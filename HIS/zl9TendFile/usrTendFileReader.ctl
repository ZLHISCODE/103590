VERSION 5.00
Object = "{BEEECC20-4D5F-4F8B-BFDC-5D9B6FBDE09D}#1.0#0"; "vsflex8.ocx"
Object = "{3B7C8863-D78F-101B-B9B5-04021C009402}#1.2#0"; "RICHTX32.OCX"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.2#0"; "MSCOMCTL.OCX"
Begin VB.UserControl usrTendFileReader 
   AutoRedraw      =   -1  'True
   ClientHeight    =   5550
   ClientLeft      =   0
   ClientTop       =   0
   ClientWidth     =   8565
   KeyPreview      =   -1  'True
   ScaleHeight     =   5550
   ScaleWidth      =   8565
   Begin MSComctlLib.ImageList imgRow 
      Left            =   6150
      Top             =   510
      _ExtentX        =   1005
      _ExtentY        =   1005
      BackColor       =   -2147483643
      ImageWidth      =   16
      ImageHeight     =   16
      MaskColor       =   12632256
      _Version        =   393216
      BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
         NumListImages   =   2
         BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "usrTendFileReader.ctx":0000
            Key             =   ""
         EndProperty
         BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "usrTendFileReader.ctx":039A
            Key             =   ""
         EndProperty
      EndProperty
   End
   Begin VB.TextBox txtLength 
      Appearance      =   0  'Flat
      Enabled         =   0   'False
      Height          =   1005
      Left            =   3930
      MultiLine       =   -1  'True
      TabIndex        =   4
      Top             =   3090
      Visible         =   0   'False
      Width           =   2025
   End
   Begin VB.PictureBox picHead 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      ForeColor       =   &H80000008&
      Height          =   3855
      Left            =   450
      ScaleHeight     =   3825
      ScaleWidth      =   7485
      TabIndex        =   5
      Top             =   810
      Width           =   7515
      Begin VB.ComboBox cboÒ³Âë 
         Height          =   300
         Left            =   3405
         Style           =   2  'Dropdown List
         TabIndex        =   11
         Top             =   3435
         Width           =   1320
      End
      Begin VB.OptionButton optPageAlign 
         Enabled         =   0   'False
         Height          =   315
         Index           =   0
         Left            =   1380
         Picture         =   "usrTendFileReader.ctx":0734
         Style           =   1  'Graphical
         TabIndex        =   13
         TabStop         =   0   'False
         Top             =   3420
         Width           =   345
      End
      Begin VB.OptionButton optPageAlign 
         Enabled         =   0   'False
         Height          =   315
         Index           =   1
         Left            =   1710
         Picture         =   "usrTendFileReader.ctx":0ABA
         Style           =   1  'Graphical
         TabIndex        =   12
         TabStop         =   0   'False
         Top             =   3420
         Width           =   345
      End
      Begin VB.OptionButton optPageAlign 
         Enabled         =   0   'False
         Height          =   315
         Index           =   2
         Left            =   2040
         Picture         =   "usrTendFileReader.ctx":0E4A
         Style           =   1  'Graphical
         TabIndex        =   9
         TabStop         =   0   'False
         Top             =   3420
         Width           =   345
      End
      Begin VB.CheckBox chkÒ³Âë 
         Caption         =   "´òÓ¡Ò³Âë"
         Height          =   195
         Left            =   150
         TabIndex        =   8
         Top             =   3480
         Width           =   1155
      End
      Begin RichTextLib.RichTextBox rtbHead 
         Height          =   1380
         Left            =   0
         TabIndex        =   6
         TabStop         =   0   'False
         Top             =   0
         Width           =   6810
         _ExtentX        =   12012
         _ExtentY        =   2434
         _Version        =   393217
         BorderStyle     =   0
         ScrollBars      =   2
         OLEDragMode     =   0
         OLEDropMode     =   0
         TextRTF         =   $"usrTendFileReader.ctx":11A3
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "ËÎÌå"
            Size            =   10.5
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin RichTextLib.RichTextBox rtbFoot 
         Height          =   1380
         Left            =   0
         TabIndex        =   7
         TabStop         =   0   'False
         Top             =   1950
         Width           =   6810
         _ExtentX        =   12012
         _ExtentY        =   2434
         _Version        =   393217
         BorderStyle     =   0
         ScrollBars      =   2
         OLEDragMode     =   0
         OLEDropMode     =   0
         TextRTF         =   $"usrTendFileReader.ctx":1240
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "ËÎÌå"
            Size            =   10.5
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin VB.Label lblÒ³Âë 
         AutoSize        =   -1  'True
         Caption         =   "Ò³ÂëÎ»ÖÃ"
         Height          =   180
         Left            =   2610
         TabIndex        =   10
         Top             =   3495
         Width           =   720
      End
   End
   Begin VB.PictureBox picMain 
      Appearance      =   0  'Flat
      AutoRedraw      =   -1  'True
      BackColor       =   &H00FFFFFF&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   4515
      Left            =   60
      ScaleHeight     =   4515
      ScaleWidth      =   8385
      TabIndex        =   1
      Top             =   510
      Width           =   8385
      Begin VSFlex8Ctl.VSFlexGrid VsfData 
         Height          =   2655
         Left            =   1590
         TabIndex        =   0
         Top             =   930
         Width           =   4305
         _cx             =   7594
         _cy             =   4683
         Appearance      =   0
         BorderStyle     =   1
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "ËÎÌå"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   16764057
         ForeColorSel    =   0
         BackColorBkg    =   -2147483643
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483636
         GridColorFixed  =   -2147483636
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483643
         FocusRect       =   2
         HighLight       =   1
         AllowSelection  =   0   'False
         AllowBigSelection=   0   'False
         AllowUserResizing=   0
         SelectionMode   =   1
         GridLines       =   1
         GridLinesFixed  =   1
         GridLineWidth   =   1
         Rows            =   4
         Cols            =   4
         FixedRows       =   3
         FixedCols       =   0
         RowHeightMin    =   255
         RowHeightMax    =   5000
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   0   'False
         FormatString    =   $"usrTendFileReader.ctx":12DD
         ScrollTrack     =   -1  'True
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   0   'False
         AutoSizeMode    =   1
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   1
         Editable        =   0
         ShowComboButton =   1
         WordWrap        =   0   'False
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         DataMode        =   0
         VirtualData     =   -1  'True
         DataMember      =   ""
         ComboSearch     =   3
         AutoSizeMouse   =   0   'False
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   24
      End
      Begin VB.Label lblTitle 
         Alignment       =   2  'Center
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Ò»°ã»¤Àí¼ÇÂ¼µ¥"
         Height          =   180
         Left            =   3450
         TabIndex        =   3
         Top             =   30
         Width           =   1275
      End
      Begin VB.Label lblSubhead 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "ÐÕÃû:##"
         Height          =   180
         Left            =   390
         TabIndex        =   2
         Top             =   540
         Width           =   720
         WordWrap        =   -1  'True
      End
   End
End
Attribute VB_Name = "usrTendFileReader"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Option Explicit
'»ù´¡Ìõ¼þ:
'1.»¤Àí¼ÇÂ¼Í¬Ò»Ê±µãÖ»¿ÉÄÜ´æÔÚÒ»Ìõ¼ÇÂ¼
'2.»¤Àí¼ÇÂ¼ÖÐ²»ÐèÒªÏñÌåÎÂµ¥ÄÇÑù , ¼ÇÂ¼²¡ÈËÊÇ·ñÍâ³ö, ¾Ü²âµÄÊý¾Ý, ²âÊÔÁËµÄÊý¾Ý²Å¼ÇÂ¼
'3.Â¼Èë»¤Àí¼ÇÂ¼Êý¾ÝÊ±,Èç¹ûËùÂ¼ÈëµÄÊý¾Ý´æÔÚÌåÎÂÊý¾Ý, ÔòÌáÈ¡¹ýÀ´
'4.»¤Àí¼ÇÂ¼µ¥ÖÐ²»ÐèÒªÂ¼ÈëÎïÀí½µÎÂ¼°Âö²«¶Ì×¾£¬ÈçÈ·ÐèÒª¿ÉÂ¼ÈëÔÚ»¤ÀíÕªÒªµÈÎÄ×ÖÐÍµÄÁÐÖÐ
'#ÊµÏÖÔ­Àí:
'1.¶ÔÓÚÓÃ»§ÐÞ¸Ä¹ýµÄÊý¾Ý,ÓÉÓÚÌá¹©±à¼­×´Ì¬Ò³ÃæÇÐ»»µÄ¹¦ÄÜ,¶ÔÓÃ»§ÐÞ¸Ä¹ýµÄÒ³Êý¾Ý½øÐÐÕûÒ³¸´ÖÆ,¼õÉÙ³ÌÐòÊµÏÖÄÑ¶È
'2.Ôö¼Ó¼ÇÂ¼¼¯¼ÇÂ¼ÄÄÐ©Ò³ÄÄÐ©µ¥Ôª¸ñ±»ÓÃ»§ÐÞ¸Ä¹ý
'3.ÈÎºÎ±à¼­(Õ³Ìù,Çå¿ÕÊý¾Ý),¶¼ÐèÒªÖØÐÂ¼ÆËãÃ¿ÐÐÊý¾ÝµÄÕ¼ÓÃÐÐ

Public mblnEditable As Boolean
'Public objFileSys As New FileSystemObject
'Public objStream As TextStream
Private mfrmParent As Object
Private mblnInit As Boolean
Private mblnShow As Boolean                 'ÊÇ·ñÏÔÊ¾Â¼Èë¿ò
Private mintPreDays As Long
Private mstrMaxDate As String
Private mintNORule As Integer               '0-Í³Ò»±àºÅ;1-°´ÎÄ¼þ¸ñÊ½Ë³Ðò±àºÅ

Private mArrPage                           '¼ÇÂ¼µ¥´òÓ¡µÄÒ³ÂëÊý×é:¸ñÊ½£ºÒ³Âë;´òÓ¡±êÊ¶(1-Ðø´ò,2-Õý³£´òÓ¡)
Private mlngMinIndex As Long, mlngMaxIndex As Long 'Êý×é×îÐ¡ºÍ×î´óË÷Òý
Private mlngµ±Ç°Ò³Âë As Long
Private mintµ±Ç°ÆðÊ¼Ò³ As Integer           'µ±Ç°ÎÄ¼þµÄÆðÊ¼Ò³(¿¼ÂÇÒÑ´òÓ¡²¿·Ö,ÒÔ¼°Ô¤ÀÀ´ÓÒÑ´òÓ¡Ò³¿ªÊ¼Ô¤ÀÀ)
Private mint½áÊøÒ³ As Integer
Private mintÒ³Âë As Integer
Private mlngµ±Ç°ÎÄ¼þID As Long
Private mstrMergeID As String  'ºÏ²¢ÎÄ¼þ
Private mlng¸ñÊ½ID As Long
Private mlng²¡ÈËID As Long
Private mlngÖ÷Ò³ID As Long
Private mlng¿ÆÊÒID As Long
Private mlng²¡ÇøID As Long
Private mintÓ¤¶ù As Integer
Private mblnÐÄÂÊ As Boolean                 'ÊÇ·ñÐèÒªÂ¼ÈëÐÄÂÊ
Private mstrPrivs As String

Private mintSymbol As Integer               'µ±Ç°¿Ø¼þË÷Òý
Private mstrSymbol As String                'ÌØÊâ×Ö·û
Private mblnClear As Boolean                'Èç¹ûÎªÕæ,Á¬ÐøÖØ´òmrsDataMap¼ÇÂ¼¼¯;µ±»»Ò³Ê±Ó¦´«¼Ù,±£ÁôÓÃ»§ÐÞ¸ÄµÄÊý¾ÝÒÔ±¸ÏÔÊ¾¡¢±£´æÊ¹ÓÃ
Private mstrCollectItems As String          '»ã×ÜÏîÄ¿¼¯ºÏ
Private mstrColCollect As String            '»ã×ÜÏîÄ¿ÁÐ¼¯ºÏ:col;1|col;4,5
Private mstrColCorrelative As String        '»ã×ÜÏîÄ¿¹ØÁªÁÐ¼¯ºÏ:COl,3;COl,4|COl,5;COl,6(Ãû³ÆÁÐºÅ,ÏîÄ¿ÐòºÅ;»ã×ÜÁÐ,ÏîÄ¿ÐòºÅ),Ö÷ÒªÕë¶Ô·ÖÀà»ã×Ü
Private mstrCOLNothing As String            'Î´°ó¶¨µÄÁÐ¼¯ºÏ+»î¶¯ÏîÄ¿ÁÐ(²»¹Ü»î¶¯ÏîÄ¿ÁÐÊÇ·ñ°ó¶¨)
Private mstrCOLActive As String             '»î¶¯ÁÐ¼¯ºÏ
Private mstrCatercorner As String           'ÁÐ¶Ô½ÇÏß¼¯ºÏ
Private mblnEditAssistant As Boolean        'µ±Ç°Ñ¡ÔñµÄÏîÄ¿ÊÇ·ñÔÊÐí½øÐÐ´Ê¾äÑ¡Ôñ
Private mlngPageRows As Long                '´ËÎÄ¼þ¸ñÊ½Ò»Ò³ËùÏÔÊ¾µÄÊý¾ÝÐÐ
Private mlngOverrunRows As Long             '³¬³öÊý¾ÝÐÐ
Private mlngRowCount As Long                'µ±Ç°¼ÇÂ¼×ÜÐÐÊý
Private mlngRowCurrent As Long              'µ±Ç°¼ÇÂ¼ÔÚ±¾Ò³µÄÊµ¼ÊÐÐÊý
Private mlngStartSpread As Long             'ÅÐ¶ÏÊý¾ÝÊÇ·ñÔÚ´òÓ¡ÆðÊ¼Ò³Ê×ÐÐ¿çÒ³£º1-ÊÇ£¬ÆäËü-·ñ(Êµ¼Ê¿ªÊ¼ÐÐºÅ)
Private mlngDate As Long                    'ÈÕÆÚ
Private mlngTime As Long                    'Ê±¼ä
Private mlngOperator As Long                '»¤Ê¿
Private mlngSignLevel As Long               'Ç©Ãû¼¶±ð
Private mlngSigner As Long                  'Ç©ÃûÐÅÏ¢
Private mlngSignName As Long                'Ç©ÃûÈË
Private mlngSignTime As Long                'Ç©ÃûÊ±¼ä
Private mlngJoinSignName As Long            '½»°àÇ©ÃûÈË
Private mlngRecord As Long                  '¼ÇÂ¼ID
Private mlngFileID As Long                  'ÎÄ¼þID£ºÖ÷Òª¶ÔÓÚºÏ²¢ÎÄ¼þÊ¹ÓÃ
Private mlngNoEditor As Long                '½ûÖ¹±à¼­ÁÐ,´æÔÚ»¤Ê¿ÁÐÔòÒÔ»¤Ê¿ÁÐÎª×¼,²»´æÔÚ»¤Ê¿ÁÐÔòÒÔÇ©ÃûÁÐÎª×¼
Private mlngCollectType As Long             '»ã×ÜÀà±ð
Private mlngCollectText As Long             '»ã×ÜÎÄ±¾
Private mlngCollectStyle As Long            '»ã×Ü±ê¼Ç
Private mlngCollectDay As Long              '»ã×ÜÈÕÆÚ:0-×òÌì;1-½ñÌì
Private mlngPrintedPage As Long             '´òÓ¡Ò³ºÅ
Private mlngPrintedRow As Long              '´òÓ¡ÐÐºÅ
Private mlngPrintedEndPage As Long          '´òÓ¡½áÊøÒ³ºÅ,Ö÷Òª¼ÇÂ¼¿çÒ³Êý¾Ýµ±Ç°´òÓ¡µ½ÄÇÒ»Ò³
Private mlngCollectValue As Long
Private mlngPrintedTag As Long                '´òÓ¡±êÊ¶,¼ÇÂ¼ÉÏ´Î´òÓ¡ÊÇ·ñ²ÉÓÃÎ´ÂúÒ³´òÓ¡¿Õ°×ÐÐ
Private mblnÈÕÆÚÊ±¼äºÏ²¢ As Boolean         'ÈÕÆÚÓëÊ±¼äºÏ²¢
Private mblnÊ±¼äÁÐÒþ²Ø As Boolean           'Òþ²ØÊ±¼äÁÐ(Èç£ºÑªÌÇ¼à²âµ¥Ö»ÐèÒªÏÔÊ¾ÈÕÆÚ)
Private Const mlngDemo As Long = 0          '±¸ÓÃ
Private mlngSingerType As Long              '»¤Ê¿¡¢Ç©ÃûÈËÏÔÊ¾Ä£Ê½£¨ÊÇÊ×ÐÐÏÔÊ¾»¹ÊÇÊ×Î²ÏÔÊ¾µÈ£©
Private mblnSignPic As Boolean            'Ç©ÃûÈËÏÔÊ¾·½Ê½
Private mblnPrintRow As Boolean           '¼ÇÂ¼µ¥Ô¤ÀÀ¡¢´òÓ¡Ê±£¬Êý¾ÝÎ´ÂúÒ³¿Õ°×²¿·ÖÊÇ·ñÊä³ö±í¸ñ
Private mblnFullPagePrint As Boolean      '¼ÇÂ¼µ¥Ô¤ÀÀ¡¢´òÓ¡Ê±,Êý¾ÝÂúÒ³²Å½øÐÐ´òÓ¡
Private mblnOddEvenPagePrint As Boolean   '¼ÇÂ¼µ¥´òÓ¡Ê±£¬Êý¾ÝÒ³ÆæÅ¼Êä³ö
Private mblnDateModel As Boolean          'ÈÕÆÚÏÔÊ¾·½Ê½£ºÏàÍ¬ÈÕÆÚµ±ÌìÏÔÊ¾Ò»´Î£»Ã¿Ò»Ìõ¼ÇÂ¼¶¼ÏÔÊ¾
Private mlngCollectColor As Long            'Ð¡½á±êÊ¶ÑÕÉ«
Private mblnShowNullCollet As Boolean       'Ð¡½áÊÇ·ñÔÚ¿ÕÖµ»ã×ÜÏÂ»­ºáÏß

Private mblnSign As Boolean                 'ÊÇ·ñÇ©Ãû
Private mblnArchive As Boolean              'ÊÇ·ñ¹éµµ
Private mintType As Integer                 '¼ÇÂ¼µ±Ç°µÄ±à¼­Ä£Ê½
Private mblnDateAd As Boolean               'ÈÕÆÚËõÐ´?
Private mstr¿ªÊ¼Ê±¼ä As String              'µ±Ç°ÎÄ¼þµÄ¿ªÊ¼Ê±¼ä
Private mstr½áÊøÊ±¼ä As String              'µ±Ç°ÎÄ¼þµÄ½áÊøÊ±¼ä
Private CellRect As RECT

Private mrsTemp As New ADODB.Recordset
Private mrsItems As New ADODB.Recordset             'ËùÓÐ»¤Àí¼ÇÂ¼ÏîÄ¿Çåµ¥
Private mrsElement As New ADODB.Recordset           'ÊÊÓÃÓÚ¼ÇÂ¼µ¥µÄ±êÇ©ÒªËØ
Private mrsSelItems As New ADODB.Recordset          'µ±Ç°Â¼ÈëµÄ»¤Àí¼ÇÂ¼ÏîÄ¿Çåµ¥
Private mrsDataMap As New ADODB.Recordset           'µ±Ç°Êý¾Ý¾µÏñ

Private Enum ColIcon
    Ç©Ãû = 1
    ÉóÇ© = 2
End Enum
Private Enum SignLevel
    Õý¸ß = 1
    ¸±¸ß = 2
    ÖÐ¼¶ = 3
    Ê¦¼¶ = 4
    Ô±Ê¿ = 5
    Î´¶¨Òå = 9
End Enum

Private Const WS_MAXIMIZE = &H1000000
Private Const WS_MAXIMIZEBOX = &H10000
Private Const WS_MINIMIZEBOX = &H20000
Private Const WS_CAPTION = &HC00000
Private Const WS_SYSMENU = &H80000
Private Const WS_THICKFRAME = &H40000
Private Const WS_CHILD = &H40000000
Private Const WS_POPUP = &H80000000
Private Const SWP_NOZORDER = &H4
Private Const SWP_FRAMECHANGED = &H20
Private Const SWP_NOOWNERZORDER = &H200
Private Const SWP_NOREPOSITION = SWP_NOOWNERZORDER

Public Event AfterDataChanged(ByVal blnChange As Boolean)
Public Event AfterRefresh()
Public Event AfterRowColChange(ByVal strInfo As String, ByVal blnImportant As Boolean, ByVal blnSign As Boolean, ByVal blnArchive As Boolean)

Dim strFields As String
Dim strValues As String
Dim blnScroll As Boolean

'²¡ÀúÎÄ¼þ¸ñÊ½¶¨ÒåÏà¹Ø
Private mintTabTiers As Integer     '±íÍ·²ã´Î
Private mintTagFormHour As Integer  '¿ªÊ¼Ê±¼äÌõ¼þ
Private mintTagToHour As Integer    '½ØÖ¹Ê±¼äÌõ¼þ
Private mobjTagFont As New StdFont  'Ìõ¼þÑùÊ½×ÖÌå
Private mlngTagColor As Long        'Ìõ¼þÑùÊ½ÑÕÉ«
Private mstrPaperSet As String      '¸ñÊ½
Private mstrPageHead As String      'Ò³Ã¼
Private mstrPageFoot As String      'Ò³½Å
Private mblnChildForm As Boolean
Private mstrSubhead As String       '±íÉÏ±êÇ©
Private mstrTabHead As String       '±íÍ·µ¥Ôª
Private mstrColWidth As String      'ÁÐ¿íÐòÁÐ´®
Private mstrColumns As String       'µ±Ç°»¤ÀíÎÄ¼þ¸÷ÁÐ¶ÔÓ¦µÄÏîÄ¿
Private lngCurColor As Long, strCurFont As String, objFont As StdFont
'±£´æ´ò¿ª»¤Àí¼ÇÂ¼ÎÄ¼þµÄSQL£¬ÔÚÆäËüµØ·½Ò²ÓÐÊ¹ÓÃ£¬²»ÄÜÐÞ¸Ä
Private mstrSQLÄÚ As String
Private mstrSQLÖÐ As String
Private mstrSQLÁÐ As String
Private mstrSQLÌõ¼þ As String
Private mstrSQL As String

'##############################################################################################
'Ò³Ã¼Ò³½Å´òÓ¡Ïà¹Ø
Private Type CHARRANGE
    cpMin As Long
    cpMax As Long
End Type
'¾ØÐÎ
Private Type RECT
    Left As Long
    Top As Long
    Right As Long
    Bottom As Long
End Type
'°üº¬ÓÃÓÚ¸ñÊ½»¯Ö¸¶¨Éè±¸µÄÏà¹ØÐÅÏ¢
Private Type FORMATRANGE
    hDC As Long             'äÖÈ¾Éè±¸
    hdcTarget As Long       'Ä¿±êÉè±¸
    rc As RECT              'äÖÈ¾ÇøÓò£¬µ¥Î»£ºç¾¡£
    rcPage As RECT          'äÖÈ¾Éè±¸µÄÕûÌåÇøÓò£¬µ¥Î»£ºç¾¡£
    chrg As CHARRANGE       'ÓÃÓÚ¸ñÊ½»¯µÄÎÄ±¾·¶Î§¡£
End Type

Private Type PageInfo
    PageNumber As Long      'Ò³Âë
    Start As Long           '×Ö·ûÆðÊ¼Î»ÖÃ
    End As Long             '×Ö·ûÖÕÖ¹Î»ÖÃ
    ActualHeight As Long    '±¾Ò³Êµ¼Ê´òÓ¡¸ß¶È
End Type
Private AllPages() As PageInfo   'Ò³ÐÅÏ¢
Private Const WM_PASTE = &H302&              'Õ³Ìù
Private Const WM_USER = &H400                'Í¨³£ÓÃ WM_USER + X À´×Ô¶¨ÒåÏûÏ¢
Private Const EM_FORMATRANGE = (WM_USER + 57)    'ÎªÄ³Ò»Éè±¸¸ñÊ½»¯Ö¸¶¨·¶Î§µÄÎÄ±¾¡£
Private Const EM_SETTARGETDEVICE = (WM_USER + 72) 'ÉèÖÃÓÃÓÚËù¼û¼´ËùµÃµÄÄ¿±êÉè±¸ºÍÐÐ¿í¡£
Private Const EM_HIDESELECTION = (WM_USER + 63)  'ÏÔÊ¾/Òþ²ØÎÄ±¾¡£
Private Const PHYSICALOFFSETX = 112  '¶ÔÓÚ´òÓ¡Éè±¸¶øÑÔ£¬±íÊ¾´ÓÎïÀíÒ³µÄ×ó±ßÔµµ½¿É´òÓ¡ÇøÓòµÄ×ó±ßÔµµÄ¾àÀë£¬²ÉÓÃÉè±¸µ¥Î»¡£
Private Const PHYSICALOFFSETY = 113  '¶ÔÓÚ´òÓ¡Éè±¸¶øÑÔ£¬±íÊ¾´ÓÎïÀíÒ³µÄÉÏ±ßÔµµ½¿É´òÓ¡ÇøÓòµÄÉÏ±ßÔµµÄ¾àÀë£¬²ÉÓÃÉè±¸µ¥Î»¡£
Private Declare Function SendMessageLong Lib "user32" Alias "SendMessageA" (ByVal hWnd As Long, ByVal wMsg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Private Declare Function GetDeviceCaps Lib "gdi32" (ByVal hDC As Long, ByVal nIndex As Long) As Long
Private Declare Function lstrlen Lib "kernel32" Alias "lstrlenA" (ByVal lpString As String) As Long '»ñÈ¡ÖÐÓ¢ÎÄ»ìºÏ×Ö·û´®³¤¶È


'######################################################################################################################
'**********************************************************************************************************************
'ÒÔ#·Ö¸ôµÄÇøÓòÄÚµÄ´úÂë¶¼Óë»æÍ¼Ïà¹Ø,Ã»ÊÂ±ð¶¯
Private Declare Function OleTranslateColor Lib "olepro32.dll" (ByVal OLE_COLOR As Long, ByVal HPALETTE As Long, pccolorref As Long) As Long
Private Declare Function CreatePen Lib "gdi32" (ByVal nPenStyle As Long, ByVal nWidth As Long, ByVal crColor As Long) As Long
Private Declare Function CreateSolidBrush Lib "gdi32" (ByVal crColor As Long) As Long
Private Declare Function SelectObject Lib "gdi32" (ByVal hDC As Long, ByVal hObject As Long) As Long
Private Declare Function DeleteObject Lib "gdi32" (ByVal hObject As Long) As Long
Private Declare Function GetStockObject Lib "gdi32" (ByVal nIndex As Long) As Long
Private Declare Function SetTextColor Lib "gdi32" (ByVal hDC As Long, ByVal crColor As Long) As Long
Private Declare Function FillRect Lib "user32" (ByVal hDC As Long, lpRect As RECT, ByVal hBrush As Long) As Long
Private Declare Function TextOut Lib "gdi32" Alias "TextOutA" (ByVal hDC As Long, ByVal X As Long, ByVal Y As Long, ByVal lpString As String, ByVal nCount As Long) As Long
Private Declare Function LineTo Lib "gdi32" (ByVal hDC As Long, ByVal X As Long, ByVal Y As Long) As Long
Private Declare Function MoveToEx Lib "gdi32" (ByVal hDC As Long, ByVal X As Long, ByVal Y As Long, lpPoint As POINTAPI) As Long

Private Type POINTAPI
        X As Long
        Y As Long
End Type

Private Const WHITE_BRUSH = 0    '°×É«»­±Ê
Private Const cdblWidth As Double = 6          'Ò»¸öÓ¢ÎÄ×Ö·ûµÄ¿í¶È
Private Const cHideCols = 3         'Ç°×ºÒþ²ØÁÐ:±¸ÓÃ,Ê±¼ä,ÈÕÆÚÊ±¼äºÏ²¢Ê±ÏÔÊ¾ÈÕÆÚÁÐ
Private Const cControlFields = 2    '¼ÇÂ¼¼¯¿ØÖÆÁÐ:Ò³ºÅ,ÐÐºÅ

Private Function GetRBGFromOLEColor(ByVal dwOleColour As Long) As Long
    '½«VBµÄÑÕÉ«×ª»»ÎªRGB±íÊ¾
    Dim clrref As Long
    Dim r As Long, g As Long, b As Long
    
    OleTranslateColor dwOleColour, 0, clrref
    
    b = (clrref \ 65536) And &HFF
    g = (clrref \ 256) And &HFF
    r = clrref And &HFF
    
    GetRBGFromOLEColor = RGB(r, g, b)
End Function

Private Function GetSymbolWidth(ByVal strPara As String) As Double
    'È±Ê¡ÊÇËÎÌå9ºÅ,°´×ÖÌå´óÐ¡Í¬±È·Å´ó
    Dim sinFontSize As Single
    Dim i As Integer, j As Integer
    
    j = Len(strPara)
    sinFontSize = VsfData.FontSize
    For i = 1 To j
        GetSymbolWidth = GetSymbolWidth + IIf(Asc(Mid(strPara, i, 1)) > 0, 1, 2) * cdblWidth * sinFontSize / 9
    Next
End Function

Private Sub DrawCell(ByVal hDC As Long, ByVal ROW As Long, ByVal COL As Long, ByVal Left As Long, ByVal Top As Long, ByVal Right As Long, ByVal Bottom As Long, Done As Boolean)
    Dim strText As String
    Dim strLeft As String
    Dim strRight As String
    Dim lngLeft As Long
    Dim lngRight As Long
    Dim dblWidth As Double
    Dim lngBackColor As Long
    Dim lngForeColor As Long
    Dim blnDraw As Boolean
    '»æÍ¼Ïà¹Ø
    Dim lngPen As Long
    Dim lngOldPen As Long
    Dim lngBrush As Long
    Dim lngOldBrush As Long
    Dim lpPoint As POINTAPI
    Dim t_ClientRect As RECT
    On Error GoTo ErrHand
    '******************************************
    'ÔÚ´ËÊÂ¼þÖÐ²»ÄÜ¶Ôµ¥Ôª¸ñµÄÈÎºÎÊôÐÔ¸³Öµ,°üÀ¨Celldata,·ñÔò»áÒýÆð¸ÃÊÂ¼þµÄËÀÑ­»·,µ¼ÖÂ¹¤¾ßÀ¸»ò¼ÆÊ±Æ÷ÎÞ·¨Õý³£¹¤×÷¡£
    '******************************************
    'Ê¹ÓÃÆ¥ÅäµÄ±³¾°É«£¬Ç°¾°É«Óë×ÖÌå½øÐÐÎÄ±¾Êä³ö¡£
    If Not mblnInit Then Exit Sub
    If VsfData.RowHidden(ROW) Then Exit Sub
    Done = False
    
    strText = VsfData.TextMatrix(ROW, COL)
'    If IsDiagonal(Col) And InStr(1, strText, "/") <> 0 Then
    If InStr(1, strText, "/") <> 0 Then
        blnDraw = True
        '¸³³õÖµ
        strLeft = Split(strText, "/")(0)
        strRight = Mid(strText, InStr(1, strText, "/") + 1)
        lngLeft = LenB(StrConv(strLeft, vbFromUnicode))
        lngRight = LenB(StrConv(strRight, vbFromUnicode))
        'È¡×Ö·û¿í¶È
        dblWidth = GetSymbolWidth(strRight)
        'Éè¶¨¿Í»§ÇøÓò´óÐ¡
        With t_ClientRect
            .Left = Left + 1
            .Top = Top + 1
            .Right = Right - 1
            .Bottom = Bottom - 1
        End With
        
        '1¡¢Çå¿ÕÄÚÈÝ
        '´´½¨Óë±³¾°É«ÏàÍ¬µÄË¢×Ó
        If ROW < VsfData.FixedRows Then
            lngBackColor = GetRBGFromOLEColor(VsfData.BackColorFixed)
            lngForeColor = GetRBGFromOLEColor(VsfData.ForeColorFixed)
        Else
            If ROW = VsfData.RowSel Then
                lngBackColor = GetRBGFromOLEColor(VsfData.BackColorSel)
                lngForeColor = RGB(0, 0, 0)
            Else
                lngBackColor = RGB(255, 255, 255)
                lngForeColor = GetRBGFromOLEColor(VsfData.Cell(flexcpForeColor, ROW, COL))
            End If

        End If
        lngBrush = CreateSolidBrush(lngBackColor)
        'Ê¹ÓÃ¸ÃË¢×ÓÌî³ä±³¾°É«
        lngOldBrush = SelectObject(hDC, lngBrush)
        Call FillRect(hDC, t_ClientRect, lngBrush)
        'Á¢¼´Ïú»ÙÁÙÊ±Ê¹ÓÃµÄË¢×Ó²¢»¹Ô­Ë¢×Ó
        Call SelectObject(hDC, lngOldBrush)
        Call DeleteObject(lngBrush)
        
        '2¡¢×¼±¸»­Ïß
        '´´½¨ÐÂ»­±Ê
        Call SetTextColor(hDC, lngForeColor)
        lngPen = CreatePen(0, 1, lngForeColor)
        lngOldPen = SelectObject(hDC, lngPen)
        '»­Ïß
        Call MoveToEx(hDC, Left, Bottom - 2, lpPoint)
        Call LineTo(hDC, Right, Top)
        'Êä³öÎÄ±¾
        Call TextOut(hDC, Left, Top, strLeft, lngLeft)
        Call TextOut(hDC, IIf(Right - dblWidth >= Left, Right - dblWidth, Left), Bottom - 16, strRight, lngRight)
        
        '»¹Ô­»­±Ê²¢Ïú»Ù
        Call SelectObject(hDC, lngOldPen)
        Call DeleteObject(lngPen)
        
        'ÒÑÍê³É×÷Í¼
        Done = True
    End If
    
    '3¡¢Èç¹ûÊÇ»ã×ÜÐÐ£¬Ôò½øÐÐÌØÊâ´¦Àí
    If Val(VsfData.TextMatrix(ROW, mlngCollectType)) < 0 And Val(VsfData.TextMatrix(ROW, mlngCollectStyle)) > 0 _
        And (COL >= mlngDate And COL < mlngNoEditor) Then
        Call DrawCollectCell(hDC, ROW, COL, Left, Top, Right, Bottom)
    End If
    Exit Sub
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Sub

Private Sub DrawCollectCell(ByVal hDC As Long, ByVal ROW As Long, ByVal COL As Long, ByVal Left As Long, ByVal Top As Long, ByVal Right As Long, ByVal Bottom As Long)
    Dim lngPen As Long, lngOldPen As Long
    Dim lpPoint As POINTAPI
    
    '´´½¨ÐÂ»­±Ê
    lngPen = CreatePen(0, 1, mlngCollectColor)
    lngOldPen = SelectObject(hDC, lngPen)
    
    Select Case Val(VsfData.TextMatrix(ROW, mlngCollectStyle))
    Case 1 'ÉÏÏÂ»®ºáÏß
        '»­Ïß
        Call MoveToEx(hDC, Left, Top, lpPoint)
        Call LineTo(hDC, Right, Top)
        Call MoveToEx(hDC, Left, Bottom - 2, lpPoint)
        Call LineTo(hDC, Right, Bottom - 2)
    Case 2  '»ã×ÜÏîÏÂË«ºáÏß
        If IIf(mblnShowNullCollet, True, VsfData.TextMatrix(ROW, COL) <> "") Then
            '»­Ïß
            Call MoveToEx(hDC, Left, Bottom - 4, lpPoint)
            Call LineTo(hDC, Right, Bottom - 4)
            Call MoveToEx(hDC, Left, Bottom - 2, lpPoint)
            Call LineTo(hDC, Right, Bottom - 2)
        End If
    Case 3  'ÉÏºáÏß
        '»­Ïß
        Call MoveToEx(hDC, Left, Top, lpPoint)
        Call LineTo(hDC, Right, Top)
    Case 4 '»ã×ÜÏîÏÂµ¥ºáÏß
        If InStr(1, "|" & mstrColCollect & ";", "|" & COL - (cHideCols + VsfData.FixedCols - 1) & ";") <> 0 Then 'And Val(VsfData.TextMatrix(ROW, COL)) <> 0 Then
             If IIf(mblnShowNullCollet, True, VsfData.TextMatrix(ROW, COL) <> "") Then
                '»­Ïß
                Call MoveToEx(hDC, Left, Bottom - 2, lpPoint)
                Call LineTo(hDC, Right, Bottom - 2)
            End If
        End If
    End Select
    
    '»¹Ô­»­±Ê²¢Ïú»Ù
    Call SelectObject(hDC, lngOldPen)
    Call DeleteObject(lngPen)
End Sub

'######################################################################################################################
'**********************************************************************************************************************
'ÒÔ#·Ö¸ôµÄÇøÓòÄÚµÄ´úÂë¶¼Óë·ÖÐÐÏà¹Ø,Ã»ÊÂ±ð¶¯
Private Function GetData(ByVal strInput As String) As Variant
    Dim arrData
    Dim strData As String
    Dim strLine(256) As Byte
    Dim lngRow As Long, lngRows As Long, lngLen As Long
    
    GetData = ""
    lngRows = SendMessage(txtLength.hWnd, EM_GETLINECOUNT, 0&, 0&)
    For lngRow = 1 To lngRows
        Call ClearArray(strLine)
        lngLen = SendMessage(txtLength.hWnd, EM_GETLINE, lngRow - 1, strLine(0))
        Call ClearArray(strLine, lngLen)
        strData = StrConv(strLine, vbUnicode)
        strData = TruncZero(strData)
        GetData = GetData & IIf(GetData = "", "", "|ZYB.ZLSOFT|") & strData & IIf(lngRow < lngRows, vbCrLf, "")
    Next
    GetData = Split(GetData, "|ZYB.ZLSOFT|")
End Function

Private Sub ClearArray(strLine() As Byte, Optional ByVal lngPos As Long = 0)
    Dim intDo As Integer, intMax As Integer
    intMax = UBound(strLine)
    For intDo = lngPos To intMax
        strLine(intDo) = 0
        If lngPos > 0 Then Exit Sub     '²»ÎªÁã,±íÊ¾½öÉèÖÃ×Ö·û´®½áÊø·û
    Next
    strLine(1) = 1
End Sub

Private Function TrimStr(ByVal str As String) As String
'¹¦ÄÜ£ºÈ¥µô×Ö·û´®ÖÐ\0ÒÔºóµÄ×Ö·û£¬²¢ÇÒÈ¥µôÁ½¶ËµÄ¿Õ¸ñ

    If InStr(str, Chr(0)) > 0 Then
        TrimStr = Trim(Left(str, InStr(str, Chr(0)) - 1))
    Else
        TrimStr = Trim(str)
    End If
End Function

Private Function TruncZero(ByVal strInput As String) As String
'¹¦ÄÜ£ºÈ¥µô×Ö·û´®ÖÐ\0ÒÔºóµÄ×Ö·û
    Dim lngPos As Long
    
    lngPos = InStr(strInput, Chr(0))
    If lngPos > 0 Then
        TruncZero = Mid(strInput, 1, lngPos - 1)
    Else
        TruncZero = strInput
    End If
End Function

'**********************************************************************************************************************
'######################################################################################################################


Private Function GetPeriod() As String
    Dim rs As New ADODB.Recordset
    Dim strPeriod As String
    On Error GoTo ErrHand
    
    '53588:ÁõÅô·É,2013-4-25,ÐÞ¸ÄÊý¾ÝµÄÊ±¼äÐ¡ÓÚ²¡ÈËÈëÔºÊ±¼ä£¬´²ºÅ£¬²¡Çø²»ÄÜÏÔÊ¾ÎÊÌâ
    'Èç£º²¡ÈËÈë¿ÆÊ±¼äÎª2013-03-13 11:23:34 ÎÄ¼þ¿ªÊ¼Ê±¼äºÍÈë¿ÆÏàÍ¬£¬´ËÊ±Â¼ÈëÊý¾ÝÊ±¼äÎª 2013-03-13 11:23
    '¾Í»áµ¼ÖÂÎÞ·¨ÌáÈ¡´²ºÅ£¬Ó¦Îª±£´æµÄÊý¾ÝÊ±¼äÎª2013-03-13 11:23:00 Ð¡ÓÚÁË²¡ÈËÈë¿ÆÊ±¼äµ¼ÖÂÎÞ·¨ÌáÈ¡µ½Êý¾Ý
    '»ñÈ¡²¡ÈËµÄÈë¿ÆÊ±¼ä
    If mintÓ¤¶ù = 0 Then
        gstrSQL = "Select ¿ªÊ¼Ê±¼ä, Sysdate As ½áÊøÊ±¼ä" & vbNewLine & _
            " From ²¡ÈË±ä¶¯¼ÇÂ¼" & vbNewLine & _
            " Where ²¡ÈËid = [1] And Ö÷Ò³id = [2] And ¿ªÊ¼Ô­Òò = 2" & vbNewLine & _
            " Union All" & vbNewLine & _
            " Select ¿ªÊ¼Ê±¼ä, Sysdate As ½áÊøÊ±¼ä" & vbNewLine & _
            " From ²¡ÈË±ä¶¯¼ÇÂ¼ a" & vbNewLine & _
            " Where a.²¡ÈËid = [1] And a.Ö÷Ò³id = [2] And a.¿ªÊ¼Ô­Òò = 1 And Not Exists" & vbNewLine & _
            " (Select 1 From ²¡ÈË±ä¶¯¼ÇÂ¼ Where ²¡ÈËid = a.²¡ÈËid And Ö÷Ò³id = a.Ö÷Ò³id And ¿ªÊ¼Ô­Òò = 2)"
    Else
        gstrSQL = " Select   ³öÉúÊ±¼ä AS ¿ªÊ¼Ê±¼ä,sysdate AS ½áÊøÊ±¼ä From ²¡ÈËÐÂÉú¶ù¼ÇÂ¼ Where ²¡ÈËID=[1] And Ö÷Ò³ID=[2] And ÐòºÅ=[3]"
    End If
    Set rs = zlDatabase.OpenSQLRecord(gstrSQL, "È¡ÈëÔºÈÕÆÚ»ò³öÉúÈÕÆÚ", mlng²¡ÈËID, mlngÖ÷Ò³ID, mintÓ¤¶ù)
    
    '»ñÈ¡Ö¸¶¨Ò³ÂëµÄÊý¾Ý·¢ÉúÊ±¼ä·¶Î§
    gstrSQL = " Select  MIN(·¢ÉúÊ±¼ä) ¿ªÊ¼Ê±¼ä,MAX(·¢ÉúÊ±¼ä) AS ½áÊøÊ±¼ä From ²¡ÈË»¤Àí´òÓ¡ Where ÎÄ¼þID=[1] And (¿ªÊ¼Ò³ºÅ=[2] OR ½áÊøÒ³ºÅ=[2])"
    Call SQLDIY(gstrSQL)
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "»ñÈ¡Ö¸¶¨Ò³ÂëµÄÊý¾Ý·¢ÉúÊ±¼ä·¶Î§", mlngµ±Ç°ÎÄ¼þID, mintÒ³Âë)
    If NVL(mrsTemp!¿ªÊ¼Ê±¼ä) = "" Then
        strPeriod = Format(rs!¿ªÊ¼Ê±¼ä, "yyyy-MM-dd HH:mm:ss") & "¡«" & Format(rs!½áÊøÊ±¼ä, "yyyy-MM-dd HH:mm:ss")
    Else
        If Format(mrsTemp!¿ªÊ¼Ê±¼ä, "yyyy-MM-dd HH:mm:ss") < Format(rs!¿ªÊ¼Ê±¼ä, "yyyy-MM-dd HH:mm:ss") Then
            strPeriod = Format(rs!¿ªÊ¼Ê±¼ä, "yyyy-MM-dd HH:mm:ss") & "¡«" & Format(mrsTemp!½áÊøÊ±¼ä, "yyyy-MM-dd HH:mm:ss")
        Else
            strPeriod = Format(mrsTemp!¿ªÊ¼Ê±¼ä, "yyyy-MM-dd HH:mm:ss") & "¡«" & Format(mrsTemp!½áÊøÊ±¼ä, "yyyy-MM-dd HH:mm:ss")
        End If
    End If
    GetPeriod = strPeriod
    Exit Function
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Function

Private Function ReadStruDef() As Boolean
    Dim lngCol As Long
    On Error GoTo ErrHand
    
    '¶ÁÈ¡ÎÄ¼þÊôÐÔ
    mblnDateAd = False
    Call GetFileProperty
    
    'ÌáÈ¡»î¶¯ÏîÄ¿²¢¼ÓÈëÁÐ¶¨Òå(¸ñÊ½£ºÁÐºÅ;±íÍ·Ãû³Æ|ÏîÄ¿ÐòºÅ,²¿Î»;ÏîÄ¿ÐòºÅ,²¿Î»||ÁÐºÅ;±íÍ·Ãû³Æ...)
    mblnÈÕÆÚÊ±¼äºÏ²¢ = False
    mblnÊ±¼äÁÐÒþ²Ø = False
    mstrCOLActive = ""
    mstrCOLNothing = ""
    mstrCollectItems = ""
    mstrColCollect = ""
    mstrColCorrelative = ""
    gstrSQL = " Select   A.ÁÐºÅ,A.ÁÐÍ·Ãû³Æ,A.ÐòºÅ,A.ÏîÄ¿ÐòºÅ,A.²¿Î» From ²¡ÈË»¤Àí»î¶¯ÏîÄ¿ A " & _
              " Where A.ÎÄ¼þID=[1] And A.Ò³ºÅ=[2] " & _
              " Order by A.ÁÐºÅ,A.ÐòºÅ"
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "ÌáÈ¡³öËùÓÐ×Ô¶¨ÒåµÄ»î¶¯ÏîÄ¿", mlngµ±Ç°ÎÄ¼þID, mintÒ³Âë)
    If mrsTemp.RecordCount <> 0 Then
        Do While Not mrsTemp.EOF
            If lngCol <> mrsTemp!ÁÐºÅ Then
                lngCol = mrsTemp!ÁÐºÅ
                mstrCOLActive = mstrCOLActive & "||" & mrsTemp!ÁÐºÅ & ";" & mrsTemp!ÁÐÍ·Ãû³Æ & "|" & mrsTemp!ÏîÄ¿ÐòºÅ & "," & NVL(mrsTemp!²¿Î»)
            Else
                mstrCOLActive = mstrCOLActive & ";" & mrsTemp!ÏîÄ¿ÐòºÅ & "," & NVL(mrsTemp!²¿Î»)
            End If
            mrsTemp.MoveNext
        Loop
    End If
    If mstrCOLActive <> "" Then mstrCOLActive = Mid(mstrCOLActive, 3)
    
    '¶ÁÈ¡²¡ÀúÎÄ¼þ¸ñÊ½¶¨Òå
    gstrSQL = "Select   d.¶ÔÏóÐòºÅ, d.ÄÚÈÝÎÄ±¾, d.ÒªËØÃû³Æ" & _
        " From ²¡ÀúÎÄ¼þ½á¹¹ d, ²¡ÀúÎÄ¼þ½á¹¹ p" & _
        " Where p.Id = d.¸¸id And p.ÎÄ¼þid = [1] And p.¶ÔÏóÀàÐÍ = 1 And p.ÄÚÈÝÎÄ±¾ = '±í¸ñÑùÊ½'" & _
        " Order By d.¶ÔÏóÐòºÅ"
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "¶ÁÈ¡²¡ÀúÎÄ¼þ¸ñÊ½¶¨Òå", mlng¸ñÊ½ID)
    With mrsTemp
        Do While Not .EOF
            Select Case "" & !ÒªËØÃû³Æ
            Case "±íÍ·²ãÊý": mintTabTiers = Val("" & !ÄÚÈÝÎÄ±¾)
            Case "×ÜÁÐÊý":  VsfData.Cols = Val("" & !ÄÚÈÝÎÄ±¾)
            Case "×îÐ¡ÐÐ¸ß": VsfData.RowHeightMin = Val("" & !ÄÚÈÝÎÄ±¾)
            Case "ÎÄ±¾×ÖÌå"
                strCurFont = "" & !ÄÚÈÝÎÄ±¾
                Set objFont = New StdFont
                With objFont
                    .Name = Split(strCurFont, ",")(0)
                    .Size = Val(Split(strCurFont, ",")(1))
                    .Bold = False: .Italic = False
                    If InStr(1, strCurFont, "´Ö") > 0 Then .Bold = True
                    If InStr(1, strCurFont, "Ð±") > 0 Then .Italic = True
                End With
                Set VsfData.Font = objFont
                Set lblSubhead.Font = VsfData.Font
                Set Font = lblSubhead.Font
                
            Case "ÎÄ±¾ÑÕÉ«": VsfData.ForeColor = Val("" & !ÄÚÈÝÎÄ±¾)
            Case "±í¸ñÑÕÉ«": VsfData.GridColor = Val("" & !ÄÚÈÝÎÄ±¾): VsfData.GridColorFixed = VsfData.GridColor
            
            Case "±êÌâÎÄ±¾": lblTitle.Caption = "" & !ÄÚÈÝÎÄ±¾
            Case "±êÌâ×ÖÌå"
                strCurFont = "" & !ÄÚÈÝÎÄ±¾
                Set objFont = New StdFont
                With objFont
                    .Name = Split(strCurFont, ",")(0)
                    .Size = Val(Split(strCurFont, ",")(1))
                    .Bold = False: .Italic = False
                    If InStr(1, strCurFont, "´Ö") > 0 Then .Bold = True
                    If InStr(1, strCurFont, "Ð±") > 0 Then .Italic = True
                End With
                Set lblTitle.Font = objFont
                lblTitle.AutoSize = False
            
            Case "¿ªÊ¼Ê±¼ä": mintTagFormHour = Val("" & !ÄÚÈÝÎÄ±¾)
            Case "ÖÕÖ¹Ê±¼ä": mintTagToHour = Val("" & !ÄÚÈÝÎÄ±¾)
            Case "Ìõ¼þ×ÖÌå"
                strCurFont = "" & !ÄÚÈÝÎÄ±¾
                Set objFont = New StdFont
                With objFont
                    .Name = Split(strCurFont, ",")(0)
                    .Size = Val(Split(strCurFont, ",")(1))
                    .Bold = False: .Italic = False
                    If InStr(1, strCurFont, "´Ö") > 0 Then .Bold = True
                    If InStr(1, strCurFont, "Ð±") > 0 Then .Italic = True
                End With
                Set mobjTagFont = objFont
            Case "Ìõ¼þÑÕÉ«": mlngTagColor = Val("" & !ÄÚÈÝÎÄ±¾)
            Case "ÓÐÐ§Êý¾ÝÐÐ"
                mlngOverrunRows = 0
                mlngPageRows = Val("" & !ÄÚÈÝÎÄ±¾)
            Case "ÈÕÆÚÊ±¼äºÏ²¢"
                mblnÈÕÆÚÊ±¼äºÏ²¢ = (Val("" & !ÄÚÈÝÎÄ±¾) = 1)
            '65502:ÁõÅô·É,2013-11-12
            Case "Ê±¼äÁÐÒþ²Ø"
                mblnÊ±¼äÁÐÒþ²Ø = (Val("" & !ÄÚÈÝÎÄ±¾) = 1)
            End Select
            .MoveNext
        Loop
    End With
    
    If mblnÊ±¼äÁÐÒþ²Ø = True Then mblnÈÕÆÚÊ±¼äºÏ²¢ = False
    
    gstrSQL = "Select   ¸ñÊ½,Ò³Ã¼ ,Ò³½Å, ÖÖÀà||'-'||±àºÅ AS KEY From ²¡ÀúÒ³Ãæ¸ñÊ½ Where ÖÖÀà = 3 And ±àºÅ In (Select Ò³Ãæ From ²¡ÀúÎÄ¼þÁÐ±í Where Id = [1])"
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "¶ÁÈ¡²¡ÀúÒ³Ãæ¸ñÊ½", mlng¸ñÊ½ID)
    If Not mrsTemp.EOF Then
        mstrPaperSet = "" & mrsTemp!¸ñÊ½
        If picHead.Tag = "" Then
            '¿¼ÂÇµ½Ò½ÔºÄÚ»¤ÀíÎÄ¼þÒ³Ã¼Ò³½Å¸ñÊ½Í³Ò»£¬´Ë´¦Ö»¶ÁÈ¡Ò»´Î
            Call ReadPageHead(rtbHead, mrsTemp!Key)
            Call ReadPageFoot(rtbFoot, mrsTemp!Key)
            picHead.Tag = mrsTemp!Key
            chkÒ³Âë.Value = IIf(Val(NVL(mrsTemp!Ò³½Å, 0)) > 0, 1, 0)
            If chkÒ³Âë.Value = 1 Then
                optPageAlign(Val(NVL(mrsTemp!Ò³½Å, 0)) - 1).Value = True
                '46251,ÁõÅô·É,2012-09-11,×°ÔØÒ³ÂëÊä³öÎ»ÖÃ
                If CInt(Val(NVL(mrsTemp!Ò³Ã¼, 0))) > 0 And CInt(Val(NVL(mrsTemp!Ò³Ã¼, 0))) < 5 Then
                    Call zlControl.CboSetIndex(cboÒ³Âë.hWnd, CInt(Val(NVL(mrsTemp!Ò³Ã¼, 0))) - 1)
                End If
            End If
        End If
    End If
    
    '------------------------------------------------------------------------------------------------------------------
    gstrSQL = "Select   d.¶ÔÏóÐòºÅ, d.ÄÚÈÝÎÄ±¾, d.ÒªËØÃû³Æ, Nvl(d.ÊÇ·ñ»»ÐÐ, 0) As ÊÇ·ñ»»ÐÐ" & _
        " From ²¡ÀúÎÄ¼þ½á¹¹ d, ²¡ÀúÎÄ¼þ½á¹¹ p" & _
        " Where p.Id = d.¸¸id And p.ÎÄ¼þid = [1] And p.¶ÔÏóÀàÐÍ = 1 And p.ÄÚÈÝÎÄ±¾ = '±íÉÏ±êÇ©'" & _
        " Order By d.¶ÔÏóÐòºÅ"
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "¶ÁÈ¡±íÉÏ±êÇ©¶¨Òå", mlng¸ñÊ½ID)
    With mrsTemp
        mstrSubhead = ""
        Do While Not .EOF
            mstrSubhead = mstrSubhead & "|" & IIf(!ÊÇ·ñ»»ÐÐ = 0, "", vbCrLf) & !ÄÚÈÝÎÄ±¾ & "{" & !ÒªËØÃû³Æ & "}"
            .MoveNext
        Loop
        If mstrSubhead <> "" Then mstrSubhead = Mid(mstrSubhead, 2)
    End With
    
    '------------------------------------------------------------------------------------------------------------------
    gstrSQL = "Select   d.¶ÔÏóÐòºÅ, d.ÄÚÈÝÐÐ´Î, d.ÄÚÈÝÎÄ±¾" & _
        " From ²¡ÀúÎÄ¼þ½á¹¹ d, ²¡ÀúÎÄ¼þ½á¹¹ p" & _
        " Where p.Id = d.¸¸id And p.ÎÄ¼þid = [1] And p.¶ÔÏóÀàÐÍ = 1 And p.ÄÚÈÝÎÄ±¾ = '±íÍ·µ¥Ôª'" & _
        " Order By d.¶ÔÏóÐòºÅ"
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "¶ÁÈ¡±íÍ·µ¥Ôª¶¨Òå", mlng¸ñÊ½ID)
    With mrsTemp
        mstrTabHead = ""
        Do While Not .EOF
            mstrTabHead = mstrTabHead & "|" & !ÄÚÈÝÐÐ´Î - 1 & "," & !¶ÔÏóÐòºÅ & "," & !ÄÚÈÝÎÄ±¾
            .MoveNext
        Loop
        If mstrTabHead <> "" Then mstrTabHead = Mid(mstrTabHead, 2)
    End With
    
    '²éÑ¯Óï¾ä×éÖ¯
    '------------------------------------------------------------------------------------------------------------------
    Dim strSqlÍâ As String, str¸ñÊ½ As String, strSqlNull As String
    Dim blnÈÕÆÚ As Boolean, blnÊ±¼ä As Boolean, bln»¤Ê¿ As Boolean
    Dim blnÇ©ÃûÈË As Boolean, blnÇ©ÃûÊ±¼ä As Boolean, blnÇ©ÃûÈÕÆÚ As Boolean
    Dim bln¶Ô½ÇÏß As Boolean, blnÑ¡ÔñÏî As Boolean          'Èç¹ûÉÏÒ»ÁÐÊÇ¶Ô½ÇÏßÇÒÑ¡ÔñÏî,ÔòÖ±½ÓÌáÈ¡¸÷ÏîÊý¾Ý,Æ´ÁÐÍ·Ê±ÔÚÊýÖµ¼ä¼ÓÉÏ/
    Dim lngColumn As Long, blnAddCollect As Boolean
    Dim strColCorrelative As String
    Dim str»ã×ÜÖµ As String
    
    gstrSQL = "Select   d.¶ÔÏóÐòºÅ,d.¶ÔÏó±ê¼Ç, d.¶ÔÏóÊôÐÔ, d.ÄÚÈÝÐÐ´Î, d.ÄÚÈÝÎÄ±¾, upper(d.ÒªËØÃû³Æ) AS ÒªËØÃû³Æ, d.ÒªËØµ¥Î»,d.ÒªËØ±íÊ¾ " & _
        " From ²¡ÀúÎÄ¼þ½á¹¹ d, ²¡ÀúÎÄ¼þ½á¹¹ p" & _
        " Where p.Id = d.¸¸id And p.ÎÄ¼þid = [1] And p.¶ÔÏóÀàÐÍ = 1 And p.ÄÚÈÝÎÄ±¾ = '±íÁÐ¼¯ºÏ'" & _
        " Order By d.¶ÔÏóÐòºÅ, d.ÄÚÈÝÐÐ´Î"
        
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "¶ÁÈ¡±íÁÐ¼¯ºÏ¶¨Òå", mlng¸ñÊ½ID)
    With mrsTemp
        lngColumn = 0: mstrColumns = "": mstrColWidth = "": mstrCatercorner = "": strColCorrelative = ""
        mstrSQLÄÚ = "": mstrSQLÖÐ = "": strSqlÍâ = "": mstrSQLÁÐ = "": mstrSQLÌõ¼þ = "": strSqlNull = ""
        blnÈÕÆÚ = False: blnÊ±¼ä = False: bln»¤Ê¿ = False
        blnÇ©ÃûÈË = False: blnÇ©ÃûÊ±¼ä = False: blnÇ©ÃûÈÕÆÚ = False
        Do While Not .EOF
            If lngColumn <> !¶ÔÏóÐòºÅ Then
                blnAddCollect = False
                If strColCorrelative <> "" Then
                    mstrColCorrelative = mstrColCorrelative & "|" & strColCorrelative
                End If
                strColCorrelative = ""
                
                mstrColumns = mstrColumns & IIf(mstrColumns = "", "", "'1'" & str¸ñÊ½) & "|" & !¶ÔÏóÐòºÅ & "'" & !ÒªËØÃû³Æ
                mstrColWidth = mstrColWidth & "," & !¶ÔÏóÊôÐÔ & "`" & !¶ÔÏóÐòºÅ & "`" & !ÒªËØ±íÊ¾
                If !ÒªËØ±íÊ¾ = 1 Then mstrCatercorner = mstrCatercorner & "," & !¶ÔÏóÐòºÅ
                str¸ñÊ½ = ""
                If !ÒªËØÃû³Æ <> "" Then str¸ñÊ½ = "{" & NVL(!ÄÚÈÝÎÄ±¾) & "[" & !ÒªËØÃû³Æ & "]" & NVL(!ÒªËØµ¥Î») & "}"
                    
                If Mid(strSqlNull, 3) = "" Then
                    strSqlNull = "''"
                Else
                    strSqlNull = Mid(strSqlNull, 3)
                End If
                mstrSQLÁÐ = mstrSQLÁÐ & "," & IIf(Mid(strSqlÍâ, 3) = "", "''", "Decode(" & Mid(strSqlÍâ, 3) & "," & strSqlNull & ",''," & Mid(strSqlÍâ, 3) & ")") & " As C" & Format(lngColumn, "00")
                
                strSqlÍâ = ""
                strSqlNull = ""
                lngColumn = !¶ÔÏóÐòºÅ
                bln¶Ô½ÇÏß = (NVL(!ÒªËØ±íÊ¾, 0) = 1)
                blnÑ¡ÔñÏî = False
                mrsItems.Filter = "ÏîÄ¿Ãû³Æ='" & NVL(!ÒªËØÃû³Æ) & "'"
                If mrsItems.RecordCount <> 0 Then
                    blnÑ¡ÔñÏî = (mrsItems!ÏîÄ¿±íÊ¾ = 5)
                    If mrsItems!ÏîÄ¿±íÊ¾ = 4 Then   '»ã×ÜÏîÄ¿
                        blnAddCollect = True
                        mstrCollectItems = mstrCollectItems & "," & mrsItems!ÏîÄ¿ÐòºÅ
                        mstrColCollect = mstrColCollect & "|" & !¶ÔÏóÐòºÅ & ";" & mrsItems!ÏîÄ¿ÐòºÅ
                        If Val(NVL(!¶ÔÏó±ê¼Ç)) > 0 And Val(NVL(!¶ÔÏóÐòºÅ)) <> Val(NVL(!¶ÔÏó±ê¼Ç)) Then
                            strColCorrelative = Val(NVL(!¶ÔÏó±ê¼Ç)) & ";" & !¶ÔÏóÐòºÅ & "," & mrsItems!ÏîÄ¿ÐòºÅ
                        End If
                    End If
                End If
                mrsItems.Filter = 0
            Else
                mstrColumns = mstrColumns & "," & !ÒªËØÃû³Æ
                str¸ñÊ½ = str¸ñÊ½ & "{" & NVL(!ÄÚÈÝÎÄ±¾) & "[" & !ÒªËØÃû³Æ & "]" & NVL(!ÒªËØµ¥Î») & "}"
                mrsItems.Filter = "ÏîÄ¿Ãû³Æ='" & NVL(!ÒªËØÃû³Æ) & "'"
                If mrsItems.RecordCount <> 0 Then
                    If mrsItems!ÏîÄ¿±íÊ¾ = 4 Then   '»ã×ÜÏîÄ¿
                        mstrCollectItems = mstrCollectItems & "," & mrsItems!ÏîÄ¿ÐòºÅ
                        If blnAddCollect Then
                            strColCorrelative = ""
                            mstrColCollect = mstrColCollect & "," & mrsItems!ÏîÄ¿ÐòºÅ
                        Else    'ÓÐ¿ÉÄÜÒ»ÁÐ°ó¶¨Á½¸öÏîÄ¿,µÚÒ»¸öÏîÄ¿²»ÊÇ»ã×ÜÏîÄ¿,µÚ¶þ¸öÏîÄ¿²ÅÊÇ»ã×ÜÏîÄ¿,Òò´Ë,ÏÂÃæµÄ´úÂë±£Ö¤¼ÓÉÏÁÐÐòºÅ
                            blnAddCollect = True
                            mstrColCollect = mstrColCollect & "|" & !¶ÔÏóÐòºÅ & ";" & mrsItems!ÏîÄ¿ÐòºÅ
                            If Val(NVL(!¶ÔÏó±ê¼Ç)) > 0 And Val(NVL(!¶ÔÏóÐòºÅ)) <> Val(NVL(!¶ÔÏó±ê¼Ç)) Then
                                strColCorrelative = Val(NVL(!¶ÔÏó±ê¼Ç)) & ";" & !¶ÔÏóÐòºÅ & "," & mrsItems!ÏîÄ¿ÐòºÅ
                            End If
                        End If
                    End If
                End If
                mrsItems.Filter = 0
            End If
            
            Select Case !ÒªËØÃû³Æ
            Case "ÈÕÆÚ"
                blnÈÕÆÚ = True
                mblnDateAd = (NVL(!ÒªËØ±íÊ¾, 0) = 1)
                mstrSQLÖÐ = mstrSQLÖÐ & ",ÈÕÆÚ"
                mstrSQLÄÚ = mstrSQLÄÚ & ",To_Char(l.·¢ÉúÊ±¼ä, " & IIf(mblnDateAd, "'dd/MM'", "'yyyy-mm-dd'") & ") As ÈÕÆÚ"
                strSqlÍâ = strSqlÍâ & "||" & !ÒªËØÃû³Æ
            Case "Ê±¼ä"
                blnÊ±¼ä = True
                mstrSQLÖÐ = mstrSQLÖÐ & ",Ê±¼ä"
                mstrSQLÄÚ = mstrSQLÄÚ & ",To_Char(l.·¢ÉúÊ±¼ä, 'hh24:mi') As Ê±¼ä"
                strSqlÍâ = strSqlÍâ & "||" & !ÒªËØÃû³Æ
                
            Case "Ç©ÃûÈË"
                blnÇ©ÃûÈË = True
                mstrSQLÖÐ = mstrSQLÖÐ & ",Ç©ÃûÈË"
                '51589:ÁõÅô·É,2013-03-01,Ìí¼Ó½»°àÇ©Ãû
                'mstrSQLÄÚ = mstrSQLÄÚ & ",l.Ç©ÃûÈË"
                mstrSQLÄÚ = mstrSQLÄÚ & ",DECODE(TRIM(NVL(L.Ç©ÃûÈË,'')),'',TRIM(L.Ç©ÃûÈË),DECODE(TRIM(NVL(L.½»°àÇ©ÃûÈË,'')),'',TRIM(L.Ç©ÃûÈË), TRIM(L.Ç©ÃûÈË) || '/' || TRIM(L.½»°àÇ©ÃûÈË))) Ç©ÃûÈË"
                strSqlÍâ = strSqlÍâ & "||" & !ÒªËØÃû³Æ
                
            Case "Ç©ÃûÊ±¼ä"
                blnÇ©ÃûÊ±¼ä = True
                mstrSQLÖÐ = mstrSQLÖÐ & ",Ç©ÃûÊ±¼ä"
                mstrSQLÄÚ = mstrSQLÄÚ & ",l.Ç©ÃûÊ±¼ä"
                strSqlÍâ = strSqlÍâ & "||" & !ÒªËØÃû³Æ
                
            Case "»¤Ê¿"
                bln»¤Ê¿ = True
                mstrSQLÖÐ = mstrSQLÖÐ & ",»¤Ê¿"
                mstrSQLÄÚ = mstrSQLÄÚ & ",l.±£´æÈË As »¤Ê¿"
                strSqlÍâ = strSqlÍâ & "||" & !ÒªËØÃû³Æ
            Case Else
                If !ÒªËØÃû³Æ <> "" Then
                 
                    mstrSQLÖÐ = mstrSQLÖÐ & ",Max(""" & !ÒªËØÃû³Æ & """) As """ & !ÒªËØÃû³Æ & """"
                    mstrSQLÌõ¼þ = mstrSQLÌõ¼þ & " Or """ & !ÒªËØÃû³Æ & """ Is Not Null"
                    
                    strSqlÍâ = strSqlÍâ & "||'" & !ÄÚÈÝÎÄ±¾ & "'||""" & !ÒªËØÃû³Æ & """||'" & !ÒªËØµ¥Î» & "'"
                    strSqlNull = strSqlNull & "||" & "'" & !ÄÚÈÝÎÄ±¾ & "'||'" & !ÒªËØµ¥Î» & "'"
                    mstrSQLÄÚ = mstrSQLÄÚ & ", Decode(c.ÏîÄ¿Ãû³Æ, '" & !ÒªËØÃû³Æ & "', c.¼ÇÂ¼ÄÚÈÝ, '') As """ & !ÒªËØÃû³Æ & """"
                    
''                    If bln¶Ô½ÇÏß And blnÑ¡ÔñÏî Then
''                        If strSqlÍâ <> "" Then
''                            'µÚ¶þÏî
''                            strSqlÍâ = strSqlÍâ & "||'/'||""" & !ÒªËØÃû³Æ & """"
''                        Else
''                            'µÚÒ»Ïî
''                            strSqlÍâ = strSqlÍâ & "||""" & !ÒªËØÃû³Æ & """"
''                        End If
''                    Else
''                        strSqlÍâ = strSqlÍâ & "||""" & !ÒªËØÃû³Æ & """"
''                        strSqlNull = strSqlNull & "||" & "'" & !ÄÚÈÝÎÄ±¾ & "'||'" & !ÒªËØµ¥Î» & "'"
''                    End If
''
''                    If (Trim("" & !ÄÚÈÝÎÄ±¾) = "" And Trim("" & !ÒªËØµ¥Î») = "") Or (bln¶Ô½ÇÏß And blnÑ¡ÔñÏî) Then
''                        mstrSQLÄÚ = mstrSQLÄÚ & ", Decode(c.ÏîÄ¿Ãû³Æ, '" & !ÒªËØÃû³Æ & "', Nvl(c.Î´¼ÇËµÃ÷,c.¼ÇÂ¼ÄÚÈÝ), '') As """ & !ÒªËØÃû³Æ & """"
''                    Else
''                        'mstrSQLÄÚ = mstrSQLÄÚ & ", Decode(c.ÏîÄ¿Ãû³Æ, '" & !ÒªËØÃû³Æ & "', Nvl(c.Î´¼ÇËµÃ÷,Decode(c.¼ÇÂ¼ÄÚÈÝ,Null,'" & !ÄÚÈÝÎÄ±¾ & "'||'" & !ÒªËØµ¥Î» & "','" & !ÄÚÈÝÎÄ±¾ & "'||c.¼ÇÂ¼ÄÚÈÝ||'" & !ÒªËØµ¥Î» & "')), '') As """ & !ÒªËØÃû³Æ & """"
''                        mstrSQLÄÚ = mstrSQLÄÚ & ", Decode(c.ÏîÄ¿Ãû³Æ, '" & !ÒªËØÃû³Æ & "', Nvl(c.Î´¼ÇËµÃ÷,Decode(c.¼ÇÂ¼ÄÚÈÝ,Null,'" & !ÄÚÈÝÎÄ±¾ & "'||'" & !ÒªËØµ¥Î» & "','" & !ÄÚÈÝÎÄ±¾ & "'||c.¼ÇÂ¼ÄÚÈÝ||'" & !ÒªËØµ¥Î» & "')),  '" & !ÄÚÈÝÎÄ±¾ & "'||'" & !ÒªËØµ¥Î» & "') As """ & !ÒªËØÃû³Æ & """"
''                    End If
                Else
                    'Îª¿Õ±íÊ¾Î´°ó¶¨ÁÐ,Ç¿ÖÆ¼Ó,ºóÃæ½øÐÐÌæ»»
                    mstrCOLNothing = mstrCOLNothing & "," & Val(Format(!¶ÔÏóÐòºÅ, "00"))
                    mstrSQLÖÐ = mstrSQLÖÐ & ",Max(""" & "C" & Format(!¶ÔÏóÐòºÅ, "00") & """) As C" & Format(!¶ÔÏóÐòºÅ, "00")
                    mstrSQLÌõ¼þ = mstrSQLÌõ¼þ & " Or """ & "C" & Format(!¶ÔÏóÐòºÅ, "00") & """ Is Not Null"
                    mstrSQLÄÚ = mstrSQLÄÚ & ", C" & Format(!¶ÔÏóÐòºÅ, "00") & " AS C" & Format(!¶ÔÏóÐòºÅ, "00")
                End If
            End Select
            .MoveNext
        Loop
        
        If mstrCollectItems <> "" Then
            mstrCollectItems = Mid(mstrCollectItems, 2)
            mstrColCollect = Mid(mstrColCollect, 2)
        End If
        'ÔÚInitRecordsÖÐÐèÒª¸ø»ã×ÜÏîÄ¿¹ØÁÐµÄÃû³ÆÁÐÃ÷Ìí¼ÓÏîÄ¿ÐòºÅ
        If Left(mstrColCorrelative, 1) = "|" Then mstrColCorrelative = Mid(mstrColCorrelative, 2)
        mstrCOLNothing = Mid(mstrCOLNothing, 2)
        mstrCatercorner = Mid(mstrCatercorner, 2)
        mstrColWidth = Mid(mstrColWidth, 2)
        '¼ÓÈë×îºóÒ»ÁÐµÄ¸ñÊ½
        mstrColumns = mstrColumns & IIf(mstrColumns = "", "", "'1'" & str¸ñÊ½) '& "|" & !¶ÔÏóÐòºÅ & "'" & !ÒªËØÃû³Æ
        mstrColumns = Mid(mstrColumns, 2)     '¸ñÊ½Èç:ÁÐºÅ;ÏîÄ¿Ãû³Æ1,ÏîÄ¿Ãû³Æ2|ÁÐºÅ...,ÊµÀý;1;ÌåÎÂ|2;Âö²«|3...

        If Mid(strSqlNull, 3) = "" Then
            strSqlNull = "''"
        Else
            strSqlNull = Mid(strSqlNull, 3)
        End If
        mstrSQLÁÐ = mstrSQLÁÐ & "," & IIf(Mid(strSqlÍâ, 3) = "", "''", "Decode(" & Mid(strSqlÍâ, 3) & "," & strSqlNull & ",''," & Mid(strSqlÍâ, 3) & ")") & " As C" & Format(lngColumn, "00")
                
                
        
        If mstrSQLÌõ¼þ <> "" Then mstrSQLÌõ¼þ = "(" & Mid(mstrSQLÌõ¼þ, 5) & ")"
        
        'Èç¹ûÃ»ÓÐ³öÏÖÈÕÆÚ£¬Ê±¼ä£¬»¤Ê¿£¬ÔòÄÚ²ãÐèÒª²¹³ä£¬ÒÔ±£Ö¤ÖÐ²ã·Ö×éµÄÕý³££º
        If blnÈÕÆÚ = False Then mstrSQLÄÚ = mstrSQLÄÚ & ",To_Char(l.·¢ÉúÊ±¼ä, 'yyyy-mm-dd') As ÈÕÆÚ"
        If blnÊ±¼ä = False Then mstrSQLÄÚ = mstrSQLÄÚ & ",To_Char(l.·¢ÉúÊ±¼ä, 'hh24:mi') As Ê±¼ä"
        If bln»¤Ê¿ = False Then mstrSQLÄÚ = mstrSQLÄÚ & ",l.±£´æÈË As »¤Ê¿"
        
        '51589:ÁõÅô·É,2013-03-01,Ìí¼Ó½»°àÇ©Ãû
        'If blnÇ©ÃûÈË = False Then mstrSQLÄÚ = mstrSQLÄÚ & ",l.Ç©ÃûÈË As Ç©ÃûÈË"
        If blnÇ©ÃûÈË = False Then mstrSQLÄÚ = mstrSQLÄÚ & ",DECODE(TRIM(NVL(L.Ç©ÃûÈË,'')),'',TRIM(L.Ç©ÃûÈË),DECODE(TRIM(NVL(L.½»°àÇ©ÃûÈË,'')),'',TRIM(L.Ç©ÃûÈË), TRIM(L.Ç©ÃûÈË) || '/' || TRIM(L.½»°àÇ©ÃûÈË))) Ç©ÃûÈË"
        If blnÇ©ÃûÊ±¼ä = False Then mstrSQLÄÚ = mstrSQLÄÚ & ",l.Ç©ÃûÊ±¼ä"
        
        If Mid(mstrSQLÖÐ, 2) = "" Then
            MsgBox "¶Ô²»Æð£¬ÄúÃ»ÓÐ¶¨Òåµ±Ç°»¤Àíµ¥µÄÏÔÊ¾ÁÐÐÅÏ¢£¬ÇëÔÚ²¡ÀúÎÄ¼þ¹ÜÀíÖÐ¶¨Òå£¡", vbInformation, gstrSysName
            Exit Function
        End If
        '50503:ÁõÅô·É,2012-09-12,Êý¾Ý´ÓÄ³Ò»Ò³µÚÒ»ÐÐ¾Í¿ªÊ¼¿çÒ³,Ìí¼Ó¿ªÊ¼ÐÐºÅ
        '56134:ÁõÅô·É,2012-12-19,²¡ÈË»¤Àí´òÓ¡Ìí¼Ó´òÓ¡±êÊ¶
        '46506:ÁõÅô·É,2012-12-27,²¡ÈË»¤Àí´òÓ¡Ìí¼Ó´òÓ¡½áÊøÒ³ºÅ£¬ÓÃÓÚ±êÊ¶¿çÒ³Êý¾Ý´òÓ¡
        '³ÌÐòÄÚ²¿¿ØÖÆÔö¼Ó¹Ì¶¨ÁÐ
        'ËµÃ÷Èç¹ûÒª¼ÓÁÐÇëÔÚ¡°´òÓ¡±êÊ¶¡±ÁÐÖ®Ç°Ìí¼Ó£¬·ñÔòÇëÐÞ¸ÄzlPrintMdl
        str»ã×ÜÖµ = " Decode(Instr('|" & mstrColCollect & "|', ';' || C.ÏîÄ¿ÐòºÅ || '|'), 0," & _
                  " Decode(Instr('|" & mstrColCollect & "|', ',' || C.ÏîÄ¿ÐòºÅ || '|'), 0," & _
                  " Decode(Instr('|" & mstrColCollect & "|', ';' || C.ÏîÄ¿ÐòºÅ || ','), 0, Null, " & _
                  " Substr(Substr('|" & mstrColCollect & "|', 1, Instr('|" & mstrColCollect & "|', ';' || C.ÏîÄ¿ÐòºÅ || ',') - 1) || ';' || C.ÏîÄ¿ÐòºÅ," & _
                  " Instr(Substr('|" & mstrColCollect & "|', 1, Instr('|" & mstrColCollect & "|', ';' || C.ÏîÄ¿ÐòºÅ || ',') - 1) || ';' || C.ÏîÄ¿ÐòºÅ, '|', -1) + 1)), " & _
                  " Substr(Substr('|" & mstrColCollect & "|', 1, Instr('|" & mstrColCollect & "|', ',' || C.ÏîÄ¿ÐòºÅ || '|') - 1) || ',' || C.ÏîÄ¿ÐòºÅ, " & _
                  " Instr(Substr('|" & mstrColCollect & "|', 1, Instr('|" & mstrColCollect & "|', ',' || C.ÏîÄ¿ÐòºÅ || '|') - 1) || ',' || " & _
                  " C.ÏîÄ¿ÐòºÅ, '|', -1) + 1)),Substr(Substr('|" & mstrColCollect & "|', 1, Instr('|" & mstrColCollect & "|', ';' || C.ÏîÄ¿ÐòºÅ || '|') - 1) || ';' || C.ÏîÄ¿ÐòºÅ, " & _
                  " Instr(Substr('|" & mstrColCollect & "|', 1, Instr('|" & mstrColCollect & "|', ';' || C.ÏîÄ¿ÐòºÅ || '|') - 1) || ';' || C.ÏîÄ¿ÐòºÅ, '|', -1) + 1)) »ã×ÜÖµ "
                  
        mstrSQLÖÐ = UCase(mstrSQLÖÐ & ",MAX(Ç©Ãû¼¶±ð) AS Ç©Ãû¼¶±ð,MAX(Ç©ÃûÐÅÏ¢) AS Ç©ÃûÐÅÏ¢,MAX(½»°àÇ©ÃûÈË) AS ½»°àÇ©ÃûÈË,MAX(ÎÄ¼þID) AS ÎÄ¼þID,MAX(¼ÇÂ¼ID) AS ¼ÇÂ¼ID,MAX(ÐÐÊý) AS ÐÐÊý,MAX(Êµ¼ÊÐÐÊý) AS Êµ¼ÊÐÐÊý,MAX(¿ªÊ¼ÐÐºÅ) AS ¿ªÊ¼ÐÐºÅ,MAX(´òÓ¡½áÊøÒ³ºÅ) as ´òÓ¡½áÊøÒ³ºÅ,f_List2str(Cast(Collect(»ã×ÜÖµ) As t_Strlist), '|') »ã×ÜÖµ,MAX(´òÓ¡±êÊ¶) AS ´òÓ¡±êÊ¶,MAX(»ã×ÜÀà±ð) AS »ã×ÜÀà±ð,MAX(»ã×ÜÎÄ±¾) AS »ã×ÜÎÄ±¾,MAX(»ã×Ü±ê¼Ç) AS »ã×Ü±ê¼Ç,MAX(»ã×ÜÈÕÆÚ) AS »ã×ÜÈÕÆÚ,MAX(´òÓ¡Ò³ºÅ) AS ´òÓ¡Ò³ºÅ,MAX(´òÓ¡ÐÐºÅ) AS ´òÓ¡ÐÐºÅ")
        mstrSQLÄÚ = UCase(mstrSQLÄÚ & ",l.Ç©Ãû¼¶±ð,l.Ç©ÃûÈË AS Ç©ÃûÐÅÏ¢,l.½»°àÇ©ÃûÈË,l.ÎÄ¼þID,C.¼ÇÂ¼ID,P.ÐÐÊý||'' AS ÐÐÊý,DECODE(SIGN(P.½áÊøÒ³ºÅ-P.¿ªÊ¼Ò³ºÅ),1,DECODE(SIGN([5]-P.¿ªÊ¼Ò³ºÅ),1, P.½áÊøÐÐºÅ,P.ÐÐÊý-P.½áÊøÐÐºÅ ),P.ÐÐÊý) AS Êµ¼ÊÐÐÊý,DECODE(SIGN(P.½áÊøÒ³ºÅ-P.¿ªÊ¼Ò³ºÅ),1,DECODE(SIGN([5]-P.¿ªÊ¼Ò³ºÅ),1,P.¿ªÊ¼ÐÐºÅ+P.ÐÐÊý-P.½áÊøÐÐºÅ,P.¿ªÊ¼ÐÐºÅ),P.¿ªÊ¼ÐÐºÅ) ¿ªÊ¼ÐÐºÅ,P.´òÓ¡½áÊøÒ³ºÅ," & str»ã×ÜÖµ & ",P.´òÓ¡±êÊ¶,NVL(L.»ã×ÜÀà±ð,0) AS »ã×ÜÀà±ð,L.»ã×ÜÎÄ±¾,L.»ã×Ü±ê¼Ç,to_char(L.·¢ÉúÊ±¼ä,'yyyy-MM-dd hh24:mi:ss')||'' AS »ã×ÜÈÕÆÚ,p.´òÓ¡Ò³ºÅ,p.´òÓ¡ÐÐºÅ")
        mstrSQLÁÐ = UCase(mstrSQLÁÐ & ",Ç©Ãû¼¶±ð,Ç©ÃûÐÅÏ¢,½»°àÇ©ÃûÈË,ÎÄ¼þID,¼ÇÂ¼ID,ÐÐÊý,Êµ¼ÊÐÐÊý,¿ªÊ¼ÐÐºÅ,´òÓ¡½áÊøÒ³ºÅ,»ã×ÜÖµ,´òÓ¡±êÊ¶,»ã×ÜÀà±ð,»ã×ÜÎÄ±¾,»ã×Ü±ê¼Ç,»ã×ÜÈÕÆÚ,´òÓ¡Ò³ºÅ,´òÓ¡ÐÐºÅ")
        
        
        '½«»î¶¯ÏîÄ¿¼ÓÈëµ½SQLÖÐ
        Call DelActiveNoUsed
        Call PreActiveCOL
        'Call SQLCombination
    End With
    
    ReadStruDef = True
    Exit Function
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Function

Private Sub PreActiveHead()
    Dim arrData
    Dim intCol As Integer
    Dim strName As String
    Dim intDo As Integer, intCount As Integer
    '¸üÐÂ±íÍ·
    
    arrData = Split(mstrCOLActive, "||")
    intCount = UBound(arrData)
    For intDo = 0 To intCount
        intCol = Split(Split(arrData(intDo), "|")(0), ";")(0)
        strName = Split(Split(arrData(intDo), "|")(0), ";")(1)
        VsfData.TextMatrix(mintTabTiers - 1, intCol + cHideCols + VsfData.FixedCols - 1) = strName
        If mintTabTiers = 3 And VsfData.TextMatrix(1, intCol + cHideCols + VsfData.FixedCols - 1) = "" Then VsfData.TextMatrix(1, intCol + cHideCols + VsfData.FixedCols - 1) = strName
        If mintTabTiers = 2 And VsfData.TextMatrix(0, intCol + cHideCols + VsfData.FixedCols - 1) = "" Then VsfData.TextMatrix(0, intCol + cHideCols + VsfData.FixedCols - 1) = strName
    Next
End Sub

Private Function DelActiveNoUsed() As Boolean
'------------------------------------------------
'¹¦ÄÜ:É¾³ý°ó¶¨ÔÚ·Ç¿ÕÁÐÉÏµÄ»î¶¯ÏîÄ¿ÁÐÐÅÏ¢
'±àÖÆ:ÁõÅô·É,2013-07-16
'ÎÊÌâºÅ:63401
'------------------------------------------------
    Dim arrData, arrActive, arrCol
    Dim strSQL As String
    Dim lngCol As Long, intDo As Integer, intCount As Integer
    Dim blnTran As Boolean
    
    If mstrCOLNothing = "" Then DelActiveNoUsed = True: Exit Function
    arrActive = Array()
    arrCol = Array()
    arrData = Split(mstrCOLActive, "||")
    intCount = UBound(arrData)
    For intDo = 0 To intCount
        lngCol = Val(Split(Split(arrData(intDo), "|")(0), ";")(0))
        If InStr(1, "," & mstrCOLNothing & ",", "," & lngCol & ",") <> 0 Then
            '¼ÇÂ¼ÏÖÓÐÕý³£¿ÕÁÐÉÏµÄ»î¶¯ÏîÄ¿ÉèÖÃÐÅÏ¢
            ReDim Preserve arrActive(UBound(arrActive) + 1)
            arrActive(UBound(arrActive)) = CStr(arrData(intDo))
        Else
            '¼ÇÂ¼½«ÒªÒÆ³ýµÄ»î¶¯ÏîÄ¿ÁÐºÅ
            ReDim Preserve arrCol(UBound(arrCol) + 1)
            arrCol(UBound(arrCol)) = lngCol
        End If
    Next
    
    On Error GoTo ErrHand
    
    'É¾³ý²»ÐèÒªµÄ»î¶¯ÏîÄ¿ÐÅÏ¢(Ö÷ÒªÊÇÐÞÕýÖ®Ç°´íÎóµÄÊý¾Ý,·¢ÉúÇé¿ö½ÏÉÙ)
    If UBound(arrCol) > 1 Then
        gcnOracle.BeginTrans
        blnTran = True
    End If
    
    For intDo = 0 To UBound(arrCol)
        If CStr(arrCol(intDo)) <> "" Then
            strSQL = "ZL_²¡ÈË»¤ÀíÒ³Ãæ_UPDATE(" & mlngµ±Ç°ÎÄ¼þID & "," & mintÒ³Âë & "," & Val(arrCol(intDo)) & ",NULL,'" & gstrUserName & "')"
            Call zlDatabase.ExecuteProcedure(strSQL, "±£´æ»î¶¯ÏîÄ¿°ó¶¨Êý¾Ý")
        End If
    Next
    If blnTran = True Then gcnOracle.CommitTrans
    
    'ÖØÐÂ¸üÐÂÌáÈ¡µÄ»î¶¯ÏîÄ¿ÁÐÐÅÏ¢
    If UBound(arrActive) = -1 Then
        mstrCOLActive = ""
    Else
        mstrCOLActive = Join(arrActive, "||")
    End If
    
    DelActiveNoUsed = True
    Exit Function
ErrHand:
    If blnTran = True Then gcnOracle.RollbackTrans
    If ErrCenter = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub PreActiveCOL()
    Dim arrData
    Dim arrCol
    Dim intCol As Integer, strName As String
    Dim strColFormat As String, strCOLNames As String, strCOLPart As String, strCOLCOND As String, strCOLDEF As String, strCOLMID As String, strCOLIN As String
    Dim intDo As Integer, intCount As Integer
    Dim intIn As Integer, intMax As Integer
    '½«»î¶¯ÏîÄ¿¼ÓÈëµ½²éÑ¯SQLÖÐ£¬¸ñÊ½£ºÁÐºÅ;±íÍ·Ãû³Æ|ÏîÄ¿ÐòºÅ,²¿Î»;ÏîÄ¿ÐòºÅ,²¿Î»||ÁÐºÅ;±íÍ·Ãû³Æ...
    '°ó¶¨¶à¸öÏîÄ¿£¬¸ÃÁÐ¾Í×Ô¶¯×ªÎª¶Ô½ÇÏßÁÐ
    
    arrData = Split(mstrCOLActive, "||")
    intCount = UBound(arrData)
    For intDo = 0 To intCount
        intCol = Split(Split(arrData(intDo), "|")(0), ";")(0)
        strName = Split(Split(arrData(intDo), "|")(0), ";")(1)
        arrCol = Split(Split(arrData(intDo), "|")(1), ";")
        
        '´¦ÀíÁÐ±íÊ¾(Ã¿ÁÐ×î¶à°ó¶¨Á½¸öÏîÄ¿)
        strCOLPart = ""
        strCOLNames = ""
        strColFormat = ""
        strCOLCOND = ""
        strCOLMID = ""
        strCOLIN = ""
        strCOLDEF = ""
        intMax = UBound(arrCol)
        For intIn = 0 To intMax
            strCOLPart = Split(arrCol(intIn), ",")(1)
            mrsItems.Filter = "ÏîÄ¿ÐòºÅ=" & Val(Split(arrCol(intIn), ",")(0))
            strCOLNames = strCOLNames & "," & mrsItems!ÏîÄ¿Ãû³Æ
            strCOLCOND = strCOLCOND & " OR """ & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & """ IS NOT NULL"
            strCOLMID = strCOLMID & ",Max(""" & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & """) As """ & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & """"
            If intIn = 0 Then
                strCOLIN = strCOLIN & ", Decode(" & IIf(strCOLPart = "", "", "c.ÌåÎÂ²¿Î»||") & "c.ÏîÄ¿Ãû³Æ, '" & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & "', Nvl(c.Î´¼ÇËµÃ÷,c.¼ÇÂ¼ÄÚÈÝ), '') As """ & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & """"
            Else
                strCOLIN = strCOLIN & ", Decode(" & IIf(strCOLPart = "", "", "c.ÌåÎÂ²¿Î»||") & "c.ÏîÄ¿Ãû³Æ, '" & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & "', Nvl(c.Î´¼ÇËµÃ÷,Decode(c.¼ÇÂ¼ÄÚÈÝ,Null,'/','/'||c.¼ÇÂ¼ÄÚÈÝ||'')), '') As """ & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & """"
            End If
            If intIn = 0 Then
                If intMax = 0 Then
                    strCOLDEF = strCOLDEF & " """ & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & """ AS C" & Format(intCol, "00")
                Else
                    strCOLDEF = strCOLDEF & " """ & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & """||"
                End If
            Else
                strCOLDEF = strCOLDEF & "NVL(""" & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & """,'/')"
                If intIn = intMax Then
                    strCOLDEF = "Decode(" & strCOLDEF & ",'" & String(intMax, "/") & "',''," & strCOLDEF & ") As C" & Format(intCol, "00")
                End If
            End If
            
            strColFormat = strColFormat & "{[" & strCOLPart & mrsItems!ÏîÄ¿Ãû³Æ & "]" & IIf(intMax > 0 And intIn < intMax, "/", "") & "}"
        Next
        If strCOLPart <> "" Then
            strCOLPart = Mid(strCOLPart, 2)
        End If
        strCOLNames = Mid(strCOLNames, 2)
        
        '¶Ô½ÇÏß
        If intMax > 0 Then
            mstrCatercorner = mstrCatercorner & IIf(mstrCatercorner = "", "", ",") & intCol
        End If
        'ÁÐ¸ñÊ½:15'»¤Ê¿'1'{[»¤Ê¿]}
        '77476:LPF:»î¶¯ÁÐÌæ»»intcolÇ°Ìí¼Ó"|"×Ö·û,±ÜÃâµÚ3ÁÐºÍµÚ13ÁÐ¶¼Îª»î¶¯ÏîÄ¿Ê±ÏîÄ¿Ìæ»»´íÎó
        mstrColumns = Replace(mstrColumns, "|" & intCol & "''1'", "|" & intCol & "'" & strCOLNames & "'1'" & strColFormat)
        'ÁÐ
        mstrSQLÁÐ = Replace(mstrSQLÁÐ, "'' AS C" & Format(intCol, "00"), strCOLDEF)
        'Ìõ¼þ
         '53893:ÁõÅô·É,2012-09-21,´¦Àí»î¶¯ÏîÄ¿°ó¶¨ÔÚÊ±¼äºóÃæµÄÇé¿ö
        'mstrSQLÌõ¼þ = Replace(UCase(mstrSQLÌõ¼þ), " OR """ & "C" & Format(intCol, "00") & """ IS NOT NULL", strCOLCOND)
        mstrSQLÌõ¼þ = Replace(UCase(Replace(UCase(mstrSQLÌõ¼þ), " OR """ & "C" & Format(intCol, "00") & """ IS NOT NULL", strCOLCOND)), """" & "C" & Format(intCol, "00") & """ IS NOT NULL", Mid(strCOLCOND, 5))
        'ÖÐ
        mstrSQLÖÐ = Replace(mstrSQLÖÐ, ",MAX(""" & "C" & Format(intCol, "00") & """) AS C" & Format(intCol, "00"), strCOLMID)
        'ÄÚ
        mstrSQLÄÚ = Replace(mstrSQLÄÚ, ", C" & Format(intCol, "00") & " AS C" & Format(intCol, "00"), strCOLIN)
    Next
    mrsItems.Filter = 0
    
    '½«Î´°ó¶¨µÄÁÐµÄSQL²¿·ÖÁ¬ÐøÖØ´ò
    If mstrCOLNothing = "" Then Exit Sub
    arrData = Split(mstrCOLNothing, ",")
    intCount = UBound(arrData)
    For intDo = 0 To intCount
        'ÁÐ(±ØÐëÒª±£Áô)
'        mstrSQLÁÐ = Replace(mstrSQLÁÐ, ",'' AS C" & arrData(intDo), "")
        'Ìõ¼þ
        'mstrSQLÌõ¼þ = Replace(UCase(mstrSQLÌõ¼þ), " OR """ & "C" & Format(arrData(intDo), "00") & """ IS NOT NULL", "")
        mstrSQLÌõ¼þ = Replace(UCase(Replace(UCase(mstrSQLÌõ¼þ), " OR """ & "C" & Format(arrData(intDo), "00") & """ IS NOT NULL", "")), """" & "C" & Format(arrData(intDo), "00") & """ IS NOT NULL OR ", "")
        mstrSQLÌõ¼þ = Replace(UCase(mstrSQLÌõ¼þ), "(""" & "C" & Format(arrData(intDo), "00") & """ IS NOT NULL)", "")

        'ÖÐ
        mstrSQLÖÐ = Replace(mstrSQLÖÐ, ",MAX(""" & "C" & Format(arrData(intDo), "00") & """) AS C" & Format(arrData(intDo), "00"), "")
        'ÄÚ
        mstrSQLÄÚ = Replace(mstrSQLÄÚ, ", C" & Format(arrData(intDo), "00") & " AS C" & Format(arrData(intDo), "00"), "")
    Next
End Sub

Private Sub SQLCombination(ByVal strÌõ¼þ As String)
    mstrSQL = "Select  '' as ±¸ÓÃ,·¢ÉúÊ±¼ä,·¢ÉúÊ±¼ä ·¢ÉúÊ±¼ä1," & Mid(mstrSQLÁÐ, 12) & vbCrLf & _
                " From (Select ¼ÇÂ¼×éºÅ,Ê±¼ä as ±¸ÓÃ,·¢ÉúÊ±¼ä," & Mid(mstrSQLÖÐ, 2) & vbCrLf & _
                "        From (Select nvl(c.¼ÇÂ¼×éºÅ,0) ¼ÇÂ¼×éºÅ,to_char(l.·¢ÉúÊ±¼ä,'yyyy-MM-dd hh24:mi:ss') AS ·¢ÉúÊ±¼ä," & Mid(mstrSQLÄÚ, 2) & vbCrLf & _
                "               From ²¡ÈË»¤ÀíÊý¾Ý l, ²¡ÈË»¤ÀíÃ÷Ï¸ c,²¡ÈË»¤ÀíÎÄ¼þ f,²¡ÈË»¤Àí´òÓ¡ p " & vbCrLf & _
                "               Where l.ID=p.¼ÇÂ¼ID And l.Id = c.¼ÇÂ¼id And l.ÎÄ¼þID+0=f.ID+0 And f.ID=p.ÎÄ¼þID " & _
                "               And c.ÖÕÖ¹°æ±¾ Is Null And c.¼ÇÂ¼ÀàÐÍ<>5  " & _
                "               And f.id=[1] And f.²¡ÈËid = [2] And f.Ö÷Ò³id = [3] And Nvl(f.Ó¤¶ù,0)=[4] " & strÌõ¼þ & ")" & vbCrLf & _
                IIf(mstrSQLÌõ¼þ <> "", "Where " & mstrSQLÌõ¼þ, "") & _
                "       Group By ÈÕÆÚ, Ê±¼ä, ·¢ÉúÊ±¼ä,¼ÇÂ¼×éºÅ,»¤Ê¿,Ç©ÃûÈË,Ç©ÃûÊ±¼ä" & _
                                "       Order By ·¢ÉúÊ±¼ä,¼ÇÂ¼×éºÅ,»¤Ê¿,Ç©ÃûÈË,Ç©ÃûÊ±¼ä)"
End Sub

Private Sub zlReadTip(aryPeriod)
    Dim aryRow() As String, aryItem() As String
    Dim strPrefix As String, strItemName As String
    Dim lngRow As Long, lngCol As Long, lngCount As Long, strCell As String, strBed As String
    Dim strTmpSQL As String
    Dim strTmp As String
    Dim blnReplace As Boolean
    
    Err = 0: On Error GoTo ErrHand
    
    '±íÉÏ±êÇ©»ñÈ¡
    lblSubhead.Caption = ""
    lblSubhead.Tag = ""
    
    '87057,²¡ÈË10:30:20×ª¿ÆÈë×¡½¨Á¢»¤ÀíÎÄ¼þÊ±¼äÎª10:30:20,´ËÊ±Â¼ÈëÊ×ÌõÊý¾ÝÎª10:30(¼ÇÂ¼µ¥ÎÞ·¨Â¼ÈëÃë),µ¼ÖÂÎÞ·¨ÏÔÊ¾ÐÂµÄ¿ÆÊÒ
    aryPeriod(0) = Format(aryPeriod(0), "YYYY-MM-DD HH:mm") & ":59"
    
    '»ñÈ¡µ±Ç°Ò³Ö®Ç°µÄ×îºó¿ÆÊÒID
    gstrSQL = "Select ¿ÆÊÒID From ²¡ÈË±ä¶¯¼ÇÂ¼ " & _
        "   Where  ²¡ÈËID=[1] And Ö÷Ò³ID=[2] And [3]>=¿ªÊ¼Ê±¼ä " & _
        " And ¿ªÊ¼Ê±¼ä IS NOT NULL And ¿ÆÊÒid IS NOT NULL And NVL(¸½¼Ó´²Î»,0)=0 Order by ¿ªÊ¼Ê±¼ä DESC"
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "»ñÈ¡µ±Ç°Ò³Ö®Ç°µÄ×îºó¿ÆÊÒID", mlng²¡ÈËID, mlngÖ÷Ò³ID, CDate(aryPeriod(0)))
    If mrsTemp.RecordCount > 0 Then mlng¿ÆÊÒID = Val(mrsTemp!¿ÆÊÒID)
    
    gstrSQL = "Select [1] || Zl_Replace_Element_Value([2],[3],[4],2,NULL,[5],[6]) as ÐÅÏ¢ From Dual"
    aryItem = Split(mstrSubhead, "|")
        
    For lngCount = 0 To UBound(aryItem)
        strPrefix = Left(aryItem(lngCount), InStr(1, aryItem(lngCount), "{") - 1)
        strItemName = Mid(aryItem(lngCount), InStr(1, aryItem(lngCount), "{") + 1, InStr(1, aryItem(lngCount), "}") - InStr(1, aryItem(lngCount), "{") - 1)
        
        strTmp = strPrefix
        strCell = ""
        '68336
        blnReplace = True
        mrsElement.Filter = "ÖÐÎÄÃû='" & strItemName & "'"
        If mrsElement.RecordCount > 0 Then
            blnReplace = Val(NVL(mrsElement!Ìæ»»Óò, 0)) = 1
        End If
        Select Case strItemName
        Case "µ±Ç°²¡Çø"
        
            strTmpSQL = "Select   b.Ãû³Æ" & vbNewLine & _
                        "From (Select ²¡Çøid, ¿ªÊ¼Ê±¼ä, Nvl(ÖÕÖ¹Ê±¼ä, To_Date('3000-01-01', 'yyyy-mm-dd')) As ÖÕÖ¹Ê±¼ä" & vbNewLine & _
                        "            From ²¡ÈË±ä¶¯¼ÇÂ¼" & vbNewLine & _
                        "            Where ²¡ÈËid = [1] And Ö÷Ò³id = [2] And ¿ÆÊÒid = [3]¡¡And NVL(¸½¼Ó´²Î»,0)=0 And ¿ªÊ¼Ê±¼ä IS NOT NULL) a,²¿ÃÅ±í b " & vbNewLine & _
                        "Where ([4] Between a.¿ªÊ¼Ê±¼ä And a.ÖÕÖ¹Ê±¼ä Or [4] >= a.¿ªÊ¼Ê±¼ä) And a.²¡Çøid Is Not Null And b.ID=a.²¡Çøid" & vbNewLine & _
                        "Order By a.¿ªÊ¼Ê±¼ä"
                        
            Set mrsTemp = zlDatabase.OpenSQLRecord(strTmpSQL, "µ±Ç°²¡Çø", mlng²¡ÈËID, mlngÖ÷Ò³ID, mlng¿ÆÊÒID, CDate(aryPeriod(0)), CDate(aryPeriod(1)))
            If mrsTemp.BOF = False Then mrsTemp.MoveLast
            
        Case "µ±Ç°´²ºÅ"

            strTmpSQL = "Select   a.´²ºÅ" & vbNewLine & _
                        "From (Select ´²ºÅ, ¿ªÊ¼Ê±¼ä, Nvl(ÖÕÖ¹Ê±¼ä, To_Date('3000-01-01', 'yyyy-mm-dd')) As ÖÕÖ¹Ê±¼ä" & vbNewLine & _
                        "            From ²¡ÈË±ä¶¯¼ÇÂ¼" & vbNewLine & _
                        "            Where ²¡ÈËid = [1] And Ö÷Ò³id = [2] And ¿ÆÊÒid = [3]¡¡And NVL(¸½¼Ó´²Î»,0)=0 And ¿ªÊ¼Ê±¼ä IS NOT NULL) a" & vbNewLine & _
                        "Where ([4] Between a.¿ªÊ¼Ê±¼ä And a.ÖÕÖ¹Ê±¼ä Or [4] >= a.¿ªÊ¼Ê±¼ä) And a.´²ºÅ Is Not Null" & vbNewLine & _
                        "Order By a.¿ªÊ¼Ê±¼ä"

            Set mrsTemp = zlDatabase.OpenSQLRecord(strTmpSQL, "µ±Ç°´²ºÅ", mlng²¡ÈËID, mlngÖ÷Ò³ID, mlng¿ÆÊÒID, CDate(aryPeriod(0)), CDate(aryPeriod(1)))
            If mrsTemp.BOF = False Then mrsTemp.MoveLast
        Case "´²Î»±ä¶¯"
            strTmpSQL = "Select   a.´²ºÅ" & vbNewLine & _
                        "From (Select ´²ºÅ, ¿ªÊ¼Ê±¼ä, Nvl(ÖÕÖ¹Ê±¼ä, To_Date('3000-01-01', 'yyyy-mm-dd')) As ÖÕÖ¹Ê±¼ä" & vbNewLine & _
                        "            From ²¡ÈË±ä¶¯¼ÇÂ¼" & vbNewLine & _
                        "            Where ²¡ÈËid = [1] And Ö÷Ò³id = [2] And ¿ÆÊÒid = [3] And NVL(¸½¼Ó´²Î»,0)=0 And ¿ªÊ¼Ê±¼ä IS NOT NULL) a" & vbNewLine & _
                        "Where (a.ÖÕÖ¹Ê±¼ä>=[4] And a.¿ªÊ¼Ê±¼ä<=[5]) And a.´²ºÅ Is Not Null" & vbNewLine & _
                        "Order By a.¿ªÊ¼Ê±¼ä"

            Set mrsTemp = zlDatabase.OpenSQLRecord(strTmpSQL, "µ±Ç°´²ºÅ", mlng²¡ÈËID, mlngÖ÷Ò³ID, mlng¿ÆÊÒID, CDate(aryPeriod(0)), CDate(aryPeriod(1)))
            strCell = "": strBed = ""
            Do While Not mrsTemp.EOF
                If strBed <> mrsTemp.Fields(0).Value Then
                    strBed = mrsTemp.Fields(0).Value
                    strCell = strCell & "->" & mrsTemp.Fields(0).Value
                End If
            mrsTemp.MoveNext
            Loop
            strCell = Mid(strCell, 3)
            If mrsTemp.RecordCount > 0 Then mrsTemp.MoveFirst
        Case "µ±Ç°¿ÆÊÒ"
        
            strTmpSQL = "Select   Ãû³Æ From ²¿ÃÅ±í a Where a.ID=[1]"
            Set mrsTemp = zlDatabase.OpenSQLRecord(strTmpSQL, "µ±Ç°¿ÆÊÒ", mlng¿ÆÊÒID)
            
        Case "×¡ÔºÒ½Ê¦"
            strTmpSQL = "Select   a.¾­ÖÎÒ½Ê¦" & vbNewLine & _
                        "From (Select ¾­ÖÎÒ½Ê¦, ¿ªÊ¼Ê±¼ä, Nvl(ÖÕÖ¹Ê±¼ä, To_Date('3000-01-01', 'yyyy-mm-dd')) As ÖÕÖ¹Ê±¼ä" & vbNewLine & _
                        "            From ²¡ÈË±ä¶¯¼ÇÂ¼" & vbNewLine & _
                        "            Where ²¡ÈËid = [1] And Ö÷Ò³id = [2] And ¿ÆÊÒid = [3]¡¡And NVL(¸½¼Ó´²Î»,0)=0 And ¿ªÊ¼Ê±¼ä IS NOT NULL) a" & vbNewLine & _
                        "Where ([4] Between a.¿ªÊ¼Ê±¼ä And a.ÖÕÖ¹Ê±¼ä Or [4] >= a.¿ªÊ¼Ê±¼ä) And a.¾­ÖÎÒ½Ê¦ Is Not Null" & vbNewLine & _
                        "Order By a.¿ªÊ¼Ê±¼ä"
            Set mrsTemp = zlDatabase.OpenSQLRecord(strTmpSQL, "×¡ÔºÒ½Ê¦", mlng²¡ÈËID, mlngÖ÷Ò³ID, mlng¿ÆÊÒID, CDate(aryPeriod(0)), CDate(aryPeriod(1)))
            If mrsTemp.BOF = False Then mrsTemp.MoveLast
        Case "ÔðÈÎ»¤Ê¿"
        
            strTmpSQL = "Select   a.ÔðÈÎ»¤Ê¿" & vbNewLine & _
                        "From (Select ÔðÈÎ»¤Ê¿, ¿ªÊ¼Ê±¼ä, Nvl(ÖÕÖ¹Ê±¼ä, To_Date('3000-01-01', 'yyyy-mm-dd')) As ÖÕÖ¹Ê±¼ä" & vbNewLine & _
                        "            From ²¡ÈË±ä¶¯¼ÇÂ¼" & vbNewLine & _
                        "            Where ²¡ÈËid = [1] And Ö÷Ò³id = [2] And ¿ÆÊÒid = [3]¡¡And NVL(¸½¼Ó´²Î»,0)=0 And ¿ªÊ¼Ê±¼ä IS NOT NULL) a" & vbNewLine & _
                        "Where ([4] Between a.¿ªÊ¼Ê±¼ä And a.ÖÕÖ¹Ê±¼ä Or [4] >= a.¿ªÊ¼Ê±¼ä) And a.ÔðÈÎ»¤Ê¿ Is Not Null" & vbNewLine & _
                        "Order By a.¿ªÊ¼Ê±¼ä"
            Set mrsTemp = zlDatabase.OpenSQLRecord(strTmpSQL, "ÔðÈÎ»¤Ê¿", mlng²¡ÈËID, mlngÖ÷Ò³ID, mlng¿ÆÊÒID, CDate(aryPeriod(0)), CDate(aryPeriod(1)))
            If mrsTemp.BOF = False Then mrsTemp.MoveLast
            
        Case "»¤ÀíµÈ¼¶"
            strTmpSQL = "Select   b.Ãû³Æ" & vbNewLine & _
                        "From (Select »¤ÀíµÈ¼¶ID, ¿ªÊ¼Ê±¼ä, Nvl(ÖÕÖ¹Ê±¼ä, To_Date('3000-01-01', 'yyyy-mm-dd')) As ÖÕÖ¹Ê±¼ä" & vbNewLine & _
                        "            From ²¡ÈË±ä¶¯¼ÇÂ¼" & vbNewLine & _
                        "            Where ²¡ÈËid = [1] And Ö÷Ò³id = [2] And ¿ÆÊÒid = [3]¡¡And NVL(¸½¼Ó´²Î»,0)=0 And ¿ªÊ¼Ê±¼ä IS NOT NULL) a,»¤ÀíµÈ¼¶ b" & vbNewLine & _
                        "Where ([4] Between a.¿ªÊ¼Ê±¼ä And a.ÖÕÖ¹Ê±¼ä Or [4] >= a.¿ªÊ¼Ê±¼ä) And a.»¤ÀíµÈ¼¶ID Is Not Null And b.ÐòºÅ=a.»¤ÀíµÈ¼¶ID" & vbNewLine & _
                        "Order By a.¿ªÊ¼Ê±¼ä"
            Set mrsTemp = zlDatabase.OpenSQLRecord(strTmpSQL, "»¤ÀíµÈ¼¶", mlng²¡ÈËID, mlngÖ÷Ò³ID, mlng¿ÆÊÒID, CDate(aryPeriod(0)), CDate(aryPeriod(1)))
            If mrsTemp.BOF = False Then mrsTemp.MoveLast
            
        Case "×îºóÕï¶Ï"
            strTmp = strPrefix
            gstrSQL = " Select f_List2str(Cast(Collect(Rownum || '¡¢' || Õï¶ÏÄÚÈÝ) As t_Strlist), ' ') As Õï¶ÏÄÚÈÝ from (Select Õï¶ÏÄÚÈÝ From ( Select  Õï¶ÏÄÚÈÝ || Decode(Nvl(ÊÇ·ñÒÉÕï, 0), 0, '', ' (£¿)') Õï¶ÏÄÚÈÝ ,Mod(Õï¶ÏÀàÐÍ, 10) Õï¶ÏÀàÐÍ, ±ê¼ÇÊ±¼ä " & vbNewLine & _
                    "                   From ²¡ÈË»¤ÀíÕï¶Ï C" & vbNewLine & _
                    "                      Where ²¡ÈËid = [1] And Ö÷Ò³id = [2] And ÎÄ¼þid = [3] And c.±ê¼ÇÊ±¼ä Between [4] And [5])" & vbNewLine & _
                    "                       Group By Õï¶ÏÄÚÈÝ Order By Min(±ê¼ÇÊ±¼ä), Min(Õï¶ÏÀàÐÍ)) "
            Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "È¡ÉèÖÃµÄÕï¶Ï", mlng²¡ÈËID, mlngÖ÷Ò³ID, mlngµ±Ç°ÎÄ¼þID, CDate(Format(aryPeriod(0), "YYYY-MM-DD hh:mm")), CDate(aryPeriod(1)))
            If NVL(mrsTemp!Õï¶ÏÄÚÈÝ) = "" Then
                gstrSQL = " Select f_List2str(Cast(Collect(Rownum || '¡¢' || Õï¶ÏÄÚÈÝ) As t_Strlist), ' ') As Õï¶ÏÄÚÈÝ from (Select Õï¶ÏÄÚÈÝ From ( Select Õï¶ÏÄÚÈÝ || Decode(Nvl(ÊÇ·ñÒÉÕï, 0), 0, '', ' (£¿)') Õï¶ÏÄÚÈÝ, Õï¶ÏÀàÐÍ,±ê¼ÇÊ±¼ä" & vbNewLine & _
                    "                                                  From (Select  Distinct Õï¶ÏÄÚÈÝ,Õï¶ÏÀàÐÍ, ±ê¼ÇÊ±¼ä, ÊÇ·ñÒÉÕï," & vbNewLine & _
                    "                                                                Rank() Over(Partition By ÎÄ¼þid Order By ±ê¼ÇÊ±¼ä Desc) As Top" & vbNewLine & _
                    "                                                         From (Select ÎÄ¼þid,Õï¶ÏÄÚÈÝ, ±ê¼ÇÊ±¼ä, Õï¶ÏÀàÐÍ, ÊÇ·ñÒÉÕï" & vbNewLine & _
                    "                                                                From ²¡ÈË»¤ÀíÕï¶Ï C" & vbNewLine & _
                    "                                                                Where ²¡ÈËid = [1] And Ö÷Ò³id = [2] And ÎÄ¼þID = [3] And C.±ê¼ÇÊ±¼ä < [4] ))" & vbNewLine & _
                    "                                                  Where Top = 1) Order By Õï¶ÏÀàÐÍ, ±ê¼ÇÊ±¼ä) "
                    
                Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "È¡ÉèÖÃµÄÕï¶Ï", mlng²¡ÈËID, mlngÖ÷Ò³ID, mlngµ±Ç°ÎÄ¼þID, CDate(Format(aryPeriod(0), "YYYY-MM-DD hh:mm")), CDate(aryPeriod(1)))
            End If
            
            If NVL(mrsTemp!Õï¶ÏÄÚÈÝ) = "" Then
                strTmp = ""
                gstrSQL = "Select [1] || Zl_Replace_Element_Value([2],[3],[4],2,NULL,[5],[6]) as ÐÅÏ¢ From Dual"
                Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "È¡ÒªËØ", strPrefix, strItemName, mlng²¡ÈËID, mlngÖ÷Ò³ID, mintÓ¤¶ù, CDate(aryPeriod(0)))
            End If
        Case Else
            If blnReplace = True Then
                strTmp = ""
                gstrSQL = "Select [1] || Zl_Replace_Element_Value([2],[3],[4],2,NULL,[5],[6]) as ÐÅÏ¢ From Dual"
                Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "È¡ÒªËØ", strPrefix, strItemName, mlng²¡ÈËID, mlngÖ÷Ò³ID, mintÓ¤¶ù, CDate(aryPeriod(0)))
            Else
                strTmp = strPrefix
                gstrSQL = "Select ÄÚÈÝ From ²¡ÈË»¤ÀíÒªËØÄÚÈÝ Where ÎÄ¼þID=[1] And Ò³ºÅ=[2] And Ãû³Æ=[3]"
                Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "È¡ÒªËØ", mlngµ±Ç°ÎÄ¼þID, mintÒ³Âë, strItemName)
            End If
        End Select
        
        If mrsTemp.BOF = False Then
            If strCell = "" Then
                If strTmp <> "" Then
                    lblSubhead.Tag = lblSubhead.Tag & " " & strTmp & mrsTemp.Fields(0).Value
                Else
                    lblSubhead.Tag = lblSubhead.Tag & " " & mrsTemp.Fields(0).Value
                End If
            Else
                lblSubhead.Tag = lblSubhead.Tag & " " & strTmp & strCell
            End If
        End If
    Next
    lblSubhead.Tag = Trim(lblSubhead.Tag)
    
    '±íÉÏ±êÇ©·ÖÉ¢´¦Àí
    Call zlLableBruit
    Exit Sub

ErrHand:
    If ErrCenter() = 1 Then
        Resume
    End If
End Sub

Private Sub zlRefresh(ByVal strÌõ¼þ As String)
    Dim aryRow() As String, aryItem() As String
    Dim strPrefix As String, strItemName As String
    Dim lngRow As Long, lngCol As Long, lngCount As Long, strCell As String
    Dim strTmpSQL As String
    Dim strTmp As String
    
    Err = 0: On Error GoTo ErrHand
    
    '×°ÈëÊý¾Ý
    Call SQLCombination(strÌõ¼þ)
    gstrSQL = mstrSQL
    If gblnMoved Then
        gstrSQL = Replace(gstrSQL, "²¡ÈË»¤ÀíÊý¾Ý", "H²¡ÈË»¤ÀíÊý¾Ý")
        gstrSQL = Replace(gstrSQL, "²¡ÈË»¤ÀíÃ÷Ï¸", "H²¡ÈË»¤ÀíÃ÷Ï¸")
    End If
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "ÌáÈ¡»¤ÀíÊý¾Ý", mlngµ±Ç°ÎÄ¼þID, mlng²¡ÈËID, mlngÖ÷Ò³ID, mintÓ¤¶ù, mintÒ³Âë, mint½áÊøÒ³)
    'Êý¾Ý¼ÇÂ¼¼¯,ÓÃÓÚ¿ìËÙ»Ö¸´
    Set mrsDataMap = CopyNewRec(mrsTemp, mrsDataMap)
    
    Exit Sub
ErrHand:
    If ErrCenter() = 1 Then
        Resume
    End If
End Sub

Public Function CopyNewRec(ByVal rsSource As ADODB.Recordset, rsTarget As ADODB.Recordset) As ADODB.Recordset
    'Ö»¿½±´¼ÇÂ¼¼¯µÄ½á¹¹,Í¬Ê±Ôö¼ÓÒ³ºÅ,ÐÐºÅ×Ö¶Î
    Dim intFields As Integer
    
    With rsTarget
        If .Fields.Count = 0 Then
            For intFields = 0 To rsSource.Fields.Count - 1
                If rsSource.Fields(intFields).Name = "»ã×ÜÈÕÆÚ" Then
                    .Fields.Append rsSource.Fields(intFields).Name, adLongVarChar, 50, adFldIsNullable      '0:±íÊ¾ÐÂÔö
                ElseIf rsSource.Fields(intFields).Type = 200 Then       'ÈÕÆÚÐÍ´¦ÀíÎª×Ö·ûÐÍ
                    .Fields.Append rsSource.Fields(intFields).Name, adLongVarChar, rsSource.Fields(intFields).DefinedSize, adFldIsNullable     '0:±íÊ¾ÐÂÔö
                Else
                    .Fields.Append rsSource.Fields(intFields).Name, IIf(rsSource.Fields(intFields).Type = adNumeric, adDouble, rsSource.Fields(intFields).Type), rsSource.Fields(intFields).DefinedSize, adFldIsNullable    '0:±íÊ¾ÐÂÔö
                End If
            Next
            
            .CursorLocation = adUseClient
            .CursorType = adOpenStatic
            .LockType = adLockOptimistic
            .Open
        End If
        
        If rsSource.RecordCount <> 0 Then rsSource.MoveFirst
        Do While Not rsSource.EOF
            .AddNew
            For intFields = 0 To rsSource.Fields.Count - 1
                .Fields(intFields) = rsSource.Fields(intFields).Value
            Next
            .Update
            rsSource.MoveNext
        Loop
    End With
    
    Set CopyNewRec = rsTarget
End Function

Private Sub PreTendMutilRows()
    Dim arrData
    Dim intData As Integer, intDatas As Integer
    Dim lngRowCount As Long, lngRowCurrent As Long  'µ±Ç°¼ÇÂ¼×ÜÐÐÊý,µ±Ç°¼ÇÂ¼ÔÚ±¾Ò³µÄÊµ¼ÊÐÐÊý
    Dim lngCol As Long, lngMax As Long
    Dim lngRow As Long, lngStart As Long, lngPrintedRow As Long, lngLastRow As Long
    Dim str·¢ÉúÊ±¼ä As String, str·¢ÉúÊ±¼ä_L As String
    Dim blnDelete As Boolean
    Dim strSignName As String
    Dim blnClear As Boolean
    Dim blnCollectType As Boolean  '¼ÇÂ¼Õý³£Êý¾ÝÐÐµÄÉÏÒ»ÐÐÊÇ·ñÊÇ»ã×ÜÐÐ
    Dim lngCurrRow As Long, lngCollectMutilRows As Long '»ã×ÜÊý¾Ýµ±Ç°ÐÐ¡¢»ã×ÜÁÐÊý¾ÝµÄÐÐÊý
    Dim i As Integer, j As Integer, arrItem, arrCorrelative, arrLastRow, arrMutilRows '·ÖÀà»ã×ÜÏîÄ¿Êý×é
    
    On Error GoTo ErrHand
    'Èç¹ûÒ»ÐÐÏÔÊ¾²»ÍêÔò·ÖÐÐÏÔÊ¾(¸ù¾Ýµ±Ç°Êý¾ÝÕ¼ÓÃÐÐÊýÏÈÌí¼Ó¿Õ°×ÐÐ²¢´¦ÀíÐÐ×ø±ê,È»ºóÔÙÒÀ´Î´¦Àíµ±Ç°ÐÐµÄÊý¾Ý)
    'Ã¿Ò³Ö»ÏÔÊ¾Êµ¼ÊµÄÊý¾ÝÐÐ,°Ñ'@´¦È¡Ïû×¢ÊÍ¼´¿É
    'ÖØÐÂµ÷ÕûËùÓÐÊý¾ÝµÄÊµ¼ÊÐÐ
    arrItem = Split(mstrColCorrelative, "|")
    lngRow = VsfData.FixedRows
    Do While True
        If lngRow > VsfData.Rows - 1 Then Exit Do
        If InStr(1, VsfData.TextMatrix(lngRow, mlngRowCount), "|") <> 0 Then Exit Do
        
        lngRowCount = Val(VsfData.TextMatrix(lngRow, mlngRowCount))
        lngRowCurrent = Val(VsfData.TextMatrix(lngRow, mlngRowCurrent))
        
        str·¢ÉúÊ±¼ä = Format(VsfData.TextMatrix(lngRow, 1), "YYYY-MM-DD HH:mm:ss")
        If Val(VsfData.TextMatrix(lngRow, mlngCollectType)) < 0 Then
            If blnCollectType = False Then str·¢ÉúÊ±¼ä_L = "": blnCollectType = True
            '·ÖÀà»ã×Ü×ÓÀàÃ÷Ï¸Êý¾ÝµÄ´¦Àí(Êý¾Ý±£´æ·½Ê½ÊÇÒ»Ìõ»¤ÀíÊý¾Ý¶ÔÓ¦¶àÌõÃ÷Ï¸,Ã÷Ï¸ÖÐµÄ¼ÇÂ¼×éºÅ²»Í¬)
            If str·¢ÉúÊ±¼ä_L <> "" And str·¢ÉúÊ±¼ä_L = str·¢ÉúÊ±¼ä Then
                If UBound(arrItem) < 0 Then 'Èç¹ûµ±Ç°Ã»ÓÐÉèÖÃ»ã×Ü¹ØÏµ,µ«Ö®Ç°Êý¾Ý´æÔÚ·ÖÀà»ã×ÜµÄÇé¿ö£¬°´×Ó·ÖÀàÌõÊýÑ­»·´¦Àí
                    lngCurrRow = lngLastRow + lngCollectMutilRows 'È·¶¨Ã¿Ò»Ìõ×ÓÊý¾ÝÊä³öµÄÆðÊ¼Î»ÖÃ
                    lngCollectMutilRows = 1
                    If lngCurrRow < lngRow Then
                        VsfData.TextMatrix(lngCurrRow, mlngDate) = ""
                        VsfData.TextMatrix(lngCurrRow, mlngTime) = ""
                        
                        For lngCol = mlngTime + 1 To mlngNoEditor - 1
                            If (lngCol <> mlngSignTime And VsfData.ColHidden(lngCol) = False) Then
                                '×¼±¸¸³Öµ
                                With txtLength
                                    .Width = VsfData.ColWidth(lngCol)
                                    'ÕâÀïÐèÒª×¢ÒâÒ»µã£ºÌáÈ¡×ÓÀàÊý¾ÝµÄÐÐÊýÓ¦¸ÃÊÇlngRow¶ø²»ÊÇlngCurrRow£¬ÒòÎªÔÚ´¦Àí»ã×Ü×ÜÁ¿¼ÇÂ¼Ê±»áµ¼ÖÂ×ÓÀàÊý¾ÝµÄÐÐÎ»ÖÃ·¢Éú±ä»¯ (ÐÐÊý = Ö÷¼ÇÂ¼¿ªÊ¼ÐÐºÅ + Êý¾ÝÐÐÊý)
                                    .Text = Replace(Replace(Replace(VsfData.TextMatrix(lngRow, lngCol), Chr(10), ""), Chr(13), ""), Chr(1), "")
                                    .FontName = VsfData.CellFontName
                                    .FontSize = VsfData.CellFontSize
                                    .FontBold = VsfData.CellFontBold
                                    .FontItalic = VsfData.CellFontItalic
                                End With
                                arrData = GetData(txtLength.Text)
                                intDatas = UBound(arrData)
                                
                                If intDatas >= 0 Then
                                    'Ñ­»·¸³Öµ
                                    If intDatas + 1 > lngRow - lngCurrRow Then intDatas = lngRow - lngCurrRow - 1
                                    If lngCollectMutilRows < intDatas + 1 Then lngCollectMutilRows = intDatas + 1
                                    For intData = 0 To intDatas
                                        VsfData.TextMatrix(lngCurrRow + intData, lngCol) = Replace(Replace(Replace(arrData(intData), Chr(10), ""), Chr(13), ""), Chr(1), "")
                                    Next
                                End If
                            End If
                        Next lngCol
                    End If
                    lngLastRow = lngCurrRow
                Else
                    'ÉèÖÃÁË·ÖÀà»ã×Ü¹ØÏµ£¬°´ÕÕÃ¿¸ö»ã×ÜÏîÄ¿ÒÀ´ÎÕ¹Ê¾Êý¾Ý
                    For i = 0 To UBound(arrItem)
                        lngCurrRow = Val(arrLastRow(i)) + Val(arrMutilRows(i)) '°´ÏîÄ¿·ÖÀà,È·¶¨Ã¿ÌõÊý¾ÝÊä³öµÄÆðÊ¼Î»ÖÃ
                        lngCollectMutilRows = 1
                        arrMutilRows(i) = lngCollectMutilRows
                        If lngCurrRow < lngRow Then
                            arrCorrelative = Split(arrItem(i), ";")
                            For j = 0 To 1
                                '×¼±¸¸³Öµ
                                    lngCol = Split(arrCorrelative(j), ",")(0) + cHideCols + VsfData.FixedCols - 1
                                    With txtLength
                                        .Width = VsfData.ColWidth(lngCol)
                                        'ÕâÀïÐèÒª×¢ÒâÒ»µã£ºÌáÈ¡×ÓÀàÊý¾ÝµÄÐÐÊýÓ¦¸ÃÊÇlngRow¶ø²»ÊÇlngCurrRow£¬ÒòÎªÔÚ´¦Àí»ã×Ü×ÜÁ¿¼ÇÂ¼Ê±»áµ¼ÖÂ×ÓÀàÊý¾ÝµÄÐÐÎ»ÖÃ·¢Éú±ä»¯ (ÐÐÊý = Ö÷¼ÇÂ¼¿ªÊ¼ÐÐºÅ + Êý¾ÝÐÐÊý)
                                        .Text = Replace(Replace(Replace(VsfData.TextMatrix(lngRow, lngCol), Chr(10), ""), Chr(13), ""), Chr(1), "")
                                        .FontName = VsfData.CellFontName
                                        .FontSize = VsfData.CellFontSize
                                        .FontBold = VsfData.CellFontBold
                                        .FontItalic = VsfData.CellFontItalic
                                    End With
                                    arrData = GetData(txtLength.Text)
                                    intDatas = UBound(arrData)
                                    
                                    If intDatas >= 0 Then
                                        If intDatas + 1 > lngRow - lngCurrRow Then intDatas = lngRow - lngCurrRow - 1
                                        If lngCollectMutilRows < intDatas + 1 Then lngCollectMutilRows = intDatas + 1
                                        arrMutilRows(i) = lngCollectMutilRows
                                        For intData = 0 To intDatas
                                            VsfData.TextMatrix(lngCurrRow + intData, lngCol) = Replace(Replace(Replace(arrData(intData), Chr(10), ""), Chr(13), ""), Chr(1), "")
                                        Next intData
                                    End If
                            Next j
                        End If
                        arrLastRow(i) = lngCurrRow
                    Next i
                End If
                '¸³ÖµÍê³ÉºóÒÆ³ýÔ­ÓÐ×ÓÀàÐÐ
                VsfData.RowPosition(lngRow) = VsfData.Rows - 1
                VsfData.RemoveItem VsfData.Rows - 1
                GoTo NextData
            Else
                '×ÜÁ¿ÐÐÄ¬ÈÏÎªÒ»ÐÐ(Ö»ÊÇÕë¶Ô»ã×ÜÁÐµÄÊý¾Ý)
                lngCollectMutilRows = 1
                lngLastRow = lngRow '¼ÇÂ¼·ÖÀà»ã×Ü×ÜÁ¿ÐÐµÄÎ»ÖÃ
                'È·¶¨·ÖÀà»ã×ÜÊ×Ìõ×Ó·ÖÀàÊý¾ÝÃ¿¸ö»ã×ÜÏîÄ¿µÄÆðÊ¼Î»ÖÃ
                arrLastRow = Array(): arrMutilRows = Array()
                For i = 0 To UBound(arrItem)
                    ReDim Preserve arrLastRow(UBound(arrLastRow) + 1)
                    arrLastRow(UBound(arrLastRow)) = lngLastRow
                    ReDim Preserve arrMutilRows(UBound(arrMutilRows) + 1)
                    arrMutilRows(UBound(arrMutilRows)) = lngCollectMutilRows
                Next i
            End If
        Else
            If blnCollectType = True Then str·¢ÉúÊ±¼ä_L = "": blnCollectType = False
            If str·¢ÉúÊ±¼ä_L <> "" And Mid(str·¢ÉúÊ±¼ä_L, 1, 16) = Mid(str·¢ÉúÊ±¼ä, 1, 16) And str·¢ÉúÊ±¼ä_L <> str·¢ÉúÊ±¼ä Then
                'ÈÕÆÚÏàÍ¬£¬ÃëÊý²»Í¬£¬ÇÒ²»ÊÇ»ã×ÜÊý¾ÝÐÐ£¬ÔòËµÃ÷ÕâÐ©Êý¾ÝÊÇÒ»×é£¬¸üÐÂlngDemoÁÐ
                VsfData.TextMatrix(lngRow, mlngDate) = ""
                VsfData.TextMatrix(lngRow, mlngTime) = ""
                VsfData.TextMatrix(lngRow, mlngDemo) = lngRow - lngLastRow + 1
                If lngRow - lngLastRow = Val(VsfData.TextMatrix(lngLastRow, mlngRowCount)) Then
                    VsfData.TextMatrix(lngLastRow, mlngDemo) = 1
                End If
            Else
                lngLastRow = lngRow
            End If
        End If
        
        If lngRowCount > 1 Then
            'ÏÈÔö¼Ó¿ÕÐÐ
            VsfData.Rows = VsfData.Rows + lngRowCount - 1
            '´Óµ±Ç°ÐÐµÄÏÂÒ»ÐÐ¿ªÊ¼£¬Ã¿ÐÐµÄÎ»ÖÃ+ËùÔö¼ÓµÄ¿Õ°×ÐÐÊý£¬±£Ö¤ÐÂÔöµÄ¿Õ°×ÐÐ´Óµ±Ç°ÐÐµÄÏÂÒ»ÐÐ¿ªÊ¼
            For intData = VsfData.Rows - lngRowCount To lngRow + 1 Step -1
                VsfData.RowPosition(intData) = intData + lngRowCount - 1
            Next
            
            'Ñ­»·´¦Àíµ±Ç°ÐÐÊý¾Ý
            For lngCol = 0 To VsfData.Cols - 1
                If VsfData.ColHidden(lngCol) And lngCol <> mlngRowCount And lngCol <> mlngDemo Then
                    'Ñ­»·¸³Öµ
                    For intData = 2 To lngRowCount
                        VsfData.TextMatrix(lngRow + intData - 1, lngCol) = VsfData.TextMatrix(lngRow, lngCol)
                        '46506:ÁõÅô·É,2012-12-27,ÂúÒ³´òÓ¡
                        'Á¬Ðø´òÓ¡µÄÇé¿ö²Å´æÔÚ´òÓ¡¿çÒ³Êý¾Ýºó°ë²¿·ÖÄÚÈÝ
                        '´òÓ¡½áÊøÒ³ºÅÎª¿ÕËµÃ÷Ö®Ç°Î´Ê¹ÓÃÂúÒ³´òÓ¡£¬¿çÒ³Êý¾ÝÒÑ¾­È«²¿´òÓ¡
                        '´òÓ¡¿çÒ³Êý¾Ýºó°ë²¿·ÖÄÚÈÝÎª:´òÓ¡Ò³ºÅ+(µ±Ç°ÐÐ+´òÓ¡ÐÐºÅ-1)\±¾Ò³Êý¾ÝÐÐ>´òÓ¡½áÊøÒ³ºÅ
                        If lngCol = mlngPrintedPage And gintPrintState = 1 And Val(VsfData.TextMatrix(lngRow, mlngRowCount)) <> Val(VsfData.TextMatrix(lngRow, mlngRowCurrent)) Then
                            If Val(VsfData.TextMatrix(lngRow, mlngPrintedEndPage)) <> 0 And Val(VsfData.TextMatrix(lngRow, mlngPrintedPage)) <> 0 And Val(VsfData.TextMatrix(lngRow, mlngPrintedEndPage)) >= Val(VsfData.TextMatrix(lngRow, mlngPrintedPage)) Then
                                If Val(VsfData.TextMatrix(lngRow, mlngPrintedPage)) + (intData + lngPrintedRow - 2) \ mlngPageRows > Val(VsfData.TextMatrix(lngRow, mlngPrintedEndPage)) Then
                                    VsfData.TextMatrix(lngRow + intData - 1, lngCol) = ""
                                End If
                            ElseIf Val(VsfData.TextMatrix(lngRow, mlngPrintedEndPage)) <> 0 And Val(VsfData.TextMatrix(lngRow, mlngPrintedPage)) = 0 Then
                                'ÉÏ´ÎÖ»´òÓ¡ÁË¿çÒ³Êý¾Ý¿çÒ³²¿·ÖµÄ
                                'ÀýÈç£ºµÚ3Ò³Êý¾Ý¿çÒ³µ½µÚ4Ò³£¬Ö®Ç°Ö»´òÓ¡ÁËµÚ4¿çÒ³µÄÊý¾Ý¡£ÔÙ´ÎÐø´ò·ÖÁ½ÖÖÇé¿ö£º´òÓ¡µÚ3Ò³£¬´òÓ¡µÚ4Ò³
                                If Val(VsfData.TextMatrix(lngRow, mlngPrintedEndPage)) > mintÒ³Âë Then
                                    If Val(VsfData.TextMatrix(lngRow, mlngRowCurrent)) > intData Then
                                        VsfData.TextMatrix(lngRow + intData - 1, lngCol) = Val(VsfData.TextMatrix(lngRow, mlngPrintedEndPage))
                                    End If
                                Else
                                    If Val(VsfData.TextMatrix(lngRow, mlngRowCount)) - Val(VsfData.TextMatrix(lngRow, mlngRowCurrent)) < intData Then
                                        VsfData.TextMatrix(lngRow + intData - 1, lngCol) = Val(VsfData.TextMatrix(lngRow, mlngPrintedEndPage))
                                    End If
                                End If
                            End If
                        End If
                    Next
                ElseIf (lngCol < mlngNoEditor And lngCol <> mlngDate And lngCol <> mlngTime) Then
                    '×¼±¸¸³Öµ
                    With txtLength
                        .Width = VsfData.ColWidth(lngCol)
                        .Text = Replace(Replace(Replace(VsfData.TextMatrix(lngRow, lngCol), Chr(10), ""), Chr(13), ""), Chr(1), "")
                        .FontName = VsfData.CellFontName
                        .FontSize = VsfData.CellFontSize
                        .FontBold = VsfData.CellFontBold
                        .FontItalic = VsfData.CellFontItalic
                    End With
                    arrData = GetData(txtLength.Text)
                    intDatas = UBound(arrData)
                    
                    If intDatas > 0 Then
                        'Ñ­»·¸³Öµ
                        If intDatas + 1 > lngRowCount Then intDatas = lngRowCount - 1
                        For intData = 0 To intDatas
                            If VsfData.Rows <= lngRow + intData Then VsfData.Rows = VsfData.Rows + 1
                            VsfData.TextMatrix(lngRow + intData, lngCol) = Replace(Replace(Replace(arrData(intData), Chr(10), ""), Chr(13), ""), Chr(1), "")
                        Next
                    End If
                ElseIf lngCol = mlngNoEditor Then
                    '½«ÐÐÖµ¸ÄÎª´Ó1¿ªÊ¼,±ÈÈçÓÐ4ÐÐÊý¾Ý,¾ÍÊÇ4|1
                    For intData = 1 To lngRowCount
                        VsfData.TextMatrix(lngRow + intData - 1, mlngRowCount) = lngRowCount & "|" & intData
                    Next
                    '×îºóÒ»ÐÐÐèÒªÌîÐ´·â±ÕÇ©Ãû
                    If mlngSignName > 0 Then VsfData.TextMatrix(lngRow + lngRowCount - 1, mlngSignName) = VsfData.TextMatrix(lngRow, mlngSignName)
                    If mlngSignTime > 0 Then VsfData.TextMatrix(lngRow + lngRowCount - 1, mlngSignTime) = VsfData.TextMatrix(lngRow, mlngSignTime)
                    '--58414,ÁõÅô·É,2013-04-10,Ìí¼Ó»¤Ê¿¡¢Ç©ÃûÁÐÏÔÊ¾Ä£Ê½
                    Call SingerShowType(VsfData, lngRow, lngRow + lngRowCount - 1)
                Else
                
                End If
            Next
            lngRow = lngRow + lngRowCount - 1
        Else
            VsfData.TextMatrix(lngRow, mlngRowCount) = "1|1"
        End If
        lngRow = lngRow + 1
NextData:
        str·¢ÉúÊ±¼ä_L = str·¢ÉúÊ±¼ä
    Loop
    
    'Ìî³äÃ¿Ò³µÄÆô¶¯ÐÐ
    lngRow = VsfData.FixedRows
    
    Do While True
        '¹Ì¶¨¸´ÖÆÏÔÊ¾ÈÕÆÚÊ±¼äÓëÇ©ÃûÁÐ
        lngStart = GetStartRow(lngRow)
        
        'ÌØÊâ´¦ÀíµÚÒ»ÐÐ(µÚÒ»ÐÐ¿ÉÄÜ´æÔÚ¿çÒ³Êý¾Ý)
        '50503:ÁõÅô·É,2012-09-12,Ö»ÓÐ¿ªÊ¼ÐÐºÅ<>1µÄ²Å½øÐÐ´¦Àí£¬±ÜÃâ´¦ÀíµôÁËÊý¾Ý´Ó¼ÇÂ¼µ¥Ä³Ò³µÚÒ»ÐÐ¾Í¿çÒ³µÄÊý¾Ý
        If lngRow = VsfData.FixedRows And Val(Split(VsfData.TextMatrix(lngRow, mlngRowCount), "|")(0)) <> Val(VsfData.TextMatrix(lngRow, mlngRowCurrent)) And Val(VsfData.TextMatrix(lngRow, mlngStartSpread)) > 1 Then
            blnDelete = True
            lngRow = lngRow + Val(Split(VsfData.TextMatrix(lngRow, mlngRowCount), "|")(0)) - Val(VsfData.TextMatrix(lngRow, mlngRowCurrent))
        End If
        
        If lngStart <> lngRow Or (Val(VsfData.TextMatrix(lngStart, mlngDemo)) > 1 And lngStart = lngRow) Then
            '--58414,ÁõÅô·É,2013-04-10,Ìí¼Ó»¤Ê¿¡¢Ç©ÃûÁÐÏÔÊ¾Ä£Ê½
            If Val(VsfData.TextMatrix(lngStart, mlngDemo)) > 1 Then
                For lngRowCount = lngStart To VsfData.FixedRows Step -1
                    If Val(VsfData.TextMatrix(lngRowCount, mlngDemo)) = 1 Then
                        If mlngDate > -1 Then VsfData.TextMatrix(lngRow, mlngDate) = VsfData.TextMatrix(lngRowCount, mlngDate)
                        If mlngTime > -1 Then VsfData.TextMatrix(lngRow, mlngTime) = VsfData.TextMatrix(lngRowCount, mlngTime)
                        Exit For
                    End If
                Next
            Else
                If mlngDate > -1 Then VsfData.TextMatrix(lngRow, mlngDate) = VsfData.TextMatrix(lngStart, mlngDate)
                If mlngTime > -1 Then VsfData.TextMatrix(lngRow, mlngTime) = VsfData.TextMatrix(lngStart, mlngTime)
            End If
            If lngStart <> lngRow Then
                '65994:ÁõÅô·É,2013-09-26,´¦ÀíÎ²ÐÐÇ©Ãû,Èç¹ûÊý¾Ý¿çÒ³Ôò»áµ¼ÖÂÁ½Ò³¶¼Ã»ÓÐÇ©Ãû»òÖ»ÓÐµÚ¶þÒ³ÓÐÇ©Ãû
                If mlngSingerType <> 3 Then '·ÇÎ²ÐÐÇ©Ãû£¬ÌîÐ´¿çÒ³Êý¾ÝÔÚµÚ¶þÒ³Êý¾ÝµÄÆðÊ¼ÐÐ
                    If mlngOperator <> -1 Then VsfData.TextMatrix(lngRow, mlngOperator) = VsfData.TextMatrix(lngStart, mlngOperator)
                    If mlngSignName <> -1 Then VsfData.TextMatrix(lngRow, mlngSignName) = VsfData.TextMatrix(lngStart, mlngSignName)
                    If mlngSignTime <> -1 Then VsfData.TextMatrix(lngRow, mlngSignTime) = VsfData.TextMatrix(lngStart, mlngSignTime)
                Else 'Î²ÐÐÇ©Ãû,ÌîÐ´¿çÒ³Êý¾ÝÆðÊ¼Ò³µÄÆðÊ¼ÐÐ(Ó¦Îª¿ªÊ¼Ìí¼ÓÊý¾ÝÊ±,ÆðÊ¼ÐÐÒÑ¾­Çå¿Õ)
                    If mlngOperator <> -1 Then VsfData.TextMatrix(lngStart, mlngOperator) = VsfData.TextMatrix(lngStart + Val(VsfData.TextMatrix(lngStart, mlngRowCount)) - 1, mlngOperator)
                    If mlngSignName <> -1 Then VsfData.TextMatrix(lngStart, mlngSignName) = VsfData.TextMatrix(lngStart + Val(VsfData.TextMatrix(lngStart, mlngRowCount)) - 1, mlngSignName)
                    If mlngSignTime <> -1 Then VsfData.TextMatrix(lngStart, mlngSignTime) = VsfData.TextMatrix(lngStart + Val(VsfData.TextMatrix(lngStart, mlngRowCount)) - 1, mlngSignTime)
                End If
                '¸üÐÂµ±Ç°Ò³×îºóÒ»ÐÐ£¬¿çÒ³Êý¾ÝµÄÇ©ÃûÈËºÍÇ©ÃûÊ±¼ä
                If lngStart <> lngRow - 1 Then
                    '--58414,ÁõÅô·É,2013-04-10,Ìí¼Ó»¤Ê¿¡¢Ç©ÃûÁÐÏÔÊ¾Ä£Ê½
                    If mlngOperator <> -1 Then VsfData.TextMatrix(lngRow - 1, mlngOperator) = VsfData.TextMatrix(lngStart + Val(VsfData.TextMatrix(lngStart, mlngRowCount)) - 1, mlngOperator)
                    If mlngSignName <> -1 Then VsfData.TextMatrix(lngRow - 1, mlngSignName) = VsfData.TextMatrix(lngStart + Val(VsfData.TextMatrix(lngStart, mlngRowCount)) - 1, mlngSignName)
                    If mlngSignTime <> -1 Then VsfData.TextMatrix(lngRow - 1, mlngSignTime) = VsfData.TextMatrix(lngStart + Val(VsfData.TextMatrix(lngStart, mlngRowCount)) - 1, mlngSignTime)
                    Call SingerShowType(VsfData, lngStart, lngRow - 1)
                End If
            End If
        End If
        
        If blnDelete Then
            '89208:³ýÖ®Ç°ÖØÐÂµ÷ÕûÊý¾ÝÐÐÊýºó£¬ÔÚ½øÐÐÉ¾³ý(ÒÔ±ã´¦ÀíºóÃæ63760ÎÊÌâÖÐµÄÇ©ÃûÈËÏÔÊ¾)
            lngRowCount = Val(VsfData.TextMatrix(lngStart, mlngRowCount))
            lngRowCount = lngRowCount - (lngRow - lngStart)
            If lngRowCount > 0 Then
                VsfData.TextMatrix(lngRow, mlngDemo) = VsfData.TextMatrix(lngStart, mlngDemo)
                For lngCol = 0 To lngRowCount - 1
                    VsfData.TextMatrix(lngCol + lngRow, mlngRowCount) = lngRowCount & "|" & lngCol + 1
                    VsfData.TextMatrix(lngCol + lngRow, mlngRowCurrent) = lngRowCount
                Next
            End If
            
            For lngCol = lngStart To lngRow - 1
                VsfData.RemoveItem lngStart
            Next
            
            blnDelete = False
            lngRow = VsfData.FixedRows  'Ö»´¦ÀíµÚÒ»ÐÐ¼ÇÂ¼É¾³ýµÄÇé¿ö,ËùÒÔ¹Ì¶¨ÉèÖÃÎª¹Ì¶¨ÐÐÎªÆôÊ¼ÐÐ
        End If
        
        lngRow = lngRow + mlngPageRows
        If lngRow > VsfData.Rows - 1 Then Exit Do
    Loop
    
    '63760:ÁõÅô·É,·Ö×éÊý¾Ý»¤Ê¿¡¢Ç©ÃûÈË¡¢Ç©ÃûÊ±¼äµÄ´¦Àí£¨Í¬Ò»¸öÇ©ÃûÈËÊ¼ÖÕÏÔÊ¾Ò»´Î£©
    If mlngSingerType > 0 And VsfData.FixedRows <= VsfData.Rows - 1 Then
        lngPrintedRow = IIf(mlngOperator <> -1, mlngOperator, mlngSignName)
        lngRow = VsfData.FixedRows
        Do While True
            lngStart = GetStartRow(lngRow)
            lngRowCount = Val(VsfData.TextMatrix(lngStart, mlngRowCount))
            If lngRowCount <= 0 Then Exit Do
            
            If mlngSingerType = 3 Then 'Î²ÐÐÇ©Ãû
                strSignName = VsfData.TextMatrix(lngStart + lngRowCount - 1, lngPrintedRow)
            Else 'Ê×ÐÐÇ©Ãû»òÊ×Î²Ç©Ãû
                strSignName = VsfData.TextMatrix(lngStart, lngPrintedRow)
            End If
            strSignName = FormatValue(strSignName)
            '¼ì²éÊÇ·ñÊÇ·Ö×éÊý¾Ý£¬´Ó·Ö×éÆðÊ¼ÐÐ¿ªÊ¼´¦Àí
            If Val(VsfData.TextMatrix(lngStart, mlngDemo)) = 1 And lngStart = lngRow And strSignName <> "" Then
                For lngRow = lngStart + lngRowCount To VsfData.Rows - 1
                    If lngRow = lngStart + lngRowCount Then
                    
                        If Val(VsfData.TextMatrix(lngRow, mlngDemo)) <= 1 Then Exit For
                        
                        '¼ì²éÍ¬Ò»·Ö×é²»Í¬Êý¾ÝÖ®¼äµÄ»¤Ê¿¡¢Ç©ÃûÈËÊÇ·ñÏàÍ¬£¬²¢×÷ÏàÓ¦µÄ´¦Àí
                        lngRowCount = Val(VsfData.TextMatrix(lngRow, mlngRowCount))
                        If lngRowCount = 0 Then Exit For
                        
                        If mlngSingerType = 3 Then 'Î²ÐÐÇ©Ãû
                            '»¤Ê¿¡¢Ç©ÃûÈËÏàÍ¬£¬Ö»ÔÚ±¾·Ö×é×îºóÒ»ÌõÊý¾Ý×îºóÒ»ÐÐÏÔÊ¾»¤Ê¿¡¢Ç©ÃûÈË
                            If strSignName = FormatValue(VsfData.TextMatrix(lngRow + lngRowCount - 1, lngPrintedRow)) Then
                                'Èç¹û·Ö×éµÄ±¾ÌõÊý¾Ý¸ÕºÃÊÇÄ³Ò»Ò³µÄÊ×ÐÐÔò²»Çå³ýÉÏÒ»Ò³±¾·Ö×é×îºóÒ»ÌõÊý¾ÝµÄ»¤Ê¿¡¢Ç©ÃûÈË
                                If (lngRow - VsfData.FixedRows) Mod mlngPageRows > 0 And lngStart <= lngRow - 1 Then
                                    If mlngOperator <> -1 Then VsfData.TextMatrix(lngRow - 1, mlngOperator) = ""
                                    If mlngSignName <> -1 Then VsfData.TextMatrix(lngRow - 1, mlngSignName) = ""
                                    If mlngSignTime <> -1 Then VsfData.TextMatrix(lngRow - 1, mlngSignTime) = ""
                                End If
                            Else
                                If FormatValue(VsfData.TextMatrix(lngRow + lngRowCount - 1, lngPrintedRow)) <> "" Then
                                    strSignName = FormatValue(VsfData.TextMatrix(lngRow + lngRowCount - 1, lngPrintedRow))
                                End If
                            End If
                        Else 'Ê×ÐÐÇ©Ãû»òÊ×Î²Ç©Ãû
                            If strSignName = FormatValue(VsfData.TextMatrix(lngRow, lngPrintedRow)) Then
                                'Èç¹û·Ö×éµÄ±¾ÌõÊý¾Ý¸ÕºÃÊÇÄ³Ò»Ò³µÄÊ×ÐÐÔò²»Çå³ýÉÏÒ»Ò³±¾·Ö×é×îºóÒ»ÌõÊý¾ÝµÄ»¤Ê¿¡¢Ç©ÃûÈË
                                If (lngRow - VsfData.FixedRows) Mod mlngPageRows > 0 Then
                                    blnClear = True
                                    'Ê×Î²Ç©ÃûÐèÒª×¢Òâ£ºÈç¹û·Ö×éÄ³ÌõÊý¾ÝµÄÊ×ÐÐ(·ÇÆðÊ¼ÐÐÊý¾Ý)ÔÚÄ³Ò³µÄ×îºóÒ»ÐÐ£¬Ôò²»È¡Ïû»¤Ê¿Ç©ÃûÈËµÄÏÔÊ¾
                                    If mlngSingerType = 2 And lngRowCount = 1 Then
                                        If lngRow + lngRowCount < VsfData.Rows Then
                                            If Val(VsfData.TextMatrix(lngRow + lngRowCount, mlngDemo)) <= 1 Then
                                                blnClear = False
                                            End If
                                        Else
                                            blnClear = False
                                        End If
                                    End If
                                    
                                    If blnClear = True Then
                                        If mlngSingerType = 1 Or (mlngSingerType = 2 And (lngRow + 1 - VsfData.FixedRows) Mod mlngPageRows > 0) Then
                                            blnClear = False
                                            If mlngOperator <> -1 Then VsfData.TextMatrix(lngRow, mlngOperator) = ""
                                            If mlngSignName <> -1 Then VsfData.TextMatrix(lngRow, mlngSignName) = ""
                                            If mlngSignTime <> -1 Then VsfData.TextMatrix(lngRow, mlngSignTime) = ""
                                        End If
                                    End If
                                    
                                    If mlngSingerType = 2 And lngStart < lngRow - 1 Then 'Ê×Î²Ç©Ãû»¹Ó¦¸ÃÈ¥µôÉÏÒ»ÌõÊý¾ÝµÄÎ²ÐÐ(ÉÏÒ»ÐÐÊý¾ÝÐÐÊýÐèÒª>1)
                                        'Èç¹ûÉÏÒ»ÐÐÊý¾Ý¿çÒ³£¬²¢ÇÒÔÚµ±Ç°Ò³Ö»ÓÐÒ»ÐÐÔò²»½øÐÐÇå³ý±¾ÌõÊý¾ÝµÄ×îºóÒ»ÐÐÇ©Ãû¡¢»¤Ê¿
                                        If (lngRow - 1 - VsfData.FixedRows) Mod mlngPageRows > 0 Then
                                            If mlngOperator <> -1 Then VsfData.TextMatrix(lngRow - 1, mlngOperator) = ""
                                            If mlngSignName <> -1 Then VsfData.TextMatrix(lngRow - 1, mlngSignName) = ""
                                            If mlngSignTime <> -1 Then VsfData.TextMatrix(lngRow - 1, mlngSignTime) = ""
                                        End If
                                    End If
                                End If
                            Else
                                If FormatValue(VsfData.TextMatrix(lngRow, lngPrintedRow)) <> "" Then
                                    strSignName = FormatValue(VsfData.TextMatrix(lngRow, lngPrintedRow))
                                End If
                            End If
                        End If
                        
                        lngStart = lngRow
                    End If
                Next lngRow
            Else
                lngRow = lngStart + lngRowCount
            End If
            
            If lngRow > VsfData.Rows - 1 Then Exit Do
        Loop
    End If
    
    'Èç¹ûÊÇÖØ´ò,½«³¬³öÒ³ÓÐÐ§Êý¾ÝÐÐµÄ²¿·ÖÉ¾µô
    If gintPrintState = 2 Then
        If VsfData.Rows > VsfData.FixedRows + mlngPageRows Then
            VsfData.Rows = VsfData.FixedRows + mlngPageRows
        End If
    End If
    
    Exit Sub
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Sub

Private Sub PreTendFormat()
    Dim aryItem() As String
    Dim lngRow As Long, lngCol As Long, lngCount As Long, strCell As String
    Dim blnAlign As Boolean
    
    On Error GoTo ErrHand
    
    'ÉèÖÃ»¤Àí¼ÇÂ¼µ¥µÄ¸ñÊ½
    With VsfData
        .Redraw = flexRDNone
        .Clear
        Set .DataSource = mrsDataMap
        
        '±íÍ·ÌîÐ´
        .MergeCells = flexMergeFixedOnly ' = flexMergeRestrictRows
        .MergeCellsFixed = flexMergeFree
        .MergeRow(0) = True
        .MergeRow(1) = True
        .MergeRow(2) = True
        'ÏÈÇå¿ÕÐÐºÏ²¢ÊôÐÔ£¬.Clear²»ÄÜÇå³ýÖ®Ç°µÄºÏ²¢ÐÅÏ¢
        For lngCount = .FixedRows To .Rows - 1
            .MergeRow(lngCount) = False
        Next
        '³ÌÐòÄÚ²¿¿ØÖÆÁÐÒþ²Ø
        .ColHidden(0) = True
        .ColHidden(1) = True
        .ColHidden(2) = True
        .ColHidden(mlngRowCount) = True
        .ColHidden(mlngRowCurrent) = True
        .ColHidden(mlngStartSpread) = True
        '51589:ÁõÅô·É,2013-03-01,Ìí¼Ó½»°àÇ©Ãû
        .ColHidden(mlngJoinSignName) = True
        .ColHidden(mlngFileID) = True
        .ColHidden(mlngRecord) = True
        .ColHidden(mlngSigner) = True
        .ColHidden(mlngSignLevel) = True
        .ColHidden(mlngCollectStyle) = True
        .ColHidden(mlngCollectText) = True
        .ColHidden(mlngCollectType) = True
        .ColHidden(mlngCollectDay) = True
        .ColHidden(mlngPrintedPage) = True
        .ColHidden(mlngPrintedRow) = True
        .ColHidden(mlngPrintedTag) = True
        .ColHidden(mlngPrintedEndPage) = True
        .ColHidden(mlngCollectValue) = True
        'ÉèÖÃÁÐÍ·
        Dim strCOL As String
        Dim dblWidth As Double
        
        aryItem = Split(mstrTabHead, "|")
        For lngCount = 0 To UBound(aryItem)
            strCell = aryItem(lngCount)
            lngRow = Left(strCell, InStr(1, strCell, ",") - 1): strCell = Mid(strCell, InStr(1, strCell, ",") + 1)
            lngCol = Left(strCell, InStr(1, strCell, ",") - 1): strCell = Mid(strCell, InStr(1, strCell, ",") + 1)
            .TextMatrix(lngRow, lngCol + cHideCols + .FixedCols - 1) = strCell
        Next
        Call PreActiveHead
        
        'ÁÐ¿íÉèÖÃ
        blnAlign = False
        aryItem = Split(mstrColWidth, ",")
        If mblnÈÕÆÚÊ±¼äºÏ²¢ Then strCOL = "," & mlngDate & "," & mlngTime & ","
        For lngCount = cHideCols + .FixedCols To .Cols - 1
            If Not .ColHidden(lngCount) Then
                .ColWidth(lngCount) = Val(Split(aryItem(lngCount - cHideCols - .FixedCols), "`")(0))
                If mblnÈÕÆÚÊ±¼äºÏ²¢ And InStr(1, strCOL, "," & lngCount & ",") > 0 Then
                    dblWidth = dblWidth + .ColWidth(lngCount)
                End If
                If InStr(1, aryItem(lngCount - cHideCols - .FixedCols), "`") <> 0 Then
                    blnAlign = True
                    .ColAlignment(lngCount) = Val(Split(aryItem(lngCount - cHideCols - .FixedCols), "`")(1))
                End If
            End If
        Next
        '½«·¢ÉúÊ±¼äÁÐÏÔÊ¾³öÀ´,ÁÐ¿íÎªÈÕÆÚÓëÊ±¼äÁÐµÄ×Ü¿í¶È
        If mblnÈÕÆÚÊ±¼äºÏ²¢ Then
            .ColWidth(2) = IIf(dblWidth < 1600, 1600, dblWidth)
            .TextMatrix(0, 2) = "·¢ÉúÊ±¼ä"
            If mintTabTiers >= 2 Then .TextMatrix(1, 2) = "·¢ÉúÊ±¼ä"
            If mintTabTiers >= 3 Then .TextMatrix(2, 2) = "·¢ÉúÊ±¼ä"
            .ColAlignment(2) = .ColAlignment(mlngDate)
        End If
        
        '¹Ì¶¨ÐÐ¸ñÊ½Îª¾ÓÖÐ
        .Cell(flexcpAlignment, 0, 0, .FixedRows - 1, .Cols - 1) = flexAlignCenterCenter
        'ÔÙ°´ÁÐºÏ²¢
        For lngCount = 0 To .Cols - 1
            .MergeCol(lngCount) = True
        Next
        
        If blnAlign = False Then
            '¸ÄÎª¸ù¾ÝÓÃ»§µÄÉèÖÃÏÔÊ¾ÁÐ¶ÔÆë·½Ê½
            If .FixedRows < .Rows Then .Cell(flexcpAlignment, .FixedRows, 0, .Rows - 1, .Cols - 1) = flexAlignGeneralCenter
        End If
        For lngCount = 0 To .Rows - 1
            If .RowHeight(lngCount) <> .RowHeightMin Then .RowHeight(lngCount) = .RowHeightMin
        Next
        Select Case mintTabTiers
        Case 1
            .RowHidden(0) = False
            .RowHidden(1) = True
            .RowHidden(2) = True
        Case 2
            .RowHidden(0) = False
            .RowHidden(1) = False
            .RowHidden(2) = True
        Case 3
            .RowHidden(0) = False
            .RowHidden(1) = False
            .RowHidden(2) = False
        End Select
        For lngCount = 0 To .Cols - 1
            .MergeCol(lngCount) = True
        Next
        
        Call PreTendMutilRows
        If mblnÈÕÆÚÊ±¼äºÏ²¢ Then
            'ÔÚPreTendMutilRows()ÖÐÒª´¦ÀíÊý¾Ý,ËùÒÔ±ØÐë½«ÁÐµÄÒþ²ØÊôÐÔ·ÅÔÚÕâÀïÉèÖÃ
            .ColHidden(mlngDate) = True
            .ColHidden(mlngTime) = True
            .ColHidden(2) = False
        End If
        
        If mblnÊ±¼äÁÐÒþ²Ø = True Then .ColHidden(mlngTime) = True
        
        Call WriteColor
        
        '¿ÉÄÜ¹Ì¶¨ÐÐµÄÐÐ¸ß²»ÕýÈ·ÐèÒª×Ô¶¯µ÷ÕûÏÂ
        .AutoResize = True
        .WordWrap = True
        .AutoSizeMode = flexAutoSizeRowHeight
        .AutoSize 0, .Cols - 1
        .AutoResize = False
        '½«·Ç¹Ì¶¨ÐÐµÄÐÐ¸ßÉèÖÃÎª×îÐ¡ÐÐ¸ß
        For lngCount = 0 To .FixedRows - 1
            If .RowHeight(lngCount) < .RowHeightMin Then .RowHeight(lngCount) = .RowHeightMin
        Next
        For lngCount = .FixedRows To .Rows - 1
            .RowHeight(lngCount) = .RowHeightMin
        Next
        
        .Redraw = flexRDDirect
    End With
    Exit Sub
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Sub

Public Function PrintHead() As Boolean
    Dim lngPage As Long
    On Error GoTo ErrHand
    
    lngPage = mintÒ³Âë
    mlngµ±Ç°Ò³Âë = lngPage
    PrintHead = PrintRTBData(rtbHead, True, lngPage)
    Exit Function
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Function

Public Function PrintFoot() As Boolean
    Dim lngPage As Long
    On Error GoTo ErrHand
    
    lngPage = mintÒ³Âë
    mlngµ±Ç°Ò³Âë = lngPage
    PrintFoot = PrintRTBData(rtbFoot, False, lngPage)
    Exit Function
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Function

Private Function PrintRTBData(ByVal objRTB As RichTextBox, ByVal blnHead As Boolean, Optional ByVal lngPage As Long = 0) As Boolean
    Dim fr As FORMATRANGE           '¸ñÊ½»¯µÄÎÄ±¾·¶Î§
    Dim rcDrawTo As RECT            'Ä¿±êÎÄ×ÖÇøÓò
    Dim rcPage As RECT              'Ä¿±êÒ³ÃæÇøÓò
    Dim rcHeand As RECT
    Dim rcFoot As RECT
    Dim gTargetDC As Long
    Dim lngFoot As Long
    Dim lngOffsetLeft As Long
    Dim lngOffsetTop As Long
    Dim lngNextPos As Long, lngLen As Long, lngTmp As Long, lngPageCount As Long
    Dim mrsTemp As New ADODB.Recordset
    Dim lngPageIndex As Long, lngPrintTextY As Long
    
    lngLen = lstrlen(objRTB.Text)
    lngOffsetLeft = gobjOutTo.ScaleX(GetDeviceCaps(gobjOutTo.hDC, PHYSICALOFFSETX), vbPixels, vbTwips)
    lngOffsetTop = gobjOutTo.ScaleY(GetDeviceCaps(gobjOutTo.hDC, PHYSICALOFFSETY), vbPixels, vbTwips)
    
    '46251,ÁõÅô·É,2012-09-11,×°ÔØÒ³ÂëÊä³öÎ»ÖÃ
    lngPageIndex = Val(cboÒ³Âë.ItemData(cboÒ³Âë.ListIndex))
    If lngPageIndex <= 0 Or lngPageIndex > 4 Then lngPageIndex = 4
    If blnHead Then
        If chkÒ³Âë.Value = 1 And (lngPageIndex = 1 Or lngPageIndex = 2) Then
            lngFoot = gobjOutTo.TextHeight("µÚ")
            With rcHeand
                .Left = lngOffsetLeft
                .Right = gobjOutTo.Width - lngOffsetLeft
                If lngPageIndex = 1 Then
                    lngPrintTextY = lngOffsetTop + 30
                    .Top = lngOffsetTop + lngFoot + 60
                    .Bottom = gobjOutTo.ScaleX(gobjSend.EmptyUp, vbMillimeters, vbTwips)
                Else
                    .Top = lngOffsetTop
                    .Bottom = gobjOutTo.ScaleX(gobjSend.EmptyUp, vbMillimeters, vbTwips) - lngFoot - 60
                    lngPrintTextY = .Bottom + 30
                End If
                If lngPrintTextY < lngOffsetTop + 30 Then lngPrintTextY = lngOffsetTop + 30
            End With
        Else
            With rcHeand
                .Left = lngOffsetLeft
                .Top = lngOffsetTop
                .Right = gobjOutTo.Width - lngOffsetLeft
                .Bottom = gobjOutTo.ScaleX(gobjSend.EmptyUp, vbMillimeters, vbTwips) - 30
            End With
            gobjOutTo.Print ""
        End If
    Else
        '62436:ÁõÅô·É,2013-06-20,ÐÞ¸ÄÒ³ÂëÊä³ö×ø±ê£¬±£Ö¤ÔÚ´òÓ¡»ú¿É´òÓ¡ÇøÓòÄÚ¡£
        If chkÒ³Âë.Value = 1 And (lngPageIndex = 3 Or lngPageIndex = 4) Then
            If lngPageIndex = 3 Then
                lngFoot = gobjOutTo.TextHeight("µÚ") + 60
                lngPrintTextY = gobjOutTo.Height - gobjOutTo.ScaleY(gobjSend.EmptyDown, vbMillimeters, vbTwips) - lngOffsetTop * 2
                rcFoot.Bottom = gobjOutTo.Height
            Else
                lngFoot = gobjOutTo.TextHeight("µÚ") + 60
                lngPrintTextY = gobjOutTo.Height - lngOffsetTop * 2 - lngFoot
                rcFoot.Bottom = lngPrintTextY
            End If
            If lngPrintTextY + lngFoot > gobjOutTo.Height - lngOffsetTop * 2 Then lngPrintTextY = gobjOutTo.Height - lngOffsetTop * 2 - lngFoot
            If lngPageIndex = 4 Then lngFoot = 0
        Else
            gobjOutTo.Print ""
            lngFoot = 0
            rcFoot.Bottom = gobjOutTo.Height
        End If
        With rcFoot
            .Left = lngOffsetLeft
            .Top = gobjOutTo.Height - lngOffsetTop * 2 - gobjOutTo.ScaleY(gobjSend.EmptyDown, vbMillimeters, vbTwips) + lngFoot
            .Right = gobjOutTo.Width - lngOffsetLeft
        End With
    End If
    
    gTargetDC = hDC
    With rcPage
        .Left = 0
        .Top = 0
        .Right = gobjOutTo.Width
        .Bottom = gobjOutTo.Height
    End With
    With rcDrawTo
        If blnHead Then
            .Left = rcHeand.Left
            .Top = rcHeand.Top
            .Right = rcHeand.Right
            .Bottom = rcHeand.Bottom
        Else
            .Left = rcFoot.Left
            .Top = rcFoot.Top
            .Right = rcFoot.Right
            .Bottom = rcFoot.Bottom
        End If
    End With
    With fr
        .hDC = gobjOutTo.hDC
        .hdcTarget = gTargetDC
        .rc = rcDrawTo
        .rcPage = rcPage
        .chrg.cpMin = 0
        .chrg.cpMax = -1
    End With
    
    Do
        lngNextPos = SendMessage(objRTB.hWnd, EM_FORMATRANGE, 0, fr)
        
        lngPageCount = lngPageCount + 1             ' Ò³Êý£«1
        '¼ÇÂ¼·ÖÒ³ÐÅÏ¢
        ReDim Preserve AllPages(1 To lngPageCount) As PageInfo
        AllPages(lngPageCount).PageNumber = lngPageCount
        AllPages(lngPageCount).ActualHeight = fr.rc.Bottom - fr.rc.Top          'Êµ¼Ê´òÓ¡¸ß¶È
        AllPages(lngPageCount).Start = lngTmp
        AllPages(lngPageCount).End = lngNextPos
        
        fr.chrg.cpMin = lngNextPos
        If lngNextPos <= lngTmp Or lngNextPos >= lngLen Then Exit Do      ' Íê³ÉËùÓÐÒ³ÃæµÄ·ÖÒ³
        lngTmp = lngNextPos
    Loop
    Call SendMessage(objRTB.hWnd, EM_FORMATRANGE, 0, ByVal CLng(0))
    
    For lngLen = 1 To lngPageCount
        If lngLen > 1 Then Exit For
        With fr
            .hDC = gobjOutTo.hDC
            .hdcTarget = gTargetDC
            .rc = rcDrawTo
            .rcPage = rcPage
            .chrg.cpMin = AllPages(lngLen).Start
            .chrg.cpMax = AllPages(lngLen).End
        End With
        Call SendMessage(objRTB.hWnd, EM_FORMATRANGE, 1, fr)
        Call SendMessage(objRTB.hWnd, EM_FORMATRANGE, 0, ByVal CLng(0))
    Next
    
    '×îºóÔÚÊä³öÒ³Âë
    If chkÒ³Âë.Value = 1 And ((blnHead = True And (lngPageIndex = 1 Or lngPageIndex = 2)) Or (blnHead = False And (lngPageIndex = 3 Or lngPageIndex = 4))) Then
        gobjOutTo.CurrentY = lngPrintTextY
        If optPageAlign(0).Value Then
            gobjOutTo.CurrentX = gobjOutTo.ScaleX(gobjSend.EmptyLeft, vbMillimeters, vbTwips) - 30
        ElseIf optPageAlign(1).Value Then
            gobjOutTo.CurrentX = (gobjOutTo.Width - 90 * LenB(StrConv("µÚ " & lngPage & " Ò³", vbFromUnicode))) / 2
        Else
            gobjOutTo.CurrentX = gobjOutTo.Width - gobjOutTo.ScaleX(gobjSend.EmptyRight, vbMillimeters, vbTwips) - 90 * LenB(StrConv("Ò³Âë:" & mintÒ³Âë, vbFromUnicode))
        End If
        gobjOutTo.Print "µÚ " & lngPage & " Ò³"
    End If
End Function

Public Function PrintPage(Optional blnOddEvenPrint As Boolean = False, Optional ArrSQL As Variant) As Boolean
    Dim strSQL() As String
    Dim blnTrans As Boolean
    Dim blnSave As Boolean          'ÒÑ´òÓ¡µÄÊý¾Ý²»±£´æ
    Dim strTime As String
    Dim strCurrDate As String
    Dim lngRow As Long, lngRows As Long
    Dim intMax As Integer, intPos As Integer
    Dim lngCurRow As Long, lngDataLines As Long
    Dim intTag As Integer
    Dim int½áÊøÒ³Âë As Integer
    Dim lngFileID As Long
    
    ReDim Preserve strSQL(1 To 1)
    On Error GoTo ErrHand
    
    '56134:ÁõÅô·É,2012-12-19,²¡ÈË»¤Àí´òÓ¡Ìí¼Ó´òÓ¡±êÊ¶
    If mblnPrintRow = True Then
        intTag = 1
    Else
        intTag = 0
        If gintPrintState = 1 And glngPrintRow > 0 And Val(VsfData.TextMatrix(glngPrintRow, VsfData.Cols - 7)) > 0 Then
            intTag = 1
        End If
    End If
    
    '¶ÔÏÔÊ¾ÐÐ½øÐÐ´¦Àí
    lngRows = VsfData.Rows - 1
    For lngRow = VsfData.FixedRows To lngRows
        If Not VsfData.RowHidden(lngRow) Then
            If lngCurRow = 0 Then lngCurRow = 1
            If FormatValue(VsfData.TextMatrix(lngRow, mlngRowCount)) Like "*|1" Then
                lngDataLines = Split(VsfData.TextMatrix(lngRow, mlngRowCount), "|")(0)
                blnSave = (Val(VsfData.TextMatrix(lngRow, mlngPrintedPage)) = 0) Or gintPrintState > 1
                'ÖØ´òµÄ»°±£³ÖÔ­ÓÐµÄ½áÊøÒ³Âë
                int½áÊøÒ³Âë = IIf(mlngµ±Ç°Ò³Âë = 0, mintÒ³Âë, mlngµ±Ç°Ò³Âë)
                If blnSave Then
                    strTime = VsfData.TextMatrix(lngRow, 1)
                    lngFileID = Val(VsfData.TextMatrix(lngRow, mlngFileID))
                    gstrSQL = "ZL_²¡ÈË»¤Àí´òÓ¡_PRINT(" & lngFileID & ",to_date('" & strTime & "','yyyy-MM-dd hh24:mi:ss'),'" & gstrUserName & "'," & _
                        IIf(mlngµ±Ç°Ò³Âë = 0, mintÒ³Âë, mlngµ±Ç°Ò³Âë) & "," & lngCurRow & "," & intTag & "," & int½áÊøÒ³Âë & ")"
                    'Debug.Print gstrSQL
                    strSQL(ReDimArray(strSQL)) = gstrSQL
                End If
            End If
            '46506:ÁõÅô·É,2012-12-28,¼ÇÂ¼µ¥ÂúÒ³´òÓ¡
            'Ã¿Ò»Ò³µÄÊ×ÐÐÈç¹û²»ÊÇ±¾ÌõÊý¾ÝµÄÆðÊ¼ÐÐ,¾ÍËµÃ÷ÊÇ¿çÒ³Êý¾Ý
            If lngCurRow = 1 And Not FormatValue(VsfData.TextMatrix(lngRow, mlngRowCount)) Like "*|1" Then
                strTime = VsfData.TextMatrix(lngRow, 1)
                lngFileID = Val(VsfData.TextMatrix(lngRow, mlngFileID))
                gstrSQL = "ZL_²¡ÈË»¤Àí´òÓ¡_PRINT(" & lngFileID & ",to_date('" & strTime & "','yyyy-MM-dd hh24:mi:ss'),'" & gstrUserName & "'," & _
                         "NULL,NULL," & intTag & "," & IIf(mlngµ±Ç°Ò³Âë = 0, mintÒ³Âë, mlngµ±Ç°Ò³Âë) & ",1)"
                strSQL(ReDimArray(strSQL)) = gstrSQL
            End If
            lngCurRow = lngCurRow + 1
        End If
    Next
    
    'Èç¹ûÊÇÆæÅ¼´òÓ¡£¬²¢ÇÒ´òÓ¡Ò³Êý²»Îª1,¾Í·µ»ØÊý¾ÝSQL
    If blnOddEvenPrint = True Then
        ArrSQL = strSQL
        PrintPage = True
        Exit Function
    End If
    
    On Error Resume Next
    intMax = UBound(strSQL)

    gcnOracle.BeginTrans
    blnTrans = True

    On Error GoTo ErrHand
    If intMax > 0 Then
        For intPos = 1 To intMax
            If strSQL(intPos) <> "" Then
                gcnOracle.Execute strSQL(intPos), , adCmdStoredProc
            End If
        Next
    End If

    gcnOracle.CommitTrans
    blnTrans = False
    PrintPage = True
    Exit Function
ErrHand:
    If blnTrans Then gcnOracle.RollbackTrans
    If ErrCenter = 1 Then
        Resume
    End If
End Function

Private Sub InitRecords()
    Dim i As Integer, j As Integer, k As Integer, l As Integer
    Dim lngCol As Long, lngOrder As Long, strName As String, intImmovable As Integer, strFormat As String
    Dim arrColumn, arrItem, arrCorrelative(), strColumns As String
    Dim blnSet As Boolean
    
    On Error GoTo ErrHand
    
    strColumns = mstrColumns
    If Not mblnInit Then
        '³õÊ¼»¯ÄÚ´æ¼ÇÂ¼¼¯(Î´¶ÔÓ¦ÏîÄ¿µÄÁÐÎª»î¶¯ÏîÄ¿,ÆäËüÁÐ¾ùÎª¹Ì¶¨Ïî)
        strFields = "ÁÐ," & adDouble & ",18|ÐòºÅ," & adDouble & ",2|ÏîÄ¿ÐòºÅ," & adDouble & ",18|ÏîÄ¿Ãû³Æ," & adLongVarChar & ",20|¹Ì¶¨," & adDouble & ",2|¸ñÊ½," & adLongVarChar & ",2000"
        Call Record_Init(mrsSelItems, strFields)
        strFields = "ÁÐ|ÐòºÅ|ÏîÄ¿ÐòºÅ|ÏîÄ¿Ãû³Æ|¹Ì¶¨|¸ñÊ½"
    End If
    
    '¼ÓÈëÁÐ¶¨Òå
    If Not mblnInit Then
        arrColumn = Split(strColumns, "|")
        j = UBound(arrColumn)
        For i = 0 To j
            lngCol = Split(arrColumn(i), "'")(0)
            arrItem = Split(Split(arrColumn(i), "'")(1), ",")
            blnSet = False   'Èç¹ûÒÑÉèÖÃÒÔ´«ÈëÖµÎª×¼'·ñÔòÕÒ²»µ½ÏîÄ¿¾ÍÊÇ»î¶¯ÏîÄ¿
            If UBound(Split(arrColumn(i), "'")) > 1 Then
                blnSet = True
                intImmovable = Split(arrColumn(i), "'")(2)
            End If
            If UBound(Split(arrColumn(i), "'")) > 2 Then
                strFormat = Split(arrColumn(i), "'")(3)
            End If
            
            k = UBound(arrItem)
            For l = 0 To k
                strName = arrItem(l)
                mrsItems.Filter = "ÏîÄ¿Ãû³Æ='" & strName & "'"
                If mrsItems.RecordCount <> 0 Then
                    lngOrder = mrsItems!ÏîÄ¿ÐòºÅ
                    If Not blnSet Then intImmovable = 1   '¹Ì¶¨²»ÔÊÐíÐÞ¸Ä
                Else
                    lngOrder = 0
                    If Not blnSet Then intImmovable = 0
                    
                    '¼ÇÂ¼ÌØÊâÁÐ
                    Select Case strName
                    Case "ÈÕÆÚ"
                        mlngDate = i + cHideCols + VsfData.FixedCols
                    Case "Ê±¼ä"
                        mlngTime = i + cHideCols + VsfData.FixedCols
                    Case "»¤Ê¿"
                        mlngOperator = i + cHideCols + VsfData.FixedCols
                    Case "Ç©ÃûÈË"
                        mlngSignName = i + cHideCols + VsfData.FixedCols
                    Case "Ç©ÃûÊ±¼ä"
                        mlngSignTime = i + cHideCols + VsfData.FixedCols
                    End Select
                End If
                strValues = lngCol & "|" & l + 1 & "|" & lngOrder & "|" & strName & "|" & intImmovable & "|" & strFormat
                Call Record_Add(mrsSelItems, strFields, strValues)
            Next
        Next
        
        'ÕûÀí·ÖÀà»ã×Ü¹ØÁªÁÐÐÅÏ¢
        arrCorrelative = Array()
        arrColumn = Split(mstrColCorrelative, "|")
        For i = 0 To UBound(arrColumn)
            arrItem = Split(arrColumn(i), ";")
            If UBound(arrItem) = 1 Then
                mrsSelItems.Filter = "ÁÐ=" & Val(arrItem(0))
                If mrsSelItems.RecordCount = 1 Then
                    ReDim Preserve arrCorrelative(UBound(arrCorrelative) + 1)
                    arrCorrelative(UBound(arrCorrelative)) = Val(arrItem(0)) & "," & mrsSelItems!ÏîÄ¿ÐòºÅ & ";" & CStr(arrItem(1))
                End If
            End If
        Next i
        If UBound(arrCorrelative) = -1 Then
            mstrColCorrelative = ""
        Else
            mstrColCorrelative = Join(arrCorrelative, "|")
        End If
        mrsSelItems.Filter = ""
        
        'Call OutputRsData(mrsSelItems)
        
        '¼ÓÈë³ÌÐòÄÚ²¿¿ØÖÆÁÐ(ÁÐÊÇÔÚ¶ÁÈ¡Êý¾Ýºó°ó¶¨Ê±Ôö¼ÓµÄ,´ËÊ±Ö»ÓÐÔ¤´¦ÀíÏÂ)
        mlngSignLevel = VsfData.Cols + cHideCols + VsfData.FixedCols '¼ÓÉÏÒþ²ØÁÐ
        mlngSigner = mlngSignLevel + 1
        '51589:ÁõÅô·É,2013-03-01,Ìí¼Ó½»°àÇ©Ãû
        mlngJoinSignName = mlngSigner + 1
        mlngFileID = mlngJoinSignName + 1
        mlngRecord = mlngFileID + 1
        mlngRowCount = mlngRecord + 1
        mlngRowCurrent = mlngRowCount + 1
        mlngStartSpread = mlngRowCurrent + 1 '50503:ÁõÅô·É,2012-09-12
        mlngPrintedEndPage = mlngStartSpread + 1 '46506:ÁõÅô·É,2012-12-27
        mlngCollectValue = mlngPrintedEndPage + 1  '³ÂÁõ,105302
        mlngPrintedTag = mlngCollectValue + 1 '56134:ÁõÅô·É,2012-12-19
        mlngCollectType = mlngPrintedTag + 1
        mlngCollectText = mlngCollectType + 1
        mlngCollectStyle = mlngCollectText + 1
        mlngCollectDay = mlngCollectStyle + 1
        mlngPrintedPage = mlngCollectDay + 1
        mlngPrintedRow = mlngPrintedPage + 1
        
        
        If mlngOperator <> -1 And mlngSignName <> -1 Then
            mlngNoEditor = IIf(mlngOperator < mlngSignName, mlngOperator, mlngSignName)
        Else
            mlngNoEditor = IIf(mlngOperator <> -1, mlngOperator, mlngSignName)
        End If
    End If
    
    mrsItems.Filter = 0
    Exit Sub
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Sub

Public Function ShowPage(Optional ByVal intPage As Integer = 0) As Boolean
    'ÏÔÊ¾Ö¸¶¨Ò³ÃæÊý¾Ý²¢¸üÐÂ´òÓ¡¶ÔÏó
    Dim aryPeriod
    Dim strBegin As String, strEnd As String
    Dim lngRow As Long, lngRows As Long, lngStart As Long
    Dim lngOffsetLeft As Long, lngScaleWidth As Long
    Dim lngShows As Long
    '»î¶¯ÏîÄ¿Ïà¹Ø±äÁ¿
    Dim mrsTemp As New ADODB.Recordset
    Dim blnPrintRow As Boolean
    On Error GoTo ErrHand
    
    If intPage <> 0 Then mlngMinIndex = intPage - Val(mArrPage(0))
    If mlngMinIndex > mlngMaxIndex Then mlngMinIndex = mlngMaxIndex
    
    mintÒ³Âë = Val(mArrPage(mlngMinIndex))
    If InStr(1, CStr(mArrPage(mlngMinIndex)), ";") <> 0 Then
        gintPrintState = Val(Split(CStr(mArrPage(mlngMinIndex)), ";")(1))
    Else
        gintPrintState = 2
    End If
    
    lngOffsetLeft = Printer.ScaleX(GetDeviceCaps(Printer.hDC, PHYSICALOFFSETX), vbPixels, vbTwips)
    
    Call LoadPageData '¼ÓÔØÏàÓ¦Ò³´òÓ¡Êý¾Ý
    
    With VsfData
        'Ð¡ÓÚÒ³ÃæÓÐÐ§Êý¾ÝÐÐËµÃ÷Ö»ÓÐÒ»Ò³Êý¾Ý
        If VsfData.Rows - VsfData.FixedRows > mlngPageRows Then
            lngRows = .Rows - 1
            For lngRow = .FixedRows To lngRows
                .RowHidden(lngRow) = True
            Next
        End If
        
        'Ð¡ÓÚÒ³ÃæÓÐÐ§Êý¾ÝÐÐËµÃ÷Ö»ÓÐÒ»Ò³Êý¾Ý
        If VsfData.Rows - VsfData.FixedRows > mlngPageRows Then
            lngRow = 3 + mlngPageRows * (mintÒ³Âë - mintµ±Ç°ÆðÊ¼Ò³)
            lngRows = 3 + mlngPageRows * (mintÒ³Âë - mintµ±Ç°ÆðÊ¼Ò³ + 1) - 1
        Else
            lngRow = 3
            lngRows = .Rows - 1
        End If
        If lngRows > .Rows - 1 Then lngRows = .Rows - 1
        '»ñÈ¡Ö¸¶¨Ò³µÄÊ±¼ä·¶Î§
        If lngRow > lngRows Then
            Exit Function
        End If
        strBegin = Format(.TextMatrix(lngRow, 1), "YYYY-MM-DD HH:mm:ss")
        lngStart = lngRows
        lngStart = GetStartRow(lngStart)
        strEnd = .TextMatrix(lngStart, 1)
        If Not IsDate(strEnd) And lngStart <> lngRow Then
            lngStart = lngRow
            strEnd = .TextMatrix(lngStart, 1)
        End If
        strEnd = Format(strEnd, "YYYY-MM-DD HH:mm") & ":59"
        '53588:ÁõÅô·É,2013-4-25,ÐÞ¸ÄÊý¾ÝµÄÊ±¼äÐ¡ÓÚ²¡ÈËÈëÔºÊ±¼ä£¬´²ºÅ£¬²¡Çø²»ÄÜÏÔÊ¾ÎÊÌâ
        'Èç£º²¡ÈËÈë¿ÆÊ±¼äÎª2013-03-13 11:23:34 ÎÄ¼þ¿ªÊ¼Ê±¼äºÍÈë¿ÆÏàÍ¬£¬´ËÊ±Â¼ÈëÊý¾ÝÊ±¼äÎª 2013-03-13 11:23
        '¾Í»áµ¼ÖÂÎÞ·¨ÌáÈ¡´²ºÅ£¬Ó¦Îª±£´æµÄÊý¾ÝÊ±¼äÎª2013-03-13 11:23:00 Ð¡ÓÚÁË²¡ÈËÈë¿ÆÊ±¼äµ¼ÖÂÎÞ·¨ÌáÈ¡µ½Êý¾Ý
        '»ñÈ¡²¡ÈËµÄÈëÔºÊ±¼ä
        If mintÓ¤¶ù = 0 Then
            gstrSQL = "Select ¿ªÊ¼Ê±¼ä, Sysdate As ½áÊøÊ±¼ä" & vbNewLine & _
                " From ²¡ÈË±ä¶¯¼ÇÂ¼" & vbNewLine & _
                " Where ²¡ÈËid = [1] And Ö÷Ò³id = [2] And ¿ªÊ¼Ô­Òò = 2" & vbNewLine & _
                " Union All" & vbNewLine & _
                " Select ¿ªÊ¼Ê±¼ä, Sysdate As ½áÊøÊ±¼ä" & vbNewLine & _
                " From ²¡ÈË±ä¶¯¼ÇÂ¼ a" & vbNewLine & _
                " Where a.²¡ÈËid = [1] And a.Ö÷Ò³id = [2] And a.¿ªÊ¼Ô­Òò = 1 And Not Exists" & vbNewLine & _
                " (Select 1 From ²¡ÈË±ä¶¯¼ÇÂ¼ Where ²¡ÈËid = a.²¡ÈËid And Ö÷Ò³id = a.Ö÷Ò³id And ¿ªÊ¼Ô­Òò = 2)"
        Else
            gstrSQL = " Select   ³öÉúÊ±¼ä AS ¿ªÊ¼Ê±¼ä From ²¡ÈËÐÂÉú¶ù¼ÇÂ¼ Where ²¡ÈËID=[1] And Ö÷Ò³ID=[2] And ÐòºÅ=[3]"
        End If
        Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "È¡ÈëÔºÈÕÆÚ»ò³öÉúÈÕÆÚ", mlng²¡ÈËID, mlngÖ÷Ò³ID, mintÓ¤¶ù)
        If Format(strBegin, "yyyy-MM-dd HH:mm:ss") < Format(mrsTemp!¿ªÊ¼Ê±¼ä, "yyyy-MM-dd HH:mm:ss") Then
            strBegin = Format(mrsTemp!¿ªÊ¼Ê±¼ä, "yyyy-MM-dd HH:mm:ss")
        End If
        aryPeriod = Split(strBegin & "||" & strEnd, "||")
        
        lngStart = lngRow
        'Ð¡ÓÚÒ³ÃæÓÐÐ§Êý¾ÝÐÐËµÃ÷Ö»ÓÐÒ»Ò³Êý¾Ý
        If VsfData.Rows - VsfData.FixedRows > mlngPageRows Then
            'ÏÔÊ¾Êý¾ÝÐÐ
            For lngRow = lngRow To lngRows
                .RowHidden(lngRow) = False
                lngShows = lngShows + 1
            Next
        End If
        
        '56134:ÁõÅô·É,2012-12-19
        '²»×ãÒ»Ò³µÄÊä³öÊ£Óà±í¸ñ(Ö»ÓÐ×îºóÒ»Ò³²Å»áÓÐ´ËÇé¿ö)
        'ÖØ´òºÍÁ¬ÐøÖØ´òµÄÇé¿ö£¬Ö»ÒªmblnPrintRow=True£¬²¢ÇÒÊý¾Ý²»×ãÒ»Ò³£¬¶¼ÐèÒªÊä³ö±í¸ñ
        'Á¬Ðø´òÓ¡Ê±mblnPrintRow=True£¬²¢ÇÒÊý¾Ý²»×ãÒ»Ò³£¬Èç¹û±¾Ò³Î´´òÓ¡¾ÍÊä³ö±í¸ñ£¬Èç¹ûÒÑ¾­´òÓ¡¹ýËµÃ÷Ö®Ç°ÒÑ¾­Êä³ö¹ý±í¸ñÁË¡£
        'Ô¤ÀÀµÄÇé¿ö£¬Ö»ÒªmblnPrintRow=True¶¼Êä³ö±í¸ñ
        If mblnPrintRow = True And lngRows - lngStart + 1 < mlngPageRows Then
            blnPrintRow = False
            If gblnPrintMode = False Then 'Ô¤ÀÀ
                blnPrintRow = True
            Else '´òÓ¡
                If gintPrintState = 1 Then 'Á¬Ðø´òÓ¡
                    'Èç¹û±¾Ò³Ö®Ç°Ã»ÓÐ´òÓ¡¹ý£¬¾ÍÊäÈë±í¸ñ
                    If glngPrintRow >= lngStart And glngPrintRow <= lngRows Then
                        blnPrintRow = (Val(.TextMatrix(glngPrintRow, mlngPrintedTag)) = 0)
                    Else
                        blnPrintRow = True
                    End If
                Else 'ÖØ´ò»òÁ¬ÐøÖØ´ò
                    blnPrintRow = True
                End If
            End If
            If blnPrintRow = True Then
                VsfData.Rows = VsfData.Rows + mlngPageRows - (lngRows - lngStart + 1)
                For lngRow = lngRows To VsfData.Rows - 1
                    VsfData.RowHeight(lngRow) = VsfData.RowHeightMin
                Next
            End If
        End If
        
        ShowPage = True
        Call zlReadTip(aryPeriod)
    End With
    
    'ÉèÖÃ´òÓ¡Ïà¹ØÄÚÈÝ
    Dim objPrint As New zlTFPrintTends, objAppRow As zlTFTabAppRow
    Dim strLable As String, strAppRow As String, lngSpaces As Long
    Dim lngPos As Long, lngMax As Long, lngNumber As Long, blnNumber As Boolean, lngASC As Long
    
    'ÉèÖÃ´òÓ¡¸ñÊ½
    If UBound(Split(mstrPaperSet, ";")) >= 0 Then SaveSetting "ZLSOFT", "¹«¹²Ä£¿é\zl9TendFile\Default", "PaperSize", Val(Split(mstrPaperSet, ";")(0))
    If UBound(Split(mstrPaperSet, ";")) >= 1 Then SaveSetting "ZLSOFT", "¹«¹²Ä£¿é\zl9TendFile\Default", "Orientation", Val(Split(mstrPaperSet, ";")(1))
    If UBound(Split(mstrPaperSet, ";")) >= 2 Then SaveSetting "ZLSOFT", "¹«¹²Ä£¿é\zl9TendFile\Default", "Height", Val(Split(mstrPaperSet, ";")(2))
    If UBound(Split(mstrPaperSet, ";")) >= 3 Then SaveSetting "ZLSOFT", "¹«¹²Ä£¿é\zl9TendFile\Default", "Width", Val(Split(mstrPaperSet, ";")(3))
    If UBound(Split(mstrPaperSet, ";")) >= 4 Then objPrint.EmptyLeft = Round(ScaleY(Val(Split(mstrPaperSet, ";")(4)), vbTwips, vbMillimeters), 2)
    If UBound(Split(mstrPaperSet, ";")) >= 5 Then objPrint.EmptyRight = Round(ScaleY(Val(Split(mstrPaperSet, ";")(5)), vbTwips, vbMillimeters), 2)
    If UBound(Split(mstrPaperSet, ";")) >= 6 Then objPrint.EmptyUp = Round(ScaleX(Val(Split(mstrPaperSet, ";")(6)), vbTwips, vbMillimeters), 2)
    If UBound(Split(mstrPaperSet, ";")) >= 7 Then objPrint.EmptyDown = Round(ScaleX(Val(Split(mstrPaperSet, ";")(7)), vbTwips, vbMillimeters), 2)
    
    On Error Resume Next
    Printer.PaperSize = Val(Split(mstrPaperSet, ";")(0))
    Printer.Orientation = Val(Split(mstrPaperSet, ";")(1))
    
    If Printer.PaperSize = 256 Then
        Call SetCustonPager(Val(Split(mstrPaperSet, ";")(3)), Val(Split(mstrPaperSet, ";")(2)))
    End If
    
    On Error GoTo ErrHand
    Set objPrint.Body = VsfData
    objPrint.Title.Text = lblTitle.Caption
    Set objPrint.Title.Font = lblTitle.Font
    Set objPrint.AppFont = lblSubhead.Font
    
    lngSpaces = lblSubhead.Height / 210
    strLable = lblSubhead.Caption
    '60333:ÁõÅô·É,2013-10-14,ÐÞ¸ÄÎÄ¼þ±àºÅµ¼ÖÂ´òÓ¡ÐÅÏ¢¶ªÊ§
    If UBound(Split(mstrPaperSet, ";")) >= 4 Then
        lngScaleWidth = Printer.Width - (lngOffsetLeft + Val(Split(mstrPaperSet, ";")(4))) * 2
    Else
        lngScaleWidth = Printer.Width - (lngOffsetLeft) * 2
    End If
    lngMax = Len(strLable)
    lngNumber = 0
    lngStart = 1
    For lngPos = 1 To lngMax
        'Èç¹ûÊýÑ§³¬³¤,Ôò°ÑÊý×ÖÒÆµ½ÏÂÒ»ÐÐÏÔÊ¾
        lngASC = Asc(Mid(strLable, lngPos, 1))

        '¼ì²éÊÇ·ñ³¬¿í(³¤¶È³¬¹ýÐÐ¿í,»òÕßÓöµ½»Ø³µ»»ÐÐ·û)
        If TextWidth(Mid(strLable, lngStart, lngPos - lngStart + 1) & "²â") > lngScaleWidth Or lngPos = lngMax Or lngASC = 10 Then
            If lngPos = lngMax Or lngASC = 10 Then
                strAppRow = Mid(strLable, lngStart, lngPos - lngStart + 1)
            Else
                strAppRow = Mid(strLable, lngStart, lngPos - lngStart - 1) & "¡­"
            End If
            lngStart = lngPos + 1
            
            'Êä³ö±íÉÏÏî
            Set objAppRow = New zlTFTabAppRow
            Call objAppRow.Add(strAppRow)
            Call objPrint.UnderAppRows.Add(objAppRow)
            
            If lngPos = lngMax Or lngASC = 10 Then
            Else
                Exit For        '»¤Àí¼ÇÂ¼µ¥±íÉÏ±êÇ©³¬³¤Ò²Ö»´òÒ»ÐÐ£¬±íÉÏ±êÇ©µÄÐÐÊý±ä»¯»áÓ°Ïì±í¸ñ´òÓ¡ÐÐ£¬ËùÒÔ¹Ì¶¨²»ÔÊÐíÌí¼Ó
            End If
        End If
    Next
    '60333:ÁõÅô·É,2013-10-14,ÐÞ¸ÄÎÄ¼þ±àºÅµ¼ÖÂ´òÓ¡ÐÅÏ¢¶ªÊ§
    If UBound(Split(mstrPaperSet, ";")) >= 3 Then
        lngMax = Val(Split(mstrPaperSet, ";")(3))
    Else
        lngMax = Printer.Width
    End If
'    If mstrPageHead <> "" Then objPrint.Header = mstrPageHead
'    If mstrPageFoot <> "" Then
'        mstrPageFoot = Replace(mstrPageFoot, "{´òÓ¡Ê±¼ä}", Now)
'        mstrPageFoot = Replace(mstrPageFoot, "{Ò³Âë}", mintÒ³Âë + mintºÏ²¢ÆðÊ¼Ò³ - 1)
'        mstrPageFoot = Replace(mstrPageFoot, "{´òÓ¡ÈË}", gstrUserName)
'        objPrint.Footer = LeftB(mstrPageFoot & Space(lngMax), lngMax - objPrint.EmptyLeft - objPrint.EmptyRight)
'    End If
    
    Set gobjSend = objPrint

    '±£´æ±êÌâµÄÊôÐÔ
    gstrTabTitle = gobjSend.Title.Text
    gstrTitleFName = gobjSend.Title.Font.Name
    gintTitleFSize = gobjSend.Title.Font.Size
    gblnTitleFItalic = gobjSend.Title.Font.Italic
    gblnTitleFBold = gobjSend.Title.Font.Bold
    glngTitleColor = gobjSend.Title.Color
    '±£´æ±íÉÏÏîÄ¿Óë±íÏÂÏîÄ¿µÄÊôÐÔ
    gstrAppRowFName = gobjSend.AppFont.Name
    gintAppRowFSize = gobjSend.AppFont.Size
    gblnAppRowFItalic = gobjSend.AppFont.Italic
    gblnAppRowFBold = gobjSend.AppFont.Bold
    glngAppRowColor = gobjSend.AppColor
    gintUpAppRow = gobjSend.UnderAppRows.Count
    gintDownAppRow = gobjSend.BelowAppRows.Count
    
    If gobjSend.FixRow = 0 Then gobjSend.FixRow = gobjSend.Body.FixedRows
    gintFixRow = gobjSend.FixRow
    gintFixCol = gobjSend.FixCol
'    gintRowTotal = gobjSend.Rows
'    gintColTotal = gobjSend.Cols
    gintGroups = 1
    
    gsngDown = gobjSend.EmptyDown
    gsngLeft = gobjSend.EmptyLeft
    gsngRight = gobjSend.EmptyRight
    gsngUp = gobjSend.EmptyUp
    gsngHeader = gobjSend.PageHeader
    gsngFooter = gobjSend.PageFooter
    
    gstrHeader = gobjSend.Header
    gstrHeader = IIf(gstrHeader = "", ";;", gstrHeader)
    gstrFooter = gobjSend.Footer
    gstrFooter = IIf(gstrFooter = "", ";;", gstrFooter)
    
    '×î¶à²»¹ýÒ»ÁÐ¾ÍÊÇÒ»Ò³Ãæ
    Call GetPrinterSet
    Call CalculateHeight
    Call CalculateRC
    gstr¶Ô½ÇÏß = GetDiagonal
    glngHideCols = cHideCols
    glngSignName = IIf(mblnSignPic = True, mlngSignName, -1)
    '64583:ÁõÅô·É,2013-09-22,´òÓ¡Ê±Í¬Ò»¸öÈÕÆÚÊÇ·ñÖØ¸´ÏÔÊ¾
    glngDate = IIf(mblnDateModel = True, mlngDate, -1)
    glngCollectColor = mlngCollectColor
    
    ShowPage = True
    Exit Function
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Function

Public Function GetFixedProperty(ByVal strName As String) As Variant
'¸ù¾ÝÃû³Æ»ñÈ¡¹Ì¶¨ÊôÐÔ
    Dim varProperty As Variant
    Select Case strName
        Case "ÓÐÐ§Êý¾ÝÐÐ"
            varProperty = mlngPageRows
        Case "»ã×ÜÑÕÉ«"
            varProperty = mlngCollectColor
    End Select
    GetFixedProperty = varProperty
End Function

Public Function GetFixedCol(ByVal strName As String) As Long
'¸ù¾ÝÃû³Æ»ñÈ¡¹Ì¶¨ÁÐÐÅÏ¢
    Dim lngCol As Long
    Select Case strName
        Case "ÈÕÆÚ"
            lngCol = mlngDate
        Case "Ê±¼ä"
            lngCol = mlngTime
        Case "»¤Ê¿"
            lngCol = mlngOperator
        Case "Ç©ÃûÈË"
            lngCol = mlngSignName
        Case "Ç©ÃûÊ±¼ä"
            lngCol = mlngSignTime
        Case "Ç©Ãû¼¶±ð"
            lngCol = mlngSignLevel
        Case "Ç©ÃûÐÅÏ¢"
            lngCol = mlngSigner
        Case "½»°àÇ©ÃûÈË"
            lngCol = mlngJoinSignName
        Case "ÎÄ¼þID"
            lngCol = mlngFileID
        Case "¼ÇÂ¼ID"
            lngCol = mlngRecord
        Case "ÐÐÊý"
            lngCol = mlngRowCount
        Case "Êµ¼ÊÐÐÊý"
            lngCol = mlngRowCurrent
        Case "¿ªÊ¼ÐÐºÅ"
            lngCol = mlngStartSpread
        Case "´òÓ¡½áÊøÒ³ºÅ"
            lngCol = mlngPrintedEndPage
        Case "»ã×ÜÖµ"
            lngCol = mlngCollectValue
        Case "´òÓ¡±êÊ¶"
            lngCol = mlngPrintedTag
        Case "»ã×ÜÀà±ð"
            lngCol = mlngCollectType
        Case "»ã×ÜÎÄ±¾"
            lngCol = mlngCollectText
        Case "»ã×Ü±ê¼Ç"
            lngCol = mlngCollectStyle
        Case "»ã×ÜÈÕÆÚ"
            lngCol = mlngCollectDay
        Case "´òÓ¡Ò³ºÅ"
            lngCol = mlngPrintedPage
        Case "´òÓ¡ÐÐºÅ"
            lngCol = mlngPrintedRow
        Case "½ûÖ¹±à¼­"
            lngCol = mlngNoEditor
    End Select
    GetFixedCol = lngCol
End Function

Public Function GetStartPage() As Integer
    If UBound(mArrPage) < 0 Then
        GetStartPage = 1
    Else
        GetStartPage = Val(mArrPage(0))
    End If
End Function

Public Function GetCollectCols(ByVal lngRaw As Long) As String
    GetCollectCols = VsfData.TextMatrix(lngRaw, mlngCollectValue)
End Function

Public Function GetPages() As Integer
    If UBound(mArrPage) < 0 Then
        GetPages = 1
    Else
        GetPages = mlngMaxIndex + Val(mArrPage(0))
    End If
End Function

Public Function isEndPage() As Boolean
    isEndPage = (mlngMinIndex = mlngMaxIndex)
End Function

Public Sub PrevPage()
    If mlngMinIndex > 0 Then
        mlngMinIndex = mlngMinIndex - 1
        If mlngMinIndex <= UBound(mArrPage) Then
            Call ShowPage
        End If
    End If
End Sub

Public Function NextPage() As Boolean
    If mlngMinIndex < mlngMaxIndex Then
        mlngMinIndex = mlngMinIndex + 1
        If mlngMinIndex <= UBound(mArrPage) Then
            NextPage = ShowPage
        End If
    End If
End Function

Public Function AppointPage(ByVal intPage As Integer) As Boolean
    If UBound(mArrPage) >= 0 Then
        If intPage <= mlngMaxIndex + Val(mArrPage(0)) Then
            mlngMinIndex = intPage - Val(mArrPage(0))
            AppointPage = ShowPage
        End If
    End If
End Function

Public Function GetFileName() As String
    GetFileName = lblTitle.Caption
End Function

Public Function blnOddEvenPagePrint() As Boolean
    blnOddEvenPagePrint = mblnOddEvenPagePrint
End Function

Public Function blnShowNullCollet() As Boolean
    blnShowNullCollet = mblnShowNullCollet
End Function

Private Sub WriteColor()
    Dim blnTag As Boolean
    Dim lngCount As Long
    Dim lngRow As Long, lngCol As Long
    On Error GoTo ErrHand
    'Íí°àÒÔºìÉ«ÏÔÊ¾,´òÓ¡¹ýµÄÒ³ºÅ×ÖÌåÉèÖÃÎª»ÒÉ«
    
    glngPrintRow = 0
    With VsfData
        For lngCount = .FixedRows To .Rows - 1
            If .TextMatrix(lngCount, 1) <> "" Then
                If .TextMatrix(lngCount, mlngPrintedPage) <> "" And gintPrintState = 1 Then
                    .Cell(flexcpForeColor, lngCount, 0, lngCount, .Cols - 1) = &HE0E0E0
                    glngPrintRow = lngCount                 '¼ÇÂ¼ÏÂ¸Ã×ø±ê,´Ó´Ë¿ªÊ¼ÏòÏÂ´òÓ¡
                Else
                    'ÒÔµÚÒ»ÌõÎ´´òÓ¡µÄÊý¾ÝÎªµ±Ç°ÏÔÊ¾Ò³
                    If lngRow = 0 And gintPrintState = 1 Then
                        lngRow = lngCount
                        mintÒ³Âë = (lngCount - VsfData.FixedRows) \ mlngPageRows + mintµ±Ç°ÆðÊ¼Ò³ - 1
                        If (lngCount - VsfData.FixedRows) > mlngPageRows Then
                            If (lngCount - VsfData.FixedRows) Mod mlngPageRows <> 0 Then mintÒ³Âë = mintÒ³Âë + 1
                        End If
                        If mintÒ³Âë < mintµ±Ç°ÆðÊ¼Ò³ Then mintÒ³Âë = mintµ±Ç°ÆðÊ¼Ò³
                    End If
                    
                    If Val(.TextMatrix(lngCount, mlngCollectType)) = 0 Then
                        'Íí°àÒÔºìÉ«ÏÔÊ¾
                        blnTag = False
                        If mintTagFormHour < mintTagToHour Then
                            blnTag = (Hour(.TextMatrix(lngCount, 1)) >= mintTagFormHour And Hour(.TextMatrix(lngCount, 1)) < mintTagToHour)
                        Else
                            blnTag = (Hour(.TextMatrix(lngCount, 1)) >= mintTagFormHour Or Hour(.TextMatrix(lngCount, 1)) < mintTagToHour)
                        End If
                        If blnTag Then
                            Set .Cell(flexcpFont, lngCount, 0, lngCount, .Cols - 1) = mobjTagFont
                            .Cell(flexcpForeColor, lngCount, 0, lngCount, .Cols - 1) = mlngTagColor
                        End If
                    End If
                End If
                '´¦ÀíÐ¡½áµÄÏÔÊ¾
                '65889:ÁõÅô·É,2013-11-1,´¦ÀíÐ¡½áÐÐ¿çÒ³µÄÇé¿ö£¬±£Ö¤ÏÂÒ»Ò³Ð¡½áÊ×ÐÐÒ²ÄÜÕýÈ·ÏÔÊ¾Ð¡½áÃû³Æ£¬¶ø²»ÊÇÊý¾Ý·¢ÉúÊ±¼ä
                'Ìí¼Ó (lngCount - .FixedRows + 1) Mod mlngPageRows = 1
                If FormatValue(VsfData.TextMatrix(lngCount, mlngRowCount)) Like "*|1" Or (lngCount - .FixedRows + 1) Mod mlngPageRows = 1 Then
                    If Val(VsfData.TextMatrix(lngCount, mlngCollectType)) <> 0 Then
                        VsfData.TextMatrix(lngCount, mlngDate) = VsfData.TextMatrix(lngCount, mlngCollectText)
                        If mblnÊ±¼äÁÐÒþ²Ø = False Then
                            VsfData.TextMatrix(lngCount, mlngTime) = VsfData.TextMatrix(lngCount, mlngCollectText)
                        End If
            
                        '88967:»¤Ê¿¡¢Ç©ÃûÁÐÍ¬Ê±´æÔÚ£¬ÇÒÊôÓÚÍ¬Ò»²Ù×÷Ô±£¬ÔòÓ¦±ÜÃâºÏ²¢(´òÓ¡Ç©ÃûÈËÊä³öÇ©ÃûÍ¼Æ¬Ðè×¢ÒâÇ©ÃûÈËÓÐ»Ø³µµÄÇé¿ö)
                        For lngCol = mlngTime + 1 To IIf(mlngNoEditor < mlngSignName, mlngSignName, mlngNoEditor)
                            '52953,ÁõÅô·É,2012-08-24,»ã×ÜÊý¾ÝÎª0Ò²ÒªÏÔÊ¾,¹ØÁªÎÊÌâ:60792
                            'If .TextMatrix(lngCount, lngCOL) = "0" Then .TextMatrix(lngCount, lngCOL) = ""
                            If Trim(.TextMatrix(lngCount, lngCol)) <> "" And .ColHidden(lngCol) = False Then
                                '66085:ÁõÅô·É,2012-09-26,±ÜÃâÏàÁÚ»ã×ÜÁÐºÏ²¢,½«Ô­À´µÄÁÐÄÚÈÝ+¿Õ¸ñÍ¬Ò»¸Ä³ÉÔÚÁÐºóÃæÔÚchr(13)
                                '±ÜÃâÒò¼Ó¿Õ¸ñºóÁÐ¿í²»¹»µ¼ÖÂÄÚÈÝÏÔÊ¾²»ÍêÈ«(Ö÷ÒªÕë¶ÔÓÒ¶ÔÆä)
'                                Select Case .ColAlignment(lngCol)
'                                    Case 6, 7, 8
'                                        .TextMatrix(lngCount, lngCol) = IIf(lngCol Mod 2 = 1, " ", "") & .TextMatrix(lngCount, lngCol)
'                                    Case 3, 4, 5
'                                        .TextMatrix(lngCount, lngCol) = IIf(lngCol Mod 2 = 1, " ", "") & .TextMatrix(lngCount, lngCol) & IIf(lngCol Mod 2 = 1, " ", "")
'                                    Case 0, 1, 2
'                                        .TextMatrix(lngCount, lngCol) = .TextMatrix(lngCount, lngCol) & IIf(lngCol Mod 2 = 1, " ", "")
'                                    Case Else
'                                        .TextMatrix(lngCount, lngCol) = IIf(lngCol Mod 2 = 1, " ", "") & .TextMatrix(lngCount, lngCol)
'                                End Select
                                .TextMatrix(lngCount, lngCol) = .TextMatrix(lngCount, lngCol) & IIf(lngCol Mod 2 = 1, Chr(13), "")
                            End If
                        Next
                        .MergeRow(lngCount) = True
                    End If
                End If
            End If
        Next
        
        'Èç¹ûÎ´¸³Öµ,È¡×îºóÒ»Ò³
        If (lngRow = 0 And gintPrintState = 1) Then
            mintÒ³Âë = (.Rows - VsfData.FixedRows) \ mlngPageRows + mintµ±Ç°ÆðÊ¼Ò³ - 1
            If (.Rows - VsfData.FixedRows) > mlngPageRows Then
                If (.Rows - VsfData.FixedRows) Mod mlngPageRows <> 0 Then mintÒ³Âë = mintÒ³Âë + 1
            End If
            If mintÒ³Âë < mintµ±Ç°ÆðÊ¼Ò³ Then mintÒ³Âë = mintµ±Ç°ÆðÊ¼Ò³
        End If
        If mintÒ³Âë = 0 Then mintÒ³Âë = 1
                        
        'Èç¹ûÒ³Âë>µ±Ç°ÆðÊ¼Ò³,ËµÃ÷ÆðÊ¼Ò³ÎÞÐ§
        If gintPrintState = 1 Then
            'Èç¹ûµ±Ç°Ò³´óÓÚÆðÊ¼Ò³,É¾³ýÎÞÐ§Ò³Êý¾Ý
            If mintÒ³Âë > mintµ±Ç°ÆðÊ¼Ò³ Then
                For lngRow = 1 To mlngPageRows
                    VsfData.RemoveItem VsfData.FixedRows
                Next
                mintµ±Ç°ÆðÊ¼Ò³ = mintÒ³Âë
                glngPrintRow = glngPrintRow - mlngPageRows
                If glngPrintRow < VsfData.FixedRows Then glngPrintRow = 0
            End If
            'Èç¹ûÆðÊ¼ÐÐ³¬¹ýÒ»Ò³,É¾³ýÎÞÐ§Ò³Êý¾Ý
            If lngRow >= VsfData.FixedRows + mlngPageRows Then
                For lngRow = 1 To mlngPageRows
                    VsfData.RemoveItem VsfData.FixedRows
                Next
                glngPrintRow = glngPrintRow - mlngPageRows
                If glngPrintRow < VsfData.FixedRows Then glngPrintRow = 0
                mintµ±Ç°ÆðÊ¼Ò³ = mintµ±Ç°ÆðÊ¼Ò³ + 1
                mintÒ³Âë = mintÒ³Âë + 1
            End If
            If mint½áÊøÒ³ > mintÒ³Âë And VsfData.Rows - VsfData.FixedRows <= mlngPageRows Then
                mint½áÊøÒ³ = mintÒ³Âë
            End If
        End If
        
        '½«ÈÕÆÚÎª¿ÕµÄÐÐµÄ·¢ÉúÊ±¼äÒ²ÉèÖÃÎª¿Õ(·Ö×éÊý¾Ý)
        If mblnÈÕÆÚÊ±¼äºÏ²¢ Then
            lngRow = VsfData.FixedRows
            Do While True
                If lngRow > VsfData.Rows - 1 Then Exit Do
                If VsfData.TextMatrix(lngRow, mlngDate) = "" Then
                    VsfData.TextMatrix(lngRow, 1) = ""
                    VsfData.TextMatrix(lngRow, 2) = ""
                Else
                    If Val(VsfData.TextMatrix(lngRow, mlngCollectType)) <> 0 Then
                        VsfData.TextMatrix(lngRow, 2) = VsfData.TextMatrix(lngRow, mlngDate)
                    Else
                        VsfData.TextMatrix(lngRow, 1) = Format(VsfData.TextMatrix(lngRow, 1), "yyyy-MM-dd HH:mm")
                        VsfData.TextMatrix(lngRow, 2) = Format(VsfData.TextMatrix(lngRow, 1), "yyyy-MM-dd HH:mm")
                    End If
                End If
                lngRow = lngRow + 1
            Loop
        End If
        
    End With
    Exit Sub
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Sub

Private Sub zlLableBruit()
    Dim lngScaleLeft As Long, lngScaleTop As Long, lngScaleRight As Long, lngScaleBottom As Long
    
    lblSubhead.Top = lblTitle.Top + lblTitle.Height + 120
    lblSubhead.Width = VsfData.Width
    lblSubhead.Caption = lblSubhead.Tag
    VsfData.Move lngScaleLeft + 210, lblSubhead.Top + lblSubhead.Height + 45, ScaleWidth - lngScaleLeft - 210 * 2
    VsfData.Height = picMain.Height - VsfData.Top
End Sub

Private Sub GetFileProperty()
    'ÌáÈ¡ÎÄ¼þÊôÐÔ
    On Error GoTo ErrHand
    
    gstrSQL = " Select   ¿ªÊ¼Ê±¼ä,½áÊøÊ±¼ä,¸ñÊ½ID,¿ÆÊÒID,¹éµµÈË From ²¡ÈË»¤ÀíÎÄ¼þ " & _
              " Where ²¡ÈËID=[1] And Ö÷Ò³ID=[2] And Ó¤¶ù=[3] And ID=[4] And Rownum<2"
    If gblnMoved Then
        gstrSQL = Replace(gstrSQL, "²¡ÈË»¤ÀíÎÄ¼þ", "H²¡ÈË»¤ÀíÎÄ¼þ")
    End If
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "ÌáÈ¡»¤ÀíÎÄ¼þÊý¾Ý", mlng²¡ÈËID, mlngÖ÷Ò³ID, mintÓ¤¶ù, mlngµ±Ç°ÎÄ¼þID)
    If mrsTemp.RecordCount <> 0 Then
        mlng¸ñÊ½ID = mrsTemp!¸ñÊ½ID
        mlng¿ÆÊÒID = mrsTemp!¿ÆÊÒID
        mstr¿ªÊ¼Ê±¼ä = Format(mrsTemp!¿ªÊ¼Ê±¼ä, "yyyy-MM-dd HH:mm:ss")
        mstr½áÊøÊ±¼ä = Format(mrsTemp!½áÊøÊ±¼ä, "yyyy-MM-dd HH:mm:ss")
    End If
    
    RaiseEvent AfterRowColChange("", False, mblnSign, mblnArchive)
    Exit Sub
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Sub

Private Sub InitEnv()
    On Error GoTo ErrHand
    
     '46251,ÁõÅô·É,2012-09-11,×°ÔØÒ³ÂëÊä³öÎ»ÖÃ
    With cboÒ³Âë
        .Clear
        .AddItem "Ò³Ã¼ÉÏ·½": .ItemData(.NewIndex) = 1
        .AddItem "Ò³Ã¼ÏÂ·½": .ItemData(.NewIndex) = 2
        .AddItem "Ò³½ÅÉÏ·½": .ItemData(.NewIndex) = 3
        .AddItem "Ò³½ÅÏÂ·½": .ItemData(.NewIndex) = 4
        cboÒ³Âë.Tag = 3
        Call zlControl.CboSetIndex(cboÒ³Âë.hWnd, 2)
    End With
    
    '´ò¿ªÏÖ´æÔÚµÄËùÓÐ»¤Àí¼ÇÂ¼ÏîÄ¿
    gstrSQL = " Select   ÏîÄ¿ÐòºÅ,upper(ÏîÄ¿Ãû³Æ) AS ÏîÄ¿Ãû³Æ,ÏîÄ¿ÀàÐÍ,ÏîÄ¿ÐÔÖÊ,ÏîÄ¿³¤¶È,ÏîÄ¿Ð¡Êý,ÏîÄ¿±íÊ¾,ÏîÄ¿µ¥Î»,ÏîÄ¿ÖµÓò,»¤ÀíµÈ¼¶,Ó¦ÓÃ·½Ê½" & _
              " From »¤Àí¼ÇÂ¼ÏîÄ¿ B" & _
              " Order by ÏîÄ¿ÐòºÅ"
    Set mrsItems = zlDatabase.OpenSQLRecord(gstrSQL, "´ò¿ªÏÖ´æÔÚµÄËùÓÐ»¤Àí¼ÇÂ¼ÏîÄ¿")
    
    'ÌáÈ¡ÊÊÓÃÓÚ¼ÇÂ¼µ¥µÄÕïÖÎËù¼ûÏîÄ¿
    gstrSQL = _
        " Select i.·ÖÀàid, i.±àÂë, i.ÖÐÎÄÃû, nvl(i.Ìæ»»Óò,0) Ìæ»»Óò,i.ÀàÐÍ,i.³¤¶È,i.Ð¡Êý,i.µ¥Î»,i.±íÊ¾·¨,i.ÊýÖµÓò,i.±ØÌî" & vbNewLine & _
        " From ÕïÖÎËù¼ûÏîÄ¿ i, ÕïÖÎËù¼û·ÖÀà k" & vbNewLine & _
        " Where k.Id = i.·ÖÀàid And ((k.±àÂë In ('02', '05', '06') And i.Ìæ»»Óò = 1) Or (k.ÐÔÖÊ = 2 And k.±àÂë = '06' And NVL(i.Ìæ»»Óò,0) = 0))" & vbNewLine & _
        " Order By k.ÐÔÖÊ, k.±àÂë, i.±àÂë"
    Set mrsElement = zlDatabase.OpenSQLRecord(gstrSQL, "ÌáÈ¡ÊÊÓÃÓÚ¼ÇÂ¼µ¥µÄÕïÖÎËù¼ûÏîÄ¿")
    
    Exit Sub
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Sub

Public Function ShowMe(ByVal frmParent As Form, ByVal lngFileID As Long, ByVal lngPatiID As Long, ByVal lngPageId As Long, ByVal intBaby As Integer, Optional ByVal strPages As String = "") As Boolean
    '******************************************************************************************************************
    '¹¦ÄÜ£º ÏÔÊ¾»¤Àí¼ÇÂ¼ÎÄ¼þÄÚÈÝ
    '²ÎÊý£º frmParent           ÉÏ¼¶´°Ìå¶ÔÏó
    '       lngFileID           ÎÄ¼þID
    '       lngPatiID           ²¡ÈËid
    '       lngPageID           Ö÷Ò³id
    '       intBaby             Ó¤¶ù±êÖ¾
    '       strPage             Îª¿ÕËµÃ÷´ÓµÚÒ»Ò³¿ªÊ¼½øÐÐ´òÓ¡,²»Îª¿Õ¸ñÊ½Îª£ºÒ³Âë;±êÊ¶(Ðø´ò»òÕý³£´òÓ¡),Ò³Âë;±êÊ¶......
    '·µ»Ø£º ÎÞ
    '******************************************************************************************************************
    Dim mrsTemp As New ADODB.Recordset
    Dim i As Long
    Dim arrTemp() As String
    On Error GoTo ErrHand
    Err = 0
    
    mArrPage = Array(): mlngMinIndex = -1: mlngMaxIndex = -1
    mblnInit = False
    mlngµ±Ç°ÎÄ¼þID = lngFileID
    mlng²¡ÈËID = lngPatiID
    mlngÖ÷Ò³ID = lngPageId
    mintÓ¤¶ù = intBaby
    mlngPageRows = frmAsk.mintPageRows
    Set mfrmParent = frmParent
    mintNORule = Val(zlDatabase.GetPara("»¤ÀíÎÄ¼þÒ³Âë¹æÔò", glngSys, 1255, 0))
    mblnSignPic = (Val(zlDatabase.GetPara("¼ÇÂ¼µ¥Ç©ÃûÈËÏÔÊ¾·½Ê½", glngSys, 1255, 0)) = 1)
    '56134:ÁõÅô·É,2012-12-19,¼ÇÂ¼µ¥´òÓ¡Ê±,Êý¾ÝÎ´ÂúÒ³¿Õ°×²¿·ÖÊä³ö±í¸ñ
    mblnPrintRow = (Val(zlDatabase.GetPara("¼ÇÂ¼µ¥Î´ÂúÒ³´òÓ¡±í¸ñ", glngSys, 1255, 0)) = 1)
    '46506:ÁõÅô·É,2012-12-19,¼ÇÂ¼µ¥´òÓ¡Ê±£¬Êý¾ÝÂúÒ³²Å½øÐÐÊä³ö(ÎÄ¼þÎª½áÊøÊ±ÓÐÐ§)
    mblnFullPagePrint = (Val(zlDatabase.GetPara("¼ÇÂ¼µ¥ÂúÒ³´òÓ¡", glngSys, 1255, 0)) = 1)
    '49753:ÁõÅô·É,2012-12-19,¼ÇÂ¼µ¥´òÓ¡Ê±£¬Êý¾ÝÒ³ÆæÅ¼Êä³ö
    mblnOddEvenPagePrint = (Val(zlDatabase.GetPara("¼ÇÂ¼µ¥ÆæÅ¼´òÓ¡", glngSys, 1255, 0)) = 1)
    '--58414,ÁõÅô·É,2013-04-10,Ìí¼Ó»¤Ê¿¡¢Ç©ÃûÁÐÏÔÊ¾Ä£Ê½
    mlngSingerType = Val(zlDatabase.GetPara("»¤Ê¿¡¢Ç©ÃûÁÐÏÔÊ¾Ä£Ê½", glngSys, 1255, "2"))
    If InStr(1, ",0,1,2,3,", "," & mlngSingerType & ",") = 0 Then mlngSingerType = 2
    '64583:ÁõÅô·É,2013-09-22,Ô¤ÀÀ¡¢´òÓ¡Ê±Í¬Ò»Ò³ÏàÍ¬ÈÕÆÚÏÔÊ¾·½Ê½:¶à´Î;Ò»´Î
    mblnDateModel = (Val(zlDatabase.GetPara("¼ÇÂ¼µ¥ÈÕÆÚÏÔÊ¾·½Ê½", glngSys, 1255, 0)) = 1)
    '68739:ÁõÅô·É,2014-1-2,Ìí¼Ó"Ð¡½á±êÊ¶ÑÕÉ«"
    mlngCollectColor = Val(zlDatabase.GetPara("Ð¡½á±êÊ¶ÑÕÉ«", glngSys, 1255, "255"))
    
    arrTemp = Split(zlDatabase.GetPara("Ð¡½áÈ±Ê¡¸ñÊ½", glngSys, 1255), ";")
    If UBound(arrTemp) > 0 Then
        mblnShowNullCollet = arrTemp(1) = 0
    Else
        mblnShowNullCollet = True
    End If
    'ÅÐ¶Ï²¡ÈËÊÇ·ñ×ª³ö
    gstrSQL = "Select Êý¾Ý×ª³ö From ²¡°¸Ö÷Ò³ Where ²¡ÈËID=[1] And Ö÷Ò³ID=[2]"
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "ÅÐ¶ÏÊý¾ÝÊÇ·ñ×ª³ö", mlng²¡ÈËID, mlngÖ÷Ò³ID)
    gblnMoved = NVL(mrsTemp!Êý¾Ý×ª³ö, 0) <> 0
    
    'Èç¹ûÊ±ÅúÁ¿´òÓ¡£¬Ôò½øÐÐÈ«²¿´òÓ¡
    If gblnBatch = False Then
        'ÅÐ¶Ïµ±Ç°ÎÄ¼þÊÇ·ñÒÑ¾­½áÊø
        gstrSQL = " Select  ½áÊøÊ±¼ä From ²¡ÈË»¤ÀíÎÄ¼þ " & _
                  " Where ²¡ÈËID=[1] And Ö÷Ò³ID=[2] And Ó¤¶ù=[3] And ID=[4] And Rownum<2"
        Call SQLDIY(gstrSQL)
        Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "ÌáÈ¡»¤ÀíÎÄ¼þÊý¾Ý", mlng²¡ÈËID, mlngÖ÷Ò³ID, mintÓ¤¶ù, mlngµ±Ç°ÎÄ¼þID)
        If mrsTemp.RecordCount > 0 Then
            'Èç¹ûÎÄ¼þÒÑ¾­½áÊø,²»¹Ü¼ÇÂ¼µ¥ÊÇ·ñÂúÒ³¶¼½øÐÐ´òÓ¡
            If Trim(NVL(mrsTemp!½áÊøÊ±¼ä)) <> "" Then mblnFullPagePrint = False
        End If
    Else
        mblnFullPagePrint = False
        mblnOddEvenPagePrint = False
    End If
    If mblnFullPagePrint = True Then mblnPrintRow = False
    
    If mrsItems.State = 0 Then
        Call InitEnv            '³õÊ¼»¯»·¾³
    End If
    Call InitVariable
    
    mstrMergeID = ""
    gstrSQL = " Select MIN(¿ªÊ¼Ò³ºÅ) AS ¿ªÊ¼Ò³ºÅ,MAX(½áÊøÒ³ºÅ) AS ½áÊøÒ³ºÅ From ²¡ÈË»¤Àí´òÓ¡ Where ÎÄ¼þID=[1]"
    Call SQLDIY(gstrSQL)
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "»ñÈ¡ÎÄ¼þ×îÐ¡ºÍ×î´óÒ³Âë", mlngµ±Ç°ÎÄ¼þID)
    mint½áÊøÒ³ = Val(NVL(mrsTemp!½áÊøÒ³ºÅ, 0))
    mintÒ³Âë = Val(NVL(mrsTemp!¿ªÊ¼Ò³ºÅ, 0))
    If mint½áÊøÒ³ = 0 Then Exit Function
    
    If strPages <> "" Then
        For i = 0 To UBound(Split(strPages, ","))
            If Val(Split(strPages, ",")(i)) >= mintÒ³Âë And Val(Split(strPages, ",")(i)) <= mint½áÊøÒ³ Then
                ReDim Preserve mArrPage(UBound(mArrPage) + 1)
                mArrPage(UBound(mArrPage)) = Split(strPages, ",")(i)
            End If
        Next i
    Else
        For i = mintÒ³Âë To mint½áÊøÒ³
            ReDim Preserve mArrPage(UBound(mArrPage) + 1)
            mArrPage(UBound(mArrPage)) = i & ";2"
        Next i
    End If
   
    'Èç¹ûÊÇÂúÒ³´òÓ¡Ò³£¬²¢ÇÒÑ¡ÔñµÄ´òÓ¡×îºóÒ»Ò³µÈÓÚÎÄ¼þ×îºóÒ³ºÅ£¬Ôò¼ì²éÊÇ·ñÂúÒ³
    If mblnFullPagePrint = True And mint½áÊøÒ³ = Val(mArrPage(UBound(mArrPage))) Then
        gstrSQL = "Select Max(½áÊøÐÐºÅ) ½áÊøÐÐºÅ From ²¡ÈË»¤Àí´òÓ¡ where ÎÄ¼þID=[1] And ½áÊøÒ³ºÅ=[2] "
        Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "»ñÈ¡ÎÄ¼þ×îºóÒ»Ò³µÄ½áÊøÐÐºÅ", mlngµ±Ç°ÎÄ¼þID, mint½áÊøÒ³)
        If mrsTemp!½áÊøÐÐºÅ < mlngPageRows Then
            If UBound(mArrPage) <= 0 Then
                mArrPage = Array()
            Else
                ReDim Preserve mArrPage(UBound(mArrPage) - 1)
            End If
        End If
    End If
    If UBound(mArrPage) < 0 Then
        If gblnBatch = False Then
            MsgBox "Ã»ÓÐÂú×ãÌõ¼þ»ò¿É´òÓ¡µÄ»¤Àí¼ÇÂ¼µ¥Êý¾Ý£¡", vbInformation, gstrSysName
        End If
        Exit Function
    End If
    
    'ÆæÅ¼´òÓ¡Ê±Ðè¼ì²éÒ³ÂëÊÇ·ñÁ¬Ðø£¬²»Á¬ÐøÔò²»½øÐÐÆæÅ¼´òÓ¡
    If mblnOddEvenPagePrint = True Then
        mintÒ³Âë = Val(mArrPage(0)) - 1
        For i = 0 To UBound(mArrPage)
            If mintÒ³Âë + 1 <> Val(mArrPage(i)) Then
                mblnOddEvenPagePrint = False
                Exit For
            End If
            mintÒ³Âë = Val(mArrPage(i))
        Next i
    End If
    
    mlngMinIndex = 0: mlngMaxIndex = UBound(mArrPage)
    mintÒ³Âë = Val(mArrPage(mlngMinIndex))
    mint½áÊøÒ³ = Val(mArrPage(UBound(mArrPage)))
    
    mstrMergeID = ""
    'ÌáÈ¡ºÏ²¢ÎÄ¼þÐÅÏ¢
    gstrSQL = _
        "Select Id From (With ²¡ÈË»¤ÀíÎÄ¼þ_F1 As" & vbNewLine & _
        " (Select a.Id, a.Ðø´òid From ²¡ÈË»¤ÀíÎÄ¼þ a Where a.²¡ÈËid = [1] And a.Ö÷Ò³id = [2] And Nvl(a.Ó¤¶ù, 0) = [3])" & vbNewLine & _
        "Select Id From ²¡ÈË»¤ÀíÎÄ¼þ_F1 Start With Ðø´òid = [4] Connect By Prior Id = Ðø´òid Order By Level Desc)"
    Call SQLDIY(gstrSQL)
    Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "¼ì²éµ±Ç°ÎÄ¼þÊÇ·ñÓëÆäËüÎÄ¼þÉèÖÃÎªºÏ²¢´òÓ¡", mlng²¡ÈËID, mlngÖ÷Ò³ID, mintÓ¤¶ù, mlngµ±Ç°ÎÄ¼þID)
    Do While Not mrsTemp.EOF
        mstrMergeID = mstrMergeID & "," & mrsTemp!ID
    mrsTemp.MoveNext
    Loop
    mstrMergeID = Mid(mstrMergeID, 2)
    Call ShowPage
    mblnInit = True
    mblnEditable = False
    ShowMe = True
'    Call OutputRsData(mrsSelItems)
    Exit Function
    
ErrHand:
    If ErrCenter() = 1 Then
        Resume
    End If
End Function

Private Function LoadPageData() As Boolean
    Dim strÌõ¼þ As String, lng½áÊøÒ³ As Long, lngFileID As Long
    Dim blnInitRec As Boolean
    Dim arrCode, i As Integer
    On Error GoTo ErrHand
    
    mintµ±Ç°ÆðÊ¼Ò³ = mintÒ³Âë
    Set mrsDataMap = New ADODB.Recordset
    lngFileID = mlngµ±Ç°ÎÄ¼þID
    'ºÏ²¢ÎÄ¼þ´¦Àí
    blnInitRec = False
    arrCode = Split(mstrMergeID, ",")
    If UBound(arrCode) >= 0 And mintÒ³Âë = Val(mArrPage(0)) Then
        For i = 0 To UBound(arrCode)
            gstrSQL = "Select MAX(½áÊøÒ³ºÅ) ½áÊøÒ³ From ²¡ÈË»¤Àí´òÓ¡ Where ÎÄ¼þID=[1]"
            Call SQLDIY(gstrSQL)
            Set mrsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "ÌáÈ¡ºÏ²¢ÎÄ¼þ×î´ó½áÊøÒ³ºÅ", Val(arrCode(i)))
            lng½áÊøÒ³ = NVL(mrsTemp!½áÊøÒ³, 0)
            If lng½áÊøÒ³ = mintÒ³Âë Then
                mlngµ±Ç°ÎÄ¼þID = Val(arrCode(i))
                Call ReadStruDef
                If Not blnInitRec Then
                    Call InitRecords
                    blnInitRec = True
                End If
                strÌõ¼þ = " And P.½áÊøÒ³ºÅ=[5]"
                Call zlRefresh(strÌõ¼þ)
            End If
        Next i
    End If
    mlngµ±Ç°ÎÄ¼þID = lngFileID
    'Òª´òÓ¡µÄÎÄ¼þ´¦Àí
    Call ReadStruDef
    If Not blnInitRec Then
        Call InitRecords
        blnInitRec = True
    End If
    strÌõ¼þ = " AND (P.¿ªÊ¼Ò³ºÅ=[5] OR (P.½áÊøÒ³ºÅ=[5])) "
    Call zlRefresh(strÌõ¼þ)
    Call PreTendFormat
    LoadPageData = True
    Exit Function
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
End Function

Private Sub lblTitle_Click()
    Call NextPage
'    Call PrevPage
End Sub

Private Sub UserControl_Resize()
    On Error Resume Next
    
    With picMain
        .Top = 0
        .Left = 0
        .Width = ScaleWidth
        .Height = ScaleHeight
    End With
    
    Call zlLableBruit
End Sub

Private Sub vsfData_DrawCell(ByVal hDC As Long, ByVal ROW As Long, ByVal COL As Long, ByVal Left As Long, ByVal Top As Long, ByVal Right As Long, ByVal Bottom As Long, Done As Boolean)
    Call DrawCell(hDC, ROW, COL, Left, Top, Right, Bottom, Done)
End Sub

Private Sub InitVariable()
    'Á¬ÐøÖØ´ò³£Á¿
    mlngDate = -1
    mlngTime = -1
    mlngOperator = -1
    mlngSigner = -1
    mlngSignTime = -1
    mlngSignName = -1
    mlngFileID = -1
    mlngRecord = -1
    mlngNoEditor = -1
    mlngPrintedEndPage = -1
    mlngCollectValue = -1
    
    mblnShow = False
    mblnSign = False
    mblnArchive = False
    mblnEditAssistant = False
    
    Set mrsDataMap = New ADODB.Recordset
End Sub

Private Function GetStartRow(ByVal lngRow As Long) As Long
    Dim lngStart As Long
    Dim lngCurRows As Long, lngRows As Long
    'ÌáÈ¡Êý¾ÝÆðÊ¼ÐÐ,³¬³ö±¾Ò³Ôò·µ»Ø0
    'Èç¹û±¾Ò³Î´ÏÔÊ¾È«,ÔòËµÃ÷³¬³ö±¾Ò³,Ò²·µ»Ø0
    '²»ÔÊÐíÔÚÁ¬ÐøµÄÊý¾ÝÐÐÖÐ²åÈëÐÂÐÐ
    
    If VsfData.TextMatrix(lngRow, mlngRowCount) = "" Then VsfData.TextMatrix(lngRow, mlngRowCount) = "1|1"
    lngRows = Val(Split(VsfData.TextMatrix(lngRow, mlngRowCount), "|")(0))    '×ÜÐÐÊý
    lngCurRows = Val(Split(VsfData.TextMatrix(lngRow, mlngRowCount), "|")(1)) 'µ±Ç°ÐÐ
    If lngCurRows = 1 Then
        GetStartRow = lngRow
        Exit Function
    End If
    
    'Ñ°ÕÒÆðÊ¼ÐÐ
    For lngRow = lngRow To 3 Step -1
        If FormatValue(VsfData.TextMatrix(lngRow, mlngRowCount)) = lngRows & "|1" Then
            lngStart = lngRow
            Exit For
        End If
    Next
    
    GetStartRow = lngStart
End Function

Public Function GetDiagonal() As String
    GetDiagonal = "," & mstrCatercorner & "," '& mstrCOLNothing & ","
End Function

Private Function IsDiagonal(ByVal intCol As Integer) As Boolean
    Dim arrCol, arrData
    Dim intDo As Integer, intCount As Integer
    'ÅÐ¶ÏÖ¸¶¨ÁÐÊÇ·ñÉèÖÃÁËÁÐ¶Ô½ÇÏß£¨mstrColWidthµÄ¸ñÊ½£º765`11`1`1,765`11`2`1,...£¬¶ÔÏóÊôÐÔ`¶ÔÏóÐòºÅ`ÁÐ¶Ô½ÇÏß£©
    
    IsDiagonal = (InStr(1, "," & mstrCatercorner & "," & mstrCOLNothing & ",", "," & intCol - (cHideCols + VsfData.FixedCols - 1) & ",") <> 0)
End Function


'######################################################################################################################
'**********************************************************************************************************************
'ÒÔÏÂÊÇ»ù´¡º¯Êý»ò¹ý³Ì

Private Sub picMain_Resize()
    On Error Resume Next
    picMain.Left = 0
    
    lblTitle.Left = 0
    lblTitle.Width = picMain.Width
    
    VsfData.Width = picMain.Width - VsfData.Left * 2
    VsfData.Height = picMain.Height - VsfData.Top
End Sub

Private Sub UserControl_GotFocus()
    On Error Resume Next
    VsfData.SetFocus
End Sub

Private Sub UserControl_Initialize()
    mblnShow = False
    mblnInit = False
    
'    Set objStream = objFileSys.OpenTextFile("C:\WORKLOG.txt", ForAppending, True)
End Sub

Private Sub UserControl_Terminate()
'    objStream.Close
    If Not mrsTemp Is Nothing Then
        If mrsTemp.State = adStateOpen Then mrsTemp.Close
        Set mrsTemp = Nothing
    End If
    If Not mrsItems Is Nothing Then
        If mrsItems.State = adStateOpen Then mrsItems.Close
        Set mrsItems = Nothing
    End If
    If Not mrsElement Is Nothing Then
        If mrsElement.State = adStateOpen Then mrsElement.Close
        Set mrsElement = Nothing
    End If
    If Not mrsSelItems Is Nothing Then
        If mrsSelItems.State = adStateOpen Then mrsSelItems.Close
        Set mrsSelItems = Nothing
    End If
    If Not mrsDataMap Is Nothing Then
        If mrsDataMap.State = adStateOpen Then mrsDataMap.Close
        Set mrsDataMap = Nothing
    End If
    If Not mfrmParent Is Nothing Then Set mfrmParent = Nothing
    If Not mobjTagFont Is Nothing Then Set mobjTagFont = Nothing
End Sub

Private Function ReDimArray(ByRef strArray() As String) As Long
    '----------------------------------------------------------------------
    '¹¦ÄÜ£ºÖØÐÂ¶¨ÒåÊý×é
    '----------------------------------------------------------------------
    Dim lngCount As Long
    Dim strTmp As String
    
    On Error GoTo InitHand
    
    strTmp = strArray(1)
    
    lngCount = UBound(strArray) + 1
    
    GoTo OkHand
    
InitHand:
    
    lngCount = 1
    
OkHand:
    
    ReDim Preserve strArray(1 To lngCount)
            
    ReDimArray = lngCount
End Function

Private Sub SingerShowType(ByVal vsfObj As VSFlexGrid, ByVal lngStartRow As Long, ByVal lngEndRow As Long)
'-------------------------------------------------
'¹¦ÄÜ£º»¤Ê¿Ç©ÃûÈËÏÔÊ¾·½Ê½
''--58414,ÁõÅô·É,2013-04-10,Ìí¼Ó»¤Ê¿¡¢Ç©ÃûÁÐÏÔÊ¾Ä£Ê½
'-------------------------------------------------
    Dim lngRow As Integer
    
    Select Case mlngSingerType
        Case 0 'ËùÓÐÐÐÏÔÊ¾
            For lngRow = lngStartRow To lngEndRow
                If mlngOperator > 0 Then vsfObj.TextMatrix(lngRow, mlngOperator) = vsfObj.TextMatrix(lngStartRow, mlngOperator)
                If mlngSignName > 0 Then vsfObj.TextMatrix(lngRow, mlngSignName) = vsfObj.TextMatrix(lngStartRow, mlngSignName)
                If mlngSignTime > 0 Then vsfObj.TextMatrix(lngRow, mlngSignTime) = vsfObj.TextMatrix(lngStartRow, mlngSignTime)
            Next
        Case 1 'Ê×ÐÐÏÔÊ¾
            For lngRow = lngStartRow To lngEndRow
                If lngRow = lngStartRow Then
                    If mlngOperator > 0 Then vsfObj.TextMatrix(lngRow, mlngOperator) = vsfObj.TextMatrix(lngStartRow, mlngOperator)
                    If mlngSignName > 0 Then vsfObj.TextMatrix(lngRow, mlngSignName) = vsfObj.TextMatrix(lngStartRow, mlngSignName)
                    If mlngSignTime > 0 Then vsfObj.TextMatrix(lngRow, mlngSignTime) = vsfObj.TextMatrix(lngStartRow, mlngSignTime)
                Else
                    If mlngOperator > 0 Then vsfObj.TextMatrix(lngRow, mlngOperator) = ""
                    If mlngSignName > 0 Then vsfObj.TextMatrix(lngRow, mlngSignName) = ""
                    If mlngSignTime > 0 Then vsfObj.TextMatrix(lngRow, mlngSignTime) = ""
                End If
            Next
        Case 3 'Î²ÐÐÏÔÊ¾
            If mlngOperator > 0 Then
                If vsfObj.TextMatrix(lngStartRow, mlngOperator) = "" Then vsfObj.TextMatrix(lngStartRow, mlngOperator) = vsfObj.TextMatrix(lngEndRow, mlngOperator)
            End If
            If mlngSignName > 0 Then
                If vsfObj.TextMatrix(lngStartRow, mlngSignName) = "" Then vsfObj.TextMatrix(lngStartRow, mlngSignName) = vsfObj.TextMatrix(lngEndRow, mlngSignName)
            End If
            If mlngSignTime > 0 Then
                If vsfObj.TextMatrix(lngStartRow, mlngSignTime) = "" Then vsfObj.TextMatrix(lngStartRow, mlngSignTime) = vsfObj.TextMatrix(lngEndRow, mlngSignTime)
            End If
            For lngRow = lngEndRow To lngStartRow Step -1
                If lngRow = lngEndRow Then
                    If mlngOperator > 0 Then vsfObj.TextMatrix(lngRow, mlngOperator) = vsfObj.TextMatrix(lngStartRow, mlngOperator)
                    If mlngSignName > 0 Then vsfObj.TextMatrix(lngRow, mlngSignName) = vsfObj.TextMatrix(lngStartRow, mlngSignName)
                    If mlngSignTime > 0 Then vsfObj.TextMatrix(lngRow, mlngSignTime) = vsfObj.TextMatrix(lngStartRow, mlngSignTime)
                Else
                    If mlngOperator > 0 Then vsfObj.TextMatrix(lngRow, mlngOperator) = ""
                    If mlngSignName > 0 Then vsfObj.TextMatrix(lngRow, mlngSignName) = ""
                    If mlngSignTime > 0 Then vsfObj.TextMatrix(lngRow, mlngSignTime) = ""
                End If
            Next
        Case Else 'Ê×Î²ÏÔÊ¾
            '×îºóÒ»ÐÐÐèÒªÌîÐ´·â±ÕÇ©Ãû
            For lngRow = lngStartRow To lngEndRow
                If lngRow = lngStartRow Or lngRow = lngEndRow Then
                    If mlngOperator > 0 Then vsfObj.TextMatrix(lngRow, mlngOperator) = vsfObj.TextMatrix(lngStartRow, mlngOperator)
                    If mlngSignName > 0 Then vsfObj.TextMatrix(lngRow, mlngSignName) = vsfObj.TextMatrix(lngStartRow, mlngSignName)
                    If mlngSignTime > 0 Then vsfObj.TextMatrix(lngRow, mlngSignTime) = vsfObj.TextMatrix(lngStartRow, mlngSignTime)
                Else
                    If mlngOperator > 0 Then vsfObj.TextMatrix(lngRow, mlngOperator) = ""
                    If mlngSignName > 0 Then vsfObj.TextMatrix(lngRow, mlngSignName) = ""
                    If mlngSignTime > 0 Then vsfObj.TextMatrix(lngRow, mlngSignTime) = ""
                End If
            Next
    End Select
End Sub

