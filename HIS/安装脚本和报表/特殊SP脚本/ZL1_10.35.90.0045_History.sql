----------------------------------------------------------------------------------------------------------------
--本脚本支持从ZLHIS+ v10.35.90升级到 v10.35.90
--请以数据空间的所有者登录PLSQL并执行下列脚本
Define n_System=100;
----------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------
--结构修正部份
------------------------------------------------------------------------------


------------------------------------------------------------------------------
--数据修正部份
------------------------------------------------------------------------------
--136517:冉俊明,2019-01-08,92802问题升级错误的数据再升级
Declare
  --92802问题升级前的历史数据 交易序号都为-1
  --病人卡结算记录.应收金额 与 病人预交记录.冲预交 正负相同则表示需要升级
  --已升级正确的数据该查询不会有记录，所以不需要标记是否已升级
  Cursor c_结算数据 Is
    Select a.Rowid
    From 病人卡结算记录 A, 病人预交记录 B
    Where a.结算id = b.Id And a.记录性质 = 4 And a.交易序号 = -1 And Sign(a.应收金额) = Sign(b.冲预交);

  c_Rowid      t_Strlist := t_Strlist();
  n_Array_Size Number := 10000; --每批一万,多了可能PGA不够
  I            Number(8) := 0; --每修正10万条记录提交一次,多了可能Undo不够,少了提交过于频繁
  J            Number(16) := 0;
Begin
  Open c_结算数据();
  Loop
    Fetch c_结算数据 Bulk Collect
      Into c_Rowid Limit n_Array_Size;
    Exit When c_Rowid.Count = 0;
  
    Forall K In 1 .. c_Rowid.Count
      Update 病人卡结算记录 Set 应收金额 = -1 * 应收金额, 实收金额 = -1 * 实收金额 Where Rowid = c_Rowid(K);
  
    J := J + c_Rowid.Count;
    If I = 10 Then
      Commit;
      I := 0;
    Else
      I := I + 1;
    End If;
  End Loop;
  Close c_结算数据;
  Commit;
End;
/


-------------------------------------------------------------------------------
--权限修正部份
-------------------------------------------------------------------------------


-------------------------------------------------------------------------------
--报表修正部份
-------------------------------------------------------------------------------


-------------------------------------------------------------------------------
--过程修正部份
-------------------------------------------------------------------------------


------------------------------------------------------------------------------------
--系统版本号
Commit;
