
--分类目录
--1.公共基础,2.医保基础,3.病人病案基础,4.费用基础,5.药品卫材基础
--6.临床基础,7.临床路径基础,8.病历基础,9.护理基础,10.检验基础
--11.检查基础,12.医保业务,13.病人病案业务,14.费用业务,15.药品卫材业务
--16.临床医嘱,17.临床路径,18.病历业务,19.护理业务,20.检验业务,21.检查业务
----------------------------------------------------------------------------
--[[1.公共基础]]
----------------------------------------------------------------------------
Create Or Replace Procedure Zl_Third_Getperson
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取人员信息
  --入参:Xml_In:
  --<IN>
  --  <ID></ID>              //人员ID,精确匹配，为NULL则不进行匹配查询
  --  <NAME></NAME>          //人员姓名名称,精确匹配，为NULL则不进行匹配查询
  --  <CODE></CODE>          //人员编码,精确匹配，为NULL则不进行匹配查询
  --  <KEY></KEY>          //模糊查询关键字，简码、名称、编码，简码为拼音简码，编码左匹配，名称与简码全匹配。为NULL则不进行匹配查询。
  --  <STANDING></STANDING> //人员性质，多个性质以逗号分隔。如：医生,护士。
  --  <BMID></BMID>         //人员所属部门ID
  --  <BMATTRIBUTE></BMATTRIBUTE>//人员所属部门属性，多个部分性质以逗号分隔。临床,药房
  --  <BMSERVFOR></BMSERVFOR>    //人员所属部门服务对象。Null -所有。0-（不包含1-门诊,2-住院,3-门诊和住院），1-门诊（包含3）,2-住院（包含3）,3-门诊和住院
  --  <SORT></SORT>      //排序字段，为NULL ,则缺省排序字段为ID。Id,编号,姓名,简码,身份证号,出生日期,性别,民族,工作日期,办公室电话,电子邮件,执业类别,执业范围,管理职务,
  --                    //专业技术职务,聘任技术职务,学历,站点,执业证号,资格证书号,执业开始日期,处方权标志,手术等级,移动电话,门诊特殊医嘱权限,住院特殊医嘱权限,人员性质
  --  <PAGENOW></PAGENOW>  //当前页数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --  <PAGESIZE></PAGESIZE>  //记录条数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <RYLIST>
  --    <ITEM jsonArray=”true”>
  --      <ID></ID>  --ID
  --      <XM></XM>  --姓名
  --      <BH></BH>  --编号
  --      <JM></JM>  --简码
  --      <XB></XB>  --性别
  --      <CSRQ></CSRQ> --出生日期
  --      <SFZH></SFZH> --身份证号
  --      <MZ></MZ>  --民族
  --      <XL></XL>  --学历
  --      <ZYJSZW></ZYJSZW> --专业技术职务
  --      <XZ></XZ>  --人员性质，字符串“医生,护士,其他”
  --      <WD></WD>  --工作日期
  --      <TEL></TEL>  --办公室电话
  --      <ML></ML>  --电子邮件
  --      <ZYLB></ZYLB>  --执业类别
  --      <PA></PA>  --执业范围
  --      <MP></MP>  --管理职务
  --      <EP></EP>  --聘任技术职务
  --      <PCN></PCN>  --执业证号
  --      <CN></CN>  --资格证书号
  --      <PBD></PBD>  --执业开始日期
  --      <PRS></PRS>  --处方权标志
  --      <OL></OL>  --手术等级
  --      <PH></PH>  --移动电话
  --      <OSAP></OSAP>  --门诊特殊医嘱权限
  --      <ISAP></ISAP>  --住院特殊医嘱权限
  --      <ZD></ZD>    --站点
  --      <BMLIST>  --所属部门列表
  --        <ITEM jsonArray=”true”>
  --          <ID></ID> --部门ID
  --          <MC></MC> --部门名称
  --        </ITEM>
  --      </BMLIST>
  --    </ITEM>
  --  <RYLIST>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------

  v_Sql       Varchar2(4000);
  v_Peoplesql Varchar2(4000);
  v_Deptsql   Varchar2(4000);
  n_Id        人员表.Id %Type;
  v_Name      人员表.编号 %Type;
  v_Code      人员表.姓名 %Type;
  v_Key       Varchar2(100);
  v_Standing  Varchar2(100);
  n_部门id    部门表.Id%Type;
  v_部门性质  Varchar2(100);
  n_Serv      Number(1);
  v_Sort      Varchar2(500);
  n_Cur_Page  Number(5);
  n_Pagesize  Number(5);
  v_Xmlfileds Varchar2(1000);
  v_Fileds    Varchar2(1000);
  x_Templet   Xmltype; --模板XML
Begin
  --获取入参
  Select Nvl(Max(b.Manid), 0), Max(b.Na), Max(b.Code), Max(b.Key), Max(b.Standing), Nvl(Max(b.Bmid), 0),
         Max(b.Bmattribute), Max(b.Bmservfor), Max(b.Sortkey), Nvl(Max(b.Pagenow), 0), Nvl(Max(b.Pagesize), 0)
  Into n_Id, v_Name, v_Code, v_Key, v_Standing, n_部门id, v_部门性质, n_Serv, v_Sort, n_Cur_Page, n_Pagesize
  From Xmltable('$a/IN' Passing Xml_In As "a" Columns Manid Number(18) Path 'ID', Na Varchar2(100) Path 'NAME',
                 Code Varchar2(10) Path 'CODE', Key Varchar2(100) Path 'KEY', Standing Varchar2(100) Path 'STANDING',
                 Bmid Number(18) Path 'BMID', Bmattribute Varchar2(100) Path 'BMATTRIBUTE',
                 Bmservfor Number(1) Path 'BMSERVFOR', Sortkey Varchar2(500) Path 'SORT', Pagenow Number(5) Path 'PAGENOW',
                 Pagesize Number(5) Path 'PAGESIZE') B;

  v_Xmlfileds := 'X.Id As "ID", X.姓名 As "XM", X.编号 As "BH",X.简码 As "JM", X.性别 As "XB",X.出生日期 As "CSRQ",X.身份证号 As "SFZH", X.民族 As "MZ", X.学历 As "XL",' ||
                 Chr(10) ||
                 'X.专业技术职务 As "ZYJSZW", X.人员性质 As "XZ",X.工作日期 As "WD",X.办公室电话 As "TEL",X.电子邮件 As "ML",X.执业类别 As "ZYLB",' ||
                 Chr(10) ||
                 'X.执业范围 As "PA",X.管理职务 As "MP",X.聘任技术职务 As "EP",X.执业证号 As "PCN",X.资格证书号 As "CN",X.执业开始日期 As "PBD",X.处方权标志 As "PRS",' ||
                 Chr(10) ||
                 'X.手术等级 As "OL",X.移动电话 As "PH",X.门诊特殊医嘱权限 As "OSAP",X.住院特殊医嘱权限 As "ISAP",X.站点 As "ZD",X.部门 As "BMLIST"';

  v_Fileds    := 'X.Id,X.编号,X.姓名,X.简码,X.身份证号,X.出生日期,X.性别,X.民族,X.工作日期,X.办公室电话,X.电子邮件,X.执业类别,X.执业范围,X.管理职务,X.专业技术职务,X.聘任技术职务,X.学历,X.站点,X.执业证号,X.资格证书号,X.执业开始日期,X.处方权标志,X.手术等级,X.移动电话,X.门诊特殊医嘱权限,X.住院特殊医嘱权限,X.人员性质';
  v_Peoplesql := 'Select a.Id, a.编号, a.姓名, a.简码, a.身份证号, a.出生日期, a.性别, a.民族, a.工作日期, a.办公室电话, a.电子邮件, a.执业类别, a.执业范围, a.管理职务, a.专业技术职务,' ||
                 Chr(10) ||
                 '       a.聘任技术职务, a.学历, a.站点, a.执业证号, a.资格证书号, A. 执业开始日期, a.处方权标志, a.手术等级, a.移动电话, a.门诊特殊医嘱权限, a.住院特殊医嘱权限, b.人员性质,D.ID 部门ID,D.名称 部门名称' ||
                 Chr(10) || 'From 人员表 A,' || Chr(10) ||
                 '     (Select B1.人员id, f_List2str(Cast(Collect(B1.人员性质) As t_Strlist)) 人员性质' || Chr(10) ||
                 '       From 人员性质说明 B1' || Chr(10) || '       Group By B1.人员id) B,部门人员 C, 部门表 D';
  --存在部门限制
  If v_部门性质 Is Not Null Or n_Serv Is Not Null Then
    --增加部门工作性质条件
    If v_部门性质 Is Not Null Then
      v_部门性质 := ',' || v_部门性质 || ',';
      v_Deptsql  := 'Select Distinct G.部门id From 部门性质说明 G Where Instr(:1, '','' || G.工作性质 || '','') > 0';
    End If;
    --增加服务对象条件
    If n_Serv Is Not Null Then
      --部门工作性质占位
      If v_Deptsql Is Null Then
        v_Deptsql := 'Select Distinct G.部门id From 部门性质说明 G Where :1 Is Null';
      End If;
      If n_Serv <> 3 And n_Serv <> 0 Then
        v_Deptsql := v_Deptsql || ' And (G.服务对象=:2 Or G.服务对象=3)';
      Else
        v_Deptsql := v_Deptsql || ' And G.服务对象=:2';
      End If;
    Elsif v_Deptsql Is Not Null Then
      --服务对象参数占位
      v_Deptsql := v_Deptsql || ' And :2 Is Null';
    End If;
  End If;
  --部门ID判断
  If n_部门id <> 0 And v_Deptsql Is Not Null Then
    v_Deptsql := v_Deptsql || ' And G.部门id =:3';
  Elsif v_Deptsql Is Not Null Then
    v_Deptsql := v_Deptsql || ' And :3 =0';
  End If;
  --单独部门ID条件
  If n_部门id <> 0 And v_Deptsql Is Null Then
    v_Deptsql := 'Select Distinct h.人员id From 部门人员 H Where :1 Is Null And :2 Is Null And  h.部门id = :3';
    --有其他部门条件
  Elsif v_Deptsql Is Not Null Then
    v_Deptsql := 'Select Distinct h.人员id From 部门人员 H Where h.部门id In(' || v_Deptsql || ')';
  End If;

  If v_Deptsql Is Not Null Then
    v_Peoplesql := v_Peoplesql || ',(' || v_Deptsql || ')E ' || Chr(10) ||
                   'Where a.Id = b.人员id(+) And A.ID=C.人员id And C.部门id=D.ID And A.ID=E.人员id And (a.撤档时间 Is Null Or a.撤档时间 = To_Date(''3000-01-01'', ''YYYY-MM-DD''))';
  Else
    v_Peoplesql := v_Peoplesql || Chr(10) ||
                   'Where a.Id = b.人员id(+) And A.ID=C.人员id And C.部门id=D.ID And (a.撤档时间 Is Null Or a.撤档时间 = To_Date(''3000-01-01'', ''YYYY-MM-DD'')) And :1 Is Null And :2 Is Null And :3=0';
  End If;
  --增加ID选项
  If n_Id <> 0 Then
    v_Peoplesql := v_Peoplesql || ' And a.ID=:4';
  Else
    v_Peoplesql := v_Peoplesql || ' And :4=0';
  End If;
  --增加名称条件
  If v_Name Is Not Null Then
    v_Peoplesql := v_Peoplesql || ' And a.姓名=:5';
  Else
    v_Peoplesql := v_Peoplesql || ' And :5 Is Null';
  End If;
  --增加编码条件
  If v_Code Is Not Null Then
    v_Peoplesql := v_Peoplesql || ' And a.编号=:6';
  Else
    v_Peoplesql := v_Peoplesql || ' And :6 Is Null';
  End If;

  --增加模糊匹配限制
  If v_Key Is Not Null Then
    v_Peoplesql := v_Peoplesql || ' And (a.编号 Like :7 Or A.姓名 Like :8 Or A.简码 Like :9)';
  Else
    v_Peoplesql := v_Peoplesql || ' And (:7 Is Not Null Or :8 Is Not Null Or :9 Is Not Null)';
  End If;
  --按人员性质查询
  If v_Standing Is Not Null Then
    v_Standing  := ',' || v_Standing || ',';
    v_Peoplesql := v_Peoplesql ||
                   ' And Exists (Select 1 From 人员性质说明 F Where F.人员id=A.ID And Instr( :10, '','' || F.人员性质 || '','') > 0)';
  Else
    v_Peoplesql := v_Peoplesql || ' And :10 Is Null';
  End If;
  --处理部门子节点
  v_Sql    := 'Select ' || Replace(v_Fileds, 'X.', 'J.') ||
              ',Xmlagg(Xmlelement("ITEM", Xmlattributes(''True'' As "jsonArray"),Xmlforest(J.部门id As "ID", J.部门名称 As "MC"))) 部门 From (' ||
              v_Peoplesql || ') J Group By ' || Replace(v_Fileds, 'X.', 'J.');
  v_Fileds := v_Fileds || ',X.部门';
  --排序字段
  v_Sort := Nvl(v_Sort, 'ID');
  v_Sql  := 'Select Rownum Rn, ' || Replace(v_Fileds, 'X.', 'L.') || Chr(10) || 'From (Select ' ||
            Replace(v_Fileds, 'X.', 'K.') || Chr(10) || '       From (' || v_Sql || ') K' || Chr(10) ||
            '       Order By ' || Replace(v_Sort, 'X.', 'K.') || ') L';

  --分页查询
  v_Sql := 'Select Xmlelement("OUTPUT",Xmlelement("RYLIST",Xmlagg(Xmlelement("ITEM", Xmlattributes(''true'' As "jsonArray"), Xmlforest(' ||
           Replace(v_Xmlfileds, 'X.', 'M.') || ')))))' || Chr(10) || '       From (' || v_Sql || ') M ';
  If n_Cur_Page > 0 And n_Pagesize > 0 Then
    v_Sql := v_Sql || '  Where M.Rn Between :11 And :12';
  Else
    --可能有其一不为0
    n_Cur_Page := 0;
    n_Pagesize := 0;
    --开始从1开始
    v_Sql := v_Sql || '  Where :11=1 And :12=0';
  End If;
  Execute Immediate v_Sql
    Into x_Templet
    Using v_部门性质, n_Serv, n_部门id, n_Id, v_Name, v_Code, v_Key || '%', v_Key || '%', '%' || v_Key || '%', v_Standing, n_Pagesize * (n_Cur_Page - 1) + 1, n_Pagesize * n_Cur_Page;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getperson;
/
Create Or Replace Procedure Zl_Third_Getdept
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取部门信息
  --入参:Xml_In:
  --<IN>
  --  <BMID></BMID>         //部门ID，为NULL则不进行匹配查询
  --  <NAME></NAME>          //部门名称,精确匹配，为NULL则不进行匹配查询
  --  <CODE></CODE>          //部门编码,精确匹配，为NULL则不进行匹配查询
  --  <KEY></KEY>          //模糊查询关键字，简码、名称、编码，简码为拼音简码，编码左匹配，名称与简码全匹配。为NULL则不进行匹配查询。
  --  <BMATTRIBUTE></BMATTRIBUTE>//部门属性，多个部分性质以逗号分隔。临床,药房
  --  <BMSERVFOR></BMSERVFOR>    //部门服务对象。Null -所有。0-（不包含1-门诊,2-住院,3-门诊和住院），1-门诊（包含3）,2-住院（包含3）,3-门诊和住院
  --  <EXCLUDEEMPTY></EXCLUDEEMPTY>//是否排除没有人员的空部门，0，null-所有部门，1-不包含没有人员的空部门。
  --  <SORT></SORT>      //排序字段，为NULL ,则缺省排序字段为ID。Id,上级id,编码,名称,简码,站点,末级,部门负责人,工作性质
  --  <PAGENOW></PAGENOW>  //当前页数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --  <PAGESIZE></PAGESIZE>  //记录条数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <BMLIST>
  --    <ITEM jsonArray=”true”>
  --      <ID></ID>  --ID
  --      <PID></PID>  --上级id
  --      <MC></MC>  --名称
  --      <BH></BH>  --编码
  --      <JM></JM>  --简码
  --      <ZD></ZD>  --站点
  --      <LS></LS>  --末级
  --      <DH></DH>  --部门负责人
  --      <XZ></XZ>  --性质，多个性质用“,”号分隔
  --    </ITEM>
  --  <BMLIST>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Sql       Varchar2(4000);
  v_Where     Varchar2(4000);
  v_Deptsql   Varchar2(4000);
  n_Id        部门表.Id %Type;
  v_Name      部门表.名称 %Type;
  v_Code      部门表.编码 %Type;
  v_Key       Varchar2(100);
  v_部门性质  Varchar2(100);
  n_Serv      Number(1);
  n_Exclude   Number(1);
  v_Sort      Varchar2(500);
  n_Cur_Page  Number(5);
  n_Pagesize  Number(5);
  v_Xmlfileds Varchar2(1000);
  v_Fileds    Varchar2(1000);
  x_Templet   Xmltype; --模板XML
Begin
  --获取入参
  Select Nvl(Max(b.Bmid), 0), Max(b.Na), Max(b.Code), Max(b.Key), Max(b.Bmattribute), Max(b.Bmservfor),
         Nvl(Max(b.Exclude), 0), Max(b.Sortkey), Nvl(Max(b.Pagenow), 0), Nvl(Max(b.Pagesize), 0)
  Into n_Id, v_Name, v_Code, v_Key, v_部门性质, n_Serv, n_Exclude, v_Sort, n_Cur_Page, n_Pagesize
  From Xmltable('$a/IN' Passing Xml_In As "a" Columns Bmid Number(18) Path 'BMID', Na Varchar2(100) Path 'NAME',
                 Code Varchar2(20) Path 'CODE', Key Varchar2(100) Path 'KEY', Bmattribute Varchar2(100) Path 'BMATTRIBUTE',
                 Bmservfor Number(1) Path 'BMSERVFOR', Exclude Number(1) Path 'EXCLUDEEMPTY',
                 Sortkey Varchar2(500) Path 'SORT', Pagenow Number(5) Path 'PAGENOW', Pagesize Number(5) Path 'PAGESIZE') B;

  v_Xmlfileds := 'X.Id As "ID",X.上级id As "PID", X.名称 As "MC",X.编码 As "BH",X.简码 As "JM", X.站点 As "ZD",X.末级 As "LS",X.部门负责人 As "DH",X.工作性质 As "XZ"';

  v_Fileds := 'X.Id,X.上级id,X.编码,X.名称,X.简码,X.站点,X.末级,X.部门负责人,X.工作性质';
  v_Sql    := 'Select a.Id, a.上级id, a.编码, a.名称, a.简码, a.站点, a.末级, a.部门负责人, b.工作性质' || Chr(10) || 'From 部门表 A,' ||
              Chr(10) || '     (Select B1.部门id, f_List2str(Cast(Collect(B1.工作性质) As t_Strlist)) 工作性质' || Chr(10) ||
              '       From 部门性质说明 B1' || Chr(10) || '       Group By B1.部门id) B';
  v_Where  := 'Where a.Id = b.部门id(+) And (a.撤档时间 Is Null Or a.撤档时间 = To_Date(''3000-01-01'', ''YYYY-MM-DD''))';
  --是否排除不存在人员的部门
  If n_Exclude = 1 Then
    v_Sql   := v_Sql || ',(Select Distinct C1.部门id From 部门人员 C1) C';
    v_Where := v_Where || ' And A.ID=C.部门id';
  End If;
  --存在部门限制
  If v_部门性质 Is Not Null Or n_Serv Is Not Null Then
    --增加部门工作性质条件
    If v_部门性质 Is Not Null Then
      v_部门性质 := ',' || v_部门性质 || ',';
      v_Deptsql  := 'Select Distinct G.部门id From 部门性质说明 G Where Instr(:1, '','' || G.工作性质 || '','') > 0';
    End If;
    --增加服务对象条件
    If n_Serv Is Not Null Then
      --部门工作性质占位
      If v_Deptsql Is Null Then
        v_Deptsql := 'Select Distinct G.部门id From 部门性质说明 G Where :1 Is Null';
      End If;
      If n_Serv <> 3 And n_Serv <> 0 Then
        v_Deptsql := v_Deptsql || ' And (G.服务对象=:2 Or G.服务对象=3)';
      Else
        v_Deptsql := v_Deptsql || ' And G.服务对象=:2';
      End If;
    Elsif v_Deptsql Is Not Null Then
      --服务对象参数占位
      v_Deptsql := v_Deptsql || ' And :2 Is Null';
    End If;
    v_Sql   := v_Sql || ',(' || v_Deptsql || ') D';
    v_Where := v_Where || ' And A.ID=D.部门id';
  Else
    v_Where := v_Where || ' And :1 Is Null And :2 Is Null';
  End If;

  --增加ID选项
  If n_Id <> 0 Then
    v_Where := v_Where || ' And a.ID=:3';
  Else
    v_Where := v_Where || ' And :3=0';
  End If;
  --增加名称条件
  If v_Name Is Not Null Then
    v_Where := v_Where || ' And a.名称=:4';
  Else
    v_Where := v_Where || ' And :4 Is Null';
  End If;
  --增加编码条件
  If v_Code Is Not Null Then
    v_Where := v_Where || ' And a.编码=:5';
  Else
    v_Where := v_Where || ' And :5 Is Null';
  End If;

  --增加模糊匹配限制
  If v_Key Is Not Null Then
    v_Where := v_Where || ' And (a.编码 Like :6 Or A.名称 Like :7 Or A.简码 Like :8)';
  Else
    v_Where := v_Where || ' And (:6 Is Not Null Or :7 Is Not Null Or :8 Is Not Null)';
  End If;

  --排序字段
  v_Sort := Nvl(v_Sort, 'ID');
  v_Sql  := 'Select Rownum Rn, ' || Replace(v_Fileds, 'X.', 'F.') || Chr(10) || 'From (Select ' ||
            Replace(v_Fileds, 'X.', 'E.') || Chr(10) || '       From (' || v_Sql || Chr(10) || v_Where || ') E' ||
            Chr(10) || '       Order By ' || Replace(v_Sort, 'X.', 'E.') || ') F';

  --分页查询
  v_Sql := 'Select Xmlelement("OUTPUT",Xmlelement("RYLIST",Xmlagg(Xmlelement("ITEM", Xmlattributes(''true'' As "jsonArray"), Xmlforest(' ||
           Replace(v_Xmlfileds, 'X.', 'M.') || ')))))' || Chr(10) || '       From (' || v_Sql || ') M ';
  If n_Cur_Page > 0 And n_Pagesize > 0 Then
    v_Sql := v_Sql || '  Where M.Rn Between :9 And :10';
  Else
    --可能有其一不为0
    n_Cur_Page := 0;
    n_Pagesize := 0;
    --开始从1开始
    v_Sql := v_Sql || '  Where :9=1 And :10=0';
  End If;
  Execute Immediate v_Sql
    Into x_Templet
    Using v_部门性质, n_Serv, n_Id, v_Name, v_Code, v_Key || '%', v_Key || '%', '%' || v_Key || '%', n_Pagesize * (n_Cur_Page - 1) + 1, n_Pagesize * n_Cur_Page;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getdept;
/
Create Or Replace Procedure Zl_Third_Getdeptmatch
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:用于获取科室病区对照关系
  --入参:Xml_In:
  --<IN>
  --  <BMID></BMID>         --病区ID
  --  <KSID></KSID>         --科室ID
  --  <KSATTRIBUTE></KSATTRIBUTE>//科室属性，多个部分性质以逗号分隔。临床,药房
  --  <KSSERVFOR></KSSERVFOR>    //科室服务对象。Null -所有。0-（不包含1-门诊,2-住院,3-门诊和住院），1-门诊（包含3）,2-住院（包含3）,3-门诊和住院
  --  <SORT></SORT>      //排序字段，为NULL ,则缺省排序字段为科室id。科室id,病区id
  --  <PAGENOW></PAGENOW>  //当前页数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --  <PAGESIZE></PAGESIZE>  //记录条数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <BMKSLIST>
  --    <ITEM jsonArray="true">
  --      <BQID></BQID>  --病区ID
  --      <KSID></KSID>  --科室ID
  --    </ITEM>
  --  <BMKSLIST>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Sql       Varchar2(4000);
  v_Where     Varchar2(4000);
  v_Deptsql   Varchar2(4000);
  n_科室id    部门表.Id%Type;
  n_病区id    部门表.Id%Type;
  v_部门性质  Varchar2(100);
  n_Serv      Number(1);
  v_Sort      Varchar2(500);
  n_Cur_Page  Number(5);
  n_Pagesize  Number(5);
  v_Xmlfileds Varchar2(1000);
  v_Fileds    Varchar2(1000);
  x_Templet   Xmltype; --模板XML
Begin
  --获取入参
  Select Nvl(Max(b.Bmid), 0), Nvl(Max(b.Ksid), 0), Max(b.Ksattribute), Max(b.Ksservfor), Max(b.Sortkey),
         Nvl(Max(b.Pagenow), 0), Nvl(Max(b.Pagesize), 0)
  Into n_病区id, n_科室id, v_部门性质, n_Serv, v_Sort, n_Cur_Page, n_Pagesize
  From Xmltable('$a/IN' Passing Xml_In As "a" Columns Bmid Number(18) Path 'BMID', Ksid Number(18) Path 'KSID',
                 Ksattribute Varchar2(100) Path 'KSATTRIBUTE', Ksservfor Number(1) Path 'KSSERVFOR',
                 Sortkey Varchar2(500) Path 'SORT', Pagenow Number(5) Path 'PAGENOW', Pagesize Number(5) Path 'PAGESIZE') B;

  v_Xmlfileds := 'X.病区id As "BQID", X.科室id As "KSID"';
  v_Fileds    := 'X.科室id,X.病区id';
  v_Sql       := 'Select a.科室id, a.病区id From 病区科室对应 A';
  --存在部门限制
  If v_部门性质 Is Not Null Or n_Serv Is Not Null Then
    --增加部门工作性质条件
    If v_部门性质 Is Not Null Then
      v_部门性质 := ',' || v_部门性质 || ',';
      v_Deptsql  := 'Select Distinct G.部门id From 部门性质说明 G Where Instr(:1, '','' || G.工作性质 || '','') > 0';
    End If;
    --增加服务对象条件
    If n_Serv Is Not Null Then
      --部门工作性质占位
      If v_Deptsql Is Null Then
        v_Deptsql := 'Select Distinct G.部门id From 部门性质说明 G Where :1 Is Null';
      End If;
      If n_Serv <> 3 And n_Serv <> 0 Then
        v_Deptsql := v_Deptsql || ' And (G.服务对象=:2 Or G.服务对象=3)';
      Else
        v_Deptsql := v_Deptsql || ' And G.服务对象=:2';
      End If;
    Elsif v_Deptsql Is Not Null Then
      --服务对象参数占位
      v_Deptsql := v_Deptsql || ' And :2 Is Null';
    End If;
    v_Sql   := v_Sql || ',(' || v_Deptsql || ') B';
    v_Where := 'Where  A.科室id=B.部门id';
  Else
    v_Where := 'Where :1 Is Null And :2 Is Null';
  End If;
  If n_病区id <> 0 Then
    v_Where := v_Where || ' And A.病区id=:3';
  Else
    v_Where := v_Where || ' And :3=0';
  End If;
  If n_科室id <> 0 Then
    v_Where := v_Where || ' And A.科室id=:4';
  Else
    v_Where := v_Where || ' And :4=0';
  End If;
  --排序字段
  v_Sort := Nvl(v_Sort, '科室id');
  v_Sql  := 'Select Rownum Rn, ' || Replace(v_Fileds, 'X.', 'F.') || Chr(10) || 'From (Select ' ||
            Replace(v_Fileds, 'X.', 'E.') || Chr(10) || '       From (' || v_Sql || Chr(10) || v_Where || ') E' ||
            Chr(10) || '       Order By ' || Replace(v_Sort, 'X.', 'E.') || ') F';

  --分页查询
  v_Sql := 'Select Xmlelement("OUTPUT",Xmlelement("BMKSLIST",Xmlagg(Xmlelement("ITEM", Xmlattributes(''true'' As "jsonArray"), Xmlforest(' ||
           Replace(v_Xmlfileds, 'X.', 'M.') || ')))))' || Chr(10) || '       From (' || v_Sql || ') M ';
  If n_Cur_Page > 0 And n_Pagesize > 0 Then
    v_Sql := v_Sql || '  Where M.Rn Between :5 And :6';
  Else
    --可能有其一不为0
    n_Cur_Page := 0;
    n_Pagesize := 0;
    --开始从1开始
    v_Sql := v_Sql || '  Where :5=1 And :6=0';
  End If;
  Execute Immediate v_Sql
    Into x_Templet
    Using v_部门性质, n_Serv, n_病区id, n_科室id, n_Pagesize * (n_Cur_Page - 1) + 1, n_Pagesize * n_Cur_Page;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getdeptmatch;
/
Create Or Replace Procedure Zl_Third_Getdiseasesitem
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取疾病编码目录数据，支持精确匹配、模糊匹配、分页查询
  --入参:Xml_In:
  --<IN>
  --  <ID></ID> //疾病ID,精确匹配，为NULL则不进行匹配查询
  --  <NAME></NAME> //疾病名称,精确匹配，为NULL则不进行匹配查询
  --  <CODE></CODE> //疾病编码,精确匹配，为NULL则不进行匹配查询
  --  <KEY></KEY> //模糊查询关键字，简码、名称、编码，简码为拼音简码，编码左匹配，名称与简码全匹配。为NULL则不进行匹配查询。
  --  <DISEASECATEGORIES></DISEASECATEGORIES> //疾病类别，多个分类直接拼接，不加分隔符，为Null则不进行疾病类别限制
  --  <SEX></SEX> //性别限制。男，女。为NULL则不进行性别限制
  --  <APPLICATION></APPLICATION> //适用范围限制。0，全院，1-门诊,2-住院,null-不限制
  --  <NOTCHECKVALID></NOTCHECKVALID> //是否不进行有效性检查。0-进行有效性检查，1-不进行有效性检查。
  --  <SORT></SORT>//排序字段，为NULL ,则缺省排序字段为编码,ID。若要对排序字段上添加函数，则必须增加别名前缀X.(必须大写)如：NVL(X.编码,'测试')
  --               //支持的排序字段名：ID,编码,序号,名称,简码,五笔码,性别限制,疗效限制,分娩,适用范围,是否病人,手术类型,手术操作类型,统计码,类别,分类id
  --               //分类名称,分类简码,分类编码范围,建档时间,撤档时间,附码,附码id,附码名称
  --  <PAGENOW></PAGENOW>  //当前页数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --  <PAGESIZE></PAGESIZE>  //记录条数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <XMLIST>
  --    <ITEM jsonArray="true">
  --      <ID></ID>   //ID
  --      <CD></CD>   //疾病编码
  --      <NO></NO>   //序号
  --      <NA></NA>   //名称
  --      <JM></JM>   //简码
  --      <WB></WB>   //五笔简码
  --      <SEX></SEX>   //性别限制
  --      <EF></EF>   //疗效限制
  --      <CB></CB>   //分娩
  --      <AR></AR>   //适用范围
  --      <AP></AP>   //是否病人
  --      <OT></OT>   //手术类型
  --      <TOO></TOO>   //手术操作类型
  --      <SC></SC>   //统计码
  --      <CAT></CAT>   //分类
  --      <CID></CID>   //分类ID
  --      <CN></CN>   //分类名称
  --      <CJM></CJM>   //分类简码
  --      <CCR></CCR>   //分类编码范围
  --      <BE></BE>   //建档时间
  --      <EN></EN>   //撤档时间
  --      <ECD></ECD>   //附码
  --      <ECN></ECN>   //附码名称
  --      <ECID></ECID>   //附码ID
  --    </ITEM>
  --  </XMLIST>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Sql           Varchar2(8000);
  n_Id            疾病编码目录.Id %Type;
  v_Name          疾病编码目录.名称 %Type;
  v_Code          疾病编码目录.编码 %Type;
  v_Key           Varchar2(200);
  v_Cats          Varchar2(20);
  v_Sex           Varchar2(10);
  n_Apprange      Number(1);
  n_Notcheckvalid Number(1);
  v_Sort          Varchar2(500);
  n_Cur_Page      Number(5);
  n_Pagesize      Number(5);
  v_Fileds        Varchar2(1000);
  v_Xmlfileds     Varchar2(1000);
  x_Templet       Xmltype; --模板XML
Begin
  Select Nvl(Max(b.Id), 0), Max(b.Na), Max(b.Code), Max(b.Key), Max(b.Cats), Max(b.Sex), Max(b.Application),
         Nvl(Max(b.Notcheckvalid), 0), Max(b.Sortkey), Nvl(Max(b.Pagenow), 0), Nvl(Max(Pagesize), 0)
  Into n_Id, v_Name, v_Code, v_Key, v_Cats, v_Sex, n_Apprange, n_Notcheckvalid, v_Sort, n_Cur_Page, n_Pagesize
  From Xmltable('$a/IN' Passing Xml_In As "a" Columns ID Number(18) Path 'ID', Na Varchar2(150) Path 'NAME',
                 Code Varchar2(20) Path 'CODE', Key Varchar2(200) Path 'KEY', Cats Varchar2(20) Path 'DISEASECATEGORIES',
                 Sex Varchar2(10) Path 'SEX', Application Number(1) Path 'APPLICATION',
                 Notcheckvalid Number(1) Path 'NOTCHECKVALID', Sortkey Varchar2(500) Path 'SORT',
                 Pagenow Number(5) Path 'PAGENOW', Pagesize Number(5) Path 'PAGESIZE') B;
  v_Xmlfileds := 'X.Id As "ID", X.编码 As "CD", X.序号 As "NO", X.名称 As "NA",X.简码 As "JM", X.五笔码 As "WB", X.性别限制 As "SEX", X.疗效限制 As "EF",' ||
                 Chr(10) ||
                 'X.分娩 As "CB", X.适用范围 As "AR", X.是否病人 As "AP", X.手术类型 As "OT",X.手术操作类型 As "TOO", X.统计码 As "SC", X.类别 As "CAT", X.分类id As "CID",' ||
                 Chr(10) ||
                 'X.分类名称 As "CN", X.分类简码 As "CJM", X.分类编码范围 As "CCR", X.建档时间 As "BE",X.撤档时间 As "EN", X.附码 As "ECD", X.附码id As "ECID", X.附码名称 As "ECN"';
  v_Fileds    := 'X.ID,X.编码,X.序号,X.名称,X.简码,X.五笔码,X.性别限制,X.疗效限制,X.分娩,X.适用范围,X.是否病人,X.手术类型,X.手术操作类型,X.统计码,X.类别,X.分类id,X.分类名称,X.分类简码,X.分类编码范围,X.建档时间,X.撤档时间,X.附码,X.附码id,X.附码名称';
  v_Sql       := 'Select a.Id, a.编码, a.序号, a.名称, a.简码, a.五笔码, a.性别限制, a.疗效限制, a.分娩, a.适用范围, c.是否病人, a.手术类型, a.手术操作类型, a.统计码, a.类别, a.分类id,' ||
                 Chr(10) || '         c.名称 分类名称, a.简码 分类简码, c.编码范围 分类编码范围, a.建档时间, a.撤档时间, a.附码, b.Id 附码id, b.名称 附码名称' ||
                 Chr(10) || '  From 疾病编码目录 A, 疾病编码目录 B, 疾病编码分类 C' || Chr(10) ||
                 '  Where a.分类id = c.Id(+) And a.附码 = b.编码(+)';

  --增加ID选项
  If n_Id <> 0 Then
    v_Sql := v_Sql || ' And a.ID=:1';
  Else
    v_Sql := v_Sql || ' And :1=0';
  End If;
  --增加名称条件
  If v_Name Is Not Null Then
    v_Sql := v_Sql || ' And a.名称=:2';
  Else
    v_Sql := v_Sql || ' And :2 Is Null';
  End If;
  --增加编码条件
  If v_Code Is Not Null Then
    v_Sql := v_Sql || ' And a.编码=:3';
  Else
    v_Sql := v_Sql || ' And :3 Is Null';
  End If;
  --增加模糊匹配限制
  If v_Key Is Not Null Then
    v_Sql := v_Sql || ' And (a.编码 Like :4 Or a.名称 Like :5 Or a.简码 Like :6)';
  Else
    --拼接了匹配符所以不为空
    v_Sql := v_Sql || ' And (:4 Is Not Null Or :5 Is Not Null Or :6 Is Not Null)';
  End If;

  --增加分类限制条件
  If v_Cats Is Not Null Then
    v_Sql := v_Sql || ' And instr(:7,a.类别)>0';
  Else
    v_Sql := v_Sql || ' And :7 Is Null';
  End If;
  --增加性别限制
  If v_Sex Is Not Null Then
    v_Sql := v_Sql || ' And (a.性别限制=:8 Or a.性别限制 Is Null)';
  Else
    v_Sql := v_Sql || ' And :8 Is Null';
  End If;
  --增加适用范围限制
  If n_Apprange Is Not Null Then
    v_Sql := v_Sql || ' And (a.适用范围=:9 Or Nvl(a.适用范围,0)=0)';
  Else
    v_Sql := v_Sql || ' And :9 Is Null';
  End If;
  --增加撤档检查限制
  If n_Notcheckvalid = 0 Then
    v_Sql := v_Sql || ' And (A.撤档时间 Is Null Or A.撤档时间 = To_Date(''3000-01-01'', ''YYYY-MM-DD''))';
  End If;
  --排序字段
  v_Sort := Nvl(v_Sort, '编码,ID');
  v_Sql  := 'Select Rownum Rn, ' || Replace(v_Fileds, 'X.', 'E.') || Chr(10) || 'From (Select ' ||
            Replace(v_Fileds, 'X.', 'D.') || Chr(10) || '       From (' || v_Sql || ') D' || Chr(10) ||
            '       Order By ' || Replace(v_Sort, 'X.', 'D.') || ') E';
  --分页查询
  v_Sql := 'Select Xmlelement("OUTPUT",Xmlelement("XMLIST",Xmlagg(Xmlelement("ITEM", Xmlattributes(''true'' As "jsonArray"), Xmlforest(' ||
           Replace(v_Xmlfileds, 'X.', 'F.') || ')))))' || Chr(10) || '       From (' || v_Sql || ') F ';
  If n_Cur_Page > 0 And n_Pagesize > 0 Then
    v_Sql := v_Sql || '  Where F.Rn Between :10 And :11';
  Else
    --可能有其一不为0
    n_Cur_Page := 0;
    n_Pagesize := 0;
    --开始从1开始
    v_Sql := v_Sql || '  Where :10=1 And :11=0';
  End If;
  Execute Immediate v_Sql
    Into x_Templet
    Using n_Id, v_Name, v_Code, v_Key || '%', v_Key || '%', '%' || v_Key || '%', v_Cats, v_Sex, n_Apprange, n_Pagesize * (n_Cur_Page - 1) + 1, n_Pagesize * n_Cur_Page;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getdiseasesitem;
/
Create Or Replace Procedure Zl_Third_Getfeeitem
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取收费项目目录,支持精确匹配、模糊匹配、分页查询
  --入参:Xml_In:
  --<IN>
  --  <ID></ID> //收费项目ID,精确匹配，为NULL则不进行匹配查询
  --  <NAME></NAME> //收费项目名称,精确匹配，为NULL则不进行匹配查询
  --  <CODE></CODE> //收费项目编码,精确匹配，为NULL则不进行匹配查询
  --  <KEY></KEY> //模糊查询关键字，简码、名称、编码，简码为拼音简码，编码左匹配，名称与简码全匹配。为NULL则不进行匹配查询。
  --  <DISEASECATEGORIES></DISEASECATEGORIES> //收费项目类别，多个分类直接拼接，不加分隔符，为Null则自动排除床位和挂号
  --  <SERVFOR></SERVFOR> //适用范围限制。Null -所有。0-（不包含1-门诊,2-住院,3-门诊和住院），1-门诊（包含3）,2-住院（包含3）,3-门诊和住院
  --  <NOTCHECKVALID></NOTCHECKVALID> //是否不进行有效性检查。0-进行有效性检查，1-不进行有效性检查。
  --  <INCLUDESUB></INCLUDESUB> //是否包含从属项目。0,null-不包含从属项目,1-包含从属项目
  --  <SORT></SORT>//排序字段，为NULL ,则缺省排序字段为编码,ID。若要对排序字段上添加函数，则必须增加别名前缀X.(必须大写)如：NVL(X.编码,'测试')
  --               //类别, 类别名称, 固定类别, Id, 编码, 名称, 规格, 产地, 计算单位, 说明, 项目特性, 服务对象, 执行科室, 标识主码, 标识子码,备选码,
  --               //建档时间, 撤档时间, 费用类型, 是否变价, 最低限价, 最高限价, 录入限量, 费用确认, 屏蔽费别, 加班加价, 计算方式, 补充摘要, 病案费目,
  --               //站点, 启用原因, 停用原因,主项id,固有从属,从项数次,单价
  --  <PAGENOW></PAGENOW>  //当前页数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --  <PAGESIZE></PAGESIZE>  //记录条数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --</IN>
  --出参:Xml_Out--以类别与编码排序返回分页
  --<OUTPUT>
  --  <XMLIST>
  --    <XM jsonArray="true">
  --      <LB></LB>   //类别，治疗、护理等
  --      <LBC></LBC>   //类别编码
  --      <LBF></LBF>   //类别是否是固定类别
  --      <DMC></DMC>   //收费分类项目名称
  --      <ID></ID>   //收费项目Id
  --      <BM></BM>   //收费项目编码
  --      <MC></MC>   //收费项目名称
  --      <GG></GG>   //规格
  --      <CD></CD>   //产地
  --      <DW></DW>   //计算单位
  --      <SM></SM>   //说明
  --      <TX></TX>   //项目特性
  --      <SF></SF>   //服务对象
  --      <ED></ED>   //执行科室
  --      <MM></MM>   //标识主码
  --      <MS></MS>   //标识子码
  --      <BC></BC>   //备选码
  --      <BE></BE>   //建档时间
  --      <EN></EN>   //撤档时间
  --      <FT></FT>   //费用类型
  --      <VV></VV>   //是否变价
  --      <LP></LP>   //最低限价
  --      <HP></HP>   //最高限价
  --      <UM></UM>   //录入限量
  --      <FC></FC>   //费用确认
  --      <IF></IF>   //屏蔽费别
  --      <OP></OP>   //加班加价
  --      <CT></CT>   //计算方式
  --      <AS></AS>   //补充摘要
  --      <MI></MI>   //病案费目
  --      <ZD></ZD>   //站点
  --      <UR></UR>   //启用原因
  --      <SR></SR>   //停用原因
  --      <MID></MID>   //主项id
  --      <FS></FS>   //固有从属
  --      <ST></ST>   //从项数次
  --      <CSP></CSP> //成套标识，0-非成套，1-成套
  --      <DJ></DJ>   //单价
  --    </XM>
  --  </XMLIST>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Sql           Varchar2(8000);
  n_Id            收费项目目录.Id %Type;
  v_Name          收费项目目录.名称 %Type;
  v_Code          收费项目目录.编码 %Type;
  v_Key           Varchar2(200);
  v_Cats          Varchar2(20);
  n_Serv          Number(3);
  n_Notcheckvalid Number(1);
  n_Sub           Number(1);
  v_Sort          Varchar2(500);
  n_Cur_Page      Number(5);
  n_Pagesize      Number(5);
  v_Xmlfileds     Varchar2(1000);
  v_Fileds        Varchar2(1000);
  v_Fileds1       Varchar2(1000);
  x_Templet       Xmltype; --模板XML
Begin
  --获取查询参数
  Select Nvl(Max(b.Id), 0), Max(b.Na), Max(b.Code), Max(b.Key), Max(b.Cats), Max(b.Servfor),
         Nvl(Max(b.Notcheckvalid), 0), Nvl(Max(b.Includesub), 0), Max(b.Sortkey), Nvl(Max(b.Pagenow), 0),
         Nvl(Max(b.Pagesize), 0)
  Into n_Id, v_Name, v_Code, v_Key, v_Cats, n_Serv, n_Notcheckvalid, n_Sub, v_Sort, n_Cur_Page, n_Pagesize
  From Xmltable('$a/IN' Passing Xml_In As "a" Columns ID Number(18) Path 'ID', Na Varchar2(150) Path 'NAME',
                 Code Varchar2(20) Path 'CODE', Key Varchar2(200) Path 'KEY', Cats Varchar2(20) Path 'DISEASECATEGORIES',
                 Servfor Number(3) Path 'SERVFOR', Notcheckvalid Number(1) Path 'NOTCHECKVALID',
                 Includesub Number(1) Path 'INCLUDESUB', Sortkey Varchar2(500) Path 'SORT',
                 Pagenow Number(5) Path 'PAGENOW', Pagesize Number(5) Path 'PAGESIZE') B;
  v_Xmlfileds := 'X.类别名称 As "LB", X.类别 As "LBC", X.固定类别 As "LBF",X.分类名称 As "DMC", X.Id As "ID",X.编码 As "BM", X.名称 As "MC", X.规格 As "GG", X.产地 As "CD",X.计算单位 As "DW",' ||
                 Chr(10) ||
                 'X.说明 As "SM", X.项目特性 As "TX", X.服务对象 As "SF", X.执行科室 As "ED",X.标识主码 As "MM",X.标识子码 As "MS", X.备选码 As "BC", X.建档时间 As "BE", X.撤档时间 As "EN",X.费用类型 As "FT",' ||
                 Chr(10) ||
                 'X.是否变价 As "VV", X.最低限价 As "LP", X.最高限价 As "HP", X.录入限量 As "UM",X.费用确认 As "FC",X.屏蔽费别 As "IF", X.加班加价 As "OP", X.计算方式 As "CT", X.补充摘要 As "AS",X.病案费目 As "MI",' ||
                 Chr(10) ||
                 'X.站点 As "ZD", X.启用原因 As "UR", X.停用原因 As "SR", X.主项id As "MID",X.固有从属 As "FS",X.从项数次 As "ST",X.成套标识 As "CSP",X.单价 As "DJ"';
  v_Fileds    := 'X.类别, X.类别名称, X.固定类别,X.分类名称, X.Id, X.编码, X.名称, X.规格, X.产地, X.计算单位, X.说明, X.项目特性, X.服务对象, X.执行科室, X.标识主码, X.标识子码,X.备选码, X.建档时间, X.撤档时间, X.费用类型, X.是否变价, X.最低限价, X.最高限价, X.录入限量, X.费用确认, X.屏蔽费别, X.加班加价, X.计算方式, X.补充摘要, X.病案费目,X.站点, X.启用原因, X.停用原因';
  v_Fileds1   := v_Fileds || ',X.主项id,X.固有从属,X.从项数次,X.成套标识';
  v_Sql       := 'Select a.类别, b.名称 类别名称, b.固定 固定类别,B1.名称 分类名称, a.Id, a.编码, a.名称, a.规格, a.产地, a.计算单位, a.说明, a.项目特性, a.服务对象, a.执行科室, a.标识主码, a.标识子码,' ||
                 Chr(10) ||
                 '       a.备选码, a.建档时间, a.撤档时间, a.费用类型, a.是否变价, a.最低限价, a.最高限价, a.录入限量, a.费用确认, a.屏蔽费别, a.加班加价, a.计算方式, a.补充摘要, a.病案费目,' ||
                 Chr(10) || '       a.站点, a.启用原因, a.停用原因 ' || Chr(10) || 'From 收费项目目录 A, 收费项目类别 B,收费分类目录 B1';

  If v_Key Is Not Null Then
    v_Sql := v_Sql || ',收费项目别名 A1 Where a.类别 = b.编码 And a.Id = A1.收费细目id And A1.码类 = 1 And A.分类id=B1.id';
  Else
    v_Sql := v_Sql || ' Where a.类别 = b.编码  And A.分类id=B1.id';
  End If;
  --增加ID选项
  If n_Id <> 0 Then
    v_Sql := v_Sql || ' And a.ID=:1';
  Else
    v_Sql := v_Sql || ' And :1=0';
  End If;
  --增加名称条件
  If v_Name Is Not Null Then
    v_Sql := v_Sql || ' And a.名称=:2';
  Else
    v_Sql := v_Sql || ' And :2 Is Null';
  End If;
  --增加编码条件
  If v_Code Is Not Null Then
    v_Sql := v_Sql || ' And a.编码=:3';
  Else
    v_Sql := v_Sql || ' And :3 Is Null';
  End If;
  --增加模糊匹配限制
  If v_Key Is Not Null Then
    v_Sql := v_Sql || ' And (a.编码 Like :4 Or A1.名称 Like :5 Or A1.简码 Like :6)';
  Else
    v_Sql := v_Sql || ' And (:4 Is Not Null Or :5 Is Not Null Or :6 Is Not Null)';
  End If;
  --增加分类限制条件
  If v_Cats Is Not Null Then
    v_Sql := v_Sql || ' And instr(:7,a.类别)>0';
  Else
    v_Sql := v_Sql || ' And a.类别 Not In (''1'', ''J'') And :7 Is Null';
  End If;
  --增加适用范围限制
  If n_Serv Is Not Null Then
    If n_Serv = 0 Then
      v_Sql := v_Sql || ' And NVL(a.服务对象,0)=0 And :8 Is Not Null';
    Elsif n_Serv <> 3 Then
      v_Sql := v_Sql || ' And (a.服务对象=:8 Or 服务对象=3)';
    Else
      v_Sql := v_Sql || ' And a.服务对象=:8';
    End If;
  Else
    v_Sql := v_Sql || ' And :8 Is Null';
  End If;
  --增加撤档检查限制
  If n_Notcheckvalid = 0 Then
    v_Sql := v_Sql || ' And (A.撤档时间 Is Null Or A.撤档时间 = To_Date(''3000-01-01'', ''YYYY-MM-DD''))';
  End If;
  --是否包含从属项目过滤
  v_Sql := ' WIth ca As(' || v_Sql || '),CB As (Select Distinct C1.主项id From 收费从属项目 C1)';
  v_Sql := v_Sql || Chr(10) || 'Select ' || Replace(v_Fileds, 'X.', 'CA.') ||
           ',Null 主项id, 1 固有从属, 1 从项数次,Decode(CB.主项id,Null,0,1) As 成套标识  From CA,CB Where CA.Id=CB.主项id(+)';
  If n_Sub <> 0 Then
    v_Sql := v_Sql || Chr(10) || ' Union All ' || Chr(10) ||
             'Select D.类别, E.名称 类别名称, E.固定 固定类别,E1.名称 分类名称, D.Id, D.编码, D.名称, D.规格, D.产地, D.计算单位, D.说明, D.项目特性, D.服务对象, D.执行科室, D.标识主码, D.标识子码,' ||
             Chr(10) ||
             'D.备选码, D.建档时间, D.撤档时间, D.费用类型, D.是否变价, D.最低限价, D.最高限价, D.录入限量, D.费用确认, D.屏蔽费别, D.加班加价, D.计算方式, D.补充摘要, D.病案费目,' ||
             Chr(10) ||
             'D.站点, D.启用原因, D.停用原因, CA.Id 主项id, c.固有从属, c.从项数次,Decode(CB.主项id,Null,0,1) As 成套标识 From CA, 收费从属项目 C, 收费项目目录 D, 收费项目类别 E ,收费分类目录 E1,CB Where C.主项ID=CA.ID And C.从项ID=D.ID  And D.类别 = E.编码 And D.分类id=E1.id And D.Id=CB.主项id(+)';
  End If;
  --计算单价
  v_Sql     := 'Select ' || Replace(v_Fileds1, 'X.', 'F.') ||
               ',Decode(Nvl(F.是否变价, 0), 0, LTrim(RTrim(To_Char(Sum(Nvl(G.现价, 0)), ''9999999990.0000''))),Decode(Instr(''4567'', F.类别), 0, LTrim(RTrim(To_Char(Sum(Nvl(G.缺省价格, 0)), ''9999999990.0000''))),''时价'')) As 单价 From ( ' ||
               v_Sql || ') F,收费价目 G ' || Chr(10) ||
               'Where F.Id = G.收费细目id(+) And G.执行日期 <= Sysdate And (G.终止日期 > Sysdate Or G.终止日期 Is Null) And G.价格等级 Is Null ' ||
               Chr(10) || 'Group By ' || Replace(v_Fileds1, 'X.', 'F.');
  v_Fileds1 := v_Fileds1 || ',X.单价';
  --排序字段
  v_Sort := Nvl(v_Sort, '编码,ID');
  v_Sql  := 'Select Rownum Rn, ' || Replace(v_Fileds1, 'X.', 'J.') || Chr(10) || 'From (Select ' ||
            Replace(v_Fileds1, 'X.', 'H.') || Chr(10) || '       From (' || v_Sql || ') H' || Chr(10) ||
            '       Order By ' || Replace(v_Sort, 'X.', 'H.') || ') J';
  --分页查询
  v_Sql := 'Select Xmlelement("OUTPUT", Xmlelement("XMLIST",Xmlagg(Xmlelement("XM", Xmlattributes(''true'' As "jsonArray"),Xmlforest(' ||
           Replace(v_Xmlfileds, 'X.', 'K.') || ')))))' || Chr(10) || '       From (' || v_Sql || ') K ';
  If n_Cur_Page > 0 And n_Pagesize > 0 Then
    v_Sql := v_Sql || '  Where K.Rn Between :9 And :10';
  Else
    --从1开始，防止其中一个不为0
    n_Cur_Page := 0;
    n_Pagesize := 0;
    v_Sql      := v_Sql || '  Where :9=1 And :10=0';
  End If;
  Execute Immediate v_Sql
    Into x_Templet
    Using n_Id, v_Name, v_Code, v_Key || '%', v_Key || '%', '%' || v_Key || '%', v_Cats, n_Serv, n_Pagesize * (n_Cur_Page - 1) + 1, n_Pagesize * n_Cur_Page;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getfeeitem;
/
Create Or Replace Procedure Zl_Third_Getclinicitem
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取诊疗项目目录,支持精确匹配、模糊匹配、分页查询
  --入参:Xml_In:
  --<IN>
  --  <ID></ID> //诊疗项目ID,精确匹配，为NULL则不进行匹配查询
  --  <NAME></NAME> //诊疗项目名称,精确匹配，为NULL则不进行匹配查询
  --  <CODE></CODE> //诊疗项目编码,精确匹配，为NULL则不进行匹配查询
  --  <KEY></KEY> //模糊查询关键字，简码、名称、编码，简码为拼音简码，编码左匹配，名称与简码全匹配。为NULL则不进行匹配查询。
  --  <DISEASECATEGORIES></DISEASECATEGORIES> //诊疗项目类别，多个分类直接拼接，不加分隔符，为Null则不限制
  --  <SEX></SEX> //性别限制。1-男，2-女。为NULL则不进行性别限制,0-表示不限制性别的项目
  --  <SERVFOR></SERVFOR> //适用范围限制。Null -所有。0-（不包含1-门诊,2-住院,3-门诊和住院，4-体检），1-门诊（包含3）,2-住院（包含3）,3-门诊和住院,4-体检
  --  <OPTYPE></OPTYPE> //操作类型
  --  <NOTCHECKVALID></NOTCHECKVALID> //是否不进行有效性检查。0-进行有效性检查，1-不进行有效性检查。
  --  <SORT></SORT>//排序字段，为NULL ,则缺省排序字段为编码,ID。若要对排序字段上添加函数，则必须增加别名前缀X.(必须大写)如：NVL(X.编码,'测试')
  --               //类别,类别名称, Id, 编码, 名称, 标本部位, 计算单位, 计算方式, 执行频率, 适用性别, 单独应用, 组合项目, 操作类型, 执行安排, 执行科室,
  --               //服务对象, 计价性质, 建档时间, 撤档时间, 参考目录id, 人员id, 录入限量, 试管编码, 执行分类, 执行标记, 计算规则, 站点,建档人, 计算系数, 诊疗频率编码,
  --               //是否保密
  --  <PAGENOW></PAGENOW>  //当前页数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --  <PAGESIZE></PAGESIZE>  //记录条数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --</IN>
  --出参:Xml_Out--以类别与编码排序返回分页
  --<OUTPUT>
  --  <XMLIST>
  --    <ITEM jsonArray="true">
  --      <LB></LB>   //类别
  --      <LBN></LBN>   //类别名称
  --      <ID></ID>   //诊疗项目ID
  --      <BM></BM>   //诊疗项目编码
  --      <MC></MC>   //诊疗项目名称
  --      <BW></BW>   //标本部位
  --      <DW></DW>   //计算单位
  --      <CW></CW>   //计算方式
  --      <EF></EF>   //执行频率
  --      <SEX></SEX>   //适用性别
  --      <AA></AA>   //单独应用
  --      <CP></CP>   //组合项目
  --      <OT></OT>   //操作类型
  --      <SF></SF>   //服务对象
  --      <ES></ES>   //执行安排
  --      <ED></ED>   //执行科室
  --      <VN></VN>   //计价性质
  --      <BE></BE>   //建档时间
  --      <EN></EN>   //撤档时间
  --      <RDID></RDID>   //参考目录id
  --      <MID></MID>   //人员id
  --      <UM></UM>   //录入限量
  --      <TC></TC>   //试管编码
  --      <EC></EC>   //执行分类
  --      <EM></EM>   //执行标记
  --      <CR></CR>   //计算规则
  --      <CM></CM>   //建档人
  --      <CC></CC>   //计算系数
  --      <CFC></CFC>   //诊疗频率编码
  --      <ZD></ZD>   //站点
  --      <KC></KC>   //是否保密
  --    </ITEM>
  --  </XMLIST>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Sql           Varchar2(8000);
  n_Id            诊疗项目目录.Id %Type;
  v_Name          诊疗项目目录.名称 %Type;
  v_Code          诊疗项目目录.编码 %Type;
  v_Key           Varchar2(200);
  v_Cats          Varchar2(20);
  n_Sex           Number(3);
  n_Serv          Number(3);
  v_Optype        诊疗项目目录.操作类型%Type;
  n_Notcheckvalid Number(1);
  v_Sort          Varchar2(500);
  n_Cur_Page      Number(5);
  n_Pagesize      Number(5);
  v_Xmlfileds     Varchar2(1000);
  v_Fileds        Varchar2(1000);
  x_Templet       Xmltype; --模板XML
Begin

  --获取查询参数
  Select Nvl(Max(b.Id), 0), Max(b.Na), Max(b.Code), Max(b.Key), Max(b.Cats), Max(b.Sex), Max(b.Servfor), Max(b.Optype),
         Nvl(Max(b.Notcheckvalid), 0), Max(b.Sortkey), Nvl(Max(b.Pagenow), 0), Nvl(Max(b.Pagesize), 0)
  Into n_Id, v_Name, v_Code, v_Key, v_Cats, n_Sex, n_Serv, v_Optype, n_Notcheckvalid, v_Sort, n_Cur_Page, n_Pagesize
  From Xmltable('$a/IN' Passing Xml_In As "a" Columns ID Number(18) Path 'ID', Na Varchar2(150) Path 'NAME',
                 Code Varchar2(20) Path 'CODE', Key Varchar2(200) Path 'KEY', Cats Varchar2(20) Path 'DISEASECATEGORIES',
                 Sex Number(3) Path 'SEX', Servfor Number(3) Path 'SERVFOR', Optype Varchar2(20) Path 'OPTYPE',
                 Notcheckvalid Number(1) Path 'NOTCHECKVALID', Sortkey Varchar2(500) Path 'SORT',
                 Pagenow Number(5) Path 'PAGENOW', Pagesize Number(5) Path 'PAGESIZE') B;
  v_Xmlfileds := 'X.类别 As "LB", X.类别名称 As "LBN", X.Id As "ID", X.编码 As "BM", X.名称 As "MC", X.标本部位 As "BW", X.计算单位 As "DW",' ||
                 Chr(10) ||
                 'X.计算方式 As "CW", X.执行频率 As "EF", X.适用性别 As "SEX", X.单独应用 As "AA", X.组合项目 As "CP", X.操作类型 As "OT", X.服务对象 As "SF",' ||
                 Chr(10) || 'X.执行安排 As "ES", X.执行科室 As "ED",  X.计价性质 As "VN", X.建档时间 As "BE", X.撤档时间 As "EN",' ||
                 Chr(10) ||
                 'X.参考目录id As "RDID", X.人员id As "MID", X.录入限量 As "UM", X.试管编码 As "TC", X.执行分类 As "EC", X.执行标记 As "EM",' ||
                 Chr(10) ||
                 'X.计算规则 As "CR", X.建档人 As "CM", X.计算系数 As "CC", X.诊疗频率编码 As "CFC", X.站点 As "ZD", X.是否保密 As "KC"';

  v_Fileds := 'X.类别,X.类别名称, X.Id, X.编码, X.名称, X.标本部位, X.计算单位, X.计算方式, X.执行频率, X.适用性别, X.单独应用, X.组合项目, X.操作类型, X.执行安排, X.执行科室,X.服务对象, X.计价性质, X.建档时间, X.撤档时间, X.参考目录id, X.人员id, X.录入限量, X.试管编码, X.执行分类, X.执行标记, X.计算规则,X.站点, X.建档人, X.计算系数, X.诊疗频率编码,X.是否保密';
  v_Sql    := 'Select a.类别, b.名称 类别名称, a.Id, a.编码, a.名称, a.标本部位, a.计算单位, a.计算方式, a.执行频率, a.适用性别, a.单独应用, a.组合项目, a.操作类型, a.执行安排, a.执行科室,' ||
              Chr(10) ||
              '       a.服务对象, a.计价性质, a.建档时间, a.撤档时间, a.参考目录id, a.人员id, a.录入限量, a.试管编码, a.执行分类, a.执行标记, a.计算规则, a.站点, a.建档人, a.计算系数, a.诊疗频率编码,' ||
              Chr(10) || '       a.是否保密' || Chr(10) || 'From 诊疗项目目录 A, 诊疗项目类别 B';
  If v_Key Is Not Null Then
    v_Sql := v_Sql || ',诊疗项目别名 A1 Where a.类别 = b.编码 And a.Id = A1.诊疗项目id And A1.码类 = 1 ';
  Else
    v_Sql := v_Sql || ' Where a.类别 = b.编码 ';
  End If;

  --增加ID选项
  If n_Id <> 0 Then
    v_Sql := v_Sql || ' And a.ID=:1';
  Else
    v_Sql := v_Sql || ' And :1=0';
  End If;
  --增加名称条件
  If v_Name Is Not Null Then
    v_Sql := v_Sql || ' And a.名称=:2';
  Else
    v_Sql := v_Sql || ' And :2 Is Null';
  End If;
  --增加编码条件
  If v_Code Is Not Null Then
    v_Sql := v_Sql || ' And a.编码=:3';
  Else
    v_Sql := v_Sql || ' And :3 Is Null';
  End If;
  --增加模糊匹配限制
  If v_Key Is Not Null Then
    v_Sql := v_Sql || ' And (a.编码 Like :4 Or A1.名称 Like :5 Or A1.简码 Like :5)';
  Else
    v_Sql := v_Sql || ' And (:4 Is Not Null Or :5 Is Not Null Or :6 Is Not Null)';
  End If;
  --增加分类限制条件
  If v_Cats Is Not Null Then
    v_Sql := v_Sql || ' And instr(:7,a.类别)>0';
  Else
    v_Sql := v_Sql || ' And :7 Is Null';
  End If;
  --增加操作类型条件
  If v_Optype Is Not Null Then
    v_Sql := v_Sql || ' And a.操作类型=:8';
  Else
    v_Sql := v_Sql || ' And :8 Is Null';
  End If;
  --增加性别限制
  If n_Sex Is Not Null Then
    If n_Sex = 0 Then
      v_Sql := v_Sql || ' And NVL(a.适用性别,0)=0 And :9 Is Not Null';
    Else
      v_Sql := v_Sql || ' And (a.适用性别=:9 Or NVL(a.适用性别,0)=0)';
    End If;
  Else
    v_Sql := v_Sql || ' And :9 Is Null';
  End If;

  --增加适用范围限制
  If n_Serv Is Not Null Then
    If n_Serv = 0 Then
      v_Sql := v_Sql || ' And NVL(a.服务对象,0) =0 And :10 Is Not Null';
    Elsif n_Serv <> 3 And n_Serv <> 4 Then
      v_Sql := v_Sql || ' And (a.服务对象=:10 Or a.服务对象=3)';
    Else
      v_Sql := v_Sql || ' And a.服务对象=:10';
    End If;
  Else
    v_Sql := v_Sql || ' And :10 Is Null';
  End If;
  --增加撤档检查限制
  If n_Notcheckvalid = 0 Then
    v_Sql := v_Sql || ' And (A.撤档时间 Is Null Or A.撤档时间 = To_Date(''3000-01-01'', ''YYYY-MM-DD''))';
  End If;
  --排序字段
  v_Sort := Nvl(v_Sort, '编码,ID');
  v_Sql  := 'Select Rownum Rn, ' || Replace(v_Fileds, 'X.', 'E.') || Chr(10) || 'From (Select ' ||
            Replace(v_Fileds, 'X.', 'D.') || Chr(10) || '       From (' || v_Sql || ') D' || Chr(10) ||
            '       Order By ' || Replace(v_Sort, 'X.', 'D.') || ') E';
  --分页查询
  v_Sql := 'Select Xmlelement("OUTPUT",Xmlelement("XMLIST",Xmlagg(Xmlelement("ITEM", Xmlattributes(''true'' As "jsonArray"), Xmlforest(' ||
           Replace(v_Xmlfileds, 'X.', 'F.') || ')))))' || Chr(10) || '       From (' || v_Sql || ') F ';
  If n_Cur_Page > 0 And n_Pagesize > 0 Then
    v_Sql := v_Sql || '  Where F.Rn Between :11 And :12';
  Else
    --从1开始，防止其中一个不为0
    n_Cur_Page := 0;
    n_Pagesize := 0;
    v_Sql      := v_Sql || '  Where :11=1 And :12=0';
  End If;
  Execute Immediate v_Sql
    Into x_Templet
    Using n_Id, v_Name, v_Code, v_Key || '%', v_Key || '%', '%' || v_Key || '%', v_Cats, v_Optype, n_Sex, n_Serv, n_Pagesize * (n_Cur_Page - 1) + 1, n_Pagesize * n_Cur_Page;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getclinicitem;
/
Create Or Replace Procedure Zl_Third_Getclinicfee
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取诊疗项目目录收费对照
  --入参:Xml_In:
  --<IN>
  --  <ID></ID> //诊疗项目ID
  --  <DISEASECATEGORIES></DISEASECATEGORIES> //诊疗项目类别，多个分类直接拼接，不加分隔符，为Null则自动排除床位和挂号
  --  <ServFor></ServFor> //适用范围限制。Null -所有。0-（不包含1-门诊,2-住院,3-门诊和住院，4-体检），1-门诊（包含3）,2-住院（包含3）,3-门诊和住院,4-体检
  --  <OPTYPE></OPTYPE> //操作类型
  --  <SORT></SORT>//排序字段，为NULL ,则缺省排序字段为诊疗项目ID、收费项目ID。若要对排序字段上添加函数，则必须增加别名前缀X.(必须大写)如：NVL(X.编码,'测试')
  --               //诊疗类别,诊疗项目id,诊疗项目编码,诊疗项目名称,计算单位,收费类别,收费项目id,收费编码,收费名称,是否变价,收费数量,固有对照,从属项目,费用性质,检查部位,
  --               //检查方法,收费方式,适用科室id,病人来源
  --  <PAGENOW></PAGENOW>  //当前页数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --  <PAGESIZE></PAGESIZE>  //记录条数，当PAGESIZE与PAGENOW为空或<1,则返回所有数据。否则返回指定页数的数据
  --</IN>
  --出参:Xml_Out--以类别与编码排序返回分页
  --<OUTPUT>
  --  <XMLIST>
  --    <ITEM jsonArray="true">
  --      <CLB></CLB>   //诊疗类别
  --      <CID></CID>   //诊疗项目id
  --      <CBM></CBM>   //诊疗项目编码
  --      <CMC></CMC>   //诊疗项目名称
  --      <DW></DW>   //诊疗项目计算单位
  --      <FLB></FLB>   //收费类别
  --      <FID></FID>   //收费项目id
  --      <FBM></FBM>   //收费编码
  --      <FMC></FMC>   //收费名称
  --      <VV></VV>   //是否变价
  --      <CM></CM>   //收费数量
  --      <IS></IS>   //检查方法
  --      <FP></FP>   //费用性质
  --      <CP></CP>   //检查部位
  --      <FT></FT>   //收费方式
  --      <UD></UD>   //适用科室id
  --      <PF></PF>   //病人来源
  --      <DJ></DJ>   //单价
  --    </ITEM>
  --  </XMLIST>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Sql       Varchar2(4000);
  n_Id        诊疗项目目录.Id %Type;
  v_Cats      Varchar2(20);
  n_Serv      Number(1);
  v_Optype    诊疗项目目录.操作类型%Type;
  v_Sort      Varchar2(500);
  n_Cur_Page  Number(5);
  n_Pagesize  Number(5);
  v_Xmlfileds Varchar2(1000);
  v_Fileds    Varchar2(1000);
  x_Templet   Xmltype; --模板XML
Begin
  --获取查询参数
  Select Nvl(Max(b.Id), 0), Max(b.Cats), Max(b.Servfor), Max(b.Optype), Max(b.Sortkey), Nvl(Max(b.Pagenow), 0),
         Nvl(Max(b.Pagesize), 0)
  Into n_Id, v_Cats, n_Serv, v_Optype, v_Sort, n_Cur_Page, n_Pagesize
  From Xmltable('$a/IN' Passing Xml_In As "a" Columns ID Number(18) Path 'ID',
                 Cats Varchar2(20) Path 'DISEASECATEGORIES', Servfor Number(1) Path 'ServFor',
                 Optype Varchar2(20) Path 'OPTYPE', Sortkey Varchar2(500) Path 'SORT', Pagenow Number(5) Path 'PAGENOW',
                 Pagesize Number(5) Path 'PAGESIZE') B;
  v_Xmlfileds := 'X.诊疗类别 As "CLB", X.诊疗项目id As "CID", X.诊疗项目编码 As "CBM",' || Chr(10) ||
                 'X.诊疗项目名称 As "CMC",X.计算单位  As "DW", X.收费类别 As "FLB", X.收费项目id As "FID",' || Chr(10) ||
                 'X.收费编码 As "FBM", X.收费名称 As "FMC", X.是否变价 As "VV", X.收费数量 As "FM",' || Chr(10) ||
                 'X.检查方法 As "CM", X.从属项目 As "IS", X.费用性质 As "FP", X.检查部位 As "CP",' || Chr(10) ||
                 'X.收费方式 As "FT", X.适用科室id As "UD", X.病人来源 As "PF",X.单价 As "DJ"';
  v_Fileds    := 'X.诊疗类别,X.诊疗项目id,X.诊疗项目编码,X.诊疗项目名称,X.计算单位,X.收费类别,X.收费项目id,X.收费编码,X.收费名称,X.是否变价,X.收费数量,X.固有对照,X.从属项目,X.费用性质,X.检查部位,X.检查方法,X.收费方式,X.适用科室id,X.病人来源';
  v_Sql       := 'Select b.类别 诊疗类别, b.Id 诊疗项目id, b.编码 诊疗项目编码, b.名称 诊疗项目名称,b.计算单位, c.类别 收费类别, c.Id 收费项目id, c.编码 收费编码, c.名称 收费名称, c.是否变价, a.收费数量,' ||
                 Chr(10) || '       a.固有对照, a.从属项目, a.费用性质, a.检查部位, a.检查方法, a.收费方式, a.适用科室id, a.病人来源' || Chr(10) ||
                 'From 诊疗收费关系 A, 诊疗项目目录 B, 收费项目目录 C' || Chr(10) || 'Where a.诊疗项目id = b.Id And a.收费项目id = c.Id';

  --增加ID选项
  If n_Id <> 0 Then
    v_Sql := v_Sql || ' And a.诊疗项目id=:1';
  Else
    v_Sql := v_Sql || ' And :1=0';
  End If;
  --增加分类限制条件
  If v_Cats Is Not Null Then
    v_Sql := v_Sql || ' And instr(:2,b.类别)>0';
  Else
    v_Sql := v_Sql || ' And :2 Is Null';
  End If;
  --增加适用范围限制
  If n_Serv Is Not Null Then
    If n_Serv = 0 Then
      v_Sql := v_Sql || ' And NVL(b.服务对象,0) =0 And :3 Is Not Null';
    Elsif n_Serv <> 3 And n_Serv <> 4 Then
      v_Sql := v_Sql || ' And (b.服务对象=:3 Or b.服务对象=3)';
    Else
      v_Sql := v_Sql || ' And b.服务对象=:3';
    End If;
  Else
    v_Sql := v_Sql || ' And :3 Is Null';
  End If;
  --增加操作类型条件
  If v_Optype Is Not Null Then
    v_Sql := v_Sql || ' And b.操作类型=:4';
  Else
    v_Sql := v_Sql || ' And :4 Is Null';
  End If;
  --计算单价
  v_Sql := 'Select ' || Replace(v_Fileds, 'X.', 'F.') ||
           ',Decode(Nvl(F.是否变价, 0), 0, LTrim(RTrim(To_Char(Sum(Nvl(G.现价, 0)), ''9999999990.0000''))),Decode(Instr(''4567'', F.收费类别), 0, LTrim(RTrim(To_Char(Sum(Nvl(G.缺省价格, 0)), ''9999999990.0000''))),''时价'')) As 单价 From ( ' ||
           v_Sql || ') F,收费价目 G ' || Chr(10) ||
           'Where F.收费项目id = G.收费细目id(+) And G.执行日期 <= Sysdate And (G.终止日期 > Sysdate Or G.终止日期 Is Null) And G.价格等级 Is Null ' ||
           Chr(10) || 'Group By ' || Replace(v_Fileds, 'X.', 'F.');
  --排序字段
  v_Fileds := v_Fileds || ',X.单价';
  v_Sort   := Nvl(v_Sort, '诊疗项目id,收费项目id');
  v_Sql    := 'Select Rownum Rn, ' || Replace(v_Fileds, 'X.', 'J.') || Chr(10) || 'From (Select ' ||
              Replace(v_Fileds, 'X.', 'H.') || Chr(10) || '       From (' || v_Sql || ') H' || Chr(10) ||
              '       Order By ' || Replace(v_Sort, 'X.', 'H.') || ') J';
  --分页查询
  v_Sql := 'Select Xmlelement("OUTPUT",Xmlelement("XMLIST",Xmlagg(Xmlelement("ITEM", Xmlattributes(''true'' As "jsonArray"), Xmlforest(' ||
           Replace(v_Xmlfileds, 'X.', 'K.') || ')))))' || Chr(10) || '       From (' || v_Sql || ') K ';
  If n_Cur_Page > 0 And n_Pagesize > 0 Then
    v_Sql := v_Sql || '  Where K.Rn Between :5 And :6';
  Else
    n_Cur_Page := 0;
    n_Pagesize := 0;
    v_Sql      := v_Sql || '  Where :5=1 And :6=0';
  End If;
  Execute Immediate v_Sql
    Into x_Templet
    Using n_Id, v_Cats, n_Serv, v_Optype, n_Pagesize * (n_Cur_Page - 1) + 1, n_Pagesize * n_Cur_Page;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getclinicfee;
/
----------------------------------------------------------------------------
--[[2.医保基础]]
----------------------------------------------------------------------------

----------------------------------------------------------------------------
--[[3.病人病案基础]]
----------------------------------------------------------------------------
Create Or Replace Procedure Zl_Third_Patiinfo_Update
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：用于预约中心更新病人信息
  --入参：xml_in
  --<IN>
  -- <REGID>1162695</REGID>   --挂号id
  -- <PATIID>5</PATIID>     --病人ID
  -- <HOME_TEL>3</HOME_TEL>   --家庭电话
  -- <CONTACT_TEL></CONTACT_TEL> --联系人电话
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>
  n_挂号id     病人挂号记录.Id%Type;
  n_病人id     病人信息.病人id%Type;
  v_家庭电话   病人信息.家庭电话%Type;
  v_联系人电话 病人信息.联系人电话%Type;

  v_Error Varchar2(2000);

  Err_Custom Exception;
Begin
  Select Extractvalue(Value(A), 'IN/REGID') As 挂号id, Extractvalue(Value(A), 'IN/PATIID') As 病人id,
         Extractvalue(Value(A), 'IN/HOME_TEL') As 家庭电话, Extractvalue(Value(A), 'IN/CONTACT_TEL') As 联系人电话
  Into n_挂号id, n_病人id, v_家庭电话, v_联系人电话
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  If n_病人id = 0 Then
    v_Error := '病人ID不允许为空!';
    Raise Err_Custom;
  End If;
  Update 病人信息 Set 家庭电话 = v_家庭电话, 联系人电话 = v_联系人电话 Where 病人id = n_病人id;
  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Custom Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Patiinfo_Update;
/
----------------------------------------------------------------------------
--[[4.费用基础]]
----------------------------------------------------------------------------
Create Or Replace Function Zl_Third_GetPatiID
(
身份证号_IN In 病人信息.身份证号%Type,
姓名_IN     In 病人信息.姓名%Type
)
 Return Number Is
  ---------------------------------------------------------------------------------------------------------------------------
  --功能:根据传入的身份证号返回病人ID
  --参数：
  --  身份证号_IN:病人信息.身份证号
  -- 返回:
  --  n_病人ID:病人信息.病人ID
  -- 规则:
  --  根据传入的病人身份证获取病人ID,如果有多个病人ID,则以最新一次就诊时间为准,如果就诊时间为空,则以最后一次登记时间为准
  --说明:如果找不到病人ID,则病人ID=0
  ----------------------------------------------------------------------------------------------------------------------------
  n_病人ID  病人信息.病人ID%Type;
  v_Temp    varchar2(225);
  v_Err_Msg varchar2(200);
  Err_Item Exception;
Begin
  Begin
    Select 病人ID
    Into n_病人ID
    From (Select 病人ID From 病人信息 Where 身份证号 = 身份证号_IN And 姓名=姓名_IN Order By 就诊时间 Desc, 登记时间 Desc)
    Where rownum < 2;
  Exception
    When Others Then
      n_病人ID := 0;
  End;
  Return n_病人ID;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(Sqlcode, Sqlerrm);
End zl_third_GetPatiID;
/
CREATE OR REPLACE Procedure zl_Third_IsValidPati
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:刷卡合法性检查，非临时卡要检查是否实名认证
  --入参:Xml_In:
  --<IN>
  --   <BRID></BRID>    //病人ID
  --   <KLB></KLB>    //卡类别:可以传卡名称，也可以传卡类别id
  --   <KH></KH>    //卡号
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  -- <FHZT></FHZT>          //返回状态:0-失败;1-成功
  -- <ERROR><MSG>错误信息</MSG></ERROR>  //出错时返回
  --</ OUTPUT>
  
  n_病人id     病人信息.病人ID%Type;
  v_卡类别     医疗卡类别.名称%Type;
  n_卡类别id   病人医疗卡信息.卡类别ID%Type;
  v_卡号       病人医疗卡信息.卡号%Type;
  d_有效时间   病人医疗卡信息.终止使用时间%Type;
  d_挂失时间   病人医疗卡信息.挂失时间%Type;
  n_卡状态     病人医疗卡信息.状态%Type;
  n_启用       医疗卡类别.是否启用%Type;
  n_认证       number(3);
  n_实名制     number(3);
  Err_Custom Exception;
  
  Procedure Get_Errmsg
  (
    Errmsg_In Varchar2,
    Xml_Out   Out Xmltype
  ) Is
    v_Temp Varchar2(4000);
  Begin
    v_Temp  := '<MSG>' || Errmsg_In || '</MSG>';
    v_Temp  := '<ERROR>' || v_Temp || '</ERROR>';
    v_Temp  := '<FHZT>' || 0 || '</FHZT>' || v_Temp;
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
  End;
Begin
  Select to_number(Extractvalue(Value(A), 'IN/BRID')), Extractvalue(Value(A), 'IN/KLB'),
         Extractvalue(Value(A), 'IN/KH')
  Into n_病人id, v_卡类别, v_卡号
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  
  If Nvl(n_病人id, 0) = 0 Then
    Get_Errmsg('病人信息不存在!', Xml_Out);
    Return;
  End if;
  
  If Translate(v_卡类别, '0123456789', '\') is Null Then
    n_卡类别id := To_number(v_卡类别);
  Else
    Select Max(ID) Into n_卡类别id From 医疗卡类别 Where 名称 = v_卡类别;
  End if;
  
  IF v_卡类别 is Not Null Then
    Select Nvl(Max(a.终止使用时间), To_Date('3000-01-01', 'yyyy-mm-dd')), Nvl(Max(a.状态), -1), Nvl(Max(b.是否启用), 0),
           Nvl(Max(a.挂失时间 + Nvl(c.有效天数, 0)), To_Date('3000-01-01', 'yyyy-mm-dd')) As 挂失时间
    Into d_有效时间, n_卡状态, n_启用, d_挂失时间
    From 病人医疗卡信息 a, 医疗卡类别 b, 医疗卡挂失方式 c
    Where a.病人id = n_病人id And a.卡类别id = n_卡类别id And a.卡号 = v_卡号 And b.Id = a.卡类别id And a.挂失方式 = c.名称(+) And Rownum < 2;

    IF n_卡状态 = -1 Then
      Get_Errmsg('当前卡号不是有效卡号!', Xml_Out);
      Return;
    End if;
    
    IF n_启用 = 0 Then
      Get_Errmsg('当前卡类别未启用!', Xml_Out);
      Return;
    End if;
    
    IF n_卡状态 = 1 And d_挂失时间 < sysdate Then
      Get_Errmsg('当前卡号已挂失!', Xml_Out);
      Return;
    End if;
    
    IF n_卡状态 = 2 Then
      Get_Errmsg('当前卡号已停用!', Xml_Out);
      Return;
    End if;
    
    IF d_有效时间 < sysdate Then
      Get_Errmsg('当前卡号已失效!', Xml_Out);
      Return;
    End if;
    
    --临时卡直接返回1
    IF d_有效时间 <> To_Date('3000-01-01', 'yyyy-mm-dd') Then
      Xml_Out := Xmltype('<OUTPUT><FHZT>1</FHZT></OUTPUT>');
      Return;
    End IF;
  End if;
  
  n_实名制 := To_Number(Nvl(zl_GetSysParameter(319), '0'));
  If n_实名制 = 0 Then
    Xml_Out := Xmltype('<OUTPUT><FHZT>1</FHZT></OUTPUT>');
    Return;
  End if;
  
  Select Count(1) Into n_认证 From 病人实名信息 Where 病人id = n_病人id and RowNum < 2;
  IF n_认证 = 0 Then
    Get_Errmsg('病人未实名认证!', Xml_Out);
    Return;
  End if;

  Xml_Out := Xmltype('<OUTPUT><FHZT>1</FHZT></OUTPUT>');
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End zl_Third_IsValidPati;
/
Create Or Replace Procedure Zl_Third_Getdepositbalance
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取病人预交款余额
  --入参:Xml_In:
  --    <IN>
  --        <BRID>病人ID</BRID>
  --        <ZYID>主页ID</ZYID> //住院预交查询时有效:传入主页ID，查询第几次的预交余额
  --        <YJLX>预交类型</YJLX> //1-门诊预交;2-住院预交;0-所有预交
  --              说明:如果预交类型没有传入,则缺省为0,读取门诊和住院预交
  --    </IN>
  --出参:Xml_Out
  --  <OUTPUT>
  --     <YJYE>预交余额</YJYE>
  --     DD如无下列错误结点则说明正确执行
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_病人id   病人信息.病人id%Type;
  n_主页id   病案主页.主页id%Type;
  n_预交类型 病人预交记录.预交类别%Type;
  n_预交余额 病人余额.预交余额%Type;
  n_费用余额 病人余额.费用余额%Type;

  v_Temp    Varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/ZYID'), Extractvalue(Value(A), 'IN/YJLX')
  Into n_病人id, n_主页id, n_预交类型
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '未传入病人ID,无法完成查询!';
    Raise Err_Item;
  End If;

  If Nvl(n_预交类型, 0) = 1 Then
    Select Nvl(Sum(预交余额), 0) - Nvl(Sum(费用余额), 0)
    Into n_预交余额
    From 病人余额
    Where 病人id = n_病人id And 类型 = 1;
  Elsif Nvl(n_预交类型, 0) = 2 Then
    If Nvl(n_主页id, 0) = 0 Then
      Select Nvl(Sum(预交余额), 0) - Nvl(Sum(费用余额), 0)
      Into n_预交余额
      From 病人余额
      Where 病人id = n_病人id And 类型 = 2;
    Else
      Select Nvl(Sum(金额), 0) - Nvl(Sum(冲预交), 0)
      Into n_预交余额
      From 病人预交记录
      Where 病人id = n_病人id And 主页id = n_主页id And 记录性质 In (1, 11) And Nvl(校对标志, 0) = 0;
      Select Nvl(Sum(金额), 0) Into n_费用余额 From 病人未结费用 Where 病人id = n_病人id And 主页id = n_主页id;
      n_预交余额 := n_预交余额 - n_费用余额;
    End If;
  Else
    Select Nvl(Sum(预交余额), 0) - Nvl(Sum(费用余额), 0) Into n_预交余额 From 病人余额 Where 病人id = n_病人id;
  End If;
  If Nvl(n_预交余额, 0) < 0 Then
    n_预交余额 := 0;
  End If;

  v_Temp := '<YJYE>' || n_预交余额 || '</YJYE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getdepositbalance;
/
Create Or Replace Procedure Zl_Third_Swapstaut
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:读取三方支付的状态
  --入参:Xml_In:
  --<IN>
  --        <JYLB>交易类别</JYLB> //支付宝，微信等
  --        <JYLSH>交易流水号</JYLSH>
  --        <BRID>病人ID</BRID>
  --</IN>
  --出参:Xml_Out
  --  <OUT>
  --    <ZT>状态</ZT>  DD0-交易失败,1-交易成功;2-交易正在进行中;3-不存在该交易记录
  --    <JYSJ>交易时间</JYSJ>  DD当状态为1时才返回,否则为空  格式为'YYYY-MM-DD hh24:mi:ss'
  --    <JYID>业务交易ID</JYID>  DD当状态为1时才返回,否则为空   针对挂号和结帐为结帐ID;针对预交为预交ID;针对收费为结算序号
  --    <YWLX>业务类型</YWLX>   DD null-历史数据;1-预交;2-结帐;3-收费;4-挂号
  --    <DJH>单据号</DJH>  DD 多个用逗号分隔  针对挂号为挂号单据号,针对结帐为结帐单据号,针对预交为预交单据号,针对收费为收费单据号


  --  </OUT>
  --------------------------------------------------------------------------------------------------
  v_Temp    Varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML

  v_交易类别   三方交易记录.类别%Type;
  v_交易流水号 三方交易记录.流水号%Type;
  n_病人id     病人预交记录.病人id%Type;

  n_Count    Number(18);
  n_交易id   三方交易记录.业务结算id%Type;
  n_业务类型 三方交易记录.业务类型%Type;
  v_Nos      Varchar2(3000);
  d_交易时间 Date;

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Nvl(Extractvalue(Value(A), 'IN/JYLB'), '-'), Nvl(Extractvalue(Value(A), 'IN/JYLSH'), '-'),
         Nvl(Extractvalue(Value(A), 'IN/BRID'), 0)
  Into v_交易类别, v_交易流水号, n_病人id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Begin
    Select 状态, 交易时间, 业务结算id, 业务类型
    Into n_Count, d_交易时间, n_交易id, n_业务类型
    From 三方交易记录
    Where 类别 = v_交易类别 And 流水号 = v_交易流水号
    For Update Nowait;
  Exception
    When Others Then
      n_Count := -1;
  End;

  If n_Count = -1 Then
    Select Count(1) Into n_Count From 三方交易记录 Where 类别 = v_交易类别 And 流水号 = v_交易流水号;
    If n_Count = 0 Then
      Select Count(1), Max(收款时间), Max(Decode(记录性质, 1, ID, 3, 结算序号, 结帐id)), Max(Mod(记录性质, 10))
      Into n_Count, d_交易时间, n_交易id, n_业务类型
      From 病人预交记录
      Where 记录性质 <> 11 And Nvl(校对标志, 0) <> 1 And 病人id = n_病人id And 交易流水号 = v_交易流水号 And
            卡类别id In (Select ID From 医疗卡类别 Where 名称 = v_交易类别);
      If n_Count = 0 Then
        n_Count := 3;
      Else
        --不存在三方交易记录，但存在病人预交记录，也表示交易成功
        n_Count := 1;
      End If;
    Else
      n_Count := 2;
    End If;
  End If;

  If n_Count = 1 Then
    If n_业务类型 = 1 Then
      Select Max(NO) Into v_Nos From 病人预交记录 Where 记录性质 = 1 And ID = n_交易id;
    Elsif n_业务类型 = 2 Then
      Select Max(NO) Into v_Nos From 病人结帐记录 Where ID = n_交易id;
    Elsif n_业务类型 = 3 Then
      Select f_List2str(Cast(Collect(NO) As t_Strlist))
      Into v_Nos
      From (Select Distinct a.No As NO
             From 门诊费用记录 A, 病人预交记录 B
             Where a.结帐id = b.结帐id And b.结算序号 = n_交易id);
    Elsif n_业务类型 = 4 Then
      Select Max(NO) Into v_Nos From 门诊费用记录 Where 记录性质 = 4 And 结帐id = n_交易id;
    End If;
  End If;

  v_Temp := '<ZT>' || n_Count || '</ZT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<JYSJ>' || To_Char(d_交易时间, 'YYYY-MM-DD hh24:mi:ss') || '</JYSJ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<JYID>' || Nvl(n_交易id, 0) || '</JYID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<YWLX>' || n_业务类型 || '</YWLX>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<DJH>' || Nvl(v_Nos, '') || '</DJH>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Swapstaut;
/
----------------------------------------------------------------------------
--[[5.药品卫材基础]]
----------------------------------------------------------------------------
Create Or Replace Procedure Zl_Third_Getsign
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能：获取输液单信息/查询
  --参数：
  --入参数 Xml_In
  --<IN>
  --  <ID></ID>   --输液配药记录.ID
  --</IN>

  --出参 Xml_Out
  --<OUTPUT>
  --  <YZID></YZID>   --输液配药记录.医嘱ID
  --  <FSH></FSH>   --输液配药记录.发送号
  --  <YQSJ></YQSJ>   --医嘱的要求时间
  --  <PYSJ></PYSJ>   --输液配药记录.配药时间_BAK
  --  <PYR></PYR>   --输液配药记录.配药人_BAK
  --  <PQH></PQH>   --输液配药记录.瓶签号
  --  <PC></PC>   --输液配药记录.配药批次
  --  <PCRQ></PCRQ>   --输液配药记录.执行时间
  --  <BQ></BQ>   --输液配药记录.病人病区id
  --  <XM></XM>   --输液配药记录.姓名
  --  <XB></XB>   --输液配药记录.性别
  --  <NL></NL>   --输液配药记录.年龄
  --  <CH></CH>   --输液配药记录.床号
  --  <ZT></ZT>   --输液配药记录.操作状态(实际数值)
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_Id      输液配药记录.Id%Type;
  x_Templet Xmltype; --模板XML
  v_Temp    Varchar2(32767);

  n_医嘱id     输液配药记录.医嘱id%Type;
  n_发送号     输液配药记录.发送号%Type;
  v_要求时间   输液配药记录.执行时间%Type;
  v_配药时间   输液配药状态.操作时间%Type;
  v_配药人     输液配药状态.操作人员%Type;
  v_瓶签号     输液配药记录.瓶签号%Type;
  n_配药批次   输液配药记录.配药批次%Type;
  v_执行时间   输液配药记录.执行时间%Type;
  n_病人病区id 输液配药记录.病人病区id%Type;
  v_姓名       输液配药记录.姓名%Type;
  v_性别       输液配药记录.性别%Type;
  v_年龄       输液配药记录.年龄%Type;
  v_床号       输液配药记录.床号%Type;
  n_操作状态   输液配药记录.操作状态%Type;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  --获取输液单ID
  Select Extractvalue(Value(A), 'IN/ID') Into n_Id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --获取对应输液单的信息
  Select a.医嘱id, a.发送号, a.执行时间, a.瓶签号, a.配药批次, a.执行时间, a.病人病区id, a.姓名, a.性别, a.年龄, a.床号, a.操作状态

  Into n_医嘱id, n_发送号, v_要求时间, v_瓶签号, n_配药批次, v_执行时间, n_病人病区id, v_姓名, v_性别, v_年龄, v_床号, n_操作状态

  From 输液配药记录 A
  Where a.Id = n_Id;

  Begin
    Select 操作人员, 操作时间
    Into v_配药人, v_配药时间
    From (Select b.操作人员, b.操作时间
           From 输液配药状态 B
           Where b.操作类型 = 4 And b.配药id = n_Id
           Order By b.操作时间 Desc)
    Where Rownum < 2;
  
  Exception
    When Others Then
      v_配药人   := '';
      v_配药时间 := '';
  End;

  v_Temp := '<YZID>' || n_医嘱id || '</YZID>';
  v_Temp := v_Temp || '<FSH>' || n_发送号 || '</FSH>';
  v_Temp := v_Temp || '<YQSJ>' || v_要求时间 || '</YQSJ>';
  v_Temp := v_Temp || '<PYSJ>' || v_配药时间 || '</PYSJ>';
  v_Temp := v_Temp || '<PYR>' || v_配药人 || '</PYR>';
  v_Temp := v_Temp || '<PQH>' || v_瓶签号 || '</PQH>';
  v_Temp := v_Temp || '<PC>' || n_配药批次 || '</PC>';
  v_Temp := v_Temp || '<PCRQ>' || v_执行时间 || '</PCRQ>';
  v_Temp := v_Temp || '<BQ>' || n_病人病区id || '</BQ>';
  v_Temp := v_Temp || '<XM>' || v_姓名 || '</XM>';
  v_Temp := v_Temp || '<XB>' || v_性别 || '</XB>';
  v_Temp := v_Temp || '<NL>' || v_年龄 || '</NL>';
  v_Temp := v_Temp || '<CH>' || v_床号 || '</CH>';
  v_Temp := v_Temp || '<ZT>' || n_操作状态 || '</ZT>';

  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getsign;
/
Create Or Replace Procedure Zl_Third_Signedit
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能：签收/拒收  /写入
  --参数：
  --入参数 Xml_In
  --<IN>
  --  <TYPE>1</TYPE>   --1：签收；0：拒收
  --  <YZID>1162695</YZID>   --医嘱id
  --  <FSH>202704</FSH>   --发送号
  --  <YQSJ>2017-12-05 10:00:00</YQSJ>   --要求时间
  --  <CZY></CZY>   --操作员
  --  <CZSJ>2017-12-05 16:26:54</CZSJ>   --操作时间
  --  <JSYY><JSYY>   --拒收原因，拒收时可传入
  --</IN>

  --出参 Xml_Out
  --成功：
  --<OUTPUT>
  --  <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --  <RESULT>false</RESULT>
  --  <ERROR>
  --    <MSG>详细错误提示</MSG>
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  n_签收     输液配药记录.操作状态%Type;
  n_医嘱id   输液配药记录.医嘱id%Type;
  n_发送号   输液配药记录.发送号%Type;
  v_要求时间 Varchar2(2000);
  v_操作人员 输液配药记录.操作人员%Type;
  v_操作时间 Varchar2(2000);
  v_拒收原因 Varchar2(2000);

  x_Templet Xmltype; --模板XML
  v_Temp    Varchar2(32767);
  Err_Custom Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/TYPE'), Extractvalue(Value(A), 'IN/YZID'), Extractvalue(Value(A), 'IN/FSH'),
         Extractvalue(Value(A), 'IN/YQSJ'), Extractvalue(Value(A), 'IN/CZY'), Extractvalue(Value(A), 'CZSJ'),
         Extractvalue(Value(A), 'JSYY')
  Into n_签收, n_医嘱id, n_发送号, v_要求时间, v_操作人员, v_操作时间, v_拒收原因
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --根据签收状态来更新输液配记录
  For r_Bill In (Select ID, 操作状态
                 From 输液配药记录
                 Where 医嘱id = n_医嘱id And 发送号 = n_发送号 And 执行时间 = To_Date(v_要求时间, 'yyyy-mm-dd hh24:mi:ss') And
                       操作人员 = v_操作人员 And 操作时间 = To_Date(v_操作时间, 'yyyy-mm-dd hh24:mi:ss')) Loop
  
    --判断当前单据的状态是否满足签收或拒签
    If r_Bill.操作状态 = 5 Then
      If n_签收 = 1 Then
        Update 输液配药记录
        Set 操作状态 = 6, 操作人员 = v_操作人员, 操作时间 = To_Date(v_操作时间, 'yyyy-mm-dd hh24:mi:ss')
        Where ID = r_Bill.Id;
      
        Insert Into 输液配药状态
          (配药id, 操作类型, 操作人员, 操作时间, 操作说明)
        Values
          (r_Bill.Id, 6, v_操作人员, To_Date(v_操作时间, 'yyyy-mm-dd hh24:mi:ss'), Null);
      Else
        Update 输液配药记录
        Set 操作状态 = 7, 操作人员 = v_操作人员, 操作时间 = To_Date(v_操作时间, 'yyyy-mm-dd hh24:mi:ss')
        Where ID = r_Bill.Id;
      
        Insert Into 输液配药状态
          (配药id, 操作类型, 操作人员, 操作时间, 操作说明)
        Values
          (r_Bill.Id, 7, v_操作人员, To_Date(v_操作时间, 'yyyy-mm-dd hh24:mi:ss'), v_拒收原因);
      End If;
    Else
      Raise Err_Custom;
    End If;
  End Loop;

  v_Temp := '<RESULT>' || 'true' || '</RESULT>';

  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Err_Custom Then
    v_Temp := '<RESULT>' || 'false' || '</RESULT>';
    v_Temp := v_Temp || '<ERROR><MSG>' || '当前输液单状态不允许签收或拒签！' || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
  When Others Then
    v_Temp := '<RESULT>' || 'false' || '</RESULT>';
    v_Temp := v_Temp || '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Signedit;
/
Create Or Replace Procedure Zl_Third_Signedit_Cancel
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能：取消签收/取消拒收  /写入
  --参数：
  --入参数 Xml_In
  --<IN>
  --  <TYPE>1</TYPE>   --1：取消签收；0：取消拒收
  --  <YZID>1162695</YZID>   --医嘱id
  --  <FSH>202704</FSH>   --发送号
  --  <YQSJ>2017-12-05 10:00:00</YQSJ>   --要求时间
  --  <CZY></CZY>   --操作员
  --  <CZSJ>2017-12-05 16:26:54</CZSJ>   --操作时间
  --</IN>

  --出参 Xml_Out
  --成功：
  --<OUTPUT>
  --  <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --  <RESULT>false</RESULT>
  --  <ERROR>
  --    <MSG>详细错误提示</MSG>
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  n_签收     输液配药记录.操作状态%Type;
  n_医嘱id   输液配药记录.医嘱id%Type;
  n_发送号   输液配药记录.发送号%Type;
  v_要求时间 Varchar2(2000);
  v_操作人员 输液配药记录.操作人员%Type;
  v_操作时间 Varchar2(2000);

  x_Templet Xmltype; --模板XML
  v_Temp    Varchar2(32767);
  v_Error   Varchar2(255);
  Err_Custom Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/TYPE'), Extractvalue(Value(A), 'IN/YZID'), Extractvalue(Value(A), 'IN/FSH'),
         Extractvalue(Value(A), 'IN/YQSJ'), Extractvalue(Value(A), 'IN/CZY'), Extractvalue(Value(A), 'CZSJ')
  Into n_签收, n_医嘱id, n_发送号, v_要求时间, v_操作人员, v_操作时间
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --根据传入类型来回退输液配记录的操作状态
  For r_Bill In (Select ID, 操作状态
                 From 输液配药记录
                 Where 医嘱id = n_医嘱id And 发送号 = n_发送号 And 执行时间 = To_Date(v_要求时间, 'yyyy-mm-dd hh24:mi:ss') And
                       操作人员 = v_操作人员 And 操作时间 = To_Date(v_操作时间, 'yyyy-mm-dd hh24:mi:ss')) Loop
  
    If n_签收 = 1 Then
      If r_Bill.操作状态 = 6 Then
        --更新记录
        Update 输液配药记录
        Set 操作状态 = 5, 操作人员 = v_操作人员, 操作时间 = To_Date(v_操作时间, 'yyyy-mm-dd hh24:mi:ss')
        Where ID = r_Bill.Id;
      
        Insert Into 输液配药状态
          (配药id, 操作类型, 操作人员, 操作时间, 操作说明)
        Values
          (r_Bill.Id, 5, v_操作人员, To_Date(v_操作时间, 'yyyy-mm-dd hh24:mi:ss'), '取消签收');
      Else
        v_Error := '当前输液单状态不是签收状态，不能进行取消签收！';
        Raise Err_Custom;
      End If;
    Else
      If r_Bill.操作状态 = 7 Then
        --更新记录
        Update 输液配药记录
        Set 操作状态 = 5, 操作人员 = v_操作人员, 操作时间 = To_Date(v_操作时间, 'yyyy-mm-dd hh24:mi:ss')
        Where ID = r_Bill.Id;
      
        Insert Into 输液配药状态
          (配药id, 操作类型, 操作人员, 操作时间, 操作说明)
        Values
          (r_Bill.Id, 5, v_操作人员, To_Date(v_操作时间, 'yyyy-mm-dd hh24:mi:ss'), '取消拒收');
      Else
        v_Error := '当前输液单状态不是拒签状态，不能进行取消拒收！';
        Raise Err_Custom;
      End If;
    End If;
  
  End Loop;

  v_Temp := '<RESULT>' || 'true' || '</RESULT>';

  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Err_Custom Then
    v_Temp := '<RESULT>' || 'false' || '</RESULT>';
    v_Temp := v_Temp || '<ERROR><MSG>' || v_Error || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
  When Others Then
    v_Temp := '<RESULT>' || 'false' || '</RESULT>';
    v_Temp := v_Temp || '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Signedit_Cancel;
/
Create Or Replace Procedure Zl_Third_Getpivabatch
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取批次信息
  --入参:Xml_In
  --<IN>
  --   <DEPID>88393</DEPID>    //配置中心id
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --   <BATLIST>       //如果为空表示没有找到数据
  --    <BAT>1# </BAT>
  --    <BAT>2# </BAT>
  --    <BAT>3# </BAT>
  --   </BATLIST>
  --   <DEFBAT>默认批次</DEFBAT>
  --   <MSG>提示信息</MSG>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_部门id    Number(18);
  v_Temp      Varchar2(32767); --临时XML
  x_Templet   Xmltype; --模板XML
  d_Exetime   Date;
  d_Starttime Date;
  d_Endtime   Date;
  v_Batch     Varchar2(200);
Begin
  x_Templet := Xmltype('<OUTPUT><BATLIST></BATLIST></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/DEPID') Into n_部门id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  v_Temp := '';
  For r_Reg In (Select Distinct 配药批次
                From 输液配药记录
                Where 部门id = n_部门id And 操作状态 >= 2 And 操作状态 < 5 And 操作时间 > Trunc(Sysdate)) Loop
    v_Temp := '<BAT>' || r_Reg.配药批次 || '</BAT>';
    Select Appendchildxml(x_Templet, '/OUTPUT/BATLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  If v_Temp = '' Then
    v_Temp := '<DEFBAT></DEFBAT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    v_Temp := '<MSG>没有找到有输液单需要发送的批次！</MSG>';
  Else
    d_Exetime := To_Date(Substr(To_Char(Sysdate, 'yyyy-mm-dd hh24:mi'), 12), 'hh24:mi');
    For r_Reg In (Select 批次, 配药时间 From 配药工作批次 Where 启用 = 1 Order By 批次) Loop
      v_Batch     := '';
      d_Starttime := To_Date(Substr(r_Reg.配药时间, 1, Instr(r_Reg.配药时间, '-') - 1), 'hh24:mi');
      d_Endtime   := To_Date(Substr(r_Reg.配药时间, Instr(r_Reg.配药时间, '-') + 1), 'hh24:mi');
    
      If d_Exetime >= d_Starttime And d_Exetime <= d_Endtime Then
        v_Batch := r_Reg.批次 || '#';
        Exit;
      End If;
    End Loop;
    v_Temp := '<DEFBAT>' || v_Batch || '</DEFBAT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    v_Temp := '<MSG></MSG>';
  End If;

  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpivabatch;
/
Create Or Replace Procedure Zl_Third_Getpivadeptid
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取人员对应的配置中心id
  --入参:Xml_In
  --<IN>
  --   <ID>88393</ID>    //人员id
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --   <DEPID>配置中心id</DEPID >
  --   <MSG>提示信息,有内容则提示</MSG>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_人员id  Number(18);
  n_部门id  Number(18);
  v_Temp    Varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/ID') Into n_人员id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select a.部门id
  Into n_部门id
  From 部门人员 A, 部门性质说明 B
  Where a.部门id = b.部门id And b.工作性质 = '配制中心' And a.人员id = n_人员id And Rownum = 1;
  v_Temp := '<DEPID>' || n_部门id || '</DEPID>';

  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<MSG></MSG>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpivadeptid;
/
Create Or Replace Procedure Zl_Third_IsExistPIVAInfu
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:判断当前科室当前批次是否有未发送的输液单，如果有则显示相应数量
  --入参:Xml_In
  --<IN>
  --   <PIVAID>88393</PIVAID>    //配置中心id
  --   <DEPID>88393</DEPID>    //科室id
  --   <BATCH>88393</BATCH>    //批次  
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --<DEPName>科室名称</DEPName>
  --<DEPNO>科室编号</DEPNO>
  --<EXIST> 0 </EXIST>该标签值为0或者1，0表示没有，1表示有
  --<CONT> 0/20 </ CONT>格式表示为已摆药未发送的数量/已发送未签收的数量
  --<MSG>提示信息,有内容则提示</MSG>

  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_科室id       number(18);
  n_配置中心id   number(18);
  n_未发送数量   number(18);
  n_已发送数量   number(18);
  n_count        number(18);
  v_批次         varchar2(200);
  v_编码         varchar2(200);
  v_名称         varchar2(200);
  v_Temp         varchar2(32767); --临时XML
  x_Templet      Xmltype; --模板XML
  v_Err_Msg      varchar2(200);
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  
  Select Extractvalue(Value(A), 'IN/PIVAID'),Extractvalue(Value(A), 'IN/DEPID'),Extractvalue(Value(A), 'IN/BATCH')
  Into n_配置中心id,n_科室id,v_批次
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  
  select count(id) into n_count from 部门表 where id=n_科室id;
  if n_count=0 then
    v_Err_Msg:='未找到对应的科室信息，请重新扫描科室条码！';
    v_Temp :='<DEPNAME></DEPNAME>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp :='<DEPNO></DEPNO>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  else
    select 编码,名称 into v_编码,v_名称 from 部门表 where id=n_科室id;
  
    v_Temp :='<DEPNAME>' ||  v_名称 || '</DEPNAME>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp :='<DEPNO>' ||  v_编码 || '</DEPNO>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    
  end if;
  
  select count(id) into n_未发送数量 from 输液配药记录 where 部门id=n_配置中心id and 病人科室id=n_科室id and 配药批次=v_批次 and 操作状态>=2 and 操作状态<5 and 执行时间 Between Trunc(sysdate) And Trunc(sysdate + 1) - 1 / 24 / 60 / 60;
  select count(id) into n_已发送数量 from 输液配药记录 where 部门id=n_配置中心id and 病人科室id=n_科室id and 配药批次=v_批次 and 操作状态=5 and 执行时间 Between Trunc(sysdate) And Trunc(sysdate + 1) - 1 / 24 / 60 / 60;
  if n_未发送数量=0 then
    v_Temp := '<EXIST>0</EXIST>';  
    if v_Err_Msg='' then
      v_Err_Msg:='当前批次不存在需要发送的输液单！';
    end if;
  else
    v_Temp := '<EXIST>1</EXIST>';
  end if;
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp :='<CONT>' ||  n_已发送数量 || '/' || (n_已发送数量+n_未发送数量) || '</CONT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<MSG>' || v_Err_Msg || '</MSG>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;    
	zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_IsExistPIVAInfu;
/
Create Or Replace Procedure Zl_Third_Sendpivainfu
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:判断当前科室当前批次是否有未发送的输液单，如果有则显示相应数量
  --入参:Xml_In
  --<IN>
  --   <PIVAID>88393</PIVAID>    //配置中心id
  --   <DEPID>88393</DEPID>    //科室id
  --   <BATCH>88393</BATCH>    //批次
  --   <NO>880030093</NO>    //瓶签号
  --   <PERSON>88393</PERSON>    //发送人信息  
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --   <RESULT> 1 </RESULT >  该标签值为0或者1，0表示发送失败，1表示发送成功
  --   <CONT> 已发送数量/总数量</CONT >
  --   <MSG> 提示信息 </MSG> 发送失败的提示信息
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_已发送数量 Number(5);
  n_总数量     Number(5);
  n_Id         Number(18);
  n_科室id     Number(18);
  n_配置中心id Number(18);
  n_操作状态   Number(2);
  v_瓶签号     Varchar2(50);
  v_发送人     Varchar2(100);
  v_批次       Varchar2(20);
  v_Temp       Varchar2(32767); --临时XML
  x_Templet    Xmltype; --模板XML
  v_Err_Msg    Varchar2(200);
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  v_Err_Msg := '';

  Select Extractvalue(Value(A), 'IN/PIVAID'), Extractvalue(Value(A), 'IN/DEPID'), Extractvalue(Value(A), 'IN/BATCH'),
         Extractvalue(Value(A), 'IN/PERSON'), Extractvalue(Value(A), 'IN/NO')
  Into n_配置中心id, n_科室id, v_批次, v_发送人, v_瓶签号
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Count(ID)
  Into n_Id
  From 输液配药记录
  Where 部门id = n_配置中心id And 病人科室id = n_科室id And 配药批次 = v_批次 And 瓶签号 = v_瓶签号 And 操作状态 <> 12 And Rownum = 1;
  If n_Id = 0 Then
    v_Temp    := '<RESULT>0</RESULT>';
    v_Err_Msg := '该输液单不是当前科室当前批次的输液单！';
  Else
    Select ID, 操作状态
    Into n_Id, n_操作状态
    From 输液配药记录
    Where 部门id = n_配置中心id And 病人科室id = n_科室id And 配药批次 = v_批次 And 瓶签号 = v_瓶签号 And 操作状态 <> 12 And Rownum = 1;
    If n_操作状态 >= 5 Then
      v_Temp    := '<RESULT>0</RESULT>';
      v_Err_Msg := '该输液单已经发送！';
    Else
      v_Temp := '<RESULT>1</RESULT>';
    End If;
  End If;
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Zl_输液配药记录_发送(n_Id, v_发送人, Sysdate);
  Select Count(ID)
  Into n_已发送数量
  From 输液配药记录
  Where 部门id = n_配置中心id And 病人科室id = n_科室id And 配药批次 = v_批次 And 操作状态 = 5 And 执行时间 Between Trunc(Sysdate) And
        Trunc(Sysdate + 1) - 1 / 24 / 60 / 60;
  Select Count(ID)
  Into n_总数量
  From 输液配药记录
  Where 部门id = n_配置中心id And 病人科室id = n_科室id And 配药批次 = v_批次 And 操作状态 >= 2 And 操作状态 <= 5 And 执行时间 Between Trunc(Sysdate) And
        Trunc(Sysdate + 1) - 1 / 24 / 60 / 60;
  v_Temp := '<CONT> ' || n_已发送数量 || '/' || n_总数量 || ' </CONT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<MSG>' || v_Err_Msg || '</MSG>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Sendpivainfu;
/
----------------------------------------------------------------------------
--[[6.临床基础]]
----------------------------------------------------------------------------
Create Or Replace Procedure Zl_Third_Getdisease
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：查询诊断疾病目录
  --入参：Xml_In
  --<IN>
  --     <ZDLB></ZDLB>     --诊断类别   0-西医诊断，1-中医诊断
  --     <SRLB></SRLB>     --输入类别   0-根据诊断标准输入，1-根据疾病编码输入
  --     <XBXZ></XBXZ>     --性别限制  男/女  为空则不限制
  --     <SYFW></SYFW>     --适用范围  1-门诊  2-住院  为空则不限制
  --     <QTJBZL></QTJBZL> --其它疾病种类：中医诊断-疾病编码类别；西医诊断-诊断类型  例 ：1、查询损伤中毒编码：Y
  --                                                                                      2、查询病理诊断编码：M,D
  --     <PPWB></PPWB>     --匹配文本
  --     <BRKSID></BRKSID> --病人科室ID
  --     <CZYID></CZYID>   --操作员ID

  --</IN>
  --出参：Xml_Out
  --<OUTPUT>
  --  <DISLIST>诊断疾病目录[数组]
  --    <DIS>
  --      <ID></ID>        --Id
  --      <BM></BM>        --编码
  --      <XH></XH>        --序号
  --      <FM></FM>        --附码
  --      <MC></MC>        --名称
  --      <SM></SM>        --说明
  --      <JM></JM>        --简码
  --      <LXXZ></LXXZ>    --疗效限制   提醒性，疾病可能不能达到这一疗效层次，依次为治愈、好转、未愈。
  --      <SFFM></SFFM>    --是否分娩   为1时表示可以录入分娩信息
  --      <SFBR></SFBR>    --是否病人   缺省为1,0-疾病疗效只能是其他
  --      <JBBM></JBBM>    --疾病编码
  --      <JBID></JBID>    --疾病id
  --      <JBLB></JBLB>    --疾病类别
  --      <ZDID></ZDID>    --诊断id
  --      <ZHLIST>证候名称[数组] 仅中医诊断按根据诊断标准输入时返回
  --        <ZH>
  --          <ZHMC></ZHMC>
  --        </ZH>
  --        ....
  --      </ZHLIST>
  --    </DIS>
  --  </DISLIST>
  --  .....
  --</OUTPUT>

  n_诊断类别 Number;
  n_输入类别 Number;
  v_性别限制 Varchar2(50);
  n_适用范围 Number;

  v_其它疾病种类 Varchar2(200);

  v_匹配文本 Varchar2(4000);

  n_病人科室id Number;
  n_操作员id   Number;

  v_Xtmp     Varchar(5000); --临时XML
  v_证候xtmp Varchar(5000); --临时XML

  x_Templet Xmltype;
Begin
  Select Nvl(To_Number(Extractvalue(Value(A), 'IN/ZDLB')), 0), Nvl(To_Number(Extractvalue(Value(A), 'IN/SRLB')), 0),
         Extractvalue(Value(A), 'IN/XBXZ'), Extractvalue(Value(A), 'IN/QTJBZL'),
         Nvl(To_Number(Extractvalue(Value(A), 'IN/SYFW')), 0), Extractvalue(Value(A), 'IN/PPWB'),
         To_Number(Extractvalue(Value(A), 'IN/BRKSID')), To_Number(Extractvalue(Value(A), 'IN/CZYID'))
  Into n_诊断类别, n_输入类别, v_性别限制, v_其它疾病种类, n_适用范围, v_匹配文本, n_病人科室id, n_操作员id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --未传其它种类时，默认读取疾病诊断
  If v_其它疾病种类 Is Null Then
    v_其它疾病种类 := '-';
    If n_诊断类别 = 0 Then
      v_其它疾病种类 := 'D';
    Else
      If n_输入类别 <> 0 Then
        v_其它疾病种类 := 'B';
      End If;
    End If;
  End If;

  x_Templet := Xmltype('<OUTPUT><DISLIST></DISLIST></OUTPUT>');

  If (n_诊断类别 = 0 Or (n_诊断类别 = 1 And v_其它疾病种类 <> 'Z')) And n_输入类别 = 0 Then
    For R In (Select Distinct a.Id, a.编码, b.序号, b.附码, a.名称, a.说明, a.简码, a.疗效限制, a.分娩, a.是否病人, b.编码 疾病编码, b.Id 疾病id,
                              b.类别 疾病类别, a.诊断id,
                              Decode(a.名称, v_匹配文本, 1, Decode(a.简码, v_匹配文本, 1, Decode(a.编码, v_匹配文本, 1, Null))) As 排序1id,
                              Decode(d.诊断id, Null, Decode(c.诊断id, Null, Null, 2), 1) As 排序2id,
                              Decode(Substr(a.名称, 1, Length(v_匹配文本)), v_匹配文本, 1,
                                      Decode(Substr(a.简码, 1, Length(v_匹配文本)), v_匹配文本, 1,
                                              Decode(Substr(a.编码, 1, Length(v_匹配文本)), v_匹配文本, 1, Null))) As 排序3id
              From (Select a.Id, a.编码, Null 序号, Null 附码, a.名称, a.说明, b.简码, 0 疗效限制, 0 分娩, 0 是否病人, Max(d.疾病id) 疾病id,
                            a.Id 诊断id
                     From 疾病诊断目录 A, 疾病诊断别名 B, 疾病诊断对照 D
                     Where a.Id = b.诊断id And a.Id = d.诊断id(+) And a.类别 = n_诊断类别 + 1 And
                           (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And b.码类 = 1 And
                           (a.编码 Like v_匹配文本 || '%' Or b.名称 Like v_匹配文本 || '%' Or b.简码 Like v_匹配文本 || '%') And
                           (n_适用范围 = 0 Or (Nvl(a.适用范围, 0) = 0 Or a.适用范围 = n_适用范围))
                     Group By a.Id, a.编码, a.名称, a.说明, a.编者, b.简码) A, 疾病编码目录 B, 疾病诊断科室 C, 疾病诊断科室 D
              Where a.疾病id = b.Id(+) And c.诊断id(+) = a.Id And d.诊断id(+) = a.Id And c.科室id(+) = n_病人科室id And
                    d.人员id(+) = n_操作员id
              Order By 排序1id, 排序2id, 排序3id, a.编码) Loop
    
      v_Xtmp := '<DIS>';
      v_Xtmp := v_Xtmp || '<ID>' || r.Id || '</ID>';
      v_Xtmp := v_Xtmp || '<BM>' || r.编码 || '</BM>';
      v_Xtmp := v_Xtmp || '<XH>' || r.序号 || '</XH>';
      v_Xtmp := v_Xtmp || '<FM>' || r.附码 || '</FM>';
      v_Xtmp := v_Xtmp || '<MC>' || r.名称 || '</MC>';
      v_Xtmp := v_Xtmp || '<SM>' || r.说明 || '</SM>';
      v_Xtmp := v_Xtmp || '<JM>' || r.简码 || '</JM>';
      v_Xtmp := v_Xtmp || '<LXXZ>' || r.疗效限制 || '</LXXZ>';
      v_Xtmp := v_Xtmp || '<SFFM>' || r.分娩 || '</SFFM>';
      v_Xtmp := v_Xtmp || '<SFBR>' || r.是否病人 || '</SFBR>';
      v_Xtmp := v_Xtmp || '<JBBM>' || r.疾病编码 || '</JBBM>';
      v_Xtmp := v_Xtmp || '<JBID>' || r.疾病id || '</JBID>';
      v_Xtmp := v_Xtmp || '<JBLB>' || r.疾病类别 || '</JBLB>';
      v_Xtmp := v_Xtmp || '<ZDID>' || r.诊断id || '</ZDID>';
    
      v_证候xtmp := '';
      If n_诊断类别 = 1 And n_输入类别 = 0 And r.诊断id Is Not Null Then
        For G In (Select Distinct a.证候序号 As ID, a.证候名称 名称
                  From 疾病诊断参考 A, 疾病编码目录 B
                  Where a.证候id = b.Id(+) And a.诊断id = r.诊断id And a.证候名称 Is Not Null
                  Order By a.证候序号) Loop
          v_证候xtmp := v_证候xtmp || '<ZH>';
          v_证候xtmp := v_证候xtmp || '<ZHMC>' || g.名称 || '</ZHMC>';
          v_证候xtmp := v_证候xtmp || '</ZH>';
        End Loop;
      
        v_证候xtmp := '<ZHLIST>' || v_证候xtmp || '</ZHLIST>';
      End If;
      v_Xtmp := v_Xtmp || v_证候xtmp;
    
      v_Xtmp := v_Xtmp || '</DIS>';
    
      Select Appendchildxml(x_Templet, '/OUTPUT/DISLIST', Xmltype(v_Xtmp)) Into x_Templet From Dual;
    End Loop;
  Else
    For R In (Select Distinct a.Id, a.编码, a.序号, a.附码, a.名称, a.说明, a.分类id, a.简码, a.疗效限制, a.分娩, a.是否病人, a.疾病编码, a.疾病id,
                              a.疾病类别, a.诊断id,
                              Decode(a.名称, v_匹配文本, 1, Decode(a.简码, v_匹配文本, 1, Decode(a.编码, v_匹配文本, 1, Null))) As 排序1id,
                              Decode(d.疾病id, Null, Decode(c.疾病id, Null, Null, 2), 1) As 排序2id,
                              Decode(Substr(a.名称, 1, Length(v_匹配文本)), v_匹配文本, 1,
                                      Decode(Substr(a.简码, 1, Length(v_匹配文本)), v_匹配文本, 1,
                                              Decode(Substr(a.编码, 1, Length(v_匹配文本)), v_匹配文本, 1, Null))) As 排序3id
              From (Select a.Id, a.编码, a.序号, a.附码, a.名称, a.说明, a.分类id, a.简码, a.疗效限制, a.分娩, c.是否病人, a.编码 疾病编码, a.Id 疾病id,
                            a.类别 疾病类别, Max(b.诊断id) 诊断id
                     From 疾病编码目录 A, 疾病诊断对照 B, 疾病编码分类 C
                     Where a.Id = b.疾病id(+) And a.分类id = c.Id(+) And Instr(v_其它疾病种类, a.类别) > 0 And
                           (a.编码 Like v_匹配文本 || '%' Or a.名称 Like v_匹配文本 || '%' Or a.简码 Like v_匹配文本 || '%') And
                           (v_性别限制 Is Null Or (a.性别限制 = v_性别限制 Or a.性别限制 Is Null)) And
                           (n_适用范围 = 0 Or (Nvl(a.适用范围, 0) = 0 Or a.适用范围 = n_适用范围)) And
                           (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD'))
                     Group By a.Id, a.编码, a.序号, a.附码, a.名称, a.说明, a.分类id, a.简码, a.疗效限制, a.分娩, a.类别, c.是否病人) A, 疾病编码科室 C,
                   疾病编码科室 D
              Where c.疾病id(+) = a.Id And d.疾病id(+) = a.Id And c.科室id(+) = n_病人科室id And d.人员id(+) = n_操作员id
              Order By 排序1id, 排序2id, 排序3id, a.编码) Loop
      v_Xtmp := '<DIS>';
      v_Xtmp := v_Xtmp || '<ID>' || r.Id || '</ID>';
      v_Xtmp := v_Xtmp || '<BM>' || r.编码 || '</BM>';
      v_Xtmp := v_Xtmp || '<XH>' || r.序号 || '</XH>';
      v_Xtmp := v_Xtmp || '<FM>' || r.附码 || '</FM>';
      v_Xtmp := v_Xtmp || '<MC>' || r.名称 || '</MC>';
      v_Xtmp := v_Xtmp || '<SM>' || r.说明 || '</SM>';
      v_Xtmp := v_Xtmp || '<JM>' || r.简码 || '</JM>';
      v_Xtmp := v_Xtmp || '<LXXZ>' || r.疗效限制 || '</LXXZ>';
      v_Xtmp := v_Xtmp || '<SFFM>' || r.分娩 || '</SFFM>';
      v_Xtmp := v_Xtmp || '<SFBR>' || r.是否病人 || '</SFBR>';
      v_Xtmp := v_Xtmp || '<JBBM>' || r.疾病编码 || '</JBBM>';
      v_Xtmp := v_Xtmp || '<JBID>' || r.疾病id || '</JBID>';
      v_Xtmp := v_Xtmp || '<JBLB>' || r.疾病类别 || '</JBLB>';
      v_Xtmp := v_Xtmp || '<ZDID>' || r.诊断id || '</ZDID>';
      v_Xtmp := v_Xtmp || '</DIS>';
    
      Select Appendchildxml(x_Templet, '/OUTPUT/DISLIST', Xmltype(v_Xtmp)) Into x_Templet From Dual;
    End Loop;
  End If;

  Xml_Out := x_Templet;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getdisease;
/


Create Or Replace Procedure Zl_Third_Updatediag
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：病人诊断更新(支持新增诊断，删除诊断)
  --入参：Xml_In
  --<IN>
  --  <DELLIST>  [数组]：需删除病人诊断记录的列表
  --    <ZD>
  --      <BRID></BRID>   --病人ID
  --      <ZYID></ZYID>   --主页ID
  --      <JLLY></JLLY>   --记录来源
  --      <BLID></BLID>   --病历id
  --      <ZDLX></ZDLX>   --诊断类型  为空时表示所有类型,否则为字符串,如'1,2,3...'
  --      <ZDIDS></ZDIDS> --诊断ids   需要删除的诊断ID串 ,格式为 'ID1,ID2,ID3...'  为空时表示清空病人的诊断
  --    </ZD>....
  --  </DELLIST>

  --  <ADDLIST>  [数组]：需保存的病人诊断记录的列表
  --    <ZD>
  --      <BRID></BRID>       --  病人ID
  --      <ZYID></ZYID>       --  主页ID
  --      <JLYY></JLYY>       --  记录来源   1-病历；2-入院登记；3-首页整理;4-病案
  --      <BLID></BLID>       --  病历ID     当前诊断为病历部分时，指定对应的病历组成ID

  --      <ZDLX></ZDLX>       --  诊断类型   1-西医门诊诊断;2-西医入院诊断;3-西医出院诊断;5-院内感染;6-病理诊断;7-损伤中毒码,8-术前诊断;9-术后诊断;
  --                                         10-并发症;11-中医门诊诊断;12-中医入院诊断;13-中医出院诊断;21-病原学诊断;22-影像学诊断

  --      <JBID></JBID>       --  疾病ID    当按照疾病编码下达诊断时填写
  --      <ZDID></ZDID>       --  诊断ID    当按照诊断标准下达诊断时填写
  --      <ZHID></ZHID>       --  证候ID    中医诊断需要同时进行证候辨别
  --      <ZDMS></ZDMS>       --  诊断描述  诊断的具体文字描述，(编码)+名称，西医缺省为病名，中医则根据征候名和病名结合产生，如“风热感冒”
  --      <CYQK></CYQK>       --  出院情况  只在出院诊断时填写：治愈、好转、未愈、死亡、其他。
  --      <SFWZ></SFWZ>       --  是否未治  只在出院诊断时填写
  --      <SFYZ></SFYZ>       --  是否疑诊  即出现“？”的诊断
  --      <JLRQ></JLRQ>       --  记录日期
  --      <YZID></YZID>       --  医嘱ID  与当前诊断相关联的，用","间隔的医嘱ID串
  --      <ZDCX></ZDCX>       --  诊断次序
  --      <BZ></BZ>           --  备注
  --      <RYBQ></RYBQ>       --  入院病情
  --      <FBSJ></FBSJ>       --  发病时间
  --      <JLR></JLR>         --  记录人
  --      <FMID></FMID>       --  附码ID
  --      <QZS></QZS>         --  前注释
  --      <HZS></HZS>         --  后注释
  --      <BMLB></BMLB>       --  编码类别
  --      <BMXH></BMXH>       --  编码序号
  --      <LRCX></LRCX>       --  录入次序
  --      <ZID></ZID>         --  主ID
  --      <LJJLID></LJJLID>   --  路径记录ID
  --      <LJXZ></LJXZ>       --  路径性质
  --      <MS></MS>           --  模式     新开医嘱导入路径时填写诊断
  --    </ZD>....
  --  </ADDLIST>
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --    <RESULT>true</RESULT>
  --    <DIAGIDS></DIAGIDS>   --保存的诊断ID串
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  n_诊断id  Number;
  v_Diagids Varchar2(500);

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  --处理诊断删除
  For R In (Select To_Number(Extractvalue(Value(A), 'ZD/BRID')) As 病人id,
                   To_Number(Extractvalue(Value(A), 'ZD/ZYID')) As 主页id,
                   To_Number(Extractvalue(Value(A), 'ZD/JLLY')) As 记录来源,
                   To_Number(Extractvalue(Value(A), 'ZD/BLID')) As 病历id, Extractvalue(Value(A), 'ZD/ZDLX') As 诊断类型,
                   Extractvalue(Value(A), 'ZD/ZDIDS') As 诊断ids
            From Table(Xmlsequence(Extract(Xml_In, 'IN/DELLIST/ZD'))) A) Loop
    Zl_病人诊断记录_Delete(r.病人id, r.主页id, r.记录来源, r.病历id, r.诊断类型, r.诊断ids);
  End Loop;

  --处理诊断保存
  For R In (Select To_Number(Extractvalue(Value(A), 'ZD/BRID')) As 病人id,
                   To_Number(Extractvalue(Value(A), 'ZD/ZYID')) As 主页id,
                   To_Number(Extractvalue(Value(A), 'ZD/JLYY')) As 记录来源,
                   To_Number(Extractvalue(Value(A), 'ZD/BLID')) As 病历id, Extractvalue(Value(A), 'ZD/ZDLX') As 诊断类型,
                   To_Number(Extractvalue(Value(A), 'ZD/JBID')) As 疾病id,
                   To_Number(Extractvalue(Value(A), 'ZD/ZDID')) As 诊断id,
                   To_Number(Extractvalue(Value(A), 'ZD/ZHID')) As 证候id, Extractvalue(Value(A), 'ZD/ZDMS') As 诊断描述,
                   Extractvalue(Value(A), 'ZD/CYQK') As 出院情况, To_Number(Extractvalue(Value(A), 'ZD/SFWZ')) As 是否未治,
                   To_Number(Extractvalue(Value(A), 'ZD/SFYZ')) As 是否疑诊,
                   To_Date(Extractvalue(Value(A), 'ZD/JLRQ'), 'YYYY-MM-DD HH24:MI:SS') As 记录日期,
                   To_Number(Extractvalue(Value(A), 'ZD/YZID')) As 医嘱id, Extractvalue(Value(A), 'ZD/ZDCX') As 诊断次序,
                   Extractvalue(Value(A), 'ZD/BZ') As 备注, Extractvalue(Value(A), 'ZD/RYBQ') As 入院病情,
                   To_Date(Extractvalue(Value(A), 'ZD/FBSJ'), 'YYYY-MM-DD HH24:MI:SS') As 发病时间,
                   Extractvalue(Value(A), 'ZD/JLR') As 记录人, To_Number(Extractvalue(Value(A), 'ZD/FMID')) As 附码id,
                   Extractvalue(Value(A), 'ZD/QZS') As 前注释, Extractvalue(Value(A), 'ZD/HZS') As 后注释,
                   Extractvalue(Value(A), 'ZD/BMLB') As 编码类别, Extractvalue(Value(A), 'ZD/BMXH') As 编码序号,
                   Extractvalue(Value(A), 'ZD/LRCX') As 录入次序, Extractvalue(Value(A), 'ZD/ZID') As 主id,
                   Extractvalue(Value(A), 'ZD/LJJLID') As 路径记录id, Extractvalue(Value(A), 'ZD/LJXZ') As 路径性质,
                   Extractvalue(Value(A), 'ZD/MS') As 模式
            From Table(Xmlsequence(Extract(Xml_In, 'IN/ADDLIST/ZD'))) A) Loop
  
    Select 病人诊断记录_Id.Nextval Into n_诊断id From Dual;
    Zl_病人诊断记录_Insert(r.病人id, r.主页id, r.记录来源, r.病历id, r.诊断类型, r.疾病id, r.诊断id, r.证候id, r.诊断描述, r.出院情况, r.是否未治, r.是否疑诊,
                     r.记录日期, r.医嘱id, r.诊断次序, r.备注, r.入院病情, r.发病时间, r.记录人, n_诊断id, r.附码id, r.前注释, r.后注释, r.编码类别, r.编码序号,
                     r.录入次序, r.主id, r.路径记录id, r.路径性质, r.模式);
    v_Diagids := v_Diagids || ',' || n_诊断id;
  End Loop;
  v_Diagids := Substr(v_Diagids, 2);

  Xml_Out := Xmltype('<OUTPUT><DIAGIDS>' || v_Diagids || '</DIAGIDS><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Updatediag;
/



Create Or Replace Procedure Zl_Third_Disregistdelete
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:删除传染病阳性结果反馈单并删除消息
  --入参:Xml_In:
  --  <IN>
  --      <JLID></JLID>       --记录ID        (Number)    疾病阳性记录.id
  --      <YZID></YZID>       --医嘱ID        (Number)    填了写反馈单的医嘱的医嘱ID，如结点<JLID>有值则按该结点删除，否则传入医嘱id按医嘱id进行删除
  --      <CZYXM></CZYXM>     --操作员姓名    (VarChar) 
  --  </IN>
  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT> 
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>
  -------------------------------------------------------------------------------------------------- 
  v_操作员姓名 Varchar2(300);
  n_记录id     Number(18);
  n_医嘱id     Number(18);
  n_Cnt        Number(1);
  v_Err_Msg    Varchar2(200);
  Err_Item Exception;
Begin

  Select To_Number(Extractvalue(Value(A), 'IN/JLID')), Extractvalue(Value(A), 'IN/CZYXM'),
         Extractvalue(Value(A), 'IN/YZID')
  Into n_记录id, v_操作员姓名, n_医嘱id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_记录id, 0) <> 0 Then
    --检查
    For R In (Select a.Id, a.记录状态, a.登记人 From 疾病阳性记录 A Where a.Id = n_记录id) Loop
      If r.登记人 <> v_操作员姓名 Then
        v_Err_Msg := '不允许删除他人的反馈单！';
        Raise Err_Item;
      End If;
      If Nvl(r.记录状态, 0) > 1 Then
        v_Err_Msg := '医生已经处理了该反馈单，不能删除。';
        Raise Err_Item;
      End If;
      n_Cnt := 1;
    End Loop;
  
    If Nvl(n_Cnt, 0) = 0 Then
      v_Err_Msg := '没有查询到反馈单！';
      Raise Err_Item;
    End If;
  
    --保存
    Zl_疾病阳性记录_Delete(n_记录id);
    Delete 业务消息清单 Where 业务标识 = To_Char(n_记录id) And 类型编码 = 'ZLHIS_CIS_032';
  Else
    --检查
    For R In (Select a.Id, a.记录状态, a.登记人 From 疾病阳性记录 A Where a.医嘱id = n_医嘱id) Loop
      If r.登记人 <> v_操作员姓名 Then
        v_Err_Msg := '不允许删除他人的反馈单！';
        Raise Err_Item;
      End If;
      If Nvl(r.记录状态, 0) > 1 Then
        v_Err_Msg := '医生已经处理了该反馈单，不能删除。';
        Raise Err_Item;
      End If;
      --保存
      Zl_疾病阳性记录_Delete(r.Id);
      Delete 业务消息清单 Where 业务标识 = To_Char(r.Id) And 类型编码 = 'ZLHIS_CIS_032';
    End Loop;
  End If;

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Disregistdelete;
/
Create Or Replace Procedure Zl_Third_Advicelisedit
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:LIS系统对接医嘱相关处理
  --入参:Xml_In:
  --  <IN>
  --      <TYPE></TYPE>     --调用类型      (Number)： 1-采集生成条码，2-采集取消条码，
  --                                                   3-完成采集，4-取消采集完成，
  --                                                   5-标本送检，6-标本取消送检，
  --                                                   7-签收登记，8-签收取消登记，
  --                                                   9-标本拒收

  --      <YZIDS></YZIDS>   --医嘱ids       (VarChar) 标本行医嘱ID
  -- 1-采集生成条码，2-采集取消条码
  --      <YBTM></YBTM>     --样本条码      (VarChar)

  -- 3-完成采集，4-取消采集完成，
  --      <CYR></CYR>       --采样人        (VarChar)
  --      <CYSJ></CYSJ>     --采样时间      (DATE)
  --      <WCR></WCR>       --完成人        (VarChar)
  --      <WCSJ></WCSJ>     --完成时间      (DATE)

  -- 5-标本送检，6-标本取消送检，
  --      <SJR></SJR>       --送检人        (VarChar)
  --      <SJSFPH></SJSFPH> --标本发送批号  (Number)

  --7-签收登记，8-签收取消登记，
  --      <JSR></JSR>      --接收人         (VarChar)
  --      <JSSJ></JSSJ>    --接收时间       (DATE)
  --      <JSPC></JSPC>    --接收批次       (Number)

  --9-标本拒收
  --      <ZXSM></ZXSM>    --执行说明       (VarChar)

  --  </IN>
  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_医嘱ids  Varchar2(4000);
  v_相关ids  Varchar2(4000);
  n_Type     Number;
  v_样本条码 病人医嘱发送.样本条码%Type;
  v_采样人   病人医嘱发送.采样人%Type;
  d_采样时间 病人医嘱发送.采样时间%Type;
  v_完成人   病人医嘱发送.完成人%Type;
  d_完成时间 病人医嘱发送.完成时间%Type;
  v_送检人   病人医嘱发送.送检人%Type;
  v_接收人   病人医嘱发送.接收人%Type;
  d_接收时间 病人医嘱发送.接收时间%Type;
  n_接收批次 病人医嘱发送.接收批次%Type;
  v_执行说明 病人医嘱发送.执行说明%Type;

  n_标本发送批号 病人医嘱发送.标本发送批号%Type;

  n_作废停止 Number;

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/TYPE')), Extractvalue(Value(A), 'IN/YZIDS')
  Into n_Type, v_医嘱ids
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select f_List2str(Cast(Collect(To_Char(ID)) As t_Strlist))
  Into v_相关ids
  From (Select Distinct ID
         From 病人医嘱记录
         Where ID In (Select 相关id
                      From 病人医嘱记录
                      Where ID In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist)))));
  --获取采集类医嘱ID
  If n_Type = 3 Or n_Type = 4 Then
    v_医嘱ids := v_相关ids;
  Else
    If v_相关ids Is Not Null Then
      v_医嘱ids := v_医嘱ids || ',' || v_相关ids;
    End If;
  End If;

  If v_医嘱ids Is Null Then
    v_Err_Msg := '无法确定病人医嘱记录,请检查传入项是否完整！';
    Raise Err_Item;
  End If;

  Select Count(1)
  Into n_作废停止
  From 病人医嘱记录
  Where ID In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist))) And 医嘱状态 = 4;

  If n_作废停止 > 0 Then
    v_Err_Msg := '存在已经被作废或停止的医嘱，不能操作。';
    Raise Err_Item;
  End If;

  --      <TYPE></TYPE>     --调用类型      (Number)： 1-采集生成条码，2-采集取消条码，
  --                                                   3-完成采集，4-取消采集完成，
  --                                                   5-标本送检，6-标本取消送检，
  --                                                   7-签收登记，8-签收取消登记，
  --                                                   9-标本拒收

  If n_Type = 1 Then
    --采集生成条码
    Select Extractvalue(Value(A), 'IN/YBTM') Into v_样本条码 From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  
    Update /*+ rule */ 病人医嘱发送
    Set 样本条码 = v_样本条码, 条码打印 = Decode(v_样本条码, Null, Null, 条码打印)
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist)));
  
  Elsif n_Type = 2 Then
    --采集取消条码
    Update /*+ rule */ 病人医嘱发送
    Set 样本条码 = Null, 条码打印 = Null
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist)));
  Elsif n_Type = 3 Then
    --完成采集
    Select Extractvalue(Value(A), 'IN/CYR'), To_Date(Extractvalue(Value(A), 'IN/CYSJ'), 'yyyy-mm-dd hh24:mi:ss'),
           Extractvalue(Value(A), 'IN/WCR'), To_Date(Extractvalue(Value(A), 'IN/WCSJ'), 'yyyy-mm-dd hh24:mi:ss')
    Into v_采样人, d_采样时间, v_完成人, d_完成时间
    From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  
    Update /*+ rule */ 病人医嘱发送
    Set 采样人 = v_采样人, 采样时间 = d_采样时间, 重采标本 = Decode(Nvl(重采标本, 0), 0, Decode(执行状态, 2, 1, 0), 重采标本), 执行说明 = Null, 执行状态 = 1,
        完成人 = v_完成人, 完成时间 = d_完成时间
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist)));
  Elsif n_Type = 4 Then
    --取消采集完成
    Update /*+ rule */ 病人医嘱发送
    Set 采样人 = Null, 采样时间 = Null, 执行状态 = 0, 执行说明 = Null, 完成人 = Null, 完成时间 = Null
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist)));
  Elsif n_Type = 5 Then
    --标本送检
    Select Extractvalue(Value(A), 'IN/SJR'), To_Number(Extractvalue(Value(A), 'IN/SJSFPH'))
    Into v_送检人, n_标本发送批号
    From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  
    Update /*+ rule */ 病人医嘱发送
    Set 标本送出时间 = Decode(标本送出时间, Null, Sysdate, 标本送出时间), 送检人 = v_送检人, 标本发送批号 = n_标本发送批号
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist)));
  Elsif n_Type = 6 Then
    --标本取消送检
    Update /*+ rule */ 病人医嘱发送
    Set 标本送出时间 = Null, 送检人 = Null, 标本发送批号 = Null
    Where 医嘱id In (Select a.Id
                   From 病人医嘱记录 A, (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist))) B
                   Where b.Column_Value In (a.Id, a.相关id));
  
  Elsif n_Type = 7 Then
    --签收登记
    Select Extractvalue(Value(A), 'IN/SJR'), Extractvalue(Value(A), 'IN/JSR'),
           To_Date(Extractvalue(Value(A), 'IN/JSSJ'), 'yyyy-mm-dd hh24:mi:ss'),
           To_Number(Extractvalue(Value(A), 'IN/JSPC'))
    Into v_送检人, v_接收人, d_接收时间, n_接收批次
    From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
    If v_送检人 Is Null Then
      Update 病人医嘱发送
      Set 接收人 = v_接收人, 接收时间 = d_接收时间, 接收批次 = n_接收批次, 重采标本 = Null
      Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist)));
    Else
      Update 病人医嘱发送
      Set 接收人 = v_接收人, 接收时间 = d_接收时间, 接收批次 = n_接收批次, 重采标本 = Null, 送检人 = v_送检人
      Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist)));
    End If;
  
    Update 病人医嘱发送
    Set 执行状态 = 1
    Where 医嘱id In
          (Select ID
           From 病人医嘱记录
           Where ID In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist))) And 相关id Is Null);
  Elsif n_Type = 8 Then
    --签收取消登记
    Update 病人医嘱发送
    Set 接收人 = Null, 接收时间 = Null, 接收批次 = Null
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist)));
  
    Update 病人医嘱发送
    Set 执行状态 = Decode(样本条码, Null, 0, 1)
    Where 医嘱id In
          (Select ID
           From 病人医嘱记录
           Where ID In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist))) And 相关id Is Null);
  
  Elsif n_Type = 9 Then
    --标本拒收
    Select Extractvalue(Value(A), 'IN/ZXSM') Into v_执行说明 From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  
    Update 病人医嘱发送
    Set 执行状态 = 2, 执行说明 = v_执行说明, 采样人 = Null, 采样时间 = Null, 送检人 = Null, 标本送出时间 = Null, 标本发送批号 = Null, 接收人 = Null,
        接收时间 = Null
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱ids) As Zltools.t_Numlist)));
  End If;

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Advicelisedit;
/

Create Or Replace Procedure Zl_Third_Disregistsend
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:生成传染病阳性结果反馈单并发送消息
  --入参:Xml_In: 
  --  <IN> 
  --      <YZID></YZID>       --医嘱ID        (Number)    要填写反馈单的医嘱的医嘱ID
  --      <YSJB></YSJB>       --疑似疾病      (VarChar)   病人的疑似传染病
  --      <FKJG></FKJG>       --反馈结果      (VarChar)   当前填写的反馈结果
  --      <BBMC></BBMC>       --标本名称      (VarChar)   病人检测所用的标本
  --      <DJR></DJR>         --登记人        (VarChar)   当前填写反馈单的操作员
  --      <DJSJ></DJSJ>       --登记时间      (DATE)      当前填写反馈单的时间
  --      <DJKSID></DJKSID>   --登记科室ID    (Number)    当前填写反馈单的科室ID
  --      <SJYS></SJYS>       --送检医生      (VarChar)   让病人前来检查的医生
  --      <SJSJ></SJSJ>       --送检时间      (Date)      标本到达的时间
  --      <SJKSID></SJKSID>   --送检科室ID    (Number)    让病人前来检查的科室ID
  --      <JCSJ></JCSJ>       --检查时间      (Date)      病人的检查时间
  --  </IN> 
  --出参：Xml_Out 
  --<OUTPUT> 
  --   <RESULT>true</RESULT> 
  --   <JBID>1001</JBID>   --疾病ID
  --</OUTPUT> 

  --失败： 
  --<OUTPUT> 
  --   <RESULT>false</RESULT> 
  --   <ERROR> 
  --     <MSG>详细错误提示</MSG> 
  --   </ERROR> 
  --</OUTPUT> 
  -------------------------------------------------------------------------------------------------- 

  n_医嘱id 病人医嘱记录.Id%Type;
  n_病人id 疾病阳性记录.病人id%Type;
  n_主页id 疾病阳性记录.主页id%Type;
  v_挂号单 疾病阳性记录.挂号单%Type;

  v_疑似疾病   疾病阳性记录.传染病名称%Type;
  v_反馈结果   疾病阳性记录.反馈结果%Type;
  v_标本名称   疾病阳性记录.标本名称%Type;
  v_登记人     疾病阳性记录.登记人%Type;
  d_登记时间   疾病阳性记录.登记时间%Type;
  n_登记科室id 疾病阳性记录.登记科室id%Type;
  v_送检医生   疾病阳性记录.送检医生%Type;
  d_送检时间   疾病阳性记录.送检时间%Type;
  n_送检科室id 疾病阳性记录.送检科室id%Type;
  d_检查时间   疾病阳性记录.检查时间%Type;

  n_疾病id 疾病阳性记录.Id%Type;

  d_就诊时间 Date;
  d_Now      Date;
  n_就诊id   Number(18);
  n_场合     Number(3);
  n_病区id   Number(18);
  n_科室id   Number(18);
  v_提醒场合 Varchar2(10);
  v_提醒部门 Varchar2(100);

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/YZID')), Extractvalue(Value(A), 'IN/YSJB'),
         Extractvalue(Value(A), 'IN/FKJG'), Extractvalue(Value(A), 'IN/BBMC'), Extractvalue(Value(A), 'IN/DJR'),
         To_Date(Extractvalue(Value(A), 'IN/DJSJ'), 'yyyy-mm-dd hh24:mi:ss'),
         To_Number(Extractvalue(Value(A), 'IN/DJKSID')), Extractvalue(Value(A), 'IN/SJYS'),
         To_Date(Extractvalue(Value(A), 'IN/SJSJ'), 'yyyy-mm-dd hh24:mi:ss'),
         To_Number(Extractvalue(Value(A), 'IN/SJKSID')),
         To_Date(Extractvalue(Value(A), 'IN/JCSJ'), 'yyyy-mm-dd hh24:mi:ss')
  Into n_医嘱id, v_疑似疾病, v_反馈结果, v_标本名称, v_登记人, d_登记时间, n_登记科室id, v_送检医生, d_送检时间, n_送检科室id, d_检查时间
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --检查
  If Nvl(n_医嘱id, 0) = 0 Then
    v_Err_Msg := '无法确定病人医嘱记录,请检查传入项是否完整！';
    Raise Err_Item;
  End If;

  Select a.病人id, a.主页id, a.挂号单 Into n_病人id, n_主页id, v_挂号单 From 病人医嘱记录 A Where a.Id = n_医嘱id;
  If n_主页id Is Not Null Then
    Select Max(入院日期), Max(出院科室id), Max(当前病区id)
    Into d_就诊时间, n_科室id, n_病区id
    From 病案主页
    Where 病人id = n_病人id And 主页id = n_主页id;
    n_就诊id   := n_主页id;
    n_场合     := 2;
    v_提醒场合 := '0100';
    If n_病区id = n_科室id Then
      v_提醒部门 := n_病区id;
    Else
      v_提醒部门 := n_科室id || ',' || n_病区id;
    End If;
  Else
    Select Max(ID), Max(执行时间), Max(执行部门id)
    Into n_就诊id, d_就诊时间, n_科室id
    From 病人挂号记录
    Where NO = v_挂号单 And 记录性质 = 1 And 记录状态 = 1;
    n_场合     := 1;
    v_提醒场合 := '1000';
    v_提醒部门 := n_科室id;
  End If;

  Select Sysdate Into d_Now From Dual;

  If v_疑似疾病 Is Null Then
    v_Err_Msg := '没有确定疑似疾病。';
    Raise Err_Item;
  End If;

  If v_反馈结果 Is Null Then
    v_Err_Msg := '没有填写反馈结果。';
    Raise Err_Item;
  End If;

  If d_检查时间 Is Null Then
    v_Err_Msg := '没有填写检查时间。';
    Raise Err_Item;
  Else
    If d_就诊时间 Is Not Null Then
      If d_检查时间 < d_就诊时间 Then
        If n_主页id Is Not Null Then
          v_Err_Msg := '检查时间不能小于病人的入院时间。';
        Else
          v_Err_Msg := '检查时间不能小于病人的就诊时间。';
        End If;
        Raise Err_Item;
      End If;
    End If;
  
    If d_检查时间 > d_Now Then
      v_Err_Msg := '检查时间不能大于当前时间。';
      Raise Err_Item;
    End If;
  End If;

  If d_送检时间 Is Not Null Then
    If d_就诊时间 Is Not Null Then
      If d_送检时间 < d_就诊时间 Then
        If n_主页id Is Not Null Then
          v_Err_Msg := '送检时间不能小于病人的入院时间。';
        Else
          v_Err_Msg := '送检时间不能小于病人的就诊时间。';
        End If;
        Raise Err_Item;
      End If;
    End If;
  
    If d_送检时间 > d_Now Then
      v_Err_Msg := '送检时间不能大于当前时间。';
      Raise Err_Item;
    End If;
  End If;

  --保存
  Select 疾病阳性记录_Id.Nextval Into n_疾病id From Dual;

  Zl_疾病阳性检测记录_Insert(n_疾病id, n_病人id, n_主页id, v_挂号单, n_医嘱id, d_送检时间, n_送检科室id, v_送检医生, v_标本名称, v_反馈结果, v_疑似疾病, d_检查时间,
                     d_登记时间, v_登记人, n_登记科室id, 1);

  Zl_业务消息清单_Insert(n_病人id, n_就诊id, n_科室id, n_病区id, n_场合, '有传染病阳性结果。', v_提醒场合, 'ZLHIS_CIS_032', n_疾病id, 3, 0, Sysdate,
                   v_提醒部门);

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT><JBID>' || n_疾病id || '</JBID></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Disregistsend;
/
Create Or Replace Procedure Zl_Third_Getadvicerptread
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取病人医嘱报告的查阅状态
  --入参：Xml_In
  --<IN>
  --     <YZID></YZID>             --医嘱ID(Number)
  --     <LYID></LYID>             --来源ID(Number)
  --</IN>
  --出参：Xml_Out
  --<OUTPUT>
  --         <RESULT>true</RESULT>
  --         <CYZT></CYZT>         --查阅状态(varChar)  出参示例：未出,未读,部分已读,已读
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  n_医嘱id   病人医嘱记录.Id%Type;
  v_来源id   Varchar(50);
  v_查阅状态 Varchar(50);
  v_Xtmp     Varchar(5000); --临时XML
Begin

  Select To_Number(Extractvalue(Value(A), 'IN/YZID')), Extractvalue(Value(A), 'IN/LYID')
  Into n_医嘱id, v_来源id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For R In (Select Max(y.病历id) As 报告id, Max(y.检查报告id) || '' As 检查报告id, Max(y.Risid) As Ris报告id, Max(y.报告id) As Lis报告id,
                   Decode(Max(Nvl(y.查阅状态, 0)), Min(Nvl(y.查阅状态, 0)), Max(Nvl(y.查阅状态, 0)), 2) As 查阅状态
            From 病人医嘱报告 Y, 医嘱报告内容 N
            Where y.报告id = n.Id And n.来源id = v_来源id And Nvl(n.报告状态, 0) = 0 And y.医嘱id = n_医嘱id) Loop
  
    If Nvl(r.报告id, 0) = 0 And Nvl(r.Ris报告id, 0) = 0 And Nvl(r.Lis报告id, 0) = 0 And Nvl(r.检查报告id, '空') = '空' Then
      v_查阅状态 := '未出';
    Else
      If Nvl(r.查阅状态, 0) = 0 Then
        v_查阅状态 := '未读';
      Elsif Nvl(r.查阅状态, 0) = 2 Then
        v_查阅状态 := '部分已读';
      Else
        v_查阅状态 := '已读';
      End If;
    End If;
    v_Xtmp := '<OUTPUT><RESULT>true</RESULT>';
    v_Xtmp := v_Xtmp || '<YZID>' || n_医嘱id || '</YZID>';
    v_Xtmp := v_Xtmp || '<CYZT>' || v_查阅状态 || '</CYZT>';
    v_Xtmp := v_Xtmp || '<BGID>' || r.报告id || '</BGID>';
    v_Xtmp := v_Xtmp || '<JCBGID>' || r.检查报告id || '</JCBGID>';
    v_Xtmp := v_Xtmp || '<RISBGID>' || r.Ris报告id || '</RISBGID>';
    v_Xtmp := v_Xtmp || '<LISBGID>' || r.Lis报告id || '</LISBGID>';
    v_Xtmp := v_Xtmp || '</OUTPUT>';
  End Loop;

  If v_Xtmp Is Not Null Then
    Xml_Out := Xmltype(v_Xtmp);
  End If;
Exception
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getadvicerptread;
/
Create Or Replace Procedure Zl_Third_Applypathology
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:病人生成医嘱发送医嘱(病理系统)
  --入参:Xml_In:
  --  <IN>
  --   <YZXX> 医嘱信息
  --      <BRID></BRID>         --病人id
  --      <JZID></JZID>         --就诊id   门诊=挂号ID|住院=主页ID
  --      <BRLY></BRLY>         --病人来源 1-门诊;2-住院;3-外来(今后用于辅诊部门接收外来病人);4-体检病人
  --      <JJBZ></JJBZ>         --紧急标志
  --      <ZLXMID></ZLXMID>     --诊疗项目id
  --      <ZLXMMC></ZLXMMC>     --诊疗项目名称
  --      <KZKSID</KZKSID>      --申请科室ID
  --      <KZSJ</KZSJ>          --申请时间
  --      <KZYS</KZYS>          --申请医生
  --      <ZXKSID</ZXKSID>      --执行科室ID
  --      <YZID></YZID>         --医嘱ID: 发送医嘱标识为2时传入待发送的医嘱ID
  --      <FSYZBS</FSYZBS>      --发送医嘱标识 1-保存医嘱，2-发送医嘱，3-保存并发送医嘱。
  --      <FSSFBS</FSSFBS>      --住院医嘱发送收费标识 0-住院记账单，1-门诊收费单

  --      <QMLX></QMLX>          --签名类型 对应为1-新开,4-作废
  --      <QMGZ></QMGZ>          --签名规则 固定传1
  --      <QMXX></QMXX>          --签名信息
  --      <ZSID></ZSID>          --证书id
  --      <SJC></SJC>            --时间戳  日期类型格式：2017-12-21 16:14:12
  --      <SJCXX></SJCXX>        --时间戳信息

  ------检查相关的
  --      <BWFFALL></BWFFALL>方法部位总述格式: 部位1(方法1),部位2(方法2,方法3),...  逗号为半角
  --                      如：胆囊和胆道(收缩功能检查),输卵管(超声造影),腹部的测试(膀胱余尿测定,常规)
  --      <BWLIST>             --检查方法部位列表详情数组
  --        <BWFF>             --检查方法部位列表详情
  --          <BW>颅骨</BW>    --部位
  --          <FF>平扫</FF>    --方法
  --        </BWFF>
  --       <BWFF>
  --       ....
  --       </BWFF>
  --    </BWLIST>

  --   </YZXX>
  --  </IN>

  --出参:Xml_Out，生成的医嘱ID，发送号，错误信息
  --  <OUTPUT>
  --    <YZID></YZID>     医嘱ID
  --    <FSH></FSH>      发送号
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------
  n_病人id   病人医嘱记录.病人id%Type;
  n_病人来源 Varchar(5); --患者来源|1-门诊;2-住院;3-外来;4-体检
  n_就诊id   Varchar2(30);
  v_挂号单   病人医嘱记录.挂号单%Type;

  --项目信息
  v_诊疗项目id   Varchar2(30);
  v_诊疗项目名称 诊疗项目目录.名称%Type;
  n_执行科室id   部门表.Id%Type;
  n_紧急标志     病人医嘱记录.紧急标志%Type;
  n_申请科室id   部门表.Id%Type;
  v_申请时间     Varchar2(30);
  v_申请医生     病人医嘱记录.开嘱医生%Type;
  n_发送标识     Number;
  n_收费标识     Number;
  v_方法部位总述 Varchar2(4000);

  --中间变量--
  n_医嘱id   病人医嘱记录.Id%Type;
  n_子医嘱id 病人医嘱记录.Id%Type;
  v_医嘱ids  Varchar2(4000);

  n_序号       病人医嘱记录.序号%Type;
  v_操作员编号 人员表.编号%Type;
  v_操作员姓名 人员表.姓名%Type;
  n_发送号     病人医嘱发送.发送号%Type;
  v_No号       病人医嘱发送.No%Type;

  n_签名类型   Number;
  n_签名id     Number;
  n_签名规则   Number;
  v_签名信息   Varchar2(4000);
  d_时间戳     Date;
  n_证书id     Number;
  v_时间戳信息 Varchar2(4000);

  v_Tmp     Varchar(32767);
  v_Temp    Varchar2(4000);
  x_Templet Xmltype;
  x_Tmp     Xmltype;
  x_Par     Xmltype;
  v_Err_Msg Varchar(2000);
  Err_Item Exception;

  Procedure Advicesend_Bl
  (
    Xml_In  In Xmltype,
    Xml_Out Out Xmltype
  ) Is
    --------------------------------------------------------------------------------------------------
    --功能:住院医嘱发送(病理)
    --     外挂接口，医保接口，记帐报警，电子签名等功能失效。
    --入参:Xml_In:
    --  <IN>
    --  <BRID></BRID>病人ID
    --  <JZID></JZID>就诊ID
    --  <CZYXM></CZYXM> 操作员姓名
    --  <CZYBH></CZYBH> 操作员编号
    --  <YZID></YZID>医嘱ID
    --  <FSSFBS></FSSFBS>住院医嘱发送收费标识 0-住院记账单，1-门诊收费单
    --  </IN>
  
    --出参:Xml_Out
    --  <OUTPUT>
    --    <ERROR>
    --      <MSG>错误信息</MSG>
    --    </ERROR>
    --  </OUTPUT>
    --------------------------------------------------------------------------------------------------
  
    --自定义类型
    --动态游标类型
    Type Rs_Recordset Is Ref Cursor;
  
    --医嘱表格类型
    Type r_Advice Is Record(
      选择          Number,
      婴儿          Number,
      医嘱内容      Varchar2(4000),
      总量          Number(16, 5),
      总量单位      Varchar2(500),
      单量          Number(16, 5),
      单量单位      Varchar2(500),
      金额          Number(16, 5),
      金额_Data     Number(16, 5),
      频率          Varchar2(500),
      频率_Data     Varchar2(500),
      用法          Varchar2(500),
      医生嘱托      Varchar2(500),
      医生嘱托_Data Varchar2(500), --摘要
      执行时间      Varchar2(500),
      执行科室      Varchar2(500),
      执行性质      Varchar2(500),
      ID            Number(18),
      Id_Data       Varchar2(4000), --
      主页id        Number(18),
      相关id        Number(18),
      病人科室id    Number(18),
      开嘱科室id    Number(18),
      开嘱医生      Varchar2(500),
      诊疗类别      Varchar2(500),
      诊疗项目id    Number(18),
      标本部位      Varchar2(500),
      检查方法      Varchar2(500),
      执行标记      Varchar2(500),
      计价特性      Number(1),
      执行性质id    Number(18),
      执行科室id    Number(18),
      收费细目id    Number(18),
      频率次数      Number(3),
      频率间隔      Number(3),
      间隔单位      Varchar2(4),
      剂量系数      Varchar2(500),
      住院包装      Varchar2(500),
      住院单位      Varchar2(500),
      可否分零      Number(1),
      库存          Varchar2(500),
      次数          Varchar2(500),
      分解时间      Varchar2(4000),
      分解时间_Data Varchar2(4000),
      首次时间      Varchar2(500),
      末次时间      Varchar2(500),
      签名id        Number(18),
      试管编码      Varchar2(500),
      操作类型      Varchar2(500),
      紧急标志      Varchar2(500),
      零费记帐      Varchar2(500),
      计算方式      Varchar2(500),
      开始时间      Varchar2(500),
      执行安排      Varchar2(500),
      执行分类      Varchar2(500),
      毒理分类      Varchar2(500));
    Type t_Advice Is Table Of r_Advice;
  
    --项目收费对照
    Type r_Price Is Record(
      医嘱id     Number(18),
      相关id     Number(18),
      费用性质   Number(18),
      收费方式   Number(18),
      收费类别   Varchar2(500),
      收费细目id Number(18),
      执行科室id Number(18),
      数量       Number(16, 5),
      单价       Number(16, 5),
      在用       Number(18),
      变价       Number(18),
      从项       Number(18),
      固定       Number(18));
    Type t_Price Is Table Of r_Price;
  
    Type r_Bill Is Record(
      Key      Varchar2(200),
      NO       Varchar2(30),
      费用序号 Number(18),
      发送序号 Number(18));
    Type t_Bill Is Table Of r_Bill;
  
    Type r_Exec Is Record(
      医嘱id     Number(18),
      发送号     Number(18),
      收费细目id Number(18),
      要求时间   Varchar2(30),
      数量       Number(16, 5),
      费用性质   Number(1));
    Type t_Exec Is Table Of r_Exec;
  
    Type r_Moneynow Is Record(
      医嘱id     Number(18),
      诊疗项目id Number(18),
      收费项目id Number(18),
      试管编码   Varchar2(18),
      样本条码   Varchar2(18),
      收费方式   Number(1),
      收费时间   Varchar2(18),
      执行部门id Number(18));
    Type t_Moneynow Is Table Of r_Moneynow;
  
    Type r_Moneyday Is Record(
      诊疗项目id Number(18),
      收费项目id Number(18),
      执行部门id Number(18),
      收费方式   Number(1),
      执行否     Number(18),
      收费时间   Varchar2(30));
    Type t_Moneyday Is Table Of r_Moneyday;
  
    Type 医嘱计价_Sql Is Record(
      过程名     Number, --1--ZL_病人医嘱计价_Delete ; 2 --ZL_病人医嘱计价_INSERT
      医嘱id     病人医嘱记录.Id%Type,
      收费细目id 病人医嘱计价.收费细目id%Type,
      数量       病人医嘱计价.数量%Type,
      单价       病人医嘱计价.单价%Type,
      从项       病人医嘱计价.从项%Type := Null,
      执行科室id 病人医嘱计价.执行科室id%Type := Null,
      费用性质   病人医嘱计价.费用性质%Type := 0,
      收费方式   病人医嘱计价.收费方式%Type := 0,
      删单行     Number);
    Type t_医嘱计价_Sql Is Table Of 医嘱计价_Sql;
  
    Type 病人费用_Insert Is Record(
      过程名     Number, --1--ZL_门诊划价记录_INSERT;  2--ZL_门诊记帐记录_INSERT
      NO         Varchar2(300),
      序号       住院费用记录.序号%Type,
      病人id     住院费用记录.病人id%Type,
      主页id     住院费用记录.主页id%Type,
      标识号     住院费用记录.标识号%Type,
      姓名       住院费用记录.姓名%Type,
      性别       住院费用记录.性别%Type,
      年龄       住院费用记录.年龄%Type,
      费别       Varchar2(300),
      加班标志   住院费用记录.加班标志%Type,
      病人科室id 住院费用记录.病人科室id%Type,
      开单部门id 住院费用记录.开单部门id%Type,
      开单人     住院费用记录.开单人%Type,
      从属父号   住院费用记录.从属父号%Type,
      收费细目id 住院费用记录.收费细目id%Type,
      收费类别   住院费用记录.收费类别%Type,
      计算单位   住院费用记录.计算单位%Type,
      发药窗口   住院费用记录.发药窗口%Type,
      付数       住院费用记录.付数%Type,
      数次       住院费用记录.数次%Type,
      附加标志   住院费用记录.附加标志%Type,
      执行部门id 住院费用记录.执行部门id%Type,
      价格父号   住院费用记录.价格父号%Type,
      收入项目id 住院费用记录.收入项目id%Type,
      收据费目   住院费用记录.收据费目%Type,
      标准单价   住院费用记录.标准单价%Type,
      应收金额   住院费用记录.应收金额%Type,
      实收金额   住院费用记录.实收金额%Type,
      发生时间   住院费用记录.发生时间%Type,
      登记时间   住院费用记录.登记时间%Type,
      药品摘要   药品收发记录.摘要%Type,
      操作员姓名 住院费用记录.操作员姓名%Type,
      费用摘要   住院费用记录.摘要%Type := Null,
      医嘱序号   住院费用记录.医嘱序号%Type := Null,
      频次       药品收发记录.频次%Type := Null,
      单量       药品收发记录.单量%Type := Null,
      用法       药品收发记录.用法%Type := Null,
      期效       药品收发记录.扣率%Type := Null,
      计价特性   药品收发记录.扣率%Type := Null,
      病人来源   Number := 1,
      保险编码   住院费用记录.保险编码%Type := Null,
      费用类型   住院费用记录.费用类型%Type := Null,
      保险项目否 住院费用记录.保险项目否%Type := Null,
      保险大类id 住院费用记录.保险大类id%Type := Null,
      中药形态   住院费用记录.结论%Type := Null,
      备货材料   Number := 0,
      批次       药品收发记录.批次%Type := Null,
      划价       Number,
      婴儿费     住院费用记录.婴儿费%Type,
      操作员编号 住院费用记录.操作员编号%Type,
      门诊标志   住院费用记录.门诊标志%Type := 2,
      记帐单id   住院费用记录.记帐单id%Type := Null,
      --住院不同
      床号           住院费用记录.床号%Type := 0,
      病区id         住院费用记录.病人病区id%Type := 0,
      科室id         住院费用记录.病人科室id%Type := 0,
      统筹金额       住院费用记录.统筹金额%Type := 0,
      多病人单       住院费用记录.多病人单%Type := Null,
      类别id         药品单据性质.类别id%Type := 0,
      是否急诊       住院费用记录.是否急诊%Type := 0,
      简单记帐       Number := 0,
      医技补临床费用 Number := 0,
      领药部门id     药品收发记录.对方部门id%Type := Null,
      医疗小组id     住院费用记录.医疗小组id%Type := -1,
      付款方式       门诊费用记录.付款方式%Type
      
      );
    Type t_病人费用_Insert Is Table Of 病人费用_Insert;
  
    --自动发料可执行SQL
    Type 处方发料_Sql Is Record(
      Partid   药品收发记录.库房id%Type,
      Bill     药品收发记录.单据%Type,
      NO       药品收发记录.No%Type,
      People   药品收发记录.审核人%Type,
      配药人   药品收发记录.配药人%Type,
      校验人   药品收发记录.填制人%Type,
      发药方式 药品收发记录.发药方式%Type,
      发药时间 药品收发记录.审核日期%Type);
    Type t_处方发料_Sql Is Table Of 处方发料_Sql;
    --医嘱发送记录生成SQL
    Type 医嘱发送_Sql Is Record(
      医嘱id     病人医嘱发送.医嘱id%Type,
      发送号     病人医嘱发送.发送号%Type,
      记录性质   病人医嘱发送.记录性质%Type,
      NO         病人医嘱发送.No%Type,
      记录序号   病人医嘱发送.记录序号%Type,
      发送数次   病人医嘱发送.发送数次%Type,
      首次时间   病人医嘱发送.首次时间%Type,
      末次时间   病人医嘱发送.末次时间%Type,
      发送时间   病人医嘱发送.发送时间%Type,
      执行状态   病人医嘱发送.执行状态%Type,
      执行部门id 病人医嘱发送.执行部门id%Type,
      计费状态   病人医嘱发送.计费状态%Type,
      First      Number := 0,
      样本条码   病人医嘱发送.样本条码%Type := Null,
      操作员编号 人员表.编号%Type := Null,
      操作员姓名 人员表.姓名%Type := Null);
    Type t_医嘱发送_Sql Is Table Of 医嘱发送_Sql;
  
    --医嘱执行计价SQL
    Type 执行计价_Sql Is Record(
      医嘱id     医嘱执行计价.医嘱id%Type,
      发送号     医嘱执行计价.发送号%Type,
      要求时间   医嘱执行计价.要求时间%Type,
      收费细目id 医嘱执行计价.收费细目id%Type,
      数量       医嘱执行计价.数量%Type,
      费用性质   医嘱执行计价.费用性质%Type);
  
    Type t_执行计价_Sql Is Table Of 执行计价_Sql;
  
    --可执行SQL记录
    r_计价     t_医嘱计价_Sql := t_医嘱计价_Sql();
    r_费用     t_病人费用_Insert := t_病人费用_Insert();
    r_发料     t_处方发料_Sql := t_处方发料_Sql();
    r_发送     t_医嘱发送_Sql := t_医嘱发送_Sql();
    r_执行计价 t_执行计价_Sql := t_执行计价_Sql();
  
    --缓存数据
    Vsadvice    t_Advice;
    Rs_Price    t_Price;
    Rs_Bill     t_Bill := t_Bill();
    Rs_Exec     t_Exec;
    Rs_Moneynow t_Moneynow := t_Moneynow();
    Rs_Moneyday t_Moneyday;
  
    --公用的
    Gv_Nodeno         Varchar2(20); --站点,外部传入
    Gn_Decprice       Number := 0; --系统参数
    Gn_Dec            Number := 0;
    Gv_动态费别       Varchar2(4000);
    Gb_从项汇总折扣   Boolean := False;
    Gb_执行前先结算   Boolean := False;
    Gv_住院发送划价单 Varchar2(400); --住院发送划价单
    Gn_消费验证       Number;
    Gb_住院自动发料   Boolean; --住院自动发料
  
    Gn_发送收费标识 Number; --住院医嘱发送收费标识 0-住院记账单，1-门诊收费单
  
    Gn_Type Number := 0;
  
    --过程级的变量
    Mn_病人id     病人信息.病人id%Type;
    Mn_就诊id     病人信息.主页id%Type; --住院为主页ID
    Mv_姓名       病案主页.姓名%Type;
    Mv_性别       病案主页.性别%Type;
    Mv_年龄       病案主页.年龄%Type;
    Mv_操作员编号 人员表.编号%Type;
    Mv_操作员姓名 人员表.姓名%Type;
    Mn_病人病区id 病案主页.当前病区id%Type;
    Mn_病人科室id 病案主页.出院科室id%Type;
    Mn_床号       病案主页.出院病床%Type;
    Mn_标识号     病人信息.住院号%Type; --住院号
  
    Mv_费别       Varchar2(400);
    Mv_医嘱id     Varchar2(4000);
    Mv_Msg        Varchar2(4000);
    Mb_Auto       Boolean := False;
    Mn_Nosequence Number := 0; --单据号序列重新初始
  
    -------------外部直接传入的XML内容-------------
    n_病人id     Number;
    n_就诊id     Number;
    v_Tmp        Varchar2(3000);
    v_操作员姓名 人员表.姓名%Type;
    v_操作员编号 人员表.编号%Type;
    I            Number;
    x_t          Xmltype;
  
    ----------------------子方法区域---------------------
    --获取出错信息
    Function f_Geterrmsg Return Varchar2 Is
    Begin
      Return Mv_Msg;
    End;
  
    --错误处理中心包内部调用
    Procedure p_Errcenter(Msg_In In Varchar2) Is
    Begin
      Mv_Msg := Msg_In;
    End;
  
    --生成真正的NO
    Procedure p_Replacetrueno Is
    
      Type r_No Is Record(
        No_False Varchar2(200),
        No_True  Varchar2(200));
      Type t_No Is Table Of r_No;
      Rsno t_No := t_No();
    
      v_Curno Varchar2(200);
      v_No    Varchar2(200);
      I       Number;
      J       Number;
    Begin
      --发送记录
      For I In 1 .. r_发送.Count Loop
        v_Curno := r_发送(I).No;
        v_No    := Null;
        For J In 1 .. Rsno.Count Loop
          If Rsno(J).No_False = v_Curno Then
            v_No := Rsno(J).No_True;
            Exit;
          End If;
        End Loop;
        If v_No Is Null Then
          If Substr(v_Curno, 1, 2) = '13' Then
            Select Nextno(13, Null, Null, 1) Into v_No From Dual;
          Else
            Select Nextno(14, Null, Null, 1) Into v_No From Dual;
          End If;
          Rsno.Extend;
          Rsno(Rsno.Count).No_False := v_Curno;
          Rsno(Rsno.Count).No_True := v_No;
        End If;
        r_发送(I).No := v_No;
      End Loop;
    
      --费用记录
      For I In 1 .. r_费用.Count Loop
        v_Curno := r_费用(I).No;
        v_No    := Null;
        For J In 1 .. Rsno.Count Loop
          If Rsno(J).No_False = v_Curno Then
            v_No := Rsno(J).No_True;
            Exit;
          End If;
        End Loop;
        If v_No Is Null Then
          If Substr(v_Curno, 1, 2) = '13' Then
            Select Nextno(13, Null, Null, 1) Into v_No From Dual;
          Else
            Select Nextno(14, Null, Null, 1) Into v_No From Dual;
          End If;
          Rsno.Extend;
          Rsno(Rsno.Count).No_False := v_Curno;
          Rsno(Rsno.Count).No_True := v_No;
        End If;
        r_费用(I).No := v_No;
      End Loop;
    
      --发料
      For I In 1 .. r_发料.Count Loop
        v_Curno := r_发料(I).No;
        v_No    := Null;
        For J In 1 .. Rsno.Count Loop
          If Rsno(J).No_False = v_Curno Then
            v_No := Rsno(J).No_True;
            Exit;
          End If;
        End Loop;
        If v_No Is Null Then
          If Substr(v_Curno, 1, 2) = '13' Then
            Select Nextno(13, Null, Null, 1) Into v_No From Dual;
          Else
            Select Nextno(14, Null, Null, 1) Into v_No From Dual;
          End If;
          Rsno.Extend;
          Rsno(Rsno.Count).No_False := v_Curno;
          Rsno(Rsno.Count).No_True := v_No;
        End If;
        r_发料(I).No := v_No;
      End Loop;
    End;
  
    --获取当前费用单据的NO及序号
    Procedure p_Getcurbillset
    (
      Key_In       In Varchar2,
      费用序号_In  In Number,
      发送序号_In  In Number,
      记帐_In      In Boolean,
      No_Out       Out Varchar2,
      费用序号_Out Out Number,
      发送序号_Out Out Number
    ) Is
      b_Have Boolean;
      n_Tmp  Number;
    Begin
    
      b_Have := False;
      For I In 1 .. Rs_Bill.Count Loop
        If Rs_Bill(I).Key = Key_In Then
          n_Tmp  := I;
          b_Have := True;
          Exit;
        End If;
      End Loop;
    
      If Not b_Have Then
        Rs_Bill.Extend;
        n_Tmp := Rs_Bill.Count;
        Rs_Bill(n_Tmp).Key := Key_In;
        --取单据号
        Mn_Nosequence := Mn_Nosequence + 1;
        If 记帐_In Then
          Rs_Bill(n_Tmp).No := 14;
        Else
          Rs_Bill(n_Tmp).No := 13;
        End If;
        Rs_Bill(n_Tmp).No := Rs_Bill(n_Tmp).No || LPad(Mn_Nosequence, 4, '0');
        If 费用序号_In = -1 Then
          Rs_Bill(n_Tmp).费用序号 := 0;
        Else
          Rs_Bill(n_Tmp).费用序号 := 1;
        End If;
        If 发送序号_In = -1 Then
          Rs_Bill(n_Tmp).发送序号 := 0;
        Else
          Rs_Bill(n_Tmp).发送序号 := 1;
        End If;
      Else
        If 费用序号_In <> -1 Then
          Rs_Bill(n_Tmp).费用序号 := Rs_Bill(n_Tmp).费用序号 + 1;
        End If;
        If 发送序号_In <> -1 Then
          Rs_Bill(n_Tmp).发送序号 := Rs_Bill(n_Tmp).发送序号 + 1;
        End If;
      End If;
    
      No_Out := Rs_Bill(n_Tmp).No;
      If 费用序号_In <> -1 Then
        费用序号_Out := Rs_Bill(n_Tmp).费用序号;
      End If;
      If 发送序号_In <> -1 Then
        发送序号_Out := Rs_Bill(n_Tmp).发送序号;
      End If;
    
    End;
    --获取指定病人某天(dat收费时间)之后医嘱产生的费用项目明细
    Function f_Getpatidaymoneydetail
    (
      病人id_In   In Number,
      主页id_In   In Number,
      收费时间_In In Date
    ) Return Number Is
    
      Cursor c_Detail Is
        Select a.诊疗项目id, c.收费细目id As 收费项目id, c.执行部门id, Decode(Nvl(c.执行状态, 0), 0, 0, 1) As 执行否,
               To_Char(b.首次时间, 'yyyy-mm-dd') As 首次时间, Trunc(b.末次时间) - Trunc(b.首次时间) + 1 As 天数, 0 As 收费方式,
               To_Char(b.末次时间, 'yyyy-mm-dd') As 末次时间, a.频率间隔, a.间隔单位, a.医嘱期效, a.Id, Nvl(a.相关id, 0) As 相关id
        From 病人医嘱记录 A, 病人医嘱发送 B, 住院费用记录 C
        Where a.病人id = 病人id_In And Nvl(a.主页id, 0) = 主页id_In And a.医嘱期效 = 1 And a.Id = b.医嘱id And b.记录性质 = c.记录性质 And
              b.No = c.No And b.医嘱id = c.医嘱序号 And c.记录状态 In (0, 1) And b.末次时间 >= 收费时间_In
        Union
        Select a.诊疗项目id, d.收费细目id, d.执行科室id As 执行部门id, 0 As 执行否, To_Char(b.首次时间, 'yyyy-mm-dd') As 首次时间,
               Trunc(b.末次时间) - Trunc(b.首次时间) + 1 As 天数, -1 As 收费方式, To_Char(b.末次时间, 'yyyy-mm-dd') As 末次时间, a.频率间隔,
               a.间隔单位, a.医嘱期效, a.Id, Nvl(a.相关id, 0) As 相关id
        From 病人医嘱记录 A, 病人医嘱发送 B, 病人医嘱计价 D
        Where a.病人id = 病人id_In And Nvl(a.主页id, 0) = 主页id_In And a.医嘱期效 = 1 And a.Id = b.医嘱id And b.末次时间 >= 收费时间_In And
              a.Id = d.医嘱id And d.收费方式 = 7 And Not Exists
         (Select 1
               From 住院费用记录 C
               Where c.收费细目id = d.收费细目id And b.记录性质 = c.记录性质 And b.No = c.No And a.Id = c.医嘱序号)
        Order By 诊疗项目id, 收费项目id;
    
      Cursor c_Zy Is
        Select a.诊疗项目id, c.收费细目id As 收费项目id, c.执行部门id, Decode(Nvl(c.执行状态, 0), 0, 0, 1) As 执行否,
               To_Char(b.首次时间, 'yyyy-mm-dd') As 首次时间, Trunc(b.末次时间) - Trunc(b.首次时间) + 1 As 天数, 0 As 收费方式,
               To_Char(b.末次时间, 'yyyy-mm-dd') As 末次时间, a.频率间隔, a.间隔单位, a.医嘱期效, a.Id, Nvl(a.相关id, 0) As 相关id
        From 病人医嘱记录 A, 病人医嘱发送 B, 住院费用记录 C
        Where a.病人id = 病人id_In And Nvl(a.主页id, 0) = 主页id_In And a.医嘱期效 = 1 And a.Id = b.医嘱id And b.记录性质 = c.记录性质 And
              b.No = c.No And b.医嘱id = c.医嘱序号 And c.记录状态 In (0, 1) And b.末次时间 >= 收费时间_In
        Union
        Select a.诊疗项目id, d.收费细目id, d.执行科室id As 执行部门id, 0 As 执行否, To_Char(b.首次时间, 'yyyy-mm-dd') As 首次时间,
               Trunc(b.末次时间) - Trunc(b.首次时间) + 1 As 天数, -1 As 收费方式, To_Char(b.末次时间, 'yyyy-mm-dd') As 末次时间, a.频率间隔,
               a.间隔单位, a.医嘱期效, a.Id, Nvl(a.相关id, 0) As 相关id
        From 病人医嘱记录 A, 病人医嘱发送 B, 病人医嘱计价 D
        Where a.病人id = 病人id_In And Nvl(a.主页id, 0) = 主页id_In And a.医嘱期效 = 1 And a.Id = b.医嘱id And b.末次时间 >= 收费时间_In And
              a.Id = d.医嘱id And d.收费方式 = 7 And Not Exists
         (Select 1
               From 住院费用记录 C
               Where c.收费细目id = d.收费细目id And b.记录性质 = c.记录性质 And b.No = c.No And a.Id = c.医嘱序号)
        Order By 诊疗项目id, 收费项目id;
    
      Cursor c_Mz Is
        Select a.诊疗项目id, c.收费细目id As 收费项目id, c.执行部门id, Decode(Nvl(c.执行状态, 0), 0, 0, 1) As 执行否,
               To_Char(b.首次时间, 'yyyy-mm-dd') As 首次时间, Trunc(b.末次时间) - Trunc(b.首次时间) + 1 As 天数, 0 As 收费方式,
               To_Char(b.末次时间, 'yyyy-mm-dd') As 末次时间, a.频率间隔, a.间隔单位, a.医嘱期效, a.Id, Nvl(a.相关id, 0) As 相关id
        From 病人医嘱记录 A, 病人医嘱发送 B, 门诊费用记录 C
        Where a.病人id = 病人id_In And Nvl(a.主页id, 0) = 主页id_In And a.医嘱期效 = 1 And a.Id = b.医嘱id And b.记录性质 = c.记录性质 And
              b.No = c.No And b.医嘱id = c.医嘱序号 And c.记录状态 In (0, 1) And b.末次时间 >= 收费时间_In
        Union
        Select a.诊疗项目id, d.收费细目id, d.执行科室id As 执行部门id, 0 As 执行否, To_Char(b.首次时间, 'yyyy-mm-dd') As 首次时间,
               Trunc(b.末次时间) - Trunc(b.首次时间) + 1 As 天数, -1 As 收费方式, To_Char(b.末次时间, 'yyyy-mm-dd') As 末次时间, a.频率间隔,
               a.间隔单位, a.医嘱期效, a.Id, Nvl(a.相关id, 0) As 相关id
        From 病人医嘱记录 A, 病人医嘱发送 B, 病人医嘱计价 D
        Where a.病人id = 病人id_In And Nvl(a.主页id, 0) = 主页id_In And a.医嘱期效 = 1 And a.Id = b.医嘱id And b.末次时间 >= 收费时间_In And
              a.Id = d.医嘱id And d.收费方式 = 7 And Not Exists
         (Select 1
               From 门诊费用记录 C
               Where c.收费细目id = d.收费细目id And b.记录性质 = c.记录性质 And b.No = c.No And a.Id = c.医嘱序号)
        Order By 诊疗项目id, 收费项目id;
    
      d_Day Date;
    
      n_Tmp Number := 0;
      I     Number;
    
      n_诊疗项目id Number(18);
      n_收费项目id Number(18);
      n_执行部门id Number(18);
      n_执行否     Number(1);
      v_首次时间   Varchar2(18);
      n_天数       Number(3);
      n_收费方式   Number(1);
      v_末次时间   Varchar2(18);
      n_频率间隔   Number(18);
      v_间隔单位   Varchar2(18);
      n_医嘱期效   Number(1);
      n_Id         Number(18);
      n_相关id     Number(18);
    
      Procedure p_Addmoneydayitem Is
      Begin
        n_Tmp := 0;
        For I In 1 .. Rs_Moneyday.Count Loop
          If Rs_Moneyday(I)
           .诊疗项目id = n_诊疗项目id And Rs_Moneyday(I).收费项目id = n_收费项目id And Rs_Moneyday(I)
             .收费时间 = To_Char(d_Day, 'yyyy-MM-dd') And Rs_Moneyday(I).执行否 = n_执行否 And Rs_Moneyday(I).收费方式 = n_收费方式 Then
            n_Tmp := 1;
            Exit;
          End If;
        End Loop;
        If n_Tmp = 0 Then
          Rs_Moneyday.Extend;
          n_Tmp := Rs_Moneyday.Count;
          Rs_Moneyday(n_Tmp).诊疗项目id := n_诊疗项目id;
          Rs_Moneyday(n_Tmp).收费项目id := n_收费项目id;
          Rs_Moneyday(n_Tmp).执行部门id := n_执行部门id;
          Rs_Moneyday(n_Tmp).执行否 := n_执行否;
          Rs_Moneyday(n_Tmp).收费方式 := n_收费方式;
          Rs_Moneyday(n_Tmp).收费时间 := To_Char(d_Day, 'yyyy-MM-dd');
        End If;
      End;
    Begin
    
      If Gn_发送收费标识 = 1 Then
        Open c_Mz;
        Loop
          Fetch c_Mz
            Into n_诊疗项目id, n_收费项目id, n_执行部门id, n_执行否, v_首次时间, n_天数, n_收费方式, v_末次时间, n_频率间隔, v_间隔单位, n_医嘱期效, n_Id, n_相关id;
          Exit When c_Mz%NotFound;
          If n_频率间隔 = 1 And v_间隔单位 = '天' Or v_间隔单位 = '小时' Or v_间隔单位 = '分钟' Then
            For I In 1 .. n_天数 Loop
              If I = 1 Then
                d_Day := To_Date(v_首次时间, 'yyyy-MM-dd');
              Else
                d_Day := To_Date(v_首次时间, 'yyyy-MM-dd') + I - 1;
              End If;
              If d_Day >= 收费时间_In Then
                p_Addmoneydayitem;
              End If;
            End Loop;
          Else
            --对于临嘱这里可能会漏算
            d_Day := To_Date(v_首次时间, 'yyyy-MM-dd');
            If d_Day >= 收费时间_In Then
              p_Addmoneydayitem;
            End If;
            d_Day := To_Date(v_末次时间, 'yyyy-MM-dd');
            If d_Day >= 收费时间_In Then
              p_Addmoneydayitem;
            End If;
          End If;
        End Loop;
        Close c_Mz;
      Else
      
        If Gn_Type = 1 Then
          Open c_Zy;
          Loop
            Fetch c_Zy
              Into n_诊疗项目id, n_收费项目id, n_执行部门id, n_执行否, v_首次时间, n_天数, n_收费方式, v_末次时间, n_频率间隔, v_间隔单位, n_医嘱期效, n_Id,
                   n_相关id;
            Exit When c_Zy%NotFound;
            If n_频率间隔 = 1 And v_间隔单位 = '天' Or v_间隔单位 = '小时' Or v_间隔单位 = '分钟' Then
              For I In 1 .. n_天数 Loop
                If I = 1 Then
                  d_Day := To_Date(v_首次时间, 'yyyy-MM-dd');
                Else
                  d_Day := To_Date(v_首次时间, 'yyyy-MM-dd') + I - 1;
                End If;
                If d_Day >= 收费时间_In Then
                  p_Addmoneydayitem;
                End If;
              End Loop;
            Else
              --对于临嘱这里可能会漏算
              d_Day := To_Date(v_首次时间, 'yyyy-MM-dd');
              If d_Day >= 收费时间_In Then
                p_Addmoneydayitem;
              End If;
              d_Day := To_Date(v_末次时间, 'yyyy-MM-dd');
              If d_Day >= 收费时间_In Then
                p_Addmoneydayitem;
              End If;
            End If;
          End Loop;
          Close c_Zy;
        Else
          Open c_Detail;
          Loop
            Fetch c_Detail
              Into n_诊疗项目id, n_收费项目id, n_执行部门id, n_执行否, v_首次时间, n_天数, n_收费方式, v_末次时间, n_频率间隔, v_间隔单位, n_医嘱期效, n_Id,
                   n_相关id;
            Exit When c_Detail%NotFound;
            If n_频率间隔 = 1 And v_间隔单位 = '天' Or v_间隔单位 = '小时' Or v_间隔单位 = '分钟' Then
              For I In 1 .. n_天数 Loop
                If I = 1 Then
                  d_Day := To_Date(v_首次时间, 'yyyy-MM-dd');
                Else
                  d_Day := To_Date(v_首次时间, 'yyyy-MM-dd') + I - 1;
                End If;
                If d_Day >= 收费时间_In Then
                  p_Addmoneydayitem;
                End If;
              End Loop;
            Else
              --对于临嘱这里可能会漏算
              d_Day := To_Date(v_首次时间, 'yyyy-MM-dd');
              If d_Day >= 收费时间_In Then
                p_Addmoneydayitem;
              End If;
              d_Day := To_Date(v_末次时间, 'yyyy-MM-dd');
              If d_Day >= 收费时间_In Then
                p_Addmoneydayitem;
              End If;
            End If;
          End Loop;
          Close c_Detail;
        End If;
      
      End If;
    
      Return(1);
    End;
  
    --根据管码获取对应的试管材料ID
    Function f_Gettubematerial(编码_In In 采血管类型.编码%Type) Return Number Is
      n_材料id 采血管类型.材料id%Type;
    Begin
      Select Max(材料id) Into n_材料id From 采血管类型 Where 编码 = 编码_In;
      Return(n_材料id);
    End;
  
    --判断指定的医嘱费用是否应该产生
    Function f_Advicemoneymake
    (
      病人id_In     In Number,
      医嘱id_In     In Number,
      诊疗项目id_In In Number,
      收费项目id_In In Number,
      执行部门id_In In Number,
      试管编码_In   In Varchar2,
      收费类别_In   In Varchar2,
      收费方式_In   In Number,
      分解时间_In   In Varchar2,
      总量_In       In Number,
      当前医嘱id_In In Number,
      发送号_In     In Number,
      计价数量_In   In Number,
      计算方式_In   In Number,
      频率_In       In Varchar2,
      单量_In       In Number,
      期效_In       In Number,
      费用性质_In   In Number,
      诊疗类别_In   In Varchar2,
      样本条码_In   In Varchar2,
      费用次数_Out  Out Number
    ) Return Number Is
    
      Type r_Days Is Record(
        收费时间 Varchar2(30),
        存在     Number(1));
      Type t_Days Is Table Of r_Days;
      Rsdays t_Days := t_Days();
    
      Arrtmp      t_Strlist := t_Strlist();
      n_Rtn       Number;
      n_Tmp       Number;
      b_Makemoney Boolean;
      n_材料id    Number;
      n_Cnt存在   Number;
      v_Tmp       Varchar2(30000);
    
      n_数量    Number := 0;
      v_Date    Varchar2(30);
      n_总量tmp Number := 0;
      n_单量tmp Number := 0;
      b_Tmp     Boolean;
    
    Begin
      b_Makemoney  := True;
      费用次数_Out := 1;
      n_Rtn        := 1;
    
      If 收费方式_In = 9 Then
        --自定义
        Null;
      End If;
    
      If 收费方式_In = 0 Then
        --正常收费的，检查在本次发送中、本医嘱中是否被排斥
        For I In 1 .. Rs_Moneynow.Count Loop
          If Rs_Moneynow(I).医嘱id = 医嘱id_In And Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And
              (Rs_Moneynow(I).收费方式 = 5 Or Rs_Moneynow(I).收费方式 = 6) Then
            b_Makemoney := False;
            Exit;
          End If;
        End Loop;
      Elsif 收费方式_In = 1 Then
        --检验试管费用(一次发送只收取一次)
        If 试管编码_In Is Not Null Then
          For I In 1 .. Rs_Moneynow.Count Loop
            If Rs_Moneynow(I).试管编码 = 试管编码_In And Rs_Moneynow(I).样本条码 = 样本条码_In And Rs_Moneynow(I).收费项目id = 收费项目id_In And
                Nvl(Rs_Moneynow(I).收费方式, 0) <> -1 Then
              b_Makemoney := False;
              Exit;
            End If;
          End Loop;
          --只收取试管对应的卫材费用
          If b_Makemoney And 收费类别_In = '4' Then
            n_材料id := f_Gettubematerial(试管编码_In);
            If n_材料id <> 0 And 收费项目id_In <> n_材料id Then
              b_Makemoney := False;
            End If;
          End If;
        End If;
      Elsif 收费方式_In = 2 Then
        --一次发送只收取一次
      
        For I In 1 .. Rs_Moneynow.Count Loop
          If Rs_Moneynow(I)
           .诊疗项目id = 诊疗项目id_In And Rs_Moneynow(I).收费项目id = 收费项目id_In And Nvl(Rs_Moneynow(I).收费方式, 0) <> -1 Then
            b_Makemoney := False;
            Exit;
          End If;
        End Loop;
      Elsif Instr(',3,4,5,6,7,', 收费方式_In) > 0 Then
        --3-当天只收取一次；4-当天未执行收取一次；5-当天只收取一次，排斥其他项目；6-当天未执行收取一次，排斥其他项目
        --正常收费的，检查在本次发送中、本医嘱中是否被排斥
        If 收费方式_In = 7 Then
          For I In 1 .. Rs_Moneynow.Count Loop
            If Rs_Moneynow(I).医嘱id = 医嘱id_In And Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And
                (Rs_Moneynow(I).收费方式 = 5 Or Rs_Moneynow(I).收费方式 = 6) Then
              b_Makemoney := False;
              Exit;
            End If;
          End Loop;
        End If;
      
        If b_Makemoney Then
          v_Tmp := 分解时间_In;
          While v_Tmp Is Not Null Loop
            Rsdays.Extend;
            Rsdays(Rsdays.Count).收费时间 := Substr(v_Tmp, 1, 10);
            Rsdays(Rsdays.Count).存在 := 0;
            v_Tmp := Substr(v_Tmp, 21);
          End Loop;
          --先从本次发送中的找(频率为一天一次且没有收的，判断时当成已收取,以便后续的其他医嘱'首次不收'时不再认为有首次)
          For J In 1 .. Rsdays.Count Loop
            For I In 1 .. Rs_Moneynow.Count Loop
              If Rs_Moneynow(I)
               .收费时间 = Rsdays(J).收费时间 And Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And Rs_Moneynow(I).收费项目id = 收费项目id_In Then
              
                If 收费方式_In = 7 And Nvl(Rs_Moneynow(I).收费方式, 0) <> -1 Then
                  Rsdays(I).存在 := 1;
                  Exit;
                Elsif (收费方式_In = 4 Or 收费方式_In = 6) And Nvl(执行部门id_In, 0) <> 0 And Rs_Moneynow(I).执行部门id = 执行部门id_In Then
                  Rsdays(I).存在 := 1;
                  Exit;
                End If;
              End If;
            End Loop;
          End Loop;
        
          --再从已发送中的找(当天及将来执行的)
          n_Cnt存在 := 0;
          For J In 1 .. Rsdays.Count Loop
            If Rsdays(J).存在 = 0 Then
              n_Cnt存在 := n_Cnt存在 + 1;
              If Rs_Moneyday Is Null Then
                Rs_Moneyday := t_Moneyday();
                n_Tmp       := f_Getpatidaymoneydetail(病人id_In, 0, To_Date(Rsdays(J).收费时间, 'YYYY-MM-DD'));
              End If;
              For J In 1 .. Rsdays.Count Loop
                For I In 1 .. Rs_Moneyday.Count Loop
                  If Rs_Moneyday(I)
                   .收费时间 = Rsdays(J).收费时间 And Rs_Moneyday(I).诊疗项目id = 诊疗项目id_In And Rs_Moneyday(I).收费项目id = 收费项目id_In Then
                  
                    If 收费方式_In = 7 And Nvl(Rs_Moneyday(I).收费方式, 0) <> -1 Then
                      Rsdays(J).存在 := 1;
                      n_Cnt存在 := n_Cnt存在 - 1;
                      Exit;
                    Elsif (收费方式_In = 4 Or 收费方式_In = 6) And Nvl(执行部门id_In, 0) <> 0 And Rs_Moneyday(I).执行部门id = 执行部门id_In Then
                      Rsdays(J).存在 := 1;
                      n_Cnt存在 := n_Cnt存在 - 1;
                      Exit;
                    Else
                      Rsdays(J).存在 := 1;
                      n_Cnt存在 := n_Cnt存在 - 1;
                      Exit;
                    End If;
                  End If;
                End Loop;
              End Loop;
            End If;
          End Loop;
        End If;
      End If;
      --记录到本次发送明细项目记录中
      If Instr(',3,4,5,6,7,', 收费方式_In) > 0 Then
        If 收费方式_In = 7 Then
          If b_Makemoney Then
            --rsDays.Filter = '存在=0' n_Cnt存在 代替   --没收过的那些天(频率为一天一次但未收的当成收过了)，首次不收
            费用次数_Out := 总量_In - n_Cnt存在;
            If 费用次数_Out > 0 Then
              b_Makemoney := True;
            Else
              b_Makemoney := False;
            End If;
          End If;
        Else
          -- rsDays.Filter = '存在=0'
          -- B_makemoney = rsDays.RecordCount > 0
          -- lng费用次数 = rsDays.RecordCount    --一天一次，有多少天要收就有多少次
          费用次数_Out := n_Cnt存在;
          If n_Cnt存在 > 0 Then
            b_Makemoney := True;
          Else
            b_Makemoney := False;
          End If;
          Null;
        End If;
        If b_Makemoney Or 收费方式_In = 7 And 费用次数_Out = 0 Then
          For I In 1 .. Rsdays.Count Loop
            If Rsdays(I).存在 = 0 Then
              Rs_Moneynow.Extend;
              n_Tmp := Rs_Moneynow.Count;
              Rs_Moneynow(n_Tmp).医嘱id := 医嘱id_In;
              Rs_Moneynow(n_Tmp).诊疗项目id := 诊疗项目id_In;
              Rs_Moneynow(n_Tmp).收费项目id := 收费项目id_In;
              Rs_Moneynow(n_Tmp).试管编码 := 试管编码_In;
              Rs_Moneynow(n_Tmp).样本条码 := 样本条码_In;
            
              --首次不收时，如果频率为一天一次，则计算后的费用次数为0,为了让本次后续发送的其他医嘱正确计算首是否收取，需要产生记录，但收费方式特殊记录为-1
              -- rs_MoneyNow(n_tmp).收费方式 := IIF(收费方式_In := 7 And lng费用次数 := 0, -1, 收费方式_In)
              If 收费方式_In = 7 And 费用次数_Out = 0 Then
                Rs_Moneynow(n_Tmp).收费方式 := -1;
              Else
                Rs_Moneynow(n_Tmp).收费方式 := 收费方式_In;
              End If;
              Rs_Moneynow(n_Tmp).收费时间 := Rsdays(I).收费时间;
              Rs_Moneynow(n_Tmp).执行部门id := 执行部门id_In;
            End If;
          End Loop;
        End If;
      Elsif b_Makemoney Then
        Rs_Moneynow.Extend;
        n_Tmp := Rs_Moneynow.Count;
        Rs_Moneynow(n_Tmp).医嘱id := 医嘱id_In;
        Rs_Moneynow(n_Tmp).诊疗项目id := 诊疗项目id_In;
        Rs_Moneynow(n_Tmp).收费项目id := 收费项目id_In;
        Rs_Moneynow(n_Tmp).试管编码 := 试管编码_In;
        Rs_Moneynow(n_Tmp).样本条码 := 样本条码_In;
        Rs_Moneynow(n_Tmp).收费方式 := 收费方式_In;
        If 分解时间_In Is Null Then
          Rs_Moneynow(n_Tmp).收费时间 := Substr(分解时间_In, 1, 10); --yyyy-MM-dd
        Else
          Rs_Moneynow(n_Tmp).收费时间 := Null;
        End If;
        Rs_Moneynow(n_Tmp).执行部门id := 执行部门id_In;
      End If;
    
      --读取医嘱执行计价(除药品卫材医嘱外的才存储)
      If Instr(',5,6,7,', ',' || 诊疗类别_In || ',') = 0 Then
        If 分解时间_In Is Not Null Then
          -- arrTmp = Split(分解时间_In, ',');
          v_Tmp := 分解时间_In;
          While v_Tmp Is Not Null Loop
            Arrtmp.Extend;
            Arrtmp(Arrtmp.Count) := Substr(v_Tmp, 1, 19);
            v_Tmp := Substr(v_Tmp, 21);
          End Loop;
        
          n_总量tmp := 总量_In * 计价数量_In;
          n_单量tmp := 单量_In;
          If 单量_In = 0 Then
            n_单量tmp := 1;
          End If;
          For I In 1 .. Arrtmp.Count Loop
            Rs_Exec.Extend;
            n_Tmp := Rs_Exec.Count;
            Rs_Exec(n_Tmp).医嘱id := 当前医嘱id_In;
            Rs_Exec(n_Tmp).发送号 := 发送号_In;
            Rs_Exec(n_Tmp).要求时间 := Arrtmp(I);
            Rs_Exec(n_Tmp).收费细目id := 收费项目id_In;
            Rs_Exec(n_Tmp).费用性质 := 费用性质_In;
            If b_Makemoney Then
              --卫材也可以输入单量总量
              If 频率_In Is Not Null And
                 ((计算方式_In = 0 Or 计算方式_In = 3) And 总量_In > 0 Or 计算方式_In = 1 Or 计算方式_In = 2 Or 诊疗类别_In = '4') Then
                --计量和计时的需要乘以数次
                If 期效_In = 0 Then
                  --1、长嘱可选频率、持续性、必要时和不定时以单量作为数次。
                  n_数量 := 计价数量_In * n_单量tmp;
                Else
                  --3、临嘱可选频率取单量作为数次，最后一次剩余的数量，例如红外照射治疗，总量80、单量25，每天4次，那么执行登记时，供执行四次，前三次本次数次为25，第四次为80除以25取模=5。
                  If Arrtmp.Count = 1 Then
                    n_数量 := 计价数量_In * 总量_In;
                  Else
                    If I = Arrtmp.Count Then
                      n_数量 := n_总量tmp;
                    Else
                      If n_总量tmp >= n_单量tmp Then
                        n_数量 := 计价数量_In * n_单量tmp;
                      Else
                        n_数量 := n_总量tmp;
                      End If;
                      n_总量tmp := n_总量tmp - n_数量;
                    End If;
                  End If;
                End If;
              Else
                n_数量 := 计价数量_In;
              End If;
              If I <> 1 Then
                v_Date := Substr(Arrtmp(I - 1), 1, 10);
              End If;
              --一次发送收取一次，则只有第一次收取
              If Instr(',1,2,', 收费方式_In) > 0 Then
                If I <> 1 Then
                  n_数量 := 0;
                End If;
              Elsif Instr(',3,4,5,6,', 收费方式_In) > 0 Then
                --3456当天只收取一次的，存在=0的收取，默认第一次有数量
                -- rsDays.Filter = '存在=0 And 收费时间=--' || Format(arrTmp(i), 'yyyy-MM-dd') || '--'
                b_Tmp := False;
                For J In 1 .. Rsdays.Count Loop
                  If Rsdays(J).存在 = 0 And Rsdays(J).收费时间 = Substr(Arrtmp(I), 1, 10) Then
                    b_Tmp := True;
                  End If;
                End Loop;
                If Not (b_Tmp And Substr(Arrtmp(I), 1, 10) <> v_Date) Then
                  n_数量 := 0;
                End If;
              Elsif 收费方式_In = 7 Then
                --当天首次不收取的，存在=1就收取，存在=0的为首次
                --  rsDays.Filter = '存在=1 And 收费时间=--' || Format(arrTmp(i), 'yyyy-MM-dd') || '--'
                b_Tmp := False;
                For J In 1 .. Rsdays.Count Loop
                  If Rsdays(J).存在 = 1 And Rsdays(J).收费时间 = Substr(Arrtmp(I), 1, 10) Then
                    b_Tmp := True;
                  End If;
                End Loop;
                If Not b_Tmp And Substr(Arrtmp(I), 1, 10) <> v_Date Then
                  n_数量 := 0;
                End If;
              End If;
            Else
              --如果不收取，则设置为0
              n_数量 := 0;
            End If;
            Rs_Exec(n_Tmp).数量 := n_数量;
          End Loop;
        End If;
      End If;
      If b_Makemoney Then
        n_Rtn := 1;
      Else
        n_Rtn := 0;
      End If;
      Return(n_Rtn);
    End;
  
    --获取非药收费项目的执行科室
    Function f_Get收费执行科室id Return Number Is
    Begin
      Return(0);
    End;
  
    --根据收费细目ID或收入项目ID(前者优先),应收金额,按费别设置的分段比例打折规则计算实收金额
    Function f_Actualmoney
    (
      费别_In       In Varchar2,
      收入项目id_In In Number,
      应收金额_In   In Number,
      收费细目id_In In Number,
      库房id_In     In Number,
      数量_In       In Number,
      加班加价率_In In Number,
      费别_Out      Out Varchar2
    ) Return Number Is
      n_金额 病人医嘱计价.单价%Type := 0;
      v_Tmp  Varchar2(80);
    Begin
      Select Zl_Actualmoney(费别_In, 收费细目id_In, 收入项目id_In, (应收金额_In / (1 + 加班加价率_In)), 数量_In, 库房id_In) As Actualmoney
      Into v_Tmp
      From Dual;
      费别_Out := Substr(v_Tmp, 1, Instr(v_Tmp, ':') - 1);
      n_金额   := To_Number(Substr(v_Tmp, Instr(v_Tmp, ':') + 1));
      Return(n_金额);
    End;
  
    Function f_Calcdrugprice
    (
      药品id_In In Number,
      药房id_In In Number,
      数量_In   In Number,
      费别_In   In Varchar2
    ) Return Number Is
      n_时价   病人医嘱计价.单价%Type := 0;
      n_总数量 病人医嘱计价.单价%Type := 0;
      v_Tmp    Varchar2(80);
      v_费别   Varchar2(800);
    Begin
      Select Zl_Fun_Getprice(药品id_In, 药房id_In, 数量_In, 0, Null) As 结果 Into v_Tmp From Dual;
      If v_Tmp Is Not Null Then
        v_Tmp    := v_Tmp || '|';
        n_时价   := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1));
        v_Tmp    := Substr(v_Tmp, Instr(v_Tmp, '|') + 1);
        n_总数量 := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1));
      End If;
      If n_总数量 = 0 And 费别_In Is Not Null Then
        n_时价 := Round(n_时价 * 数量_In, Gn_Dec);
        For R In (Select a.屏蔽费别, b.收入项目id
                  From 收费项目目录 A, 收费价目 B
                  Where a.Id = b.收费细目id And a.Id = 药品id_In And
                        ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null))) Loop
          If Not (Nvl(r.屏蔽费别, 0) = 1) Then
            v_费别 := 费别_In;
            If Gv_动态费别 Is Not Null Then
              v_费别 := v_费别 || ',' || Gv_动态费别;
            End If;
            n_时价 := f_Actualmoney(v_费别, r.收入项目id, n_时价, 药品id_In, 药房id_In, 数量_In, 0, v_Tmp);
          End If;
        End Loop;
      End If;
      Return(n_时价);
    End;
  
    --大于指定数的整数
    Function f_Intex(Num_In In Number) Return Number Is
      n_Num Number;
    Begin
      Select Round(Num_In) Into n_Num From Dual;
      If Num_In > n_Num Then
        n_Num := n_Num + 1;
      End If;
      Return(n_Num);
    End;
  
    --分解时间
    Function f_Calc次数分解时间
    (
      次数_In     In 病人医嘱记录.总给予量%Type,
      开始时间_In In Date,
      终止时间_In In Date,
      执行时间_In In 病人医嘱记录.执行时间方案%Type,
      频率间隔_In In 病人医嘱记录.频率间隔%Type,
      间隔单位_In In 病人医嘱记录.间隔单位%Type
    ) Return Varchar2 Is
      v_Detailtime Varchar2(4000);
      n_First      Number(1);
      v_First      病人医嘱记录.执行时间方案%Type;
      v_Normal     病人医嘱记录.执行时间方案%Type;
      v_Mtime      Varchar(100);
      v_Rtime      Varchar(100);
      v_Curtime    Date;
      v_Tmptime    Date;
      n_Cnt        Number; --计数器
      --求某时间所在周的星期一的日期
      Function Getweekbase(v_Time Date) Return Date Is
        v_Week Number(1);
      Begin
        v_Week := To_Number(To_Char(v_Time, 'D'));
        v_Week := v_Week - 1;
        If v_Week = 0 Then
          v_Week := 7;
        End If;
        Return(Trunc(v_Time - (v_Week - 1)));
      End;
    Begin
    
      n_Cnt := 0;
    
      --执行时间方案基准
      If Nvl(Instr(执行时间_In, ','), 0) > 0 Then
        v_First  := Substr(执行时间_In, 1, Instr(执行时间_In, ',') - 1);
        v_Normal := Substr(执行时间_In, Instr(执行时间_In, ',') + 1);
      Else
        v_First  := Null;
        v_Normal := 执行时间_In;
      End If;
    
      If 间隔单位_In = '周' Then
        v_Curtime := Getweekbase(开始时间_In); --按周执行时在医嘱开始那周的星期一作为基准
      Else
        v_Curtime := 开始时间_In;
      End If;
      If 间隔单位_In = '周' Then
        If v_First Is Not Null Then
          If v_Curtime = Getweekbase(开始时间_In) Then
            n_First := 1;
          End If;
        End If;
        While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop
          If Nvl(n_First, 0) = 1 Then
            v_Rtime := v_First || '-';
          Else
            v_Rtime := v_Normal || '-';
          End If;
          n_First := 0;
          --1/8:00-3/8:00-5/8:00
          While v_Rtime Is Not Null Loop
            v_Mtime   := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
            v_Tmptime := v_Curtime + To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, '/') - 1)) - 1;
            v_Mtime   := Substr(v_Mtime, Instr(v_Mtime, '/') + 1);
            If Instr(v_Mtime, ':') = 0 Then
              v_Mtime := v_Mtime || ':00';
            End If;
            v_Tmptime := Trunc(v_Tmptime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
            If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In Then
              v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
              n_Cnt        := n_Cnt + 1;
              If n_Cnt >= 次数_In Then
                Exit;
              End If;
            Elsif v_Tmptime > 终止时间_In Then
              Exit;
            End If;
            v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
          End Loop;
          v_Curtime := Trunc(v_Curtime + 7);
        End Loop;
      Elsif 间隔单位_In = '天' Then
        If v_First Is Not Null Then
          If Trunc(开始时间_In) = Trunc(开始时间_In) Then
            n_First := 1;
          End If;
        End If;
        While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop
          If Nvl(n_First, 0) = 1 Then
            v_Rtime := v_First || '-';
          Else
            v_Rtime := v_Normal || '-';
          End If;
          n_First := 0;
          If 频率间隔_In = 1 Then
            --8:00-12:00-14:00；8-12-14
            While v_Rtime Is Not Null Loop
              v_Mtime := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
              If Instr(v_Mtime, ':') = 0 Then
                v_Mtime := v_Mtime || ':00';
              End If;
              v_Tmptime := Trunc(v_Curtime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
              If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In Then
              
                v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
                n_Cnt        := n_Cnt + 1;
                If n_Cnt >= 次数_In Then
                  Exit;
                
                End If;
              Elsif v_Tmptime > 终止时间_In Then
                Exit;
              End If;
              v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
            End Loop;
          Else
            --1/8:00-1/15:00-2/9:00
            While v_Rtime Is Not Null Loop
              v_Mtime   := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
              v_Tmptime := v_Curtime + To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, '/') - 1)) - 1;
              v_Mtime   := Substr(v_Mtime, Instr(v_Mtime, '/') + 1);
              If Instr(v_Mtime, ':') = 0 Then
                v_Mtime := v_Mtime || ':00';
              End If;
              v_Tmptime := Trunc(v_Tmptime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
              If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In Then
              
                v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
                n_Cnt        := n_Cnt + 1;
                If n_Cnt >= 次数_In Then
                  Exit;
                
                End If;
              Elsif v_Tmptime > 终止时间_In Then
                Exit;
              End If;
              v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
            End Loop;
          End If;
          v_Curtime := Trunc(v_Curtime + 频率间隔_In); --因为Loop条件注意要取整
        End Loop;
      Elsif 间隔单位_In = '小时' Then
        --10:00-20:00-40:00；10-20-40；02:30
        While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop
        
          v_Rtime := 执行时间_In || '-';
          While v_Rtime Is Not Null Loop
            v_Mtime := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
            If Instr(v_Mtime, ':') = 0 Then
              v_Tmptime := v_Curtime + (To_Number(v_Mtime) - 1) / 24;
            Else
              v_Tmptime := v_Curtime + (To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, ':') - 1)) - 1) / 24 +
                           To_Number(Substr(v_Mtime, Instr(v_Mtime, ':') + 1)) / 60 / 24;
            End If;
          
            If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In Then
            
              v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
              n_Cnt        := n_Cnt + 1;
              If n_Cnt >= 次数_In Then
                Exit;
              End If;
            
            Elsif v_Tmptime > 终止时间_In Then
              Exit;
            End If;
            v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
          End Loop;
          v_Curtime := v_Curtime + 频率间隔_In / 24;
        End Loop;
      Elsif 间隔单位_In = '分钟' Then
        --无执行时间
        While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop
          v_Tmptime := v_Curtime;
          If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In Then
            v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
            n_Cnt        := n_Cnt + 1;
            If n_Cnt >= 次数_In Then
              Exit;
            End If;
          Elsif v_Tmptime > 终止时间_In Then
            Exit;
          End If;
          v_Curtime := v_Curtime + 频率间隔_In / (24 * 60);
        End Loop;
      End If;
      If v_Detailtime Is Not Null Then
        v_Detailtime := Substr(v_Detailtime, 2);
      End If;
      Return(v_Detailtime);
    End;
  
    Function f_Main
    (
      就诊id_In     In 病人信息.主页id%Type,
      病人id_In     In 病人信息.病人id%Type,
      医嘱id_In     In Varchar2,
      操作员编号_In In 人员表.编号%Type,
      操作员姓名_In In 人员表.姓名%Type
    ) Return Number Is
    Begin
      Mn_病人id     := 病人id_In;
      Mn_就诊id     := 就诊id_In;
      Mv_医嘱id     := 医嘱id_In;
      Mv_操作员编号 := 操作员编号_In;
      Mv_操作员姓名 := 操作员姓名_In;
    
      Return(1);
    Exception
      When Others Then
        p_Errcenter(SQLErrM);
        Return(0);
    End;
  
    --读取参数相关
    Procedure p_Load Is
      n_Tmp Number := 0;
      v_Tmp Varchar2(400);
    Begin
    
      --金额小数位数
      Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')), Zl_To_Number(Nvl(zl_GetSysParameter(157), '5')),
             zl_GetSysParameter(80)
      Into Gn_Dec, Gn_Decprice, Gv_住院发送划价单
      From Dual;
    
      --执行前先结算
      n_Tmp := Zl_To_Number(Nvl(zl_GetSysParameter(163), '0'));
      If n_Tmp <> 0 Then
        Gb_执行前先结算 := True;
      End If;
    
      --从属项目汇总计算折扣
      n_Tmp := To_Number(Nvl(zl_GetSysParameter(93), 0));
      If n_Tmp <> 0 Then
        Gb_从项汇总折扣 := True;
      End If;
    
      v_Tmp       := 0 || zl_GetSysParameter(28) || '|';
      Gn_消费验证 := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1));
    
      --住院自动发料
      Select Zl_To_Number(Nvl(zl_GetSysParameter(63), '0')) Into n_Tmp From Dual;
      If n_Tmp <> 0 Then
        Gb_住院自动发料 := True;
      Else
        Gb_住院自动发料 := False;
      End If;
    
      Select a.费别, b.姓名, b.性别, b.年龄, Nvl(b.当前病区id, 0), Nvl(b.出院科室id, 0), Nvl(b.出院病床, 0), Nvl(b.住院号, 0)
      Into Mv_费别, Mv_姓名, Mv_性别, Mv_年龄, Mn_病人病区id, Mn_病人科室id, Mn_床号, Mn_标识号
      From 病人信息 A, 病案主页 B
      Where a.病人id = b.病人id And b.主页id = Mn_就诊id And b.病人id = Mn_病人id;
      --读取动态费别,发送关闭后清除
      --(忽略)gstr动态费别 = Load动态费别(mlng接诊科室ID)
      --对 Gv_动态费别 赋值
    Exception
      When Others Then
        p_Errcenter(SQLErrM);
        --zl_ErrorCenter(SQLCode, SQLErrM);
    End;
  
    --读取指定医嘱(仅当前行)的计价关系到临时记录集,并计算缺省发送金额(按费别打折)
    Function f_Loadadviceprice
    (
      Row_In        In Number,
      Id_In         In 人员表.Id%Type,
      相关id_In     In 人员表.Id%Type,
      诊疗项目id_In In 人员表.Id%Type,
      执行科室id_In In 人员表.Id%Type,
      执行性质_In   In 病人医嘱记录.执行性质%Type,
      计价特性_In   In 病人医嘱记录.计价特性%Type,
      标本部位_In   In 病人医嘱记录.标本部位%Type,
      检查方法_In   In 病人医嘱记录.检查方法%Type,
      执行标记_In   In 病人医嘱记录.执行标记%Type,
      金额_Out      Out 住院费用记录.实收金额%Type
    ) Return Number Is
    
      b_零费记帐 Boolean := False;
      b_Havesub  Boolean := False;
    
      b_Do         Boolean := False;
      n_Row        Number := 0;
      n_数量       Number(16, 5) := 0;
      n_金额       住院费用记录.实收金额%Type := 0;
      n_实收       住院费用记录.实收金额%Type := 0;
      n_应收       住院费用记录.实收金额%Type := 0;
      n_加班率     住院费用记录.实收金额%Type := 0;
      n_材料id     人员表.Id%Type := 0;
      v_Sql        Varchar2(30000);
      v_Price      Varchar2(20000);
      v_费用性质   Varchar2(200);
      n_费用性质   Number := 0;
      n_项目id     人员表.Id%Type := 0;
      n_主收入id   人员表.Id%Type := 0;
      n_执行科室id 人员表.Id%Type := 0;
      v_费别       Varchar2(30);
      v_Tmp        Varchar2(3000);
    
      v_收费sql Varchar2(3000);
    
      Type r_Recordset_Tmp Is Record(
        类别       Varchar2(30),
        收费项目id Number,
        收费数量   Number,
        固有对照   Number,
        收入项目id Number,
        加班加价   Number,
        加班加价率 Number,
        单价       Number,
        是否变价   Number,
        从项       Number,
        跟踪在用   Number,
        执行科室id Number,
        屏蔽费别   Number,
        费用性质   Number,
        收费方式   Number);
      Type t_Tmp Is Table Of r_Recordset_Tmp;
      Rs_Tmp  t_Tmp := t_Tmp();
      n_Rsrow Number := 0;
    
      c_Tmp Rs_Recordset;
    Begin
      If Vsadvice(Row_In).零费记帐 = 1 Then
        b_零费记帐 := True;
      End If;
      金额_Out := 0;
    
      If Gn_发送收费标识 = 0 Then
        v_收费sql := '2';
      Else
        v_收费sql := '1';
      End If;
    
      --取诊疗收费 关系中的对照(发送时才定计价):正常计价,不为叮嘱、院外执行
      If Nvl(计价特性_In, 0) = 0 And Instr(',0,5,', Nvl(执行性质_In, 0)) = 0 Then
        If Vsadvice(Row_In).试管编码 Is Not Null Then
          n_材料id := f_Gettubematerial(Vsadvice(Row_In).试管编码);
        End If;
        n_数量 := Vsadvice(Row_In).总量;
        --几种对应的计价情况
        If 标本部位_In Is Not Null And 检查方法_In Is Not Null Then
          v_Price := ' And c.检查部位=:3 And c.检查方法=:4 And Nvl(c.费用性质,0)=0';
        Elsif Nvl(执行标记_In, 0) = 0 Then
          v_Price := ' And c.检查部位 Is Null And c.检查方法 is Null And Nvl(c.费用性质,0)=0 and (1=1 or c.检查方法=:3 or c.检查方法=:4)';
        Else
          --目前包含床旁或术中加收的情况
          v_Price := ' And c.检查部位 Is Null And c.检查方法 is Null And Nvl(c.费用性质,0) IN(0,1) and (1=1 or c.检查方法=:3 or c.检查方法=:4)';
        End If;
        v_Price := 'Select * From ( Select C.诊疗项目ID,C.收费项目ID,C.检查部位,C.检查方法,C.费用性质,C.收费数量,C.固有对照,C.从属项目,C.收费方式,c.适用科室id' ||
                   ',Max(Nvl(c.适用科室id, 0)) Over(Partition By c.诊疗项目id, c.检查部位, c.检查方法, c.费用性质) As Top' ||
                   ' From 诊疗收费关系 C Where C.诊疗项目ID=:1 And (C.适用科室ID is Null And C.病人来源 = 0 or C.适用科室ID =:2 And C.病人来源 = ' ||
                   v_收费sql || ') ' || v_Price || '  ) Where Nvl(适用科室id, 0) = Top';
        v_Sql   := 'Select C.类别,A.收费项目ID,A.收费数量,A.固有对照,B.收入项目ID,C.加班加价,B.加班加价率,Decode(C.是否变价,1,B.缺省价格,B.现价)';
        v_Sql   := v_Sql || '  as 单价,C.是否变价,Nvl(A.从属项目,0) as 从项,D.跟踪在用,' || 执行科室id_In ||
                   ' as 执行科室ID,C.屏蔽费别,Nvl(A.费用性质,0) as 费用性质,' || 'Nvl(A.收费方式,0) as 收费方式 ' || ' From ( ' || v_Price ||
                   ') A,收费价目 B,收费项目目录 C,材料特性 D' || '  Where A.收费项目ID=B.收费细目ID And A.收费项目ID=C.ID And A.收费项目ID=D.材料ID(+)' ||
                   ' And C.服务对象 IN(1,3) And (C.撤档时间=To_Date(''3000-01-01'',''YYYY-MM-DD'') Or C.撤档时间 is NULL)' ||
                   ' And (C.站点=''' || Gv_Nodeno || ''' Or C.站点 is Null)' ||
                   ' And ((Sysdate Between B.执行日期 and B.终止日期) or (Sysdate>=B.执行日期 And B.终止日期 is NULL))' ||
                   ' And (Nvl(A.收费方式,0)=1 And C.类别=''4'' And A.收费项目ID=:5 Or Not(Nvl(A.收费方式,0)=1 And C.类别=''4'' And ';
        If n_材料id <> 0 Then
          v_Sql := v_Sql || ' 1=1 ';
        Else
          v_Sql := v_Sql || ' 0=1 ';
        End If;
        v_Sql := v_Sql || ' )) Order by 费用性质,从项,A.收费项目ID';
      
        Open c_Tmp For v_Sql
          Using In 诊疗项目id_In, In 执行科室id_In, In 标本部位_In, In 检查方法_In, In n_材料id;
        Fetch c_Tmp Bulk Collect
          Into Rs_Tmp;
        Close c_Tmp;
        For I In 1 .. Rs_Tmp.Count Loop
          If Instr(',' || v_费用性质 || ',', ',' || Rs_Tmp(I).费用性质 || ',') = 0 Then
            v_费用性质 := v_费用性质 || ',' || Rs_Tmp(I).费用性质;
          End If;
        End Loop;
        v_费用性质 := Substr(v_费用性质, 2);
        While v_费用性质 Is Not Null Loop
          n_费用性质 := Substr(v_费用性质, 1, 1);
          v_费用性质 := Substr(v_费用性质, 3);
        
          For I In 1 .. Rs_Tmp.Count Loop
            If Rs_Tmp(I).费用性质 = n_费用性质 Then
              n_项目id   := 0;
              n_金额     := 0;
              n_主收入id := 0;
              b_Havesub  := False;
              If Gb_从项汇总折扣 Then
                n_Rsrow := I;
                For J In n_Rsrow .. Rs_Tmp.Count Loop
                  If Rs_Tmp(J).费用性质 = n_费用性质 Then
                    If Nvl(Rs_Tmp(J).从项, 0) = 0 Then
                      --SQL中主项排在前面,只取主项目的第一个收入
                      If n_主收入id = 0 Then
                        n_主收入id := Rs_Tmp(J).收入项目id;
                      End If;
                    Elsif Nvl(Rs_Tmp(J).从项, 0) = 1 Then
                      b_Havesub := True;
                      Exit;
                    End If;
                  End If;
                End Loop;
              End If;
            End If;
          End Loop;
        
          --正向循环方式,循环结束后再处理最后一条
          For I In 1 .. Rs_Tmp.Count Loop
            If Rs_Tmp(I).费用性质 = n_费用性质 Then
              n_Rsrow := I;
              b_Do    := False;
              If Rs_Tmp(n_Rsrow).收费项目id <> n_项目id And n_项目id <> 0 Then
                b_Do := True;
              End If;
              If b_Do Then
                If Rs_Price(n_Row).单价 Is Not Null Then
                  Rs_Price(n_Row).单价 := Round(Rs_Price(n_Row).单价, Gn_Decprice);
                End If;
                --医嘱发送金额
                n_金额 := n_金额 + Round(n_实收, Gn_Dec);
              End If;
              ---------------------------
              If Rs_Tmp(n_Rsrow).收费项目id <> n_项目id Then
                n_实收 := 0;
                Rs_Price.Extend;
                n_Row := Rs_Price.Count;
                Rs_Price(n_Row).医嘱id := Id_In;
                Rs_Price(n_Row).相关id := 相关id_In;
                Rs_Price(n_Row).费用性质 := Nvl(Rs_Tmp(n_Rsrow).费用性质, 0);
                Rs_Price(n_Row).收费方式 := Nvl(Rs_Tmp(n_Rsrow).收费方式, 0);
                Rs_Price(n_Row).收费类别 := Rs_Tmp(n_Rsrow).类别;
                Rs_Price(n_Row).收费细目id := Rs_Tmp(n_Rsrow).收费项目id;
                Rs_Price(n_Row).执行科室id := 执行科室id_In;
                Rs_Price(n_Row).数量 := Nvl(Rs_Tmp(n_Rsrow).收费数量, 0);
                Rs_Price(n_Row).在用 := Nvl(Rs_Tmp(n_Rsrow).跟踪在用, 0);
                Rs_Price(n_Row).变价 := Nvl(Rs_Tmp(n_Rsrow).是否变价, 0);
                Rs_Price(n_Row).固定 := Nvl(Rs_Tmp(n_Rsrow).固有对照, 0);
                Rs_Price(n_Row).从项 := Nvl(Rs_Tmp(n_Rsrow).从项, 0);
                --执行科室:非药嘱药品及跟踪卫材的专门取
                n_执行科室id := Nvl(Rs_Tmp(n_Rsrow).执行科室id, 0);
                If Rs_Tmp(n_Rsrow)
                 .类别 = '4' And Nvl(Rs_Tmp(n_Rsrow).跟踪在用, 0) = 1 Or Instr(',5,6,7,', Rs_Tmp(n_Rsrow).类别) > 0 Then
                
                  n_执行科室id := n_执行科室id;
                  -- lng执行科室ID = Get收费执行科室ID(mlng病人ID, 0, rsTmp!类别, rsTmp!收费项目ID, 4, NVL(rsSend!病人科室id, 0), 0, 1, lng执行科室ID)
                End If;
                If Nvl(n_执行科室id, 0) <> 0 Then
                  Rs_Price(n_Row).执行科室id := n_执行科室id;
                Else
                  Rs_Price(n_Row).执行科室id := 0;
                End If;
                Null;
              End If;
              n_项目id := Rs_Tmp(n_Rsrow).收费项目id;
            
              --计算单价和实收
              If (Nvl(Rs_Tmp(n_Rsrow).是否变价, 0) = 1 And Instr(',5,6,7,', Rs_Tmp(n_Rsrow).类别) > 0) Or
                 (Nvl(Rs_Tmp(n_Rsrow).是否变价, 0) = 1 And Rs_Tmp(n_Rsrow).类别 = '4' And Nvl(Rs_Tmp(n_Rsrow).跟踪在用, 0) = 1) Then
              
                --非药嘱药品计价按时价计算(仅一个收入),其它变价需要由医生输入
                --跟踪在用的时价卫材和药品一样计算
                Rs_Price(n_Row).单价 := f_Calcdrugprice(Rs_Tmp(n_Rsrow).收费项目id, Rs_Price(n_Row).执行科室id,
                                                      n_数量 * Nvl(Rs_Tmp(n_Rsrow).收费数量, 0), Null);
              
                n_应收 := Rs_Price(n_Row).数量 * n_数量 * Round(Rs_Price(n_Row).单价, Gn_Decprice);
              
                n_应收 := Round(n_应收, Gn_Dec);
              
                If Not b_零费记帐 Then
                  If Nvl(Rs_Tmp(n_Rsrow).屏蔽费别, 0) = 0 And Mv_费别 Is Not Null And (Not (Gb_从项汇总折扣 And b_Havesub)) Then
                    v_费别 := Mv_费别;
                    If Gv_动态费别 Is Not Null Then
                      v_费别 := v_费别 || ',' || Gv_动态费别;
                    End If;
                    n_加班率 := 0;
                    n_实收   := n_实收 +
                              Round(f_Actualmoney(v_费别, Rs_Tmp(n_Rsrow).收入项目id, n_应收, Rs_Tmp(n_Rsrow).收费项目id, n_执行科室id,
                                                  (Rs_Price(n_Row).数量 * n_数量), n_加班率, v_Tmp), Gn_Dec);
                  Else
                    n_实收 := n_实收 + n_应收;
                  End If;
                End If;
              Else
                --固定价格或普通变价(只有一个收入项目)
                Rs_Price(n_Row).单价 := Nvl(Rs_Price(n_Row).单价, 0) + Nvl(Rs_Tmp(n_Rsrow).单价, 0);
              
                n_应收 := Rs_Price(n_Row).数量 * n_数量 * Round(Rs_Tmp(n_Rsrow).单价, Gn_Decprice);
                n_应收 := Round(n_应收, Gn_Dec);
                If Not b_零费记帐 Then
                  If Nvl(Rs_Tmp(n_Rsrow).屏蔽费别, 0) = 0 And Mv_费别 Is Not Null And (Not (Gb_从项汇总折扣 And b_Havesub)) Then
                    v_费别 := Mv_费别;
                    If Gv_动态费别 Is Not Null Then
                      v_费别 := v_费别 || ',' || Gv_动态费别;
                    End If;
                    n_加班率 := 0;
                    n_实收   := n_实收 +
                              Round(f_Actualmoney(v_费别, Rs_Tmp(n_Rsrow).收入项目id, n_应收, Rs_Tmp(n_Rsrow).收费项目id, n_执行科室id,
                                                  (Rs_Price(n_Row).数量 * n_数量), n_加班率, v_Tmp), Gn_Dec);
                  Else
                    n_实收 := n_实收 + n_应收;
                  End If;
                End If;
              End If;
            End If;
          End Loop;
        
          --循环结再处理最后一条
          If Nvl(n_项目id, 0) <> 0 Then
            If Rs_Price(n_Row).单价 Is Not Null Then
              Rs_Price(n_Row).单价 := Round(Rs_Price(n_Row).单价, Gn_Decprice);
            End If;
            --医嘱发送金额
            n_金额 := n_金额 + Round(n_实收, Gn_Dec);
          End If;
        
          --从属项目汇总计算折扣
          If Gb_从项汇总折扣 And b_Havesub And n_主收入id <> 0 And Not b_零费记帐 Then
            v_费别 := Mv_费别;
            If Gv_动态费别 Is Not Null Then
              v_费别 := v_费别 || ',' || Gv_动态费别;
            End If;
            n_金额 := Round(f_Actualmoney(v_费别, n_主收入id, n_金额, 0, 0, 0, 0, v_Tmp), Gn_Dec);
          End If;
          金额_Out := 金额_Out + n_金额;
        
        End Loop;
      End If;
      Mv_Msg := Null;
      Return(1);
    Exception
      When Others Then
        p_Errcenter(SQLErrM);
        --zl_ErrorCenter(SQLCode, SQLErrM);
        Return(0);
    End;
  
    Function f_Loadadvicesend Return Number Is
      --医嘱记录集
      Cursor c_Advice(医嘱id_In Varchar2) Is
        Select a.病人id, a.主页id, a.Id, a.相关id, Nvl(a.相关id, a.Id) As 组id, Nvl(x.序号, a.序号) As 组号, a.医嘱状态, a.诊疗类别,
               f.名称 As 类别名称, a.诊疗项目id, b.名称 As 诊疗项目, a.收费细目id, a.婴儿, a.医嘱内容, a.标本部位, a.检查方法, a.执行标记, a.天数, a.总给予量,
               d.住院单位, a.单次用量, Decode(a.诊疗类别, '4', c.计算单位, b.计算单位) As 计算单位, d.剂量系数, d.住院包装, a.开始执行时间, a.执行频次, a.频率次数,
               a.频率间隔, a.间隔单位, a.医生嘱托, a.执行时间方案, a.申请序号, b.执行分类, a.病人科室id, a.开嘱科室id, a.开嘱医生, a.开嘱时间, a.计价特性, a.执行性质,
               a.执行科室id, Nvl(e.名称, Decode(Nvl(a.执行性质, 0), 5, '-')) As 执行科室, b.操作类型, b.试管编码,
               Nvl(a.可否分零, d.住院可否分零) As 可否分零, Decode(a.诊疗类别, '4', g.在用分批, d.药房分批) As 分批, g.跟踪在用, c.是否变价, c.撤档时间, c.服务对象,
               a.新开签名id As 签名id, a.摘要, a.紧急标志, b.计算方式, b.执行安排, h.毒理分类, a.用药理由, g.高值材料, c.规格, a.零费记帐
        From 病人医嘱记录 A, 诊疗项目目录 B, 收费项目目录 C, 药品规格 D, 部门表 E, 诊疗项目类别 F, 材料特性 G, 药品特性 H, 病人医嘱记录 X
        Where a.相关id = x.Id(+) And b.类别 = f.编码 And a.诊疗项目id = b.Id And a.收费细目id = c.Id(+) And a.收费细目id = d.药品id(+) And
              a.收费细目id = g.材料id(+) And a.执行科室id = e.Id(+) And a.诊疗类别 = 'D' And Nvl(a.执行标记, 0) <> -1 And
              b.Id = h.药名id(+) And Nvl(a.审核状态, 0) Not In (1, 3, 4, 5) And Nvl(a.皮试结果, '无') <> '免试' And
              a.开始执行时间 Is Not Null And a.病人来源 <> 3 And a.医嘱状态 In (1, 3, 5) And a.医嘱期效 = 1 And
              a.Id In (Select /*+cardinality(x,10)*/
                        x.Column_Value
                       From Table(f_Num2list(医嘱id_In)) X)
        Order By a.婴儿, 组号, 组id, a.序号;
      r_Advice c_Advice%RowType;
    
      n_Row       Number := 0;
      n_Break     Number;
      v_停用      Varchar2(4000);
      v_分解      Varchar2(4000);
      n_Del医嘱id Number(18) := 0;
      n_Del相关id Number(18) := 0;
      n_最小次数  Number := 0;
      n_次数      Number := 0;
      n_总量      Number(16, 5) := 0;
      n_金额      Number(16, 5) := 0;
      n_Tmp       Number := 0;
    Begin
      Vsadvice := t_Advice();
      Rs_Price := t_Price();
      Vsadvice.Extend; --添加一个空行
      Open c_Advice(Mv_医嘱id);
      Loop
        Fetch c_Advice
          Into r_Advice;
        Exit When c_Advice%NotFound;
        If c_Advice%RowCount > 0 Then
          Vsadvice.Extend;
          n_Row := Vsadvice.Count; --当前行
          Vsadvice(n_Row).选择 := 1; --1表示可以发送,非1不能发送;2-表示一般的叮嘱
          If Nvl(r_Advice.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) <> To_Date('3000-01-01', 'yyyy-mm-dd') Then
            Vsadvice(n_Row).选择 := 0;
            If Instr(v_停用 || ',', ',' || r_Advice.医嘱内容 || ',') = 0 Then
              v_停用 := v_停用 || ',' || r_Advice.医嘱内容;
            End If;
          End If;
          Vsadvice(n_Row).婴儿 := r_Advice.婴儿;
          Vsadvice(n_Row).医嘱内容 := r_Advice.医嘱内容;
          Vsadvice(n_Row).频率 := r_Advice.执行频次;
          Vsadvice(n_Row).医生嘱托 := r_Advice.医生嘱托;
          Vsadvice(n_Row).医生嘱托_Data := r_Advice.摘要;
          Vsadvice(n_Row).执行时间 := r_Advice.执行时间方案;
          Vsadvice(n_Row).执行科室 := r_Advice.执行科室;
          Vsadvice(n_Row).执行性质 := r_Advice.执行性质;
          Vsadvice(n_Row).Id := r_Advice.Id;
          Vsadvice(n_Row).主页id := r_Advice.主页id;
          Vsadvice(n_Row).相关id := r_Advice.相关id;
          Vsadvice(n_Row).病人科室id := r_Advice.病人科室id;
          Vsadvice(n_Row).开嘱科室id := r_Advice.开嘱科室id;
          Vsadvice(n_Row).开嘱医生 := r_Advice.开嘱医生;
          Vsadvice(n_Row).诊疗类别 := r_Advice.诊疗类别;
          Vsadvice(n_Row).诊疗项目id := r_Advice.诊疗项目id;
          Vsadvice(n_Row).标本部位 := r_Advice.标本部位;
          Vsadvice(n_Row).检查方法 := r_Advice.检查方法;
          Vsadvice(n_Row).执行标记 := r_Advice.执行标记;
          Vsadvice(n_Row).计价特性 := r_Advice.计价特性;
          Vsadvice(n_Row).执行性质id := r_Advice.执行性质;
          Vsadvice(n_Row).执行科室id := r_Advice.执行科室id;
          Vsadvice(n_Row).频率次数 := r_Advice.频率次数;
          Vsadvice(n_Row).频率间隔 := r_Advice.频率间隔;
          Vsadvice(n_Row).间隔单位 := r_Advice.间隔单位;
        
          n_总量 := Nvl(r_Advice.总给予量, 1);
          n_次数 := f_Intex(n_总量 / Nvl(r_Advice.单次用量, 1));
        
          If r_Advice.执行时间方案 Is Null And
             (Nvl(r_Advice.频率次数, 0) = 0 Or Nvl(r_Advice.频率间隔, 0) = 0 Or r_Advice.间隔单位 Is Null) Then
            --执行频率为 一次性 的项目
            v_分解 := Null;
            Vsadvice(n_Row).频率_Data := 1;
          Else
            --执行频率为 可选频率 的项目:下医嘱时应输入了总量
            If r_Advice.执行时间方案 Is Not Null Or Nvl(r_Advice.间隔单位, ' ') = '分钟' Then
              v_分解 := f_Calc次数分解时间(n_次数, r_Advice.开始执行时间, To_Date('3000-01-01', 'yyyy-mm-dd'), r_Advice.执行时间方案,
                                   r_Advice.频率间隔, r_Advice.间隔单位);
            Else
              v_分解 := Null; --临嘱也许未输入执行时间,无法分解
            End If;
          End If;
          Vsadvice(n_Row).次数 := n_次数;
          Vsadvice(n_Row).分解时间 := v_分解;
          If v_分解 Is Not Null Then
            Vsadvice(n_Row).首次时间 := Substr(v_分解, 1, 16);
            Vsadvice(n_Row).末次时间 := Substr(v_分解, Instr(v_分解, ',', -1) + 1, 16);
          Else
            --记录费用发生时间(当无分解时间时),以医嘱的开始执行时间
            Vsadvice(n_Row).分解时间_Data := To_Char(r_Advice.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
          End If;
          Vsadvice(n_Row).单量 := r_Advice.单次用量;
          If r_Advice.单次用量 Is Not Null Then
            Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
          End If;
          Vsadvice(n_Row).总量 := Round(n_总量, 5);
          Vsadvice(n_Row).总量单位 := r_Advice.计算单位;
        
          Vsadvice(n_Row).签名id := r_Advice.签名id;
          --采集方式的管码与检验相同(暂不考虑一并检验的情况)
          If Vsadvice(n_Row).Id_Data = '4' Then
            Vsadvice(n_Row).试管编码 := Vsadvice(n_Row - 1).试管编码;
          Else
            Vsadvice(n_Row).试管编码 := r_Advice.试管编码;
          End If;
          Vsadvice(n_Row).操作类型 := r_Advice.操作类型;
          Vsadvice(n_Row).紧急标志 := r_Advice.紧急标志;
          Vsadvice(n_Row).零费记帐 := r_Advice.零费记帐;
          --计算方式
          If Instr(',4,5,6,7,', ',' || r_Advice.诊疗类别 || ',') = 0 Then
            Vsadvice(n_Row).计算方式 := r_Advice.计算方式;
          Else
            Vsadvice(n_Row).计算方式 := '0';
          End If;
          Vsadvice(n_Row).开始时间 := To_Char(r_Advice.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
          Vsadvice(n_Row).执行安排 := r_Advice.执行安排;
          Vsadvice(n_Row).执行分类 := r_Advice.执行分类;
        
          --计算项目发送金额
          n_Tmp := f_Loadadviceprice(n_Row, r_Advice.Id, r_Advice.相关id, r_Advice.诊疗项目id, r_Advice.执行科室id, r_Advice.执行性质,
                                     r_Advice.计价特性, r_Advice.标本部位, r_Advice.检查方法, r_Advice.执行标记, n_金额);
          If n_Tmp = 0 Then
            n_Del医嘱id := r_Advice.Id;
            n_Del相关id := Nvl(r_Advice.相关id, 0);
            --往前删除整组医嘱 Call DeleteCurRow(lngRow)
            Vsadvice.Delete(n_Row);
            n_Row := n_Row - 1;
            For I In 1 .. n_Row Loop
              If Nvl(Vsadvice(n_Row + I - 1).相关id, 0) = n_Del相关id Then
                Vsadvice.Delete(n_Row + I - 1);
              Else
                Exit;
              End If;
            End Loop;
            n_最小次数 := 0;
            n_Break    := 0;
          End If;
          Vsadvice(n_Row).金额 := Round(n_金额, Gn_Dec);
          Vsadvice(n_Row).金额_Data := Vsadvice(n_Row).金额;
        End If;
      End Loop;
    
      Mv_Msg := Null;
      If Vsadvice.Count = 1 Then
        Return(0);
      Else
        Return(1);
      End If;
    Exception
      When Others Then
        p_Errcenter(SQLErrM);
        Return(0);
    End;
  
    --医嘱发送
    Function f_Sendadvice Return Number Is
    
      Type r_Seek Is Record(
        费用性质 Number,
        主项标签 Number,
        主收入id Number(18),
        合计     Number(16, 5));
      Type t_Seek Is Table Of r_Seek;
    
      Type r_Money Is Record(
        ID         Number(18),
        类别       Varchar2(20),
        类别名称   Varchar2(2000),
        名称       Varchar2(2000),
        计算单位   Varchar2(20),
        是否变价   Number(1),
        屏蔽费别   Number(1),
        费用确认   Number(1),
        加班加价   Number(1),
        加班加价率 Number(16, 5),
        附术收费率 Number(16, 5),
        住院单位   Varchar2(20),
        住院包装   Number(16, 5),
        剂量系数   Number(16, 5),
        分批       Number(1),
        跟踪在用   Number(1),
        收入项目id Number(18),
        收据费目   Varchar2(20),
        数量       Number(16, 5),
        单价       Number(16, 5),
        执行科室id Number(18),
        从项       Number(1),
        费用性质   Number(1),
        收费方式   Number(1));
      Type t_Money Is Table Of r_Money;
    
      Rs_Seek  t_Seek;
      Rs_Money t_Money;
    
      c_Tmp Rs_Recordset;
    
      n_发送号        病人医嘱发送.发送号%Type;
      n_发送序号      病人医嘱发送.发送号%Type;
      d_Cur           Date;
      n_配方数        Number;
      v_Nokey         Varchar2(600);
      v_No            Varchar2(600);
      n_Tmp           Number;
      n_Tmp1          Number;
      b_离院带药      Boolean;
      n_Okrowmney     Number;
      v_Sql           Varchar2(20000);
      v_收费项目      Varchar2(6000);
      n_执行科室id    部门表.Id%Type;
      n_父序号        Number;
      n_父项目id      Number(18);
      v_Havesub       Varchar2(600);
      v_Nonesub       Varchar2(600);
      v_Cuvettenumber Varchar2(600);
      n_费用次数      Number;
      n_收费数量      Number;
      n_执行状态      Number;
      n_计费状态      Number;
      b_附加手术      Boolean := False;
      b_First         Boolean;
      n_Idx           Number;
      v_分解时间      Varchar2(20000);
      I               Number;
      J               Number;
      K               Number;
      n_付数          Number(16, 5);
      n_数量          Number(16, 5);
      n_Other数量     Number(16, 5);
      n_单价          Number(16, 5);
      n_应收          Number(16, 5);
      n_实收          Number(16, 5);
      n_合计          Number(16, 5);
      n_记帐合计      Number(16, 5);
      n_发送数次      Number(16, 5);
      b_Bool          Boolean;
      n_费用父号      Number;
      n_费用序号      Number;
      v_费别          Varchar2(3000);
      v_类别          Varchar2(3000);
      d_发生时间      Date;
      d_登记时间      Date;
      n_划价          Number;
      v_自动发料      Varchar2(6000);
      b_记帐          Boolean;
    
      d_首次时间 Date;
      d_末次时间 Date;
    
    Begin
      If Gn_发送收费标识 = 0 Then
        b_记帐 := True;
      Else
        b_记帐 := False;
      End If;
    
      Mn_Nosequence := 0;
      n_发送号      := Nextno(10, Null, Null, 1);
      If Mb_Auto Then
        Select (Sysdate + 1 / 60 / 24) As 发送时间 Into d_Cur From Dual;
      Else
        Select Sysdate Into d_Cur From Dual;
      End If;
    
      n_配方数 := 1; --表示发送的第几付配方,用于分单据号
      Rs_Exec  := t_Exec();
      --从第二行开始循环,因为前面加了空行
      For I In 2 .. Vsadvice.Count Loop
        --产生单据号分配关键字
        v_Nokey := '只产生一个单据号';
      
        --开单人不同的，默认全部分别产生单据
        v_Nokey := v_Nokey || '_' || Vsadvice(I).开嘱医生;
      
        --产生医嘱记帐费用:以最新价格计算
        -----------------------------------------------------------------
        v_Sql      := Null;
        v_收费项目 := Null;
        --先删除原非药医嘱的计价(应该没有)
        r_计价.Extend;
        n_Tmp := r_计价.Count;
        r_计价(n_Tmp).医嘱id := Vsadvice(I).Id;
        r_计价(n_Tmp).删单行 := 1;
        r_计价(n_Tmp).过程名 := 1;
      
        --不计价,手工计价；叮嘱,院外执行的医嘱不读取
        If Nvl(Vsadvice(I).计价特性, 0) = 0 And Instr(',0,5,', Nvl(Vsadvice(I).执行性质id, 0)) = 0 Then
          For J In 1 .. Rs_Price.Count Loop
            If Rs_Price(J).医嘱id = Vsadvice(I).Id Then
              --对照数量为0的自动过滤掉
              If Nvl(Rs_Price(J).收费细目id, 0) <> 0 And Nvl(Rs_Price(J).数量, 0) <> 0 Then
                --(忽略:不涉及到)普通项目的变价单价要求输入，包括非跟踪在用的时价卫材医嘱
              
                --计价执行科室:只保存非药品及卫材医嘱的，药品和卫材计价的执行科室
                If Instr(',4,5,6,7,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 And
                   (Instr(',5,6,7,', Rs_Price(J).收费类别) > 0 Or Rs_Price(J).收费类别 = '4' And Nvl(Rs_Price(J).在用, 0) = 1) Then
                  n_执行科室id := Nvl(Rs_Price(J).执行科室id, 0);
                  --(忽略)卫材必须设置执行科室
                Else
                  n_执行科室id := 0;
                End If;
                --药品、卫材医嘱的计价固定对应不保存；非跟踪在用的时价卫材的变价需要输入，因此要保存到计价表中
                If Instr(',4,5,6,7,', Vsadvice(I).诊疗类别) = 0 Or Vsadvice(I)
                  .诊疗类别 = '4' And Nvl(Rs_Price(J).在用, 0) = 0 And Nvl(Rs_Price(J).变价, 0) = 1 Then
                
                  r_计价.Extend;
                  n_Tmp := r_计价.Count;
                  r_计价(n_Tmp).医嘱id := Vsadvice(I).Id;
                  r_计价(n_Tmp).过程名 := 2;
                  r_计价(n_Tmp).收费细目id := Rs_Price(J).收费细目id;
                  r_计价(n_Tmp).数量 := Rs_Price(J).数量;
                  r_计价(n_Tmp).单价 := Rs_Price(J).单价;
                  r_计价(n_Tmp).从项 := Rs_Price(J).从项;
                  If n_执行科室id > 0 Then
                    r_计价(n_Tmp).执行科室id := n_执行科室id;
                  Else
                    r_计价(n_Tmp).执行科室id := Null;
                  End If;
                  r_计价(n_Tmp).费用性质 := Rs_Price(J).费用性质;
                  r_计价(n_Tmp).收费方式 := Rs_Price(J).收费方式;
                End If;
                --临时病人医嘱计价表
                If Nvl(Vsadvice(I).总量, 0) <> 0 Then
                  If v_Sql Is Not Null Then
                    v_Sql := v_Sql || ' Union ALL ';
                  End If;
                  v_Sql := v_Sql || 'Select ' || Rs_Price(J).收费细目id || ' as 收费细目ID,' || Nvl(Rs_Price(J).执行科室id, 0) ||
                           ' as 执行科室ID,' || Nvl(Rs_Price(J).数量, 0) || ' as 数量,' || Nvl(Rs_Price(J).单价, 0) || ' as 单价,' ||
                           Nvl(Rs_Price(J).从项, 0) || ' as 从项,' || Nvl(Rs_Price(J).费用性质, 0) || ' as 费用性质,' ||
                           Nvl(Rs_Price(J).收费方式, 0) || ' as 收费方式 From Dual';
                
                End If;
              End If;
            End If;
          End Loop;
        End If;
        If v_Sql Is Not Null Then
          v_Sql := ' Select A.ID,A.类别,D.名称 as 类别名称,A.名称,A.计算单位,A.是否变价,' ||
                   ' A.屏蔽费别,A.费用确认,A.加班加价,B.加班加价率,B.附术收费率,Y.住院单位,Y.住院包装,Y.剂量系数,' ||
                   ' Decode(A.类别,''4'',E.在用分批,Y.药房分批) as 分批,E.跟踪在用,B.收入项目ID,' ||
                   ' C.收据费目,X.数量,Decode(A.是否变价,1,X.单价,B.现价) as 单价,X.执行科室ID,X.从项,X.费用性质,X.收费方式' ||
                   ' From 收费项目目录 A,收费价目 B,收入项目 C,收费项目类别 D,材料特性 E,(' || v_Sql || ') X,药品规格 Y' ||
                   ' Where A.ID=B.收费细目ID And B.收入项目ID=C.ID And A.ID=E.材料ID(+)' ||
                   ' And A.类别=D.编码 And X.收费细目ID=A.ID And A.ID=Y.药品ID(+) and (1=1 or A.ID=:1 )' ||
                   ' And ((Sysdate Between B.执行日期 and B.终止日期) or (Sysdate>=B.执行日期 And B.终止日期 is NULL))' ||
                   ' Order by X.费用性质,X.从项,X.收费方式 Desc,A.ID';
          --一定要把主项排在前面,以便于计算和在费用记录中保持主从关系
        End If;
      
        --汇总折扣变量初始
        v_Havesub := Null;
        v_Nonesub := Null;
        Rs_Seek   := t_Seek();
        --提前生成样本条码
        v_Cuvettenumber := Null;
        --(忽略)诊间支付相关
        --(忽略)本科执行的自动执行：特殊医嘱不用处理
        n_执行状态 := 0;
      
        --无需计费或未计费
        If Vsadvice(I).计价特性 = 1 Then
          n_计费状态 := -1;
        Else
          n_计费状态 := 0;
        End If;
        If v_Sql Is Not Null Then
          Open c_Tmp For v_Sql
            Using In Nvl(Vsadvice(I).收费细目id, 0);
          Fetch c_Tmp Bulk Collect
            Into Rs_Money;
          Close c_Tmp;
          If Rs_Money.Count > 0 Then
            n_计费状态 := 1; --已计费
          End If;
        
          For n_Idx In 1 .. Rs_Money.Count Loop
            --执行科室ID
            n_执行科室id := Nvl(Rs_Money(n_Idx).执行科室id, 0);
            --在原值基础上取有效的非药嘱药品及跟踪卫材的执行科室
            If Instr(',4,5,6,7,', Vsadvice(I).诊疗类别) = 0 And
               (Rs_Money(n_Idx)
                .类别 = '4' And Nvl(Rs_Money(n_Idx).跟踪在用, 0) = 1 Or Instr(',5,6,7,', Rs_Money(n_Idx).类别) > 0) Then
              --(忽略)n_执行科室id := f_Get收费执行科室id;
              n_执行科室id := Nvl(Rs_Money(n_Idx).执行科室id, 0);
              -- Get收费执行科室ID(mlng病人ID, 0, Rs_Money(n_idx).类别, Rs_Money(n_idx).ID, 4, Val(Vsadvice(I).病人科室ID)), 0, 1, lng执行科室ID)
            End If;
          
            --分解时间
            If Vsadvice(I).分解时间 Is Not Null Then
              v_分解时间 := Vsadvice(I).分解时间;
            Else
              v_分解时间 := Vsadvice(I).分解时间_Data; --开始执行时间
            End If;
            --------------------------------------------
            --根据收费方式，确定当前收费项目是否应收费
            If Rs_Money(n_Idx).费用性质 || '_' || Rs_Money(n_Idx).Id <> Nvl(v_收费项目, 'NULL') Then
              n_收费数量  := 0;
              n_Okrowmney := n_Idx;
              --默认返回值是1,处理后可能0
              n_Tmp := f_Advicemoneymake(Mn_病人id, Nvl(Vsadvice(I).相关id, Vsadvice(I).Id), Vsadvice(I).诊疗项目id,
                                         Rs_Money(n_Idx).Id, n_执行科室id, Vsadvice(I).试管编码, Rs_Money(n_Idx).类别,
                                         Nvl(Rs_Money(n_Idx).收费方式, 0), v_分解时间, Vsadvice(I).总量, Vsadvice(I).Id, n_发送号,
                                         Rs_Money(n_Idx).数量, Vsadvice(I).计算方式, Vsadvice(I).频率, Vsadvice(I).单量, 1, 0,
                                         Vsadvice(I).诊疗类别, v_Cuvettenumber, n_费用次数);
              If n_Tmp = 0 Then
                --跳过当前收费项目(多个收入项目)
                v_收费项目 := Rs_Money(n_Idx).费用性质 || '_' || Rs_Money(n_Idx).Id;
                K          := n_Idx;
                While K Is Not Null Loop
                  If Rs_Money(K).费用性质 || '_' || Rs_Money(K).Id = v_收费项目 Then
                    K := Rs_Money.Next(K);
                  Else
                    Exit;
                  End If;
                End Loop;
                If K Is Null Then
                  --已经到了结尾跳出循环
                  Exit;
                End If;
                n_Okrowmney := K;
              End If;
            
              If n_Okrowmney = n_Idx Then
                If Instr(',5,6,7', Rs_Money(n_Idx).类别) > 0 Then
                  If Instr(',5,6,7', Vsadvice(I).诊疗类别) > 0 Then
                    If Vsadvice(I).诊疗类别 = '7' Then
                      n_付数 := Vsadvice(I).总量;
                      --中药药房单位按不可分零处理:每付
                      If Nvl(Vsadvice(I).可否分零, 0) = 0 Then
                        n_数量 := Vsadvice(I).单量 / Nvl(Rs_Money(n_Idx).剂量系数, 1);
                      Else
                        n_数量 := f_Intex(Vsadvice(I).单量 / Nvl(Rs_Money(n_Idx).剂量系数, 1) / Nvl(Rs_Money(n_Idx).住院包装, 1)) *
                                Nvl(Rs_Money(n_Idx).住院包装, 1);
                      End If;
                    Else
                      n_付数 := 1;
                      n_数量 := Vsadvice(I).总量 * Nvl(Rs_Money(n_Idx).住院包装, 1);
                    End If;
                  Else
                    n_付数 := 1;
                    --中药药房单位按不可分零处理:每付
                    --非药嘱药品计价:因为这里预定了售价数量,因此不作不分零处理
                    --对于收费对照中的药品，且为当天只收取一次，数量为费用次数*对照数量
                    If Instr(',2,3,4,5,6,7,9,', Rs_Money(n_Idx).收费方式) > 0 Then
                      If n_Other数量 > 0 Then
                        n_数量 := n_Other数量;
                      Else
                        n_数量 := n_费用次数 * Nvl(Rs_Money(n_Idx).数量, 0);
                      End If;
                    Else
                      n_数量 := Vsadvice(I).总量 * Nvl(Rs_Money(n_Idx).数量, 0);
                    End If;
                  End If;
                  n_数量 := n_数量;
                
                  If Nvl(Rs_Money(n_Idx).是否变价, 0) = 1 Then
                    n_单价 := f_Calcdrugprice(Rs_Money(n_Idx).Id, n_执行科室id, n_付数 * n_数量, Null);
                  Else
                    n_单价 := Nvl(Rs_Money(n_Idx).单价, 0);
                  End If;
                Elsif Rs_Money(n_Idx).类别 = '4' And Nvl(Rs_Money(n_Idx).跟踪在用, 0) = 1 Then
                  --检查卫生材料入出类别
                  --  If lng卫材类别ID = 0 Then
                  --   Screen.MousePointer = 0
                  --      MsgBox '不能确定卫生材料单据的入出类别,请先到入出类别管理中设置！', vbInformation, gstrSysName
                  --     GoTo FuncEnd
                  --  end if;
                  n_付数 := 1;
                  If Instr(',1,2,3,4,5,6,7,9,', Rs_Money(n_Idx).收费方式) > 0 Then
                    If n_Other数量 > 0 Then
                      n_数量 := n_Other数量;
                    Else
                      n_数量 := n_费用次数 * Nvl(Rs_Money(n_Idx).数量, 0);
                    End If;
                  Else
                    n_数量 := Vsadvice(I).总量 * Nvl(Rs_Money(n_Idx).数量, 0);
                  End If;
                  --确定时价卫材价格
                  If Nvl(Rs_Money(n_Idx).是否变价, 0) = 1 Then
                    n_单价 := f_Calcdrugprice(Rs_Money(n_Idx).Id, n_执行科室id, n_数量, Null);
                  Else
                    n_单价 := Nvl(Rs_Money(n_Idx).单价, 0);
                  End If;
                Else
                  --总量等于单次用量乘数次。一天只收一次时，有多少天要执行，就收多少次，不管单次用量（例如：每天两次）,但要管收费对照的次数
                
                  n_付数 := 1;
                  If Instr(',1,2,3,4,5,6,7,9,', Rs_Money(n_Idx).收费方式) > 0 Then
                    If n_Other数量 > 0 Then
                      n_数量 := n_Other数量;
                    Else
                      n_数量 := n_费用次数 * Nvl(Rs_Money(n_Idx).数量, 0);
                    End If;
                  Else
                    n_数量 := Vsadvice(I).总量 * Nvl(Rs_Money(n_Idx).数量, 0);
                  End If;
                  n_单价 := Nvl(Rs_Money(n_Idx).单价, 0);
                End If;
                --(忽略)非药嘱药品及跟踪卫材的库存检查
                --发送金额
                n_应收 := n_付数 * n_数量 * n_单价;
                If b_附加手术 Then
                  n_应收 := n_应收 * Nvl(Rs_Money(n_Idx).附术收费率, 100) / 100;
                End If;
              
                n_应收 := n_应收;
              
                --NO,序号
                p_Getcurbillset(v_Nokey, 0, -1, b_记帐, v_No, n_费用序号, n_Tmp1);
                r_费用.Extend;
                b_Bool := False;
                If Rs_Money(n_Idx).费用性质 || '_' || Rs_Money(n_Idx).Id <> v_收费项目 Then
                  n_费用父号 := n_费用序号;
                  If Rs_Money(n_Idx).从项 = 0 Then
                    --记录主项信息，主项肯定在从项前
                    --即使不汇总折扣，也要记录主从项关系
                    If Instr(v_Havesub || ',', ',' || Rs_Money(n_Idx).费用性质 || ',') = 0 And
                       Instr(v_Nonesub || ',', ',' || Rs_Money(n_Idx).费用性质 || ',') = 0 Then
                      n_Tmp := Null;
                      For J In 1 .. Rs_Money.Count Loop
                        If Rs_Money(J).费用性质 = Rs_Money(n_Idx).费用性质 And Rs_Money(J).从项 = 1 Then
                          n_Tmp := 1;
                          Exit;
                        End If;
                      End Loop;
                    
                      If n_Tmp = 1 Then
                        n_父序号   := n_费用序号;
                        n_父项目id := Rs_Money(n_Idx).Id;
                      
                        Rs_Seek.Extend;
                        n_Tmp := Rs_Seek.Count;
                        Rs_Seek(n_Tmp).费用性质 := Rs_Money(n_Idx).费用性质;
                        Rs_Seek(n_Tmp).主项标签 := r_费用.Count;
                        Rs_Seek(n_Tmp).主收入id := Rs_Money(n_Idx).收入项目id;
                        v_Havesub := v_Havesub || ',' || Rs_Money(n_Idx).费用性质;
                        b_Bool := True;
                      Else
                        v_Nonesub := v_Nonesub || ',' || Rs_Money(n_Idx).费用性质;
                      End If;
                    End If;
                  End If;
                End If;
                --计算汇总折扣合计
                v_费别 := Mv_费别;
                If Gb_从项汇总折扣 And
                   (Rs_Money(n_Idx).从项 = 1 Or Instr(v_Havesub || ',', ',' || Rs_Money(n_Idx).费用性质 || ',') > 0) Then
                  If Vsadvice(I).零费记帐 = 1 Then
                    n_实收 := 0;
                  Else
                    n_实收 := n_应收;
                  End If;
                
                  --累计医嘱合计来计算折扣
                  For J In 1 .. Rs_Seek.Count Loop
                    If Rs_Seek(J).费用性质 = Rs_Money(n_Idx).费用性质 Then
                      Rs_Seek(J).合计 := Nvl(Rs_Seek(J).合计, 0) + n_实收;
                      Exit;
                    End If;
                  End Loop;
                Elsif Nvl(Rs_Money(n_Idx).屏蔽费别, 0) = 0 Then
                  If Gv_动态费别 Is Not Null And Not b_记帐 Then
                    v_费别 := Mv_费别 || ',' || Gv_动态费别;
                  End If;
                  If Vsadvice(I).零费记帐 = 1 Then
                    n_实收 := 0;
                  Else
                    n_Tmp  := 0;
                    n_实收 := Round(f_Actualmoney(v_费别, Rs_Money(n_Idx).收入项目id, n_应收, Rs_Money(n_Idx).Id, n_执行科室id,
                                                n_付数 * n_数量, n_Tmp, v_费别), Gn_Dec);
                  End If;
                  If Instr(v_费别, ',') > 0 Then
                    v_费别 := Mv_费别;
                  End If;
                Else
                  If Vsadvice(I).零费记帐 = 1 Then
                    n_实收 := 0;
                  Else
                    n_实收 := n_应收;
                  End If;
                End If;
                --汇总折扣时，对主项的实收金额作特殊处理,直接记入扩展字段中
                --(忽略)医保相关字段
                --收集记帐报警类别
                If Instr(v_类别, Rs_Money(n_Idx).类别) = 0 Then
                  v_类别 := v_类别 || Rs_Money(n_Idx).类别;
                End If;
                --发生时间
                If Vsadvice(I).分解时间 Is Not Null Then
                  d_发生时间 := To_Date(Substr(Vsadvice(I).分解时间, 1, 19), 'YYYY-MM-DD HH24:MI:SS');
                Else
                  d_发生时间 := To_Date(Substr(Vsadvice(I).分解时间_Data, 1, 19), 'YYYY-MM-DD HH24:MI:SS');
                End If;
                --因为现在不计价的医嘱不产生费用,所以传入的计价特性都为(0-正常计价)
                n_合计 := Nvl(n_合计, 0) + n_实收;
                If Not b_记帐 Then
                  r_费用(r_费用.Count).过程名 := 1;
                  d_登记时间 := d_Cur;
                Else
                  --是否划价费用
                  If Instr(Gv_住院发送划价单, Vsadvice(I).诊疗类别) > 0 Then
                    n_划价 := 1;
                  Else
                    n_划价 := 0;
                  End If;
                
                  If n_划价 = 0 Then
                    If Rs_Money(n_Idx).费用确认 = 1 Then
                      n_划价 := 1;
                    Else
                      n_划价 := 0;
                    End If;
                  End If;
                
                  If n_划价 = 0 Or n_执行状态 = 1 Then
                    If Nvl(Gn_消费验证, 0) <> 0 Then
                      n_记帐合计 := Nvl(n_记帐合计, 0) + n_实收;
                    End If;
                  End If;
                
                  --登记时间
                  If n_划价 = 1 Then
                    d_登记时间 := d_Cur + 1 / 24 / 60;
                  Else
                    d_登记时间 := d_Cur;
                  End If;
                  r_费用(r_费用.Count).过程名 := 2;
                End If;
              
                n_Tmp := r_费用.Count;
                r_费用(n_Tmp).No := v_No;
                r_费用(n_Tmp).主页id := Vsadvice(I).主页id;
                r_费用(n_Tmp).病人来源 := 2;
                r_费用(n_Tmp).保险编码 := Null;
                r_费用(n_Tmp).费用类型 := Null;
                r_费用(n_Tmp).保险项目否 := Null;
                r_费用(n_Tmp).保险大类id := Null;
                r_费用(n_Tmp).中药形态 := Null;
              
                r_费用(n_Tmp).序号 := n_费用序号;
                r_费用(n_Tmp).病人id := Mn_病人id;
                r_费用(n_Tmp).标识号 := Mn_标识号;
                r_费用(n_Tmp).姓名 := Mv_姓名;
                r_费用(n_Tmp).性别 := Mv_性别;
                r_费用(n_Tmp).年龄 := Mv_年龄;
              
                r_费用(n_Tmp).床号 := Mn_床号;
                r_费用(n_Tmp).病区id := Mn_病人病区id;
                r_费用(n_Tmp).科室id := Mn_病人科室id;
              
                r_费用(n_Tmp).费别 := v_费别;
                r_费用(n_Tmp).加班标志 := Null;
                r_费用(n_Tmp).婴儿费 := Vsadvice(I).婴儿;
                r_费用(n_Tmp).病人科室id := Vsadvice(I).开嘱科室id;
                r_费用(n_Tmp).开单部门id := Vsadvice(I).开嘱科室id;
                r_费用(n_Tmp).开单人 := Vsadvice(I).开嘱医生;
                If Rs_Money(n_Idx).从项 = 1 And n_父序号 > 0 Then
                  r_费用(n_Tmp).从属父号 := n_父序号;
                Else
                  r_费用(n_Tmp).从属父号 := Null;
                End If;
                r_费用(n_Tmp).收费细目id := Rs_Money(n_Idx).Id;
                r_费用(n_Tmp).收费类别 := Rs_Money(n_Idx).类别;
                r_费用(n_Tmp).计算单位 := Rs_Money(n_Idx).计算单位;
                r_费用(n_Tmp).付数 := n_付数;
                r_费用(n_Tmp).数次 := n_数量;
                If b_附加手术 Then
                  r_费用(n_Tmp).附加标志 := 1;
                Else
                  r_费用(n_Tmp).附加标志 := 0;
                End If;
                If n_执行科室id > 0 Then
                  r_费用(n_Tmp).执行部门id := n_执行科室id;
                Else
                  r_费用(n_Tmp).执行部门id := Null;
                End If;
                If n_费用父号 = n_费用序号 Then
                  r_费用(n_Tmp).价格父号 := Null;
                Else
                  r_费用(n_Tmp).价格父号 := n_费用父号;
                End If;
                r_费用(n_Tmp).收入项目id := Rs_Money(n_Idx).收入项目id;
                r_费用(n_Tmp).收据费目 := Rs_Money(n_Idx).收据费目;
                r_费用(n_Tmp).标准单价 := n_单价;
                r_费用(n_Tmp).应收金额 := n_应收;
                r_费用(n_Tmp).实收金额 := n_实收;
                r_费用(n_Tmp).发生时间 := d_发生时间;
                r_费用(n_Tmp).登记时间 := d_登记时间;
                r_费用(n_Tmp).药品摘要 := '医嘱发送';
                r_费用(n_Tmp).划价 := n_划价;
                r_费用(n_Tmp).操作员编号 := Mv_操作员编号;
                r_费用(n_Tmp).操作员姓名 := Mv_操作员姓名;
                r_费用(n_Tmp).记帐单id := Null;
                r_费用(n_Tmp).费用摘要 := Vsadvice(I).医嘱内容;
                r_费用(n_Tmp).医嘱序号 := Vsadvice(I).Id;
                r_费用(n_Tmp).频次 := Vsadvice(I).频率;
                r_费用(n_Tmp).单量 := Vsadvice(I).单量;
                r_费用(n_Tmp).用法 := Vsadvice(I).用法;
                r_费用(n_Tmp).期效 := 1;
                If b_离院带药 Then
                  r_费用(n_Tmp).计价特性 := 3;
                Else
                  r_费用(n_Tmp).计价特性 := Vsadvice(I).计价特性;
                End If;
                r_费用(n_Tmp).门诊标志 := 2;
                r_费用(n_Tmp).中药形态 := Null;
                r_费用(n_Tmp).备货材料 := 0;
                r_费用(n_Tmp).批次 := Zl_To_Number(Nvl(Vsadvice(I).检查方法, 0));
                --记录自动发料的SQL
                If Gb_住院自动发料 And b_记帐 And n_划价 = 0 And Nvl(n_执行科室id, 0) <> 0 And Rs_Money(n_Idx).类别 = '4' And
                   Nvl(Rs_Money(n_Idx).跟踪在用, 0) = 1 Then
                  If Instr(v_自动发料 || ';', ';' || v_No || ',' || n_执行科室id || ';') = 0 Then
                    r_发料.Extend;
                    n_Tmp := r_发料.Count;
                    r_发料(n_Tmp).Partid := n_执行科室id;
                    r_发料(n_Tmp).Bill := 25;
                    r_发料(n_Tmp).No := v_No;
                    r_发料(n_Tmp).People := Mv_操作员姓名;
                    r_发料(n_Tmp).配药人 := Mv_操作员姓名;
                    r_发料(n_Tmp).校验人 := Mv_操作员姓名;
                    r_发料(n_Tmp).发药方式 := 1;
                    r_发料(n_Tmp).发药时间 := Sysdate;
                    v_自动发料 := v_自动发料 || ';' || v_No || ',' || n_执行科室id;
                  End If;
                End If;
                --(忽略)医保管控实时监测：生成费用项目记录集,以收费细目汇总
              End If;
            End If;
          End Loop;
        End If;
      
        --对医嘱金额进行汇总折扣处理
        If Gb_从项汇总折扣 And v_Havesub Is Not Null Then
        
          For J In 1 .. Rs_Seek.Count Loop
            n_Tmp := Rs_Seek(J).主项标签;
          
            v_费别 := Mv_费别;
            If Gv_动态费别 Is Not Null And Not b_记帐 Then
              v_费别 := v_费别 || ',' || Gv_动态费别;
            End If;
          
            If Vsadvice(I).零费记帐 = 1 Then
              n_实收 := 0;
            Else
              n_实收 := Round(f_Actualmoney(v_费别, Rs_Seek(J).主收入id, Rs_Seek(J).合计, 0, 0, 0, 0, v_费别), Gn_Dec);
            
            End If;
          
            If Instr(v_费别, ',') > 0 Then
              v_费别 := Mv_费别;
            End If;
            --替换费别和实收
            r_费用(n_Tmp).费别 := v_费别;
          
            n_实收 := n_实收 - Rs_Seek(J).合计; --打折差额
            r_费用(n_Tmp).实收金额 := n_实收;
          
          End Loop;
        End If;
        --产生医嘱发送记录
        -------------------------------------
        If Nvl(Vsadvice(I).执行性质id, 0) <> 0 Then
          --叮嘱不发送(给药途径，配方煎法、用法,采集方法、输血途径可能为)
        
          --(忽略)医嘱的发送合性检查提示
          --一样要产生费用NO
          p_Getcurbillset(v_Nokey, -1, 0, b_记帐, v_No, n_Tmp, n_发送序号);
          --是否一组医嘱的第一医嘱行:药疗的第一药品行为第一医嘱行
          b_First := False;
          If Instr(',5,6,7,', Vsadvice(I).诊疗类别) > 0 Then
            If Nvl(Vsadvice(I).相关id, 0) <> Nvl(Vsadvice(I - 1).相关id, 0) Then
              b_First := True;
            End If;
          Elsif Vsadvice(I).诊疗类别 = 'C' And Nvl(Vsadvice(I).相关id, 0) <> 0 Then
            If Nvl(Vsadvice(I).相关id, 0) <> Nvl(Vsadvice(I - 1).相关id, 0) Then
              b_First := True; --检验组合中的第一检验行
            End If;
          Elsif Instr(',1,2,3,4,5,', ',' || Vsadvice(I).Id_Data || ',') = 0 Then
            --排开给药途径、中药煎法、中药用法、采集方法、输血途径
            If Nvl(Vsadvice(I).相关id, 0) = 0 Then
              b_First := True;
            End If;
          End If;
          --发送数次:药品为剂量单位的总量,其它为次数
          If Vsadvice(I).诊疗类别 = '7' Then
            n_发送数次 := Vsadvice(I).总量 * Vsadvice(I).单量;
          Elsif Instr(',5,6,', Vsadvice(I).诊疗类别) > 0 Then
            n_发送数次 := Vsadvice(I).总量 * Vsadvice(I).住院包装 * Vsadvice(I).剂量系数;
          Else
            n_发送数次 := Vsadvice(I).总量;
          End If;
        
          --首末时间
          v_分解时间 := Vsadvice(I).分解时间;
          If v_分解时间 Is Not Null Then
            d_首次时间 := To_Date(Substr(v_分解时间, 1, 19), 'YYYY-MM-DD HH24:MI:SS');
            d_末次时间 := To_Date(Substr(v_分解时间, Instr(v_分解时间, ',', -1) + 1, 19), 'YYYY-MM-DD HH24:MI:SS');
          Else
            --无法分解或为'一次性'临嘱，填为开始执行时间
            d_首次时间 := To_Date(Vsadvice(I).开始时间, 'YYYY-MM-DD HH24:MI:SS');
            d_末次时间 := d_首次时间;
          End If;
        
          r_发送.Extend;
          n_Tmp := r_发送.Count;
          r_发送(n_Tmp).医嘱id := Vsadvice(I).Id;
          r_发送(n_Tmp).发送号 := n_发送号;
          If b_记帐 Then
            r_发送(n_Tmp).记录性质 := 2;
          Else
            r_发送(n_Tmp).记录性质 := 1;
          End If;
          r_发送(n_Tmp).No := v_No;
          r_发送(n_Tmp).记录序号 := n_发送序号; --   病人医嘱发送.记录序号%Type,
          If n_发送数次 > 0 Then
            r_发送(n_Tmp).发送数次 := n_发送数次;
          Else
            r_发送(n_Tmp).发送数次 := Null;
          End If;
          r_发送(n_Tmp).首次时间 := d_首次时间;
          r_发送(n_Tmp).末次时间 := d_末次时间;
          r_发送(n_Tmp).发送时间 := d_Cur;
          r_发送(n_Tmp).执行状态 := n_执行状态;
          r_发送(n_Tmp).执行部门id := Vsadvice(I).执行科室id;
          r_发送(n_Tmp).计费状态 := n_计费状态;
          If b_First Then
            r_发送(n_Tmp).First := 1;
          Else
            r_发送(n_Tmp).First := 0;
          End If;
          r_发送(n_Tmp).样本条码 := v_Cuvettenumber;
          r_发送(n_Tmp).操作员编号 := Mv_操作员编号;
          r_发送(n_Tmp).操作员姓名 := Mv_操作员姓名;
        
          --医嘱执行计价
          For J In 1 .. Rs_Exec.Count Loop
            If Rs_Exec(J).医嘱id = Vsadvice(I).Id And Rs_Exec(J).发送号 = n_发送号 Then
              r_执行计价.Extend;
              n_Tmp := r_执行计价.Count;
              r_执行计价(n_Tmp).医嘱id := Rs_Exec(J).医嘱id;
              r_执行计价(n_Tmp).发送号 := n_发送号;
              r_执行计价(n_Tmp).要求时间 := To_Date(Rs_Exec(J).要求时间, 'YYYY-MM-DD HH24:MI:SS');
              r_执行计价(n_Tmp).收费细目id := Rs_Exec(J).收费细目id;
              r_执行计价(n_Tmp).数量 := Rs_Exec(J).数量;
              r_执行计价(n_Tmp).费用性质 := 0;
            End If;
          End Loop;
          --(忽略)血库系统调用 Zl_血液配血费用_Insert
          --(忽略)要发送的尚未签名的医嘱ID(组ID,一组中的叮嘱也会被签名)
        End If;
        --计算中药配方数
        If Vsadvice(I).Id_Data = '3' Then
          --中药用法
          n_配方数 := n_配方数 + 1;
        End If;
      End Loop;
      --(忽略)自动进行电子签名(未签名部份)
      --(忽略)医保管控实时监测
      --(忽略)调用外挂接口
      Return(1);
    End;
  
    --提交本次发送的HIS数据
    Procedure p_Completepatisend Is
    Begin
      p_Replacetrueno;
      For I In 1 .. r_计价.Count Loop
        If r_计价(I).过程名 = 1 Then
          Zl_病人医嘱计价_Delete(r_计价(I).医嘱id, r_计价(I).删单行);
        Else
          Zl_病人医嘱计价_Insert(r_计价(I).医嘱id, r_计价(I).收费细目id, r_计价(I).数量, r_计价(I).单价, r_计价(I).从项, r_计价(I).执行科室id,
                           r_计价(I).费用性质, r_计价(I).收费方式);
        End If;
      End Loop;
    
      For I In 1 .. r_费用.Count Loop
        If r_费用(I).过程名 = 1 Then
          Zl_门诊划价记录_Insert(r_费用(I).No, r_费用(I).序号, r_费用(I).病人id, r_费用(I).主页id, r_费用(I).标识号, r_费用(I).付款方式, r_费用(I).姓名,
                           r_费用(I).性别, r_费用(I).年龄, r_费用(I).费别, r_费用(I).加班标志, r_费用(I).病人科室id, r_费用(I).开单部门id, r_费用(I).开单人,
                           r_费用(I).从属父号, r_费用(I).收费细目id, r_费用(I).收费类别, r_费用(I).计算单位, r_费用(I).发药窗口, r_费用(I).付数,
                           r_费用(I).数次, r_费用(I).附加标志, r_费用(I).执行部门id, r_费用(I).价格父号, r_费用(I).收入项目id, r_费用(I).收据费目,
                           r_费用(I).标准单价, r_费用(I).应收金额, r_费用(I).实收金额, r_费用(I).发生时间, r_费用(I).登记时间, r_费用(I).药品摘要,
                           r_费用(I).操作员姓名, r_费用(I).费用摘要, r_费用(I).医嘱序号, r_费用(I).频次, r_费用(I).单量, r_费用(I).用法, r_费用(I).期效,
                           r_费用(I).计价特性, r_费用(I).病人来源, r_费用(I).保险编码, r_费用(I).费用类型, r_费用(I).保险项目否, r_费用(I).保险大类id,
                           r_费用(I).中药形态, r_费用(I).备货材料, r_费用(I).批次);
        Else
          Zl_住院记帐记录_Insert(r_费用(I).No, r_费用(I).序号, r_费用(I).病人id, r_费用(I).主页id, r_费用(I).标识号, r_费用(I).姓名, r_费用(I).性别,
                           r_费用(I).年龄, r_费用(I).床号, r_费用(I).费别, r_费用(I).病区id, r_费用(I).科室id, r_费用(I).加班标志, r_费用(I).婴儿费,
                           r_费用(I).开单部门id, r_费用(I).开单人, r_费用(I).从属父号, r_费用(I).收费细目id, r_费用(I).收费类别, r_费用(I).计算单位,
                           r_费用(I).保险项目否, r_费用(I).保险大类id, r_费用(I).保险编码, r_费用(I).付数, r_费用(I).数次, r_费用(I).附加标志,
                           r_费用(I).执行部门id, r_费用(I).价格父号, r_费用(I).收入项目id, r_费用(I).收据费目, r_费用(I).标准单价, r_费用(I).应收金额,
                           r_费用(I).实收金额, r_费用(I).统筹金额, r_费用(I).发生时间, r_费用(I).登记时间, r_费用(I).药品摘要, r_费用(I).划价,
                           r_费用(I).操作员编号, r_费用(I).操作员姓名, r_费用(I).多病人单, r_费用(I).类别id, r_费用(I).记帐单id, r_费用(I).费用摘要,
                           r_费用(I).是否急诊, r_费用(I).医嘱序号, r_费用(I).频次, r_费用(I).单量, r_费用(I).用法, r_费用(I).期效, r_费用(I).计价特性,
                           r_费用(I).简单记帐, r_费用(I).费用类型, r_费用(I).医技补临床费用, r_费用(I).领药部门id, r_费用(I).中药形态, r_费用(I).医疗小组id,
                           r_费用(I).备货材料, r_费用(I).批次);
        End If;
      End Loop;
    
      For I In 1 .. r_发送.Count Loop
        Zl_病人医嘱发送_Insert(r_发送(I).医嘱id, r_发送(I).发送号, r_发送(I).记录性质, r_发送(I).No, r_发送(I).记录序号, r_发送(I).发送数次, r_发送(I).首次时间,
                         r_发送(I).末次时间, r_发送(I).发送时间, r_发送(I).执行状态, r_发送(I).执行部门id, r_发送(I).计费状态, r_发送(I).First,
                         r_发送(I).样本条码, r_发送(I).操作员编号, r_发送(I).操作员姓名, Null, Null,
                         To_Char(Sysdate, 'yyyy-mm-dd hh24:mi:ss'), Null);
      End Loop;
    
      For I In 1 .. r_执行计价.Count Loop
        Zl_医嘱执行计价_Insert(r_执行计价(I).医嘱id, r_执行计价(I).发送号, r_执行计价(I).要求时间, r_执行计价(I).收费细目id, r_执行计价(I).数量, r_执行计价(I).费用性质);
      End Loop;
    
      For I In 1 .. r_发料.Count Loop
        Zl_材料收发记录_处方发料(r_发料(I).Partid, r_发料(I).Bill, r_发料(I).No, r_发料(I).People, r_发料(I).配药人, r_发料(I).校验人, r_发料(I).发药方式,
                       r_发料(I).发药时间);
      End Loop;
    Exception
      When Others Then
        Rollback;
        p_Errcenter(SQLErrM);
        --zl_ErrorCenter(SQLCode, SQLErrM);
    End;
  Begin
    --传入参数
    Select Extractvalue(Value(A), 'IN/BRID') As 病人id, Extractvalue(Value(A), 'IN/JZID') As 就诊id,
           Extractvalue(Value(A), 'IN/YZID') As 医嘱id, Extractvalue(Value(A), 'IN/CZYXM') As 操作员,
           Extractvalue(Value(A), 'IN/CZYBH') As 操作员编号, To_Number(Nvl(Extractvalue(Value(A), 'IN/FSSFBS'), 0))
    Into n_病人id, n_就诊id, v_医嘱ids, v_操作员姓名, v_操作员编号, Gn_发送收费标识
    From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  
    I := f_Main(n_就诊id, n_病人id, v_医嘱ids, v_操作员编号, v_操作员姓名);
    p_Load;
    I := f_Loadadvicesend;
    If I = 1 Then
      I := f_Sendadvice;
      p_Completepatisend;
    End If;
    If x_t Is Null Then
      v_Tmp   := '<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>';
      Xml_Out := Xmltype(v_Tmp);
    Else
      Xml_Out := x_t;
    End If;
  Exception
    When Others Then
      v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
      Xml_Out := Xmltype(v_Tmp);
      zl_ErrorCenter(SQLCode, SQLErrM);
  End;

Begin
  --读取医嘱信息
  Select To_Number(Extractvalue(Value(A), 'IN/YZXX/BRID')), To_Number(Extractvalue(Value(A), 'IN/YZXX/JZID')),
         To_Number(Extractvalue(Value(A), 'IN/YZXX/BRLY')), Extractvalue(Value(A), 'IN/YZXX/ZLXMID'),
         Extractvalue(Value(A), 'IN/YZXX/ZLXMMC'), Extractvalue(Value(A), 'IN/YZXX/JJBZ'),
         To_Number(Nvl(Extractvalue(Value(A), 'IN/YZXX/FSYZBS'), 0)),
         To_Number(Nvl(Extractvalue(Value(A), 'IN/YZXX/YZID'), 0)),
         To_Number(Nvl(Extractvalue(Value(A), 'IN/YZXX/FSSFBS'), 0))
  Into n_病人id, n_就诊id, n_病人来源, v_诊疗项目id, v_诊疗项目名称, n_紧急标志, n_发送标识, n_医嘱id, n_收费标识
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Extractvalue(Value(A), 'IN/YZXX/KZYS'), Extractvalue(Value(A), 'IN/YZXX/KZSJ'),
         To_Number(Extractvalue(Value(A), 'IN/YZXX/KZKSID')), To_Number(Extractvalue(Value(A), 'IN/YZXX/ZXKSID')),
         Extractvalue(Value(A), 'IN/YZXX/BWFFALL')
  Into v_申请医生, v_申请时间, n_申请科室id, n_执行科室id, v_方法部位总述
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_病人id, 0) = 0 Or Nvl(n_就诊id, 0) = 0 Then
    v_Err_Msg := '未传入完整的申请条件,无法完成申请!';
    Raise Err_Item;
  End If;

  --获取一组医嘱ids
  If Nvl(n_医嘱id, 0) > 0 Then
    Select f_List2str(Cast(Collect(c.Id || '') As t_Strlist)) Into v_医嘱ids From 病人医嘱记录 c Where c.相关id = n_医嘱id;
    If v_医嘱ids Is Not Null Then
      v_医嘱ids := n_医嘱id || ',' || v_医嘱ids;
    Else
      v_医嘱ids := n_医嘱id ;
    End If;
  End If;

  If v_方法部位总述 Is Not Null Then
    v_方法部位总述 := ':' || v_方法部位总述;
  End If;

  If Nvl(n_病人来源, 0) = 1 Then
    Select NO Into v_挂号单 From 病人挂号记录 Where ID = n_就诊id And 病人id = n_病人id;
  End If;

  --当前操作人员
  If v_申请医生 Is Null Then
    v_Temp       := Zl_Identity(1);
    v_Temp       := Substr(v_Temp, Instr(v_Temp, ';') + 1);
    v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
    v_操作员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
    v_操作员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);
    v_申请医生   := v_操作员姓名;
  Else
    v_操作员姓名 := v_申请医生;
    Select Max(编号) Into v_操作员编号 From 人员表 Where 姓名 = v_申请医生;
  End If;

  If n_发送标识 = 1 Or n_发送标识 = 3 Then
    Select 病人医嘱记录_Id.Nextval Into n_医嘱id From Dual;
    v_医嘱ids := n_医嘱id;
  End If;

  If Nvl(n_病人来源, 0) = 1 Then
    --生成门诊医嘱部分
    If n_发送标识 = 1 Or n_发送标识 = 3 Then
      Select Nvl(Max(序号), 0) + 1 Into n_序号 From 病人医嘱记录 Where 挂号单 = v_挂号单;
    
      Zl_病人医嘱记录_Insert(n_医嘱id, Null, n_序号, n_病人来源, n_病人id, Null, 0, 1, 1, 'D', v_诊疗项目id, Null, Null, Null, 1,
                       v_诊疗项目名称 || v_方法部位总述, Null, Null, '一次性', Null, Null, Null, Null, 0, n_执行科室id, 4, n_紧急标志,
                       To_Date(v_申请时间, 'yyyy-MM-dd HH24:MI:SS'), Null, n_申请科室id, n_申请科室id, v_申请医生,
                       To_Date(v_申请时间, 'yyyy-MM-dd HH24:MI:SS'), v_挂号单, Null, Null, 0, Null, Null, v_操作员姓名, Null, Null,
                       '', Null, Null, '', Null, Null, Null, Null, Null, Null);
      If v_方法部位总述 Is Not Null Then
        --添加部位方法 
        For Y In (Select b.部位, b.方法
                  From Xmltable('$a/IN/YZXX/BWLIST/BWFF' Passing Xml_In As "a" Columns 部位 Varchar2(60) Path 'BW',
                                 方法 Varchar2(60) Path 'FF') B) Loop
          Select 病人医嘱记录_Id.Nextval Into n_子医嘱id From Dual;
          Select Nvl(Max(序号), 0) + 1 Into n_序号 From 病人医嘱记录 Where 挂号单 = v_挂号单;
        
          v_医嘱ids := v_医嘱ids || ',' || n_子医嘱id;
          Zl_病人医嘱记录_Insert(n_子医嘱id, n_医嘱id, n_序号, n_病人来源, n_病人id, Null, 0, 1, 1, 'D', v_诊疗项目id, Null, Null, Null, 1,
                           v_诊疗项目名称, Null, y.部位, '一次性', Null, Null, Null, Null, 0, n_执行科室id, 4, n_紧急标志,
                           To_Date(v_申请时间, 'yyyy-MM-dd HH24:MI:SS'), Null, n_申请科室id, n_申请科室id, v_申请医生,
                           To_Date(v_申请时间, 'yyyy-MM-dd HH24:MI:SS'), v_挂号单, Null, y.方法, 0, Null, Null, v_操作员姓名, Null,
                           Null, '', Null, Null, '', Null, Null, Null, Null, Null, Null);
        End Loop;
      End If;
    End If;
    If n_发送标识 = 2 Or n_发送标识 = 3 Then
    
      --医嘱签名处理
      Select To_Number(Extractvalue(Value(A), 'IN/YZXX/QMGZ')), Extractvalue(Value(A), 'IN/YZXX/QMXX'),
             To_Number(Extractvalue(Value(A), 'IN/YZXX/ZSID')),
             To_Date(Extractvalue(Value(A), 'IN/YZXX/SJC'), 'yyyy-MM-dd HH24:MI:SS'),
             Extractvalue(Value(A), 'IN/YZXX/SJCXX')
      Into n_签名规则, v_签名信息, n_证书id, d_时间戳, v_时间戳信息
      From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
    
      If v_签名信息 Is Not Null Then
        Select 医嘱签名记录_Id.Nextval Into n_签名id From Dual;
        Zl_医嘱签名记录_Insert(n_签名id, 1, n_签名规则, v_签名信息, n_证书id, v_医嘱ids, d_时间戳, v_操作员姓名, v_时间戳信息);
      End If;
    
      --重新生成发送接口的入参
      Select Xmlelement("IN",
                         Xmlforest(n_病人id As "BRID", n_就诊id As "JZID", v_医嘱ids As "YZID", v_操作员姓名 As "CZYXM",
                                    v_操作员编号 As "CZYBH", Null As "ZD", 0 As "JZD", Null As "JBJJ", Null As "CLLIS",
                                    Null As "FHLISDATA")) As 数据
      Into x_Par
      From Dual;
    
      Zl_Third_Advicesend(x_Par, x_Tmp);
    
      Select Extractvalue(Value(A), 'OUTPUT/ERROR/MSG')
      Into v_Err_Msg
      From Table(Xmlsequence(Extract(x_Tmp, 'OUTPUT'))) A;
      If v_Err_Msg Is Not Null Then
        Raise Err_Item;
      End If;
    End If;
  Else
    --生成住院医嘱部分
  
    If n_发送标识 = 1 Or n_发送标识 = 3 Then
      Select Nvl(Max(序号), 0) + 1 Into n_序号 From 病人医嘱记录 Where 病人id = n_病人id And 主页id = n_就诊id;
    
      Zl_病人医嘱记录_Insert(n_医嘱id, Null, n_序号, n_病人来源, n_病人id, n_就诊id, 0, 1, 1, 'D', v_诊疗项目id, Null, Null, Null, 1,
                       v_诊疗项目名称 || v_方法部位总述, Null, Null, '一次性', Null, Null, Null, Null, 0, n_执行科室id, 4, n_紧急标志,
                       To_Date(v_申请时间, 'yyyy-MM-dd HH24:MI:SS'), Null, n_申请科室id, n_申请科室id, v_申请医生,
                       To_Date(v_申请时间, 'yyyy-MM-dd HH24:MI:SS'), Null, Null, Null, 0, Null, Null, v_操作员姓名, Null, Null,
                       '', Null, Null, '', Null, Null, Null, Null, Null, Null);
    
      If v_方法部位总述 Is Not Null Then
        --添加部位方法 
        For Y In (Select b.部位, b.方法
                  From Xmltable('$a/IN/YZXX/BWLIST/BWFF' Passing Xml_In As "a" Columns 部位 Varchar2(60) Path 'BW',
                                 方法 Varchar2(60) Path 'FF') B) Loop
          Select 病人医嘱记录_Id.Nextval Into n_子医嘱id From Dual;
          Select Nvl(Max(序号), 0) + 1 Into n_序号 From 病人医嘱记录 Where 病人id = n_病人id And 主页id = n_就诊id;
        
          v_医嘱ids := v_医嘱ids || ',' || n_子医嘱id;
          Zl_病人医嘱记录_Insert(n_子医嘱id, n_医嘱id, n_序号, n_病人来源, n_病人id, n_就诊id, 0, 1, 1, 'D', v_诊疗项目id, Null, Null, Null, 1,
                           v_诊疗项目名称, Null, y.部位, '一次性', Null, Null, Null, Null, 0, n_执行科室id, 4, n_紧急标志,
                           To_Date(v_申请时间, 'yyyy-MM-dd HH24:MI:SS'), Null, n_申请科室id, n_申请科室id, v_申请医生,
                           To_Date(v_申请时间, 'yyyy-MM-dd HH24:MI:SS'), Null, Null, y.方法, 0, Null, Null, v_操作员姓名, Null,
                           Null, '', Null, Null, '', Null, Null, Null, Null, Null, Null, 1);
        End Loop;
      End If;
    
    End If;
  
    If n_发送标识 = 2 Or n_发送标识 = 3 Then
      --医嘱签名处理
      Select To_Number(Extractvalue(Value(A), 'IN/YZXX/QMGZ')), Extractvalue(Value(A), 'IN/YZXX/QMXX'),
             To_Number(Extractvalue(Value(A), 'IN/YZXX/ZSID')),
             To_Date(Extractvalue(Value(A), 'IN/YZXX/SJC'), 'yyyy-MM-dd HH24:MI:SS'),
             Extractvalue(Value(A), 'IN/YZXX/SJCXX')
      Into n_签名规则, v_签名信息, n_证书id, d_时间戳, v_时间戳信息
      From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
    
      If v_签名信息 Is Not Null Then
        Select 医嘱签名记录_Id.Nextval Into n_签名id From Dual;
        Zl_医嘱签名记录_Insert(n_签名id, 1, n_签名规则, v_签名信息, n_证书id, v_医嘱ids, d_时间戳, v_操作员姓名, v_时间戳信息);
      End If;
    
      For r_主医嘱 In (Select ID
                    From 病人医嘱记录
                    Where ID In (Select /*+cardinality(x,10)*/
                                  x.Column_Value
                                 From Table(f_Num2list(v_医嘱ids)) X) And 相关id Is Null) Loop
      
        Zl_病人医嘱记录_校对(r_主医嘱.Id, '3', Sysdate, Null, Null, v_操作员编号, v_操作员姓名);
      End Loop;
    
      --重新生成发送接口的入参
      Select Xmlelement("IN",
                         Xmlforest(n_病人id As "BRID", n_就诊id As "JZID", v_医嘱ids As "YZID", v_操作员姓名 As "CZYXM",
                                    v_操作员编号 As "CZYBH", n_收费标识 As "FSSFBS")) As 数据
      Into x_Par
      From Dual;
      Advicesend_Bl(x_Par, x_Tmp);
      Select Extractvalue(Value(A), 'OUTPUT/ERROR/MSG')
      Into v_Err_Msg
      From Table(Xmlsequence(Extract(x_Tmp, 'OUTPUT'))) A;
      If v_Err_Msg Is Not Null Then
        Raise Err_Item;
      End If;
    End If;
  End If;

  --获取医嘱的最新的发送号
  If n_发送标识 = 2 Or n_发送标识 = 3 Then
    Select Max(发送号), Max(NO)
    Into n_发送号, v_No号
    From 病人医嘱发送
    Where 医嘱id In (Select /*+cardinality(x,10)*/
                    x.Column_Value
                   From Table(f_Num2list(v_医嘱ids)) X);
  End If;
  x_Templet := Xmltype('<OUTPUT><YZID>' || n_医嘱id || '</YZID><YZIDS>' || v_医嘱ids || '</YZIDS><FSH>' || n_发送号 ||
                       '</FSH><NO>' || v_No号 || '</NO></OUTPUT>');

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Applypathology;
/

Create Or Replace Procedure Zl_Third_Getadvicesignsource
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:单条医嘱获取医嘱签名原文

  --入参:Xml_In:
  --<IN>
  --  <QMLX></QMLX>--签名类型 对应为1-新开,4-作废
  --  <YZID></YZID>--主医嘱ID
  --  <CZYXM></CZYXM>--操作员姓名
  --</IN>

  --出参
  --<OUTPUT>
  --  <QMYW></QMYW>--签名源文，参考ZLHIS获取源文方式拼串返回
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_签名类型 Number;
  n_主医嘱id Number;

  v_操作员姓名 Varchar(200);

  v_Source Varchar(4000);

  v_分隔符 Varchar(4000);

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/QMLX')), To_Number(Extractvalue(Value(A), 'IN/YZID')),
         Extractvalue(Value(A), 'IN/CZYXM')
  Into n_签名类型, n_主医嘱id, v_操作员姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  v_分隔符 := '[分隔]';

  If n_签名类型 = 1 Then
    For v_医嘱信息 In (Select Nvl(a.Id, '') || v_分隔符 || Nvl(a.相关id, '') || v_分隔符 || Nvl(a.姓名, '') || v_分隔符 || Nvl(a.性别, '') ||
                           v_分隔符 || Nvl(a.年龄, '') || v_分隔符 || Nvl(a.婴儿, '') || v_分隔符 || Nvl(a.医嘱期效, '') || v_分隔符 ||
                           Nvl(To_Char(a.开始执行时间, 'yyyy-MM-dd HH24:MI:SS'), '') || v_分隔符 || Nvl(a.医嘱内容, '') || v_分隔符 ||
                           Nvl(a.标本部位, '') || v_分隔符 || Nvl(a.单次用量, '') || v_分隔符 || Nvl(a.总给予量, '') || v_分隔符 ||
                           Nvl(a.医生嘱托, '') || v_分隔符 || Nvl(a.执行频次, '') || v_分隔符 || Nvl(a.频率次数, '') || v_分隔符 ||
                           Nvl(a.频率间隔, '') || v_分隔符 || Nvl(a.间隔单位, '') || v_分隔符 || Nvl(a.执行时间方案, '') || v_分隔符 ||
                           Nvl(a.执行性质, '') || v_分隔符 || Nvl(a.紧急标志, '') || v_分隔符 || Nvl(a.开嘱医生, '') || v_分隔符 ||
                           Nvl(To_Char(a.开嘱时间, 'yyyy-MM-dd HH24:MI:SS'), '') As 签名原文
                   From 病人医嘱记录 A, 病人医嘱状态 B
                   Where a.Id = b.医嘱id And Nvl(b.签名id, 0) = 0 And b.操作类型 = 1 And a.医嘱状态 = 1 And
                         Decode(a.审核标记, 1, Substr(a.开嘱医生, 1, Instr(a.开嘱医生, '/') - 1),
                                Substr(a.开嘱医生, Instr(a.开嘱医生, '/') + 1)) = v_操作员姓名 And Exists
                    (Select m.姓名
                          From 人员表 M, 执业类别 N
                          Where m.姓名 = Decode(a.审核标记, 1, Substr(a.开嘱医生, 1, Instr(a.开嘱医生, '/') - 1),
                                              Substr(a.开嘱医生, Instr(a.开嘱医生, '/') + 1)) And m.执业类别 = n.编码 And
                                n.分类 In ('执业医师', '执业助理医师')) And
                         a.Id In (Select n_主医嘱id As ID
                                  From Dual
                                  Union All
                                  Select ID From 病人医嘱记录 Where 相关id = n_主医嘱id)
                   Order By a.婴儿, Nvl(a.相关id, a.Id), a.序号) Loop
      v_Source := v_Source || Chr(13) || Chr(10) || v_医嘱信息.签名原文;
    End Loop;
  Elsif n_签名类型 = 4 Then
    For v_医嘱信息 In (Select Nvl(a.Id, '') || v_分隔符 || Nvl(a.相关id, '') || v_分隔符 || Nvl(a.姓名, '') || v_分隔符 || Nvl(a.性别, '') ||
                           v_分隔符 || Nvl(a.年龄, '') || v_分隔符 || Nvl(a.婴儿, '') || v_分隔符 || Nvl(a.医嘱期效, '') || v_分隔符 ||
                           Nvl(To_Char(a.开始执行时间, 'yyyy-MM-dd HH24:MI:SS'), '') || v_分隔符 || Nvl(a.医嘱内容, '') || v_分隔符 ||
                           Nvl(a.标本部位, '') || v_分隔符 || Nvl(a.单次用量, '') || v_分隔符 || Nvl(a.总给予量, '') || v_分隔符 ||
                           Nvl(a.医生嘱托, '') || v_分隔符 || Nvl(a.执行频次, '') || v_分隔符 || Nvl(a.频率次数, '') || v_分隔符 ||
                           Nvl(a.频率间隔, '') || v_分隔符 || Nvl(a.间隔单位, '') || v_分隔符 || Nvl(a.执行时间方案, '') || v_分隔符 ||
                           Nvl(a.执行性质, '') || v_分隔符 || Nvl(a.紧急标志, '') || v_分隔符 || Nvl(a.开嘱医生, '') || v_分隔符 ||
                           Nvl(To_Char(a.开嘱时间, 'yyyy-MM-dd HH24:MI:SS'), '') As 签名原文
                   From 病人医嘱记录 A, 病人医嘱状态 B
                   Where a.Id = b.医嘱id And Nvl(b.签名id, 0) > 0 And b.操作类型 = 1 And
                         a.Id In (Select n_主医嘱id As ID
                                  From Dual
                                  Union All
                                  Select ID From 病人医嘱记录 Where 相关id = n_主医嘱id)
                   Order By a.婴儿, Nvl(a.相关id, a.Id), a.序号) Loop
      v_Source := v_Source || Chr(13) || Chr(10) || v_医嘱信息.签名原文;
    End Loop;
  End If;

  Xml_Out := Xmltype('<OUTPUT> <QMYW>' || Substr(v_Source, 3) || '</QMYW><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getadvicesignsource;
/



Create Or Replace Procedure Zl_Third_Checksign
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:判断是否启用医嘱签名

  --入参:Xml_In:
  --<IN>
  --  <QMCH></QMCH>--签名场合，0-门诊医嘱；1-住院医嘱
  --  <KZKSID></KZKSID>--开嘱科室ID
  --</IN>

  --出参
  --<OUTPUT>
  --  <SFQY></SFQY>--是否启用签名，0-未启用，1-启用
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Para Varchar2(100);

  n_签名场合   Number;
  n_开嘱科室id Number;
  n_是否启用   Number;

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/QMCH')), To_Number(Extractvalue(Value(A), 'IN/KZKSID'))
  Into n_签名场合, n_开嘱科室id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  v_Para     := zl_GetSysParameter(26);
  n_是否启用 := 0;
  If Substr(v_Para, n_签名场合 + 1, 1) = '1' Then
    n_是否启用 := Nvl(Zl_Fun_Getsignpar(n_签名场合, n_开嘱科室id), 0);
  End If;

  Xml_Out := Xmltype('<OUTPUT> <SFQY>' || n_是否启用 || '</SFQY><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Checksign;
/


Create Or Replace Procedure Zl_Third_Newidentitycertinfo
(
  Xml_In        In Xmltype,
  Pati_Image_In Blob,
  Xml_Out       Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:新建指定病人的病人实名信息
  --入参:Xml_In:
  --<IN>
  --  <PATI_NAME></PATI_NAME> --姓名
  --  <SEX></SEX>             --性别
  --  <BIRTH_DATE></BIRTH_DATE>  --出生日期
  --  <COUNTRY></COUNTRY>        --国籍
  --  <NATION></NATION>          --民族
  --  <BIRTH_PLACE></BIRTH_PLACE>    --出生地点
  --  <ADDRESS></ADDRESS>        --住址
  --  <ID_NUMBER></ID_NUMBER>    --身份证号
  --  <P_PATI_NAME></P_PATI_NAME>    --陪诊人姓名
  --  <P_SEX></P_SEX>     --陪诊人性别
  --  <P_BIRTH_DATE></P_BIRTH_DATE>    --陪诊人出生日期
  --  <P_COUNTRY></P_COUNTRY>     --陪诊人国籍
  --  <P_NATION></P_NATION>    --陪诊人民族
  --  <P_ADDRESS></P_ADDRESS>   --陪诊人住址
  --  <P_ID_NUMBER></P_ID_NUMBER>     --陪诊人身份证号
  --  <P_RELATION></P_RELATION>    --陪诊人关系
  --  <PHONE_NUMBER></PHONE_NUMBER>   --手机号
  --  <NOTE></NOTE>    --备注
  --  <STATE></STATE>   --认证状态(只能是0-待审核，1-已认证)
  --  <OTHER_CERTS>
  --      <CERT>
  --          <CERT_TYPE></CERT_TYPE>    --证件类型
  --          <CERT_NUMBER></CERT_NUMBER>    --证件号码
  --          <CERT_NOTE></CERT_NOTE>    --证件备注
  --          <CERT_OWNER></CERT_OWNER>     --所有者
  --      </CERT>
  --  </OTHER_CERTS>    --其他证件
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <RESULT></RESULT>   --执行结果
  --  <CERT_ID></CERT_ID>    --实名ID
  --  <PATI_ID></PATI_ID>    --病人ID
  --  <V_CARDNO></V_CARDNO>    --虚拟卡号(-病人ID)
  --  <ERROR>
  --      <MSG></MSG>    --错误信息
  --  </ERROR>    --正常则无此结点
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_姓名           病人实名信息.姓名%Type;
  v_性别           病人实名信息.性别%Type;
  d_出生日期       病人实名信息.出生日期%Type;
  v_国籍           病人实名信息.国籍%Type;
  v_民族           病人实名信息.民族%Type;
  v_出生地点       病人实名信息.出生地点%Type;
  v_住址           病人实名信息.住址%Type;
  v_身份证号       病人实名信息.身份证号%Type;
  v_陪诊人姓名     病人实名信息.陪诊人姓名%Type;
  v_陪诊人性别     病人实名信息.陪诊人性别%Type;
  d_陪诊人出生日期 病人实名信息.陪诊人出生日期%Type;
  v_陪诊人国籍     病人实名信息.陪诊人国籍%Type;
  v_陪诊人民族     病人实名信息.陪诊人民族%Type;
  v_陪诊人住址     病人实名信息.陪诊人住址%Type;
  v_陪诊人身份证号 病人实名信息.陪诊人身份证号%Type;
  v_陪诊人关系     病人实名信息.陪诊人关系%Type;
  v_备注           病人实名信息.备注%Type;
  v_手机号         病人实名信息.手机号%Type;
  v_证件号码       病人实名证件.证件号码%Type;
  n_所有者         病人实名证件.所有者%Type;

  Type r_证件 Is Record(
    证件类型 病人实名证件.证件类型%Type,
    证件号码 病人实名证件.证件号码%Type,
    证件备注 病人实名证件.备注%Type,
    所有者   病人实名证件.所有者%Type);

  Type t_证件 Is Table Of r_证件;
  Rs_Sql证件 t_证件 := t_证件();

  v_病人出生日期   Varchar2(20);
  v_陪诊人出生日期 Varchar2(20);
  v_建档人         Varchar2(40);
  v_认证状态       Varchar2(2);
  v_证件信息       Varchar2(4000);
  v_Error          Varchar2(200);
  v_Tmp            Varchar2(4000);
  v_Result         Varchar2(200);
  n_No             Number(18);
  I                Number(18);
  n_New            Number(1);
  n_Id             Number(18);
  n_病人id         Number(18);
  n_实名id         Number(18);
  v_虚拟病人id     Varchar2(20);
  n_实名信息id     Number(18);
  n_Count          Number(5);
  Err_Item Exception;
Begin
  --解析XML节点
  Select Extractvalue(Value(A), 'IN/PATI_NAME') As 姓名, Extractvalue(Value(A), 'IN/SEX') As 性别,
         Extractvalue(Value(A), 'IN/BIRTH_DATE') As 出生日期, Extractvalue(Value(A), 'IN/COUNTRY') As 国籍,
         Extractvalue(Value(A), 'IN/NATION') As 民族, Extractvalue(Value(A), 'IN/BIRTH_PLACE') As 出生地点,
         Extractvalue(Value(A), 'IN/ADDRESS') As 住址, Extractvalue(Value(A), 'IN/ID_NUMBER') As 身份证号,
         Extractvalue(Value(A), 'IN/P_PATI_NAME') As 陪诊人姓名, Extractvalue(Value(A), 'IN/P_SEX') As 陪诊人性别,
         Extractvalue(Value(A), 'IN/P_BIRTH_DATE') As 陪诊人出生日期, Extractvalue(Value(A), 'IN/P_COUNTRY') As 陪诊人国籍,
         Extractvalue(Value(A), 'IN/P_NATION') As 陪诊人民族, Extractvalue(Value(A), 'IN/P_ADDRESS') As 陪诊人住址,
         Extractvalue(Value(A), 'IN/P_ID_NUMBER') As 陪诊人身份证号, Extractvalue(Value(A), 'IN/P_RELATION') As 陪诊人关系,
         Extractvalue(Value(A), 'IN/PHONE_NUMBER') As 手机号, Extractvalue(Value(A), 'IN/NOTE') As 备注,
         Extractvalue(Value(A), 'IN/STATE') As 认证状态
  Into v_姓名, v_性别, v_病人出生日期, v_国籍, v_民族, v_出生地点, v_住址, v_身份证号, v_陪诊人姓名, v_陪诊人性别, v_陪诊人出生日期, v_陪诊人国籍, v_陪诊人民族, v_陪诊人住址,
       v_陪诊人身份证号, v_陪诊人关系, v_手机号, v_备注, v_认证状态
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  d_出生日期       := To_Date(v_病人出生日期, 'YYYY-MM-DD HH:MI:SS');
  d_陪诊人出生日期 := To_Date(v_陪诊人出生日期, 'YYYY-MM-DD HH:MI:SS');

  For X In (Select b.证件, b.证件类型, b.证件号码, b.所有者, b.证件备注
            From Xmltable('$a/IN/OTHER_CERTS/CERT' Passing Xml_In As "a" Columns 证件 Xmltype Path 'CERT',
                           证件类型 Varchar2(20) Path 'CERT_TYPE', 证件号码 Varchar2(20) Path 'CERT_NUMBER',
                           所有者 Number(1) Path 'CERT_OWNER', 证件备注 Varchar2(100) Path 'CERT_NOTE') B) Loop
    Rs_Sql证件.Extend;
    Rs_Sql证件(Rs_Sql证件.Count).证件类型 := x.证件类型;
    Rs_Sql证件(Rs_Sql证件.Count).证件号码 := x.证件号码;
    Rs_Sql证件(Rs_Sql证件.Count).证件备注 := x.证件备注;
    Rs_Sql证件(Rs_Sql证件.Count).所有者 := x.所有者;
  End Loop;

  --检查必录信息,必须录入病人的姓名、性别、出生日期
  If v_姓名 Is Null Then
    v_Error := '必须录入病人姓名！';
    Raise Err_Item;
  Elsif v_性别 Is Null Then
    v_Error := '必须录入病人性别！';
    Raise Err_Item;
  Elsif v_病人出生日期 Is Null Then
    v_Error := '必须录入病人出生日期！';
    Raise Err_Item;
  End If;

  For I In 1 .. Rs_Sql证件.Count Loop
    n_所有者   := Rs_Sql证件(I).所有者;
    v_证件号码 := Rs_Sql证件(I).证件号码;
    v_证件信息 := v_证件信息 || ',' || Rs_Sql证件(I).证件类型 || ',' || Rs_Sql证件(I).证件号码 || ',' || Rs_Sql证件(I).所有者;
  End Loop;
  If (Not v_陪诊人姓名 Is Null And Not v_陪诊人身份证号 Is Null) And (Not v_陪诊人姓名 Is Null And Not v_证件号码 Is Null) Then
    --在没有输入陪诊人信息的情况下，病人身份证号和其他证件号必须录入一个
    If v_身份证号 Is Null And v_证件号码 Is Null Then
      v_Error := '必须录入病人身份证号！';
      Raise Err_Item;
    End If;
  Else
    --录入了陪诊人信息后必须录入v_陪诊人性别、陪诊人出生日期、陪诊人关系
    If (Not v_陪诊人姓名 Is Null And Not v_陪诊人姓名 Is Null) Or (n_所有者 = 2 And Not v_陪诊人姓名 Is Null And Not v_证件号码 Is Null) Then
      If v_陪诊人性别 Is Null Then
        v_Error := '必须录入陪诊人性别！';
        Raise Err_Item;
      Elsif v_陪诊人出生日期 Is Null Then
        v_Error := '必须录入陪诊人出生日期！';
        Raise Err_Item;
      Elsif v_陪诊人关系 Is Null Then
        v_Error := '必须录入陪诊人关系！';
        Raise Err_Item;
      End If;
    End If;
  End If;

  --查询是否有重复的病人实名信息
  --第一种情况：身份证号
  If Nvl(v_身份证号, '|') <> '|' Then
    Select Count(1) Into n_Count From 病人实名信息 Where 身份证号 = v_身份证号;
    If n_Count = 1 Then
      v_Error := '该病人已经存在有效的实名认证信息，不需要再次认证！';
      Raise Err_Item;
    End If;
  End If;
  n_Count := 0;
  --第二种情况：姓名+其他证件类型+其他证件号码(本人的)
  If n_所有者 = 1 Then
    Select Count(1)
    Into n_Count
    From 病人实名信息 A, 病人实名证件 B
    Where a.实名id = b.实名id And a.姓名 = v_姓名 And
          Instr(v_证件信息 || ',', ',' || b.证件类型 || ',' || b.证件号码 || ',' || b.所有者 || ',') > 0;
    If n_Count = 1 Then
      v_Error := '该病人已经存在有效的实名认证信息，不需要再次认证！';
      Raise Err_Item;
    End If;
  End If;
  n_Count := 0;
  --第三种情况：姓名+陪诊人姓名+陪诊人身份证号
  Select Count(1)
  Into n_Count
  From 病人实名信息
  Where 姓名 = v_姓名 And 陪诊人姓名 = v_陪诊人姓名 And 陪诊人身份证号 = v_陪诊人身份证号;
  If n_Count = 1 Then
    v_Error := '该病人已经存在有效的实名认证信息，不需要再次认证！';
    Raise Err_Item;
  End If;
  n_Count := 0;
  --第四种情况：姓名+陪诊人姓名+其他证件类型+其他证件号码(陪诊人的)
  If n_所有者 = 2 Then
    Select Count(1)
    Into n_Count
    From 病人实名信息 A, 病人实名证件 B
    Where a.实名id = b.实名id And a.姓名 = v_姓名 And a.陪诊人姓名 = v_陪诊人姓名 And
          Instr(v_证件信息 || ',', ',' || b.证件类型 || ',' || b.证件号码 || ',' || b.所有者 || ',') > 0;
    If n_Count = 1 Then
      v_Error := '该病人已经存在有效的实名认证信息，不需要再次认证！';
      Raise Err_Item;
    End If;
  End If;
  n_Count := 0;

  Select 病人实名信息_实名id.Nextval Into n_实名id From Dual;

  v_建档人 := Zl_Identity(1);
  v_建档人 := Substr(v_建档人, Instr(v_建档人, ',') + 1);
  v_建档人 := Substr(v_建档人, Instr(v_建档人, ',') + 1);

  If v_身份证号 Is Null Then
    n_New := 1;
  Else
    Select Max(病人id) As 病人id
    Into n_Id
    From (Select Nvl(Nvl(就诊时间, 入院时间), 登记时间) As 时间, 病人id
           From 病人信息
           Where 姓名 = v_姓名 And 身份证号 = v_身份证号
           Order By 时间 Desc)
    Where Rownum = 1;
    If n_Id Is Null Then
      n_New := 1;
    Else
      n_New := 0;
    End If;
  End If;

  If n_New = 1 Then
    --新建指定病人的实名认证信息
    Select 病人信息_Id.Nextval Into n_病人id From Dual;
    v_虚拟病人id := '-' || n_病人id;
    Select Nextno(3) Into n_No From Dual;
    Insert Into 病人信息
      (病人id, 姓名, 性别, 出生日期, 出生地点, 身份证号, 民族, 国籍, 家庭地址, 联系人姓名, 联系人关系, 联系人地址, 联系人身份证号, 手机号, 登记时间, 门诊号)
    Values
      (n_病人id, v_姓名, v_性别, d_出生日期, v_出生地点, v_身份证号, v_民族, v_国籍, v_住址, v_陪诊人姓名, v_陪诊人关系, v_陪诊人住址, v_陪诊人身份证号, v_手机号,
       Sysdate, n_No);
    --病人图片部分
    If Not Pati_Image_In Is Null Then
      Insert Into 病人照片 (病人id, 照片) Values (n_病人id, Pati_Image_In);
    End If;
  Else
    n_病人id     := n_Id;
    v_虚拟病人id := '-' || n_病人id;
    Begin
      Select 门诊号 Into n_No From 病人信息 Where 病人id = n_病人id;
    Exception
      When Others Then
        Null;
    End;
    If n_No Is Null Then
      Select Nextno(3) Into n_No From Dual;
    End If;
    Update 病人信息
    Set 姓名 = v_姓名, 性别 = v_性别, 出生日期 = d_出生日期, 出生地点 = v_出生地点, 身份证号 = v_身份证号, 民族 = v_民族, 国籍 = v_国籍, 家庭地址 = v_住址,
        联系人姓名 = v_陪诊人姓名, 联系人关系 = v_陪诊人关系, 联系人地址 = v_陪诊人住址, 联系人身份证号 = v_陪诊人身份证号, 手机号 = v_手机号, 门诊号 = n_No
    Where 病人id = n_病人id;
  
    --病人图片部分
    If Not Pati_Image_In Is Null Then
      Update 病人照片 Set 照片 = Pati_Image_In Where 病人id = n_病人id;
    End If;
  End If;

  Insert Into 病人实名信息
    (实名id, 病人id, 姓名, 性别, 出生日期, 国籍, 民族, 出生地点, 住址, 身份证号, 身份证类型, 陪诊人姓名, 陪诊人性别, 陪诊人出生日期, 陪诊人国籍, 陪诊人民族, 陪诊人住址, 陪诊人身份证号,
     陪诊人身份证类型, 陪诊人关系, 手机号, 备注, 认证状态, 建档时间, 建档人, 更新人, 更新时间)
  Values
    (n_实名id, n_病人id, v_姓名, v_性别, d_出生日期, v_国籍, v_民族, v_出生地点, v_住址, v_身份证号, Decode(v_身份证号, '', To_Number(''), 1),
     v_陪诊人姓名, v_陪诊人性别, d_陪诊人出生日期, v_陪诊人国籍, v_陪诊人民族, v_陪诊人住址, v_陪诊人身份证号, Decode(v_陪诊人身份证号, '', To_Number(''), 1), v_陪诊人关系,
     v_手机号, v_备注, v_认证状态, Sysdate, v_建档人, v_建档人, Sysdate);

  For I In 1 .. Rs_Sql证件.Count Loop
    Select 病人实名证件_Id.Nextval Into n_实名信息id From Dual;
    Insert Into 病人实名证件
      (ID, 实名id, 证件类型, 证件号码, 备注, 所有者)
    Values
      (n_实名信息id, n_实名id, Rs_Sql证件(I).证件类型, Rs_Sql证件(I).证件号码, Rs_Sql证件(I).证件备注, Rs_Sql证件(I).所有者);
  End Loop;

  v_Result := 'TRUE';
  v_Tmp    := '<OUTPUT><RESULT>' || v_Result || '</RESULT>' || '<CERT_ID>' || n_实名id || '</CERT_ID>' || '<PATI_ID>' ||
              n_病人id || '</PATI_ID>' || '</OUTPUT>';
  Xml_Out  := Xmltype(v_Tmp);

Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    v_Result := 'FALSE';
    v_Tmp    := '<OUTPUT><RESULT>' || v_Result || '</RESULT>' || '<CERT_ID>' || n_实名id || '</CERT_ID>' || '<PATI_ID>' ||
                n_病人id || '</PATI_ID>' || '<ERROR>' || '<MSG>' || SQLErrM || '</MSG>' || '</ERROR>' || '</OUTPUT>';
    Xml_Out  := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Newidentitycertinfo;
/
Create Or Replace Procedure Zl_Third_Newidentitycertimage
(
  Xml_In        In Xmltype,
  Cert_Image_In In Blob,
  Xml_Out       Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:新增指定病人的病人实名证件图片信息
  -- <IN>            
  --<CERT_ID></CERT_ID>          实名ID
  --<PATI_ID></PATI_ID>          病人ID
  --<V_CARDNO></V_CARDNO>          虚拟卡号(-病人ID)
  --<CERT_TYPE></CERT_TYPE>          证件类型
  --<CERT_NUMBER></CERT_NUMBER>          证件号码
  --<IMAGE_SERIAL></IMAGE_SERIAL>        序号(第几张照片)
  --<IMAGE_NOTE></IMAGE_NOTE>          照片备注
  -- </IN>
  -- CERT_IMAGE_In         证件照片

  --出参:Xml_Out          
  --<OUTPUT>
  --<RESULT>false</RESULT>
  --<ERROR>  正常则无此节点
  --<MSG>错误信息</MSG>
  --</ERROR>
  --------------------------------------------------------------------------------------------------
  n_实名id   病人实名信息.实名id%Type;
  n_病人id   病人实名信息.病人id%Type;
  v_虚拟卡号 Varchar2(20);
  n_序号     病人实名证件图片.序号%Type;
  v_备注     病人实名证件图片.备注%Type;
  v_证件类型 病人实名证件.证件类型%Type;
  v_证件号码 病人实名证件.证件号码%Type;
  n_证件id   病人实名证件.Id%Type;

  v_Error    Varchar2(200);
  v_Tmp      Varchar2(4000);
  v_Result   Varchar2(200);
  n_虚拟卡号 Number(18);
  n_Id       Number(18);
  Err_Item Exception;
Begin
  --解析XML节点
  Select Extractvalue(Value(A), 'IN/CERT_ID') As 实名id, Extractvalue(Value(A), 'IN/PATI_ID') As 病人id,
         Extractvalue(Value(A), 'IN/V_CARDNO') As 虚拟卡号, Extractvalue(Value(A), 'IN/CERT_TYPE') As 证件类型,
         Extractvalue(Value(A), 'IN/CERT_NUMBER') As 证件号码, Extractvalue(Value(A), 'IN/IMAGE_SERIAL') As 序号,
         Extractvalue(Value(A), 'IN/IMAGE_NOTE') As 备注
  Into n_实名id, n_病人id, v_虚拟卡号, v_证件类型, v_证件号码, n_序号, v_备注
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --查询证件ID
  n_虚拟卡号 := -1 * To_Number(v_虚拟卡号);
  If Nvl(n_实名id, 0) <> 0 Then
    n_Id := n_实名id;
  Elsif Nvl(n_病人id, 0) <> 0 Then
    Select 实名id Into n_实名id From 病人实名信息 Where 病人id = n_病人id;
    If Nvl(n_实名id, 0) <> 0 Then
      n_Id := n_实名id;
    End If;
  Elsif Nvl(n_虚拟卡号, 0) <> 0 Then
    Select 实名id Into n_实名id From 病人实名信息 Where 病人id = n_虚拟卡号;
    If Nvl(n_实名id, 0) <> 0 Then
      n_Id := n_实名id;
    End If;
  End If;
  Select ID Into n_证件id From 病人实名证件 Where 实名id = n_Id And 证件类型 = v_证件类型 And 证件号码 = v_证件号码;

  --更新或者插入证件图片信息
  If Nvl(n_证件id, 0) <> 0 Then
    Update 病人实名证件图片 Set 证件图片 = Cert_Image_In, 备注 = v_备注 Where 证件id = n_证件id And 序号 = n_序号;
    If Sql%RowCount = 0 Then
      Insert Into 病人实名证件图片 (证件id, 序号, 证件图片, 备注) Values (n_证件id, n_序号, Cert_Image_In, v_备注);
    End If;
  Else
    v_Error := '该病人没有证件类型为：【' || v_证件类型 || '】证件号码为：【' || v_证件号码 || '】的证件信息，请检查！';
    Raise Err_Item;
  End If;

  v_Result := 'TRUE';
  v_Tmp    := '<OUTPUT><RESULT>' || v_Result || '</RESULT>' || '</OUTPUT>';
  Xml_Out  := Xmltype(v_Tmp);
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    v_Result := 'FALSE';
    v_Tmp    := '<OUTPUT><RESULT>' || v_Result || '</RESULT>' || '<MSG>' || SQLErrM || '</MSG></OUTPUT>';
    Xml_Out  := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Newidentitycertimage;
/
Create Or Replace Procedure Zl_Third_Getidentitycertinfo
(
  Xml_In         In Xmltype,
  Pati_Image_Out Out Blob,
  Xml_Out        Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:查询指定病人的实名认证信息
  --入参:Xml_In:
  --<IN>
  -- <CERT_ID></CERT_ID> 实名ID
  -- <PATI_ID></PATI_ID> 病人ID
  -- <V_CARDNO></V_CARDNO> 虚拟卡号(-病人ID)
  -- <ID_NUMBER></ID_NUMBER> 病人身份证号
  -- <CERT_TYPE></CERT_TYPE> 病人其他证件类型
  -- <CERT_NUMBER></CERT_NUMBER> 病人其他证件号码
  -- <P_ID_NUMBER></P_ID_NUMBER> 陪诊人身份证号
  -- <P_CERT_TYPE></P_CERT_TYPE> 陪诊人其他证件类型
  -- <P_CERT_NUMBER></P_CERT_NUMBER> 陪诊人其他证件号码
  -- <PATI_NAME></PATI_NAME> 病人姓名
  -- <P_PATI_NAME></P_PATI_NAME> 陪诊人姓名
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --  <CERT_ID></CERT_ID> 实名ID
  --  <PATI_ID></PATI_ID> 病人ID
  --  <V_CARDNO></V_CARDNO> 虚拟卡号(-病人ID)
  --  <PATI_NAME></PATI_NAME> --姓名
  --  <SEX></SEX>             --性别
  --  <BIRTH_DATE></BIRTH_DATE>  --出生日期
  --  <COUNTRY></COUNTRY>        --国籍
  --  <NATION></NATION>          --民族
  --  <BIRTH_PLACE></BIRTH_PLACE>    --出生地点
  --  <ADDRESS></ADDRESS>        --住址
  --  <ID_NUMBER></ID_NUMBER>    --身份证号
  --  <P_PATI_NAME></P_PATI_NAME>    --陪诊人姓名
  --  <P_SEX></P_SEX>     --陪诊人性别
  --  <P_BIRTH_DATE></P_BIRTH_DATE>    --陪诊人出生日期
  --  <P_COUNTRY></P_COUNTRY>     --陪诊人国籍
  --  <P_NATION></P_NATION>    --陪诊人民族
  --  <P_ADDRESS></P_ADDRESS>   --陪诊人住址
  --  <P_ID_NUMBER></P_ID_NUMBER>     --陪诊人身份证号
  --  <P_RELATION></P_RELATION>    --陪诊人关系
  --  <PHONE_NUMBER></PHONE_NUMBER>   --手机号
  --  <NOTE></NOTE>    --备注
  --  <STATE></STATE>   --认证状态(只能是0-待审核，1-已认证)
  --  <LAST_TIME></LAST_TIME>    --更新时间
  --  <OTHER_CERTS>
  --      <CERT>
  --          <CERT_TYPE></CERT_TYPE>    --证件类型
  --          <CERT_NUMBER></CERT_NUMBER>    --证件号码
  --          <CERT_NOTE></CERT_NOTE>    --证件备注
  --          <CERT_OWNER></CERT_OWNER>     --所有者
  --          <CERT_IMAGES>
  --               <IMAGE>
  --                    <SERIAL></SERIAL>    --序号
  --                    <NOTE></NOTE>      --备注
  --               </IMAGE>
  --          </CERT_IMAGES>   --证件图片
  --      </CERT>
  --  </OTHER_CERTS>    --其他证件
  --  <ERROR>
  --      <MSG></MSG>    --错误信息
  --  </ERROR>    --正常则无此结点
  --</OUTPUT>

  v_姓名             病人实名信息.姓名%Type;
  v_身份证号         病人实名信息.身份证号%Type;
  v_陪诊人姓名       病人实名信息.陪诊人姓名%Type;
  v_陪诊人身份证号   病人实名信息.陪诊人身份证号%Type;
  v_病人其它证件类型 病人实名证件.证件类型%Type;
  v_病人其它证件号码 病人实名证件.证件号码%Type;

  v_陪诊人其它证件类型 病人实名证件.证件类型%Type;
  v_陪诊人其它证件号码 病人实名证件.证件号码%Type;

  v_Error Varchar2(200);
  v_Tmp   Varchar2(4000);
  v_Xtmp  Varchar2(4000);

  x_Main Xmltype;
  x_证件 Xmltype;
  x_图片 Xmltype;
  x_Tmp  Xmltype;

  n_病人id         Number(18);
  n_实名id         Number(18);
  v_虚拟病人id     Varchar2(20);
  b_Base64病人图片 Blob;
  v_病人           Varchar2(4000);
  n_Begin          Number(5);
  n_End            Number(5);
  n_Length         Number(10);
  Err_Item Exception;
Begin

  --解析XML节点
  Select Extractvalue(Value(A), 'IN/CERT_ID') As 实名id, Extractvalue(Value(A), 'IN/PATI_ID') As 病人id,
         Extractvalue(Value(A), 'IN/V_CARDNO') As 虚拟病人id, Extractvalue(Value(A), 'IN/CERT_TYPE') As 病人其它证件类型,
         Extractvalue(Value(A), 'IN/CERT_NUMBER') As 病人其它证件号码, Extractvalue(Value(A), 'IN/P_CERT_TYPE') As 陪诊人其它证件类型,
         Extractvalue(Value(A), 'IN/P_CERT_NUMBER') As 陪诊人其它证件号码, Extractvalue(Value(A), 'IN/PATI_NAME') As 姓名,
         Extractvalue(Value(A), 'IN/ID_NUMBER') As 身份证号, Extractvalue(Value(A), 'IN/P_PATI_NAME') As 陪诊人姓名,
         Extractvalue(Value(A), 'IN/P_ID_NUMBER') As 陪诊人身份证号
  Into n_实名id, n_病人id, v_虚拟病人id, v_病人其它证件类型, v_病人其它证件号码, v_陪诊人其它证件类型, v_陪诊人其它证件号码, v_姓名, v_身份证号, v_陪诊人姓名, v_陪诊人身份证号
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --身份证号
  If Nvl(n_实名id, 0) = 0 Then
    If v_身份证号 Is Not Null Then
      Select Max(a.实名id) Into n_实名id From 病人实名信息 A Where a.身份证号 = v_身份证号;
    End If;
  End If;

  --病人id
  If Nvl(n_实名id, 0) = 0 Then
    If v_虚拟病人id Is Not Null Then
      n_病人id := -1 * To_Number(v_虚拟病人id);
    End If;
    Select Max(a.实名id) Into n_实名id From 病人实名信息 A Where a.病人id = n_病人id;
  End If;

  --病人其它证件
  If Nvl(n_实名id, 0) = 0 Then
    Select Max(a.实名id)
    Into n_实名id
    From 病人实名证件 A
    Where a.证件类型 = v_病人其它证件类型 And a.证件号码 = v_病人其它证件号码 And a.所有者 = 1;
  End If;

  --传入"陪诊人身份证号"，以及"病人姓名、陪诊人姓名"
  If Nvl(n_实名id, 0) = 0 Then
    Select Max(a.实名id)
    Into n_实名id
    From 病人实名信息 A
    Where a.陪诊人身份证号 = v_陪诊人身份证号 And a.姓名 = v_姓名 And a.陪诊人姓名 = v_陪诊人姓名;
  End If;

  --传入"陪诊人其他证件类型/号码"，以及"病人姓名、陪诊人姓名"
  If Nvl(n_实名id, 0) = 0 Then
    Select Max(a.实名id)
    Into n_实名id
    From 病人实名证件 A, 病人实名信息 B
    Where a.实名id = b.实名id
         
          And b.姓名 = v_姓名 And b.陪诊人姓名 = v_陪诊人姓名
         
          And a.证件类型 = v_陪诊人其它证件类型 And a.证件号码 = v_陪诊人其它证件号码 And a.所有者 = 2;
  End If;

  If Nvl(n_实名id, 0) = 0 Then
    v_Error := '根据传入信息未找实名认证信息！';
    Raise Err_Item;
  End If;

  --通过 实名ID进行关联信息查询
  Select Max(a.信息)
  Into v_Tmp
  From (Select '<CERT_ID>' || a.实名id || '</CERT_ID><PATI_ID>' || a.病人id || '</PATI_ID><V_CARDNO>-' || a.病人id ||
                 '</V_CARDNO><PATI_NAME>' || a.姓名 || '</PATI_NAME><SEX>' || a.性别 || '</SEX><BIRTH_DATE>' ||
                 To_Char(a.出生日期, 'YYYY-MM-DD HH24:MI:SS') || '</BIRTH_DATE><COUNTRY>' || a.国籍 || '</COUNTRY>' ||
                 '<NATION>' || a.民族 || '</NATION><BIRTH_PLACE>' || a.出生地点 || '</BIRTH_PLACE><ADDRESS>' || a.住址 ||
                 '</ADDRESS><ID_NUMBER>' || a.身份证号 || '</ID_NUMBER><P_PATI_NAME>' || a.陪诊人姓名 || '</P_PATI_NAME><P_SEX>' ||
                 a.陪诊人性别 || '</P_SEX><P_BIRTH_DATE>' || To_Char(a.陪诊人出生日期, 'YYYY-MM-DD HH24:MI:SS') ||
                 '</P_BIRTH_DATE><P_COUNTRY>' || a.陪诊人国籍 || '</P_COUNTRY><P_NATION>' || a.陪诊人民族 ||
                 '</P_NATION><P_ADDRESS>' || a.陪诊人住址 || '</P_ADDRESS>' || '<P_ID_NUMBER>' || a.陪诊人身份证号 ||
                 '</P_ID_NUMBER><P_RELATION>' || a.陪诊人关系 || '</P_RELATION>' || '<PHONE_NUMBER>' || a.手机号 ||
                 '</PHONE_NUMBER><NOTE>' || a.备注 || '</NOTE><STATE>' || a.认证状态 || '</STATE><LAST_TIME>' ||
                 To_Char(a.更新时间, 'YYYY-MM-DD HH24:MI:SS') || '</LAST_TIME>' As 信息
         From 病人实名信息 A
         Where a.实名id = n_实名id) A;

  If v_Tmp Is Null Then
    v_Error := '根据传入信息未找实名认证信息！';
    Raise Err_Item;
  End If;

  n_Begin  := Instr(v_Tmp, '<PATI_ID>', 1, 1) + Length('<PATI_ID>');
  n_End    := Instr(v_Tmp, '</PATI_ID>', 1, 1);
  n_Length := n_End - n_Begin;
  v_病人   := Substr(v_Tmp, n_Begin, n_Length);
  n_病人id := To_Number(v_病人);

  Select 照片 Into b_Base64病人图片 From 病人照片 Where 病人id = n_病人id;

  Pati_Image_Out := b_Base64病人图片;

  x_Main := Xmltype('<OUTPUT>' || v_Tmp || '</OUTPUT>');
  x_证件 := Xmltype('<OTHER_CERTS></OTHER_CERTS>');
  For R In (Select a.Id, a.实名id, a.证件类型, a.证件号码, a.备注, a.所有者
            From 病人实名证件 A
            Where a.实名id = n_实名id) Loop
  
    v_Xtmp := '<CERT jsonArray=''Ture'' >';
    v_Xtmp := v_Xtmp || '<CERT_TYPE>' || r.证件类型 || '</CERT_TYPE>'; --证件类型
    v_Xtmp := v_Xtmp || '<CERT_NUMBER>' || r.证件号码 || '</CERT_NUMBER>'; --证件号码
    v_Xtmp := v_Xtmp || '<CERT_NOTE>' || r.证件号码 || '</CERT_NOTE>'; --证件备注
    v_Xtmp := v_Xtmp || '<CERT_OWNER>' || r.所有者 || '</CERT_OWNER>'; --所有者
    v_Xtmp := v_Xtmp || '</CERT>';
    x_Tmp  := Xmltype(v_Xtmp);
  
    x_图片 := Xmltype('<CERT_IMAGES></CERT_IMAGES>');
    v_Tmp  := Null;
    For T In (Select a.证件id, a.序号, a.证件图片, a.备注 From 病人实名证件图片 A Where a.证件id = r.Id Order By a.序号) Loop
      v_Tmp := '<IMAGE jsonArray=''Ture'' >';
      v_Tmp := v_Tmp || '<SERIAL>' || t.序号 || '</SERIAL>';
      v_Tmp := v_Tmp || '<NOTE>' || t.备注 || '</NOTE>'; --备注
      v_Tmp := v_Tmp || '</IMAGE>';
      Select Appendchildxml(x_图片, '/CERT_IMAGES', Xmltype(v_Tmp)) Into x_图片 From Dual;
    End Loop;
    Select Appendchildxml(x_Tmp, '/CERT', x_图片) Into x_Tmp From Dual;
    Select Appendchildxml(x_证件, '/OTHER_CERTS', x_Tmp) Into x_证件 From Dual;
  End Loop;
  Select Appendchildxml(x_Main, '/OUTPUT', x_证件) Into x_Main From Dual;
  Xml_Out := x_Main;
Exception
  When Err_Item Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Error := SQLCode || '--' || SQLErrM;
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getidentitycertinfo;
/
Create Or Replace Procedure Zl_Third_Getidentitycertimage
(
  Xml_In         In Xmltype,
  Cert_Image_Out Out Blob
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取指定病人的病人实名证件图片信息
  -- <IN>                     
  --<CERT_ID></CERT_ID>          实名ID
  --<PATI_ID></PATI_ID>         病人ID
  --<V_CARDNO></V_CARDNO>         虚拟卡号(-病人ID)
  --<CERT_TYPE></CERT_TYPE>         证件类型
  --<CERT_NUMBER></CERT_NUMBER>         证件号码
  --<IMAGE_SERIAL></IMAGE_SERIAL>         序号(第几张照片)
  -- </IN>
  --------------------------------------------------------------------------------------------------
  n_实名id   病人实名信息.实名id%Type;
  n_病人id   病人实名信息.病人id%Type;
  v_虚拟卡号 Varchar2(20);
  n_序号     病人实名证件图片.序号%Type;
  v_证件类型 病人实名证件.证件类型%Type;
  v_证件号码 病人实名证件.证件号码%Type;
  n_证件id   病人实名证件.Id%Type;

  v_Error    Varchar2(200);
  n_虚拟卡号 Number(18);
  n_Id       Number(18);
  b_Image    Blob;
  Err_Item Exception;
Begin
  --解析XML节点
  Select Extractvalue(Value(A), 'IN/CERT_ID') As 实名id, Extractvalue(Value(A), 'IN/PATI_ID') As 病人id,
         Extractvalue(Value(A), 'IN/V_CARDNO') As 虚拟卡号, Extractvalue(Value(A), 'IN/CERT_TYPE') As 证件类型,
         Extractvalue(Value(A), 'IN/CERT_NUMBER') As 证件号码, Extractvalue(Value(A), 'IN/IMAGE_SERIAL') As 序号
  Into n_实名id, n_病人id, v_虚拟卡号, v_证件类型, v_证件号码, n_序号
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --查询证件ID
  n_虚拟卡号 := -1 * To_Number(v_虚拟卡号);
  If Nvl(n_实名id, 0) <> 0 Then
    n_Id := n_实名id;
  Elsif Nvl(n_病人id, 0) <> 0 Then
    Select 实名id Into n_实名id From 病人实名信息 Where 病人id = n_病人id;
    If Nvl(n_实名id, 0) <> 0 Then
      n_Id := n_实名id;
    End If;
  Elsif Nvl(n_虚拟卡号, 0) <> 0 Then
    Select 实名id Into n_实名id From 病人实名信息 Where 病人id = n_虚拟卡号;
    If Nvl(n_实名id, 0) <> 0 Then
      n_Id := n_实名id;
    End If;
  End If;
  Select ID Into n_证件id From 病人实名证件 Where 实名id = n_Id And 证件类型 = v_证件类型 And 证件号码 = v_证件号码;

  --返回证件图片信息
  If Nvl(n_证件id, 0) <> 0 Then
    Select 证件图片 Into b_Image From 病人实名证件图片 Where 证件id = n_证件id And 序号 = n_序号;
    If Sql%RowCount = 0 Then
      v_Error := '该病人没有证件ID：【' || n_证件id || '】图片序号为：【' || n_序号 || '】的图片信息，请检查！';
      Raise Err_Item;
    End If;
  Else
    v_Error := '该病人没有证件类型为：【' || v_证件类型 || '】证件号码为：【' || v_证件号码 || '】的证件信息，请检查！';
    Raise Err_Item;
  End If;
  Cert_Image_Out := b_Image;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getidentitycertimage;
/
Create Or Replace Procedure Zl_Third_Getpatiinfo_Bl
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:病理系统获取病人基本信息
  --入参:Xml_In:
  --  <IN>
  --      <BSHLX></BSHLX>     --标识号类型|1:门诊 2：住院
  --      <BSH></BSH>         --标识号（门诊号/住院号）
  --      <BRID></BRID>         --病人id
  --      <JZID></JZID>         --就诊id
  --      <BRLY></BRLY>         --病人来源 1-门诊;2-住院;3-外来(今后用于辅诊部门接收外来病人);4-体检病人
  --  </IN>

  --出参:Xml_Out
  -- <OUTPUT>
  --   <BR>
  --     <BRID></BRID>       --病人ID
  --     <ZYID></ZYID>       --主页ID
  --     <XM></XM>           --姓名
  --     <XB></XB>           --性别
  --     <Nl></NL>           --年龄
  --     <MZ></MZ>           --民族
  --     <HY></HY>           --婚姻状况
  --     <ZY></ZY>           --职业
  --     <MZH></MZH>         --门诊号
  --     <ZYH></ZYH>         --住院号
  --     <DQCH></DQCH>       --当前床号
  --     <SFZH></SFZH>       --身份证号
  --     <LXRDH></LXRDH>     --联系人电话
  --     <LXRDZ></LXRDZ>     --联系人地址
  --     <BRLY></BRLY>       --病人来源
  --     <BRKS></BRKS>       --病人科室
  --     <BRBQ></BRBQ>       --病人病区
  --     <LCZD></LCZD>       --临床诊断(最后诊断)
  --     <BRZS></BRZS>  --病人主诉
  --     <XBS></XBS> --现病史
  --     <TGJC></TGJC>--体格检查

  --     <KDYS></KDYS>       --开单医生
  --     <YRLIST>            可选的医生列表,数组形式
  --        <ITEM><XM></XM></ITEM>
  --        ....
  --     </YRLIST>
  --   </BR>
  -- </OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_标识号类型 Varchar2(10);
  v_标识号     Varchar2(500);
  n_病人id     Number(18);
  n_就诊id     病人挂号记录.Id%Type;
  n_病人来源   病人医嘱记录.病人来源%Type;
  n_Type1      Number; --查询方式 0/1 只传 标识号类型和标识号
  n_Type2      Number; --查询方式 0/1 只传 病人id,就诊id,病人来源
  v_人员姓名   人员表.姓名%Type;
  v_人员编号   人员表.编号%Type;
  n_Cnt        Number;
  v_开单医生   人员表.姓名%Type;
  n_科室id     部门表.Id%Type;
  v_Diags      Varchar2(4000);
  v_要素       Varchar2(4000);

  v_Temp    Varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML
  x_医生    Xmltype;
  v_Err_Msg Varchar2(200);
  Err_Item Exception;

Begin

  Select Extractvalue(Value(A), 'IN/BSHLX'), Extractvalue(Value(A), 'IN/BSH'), Extractvalue(Value(A), 'IN/BRID'),
         Extractvalue(Value(A), 'IN/JZID'), Extractvalue(Value(A), 'IN/BRLY')
  Into v_标识号类型, v_标识号, n_病人id, n_就诊id, n_病人来源
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --入参传入情况：1.只传 标识号类型和标识号  2.只传 病人id,就诊id,病人来源
  n_Type1 := 0;
  n_Type2 := n_Type1;
  If Nvl(n_病人id, 0) <> 0 And Nvl(n_就诊id, 0) <> 0 And Nvl(n_病人来源, 0) <> 0 Then
    n_Type1 := 1;
  End If;

  If Nvl(v_标识号类型, 0) <> 0 And Nvl(v_标识号, 0) <> 0 Then
    n_Type2 := 1;
  End If;

  If n_Type1 = 0 And n_Type2 = 0 Then
    v_Err_Msg := '未传入完整的查询条件,无法完成查询!';
    Raise Err_Item;
  End If;

  If n_Type1 = 0 And n_Type2 = 1 Then
    If v_标识号类型 = '1' Then
      For R In (Select a.病人id, a.Id
                From 病人挂号记录 A
                Where a.门诊号 = v_标识号 And a.记录性质 = 1 And a.记录状态 = 1
                Order By a.执行时间 Desc) Loop
        n_病人来源 := 1;
        n_病人id   := r.病人id;
        n_就诊id   := r.Id;
        --取最近一条，只循环一次
        Exit;
      End Loop;
    Else
      For R In (Select a.病人id, a.主页id From 病案主页 A Where a.住院号 = v_标识号 Order By a.入院日期 Desc) Loop
        n_病人来源 := 2;
        n_病人id   := r.病人id;
        n_就诊id   := r.主页id;
        --取最近一条，只循环一次
        Exit;
      End Loop;
    End If;
  End If;

  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '未查找到病人信息,请检查传入条件!';
    Raise Err_Item;
  End If;

  v_Temp     := Zl_Identity;
  v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_人员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
  v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);

  Select Count(1)
  Into n_Cnt
  From 人员表 A, 人员性质说明 B
  Where a.编号 = v_人员编号 And b.人员id = a.Id And b.人员性质 = '医生';

  If n_Cnt > 0 Then
    v_开单医生 := v_人员姓名;
  End If;

  If n_病人来源 = 2 Then
    For R In (Select a.病人id, b.主页id, a.姓名, a.性别, a.年龄, a.民族, a.婚姻状况, a.职业, Null As 门诊号, b.住院号, b.出院病床 As 床号, a.身份证号,
                     a.联系人电话, a.联系人地址, b.出院科室id As 病人科室id, c.名称 As 病人科室, d.名称 As 病人病区, 2 As 病人来源, c.站点
              From 病人信息 A, 病案主页 B, 部门表 C, 部门表 D
              Where a.病人id = b.病人id And b.出院科室id = c.Id And b.当前病区id = d.Id(+) And b.病人id = n_病人id And b.主页id = n_就诊id) Loop
      n_科室id := r.病人科室id;
    
      Select Zl_Replace_Element_Value('最后诊断', n_病人id, n_就诊id, 2) Into v_Diags From Dual;
    
      v_Temp := '<BR>';
      v_Temp := v_Temp || '<BRID>' || r.病人id || '</BRID>';
      v_Temp := v_Temp || '<ZYID>' || r.主页id || '</ZYID>';
      v_Temp := v_Temp || '<XM>' || r.姓名 || '</XM>';
      v_Temp := v_Temp || '<XB>' || r.性别 || '</XB>';
      v_Temp := v_Temp || '<NL>' || r.年龄 || '</NL>';
      v_Temp := v_Temp || '<MZ>' || r.民族 || '</MZ>';
      v_Temp := v_Temp || '<HY>' || r.婚姻状况 || '</HY>';
      v_Temp := v_Temp || '<ZY>' || r.职业 || '</ZY>';
      v_Temp := v_Temp || '<MZH>' || r.门诊号 || '</MZH>';
      v_Temp := v_Temp || '<ZYH>' || r.住院号 || '</ZYH>';
      v_Temp := v_Temp || '<DQCH>' || r.床号 || '</DQCH>';
      v_Temp := v_Temp || '<SFZH>' || r.身份证号 || '</SFZH>';
      v_Temp := v_Temp || '<LXRDH>' || r.联系人电话 || '</LXRDH>';
      v_Temp := v_Temp || '<LXRDZ>' || r.联系人地址 || '</LXRDZ>';
      v_Temp := v_Temp || '<BRLY>' || r.病人来源 || '</BRLY>';
      v_Temp := v_Temp || '<BRKS>' || r.病人科室 || '</BRKS>';
      v_Temp := v_Temp || '<ZD>' || r.站点 || '</ZD>';
      v_Temp := v_Temp || '<BRBQ>' || r.病人病区 || '</BRBQ>';
      v_Temp := v_Temp || '<LCZD>' || v_Diags || '</LCZD>';
    
      Select Zl_Replace_Element_Value('病人主诉', n_病人id, n_就诊id, 2) Into v_要素 From Dual;
      v_Temp := v_Temp || '<BRZS>' || v_要素 || '</BRZS>'; --病人主诉
      Select Zl_Replace_Element_Value('现病史', n_病人id, n_就诊id, 2) Into v_要素 From Dual;
      v_Temp := v_Temp || '<XBS>' || v_要素 || '</XBS>'; --现病史
      Select Zl_Replace_Element_Value('体格检查', n_病人id, n_就诊id, 2) Into v_要素 From Dual;
      v_Temp := v_Temp || '<TGJC>' || v_要素 || '</TGJC>'; --体格检查
    
      v_Temp    := v_Temp || '<KDYS>' || v_开单医生 || '</KDYS>';
      v_Temp    := v_Temp || '</BR>';
      x_Templet := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
    End Loop;
  
  Else
  
    For R In (Select a.病人id, b.Id As 主页id, a.姓名, a.性别, a.年龄, a.民族, a.婚姻状况, a.职业, Null As 门诊号, Null As 住院号, Null As 床号,
                     a.身份证号, a.联系人电话, a.联系人地址, b.执行部门id As 病人科室id, c.名称 As 病人科室, Null As 病人病区, 1 As 病人来源, c.站点
              From 病人信息 A, 病人挂号记录 B, 部门表 C
              Where a.病人id = b.病人id And b.执行部门id = c.Id And b.Id = n_就诊id) Loop
      n_科室id := r.病人科室id;
    
      Select Zl_Replace_Element_Value('最后诊断', n_病人id, n_就诊id, 1) Into v_Diags From Dual;
      v_Temp := '<BR>';
      v_Temp := v_Temp || '<BRID>' || r.病人id || '</BRID>';
      v_Temp := v_Temp || '<ZYID>' || r.主页id || '</ZYID>';
      v_Temp := v_Temp || '<XM>' || r.姓名 || '</XM>';
      v_Temp := v_Temp || '<XB>' || r.性别 || '</XB>';
      v_Temp := v_Temp || '<NL>' || r.年龄 || '</NL>';
      v_Temp := v_Temp || '<MZ>' || r.民族 || '</MZ>';
      v_Temp := v_Temp || '<HY>' || r.婚姻状况 || '</HY>';
      v_Temp := v_Temp || '<ZY>' || r.职业 || '</ZY>';
      v_Temp := v_Temp || '<MZH>' || r.门诊号 || '</MZH>';
      v_Temp := v_Temp || '<ZYH>' || r.住院号 || '</ZYH>';
      v_Temp := v_Temp || '<DQCH>' || r.床号 || '</DQCH>';
      v_Temp := v_Temp || '<SFZH>' || r.身份证号 || '</SFZH>';
      v_Temp := v_Temp || '<LXRDH>' || r.联系人电话 || '</LXRDH>';
      v_Temp := v_Temp || '<LXRDZ>' || r.联系人地址 || '</LXRDZ>';
      v_Temp := v_Temp || '<BRLY>' || r.病人来源 || '</BRLY>';
      v_Temp := v_Temp || '<BRKS>' || r.病人科室 || '</BRKS>';
      v_Temp := v_Temp || '<ZD>' || r.站点 || '</ZD>';
      v_Temp := v_Temp || '<BRBQ>' || r.病人病区 || '</BRBQ>';
      v_Temp := v_Temp || '<LCZD>' || v_Diags || '</LCZD>';
    
      Select Zl_Replace_Element_Value('病人主诉', n_病人id, n_就诊id, 1) Into v_要素 From Dual;
      v_Temp := v_Temp || '<BRZS>' || v_要素 || '</BRZS>'; --病人主诉
      Select Zl_Replace_Element_Value('现病史', n_病人id, n_就诊id, 1) Into v_要素 From Dual;
      v_Temp := v_Temp || '<XBS>' || v_要素 || '</XBS>'; --现病史
      Select Zl_Replace_Element_Value('体格检查', n_病人id, n_就诊id, 1) Into v_要素 From Dual;
      v_Temp := v_Temp || '<TGJC>' || v_要素 || '</TGJC>'; --体格检查
    
      v_Temp    := v_Temp || '<KDYS>' || v_开单医生 || '</KDYS>';
      v_Temp    := v_Temp || '</BR>';
      x_Templet := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
    End Loop;
  End If;

  Select Xmlelement("YRLIST",
                     Xmlagg(Xmlelement("ITEM", Xmlattributes('true' As "jsonArray"), Xmlforest(Max(a.姓名) As "XM"))))
  Into x_医生
  From 人员表 A, 部门人员 F, 人员性质说明 B
  Where a.Id = f.人员id And a.Id = b.人员id And b.人员性质 = '医生' And f.部门id = n_科室id
  Group By a.Id;
  Select Appendchildxml(x_Templet, '/OUTPUT/BR', x_医生) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpatiinfo_Bl;
/

Create Or Replace Procedure Zl_Third_Outpatireg
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：用于产生预入院记录/取消预入院    数据写入 
  --入参：xml_in 
  --<IN> 
  -- <TYPE>1</TYPE>   --操作类型：1-产生预入院记录；0-取消预入院 
  -- <GHID>1162695</GHID>       --挂号id 
  -- <RYKSID>202704</RYKSID>    --入院科室ID 
  -- <RYBQID>202704</RYBQID>    --入院病区ID 
  -- <CH>5</CH>   --床号 
  -- <YZID>3</YZID> --医嘱id 
  -- <CZYBH></CZYBH> --操作员编号 
  -- <CZYXM></CZYXM> --操作员姓名 
  --</IN> 

  --出参：Xml_Out 
  --<OUTPUT> 
  --   <RESULT>true</RESULT> 
  --</OUTPUT> 

  --失败： 
  --<OUTPUT> 
  --   <RESULT>false</RESULT> 
  --   <ERROR> 
  --     <MSG>详细错误提示</MSG> 
  --   </ERROR> 
  --</OUTPUT> 

  n_医嘱id 病人医嘱记录.Id%Type;
  Cursor c_Advice Is
    Select Nvl(a.相关id, a.Id) As 组id, a.相关id, a.序号, a.病人id, a.挂号单, a.婴儿, a.姓名, c.操作类型, a.诊疗类别, a.医嘱状态, a.医嘱内容, a.开嘱医生,
           a.开始执行时间, a.执行时间方案, a.频率次数, a.频率间隔, a.间隔单位, Nvl(a.紧急标志, 0) As 紧急标志, a.诊疗项目id, a.收费细目id
    From 病人医嘱记录 A, 诊疗项目目录 C
    Where a.诊疗项目id = c.Id And a.诊疗类别 = 'Z' And c.操作类型 = '2' And a.Id = n_医嘱id;
  r_Advice c_Advice%RowType;

  Cursor c_Pati(v_病人id 病人信息.病人id%Type) Is
    Select a.病人id, a.住院号, a.姓名, a.性别, a.年龄, a.费别, a.出生日期, a.国籍, a.民族, a.学历, a.婚姻状况, a.职业, a.身份, a.身份证号, a.出生地点, a.家庭地址,
           a.家庭地址邮编, a.家庭电话, a.户口地址, a.户口地址邮编, a.联系人姓名, a.联系人关系, a.联系人地址, a.联系人电话, a.工作单位, a.合同单位id, a.单位电话, a.单位邮编,
           a.单位开户行, a.单位帐号, a.籍贯, a.区域, a.医疗付款方式, a.险类
    From 病人信息 A
    Where a.病人id = v_病人id;
  r_Pati c_Pati%RowType;

  n_Type   Number;
  n_挂号id 病人医嘱记录.Id%Type;
  n_科室id 病人医嘱记录.Id%Type;
  n_病区id 病人医嘱记录.Id%Type;
  v_床号   病案主页.入院病床%Type;

  n_病人id 病案主页.病人id%Type;
  v_No     病人挂号记录.No%Type;
  n_Count  Number;

  v_入院方式 病案主页.入院方式%Type;
  v_人员编号 人员表.编号%Type;
  v_人员姓名 人员表.姓名%Type;
  v_Temp     Varchar2(4000);
  v_Error    Varchar2(2000);

  Err_Custom Exception;
Begin
  Select Extractvalue(Value(A), 'IN/TYPE'), Extractvalue(Value(A), 'IN/GHID') As 挂号id,
         Extractvalue(Value(A), 'IN/RYKSID') As 入院科室id, Extractvalue(Value(A), 'IN/RYBQID') As 入院病区id,
         Extractvalue(Value(A), 'IN/CH') As 床号, Extractvalue(Value(A), 'IN/CZYBH') As 编号,
         Extractvalue(Value(A), 'IN/CZYXM') As 姓名, Extractvalue(Value(A), 'IN/YZID') As 医嘱id
  Into n_Type, n_挂号id, n_科室id, n_病区id, v_床号, v_人员编号, v_人员姓名, n_医嘱id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If n_Type = 1 Then
    --住院预约登记 
    Select a.病人id, a.No, Decode(a.急诊, 1, '急诊', Null)
    Into n_病人id, v_No, v_入院方式
    From 病人挂号记录 A
    Where a.Id = n_挂号id;
  
    Open c_Advice;
    Fetch c_Advice
      Into r_Advice;
  
    If r_Advice.紧急标志 = 1 Then
      v_入院方式 := '急诊';
    End If;
  
    Open c_Pati(n_病人id);
    Fetch c_Pati
      Into r_Pati;
  
    --当前操作人员 
    If v_人员编号 Is Null Or v_人员姓名 Is Null Then
      v_Temp     := Zl_Identity;
      v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
      v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
      v_人员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
      v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);
    End If;
  
    --删除留观记录和住院预约记录不能并存 
    Begin
      Select Count(1) Into n_Count From 病案主页 Where 病人id = r_Advice.病人id And Nvl(主页id, 0) = 0;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If Nvl(n_Count, 0) > 0 Then
      Zl_入院病案主页_Delete(r_Advice.病人id, 0, 0, 0);
      n_Count := 0;
    End If;
  
    If n_Count = 0 Then
      Select Count(1) Into n_Count From 病案主页 Where 病人id = r_Advice.病人id And 出院日期 Is Null;
    End If;
    If n_Count = 0 Then
      Select Count(1)
      Into n_Count
      From 病案主页
      Where 病人id = r_Advice.病人id And (入院日期 >= r_Advice.开始执行时间 Or 出院日期 >= r_Advice.开始执行时间);
    End If;
  
    If n_Count = 0 Then
      Zl_入院病案主页_Insert(1, 0, r_Pati.病人id, r_Pati.住院号, Null, r_Pati.姓名, r_Pati.性别, r_Pati.年龄, r_Pati.费别, r_Pati.出生日期,
                       r_Pati.国籍, r_Pati.民族, r_Pati.学历, r_Pati.婚姻状况, r_Pati.职业, r_Pati.身份, r_Pati.身份证号, r_Pati.出生地点,
                       r_Pati.家庭地址, r_Pati.家庭地址邮编, r_Pati.家庭电话, r_Pati.户口地址, r_Pati.户口地址邮编, r_Pati.联系人姓名, r_Pati.联系人关系,
                       r_Pati.联系人地址, r_Pati.联系人电话, r_Pati.工作单位, r_Pati.合同单位id, r_Pati.单位电话, r_Pati.单位邮编, r_Pati.单位开户行,
                       r_Pati.单位帐号, Null, Null, Null, n_科室id, Null, Null, v_入院方式, Null, Null, r_Advice.开嘱医生, r_Pati.籍贯,
                       r_Pati.区域, r_Advice.开始执行时间, Null, Null, r_Pati.医疗付款方式, Null, Null, Null, Null, Null, Null,
                       r_Pati.险类, v_人员编号, v_人员姓名, 0, Null, n_病区id, 0, Null, Null, Null, Null, Null, Null, Null, n_挂号id);
    End If;
  Else
    --取消登记 
    Select Count(1) Into n_Count From 病案主页 B Where b.挂号id = n_挂号id;
    If n_Count > 0 Then
      Select b.病人id Into n_病人id From 病案主页 B Where b.挂号id = n_挂号id;
      Zl_入院病案主页_Delete(n_病人id, 0);
    End If;
  End If;
  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Custom Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Outpatireg;
/
Create Or Replace Procedure Zl_Third_Advicecheck
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：病人医嘱核对/取消核对，数据写入
  --入参：xml_in
  --<IN>
  -- <TYPE>1</TYPE>   --操作类型：1、核对；0、取消核对
  -- <YZID>1162695</YZID>   --医嘱id
  -- <FSH>202704</FSH>   --发送号    
  -- <ZXSJ>2017-12-05 16:26:54</ZXSJ>   --执行时间

  --以下节点取消核对时传空
  -- <HDSJ>2017-12-05 10:00:00</HDSJ>   --核对时间  
  -- <HDR></HDR>   --核对人   
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  n_Type     Number;
  n_医嘱id   病人医嘱记录.Id%Type;
  n_发送号   病人医嘱发送.发送号%Type;
  d_执行时间 病人医嘱执行.要求时间%Type;
  d_核对时间 病人医嘱执行.要求时间%Type;
  v_核对人   病人医嘱执行.核对人%Type;
Begin
  Select Extractvalue(Value(A), 'IN/TYPE'), Extractvalue(Value(A), 'IN/YZID') As 医嘱id,
         Extractvalue(Value(A), 'IN/FSH') As 发送号,
         To_Date(Extractvalue(Value(A), 'IN/ZXSJ'), 'yyyy-mm-dd hh24:mi:ss') As 执行时间,
         To_Date(Extractvalue(Value(A), 'IN/HDSJ'), 'yyyy-mm-dd hh24:mi:ss') As d_核对时间,
         Extractvalue(Value(A), 'IN/HDR') As 核对人
  Into n_Type, n_医嘱id, n_发送号, d_执行时间, d_核对时间, v_核对人
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  If n_Type = 1 Then
    Zl_病人医嘱核对_Insert(n_医嘱id, n_发送号, v_核对人, d_执行时间, d_核对时间);  
  Else
    Zl_病人医嘱核对_Delete(n_医嘱id, n_发送号, d_执行时间);  
  End If;
  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Advicecheck;
/
CREATE OR REPLACE Procedure Zl_Third_Getpatiinfo_Ydhl
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取单个病人基本信息/查询
  --入参：Xml_In
  --<IN>
  --     <PATIID></PATIID>         --病人ID
  --     <PAGEID></PAGEID>     --主页ID
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --    <PATI>
  --      <JBXX>    --基本信息
  --        <PATIID></PATIID>         --病人ID
  --        <PAGEID></PAGEID>  --主页ID
  --        <BABY></BABY>  --婴儿序号
  --        <XM></XM>   --姓名
  --        <XB></XB>   --性别
  --        <NL></NL>   --年龄
  --        <CSRQ></CSRQ>  --出生日期
  --        <ZYH></ZYH>  --住院号
  --        <HY></HY>   --婚姻
  --        <GJ></GJ>   --国籍
  --        <MZ></MZ>   --民族
  --        <XL></XL>   --学历
  --        <SF></SF>   --身份
  --        <ZY></ZY>   --职业
  --        <SFZH></SFZH>  --身份证号
  --        <FKFS></FKFS>  --付款方式
  --        <LXFS></LXFS>  --联系方式
  --        <LXRXM></LXRXM>  --联系人姓名
  --        <LXRDH></LXRDH>  --联系人电话
  --        <LXRDZ></LXRDZ>  --联系人地址
  --        <JTDH></JTDH>  --家庭电话
  --        <JTDZ></JTDZ>  --家庭地址
  --        <CSDD></CSDD>  --出生地点
  --        <GMS></GMS>  --过敏史
  --      </JBXX>
  --      <ZYXX>    --住院信息
  --        <RYRQ></RYRQ>  --入院日期
  --        <RKRQ></RKRQ>  --入科日期
  --        <CYRQ></CYRQ>  --出院日期
  --        <ZYTS></ZYTS>  --住院天数
  --        <RYFS></RYFS>  --入院方式
  --        <KSID></KSID>  --科室ID
  --        <KSMC></KSMC>  --科室名称
  --        <BQID></BQID>  --病区ID
  --        <BQMC></BQMC>  --病区名称
  --        <CH></CH>   --床号
  --        <BQ></BQ>   --病情
  --        <ZZYS></ZZYS>  --主治医师
  --        <ZRYS></ZRYS>  --主任医师
  --        <ZYYS></ZYYS>  --住院医师
  --        <ZRHS></ZRHS>  --责任护士
  --        <HLDJ></HLDJ>  --护理等级
  --        <YLZ></YLZ>    --医疗小组id
  --        <YBH></YBH>    --医保号
  --        <YBMC></YBMC>  --医保名称
  --      </ZYXX>
  --    </PATI>
  --</OUTPUT>

  n_病人id 病人医嘱记录.Id%Type;
  n_主页id 病人医嘱记录.主页id%Type;
  v_Xtmp   Clob; --临时XML

  x_Templet Xmltype;

  v_过敏信息 Varchar2(5000);
  v_主治医师 Varchar2(500);
  v_主任医师 Varchar2(500);

  Cursor c_Pati Is
    Select a.病人id, b.主页id, 0 As 婴儿序号, Nvl(b.姓名, a.姓名) As 姓名, Nvl(b.性别, a.性别) As 性别, Nvl(b.年龄, a.年龄) As 年龄, a.出生日期, b.住院号,
           a.婚姻状况 As 婚姻, a.国籍, a.民族, a.学历, a.身份, a.职业, a.身份证号, a.医疗付款方式 As 付款方式, a.手机号 As 联系方式, a.联系人姓名, a.联系人电话,
           a.联系人地址, a.家庭电话, a.家庭地址, a.出生地点, '待定单独查询' As 过敏史, Decode(b.入科时间, Null, b.入院日期, b.入科时间) As 入院日期,
           b.入科时间 As 入科日期, b.出院日期, (Trunc(Nvl(b.出院日期, Sysdate)) - Trunc(Decode(b.入科时间, Null, b.入院日期, b.入科时间))) As 住院天数,
           b.入院方式, b.出院科室id As 科室id, c.名称 As 科室名称, b.当前病区id As 病区id, f.名称 As 病区名称, b.出院病床 As 床号, b.当前病况 As 病情,
           '待定病案主页从表' As 主治医师, '待定病案主页从表' As 主任医师, b.住院医师, b.责任护士, e.名称 As 护理等级, b.医疗小组id, a.医保号, d.名称 As 医保名称
    From 病人信息 A, 病案主页 B, 部门表 C, 保险类别 D, 收费项目目录 E, 部门表 F
    Where a.病人id = b.病人id And b.出院科室id = c.Id And b.险类 = d.序号(+) And b.护理等级id = e.Id(+) And b.当前病区id = f.Id And
          b.病人id = n_病人id And b.主页id = n_主页id;

  --放到循环中执行的，可能有性能问题
  Procedure p_Getother
  (
    病人id_In    In 病人信息.病人id%Type,
    主页id_In    In 病案主页.主页id%Type,
    过敏信息_Out Out Varchar2,
    主治医师_Out Out Varchar2,
    主任医师_Out Out Varchar2
  ) Is
  Begin

    过敏信息_Out := Null;
    主治医师_Out := Null;
    主任医师_Out := Null;

    For R In (Select a.信息名, a.信息值
              From 病案主页从表 A
              Where a.病人id = 病人id_In And a.主页id = 主页id_In And a.信息名 In ('主治医师', '主任医师')) Loop
      If r.信息名 = '主治医师' Then
        主治医师_Out := r.信息值;
      Elsif r.信息名 = '主任医师' Then
        主任医师_Out := r.信息值;
      End If;
    End Loop;

    For R In (Select a.药物名
              From 病人过敏记录 A, 病人挂号记录 B, 病案主页 C
              Where a.病人id = b.病人id(+) And a.主页id = b.Id(+) And b.记录性质(+) = 1 And b.记录状态(+) = 1 And a.病人id = c.病人id(+) And
                    a.主页id = c.主页id(+) And a.结果 = 1 And 药物名 Is Not Null And a.病人id = 202 And Not Exists
               (Select 药物id
                     From 病人过敏记录
                     Where (Nvl(药物id, 0) = Nvl(a.药物id, 0) Or Nvl(药物名, 'Null') = Nvl(a.药物名, 'Null')) And Nvl(结果, 0) = 0 And
                           记录时间 > a.记录时间 And 病人id = 202)
              Group By a.药物名
              Order By a.药物名) Loop
      过敏信息_Out := 过敏信息_Out || ',' || r.药物名;
    End Loop;
    过敏信息_Out := Substr(过敏信息_Out, 2);
  End;
Begin

  Select Extractvalue(Value(A), 'IN/PATIID') As 病人id, Extractvalue(Value(A), 'IN/PAGEID') As 主页id
  Into n_病人id, n_主页id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  For R In c_Pati Loop
    p_Getother(r.病人id, r.主页id, v_过敏信息, v_主治医师, v_主任医师);
    v_Xtmp := '<PATI>';
    v_Xtmp := v_Xtmp || '<JBXX>';
    v_Xtmp := v_Xtmp || '<PATIID>' || r.病人id || '</PATIID>';
    v_Xtmp := v_Xtmp || '<PAGEID>' || r.主页id || '</PAGEID>';
    v_Xtmp := v_Xtmp || '<BABY>' || r.婴儿序号 || '</BABY>';
    v_Xtmp := v_Xtmp || '<XM>' || r.姓名 || '</XM>';
    v_Xtmp := v_Xtmp || '<XB>' || r.性别 || '</XB>';
    v_Xtmp := v_Xtmp || '<NL>' || r.年龄 || '</NL>';
    v_Xtmp := v_Xtmp || '<CSRQ>' || To_Char(r.出生日期, 'yyyy-mm-dd hh24:mi:ss') || '</CSRQ>';
    v_Xtmp := v_Xtmp || '<ZYH>' || r.住院号 || '</ZYH>';
    v_Xtmp := v_Xtmp || '<HY>' || r.婚姻 || '</HY>';
    v_Xtmp := v_Xtmp || '<GJ>' || r.国籍 || '</GJ>';
    v_Xtmp := v_Xtmp || '<MZ>' || r.民族 || '</MZ>';
    v_Xtmp := v_Xtmp || '<XL>' || r.学历 || '</XL>';
    v_Xtmp := v_Xtmp || '<SF>' || r.身份 || '</SF>';
    v_Xtmp := v_Xtmp || '<ZY>' || r.职业 || '</ZY>';
    v_Xtmp := v_Xtmp || '<SFZH>' || r.身份证号 || '</SFZH>';
    v_Xtmp := v_Xtmp || '<FKFS>' || r.付款方式 || '</FKFS>';
    v_Xtmp := v_Xtmp || '<LXFS>' || r.联系方式 || '</LXFS>';
    v_Xtmp := v_Xtmp || '<LXRXM>' || r.联系人姓名 || '</LXRXM>';
    v_Xtmp := v_Xtmp || '<LXRDH>' || r.联系人电话 || '</LXRDH>';
    v_Xtmp := v_Xtmp || '<LXRDZ>' || r.联系人地址 || '</LXRDZ>';
    v_Xtmp := v_Xtmp || '<JTDH>' || r.家庭电话 || '</JTDH>';
    v_Xtmp := v_Xtmp || '<JTDZ>' || r.家庭地址 || '</JTDZ>';
    v_Xtmp := v_Xtmp || '<CSDD>' || r.出生地点 || '</CSDD>';
    v_Xtmp := v_Xtmp || '<GMS>' || v_过敏信息 || '</GMS>'; -- r.过敏史
    v_Xtmp := v_Xtmp || '</JBXX>';
    v_Xtmp := v_Xtmp || '<ZYXX>';
    v_Xtmp := v_Xtmp || '<RYRQ>' || To_Char(r.入院日期, 'yyyy-mm-dd hh24:mi:ss') || '</RYRQ>';
    v_Xtmp := v_Xtmp || '<RKRQ>' || To_Char(r.入科日期, 'yyyy-mm-dd hh24:mi:ss') || '</RKRQ>';
    v_Xtmp := v_Xtmp || '<CYRQ>' || To_Char(r.出院日期, 'yyyy-mm-dd hh24:mi:ss') || '</CYRQ>';
    v_Xtmp := v_Xtmp || '<ZYTS>' || r.住院天数 || '</ZYTS>';
    v_Xtmp := v_Xtmp || '<RYFS>' || r.入院方式 || '</RYFS>';
    v_Xtmp := v_Xtmp || '<KSID>' || r.科室id || '</KSID>';
    v_Xtmp := v_Xtmp || '<KSMC>' || r.科室名称 || '</KSMC>';
    v_Xtmp := v_Xtmp || '<BQID>' || r.病区id || '</BQID>';
    v_Xtmp := v_Xtmp || '<BQMC>' || r.病区名称 || '</BQMC>';
    v_Xtmp := v_Xtmp || '<CH>' || r.床号 || '</CH>';
    v_Xtmp := v_Xtmp || '<BQ>' || r.病情 || '</BQ>';
    v_Xtmp := v_Xtmp || '<ZZYS>' || v_主治医师 || '</ZZYS>';
    v_Xtmp := v_Xtmp || '<ZRYS>' || v_主任医师 || '</ZRYS>';
    v_Xtmp := v_Xtmp || '<ZYYS>' || r.住院医师 || '</ZYYS>';
    v_Xtmp := v_Xtmp || '<ZRHS>' || r.责任护士 || '</ZRHS>';
    v_Xtmp := v_Xtmp || '<HLDJ>' || r.护理等级 || '</HLDJ>';
    v_Xtmp := v_Xtmp || '<YLZ>' || r.医疗小组id || '</YLZ>';
    v_Xtmp := v_Xtmp || '<YBH>' || r.医保号 || '</YBH>';
    v_Xtmp := v_Xtmp || '<YBMC>' || r.医保名称 || '</YBMC>';
    v_Xtmp := v_Xtmp || '</ZYXX>';
    v_Xtmp := v_Xtmp || '</PATI>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Xtmp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpatiinfo_Ydhl;
/
CREATE OR REPLACE Procedure Zl_Third_Getadviceinfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取医嘱基本信息/查询
  --参数：
  --入参数 Xml_In
  --<IN>
  --     <YZID>1156789</YZID>--主医嘱ID
  --</IN>

  --出参 Xml_Out
  --<OUTPUT>
  --    <YZ>
  --       <PATIID></PATIID>     --病人医嘱记录.病人ID
  --       <PAGEID></PAGEID>     --病人医嘱记录.主页ID
  --       <BABY></BABY>   --病人医嘱记录.婴儿
  --       <YZID>1145878</YZID>   --病人医嘱记录.医嘱ID， 主医嘱ID
  --       <RELATEDID></RELATEDID>   --病人医嘱记录.相关ID
  --       <ZXKSID></ZXKSID>   --病人医嘱记录.执行科室id
  --       <YZQX>0</YZQX>      --病人医嘱记录.医嘱期效
  --       <STATE>8</STATE>    --病人医嘱记录.医嘱状态
  --       <JJBZ>0</JJBZ>      --病人医嘱记录.紧急标志
  --       <KZYS>代翔</KZYS>   --病人医嘱记录.开嘱医生
  --       <KZSJ>2015-03-25 16:37:00</KZSJ>   --病人医嘱记录.开嘱时间
  --       <ZLXMID></ZLXMID>   --诊疗项目目录.ID
  --       <ZLLB>E</ZLLB>      --诊疗项目目录.类别
  --       <ZLXMMC></ZLXMMC>   --诊疗项目目录.名称 ，检查，检验(检验行 C)，手术(主手术行 F)，输血(K)，中药配方(服法行 E)，其它(本身)
  --       <ZLXMCZLX></<ZLXMCZLX>   --诊疗项目目录.操作类型
  --       <ZLXMZXFL></ZLXMZXFL>   --诊疗项目目录.执行分类
  --       <BZ>21</BZ> 诊疗项目目录.操作类型||诊疗项目目录.执行分类
  --       <YF>静脉滴注</YF>   --病人医嘱记录.医嘱内容 ，主医嘱行中的  医嘱内容
  --       <PC>BID</PC>   --诊疗频率项目.英文名称
  --       <ZXSJFY>18-20</ZXSJFY>   --病人医嘱记录.执行时间方案
  --       <PLCS>2</PLCS>   --病人医嘱记录.频率次数
  --       <PLJG>1</PLJG>   --病人医嘱记录.频率间隔
  --       <PSJG></PSJG>   --病人医嘱记录.皮试结果
  --       <YSZT></YSZT>   --病人医嘱记录.医生嘱托
  --       <KSZXSJ>2015-03-25 16:35:00</KSZXSJ>  --病人医嘱记录.开始执行时间
  --       <ZXZZSJ></ZXZZSJ>   --病人医嘱记录.执行终止时间
  --       <TZYS></TZYS>   --病人医嘱记录.停嘱医生
  --       <TZSJ></TZSJ>   --病人医嘱记录.停嘱时间
  --       <DW>次</DW>   --诊疗项目目录.计算单位
  --       <DL></DL>   --病人医嘱记录.单次用量
  --       <ZL></ZL>   --病人医嘱记录.总给予量
  --       <BBBW></BBBW>   --标本部位，诊疗项目目录.标本部位

  --       <ITEMLIST> 仅输血项目和西/成药医嘱项目明细相关信息；输血的血袋信息，药品行明细信息
  --        <ITEM>
  --         <YSZT></YSZT>   --病人医嘱记录.医生嘱托
  --         <YZID>1145878</YZID>   --病人医嘱记录.医嘱ID
  --         <RELATEDID></RELATEDID>   --病人医嘱记录.相关ID
  --         <ZLXMID></ZLXMID>   --诊疗项目目录.ID
  --         <SFXMID></SFXMID>   --收费项目目录.id
  --         <SFXMMC></SFXMMC>   --收费项目目录.名称
  --         <SFXMGG></SFXMGG>   --收费项目目录.规格
  --         <BM></BM>           --收费项目别名.名称（商品名）
  --         <ZL></ZL>           --病人医嘱记录.总给予量
  --         <DL>10</DL>         --病人医嘱记录.单次用量
  --         <DW>ml</DW>         --收费项目目录.计算单位
  --         <ZLDW>ml</ZLDW>   --诊疗项目目录.计算单位
  --         <ZXXZ></ZXXZ>   --病人医嘱记录.执行性质
  --         <ZXKS></ZXKS>   --诊疗项目目录.执行科室
  --         <XDBH></XDBH>   --血液收发记录.血袋编号
  --         <SXXH></SXXH>   --血液收发记录.序号
  --        </ITEM>
  --        <ITEM/>...
  --       </ITEMLIST>
  --      </YZ>
  --</OUTPUT>

  n_医嘱id  病人医嘱记录.Id%Type;
  x_医嘱    Xmltype;
  x_Item    Xmltype;
  v_Xtmp    Clob; --临时XML
  n_Cnt     Number;
  x_Templet Xmltype;

  v_英文名     诊疗频率项目.英文名称%Type;
  v_试管名称   采血管类型.名称%Type;
  v_添加剂     采血管类型.添加剂%Type;
  v_试管规格   采血管类型.规格%Type;
  n_试管颜色   采血管类型.颜色%Type;
  v_收费商品名 收费项目别名.名称%Type;
  n_启用血库   Number;
  v_Sql血库    Varchar2(4000);
  n_血库申请id Number(18);
  v_Tmp输血    Varchar2(4000);

  Type Bloodlist_Type Is Ref Cursor;
  Cbloodlist Bloodlist_Type;

  Type t_Code Is Record(
    ID       收费项目目录.Id%Type,
    名称     收费项目目录.名称%Type,
    规格     收费项目目录.规格%Type,
    单位     收费项目目录.计算单位%Type,
    血袋编号 Varchar2(50),
    序号     Number(5));
  r_b t_Code;

Begin

  Select Extractvalue(Value(A), 'IN/YZID') Into n_医嘱id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  n_Cnt := 0;
  For R In (Select a.病人id, a.主页id, a.婴儿, a.Id As 医嘱id, a.相关id, a.执行科室id, a.医嘱期效, a.医嘱状态, a.紧急标志, a.开嘱医生, a.开嘱时间, a.诊疗项目id,
                   a.诊疗类别, a.医嘱内容, a.执行时间方案, a.执行频次, a.频率次数, a.频率间隔, a.皮试结果, a.医生嘱托, a.开始执行时间, a.执行终止时间, a.停嘱医生, a.停嘱时间,
                   b.名称 As 项目名称,  Decode(b.类别,'E',Decode(b.操作类型, '2', b.操作类型 || b.执行分类, '1', '1', '4', '4', '6', '6', '99'),'D','','99') As 操执,b.操作类型, b.执行分类, b.计算单位 As 诊疗单位, a.单次用量, a.总给予量, b.标本部位, a.检查方法, a.收费细目id, c.名称 As 收费名称,
                   c.规格, Null As 收费商品名, c.计算单位 As 收费单位, a.执行性质, b.执行科室, b.试管编码, c.产地, d.高危药品
            From 病人医嘱记录 A, 诊疗项目目录 B, 收费项目目录 C, 药品规格 D
            Where a.诊疗项目id = b.Id And a.收费细目id = c.Id(+) And a.收费细目id = d.药品id(+) And (a.Id = n_医嘱id Or a.相关id = n_医嘱id)
            Order By a.序号) Loop
    n_Cnt := n_Cnt + 1;
    If n_Cnt = 1 Then
      Select Max(a.英文名称) Into v_英文名 From 诊疗频率项目 A Where a.名称 = r.执行频次;
    End If;
    v_试管名称 := Null;
    v_添加剂   := Null;
    v_试管规格 := Null;
    n_试管颜色 := Null;
    If r.试管编码 Is Not Null Then
      Select Max(a.名称), Max(a.添加剂), Max(a.规格), Max(a.颜色)
      Into v_试管名称, v_添加剂, v_试管规格, n_试管颜色
      From 采血管类型 A
      Where a.编码 = r.试管编码;
    End If;
    --主医行
    If r.相关id Is Null Then
      v_Xtmp := '<YZ>';
      v_Xtmp := v_Xtmp || '<PATIID>' || r.病人id || '</PATIID>'; --病人医嘱记录.病人ID
      v_Xtmp := v_Xtmp || '<PAGEID>' || r.主页id || '</PAGEID>'; --病人医嘱记录.主页ID
      v_Xtmp := v_Xtmp || '<BABY>' || r.婴儿 || '</BABY>'; --病人医嘱记录.婴儿
      v_Xtmp := v_Xtmp || '<YZID>' || r.医嘱id || '</YZID>'; --病人医嘱记录.医嘱ID
      v_Xtmp := v_Xtmp || '<RELATEDID>' || r.相关id || '</RELATEDID>'; --病人医嘱记录.相关ID
      v_Xtmp := v_Xtmp || '<ZXKSID>' || r.执行科室id || '</ZXKSID>'; --病人医嘱记录.执行科室id
      v_Xtmp := v_Xtmp || '<YZQX>' || r.医嘱期效 || '</YZQX>'; --病人医嘱记录.医嘱期效
      v_Xtmp := v_Xtmp || '<STATE>' || r.医嘱状态 || '</STATE>'; --病人医嘱记录.医嘱状态
      v_Xtmp := v_Xtmp || '<JJBZ>' || r.紧急标志 || '</JJBZ>'; --病人医嘱记录.紧急标志
      v_Xtmp := v_Xtmp || '<KZYS>' || r.开嘱医生 || '</KZYS>'; --病人医嘱记录.开嘱医生
      v_Xtmp := v_Xtmp || '<KZSJ>' || To_Char(r.开嘱时间, 'yyyy-mm-dd hh24:mi:ss') || '</KZSJ>'; --病人医嘱记录.开嘱时间
      v_Xtmp := v_Xtmp || '<BZ>' || r.操执 || '</BZ>'; -- 诊疗项目目录.操作类型||诊疗项目目录.执行分类
      v_Xtmp := v_Xtmp || '<ZLXMID>' || r.诊疗项目id || '</ZLXMID>'; --诊疗项目目录.ID
      v_Xtmp := v_Xtmp || '<ZLLB>' || r.诊疗类别 || '</ZLLB>'; --诊疗项目目录.类别
      v_Xtmp := v_Xtmp || '<YZNR>' || r.医嘱内容 || '</YZNR>'; --医嘱内容
      v_Xtmp := v_Xtmp || '<YF>' || r.项目名称 || '</YF>'; --病人医嘱记录.医嘱内容
      v_Xtmp := v_Xtmp || '<PC>' || v_英文名 || '</PC>'; --诊疗频率项目.英文名称
      v_Xtmp := v_Xtmp || '<ZXSJFY>' || r.执行时间方案 || '</ZXSJFY>'; --病人医嘱记录.执行时间方案
      v_Xtmp := v_Xtmp || '<PLCS>' || r.频率次数 || '</PLCS>'; --病人医嘱记录.频率次数
      v_Xtmp := v_Xtmp || '<PLJG>' || r.频率间隔 || '</PLJG>'; --病人医嘱记录.频率间隔
      v_Xtmp := v_Xtmp || '<PSJG>' || r.皮试结果 || '</PSJG>'; --病人医嘱记录.皮试结果
      v_Xtmp := v_Xtmp || '<YSZT>' || r.医生嘱托 || '</YSZT>'; --病人医嘱记录.医生嘱托
      v_Xtmp := v_Xtmp || '<KSZXSJ>' || To_Char(r.开始执行时间, 'yyyy-mm-dd hh24:mi:ss') || '</KSZXSJ>'; --病人医嘱记录.开始执行时间
      v_Xtmp := v_Xtmp || '<ZXZZSJ>' || To_Char(r.执行终止时间, 'yyyy-mm-dd hh24:mi:ss') || '</ZXZZSJ>'; --病人医嘱记录.执行终止时间
      v_Xtmp := v_Xtmp || '<TZYS>' || r.停嘱医生 || '</TZYS>'; --病人医嘱记录.停嘱医生
      v_Xtmp := v_Xtmp || '<TZSJ>' || To_Char(r.停嘱时间, 'yyyy-mm-dd hh24:mi:ss') || '</TZSJ>'; --病人医嘱记录.停嘱时间
      v_Xtmp := v_Xtmp || '<ZLXMMC>' || r.项目名称 || '</ZLXMMC>'; --诊疗项目目录.名称
      v_Xtmp := v_Xtmp || '<ZLXMCZLX>' || r.操作类型 || '</ZLXMCZLX>'; --诊疗项目目录.操作类型
      v_Xtmp := v_Xtmp || '<ZLXMZXFL>' || r.执行分类 || '</ZLXMZXFL>'; --诊疗项目目录.执行分类
      --       (仅采血管返回)
      v_Xtmp := v_Xtmp || '<CXGMC>' || v_试管名称 || '</CXGMC>'; --采血管名称
      v_Xtmp := v_Xtmp || '<CXGTJJ>' || v_添加剂 || '</CXGTJJ>'; --采血管添加剂
      v_Xtmp := v_Xtmp || '<CXGGG>' || v_试管规格 || '</CXGGG>'; --采血管规格
      v_Xtmp := v_Xtmp || '<CXGYS>' || n_试管颜色 || '</CXGYS>'; --采血管颜色
      v_Xtmp := v_Xtmp || '<DW>' || r.诊疗单位 || '</DW>'; --诊疗项目目录.计算单位
      v_Xtmp := v_Xtmp || '<DL>' || r.单次用量 || '</DL>'; --病人医嘱记录.单次用量
      v_Xtmp := v_Xtmp || '<ZL>' || r.总给予量 || '</ZL>'; --病人医嘱记录.总给予量
      v_Xtmp := v_Xtmp || '<BBBW>' || r.标本部位 || '</BBBW>'; --诊疗项目目录.标本部位
      v_Xtmp := v_Xtmp || '</YZ>';
      x_医嘱 := Xmltype(v_Xtmp);
    End If;

    --输血
    If r.诊疗类别 = 'K' Then
      --判断是否安装血库
      Select Zl_Checkobject(1, '血液收发记录') Into n_启用血库 From Dual;
      If n_启用血库 > 0 Then
        n_血库申请id := r.医嘱id;
        --医嘱部分
        v_Xtmp    := '<YSZT>' || r.医生嘱托 || '</YSZT>'; --病人医嘱记录.医生嘱托
        v_Xtmp    := v_Xtmp || '<YZID>' || r.医嘱id || '</YZID>'; --病人医嘱记录.医嘱ID
        v_Xtmp    := v_Xtmp || '<RELATEDID>' || r.相关id || '</RELATEDID>'; --病人医嘱记录.相关ID
        v_Xtmp    := v_Xtmp || '<ZLXMID>' || r.诊疗项目id || '</ZLXMID>'; --诊疗项目目录.ID
        v_Xtmp    := v_Xtmp || '<ZL>' || r.总给予量 || '</ZL>'; --病人医嘱记录.总给予量
        v_Xtmp    := v_Xtmp || '<DL>' || r.单次用量 || '</DL>'; --病人医嘱记录.单次用量
        v_Xtmp    := v_Xtmp || '<ZLDW>' || r.诊疗单位 || '</ZLDW>'; --诊疗项目目录.计算单位
        v_Xtmp    := v_Xtmp || '<ZXXZ>' || r.执行性质 || '</ZXXZ>'; --病人医嘱记录.执行性质
        v_Xtmp    := v_Xtmp || '<ZXKS>' || r.执行科室 || '</ZXKS>'; --诊疗项目目录.执行科室
        v_Tmp输血 := v_Xtmp;
        If r.检查方法 = '1' Then
          v_Sql血库 := 'Select d.Id,d.名称,d.规格,d.计算单位 as 单位, a.血袋编号,a.序号
                       From 血液收发记录 a,血液发送记录 b,血液配血记录 c,收费项目目录 d
                       Where a.Id = b.收发id And b.配发id = c.Id and a.血液id =d.id  And c.申请id =:1';
        End If;
      End If;
    Elsif r.相关id Is Not Null And r.诊疗类别 = 'E' And r.操作类型 = '8' And Nvl(r.执行分类, 0) = 0 And n_启用血库 = 1 And
          v_Sql血库 Is Null Then
      v_Sql血库 := 'Select b.Id,b.名称,  b.规格,b.计算单位 as 单位, a.血袋编号,a.序号
                  From 血液收发记录 a,收费项目目录 b
                  Where a.血液id =b.id and a.配发id = (Select Id From 血液配血记录 Where 申请id=:1)';
    Else
      v_Sql血库 := Null;
    End If;

    If v_Sql血库 Is Not Null And n_血库申请id Is Not Null Then
      --输血医嘱，只有发医嘱后才可能有血袋信息
      x_Item := Xmltype('<ITEMLIST></ITEMLIST>');
      Open Cbloodlist For v_Sql血库
        Using n_血库申请id;
      Loop
        Fetch Cbloodlist
          Into r_b.Id, r_b.名称, r_b.规格, r_b.单位, r_b.血袋编号, r_b.序号;
        Exit When Cbloodlist%NotFound;
        v_收费商品名 := Null;
        If r_b.Id Is Not Null Then
          For Z In (Select a.名称, a.性质
                    From 收费项目别名 A
                    Where a.收费细目id = r_b.Id
                    Group By a.名称, a.性质
                    Order By a.性质) Loop
            v_收费商品名 := z.名称;
            If z.性质 = 3 Then
              v_收费商品名 := z.名称;
              Exit;
            End If;
          End Loop;
        End If;

        v_Xtmp := '<ITEM jsonArray="True" >';

        v_Xtmp := v_Xtmp || v_Tmp输血;

        --血库部分
        v_Xtmp := v_Xtmp || '<SFXMID>' || r_b.Id || '</SFXMID>'; --收费项目目录.id
        v_Xtmp := v_Xtmp || '<SFXMMC>' || r_b.名称 || '</SFXMMC>'; --收费项目目录.名称
        v_Xtmp := v_Xtmp || '<SFXMGG>' || r_b.规格 || '</SFXMGG>'; --收费项目目录.规格
        v_Xtmp := v_Xtmp || '<BM>' || v_收费商品名 || '</BM>'; --收费项目别名.名称（商品名）
        v_Xtmp := v_Xtmp || '<DW>' || r_b.单位 || '</DW>'; --收费项目目录.计算单位
        v_Xtmp := v_Xtmp || '<XDBH>' || r_b.血袋编号 || '</XDBH>'; --血液收发记录.血袋编号
        v_Xtmp := v_Xtmp || '<SXXH>' || r_b.序号 || '</SXXH>'; --血液收发记录.序号

        v_Xtmp := v_Xtmp || '</ITEM>';
        Select Appendchildxml(x_Item, '/ITEMLIST', Xmltype(v_Xtmp)) Into x_Item From Dual;
      End Loop;
      Close Cbloodlist;
    End If;

    --西药成药医嘱
    If r.诊疗类别 = '5' Or r.诊疗类别 = '6' Then
      --西/成 药
      If x_Item Is Null Then
        --只初始化一次
        x_Item := Xmltype('<ITEMLIST></ITEMLIST>');
      End If;
      v_收费商品名 := Null;
      If r.收费细目id Is Not Null Then
        For Z In (Select a.名称, a.性质
                  From 收费项目别名 A
                  Where a.收费细目id = r.收费细目id
                  Group By a.名称, a.性质
                  Order By a.性质) Loop
          v_收费商品名 := z.名称;
          If z.性质 = 3 Then
            v_收费商品名 := z.名称;
            Exit;
          End If;
        End Loop;
      End If;

      v_Xtmp := '<ITEM jsonArray="True" >';
      v_Xtmp := v_Xtmp || '<YSZT>' || r.医生嘱托 || '</YSZT>'; --病人医嘱记录.医生嘱托
      v_Xtmp := v_Xtmp || '<YZID>' || r.医嘱id || '</YZID>'; --病人医嘱记录.医嘱ID
      v_Xtmp := v_Xtmp || '<RELATEDID>' || r.相关id || '</RELATEDID>'; --病人医嘱记录.相关ID
      v_Xtmp := v_Xtmp || '<GW>' || nvl(r.高危药品,0) || '</GW>'; --高危药标识，1表示高危药，0表示普通
      v_Xtmp := v_Xtmp || '<CDM>' || r.产地 || '</CDM>'; --产地名，收费项目目录.产地
      v_Xtmp := v_Xtmp || '<ZLXMID>' || r.诊疗项目id || '</ZLXMID>'; --诊疗项目目录.ID
      v_Xtmp := v_Xtmp || '<SFXMID>' || r.收费细目id || '</SFXMID>'; --收费项目目录.id
      v_Xtmp := v_Xtmp || '<SFXMMC>' || r.收费名称 || '</SFXMMC>'; --收费项目目录.名称
      v_Xtmp := v_Xtmp || '<SFXMGG>' || r.规格 || '</SFXMGG>'; --收费项目目录.规格
      v_Xtmp := v_Xtmp || '<BM>' || v_收费商品名 || '</BM>'; --收费项目别名.名称（商品名）
      v_Xtmp := v_Xtmp || '<ZL>' || r.总给予量 || '</ZL>'; --病人医嘱记录.总给予量
      v_Xtmp := v_Xtmp || '<DL>' || r.单次用量 || '</DL>'; --病人医嘱记录.单次用量
      v_Xtmp := v_Xtmp || '<DW>' || r.收费单位 || '</DW>'; --收费项目目录.计算单位
      v_Xtmp := v_Xtmp || '<ZLDW>' || r.诊疗单位 || '</ZLDW>'; --诊疗项目目录.计算单位
      v_Xtmp := v_Xtmp || '<ZXXZ>' || r.执行性质 || '</ZXXZ>'; --病人医嘱记录.执行性质
      v_Xtmp := v_Xtmp || '<ZXKS>' || r.执行科室 || '</ZXKS>'; --诊疗项目目录.执行科室
      v_Xtmp := v_Xtmp || '<XDBH></XDBH>'; --血液收发记录.血袋编号
      v_Xtmp := v_Xtmp || '<SXXH></SXXH>'; --血液收发记录.序号
      v_Xtmp := v_Xtmp || '</ITEM>';
      Select Appendchildxml(x_Item, '/ITEMLIST', Xmltype(v_Xtmp)) Into x_Item From Dual;
    End If;
  End Loop;
  If x_Item Is Not Null Then
    Select Appendchildxml(x_医嘱, '/YZ', x_Item) Into x_医嘱 From Dual;
  End If;
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  Select Appendchildxml(x_Templet, '/OUTPUT', x_医嘱) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getadviceinfo;
/
CREATE OR REPLACE Procedure Zl_Third_Getadvicesend
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取医嘱发送信息/查询
  --用于监听表【病人医嘱发送】的变化后，通过医嘱ID查询医嘱发送详情
  --入参：Xml_In
  --<IN>
  --     <YZID>1162695</YZID>
  --</IN>
  --出参：Xml_Out
  --<OUTPUT>
  --     <YZSENDLIST>
  --           <ITEM>
  --                <YZID></YZID>   --病人医嘱发送.医嘱ID
  --                <FSH></FSH>   --病人医嘱发送.发送号
  --                <YBTM></YBTM>   --病人医嘱发送.样本条码
  --                <ZXZT></ZXZT>   --病人医嘱发送.执行状态
  --               <YQSJ></YQSJ>   --医嘱执行时间.要求时间
  --           </ITEM>
  --     </YZSENDLIST>
  --</OUTPUT>

  n_医嘱id  病人医嘱记录.Id%Type;
  v_Xtmp    varchar2(4000); --临时XML
  x_Templet Xmltype;
Begin
  x_Templet := Xmltype('<OUTPUT><YZSENDLIST></YZSENDLIST></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/YZID') Into n_医嘱id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  For R In (Select a.医嘱id, a.发送号, a.样本条码, a.执行状态, b.要求时间
            From 病人医嘱发送 A, 医嘱执行时间 B
            Where a.医嘱id = b.医嘱id And a.发送号 = b.发送号 And a.医嘱id = n_医嘱id
            Order By a.发送号, b.要求时间) Loop
    v_Xtmp := '<ITEM jsonArray="true" >';
    v_Xtmp := v_Xtmp || '<YZID>' || r.医嘱id || '</YZID>';
    v_Xtmp := v_Xtmp || '<FSH>' || r.发送号 || '</FSH>';
    v_Xtmp := v_Xtmp || '<YBTM>' || r.样本条码 || '</YBTM>';
    v_Xtmp := v_Xtmp || '<ZXZT>' || r.执行状态 || '</ZXZT>';
    v_Xtmp := v_Xtmp || '<YQSJ>' || To_Char(r.要求时间, 'yyyy-mm-dd hh24:mi:ss') || '</YQSJ>';
    v_Xtmp := v_Xtmp || '</ITEM>';
    Select Appendchildxml(x_Templet, '/OUTPUT/YZSENDLIST', Xmltype(v_Xtmp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getadvicesend;
/
CREATE OR REPLACE Procedure Zl_Third_Getadvicestop
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取医嘱停止信息/查询
  --病人医嘱记录.状态=8时，表示停止
  --入参：Xml_In
  --<IN>
  --     <YZID>1162695</YZID>
  --</IN>
  --出参：Xml_Out
  --<OUTPUT>
  --     <YZ>
  --         <YZID></YZID>   --病人医嘱记录.医嘱ID
  --         <YZZT></YZZT>   --病人医嘱记录.医嘱状态
  --         <TZYS></TZYS>   --病人医嘱记录.停嘱医生
  --         <TZSJ></TZSJ>   --病人医嘱记录.停嘱时间
  --     </YZ>
  --</OUTPUT>

  n_医嘱id 病人医嘱记录.Id%Type;
  v_Xtmp   Varchar(5000); --临时XML
Begin

  Select Extractvalue(Value(A), 'IN/YZID') Into n_医嘱id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For R In (Select a.Id As 医嘱id, a.医嘱状态, a.停嘱医生, a.停嘱时间 From 病人医嘱记录 A Where a.Id = n_医嘱id) Loop
    v_Xtmp := '<OUTPUT>';
    v_Xtmp := v_Xtmp || '<YZID>' || r.医嘱id || '</YZID>';
    v_Xtmp := v_Xtmp || '<YZZT>' || r.医嘱状态 || '</YZZT>';
    v_Xtmp := v_Xtmp || '<TZYS>' || r.停嘱医生 || '</TZYS>';
    v_Xtmp := v_Xtmp || '<TZSJ>' || To_Char(r.停嘱时间, 'yyyy-mm-dd hh24:mi:ss') || '</TZSJ>';
    v_Xtmp := v_Xtmp || '</OUTPUT>';
  End Loop;

  If v_Xtmp Is Not Null Then
    Xml_Out := Xmltype(v_Xtmp);
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getadvicestop;
/
Create Or Replace Procedure Zl_Third_Adviceoperation
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：医嘱执行登记/取消执行登记 /写入
  --1、用于每次医嘱执行时的执行登记，”来源“用于区分是否移动端执行
  --2、对已执行的医嘱取消执行操作
  --入参：xml_in
  --<IN>
  -- <TYPE>1</TYPE>   --操作类型：1、执行登记；0、取消执行登记
  -- <YZID>1162695</YZID>   --医嘱id
  -- <FSH>202704</FSH>   --发送号
  -- <YQSJ>2017-12-05 10:00:00</YQSJ>   --要求时间
  -- <CZY></CZY>   --操作员
  -- <CZSJ>2017-12-05 16:26:54</CZSJ>   --操作时间

  --以下节点取消执行时传空
  -- <ZXSM>PDA执行</ZXSM>   --执行摘要
  -- <ZXCS></ZXCS>   --执行次数
  -- <SYTD>左手背</SYTD>
  -- <JLLY>1</JLLY>    --记录来源，0-PC端登记，1-移动临床登记，移动端固定传1
  -- <ZXFS>2</ZXFS>  --执行方式，0-常规(无意义)，1-手工执行，2-扫码执行

  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  n_Type     Number;
  n_医嘱id   病人医嘱记录.Id%Type;
  n_发送号   病人医嘱发送.发送号%Type;
  d_要求时间 病人医嘱执行.要求时间%Type;
  d_执行时间 病人医嘱执行.执行时间%Type;
  v_执行摘要 病人医嘱执行.执行摘要%Type;
  n_本次数次 病人医嘱执行.本次数次%Type;
  v_输液通道 病人医嘱执行.输液通道%Type;
  n_记录来源 病人医嘱执行.记录来源%Type;
  v_执行人   病人医嘱执行.执行人%Type;
  n_执行方式 Number;
  v_Err_Msg  Varchar2(200);
  Err_Item Exception;
Begin
  Select Extractvalue(Value(A), 'IN/TYPE'), Extractvalue(Value(A), 'IN/YZID') As 医嘱id,
         Extractvalue(Value(A), 'IN/FSH') As 发送号,
         To_Date(Extractvalue(Value(A), 'IN/YQSJ'), 'yyyy-mm-dd hh24:mi:ss') As 要求时间,
         Extractvalue(Value(A), 'IN/CZY') As 执行人,
         To_Date(Extractvalue(Value(A), 'IN/CZSJ'), 'yyyy-mm-dd hh24:mi:ss') As 执行时间,
         Extractvalue(Value(A), 'IN/ZXSM') As 执行摘要, Extractvalue(Value(A), 'IN/ZXCS') As 本次数次,
         Extractvalue(Value(A), 'IN/SYTD') As 输液通道, Extractvalue(Value(A), 'IN/JLLY') As 记录来源,
         Extractvalue(Value(A), 'IN/ZXFS') As 执行方式
  Into n_Type, n_医嘱id, n_发送号, d_要求时间, v_执行人, d_执行时间, v_执行摘要, n_本次数次, v_输液通道, n_记录来源, n_执行方式
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_发送号, 0) = 0 Then
    Select Max(发送号) Into n_发送号 From 病人医嘱发送 Where 医嘱id = n_医嘱id;
  End If;

  If Nvl(n_医嘱id, 0) = 0 Or Nvl(n_发送号, 0) = 0 Then
    v_Err_Msg := '未传入完整的执行条件,无法完成修改医嘱的执行状态和状态说明!';
    Raise Err_Item;
  End If;

  If n_Type = 1 Then
    Zl_病人医嘱执行_Insert(n_医嘱id, n_发送号, d_要求时间, n_本次数次, v_执行摘要, v_执行人, d_执行时间, 0, 0, 1, Null, Null, Null, 0, 0, 0, v_输液通道,
                     n_记录来源);
  Else
    Zl_病人医嘱执行_Delete(n_医嘱id, n_发送号, d_执行时间, 0, 0, 0);
  End If;
  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Adviceoperation;
/
CREATE OR REPLACE Procedure Zl_Third_Skintestoperation
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：登记皮试结果/写入
  --入参：Xml_In
  --<IN>
  --   <YZID>1162695</YZID>   --医嘱id
  --   <PSBQ>(+)</PSBQ>   --皮试标签
  --   <PSJG>1</PSJG>     --皮试结果
  --   <CZY></CZY>        --操作员
  --   <CZSJ>2017-12-05 16:26:54</CZSJ>   --操作时间
  --</IN>
  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  n_医嘱id   病人医嘱记录.Id%Type;
  v_皮试标签 病人医嘱记录.皮试结果%Type;
  n_皮试结果 病人过敏记录.结果%Type;
  v_操作员   人员表.姓名%Type;
  d_操作时间 Date;
Begin
  Select Extractvalue(Value(A), 'IN/YZID') As 医嘱id, Extractvalue(Value(A), 'IN/PSBQ') As 皮试标签,
         Extractvalue(Value(A), 'IN/PSJG') As 皮试结果, Extractvalue(Value(A), 'IN/CZY') As 操作员,
         To_Date(Extractvalue(Value(A), 'IN/CZSJ'), 'yyyy-mm-dd hh24:mi:ss') As 操作时间
  Into n_医嘱id, v_皮试标签, n_皮试结果, v_操作员, d_操作时间
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  Zl_病人医嘱记录_皮试(n_医嘱id, v_皮试标签, n_皮试结果, v_操作员, d_操作时间, Null);
  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Skintestoperation;
/
Create Or Replace Procedure Zl_Third_Advicestopaffirm
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：医嘱确认停止/写入 
  --入参数：Xml_In 
  --<IN> 
  --   <YZID>1162695</YZID>   --医嘱id 主医嘱ID 
  --   <CZY></CZY>   --操作员 
  --   <CZSJ>2017-12-05 16:26:54</CZSJ>   --操作时间 
  --</IN> 
  --出参：Xml_Out 
  --<OUTPUT> 
  --   <RESULT>true</RESULT> 
  --</OUTPUT> 

  --失败： 
  --<OUTPUT> 
  --   <RESULT>false</RESULT> 
  --   <ERROR> 
  --     <MSG>详细错误提示</MSG> 
  --   </ERROR> 
  --</OUTPUT> 

  n_医嘱id   病人医嘱记录.Id%Type;
  v_操作员   人员表.姓名%Type;
  d_操作时间 Date;
  c_Jsonask  Clob;
  c_Jsonout  Clob;
  n_Isexist  Number;
  j_Json     Pljson;
  v_Errtmp   Varchar2(4000);

Begin
  Select Extractvalue(Value(A), 'IN/YZID'), Extractvalue(Value(A), 'IN/CZY'),
         To_Date(Extractvalue(Value(A), 'IN/CZSJ'), 'yyyy-mm-dd hh24:mi:ss')
  Into n_医嘱id, v_操作员, d_操作时间
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  c_Jsonask := Empty_Clob();
  Dbms_Lob.Createtemporary(c_Jsonask, True);
  c_Jsonout := Empty_Clob();
  Dbms_Lob.Createtemporary(c_Jsonout, True);
  c_Jsonask := '{"input":{"pivas_ids":"","advice_ids":"' || n_医嘱id || '","send_no":"","query_type":2}}';
  Zl_Pivassvr_Locked(c_Jsonask, c_Jsonout);
  If c_Jsonout Is Not Null Then
    j_Json    := Pljson(c_Jsonout);
    n_Isexist := Pljson_Ext.Get_Number(j_Json, 'output.isexist');
  End If;
  If Nvl(n_Isexist, 0) <> 1 Then
    Zl_病人医嘱记录_确认停止(n_医嘱id, d_操作时间, v_操作员, 0);
    Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
  Else
    v_Errtmp := '存在输液药品的医嘱且被输液配液中心锁定，请检查';
    Xml_Out  := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Errtmp || '</MSG></ERROR></OUTPUT>');
  End If;

Exception
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Advicestopaffirm;
/
CREATE OR REPLACE Procedure Zl_Third_Getpathway
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：病人临床路径表单,阶段信息/查询
  --入参：Xml_In
  --<IN>
  --     <PATIID>29</PATIID>     --病人ID
  --     <PAGEID>1</PAGEID>     --主页ID
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --  <LJID>43</LJID>     --病人临床路径.路径ID
  --  <YSLJID></YSLJID>   --病人路径评估.原路径id
  --  <BBH></BBH>         --病人临床路径.版本号
  --  <YSBBH></YSBBH>     --病人路径评估.原路径版本
  --  <LJMC>急性单纯性阑尾炎临床路径</LJMC>   --临床路径目录.名称
  --  <ZXZT>执行中</ZXZT>   --病人临床路径.状态
  --  <BZZYR>6</BZZYR>   --临床路径版本.标准住院日
  --  <DQTS>5</DQTS>   --病人临床路径.当前天数

  --  <PHASELIST>
  --   <PHASES>
  --    <PHASE>
  --      <JDID>1</JDID>   --病人路径执行.阶段ID
  --      <JD>住院第1天 (住院日,手术日)</JD>   --临床路径阶段.名称
  --      <DQJD>0</DQJD>   --病人临床路径.当前阶段ID
  --      <DAYS>
  --        <DAY>
  --          <TS>1</TS>                     --病人路径执行.天数
  --          <RQ>2011-09-16 00:00:00</RQ>   --病人路径执行.日期
  --          <PGJG>正常</PGJG>              --病人路径评估.评估结果
  --          <PGSM>嘀咕</PGSM>              --病人路径评估.评估说明
  --          <PGR>代翔</PGR>                --病人路径评估.评估人
  --          <PGSJ>2011-09-16 10:51:40</PGSJ>   --病人路径评估.评估时间
  --          <BYYY></BYYY>                      --病人路径评估.变异原因（变异常见原因.名称）
  --          <ITEMLIST>
  --             <ITEM>
  --                <FL>主要诊疗工作</FL>   --临床路径分类.名称
  --                <TBID />   --病人路径执行.图标ID
  --                <ZXID>3366</ZXID>   --病人路径执行.ID
  --                <XMID>1</XMID>   --病人路径执行.项目ID    
  --                <XMXH>1</XMXH>   --临床路径项目.项目序号（XMID为空时，取病人路径执行 .项目序号）   
  --                <XMNR>询问病史体格检查</XMNR>   --临床路径项目.项目内容（XMID为空时，取病人路径执行 .项目内容）
  --                <ZXFS>1</ZXFS>   --临床路径项目.执行方式
  --                <ZXJG>已经执行</ZXJG>   --病人路径执行.执行结果
  --                <TJYY />   --病人路径执行.添加原因
  --                <ZXBYYY />  变异原因
  --              </ITEM>
  --           </ITEMLIST>
  --        </DAY>
  --        <DAY/>...
  --     </DAYS>
  --    </PHASE>
  --    <PHASE/>...
  --  </PHASES>
  -- </PHASELIST>
  --</OUTPUT>

  n_病人id     病人医嘱记录.病人id%Type;
  n_主页id     病人医嘱记录.主页id%Type;
  n_路径id     临床路径阶段.路径id%Type;
  n_版本号     临床路径阶段.版本号%Type;
  n_当前阶段id 病人临床路径.当前阶段id%Type;
  n_路径记录id 病人临床路径.Id%Type;
  v_Xtmp       Clob; --临时XML
  x_Templet    Xmltype;
  x_Phase      Xmltype;
  x_Day        Xmltype;
  x_Item       Xmltype;
  v_评估信息   Varchar2(4000);
  v_Err_Msg    Varchar2(255);
  Err_Item Exception;

  Cursor c_Main Is
    Select a.Id, a.路径id, c.原路径id, a.版本号, c.原路径版本, e.名称 As 路径名称,
           Decode(a.状态, 0, '不符合导入条件', 1, '执行中', 2, '正常结束', 3, '变异结束', Null) As 状态, f.标准住院日, a.当前天数, a.当前阶段id
    From 病人临床路径 A, 病人路径评估 C, 临床路径目录 E, 临床路径版本 F
    Where a.病人id = n_病人id And a.主页id = n_主页id And a.路径id = e.Id And a.当前阶段id = c.阶段id(+) And a.Id = c.路径记录id(+) And
          a.当前天数 = c.天数(+) And a.路径id = f.路径id And a.版本号 = f.版本号;

  Cursor c_定义阶段 Is
    Select a.Id As 阶段id, a.名称 As 阶段名称
    From 临床路径阶段 A
    Where a.路径id = n_路径id And a.版本号 = n_版本号 And a.父id Is Null
    Order By a.序号;

  Type t_定义阶段 Is Table Of c_定义阶段%RowType;
  r_定义阶段 t_定义阶段;

  --已生成的阶段
  Cursor c_Phase Is
    Select a.阶段id, a.天数, To_Char(a.日期, 'yyyy-mm-dd') 日期, To_Char(a.日期, 'day') 星期, b.名称 As 阶段名, b.序号, b.说明, b.父id,
           Decode(g.路径id, b.路径id, 1, 0) As 排序
    From (Select a.阶段id, a.天数, a.日期, a.路径记录id
           From 病人路径执行 A
           Where a.路径记录id = n_路径记录id
           Group By a.阶段id, a.天数, a.日期, a.路径记录id) A, 临床路径阶段 B, 临床路径阶段 C, 病人临床路径 G
    Where a.阶段id = b.Id And b.父id = c.Id(+) And g.Id = a.路径记录id
    Order By 日期, 排序, Nvl(c.序号, b.序号);

  Type t_Phase Is Table Of c_Phase%RowType;
  r_Phase t_Phase;

  --明细项目
  Cursor c_Item Is
    Select a.Id, Nvl(b.图标id, a.图标id) As 图标id, a.分类, To_Char(a.日期, 'yyyy-mm-dd') As 日期, a.天数, a.阶段id,
           Nvl(a.项目序号, b.项目序号) As 项目序号, Nvl(b.项目内容, a.项目内容) 项目内容, a.项目id, Decode(a.执行人, Null, 0, 1) 执行状态,
           Nvl(b.执行方式, 1) 执行方式, a.添加原因, Nvl(a.生成时间性质, 0) As 生成时间性质, c.名称 As 变异原因, Nvl(b.项目结果, a.项目结果) As 项目结果, a.执行结果,
           d.路径id, d.分支id, Nvl(Nvl(a.生成者, b.生成者), 1) As 生成者, d.名称 As 阶段名
    From 病人路径执行 A, 临床路径项目 B, 变异常见原因 C, 临床路径阶段 D
    Where a.路径记录id = n_路径记录id And a.项目id = b.Id(+) And a.变异原因 = c.编码(+) And a.阶段id + 0 = d.Id
    Order By a.日期, 分类, 项目序号;

  Type t_Item Is Table Of c_Item%RowType;
  r_Item t_Item;

  --阶段评估
  Cursor c_Eval Is
    Select a.阶段id, a.天数, Decode(a.评估结果, 1, '正常', -1, '变异', Null) As 评估结果, a.评估说明, a.评估人, a.评估时间, c.名称 As 变异原因, a.变异审核人,
           Nvl(a.时间进度, 0) 时间进度, a.跳转审核人, a.原路径id
    From 病人路径评估 A, 病人路径变异 B, 变异常见原因 C
    Where a.路径记录id = b.路径记录id(+) And a.阶段id = b.阶段id(+) And a.日期 = b.日期(+) And a.路径记录id = n_路径记录id And b.变异原因 = c.编码(+);
  Type t_Eval Is Table Of c_Eval%RowType;
  r_Eval t_Eval;
Begin
  Select Extractvalue(Value(A), 'IN/PATIID') As 病人id, Extractvalue(Value(A), 'IN/PAGEID') As 主页id
  Into n_病人id, n_主页id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For R In c_Main Loop
    v_Xtmp := '<LJID>' || r.路径id || '</LJID>'; --病人临床路径.路径ID
    v_Xtmp := v_Xtmp || '<YSLJID>' || r.原路径id || '</YSLJID>'; --病人路径评估.原路径id
    v_Xtmp := v_Xtmp || '<BBH>' || r.版本号 || '</BBH>'; --病人临床路径.版本号
    v_Xtmp := v_Xtmp || '<YSBBH>' || r.原路径版本 || '</YSBBH>'; --病人路径评估.原路径版本
    v_Xtmp := v_Xtmp || '<LJMC>' || r.路径名称 || '</LJMC>'; --临床路径目录.名称
    v_Xtmp := v_Xtmp || '<ZXZT>' || r.状态 || '</ZXZT>'; --病人临床路径.状态
    v_Xtmp := v_Xtmp || '<BZZYR>' || r.标准住院日 || '</BZZYR>'; --临床路径版本.标准住院日
    v_Xtmp := v_Xtmp || '<DQTS>' || r.当前天数 || '</DQTS>'; --病人临床路径.当前天数;
  
    n_路径id     := r.路径id;
    n_版本号     := r.版本号;
    n_当前阶段id := r.当前阶段id;
    n_路径记录id := r.Id;
  End Loop;
  x_Templet := Xmltype('<OUTPUT>' || v_Xtmp || '<PHASELIST></PHASELIST></OUTPUT>');

  If n_路径记录id Is Null Then
    v_Err_Msg := '未找到路径信息！';
    Raise Err_Item;
  End If;

  Open c_定义阶段;
  Fetch c_定义阶段 Bulk Collect
    Into r_定义阶段;
  Close c_定义阶段;

  Open c_Phase;
  Fetch c_Phase Bulk Collect
    Into r_Phase;
  Close c_Phase;

  Open c_Item;
  Fetch c_Item Bulk Collect
    Into r_Item;
  Close c_Item;

  Open c_Eval;
  Fetch c_Eval Bulk Collect
    Into r_Eval;
  Close c_Eval;

  For I In 1 .. r_定义阶段.Count Loop
    v_Xtmp  := '<PHASE jsonArray="True" ><JDID>' || r_定义阶段(I).阶段id || '</JDID><JD>' || r_定义阶段(I).阶段名称 || '</JD><DQJD>' || n_当前阶段id ||
               '</DQJD><DAYS></DAYS></PHASE>';
    x_Phase := Xmltype(v_Xtmp);
  
    For J In 1 .. r_Phase.Count Loop
      If r_定义阶段(I).阶段id = r_Phase(J).阶段id Then
        --day 
        v_Xtmp     := '<DAY jsonArray="True" >';
        v_Xtmp     := v_Xtmp || '<TS>' || r_Phase(J).天数 || '</TS>'; --病人路径执行.天数
        v_Xtmp     := v_Xtmp || '<RQ>' || r_Phase(J).日期 || ' 00:00:00</RQ>'; --病人路径执行.日期      
        v_评估信息 := '<PGJG></PGJG><PGSM></PGSM><PGR></PGR><PGSJ></PGSJ><BYYY></BYYY>';
        For K In 1 .. r_Eval.Count Loop
          If r_Phase(J).阶段id = r_Eval(K).阶段id And r_Phase(J).天数 = r_Eval(K).天数 Then
            v_评估信息 := '<PGJG>' || r_Eval(K).评估结果 || '</PGJG>'; --病人路径评估.评估结果
            v_评估信息 := v_评估信息 || '<PGSM>' || r_Eval(K).评估说明 || '</PGSM>'; --病人路径评估.评估说明
            v_评估信息 := v_评估信息 || '<PGR>' || r_Eval(K).评估人 || '</PGR>'; --病人路径评估.评估人
            v_评估信息 := v_评估信息 || '<PGSJ>' || To_Char(r_Eval(K).评估时间, 'yyyy-mm-dd hh24:mi:ss') || '</PGSJ>'; --病人路径评估.评估时间
            v_评估信息 := v_评估信息 || '<BYYY>' || r_Eval(K).变异原因 || '</BYYY>'; --病人路径评估.变异原因（变异常见原因.名称）         
          End If;
        End Loop;
        v_Xtmp := v_Xtmp || v_评估信息;
        v_Xtmp := v_Xtmp || '</DAY>';
        x_Day  := Xmltype(v_Xtmp);
      
        --item
        x_Item := Xmltype('<ITEMLIST></ITEMLIST>');
        For K In 1 .. r_Item.Count Loop
          If r_Phase(J).阶段id = r_Item(K).阶段id And r_Phase(J).天数 = r_Item(K).天数 Then
            v_Xtmp := '<ITEM jsonArray="True" >';
            v_Xtmp := v_Xtmp || '<FL>' || r_Item(K).分类 || '</FL>'; --临床路径分类.名称
            v_Xtmp := v_Xtmp || '<TBID>' || r_Item(K).图标id || '</TBID>'; --病人路径执行.图标ID
            v_Xtmp := v_Xtmp || '<ZXID>' || r_Item(K).Id || '</ZXID>'; --病人路径执行.ID
            v_Xtmp := v_Xtmp || '<XMID>' || r_Item(K).项目id || '</XMID>'; --病人路径执行.项目ID    
            v_Xtmp := v_Xtmp || '<XMXH>' || r_Item(K).项目序号 || '</XMXH>'; --临床路径项目.项目序号（XMID为空时，取病人路径执行 .项目序号）   
            v_Xtmp := v_Xtmp || '<XMNR>' || r_Item(K).项目内容 || '</XMNR>'; --临床路径项目.项目内容（XMID为空时，取病人路径执行 .项目内容）
            v_Xtmp := v_Xtmp || '<ZXFS>' || r_Item(K).执行方式 || '</ZXFS>'; --临床路径项目.执行方式
            v_Xtmp := v_Xtmp || '<ZXJG>' || r_Item(K).执行结果 || '</ZXJG>'; --病人路径执行.执行结果
            v_Xtmp := v_Xtmp || '<TJYY>' || r_Item(K).添加原因 || '</TJYY>'; --病人路径执行.添加原因
            v_Xtmp := v_Xtmp || '<ZXBYYY>' || r_Item(K).变异原因 || '</ZXBYYY>'; --变异原因
            v_Xtmp := v_Xtmp || '</ITEM>';
            Select Appendchildxml(x_Item, '/ITEMLIST', Xmltype(v_Xtmp)) Into x_Item From Dual;
          End If;
        End Loop;
        Select Appendchildxml(x_Day, '/DAY', x_Item) Into x_Day From Dual;
        Select Appendchildxml(x_Phase, '/PHASE/DAYS', x_Day) Into x_Phase From Dual;
      End If;
    End Loop;
    Select Appendchildxml(x_Templet, '/OUTPUT/PHASELIST', x_Phase) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpathway;
/
CREATE OR REPLACE Procedure Zl_Third_Getpathwaydetail
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：临床路径中某个项目具体的执行明细及医嘱信息/查询
  --入参：Xml_In
  --<IN>
  --     <ZXID>29</ZXID>     --病人路径执行.ID
  --</IN>
  --出参：Xml_Out
  --<OUTPUT>
  -- <LJEXEC>
  --  <ZXQK>
  --   <ZXZ />   --病人路径执行.执行者
  --   <ZXR>代翔</ZXR>   --病人路径执行.执行人
  --   <ZXSJ>2011-10-24 17:28:53</ZXSJ>   --病人路径执行.执行时间
  --   <ZXJG>已经执行</ZXJG>   --病人路径执行.执行结果
  --   <ZXSM />   --病人路径执行..执行说明
  --  </ZXQK>
  --  <YZLIST>
  --   <YZXX>
  --    <YZQX>0</YZQX>   --病人医嘱记录.医嘱期效
  --    <YZNR>注射用克林霉素 0.6g/支 苏州第壹制药有限公司</YZNR>   --病人医嘱记录.医嘱内容
  --    <DL>每次1.2g</DL>   -病人医嘱记录.单次用量
  --    <ZL />   --病人医嘱记录.总给予量
  --    <GYTJ>静脉滴注（门诊）</GYTJ>   --诊疗项目目录.名称
  --    <ZXPL>每天二次</ZXPL>   --病人医嘱记录.执行频次
  --    <ZXSJ>10-16</ZXSJ>   -病人医嘱记录.执行时间方案
  --    <YSZT />   --病人医嘱记录..医生嘱托
  --   </YZXX>
  --  </YZLIST>
  -- </LJEXEC>
  --</OUTPUT>

  n_执行id  病人路径执行.Id%Type;
  v_Xtmp    Clob; --临时XML
  x_Templet Xmltype;
Begin
  Select Extractvalue(Value(A), 'IN/ZXID') Into n_执行id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For R In (Select a.执行者, a.执行人, a.执行时间, a.执行结果, a.执行说明 From 病人路径执行 A Where a.Id = n_执行id) Loop
    v_Xtmp := '<ZXQK>';
    v_Xtmp := v_Xtmp || '<ZXZ>' || r.执行者 || '</ZXZ>';
    v_Xtmp := v_Xtmp || '<ZXR>' || r.执行人 || '</ZXR>';
    v_Xtmp := v_Xtmp || '<ZXSJ>' || To_Char(r.执行时间, 'yyyy-mm-dd hh24:mi:ss') || '</ZXSJ>';
    v_Xtmp := v_Xtmp || '<ZXJG>' || r.执行结果 || '</ZXJG>';
    v_Xtmp := v_Xtmp || '<ZXSM>' || r.执行说明 || '</ZXSM>';
    v_Xtmp := v_Xtmp || '</ZXQK>';
  End Loop;

  x_Templet := Xmltype('<OUTPUT><LJEXEC>' || v_Xtmp || '</LJEXEC><YZLIST></YZLIST></OUTPUT>');

  --(西/成药，返回药品行，其它医嘱返回主医嘱行)
  For R In (Select a.医嘱期效, a.医嘱内容, a.单量, a.总量, a.结药途径, a.执行频次, a.时间方案, a.医生嘱托
            From (Select a.Id, a.相关id, a.诊疗类别, d.诊疗类别 As 主类别, a.医嘱期效, a.医嘱内容, a.单次用量 As 单量, a.总给予量 As 总量, e.名称 As 结药途径,
                          a.执行频次, a.执行时间方案 As 时间方案, a.医生嘱托, c.操作类型
                   From 病人医嘱记录 A, 病人路径医嘱 B, 诊疗项目目录 C, 病人医嘱记录 D, 诊疗项目目录 E
                   Where b.路径执行id = n_执行id And a.Id = b.病人医嘱id And a.诊疗项目id = c.Id(+) And a.相关id = d.Id(+) And
                         d.诊疗项目id = e.Id(+)) A
            Where a.相关id Is Null And Not (a.诊疗类别 = 'E' And a.操作类型 = '2')) Loop
    v_Xtmp := '<YZXX jsonArray="True" >';
    v_Xtmp := v_Xtmp || '<YZQX>' || r.医嘱期效 || '</YZQX>';
    v_Xtmp := v_Xtmp || '<YZNR>' || r.医嘱内容 || '</YZNR>';
    v_Xtmp := v_Xtmp || '<DL>' || r.单量 || '</DL>';
    v_Xtmp := v_Xtmp || '<ZL>' || r.总量 || '</ZL>';
    v_Xtmp := v_Xtmp || '<GYTJ>' || r.结药途径 || '</GYTJ>';
    v_Xtmp := v_Xtmp || '<ZXPL>' || r.执行频次 || '</ZXPL>';
    v_Xtmp := v_Xtmp || '<ZXSJ>' || r.时间方案 || '</ZXSJ>';
    v_Xtmp := v_Xtmp || '<YSZT>' || r.医生嘱托 || '</YSZT>';
    v_Xtmp := v_Xtmp || '</YZXX>';
    Select Appendchildxml(x_Templet, '/OUTPUT/YZLIST', Xmltype(v_Xtmp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpathwaydetail;
/
Create Or Replace Procedure Zl_Third_Getdiagnosis
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取病人诊断信息/查询
  --入参：Xml_In
  --<IN>
  --     <PATIID></PATIID>     --病人ID
  --     <PAGEID></PAGEID>     --就诊ID 住院传主页ID,门诊传挂号ID
  --     <ZDLX></ZDLX>         --诊断类型字符串(逗号分割) 例：'1,2,3'  为空返回所有诊断类型   诊断类型：1-西医门诊诊断;2-西医入院诊断;3-西医出院诊断;5-院内感染;6-病理诊断;7-损伤中毒码,8-术前诊断;9-术后诊断;
  --                                                                                          10-并发症;11-中医门诊诊断;12-中医入院诊断;13-中医出院诊断;21-病原学诊断;22-影像学诊断
  --</IN>
  --出参：Xml_Out
  --<OUTPUT>
  --  <ZDLIST>
  --    <ZD>
  --      <ZDLX></ZDLX> --诊断类型。类型的名称，门诊诊断、入院诊断、出院诊断等
  --      <ZDCX></ZDCX> --诊断次序
  --      <ZDBM></ZDBM> --诊断编码
  --      <ZDMC></ZDMC> --诊断名称

  --      <JLID></JLID> --记录ID
  --      <BMXH></BMXH> --编码序号
  --      <JBID></JBID> --疾病ID
  --      <ZDID></ZDID> --诊断ID
  --      <ZHID></ZHID> --证候ID
  --      <ZDMS></ZDMS> --诊断描述
  --      <RYBQ></RYBQ> --入院病情
  --      <CYQK></CYQK> --出院情况
  --      <SFWZ></SFWZ> --是否未治
  --      <SFYZ></SFYZ> --是否疑诊
  --      <FBSJ></FBSJ> --发病时间
  --      <QZS></QZS>   --前注释
  --      <HZS></HZS>   --后注释
  --      <LRCX></LRCX> --录入次序

  --    </ZD>
  --  </ZDLIST>
  --</OUTPUT>

  n_病人id   病人医嘱记录.病人id%Type;
  n_主页id   病人医嘱记录.主页id%Type;
  v_Xtmp     Varchar(5000); --临时XML
  v_Tmp      Varchar2(800);
  v_诊断编码 Varchar2(1000);
  v_诊断名称 Varchar2(1000);
  v_诊断类型 Varchar2(1000);

  x_Templet Xmltype;
Begin
  Select Extractvalue(Value(A), 'IN/PATIID'), Extractvalue(Value(A), 'IN/PAGEID'), Extractvalue(Value(A), 'IN/ZDLX')
  Into n_病人id, n_主页id, v_诊断类型
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT><ZDLIST></ZDLIST></OUTPUT>');

  For R In (Select Decode(a.诊断类型, 1, '西医门诊诊断', 2, '西医入院诊断', 3, '西医出院诊断', 5, '院内感染', 6, '病理诊断', 7, '损伤中毒码', 8, '术前诊断', 9,
                           '术后诊断', 10, '并发症', 11, '中医门诊诊断', 12, '中医入院诊断', 13, '中医出院诊断', 21, '病原学诊断', 22, '影像学诊断') As 诊断类型,
                   a.诊断次序, a.Id, a.编码序号, a.疾病id, a.诊断id, a.证候id, a.诊断描述, a.入院病情, a.出院情况, a.是否未治, a.是否疑诊,
                   To_Char(a.发病时间, 'yyyy-mm-dd hh24:mi:ss') As 发病时间, a.前注释, a.后注释, a.录入次序, Nvl(b.编码, c.编码) As 诊断编码,
                   Nvl(b.名称, c.名称) As 诊断名称
            From 病人诊断记录 A, 疾病诊断目录 B, 疾病编码目录 C
            Where a.病人id = n_病人id And a.主页id = n_主页id And a.诊断id = b.Id(+) And a.疾病id = c.Id(+) And
                  Nvl(a.录入次序, '01') = '01' And (v_诊断类型 Is Null Or Instr(',' || v_诊断类型 || ',', ',' || a.诊断类型 || ',') > 0)
            Order By a.诊断类型, a.诊断次序) Loop
  
    v_诊断编码 := Null;
  
    v_诊断名称 := r.诊断描述;
    v_Tmp      := r.诊断描述;
    If Substr(v_Tmp, 1, 1) = '(' Then
      v_诊断编码 := Substr(v_Tmp, 2, Instr(v_Tmp, ')') - 2);
      v_诊断名称 := Substr(v_Tmp, Instr(v_Tmp, ')') + 1);
    End If;
  
    v_Xtmp := '<ZD jsonArray="True" >';
    v_Xtmp := v_Xtmp || '<ZDLX>' || r.诊断类型 || '</ZDLX>';
    v_Xtmp := v_Xtmp || '<ZDCX>' || r.诊断次序 || '</ZDCX>';
    If Nvl(r.编码序号, 1) > 1 Then
      v_Xtmp := v_Xtmp || '<ZDBM>' || r.诊断编码 || '</ZDBM>';
      v_Xtmp := v_Xtmp || '<ZDMC>' || r.诊断名称 || '</ZDMC>';
    Else
      v_Xtmp := v_Xtmp || '<ZDBM>' || v_诊断编码 || '</ZDBM>';
      v_Xtmp := v_Xtmp || '<ZDMC>' || v_诊断名称 || '</ZDMC>';
    End If;
  
    v_Xtmp := v_Xtmp || '<JLID>' || r.Id || '</JLID>';
    v_Xtmp := v_Xtmp || '<BMXH>' || r.编码序号 || '</BMXH>';
    v_Xtmp := v_Xtmp || '<JBID>' || r.疾病id || '</JBID>';
    v_Xtmp := v_Xtmp || '<ZDID>' || r.诊断id || '</ZDID>';
    v_Xtmp := v_Xtmp || '<ZHID>' || r.证候id || '</ZHID>';
    v_Xtmp := v_Xtmp || '<ZDMS>' || r.诊断描述 || '</ZDMS>';
    v_Xtmp := v_Xtmp || '<RYBQ>' || r.入院病情 || '</RYBQ>';
    v_Xtmp := v_Xtmp || '<CYQK>' || r.出院情况 || '</CYQK>';
    v_Xtmp := v_Xtmp || '<SFWZ>' || r.是否未治 || '</SFWZ>';
    v_Xtmp := v_Xtmp || '<SFYZ>' || r.是否疑诊 || '</SFYZ>';
    v_Xtmp := v_Xtmp || '<FBSJ>' || r.发病时间 || '</FBSJ>';
    v_Xtmp := v_Xtmp || '<QZS>' || r.前注释 || '</QZS>';
    v_Xtmp := v_Xtmp || '<HZS>' || r.后注释 || '</HZS>';
    v_Xtmp := v_Xtmp || '<LRCX>' || r.录入次序 || '</LRCX>';
  
    v_Xtmp := v_Xtmp || '</ZD>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT/ZDLIST', Xmltype(v_Xtmp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getdiagnosis;
/


CREATE OR REPLACE Procedure Zl_Third_Getallergy
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取病人过敏记录/查询
  --入参：Xml_In
  --<IN>
  --     <PATIID></PATIID>         --病人ID
  --     <PAGEID></PAGEID>     --主页ID
  --</IN>
  --出参：Xml_Out
  --<OUTPUT>
  --  <GMLIST>
  --    <GM>
  --      <GMYW></GMYW> --过敏药物
  --      <GMSJ></GMSJ> --过敏时间
  --      <JLSJ></JLSJ> --记录时间
  --      <JLR></JLR> --记录人
  --    </GM>
  --  </GMLIST>
  --</OUTPUT>
  n_病人id  病人医嘱记录.病人id%Type;
  n_主页id  病人医嘱记录.主页id%Type;
  v_Xtmp    Varchar(5000); --临时XML
  x_Templet Xmltype;
Begin
  Select Extractvalue(Value(A), 'IN/PATIID'), Extractvalue(Value(A), 'IN/PAGEID')
  Into n_病人id, n_主页id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT><GMLIST></GMLIST></OUTPUT>');
  For R In (Select a.药物名, a.过敏时间, a.记录时间, a.记录人
            From 病人过敏记录 A
            Where a.病人id = n_病人id And a.主页id = n_主页id
            Order By a.记录时间) Loop
    v_Xtmp := '<GM jsonArray="True" >';
    v_Xtmp := v_Xtmp || '<GMYW>' || r.药物名 || '</GMYW>'; --过敏药物
    v_Xtmp := v_Xtmp || '<GMSJ>' || To_Char(r.过敏时间, 'yyyy-mm-dd hh24:mi:ss') || '</GMSJ>'; --过敏时间
    v_Xtmp := v_Xtmp || '<JLSJ>' || To_Char(r.记录时间, 'yyyy-mm-dd hh24:mi:ss') || '</JLSJ>'; --记录时间
    v_Xtmp := v_Xtmp || '<JLR>' || r.记录人 || '</JLR>'; --记录人
    v_Xtmp := v_Xtmp || '</GM>';

    Select Appendchildxml(x_Templet, '/OUTPUT/GMLIST', Xmltype(v_Xtmp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getallergy;
/
Create Or Replace Procedure Zl_Third_Getpatichange
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取病人变动记录/查询
  --入参：Xml_In
  --<IN>
  --     <PATIID></PATIID>         --病人ID
  --     <PAGEID></PAGEID>     --主页ID
  --</IN>
  --出参：Xml_Out
  --<OUTPUT>
  --  <BDLIST>--变动数据
  --    <ITEM>
  --      <SJ></SJ>--变动时间
  --      <LSXLIST>--变动类型列表
  --         <ITEM>
  --           <MC></MC>--变动类型名称（调整护理等级/调整住院医师/调整护士/留观转住院/调整主任医师/调整病况/调整医疗小组/调整病区/入院/入住/换床/调整床位等级/预出院/调整主治医师）
  --           <XXLIST>--变动信息列表
  --              <ITEM>
  --                <XXM></XXM>  ----信息名称（医疗小组/病区/科室/床号/床位等级/护理等级/护士/住院医师/主治医生/主任医生/当前病况/包床情况）         
  --                <YXX></YXX>  ----原信息值        
  --                <XXX></XXX>  ----现信息值             
  --              </ITEM> 
  --              ...
  --           </XXLIST>
  --         </ITEM>
  --         ...
  --      </LSXLIST>  
  --    </ITEM>
  --    ... 
  --  </BDLIST>
  --</OUTPUT>

  n_病人id 病人医嘱记录.病人id%Type;
  n_主页id 病人医嘱记录.主页id%Type;

  v_Tmp  Varchar(5000);
  v_Tmp1 Varchar(5000);

  v_Pre时间  Varchar(500);
  v_Cur时间  Varchar(500);
  v_变动名称 Varchar(500);

  n_Preidx Number;
  n_Curidx Number;

  v_Value    Varchar(500);
  x_Templet  Xmltype;
  x_变动时间 Xmltype;
  x_变动类型 Xmltype;

  Cursor c_Pati Is
    Select a.Id, f.名称 As 医疗小组名, b.名称 As 病区, c.名称 As 科室, a.附加床位, Decode(a.附加床位, 0, '主床', '包床') As 床位性质, a.床号,
           d.名称 As 床位等级, e.名称 As 护理等级, a.责任护士 As 护士, a.经治医师 As 住院医师, a.主治医师 As 主治医生, a.主任医师 As 主任医生, a.病情 As 当前病况,
           a.操作员姓名 As 开始操作员,
           Decode(a.开始原因, 1, '入院', 2, '入住', 3, '转科', 4, '换床', 5, '调整床位等级', 6, '调整护理等级', 7, '调整住院医师', 8, '调整护士', 9,
                   '留观转住院', 10, '预出院', 11, '调整主治医师', 12, '调整主任医师', 13, '调整病况', 14, '调整医疗小组', 15, '调整病区') As 开始原因,
           To_Char(a.开始时间, 'YYYY-MM-DD HH24:MI:SS') As 开始时间, a.终止人员 As 终止操作员,
           Decode(a.终止原因, 1, '出院', 2, '入住', 3, '转科', 4, '换床', 5, '调整床位等级', 6, '调整护理等级', 7, '调整住院医师', 8, '调整护士', 9,
                   '留观转住院', 10, '预出院', 11, '调整主治医师', 12, '调整主任医师', 13, '调整病况', 14, '调整医疗小组', 15, '调整病区') As 终止原因,
           To_Char(a.终止时间, 'YYYY-MM-DD HH24:MI:SS') As 终止时间
    From 病人变动记录 A, 部门表 B, 部门表 C, 收费项目目录 D, 收费项目目录 E, 临床医疗小组 F
    Where a.病区id = b.Id And a.科室id = c.Id And a.床位等级id = d.Id(+) And a.护理等级id = e.Id(+) And a.病人id = n_病人id And
          a.主页id = n_主页id And a.开始时间 Is Not Null And a.医疗小组id = f.Id(+)
    Order By a.终止时间, a.开始时间, a.附加床位, a.床号;

  Type t_Pati Is Table Of c_Pati%RowType;
  r_Pati t_Pati;
  r_Seek t_Pati;

Begin
  Select Extractvalue(Value(A), 'IN/PATIID') As 病人id, Extractvalue(Value(A), 'IN/PAGEID') As 主页id
  Into n_病人id, n_主页id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  Open c_Pati;
  Fetch c_Pati Bulk Collect
    Into r_Pati;
  Close c_Pati;
  r_Seek := r_Pati;

  v_Pre时间 := '0';
  n_Preidx  := 0;
  n_Curidx  := 0;

  x_Templet := Xmltype('<OUTPUT><BDLIST></BDLIST></OUTPUT>');

  For I In 1 .. r_Pati.Count Loop
    --以时间点为一次变动
    If v_Pre时间 <> r_Pati(I).开始时间 And r_Pati(I).附加床位 = 0 Then
      v_Cur时间 := r_Pati(I).开始时间;
      --这中间查出变动情况
      x_变动时间 := Xmltype('<ITEM jsonArray="True" ><SJ>' || v_Cur时间 || '</SJ><LSXLIST></LSXLIST></ITEM>');
    
      v_变动名称 := '0';
      For J In 1 .. r_Seek.Count Loop
        If r_Seek(J).开始时间 = v_Cur时间 And r_Seek(J).附加床位 = 0 Then
          If v_变动名称 <> r_Seek(J).开始原因 Then
            v_变动名称 := r_Seek(J).开始原因;
            n_Curidx   := J;
            x_变动类型 := Xmltype('<ITEM jsonArray="True" ><MC>' || v_变动名称 || '</MC><XXLIST></XXLIST></ITEM>');
          
            --医疗小组名
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).医疗小组名, 'XXX') <> Nvl(r_Seek(n_Curidx).医疗小组名, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>医疗小组名</XXM><YXX>' || r_Seek(n_Preidx).医疗小组名 || '</YXX><XXX>' || r_Seek(n_Curidx)
                          .医疗小组名 || '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).医疗小组名 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>医疗小组名</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).医疗小组名 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            --病区
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).病区, 'XXX') <> Nvl(r_Seek(n_Curidx).病区, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>病区</XXM><YXX>' || r_Seek(n_Preidx).病区 || '</YXX><XXX>' || r_Seek(n_Curidx).病区 ||
                           '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).病区 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>病区</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).病区 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            --科室
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).科室, 'XXX') <> Nvl(r_Seek(n_Curidx).科室, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>科室</XXM><YXX>' || r_Seek(n_Preidx).科室 || '</YXX><XXX>' || r_Seek(n_Curidx).科室 ||
                           '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).科室 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>科室</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).科室 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            --床号
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).床号, 'XXX') <> Nvl(r_Seek(n_Curidx).床号, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>床号</XXM><YXX>' || r_Seek(n_Preidx).床号 || '</YXX><XXX>' || r_Seek(n_Curidx).床号 ||
                           '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).床号 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>床号</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).床号 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            --床位等级
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).床位等级, 'XXX') <> Nvl(r_Seek(n_Curidx).床位等级, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>床位等级</XXM><YXX>' || r_Seek(n_Preidx).床位等级 || '</YXX><XXX>' || r_Seek(n_Curidx).床位等级 ||
                           '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).床位等级 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>床位等级</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).床位等级 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            --护理等级
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).护理等级, 'XXX') <> Nvl(r_Seek(n_Curidx).护理等级, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>护理等级</XXM><YXX>' || r_Seek(n_Preidx).护理等级 || '</YXX><XXX>' || r_Seek(n_Curidx).护理等级 ||
                           '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).护理等级 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>护理等级</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).护理等级 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            --护士
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).护士, 'XXX') <> Nvl(r_Seek(n_Curidx).护士, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>护士</XXM><YXX>' || r_Seek(n_Preidx).护士 || '</YXX><XXX>' || r_Seek(n_Curidx).护士 ||
                           '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).护士 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>护士</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).护士 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            --住院医师
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).住院医师, 'XXX') <> Nvl(r_Seek(n_Curidx).住院医师, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>住院医师</XXM><YXX>' || r_Seek(n_Preidx).住院医师 || '</YXX><XXX>' || r_Seek(n_Curidx).住院医师 ||
                           '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).住院医师 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>住院医师</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).住院医师 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            --主治医生
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).主治医生, 'XXX') <> Nvl(r_Seek(n_Curidx).主治医生, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>主治医生</XXM><YXX>' || r_Seek(n_Preidx).主治医生 || '</YXX><XXX>' || r_Seek(n_Curidx).主治医生 ||
                           '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).主治医生 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>主治医生</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).主治医生 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            --主任医生
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).主任医生, 'XXX') <> Nvl(r_Seek(n_Curidx).主任医生, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>主任医生</XXM><YXX>' || r_Seek(n_Preidx).主任医生 || '</YXX><XXX>' || r_Seek(n_Curidx).主任医生 ||
                           '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).主任医生 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>主任医生</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).主任医生 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            --当前病况
            v_Value := Null;
            If n_Preidx <> 0 Then
              If Nvl(r_Seek(n_Preidx).当前病况, 'XXX') <> Nvl(r_Seek(n_Curidx).当前病况, 'XXX') Then
                v_Value := '<ITEM jsonArray="True" ><XXM>当前病况</XXM><YXX>' || r_Seek(n_Preidx).当前病况 || '</YXX><XXX>' || r_Seek(n_Curidx).当前病况 ||
                           '</XXX></ITEM>';
              End If;
            Else
              If r_Seek(n_Curidx).当前病况 Is Not Null Then
                v_Value := '<ITEM jsonArray="True" ><XXM>当前病况</XXM><YXX></YXX><XXX>' || r_Seek(n_Curidx).当前病况 || '</XXX></ITEM>';
              End If;
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            ----包床情况  用床号拼串即可（简单处理）
            v_Value := Null;
            v_Tmp   := Null;
            v_Tmp1  := Null;
            If n_Preidx <> 0 Then
              --检查之前的变动是否是包了床,用床号拼串即可（简单处理）
              For K In 1 .. r_Seek.Count Loop
                If v_变动名称 = r_Seek(K).终止原因 And v_Cur时间 = r_Seek(K).终止时间 And r_Seek(K).附加床位 = 1 Then
                  If v_Tmp Is Null Then
                    v_Tmp := r_Seek(K).床号;
                  Else
                    v_Tmp := v_Tmp || ',' || r_Seek(K).床号;
                  End If;
                End If;
              End Loop;
            End If;
            --检查当前的变动是否是包了床,用床号拼串即可（简单处理）
            For K In 1 .. r_Seek.Count Loop
              If v_变动名称 = r_Seek(K).开始原因 And v_Cur时间 = r_Seek(K).开始时间 And r_Seek(K).附加床位 = 1 Then
                If v_Tmp1 Is Null Then
                  v_Tmp1 := r_Seek(K).床号;
                Else
                  v_Tmp1 := v_Tmp1 || ',' || r_Seek(K).床号;
                End If;
              End If;
            End Loop;
            If Nvl(v_Tmp, 'XXX') <> Nvl(v_Tmp1, 'XXX') Then
              v_Value := '<ITEM jsonArray="True" ><XXM>包床情况</XXM><YXX>' || v_Tmp || '</YXX><XXX>' || v_Tmp1 || '</XXX></ITEM>';
            End If;
            If v_Value Is Not Null Then
              Select Appendchildxml(x_变动类型, '/ITEM/XXLIST', Xmltype(v_Value)) Into x_变动类型 From Dual;
            End If;
          
            Select Appendchildxml(x_变动时间, '/ITEM/LSXLIST', x_变动类型) Into x_变动时间 From Dual;
          End If;
        End If;
      End Loop;
    
      v_Pre时间 := v_Cur时间;
      n_Preidx  := I;
    
      Select Appendchildxml(x_Templet, '/OUTPUT/BDLIST', x_变动时间) Into x_Templet From Dual;
    End If;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpatichange;
/
CREATE OR REPLACE Procedure Zl_Third_Getoperation
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取病人手术信息/查询
  --用于获取指定病人的手术信息
  --当监听到病人发送手术医嘱时调用
  --当监听到病人完成手术时调用
  --需要手动同步时调用
  --获取所有病人信息后调用
  --入参：Xml_In
  --<IN>
  --  <PATIID></PATIID>     --病人ID
  --  <PAGEID></PAGEID>     --主页ID
  --</IN>

  --出参：Xml_Out 
  --<OUTPUT>
  --  <SSLIST>
  --    <SS>
  --      <SSMC></SSMC>  //手术名称
  --      <SSSJ></SSSJ>  //手术时间,yyyy-mm-dd hh24:mi
  --      <MZFS></MZFS>  //麻醉方式
  --      <SSQK></SSQK>  //手术情况  择期、急诊、限期
  --      <ZXKSID></ZXKSID>   //执行科室ID
  --      <ZXKSMC></ZXKSMC>    //执行科室名称
  --      <FJSS></FJSS>     //附加手术   1-是，0-否
  --    <SS>
  --  <SSLIST>
  --</OUTPUT>

  n_病人id   病人医嘱记录.病人id%Type;
  n_主页id   病人医嘱记录.主页id%Type;
  n_主医嘱id 病人医嘱记录.Id%Type;
  v_麻醉     诊疗项目目录.名称%Type;
  v_Xtmp     Clob; --临时XML 

  Cursor c_医嘱 Is
    Select b.名称, a.标本部位 As 手术时间, Nvl(a.相关id, a.Id) As 主医嘱id, a.执行科室id, c.名称 As 执行科室名称,
           Decode(a.相关id, Null, 0, 1) As 附加手术, a.诊疗类别, Decode(a.手术情况, Null, '择期', 1, '急诊', 2, '限期', Null) As 手术情况
    From 病人医嘱记录 A, 诊疗项目目录 B, 部门表 C
    Where a.诊疗项目id = b.Id And a.执行科室id = c.Id And a.诊疗类别 In ('F', 'G') And a.医嘱状态 <> 4 And Nvl(a.执行标记, 0) <> -1 And
          a.病人id = n_病人id And a.主页id = n_主页id
    Order By a.诊疗类别 Desc, a.序号;
Begin

  Select Extractvalue(Value(A), 'IN/PATIID') As 病人id, Extractvalue(Value(A), 'IN/PAGEID') As 主页id
  Into n_病人id, n_主页id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  n_主医嘱id := 0;

  For R In c_医嘱 Loop
    If n_主医嘱id <> r.主医嘱id Then
      n_主医嘱id := r.主医嘱id;
      If r.诊疗类别 = 'G' Then
        v_麻醉 := r.名称;
      End If;
    Else
      v_麻醉 := Null;
    End If;
  
    If r.诊疗类别 = 'F' Then
      v_Xtmp := v_Xtmp || '<SS jsonArray="True" >';
      v_Xtmp := v_Xtmp || '<SSMC>' || r.名称 || '</SSMC>'; --  //手术名称
      v_Xtmp := v_Xtmp || '<SSSJ>' || r.手术时间 || '</SSSJ>'; --  //手术时间,yyyy-mm-dd hh24:mi
      v_Xtmp := v_Xtmp || '<MZFS>' || v_麻醉 || '</MZFS>'; --  //麻醉方式
      v_Xtmp := v_Xtmp || '<SSQK>' || r.手术情况 || '</SSQK>'; --  //手术情况  择期、急诊、限期
      v_Xtmp := v_Xtmp || '<ZXKSID>' || r.执行科室id || '</ZXKSID>'; --   //执行科室ID
      v_Xtmp := v_Xtmp || '<ZXKSMC>' || r.执行科室名称 || '</ZXKSMC>'; --    //执行科室名称
      v_Xtmp := v_Xtmp || '<FJSS>' || r.附加手术 || '</FJSS>'; --    //附加手术   1-是，0-否    
      v_Xtmp := v_Xtmp || '</SS>';
    End If;
  End Loop;

  If v_Xtmp Is Not Null Then
    Xml_Out := Xmltype('<OUTPUT><SSLIST>' || v_Xtmp || '</SSLIST></OUTPUT>');
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getoperation;
/
CREATE OR REPLACE Procedure Zl_Third_Getallpatiinfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取病区所有病人基本信息/查询
  --用于获取某病区所有病人的基本信息。
  --在第一次获取病人信息时调用
  --每天晚上自动同步时调用
  --需要手动同步时调用

  --入参：Xml_In
  --<INPUT>
  --  <BQID></BQID>      --病区ID
  --  <CYTS></CYTS>      --出院天数，获取多少天之内出院的病人
  --</INPUT>

  --出参：Xml_Out 
  --<OUTPUT>
  --  <PATILIST>
  --    <PATI>
  --      <JBXX>    --基本信息
  --        <PATIID></PATIID>         --病人ID
  --        <PAGEID></PAGEID>  --主页ID
  --        <BABY></BABY>  --婴儿序号
  --        <XM></XM>   --姓名
  --        <XB></XB>   --性别
  --        <NL></NL>   --年龄
  --        <CSRQ></CSRQ>  --出生日期
  --        <ZYH></ZYH>  --住院号
  --        <HY></HY>   --婚姻
  --        <GJ></GJ>   --国籍
  --        <MZ></MZ>   --民族
  --        <XL></XL>   --学历
  --        <SF></SF>   --身份
  --        <ZY></ZY>   --职业
  --        <SFZH></SFZH>  --身份证号
  --        <FKFS></FKFS>  --付款方式
  --        <LXFS></LXFS>  --联系方式
  --        <LXRXM></LXRXM>  --联系人姓名
  --        <LXRDH></LXRDH>  --联系人电话
  --        <LXRDZ></LXRDZ>  --联系人地址
  --        <JTDH></JTDH>  --家庭电话
  --        <JTDZ></JTDZ>  --家庭地址
  --        <CSDD></CSDD>  --出生地点
  --        <GMS></GMS>  --过敏史
  --      </JBXX>
  --      <ZYXX>    --住院信息
  --        <RYRQ></RYRQ>  --入院日期
  --        <RKRQ></RKRQ>  --入科日期
  --        <CYRQ></CYRQ>  --出院日期
  --        <ZYTS></ZYTS>  --住院天数
  --        <RYFS></RYFS>  --入院方式
  --        <KSID></KSID>  --科室ID
  --        <KSMC></KSMC>  --科室名称
  --        <BQID></BQID>  --病区ID
  --        <BQMC></BQMC>  --病区名称
  --        <CH></CH>   --床号
  --        <BQ></BQ>   --病情
  --        <ZZYS></ZZYS>  --主治医师
  --        <ZRYS></ZRYS>  --主任医师
  --        <ZYYS></ZYYS>  --住院医师
  --        <ZRHS></ZRHS>  --责任护士
  --        <HLDJ></HLDJ>  --护理等级
  --        <YLZ></YLZ>    --医疗小组id
  --        <YBH></YBH>    --医保号
  --        <YBMC></YBMC>  --医保名称
  --      </ZYXX>
  --    </PATI>
  --  </PATILIST>
  --</OUTPUT>

  n_病区id 部门表.Id%Type;
  v_病区   部门表.名称%Type;
  n_天数   Number;
  v_Xtmp   Clob; --临时XML 
  x_Item   Xmltype;
  d_开始   Date;
  d_结束   Date;

  v_过敏信息 Varchar2(5000);
  v_主治医师 Varchar2(500);
  v_主任医师 Varchar2(500);
  x_Templet  Xmltype;

  Cursor c_在院 Is
    Select a.病人id, b.主页id, 0 As 婴儿序号, Nvl(b.姓名, a.姓名) As 姓名, Nvl(b.性别, a.性别) As 性别, Nvl(b.年龄, a.年龄) As 年龄, a.出生日期, b.住院号,
           a.婚姻状况 As 婚姻, a.国籍, a.民族, a.学历, a.身份, a.职业, a.身份证号, a.医疗付款方式 As 付款方式, a.手机号 As 联系方式, a.联系人姓名, a.联系人电话,
           a.联系人地址, a.家庭电话, a.家庭地址, a.出生地点, '待定单独查询' As 过敏史, Decode(b.入科时间, Null, b.入院日期, b.入科时间) As 入院日期,
           b.入科时间 As 入科日期, Null As 出院日期, (Trunc(Sysdate) - Trunc(Decode(b.入科时间, Null, b.入院日期, b.入科时间))) As 住院天数, b.入院方式,
           b.出院科室id As 科室id, c.名称 As 科室名称, r.病区id, v_病区 As 病区名称, b.出院病床 As 床号, b.当前病况 As 病情, '待定病案主页从表' As 主治医师,
           '待定病案主页从表' As 主任医师, b.住院医师, b.责任护士, e.名称 As 护理等级, b.医疗小组id, a.医保号, d.名称 As 医保名称

    From 病人信息 A, 病案主页 B, 部门表 C, 保险类别 D, 收费项目目录 E, 在院病人 R
    Where a.病人id = b.病人id And a.主页id = b.主页id And b.出院科室id = c.Id And b.险类 = d.序号(+) And Nvl(b.状态, 0) <> 1 And
          b.护理等级id = e.Id(+) And (r.病区id = n_病区id Or b.婴儿病区id = n_病区id) And a.病人id = r.病人id And a.当前病区id + 0 = r.病区id And
          Nvl(b.病案状态, 0) <> 5 And b.封存时间 Is Null
    Order By b.出院病床;

  Cursor c_出院 Is
    Select a.病人id, b.主页id, 0 As 婴儿序号, Nvl(b.姓名, a.姓名) As 姓名, Nvl(b.性别, a.性别) As 性别, Nvl(b.年龄, a.年龄) As 年龄, a.出生日期, b.住院号,
           a.婚姻状况 As 婚姻, a.国籍, a.民族, a.学历, a.身份, a.职业, a.身份证号, a.医疗付款方式 As 付款方式, a.手机号 As 联系方式, a.联系人姓名, a.联系人电话,
           a.联系人地址, a.家庭电话, a.家庭地址, a.出生地点, '待定单独查询' As 过敏史, Decode(b.入科时间, Null, b.入院日期, b.入科时间) As 入院日期,
           b.入科时间 As 入科日期, b.出院日期, (Trunc(b.出院日期) - Trunc(Decode(b.入科时间, Null, b.入院日期, b.入科时间))) As 住院天数, b.入院方式,
           b.出院科室id As 科室id, c.名称 As 科室名称, b.当前病区id As 病区id, v_病区 As 病区名称, b.出院病床 As 床号, b.当前病况 As 病情,
           '待定病案主页从表' As 主治医师, '待定病案主页从表' As 主任医师, b.住院医师, b.责任护士, e.名称 As 护理等级, b.医疗小组id, a.医保号, d.名称 As 医保名称
    From 病人信息 A, 病案主页 B, 部门表 C, 保险类别 D, 收费项目目录 E
    Where a.病人id = b.病人id And Nvl(b.主页id, 0) <> 0 And b.状态 = 0 And b.出院科室id = c.Id And b.险类 = d.序号(+) And
          b.护理等级id = e.Id(+) And b.当前病区id + 0 = n_病区id And Nvl(b.病案状态, 0) <> 5 And b.封存时间 Is Null And
          b.出院日期 Between d_开始 And d_结束
    Order By b.出院病床;

  --放到循环中执行的，可能有性能问题
  Procedure p_Getother
  (
    病人id_In    In 病人信息.病人id%Type,
    主页id_In    In 病案主页.主页id%Type,
    过敏信息_Out Out Varchar2,
    主治医师_Out Out Varchar2,
    主任医师_Out Out Varchar2
  ) Is
  Begin
  
    过敏信息_Out := Null;
    主治医师_Out := Null;
    主任医师_Out := Null;
 
    For R In (Select a.信息名, a.信息值
              From 病案主页从表 A
              Where a.病人id = 病人id_In And a.主页id = 主页id_In And a.信息名 In ('主治医师', '主任医师')) Loop
      If r.信息名 = '主治医师' Then
        主治医师_Out := r.信息值;
      Elsif r.信息名 = '主任医师' Then
        主任医师_Out := r.信息值;
      End If;
    End Loop;
  
    For R In (Select a.药物名
              From 病人过敏记录 A, 病人挂号记录 B, 病案主页 C
              Where a.病人id = b.病人id(+) And a.主页id = b.Id(+) And b.记录性质(+) = 1 And b.记录状态(+) = 1 And a.病人id = c.病人id(+) And
                    a.主页id = c.主页id(+) And a.结果 = 1 And 药物名 Is Not Null And a.病人id = 202 And Not Exists
               (Select 药物id
                     From 病人过敏记录
                     Where (Nvl(药物id, 0) = Nvl(a.药物id, 0) Or Nvl(药物名, 'Null') = Nvl(a.药物名, 'Null')) And Nvl(结果, 0) = 0 And
                           记录时间 > a.记录时间 And 病人id = 202)
              Group By a.药物名
              Order By a.药物名) Loop
      过敏信息_Out := 过敏信息_Out || ',' || r.药物名;
    End Loop;
    过敏信息_Out := Substr(过敏信息_Out, 2);
  End;

Begin
  Select Extractvalue(Value(A), 'IN/BQID') As 病区id, Extractvalue(Value(A), 'IN/CYTS') As 天数
  Into n_病区id, n_天数
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Sysdate Into d_结束 From Dual;

  d_开始 := Trunc(d_结束) - n_天数; --当天的 00:00:00  
  d_结束 := Trunc(d_结束) + 1 - 1 / 24 / 60; --当天的 23:59:59

  Select Max(a.名称) Into v_病区 From 部门表 A Where a.Id = n_病区id;

  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  x_Item    := Xmltype('<PATILIST></PATILIST>');

  For R In c_在院 Loop
    p_Getother(r.病人id, r.主页id, v_过敏信息, v_主治医师, v_主任医师);
    v_Xtmp := '<PATI jsonArray="True" >';
    v_Xtmp := v_Xtmp || '<JBXX>';
    v_Xtmp := v_Xtmp || '<PATIID>' || r.病人id || '</PATIID>';
    v_Xtmp := v_Xtmp || '<PAGEID>' || r.主页id || '</PAGEID>';
    v_Xtmp := v_Xtmp || '<BABY>' || r.婴儿序号 || '</BABY>';
    v_Xtmp := v_Xtmp || '<XM>' || r.姓名 || '</XM>';
    v_Xtmp := v_Xtmp || '<XB>' || r.性别 || '</XB>';
    v_Xtmp := v_Xtmp || '<NL>' || r.年龄 || '</NL>';
    v_Xtmp := v_Xtmp || '<CSRQ>' || To_Char(r.出生日期, 'yyyy-mm-dd hh24:mi:ss') || '</CSRQ>';
    v_Xtmp := v_Xtmp || '<ZYH>' || r.住院号 || '</ZYH>';
    v_Xtmp := v_Xtmp || '<HY>' || r.婚姻 || '</HY>';
    v_Xtmp := v_Xtmp || '<GJ>' || r.国籍 || '</GJ>';
    v_Xtmp := v_Xtmp || '<MZ>' || r.民族 || '</MZ>';
    v_Xtmp := v_Xtmp || '<XL>' || r.学历 || '</XL>';
    v_Xtmp := v_Xtmp || '<SF>' || r.身份 || '</SF>';
    v_Xtmp := v_Xtmp || '<ZY>' || r.职业 || '</ZY>';
    v_Xtmp := v_Xtmp || '<SFZH>' || r.身份证号 || '</SFZH>';
    v_Xtmp := v_Xtmp || '<FKFS>' || r.付款方式 || '</FKFS>';
    v_Xtmp := v_Xtmp || '<LXFS>' || r.联系方式 || '</LXFS>';
    v_Xtmp := v_Xtmp || '<LXRXM>' || r.联系人姓名 || '</LXRXM>';
    v_Xtmp := v_Xtmp || '<LXRDH>' || r.联系人电话 || '</LXRDH>';
    v_Xtmp := v_Xtmp || '<LXRDZ>' || r.联系人地址 || '</LXRDZ>';
    v_Xtmp := v_Xtmp || '<JTDH>' || r.家庭电话 || '</JTDH>';
    v_Xtmp := v_Xtmp || '<JTDZ>' || r.家庭地址 || '</JTDZ>';
    v_Xtmp := v_Xtmp || '<CSDD>' || r.出生地点 || '</CSDD>';
    v_Xtmp := v_Xtmp || '<GMS>' || v_过敏信息 || '</GMS>'; -- r.过敏史 
    v_Xtmp := v_Xtmp || '</JBXX>';
    v_Xtmp := v_Xtmp || '<ZYXX>';
    v_Xtmp := v_Xtmp || '<RYRQ>' || To_Char(r.入院日期, 'yyyy-mm-dd hh24:mi:ss') || '</RYRQ>';
    v_Xtmp := v_Xtmp || '<RKRQ>' || To_Char(r.入科日期, 'yyyy-mm-dd hh24:mi:ss') || '</RKRQ>';
    v_Xtmp := v_Xtmp || '<CYRQ>' || To_Char(r.出院日期, 'yyyy-mm-dd hh24:mi:ss') || '</CYRQ>';
    v_Xtmp := v_Xtmp || '<ZYTS>' || r.住院天数 || '</ZYTS>';
    v_Xtmp := v_Xtmp || '<RYFS>' || r.入院方式 || '</RYFS>';
    v_Xtmp := v_Xtmp || '<KSID>' || r.科室id || '</KSID>';
    v_Xtmp := v_Xtmp || '<KSMC>' || r.科室名称 || '</KSMC>';
    v_Xtmp := v_Xtmp || '<BQID>' || r.病区id || '</BQID>';
    v_Xtmp := v_Xtmp || '<BQMC>' || r.病区名称 || '</BQMC>';
    v_Xtmp := v_Xtmp || '<CH>' || r.床号 || '</CH>';
    v_Xtmp := v_Xtmp || '<BQ>' || r.病情 || '</BQ>';
    v_Xtmp := v_Xtmp || '<ZZYS>' || v_主治医师 || '</ZZYS>';
    v_Xtmp := v_Xtmp || '<ZRYS>' || v_主任医师 || '</ZRYS>';
    v_Xtmp := v_Xtmp || '<ZYYS>' || r.住院医师 || '</ZYYS>';
    v_Xtmp := v_Xtmp || '<ZRHS>' || r.责任护士 || '</ZRHS>';
    v_Xtmp := v_Xtmp || '<HLDJ>' || r.护理等级 || '</HLDJ>';
    v_Xtmp := v_Xtmp || '<YLZ>' || r.医疗小组id || '</YLZ>';
    v_Xtmp := v_Xtmp || '<YBH>' || r.医保号 || '</YBH>';
    v_Xtmp := v_Xtmp || '<YBMC>' || r.医保名称 || '</YBMC>';
    v_Xtmp := v_Xtmp || '</ZYXX>';
    v_Xtmp := v_Xtmp || '</PATI>';
    Select Appendchildxml(x_Item, '/PATILIST', Xmltype(v_Xtmp)) Into x_Item From Dual;
  End Loop;

  For R In c_出院 Loop
    p_Getother(r.病人id, r.主页id, v_过敏信息, v_主治医师, v_主任医师);
    v_Xtmp := '<PATI jsonArray="True" >';
    v_Xtmp := v_Xtmp || '<JBXX>';
    v_Xtmp := v_Xtmp || '<PATIID>' || r.病人id || '</PATIID>';
    v_Xtmp := v_Xtmp || '<PAGEID>' || r.主页id || '</PAGEID>';
    v_Xtmp := v_Xtmp || '<BABY>' || r.婴儿序号 || '</BABY>';
    v_Xtmp := v_Xtmp || '<XM>' || r.姓名 || '</XM>';
    v_Xtmp := v_Xtmp || '<XB>' || r.性别 || '</XB>';
    v_Xtmp := v_Xtmp || '<NL>' || r.年龄 || '</NL>';
    v_Xtmp := v_Xtmp || '<CSRQ>' || To_Char(r.出生日期, 'yyyy-mm-dd hh24:mi:ss') || '</CSRQ>';
    v_Xtmp := v_Xtmp || '<ZYH>' || r.住院号 || '</ZYH>';
    v_Xtmp := v_Xtmp || '<HY>' || r.婚姻 || '</HY>';
    v_Xtmp := v_Xtmp || '<GJ>' || r.国籍 || '</GJ>';
    v_Xtmp := v_Xtmp || '<MZ>' || r.民族 || '</MZ>';
    v_Xtmp := v_Xtmp || '<XL>' || r.学历 || '</XL>';
    v_Xtmp := v_Xtmp || '<SF>' || r.身份 || '</SF>';
    v_Xtmp := v_Xtmp || '<ZY>' || r.职业 || '</ZY>';
    v_Xtmp := v_Xtmp || '<SFZH>' || r.身份证号 || '</SFZH>';
    v_Xtmp := v_Xtmp || '<FKFS>' || r.付款方式 || '</FKFS>';
    v_Xtmp := v_Xtmp || '<LXFS>' || r.联系方式 || '</LXFS>';
    v_Xtmp := v_Xtmp || '<LXRXM>' || r.联系人姓名 || '</LXRXM>';
    v_Xtmp := v_Xtmp || '<LXRDH>' || r.联系人电话 || '</LXRDH>';
    v_Xtmp := v_Xtmp || '<LXRDZ>' || r.联系人地址 || '</LXRDZ>';
    v_Xtmp := v_Xtmp || '<JTDH>' || r.家庭电话 || '</JTDH>';
    v_Xtmp := v_Xtmp || '<JTDZ>' || r.家庭地址 || '</JTDZ>';
    v_Xtmp := v_Xtmp || '<CSDD>' || r.出生地点 || '</CSDD>';
    v_Xtmp := v_Xtmp || '<GMS>' || v_过敏信息 || '</GMS>'; -- r.过敏史 
    v_Xtmp := v_Xtmp || '</JBXX>';
    v_Xtmp := v_Xtmp || '<ZYXX>';
    v_Xtmp := v_Xtmp || '<RYRQ>' || To_Char(r.入院日期, 'yyyy-mm-dd hh24:mi:ss') || '</RYRQ>';
    v_Xtmp := v_Xtmp || '<RKRQ>' || To_Char(r.入科日期, 'yyyy-mm-dd hh24:mi:ss') || '</RKRQ>';
    v_Xtmp := v_Xtmp || '<CYRQ>' || To_Char(r.出院日期, 'yyyy-mm-dd hh24:mi:ss') || '</CYRQ>';
    v_Xtmp := v_Xtmp || '<ZYTS>' || r.住院天数 || '</ZYTS>';
    v_Xtmp := v_Xtmp || '<RYFS>' || r.入院方式 || '</RYFS>';
    v_Xtmp := v_Xtmp || '<KSID>' || r.科室id || '</KSID>';
    v_Xtmp := v_Xtmp || '<KSMC>' || r.科室名称 || '</KSMC>';
    v_Xtmp := v_Xtmp || '<BQID>' || r.病区id || '</BQID>';
    v_Xtmp := v_Xtmp || '<BQMC>' || r.病区名称 || '</BQMC>';
    v_Xtmp := v_Xtmp || '<CH>' || r.床号 || '</CH>';
    v_Xtmp := v_Xtmp || '<BQ>' || r.病情 || '</BQ>';
    v_Xtmp := v_Xtmp || '<ZZYS>' || v_主治医师 || '</ZZYS>';
    v_Xtmp := v_Xtmp || '<ZRYS>' || v_主任医师 || '</ZRYS>';
    v_Xtmp := v_Xtmp || '<ZYYS>' || r.住院医师 || '</ZYYS>';
    v_Xtmp := v_Xtmp || '<ZRHS>' || r.责任护士 || '</ZRHS>';
    v_Xtmp := v_Xtmp || '<HLDJ>' || r.护理等级 || '</HLDJ>';
    v_Xtmp := v_Xtmp || '<YLZ>' || r.医疗小组id || '</YLZ>';
    v_Xtmp := v_Xtmp || '<YBH>' || r.医保号 || '</YBH>';
    v_Xtmp := v_Xtmp || '<YBMC>' || r.医保名称 || '</YBMC>';
    v_Xtmp := v_Xtmp || '</ZYXX>';
    v_Xtmp := v_Xtmp || '</PATI>';
    Select Appendchildxml(x_Item, '/PATILIST', Xmltype(v_Xtmp)) Into x_Item From Dual;
  End Loop;

  Select Appendchildxml(x_Templet, '/OUTPUT', x_Item) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getallpatiinfo;
/
Create Or Replace Procedure Zl_Third_Getkfcws
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is

  --功能：开放床位数/查询
  --开放床位数：每日夜晚12点开放病床数总和，不论该床是否被病人占用,都应计算在内。包括消毒和小修理等暂停使用的病床，
  --             以及超过半年的加床。不包括因病房扩建或大修而停用的病床及临时增设病床

  --平均开放床位数：每月平均开放床位数=当月每日开放床位数之和/当月天数
  --基于ZLHIS系统数据结构的理解：床位增减记录，中增加的床位记录
  --入参：xml_in
  --<IN>
  --    <BQID></BQID>    //病区ID，传空取所有病区
  --    <KSRQ></KSRQ>  //开始日期   yyyy-mm-dd
  --    <JSRQ></JSRQ>   //结束日期  yyyy-mm-dd
  --</IN>

  --出参：xml_out
  --<OUTPUT>
  --  <BQLIST>
  --    <ITEM>
  --      <BQID></BQID>  //病区ID
  --      <BQMC></BQMC>  //病区名称
  --      <DATALIST>
  --        <ITEM>
  --           <YF></YF>  //月份
  --           <KFCR></KFCR>  //开放床位数
  --        </ITEM>
  --      </DATALIST>
  --    </ITEM>
  --  </BQLIST>
  --</OUTPUT>

  n_病区id   部门表.Id%Type;
  d_开始     Date;
  d_结束     Date;
  v_Xtmp     Varchar(5000);
  x_Tmp      Xmltype;
  x_Templet  Xmltype;
  n_初床位数 病人医嘱记录.Id%Type;
  n_总天数   Number;
  v_病区名称 部门表.名称%Type;

  v_月份   Varchar(30);
  d_Tmp    Date;
  n_开放数 Number;

  Cursor c_Item(病区id_In 部门表.Id%Type) Is
    Select a.病区id, a.天, Sum(a.变动) As 开放床位数
    From (Select a.病区id, a.变动, To_Char(a.日期, 'yyyy-mm-dd') As 天
           From 床位增减记录 A
           Where a.日期 Between d_开始 And d_结束 And a.病区id = 病区id_In) A
    Group By a.病区id, a.天
    Order By a.天;

  Type t_Item Is Table Of c_Item%RowType;
  r_Item t_Item;
Begin
  Select Extractvalue(Value(A), 'IN/BQID') As 病区id,
         To_Date(Extractvalue(Value(A), 'IN/KSRQ'), 'yyyy-mm-dd hh24:mi:ss') As 开始日期,
         To_Date(Extractvalue(Value(A), 'IN/JSRQ'), 'yyyy-mm-dd hh24:mi:ss') As 结束日期
  Into n_病区id, d_开始, d_结束
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT><BQLIST></BQLIST></OUTPUT>');

  --单个病区
  If Nvl(n_病区id, 0) <> 0 Then
    Select 名称 Into v_病区名称 From 部门表 Where ID = n_病区id;
    Select Nvl(Sum(a.变动), 0) Into n_初床位数 From 床位增减记录 A Where a.病区id = n_病区id And a.日期 < d_开始;
    Open c_Item(n_病区id);
    Fetch c_Item Bulk Collect
      Into r_Item;
    Close c_Item;
    v_Xtmp   := '<ITEM jsonArray="True" ><BQID>' || n_病区id || '</BQID><BQMC>' || v_病区名称 || '</BQMC>';
    v_Xtmp   := v_Xtmp || '<DATALIST></DATALIST></ITEM>';
    x_Tmp    := Xmltype(v_Xtmp);
    n_开放数 := 0;
    d_Tmp    := d_开始;
    v_月份   := '-';
    --循环天数
    While d_Tmp <= d_结束 Loop
      For J In 1 .. r_Item.Count Loop
        If r_Item(J).天 = To_Char(d_Tmp, 'yyyy-mm-dd') Then
          n_初床位数 := n_初床位数 + r_Item(J).开放床位数;
        End If;
      End Loop;
    
      If Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7) <> v_月份 Then
        --1.拼接之前的
        If v_月份 <> '-' Then
          n_开放数 := Round(n_开放数 / n_总天数);
          v_Xtmp   := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><KFCR>' || n_开放数 || '</KFCR></ITEM>';
          Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
        End If;
        v_月份 := Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7);
        --2.重置
        n_总天数 := 1;
        n_开放数 := n_初床位数;
      Else
        n_总天数 := n_总天数 + 1;
        n_开放数 := n_开放数 + n_初床位数;
      End If;
      d_Tmp := d_Tmp + 1;
    End Loop;
    n_开放数 := Round(n_开放数 / n_总天数);
    v_Xtmp   := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><KFCR>' || n_开放数 || '</KFCR></ITEM>';
    Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
    Select Appendchildxml(x_Templet, '/OUTPUT/BQLIST', x_Tmp) Into x_Templet From Dual;
  Else
    --所有病区  
    For R In (Select a.Id, a.名称, a.编码
              From 部门表 A, 部门性质说明 B
              Where a.Id = b.部门id And b.工作性质 = '护理' And 服务对象 = 2
              Group By a.Id, a.名称, a.编码
              Order By a.编码) Loop
      v_病区名称 := r.名称;
      n_病区id   := r.Id;
    
      Select Nvl(Sum(a.变动), 0) Into n_初床位数 From 床位增减记录 A Where a.病区id = n_病区id And a.日期 < d_开始;
      Open c_Item(n_病区id);
      Fetch c_Item Bulk Collect
        Into r_Item;
      Close c_Item;
    
      v_Xtmp   := '<ITEM jsonArray="True" ><BQID>' || n_病区id || '</BQID><BQMC>' || v_病区名称 || '</BQMC>';
      v_Xtmp   := v_Xtmp || '<DATALIST></DATALIST></ITEM>';
      x_Tmp    := Xmltype(v_Xtmp);
      n_开放数 := 0;
      d_Tmp    := d_开始;
      v_月份   := '-';
      --循环天数
      While d_Tmp <= d_结束 Loop
        For J In 1 .. r_Item.Count Loop
          If r_Item(J).天 = To_Char(d_Tmp, 'yyyy-mm-dd') Then
            n_初床位数 := n_初床位数 + r_Item(J).开放床位数;
          End If;
        End Loop;
      
        If Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7) <> v_月份 Then
          --1.拼接之前的
          If v_月份 <> '-' Then
            n_开放数 := Round(n_开放数 / n_总天数);
            v_Xtmp   := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><KFCR>' || n_开放数 || '</KFCR></ITEM>';
            Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
          End If;
          v_月份 := Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7);
          --2.重置
          n_总天数 := 1;
          n_开放数 := n_初床位数;
        Else
          n_总天数 := n_总天数 + 1;
          n_开放数 := n_开放数 + n_初床位数;
        End If;
        d_Tmp := d_Tmp + 1;
      End Loop;
      n_开放数 := Round(n_开放数 / n_总天数);
      v_Xtmp   := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><KFCR>' || n_开放数 || '</KFCR></ITEM>';
      Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
      Select Appendchildxml(x_Templet, '/OUTPUT/BQLIST', x_Tmp) Into x_Templet From Dual;
    End Loop;
  End If;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getkfcws;
/
Create Or Replace Procedure Zl_Third_Getzyrs
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：住院患者人数/查询
  --入参：Xml_In
  --<IN>
  --  <BQID></BQID>    //病区ID，传空取所有病区
  --  <KSRQ></KSRQ>  //开始日期   yyyy-mm-dd
  --  <JSRQ></JSRQ>   //结束日期  yyyy-mm-dd
  --</IN>
  --出参：xml_out
  --<OUTPUT>
  --  <BQLIST>
  --    <ITEM>
  --      <BQID></BQID>  //病区ID
  --      <BQMC></BQMC>  //病区名称
  --      <DATALIST>
  --        <ITEM>
  --           <YF></YF>  //月份
  --           <QCRS></QCRS>  //期初人数，即开始时间的在院病人数
  --           <XRRS></XRRS>  //新入人数，即时间段内新入病区的人数，包括入院、转入
  --           <XCRS></XCRS>  //新出人数，即时间段内新出病区的人数，包括出院、转出、死亡
  --           <QMRS></QMRS>  //期末人数，即结束时间的在院病人数
  --        </ITEM>
  --      </DATALIST>
  --    </ITEM>
  --  </BQLIST>
  --</OUTPUT>

  n_病区id   病人医嘱记录.执行科室id%Type;
  v_病区名称 部门表.名称%Type;
  v_Xtmp     Varchar(5000); --临时XML
  x_Tmp      Xmltype;
  d_开始     Date;
  d_结束     Date;
  x_Templet  Xmltype;
  d_Tmp      Date;
  n_期初人数 Number;
  n_新入人数 Number;
  n_新出人数 Number;
  n_期末人数 Number;
  d_s        Date;
  d_e        Date;

  v_月份 Varchar(50);

  --病区指定时间点的人数
  Cursor c_当前人数
  (
    时间_In   Date,
    病区id_In 病人医嘱记录.执行科室id%Type
  ) Is
    Select Count(1) As 人数
    From 病人变动记录 A
    Where 开始时间 < 时间_In And (终止时间 Is Null Or 终止时间 > 时间_In) And Nvl(a.附加床位, 0) = 0 And 病区id = 病区id_In;

  r_当前人数 c_当前人数%RowType;

  Cursor c_入人数
  (
    时间起_In Date,
    时间止_In Date,
    病区id_In 病人医嘱记录.执行科室id%Type
  ) Is
    Select Count(1) As 人数
    From 病人变动记录 A
    Where (a.开始原因 In (2, 3, 15) Or a.开始原因 = 1 And Not Exists
           (Select 1 From 病人变动记录 B Where a.病人id = b.病人id And a.主页id = b.主页id And b.开始原因 = 2)) And a.病区id = 病区id_In And
          a.开始时间 Between 时间起_In And 时间止_In And Nvl(a.附加床位, 0) = 0;
  r_入人数 c_入人数%RowType;

Begin
  Select Extractvalue(Value(A), 'IN/BQID') As 病区id,
         To_Date(Extractvalue(Value(A), 'IN/KSRQ'), 'yyyy-mm-dd hh24:mi:ss') As 开始日期,
         To_Date(Extractvalue(Value(A), 'IN/JSRQ'), 'yyyy-mm-dd hh24:mi:ss') As 结束日期
  Into n_病区id, d_开始, d_结束
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT><BQLIST></BQLIST></OUTPUT>');

  If Nvl(n_病区id, 0) <> 0 Then
    Select 名称 Into v_病区名称 From 部门表 Where ID = n_病区id;
  
    v_Xtmp := '<ITEM jsonArray="True" ><BQID>' || n_病区id || '</BQID><BQMC>' || v_病区名称 || '</BQMC>';
    v_Xtmp := v_Xtmp || '<DATALIST></DATALIST></ITEM>';
    x_Tmp  := Xmltype(v_Xtmp);
  
    d_Tmp  := d_开始;
    v_月份 := '-';
    d_s    := d_开始;
  
    --循环天数取出每个月份
    While d_Tmp <= d_结束 Loop
      If Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7) <> v_月份 Then
        If v_月份 <> '-' Then
        
          d_e := Trunc(d_Tmp) - 1 / 24 / 60;
        
          Open c_当前人数(d_s, n_病区id);
          Fetch c_当前人数
            Into r_当前人数;
          If c_当前人数%RowCount = 0 Then
            n_期初人数 := 0;
          Else
            n_期初人数 := r_当前人数.人数;
          End If;
          Close c_当前人数;
        
          Open c_当前人数(d_e, n_病区id);
          Fetch c_当前人数
            Into r_当前人数;
          If c_当前人数%RowCount = 0 Then
            n_期末人数 := 0;
          Else
            n_期末人数 := r_当前人数.人数;
          End If;
          Close c_当前人数;
        
          Open c_入人数(d_s, d_e, n_病区id);
          Fetch c_入人数
            Into r_入人数;
          If c_入人数%RowCount = 0 Then
            n_新入人数 := 0;
          Else
            n_新入人数 := r_入人数.人数;
          End If;
          Close c_入人数;
        
          n_新出人数 := n_新入人数 + n_期初人数 - n_期末人数;
        
          v_Xtmp := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><QCRS>' || n_期初人数 || '</QCRS><XRRS>' || n_新入人数 ||
                    '</XRRS><XCRS>' || n_新出人数 || '</XCRS><QMRS>' || n_期末人数 || '</QMRS></ITEM>';
          Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
        
        End If;
        v_月份 := Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7);
        d_s    := d_Tmp;
      
      End If;
      d_Tmp := d_Tmp + 1;
    End Loop;
  
    d_e := d_结束;
  
    Open c_当前人数(d_s, n_病区id);
    Fetch c_当前人数
      Into r_当前人数;
    If c_当前人数%RowCount = 0 Then
      n_期初人数 := 0;
    Else
      n_期初人数 := r_当前人数.人数;
    End If;
    Close c_当前人数;
  
    Open c_当前人数(d_e, n_病区id);
    Fetch c_当前人数
      Into r_当前人数;
    If c_当前人数%RowCount = 0 Then
      n_期末人数 := 0;
    Else
      n_期末人数 := r_当前人数.人数;
    End If;
    Close c_当前人数;
  
    Open c_入人数(d_s, d_e, n_病区id);
    Fetch c_入人数
      Into r_入人数;
    If c_入人数%RowCount = 0 Then
      n_新入人数 := 0;
    Else
      n_新入人数 := r_入人数.人数;
    End If;
    Close c_入人数;
  
    n_新出人数 := n_新入人数 + n_期初人数 - n_期末人数;
  
    v_Xtmp := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><QCRS>' || n_期初人数 || '</QCRS><XRRS>' || n_新入人数 ||
              '</XRRS><XCRS>' || n_新出人数 || '</XCRS><QMRS>' || n_期末人数 || '</QMRS></ITEM>';
    Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
    If x_Tmp Is Not Null Then
      Select Appendchildxml(x_Templet, '/OUTPUT/BQLIST', x_Tmp) Into x_Templet From Dual;
    End If;
  Else
    --所有病区
    For R In (Select a.Id, a.名称, a.编码
              From 部门表 A, 部门性质说明 B
              Where a.Id = b.部门id And b.工作性质 = '护理' And 服务对象 = 2
              Group By a.Id, a.名称, a.编码
              Order By a.编码) Loop
      v_病区名称 := r.名称;
      n_病区id   := r.Id;
    
      v_Xtmp := '<ITEM jsonArray="True" ><BQID>' || n_病区id || '</BQID><BQMC>' || v_病区名称 || '</BQMC>';
      v_Xtmp := v_Xtmp || '<DATALIST></DATALIST></ITEM>';
      x_Tmp  := Xmltype(v_Xtmp);
    
      d_Tmp  := d_开始;
      v_月份 := '-';
      d_s    := d_开始;
    
      --循环天数取出每个月份
      While d_Tmp <= d_结束 Loop
        If Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7) <> v_月份 Then
          If v_月份 <> '-' Then
          
            d_e := Trunc(d_Tmp) - 1 / 24 / 60;
          
            Open c_当前人数(d_s, n_病区id);
            Fetch c_当前人数
              Into r_当前人数;
            If c_当前人数%RowCount = 0 Then
              n_期初人数 := 0;
            Else
              n_期初人数 := r_当前人数.人数;
            End If;
            Close c_当前人数;
          
            Open c_当前人数(d_e, n_病区id);
            Fetch c_当前人数
              Into r_当前人数;
            If c_当前人数%RowCount = 0 Then
              n_期末人数 := 0;
            Else
              n_期末人数 := r_当前人数.人数;
            End If;
            Close c_当前人数;
          
            Open c_入人数(d_s, d_e, n_病区id);
            Fetch c_入人数
              Into r_入人数;
            If c_入人数%RowCount = 0 Then
              n_新入人数 := 0;
            Else
              n_新入人数 := r_入人数.人数;
            End If;
            Close c_入人数;
          
            n_新出人数 := n_新入人数 + n_期初人数 - n_期末人数;
          
            v_Xtmp := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><QCRS>' || n_期初人数 || '</QCRS><XRRS>' || n_新入人数 ||
                      '</XRRS><XCRS>' || n_新出人数 || '</XCRS><QMRS>' || n_期末人数 || '</QMRS></ITEM>';
            Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
          
          End If;
          v_月份 := Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7);
          d_s    := d_Tmp;
        
        End If;
        d_Tmp := d_Tmp + 1;
      End Loop;
    
      d_e := d_结束;
    
      Open c_当前人数(d_s, n_病区id);
      Fetch c_当前人数
        Into r_当前人数;
      If c_当前人数%RowCount = 0 Then
        n_期初人数 := 0;
      Else
        n_期初人数 := r_当前人数.人数;
      End If;
      Close c_当前人数;
    
      Open c_当前人数(d_e, n_病区id);
      Fetch c_当前人数
        Into r_当前人数;
      If c_当前人数%RowCount = 0 Then
        n_期末人数 := 0;
      Else
        n_期末人数 := r_当前人数.人数;
      End If;
      Close c_当前人数;
    
      Open c_入人数(d_s, d_e, n_病区id);
      Fetch c_入人数
        Into r_入人数;
      If c_入人数%RowCount = 0 Then
        n_新入人数 := 0;
      Else
        n_新入人数 := r_入人数.人数;
      End If;
      Close c_入人数;
    
      n_新出人数 := n_新入人数 + n_期初人数 - n_期末人数;
    
      v_Xtmp := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><QCRS>' || n_期初人数 || '</QCRS><XRRS>' || n_新入人数 ||
                '</XRRS><XCRS>' || n_新出人数 || '</XCRS><QMRS>' || n_期末人数 || '</QMRS></ITEM>';
      Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
      If x_Tmp Is Not Null Then
        Select Appendchildxml(x_Templet, '/OUTPUT/BQLIST', x_Tmp) Into x_Templet From Dual;
      End If;
    End Loop;
  End If;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getzyrs;
/
CREATE OR REPLACE Procedure Zl_Third_Getzycws
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：实际占用床日数/查询
  --实际占用总床日数：指每日夜晚12点实际占用病床数(即每日夜晚12点住院人数)总和。
  --                   包括实际占用的临时加床在内。病人入院后于当晚12点前死亡或因故出院的病人, 作为实际占用床位1天进行统计
  --入参：Xml_In
  --<IN>
  --    <BQID></BQID>    //病区ID，传空取所有病区
  --    <KSRQ></KSRQ>    //开始日期   yyyy-mm-dd
  --    <JSRQ></JSRQ>    //结束日期  yyyy-mm-dd
  --</IN>

  --出参：xml_out
  --<OUTPUT>
  --  <BQLIST>
  --    <ITEM>
  --      <BQID></BQID>  //病区ID
  --      <BQMC></BQMC>  //病区名称
  --      <DATALIST>
  --        <ITEM>
  --           <YF></YF>  //月份
  --           <ZYCR></ZYCR>  //实际占用床日数
  --        </ITEM>
  --      </DATALIST>
  --    </ITEM>
  --  </BQLIST>
  --</OUTPUT>
  n_病区id     部门表.Id%Type;
  v_病区名称   部门表.名称%Type;
  d_开始       Date;
  d_结束       Date;
  v_Xtmp       Varchar(5000); --临时XML
  x_Tmp        Xmltype;
  x_Templet    Xmltype;
  n_床日数     Number; --病人住院天数之和
  n_病人床日数 Number;
  n_病区床日数 Number(18);
  v_月份       Varchar2(50);
  d_Tmp        Date;
  v_Pre病人    Varchar2(100);
  n_Index      Number;
  d_s          Date;
  d_e          Date;

  d_天数起    Date;
  d_天数止    Date;
  d_Pre天数止 Date;

  Cursor c_Item
  (
    时间起_In Date,
    时间止_In Date,
    病区id_In 病人医嘱记录.执行科室id%Type
  ) Is
    Select Case
             When 终止原因 = 1 And 开始原因 In (1, 2, 3, 15) And 病区id = 病区id_In Then
              '转入加转出'
             When 终止原因 = 1 Or 开始原因 In (3, 15) And 病区id <> 病区id_In Then
              '转出'
             Else
              '转入'
           End As 类型, 病人id, 主页id, Trunc(开始时间) AS 开始时间, Trunc(终止时间) AS 终止时间, 病区id, 开始原因, 终止原因
    From (Select a.病人id, a.主页id,
                  Case
                    When Trunc(a.开始时间) < 时间起_In Then
                     时间起_In
                    Else
                     a.开始时间
                  End As 开始时间,
                  Case
                    When Trunc(a.终止时间) > 时间止_In Then
                     时间止_In
                    Else
                     a.终止时间
                  End As 终止时间, a.病区id, a.开始原因, a.终止原因
           From 病人变动记录 A
           Where a.开始时间 Between 时间起_In And 时间止_In And Exists
            (Select 1 From 病人变动记录 B Where a.病人id = b.病人id And a.主页id = b.主页id And b.病区id = 病区id_In) And
                 ((((a.开始原因 = 2 Or a.开始原因 = 1 And Not Exists
                  (Select 1 From 病人变动记录 C Where a.病人id = c.病人id And a.主页id = c.主页id And c.开始原因 = 2)) And a.病区id = 病区id_In Or
                 a.开始原因 In (3, 15))) Or a.终止原因 = 1) And Nvl(a.附加床位, 0) = 0
           Union All
           Select a.病人id, a.主页id,
                  Case
                    When Trunc(a.开始时间) < 时间起_In Then
                     时间起_In
                    Else
                     a.开始时间
                  End As 开始时间,
                  Case
                    When Trunc(a.终止时间) > 时间止_In Then
                     时间止_In
                    Else
                     a.终止时间
                  End As 终止时间, a.病区id, a.开始原因, a.终止原因
           From 病人变动记录 A
           Where a.开始时间 < 时间起_In And a.病区id = 病区id_In And
                 ((a.开始原因 = 2 Or a.开始原因 = 1 And Not Exists
                  (Select 1 From 病人变动记录 C Where a.病人id = c.病人id And a.主页id = c.主页id And c.开始原因 = 2)) And a.病区id = 病区id_In) And
                 Nvl(a.附加床位, 0) = 0 And Not Exists
            (Select 1
                  From 病人变动记录 B
                  Where a.病人id = b.病人id And a.主页id = b.主页id And b.开始时间 < 时间止_In And
                        (b.开始原因 In (3, 15) And b.病区id <> 病区id_In Or b.终止原因 = 1 And 病区id = 病区id_In)))
    Order By 病人id, 主页id, 开始时间, 终止时间;

  Type t_Item Is Table Of c_Item%RowType;
  r_Item t_Item;
Begin

  Select Extractvalue(Value(A), 'IN/BQID') As 病区id,
         To_Date(Extractvalue(Value(A), 'IN/KSRQ'), 'yyyy-mm-dd hh24:mi:ss') As 开始日期,
         To_Date(Extractvalue(Value(A), 'IN/JSRQ'), 'yyyy-mm-dd hh24:mi:ss') As 结束日期
  Into n_病区id, d_开始, d_结束
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT><BQLIST></BQLIST></OUTPUT>');

  If Nvl(n_病区id, 0) <> 0 Then
    Select 名称 Into v_病区名称 From 部门表 Where ID = n_病区id;
    v_Xtmp   := '<ITEM jsonArray="True" ><BQID>' || n_病区id || '</BQID><BQMC>' || v_病区名称 || '</BQMC>';
    v_Xtmp   := v_Xtmp || '<DATALIST></DATALIST></ITEM>';
    x_Tmp    := Xmltype(v_Xtmp);
    d_Tmp    := d_开始;
    v_月份   := '-';
    d_s      := d_开始;
    n_床日数 := 0;

    --循环天数取出每个月份
    While d_Tmp <= d_结束 Loop
      If Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7) <> v_月份 Then
        If v_月份 <> '-' Then
          d_e       := Trunc(d_Tmp) - 1 / 24 / 60;
          n_床日数  := 0;
          v_Pre病人 := '-';
          Open c_Item(d_s, d_e, n_病区id);
          Fetch c_Item Bulk Collect
            Into r_Item;
          Close c_Item;
          n_病区床日数 := 0;
          For I In 1 .. r_Item.Count Loop
            If r_Item(I).病人id || '_' || r_Item(I).主页id <> v_Pre病人 Or v_Pre病人 = '-' Then
              --新病人开始
              If r_Item(I).类型 = '转入加转出' Then
                d_天数起 := r_Item(I).开始时间;
                d_天数止 := r_Item(I).终止时间;
                If (d_天数止 - d_天数起)=0 Then
                  n_病人床日数 :=1;
                Else
                  n_病人床日数 :=(d_天数止 - d_天数起);
                End If;
                n_病区床日数 := n_病区床日数 + n_病人床日数 ;
              Elsif r_Item(I).类型 = '转入' Then
                If I >=r_Item.Count Then
                  d_天数起 := r_Item(I).开始时间;
                  d_天数止 := Trunc(d_e);
                  If (d_天数止 - d_天数起)=0 Then
                    n_病人床日数 :=1;
                  Else
                    n_病人床日数 :=(d_天数止 - d_天数起);
                  End If;
                  n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                Else
                  If r_Item(I+1).类型 = '转出' And r_Item(I+1).病人id || '_' || r_Item(I+1).主页id = r_Item(I).病人id || '_' || r_Item(I).主页id Then
                     d_天数起 := r_Item(I).开始时间;
                     d_天数止 := r_Item(I+1).开始时间;
                     If (d_天数止 - d_天数起)=0 Then
                       n_病人床日数 :=1;
                     Else
                       n_病人床日数 :=(d_天数止 - d_天数起);
                     End If;
                     n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                  Else
                     d_天数起 := r_Item(I).开始时间;
                     d_天数止 := Trunc(d_e);
                     If (d_天数止 - d_天数起)=0 Then
                       n_病人床日数 :=1;
                     Else
                       n_病人床日数 :=(d_天数止 - d_天数起);
                     End If;
                     n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                  End If;
                End If;
              Elsif r_Item(I).类型 = '转出' Then
                d_天数起 := Trunc(d_s);
                If NVL(r_Item(I).终止原因,0) = 1 then
                   d_天数止 := r_Item(I).终止时间;
                Else
                  d_天数止 := r_Item(I).开始时间;
                End If;
                If (d_天数止 - d_天数起)=0 Then
                  n_病人床日数 :=1;
                Else
                  n_病人床日数 :=(d_天数止 - d_天数起);
                End If;
                n_病区床日数 := n_病区床日数 + n_病人床日数 ;
              End If;
            Else
              If r_Item(I).类型 = '转入加转出' Then
                --如果上一个起始时间和这次的起始时间相同，则减一，例如：一天内在同一个科室转了多次；
                if d_天数起 = r_Item(I).开始时间 Then
                  n_病区床日数 := n_病区床日数 - 1;
                End If;
                d_天数起 := r_Item(I).开始时间;
                d_天数止 := r_Item(I).终止时间;
                If (d_天数止 - d_天数起)=0 Then
                  n_病人床日数 :=1;
                Else
                  n_病人床日数 :=(d_天数止 - d_天数起);
                End If;
                n_病区床日数 := n_病区床日数 + n_病人床日数 ;
              Elsif r_Item(I).类型 = '转入' Then
                --如果上一个起始时间和这次的起始时间相同，则减一，例如：一天内在同一个科室转了多次；
                if d_天数起 = r_Item(I).开始时间 Then
                  n_病区床日数 := n_病区床日数 - 1;
                End If;
                If I >=r_Item.Count Then
                  d_天数起 := r_Item(I).开始时间;
                  d_天数止 := Trunc(d_e);
                  If (d_天数止 - d_天数起)=0 Then
                    n_病人床日数 :=1;
                  Else
                    n_病人床日数 :=(d_天数止 - d_天数起);
                  End If;
                  n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                Else
                  If r_Item(I+1).类型 = '转出' And r_Item(I+1).病人id || '_' || r_Item(I+1).主页id = r_Item(I).病人id || '_' || r_Item(I).主页id Then
                     d_天数起 := r_Item(I).开始时间;
                     d_天数止 := r_Item(I+1).开始时间;
                     If (d_天数止 - d_天数起)=0 Then
                       n_病人床日数 :=1;
                     Else
                       n_病人床日数 :=(d_天数止 - d_天数起);
                     End If;
                     n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                  Else
                     d_天数起 := r_Item(I).开始时间;
                     d_天数止 := Trunc(d_e);
                     If (d_天数止 - d_天数起)=0 Then
                       n_病人床日数 :=1;
                     Else
                       n_病人床日数 :=(d_天数止 - d_天数起);
                     End If;
                     n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                  End If;
                End If;
              End If;
            End If;
            v_Pre病人 := r_Item(I).病人id || '_' || r_Item(I).主页id;
          End Loop;
          v_Xtmp := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><ZYCR>' || n_病区床日数 || '</ZYCR></ITEM>';
          Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
        End If;
        v_月份 := Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7);
        d_s    := d_Tmp;
      End If;
      d_Tmp := d_Tmp + 1;
    End Loop;

    d_e       := d_结束;
    n_床日数  := 0;
    v_Pre病人 := '-';
    Open c_Item(d_s, d_e, n_病区id);
    Fetch c_Item Bulk Collect
      Into r_Item;
    Close c_Item;
    n_病区床日数 := 0;
    For I In 1 .. r_Item.Count Loop
      If r_Item(I).病人id || '_' || r_Item(I).主页id <> v_Pre病人 Or v_Pre病人 = '-' Then
        --新病人开始
        If r_Item(I).类型 = '转入加转出' Then
          d_天数起 := r_Item(I).开始时间;
          d_天数止 := r_Item(I).终止时间;
          If (d_天数止 - d_天数起)=0 Then
            n_病人床日数 :=1;
          Else
            n_病人床日数 :=(d_天数止 - d_天数起);
          End If;
          n_病区床日数 := n_病区床日数 + n_病人床日数 ;
        Elsif r_Item(I).类型 = '转入' Then
          If I >=r_Item.Count Then
            d_天数起 := r_Item(I).开始时间;
            d_天数止 := Trunc(d_e);
            If (d_天数止 - d_天数起)=0 Then
              n_病人床日数 :=1;
            Else
              n_病人床日数 :=(d_天数止 - d_天数起);
            End If;
            n_病区床日数 := n_病区床日数 + n_病人床日数 ;
          Else
            If r_Item(I+1).类型 = '转出' And r_Item(I+1).病人id || '_' || r_Item(I+1).主页id = r_Item(I).病人id || '_' || r_Item(I).主页id Then
               d_天数起 := r_Item(I).开始时间;
               d_天数止 := r_Item(I+1).开始时间;
               If (d_天数止 - d_天数起)=0 Then
                 n_病人床日数 :=1;
               Else
                 n_病人床日数 :=(d_天数止 - d_天数起);
               End If;
               n_病区床日数 := n_病区床日数 + n_病人床日数 ;
            Else
               d_天数起 := r_Item(I).开始时间;
               d_天数止 := Trunc(d_e);
               If (d_天数止 - d_天数起)=0 Then
                 n_病人床日数 :=1;
               Else
                 n_病人床日数 :=(d_天数止 - d_天数起);
               End If;
               n_病区床日数 := n_病区床日数 + n_病人床日数 ;
            End If;
          End If;
        Elsif r_Item(I).类型 = '转出' Then
          d_天数起 := Trunc(d_s);
          If NVL(r_Item(I).终止原因,0) = 1 then
             d_天数止 := r_Item(I).终止时间;
          Else
            d_天数止 := r_Item(I).开始时间;
          End If;
          If (d_天数止 - d_天数起)=0 Then
            n_病人床日数 :=1;
          Else
            n_病人床日数 :=(d_天数止 - d_天数起);
          End If;
          n_病区床日数 := n_病区床日数 + n_病人床日数 ;
        End If;
      Else
        If r_Item(I).类型 = '转入加转出' Then
          --如果上一个起始时间和这次的起始时间相同，则减一，例如：一天内在同一个科室转了多次；
          if d_天数起 = r_Item(I).开始时间 Then
            n_病区床日数 := n_病区床日数 - 1;
          End If;
          d_天数起 := r_Item(I).开始时间;
          d_天数止 := r_Item(I).终止时间;
          If (d_天数止 - d_天数起)=0 Then
            n_病人床日数 :=1;
          Else
            n_病人床日数 :=(d_天数止 - d_天数起);
          End If;
          n_病区床日数 := n_病区床日数 + n_病人床日数 ;
        Elsif r_Item(I).类型 = '转入' Then
          --如果上一个起始时间和这次的起始时间相同，则减一，例如：一天内在同一个科室转了多次；
          if d_天数起 = r_Item(I).开始时间 Then
            n_病区床日数 := n_病区床日数 - 1;
          End If;
          If I >=r_Item.Count Then
            d_天数起 := r_Item(I).开始时间;
            d_天数止 := Trunc(d_e);
            If (d_天数止 - d_天数起)=0 Then
              n_病人床日数 :=1;
            Else
              n_病人床日数 :=(d_天数止 - d_天数起);
            End If;
            n_病区床日数 := n_病区床日数 + n_病人床日数 ;
          Else
            If r_Item(I+1).类型 = '转出' And r_Item(I+1).病人id || '_' || r_Item(I+1).主页id = r_Item(I).病人id || '_' || r_Item(I).主页id Then
               d_天数起 := r_Item(I).开始时间;
               d_天数止 := r_Item(I+1).开始时间;
               If (d_天数止 - d_天数起)=0 Then
                 n_病人床日数 :=1;
               Else
                 n_病人床日数 :=(d_天数止 - d_天数起);
               End If;
               n_病区床日数 := n_病区床日数 + n_病人床日数 ;
            Else
               d_天数起 := r_Item(I).开始时间;
               d_天数止 := Trunc(d_e);
               If (d_天数止 - d_天数起)=0 Then
                 n_病人床日数 :=1;
               Else
                 n_病人床日数 :=(d_天数止 - d_天数起);
               End If;
               n_病区床日数 := n_病区床日数 + n_病人床日数 ;
            End If;
          End If;
        End If;
      End If;
      v_Pre病人 := r_Item(I).病人id || '_' || r_Item(I).主页id;
    End Loop;
    v_Xtmp := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><ZYCR>' || n_病区床日数 || '</ZYCR></ITEM>';
    Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
    If x_Tmp Is Not Null Then
      Select Appendchildxml(x_Templet, '/OUTPUT/BQLIST', x_Tmp) Into x_Templet From Dual;
    End If;
  Else
    --所有病区
    For R In (Select a.Id, a.名称, a.编码
              From 部门表 A, 部门性质说明 B
              Where a.Id = b.部门id And b.工作性质 = '护理' And 服务对象 = 2
              Group By a.Id, a.名称, a.编码
              Order By a.编码) Loop
      v_病区名称 := r.名称;
      n_病区id   := r.Id;

      v_Xtmp   := '<ITEM jsonArray="True" ><BQID>' || n_病区id || '</BQID><BQMC>' || v_病区名称 || '</BQMC>';
      v_Xtmp   := v_Xtmp || '<DATALIST></DATALIST></ITEM>';
      x_Tmp    := Xmltype(v_Xtmp);
      d_Tmp    := d_开始;
      v_月份   := '-';
      d_s      := d_开始;
      n_床日数 := 0;

      --循环天数取出每个月份
      While d_Tmp <= d_结束 Loop
        If Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7) <> v_月份 Then
          If v_月份 <> '-' Then
            d_e       := Trunc(d_Tmp) - 1 / 24 / 60;
            n_床日数  := 0;
            v_Pre病人 := '-';
            Open c_Item(d_s, d_e, n_病区id);
            Fetch c_Item Bulk Collect
              Into r_Item;
            Close c_Item;
            n_病区床日数 := 0;
            For I In 1 .. r_Item.Count Loop
              If r_Item(I).病人id || '_' || r_Item(I).主页id <> v_Pre病人 Or v_Pre病人 = '-' Then
                --新病人开始
                If r_Item(I).类型 = '转入加转出' Then
                  d_天数起 := r_Item(I).开始时间;
                  d_天数止 := r_Item(I).终止时间;
                  If (d_天数止 - d_天数起)=0 Then
                    n_病人床日数 :=1;
                  Else
                    n_病人床日数 :=(d_天数止 - d_天数起);
                  End If;
                  n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                Elsif r_Item(I).类型 = '转入' Then
                  If I >=r_Item.Count Then
                    d_天数起 := r_Item(I).开始时间;
                    d_天数止 := Trunc(d_e);
                    If (d_天数止 - d_天数起)=0 Then
                      n_病人床日数 :=1;
                    Else
                      n_病人床日数 :=(d_天数止 - d_天数起);
                    End If;
                    n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                  Else
                    If r_Item(I+1).类型 = '转出' And r_Item(I+1).病人id || '_' || r_Item(I+1).主页id = r_Item(I).病人id || '_' || r_Item(I).主页id Then
                       d_天数起 := r_Item(I).开始时间;
                       d_天数止 := r_Item(I+1).开始时间;
                       If (d_天数止 - d_天数起)=0 Then
                         n_病人床日数 :=1;
                       Else
                         n_病人床日数 :=(d_天数止 - d_天数起);
                       End If;
                       n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                    Else
                       d_天数起 := r_Item(I).开始时间;
                       d_天数止 := Trunc(d_e);
                       If (d_天数止 - d_天数起)=0 Then
                         n_病人床日数 :=1;
                       Else
                         n_病人床日数 :=(d_天数止 - d_天数起);
                       End If;
                       n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                    End If;
                  End If;
                Elsif r_Item(I).类型 = '转出' Then
                  d_天数起 := Trunc(d_s);
                  If NVL(r_Item(I).终止原因,0) = 1 then
                     d_天数止 := r_Item(I).终止时间;
                  Else
                    d_天数止 := r_Item(I).开始时间;
                  End If;
                  If (d_天数止 - d_天数起)=0 Then
                    n_病人床日数 :=1;
                  Else
                    n_病人床日数 :=(d_天数止 - d_天数起);
                  End If;
                  n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                End If;
              Else
                If r_Item(I).类型 = '转入加转出' Then
                  --如果上一个起始时间和这次的起始时间相同，则减一，例如：一天内在同一个科室转了多次；
                  if d_天数起 = r_Item(I).开始时间 Then
                    n_病区床日数 := n_病区床日数 - 1;
                  End If;
                  d_天数起 := r_Item(I).开始时间;
                  d_天数止 := r_Item(I).终止时间;
                  If (d_天数止 - d_天数起)=0 Then
                    n_病人床日数 :=1;
                  Else
                    n_病人床日数 :=(d_天数止 - d_天数起);
                  End If;
                  n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                Elsif r_Item(I).类型 = '转入' Then
                  --如果上一个起始时间和这次的起始时间相同，则减一，例如：一天内在同一个科室转了多次；
                  if d_天数起 = r_Item(I).开始时间 Then
                    n_病区床日数 := n_病区床日数 - 1;
                  End If;
                  If I >=r_Item.Count Then
                    d_天数起 := r_Item(I).开始时间;
                    d_天数止 := Trunc(d_e);
                    If (d_天数止 - d_天数起)=0 Then
                      n_病人床日数 :=1;
                    Else
                      n_病人床日数 :=(d_天数止 - d_天数起);
                    End If;
                    n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                  Else
                    If r_Item(I+1).类型 = '转出' And r_Item(I+1).病人id || '_' || r_Item(I+1).主页id = r_Item(I).病人id || '_' || r_Item(I).主页id Then
                       d_天数起 := r_Item(I).开始时间;
                       d_天数止 := r_Item(I+1).开始时间;
                       If (d_天数止 - d_天数起)=0 Then
                         n_病人床日数 :=1;
                       Else
                         n_病人床日数 :=(d_天数止 - d_天数起);
                       End If;
                       n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                    Else
                       d_天数起 := r_Item(I).开始时间;
                       d_天数止 := Trunc(d_e);
                       If (d_天数止 - d_天数起)=0 Then
                         n_病人床日数 :=1;
                       Else
                         n_病人床日数 :=(d_天数止 - d_天数起);
                       End If;
                       n_病区床日数 := n_病区床日数 + n_病人床日数 ;
                    End If;
                  End If;
                End If;
              End If;
              v_Pre病人 := r_Item(I).病人id || '_' || r_Item(I).主页id;
            End Loop;
            v_Xtmp := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><ZYCR>' || n_病区床日数 || '</ZYCR></ITEM>';
            Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
          End If;
          v_月份 := Substr(To_Char(d_Tmp, 'yyyy-mm-dd'), 1, 7);
          d_s    := d_Tmp;
        End If;
        d_Tmp := d_Tmp + 1;
      End Loop;

      d_e       := d_结束;
      n_床日数  := 0;
      v_Pre病人 := '-';
      Open c_Item(d_s, d_e, n_病区id);
      Fetch c_Item Bulk Collect
        Into r_Item;
      Close c_Item;
      n_病区床日数 := 0;
      For I In 1 .. r_Item.Count Loop
        If r_Item(I).病人id || '_' || r_Item(I).主页id <> v_Pre病人 Or v_Pre病人 = '-' Then
          --新病人开始
          If r_Item(I).类型 = '转入加转出' Then
            d_天数起 := r_Item(I).开始时间;
            d_天数止 := r_Item(I).终止时间;
            If (d_天数止 - d_天数起)=0 Then
              n_病人床日数 :=1;
            Else
              n_病人床日数 :=(d_天数止 - d_天数起);
            End If;
            n_病区床日数 := n_病区床日数 + n_病人床日数 ;
          Elsif r_Item(I).类型 = '转入' Then
            If I >=r_Item.Count Then
              d_天数起 := r_Item(I).开始时间;
              d_天数止 := Trunc(d_e);
              If (d_天数止 - d_天数起)=0 Then
                n_病人床日数 :=1;
              Else
                n_病人床日数 :=(d_天数止 - d_天数起);
              End If;
              n_病区床日数 := n_病区床日数 + n_病人床日数 ;
            Else
              If r_Item(I+1).类型 = '转出' And r_Item(I+1).病人id || '_' || r_Item(I+1).主页id = r_Item(I).病人id || '_' || r_Item(I).主页id Then
                 d_天数起 := r_Item(I).开始时间;
                 d_天数止 := r_Item(I+1).开始时间;
                 If (d_天数止 - d_天数起)=0 Then
                   n_病人床日数 :=1;
                 Else
                   n_病人床日数 :=(d_天数止 - d_天数起);
                 End If;
                 n_病区床日数 := n_病区床日数 + n_病人床日数 ;
              Else
                 d_天数起 := r_Item(I).开始时间;
                 d_天数止 := Trunc(d_e);
                 If (d_天数止 - d_天数起)=0 Then
                   n_病人床日数 :=1;
                 Else
                   n_病人床日数 :=(d_天数止 - d_天数起);
                 End If;
                 n_病区床日数 := n_病区床日数 + n_病人床日数 ;
              End If;
            End If;
          Elsif r_Item(I).类型 = '转出' Then
            d_天数起 := Trunc(d_s);
            If NVL(r_Item(I).终止原因,0) = 1 then
               d_天数止 := r_Item(I).终止时间;
            Else
              d_天数止 := r_Item(I).开始时间;
            End If;
            If (d_天数止 - d_天数起)=0 Then
              n_病人床日数 :=1;
            Else
              n_病人床日数 :=(d_天数止 - d_天数起);
            End If;
            n_病区床日数 := n_病区床日数 + n_病人床日数 ;
          End If;
        Else
          If r_Item(I).类型 = '转入加转出' Then
            --如果上一个起始时间和这次的起始时间相同，则减一，例如：一天内在同一个科室转了多次；
            if d_天数起 = r_Item(I).开始时间 Then
              n_病区床日数 := n_病区床日数 - 1;
            End If;
            d_天数起 := r_Item(I).开始时间;
            d_天数止 := r_Item(I).终止时间;
            If (d_天数止 - d_天数起)=0 Then
              n_病人床日数 :=1;
            Else
              n_病人床日数 :=(d_天数止 - d_天数起);
            End If;
            n_病区床日数 := n_病区床日数 + n_病人床日数 ;
          Elsif r_Item(I).类型 = '转入' Then
            --如果上一个起始时间和这次的起始时间相同，则减一，例如：一天内在同一个科室转了多次；
            if d_天数起 = r_Item(I).开始时间 Then
              n_病区床日数 := n_病区床日数 - 1;
            End If;
            If I >=r_Item.Count Then
              d_天数起 := r_Item(I).开始时间;
              d_天数止 := Trunc(d_e);
              If (d_天数止 - d_天数起)=0 Then
                n_病人床日数 :=1;
              Else
                n_病人床日数 :=(d_天数止 - d_天数起);
              End If;
              n_病区床日数 := n_病区床日数 + n_病人床日数 ;
            Else
              If r_Item(I+1).类型 = '转出' And r_Item(I+1).病人id || '_' || r_Item(I+1).主页id = r_Item(I).病人id || '_' || r_Item(I).主页id Then
                 d_天数起 := r_Item(I).开始时间;
                 d_天数止 := r_Item(I+1).开始时间;
                 If (d_天数止 - d_天数起)=0 Then
                   n_病人床日数 :=1;
                 Else
                   n_病人床日数 :=(d_天数止 - d_天数起);
                 End If;
                 n_病区床日数 := n_病区床日数 + n_病人床日数 ;
              Else
                 d_天数起 := r_Item(I).开始时间;
                 d_天数止 := Trunc(d_e);
                 If (d_天数止 - d_天数起)=0 Then
                   n_病人床日数 :=1;
                 Else
                   n_病人床日数 :=(d_天数止 - d_天数起);
                 End If;
                 n_病区床日数 := n_病区床日数 + n_病人床日数 ;
              End If;
            End If;
          End If;
        End If;
        v_Pre病人 := r_Item(I).病人id || '_' || r_Item(I).主页id;
      End Loop;
      v_Xtmp := '<ITEM jsonArray="True" ><YF>' || Substr(v_月份, 6, 2) || '</YF><ZYCR>' || n_病区床日数 || '</ZYCR></ITEM>';
      Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;

      If x_Tmp Is Not Null Then
        Select Appendchildxml(x_Templet, '/OUTPUT/BQLIST', x_Tmp) Into x_Templet From Dual;
      End If;
    End Loop;
  End If;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getzycws;
/
CREATE OR REPLACE Procedure Zl_Third_Getzyhzrrs
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：出院者占用总床日数/查询
  --出院者占用总床日数：指当天出院患者的住院床日之总和，即住院总天数。病人入院后于当晚12点前死亡或因故出院的病人, 作为占用床日数1天进行统计
  --基于ZLHIS系统的理解：在指定时间范围出院的病人的住院天数的总和
  --入参：Xml_In
  --<IN>
  --    <BQID></BQID>    //病区ID，传空取所有病区
  --    <KSRQ></KSRQ>  //开始日期   yyyy-mm-dd
  --    <JSRQ></JSRQ>   //结束日期  yyyy-mm-dd
  --</IN>

  --出参：xml_out
  --<OUTPUT>
  --  <BQLIST>
  --    <ITEM>
  --      <BQID></BQID>  //病区ID
  --      <BQMC></BQMC>  //病区名称
  --      <DATALIST>
  --        <ITEM>
  --           <YF></YF>  //月份
  --           <CRS></CRS>  //出院患者占用总床日数
  --        </ITEM>
  --      </DATALIST>
  --    </ITEM>
  --  </BQLIST>
  --</OUTPUT> 

  n_病区id    部门表.Id%Type;
  n_Pre病区id 部门表.Id%Type;
  d_开始      Date;
  d_结束      Date;
  v_Xtmp      Varchar(5000); --临时XML 
  x_Tmp       Xmltype;
  x_Templet   Xmltype;

  Cursor c_Item Is
    Select m.病区id, m.病区名称, m.月, Sum(m.住院天数) As 床日数
    From (Select b.当前病区id As 病区id, b.病人id, b.主页id, a.名称 As 病区名称, To_Char(b.出院日期, 'mm') As 月,
                  (Trunc(b.出院日期) - Trunc(Decode(b.入科时间, Null, b.入院日期, b.入科时间))) As 住院天数
           From 病案主页 B, 部门表 A
           Where b.当前病区id = a.Id And b.当前病区id = n_病区id And b.出院日期 Between d_开始 And d_结束) M
    Group By m.病区id, m.病区名称, m.月
    Having Sum(m.住院天数) > 0;

  Type t_Item Is Table Of c_Item%RowType;
  r_Item t_Item;

  Cursor c_Itemall Is
    Select m.病区id, m.病区名称, m.月, Sum(m.住院天数) As 床日数
    From (Select b.当前病区id As 病区id, b.病人id, b.主页id, a.名称 As 病区名称, To_Char(b.出院日期, 'mm') As 月,
                  (Trunc(b.出院日期) - Trunc(Decode(b.入科时间, Null, b.入院日期, b.入科时间))) As 住院天数
           From 病案主页 B, 部门表 A
           Where b.当前病区id = a.Id And b.出院日期 Between d_开始 And d_结束) M
    Group By m.病区id, m.病区名称, m.月
    Having Sum(m.住院天数) > 0
    Order By m.病区id;
Begin
  Select Extractvalue(Value(A), 'IN/BQID') As 病区id,
         To_Date(Extractvalue(Value(A), 'IN/KSRQ'), 'yyyy-mm-dd hh24:mi:ss') As 开始日期,
         To_Date(Extractvalue(Value(A), 'IN/JSRQ'), 'yyyy-mm-dd hh24:mi:ss') As 结束日期
  Into n_病区id, d_开始, d_结束
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  n_Pre病区id := -1;

  If n_病区id Is Null Then
    Open c_Itemall;
    Fetch c_Itemall Bulk Collect
      Into r_Item;
    Close c_Itemall;
  Else
    Open c_Item;
    Fetch c_Item Bulk Collect
      Into r_Item;
    Close c_Item;
  End If;
  x_Templet := Xmltype('<OUTPUT><BQLIST></BQLIST></OUTPUT>');
  For I In 1 .. r_Item.Count Loop
    If n_Pre病区id <> r_Item(I).病区id Then
      If x_Tmp Is Not Null Then
        Select Appendchildxml(x_Templet, '/OUTPUT/BQLIST', x_Tmp) Into x_Templet From Dual;
      End If;
      n_Pre病区id := r_Item(I).病区id;
      v_Xtmp      := '<ITEM jsonArray="True" ><BQID>' || r_Item(I).病区id || '</BQID><BQMC>' || r_Item(I).病区名称 || '</BQMC>';
      v_Xtmp      := v_Xtmp || '<DATALIST></DATALIST></ITEM>';
      x_Tmp       := Xmltype(v_Xtmp);
    End If;
    v_Xtmp := '<ITEM jsonArray="True" ><YF>' || r_Item(I).月 || '</YF><CRS>' || r_Item(I).床日数 || '</CRS></ITEM>';
    Select Appendchildxml(x_Tmp, '/ITEM/DATALIST', Xmltype(v_Xtmp)) Into x_Tmp From Dual;
  End Loop;
  If x_Tmp Is Not Null Then
    Select Appendchildxml(x_Templet, '/OUTPUT/BQLIST', x_Tmp) Into x_Templet From Dual;
  End If;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getzyhzrrs;
/
CREATE OR REPLACE Procedure Zl_Third_Adviceedit
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：单条医嘱编辑功能
  --注意：对于日期类别的变量统一格式：2017-09-05 09:12:08
  --Xml 
  --<IN>
  --<DYFS></DYFS> 调用方式：1-根据传入医嘱ID查询某条医嘱，2-保存更新后医嘱
  --<ZYZID></ZYZID> 主医嘱ID:当调用查询时始用
  --<YZNR> 医嘱内容,保存医嘱时需传入
  --  <ROW>
  --    <ID></ID> ID  NUMBER
  --    <XGID></XGID> 相关ID  NUMBER
  --    <XH></XH> 序号  NUMBER
  --    <YZZT></YZZT> 医嘱状态  NUMBER
  --    <YZQX></YZQX> 医嘱期效  NUMBER
  --    <ZLXMID></ZLXMID> 诊疗项目ID  NUMBER
  --    <SFXMID></SFXMID> 收费细目ID  NUMBER
  --    <TS></TS> 天数  NUMBER
  --    <DCYL></DCYL> 单次用量  NUMBER
  --    <ZGYL></ZGYL> 总给予量  NUMBER
  --    <YZNR></YZNR> 医嘱内容  VARCHAR2
  --    <YSZT></YSZT> 医生嘱托  VARCHAR2
  --    <BBBW></BBBW> 标本部位  VARCHAR2
  --    <ZXPC></ZXPC> 执行频次  VARCHAR2
  --    <PLCS></PLCS> 频率次数  NUMBER
  --    <PLJG></PLJG> 频率间隔  NUMBER
  --    <JGDW></JGDW> 间隔单位  VARCHAR2
  --    <ZXSJFA></ZXSJFA> 执行时间方案  VARCHAR2
  --    <JJTX></JJTX> 计价特性  NUMBER
  --    <ZXKSID></ZXKSID> 执行科室ID  NUMBER
  --    <ZXXZ></ZXXZ> 执行性质  NUMBER
  --    <JJBZ></JJBZ> 紧急标志  NUMBER
  --    <KSZXSJ></KSZXSJ> 开始执行时间  DATE
  --    <ZXZZSJ></ZXZZSJ> 执行终止时间  DATE
  --    <BRKSID></BRKSID> 病人科室ID  NUMBER
  --    <KZKSID></KZKSID> 开嘱科室ID  NUMBER
  --    <KZYS></KZYS> 开嘱医生  VARCHAR2
  --    <KZSJ></KZSJ> 开嘱时间  DATE
  --    <JCFF></JCFF> 检查方法  VARCHAR2
  --    <ZXBJ></ZXBJ> 执行标记  NUMBER
  --    <KFFL></KFFL> 可否分零  NUMBER
  --    <ZY></ZY> 摘要  VARCHAR2
  --    <CYZXM></CYZXM> 操员作姓名   VARCHAR2，即当前操作员；查询时返回为空，保存医嘱时需从外部传入
  --    <LFJZ></LFJZ> 零费记帐  NUMBER
  --    <YYMD></YYMD> 用药目的  NUMBER
  --    <YYLY></YYLY> 用药理由  VARCHAR2
  --    <SHZT></SHZT> 审核状态  NUMBER
  --    <CLSM></CLSM> 超量说明  VARCHAR2
  --    <SCYL></SCYL> 首次用量  NUMBER
  --    <SSQK></SSQK> 手术情况  NUMBER
  --    <ZHXMID></ZHXMID> 组合项目ID  NUMBER
  --    <PSJG></PSJG> 皮试结果  VARCHAR2
  --  </ROW>
  --  ...
  --  ...
  --</YZNR>
  --</IN>

  --Xml_Out--当调用功能为查询时有用
  --<OUTPUT>
  --<YZNR> 医嘱内容保存时的结节内容相同，当调用功能为查询时有用，否则无此结点
  --</YZNR>
  --  <ERROR>
  --    <MSG></MSG>  //错误捕获
  --  </ERROR>
  --</OUTPUT>

  Type r_医嘱 Is Record(
    ID           病人医嘱记录.Id%Type,
    相关id       病人医嘱记录.相关id%Type,
    序号         病人医嘱记录.序号%Type,
    医嘱状态     病人医嘱记录.医嘱状态%Type,
    医嘱期效     病人医嘱记录.医嘱期效%Type,
    诊疗项目id   病人医嘱记录.诊疗项目id%Type,
    收费细目id   病人医嘱记录.收费细目id%Type,
    天数         病人医嘱记录.天数%Type,
    单次用量     病人医嘱记录.单次用量%Type,
    总给予量     病人医嘱记录.总给予量%Type,
    医嘱内容     病人医嘱记录.医嘱内容%Type,
    医生嘱托     病人医嘱记录.医生嘱托%Type,
    标本部位     病人医嘱记录.标本部位%Type,
    执行频次     病人医嘱记录.执行频次%Type,
    频率次数     病人医嘱记录.频率次数%Type,
    频率间隔     病人医嘱记录.频率间隔%Type,
    间隔单位     病人医嘱记录.间隔单位%Type,
    执行时间方案 病人医嘱记录.执行时间方案%Type,
    计价特性     病人医嘱记录.计价特性%Type,
    执行科室id   病人医嘱记录.执行科室id%Type,
    执行性质     病人医嘱记录.执行性质%Type,
    紧急标志     病人医嘱记录.紧急标志%Type,
    开始执行时间 病人医嘱记录.开始执行时间%Type,
    执行终止时间 病人医嘱记录.执行终止时间%Type,
    病人科室id   病人医嘱记录.病人科室id%Type,
    开嘱科室id   病人医嘱记录.开嘱科室id%Type,
    开嘱医生     病人医嘱记录.开嘱医生%Type,
    开嘱时间     病人医嘱记录.开嘱时间%Type,
    检查方法     病人医嘱记录.检查方法%Type,
    执行标记     病人医嘱记录.执行标记%Type,
    可否分零     病人医嘱记录.可否分零%Type,
    摘要         病人医嘱记录.摘要%Type,
    操员作姓名   病人医嘱状态.操作人员%Type,
    零费记帐     病人医嘱记录.零费记帐%Type,
    用药目的     病人医嘱记录.用药目的%Type,
    用药理由     病人医嘱记录.用药理由%Type,
    审核状态     病人医嘱记录.审核状态%Type,
    超量说明     病人医嘱记录.超量说明%Type,
    首次用量     病人医嘱记录.首次用量%Type,
    手术情况     病人医嘱记录.手术情况%Type,
    组合项目id   病人医嘱记录.组合项目id%Type,
    皮试结果     病人医嘱记录.皮试结果%Type);
  r_Item     r_医嘱;
  
  n_医嘱id   病人医嘱记录.Id%Type;
  n_调用方式 Number;
  x_Templet  Xmltype;
  v_Temp     Varchar2(32767); --临时XML

  Cursor c_医嘱 Is
    Select a.Id, a.相关id, a.序号, a.医嘱状态, a.医嘱期效, a.诊疗项目id, a.收费细目id, a.天数, a.单次用量, a.总给予量, a.医嘱内容, a.医生嘱托, a.标本部位, a.执行频次,
           a.频率次数, a.频率间隔, a.间隔单位, a.执行时间方案, a.计价特性, a.执行科室id, a.执行性质, a.紧急标志, a.开始执行时间, a.执行终止时间, a.病人科室id, a.开嘱科室id,
           a.开嘱医生, a.开嘱时间, a.检查方法, a.执行标记, a.可否分零, a.摘要, Null As 操员作姓名, a.零费记帐, a.用药目的, a.用药理由, a.审核状态, a.超量说明, a.首次用量,
           a.手术情况, a.组合项目id, a.皮试结果
    From 病人医嘱记录 A
    Where a.Id = n_医嘱id Or a.相关id = n_医嘱id
    Order By a.序号;

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/DYFS'), Extractvalue(Value(A), 'IN/ZYZID')
  Into n_调用方式, n_医嘱id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  If n_调用方式 = 1 Then
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<YZNR></YZNR>')) Into x_Templet From Dual;
    Open c_医嘱;
    Loop
      Fetch c_医嘱
        Into r_Item;
      Exit When c_医嘱%NotFound;
      v_Temp := '<ROW>';
      v_Temp := v_Temp || '<ID>' || r_Item.Id || '</ID>';
      v_Temp := v_Temp || '<XGID>' || r_Item.相关id || '</XGID>';
      v_Temp := v_Temp || '<XH>' || r_Item.序号 || '</XH>';
      v_Temp := v_Temp || '<YZZT>' || r_Item.医嘱状态 || '</YZZT>';
      v_Temp := v_Temp || '<YZQX>' || r_Item.医嘱期效 || '</YZQX>';
      v_Temp := v_Temp || '<ZLXMID>' || r_Item.诊疗项目id || '</ZLXMID>';
      v_Temp := v_Temp || '<SFXMID>' || r_Item.收费细目id || '</SFXMID>';
      v_Temp := v_Temp || '<TS>' || r_Item.天数 || '</TS>';
      v_Temp := v_Temp || '<DCYL>' || r_Item.单次用量 || '</DCYL>';
      v_Temp := v_Temp || '<ZGYL>' || r_Item.总给予量 || '</ZGYL>';
      v_Temp := v_Temp || '<YZNR>' || r_Item.医嘱内容 || '</YZNR>';
      v_Temp := v_Temp || '<YSZT>' || r_Item.医生嘱托 || '</YSZT>';
      v_Temp := v_Temp || '<BBBW>' || r_Item.标本部位 || '</BBBW>';
      v_Temp := v_Temp || '<ZXPC>' || r_Item.执行频次 || '</ZXPC>';
      v_Temp := v_Temp || '<PLCS>' || r_Item.频率次数 || '</PLCS>';
      v_Temp := v_Temp || '<PLJG>' || r_Item.频率间隔 || '</PLJG>';
      v_Temp := v_Temp || '<JGDW>' || r_Item.间隔单位 || '</JGDW>';
      v_Temp := v_Temp || '<ZXSJFA>' || r_Item.执行时间方案 || '</ZXSJFA>';
      v_Temp := v_Temp || '<JJTX>' || r_Item.计价特性 || '</JJTX>';
      v_Temp := v_Temp || '<ZXKSID>' || r_Item.执行科室id || '</ZXKSID>';
      v_Temp := v_Temp || '<ZXXZ>' || r_Item.执行性质 || '</ZXXZ>';
      v_Temp := v_Temp || '<JJBZ>' || r_Item.紧急标志 || '</JJBZ>';
      v_Temp := v_Temp || '<KSZXSJ>' || To_Char(r_Item.开始执行时间, 'yyyy-mm-dd hh24:mi:ss') || '</KSZXSJ>';
      v_Temp := v_Temp || '<ZXZZSJ>' || To_Char(r_Item.执行终止时间, 'yyyy-mm-dd hh24:mi:ss') || '</ZXZZSJ>';
      v_Temp := v_Temp || '<BRKSID>' || r_Item.病人科室id || '</BRKSID>';
      v_Temp := v_Temp || '<KZKSID>' || r_Item.开嘱科室id || '</KZKSID>';
      v_Temp := v_Temp || '<KZYS>' || r_Item.开嘱医生 || '</KZYS>';
      v_Temp := v_Temp || '<KZSJ>' || To_Char(r_Item.开嘱时间, 'yyyy-mm-dd hh24:mi:ss') || '</KZSJ>';
      v_Temp := v_Temp || '<JCFF>' || r_Item.检查方法 || '</JCFF>';
      v_Temp := v_Temp || '<ZXBJ>' || r_Item.执行标记 || '</ZXBJ>';
      v_Temp := v_Temp || '<KFFL>' || r_Item.可否分零 || '</KFFL>';
      v_Temp := v_Temp || '<ZY>' || r_Item.摘要 || '</ZY>';
      v_Temp := v_Temp || '<CYZXM>' || r_Item.操员作姓名 || '</CYZXM>';
      v_Temp := v_Temp || '<LFJZ>' || r_Item.零费记帐 || '</LFJZ>';
      v_Temp := v_Temp || '<YYMD>' || r_Item.用药目的 || '</YYMD>';
      v_Temp := v_Temp || '<YYLY>' || r_Item.用药理由 || '</YYLY>';
      v_Temp := v_Temp || '<SHZT>' || r_Item.审核状态 || '</SHZT>';
      v_Temp := v_Temp || '<CLSM>' || r_Item.超量说明 || '</CLSM>';
      v_Temp := v_Temp || '<SCYL>' || r_Item.首次用量 || '</SCYL>';
      v_Temp := v_Temp || '<SSQK>' || r_Item.手术情况 || '</SSQK>';
      v_Temp := v_Temp || '<ZHXMID>' || r_Item.组合项目id || '</ZHXMID>';
      v_Temp := v_Temp || '<PSJG>' || r_Item.皮试结果 || '</PSJG>';
      v_Temp := v_Temp || '</ROW>';
      Select Appendchildxml(x_Templet, '/OUTPUT/YZNR', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
    Close c_医嘱;
    Xml_Out := x_Templet;
  End If;

  If n_调用方式 = 2 Then
    For R In (Select Extractvalue(Value(A), 'ROW/ID') As ID, Extractvalue(Value(A), 'ROW/XGID') As 相关id,
                     Extractvalue(Value(A), 'ROW/XH') As 序号, Extractvalue(Value(A), 'ROW/YZZT') As 医嘱状态,
                     Extractvalue(Value(A), 'ROW/YZQX') As 医嘱期效, Extractvalue(Value(A), 'ROW/ZLXMID') As 诊疗项目id,
                     Extractvalue(Value(A), 'ROW/SFXMID') As 收费细目id, Extractvalue(Value(A), 'ROW/TS') As 天数,
                     Extractvalue(Value(A), 'ROW/DCYL') As 单次用量, Extractvalue(Value(A), 'ROW/ZGYL') As 总给予量,
                     Extractvalue(Value(A), 'ROW/YZNR') As 医嘱内容, Extractvalue(Value(A), 'ROW/YSZT') As 医生嘱托,
                     Extractvalue(Value(A), 'ROW/BBBW') As 标本部位, Extractvalue(Value(A), 'ROW/ZXPC') As 执行频次,
                     Extractvalue(Value(A), 'ROW/PLCS') As 频率次数, Extractvalue(Value(A), 'ROW/PLJG') As 频率间隔,
                     Extractvalue(Value(A), 'ROW/JGDW') As 间隔单位, Extractvalue(Value(A), 'ROW/ZXSJFA') As 执行时间方案,
                     Extractvalue(Value(A), 'ROW/JJTX') As 计价特性, Extractvalue(Value(A), 'ROW/ZXKSID') As 执行科室id,
                     Extractvalue(Value(A), 'ROW/ZXXZ') As 执行性质, Extractvalue(Value(A), 'ROW/JJBZ') As 紧急标志,
                     To_Date(Extractvalue(Value(A), 'ROW/KSZXSJ'), 'yyyy-mm-dd hh24:mi:ss') As 开始执行时间,
                     To_Date(Extractvalue(Value(A), 'ROW/ZXZZSJ'), 'yyyy-mm-dd hh24:mi:ss') As 执行终止时间,
                     Extractvalue(Value(A), 'ROW/BRKSID') As 病人科室id, Extractvalue(Value(A), 'ROW/KZKSID') As 开嘱科室id,
                     Extractvalue(Value(A), 'ROW/KZYS') As 开嘱医生,
                     To_Date(Extractvalue(Value(A), 'ROW/KZSJ'), 'yyyy-mm-dd hh24:mi:ss') As 开嘱时间,
                     Extractvalue(Value(A), 'ROW/JCFF') As 检查方法, Extractvalue(Value(A), 'ROW/ZXBJ') As 执行标记,
                     Extractvalue(Value(A), 'ROW/KFFL') As 可否分零, Extractvalue(Value(A), 'ROW/ZY') As 摘要,
                     Extractvalue(Value(A), 'ROW/CYZXM') As 操员作姓名, Extractvalue(Value(A), 'ROW/LFJZ') As 零费记帐,
                     Extractvalue(Value(A), 'ROW/YYMD') As 用药目的, Extractvalue(Value(A), 'ROW/YYLY') As 用药理由,
                     Extractvalue(Value(A), 'ROW/SHZT') As 审核状态, Extractvalue(Value(A), 'ROW/CLSM') As 超量说明,
                     Extractvalue(Value(A), 'ROW/SCYL') As 首次用量, Extractvalue(Value(A), 'ROW/SSQK') As 手术情况,
                     Extractvalue(Value(A), 'ROW/ZHXMID') As 组合项目id, Extractvalue(Value(A), 'ROW/PSJG') As 皮试结果
              From Table(Xmlsequence(Extract(Xml_In, 'IN/YZNR/ROW'))) A) Loop
    
      Zl_病人医嘱记录_Update(r.Id, r.相关id, r.序号, r.医嘱状态, r.医嘱期效, r.诊疗项目id, r.收费细目id, r.天数, r.单次用量, r.总给予量, r.医嘱内容, r.医生嘱托,
                       r.标本部位, r.执行频次, r.频率次数, r.频率间隔, r.间隔单位, r.执行时间方案, r.计价特性, r.执行科室id, r.执行性质, r.紧急标志, r.开始执行时间,
                       r.执行终止时间, r.病人科室id, r.开嘱科室id, r.开嘱医生, r.开嘱时间, r.检查方法, r.执行标记, r.可否分零, r.摘要, r.操员作姓名, r.零费记帐,
                       r.用药目的, r.用药理由, r.审核状态, r.超量说明, r.首次用量, r.手术情况, r.组合项目id, r.皮试结果);
    
    End Loop;
    Xml_Out := Xmltype('<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>');
  End If;
Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
	zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Adviceedit;
/
CREATE OR REPLACE Procedure Zl_Third_adviceDelete
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:医嘱支传入一批医嘱进行删除
  --入参:Xml_In:
  --  <IN>
  --  <ROW>
  --  <YZID></YZID>医嘱ID --主医嘱ID
  --  <ROW>
  --  </IN>
  --  示例 xml_in:=Xmltype('<IN><ROW><YZID>1</YZID></ROW><ROW><YZID>2</YZID></ROW></IN>');
  --出参:Xml_Out
  --  <OUTPUT>
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Tmp Varchar2(2000);
  v_Error Varchar(255);
  Err_Custom Exception;
Begin
  For R In (Select b.医嘱id
            From (Select Xml_In As Datas From Dual) A,
                 Xmltable('//IN/ROW' Passing a.Datas Columns 医嘱id Number(18) Path 'YZID') B) Loop
    Zl_病人医嘱记录_Delete(r.医嘱id, 1);
  End Loop;
  Xml_Out := Xmltype('<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>');
Exception
  When Err_Custom Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
	zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_adviceDelete;
/
CREATE OR REPLACE Procedure Zl_Third_Deleteoutdiag
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：删除诊断
  --入参
  --Xml_In
  --<IN>
  -- <BRID></BRID>病人ID
  -- <ZYID></ZYID>主页ID
  -- <JLLY></JLLY>记录来源
  -- <BLID></BLID>病历ID 空串，结点保留
  -- <ZDLX></ZDLX>诊断类型,
  -- <ZDIDS></ZDIDS>诊断IDS，诊断ID拼串，逗号分割。
  --</IN>

  --出参:Xml_Out， 
  --  <OUTPUT>  
  --    <ERROR> 
  --      <MSG>错误信息</MSG> 
  --    </ERROR> 
  --  </OUTPUT> 
  v_Tmp Varchar2(4000);
Begin
  For R In (Select Extractvalue(Value(A), 'ROW/BRID') As 病人id, Extractvalue(Value(A), 'ROW/ZYID') As 主页id,
                   Extractvalue(Value(A), 'ROW/JLLY') As 记录来源, Extractvalue(Value(A), 'ROW/BLID') As 病历id,
                   Extractvalue(Value(A), 'ROW/ZDLX') As 诊断类型, Extractvalue(Value(A), 'ROW/ZDIDS') As 诊断ids
            From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A) Loop
    Zl_病人诊断记录_Delete(r.病人id, r.主页id, r.记录来源, r.病历id, r.诊断类型, r.诊断ids);
  End Loop;
  Xml_Out := Xmltype('<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>');
Exception
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
	zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Deleteoutdiag;
/
Create Or Replace Procedure Zl_Third_Upd_Critical
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:危急值相关操作，新增，修改，删除等
  --入参:Xml_In: 
  --  <IN> 
  --      <TYPE></TYPE>     --调用类型      (Number)： 1-新增，2-修改，3-删除
  --      <SJLY></SJLY>     --数据来源      (Number)
  --      <YZID></YZID>     --医嘱ID        (Number)
  --      <BBID></BBID>     --标本id        (Number)
  --      <WJZMS></WJZMS>   --危急值描述    (VarChar)
  --      <BGSJ></BGSJ>     --报告时间      (DATE)
  --      <BGKSID></BGKSID> --报告科室id    (Number)
  --      <BGR></BGR>       --报告人        (VarChar)
  --  </IN> 
  --出参：Xml_Out 
  --<OUTPUT> 
  --   <RESULT>true</RESULT> 
  --</OUTPUT> 

  --失败： 
  --<OUTPUT> 
  --   <RESULT>false</RESULT> 
  --   <ERROR> 
  --     <MSG>详细错误提示</MSG> 
  --   </ERROR> 
  --</OUTPUT> 
  -------------------------------------------------------------------------------------------------- 
  n_危急值id   病人危急值记录.Id%Type;
  v_数据来源   病人危急值记录.数据来源%Type;
  n_病人id     病人危急值记录.病人id%Type;
  n_主页id     病人危急值记录.主页id%Type;
  v_挂号单     病人危急值记录.挂号单%Type;
  n_婴儿       病人危急值记录.婴儿%Type;
  v_姓名       病人危急值记录.姓名%Type;
  v_性别       病人危急值记录.性别%Type;
  v_年龄       病人危急值记录.年龄%Type;
  n_医嘱id     病人危急值记录.医嘱id%Type;
  n_标本id     病人危急值记录.标本id%Type;
  v_危急值描述 病人危急值记录.危急值描述%Type;
  d_报告时间   病人危急值记录.报告时间%Type;
  n_报告科室id 病人危急值记录.报告科室id%Type;
  v_报告人     病人危急值记录.报告人%Type;
  n_就诊id     病人挂号记录.Id%Type;
  n_就诊科室id 部门表.Id%Type;
  n_就诊病区id 部门表.Id%Type;
  n_病人来源   业务消息清单.病人来源%Type;
  v_提醒部门   Varchar2(300);

  n_Type Number; --操作状态，1-新增，2-修改，3-删除

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/TYPE')), To_Number(Extractvalue(Value(A), 'IN/YZID')),
         Extractvalue(Value(A), 'IN/SJLY'), To_Number(Extractvalue(Value(A), 'IN/BBID')),
         Extractvalue(Value(A), 'IN/WJZMS'), To_Date(Extractvalue(Value(A), 'IN/BGSJ'), 'yyyy-mm-dd hh24:mi:ss'),
         To_Number(Extractvalue(Value(A), 'IN/BGKSID')), Extractvalue(Value(A), 'IN/BGR')
  Into n_Type, n_医嘱id, v_数据来源, n_标本id, v_危急值描述, d_报告时间, n_报告科室id, v_报告人
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_医嘱id, 0) = 0 Then
    v_Err_Msg := '无法确定病人危急值记录,请检查传入项是否完整！';
    Raise Err_Item;
  End If;

  If n_Type = 1 Then
    --新增
    Select a.病人id, a.主页id, a.挂号单, a.婴儿, a.姓名, a.性别, a.年龄, a.病人来源
    Into n_病人id, n_主页id, v_挂号单, n_婴儿, v_姓名, v_性别, v_年龄, n_病人来源
    From 病人医嘱记录 A
    Where a.Id = n_医嘱id;
  
    Select 病人危急值记录_Id.Nextval Into n_危急值id From Dual;
  
    --产生危急值记录
    Zl_病人危急值记录_Insert(n_危急值id, v_数据来源, n_病人id, n_主页id, v_挂号单, n_婴儿, v_姓名, v_性别, v_年龄, n_医嘱id, n_标本id, v_危急值描述, d_报告时间,
                      n_报告科室id, v_报告人);
  
    --产生危急值消息
    If n_主页id Is Null And n_病人来源 = 1 Then
      Select a.Id As 就诊id, Null As 病区id, a.执行部门id As 科室id
      Into n_就诊id, n_就诊病区id, n_就诊科室id
      From 病人挂号记录 A
      Where a.No = v_挂号单 And a.记录性质 = 1 And a.记录状态 = 1;
      v_提醒部门 := n_就诊科室id;
    Else
      Select a.主页id As 就诊id, a.当前病区id As 病区id, a.出院科室id As 科室id
      Into n_就诊id, n_就诊病区id, n_就诊科室id
      From 病案主页 A
      Where a.病人id = n_病人id And a.主页id = n_主页id;
    
      If n_就诊病区id <> n_就诊科室id Then
        v_提醒部门 := n_就诊病区id || ',' || n_就诊科室id;
      Else
        v_提醒部门 := n_就诊科室id;
      End If;
    End If;
  
    Zl_业务消息清单_Insert(n_病人id, n_就诊id, n_就诊科室id, n_就诊病区id, n_病人来源, v_危急值描述, '1110', 'ZLHIS_LIS_003', n_医嘱id, 3, 0,
                     Sysdate, v_提醒部门);
  Elsif n_Type = 2 Then
    --修改
    Select a.病人id, a.主页id, a.挂号单, a.婴儿, a.姓名, a.性别, a.年龄
    Into n_病人id, n_主页id, v_挂号单, n_婴儿, v_姓名, v_性别, v_年龄
    From 病人医嘱记录 A
    Where a.Id = n_医嘱id;
  
    For R In (Select Distinct a.Id As ID From 病人危急值记录 A Where a.医嘱id = n_医嘱id And a.报告时间 = d_报告时间) Loop
      Zl_病人危急值记录_Update(r.Id, v_数据来源, n_病人id, n_主页id, v_挂号单, n_婴儿, v_姓名, v_性别, v_年龄, n_医嘱id, n_标本id, v_危急值描述, d_报告时间,
                        n_报告科室id, v_报告人);
    End Loop;
  Elsif n_Type = 3 Then
    --删除
    For R In (Select Distinct a.Id As ID, a.状态
              From 病人危急值记录 A
              Where a.医嘱id = n_医嘱id And a.报告时间 = d_报告时间) Loop
      If r.状态 = 2 Then
        v_Err_Msg := '当前危急值记录已处理,不能删除！';
        Raise Err_Item;
      End If;
      Zl_病人危急值记录_Delete(r.Id);
    End Loop;
  End If;

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Upd_Critical;
/
CREATE OR REPLACE Procedure Zl_Third_Updateoutdiag
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：修改诊断
  --日期格式统一固定为：2017-05-25 10:22:31
  --入参
  --Xml_In
  --<IN>
  -- <ID></ID>ID
  -- <BRID></BRID>病人ID
  -- <ZYID></ZYID>主页ID
  -- <JLLY></JLLY>记录来源
  -- <ZDLX></ZDLX>诊断类型
  -- <JBID></JBID>疾病ID
  -- <ZDID></ZDID>诊断ID
  -- <ZHID></ZHID>证候ID
  -- <ZDMS></ZDMS>诊断描述
  -- <CYQK></CYQK>出院情况
  -- <SFWZ></SFWZ>是否未治
  -- <SFYZ></SFYZ>是否疑诊
  -- <ZDCX></ZDCX>诊断次序
  -- <BZ></BZ>备注
  -- <RYBQ></RYBQ>入院病情
  -- <FBSJ></FBSJ>发病时间
  -- <FMID></FMID>附码ID
  --</IN>

  --出参:Xml_Out，
  --  <OUTPUT>
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  v_Tmp Varchar2(4000);
Begin
  For R In (Select Extractvalue(Value(A), 'ROW/ID') As ID, Extractvalue(Value(A), 'ROW/BRID') As 病人id,
                   Extractvalue(Value(A), 'ROW/ZYID') As 主页id, Extractvalue(Value(A), 'ROW/JLLY') As 记录来源,
                   Extractvalue(Value(A), 'ROW/ZDLX') As 诊断类型, Extractvalue(Value(A), 'ROW/JBID') As 疾病id,
                   Extractvalue(Value(A), 'ROW/ZDID') As 诊断id, Extractvalue(Value(A), 'ROW/ZHID') As 证候id,
                   Extractvalue(Value(A), 'ROW/ZDMS') As 诊断描述, Extractvalue(Value(A), 'ROW/CYQK') As 出院情况,
                   Extractvalue(Value(A), 'ROW/SFWZ') As 是否未治, Extractvalue(Value(A), 'ROW/SFYZ') As 是否疑诊,
                   Extractvalue(Value(A), 'ROW/ZDCX') As 诊断次序, Extractvalue(Value(A), 'ROW/BZ') As 备注,
                   Extractvalue(Value(A), 'ROW/RYBQ') As 入院病情,
                   To_Date(Extractvalue(Value(A), 'ROW/FBSJ'), 'yyyy-mm-dd hh24:mi:ss') As 发病时间,
                   Extractvalue(Value(A), 'ROW/FMID') As 附码id
            From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A) Loop
  
    Zl_病人诊断记录_Update(r.Id, r.病人id, r.主页id, r.记录来源, r.诊断类型, r.疾病id, r.诊断id, r.证候id, r.诊断描述, r.出院情况, r.是否未治, r.是否疑诊,
                     r.诊断次序, r.备注, r.入院病情, r.发病时间, r.附码id);
  End Loop;
  Xml_Out := Xmltype('<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>');
Exception
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
	zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Updateoutdiag;
/
Create Or Replace Procedure Zl_Third_Getallitems
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:根据（简码/名称/编码）获取诊疗项目（药品）
  --入参:Xml_In:
  --<IN>
  --    <SRNR></SRNR>     //输入内容
  --    <XB></XB>         //性别，男，女，其它等,空表示不区分性别
  --    <SRXG></SRXG>输入效果，0-其它, 1-全数字，2-全字母，3-包含汉字
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <XMLIST>
  --<LBID>   || 类别ID ||   </LBID>  ;
  --<ZLXMID>   || 诊疗项目ID ||   </ZLXMID>  ;
  --<SFXMID>   || 收费细目ID ||   </SFXMID>  ;
  --<LB>   || 类别 ||   </LB>  ;
  --<JB>   || 基本 ||   </JB>  ;
  --<BM>   || 编码 ||   </BM>  ;

  --<MC>   || 名称 ||   </MC>  ;
  --<SPM>   || 商品名 ||   </SPM>  ;
  --<JM>   || 简码 ||   </JM>  ;
  --<JSDW>   || 计算单位 ||   </JSDW>  ;
  --<GG>   || 规格 ||   </GG>  ;
  --<KC>   || 库存 ||   </KC>  ;

  --<CD>   || 产地 ||   </CD>  ;
  --<YPJX>   || 药品剂型 ||   </YPJX>  ;
  --<XMTX>   || 项目特性 ||   </XMTX>  ;
  --<FYLX>   || 费用类型 ||   </FYLX>  ;
  --<YBDL>   || 医保大类 ||   </YBDL>  ;
  --<SM>   || 说明 ||   </SM>  ;

  --<CFZWID>   || 处方职务ID ||   </CFZWID>  ;
  --<JG>   || 价格 ||   </JG>  ;
  --<KJDJ>   || 抗菌等级 ||   </KJDJ>  ;
  --<LCZGYID>   || 临床自管药id ||   </LCZGYID>  ;
  --<PC>   || 批次 ||   </PC></XMLIST>  ;*/

  --  </XMLIST>
  --  <XMLIST>
  --      ...
  --  </XMLIST>
  --  <ERROR>
  --    <MSG></MSG>  //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------

  --其它
  Cursor c_其它
  (
    码类_In Number,
    名称_In Varchar2,
    编码_In Varchar2,
    性别_In Varchar2
  ) Is
    Select /*+ rule*/
     Rownum As Keyid, a.类别id, a.诊疗项目id, a.收费细目id, a.类别, a.基本, a.编码, a.名称, a.商品名, a.简码, a.计算单位, a.规格, a.库存, a.产地, a.药品剂型,
     a.项目特性, a.费用类型, a.医保大类, a.说明, a.处方职务id, a.价格, a.抗菌等级, a.临床自管药id, a.批次
    From (Select a.类别 As 类别id, e.Id As 诊疗项目id, a.Id As 收费细目id, f.名称 As 类别, c.基本药物 As 基本, a.编码, a.名称, a.商品名, a.简码, e.计算单位,
                  a.规格, a.产地, d.药品剂型, Null As 项目特性, a.费用类型, a.医保大类, a.说明, d.处方职务 As 处方职务id,
                  Decode(a.价格, Null, Decode(c.上次售价, Null, a.现价, c.上次售价), a.现价) * c.门诊包装 || '/' || c.门诊单位 As 价格, Null As 库存,
                  Decode(d.抗生素, 0, '', 1, '非限制使用', 2, '限制使用', 3, '特殊使用') As 抗菌等级, d.临床自管药 As 临床自管药id, Null As 批次
           From 药品规格 C, 药品特性 D, 诊疗项目目录 E, 收费项目类别 F,
                (Select a.Id, a.类别, a.编码, a.名称, a.商品名, a.简码, a.零售单位, a.零售包装, a.规格, a.产地, a.费用类型, a.医保大类, a.说明,
                         Sum(Decode(a.是否变价, 1, Null, b.现价)) As 价格, Sum(b.现价) As 现价
                  From 收费价目 B,
                       (Select a.Id, a.类别, a.编码, C2.名称, C1.名称 As 商品名, b.简码, a.计算单位 As 零售单位, 1 As 零售包装, a.规格, a.产地, a.费用类型,
                                Null As 医保大类, a.说明, a.是否变价
                         From 收费项目别名 B, 收费项目目录 A, 收费项目别名 C2, 收费项目别名 C1
                         Where a.Id = b.收费细目id And a.类别 In ('5', '6', '7') And a.Id = C1.收费细目id(+) And C1.码类(+) = 1 And
                               C1.性质(+) = 3 And a.Id = C2.收费细目id(+) And C2.码类(+) = 1 And C2.性质(+) = 1 And
                               (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                               (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3) And
                               (a.编码 Like 编码_In And b.码类 = 码类_In Or b.名称 Like 名称_In And b.码类 = 码类_In Or
                               b.简码 Like 名称_In And b.码类 In (码类_In, 3))) A
                  Where a.Id = b.收费细目id And Sysdate Between b.执行日期 + 0 And Nvl(b.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD'))
                  Group By a.Id, a.类别, a.编码, a.名称, a.商品名, a.简码, a.零售单位, a.零售包装, a.规格, a.产地, a.费用类型, a.医保大类, a.说明) A
           Where a.Id = c.药品id And c.药名id = d.药名id And d.药名id = e.Id And a.类别 = f.编码 And e.类别 In ('5', '6', '7') And
                 Instr(性别_In, ',' || Nvl(e.适用性别, 0) || ',') > 0 And
                 (e.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or e.撤档时间 Is Null) And e.服务对象 In (1, 3) And
                 Nvl(e.执行频率, 0) In (0, 1)
           Union All
           Select a.类别 As 类别id, a.Id As 诊疗项目id, -null As 收费细目id, d.名称 As 类别, Null As 基本, a.编码, b.名称, Null As 商品名, b.简码,
                  a.计算单位, a.标本部位 As 规格, Null As 产地, Null As 药品剂型,
                  Decode(a.类别, 'H', Decode(a.操作类型, '1', '护理等级', '护理常规'), 'E',
                          Decode(a.操作类型, '1', '过敏试验', '2', '给药途径', '3', '中药煎法', '4', '中药用法', '5', '特殊治疗', '6', '采集方法', '7',
                                  '配血方法', '8', '输血途径', Null), 'Z',
                          Decode(a.操作类型, '1', '留观', '2', '住院', '3', '转科', '4', '术后', '5', '出院', '6', '转院', '7', '会诊', '8',
                                  '抢救', '9', '病重', '10', '病危', '11', '死亡', '12', '记录入出量', '14', '术前', Null), a.操作类型) As 项目特性,
                  Null As 费用类型, Null As 医保大类, Null As 说明, Null As 处方职务id, Null As 价格, Null As 库存, Null As 抗菌等级,
                  Null As 临床自管药id, Null As 批次
           From 诊疗项目类别 D, 诊疗项目别名 B, 诊疗项目目录 A
           Where a.Id = b.诊疗项目id And a.类别 = d.编码 And a.类别 Not In ('4', '5', '6', '7') And a.类别 <> '9' And
                 Nvl(a.单独应用, 0) = 1 And Instr(性别_In, ',' || Nvl(a.适用性别, 0) || ',') > 0 And Nvl(a.执行频率, 0) In (0, 1) And
                 (a.编码 Like 编码_In Or b.名称 Like 名称_In Or b.简码 Like 名称_In) And b.码类 = 码类_In And
                 (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And (a.站点 = '-' Or a.站点 Is Null) And
                 a.服务对象 In (1, 3)
           Union All
           Select a.类别 As 类别id, e.Id As 诊疗项目id, a.Id As 收费细目id, f.名称 As 类别, Null As 基本, a.编码, a.名称, Null As 商品名, a.简码,
                  a.计算单位, a.规格, a.产地, Null As 药品剂型, Null As 项目特性, a.费用类型, a.医保大类, a.说明, Null As 处方职务id,
                  Decode(a.价格, Null, Decode(c.上次售价, Null, a.现价, c.上次售价), a.现价) || '/' || a.计算单位 As 价格, Null As 库存,
                  Null As 抗菌等级, Null As 临床自管药id, a.批次
           From 材料特性 C, 诊疗项目目录 E, 收费项目类别 F,
                (Select a.Id, a.类别, a.编码, a.名称, a.简码, a.计算单位, a.规格, a.产地, a.费用类型, a.医保大类, a.说明,
                         Sum(Decode(a.是否变价, 1, Null, b.现价)) As 价格, Sum(b.现价) As 现价, Null As 批次
                  From 收费价目 B,
                       (Select a.Id, a.类别, a.编码, b.名称, b.简码, a.计算单位, a.规格, a.产地, a.费用类型, Null As 医保大类, a.说明, a.是否变价,
                                Null As 批次
                         From 收费项目别名 B, 收费项目目录 A
                         Where a.Id = b.收费细目id And a.类别 = '4' And
                               (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                               (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3) And
                               (a.编码 Like 编码_In Or b.名称 Like 名称_In Or b.简码 Like 名称_In) And b.码类 = 码类_In) A
                  Where a.Id = b.收费细目id And Sysdate Between b.执行日期 + 0 And Nvl(b.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD'))
                  Group By a.Id, a.类别, a.编码, a.名称, a.简码, a.计算单位, a.规格, a.产地, a.费用类型, a.医保大类, a.说明) A
           Where a.Id = c.材料id And c.诊疗id = e.Id And a.类别 = f.编码 And e.类别 = '4' And
                 Instr(性别_In, ',' || Nvl(e.适用性别, 0) || ',') > 0 And c.核算材料 = 0 And
                 (e.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or e.撤档时间 Is Null) And e.服务对象 In (1, 3) And
                 Nvl(e.执行频率, 0) In (0, 1)) A
    Order By Decode(类别id, '4', 'Z', 类别id), 类别, 编码;

  --全数字
  Cursor c_数字
  (
    码类_In Number,
    名称_In Varchar2,
    编码_In Varchar2,
    性别_In Varchar2
  ) Is
    Select /*+ rule*/
     Rownum As Keyid, a.类别id, a.诊疗项目id, a.收费细目id, a.类别, a.基本, a.编码, a.名称, a.商品名, a.简码, a.计算单位, a.规格, a.库存, a.产地, a.药品剂型,
     a.项目特性, a.费用类型, a.医保大类, a.说明, a.处方职务id, a.价格, a.抗菌等级, a.临床自管药id, a.批次
    From (Select a.类别 As 类别id, e.Id As 诊疗项目id, a.Id As 收费细目id, f.名称 As 类别, c.基本药物 As 基本, a.编码, a.名称, a.商品名, a.简码, e.计算单位,
                  a.规格, a.产地, d.药品剂型, Null As 项目特性, a.费用类型, a.医保大类, a.说明, d.处方职务 As 处方职务id,
                  Decode(a.价格, Null, Decode(c.上次售价, Null, a.现价, c.上次售价), a.现价) * c.门诊包装 || '/' || c.门诊单位 As 价格, Null As 库存,
                  Decode(d.抗生素, 0, '', 1, '非限制使用', 2, '限制使用', 3, '特殊使用') As 抗菌等级, d.临床自管药 As 临床自管药id, Null As 批次
           From 药品规格 C, 药品特性 D, 诊疗项目目录 E, 收费项目类别 F,
                (Select a.Id, a.类别, a.编码, a.名称, a.商品名, a.简码, a.零售单位, a.零售包装, a.规格, a.产地, a.费用类型, a.医保大类, a.说明,
                         Sum(Decode(a.是否变价, 1, Null, b.现价)) As 价格, Sum(b.现价) As 现价
                  From 收费价目 B,
                       (Select a.Id, a.类别, a.编码, C2.名称, C1.名称 As 商品名, b.简码, a.计算单位 As 零售单位, 1 As 零售包装, a.规格, a.产地, a.费用类型,
                                Null As 医保大类, a.说明, a.是否变价
                         From 收费项目别名 B, 收费项目目录 A, 收费项目别名 C2, 收费项目别名 C1
                         Where a.Id = b.收费细目id And a.类别 In ('5', '6', '7') And a.Id = C1.收费细目id(+) And C1.码类(+) = 1 And
                               C1.性质(+) = 3 And a.Id = C2.收费细目id(+) And C2.码类(+) = 1 And C2.性质(+) = 1 And
                               (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                               (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3) And
                               (a.编码 Like 编码_In And b.码类 = 码类_In Or b.简码 Like 名称_In And b.码类 = 3)) A
                  Where a.Id = b.收费细目id And Sysdate Between b.执行日期 + 0 And Nvl(b.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD'))
                  Group By a.Id, a.类别, a.编码, a.名称, a.商品名, a.简码, a.零售单位, a.零售包装, a.规格, a.产地, a.费用类型, a.医保大类, a.说明) A
           Where a.Id = c.药品id And c.药名id = d.药名id And d.药名id = e.Id And a.类别 = f.编码 And e.类别 In ('5', '6', '7') And
                 Instr(性别_In, ',' || Nvl(e.适用性别, 0) || ',') > 0 And
                 (e.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or e.撤档时间 Is Null) And e.服务对象 In (1, 3) And
                 Nvl(e.执行频率, 0) In (0, 1)
           Union All
           Select a.类别 As 类别id, a.Id As 诊疗项目id, -null As 收费细目id, d.名称 As 类别, Null As 基本, a.编码, b.名称, Null As 商品名, b.简码,
                  a.计算单位, a.标本部位 As 规格, Null As 产地, Null As 药品剂型,
                  Decode(a.类别, 'H', Decode(a.操作类型, '1', '护理等级', '护理常规'), 'E',
                          Decode(a.操作类型, '1', '过敏试验', '2', '给药途径', '3', '中药煎法', '4', '中药用法', '5', '特殊治疗', '6', '采集方法', '7',
                                  '配血方法', '8', '输血途径', Null), 'Z',
                          Decode(a.操作类型, '1', '留观', '2', '住院', '3', '转科', '4', '术后', '5', '出院', '6', '转院', '7', '会诊', '8',
                                  '抢救', '9', '病重', '10', '病危', '11', '死亡', '12', '记录入出量', '14', '术前', Null), a.操作类型) As 项目特性,
                  Null As 费用类型, Null As 医保大类, Null As 说明, Null As 处方职务id, Null As 价格, Null As 库存, Null As 抗菌等级,
                  Null As 临床自管药id, Null As 批次
           From 诊疗项目类别 D, 诊疗项目别名 B, 诊疗项目目录 A
           Where a.Id = b.诊疗项目id And a.类别 = d.编码 And a.类别 Not In ('4', '5', '6', '7') And a.类别 <> '9' And
                 Nvl(a.单独应用, 0) = 1 And Instr(性别_In, ',' || Nvl(a.适用性别, 0) || ',') > 0 And Nvl(a.执行频率, 0) In (0, 1) And
                 a.编码 Like 编码_In And b.码类 = 码类_In And (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                 (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3)
           Union All
           Select a.类别 As 类别id, e.Id As 诊疗项目id, a.Id As 收费细目id, f.名称 As 类别, Null As 基本, a.编码, a.名称, Null As 商品名, a.简码,
                  a.计算单位, a.规格, a.产地, Null As 药品剂型, Null As 项目特性, a.费用类型, a.医保大类, a.说明, Null As 处方职务id,
                  Decode(a.价格, Null, Decode(c.上次售价, Null, a.现价, c.上次售价), a.现价) || '/' || a.计算单位 As 价格, Null As 库存,
                  Null As 抗菌等级, Null As 临床自管药id, a.批次
           From 材料特性 C, 诊疗项目目录 E, 收费项目类别 F,
                (Select a.Id, a.类别, a.编码, a.名称, a.简码, a.计算单位, a.规格, a.产地, a.费用类型, a.医保大类, a.说明,
                         Sum(Decode(a.是否变价, 1, Null, b.现价)) As 价格, Sum(b.现价) As 现价, Null As 批次
                  From 收费价目 B,
                       (Select a.Id, a.类别, a.编码, b.名称, b.简码, a.计算单位, a.规格, a.产地, a.费用类型, Null As 医保大类, a.说明, a.是否变价,
                                Null As 批次
                         From 收费项目别名 B, 收费项目目录 A
                         Where a.Id = b.收费细目id And a.类别 = '4' And
                               (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                               (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3) And (a.编码 Like 编码_In) And b.码类 = 码类_In) A
                  Where a.Id = b.收费细目id And Sysdate Between b.执行日期 + 0 And Nvl(b.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD'))
                  Group By a.Id, a.类别, a.编码, a.名称, a.简码, a.计算单位, a.规格, a.产地, a.费用类型, a.医保大类, a.说明) A
           Where a.Id = c.材料id And c.诊疗id = e.Id And a.类别 = f.编码 And e.类别 = '4' And
                 Instr(性别_In, ',' || Nvl(e.适用性别, 0) || ',') > 0 And c.核算材料 = 0 And
                 (e.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or e.撤档时间 Is Null) And e.服务对象 In (1, 3) And
                 Nvl(e.执行频率, 0) In (0, 1)) A
    Order By Decode(类别id, '4', 'Z', 类别id), 类别, 编码;

  --全字母
  Cursor c_字母
  (
    码类_In Number,
    名称_In Varchar2,
    编码_In Varchar2,
    性别_In Varchar2
  ) Is
    Select /*+ rule*/
     Rownum As Keyid, a.类别id, a.诊疗项目id, a.收费细目id, a.类别, a.基本, a.编码, a.名称, a.商品名, a.简码, a.计算单位, a.规格, a.库存, a.产地, a.药品剂型,
     a.项目特性, a.费用类型, a.医保大类, a.说明, a.处方职务id, a.价格, a.抗菌等级, a.临床自管药id, a.批次
    From (Select a.类别 As 类别id, e.Id As 诊疗项目id, a.Id As 收费细目id, f.名称 As 类别, c.基本药物 As 基本, a.编码, a.名称, a.商品名, a.简码, e.计算单位,
                  a.规格, a.产地, d.药品剂型, Null As 项目特性, a.费用类型, a.医保大类, a.说明, d.处方职务 As 处方职务id,
                  Decode(a.价格, Null, Decode(c.上次售价, Null, a.现价, c.上次售价), a.现价) * c.门诊包装 || '/' || c.门诊单位 As 价格, Null As 库存,
                  Decode(d.抗生素, 0, '', 1, '非限制使用', 2, '限制使用', 3, '特殊使用') As 抗菌等级, d.临床自管药 As 临床自管药id, Null As 批次
           From 药品规格 C, 药品特性 D, 诊疗项目目录 E, 收费项目类别 F,
                (Select a.Id, a.类别, a.编码, a.名称, a.商品名, a.简码, a.零售单位, a.零售包装, a.规格, a.产地, a.费用类型, a.医保大类, a.说明,
                         Sum(Decode(a.是否变价, 1, Null, b.现价)) As 价格, Sum(b.现价) As 现价
                  From 收费价目 B,
                       (Select a.Id, a.类别, a.编码, C2.名称, C1.名称 As 商品名, b.简码, a.计算单位 As 零售单位, 1 As 零售包装, a.规格, a.产地, a.费用类型,
                                Null As 医保大类, a.说明, a.是否变价
                         From 收费项目别名 B, 收费项目目录 A, 收费项目别名 C2, 收费项目别名 C1
                         Where a.Id = b.收费细目id And a.类别 In ('5', '6', '7') And a.Id = C1.收费细目id(+) And C1.码类(+) = 1 And
                               C1.性质(+) = 3 And a.Id = C2.收费细目id(+) And C2.码类(+) = 1 And C2.性质(+) = 1 And
                               (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                               (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3) And b.简码 Like 名称_In And b.码类 = 码类_In) A
                  Where a.Id = b.收费细目id And Sysdate Between b.执行日期 + 0 And Nvl(b.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD'))
                  Group By a.Id, a.类别, a.编码, a.名称, a.商品名, a.简码, a.零售单位, a.零售包装, a.规格, a.产地, a.费用类型, a.医保大类, a.说明) A
           Where a.Id = c.药品id And c.药名id = d.药名id And d.药名id = e.Id And a.类别 = f.编码 And e.类别 In ('5', '6', '7') And
                 Instr(性别_In, ',' || Nvl(e.适用性别, 0) || ',') > 0 And
                 (e.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or e.撤档时间 Is Null) And e.服务对象 In (1, 3) And
                 Nvl(e.执行频率, 0) In (0, 1)
           Union All
           Select a.类别 As 类别id, a.Id As 诊疗项目id, -null As 收费细目id, d.名称 As 类别, Null As 基本, a.编码, b.名称, Null As 商品名, b.简码,
                  a.计算单位, a.标本部位 As 规格, Null As 产地, Null As 药品剂型,
                  Decode(a.类别, 'H', Decode(a.操作类型, '1', '护理等级', '护理常规'), 'E',
                          Decode(a.操作类型, '1', '过敏试验', '2', '给药途径', '3', '中药煎法', '4', '中药用法', '5', '特殊治疗', '6', '采集方法', '7',
                                  '配血方法', '8', '输血途径', Null), 'Z',
                          Decode(a.操作类型, '1', '留观', '2', '住院', '3', '转科', '4', '术后', '5', '出院', '6', '转院', '7', '会诊', '8',
                                  '抢救', '9', '病重', '10', '病危', '11', '死亡', '12', '记录入出量', '14', '术前', Null), a.操作类型) As 项目特性,
                  Null As 费用类型, Null As 医保大类, Null As 说明, Null As 处方职务id, Null As 价格, Null As 库存, Null As 抗菌等级,
                  Null As 临床自管药id, Null As 批次
           From 诊疗项目类别 D, 诊疗项目别名 B, 诊疗项目目录 A
           Where a.Id = b.诊疗项目id And a.类别 = d.编码 And a.类别 Not In ('4', '5', '6', '7') And a.类别 <> '9' And
                 Nvl(a.单独应用, 0) = 1 And Instr(性别_In, ',' || Nvl(a.适用性别, 0) || ',') > 0 And Nvl(a.执行频率, 0) In (0, 1) And
                 b.简码 Like 名称_In And b.码类 = 码类_In And (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                 (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3)
           Union All
           Select a.类别 As 类别id, e.Id As 诊疗项目id, a.Id As 收费细目id, f.名称 As 类别, Null As 基本, a.编码, a.名称, Null As 商品名, a.简码,
                  a.计算单位, a.规格, a.产地, Null As 药品剂型, Null As 项目特性, a.费用类型, a.医保大类, a.说明, Null As 处方职务id,
                  Decode(a.价格, Null, Decode(c.上次售价, Null, a.现价, c.上次售价), a.现价) || '/' || a.计算单位 As 价格, Null As 库存,
                  Null As 抗菌等级, Null As 临床自管药id, a.批次
           From 材料特性 C, 诊疗项目目录 E, 收费项目类别 F,
                (Select a.Id, a.类别, a.编码, a.名称, a.简码, a.计算单位, a.规格, a.产地, a.费用类型, a.医保大类, a.说明,
                         Sum(Decode(a.是否变价, 1, Null, b.现价)) As 价格, Sum(b.现价) As 现价, Null As 批次
                  From 收费价目 B,
                       (Select a.Id, a.类别, a.编码, b.名称, b.简码, a.计算单位, a.规格, a.产地, a.费用类型, Null As 医保大类, a.说明, a.是否变价,
                                Null As 批次
                         From 收费项目别名 B, 收费项目目录 A
                         Where a.Id = b.收费细目id And a.类别 = '4' And
                               (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                               (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3) And (b.简码 Like 名称_In) And b.码类 = 码类_In) A
                  Where a.Id = b.收费细目id And Sysdate Between b.执行日期 + 0 And Nvl(b.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD'))
                  Group By a.Id, a.类别, a.编码, a.名称, a.简码, a.计算单位, a.规格, a.产地, a.费用类型, a.医保大类, a.说明) A
           Where a.Id = c.材料id And c.诊疗id = e.Id And a.类别 = f.编码 And e.类别 = '4' And
                 Instr(性别_In, ',' || Nvl(e.适用性别, 0) || ',') > 0 And c.核算材料 = 0 And
                 (e.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or e.撤档时间 Is Null) And e.服务对象 In (1, 3) And
                 Nvl(e.执行频率, 0) In (0, 1)) A
    Order By Decode(类别id, '4', 'Z', 类别id), 类别, 编码;

  --有汉字
  Cursor c_汉字
  (
    码类_In Number,
    名称_In Varchar2,
    编码_In Varchar2,
    性别_In Varchar2
  ) Is
    Select /*+ rule*/
     Rownum As Keyid, a.类别id, a.诊疗项目id, a.收费细目id, a.类别, a.基本, a.编码, a.名称, a.商品名, a.简码, a.计算单位, a.规格, a.库存, a.产地, a.药品剂型,
     a.项目特性, a.费用类型, a.医保大类, a.说明, a.处方职务id, a.价格, a.抗菌等级, a.临床自管药id, a.批次
    From (Select a.类别 As 类别id, e.Id As 诊疗项目id, a.Id As 收费细目id, f.名称 As 类别, c.基本药物 As 基本, a.编码, a.名称, a.商品名, a.简码, e.计算单位,
                  a.规格, a.产地, d.药品剂型, Null As 项目特性, a.费用类型, a.医保大类, a.说明, d.处方职务 As 处方职务id,
                  Decode(a.价格, Null, Decode(c.上次售价, Null, a.现价, c.上次售价), a.现价) * c.门诊包装 || '/' || c.门诊单位 As 价格, Null As 库存,
                  Decode(d.抗生素, 0, '', 1, '非限制使用', 2, '限制使用', 3, '特殊使用') As 抗菌等级, d.临床自管药 As 临床自管药id, Null As 批次
           From 药品规格 C, 药品特性 D, 诊疗项目目录 E, 收费项目类别 F,
                (Select a.Id, a.类别, a.编码, a.名称, a.商品名, a.简码, a.零售单位, a.零售包装, a.规格, a.产地, a.费用类型, a.医保大类, a.说明,
                         Sum(Decode(a.是否变价, 1, Null, b.现价)) As 价格, Sum(b.现价) As 现价
                  From 收费价目 B,
                       (Select a.Id, a.类别, a.编码, C2.名称, C1.名称 As 商品名, b.简码, a.计算单位 As 零售单位, 1 As 零售包装, a.规格, a.产地, a.费用类型,
                                Null As 医保大类, a.说明, a.是否变价
                         From 收费项目别名 B, 收费项目目录 A, 收费项目别名 C2, 收费项目别名 C1
                         Where a.Id = b.收费细目id And a.类别 In ('5', '6', '7') And a.Id = C1.收费细目id(+) And C1.码类(+) = 1 And
                               C1.性质(+) = 3 And a.Id = C2.收费细目id(+) And C2.码类(+) = 1 And C2.性质(+) = 1 And
                               (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                               (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3) And b.名称 Like 名称_In And b.码类 = 码类_In) A
                  Where a.Id = b.收费细目id And Sysdate Between b.执行日期 + 0 And Nvl(b.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD'))
                  Group By a.Id, a.类别, a.编码, a.名称, a.商品名, a.简码, a.零售单位, a.零售包装, a.规格, a.产地, a.费用类型, a.医保大类, a.说明) A
           Where a.Id = c.药品id And c.药名id = d.药名id And d.药名id = e.Id And a.类别 = f.编码 And e.类别 In ('5', '6', '7') And
                 Instr(性别_In, ',' || Nvl(e.适用性别, 0) || ',') > 0 And
                 (e.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or e.撤档时间 Is Null) And e.服务对象 In (1, 3) And
                 Nvl(e.执行频率, 0) In (0, 1)
           Union All
           Select a.类别 As 类别id, a.Id As 诊疗项目id, -null As 收费细目id, d.名称 As 类别, Null As 基本, a.编码, b.名称, Null As 商品名, b.简码,
                  a.计算单位, a.标本部位 As 规格, Null As 产地, Null As 药品剂型,
                  Decode(a.类别, 'H', Decode(a.操作类型, '1', '护理等级', '护理常规'), 'E',
                          Decode(a.操作类型, '1', '过敏试验', '2', '给药途径', '3', '中药煎法', '4', '中药用法', '5', '特殊治疗', '6', '采集方法', '7',
                                  '配血方法', '8', '输血途径', Null), 'Z',
                          Decode(a.操作类型, '1', '留观', '2', '住院', '3', '转科', '4', '术后', '5', '出院', '6', '转院', '7', '会诊', '8',
                                  '抢救', '9', '病重', '10', '病危', '11', '死亡', '12', '记录入出量', '14', '术前', Null), a.操作类型) As 项目特性,
                  Null As 费用类型, Null As 医保大类, Null As 说明, Null As 处方职务id, Null As 价格, Null As 库存, Null As 抗菌等级,
                  Null As 临床自管药id, Null As 批次
           From 诊疗项目类别 D, 诊疗项目别名 B, 诊疗项目目录 A
           Where a.Id = b.诊疗项目id And a.类别 = d.编码 And a.类别 Not In ('4', '5', '6', '7') And a.类别 <> '9' And
                 Nvl(a.单独应用, 0) = 1 And Instr(性别_In, ',' || Nvl(a.适用性别, 0) || ',') > 0 And Nvl(a.执行频率, 0) In (0, 1) And
                 b.名称 Like 名称_In And b.码类 = 码类_In And (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                 (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3)
           Union All
           Select a.类别 As 类别id, e.Id As 诊疗项目id, a.Id As 收费细目id, f.名称 As 类别, Null As 基本, a.编码, a.名称, Null As 商品名, a.简码,
                  a.计算单位, a.规格, a.产地, Null As 药品剂型, Null As 项目特性, a.费用类型, a.医保大类, a.说明, Null As 处方职务id,
                  Decode(a.价格, Null, Decode(c.上次售价, Null, a.现价, c.上次售价), a.现价) || '/' || a.计算单位 As 价格, Null As 库存,
                  Null As 抗菌等级, Null As 临床自管药id, a.批次
           From 材料特性 C, 诊疗项目目录 E, 收费项目类别 F,
                (Select a.Id, a.类别, a.编码, a.名称, a.简码, a.计算单位, a.规格, a.产地, a.费用类型, a.医保大类, a.说明,
                         Sum(Decode(a.是否变价, 1, Null, b.现价)) As 价格, Sum(b.现价) As 现价, Null As 批次
                  From 收费价目 B,
                       (Select a.Id, a.类别, a.编码, b.名称, b.简码, a.计算单位, a.规格, a.产地, a.费用类型, Null As 医保大类, a.说明, a.是否变价,
                                Null As 批次
                         From 收费项目别名 B, 收费项目目录 A
                         Where a.Id = b.收费细目id And a.类别 = '4' And
                               (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And
                               (a.站点 = '-' Or a.站点 Is Null) And a.服务对象 In (1, 3) And b.名称 Like 名称_In And b.码类 = 码类_In) A
                  Where a.Id = b.收费细目id And Sysdate Between b.执行日期 + 0 And Nvl(b.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD'))
                  Group By a.Id, a.类别, a.编码, a.名称, a.简码, a.计算单位, a.规格, a.产地, a.费用类型, a.医保大类, a.说明) A
           Where a.Id = c.材料id And c.诊疗id = e.Id And a.类别 = f.编码 And e.类别 = '4' And
                 Instr(性别_In, ',' || Nvl(e.适用性别, 0) || ',') > 0 And c.核算材料 = 0 And
                 (e.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or e.撤档时间 Is Null) And e.服务对象 In (1, 3) And
                 Nvl(e.执行频率, 0) In (0, 1)) A
    Order By Decode(类别id, '4', 'Z', 类别id), 类别, 编码;

  r_Item c_汉字%RowType;

  v_Temp    Varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML 

  n_码类     Number(3);
  v_性别     Varchar2(20);
  v_输入内容 Varchar2(2000); --外部传入
  n_输入效果 Number; --0-其它, 1-全数字，2-全字母，3-包含汉字

  --被忽略的参数   -- 不显示库存列,不显示成套项目

  --Mstrlike         Varchar2(200); --参数  输入匹配 固定为左匹配
  --Mlng西药房       Number(18); --参数缺省库房
  --Mlng成药房       Number(18);
  --Mlng中药房       Number(18);
  --Mstr可用西药房   Varchar2(30000);
  --Mstr可用成药房   Varchar2(30000);
  --Mstr可用中药房   Varchar2(30000);
  --Mlng发料部门     Number(18);
  --Mint险类         Number; --病人相关 
  --Mint简码         Number(18); --参数  简码方式 0-拼音,1-五笔,固定为拼音 
  --Gstrmatchmode    Varchar2(200); --参数 44号系统参数 收费项目输入简码匹配方式:10.输入全是数字时只匹配编码  01.输入全是字母时只匹配简码,11两者均要求,固定为 11 
  --Gblnstock        Boolean; --参数 指定药房时限制库存  18号系统参数,固定为 False  
  --Gbyt输入药品显示 Number; --参数 "输入药品显示" 0-按输入匹配显示，1-固定显示通用名和商品名,固定为1

  Procedure p_Additem Is
  Begin
    v_Temp := '<XMLIST><LBID>' || r_Item.类别id || '</LBID>';
    v_Temp := v_Temp || '<ZLXMID>' || r_Item.诊疗项目id || '</ZLXMID>';
    v_Temp := v_Temp || '<SFXMID>' || r_Item.收费细目id || '</SFXMID>';
    v_Temp := v_Temp || '<LB>' || r_Item.类别 || '</LB>';
    v_Temp := v_Temp || '<JB>' || r_Item.基本 || '</JB>';
    v_Temp := v_Temp || '<BM>' || r_Item.编码 || '</BM>';
    v_Temp := v_Temp || '<MC>' || r_Item.名称 || '</MC>';
    v_Temp := v_Temp || '<SPM>' || r_Item.商品名 || '</SPM>';
    v_Temp := v_Temp || '<JM>' || r_Item.简码 || '</JM>';
    v_Temp := v_Temp || '<JSDW>' || r_Item.计算单位 || '</JSDW>';
    v_Temp := v_Temp || '<GG>' || r_Item.规格 || '</GG>';
    v_Temp := v_Temp || '<KC>' || r_Item.库存 || '</KC>';
  
    v_Temp := v_Temp || '<CD>' || r_Item.产地 || '</CD>';
    v_Temp := v_Temp || '<YPJX>' || r_Item.药品剂型 || '</YPJX>';
    v_Temp := v_Temp || '<XMTX>' || r_Item.项目特性 || '</XMTX>';
    v_Temp := v_Temp || '<FYLX>' || r_Item.费用类型 || '</FYLX>';
    v_Temp := v_Temp || '<YBDL>' || r_Item.医保大类 || '</YBDL>';
    v_Temp := v_Temp || '<SM>' || r_Item.说明 || '</SM>';
  
    v_Temp := v_Temp || '<CFZWID>' || r_Item.处方职务id || '</CFZWID>';
    v_Temp := v_Temp || '<JG>' || r_Item.价格 || '</JG>';
    v_Temp := v_Temp || '<KJDJ>' || r_Item.抗菌等级 || '</KJDJ>';
    v_Temp := v_Temp || '<LCZGYID>' || r_Item.临床自管药id || '</LCZGYID>';
    v_Temp := v_Temp || '<PC>' || r_Item.批次 || '</PC></XMLIST>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End;
Begin
  Select Extractvalue(Value(A), 'IN/XB'), Extractvalue(Value(A), 'IN/SRXG'), Upper(Extractvalue(Value(A), 'IN/SRNR'))
  Into v_性别, n_输入效果, v_输入内容
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  n_码类 := 1;
  If Instr(v_性别, '男') > 0 Then
    v_性别 := '0,1';
  Elsif Instr(v_性别, '男') > 0 Then
    v_性别 := '0,2';
  Elsif v_性别 Is Null Then
    v_性别 := '0,1,2';
  Else
    v_性别 := '0';
  End If;
  v_性别 := ',' || v_性别 || ',';

  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  --0-其它, 1-全数字，2-全字母，3-包含汉字
  If v_输入内容 Is Not Null Then
    If n_输入效果 = 0 Then
      Open c_其它(n_码类, '%' || v_输入内容 || '%', v_输入内容 || '%', v_性别);
      Loop
        Fetch c_其它
          Into r_Item;
        Exit When c_其它%NotFound;
        p_Additem;
      End Loop;
      Close c_其它;
    Elsif n_输入效果 = 1 Then
      Open c_数字(n_码类, '%' || v_输入内容 || '%', v_输入内容 || '%', v_性别);
      Loop
        Fetch c_数字
          Into r_Item;
        Exit When c_数字%NotFound;
        p_Additem;
      End Loop;
      Close c_数字;
    Elsif n_输入效果 = 2 Then
      Open c_字母(n_码类, '%' || v_输入内容 || '%', v_输入内容 || '%', v_性别);
      Loop
        Fetch c_字母
          Into r_Item;
        Exit When c_字母%NotFound;
        p_Additem;
      End Loop;
      Close c_字母;
    Elsif n_输入效果 = 3 Then
      Open c_其它(n_码类, '%' || v_输入内容 || '%', v_输入内容 || '%', v_性别);
      Loop
        Fetch c_其它
          Into r_Item;
        Exit When c_其它%NotFound;
        p_Additem;
      End Loop;
      Close c_其它;
    End If;
  End If;
  Xml_Out := x_Templet;
Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
	zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getallitems;
/
Create Or Replace Procedure Zl_Third_Getpersonnelinfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取人员基本信息
  --入参:Xml_In:
  --<IN>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <YRLIST>
  --    <RYID></RYID>     //人员ID
  --    <XM></XM>         //姓名
  --    <JM></JM>         //简码
  --    <SFZH></SFZH>     //身份证号
  --    <CSRQ></CSRQ>     //出生日期
  --    <XB></XB>         //性别
  --    <MZ></MZ>         //民族
  --    <XL></XL>         //学历
  --    <DH></DH>         //电话
  --    <SJ></SJ>         //手机
  --    <YX></YX>         //邮箱
  --    <ZJ></ZJ>         //职级
  --    <ZW></ZW>         //职务
  --    <CDSJ></CDSJ>     //撤档时间
  --  </YRLIST>
  --  <YRLIST>
  --      ...
  --  </YRLIST>
  --  <ERROR>
  --    <MSG></MSG>       //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  Cursor c_Detail Is
    Select a.Id As 人员id, a.姓名, a.简码, a.身份证号, a.出生日期, a.性别, a.民族, a.学历, a.办公室电话 As 电话, a.移动电话 As 手机, a.电子邮件 As 邮箱,
           a.管理职务 As 职务, Nvl(a.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) As 撤档时间
    From 人员表 A;

  x_Templet Xmltype; --模板XML
  v_Temp    varchar2(32767);
  r_Detail  c_Detail%RowType;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For r_Detail In c_Detail Loop
    v_Temp := '<YRLIST><RYID>' || r_Detail.人员id || '</RYID>';
    v_Temp := v_Temp || '<XM>' || r_Detail.姓名 || '</XM>';
    v_Temp := v_Temp || '<JM>' || r_Detail.简码 || '</JM>';
    v_Temp := v_Temp || '<SFZH>' || r_Detail.身份证号 || '</SFZH>';
    v_Temp := v_Temp || '<CSRQ>' || To_Char(r_Detail.出生日期, 'yyyy-mm-dd') || '</CSRQ>';
    v_Temp := v_Temp || '<XB>' || r_Detail.性别 || '</XB>';
    v_Temp := v_Temp || '<MZ>' || r_Detail.民族 || '</MZ>';
    v_Temp := v_Temp || '<XL>' || r_Detail.学历 || '</XL>';
    v_Temp := v_Temp || '<DH>' || r_Detail.电话 || '</DH>';
    v_Temp := v_Temp || '<SJ>' || r_Detail.手机 || '</SJ>';
    v_Temp := v_Temp || '<YX>' || r_Detail.邮箱 || '</YX>';
    v_Temp := v_Temp || '<ZJ>' || '</ZJ>';
    v_Temp := v_Temp || '<ZW>' || r_Detail.职务 || '</ZW>';
    v_Temp := v_Temp || '<CDSJ>' || To_Char(r_Detail.撤档时间, 'yyyy-mm-dd hh24:mi:ss') || '</CDSJ></YRLIST>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
End Zl_Third_Getpersonnelinfo;
/
Create Or Replace Procedure Zl_Third_Getpersonaccount
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取人员基本信息
  --入参:Xml_In:
  --<IN>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <YRLIST>
  --    <RYID></RYID>     //人员ID
  --    <ZLZH></ZLZH>     //登录帐号
  --  </YRLIST>
  --  <YRLIST>
  --      ...
  --  </YRLIST>
  --  <ERROR>
  --    <MSG></MSG>       //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  Cursor c_Detail Is
    Select 用户名, 人员id From 上机人员表 Order By 人员id;

  x_Templet Xmltype; --模板XML
  v_Temp    varchar2(32767);
  r_Detail  c_Detail%RowType;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For r_Detail In c_Detail Loop
    v_Temp := '<YRLIST><RYID>' || r_Detail.人员id || '</RYID>';
    v_Temp := v_Temp || '<ZLZH>' || r_Detail.用户名 || '</ZLZH></YRLIST>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
End Zl_Third_Getpersonaccount;
/
Create Or Replace Procedure Zl_Third_Getdeptinfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取所有部门信息
  --入参:Xml_In:
  --<IN>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <BMLIST>
  --    <ID></ID>         //ID
  --    <SJID></SJID>     //上级ID
  --    <BM></BM>         //编码
  --    <MC></MC>         //名称
  --    <JM></JM>         //简码
  --    <DH></DH>         //电话
  --    <SSJG></SSJG>     //所属机构
  --    <CDSJ></CDSJ>     //撤档时间
  --  </BMLIST>
  --  <BMLIST>
  --      ...
  --  </BMLIST>
  --  <ERROR>
  --    <MSG></MSG>  //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  Cursor c_Detail Is
    Select a.Id, a.上级id, a.编码, a.名称, a.简码, Nvl(a.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) As 撤档时间
    From 部门表 a;

  x_Templet Xmltype; --模板XML
  v_Temp    varchar2(32767);
  r_Detail  c_Detail%Rowtype;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For r_Detail In c_Detail Loop
    v_Temp := '<BMLIST><ID>' || r_Detail.Id || '</ID>';
    v_Temp := v_Temp || '<SJID>' || r_Detail.上级id || '</SJID>';
    v_Temp := v_Temp || '<BM>' || r_Detail.编码 || '</BM>';
    v_Temp := v_Temp || '<MC>' || r_Detail.名称 || '</MC>';
    v_Temp := v_Temp || '<JM>' || r_Detail.简码 || '</JM>';
    v_Temp := v_Temp || '<DH>' || '</DH>';
    v_Temp := v_Temp || '<SSJG>' || '</SSJG>';
    v_Temp := v_Temp || '<CDSJ>' || To_Char(r_Detail.撤档时间, 'yyyy-mm-dd hh24:mi:ss') || '</CDSJ></BMLIST>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || Sqlerrm || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
End Zl_Third_Getdeptinfo;
/
Create Or Replace Procedure Zl_Third_Getdeptpersoninfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取部门人员信息
  --入参:Xml_In:
  --<IN>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <GXLIST>
  --    <BMID></BMID>       //部门ID
  --    <RYID></RYID>       //人员ID
  --  </GXLIST>
  --  <GXLIST>
  --      ...
  --  </GXLIST>
  --  <ERROR>
  --    <MSG></MSG>  //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  Cursor c_Detail Is
    Select a.部门id, a.人员id From 部门人员 a;

  x_Templet Xmltype; --模板XML
  v_Temp    varchar2(32767);
  r_Detail  c_Detail%Rowtype;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For r_Detail In c_Detail Loop
    v_Temp := '<GXLIST><BMID>' || r_Detail.部门id || '</BMID>';
    v_Temp := v_Temp || '<RYID>' || r_Detail.人员id || '</RYID></GXLIST>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || Sqlerrm || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
End Zl_Third_Getdeptpersoninfo;
/
Create Or Replace Procedure Zl_Third_Getdiagnosistype
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取诊疗检查类型目录
  --入参:Xml_In:
  --<IN>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <ZLLIST>
  --    <BM></BM>         //编码
  --    <MC></MC>         //名称
  --    <JM></JM>         //简码
  --  </ZLLIST>
  --  <ZLLIST>
  --      ...
  --  </ZLLIST>
  --  <ERROR>
  --    <MSG></MSG>  //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  Cursor c_Detail Is
    Select a.编码, a.名称, a.简码 From 诊疗检查类型 a;

  x_Templet Xmltype; --模板XML
  v_Temp    varchar2(32767);
  r_Detail  c_Detail%Rowtype;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For r_Detail In c_Detail Loop
    v_Temp := '<ZLLIST><BM>' || r_Detail.编码 || '</BM>';
    v_Temp := v_Temp || '<MC>' || r_Detail.名称 || '</MC>';
    v_Temp := v_Temp || '<JM>' || r_Detail.简码 || '</JM></ZLLIST>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || Sqlerrm || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
End Zl_Third_Getdiagnosistype;
/
Create Or Replace Procedure Zl_Third_Getdiagnosisposition
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取诊疗检查部位信息
  --入参:Xml_In:
  --<IN>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <ZLLIST>
  --    <LX></LX>         //类型
  --    <BM></BM>         //编码
  --    <MC></MC>         //名称
  --    <FZ></FZ>         //分组
  --    <BZ></BZ>         //备注
  --    <FF></FF>         //方法
  --    <SYXB></SYXB>     //适用性别
  --  </ZLLIST>
  --  <ZLLIST>
  --      ...
  --  </ZLLIST>
  --  <ERROR>
  --    <MSG></MSG>  //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  Cursor c_Detail Is
    Select a.类型, a.编码, a.名称, a.分组, a.备注, a.方法, a.适用性别 From 诊疗检查部位 a;

  x_Templet Xmltype; --模板XML
  v_Temp    varchar2(32767);
  r_Detail  c_Detail%Rowtype;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For r_Detail In c_Detail Loop
    v_Temp := '<ZLLIST><LX>' || r_Detail.类型 || '</LX>';
    v_Temp := v_Temp || '<BM>' || r_Detail.编码 || '</BM>';
    v_Temp := v_Temp || '<MC>' || r_Detail.名称 || '</MC>';
    v_Temp := v_Temp || '<FZ>' || r_Detail.分组 || '</FZ>';
    v_Temp := v_Temp || '<BZ>' || r_Detail.备注 || '</BZ>';
    v_Temp := v_Temp || '<FF>' || r_Detail.方法 || '</FF>';
    v_Temp := v_Temp || '<SYXB>' || r_Detail.适用性别 || '</SYXB></ZLLIST>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || Sqlerrm || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
End Zl_Third_Getdiagnosisposition;
/
Create Or Replace Procedure Zl_Third_Getinspectionitem
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取所有检验项目信息
  --入参:Xml_In:
  --<IN>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <JYLIST>
  --    <ID></ID>         //ID
  --    <BM></BM>         //编码
  --    <MC></MC>         //名称
  --    <BBBW></BBBW>     //标本部位
  --    <JSDW></JSDW>     //计算单位
  --    <ZXKS></ZXKS>     //执行科室,格式: 执行科室,执行科室,执行科室...
  --    <CJXM></CJXM>     //采集项目(包含标本和执行科室),格式: 采集项目,采集标本!!采集科室,采集科室...|采集项目,采集标本!!采集科室,采集科室...
  --  </JYLIST>
  --  <JYLIST>
  --      ...
  --  </JYLIST>
  --  <ERROR>
  --    <MSG></MSG>  //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  Cursor c_Detail Is
    Select a.Id, a.编码, a.名称, a.标本部位, a.计算单位
    From 诊疗项目目录 A
    Where a.类别 = 'C' And (a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd') Or a.撤档时间 Is Null);

  --执行科室
  Cursor c_Exedept(项目id_In 诊疗执行科室.诊疗项目id%Type) Is
    Select Distinct 执行科室id From 诊疗执行科室 Where 诊疗项目id = 项目id_In;

  --采集项目
  Cursor c_Takeitem(项目id_In 诊疗执行科室.诊疗项目id%Type) Is
    Select a.Id, a.编码, a.名称, a.标本部位, a.计算单位
    From 诊疗项目目录 A, 诊疗用法用量 B
    Where a.Id = b.用法id And a.类别 = 'E' And a.操作类型 = '6' And b.项目id = 项目id_In;

  x_Templet      Xmltype; --模板XML
  v_Temp         Clob;
  r_Detail       c_Detail%RowType;
  r_Exedept      c_Exedept%RowType;
  r_Takeitem     c_Takeitem%RowType;
  v_Takeitem     varchar2(32767);
  v_Takeitemlist Clob;
  v_Exedept      Clob;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For r_Detail In c_Detail Loop
    v_Temp := '<JYLIST><ID>' || r_Detail.Id || '</ID>';
    v_Temp := v_Temp || '<BM>' || r_Detail.编码 || '</BM>';
    v_Temp := v_Temp || '<MC>' || r_Detail.名称 || '</MC>';
    v_Temp := v_Temp || '<BBBW>' || r_Detail.标本部位 || '</BBBW>';
    v_Temp := v_Temp || '<JSDW>' || r_Detail.计算单位 || '</JSDW>';
  
    --加入执行科室
    v_Exedept := Null;
    For r_Exedept In c_Exedept(r_Detail.Id) Loop
      If v_Exedept Is Null Then
        v_Exedept := '' || r_Exedept.执行科室id;
      Else
        v_Exedept := v_Exedept || ',' || r_Exedept.执行科室id;
      End If;
    End Loop;
    v_Temp := v_Temp || '<ZXKS>' || v_Exedept || '</ZXKS>';
  
    --加入采集项目，采集标本，采集科室
    v_Takeitemlist := Null;
    For r_Takeitem In c_Takeitem(r_Detail.Id) Loop
      v_Takeitem := r_Takeitem.名称 || ',' || r_Takeitem.标本部位;
    
      --采集科室
      v_Exedept := Null;
      For r_Exedept In c_Exedept(r_Takeitem.Id) Loop
        If v_Exedept Is Null Then
          v_Exedept := '' || r_Exedept.执行科室id;
        Else
          v_Exedept := v_Exedept || ',' || r_Exedept.执行科室id;
        End If;
      End Loop;
    
      If v_Takeitemlist Is Null Then
        v_Takeitemlist := v_Takeitem || '!!' || v_Exedept;
      Else
        v_Takeitemlist := v_Takeitemlist || '|' || v_Takeitem || '!!' || v_Exedept;
      End If;
    End Loop;
    v_Temp := v_Temp || '<CJXM>' || v_Takeitemlist || '</CJXM></JYLIST>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
End Zl_Third_Getinspectionitem;
/
Create Or Replace Procedure Zl_Third_Getcheckitem
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取所有检查项目信息
  --入参:Xml_In:
  --<IN>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <JCLIST>
  --    <ID></ID>         //ID
  --    <BM></BM>         //编码
  --    <MC></MC>         //名称
  --    <BBBW></BBBW>     //标本部位
  --    <JSDW></JSDW>     //计算单位
  --    <ZXKS></ZXKS>     //执行科室,格式: 执行科室,执行科室,执行科室...
  --    <JCBWFF></JCBWFF>  //检查部位和方法,格式: 检查部位!!检查方法,检查方法...|检查部位!!检查方法,检查方法...
  --  </JCLIST>
  --  <JCLIST>
  --      ...
  --  </JCLIST>
  --  <ERROR>
  --    <MSG></MSG>  //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  Cursor c_Detail Is
    Select a.Id, a.编码, a.名称, a.标本部位, a.计算单位
    From 诊疗项目目录 A
    Where a.类别 = 'D' And (a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd') Or a.撤档时间 Is Null);

  --检查部位和方法
  Cursor c_Checkpart(项目id_In 诊疗项目部位.项目id%Type) Is
    Select 部位, 方法 From 诊疗项目部位 Where 项目id = 项目id_In Order By 部位;

  --执行科室
  Cursor c_Exedept(项目id_In 诊疗执行科室.诊疗项目id%Type) Is
    Select Distinct 执行科室id From 诊疗执行科室 Where 诊疗项目id = 项目id_In;

  x_Templet       Xmltype; --模板XML
  v_Temp          Clob;
  r_Detail        c_Detail%RowType;
  r_Checkpart     c_Checkpart%RowType;
  r_Exedept       c_Exedept%RowType;
  v_Partandmethod varchar2(32767);
  v_Part          varchar2(32767);
  v_Exedept       Clob;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For r_Detail In c_Detail Loop
    v_Temp := '<JCLIST><ID>' || r_Detail.Id || '</ID>';
    v_Temp := v_Temp || '<BM>' || r_Detail.编码 || '</BM>';
    v_Temp := v_Temp || '<MC>' || r_Detail.名称 || '</MC>';
    v_Temp := v_Temp || '<BBBW>' || r_Detail.标本部位 || '</BBBW>';
    v_Temp := v_Temp || '<JSDW>' || r_Detail.计算单位 || '</JSDW>';
  
    --加入执行科室
    v_Exedept := Null;
    For r_Exedept In c_Exedept(r_Detail.Id) Loop
      If v_Exedept Is Null Then
        v_Exedept := '' || r_Exedept.执行科室id;
      Else
        v_Exedept := v_Exedept || ',' || r_Exedept.执行科室id;
      End If;
    End Loop;
    v_Temp := v_Temp || '<ZXKS>' || v_Exedept || '</ZXKS>';
  
    --加入检查部位和方法
    v_Part := Null;
    v_Partandmethod := Null;
    For r_Checkpart In c_Checkpart(r_Detail.Id) Loop
      If v_Part Is Null Or v_Part <> r_Checkpart.部位 Then
        v_Part := r_Checkpart.部位;
      
        If v_Partandmethod Is Null Then
          v_Partandmethod := v_Part || '!!' || r_Checkpart.方法;
        Else
          v_Partandmethod := v_Partandmethod || v_Part || '!!' || r_Checkpart.方法;
        End If;
      Else
        v_Partandmethod := v_Partandmethod || ',' || r_Checkpart.方法;
      End If;
    End Loop;
    v_Temp := v_Temp || '<JCBWFF>' || v_Partandmethod || '</JCBWFF></JCLIST>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
End Zl_Third_Getcheckitem;
/
Create Or Replace Procedure Zl_Third_Gettreatmentitem
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取所有治疗项目信息
  --入参:Xml_In:
  --<IN>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <ZLLIST>
  --    <ID></ID>         //ID
  --    <BM></BM>         //编码
  --    <MC></MC>         //名称
  --    <BBBW></BBBW>     //标本部位
  --    <JSDW></JSDW>     //计算单位
  --    <ZXPL></ZXPL>     //执行频率
  --    <JSFS></JSFS>     //计算方式
  --    <ZXKS></ZXKS>     //执行科室,格式; 执行科室,执行科室,执行科室...
  --  </ZLLIST>
  --  <ZLLIST>
  --      ...
  --  </ZLLIST>
  --  <ERROR>
  --    <MSG></MSG>  //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  Cursor c_Detail Is
    Select a.Id, a.编码, a.名称, a.标本部位, a.计算单位, a.执行频率, a.计算方式
    From 诊疗项目目录 A
    Where a.类别 = 'E' And (a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd') Or a.撤档时间 Is Null);

  --执行科室
  Cursor c_Exedept(项目id_In 诊疗执行科室.诊疗项目id%Type) Is
    Select Distinct 执行科室id From 诊疗执行科室 Where 诊疗项目id = 项目id_In;

  x_Templet Xmltype; --模板XML
  v_Temp    Clob;
  r_Detail  c_Detail%RowType;
  r_Exedept c_Exedept%RowType;
  v_Exedept Clob;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For r_Detail In c_Detail Loop
    v_Temp := '<ZLLIST><ID>' || r_Detail.Id || '</ID>';
    v_Temp := v_Temp || '<BM>' || r_Detail.编码 || '</BM>';
    v_Temp := v_Temp || '<MC>' || r_Detail.名称 || '</MC>';
    v_Temp := v_Temp || '<BBBW>' || r_Detail.标本部位 || '</BBBW>';
    v_Temp := v_Temp || '<JSDW>' || r_Detail.计算单位 || '</JSDW>';
    v_Temp := v_Temp || '<ZXPL>' || r_Detail.执行频率 || '</ZXPL>';
    v_Temp := v_Temp || '<JSFS>' || r_Detail.计算方式 || '</JSFS>';
  
    --加入执行科室
    v_Exedept := Null;
    For r_Exedept In c_Exedept(r_Detail.Id) Loop
      If v_Exedept Is Null Then
        v_Exedept := '' || r_Exedept.执行科室id;
      Else
        v_Exedept := v_Exedept || ',' || r_Exedept.执行科室id;
      End If;
    End Loop;
    v_Temp := v_Temp || '<ZXKS>' || v_Exedept || '</ZXKS></ZLLIST>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
End Zl_Third_Gettreatmentitem;
/
Create Or Replace Procedure Zl_Third_Getotheritem
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取所有其他项目信息
  --入参:Xml_In:
  --<IN>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <QTLIST>
  --    <ID></ID>         //ID
  --    <BM></BM>         //编码
  --    <MC></MC>         //名称
  --    <BBBW></BBBW>     //标本部位
  --    <JSDW></JSDW>     //计算单位
  --    <ZXPL></ZXPL>     //执行频率
  --    <JSFS></JSFS>     //计算方式
  --    <ZXKS></ZXKS>     //执行科室,格式; 执行科室,执行科室,执行科室...
  --  </QTLIST>
  --  <QTLIST>
  --      ...
  --  </QTLIST>
  --  <ERROR>
  --    <MSG></MSG>  //错误捕获
  --  </ERROR>
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  Cursor c_Detail Is
    Select a.Id, a.编码, a.名称, a.标本部位, a.计算单位, a.执行频率, a.计算方式
    From 诊疗项目目录 A
    Where a.类别 = 'Z' And (a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd') Or a.撤档时间 Is Null);

  --执行科室
  Cursor c_Exedept(项目id_In 诊疗执行科室.诊疗项目id%Type) Is
    Select Distinct 执行科室id From 诊疗执行科室 Where 诊疗项目id = 项目id_In;

  x_Templet Xmltype; --模板XML
  v_Temp    Clob;
  r_Detail  c_Detail%RowType;
  r_Exedept c_Exedept%RowType;
  v_Exedept Clob;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For r_Detail In c_Detail Loop
    v_Temp := '<QTLIST><ID>' || r_Detail.Id || '</ID>';
    v_Temp := v_Temp || '<BM>' || r_Detail.编码 || '</BM>';
    v_Temp := v_Temp || '<MC>' || r_Detail.名称 || '</MC>';
    v_Temp := v_Temp || '<BBBW>' || r_Detail.标本部位 || '</BBBW>';
    v_Temp := v_Temp || '<JSDW>' || r_Detail.计算单位 || '</JSDW>';
    v_Temp := v_Temp || '<ZXPL>' || r_Detail.执行频率 || '</ZXPL>';
    v_Temp := v_Temp || '<JSFS>' || r_Detail.计算方式 || '</JSFS>';
  
    --加入执行科室
    v_Exedept := Null;
    For r_Exedept In c_Exedept(r_Detail.Id) Loop
      If v_Exedept Is Null Then
        v_Exedept := '' || r_Exedept.执行科室id;
      Else
        v_Exedept := v_Exedept || ',' || r_Exedept.执行科室id;
      End If;
    End Loop;
    v_Temp := v_Temp || '<ZXKS>' || v_Exedept || '</ZXKS></QTLIST>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Others Then
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
End Zl_Third_Getotheritem;
/
Create Or Replace Procedure Zl_Third_Receive
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:病人接诊候诊病人，都要经过分诊，暂不考虑预约/转诊病人
  --入参:Xml_In:
  --  <IN>
  --    <JZID>1</JZID>                             挂号ID
  --    <JZZS>门诊内科</JZZS>                     接诊诊室
  --    <JZRQ>2017-05-23 08:30:30</JZRQ>          接诊时间
  --    <JZYS>张永康</JZYS>                       接诊医生
  --  </IN>
  --出参:Xml_Out
  --  <OUTPUT>
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_挂号id   病人挂号记录.Id%Type;
  v_执行人   病人挂号记录.执行人%Type;
  v_诊室     病人挂号记录.诊室%Type;
  d_接收时间 病人挂号记录.接收时间%Type;
  v_Tmp      Varchar2(2000);
  n_Cnt      Number;
  v_Err_Msg  Varchar2(200);
  Err_Item Exception;
Begin
  --参数名：病人接诊控制，模块：1260，忽略
  Select Extractvalue(Value(A), 'IN/JZID'), Extractvalue(Value(A), 'IN/JZZS'), Extractvalue(Value(A), 'IN/JZRQ'),
         Extractvalue(Value(A), 'IN/JZYS')
  Into n_挂号id, v_诊室, v_Tmp, v_执行人
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  d_接收时间 := To_Date(v_Tmp, 'YYYY-MM-DD HH24:MI:ss');

  For R In (Select a.执行状态, a.执行人, a.病人id, a.No, a.记录性质, a.记录状态, a.姓名, a.诊室
            From 病人挂号记录 A
            Where a.Id = n_挂号id) Loop
  
    If r.诊室 Is Null Then
      v_Err_Msg := r.姓名 || ' 未分诊，要分诊后才能接诊。';
      Raise Err_Item;
    End If;
  
    If r.记录性质 = 1 And r.记录状态 = 1 Then
      If Nvl(r.执行状态, 0) <> 0 Then
        v_Err_Msg := r.姓名 || ' 已被医生：' || Nvl(r.执行人, '医生') || '接诊。';
        Raise Err_Item;
      End If;
    End If;
  
    Select Count(1)
    Into n_Cnt
    From 病人挂号记录 A
    Where a.记录性质 = 1 And a.记录状态 = 1 And Nvl(a.执行状态, 0) = 0 And a.Id = n_挂号id;
    If n_Cnt = 0 Then
      v_Err_Msg := r.姓名 || '已退号，不能接诊。';
      Raise Err_Item;
    End If;
  
    Zl_病人接诊(r.病人id, r.No, Null, v_执行人, v_诊室, 0, 0, d_接收时间);
  End Loop;
  Xml_Out := Xmltype('<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>');
Exception
  When Err_Item Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
End Zl_Third_Receive;
/
Create Or Replace Procedure Zl_Third_Cancel
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:取消接诊
  --入参:Xml_In:
  --  <IN>
  --    <JZID>1</JZID>                 挂号ID
  --    <JZYS>张永康</JZYS>            当前操作医生
  --  </IN>
  --出参:Xml_Out
  --  <OUTPUT>
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_挂号id  病人挂号记录.Id%Type;
  v_执行人  病人挂号记录.执行人%Type;
  n_Cnt     Number;
  n_天数    Number;
  v_Tmp     Varchar2(2000);
  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin

  --参数：病人接诊控制，忽略
  Select Extractvalue(Value(A), 'IN/JZID'), Extractvalue(Value(A), 'IN/JZYS')
  Into n_挂号id, v_执行人
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For R In (Select a.登记时间, a.急诊, a.执行状态, a.执行人, a.病人id, a.No, a.记录性质, a.记录状态, a.姓名
            From 病人挂号记录 A
            Where a.Id = n_挂号id) Loop
  
    --挂号单是否过期检查
    n_Cnt := To_Number(Nvl(zl_GetSysParameter(210), '0'));
    If n_Cnt = 0 Then
      v_Tmp := Nvl(zl_GetSysParameter(21), '11') || '11';
      If Nvl(r.急诊, 0) = 0 Then
        n_Cnt := To_Number(Substr(v_Tmp, 1, 1));
      Else
        n_Cnt := To_Number(Substr(v_Tmp, 2, 1));
      End If;
      If n_Cnt > 0 Then
        Select r.登记时间 - Trunc(Sysdate) Into n_天数 From Dual;
        If n_天数 > n_Cnt Then
          v_Err_Msg := '该病人挂号已超过有效天数，不允许再取消接诊。';
          Raise Err_Item;
        End If;
      End If;
    End If;
  
    If r.执行人 <> v_执行人 Then
      v_Err_Msg := r.姓名 || ' 是 ' || r.执行人 || ' 接诊，你能取消自己接诊的病人。';
      Raise Err_Item;
    End If;
  
    --医嘱数据的检查
    Select Count(1) Into n_Cnt From 病人医嘱记录 Where 医嘱状态 In (1, 8) And 挂号单 = r.No;
    If n_Cnt > 0 Then
      v_Err_Msg := r.姓名 || '已有新开或已发送的医嘱，不能取消接诊。' || Chr(13) || '如果确实要取消接诊，请先将这些医嘱删除或作废。';
      Raise Err_Item;
    End If;
    Zl_病人接诊_Cancel(r.病人id, r.No);
  End Loop;
  Xml_Out := Xmltype('<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>');
Exception
  When Err_Item Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
End Zl_Third_Cancel;
/
CREATE OR REPLACE Procedure Zl_Third_Finish
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:病人完成就诊
  --入参:Xml_In:
  --  <IN>
  --    <JZID>1</JZID>                             挂号ID
  --    <JZZS>门诊内科</JZZS>                     接诊诊室
  --    <JZYS>张永康</JZYS>                        接诊医生
  --  </IN>
  --出参:Xml_Out
  --  <OUTPUT>
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_挂号id  病人挂号记录.Id%Type;
  v_执行人  病人挂号记录.执行人%Type;
  v_诊室    病人挂号记录.诊室%Type;
  n_Cnt     Number;
  v_Tmp     varchar2(2000);
  v_Err_Msg varchar2(200);
  Err_Item Exception;
Begin
  Select Extractvalue(Value(A), 'IN/JZID'), Extractvalue(Value(A), 'IN/JZZS'), Extractvalue(Value(A), 'IN/JZYS')
  Into n_挂号id, v_诊室, v_执行人
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For R In (Select a.执行状态, a.执行人, a.病人id, a.No, a.记录性质, a.记录状态, a.姓名, a.转诊状态
            From 病人挂号记录 A
            Where a.Id = n_挂号id) Loop
  
    --转诊后未接收判断 
    If r.转诊状态 = 0 Then
      v_Err_Msg := r.姓名 || '已经转诊，请取消转诊后再完成接诊。';
      Raise Err_Item;
    End If;
    
    --检查是否有医嘱询问提示，忽略  
    --疾病报告卡填写判断，忽略
    --社区信息提交，外挂部件调用，忽略
    --一卡通数据上传，忽略
  
    --并发操作检查
    If Not (r.执行人 = v_执行人 And r.执行状态 = 2 And r.记录性质 = 1 And r.记录状态 = 1) Then
      v_Err_Msg := r.姓名 || '可能被其他医生强制续诊接收，请刷新重试。';
      Raise Err_Item;
    End If;
  
    --检查未发送的医嘱
    Select Count(1)
    Into n_Cnt
    From 病人医嘱记录
    Where 挂号单 = r.No And 医嘱状态 = 1 And Nvl(执行标记, 0) <> -1 And Nvl(执行性质, 0) <> 0 And Nvl(皮试结果, '无') <> '免试';
    If n_Cnt > 0 Then
      v_Err_Msg := r.姓名 || '还有未发送的医嘱，不能完成接诊。';
      Raise Err_Item;
    End If;
    Zl_病人接诊完成(r.病人id, r.No, v_诊室, v_执行人);
  End Loop;
  Xml_Out := Xmltype('<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>');
Exception
  When Err_Item Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
End Zl_Third_Finish;
/
Create Or Replace Procedure Zl_Third_Redo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:已经完成就诊的病人恢复接诊
  --入参:Xml_In:
  --  <IN>
  --    <JZID>1</JZID>                挂号ID
  --    <JZYS>张永康</JZYS>           接诊医生，即当前操作员
  --  </IN>
  --出参:Xml_Out
  --  <OUTPUT>
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_挂号id  病人挂号记录.Id%Type;
  v_执行人  病人挂号记录.执行人%Type;
  v_Tmp     Varchar2(2000);
  n_Tmp     Number;
  n_天数    Number;
  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select Extractvalue(Value(A), 'IN/JZID'), Extractvalue(Value(A), 'IN/JZYS')
  Into n_挂号id, v_执行人
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For R In (Select a.执行状态, a.执行人, a.病人id, a.No, a.记录性质, a.记录状态, a.姓名, a.急诊, a.登记时间
            From 病人挂号记录 A
            Where a.Id = n_挂号id) Loop
    --恢复就诊是针对完成就诊的病人
    If r.执行状态 <> 1 Then
      v_Err_Msg := r.姓名 || '还未完成就诊，不能恢复接诊。';
      Raise Err_Item;
    End If;
    --挂号单是否过期检查
    n_Tmp := To_Number(Nvl(zl_GetSysParameter(210), '0'));
    If n_Tmp = 0 Then
      v_Tmp := Nvl(zl_GetSysParameter(21), '11') || '11';
      If Nvl(r.急诊, 0) = 0 Then
        n_Tmp := To_Number(Substr(v_Tmp, 1, 1));
      Else
        n_Tmp := To_Number(Substr(v_Tmp, 2, 1));
      End If;
      If n_Tmp > 0 Then
        Select r.登记时间 - Trunc(Sysdate) Into n_天数 From Dual;
        If n_天数 > n_Tmp Then
          v_Err_Msg := '该病人挂号已超过有效天数，不允许再恢复接诊。';
          Raise Err_Item;
        End If;
      End If;
    End If;
  
    --数据转出检查，忽略
    --只能恢复本人完成的挂号单
    If v_执行人 <> r.执行人 Then
      v_Err_Msg := r.姓名 || '不是由你本人完成就诊的，不能直接恢复接诊。';
      Raise Err_Item;
    End If;
    Zl_病人接诊完成_Cancel(r.病人id, r.No);
  End Loop;
  Xml_Out := Xmltype('<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>');
Exception
  When Err_Item Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
End Zl_Third_Redo;
/
CREATE OR REPLACE Procedure Zl_Third_Advicesave
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:病人生成医嘱(检查,检验,药品，手术，卫材，治疗，其它特殊类)，一个病人调用一次
  --日期格式统一固定为：2017-05-25 10:22:31
  --入参:Xml_In:
  --  <IN>
  --   <GHDH>R0000001</GHDH> 挂号单号
  --   <JZID></JZID>就诊ID，挂号ID
  --   <BRID></BRID>病人ID  
  --   <BRKSID>21</BRKSID>  病人科室ID
  --   <CZYXM>张永康</CZYXM> 操作员姓名
  --   <ZD></ZD>站点  
  --   <YZNRLIST>  医嘱列表，可以含多个结点
  --   <YZNR> 医嘱内容  
  --    <YZXH></YZXH> 医嘱序号，即传入这批医嘱中可做为当前这行医嘱唯一标识，数字类型
  --    <JJBZ>2</JJBZ>   紧急标志
  --    <KSZXSJ>2017-05-25 10:00:00</KSZXSJ> 开始执行时间
  --    <KZKSID>23</KZKSID>开嘱科室ID
  --    <KZYS>张永康</KZYS> 开嘱医生
  --    <KZSJ>2017-05-25 10:00:00</KZSJ> 开嘱时间
  --    <YEXH></YEXH>婴儿序号，如果是病人医嘱，传0
  --    <ZLLB>D</ZLLB>  诊疗类别 D-检查，E-(采集试)检验，E-(给药途径)药品医嘱，4-卫材，E-治疗，Z-特殊
  --    <CZLX></CZLX>   操作类型 ，当为药品和检验时需要传入 2/6
  --    <ZLXMID>123</ZLXMID>  诊疗项目ID  检查项目ID,检验采集项目ID,药品医嘱约药途径项目ID，其它类项目ID
  --    <ZXKSID>123</ZXKSID>  执行科室ID  检查，     采集执行科室，  给药执行科室             其它类执行科室ID

  ------药品，卫材，治疗，特殊
  --    <SFXMID></SFXMID>收费细目ID,如果是卫材类，需传入，即  收费项目目录.ID(仅限卫材使用)
  --    <PLBM></PLBM>频率：诊疗频率项目.编码 对于 非检查，检验，手术，可不传
  --    <ZXFA></ZXFA>执行方案,可以传无 ,指定频率才传，如果每天二次
  --    <DL></DL>单量，可以传无
  --    <ZL></ZL>总量，可以传无

  ------药品医嘱 
  --    <DRUGLIST>
  --     <ROW>
  --      <YMID></YMID>药名ID,诊疗项目id
  --      <YPID></YPID>药品ID,规格，收费细目ID
  --      <YFID></YFID>药房ID,发药药房
  --      <DL></DL>单量
  --      <TS></TS>天数
  --      <ZL></ZL>总量
  --     </ROW>
  --    </DRUGLIST>

  ------检查相关的，非检验项目可以不传入
  --    <BWFFALL></BWFFALL>方法部位总述格式: 部位1(方法1),部位2(方法2,方法3),...  逗号为半角
  --                      如：胆囊和胆道(收缩功能检查),输卵管(超声造影),腹部的测试(膀胱余尿测定,常规)
  --    <BWLIST>        检查方法部位列表详情
  --     <BWFF>
  --     <BW>颅骨</BW>
  --     <FF>平扫</FF>
  --     </BWFF>
  --     <BWFF>
  --     ....
  --     </BWFF>
  --    </BWLIST>

  ------检验项目的采集相关内容，非检验项目可以不传入
  --    <CJBB>血清</CJBB>        采集标本
  --    <JYZXKSID>12</JYZXKSID>  检验执行科室ID
  --    <YBCJXM>            一并采集的检验项目
  --      <ROW>
  --       <ZLXMID></ZLXMID>诊疗项目ID 
  --       ....
  --      </ROW>
  --    </YBCJXM>

  ------手术项目
  --    <SSSJ></SSSJ>手术时间
  --    <SSQK></SSQK>手术情况，null-择期，1-急诊，2-限期
  --    <SSNR></SSNR>手术内容描术 例：01月17日14:51 在 基础麻醉 下行 视神经减压术 及 甲状腺活组织检查
  --                          格式： [日期:MM月dd日HH:mm] 在 [麻醉项目名称] 下行 [主手术项目名称] 及 [附加手术名称1,附加手术名称2...]

  --    <FJSFXM>            其它附加手术项目
  --      <ROW>
  --       <ZLXMID></ZLXMID>诊疗项目ID 
  --       ....
  --      </ROW>
  --    </FJSFXM>
  --    <MZXMID></MZXMID> 麻醉项目ID
  --    <MZZXKSID></MZZXKSID> 麻醉执行科室ID

  --    ....
  --    </YZNR>
  --   </YZNRLIST>

  --   <DIAGS>诊断信息
  --     <ROW>
  --        <ZDXH></ZDXH>诊断序号
  --        <BRID></BRID>病人ID
  --        <ZYID></ZYID>主页ID
  --        <JLLY></JLLY>记录来源，1-病历；2-入院登记；3-首页整理;4-病案，固定传3
  --        <BLID></BLID>病历ID，可以不传结点保留
  --        <ZDLX></ZDLX>诊断类型，3西诊断，11中医诊断
  --        <JBID></JBID>疾病ID，可以不传结点保留
  --        <ZDID></ZDID>诊断ID，可以不传结点保留
  --        <ZHID></ZHID>证候ID，可以不传结点保留
  --        <ZDMS></ZDMS>诊断描述，必填
  --        <CYQK></CYQK>出院情况，可以不传结点保留
  --        <SFWZ></SFWZ>是否未治 ，可以不传结点保留
  --        <SFYZ></SFYZ>是否疑诊 取值  0/1
  --        <JLRQ></JLRQ>记录日期 日期类型字符串
  --        <YZID></YZID>医嘱ID，可以不传结点保留
  --        <ZDCX></ZDCX>诊断次序，必填
  --        <BZ></BZ>备注 ，可以不传结点保留
  --        <RYBQ></RYBQ>入院病情，可以不传结点保留
  --        <FBSJ></FBSJ>发病时间 日期类型字符串
  --        <JLR></JLR>记录人，必填
  --        <ID></ID>ID， 不传结点保留，即诊断记录的真实ID值
  --        <FMID></FMID>附码ID，可以不传结点保留
  --     </ROW>
  --   </DIAGS>

  --   <ZDYZDY>诊断医嘱对应,以保存的对应关系只传医嘱ID,诊断ID,另外两个序号传空串，如果未保存的关系医嘱ID,诊断ID传空串
  --     <ROW>
  --      <YZXH></YZXH>医嘱序号
  --      <ZDXH></ZDXH>诊断序号
  --      <YZID></YZID>医嘱ID 真实的医嘱ID
  --      <ZDID></ZDID>诊断ID 直实的诊断ID
  --     </ROW>
  --   </ZDYZDY>
  --  </IN>

  --出参:Xml_Out，生成的医嘱ID串，错误信息
  --  <OUTPUT>
  --    <ITEM> 保存的医嘱主项目ID
  --     <ZLXMID></ZLXMID> 诊疗项目ID
  --     <ZYZID></ZYZID>   主医嘱ID
  --    </ITEM>
  --    <YZIDS>1234,41234,64645,...</YZIDS>医嘱ID串，逗号分割
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  Type r_医嘱记录 Is Record(
    ID           病人医嘱记录.Id%Type,
    相关id       病人医嘱记录.相关id%Type,
    序号         病人医嘱记录.序号%Type,
    病人来源     病人医嘱记录.病人来源%Type,
    病人id       病人医嘱记录.病人id%Type,
    主页id       病人医嘱记录.主页id%Type,
    婴儿         病人医嘱记录.婴儿%Type,
    医嘱状态     病人医嘱记录.医嘱状态%Type,
    医嘱期效     病人医嘱记录.医嘱期效%Type,
    诊疗类别     病人医嘱记录.诊疗类别%Type,
    诊疗项目id   病人医嘱记录.诊疗项目id%Type,
    收费细目id   病人医嘱记录.收费细目id%Type,
    天数         病人医嘱记录.天数%Type,
    单次用量     病人医嘱记录.单次用量%Type,
    总给予量     病人医嘱记录.总给予量%Type,
    医嘱内容     病人医嘱记录.医嘱内容%Type,
    医生嘱托     病人医嘱记录.医生嘱托%Type,
    标本部位     病人医嘱记录.标本部位%Type,
    执行频次     病人医嘱记录.执行频次%Type,
    频率次数     病人医嘱记录.频率次数%Type,
    频率间隔     病人医嘱记录.频率间隔%Type,
    间隔单位     病人医嘱记录.间隔单位%Type,
    执行时间方案 病人医嘱记录.执行时间方案%Type,
    计价特性     病人医嘱记录.计价特性%Type,
    执行科室id   病人医嘱记录.执行科室id%Type,
    执行性质     病人医嘱记录.执行性质%Type,
    紧急标志     病人医嘱记录.紧急标志%Type,
    开始执行时间 病人医嘱记录.开始执行时间%Type,
    执行终止时间 病人医嘱记录.执行终止时间%Type,
    病人科室id   病人医嘱记录.病人科室id%Type,
    开嘱科室id   病人医嘱记录.开嘱科室id%Type,
    开嘱医生     病人医嘱记录.开嘱医生%Type,
    开嘱时间     病人医嘱记录.开嘱时间%Type,
    挂号单       病人医嘱记录.挂号单%Type := Null,
    前提id       病人医嘱记录.前提id%Type := Null,
    检查方法     病人医嘱记录.检查方法%Type := Null,
    执行标记     病人医嘱记录.执行标记%Type := Null,
    可否分零     病人医嘱记录.可否分零%Type := Null,
    摘要         病人医嘱记录.摘要%Type := Null,
    操作员姓名   病人医嘱状态.操作人员%Type := Null,
    零费记帐     病人医嘱记录.零费记帐%Type := Null,
    用药目的     病人医嘱记录.用药目的%Type := Null,
    用药理由     病人医嘱记录.用药理由%Type := Null,
    审核状态     病人医嘱记录.审核状态%Type := Null,
    申请序号     病人医嘱记录.申请序号%Type := Null,
    超量说明     病人医嘱记录.超量说明%Type := Null,
    首次用量     病人医嘱记录.首次用量%Type := Null,
    配方id       病人医嘱记录.配方id%Type := Null,
    手术情况     病人医嘱记录.手术情况%Type := Null,
    组合项目id   病人医嘱记录.组合项目id%Type := Null,
    皮试结果     病人医嘱记录.皮试结果%Type := Null);

  Type t_医嘱记录 Is Table Of r_医嘱记录;
  Rs_Sql t_医嘱记录 := t_医嘱记录();
  Rt     r_医嘱记录;

  Type r_诊断记录 Is Record(
    病人id   病人诊断记录.病人id%Type,
    主页id   病人诊断记录.主页id%Type,
    记录来源 病人诊断记录.记录来源%Type,
    病历id   病人诊断记录.病历id%Type,
    诊断类型 病人诊断记录.诊断类型%Type,
    疾病id   病人诊断记录.疾病id%Type,
    诊断id   病人诊断记录.诊断id%Type,
    证候id   病人诊断记录.证候id%Type,
    诊断描述 病人诊断记录.诊断描述%Type,
    出院情况 病人诊断记录.出院情况%Type,
    是否未治 病人诊断记录.是否未治%Type,
    是否疑诊 病人诊断记录.是否疑诊%Type,
    记录日期 病人诊断记录.记录日期%Type,
    医嘱id   Varchar2(4000),
    诊断次序 病人诊断记录.诊断次序%Type,
    备注     病人诊断记录.备注%Type,
    入院病情 病人诊断记录.入院病情%Type,
    发病时间 病人诊断记录.发病时间%Type,
    记录人   病人诊断记录.记录人%Type,
    ID       病人诊断记录.Id%Type,
    附码id   病人诊断记录.疾病id%Type);

  Type t_诊断记录 Is Table Of r_诊断记录;
  Rs_Sql诊断 t_诊断记录 := t_诊断记录();

  Type r_诊断医嘱 Is Record(
    诊断序号 病人诊断记录.病人id%Type,
    医嘱序号 病人诊断记录.病人id%Type,
    诊断id   病人诊断记录.病人id%Type,
    医嘱id   病人诊断记录.病人id%Type);

  Type t_诊断医嘱 Is Table Of r_诊断医嘱;
  Rs_Sql诊断医嘱 t_诊断医嘱 := t_诊断医嘱();

  Cursor c_频率(P编码 诊疗频率项目.编码%Type) Is
    Select 编码, 名称, 简码, 英文名称, 频率次数, 频率间隔, 间隔单位, 适用范围 From 诊疗频率项目 Where 编码 = P编码;
  r_频率 c_频率%RowType;

  Cursor c_项目(Pid 诊疗项目目录.Id%Type) Is
    Select 计算规则, 站点, 类别, 分类id, ID, 编码, 名称, 标本部位, 计算单位, 计算方式, 执行频率, 适用性别, 单独应用, 组合项目, 操作类型, 执行安排, 执行科室, 服务对象, 计价性质,
           参考目录id, 人员id, 建档时间, 撤档时间, 录入限量, 试管编码, 执行分类, 执行标记
    From 诊疗项目目录
    Where ID = Pid;

  r_项目 c_项目%RowType;
  r_给药 c_项目%RowType;
  r_药品 c_项目%RowType;

  d_开始执行时间 病人医嘱记录.开始执行时间%Type;
  n_病人科室id   病人医嘱记录.病人科室id%Type;
  v_操作员       人员表.姓名%Type;
  d_开嘱时间     病人医嘱记录.开嘱时间%Type;
  v_挂号单       病人医嘱记录.挂号单%Type;

  v_医嘱内容     病人医嘱记录.医嘱内容%Type;
  v_Tmp          Varchar2(32767);
  v_项目名称     诊疗项目目录.名称%Type;
  n_项目计价特性 诊疗项目目录.计价性质%Type;
  n_项目执行性质 诊疗项目目录.执行科室%Type;
  v_试管编码     诊疗项目目录.试管编码%Type;
  n_医嘱id       病人医嘱记录.Id%Type;
  n_相关id       病人医嘱记录.Id%Type;
  n_序号         病人医嘱记录.序号%Type;
  n_病人id       病人医嘱记录.病人id%Type;
  v_医嘱ids      Varchar2(32767);
  J              Number;
  n_Tmp          Number;
  n_诊断id       病人医嘱记录.Id%Type;
  n_主医嘱id     病人医嘱记录.Id%Type;
  n_药名id       病人医嘱记录.Id%Type;
  n_药品id       病人医嘱记录.Id%Type;
  n_药房id       部门表.Id%Type;
  n_单量         病人医嘱记录.单次用量%Type;
  n_天数         病人医嘱记录.天数%Type;
  n_总量         病人医嘱记录.总给予量%Type;
  n_执行性质     病人医嘱记录.执行性质%Type;
  v_频率编码     诊疗频率项目.编码%Type;
  v_执行方案     Varchar2(40);
  n_收费细目id   Number(18);

  Type r_病人医嘱附件记录 Is Record(
    项目   病人医嘱附件.项目%Type,
    必填   病人医嘱附件.必填%Type,
    排列   病人医嘱附件.排列%Type,
    要素id 病人医嘱附件.要素id%Type,
    医嘱id 病人医嘱附件.医嘱id%Type,
    内容   病人医嘱附件.内容%Type);

  Type t_r_病人医嘱附件记录 Is Table Of r_病人医嘱附件记录;
  Rs_Sql病人医嘱附件记录 t_r_病人医嘱附件记录 := t_r_病人医嘱附件记录();
  Rf                     r_病人医嘱附件记录;

  n_是否有附加项 Number(18);

  v_Err_Msg Varchar(2000);
  Err_Item Exception;
  v_Erroritem    Varchar(2000);
  v_Erroritemlis Varchar(2000);

  d_Stoptime Date;
  v_Itemname Varchar(200);
  v_编码     Varchar(200);
  v_项目类别 Varchar(200);
  n_组合id   Number(18);
  n_Cnt      Number;
Begin 
  --取出诊断医嘱对应关系
  For R In (Select Extractvalue(Value(A), 'ROW/YZXH') As 医嘱序号, Extractvalue(Value(A), 'ROW/ZDXH') As 诊断序号,
                   Extractvalue(Value(A), 'ROW/YZID') As 医嘱id, Extractvalue(Value(A), 'ROW/ZDID') As 诊断id
            From Table(Xmlsequence(Extract(Xml_In, 'IN/ZDYZDY/ROW'))) A) Loop
    Rs_Sql诊断医嘱.Extend;
    Rs_Sql诊断医嘱(Rs_Sql诊断医嘱.Count).医嘱序号 := r.医嘱序号;
    Rs_Sql诊断医嘱(Rs_Sql诊断医嘱.Count).诊断序号 := r.诊断序号;
    Rs_Sql诊断医嘱(Rs_Sql诊断医嘱.Count).医嘱id := r.医嘱id;
    Rs_Sql诊断医嘱(Rs_Sql诊断医嘱.Count).诊断id := r.诊断id;
  End Loop;

  Select Extractvalue(Value(A), 'IN/GHDH') As 挂号单, Extractvalue(Value(A), 'IN/BRID') As 病人id,
         Extractvalue(Value(A), 'IN/BRKSID') As 病人科室id, Extractvalue(Value(A), 'IN/CZYXM') As 操作员
  Into v_挂号单, n_病人id, n_病人科室id, v_操作员
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Nvl(Max(a.序号), 0) Into n_序号 From 病人医嘱记录 A Where a.挂号单 = v_挂号单;

  --产生医嘱 
  For X In (Select v_操作员 As 操作员, 0 As 婴儿, b.医嘱序号, b.诊疗项目id, b.诊疗类别, b.操作类型, b.执行科室id, b.紧急标志, b.开始执行时间, b.开嘱时间, b.开嘱科室id,
                   b.开嘱医生, b.收费细目id, b.频率编码, b.执行方案, b.单量, b.总量, b.西药品明细, b.检查部位方法总述, b.检查部位方法明细, b.采集标本, b.检验执行科室id,
                   b.检验项目明细, b.手术时间, b.手术情况, b.手术内容, b.手术附加项目明细, b.麻醉项目id, b.麻醉执行科室id, b.申请附项名称, b.申请附项内容
            From Xmltable('$a/IN/YZNRLIST/YZNR' Passing Xml_In As "a" Columns 医嘱序号 Number(18) Path 'YZXH',
                           诊疗项目id Number(18) Path 'ZLXMID', 诊疗类别 Varchar2(1) Path 'ZLLB', 操作类型 Varchar2(20) Path 'CZLX',
                           执行科室id Number(18) Path 'ZXKSID', 紧急标志 Number(1) Path 'JJBZ', 开始执行时间 Varchar2(30) Path 'KSZXSJ',
                           开嘱时间 Varchar2(30) Path 'KZSJ', 开嘱科室id Number(18) Path 'KZKSID', 开嘱医生 Varchar2(41) Path 'KZYS',
                           收费细目id Number(18) Path 'SFXMID', 频率编码 Varchar2(3) Path 'PLBM', 执行方案 Varchar2(100) Path 'ZXFA',
                           单量 Number(16, 5) Path 'DL', 总量 Number(16, 5) Path 'ZL', 西药品明细 Xmltype Path 'DRUGLIST',
                           检查部位方法总述 Varchar2(4000) Path 'BWFFALL', 检查部位方法明细 Xmltype Path 'BWLIST',
                           采集标本 Varchar2(60) Path 'CJBB', 检验执行科室id Number(18) Path 'JYZXKSID', 检验项目明细 Xmltype Path 'YBCJXM',
                           手术时间 Varchar2(30) Path 'SSSJ', 手术情况 Number(2) Path 'SSQK', 手术内容 Varchar2(1000) Path 'SSNR',
                           手术附加项目明细 Xmltype Path 'FJSFXM', 麻醉项目id Number(18) Path 'MZXMID', 麻醉执行科室id Number Path 'MZZXKSID',
                           申请附项名称 Varchar2(1000) Path 'SQFXMC', 申请附项内容 Varchar2(4000) Path 'SQFXNR') B) Loop
  
    d_开始执行时间 := To_Date(x.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
    d_开嘱时间     := To_Date(x.开嘱时间, 'YYYY-MM-DD HH24:MI:SS');
  
    If x.诊疗类别 = 'D' Then
      Select 名称, 计价性质, 执行科室
      Into v_项目名称, n_项目计价特性, n_项目执行性质
      From 诊疗项目目录
      Where ID = x.诊疗项目id;
    
      v_医嘱内容 := x.检查部位方法总述;
    
      Select 病人医嘱记录_Id.Nextval Into n_医嘱id From Dual;
      n_相关id := n_医嘱id;
      v_Tmp    := v_项目名称;
      If v_医嘱内容 Is Not Null Then
        v_Tmp := v_Tmp || ':' || v_医嘱内容;
      End If;
    
      n_序号 := n_序号 + 1;
      Select n_医嘱id, Null, n_序号, 1, n_病人id, Null, x.婴儿, 1, 1, x.诊疗类别, x.诊疗项目id, Null, Null, Null, 1, v_Tmp, Null, Null,
             '一次性', Null, Null, Null, Null, n_项目计价特性, x.执行科室id, n_项目执行性质, x.紧急标志, d_开始执行时间, Null, n_病人科室id, x.开嘱科室id,
             x.开嘱医生, d_开嘱时间, v_挂号单, Null, Null, 0, Null, Null, x.操作员
      Into Rt.Id, Rt.相关id, Rt.序号, Rt.病人来源, Rt.病人id, Rt.主页id, Rt.婴儿, Rt.医嘱状态, Rt.医嘱期效, Rt.诊疗类别, Rt.诊疗项目id, Rt.收费细目id,
           Rt.天数, Rt.单次用量, Rt.总给予量, Rt.医嘱内容, Rt.医生嘱托, Rt.标本部位, Rt.执行频次, Rt.频率次数, Rt.频率间隔, Rt.间隔单位, Rt.执行时间方案, Rt.计价特性,
           Rt.执行科室id, Rt.执行性质, Rt.紧急标志, Rt.开始执行时间, Rt.执行终止时间, Rt.病人科室id, Rt.开嘱科室id, Rt.开嘱医生, Rt.开嘱时间, Rt.挂号单, Rt.前提id,
           Rt.检查方法, Rt.执行标记, Rt.可否分零, Rt.摘要, Rt.操作员姓名
      From Dual;
      n_主医嘱id := n_医嘱id;
      Rs_Sql.Extend;
      Rs_Sql(Rs_Sql.Count) := Rt;
    
      If v_医嘱内容 Is Not Null Then
        --添加部位方法 
        For Y In (Select b.部位, b.方法
                  From Xmltable('$a/BWLIST/BWFF' Passing x.检查部位方法明细 As "a" Columns 部位 Varchar2(60) Path 'BW',
                                 方法 Varchar2(60) Path 'FF') B) Loop
        
          Select 病人医嘱记录_Id.Nextval Into n_医嘱id From Dual;
          n_序号 := n_序号 + 1;
        
          Select n_医嘱id, n_相关id, n_序号, 1, n_病人id, Null, x.婴儿, 1, 1, x.诊疗类别, x.诊疗项目id, Null, Null, Null, 1, v_项目名称, Null,
                 y.部位, '一次性', Null, Null, Null, Null, n_项目计价特性, x.执行科室id, n_项目执行性质, x.紧急标志, d_开始执行时间, Null, n_病人科室id,
                 x.开嘱科室id, x.开嘱医生, d_开嘱时间, v_挂号单, Null, y.方法, 0, Null, Null, x.操作员
          Into Rt.Id, Rt.相关id, Rt.序号, Rt.病人来源, Rt.病人id, Rt.主页id, Rt.婴儿, Rt.医嘱状态, Rt.医嘱期效, Rt.诊疗类别, Rt.诊疗项目id, Rt.收费细目id,
               Rt.天数, Rt.单次用量, Rt.总给予量, Rt.医嘱内容, Rt.医生嘱托, Rt.标本部位, Rt.执行频次, Rt.频率次数, Rt.频率间隔, Rt.间隔单位, Rt.执行时间方案,
               Rt.计价特性, Rt.执行科室id, Rt.执行性质, Rt.紧急标志, Rt.开始执行时间, Rt.执行终止时间, Rt.病人科室id, Rt.开嘱科室id, Rt.开嘱医生, Rt.开嘱时间,
               Rt.挂号单, Rt.前提id, Rt.检查方法, Rt.执行标记, Rt.可否分零, Rt.摘要, Rt.操作员姓名
          From Dual;
          Rs_Sql.Extend;
          Rs_Sql(Rs_Sql.Count) := Rt;
        
        End Loop;
        --==yqq 20171127===========================================
      End If;
    
      If x.申请附项名称 Is Not Null And x.申请附项内容 Is Not Null Then
        --判断是否配置了附加项
        Select Max(a.诊疗项目id)
        Into n_是否有附加项
        From 病历单据应用 A, 病历文件列表 B, 病历单据附项 C, 诊治所见项目 D
        Where a.诊疗项目id = Rt.诊疗项目id And a.应用场合 = 1 And a.病历文件id = b.Id And b.种类 = 7 And b.Id = c.文件id And
              c.要素id = d.Id(+) And 项目 = x.申请附项名称 And Rownum < 2;
        If n_是否有附加项 > 0 Then
          --添加申请附项（检查部位补充）
          Select c.项目, c.必填, c.排列, c.要素id
          Into Rf.项目, Rf.必填, Rf.排列, Rf.要素id
          From 病历单据应用 A, 病历文件列表 B, 病历单据附项 C, 诊治所见项目 D
          Where a.诊疗项目id = Rt.诊疗项目id And a.应用场合 = 1 And a.病历文件id = b.Id And b.种类 = 7 And b.Id = c.文件id And
                c.要素id = d.Id(+) And 项目 = x.申请附项名称 And Rownum < 2;
        
          Select x.申请附项内容, n_相关id Into Rf.内容, Rf.医嘱id From Dual;
        
          Rs_Sql病人医嘱附件记录.Extend;
          Rs_Sql病人医嘱附件记录(Rs_Sql病人医嘱附件记录.Count) := Rf;
        End If;
      End If;
      --==yqq 20171127===========================================
    Elsif x.诊疗类别 = 'E' And x.操作类型 = '6' Then
      n_Cnt      := 0;
      n_相关id   := Null;
      v_医嘱内容 := Null;
      --检验项目
      For Y In (Select b.诊疗项目id
                From Xmltable('$a/YBCJXM/ROW' Passing x.检验项目明细 As "a" Columns 诊疗项目id Number(18) Path 'ZLXMID') B) Loop
        Select 名称, 计价性质, 执行科室, 试管编码
        Into v_项目名称, n_项目计价特性, n_项目执行性质, v_试管编码
        From 诊疗项目目录
        Where ID = y.诊疗项目id;
      
        v_医嘱内容 := v_医嘱内容 || ',' || v_项目名称;
      
        Select 病人医嘱记录_Id.Nextval Into n_医嘱id From Dual;
        n_序号 := n_序号 + 1;
        Select n_医嘱id, n_相关id, n_序号, 1, n_病人id, Null, x.婴儿, 1, 1, 'C', y.诊疗项目id, Null, Null, Null, 1, v_项目名称, Null,
               x.采集标本, '一次性', Null, Null, Null, Null, n_项目计价特性, x.检验执行科室id, n_项目执行性质, x.紧急标志, d_开始执行时间, Null, n_病人科室id,
               x.开嘱科室id, x.开嘱医生, d_开嘱时间, v_挂号单, Null, Null, 0, Null, Null, x.操作员
        Into Rt.Id, Rt.相关id, Rt.序号, Rt.病人来源, Rt.病人id, Rt.主页id, Rt.婴儿, Rt.医嘱状态, Rt.医嘱期效, Rt.诊疗类别, Rt.诊疗项目id, Rt.收费细目id,
             Rt.天数, Rt.单次用量, Rt.总给予量, Rt.医嘱内容, Rt.医生嘱托, Rt.标本部位, Rt.执行频次, Rt.频率次数, Rt.频率间隔, Rt.间隔单位, Rt.执行时间方案, Rt.计价特性,
             Rt.执行科室id, Rt.执行性质, Rt.紧急标志, Rt.开始执行时间, Rt.执行终止时间, Rt.病人科室id, Rt.开嘱科室id, Rt.开嘱医生, Rt.开嘱时间, Rt.挂号单, Rt.前提id,
             Rt.检查方法, Rt.执行标记, Rt.可否分零, Rt.摘要, Rt.操作员姓名
        From Dual;
        Rs_Sql.Extend;
        Rs_Sql(Rs_Sql.Count) := Rt;
        n_Cnt := n_Cnt + 1;
      End Loop;
    
      Select 病人医嘱记录_Id.Nextval Into n_相关id From Dual;
      v_医嘱内容 := v_医嘱内容 || '(' || x.采集标本 || ')';
      v_医嘱内容 := Substr(v_医嘱内容, 2);
      Select 名称, 计价性质, 执行科室
      Into v_项目名称, n_项目计价特性, n_项目执行性质
      From 诊疗项目目录
      Where ID = x.诊疗项目id;
      n_序号 := n_序号 + 1;
      Select n_相关id, Null, n_序号, 1, n_病人id, Null, x.婴儿, 1, 1, 'E', x.诊疗项目id, Null, Null, Null, 1, v_医嘱内容, Null, x.采集标本,
             '一次性', Null, Null, Null, Null, n_项目计价特性, x.执行科室id, n_项目执行性质, x.紧急标志, d_开始执行时间, Null, n_病人科室id, x.开嘱科室id,
             x.开嘱医生, d_开嘱时间, v_挂号单, Null, Null, 0, Null, Null, x.操作员
      Into Rt.Id, Rt.相关id, Rt.序号, Rt.病人来源, Rt.病人id, Rt.主页id, Rt.婴儿, Rt.医嘱状态, Rt.医嘱期效, Rt.诊疗类别, Rt.诊疗项目id, Rt.收费细目id,
           Rt.天数, Rt.单次用量, Rt.总给予量, Rt.医嘱内容, Rt.医生嘱托, Rt.标本部位, Rt.执行频次, Rt.频率次数, Rt.频率间隔, Rt.间隔单位, Rt.执行时间方案, Rt.计价特性,
           Rt.执行科室id, Rt.执行性质, Rt.紧急标志, Rt.开始执行时间, Rt.执行终止时间, Rt.病人科室id, Rt.开嘱科室id, Rt.开嘱医生, Rt.开嘱时间, Rt.挂号单, Rt.前提id,
           Rt.检查方法, Rt.执行标记, Rt.可否分零, Rt.摘要, Rt.操作员姓名
      From Dual;
      n_主医嘱id := n_相关id;
      Rs_Sql.Extend;
      Rs_Sql(Rs_Sql.Count) := Rt;
      n_Cnt := n_Cnt + 1;
    
      --替换真实的相关ID
      For I In 1 .. n_Cnt - 1 Loop
        Rs_Sql(Rs_Sql.Count - I).相关id := n_相关id;
      End Loop;
    
    Elsif x.诊疗类别 = 'F' Then
      --手术医嘱
      Select 名称, 计价性质, 执行科室
      Into v_项目名称, n_项目计价特性, n_项目执行性质
      From 诊疗项目目录
      Where ID = x.诊疗项目id;
    
      v_医嘱内容  := x.手术内容;
      Rt.手术情况 := x.手术情况;
    
      Select 病人医嘱记录_Id.Nextval Into n_医嘱id From Dual;
      n_相关id := n_医嘱id;
    
      n_序号 := n_序号 + 1;
      Select n_医嘱id, Null, n_序号, 1, n_病人id, Null, x.婴儿, 1, 1, x.诊疗类别, x.诊疗项目id, Null, Null, Null, 1, v_医嘱内容, Null,
             x.手术时间, '一次性', Null, Null, Null, Null, n_项目计价特性, x.执行科室id, n_项目执行性质, x.紧急标志, d_开始执行时间, Null, n_病人科室id,
             x.开嘱科室id, x.开嘱医生, d_开嘱时间, v_挂号单, Null, Null, 0, Null, Null, x.操作员
      Into Rt.Id, Rt.相关id, Rt.序号, Rt.病人来源, Rt.病人id, Rt.主页id, Rt.婴儿, Rt.医嘱状态, Rt.医嘱期效, Rt.诊疗类别, Rt.诊疗项目id, Rt.收费细目id,
           Rt.天数, Rt.单次用量, Rt.总给予量, Rt.医嘱内容, Rt.医生嘱托, Rt.标本部位, Rt.执行频次, Rt.频率次数, Rt.频率间隔, Rt.间隔单位, Rt.执行时间方案, Rt.计价特性,
           Rt.执行科室id, Rt.执行性质, Rt.紧急标志, Rt.开始执行时间, Rt.执行终止时间, Rt.病人科室id, Rt.开嘱科室id, Rt.开嘱医生, Rt.开嘱时间, Rt.挂号单, Rt.前提id,
           Rt.检查方法, Rt.执行标记, Rt.可否分零, Rt.摘要, Rt.操作员姓名
      From Dual;
      n_主医嘱id := n_医嘱id;
      Rs_Sql.Extend;
      Rs_Sql(Rs_Sql.Count) := Rt;
    
      --附加手术 
      If x.手术附加项目明细 Is Not Null Then
        For Y In (Select b.诊疗项目id
                  From Xmltable('$a/FJSFXM/ROW' Passing x.手术附加项目明细 As "a" Columns 诊疗项目id Number(18) Path 'ZLXMID') B) Loop
          Select 病人医嘱记录_Id.Nextval Into n_医嘱id From Dual;
          n_序号 := n_序号 + 1;
          Select n_医嘱id, n_相关id, n_序号, ID, 名称, 计价性质, 执行科室
          Into Rt.Id, Rt.相关id, Rt.序号, Rt.诊疗项目id, Rt.医嘱内容, Rt.计价特性, Rt.执行性质
          From 诊疗项目目录
          Where ID = y.诊疗项目id;
        
          Rs_Sql.Extend;
          Rs_Sql(Rs_Sql.Count) := Rt;
        End Loop;
      End If;
      --麻醉 
      Rt.诊疗项目id := x.麻醉项目id;
      Rt.执行科室id := x.麻醉执行科室id;
    
      If Rt.诊疗项目id Is Not Null Then
        Select 病人医嘱记录_Id.Nextval Into n_医嘱id From Dual;
        n_序号 := n_序号 + 1;
        Select n_医嘱id, n_相关id, n_序号, 类别, 名称, 计价性质, 执行科室
        Into Rt.Id, Rt.相关id, Rt.序号, Rt.诊疗类别, Rt.医嘱内容, Rt.计价特性, Rt.执行性质
        From 诊疗项目目录
        Where ID = Rt.诊疗项目id;
        Rs_Sql.Extend;
        Rs_Sql(Rs_Sql.Count) := Rt;
      End If;
    
    Elsif x.诊疗类别 = 'E' And x.操作类型 = '2' Then
      --药品医嘱
      Open c_频率(x.频率编码); --诊疗频率项目
      Fetch c_频率
        Into r_频率;
      Close c_频率;
    
      Open c_项目(x.诊疗项目id);
      Fetch c_项目
        Into r_给药;
      Close c_项目;
    
      n_Cnt    := 0;
      n_相关id := Null;
      --药品医嘱 
      For Y In (Select b.药名id, b.药品id, b.药房id, b.单量, b.天数, b.总量
                From Xmltable('$a/DRUGLIST/ROW' Passing x.西药品明细 As "a" Columns 药名id Number(18) Path 'YMID',
                               药品id Number(18) Path 'YPID', 药房id Number(18) Path 'YFID', 单量 Number(16, 5) Path 'DL',
                               天数 Number(16, 5) Path 'TS', 总量 Number(16, 5) Path 'ZL') B) Loop
      
        n_药名id := y.药名id;
        n_药品id := y.药品id;
        n_药房id := y.药房id;
        n_单量   := y.单量;
        n_天数   := y.天数;
        n_总量   := y.总量;
      
        Open c_项目(n_药名id);
        Fetch c_项目
          Into r_药品;
        Close c_项目;
      
        n_执行性质 := 4;
        If Nvl(n_药房id, 0) = 0 Then
          n_执行性质 := 5;
        End If;
      
        --生成医嘱内容
        v_医嘱内容 := r_药品.名称;
        For Mc In (Select Nvl(b.名称, a.名称) As 名称, a.规格, a.产地, b.性质
                   From 收费项目目录 A, 收费项目别名 B
                   Where a.Id = b.收费细目id(+) And a.Id = n_药品id
                   Order By b.性质, b.码类) Loop
          If Mc.产地 Is Not Null Then
            v_医嘱内容 := v_医嘱内容 || '(' || Mc.产地 || ')';
          End If;
          If Mc.规格 Is Not Null Then
            v_医嘱内容 := v_医嘱内容 || ' ' || Mc.规格;
          End If;
          Exit;
        End Loop;
        n_序号 := n_序号 + 1;
        Select 病人医嘱记录_Id.Nextval Into n_医嘱id From Dual;
        Select n_医嘱id, n_相关id, n_序号, 1, n_病人id, Null, x.婴儿, 1, 1, r_药品.类别, n_药名id, n_药品id, n_天数, n_单量, n_总量, v_医嘱内容,
               Null, r_药品.名称, r_频率.名称, r_频率.频率次数, r_频率.频率间隔, r_频率.间隔单位, x.执行方案, Nvl(r_药品.计价性质, 0), n_药房id, n_执行性质,
               x.紧急标志, d_开始执行时间, Null, n_病人科室id, x.开嘱科室id, x.开嘱医生, d_开嘱时间, v_挂号单, Null, Null, 0, Null, Null, x.操作员
        Into Rt.Id, Rt.相关id, Rt.序号, Rt.病人来源, Rt.病人id, Rt.主页id, Rt.婴儿, Rt.医嘱状态, Rt.医嘱期效, Rt.诊疗类别, Rt.诊疗项目id, Rt.收费细目id,
             Rt.天数, Rt.单次用量, Rt.总给予量, Rt.医嘱内容, Rt.医生嘱托, Rt.标本部位, Rt.执行频次, Rt.频率次数, Rt.频率间隔, Rt.间隔单位, Rt.执行时间方案, Rt.计价特性,
             Rt.执行科室id, Rt.执行性质, Rt.紧急标志, Rt.开始执行时间, Rt.执行终止时间, Rt.病人科室id, Rt.开嘱科室id, Rt.开嘱医生, Rt.开嘱时间, Rt.挂号单, Rt.前提id,
             Rt.检查方法, Rt.执行标记, Rt.可否分零, Rt.摘要, Rt.操作员姓名
        From Dual;
        Rs_Sql.Extend;
        Rs_Sql(Rs_Sql.Count) := Rt;
        n_Cnt := n_Cnt + 1;
      End Loop;
      --给药途径医嘱
      n_序号     := n_序号 + 1;
      n_执行性质 := r_给药.执行科室;
      If Nvl(x.执行科室id, 0) = 0 Then
        n_执行性质 := 5;
      End If;
      Select 病人医嘱记录_Id.Nextval Into n_医嘱id From Dual;
      n_相关id := n_医嘱id;
      Select n_相关id, Null, n_序号, 1, n_病人id, Null, x.婴儿, 1, 1, 'E', r_给药.Id, Null, n_天数, Null, Null, r_给药.名称, Null, Null,
             r_频率.名称, r_频率.频率次数, r_频率.频率间隔, r_频率.间隔单位, x.执行方案, Nvl(r_给药.计价性质, 0), x.执行科室id, n_执行性质, x.紧急标志, d_开始执行时间,
             Null, n_病人科室id, x.开嘱科室id, x.开嘱医生, d_开嘱时间, v_挂号单, Null, Null, 0, Null, Null, x.操作员
      Into Rt.Id, Rt.相关id, Rt.序号, Rt.病人来源, Rt.病人id, Rt.主页id, Rt.婴儿, Rt.医嘱状态, Rt.医嘱期效, Rt.诊疗类别, Rt.诊疗项目id, Rt.收费细目id,
           Rt.天数, Rt.单次用量, Rt.总给予量, Rt.医嘱内容, Rt.医生嘱托, Rt.标本部位, Rt.执行频次, Rt.频率次数, Rt.频率间隔, Rt.间隔单位, Rt.执行时间方案, Rt.计价特性,
           Rt.执行科室id, Rt.执行性质, Rt.紧急标志, Rt.开始执行时间, Rt.执行终止时间, Rt.病人科室id, Rt.开嘱科室id, Rt.开嘱医生, Rt.开嘱时间, Rt.挂号单, Rt.前提id,
           Rt.检查方法, Rt.执行标记, Rt.可否分零, Rt.摘要, Rt.操作员姓名
      From Dual;
      n_主医嘱id := n_相关id;
      Rs_Sql.Extend;
      Rs_Sql(Rs_Sql.Count) := Rt;
      n_Cnt := n_Cnt + 1;
    
      --替换真实的相关ID
      For I In 1 .. n_Cnt - 1 Loop
        Rs_Sql(Rs_Sql.Count - I).相关id := n_相关id;
      End Loop;
    Elsif Instr(',4,E,Z,', x.诊疗类别) > 0 Then
      n_收费细目id := x.收费细目id;
      v_频率编码   := x.频率编码;
      v_执行方案   := x.执行方案;
      n_单量       := x.单量;
      n_总量       := x.总量;
    
      Open c_项目(x.诊疗项目id);
      Fetch c_项目
        Into r_项目;
      Close c_项目;
      Open c_频率(x.频率编码); --诊疗频率项目
      Fetch c_频率
        Into r_频率;
      Close c_频率;
    
      n_序号 := n_序号 + 1;
      Select 病人医嘱记录_Id.Nextval Into n_医嘱id From Dual;
    
      v_医嘱内容 := r_项目.名称;
      If x.诊疗类别 = '4' Then
        Select r_项目.名称 || '(' || 规格 || ')' Into v_医嘱内容 From 收费项目目录 Where ID = n_收费细目id;
      End If;
      Select n_医嘱id, Null, n_序号, 1, n_病人id, Null, x.婴儿, 1, 1, x.诊疗类别, x.诊疗项目id, n_收费细目id, Null, n_单量, n_总量, v_医嘱内容, Null,
             Null, r_频率.名称, r_频率.频率次数, r_频率.频率间隔, r_频率.间隔单位, x.执行方案, Nvl(r_项目.计价性质, 0), x.执行科室id, r_项目.执行科室, x.紧急标志,
             d_开始执行时间, Null, n_病人科室id, x.开嘱科室id, x.开嘱医生, d_开嘱时间, v_挂号单, Null, Null, Null, Null, Null, x.操作员
      Into Rt.Id, Rt.相关id, Rt.序号, Rt.病人来源, Rt.病人id, Rt.主页id, Rt.婴儿, Rt.医嘱状态, Rt.医嘱期效, Rt.诊疗类别, Rt.诊疗项目id, Rt.收费细目id,
           Rt.天数, Rt.单次用量, Rt.总给予量, Rt.医嘱内容, Rt.医生嘱托, Rt.标本部位, Rt.执行频次, Rt.频率次数, Rt.频率间隔, Rt.间隔单位, Rt.执行时间方案, Rt.计价特性,
           Rt.执行科室id, Rt.执行性质, Rt.紧急标志, Rt.开始执行时间, Rt.执行终止时间, Rt.病人科室id, Rt.开嘱科室id, Rt.开嘱医生, Rt.开嘱时间, Rt.挂号单, Rt.前提id,
           Rt.检查方法, Rt.执行标记, Rt.可否分零, Rt.摘要, Rt.操作员姓名
      From Dual;
      n_主医嘱id := n_医嘱id;
      Rs_Sql.Extend;
      Rs_Sql(Rs_Sql.Count) := Rt;
    End If;
  
    --替换真实的医嘱ID
    For J In 1 .. Rs_Sql诊断医嘱.Count Loop
      If Rs_Sql诊断医嘱(J).医嘱序号 = To_Number(x.医嘱序号) Then
        Rs_Sql诊断医嘱(J).医嘱id := n_主医嘱id;
      End If;
    End Loop;
  
  End Loop;

  --诊断相关处理
  For R In (Select Extractvalue(Value(A), 'ROW/ZDXH') As 诊断序号, Extractvalue(Value(A), 'ROW/BRID') As 病人id,
                   Extractvalue(Value(A), 'ROW/ZYID') As 主页id, Extractvalue(Value(A), 'ROW/JLLY') As 记录来源,
                   Extractvalue(Value(A), 'ROW/BLID') As 病历id, Extractvalue(Value(A), 'ROW/ZDLX') As 诊断类型,
                   Extractvalue(Value(A), 'ROW/JBID') As 疾病id, Extractvalue(Value(A), 'ROW/ZDID') As 诊断id,
                   Extractvalue(Value(A), 'ROW/ZHID') As 证候id, Extractvalue(Value(A), 'ROW/ZDMS') As 诊断描述,
                   Extractvalue(Value(A), 'ROW/CYQK') As 出院情况, Extractvalue(Value(A), 'ROW/SFWZ') As 是否未治,
                   Extractvalue(Value(A), 'ROW/SFYZ') As 是否疑诊,
                   To_Date(Extractvalue(Value(A), 'ROW/JLRQ'), 'yyyy-mm-dd hh24:mi:ss') As 记录日期,
                   Extractvalue(Value(A), 'ROW/YZID') As 医嘱id, Extractvalue(Value(A), 'ROW/ZDCX') As 诊断次序,
                   Extractvalue(Value(A), 'ROW/BZ') As 备注, Extractvalue(Value(A), 'ROW/RYBQ') As 入院病情,
                   To_Date(Extractvalue(Value(A), 'ROW/FBSJ'), 'yyyy-mm-dd hh24:mi:ss') As 发病时间,
                   Extractvalue(Value(A), 'ROW/JLR') As 记录人, Extractvalue(Value(A), 'ROW/ID') As ID,
                   Extractvalue(Value(A), 'ROW/FMID') As 附码id
            From Table(Xmlsequence(Extract(Xml_In, 'IN/DIAGS/ROW'))) A) Loop
  
    Select 病人诊断记录_Id.Nextval Into n_诊断id From Dual;
    Rs_Sql诊断.Extend;
    n_Tmp := Rs_Sql诊断.Count;
    Rs_Sql诊断(n_Tmp).病人id := r.病人id;
    Rs_Sql诊断(n_Tmp).主页id := r.主页id;
    Rs_Sql诊断(n_Tmp).记录来源 := r.记录来源;
    Rs_Sql诊断(n_Tmp).病历id := r.病历id;
    Rs_Sql诊断(n_Tmp).诊断类型 := r.诊断类型;
    Rs_Sql诊断(n_Tmp).疾病id := r.疾病id;
    Rs_Sql诊断(n_Tmp).诊断id := r.诊断id;
    Rs_Sql诊断(n_Tmp).证候id := r.证候id;
    Rs_Sql诊断(n_Tmp).诊断描述 := r.诊断描述;
    Rs_Sql诊断(n_Tmp).出院情况 := r.出院情况;
    Rs_Sql诊断(n_Tmp).是否未治 := r.是否未治;
    Rs_Sql诊断(n_Tmp).是否疑诊 := r.是否疑诊;
    Rs_Sql诊断(n_Tmp).记录日期 := r.记录日期;
    Rs_Sql诊断(n_Tmp).医嘱id := Null;
    Rs_Sql诊断(n_Tmp).诊断次序 := r.诊断次序;
    Rs_Sql诊断(n_Tmp).备注 := r.备注;
    Rs_Sql诊断(n_Tmp).入院病情 := r.入院病情;
    Rs_Sql诊断(n_Tmp).发病时间 := r.发病时间;
    Rs_Sql诊断(n_Tmp).记录人 := r.记录人;
    Rs_Sql诊断(n_Tmp).Id := n_诊断id;
    Rs_Sql诊断(n_Tmp).附码id := r.附码id;
  
    --替换真实的诊断ID
    For J In 1 .. Rs_Sql诊断医嘱.Count Loop
      If Rs_Sql诊断医嘱(J).诊断序号 = To_Number(r.诊断序号) Then
        Rs_Sql诊断医嘱(J).诊断id := n_诊断id;
      End If;
    End Loop;
  End Loop;

  --提交数据
  Xml_Out := Xmltype('<OUTPUT></OUTPUT>');
  For I In 1 .. Rs_Sql.Count Loop
    v_医嘱ids := v_医嘱ids || ',' || Rs_Sql(I).Id;
    If Rs_Sql(I).相关id Is Null Then
      v_Tmp := '<ITEM><ZLXMID>' || Rs_Sql(I).诊疗项目id || '</ZLXMID><ZYZID>' || Rs_Sql(I).Id || '</ZYZID></ITEM>';
      Select Appendchildxml(Xml_Out, '/OUTPUT', Xmltype(v_Tmp)) Into Xml_Out From Dual;
    End If;
    Zl_病人医嘱记录_Insert(Rs_Sql(I).Id, Rs_Sql(I).相关id, Rs_Sql(I).序号, Rs_Sql(I).病人来源, Rs_Sql(I).病人id, Rs_Sql(I).主页id,
                     Rs_Sql(I).婴儿, Rs_Sql(I).医嘱状态, Rs_Sql(I).医嘱期效, Rs_Sql(I).诊疗类别, Rs_Sql(I).诊疗项目id, Rs_Sql(I).收费细目id,
                     Rs_Sql(I).天数, Rs_Sql(I).单次用量, Rs_Sql(I).总给予量, Rs_Sql(I).医嘱内容, Rs_Sql(I).医生嘱托, Rs_Sql(I).标本部位,
                     Rs_Sql(I).执行频次, Rs_Sql(I).频率次数, Rs_Sql(I).频率间隔, Rs_Sql(I).间隔单位, Rs_Sql(I).执行时间方案, Rs_Sql(I).计价特性,
                     Rs_Sql(I).执行科室id, Rs_Sql(I).执行性质, Rs_Sql(I).紧急标志, Rs_Sql(I).开始执行时间, Rs_Sql(I).执行终止时间,
                     Rs_Sql(I).病人科室id, Rs_Sql(I).开嘱科室id, Rs_Sql(I).开嘱医生, Rs_Sql(I).开嘱时间, Rs_Sql(I).挂号单, Rs_Sql(I).前提id,
                     Rs_Sql(I).检查方法, Rs_Sql(I).执行标记, Rs_Sql(I).可否分零, Rs_Sql(I).摘要, Rs_Sql(I).操作员姓名);
  End Loop;

  For I In 1 .. Rs_Sql诊断.Count Loop
    Zl_病人诊断记录_Insert(Rs_Sql诊断(I).病人id, Rs_Sql诊断(I).主页id, Rs_Sql诊断(I).记录来源, Rs_Sql诊断(I).病历id, Rs_Sql诊断(I).诊断类型,
                     Rs_Sql诊断(I).疾病id, Rs_Sql诊断(I).诊断id, Rs_Sql诊断(I).证候id, Rs_Sql诊断(I).诊断描述, Rs_Sql诊断(I).出院情况,
                     Rs_Sql诊断(I).是否未治, Rs_Sql诊断(I).是否疑诊, Rs_Sql诊断(I).记录日期, Rs_Sql诊断(I).医嘱id, Rs_Sql诊断(I).诊断次序,
                     Rs_Sql诊断(I).备注, Rs_Sql诊断(I).入院病情, Rs_Sql诊断(I).发病时间, Rs_Sql诊断(I).记录人, Rs_Sql诊断(I).Id,
                     Rs_Sql诊断(I).附码id);
  End Loop;

  For I In 1 .. Rs_Sql诊断医嘱.Count Loop
    Zl_病人诊断医嘱_Delete(Rs_Sql诊断医嘱(I).医嘱id);
    Zl_病人诊断医嘱_Insert(Null, Null, Rs_Sql诊断医嘱(I).诊断id, Rs_Sql诊断医嘱(I).医嘱id);
  End Loop;

  For I In 1 .. Rs_Sql病人医嘱附件记录.Count Loop
    Zl_病人医嘱附件_Insert(Rs_Sql病人医嘱附件记录(I).医嘱id, Rs_Sql病人医嘱附件记录(I).项目, Rs_Sql病人医嘱附件记录(I).必填, Rs_Sql病人医嘱附件记录(I).排列,
                     Rs_Sql病人医嘱附件记录(I).要素id, Rs_Sql病人医嘱附件记录(I).内容);
  End Loop;

  v_Tmp := '<YZIDS>' || Substr(v_医嘱ids, 2) || '</YZIDS>';
  Select Appendchildxml(Xml_Out, '/OUTPUT', Xmltype(v_Tmp)) Into Xml_Out From Dual;
Exception
  When Err_Item Then
    Rollback;
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || v_Err_Msg || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    Rollback;
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Advicesave;
/
CREATE OR REPLACE Procedure Zl_Third_Advicesend
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:门诊医嘱发送
  --     外挂接口，医保接口，记帐报警，电子签名等功能失效。
  --入参:Xml_In:
  --  <IN>
  --  <BRID></BRID>病人ID
  --  <JZID></JZID>就诊ID，挂号ID
  --  <CZYXM></CZYXM> 操作员姓名
  --  <CZYBH></CZYBH> 操作员编号
  --  <ZD></ZD>站点,字符串，长度为1
  --  <YZIDS>1</YZIDS>要发送的医嘱ID串，逗号分割
  --  <JZD>0</JZD> 是否发送为记帐单，0-划价单，1-记帐单
  --  <JBJJ></JBJJ>加班加价 由外部传入决定
  --  <CZYID></CZYID>操作员ID
  --  <CLLIS></CLLIS>处理LIS申请，定决是否要在过程内部调用LIS接口， 0-不处理，1-要处理
  --  <FHLISDATA></FHLISDATA>是否需要返回LIS申请信息，0-不返回，1-返回
  --  </IN>

  --出参:Xml_Out
  --  <OUTPUT>
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------

  --自定义类型
  --动态游标类型
  Type Rs_Recordset Is Ref Cursor;

  --医嘱表格类型
  Type r_Advice Is Record(
    选择          Number,
    婴儿          Number,
    医嘱内容      Varchar2(4000),
    总量          Number(16, 5),
    总量单位      Varchar2(500),
    单量          Number(16, 5),
    单量单位      Varchar2(500),
    金额          Number(16, 5),
    金额_Data     Number(16, 5),
    频率          Varchar2(500),
    频率_Data     Varchar2(500),
    用法          Varchar2(500),
    医生嘱托      Varchar2(500),
    医生嘱托_Data Varchar2(500), --摘要
    执行时间      Varchar2(500),
    执行科室      Varchar2(500),
    执行性质      Varchar2(500),
    ID            Number(18),
    Id_Data       Varchar2(4000), --
    相关id        Number(18),
    病人科室id    Number(18),
    开嘱科室id    Number(18),
    开嘱医生      Varchar2(500),
    诊疗类别      Varchar2(500),
    诊疗项目id    Number(18),
    标本部位      Varchar2(500),
    检查方法      Varchar2(500),
    执行标记      Varchar2(500),
    计价特性      Number(1),
    执行性质id    Number(18),
    执行科室id    Number(18),
    收费细目id    Number(18),
    频率次数      Number(3),
    频率间隔      Number(3),
    间隔单位      Varchar2(4),
    剂量系数      Varchar2(500),
    门诊包装      Varchar2(500),
    门诊单位      Varchar2(500),
    可否分零      Number(1),
    库存          Varchar2(500),
    次数          Varchar2(500),
    分解时间      Varchar2(4000),
    分解时间_Data Varchar2(4000),
    首次时间      Varchar2(500),
    末次时间      Varchar2(500),
    前提id        Number(18),
    签名id        Number(18),
    试管编码      Varchar2(500),
    操作类型      Varchar2(500),
    紧急标志      Varchar2(500),
    零费记帐      Varchar2(500),
    计算方式      Varchar2(500),
    开始时间      Varchar2(500),
    执行安排      Varchar2(500),
    执行分类      Varchar2(500),
    毒理分类      Varchar2(500));
  Type t_Advice Is Table Of r_Advice;

  --项目收费对照
  Type r_Price Is Record(
    医嘱id     Number(18),
    相关id     Number(18),
    费用性质   Number(18),
    收费方式   Number(18),
    收费类别   Varchar2(500),
    收费细目id Number(18),
    执行科室id Number(18),
    数量       Number(16, 5),
    单价       Number(16, 5),
    在用       Number(18),
    变价       Number(18),
    从项       Number(18),
    固定       Number(18));
  Type t_Price Is Table Of r_Price;

  Type r_Bill Is Record(
    Key      Varchar2(200),
    NO       Varchar2(30),
    费用序号 Number(18),
    发送序号 Number(18));
  Type t_Bill Is Table Of r_Bill;

  Type r_Exec Is Record(
    医嘱id     Number(18),
    发送号     Number(18),
    收费细目id Number(18),
    要求时间   Varchar2(30),
    数量       Number(16, 5),
    费用性质   Number(1));
  Type t_Exec Is Table Of r_Exec;

  Type r_Number Is Record(
    管码       Varchar2(30),
    相关id     Number(18),
    样本条码   Varchar2(18),
    执行科室id Number(18),
    诊疗项目id Number(18),
    婴儿       Number(1),
    紧急标志   Number(1),
    标本       Varchar2(18),
    采集科室id Number(18));
  Type t_Number Is Table Of r_Number;

  Type r_Moneynow Is Record(
    医嘱id     Number(18),
    诊疗项目id Number(18),
    收费项目id Number(18),
    试管编码   Varchar2(18),
    样本条码   Varchar2(18),
    收费方式   Number(1),
    收费时间   Varchar2(18),
    执行部门id Number(18));
  Type t_Moneynow Is Table Of r_Moneynow;

  Type r_Moneyday Is Record(
    诊疗项目id Number(18),
    收费项目id Number(18),
    执行部门id Number(18),
    收费方式   Number(1),
    执行否     Number(18),
    收费时间   Varchar2(30));
  Type t_Moneyday Is Table Of r_Moneyday;

  Type 医嘱计价_Sql Is Record(
    过程名     Number, --1--ZL_病人医嘱计价_Delete ; 2 --ZL_病人医嘱计价_INSERT
    医嘱id     病人医嘱记录.Id%Type,
    收费细目id 病人医嘱计价.收费细目id%Type,
    数量       病人医嘱计价.数量%Type,
    单价       病人医嘱计价.单价%Type,
    从项       病人医嘱计价.从项%Type := Null,
    执行科室id 病人医嘱计价.执行科室id%Type := Null,
    费用性质   病人医嘱计价.费用性质%Type := 0,
    收费方式   病人医嘱计价.收费方式%Type := 0,
    删单行     Number);
  Type t_医嘱计价_Sql Is Table Of 医嘱计价_Sql;

  Type 病人费用_Insert Is Record(
    过程名     Number, --1--ZL_门诊划价记录_INSERT;  2--ZL_门诊记帐记录_INSERT
    NO         Varchar2(300),
    序号       门诊费用记录.序号%Type,
    病人id     门诊费用记录.病人id%Type,
    主页id     住院费用记录.主页id%Type,
    标识号     门诊费用记录.标识号%Type,
    付款方式   门诊费用记录.付款方式%Type,
    姓名       门诊费用记录.姓名%Type,
    性别       门诊费用记录.性别%Type,
    年龄       门诊费用记录.年龄%Type,
    费别       Varchar2(300),
    加班标志   门诊费用记录.加班标志%Type,
    病人科室id 门诊费用记录.病人科室id%Type,
    开单部门id 门诊费用记录.开单部门id%Type,
    开单人     门诊费用记录.开单人%Type,
    从属父号   门诊费用记录.从属父号%Type,
    收费细目id 门诊费用记录.收费细目id%Type,
    收费类别   门诊费用记录.收费类别%Type,
    计算单位   门诊费用记录.计算单位%Type,
    发药窗口   门诊费用记录.发药窗口%Type,
    付数       门诊费用记录.付数%Type,
    数次       门诊费用记录.数次%Type,
    附加标志   门诊费用记录.附加标志%Type,
    执行部门id 门诊费用记录.执行部门id%Type,
    价格父号   门诊费用记录.价格父号%Type,
    收入项目id 门诊费用记录.收入项目id%Type,
    收据费目   门诊费用记录.收据费目%Type,
    标准单价   门诊费用记录.标准单价%Type,
    应收金额   门诊费用记录.应收金额%Type,
    实收金额   门诊费用记录.实收金额%Type,
    发生时间   门诊费用记录.发生时间%Type,
    登记时间   门诊费用记录.登记时间%Type,
    药品摘要   药品收发记录.摘要%Type,
    操作员姓名 门诊费用记录.操作员姓名%Type,
    费用摘要   门诊费用记录.摘要%Type := Null,
    医嘱序号   门诊费用记录.医嘱序号%Type := Null,
    频次       药品收发记录.频次%Type := Null,
    单量       药品收发记录.单量%Type := Null,
    用法       药品收发记录.用法%Type := Null,
    期效       药品收发记录.扣率%Type := Null,
    计价特性   药品收发记录.扣率%Type := Null,
    病人来源   Number := 1,
    保险编码   门诊费用记录.保险编码%Type := Null,
    费用类型   门诊费用记录.费用类型%Type := Null,
    保险项目否 门诊费用记录.保险项目否%Type := Null,
    保险大类id 门诊费用记录.保险大类id%Type := Null,
    中药形态   门诊费用记录.结论%Type := Null,
    备货材料   Number := 0,
    批次       药品收发记录.批次%Type := Null,
    划价       Number,
    婴儿费     门诊费用记录.婴儿费%Type,
    操作员编号 门诊费用记录.操作员编号%Type,
    门诊标志   门诊费用记录.门诊标志%Type := 1,
    记帐单id   门诊费用记录.记帐单id%Type := Null);
  Type t_病人费用_Insert Is Table Of 病人费用_Insert;

  --自动发料可执行SQL
  Type 处方发料_Sql Is Record(
    Partid   药品收发记录.库房id%Type,
    Bill     药品收发记录.单据%Type,
    NO       药品收发记录.No%Type,
    People   药品收发记录.审核人%Type,
    配药人   药品收发记录.配药人%Type,
    校验人   药品收发记录.填制人%Type,
    发药方式 药品收发记录.发药方式%Type,
    发药时间 药品收发记录.审核日期%Type);
  Type t_处方发料_Sql Is Table Of 处方发料_Sql;
  --医嘱发送记录生成SQL
  Type 医嘱发送_Sql Is Record(
    医嘱id     病人医嘱发送.医嘱id%Type,
    发送号     病人医嘱发送.发送号%Type,
    记录性质   病人医嘱发送.记录性质%Type,
    NO         病人医嘱发送.No%Type,
    记录序号   病人医嘱发送.记录序号%Type,
    发送数次   病人医嘱发送.发送数次%Type,
    首次时间   病人医嘱发送.首次时间%Type,
    末次时间   病人医嘱发送.末次时间%Type,
    发送时间   病人医嘱发送.发送时间%Type,
    执行状态   病人医嘱发送.执行状态%Type,
    执行部门id 病人医嘱发送.执行部门id%Type,
    计费状态   病人医嘱发送.计费状态%Type,
    First      Number := 0,
    样本条码   病人医嘱发送.样本条码%Type := Null,
    操作员编号 人员表.编号%Type := Null,
    操作员姓名 人员表.姓名%Type := Null);
  Type t_医嘱发送_Sql Is Table Of 医嘱发送_Sql;

  --医嘱执行计价SQL
  Type 执行计价_Sql Is Record(
    医嘱id     医嘱执行计价.医嘱id%Type,
    发送号     医嘱执行计价.发送号%Type,
    要求时间   医嘱执行计价.要求时间%Type,
    收费细目id 医嘱执行计价.收费细目id%Type,
    数量       医嘱执行计价.数量%Type,
    费用性质   医嘱执行计价.费用性质%Type);

  Type t_执行计价_Sql Is Table Of 执行计价_Sql;

  --可执行SQL记录
  r_计价     t_医嘱计价_Sql := t_医嘱计价_Sql();
  r_费用     t_病人费用_Insert := t_病人费用_Insert();
  r_发料     t_处方发料_Sql := t_处方发料_Sql();
  r_发送     t_医嘱发送_Sql := t_医嘱发送_Sql();
  r_执行计价 t_执行计价_Sql := t_执行计价_Sql();

  --缓存数据
  Vsadvice    t_Advice;
  Rs_Price    t_Price;
  Rs_Bill     t_Bill := t_Bill();
  Rs_Exec     t_Exec;
  Rs_Number   t_Number := t_Number();
  Rs_Moneynow t_Moneynow := t_Moneynow();
  Rs_Moneyday t_Moneyday;

  --公用的
  Gv_Nodeno         Varchar2(20); --站点,外部传入
  Gn_Decprice       Number := 0; --系统参数
  Gn_Dec            Number := 0;
  Gb_加班加价       Boolean := False; --外部传入
  Gv_动态费别       Varchar2(4000);
  Gb_从项汇总折扣   Boolean := False;
  Gb_执行前先结算   Boolean := False;
  Gn_Rxcount        Number := 0;
  Gv_门诊发送划价单 Varchar2(400);
  Gn_消费验证       Number;
  Gb_门诊自动发料   Boolean;
  Gb_发送生成条形码 Boolean;

  --过程级的变量
  Mn_病人id     病人信息.病人id%Type;
  Mn_挂号id     病人信息.病人id%Type;
  Mv_挂号单     病人挂号记录.No%Type;
  Mv_门诊号     病人挂号记录.门诊号%Type;
  Mv_姓名       病人挂号记录.姓名%Type;
  Mv_性别       病人挂号记录.性别%Type;
  Mv_年龄       病人挂号记录.年龄%Type;
  Mv_操作员编号 人员表.编号%Type;
  Mv_操作员姓名 人员表.姓名%Type;

  Mv_费别             Varchar2(400);
  Mv_医嘱ids          Varchar2(4000);
  Mv_Msg              Varchar2(4000);
  Mb_Auto             Boolean := False;
  Mn_Nosequence       Number := 0; --单据号序列重新初始
  Mn_Sendno           Number := 0;
  Mv_单据组合类别     Varchar2(400);
  Mb_检验单独产生单据 Boolean := False;
  Mb_一并给药发一张   Boolean := False;
  Mb_Starttimedef     Boolean := False;

  -------------外部直接传入的XML内容-------------
  n_病人id     Number;
  n_就诊id     Number;
  v_医嘱ids    Varchar2(8000);
  v_Tmp        Varchar2(3000);
  v_站点       Varchar2(2);
  n_记帐       Number;
  v_操作员姓名 人员表.姓名%Type;
  v_操作员编号 人员表.编号%Type;
  n_加班加价   Number;
  n_调用       Number;
  n_返回       Number;
  I            Number;
  x_t          Xmltype;

  ----------------------子方法区域---------------------
  --获取出错信息
  Function f_Geterrmsg Return Varchar2 Is
  Begin
    Return Mv_Msg;
  End;

  --错误处理中心包内部调用
  Procedure p_Errcenter(Msg_In In Varchar2) Is
  Begin
    Mv_Msg := Msg_In;
  End;

  --检验LIS接口
  Procedure p_Lis接口
  (
    调用_In In Number,
    返回_In In Number,
    Xml_Out Out Xmltype
  ) Is
    --------------------------------------------------------------------------------------------------
    --功能:LIS检验接口
    --调用_IN 是否直接调用LIS存储过程,1-调用,0-不调用;
    --返回_in 是否返回调用LIS过程时的参数
    --出参:Xml_Out，生成的医嘱ID串，错误信息
    --  <OUTPUT>
    --    <LISAPP>C:44271,E:44272;C:44273,E:44274</LISAPP>检验医嘱信息，固定格式：类别:医嘱ID,类别:医嘱ID;....
    --    <LISDATA></LISDATA>新版LIS检验信息，返回值
    --         LISDATA 此结点的内容，为 Zl_Thrid_Sendlisapplication 过程的 入参数，
    --         结点内容可以有行<IN>XXX1</IN><IN>XXX2</IN>.....
    --    <ERROR>
    --      <MSG>错误信息</MSG>
    --    </ERROR>
    --  </OUTPUT>
    --------------------------------
    --申请基本信息，医嘱id_In 检验行医嘱ID
    Cursor c_Pati(医嘱id_In In 病人医嘱记录.Id%Type) Is
      Select a.Id As 医嘱id, a.相关id As 申请id, a.病人来源, a.病人id, a.婴儿, c.姓名, Decode(c.性别, '男', 1, '女', 2, '未知', 9, 0) 性别, a.年龄,
             a.开嘱医生 As 申请人, a.开嘱时间 As 申请时间, d.名称 As 申请科室, c.当前床号 As 床号, c.健康号, e.名称 As 病人科室, a.紧急标志, a.挂号单, c.门诊号, c.住院号,
             c.出生日期, a.主页id, b.接收人 As 签收人, b.接收时间 As 签收时间, b.采样人, b.采样时间, b.样本条码, 1 As 病人类型, Null As 路径状态, b.送检人,
             b.标本送出时间 As 送检时间, b.计费状态, a.诊疗项目id, f.编码 As 诊疗编码, a.标本部位 As 标本类型, b.记录性质, e.编码 As 病人科室编码, d.编码 As 申请科室编码,
             g.编码 As 病区编码, g.名称 As 病区
      From 病人医嘱记录 A, 病人医嘱发送 B, 病人信息 C, 部门表 D, 部门表 E, 诊疗项目目录 F, 部门表 G
      Where a.Id = b.医嘱id And a.病人id = c.病人id And a.开嘱科室id = d.Id And a.病人科室id = e.Id And a.诊疗项目id = f.Id And
            c.当前病区id = g.Id(+) And a.Id = 医嘱id_In;
    r_Pati c_Pati%RowType;

    --采集行 医嘱id_In 采集行医嘱ID
    Cursor c_Cjrow(医嘱id_In In 病人医嘱记录.Id%Type) Is
      Select 医嘱id_In As 医嘱id, b.名称 As 采集方式, c.名称 As 采集科室, Sum(d.应收金额) As 应收金额, Sum(Decode(d.记录状态, 1, d.实收金额, 0)) As 实收金额,
             Max(d.记录状态) As 记录状态, Max(d.记录性质) As 记录性质
      From 病人医嘱记录 A, 诊疗项目目录 B, 部门表 C, 门诊费用记录 D
      Where a.诊疗项目id = b.Id And a.执行科室id = c.Id And a.Id = d.医嘱序号(+) And a.Id = 医嘱id_In
      Group By b.名称, c.名称;
    r_Cj c_Cjrow%RowType;

    --检验行 医嘱id_In 检验行医嘱ID
    Cursor c_Jyrow(医嘱id_In In 病人医嘱记录.Id%Type) Is
      Select 医嘱id_In As 医嘱id, Max(a.费别) As 费别, Max(a.记录状态) As 记录状态, Max(a.记录性质) As 记录性质, Sum(a.应收金额) As 应收金额,
             Sum(Decode(a.记录状态, 1, a.实收金额, 0)) As 实收金额
      From 门诊费用记录 A
      Where a.医嘱序号 = 医嘱id_In;
    r_Jy c_Jyrow%RowType;

    v_Tmp      Varchar(32767);
    v_Lisinfo  Varchar2(30000);
    v_Lisapp   Varchar2(3000);
    x_Lis      Xmltype;
    n_医嘱id   Number(18);
    x_T1       Xmltype;
    x_T2       Xmltype;
    n_记录状态 Number;
    n_记录性质 Number;
    n_计费状态 Number;
    v_Lisids   Varchar(8000);
    v_Err_Msg  Varchar(2000);
    Err_Item Exception;
  Begin
    For I In 1 .. Vsadvice.Count Loop
      If Vsadvice(I).诊疗类别 = 'C' Then
        v_Lisapp := v_Lisapp || ';C:' || Vsadvice(I).Id;
      Elsif Vsadvice(I).诊疗类别 = 'E' And Vsadvice(I).操作类型 = '6' Then
        v_Lisapp := v_Lisapp || ',E:' || Vsadvice(I).Id;
      End If;
    End Loop;
    v_Lisids := Substr(v_Lisapp, 2);
    x_Lis    := Xmltype('<LISDATA></LISDATA>');
    v_Lisapp := v_Lisids || ';';

    While v_Lisapp Is Not Null Loop
      v_Tmp    := Substr(v_Lisapp, 1, Instr(v_Lisapp, ';') - 1);
      v_Lisapp := Substr(v_Lisapp, Instr(v_Lisapp, ';') + 1);
      v_Tmp    := Replace(Replace(v_Tmp, 'C:', ''), ',E:', ',');
      n_医嘱id := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1));
      Open c_Pati(n_医嘱id);
      Fetch c_Pati
        Into r_Pati;
      Close c_Pati;
      Open c_Jyrow(n_医嘱id);
      Fetch c_Jyrow
        Into r_Jy;
      Close c_Jyrow;

      n_医嘱id := To_Number(Substr(v_Tmp, Instr(v_Tmp, ',') + 1));
      Open c_Cjrow(n_医嘱id);
      Fetch c_Cjrow
        Into r_Cj;
      Close c_Cjrow;

      --获取计费状态
      n_记录状态 := Nvl(r_Cj.记录状态, 0);
      n_记录性质 := Nvl(r_Cj.记录性质, 0);
      If n_记录性质 = 2 And n_记录状态 = 1 Then
        n_计费状态 := 3;
      Else
        If n_记录状态 = 0 Then
          n_计费状态 := 0;
        Else
          If n_记录状态 = 1 Then
            n_计费状态 := 1;
          Else
            If n_记录状态 = 2 Or n_记录状态 = 3 Then
              n_计费状态 := 2;
            Else
              n_计费状态 := 0;
            End If;
          End If;
        End If;
      End If;

      v_Lisinfo := '<IN>';
      v_Lisinfo := v_Lisinfo || '<TYPE>0</TYPE><ADVICE>';

      v_Lisinfo := v_Lisinfo || '<SQID>' || r_Cj.医嘱id || '</SQID>';
      v_Lisinfo := v_Lisinfo || '<YZID>' || r_Jy.医嘱id || '</YZID>';
      v_Lisinfo := v_Lisinfo || '<BRLY>1</BRLY>';
      v_Lisinfo := v_Lisinfo || '<BRID>' || r_Pati.病人id || '</BRID>';
      v_Lisinfo := v_Lisinfo || '<YE>0</YE>';
      v_Lisinfo := v_Lisinfo || '<XM>' || r_Pati.姓名 || '</XM>';
      v_Lisinfo := v_Lisinfo || '<XB>' || r_Pati.性别 || '</XB>';
      v_Lisinfo := v_Lisinfo || '<NL>' || r_Pati.年龄 || '</NL>';
      v_Lisinfo := v_Lisinfo || '<NLSZ>' || Substr(r_Pati.年龄, 1, Instr(r_Pati.年龄, '岁') - 1) || '</NLSZ>';
      v_Lisinfo := v_Lisinfo || '<NLDW>' || Substr(r_Pati.年龄, Instr(r_Pati.年龄, '岁')) || '</NLDW>';
      v_Lisinfo := v_Lisinfo || '<XMBM>' || r_Pati.诊疗编码 || '</XMBM>';
      v_Lisinfo := v_Lisinfo || '<BBLX>' || r_Pati.标本类型 || '</BBLX>';
      v_Lisinfo := v_Lisinfo || '<SQR>' || r_Pati.申请人 || '</SQR>';
      v_Lisinfo := v_Lisinfo || '<SQSJ>' || To_Char(r_Pati.申请时间, 'yyyy-mm-dd hh24:mi:ss') || '</SQSJ>';
      v_Lisinfo := v_Lisinfo || '<SQKS>' || r_Pati.申请科室 || '</SQKS>';
      v_Lisinfo := v_Lisinfo || '<CH>' || r_Pati.床号 || '</CH>'; --
      v_Lisinfo := v_Lisinfo || '<JKH>' || r_Pati.健康号 || '</JKH>'; --
      v_Lisinfo := v_Lisinfo || '<BRKS>' || r_Pati.病人科室 || '</BRKS>'; --
      v_Lisinfo := v_Lisinfo || '<JJ>' || r_Pati.紧急标志 || '</JJ>'; --
      v_Lisinfo := v_Lisinfo || '<GHD>' || r_Pati.挂号单 || '</GHD>'; --
      v_Lisinfo := v_Lisinfo || '<MZH>' || r_Pati.门诊号 || '</MZH>'; --
      v_Lisinfo := v_Lisinfo || '<ZYH>' || r_Pati.住院号 || '</ZYH>'; --
      v_Lisinfo := v_Lisinfo || '<CSRQ >' || To_Char(r_Pati.出生日期, 'yyyy-mm-dd hh24:mi:ss') || '</CSRQ>'; --
      v_Lisinfo := v_Lisinfo || '<ZYID>' || r_Pati.主页id || '</ZYID>'; --
      v_Lisinfo := v_Lisinfo || '<QSR>' || r_Pati.签收人 || '</QSR>'; --
      v_Lisinfo := v_Lisinfo || '<QSSJ>' || To_Char(r_Pati.签收时间, 'yyyy-mm-dd hh24:mi:ss') || '</QSSJ>'; --
      v_Lisinfo := v_Lisinfo || '<CYR>' || r_Pati.采样人 || '</CYR>'; --
      v_Lisinfo := v_Lisinfo || '<CYSJ>' || To_Char(r_Pati.采样时间, 'yyyy-mm-dd hh24:mi:ss') || '</CYSJ>'; --
      v_Lisinfo := v_Lisinfo || '<SJR>' || r_Pati.送检人 || '</SJR>'; --
      v_Lisinfo := v_Lisinfo || '<SJSJ>' || To_Char(r_Pati.送检时间, 'yyyy-mm-dd hh24:mi:ss') || '</SJSJ>'; --
      v_Lisinfo := v_Lisinfo || '<JFZT>' || n_计费状态 || '</JFZT>'; --计费状态，单独处理
      v_Lisinfo := v_Lisinfo || '<BQ>' || r_Pati.病区 || '</BQ>'; --
      v_Lisinfo := v_Lisinfo || '<BQBM>' || r_Pati.病区编码 || '</BQBM>'; --
      v_Lisinfo := v_Lisinfo || '<SQKSBM>' || r_Pati.申请科室编码 || '</SQKSBM>'; --
      v_Lisinfo := v_Lisinfo || '<BRKSBM>' || r_Pati.病人科室编码 || '</BRKSBM>'; --
      v_Lisinfo := v_Lisinfo || '<BRLX>' || r_Pati.病人类型 || '</BRLX>'; --
      v_Lisinfo := v_Lisinfo || '<LJZT>' || r_Pati.路径状态 || '</LJZT>'; --
      v_Lisinfo := v_Lisinfo || '<YBTM>' || r_Pati.样本条码 || '</YBTM>'; --

      v_Lisinfo := v_Lisinfo || '<CJFS>' || r_Cj.采集方式 || '</CJFS>'; --
      v_Lisinfo := v_Lisinfo || '<CJKS>' || r_Cj.采集科室 || '</CJKS>'; --
      v_Lisinfo := v_Lisinfo || '<YSJE>' || r_Jy.应收金额 || '</YSJE>'; --检验行
      v_Lisinfo := v_Lisinfo || '<SSJE>' || r_Jy.实收金额 || '</SSJE>'; --检验行
      v_Lisinfo := v_Lisinfo || '<FB>' || r_Jy.费别 || '</FB>'; --
      v_Lisinfo := v_Lisinfo || '<ZD></ZD>'; --诊断，暂时无
      v_Lisinfo := v_Lisinfo || '<YEXM></YEXM>'; --婴儿姓名，门诊无婴儿这一说
      v_Lisinfo := v_Lisinfo || '<YEXB></YEXB>'; --婴儿性别，门诊无
      v_Lisinfo := v_Lisinfo || '<YZFX></YZFX>'; --医嘱附项 无
      v_Lisinfo := v_Lisinfo || '<CJYSJE>' || r_Cj.应收金额 || '</CJYSJE>'; --采集行
      v_Lisinfo := v_Lisinfo || '<CJSSJE>' || r_Cj.实收金额 || '</CJSSJE>'; --采集行

      v_Lisinfo := v_Lisinfo || '</ADVICE></IN>';

      If 返回_In = 1 Then
        Select Appendchildxml(x_Lis, '/LISDATA', Xmltype(v_Lisinfo)) Into x_Lis From Dual;
      End If;

      If 调用_In = 1 Then
        Begin
          x_T1 := Xmltype(v_Lisinfo);
          Execute Immediate 'Begin Zl_Thrid_Sendlisapplication(:1,:2); End;'
            Using In x_T1, Out x_T2;
        Exception
          When Others Then
            v_Err_Msg := '调用LIS检验接口出错。';
            Raise Err_Item;
        End;
        If x_T2 Is Not Null Then
          Select Extractvalue(Value(A), 'OUTPUT/ERROR/MSG')
          Into v_Err_Msg
          From Table(Xmlsequence(Extract(x_T2, 'OUTPUT'))) A;
          If v_Err_Msg Is Not Null Then
            Raise Err_Item;
          End If;
        End If;
      End If;
    End Loop;
    If 返回_In = 1 Then
      Select Appendchildxml(Xml_Out, '/OUTPUT', x_Lis) Into Xml_Out From Dual;
      Select Appendchildxml(Xml_Out, '/OUTPUT', Xmltype('<LISAPP>' || v_Lisids || '</LISAPP>')) Into Xml_Out From Dual;
    End If;
  Exception
    When Err_Item Then
      v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>';
      Xml_Out := Xmltype(v_Tmp);
    When Others Then
      v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
      Xml_Out := Xmltype(v_Tmp);
  End;

  --生成真正的NO
  Procedure p_Replacetrueno Is

    Type r_No Is Record(
      No_False Varchar2(200),
      No_True  Varchar2(200));
    Type t_No Is Table Of r_No;
    Rsno t_No := t_No();

    v_Curno Varchar2(200);
    v_No    Varchar2(200);
    I       Number;
    J       Number;
  Begin
    --发送记录
    For I In 1 .. r_发送.Count Loop
      v_Curno := r_发送(I).No;
      v_No    := Null;
      For J In 1 .. Rsno.Count Loop
        If Rsno(J).No_False = v_Curno Then
          v_No := Rsno(J).No_True;
          Exit;
        End If;
      End Loop;
      If v_No Is Null Then
        If Substr(v_Curno, 1, 2) = '13' Then
          Select Nextno(13, Null, Null, 1) Into v_No From Dual;
        Else
          Select Nextno(14, Null, Null, 1) Into v_No From Dual;
        End If;
        Rsno.Extend;
        Rsno(Rsno.Count).No_False := v_Curno;
        Rsno(Rsno.Count).No_True := v_No;
      End If;
      r_发送(I).No := v_No;
    End Loop;

    --费用记录
    For I In 1 .. r_费用.Count Loop
      v_Curno := r_费用(I).No;
      v_No    := Null;
      For J In 1 .. Rsno.Count Loop
        If Rsno(J).No_False = v_Curno Then
          v_No := Rsno(J).No_True;
          Exit;
        End If;
      End Loop;
      If v_No Is Null Then
        If Substr(v_Curno, 1, 2) = '13' Then
          Select Nextno(13, Null, Null, 1) Into v_No From Dual;
        Else
          Select Nextno(14, Null, Null, 1) Into v_No From Dual;
        End If;
        Rsno.Extend;
        Rsno(Rsno.Count).No_False := v_Curno;
        Rsno(Rsno.Count).No_True := v_No;
      End If;
      r_费用(I).No := v_No;
    End Loop;

    --发料
    For I In 1 .. r_发料.Count Loop
      v_Curno := r_发料(I).No;
      v_No    := Null;
      For J In 1 .. Rsno.Count Loop
        If Rsno(J).No_False = v_Curno Then
          v_No := Rsno(J).No_True;
          Exit;
        End If;
      End Loop;
      If v_No Is Null Then
        If Substr(v_Curno, 1, 2) = '13' Then
          Select Nextno(13, Null, Null, 1) Into v_No From Dual;
        Else
          Select Nextno(14, Null, Null, 1) Into v_No From Dual;
        End If;
        Rsno.Extend;
        Rsno(Rsno.Count).No_False := v_Curno;
        Rsno(Rsno.Count).No_True := v_No;
      End If;
      r_发料(I).No := v_No;
    End Loop;
  End;

  --获取当前费用单据的NO及序号
  Procedure p_Getcurbillset
  (
    Key_In       In Varchar2,
    费用序号_In  In Number,
    发送序号_In  In Number,
    记帐_In      In Boolean,
    No_Out       Out Varchar2,
    费用序号_Out Out Number,
    发送序号_Out Out Number
  ) Is
    b_Have Boolean;
    n_Tmp  Number;
  Begin

    b_Have := False;
    For I In 1 .. Rs_Bill.Count Loop
      If Rs_Bill(I).Key = Key_In Then
        n_Tmp  := I;
        b_Have := True;
        Exit;
      End If;
    End Loop;

    If Not b_Have Then
      Rs_Bill.Extend;
      n_Tmp := Rs_Bill.Count;
      Rs_Bill(n_Tmp).Key := Key_In;
      --取单据号
      Mn_Nosequence := Mn_Nosequence + 1;
      If 记帐_In Then
        Rs_Bill(n_Tmp).No := 14;
      Else
        Rs_Bill(n_Tmp).No := 13;
      End If;
      Rs_Bill(n_Tmp).No := Rs_Bill(n_Tmp).No || LPad(Mn_Nosequence, 4, '0');
      If 费用序号_In = -1 Then
        Rs_Bill(n_Tmp).费用序号 := 0;
      Else
        Rs_Bill(n_Tmp).费用序号 := 1;
      End If;
      If 发送序号_In = -1 Then
        Rs_Bill(n_Tmp).发送序号 := 0;
      Else
        Rs_Bill(n_Tmp).发送序号 := 1;
      End If;
    Else
      If 费用序号_In <> -1 Then
        Rs_Bill(n_Tmp).费用序号 := Rs_Bill(n_Tmp).费用序号 + 1;
      End If;
      If 发送序号_In <> -1 Then
        Rs_Bill(n_Tmp).发送序号 := Rs_Bill(n_Tmp).发送序号 + 1;
      End If;
    End If;

    No_Out := Rs_Bill(n_Tmp).No;
    If 费用序号_In <> -1 Then
      费用序号_Out := Rs_Bill(n_Tmp).费用序号;
    End If;
    If 发送序号_In <> -1 Then
      发送序号_Out := Rs_Bill(n_Tmp).发送序号;
    End If;

  End;
  --获取指定病人某天(dat收费时间)之后医嘱产生的费用项目明细
  Function f_Getpatidaymoneydetail
  (
    病人id_In   In Number,
    主页id_In   In Number,
    收费时间_In In Date
  ) Return Number Is

    Cursor c_Detail Is
      Select a.诊疗项目id, c.收费细目id As 收费项目id, c.执行部门id, Decode(Nvl(c.执行状态, 0), 0, 0, 1) As 执行否,
             To_Char(b.首次时间, 'yyyy-mm-dd') As 首次时间, Trunc(b.末次时间) - Trunc(b.首次时间) + 1 As 天数, 0 As 收费方式,
             To_Char(b.末次时间, 'yyyy-mm-dd') As 末次时间, a.频率间隔, a.间隔单位, a.医嘱期效, a.Id, Nvl(a.相关id, 0) As 相关id
      From 病人医嘱记录 A, 病人医嘱发送 B, 门诊费用记录 C
      Where a.病人id = 病人id_In And Nvl(a.主页id, 0) = 主页id_In And a.医嘱期效 = 1 And a.Id = b.医嘱id And b.记录性质 = c.记录性质 And
            b.No = c.No And b.医嘱id = c.医嘱序号 And c.记录状态 In (0, 1) And b.末次时间 >= 收费时间_In
      Union
      Select a.诊疗项目id, d.收费细目id, d.执行科室id As 执行部门id, 0 As 执行否, To_Char(b.首次时间, 'yyyy-mm-dd') As 首次时间,
             Trunc(b.末次时间) - Trunc(b.首次时间) + 1 As 天数, -1 As 收费方式, To_Char(b.末次时间, 'yyyy-mm-dd') As 末次时间, a.频率间隔, a.间隔单位,
             a.医嘱期效, a.Id, Nvl(a.相关id, 0) As 相关id
      From 病人医嘱记录 A, 病人医嘱发送 B, 病人医嘱计价 D
      Where a.病人id = 病人id_In And Nvl(a.主页id, 0) = 主页id_In And a.医嘱期效 = 1 And a.Id = b.医嘱id And b.末次时间 >= 收费时间_In And
            a.Id = d.医嘱id And d.收费方式 = 7 And Not Exists
       (Select 1
             From 门诊费用记录 C
             Where c.收费细目id = d.收费细目id And b.记录性质 = c.记录性质 And b.No = c.No And a.Id = c.医嘱序号)
      Order By 诊疗项目id, 收费项目id;

    d_Day Date;

    n_Tmp Number := 0;
    I     Number;

    n_诊疗项目id Number(18);
    n_收费项目id Number(18);
    n_执行部门id Number(18);
    n_执行否     Number(1);
    v_首次时间   Varchar2(18);
    n_天数       Number(3);
    n_收费方式   Number(1);
    v_末次时间   Varchar2(18);
    n_频率间隔   Number(18);
    v_间隔单位   Varchar2(18);
    n_医嘱期效   Number(1);
    n_Id         Number(18);
    n_相关id     Number(18);

    Procedure p_Addmoneydayitem Is
    Begin
      n_Tmp := 0;
      For I In 1 .. Rs_Moneyday.Count Loop
        If Rs_Moneyday(I)
         .诊疗项目id = n_诊疗项目id And Rs_Moneyday(I).收费项目id = n_收费项目id And Rs_Moneyday(I)
           .收费时间 = To_Char(d_Day, 'yyyy-MM-dd') And Rs_Moneyday(I).执行否 = n_执行否 And Rs_Moneyday(I).收费方式 = n_收费方式 Then
          n_Tmp := 1;
          Exit;
        End If;
      End Loop;
      If n_Tmp = 0 Then
        Rs_Moneyday.Extend;
        n_Tmp := Rs_Moneyday.Count;
        Rs_Moneyday(n_Tmp).诊疗项目id := n_诊疗项目id;
        Rs_Moneyday(n_Tmp).收费项目id := n_收费项目id;
        Rs_Moneyday(n_Tmp).执行部门id := n_执行部门id;
        Rs_Moneyday(n_Tmp).执行否 := n_执行否;
        Rs_Moneyday(n_Tmp).收费方式 := n_收费方式;
        Rs_Moneyday(n_Tmp).收费时间 := To_Char(d_Day, 'yyyy-MM-dd');
      End If;
    End;
  Begin

    Open c_Detail;
    Loop
      Fetch c_Detail
        Into n_诊疗项目id, n_收费项目id, n_执行部门id, n_执行否, v_首次时间, n_天数, n_收费方式, v_末次时间, n_频率间隔, v_间隔单位, n_医嘱期效, n_Id, n_相关id;
      Exit When c_Detail%NotFound;
      If n_频率间隔 = 1 And v_间隔单位 = '天' Or v_间隔单位 = '小时' Or v_间隔单位 = '分钟' Then
        For I In 1 .. n_天数 Loop
          If I = 1 Then
            d_Day := To_Date(v_首次时间, 'yyyy-MM-dd');
          Else
            d_Day := To_Date(v_首次时间, 'yyyy-MM-dd') + I - 1;
          End If;
          If d_Day >= 收费时间_In Then
            p_Addmoneydayitem;
          End If;
        End Loop;
      Else
        --对于临嘱这里可能会漏算
        d_Day := To_Date(v_首次时间, 'yyyy-MM-dd');
        If d_Day >= 收费时间_In Then
          p_Addmoneydayitem;
        End If;
        d_Day := To_Date(v_末次时间, 'yyyy-MM-dd');
        If d_Day >= 收费时间_In Then
          p_Addmoneydayitem;
        End If;
      End If;
    End Loop;
    Close c_Detail;
    Return(1);
  End;

  --根据管码获取对应的试管材料ID
  Function f_Gettubematerial(编码_In In 采血管类型.编码%Type) Return Number Is
    n_材料id 采血管类型.材料id%Type;
  Begin
    Select Max(材料id) Into n_材料id From 采血管类型 Where 编码 = 编码_In;
    Return(n_材料id);
  End;

  --判断指定的医嘱费用是否应该产生
  Function f_Advicemoneymake
  (
    病人id_In     In Number,
    医嘱id_In     In Number,
    诊疗项目id_In In Number,
    收费项目id_In In Number,
    执行部门id_In In Number,
    试管编码_In   In Varchar2,
    收费类别_In   In Varchar2,
    收费方式_In   In Number,
    分解时间_In   In Varchar2,
    总量_In       In Number,
    当前医嘱id_In In Number,
    发送号_In     In Number,
    计价数量_In   In Number,
    计算方式_In   In Number,
    频率_In       In Varchar2,
    单量_In       In Number,
    期效_In       In Number,
    费用性质_In   In Number,
    诊疗类别_In   In Varchar2,
    样本条码_In   In Varchar2,
    费用次数_Out  Out Number
  ) Return Number Is

    Type r_Days Is Record(
      收费时间 Varchar2(30),
      存在     Number(1));
    Type t_Days Is Table Of r_Days;
    Rsdays t_Days := t_Days();

    Arrtmp      t_Strlist := t_Strlist();
    n_Rtn       Number;
    n_Tmp       Number;
    b_Makemoney Boolean;
    n_材料id    Number;
    n_Cnt存在   Number;
    v_Tmp       Varchar2(30000);
    v_Tmp1      Varchar2(30000);

    n_数量    Number := 0;
    v_Date    Varchar2(30);
    n_总量tmp Number := 0;
    n_单量tmp Number := 0;
    b_Tmp     Boolean;

  Begin
    b_Makemoney  := True;
    费用次数_Out := 1;
    n_Rtn        := 1;

    If 收费方式_In = 9 Then
      --自定义
      Null;
    End If;

    If 收费方式_In = 0 Then
      --正常收费的，检查在本次发送中、本医嘱中是否被排斥
      For I In 1 .. Rs_Moneynow.Count Loop
        If Rs_Moneynow(I).医嘱id = 医嘱id_In And Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And
            (Rs_Moneynow(I).收费方式 = 5 Or Rs_Moneynow(I).收费方式 = 6) Then
          b_Makemoney := False;
          Exit;
        End If;
      End Loop;
    Elsif 收费方式_In = 1 Then
      --检验试管费用(一次发送只收取一次)
      If 试管编码_In Is Not Null Then
        For I In 1 .. Rs_Moneynow.Count Loop
          If Rs_Moneynow(I).试管编码 = 试管编码_In And Rs_Moneynow(I).样本条码 = 样本条码_In And Rs_Moneynow(I).收费项目id = 收费项目id_In And
              Nvl(Rs_Moneynow(I).收费方式, 0) <> -1 Then
            b_Makemoney := False;
            Exit;
          End If;
        End Loop;
        --只收取试管对应的卫材费用
        If b_Makemoney And 收费类别_In = '4' Then
          n_材料id := f_Gettubematerial(试管编码_In);
          If n_材料id <> 0 And 收费项目id_In <> n_材料id Then
            b_Makemoney := False;
          End If;
        End If;
      End If;
    Elsif 收费方式_In = 2 Then
      --一次发送只收取一次

      For I In 1 .. Rs_Moneynow.Count Loop
        If Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And Rs_Moneynow(I).收费项目id = 收费项目id_In And Nvl(Rs_Moneynow(I).收费方式, 0) <> -1 Then
          b_Makemoney := False;
          Exit;
        End If;
      End Loop;
    Elsif Instr(',3,4,5,6,7,', 收费方式_In) > 0 Then
      --3-当天只收取一次；4-当天未执行收取一次；5-当天只收取一次，排斥其他项目；6-当天未执行收取一次，排斥其他项目
      --正常收费的，检查在本次发送中、本医嘱中是否被排斥
      If 收费方式_In = 7 Then
        For I In 1 .. Rs_Moneynow.Count Loop
          If Rs_Moneynow(I).医嘱id = 医嘱id_In And Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And
              (Rs_Moneynow(I).收费方式 = 5 Or Rs_Moneynow(I).收费方式 = 6) Then
            b_Makemoney := False;
            Exit;
          End If;
        End Loop;
      End If;

      If b_Makemoney Then
        v_Tmp := 分解时间_In;
        While v_Tmp Is Not Null Loop
          If Instr(',' || v_Tmp1 || ',', ',' || Substr(v_Tmp, 1, 10) || ',') = 0 Then
            v_Tmp1 := v_Tmp1 || ',' || Substr(v_Tmp, 1, 10);
            Rsdays.Extend;
            Rsdays(Rsdays.Count).收费时间 := Substr(v_Tmp, 1, 10);
            Rsdays(Rsdays.Count).存在 := 0;
          End If;
          v_Tmp := Substr(v_Tmp, 21);
        End Loop;

        --先从本次发送中的找(频率为一天一次且没有收的，判断时当成已收取,以便后续的其他医嘱'首次不收'时不再认为有首次)
        For J In 1 .. Rsdays.Count Loop
          For I In 1 .. Rs_Moneynow.Count Loop
            If Rs_Moneynow(I)
             .收费时间 = Rsdays(J).收费时间 And Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And Rs_Moneynow(I).收费项目id = 收费项目id_In Then

              If 收费方式_In = 7 Then
                Rsdays(J).存在 := 1;
                Exit;
              Elsif (收费方式_In = 4 Or 收费方式_In = 6) And Nvl(执行部门id_In, 0) <> 0 And Rs_Moneynow(I).执行部门id = 执行部门id_In Then
                Rsdays(J).存在 := 1;
                Exit;
              Elsif Nvl(Rs_Moneynow(I).收费方式, 0) <> -1 Then
                Rsdays(J).存在 := 1;
                Exit;
              End If;
            End If;
          End Loop;
        End Loop;

        --再从已发送中的找(当天及将来执行的)
        n_Cnt存在 := 0;
        For J In 1 .. Rsdays.Count Loop
          If Rsdays(J).存在 = 0 Then
            n_Cnt存在 := n_Cnt存在 + 1;
            If Rs_Moneyday Is Null Then
              Rs_Moneyday := t_Moneyday();
              n_Tmp       := f_Getpatidaymoneydetail(病人id_In, 0, To_Date(Rsdays(J).收费时间, 'YYYY-MM-DD'));
            End If;
            For J In 1 .. Rsdays.Count Loop
              For I In 1 .. Rs_Moneyday.Count Loop
                If Rs_Moneyday(I)
                 .收费时间 = Rsdays(J).收费时间 And Rs_Moneyday(I).诊疗项目id = 诊疗项目id_In And Rs_Moneyday(I).收费项目id = 收费项目id_In Then

                  If 收费方式_In = 7 And Nvl(Rs_Moneyday(I).收费方式, 0) <> -1 Then
                    Rsdays(J).存在 := 1;
                    n_Cnt存在 := n_Cnt存在 - 1;
                    Exit;
                  Elsif (收费方式_In = 4 Or 收费方式_In = 6) And Nvl(执行部门id_In, 0) <> 0 And Rs_Moneyday(I).执行部门id = 执行部门id_In Then
                    Rsdays(J).存在 := 1;
                    n_Cnt存在 := n_Cnt存在 - 1;
                    Exit;
                  Else
                    Rsdays(J).存在 := 1;
                    n_Cnt存在 := n_Cnt存在 - 1;
                    Exit;
                  End If;
                End If;
              End Loop;
            End Loop;
          End If;
        End Loop;
      End If;
    End If;
    --记录到本次发送明细项目记录中
    If Instr(',3,4,5,6,7,', 收费方式_In) > 0 Then
      If 收费方式_In = 7 Then
        If b_Makemoney Then
          --rsDays.Filter = '存在=0' n_Cnt存在 代替   --没收过的那些天(频率为一天一次但未收的当成收过了)，首次不收
          费用次数_Out := 总量_In - n_Cnt存在;
          If 费用次数_Out > 0 Then
            b_Makemoney := True;
          Else
            b_Makemoney := False;
          End If;
        End If;
      Else
        -- rsDays.Filter = '存在=0'
        -- B_makemoney = rsDays.RecordCount > 0
        -- lng费用次数 = rsDays.RecordCount    --一天一次，有多少天要收就有多少次
        费用次数_Out := n_Cnt存在;
        If n_Cnt存在 > 0 Then
          b_Makemoney := True;
        Else
          b_Makemoney := False;
        End If;
        Null;
      End If;
      If b_Makemoney Or 收费方式_In = 7 And 费用次数_Out = 0 Then
        For I In 1 .. Rsdays.Count Loop
          If Rsdays(I).存在 = 0 Then
            Rs_Moneynow.Extend;
            n_Tmp := Rs_Moneynow.Count;
            Rs_Moneynow(n_Tmp).医嘱id := 医嘱id_In;
            Rs_Moneynow(n_Tmp).诊疗项目id := 诊疗项目id_In;
            Rs_Moneynow(n_Tmp).收费项目id := 收费项目id_In;
            Rs_Moneynow(n_Tmp).试管编码 := 试管编码_In;
            Rs_Moneynow(n_Tmp).样本条码 := 样本条码_In;

            --首次不收时，如果频率为一天一次，则计算后的费用次数为0,为了让本次后续发送的其他医嘱正确计算首是否收取，需要产生记录，但收费方式特殊记录为-1
            -- rs_MoneyNow(n_tmp).收费方式 := IIF(收费方式_In := 7 And lng费用次数 := 0, -1, 收费方式_In)
            If 收费方式_In = 7 And 费用次数_Out = 0 Then
              Rs_Moneynow(n_Tmp).收费方式 := -1;
            Else
              Rs_Moneynow(n_Tmp).收费方式 := 收费方式_In;
            End If;
            Rs_Moneynow(n_Tmp).收费时间 := Rsdays(I).收费时间;
            Rs_Moneynow(n_Tmp).执行部门id := 执行部门id_In;
          End If;
        End Loop;
      End If;
    Elsif b_Makemoney Then
      Rs_Moneynow.Extend;
      n_Tmp := Rs_Moneynow.Count;
      Rs_Moneynow(n_Tmp).医嘱id := 医嘱id_In;
      Rs_Moneynow(n_Tmp).诊疗项目id := 诊疗项目id_In;
      Rs_Moneynow(n_Tmp).收费项目id := 收费项目id_In;
      Rs_Moneynow(n_Tmp).试管编码 := 试管编码_In;
      Rs_Moneynow(n_Tmp).样本条码 := 样本条码_In;
      Rs_Moneynow(n_Tmp).收费方式 := 收费方式_In;
      If 分解时间_In Is Null Then
        Rs_Moneynow(n_Tmp).收费时间 := Substr(分解时间_In, 1, 10); --yyyy-MM-dd
      Else
        Rs_Moneynow(n_Tmp).收费时间 := Null;
      End If;
      Rs_Moneynow(n_Tmp).执行部门id := 执行部门id_In;
    End If;

    --读取医嘱执行计价(除药品卫材医嘱外的才存储)
    If Instr(',5,6,7,', ',' || 诊疗类别_In || ',') = 0 Then
      If 分解时间_In Is Not Null Then
        -- arrTmp = Split(分解时间_In, ',');
        v_Tmp := 分解时间_In;
        While v_Tmp Is Not Null Loop
          Arrtmp.Extend;
          Arrtmp(Arrtmp.Count) := Substr(v_Tmp, 1, 19);
          v_Tmp := Substr(v_Tmp, 21);
        End Loop;

        n_总量tmp := 总量_In * 计价数量_In;
        n_单量tmp := 单量_In;
        If 单量_In = 0 Then
          n_单量tmp := 1;
        End If;
        For I In 1 .. Arrtmp.Count Loop
          Rs_Exec.Extend;
          n_Tmp := Rs_Exec.Count;
          Rs_Exec(n_Tmp).医嘱id := 当前医嘱id_In;
          Rs_Exec(n_Tmp).发送号 := 发送号_In;
          Rs_Exec(n_Tmp).要求时间 := Arrtmp(I);
          Rs_Exec(n_Tmp).收费细目id := 收费项目id_In;
          Rs_Exec(n_Tmp).费用性质 := 费用性质_In;
          If b_Makemoney Then
            --卫材也可以输入单量总量
            If 频率_In Is Not Null And
               ((计算方式_In = 0 Or 计算方式_In = 3) And 总量_In > 0 Or 计算方式_In = 1 Or 计算方式_In = 2 Or 诊疗类别_In = '4') Then
              --计量和计时的需要乘以数次
              If 期效_In = 0 Then
                --1、长嘱可选频率、持续性、必要时和不定时以单量作为数次。
                n_数量 := 计价数量_In * n_单量tmp;
              Else
                --3、临嘱可选频率取单量作为数次，最后一次剩余的数量，例如红外照射治疗，总量80、单量25，每天4次，那么执行登记时，供执行四次，前三次本次数次为25，第四次为80除以25取模=5。
                --门诊有可能没有录入执行时间,分解时间就只有一个，按总量作为次数
                If Arrtmp.Count = 1 Then
                  n_数量 := 计价数量_In * 总量_In;
                Else
                  If I = Arrtmp.Count Then
                    n_数量 := n_总量tmp;
                  Else
                    If n_总量tmp >= n_单量tmp Then
                      n_数量 := 计价数量_In * n_单量tmp;
                    Else
                      n_数量 := n_总量tmp;
                    End If;
                    n_总量tmp := n_总量tmp - n_数量;
                  End If;
                End If;
              End If;
            Else
              n_数量 := 计价数量_In;
            End If;
            If I <> 1 Then
              v_Date := Substr(Arrtmp(I - 1), 1, 10);
            End If;
            --一次发送收取一次，则只有第一次收取
            If Instr(',1,2,', 收费方式_In) > 0 Then
              If I <> 1 Then
                n_数量 := 0;
              End If;
            Elsif Instr(',3,4,5,6,', 收费方式_In) > 0 Then
              --3456当天只收取一次的，存在=0的收取，默认第一次有数量
              -- rsDays.Filter = '存在=0 And 收费时间=--' || Format(arrTmp(i), 'yyyy-MM-dd') || '--'
              b_Tmp := False;
              For J In 1 .. Rsdays.Count Loop
                If Rsdays(J).存在 = 0 And Rsdays(J).收费时间 = Substr(Arrtmp(I), 1, 10) Then
                  b_Tmp := True;
                End If;
              End Loop;
              If Not (b_Tmp And Substr(Arrtmp(I), 1, 10) <> v_Date) Then
                n_数量 := 0;
              End If;
            Elsif 收费方式_In = 7 Then
              --当天首次不收取的，存在=1就收取，存在=0的为首次
              --  rsDays.Filter = '存在=1 And 收费时间=--' || Format(arrTmp(i), 'yyyy-MM-dd') || '--'
              b_Tmp := False;
              For J In 1 .. Rsdays.Count Loop
                If Rsdays(J).存在 = 1 And Rsdays(J).收费时间 = Substr(Arrtmp(I), 1, 10) Then
                  b_Tmp := True;
                End If;
              End Loop;
              If Not b_Tmp And Substr(Arrtmp(I), 1, 10) <> v_Date Then
                n_数量 := 0;
              End If;
            End If;
          Else
            --如果不收取，则设置为0
            n_数量 := 0;
          End If;
          Rs_Exec(n_Tmp).数量 := n_数量;
        End Loop;
      End If;
    End If;
    If b_Makemoney Then
      n_Rtn := 1;
    Else
      n_Rtn := 0;
    End If;
    Return(n_Rtn);
  End;

  --获取非药收费项目的执行科室
  Function f_Get收费执行科室id Return Number Is
  Begin
    Return(0);
  End;

  --对检验医嘱生成样本条码
  Function f_Getcuvettenumber
  (
    管码_In       In Varchar2,
    医嘱id_In     In Number,
    相关id_In     In Number,
    类别_In       In Varchar2,
    操作类型_In   In 诊疗项目目录.操作类型%Type,
    执行科室id_In In Number,
    婴儿_In       In Number,
    诊疗项目id_In In Number,
    紧急_In       In Number,
    标本_In       In Varchar2,
    采集科室id_In In Number
  ) Return Varchar2 Is
    v_Tmp管码 Varchar2(300);
    v_Tmp条码 Varchar2(300);
    b_无数据  Boolean := False;
    I         Number;
    n_Tmp     Number;
    --检验医嘱才会有条码，采集行和检验行同用一个条码  检验项目--诊疗项目id
  Begin
    If 类别_In = 'C' And 管码_In Is Not Null Then
      --检验项目才有管码
      b_无数据 := True;
      For I In 1 .. Rs_Number.Count Loop
        If Rs_Number(I).相关id = 相关id_In Then
          b_无数据 := False;
          n_Tmp    := I;
          Exit;
        End If;
      End Loop;
      If b_无数据 Then
        For I In 1 .. Rs_Number.Count Loop
          If Rs_Number(I).诊疗项目id = 诊疗项目id_In Then
            b_无数据 := False;
            n_Tmp    := I;
            Exit;
          End If;
        End Loop;

        If b_无数据 Then
          For I In 1 .. Rs_Number.Count Loop
            If Rs_Number(I).管码 = 管码_In And Rs_Number(I).执行科室id = 执行科室id_In And Rs_Number(I).婴儿 = 婴儿_In And Rs_Number(I)
               .紧急标志 = 紧急_In And Rs_Number(I).标本 = 标本_In And Rs_Number(I).采集科室id = 采集科室id_In Then
              b_无数据 := False;
              n_Tmp    := I;
              Exit;
            End If;
          End Loop;

          If b_无数据 Then
            --生成新的条码
            Rs_Number.Extend;
            n_Tmp := Rs_Number.Count;
            Rs_Number(n_Tmp).管码 := 管码_In;
            Rs_Number(n_Tmp).相关id := 相关id_In;
            Rs_Number(n_Tmp).样本条码 := Nextno(125, 医嘱id_In, 诊疗项目id_In, 1);
            Rs_Number(n_Tmp).诊疗项目id := 诊疗项目id_In;
            Rs_Number(n_Tmp).执行科室id := 执行科室id_In;
            Rs_Number(n_Tmp).婴儿 := 婴儿_In;
            Rs_Number(n_Tmp).紧急标志 := 紧急_In;
            Rs_Number(n_Tmp).标本 := 标本_In;
            Rs_Number(n_Tmp).采集科室id := 采集科室id_In;
            v_Tmp条码 := Rs_Number(n_Tmp).样本条码;
          Else
            --相同管码、执行科室、婴儿的检验使用相同的样本条码
            v_Tmp管码 := Rs_Number(n_Tmp).管码;
            v_Tmp条码 := Rs_Number(n_Tmp).样本条码;
            Rs_Number.Extend;
            n_Tmp := Rs_Number.Count;
            Rs_Number(n_Tmp).管码 := v_Tmp管码;
            Rs_Number(n_Tmp).相关id := 相关id_In;
            Rs_Number(n_Tmp).样本条码 := v_Tmp条码;
            Rs_Number(n_Tmp).诊疗项目id := 诊疗项目id_In;
            Rs_Number(n_Tmp).执行科室id := 执行科室id_In;
            Rs_Number(n_Tmp).婴儿 := 婴儿_In;
            Rs_Number(n_Tmp).紧急标志 := 紧急_In;
            Rs_Number(n_Tmp).标本 := 标本_In;
            Rs_Number(n_Tmp).采集科室id := 采集科室id_In;
          End If;
        Else
          --生成新的条码：相同检验的医嘱使用'不同的'条码
          Rs_Number.Extend;
          n_Tmp := Rs_Number.Count;
          Rs_Number(n_Tmp).管码 := 管码_In;
          Rs_Number(n_Tmp).相关id := 相关id_In;
          Rs_Number(n_Tmp).样本条码 := Nextno(125, 医嘱id_In, 诊疗项目id_In, 1);
          Rs_Number(n_Tmp).诊疗项目id := 诊疗项目id_In;
          Rs_Number(n_Tmp).执行科室id := 执行科室id_In;
          Rs_Number(n_Tmp).婴儿 := 婴儿_In;
          Rs_Number(n_Tmp).紧急标志 := 紧急_In;
          Rs_Number(n_Tmp).标本 := 标本_In;
          Rs_Number(n_Tmp).采集科室id := 采集科室id_In;
          v_Tmp条码 := Rs_Number(n_Tmp).样本条码;
        End If;
      Else
        --一并采集的检验项目使用相同的条码
        v_Tmp管码 := Rs_Number(n_Tmp).管码;
        v_Tmp条码 := Rs_Number(n_Tmp).样本条码;
        Rs_Number.Extend;
        n_Tmp := Rs_Number.Count;
        Rs_Number(n_Tmp).管码 := v_Tmp管码;
        Rs_Number(n_Tmp).相关id := 相关id_In;
        Rs_Number(n_Tmp).样本条码 := v_Tmp条码;
        Rs_Number(n_Tmp).诊疗项目id := 诊疗项目id_In;
        Rs_Number(n_Tmp).执行科室id := 执行科室id_In;
        Rs_Number(n_Tmp).婴儿 := 婴儿_In;
        Rs_Number(n_Tmp).紧急标志 := 紧急_In;
        Rs_Number(n_Tmp).标本 := 标本_In;
        Rs_Number(n_Tmp).采集科室id := 采集科室id_In;
      End If;
    Elsif 类别_In = 'E' And 操作类型_In = '6' Then
      --采集方式使用与医嘱相同(最近)的条码
      I := Rs_Number.Count;
      If I > 0 Then
        If Nvl(Rs_Number(I).相关id, 0) = 医嘱id_In Then
          v_Tmp条码 := Rs_Number(I).样本条码;
        End If;
      End If;
    End If;
    Return(v_Tmp条码);
  End;

  --获取诊疗项目对应的诊疗单据
  Function f_Getclinicbillid(项目id_In In 诊疗项目目录.Id%Type) Return Number Is
    n_Tmp Number(18);
  Begin
    Select Max(病历文件id) Into n_Tmp From 病历单据应用 Where 诊疗项目id = 项目id_In;
    n_Tmp := Nvl(n_Tmp, 0);
    Return(n_Tmp);
  End;

  --一并给的第一个药品的执行科室
  Function f_Getmergedrugstore(Row_In In Number) Return Number Is
    n_药房id 部门表.Id%Type := 0;
    n_Begin  Number := 0;
  Begin
    If Nvl(Vsadvice(Row_In).相关id, 0) <> Nvl(Vsadvice(Row_In - 1).相关id, 0) And Nvl(Vsadvice(Row_In).执行科室id, 0) <> 0 Then
      n_药房id := Nvl(Vsadvice(Row_In).执行科室id, 0);
    Else
      For I In 1 .. Row_In - 1 Loop
        If Nvl(Vsadvice(Row_In).相关id, 0) = Nvl(Vsadvice(I).相关id, 0) Then
          If Nvl(Vsadvice(I).执行科室id, 0) <> 0 Then
            n_药房id := Nvl(Vsadvice(I).执行科室id, 0);
            Exit;
          End If;
        Else
          Exit;
        End If;
      End Loop;
      For I In n_Begin .. Vsadvice.Count Loop
        If Nvl(Vsadvice(Row_In).相关id, 0) <> Nvl(Vsadvice(I).相关id, 0) Then
          n_Begin := I;
          Exit;
        End If;
      End Loop;
    End If;
    Return(n_药房id);
  End;

  --根据收费细目ID或收入项目ID(前者优先),应收金额,按费别设置的分段比例打折规则计算实收金额
  Function f_Actualmoney
  (
    费别_In       In Varchar2,
    收入项目id_In In Number,
    应收金额_In   In Number,
    收费细目id_In In Number,
    库房id_In     In Number,
    数量_In       In Number,
    加班加价率_In In Number,
    费别_Out      Out Varchar2
  ) Return Number Is
    n_金额 病人医嘱计价.单价%Type := 0;
    v_Tmp  Varchar2(80);
  Begin
    Select Zl_Actualmoney(费别_In, 收费细目id_In, 收入项目id_In, (应收金额_In / (1 + 加班加价率_In)), 数量_In, 库房id_In) As Actualmoney
    Into v_Tmp
    From Dual;
    费别_Out := Substr(v_Tmp, 1, Instr(v_Tmp, ':') - 1);
    n_金额   := To_Number(Substr(v_Tmp, Instr(v_Tmp, ':') + 1));
    Return(n_金额);
  End;

  --时价单计算,仅用门诊
  Function f_Calcdrugprice
  (
    药品id_In In Number,
    药房id_In In Number,
    数量_In   In Number,
    费别_In   In Varchar2
  ) Return Number Is
    n_时价   收费价目.现价%Type := 0;
    n_总数量 收费价目.现价%Type := 0;
    v_Tmp    Varchar2(80);
    v_费别   Varchar2(800);
  Begin
    Select Zl_Fun_Getprice(药品id_In, 药房id_In, 数量_In, 0, Null) As 结果 Into v_Tmp From Dual;
    If v_Tmp Is Not Null Then
      v_Tmp    := v_Tmp || '|';
      n_时价   := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1));
      v_Tmp    := Substr(v_Tmp, Instr(v_Tmp, '|') + 1);
      n_总数量 := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1));
    End If;
    If n_总数量 = 0 And 费别_In Is Not Null Then
      n_时价 := Round(n_时价 * 数量_In, Gn_Dec);
      For R In (Select a.屏蔽费别, b.收入项目id
                From 收费项目目录 A, 收费价目 B
                Where a.Id = b.收费细目id And a.Id = 药品id_In And
                      ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null))) Loop
        If Not (Nvl(r.屏蔽费别, 0) = 1) Then
          v_费别 := 费别_In;
          If Gv_动态费别 Is Not Null Then
            v_费别 := v_费别 || ',' || Gv_动态费别;
          End If;
          n_时价 := f_Actualmoney(v_费别, r.收入项目id, n_时价, 药品id_In, 药房id_In, 数量_In, 0, v_Tmp);
        End If;
      End Loop;
    End If;
    Return(n_时价);
  End;

  --获取收费细目的当前售价价格金额
  Function f_Calcprice
  (
    项目id_In     In 收费项目目录.Id%Type,
    费别_In       In Varchar2,
    数量_In       In 诊疗收费关系.收费数量%Type,
    加班加价_In   In Boolean,
    n_执行科室id  In 部门表.Id%Type,
    卫材医嘱id_In In 病人医嘱记录.Id%Type
  ) Return Number Is
    n_单价 病人医嘱计价.单价%Type := 0;
    n_金额 病人医嘱计价.单价%Type := 0;
    v_Tmp  Varchar2(20);
    v_费别 Varchar2(20);
    n_加率 Number;
  Begin

    If 卫材医嘱id_In > 0 Then
      For R In (Select 单价 From 病人医嘱计价 Where 医嘱id = 卫材医嘱id_In And 收费细目id = 项目id_In) Loop
        n_单价 := r.单价;
        Exit;
      End Loop;
    End If;

    If 费别_In Is Null Then
      If (Not 加班加价_In) And Gb_加班加价 Then
        Select Sum(Decode(Nvl(a.是否变价, 0), 1, Decode(n_单价, 0, b.缺省价格, n_单价), b.现价) *
                    Decode(a.加班加价, 1, 1 + Nvl(b.加班加价率, 0) / 100, 1)) As 金额
        Into n_金额
        From 收费项目目录 A, 收费价目 B
        Where a.Id = b.收费细目id And a.Id = 项目id_In And
              ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null));
      Else
        Select Sum(Decode(Nvl(a.是否变价, 0), 1, Decode(n_单价, 0, b.缺省价格, n_单价), b.现价)) As 金额
        Into n_金额
        From 收费项目目录 A, 收费价目 B
        Where a.Id = b.收费细目id And a.Id = 项目id_In And
              ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null));

      End If;
    Else
      If (Not 加班加价_In) And Gb_加班加价 Then
        For R In (Select a.屏蔽费别, a.加班加价, b.加班加价率, b.收入项目id,
                         Decode(Nvl(a.是否变价, 0), 1, Decode(n_单价, 0, b.缺省价格, n_单价), b.现价) *
                          Decode(a.加班加价, 1, 1 + Nvl(b.加班加价率, 0) / 100, 1) As 金额
                  From 收费项目目录 A, 收费价目 B
                  Where a.Id = b.收费细目id And a.Id = 项目id_In And
                        ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null))) Loop
          If Nvl(r.屏蔽费别, 0) = 1 Then
            n_金额 := n_金额 + Round(数量_In * Nvl(r.金额, 0), Gn_Dec);
          Else
            v_费别 := 费别_In;
            If Gv_动态费别 Is Not Null Then
              v_费别 := v_费别 || ',' || Gv_动态费别;
            End If;
            n_加率 := 0;
            If (Not 加班加价_In) And Gb_加班加价 And Nvl(r.加班加价, 0) = 1 Then
              n_加率 := Nvl(r.加班加价率, 0) / 100;
              Null;
            End If;
            n_金额 := n_金额 + f_Actualmoney(v_费别, r.收入项目id, 数量_In * Nvl(r.金额, 0), 项目id_In, n_执行科室id, 数量_In, n_加率, v_Tmp);
          End If;
        End Loop;
      Else
        For R In (Select a.屏蔽费别, a.加班加价, b.加班加价率, b.收入项目id,
                         Decode(Nvl(a.是否变价, 0), 1, Decode(n_单价, 0, b.缺省价格, n_单价), b.现价) As 金额
                  From 收费项目目录 A, 收费价目 B
                  Where a.Id = b.收费细目id And a.Id = 项目id_In And
                        ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null))) Loop
          If Nvl(r.屏蔽费别, 0) = 1 Then
            n_金额 := n_金额 + Round(数量_In * Nvl(r.金额, 0), Gn_Dec);
          Else
            v_费别 := 费别_In;
            If Gv_动态费别 Is Not Null Then
              v_费别 := v_费别 || ',' || Gv_动态费别;
            End If;
            n_加率 := 0;
            If (Not 加班加价_In) And Gb_加班加价 And Nvl(r.加班加价, 0) = 1 Then
              n_加率 := Nvl(r.加班加价率, 0) / 100;
              Null;
            End If;
            n_金额 := n_金额 + f_Actualmoney(v_费别, r.收入项目id, 数量_In * Nvl(r.金额, 0), 项目id_In, n_执行科室id, 数量_In, n_加率, v_Tmp);
          End If;
        End Loop;
      End If;
    End If;
    Return(n_金额);
  End;

  --将医嘱执行的分解时间按次数进行截断
  Function f_Trim分解时间
  (
    次数_In In Number,
    v_分解  Varchar2
  ) Return Varchar2 Is
    v_Result Varchar2(4000);
    v_Tmp    Varchar2(4000);
  Begin
    v_Tmp := v_分解;
    For I In 1 .. 次数_In Loop
      v_Result := v_Result || ',' || Substr(v_Tmp, 1, 19);
      v_Tmp    := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
    End Loop;
    v_Result := Substr(v_Result, 2);
    Return(v_Result);
  End;

  --大于指定数的整数
  Function f_Intex(Num_In In Number) Return Number Is
    n_Num Number;
  Begin
    Select Round(Num_In) Into n_Num From Dual;
    If Num_In > n_Num Then
      n_Num := n_Num + 1;
    End If;
    Return(n_Num);
  End;

  --分解时间
  Function f_Calc次数分解时间
  (
    次数_In     In 病人医嘱记录.总给予量%Type,
    开始时间_In In Date,
    终止时间_In In Date,
    执行时间_In In 病人医嘱记录.执行时间方案%Type,
    频率间隔_In In 病人医嘱记录.频率间隔%Type,
    间隔单位_In In 病人医嘱记录.间隔单位%Type
  ) Return Varchar2 Is
    v_Detailtime Varchar2(4000);
    n_First      Number(1);
    v_First      病人医嘱记录.执行时间方案%Type;
    v_Normal     病人医嘱记录.执行时间方案%Type;
    v_Mtime      Varchar(100);
    v_Rtime      Varchar(100);
    v_Curtime    Date;
    v_Tmptime    Date;
    n_Cnt        Number; --计数器
    --求某时间所在周的星期一的日期
    Function Getweekbase(v_Time Date) Return Date Is
      v_Week Number(1);
    Begin
      v_Week := To_Number(To_Char(v_Time, 'D'));
      v_Week := v_Week - 1;
      If v_Week = 0 Then
        v_Week := 7;
      End If;
      Return(Trunc(v_Time - (v_Week - 1)));
    End;
  Begin

    n_Cnt := 0;

    --执行时间方案基准
    If Nvl(Instr(执行时间_In, ','), 0) > 0 Then
      v_First  := Substr(执行时间_In, 1, Instr(执行时间_In, ',') - 1);
      v_Normal := Substr(执行时间_In, Instr(执行时间_In, ',') + 1);
    Else
      v_First  := Null;
      v_Normal := 执行时间_In;
    End If;

    If 间隔单位_In = '周' Then
      v_Curtime := Getweekbase(开始时间_In); --按周执行时在医嘱开始那周的星期一作为基准
    Else
      v_Curtime := 开始时间_In;
    End If;
    If 间隔单位_In = '周' Then
      If v_First Is Not Null Then
        If v_Curtime = Getweekbase(开始时间_In) Then
          n_First := 1;
        End If;
      End If;
      While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop
        If Nvl(n_First, 0) = 1 Then
          v_Rtime := v_First || '-';
        Else
          v_Rtime := v_Normal || '-';
        End If;
        n_First := 0;
        --1/8:00-3/8:00-5/8:00
        While v_Rtime Is Not Null Loop
          v_Mtime   := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
          v_Tmptime := v_Curtime + To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, '/') - 1)) - 1;
          v_Mtime   := Substr(v_Mtime, Instr(v_Mtime, '/') + 1);
          If Instr(v_Mtime, ':') = 0 Then
            v_Mtime := v_Mtime || ':00';
          End If;
          v_Tmptime := Trunc(v_Tmptime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
          If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In Then
            v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
            n_Cnt        := n_Cnt + 1;
            If n_Cnt >= 次数_In Then
              Exit;
            End If;
          Elsif v_Tmptime > 终止时间_In Then
            Exit;
          End If;
          v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
        End Loop;
        v_Curtime := Trunc(v_Curtime + 7);
      End Loop;
    Elsif 间隔单位_In = '天' Then
      If v_First Is Not Null Then
        If Trunc(开始时间_In) = Trunc(开始时间_In) Then
          n_First := 1;
        End If;
      End If;
      While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop
        If Nvl(n_First, 0) = 1 Then
          v_Rtime := v_First || '-';
        Else
          v_Rtime := v_Normal || '-';
        End If;
        n_First := 0;
        If 频率间隔_In = 1 Then
          --8:00-12:00-14:00；8-12-14
          While v_Rtime Is Not Null Loop
            v_Mtime := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
            If Instr(v_Mtime, ':') = 0 Then
              v_Mtime := v_Mtime || ':00';
            End If;
            v_Tmptime := Trunc(v_Curtime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
            If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In Then

              v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
              n_Cnt        := n_Cnt + 1;
              If n_Cnt >= 次数_In Then
                Exit;

              End If;
            Elsif v_Tmptime > 终止时间_In Then
              Exit;
            End If;
            v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
          End Loop;
        Else
          --1/8:00-1/15:00-2/9:00
          While v_Rtime Is Not Null Loop
            v_Mtime   := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
            v_Tmptime := v_Curtime + To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, '/') - 1)) - 1;
            v_Mtime   := Substr(v_Mtime, Instr(v_Mtime, '/') + 1);
            If Instr(v_Mtime, ':') = 0 Then
              v_Mtime := v_Mtime || ':00';
            End If;
            v_Tmptime := Trunc(v_Tmptime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
            If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In Then

              v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
              n_Cnt        := n_Cnt + 1;
              If n_Cnt >= 次数_In Then
                Exit;

              End If;
            Elsif v_Tmptime > 终止时间_In Then
              Exit;
            End If;
            v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
          End Loop;
        End If;
        v_Curtime := Trunc(v_Curtime + 频率间隔_In); --因为Loop条件注意要取整
      End Loop;
    Elsif 间隔单位_In = '小时' Then
      --10:00-20:00-40:00；10-20-40；02:30
      While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop

        v_Rtime := 执行时间_In || '-';
        While v_Rtime Is Not Null Loop
          v_Mtime := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
          If Instr(v_Mtime, ':') = 0 Then
            v_Tmptime := v_Curtime + (To_Number(v_Mtime) - 1) / 24;
          Else
            v_Tmptime := v_Curtime + (To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, ':') - 1)) - 1) / 24 +
                         To_Number(Substr(v_Mtime, Instr(v_Mtime, ':') + 1)) / 60 / 24;
          End If;

          If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In Then

            v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
            n_Cnt        := n_Cnt + 1;
            If n_Cnt >= 次数_In Then
              Exit;
            End If;

          Elsif v_Tmptime > 终止时间_In Then
            Exit;
          End If;
          v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
        End Loop;
        v_Curtime := v_Curtime + 频率间隔_In / 24;
      End Loop;
    Elsif 间隔单位_In = '分钟' Then
      --无执行时间
      While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop
        v_Tmptime := v_Curtime;
        If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In Then
          v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
          n_Cnt        := n_Cnt + 1;
          If n_Cnt >= 次数_In Then
            Exit;
          End If;
        Elsif v_Tmptime > 终止时间_In Then
          Exit;
        End If;
        v_Curtime := v_Curtime + 频率间隔_In / (24 * 60);
      End Loop;
    End If;
    If v_Detailtime Is Not Null Then
      v_Detailtime := Substr(v_Detailtime, 2);
    End If;
    Return(v_Detailtime);
  End;

  --库存
  Function f_库存
  (
    药品id_In In 病人挂号记录.病人id%Type,
    库房id_In In 药品库存.库房id%Type
  ) Return Number Is
    n_库存 药品库存.可用数量%Type := 0;
  Begin
    Select Nvl(Sum(a.可用数量), 0) / Nvl(b.门诊包装, 1) As 库存
    Into n_库存
    From 药品库存 A, 药品规格 B
    Where a.药品id = b.药品id(+) And a.性质 = 1 And (Nvl(a.批次, 0) = 0 Or a.效期 Is Null Or a.效期 > Trunc(Sysdate)) And
          a.药品id = 药品id_In And a.库房id = 库房id_In
    Group By Nvl(b.门诊包装, 1), a.库房id;
    Return(n_库存);
  End;

  Function f_Main
  (
    站点_In       In 部门表.站点%Type,
    挂号id_In     In 病人挂号记录.病人id%Type,
    病人id_In     In 病人挂号记录.病人id%Type,
    医嘱ids_In    In Varchar2,
    加班加价_In   In Number,
    操作员编号_In In 人员表.编号%Type,
    操作员姓名_In In 人员表.姓名%Type
  ) Return Number Is
  Begin
    Mn_病人id  := 病人id_In;
    Mn_挂号id  := 挂号id_In;
    Mv_医嘱ids := 医嘱ids_In;
    Gv_Nodeno  := 站点_In;
    If 加班加价_In = 1 Then
      Gb_加班加价 := True;
    Else
      Gb_加班加价 := False;
    End If;
    Mv_操作员编号 := 操作员编号_In;
    Mv_操作员姓名 := 操作员姓名_In;
    Return(1);
  Exception
    When Others Then
      p_Errcenter(SQLErrM);
      Return(0);
  End;

  --读取参数相关
  Procedure p_Load Is
    n_Tmp Number := 0;
    v_Tmp Varchar2(400);
  Begin

    --金额小数位数
    Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')), Zl_To_Number(Nvl(zl_GetSysParameter(157), '5')),
           zl_GetSysParameter(86)
    Into Gn_Dec, Gn_Decprice, Gv_门诊发送划价单
    From Dual;

    --执行前先结算
    n_Tmp := Zl_To_Number(Nvl(zl_GetSysParameter(163), '0'));
    If n_Tmp <> 0 Then
      Gb_执行前先结算 := True;
    End If;

    --从属项目汇总计算折扣
    n_Tmp := To_Number(Nvl(zl_GetSysParameter(93), 0));
    If n_Tmp <> 0 Then
      Gb_从项汇总折扣 := True;
    End If;

    --处方条数限制
    Gn_Rxcount := To_Number(Nvl(zl_GetSysParameter(56), 0));

    v_Tmp       := 0 || zl_GetSysParameter(28) || '|';
    Gn_消费验证 := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1));

    --门诊自动发料
    n_Tmp := Zl_To_Number(Nvl(zl_GetSysParameter(92), '0'));
    If n_Tmp <> 0 Then
      Gb_门诊自动发料 := True;
    Else
      Gb_门诊自动发料 := False;
    End If;

    --检验医嘱发送时生成条形码
    n_Tmp := Zl_To_Number(Nvl(zl_GetSysParameter(143), '0'));
    If n_Tmp <> 0 Then
      Gb_发送生成条形码 := True;
    Else
      Gb_发送生成条形码 := False;
    End If;

    Mn_Sendno       := To_Number(Nvl(zl_GetSysParameter('发送单据号规则', 1252), 0));
    Mv_单据组合类别 := Nvl(zl_GetSysParameter('产生为同一单据的医嘱类别', 1252), 0);
    n_Tmp           := To_Number(Nvl(zl_GetSysParameter('检验医嘱单独产生单据', 1252), 0));
    If n_Tmp = 1 Then
      Mb_检验单独产生单据 := True;
    End If;
    n_Tmp := To_Number(Nvl(zl_GetSysParameter('一并给药发送为一张', 1252), 1));
    If 1 = n_Tmp Then
      Mb_一并给药发一张 := True;
    End If;

    --开始时间不是同一天的分别产生单据
    n_Tmp := To_Number(Nvl(zl_GetSysParameter('开始时间不是同一天的分别产生单据', 1252), 1));
    If 1 = n_Tmp Then
      Mb_Starttimedef := True;
    End If;

    Select a.费别, b.门诊号, b.姓名, b.性别, b.年龄, b.No
    Into Mv_费别, Mv_门诊号, Mv_姓名, Mv_性别, Mv_年龄, Mv_挂号单
    From 病人信息 A, 病人挂号记录 B
    Where a.病人id = b.病人id And b.Id = Mn_挂号id;
    --读取动态费别,发送关闭后清除
    --(忽略)gstr动态费别 = Load动态费别(mlng接诊科室ID)
    --对 Gv_动态费别 赋值
  Exception
    When Others Then
      p_Errcenter(SQLErrM);
      --zl_ErrorCenter(SQLCode, SQLErrM);
  End;

  --读取指定医嘱(仅当前行)的计价关系到临时记录集,并计算缺省发送金额(按费别打折)
  Function f_Loadadviceprice
  (
    Row_In        In Number,
    Id_In         In 人员表.Id%Type,
    相关id_In     In 人员表.Id%Type,
    诊疗项目id_In In 人员表.Id%Type,
    收费细目id_In In 人员表.Id%Type,
    执行科室id_In In 人员表.Id%Type,
    是否变价_In   In 材料特性.跟踪在用%Type,
    跟踪在用_In   In 材料特性.跟踪在用%Type,
    可否分零_In   In 材料特性.跟踪在用%Type,
    诊疗类别_In   In 诊疗项目目录.类别%Type,
    执行性质_In   In 病人医嘱记录.执行性质%Type,
    门诊包装_In   In 药品规格.门诊包装%Type,
    剂量系数_In   In 药品规格.剂量系数%Type,
    计价特性_In   In 病人医嘱记录.计价特性%Type,
    标本部位_In   In 病人医嘱记录.标本部位%Type,
    检查方法_In   In 病人医嘱记录.检查方法%Type,
    执行标记_In   In 病人医嘱记录.执行标记%Type,
    金额_Out      Out 门诊费用记录.实收金额%Type
  ) Return Number Is

    b_零费记帐 Boolean := False;
    b_附加手术 Boolean := False;
    b_Havesub  Boolean := False;

    b_Do         Boolean := False;
    n_Row        Number := 0;
    n_数量       Number(16, 5) := 0;
    n_金额       门诊费用记录.实收金额%Type := 0;
    n_实收       门诊费用记录.实收金额%Type := 0;
    n_应收       门诊费用记录.实收金额%Type := 0;
    n_单价       门诊费用记录.实收金额%Type := 0;
    n_加班率     门诊费用记录.实收金额%Type := 0;
    n_材料id     人员表.Id%Type := 0;
    v_Sql        Varchar2(30000);
    v_Price      Varchar2(20000);
    v_费用性质   Varchar2(200);
    n_费用性质   Number := 0;
    n_项目id     人员表.Id%Type := 0;
    n_主收入id   人员表.Id%Type := 0;
    n_执行科室id 人员表.Id%Type := 0;
    v_费别       Varchar2(30);
    v_Tmp        Varchar2(3000);

    Type r_Recordset_Tmp Is Record(
      类别       Varchar2(30),
      收费项目id Number,
      收费数量   Number,
      固有对照   Number,
      收入项目id Number,
      加班加价   Number,
      加班加价率 Number,
      单价       Number,
      是否变价   Number,
      从项       Number,
      跟踪在用   Number,
      执行科室id Number,
      屏蔽费别   Number,
      费用性质   Number,
      收费方式   Number);
    Type t_Tmp Is Table Of r_Recordset_Tmp;
    Rs_Tmp  t_Tmp := t_Tmp();
    n_Rsrow Number := 0;

    c_Tmp Rs_Recordset;
  Begin
    If Vsadvice(Row_In).零费记帐 = 1 Then
      b_零费记帐 := True;
    End If;
    金额_Out := 0;
    If Instr(',4,5,6,7,', 诊疗类别_In) > 0 Then
      --不为院外执行(自备药),药品不可能为叮嘱,且固定正常计价
      If Nvl(执行性质_In, 0) <> 5 Then
        Rs_Price.Extend;
        n_Row := Rs_Price.Count;
        Rs_Price(n_Row).医嘱id := Id_In;
        Rs_Price(n_Row).相关id := 相关id_In;
        Rs_Price(n_Row).费用性质 := 0;
        Rs_Price(n_Row).收费方式 := 0;
        Rs_Price(n_Row).收费类别 := 诊疗类别_In;
        Rs_Price(n_Row).收费细目id := 收费细目id_In;
        Rs_Price(n_Row).执行科室id := 执行科室id_In;
        Rs_Price(n_Row).数量 := 1;
        Rs_Price(n_Row).在用 := Nvl(跟踪在用_In, 0);
        Rs_Price(n_Row).变价 := Nvl(是否变价_In, 0);
        Rs_Price(n_Row).固定 := 1;
        Rs_Price(n_Row).从项 := 0;

        --发送的零售数量
        If 诊疗类别_In = '7' Then
          If Nvl(可否分零_In, 0) = 0 Then
            n_数量 := Vsadvice(Row_In).总量 * Vsadvice(Row_In).单量 / Nvl(剂量系数_In, 1);
          Else
            n_数量 := Vsadvice(Row_In)
                    .总量 * f_Intex(Vsadvice(Row_In).单量 / Nvl(剂量系数_In, 1) / Nvl(门诊包装_In, 1)) * Nvl(门诊包装_In, 1);
          End If;
        Else
          n_数量 := Vsadvice(Row_In).总量 * Nvl(门诊包装_In, 1);
        End If;
        --记录售价单价
        If Nvl(是否变价_In, 0) = 0 Or 诊疗类别_In = '4' And Nvl(跟踪在用_In, 0) = 0 Then
          Rs_Price(n_Row).单价 := f_Calcprice(收费细目id_In, Null, Null, True, 0, 0);
        Else
          --以售价计算药品时价,自备药时无对应药房
          Rs_Price(n_Row).单价 := f_Calcdrugprice(收费细目id_In, Nvl(执行科室id_In, 0), n_数量, Null);
        End If;
        If Not b_零费记帐 Then
          If Mv_费别 Is Not Null Then
            If Nvl(是否变价_In, 0) = 0 Or 诊疗类别_In = '4' And Nvl(跟踪在用_In, 0) = 0 Then
              n_金额 := f_Calcprice(收费细目id_In, Mv_费别, n_数量, False, Nvl(执行科室id_In, 0), 0);
            Else
              --以售价计算药品时价,自备药时无对应药房
              n_金额 := f_Calcdrugprice(收费细目id_In, Nvl(执行科室id_In, 0), n_数量, Mv_费别);
            End If;
          Else
            If Gb_加班加价 Then
              If Nvl(是否变价_In, 0) = 0 Or 诊疗类别_In = '4' And Nvl(跟踪在用_In, 0) = 0 Then
                n_单价 := f_Calcprice(收费细目id_In, Null, Null, False, 0, 0);
              Else
                --以售价计算药品时价,自备药时无对应药房
                --n_金额:= f_Calcdrugprice(收费细目id_In, Nvl(执行科室id_In, 0), n_数量, Null);
                n_单价 := Rs_Price(n_Row).单价;
              End If;
              n_金额 := Round(Rs_Price(n_Row).数量 * n_数量 * n_单价, Gn_Dec);
            Else
              n_金额 := Round(Rs_Price(n_Row).数量 * n_数量 * Rs_Price(n_Row).单价, Gn_Dec);
            End If;
          End If;
        End If;
      End If;
      金额_Out := n_金额;
    Else
      --取诊疗收费 关系中的对照(发送时才定计价):正常计价,不为叮嘱、院外执行
      If Nvl(计价特性_In, 0) = 0 And Instr(',0,5,', Nvl(执行性质_In, 0)) = 0 Then
        If Vsadvice(Row_In).试管编码 Is Not Null Then
          n_材料id := f_Gettubematerial(Vsadvice(Row_In).试管编码);
        End If;
        n_数量 := Vsadvice(Row_In).总量;
        --几种对应的计价情况
        If 标本部位_In Is Not Null And 检查方法_In Is Not Null Then
          v_Price := ' And c.检查部位=:3 And c.检查方法=:4 And Nvl(c.费用性质,0)=0';
        Elsif Nvl(执行标记_In, 0) = 0 Then
          v_Price := ' And c.检查部位 Is Null And c.检查方法 is Null And Nvl(c.费用性质,0)=0 and (1=1 or c.检查方法=:3 or c.检查方法=:4)';
        Else
          --目前包含床旁或术中加收的情况
          v_Price := ' And c.检查部位 Is Null And c.检查方法 is Null And Nvl(c.费用性质,0) IN(0,1) and (1=1 or c.检查方法=:3 or c.检查方法=:4)';
        End If;
        If 诊疗类别_In = 'F' And 相关id_In Is Not Null Then
          b_附加手术 := True;
        End If;
        v_Price := 'Select * From ( Select C.诊疗项目ID,C.收费项目ID,C.检查部位,C.检查方法,C.费用性质,C.收费数量,C.固有对照,C.从属项目,C.收费方式,c.适用科室id' ||
                   ',Max(Nvl(c.适用科室id, 0)) Over(Partition By c.诊疗项目id, c.检查部位, c.检查方法, c.费用性质) As Top' ||
                   ' From 诊疗收费关系 C Where C.诊疗项目ID=:1 And (C.适用科室ID is Null And C.病人来源 = 0 or C.适用科室ID =:2 And C.病人来源 = 1) ' ||
                   v_Price || '  ) Where Nvl(适用科室id, 0) = Top';
        v_Sql   := 'Select C.类别,A.收费项目ID,A.收费数量,A.固有对照,B.收入项目ID,C.加班加价,B.加班加价率,Decode(C.是否变价,1,B.缺省价格,B.现价)';
        If b_附加手术 Then
          v_Sql := v_Sql || '*Nvl(B.附术收费率,100)/100 ';
        End If;
        v_Sql := v_Sql || '  as 单价,C.是否变价,Nvl(A.从属项目,0) as 从项,D.跟踪在用,' || 执行科室id_In ||
                 ' as 执行科室ID,C.屏蔽费别,Nvl(A.费用性质,0) as 费用性质,' || 'Nvl(A.收费方式,0) as 收费方式 ' || ' From ( ' || v_Price ||
                 ') A,收费价目 B,收费项目目录 C,材料特性 D' || '  Where A.收费项目ID=B.收费细目ID And A.收费项目ID=C.ID And A.收费项目ID=D.材料ID(+)' ||
                 ' And C.服务对象 IN(1,3) And (C.撤档时间=To_Date(''3000-01-01'',''YYYY-MM-DD'') Or C.撤档时间 is NULL)' ||
                 ' And (C.站点=''' || Gv_Nodeno || ''' Or C.站点 is Null)' ||
                 ' And ((Sysdate Between B.执行日期 and B.终止日期) or (Sysdate>=B.执行日期 And B.终止日期 is NULL))' ||
                 ' And (Nvl(A.收费方式,0)=1 And C.类别=''4'' And A.收费项目ID=:5 Or Not(Nvl(A.收费方式,0)=1 And C.类别=''4'' And ';

        If n_材料id <> 0 Then
          v_Sql := v_Sql || ' 1=1 ';
        Else
          v_Sql := v_Sql || ' 0=1 ';
        End If;
        v_Sql := v_Sql || ' )) Order by 费用性质,从项,A.收费项目ID';

        Open c_Tmp For v_Sql
          Using In 诊疗项目id_In, In 执行科室id_In, In 标本部位_In, In 检查方法_In, In n_材料id;
        Fetch c_Tmp Bulk Collect
          Into Rs_Tmp;
        Close c_Tmp;
        For I In 1 .. Rs_Tmp.Count Loop
          If Instr(',' || v_费用性质 || ',', ',' || Rs_Tmp(I).费用性质 || ',') = 0 Then
            v_费用性质 := v_费用性质 || ',' || Rs_Tmp(I).费用性质;
          End If;
        End Loop;
        v_费用性质 := Substr(v_费用性质, 2);
        While v_费用性质 Is Not Null Loop
          n_费用性质 := Substr(v_费用性质, 1, 1);
          v_费用性质 := Substr(v_费用性质, 3);

          For I In 1 .. Rs_Tmp.Count Loop
            If Rs_Tmp(I).费用性质 = n_费用性质 Then
              n_项目id   := 0;
              n_金额     := 0;
              n_主收入id := 0;
              b_Havesub  := False;
              If Gb_从项汇总折扣 Then
                n_Rsrow := I;
                For J In n_Rsrow .. Rs_Tmp.Count Loop
                  If Rs_Tmp(J).费用性质 = n_费用性质 Then
                    If Nvl(Rs_Tmp(J).从项, 0) = 0 Then
                      --SQL中主项排在前面,只取主项目的第一个收入
                      If n_主收入id = 0 Then
                        n_主收入id := Rs_Tmp(J).收入项目id;
                      End If;
                    Elsif Nvl(Rs_Tmp(J).从项, 0) = 1 Then
                      b_Havesub := True;
                      Exit;
                    End If;
                  End If;
                End Loop;
              End If;
            End If;
          End Loop;

          --正向循环方式,循环结束后再处理最后一条
          For I In 1 .. Rs_Tmp.Count Loop
            If Rs_Tmp(I).费用性质 = n_费用性质 Then
              n_Rsrow := I;
              b_Do    := False;
              If Rs_Tmp(n_Rsrow).收费项目id <> n_项目id And n_项目id <> 0 Then
                b_Do := True;
              End If;
              If b_Do Then
                If Rs_Price(n_Row).单价 Is Not Null Then
                  Rs_Price(n_Row).单价 := Round(Rs_Price(n_Row).单价, Gn_Decprice);
                End If;
                --医嘱发送金额
                n_金额 := n_金额 + Round(n_实收, Gn_Dec);
              End If;
              ---------------------------
              If Rs_Tmp(n_Rsrow).收费项目id <> n_项目id Then
                n_实收 := 0;
                Rs_Price.Extend;
                n_Row := Rs_Price.Count;
                Rs_Price(n_Row).医嘱id := Id_In;
                Rs_Price(n_Row).相关id := 相关id_In;
                Rs_Price(n_Row).费用性质 := Nvl(Rs_Tmp(n_Rsrow).费用性质, 0);
                Rs_Price(n_Row).收费方式 := Nvl(Rs_Tmp(n_Rsrow).收费方式, 0);
                Rs_Price(n_Row).收费类别 := Rs_Tmp(n_Rsrow).类别;
                Rs_Price(n_Row).收费细目id := Rs_Tmp(n_Rsrow).收费项目id;
                Rs_Price(n_Row).执行科室id := 执行科室id_In;
                Rs_Price(n_Row).数量 := Nvl(Rs_Tmp(n_Rsrow).收费数量, 0);
                Rs_Price(n_Row).在用 := Nvl(Rs_Tmp(n_Rsrow).跟踪在用, 0);
                Rs_Price(n_Row).变价 := Nvl(Rs_Tmp(n_Rsrow).是否变价, 0);
                Rs_Price(n_Row).固定 := Nvl(Rs_Tmp(n_Rsrow).固有对照, 0);
                Rs_Price(n_Row).从项 := Nvl(Rs_Tmp(n_Rsrow).从项, 0);
                --执行科室:非药嘱药品及跟踪卫材的专门取
                n_执行科室id := Nvl(Rs_Tmp(n_Rsrow).执行科室id, 0);
                If Rs_Tmp(n_Rsrow)
                 .类别 = '4' And Nvl(Rs_Tmp(n_Rsrow).跟踪在用, 0) = 1 Or Instr(',5,6,7,', Rs_Tmp(n_Rsrow).类别) > 0 Then

                  n_执行科室id := n_执行科室id;
                  -- lng执行科室ID = Get收费执行科室ID(mlng病人ID, 0, rsTmp!类别, rsTmp!收费项目ID, 4, NVL(rsSend!病人科室id, 0), 0, 1, lng执行科室ID)
                End If;
                If Nvl(n_执行科室id, 0) <> 0 Then
                  Rs_Price(n_Row).执行科室id := n_执行科室id;
                Else
                  Rs_Price(n_Row).执行科室id := 0;
                End If;
                Null;
              End If;
              n_项目id := Rs_Tmp(n_Rsrow).收费项目id;

              --计算单价和实收
              If (Nvl(Rs_Tmp(n_Rsrow).是否变价, 0) = 1 And Instr(',5,6,7,', Rs_Tmp(n_Rsrow).类别) > 0) Or
                 (Nvl(Rs_Tmp(n_Rsrow).是否变价, 0) = 1 And Rs_Tmp(n_Rsrow).类别 = '4' And Nvl(Rs_Tmp(n_Rsrow).跟踪在用, 0) = 1) Then

                --非药嘱药品计价按时价计算(仅一个收入),其它变价需要由医生输入
                --跟踪在用的时价卫材和药品一样计算
                Rs_Price(n_Row).单价 := f_Calcdrugprice(Rs_Tmp(n_Rsrow).收费项目id, Rs_Price(n_Row).执行科室id,
                                                      n_数量 * Nvl(Rs_Tmp(n_Rsrow).收费数量, 0), Null);

                n_应收 := Rs_Price(n_Row).数量 * n_数量 * Round(Rs_Price(n_Row).单价, Gn_Decprice);

                --处理加班加价
                If Gb_加班加价 And Nvl(Rs_Tmp(n_Rsrow).加班加价, 0) = 1 Then
                  n_应收 := n_应收 * (1 + Nvl(Rs_Tmp(n_Rsrow).加班加价率, 0) / 100);
                End If;
                n_应收 := Round(n_应收, Gn_Dec);

                If Not b_零费记帐 Then
                  If Nvl(Rs_Tmp(n_Rsrow).屏蔽费别, 0) = 0 And Mv_费别 Is Not Null And (Not (Gb_从项汇总折扣 And b_Havesub)) Then
                    v_费别 := Mv_费别;
                    If Gv_动态费别 Is Not Null Then
                      v_费别 := v_费别 || ',' || Gv_动态费别;
                    End If;
                    If Gb_加班加价 And Nvl(Rs_Tmp(n_Rsrow).加班加价, 0) = 1 Then
                      n_加班率 := Nvl(Rs_Tmp(n_Rsrow).加班加价率, 0) / 100;
                    Else
                      n_加班率 := 0;
                    End If;
                    n_实收 := n_实收 +
                            Round(f_Actualmoney(v_费别, Rs_Tmp(n_Rsrow).收入项目id, n_应收, Rs_Tmp(n_Rsrow).收费项目id, n_执行科室id,
                                                (Rs_Price(n_Row).数量 * n_数量), n_加班率, v_Tmp), Gn_Dec);
                  Else
                    n_实收 := n_实收 + n_应收;
                  End If;
                End If;
              Else
                --固定价格或普通变价(只有一个收入项目)
                Rs_Price(n_Row).单价 := Nvl(Rs_Price(n_Row).单价, 0) + Nvl(Rs_Tmp(n_Rsrow).单价, 0);

                n_应收 := Rs_Price(n_Row).数量 * n_数量 * Round(Rs_Tmp(n_Rsrow).单价, Gn_Decprice);
                --处理加班加价
                If Gb_加班加价 And Nvl(Rs_Tmp(n_Rsrow).加班加价, 0) = 1 Then
                  n_应收 := n_应收 * (1 + Nvl(Rs_Tmp(n_Rsrow).加班加价率, 0) / 100);
                End If;
                n_应收 := Round(n_应收, Gn_Dec);
                If Not b_零费记帐 Then
                  If Nvl(Rs_Tmp(n_Rsrow).屏蔽费别, 0) = 0 And Mv_费别 Is Not Null And (Not (Gb_从项汇总折扣 And b_Havesub)) Then
                    v_费别 := Mv_费别;
                    If Gv_动态费别 Is Not Null Then
                      v_费别 := v_费别 || ',' || Gv_动态费别;
                    End If;
                    If Gb_加班加价 And Nvl(Rs_Tmp(n_Rsrow).加班加价, 0) = 1 Then
                      n_加班率 := Nvl(Rs_Tmp(n_Rsrow).加班加价率, 0) / 100;
                    Else
                      n_加班率 := 0;
                    End If;
                    n_实收 := n_实收 +
                            Round(f_Actualmoney(v_费别, Rs_Tmp(n_Rsrow).收入项目id, n_应收, Rs_Tmp(n_Rsrow).收费项目id, n_执行科室id,
                                                (Rs_Price(n_Row).数量 * n_数量), n_加班率, v_Tmp), Gn_Dec);
                  Else
                    n_实收 := n_实收 + n_应收;
                  End If;
                End If;
              End If;
            End If;
          End Loop;

          --循环结再处理最后一条
          If Nvl(n_项目id, 0) <> 0 Then
            If Rs_Price(n_Row).单价 Is Not Null Then
              Rs_Price(n_Row).单价 := Round(Rs_Price(n_Row).单价, Gn_Decprice);
            End If;
            --医嘱发送金额
            n_金额 := n_金额 + Round(n_实收, Gn_Dec);
          End If;

          --从属项目汇总计算折扣
          If Gb_从项汇总折扣 And b_Havesub And n_主收入id <> 0 And Not b_零费记帐 Then
            v_费别 := Mv_费别;
            If Gv_动态费别 Is Not Null Then
              v_费别 := v_费别 || ',' || Gv_动态费别;
            End If;
            n_金额 := Round(f_Actualmoney(v_费别, n_主收入id, n_金额, 0, 0, 0, 0, v_Tmp), Gn_Dec);
          End If;
          金额_Out := 金额_Out + n_金额;

        End Loop;
      End If;
    End If;
    Mv_Msg := Null;
    Return(1);
  Exception
    When Others Then
      p_Errcenter(SQLErrM);
      --zl_ErrorCenter(SQLCode, SQLErrM);
      Return(0);
  End;

  Function f_Loadadvicesend Return Number Is
    --医嘱记录集
    Cursor c_Advice(医嘱ids_In Varchar2) Is
      Select a.病人id, a.Id, a.挂号单, a.相关id, Nvl(a.相关id, a.Id) As 组id, Nvl(x.序号, a.序号) As 组号, a.诊疗类别, f.名称 As 类别名称,
             a.诊疗项目id, b.名称 As 诊疗项目, a.收费细目id, c.规格, a.婴儿, a.医嘱内容, a.标本部位, a.检查方法, a.执行标记, a.天数, a.总给予量, d.门诊单位, a.单次用量,
             Decode(a.诊疗类别, '4', c.计算单位, b.计算单位) As 计算单位, d.剂量系数, d.门诊包装, a.开始执行时间, a.执行频次, a.频率次数, a.频率间隔, a.间隔单位,
             a.医生嘱托, a.执行时间方案, a.病人科室id, a.开嘱科室id, a.开嘱医生, a.计价特性, a.执行性质, a.执行科室id,
             Nvl(e.名称, Decode(Nvl(a.执行性质, 0), 5, '-')) As 执行科室, d.门诊可否分零 As 可否分零,
             Decode(a.诊疗类别, '4', g.在用分批, d.药房分批) As 分批, c.是否变价, g.跟踪在用, c.撤档时间, c.服务对象, a.前提id, a.新开签名id As 签名id, b.试管编码,
             b.操作类型, b.执行分类, a.摘要, a.紧急标志, a.零费记帐, b.计算方式, b.执行安排, h.毒理分类
      From 病人医嘱记录 A, 诊疗项目目录 B, 收费项目目录 C, 药品规格 D, 部门表 E, 诊疗项目类别 F, 材料特性 G, 药品特性 H, 病人医嘱记录 X
      Where a.相关id = x.Id(+) And b.类别 = f.编码 And a.诊疗项目id = b.Id And a.收费细目id = c.Id(+) And a.收费细目id = d.药品id(+) And
            a.收费细目id = g.材料id(+) And a.执行科室id = e.Id(+) And Not (a.诊疗类别 = 'H' And b.操作类型 = '1') And
            Nvl(a.执行标记, 0) <> -1 And b.Id = h.药名id(+) And Nvl(a.审核状态, 0) Not In (1, 3, 4, 5) And
            Nvl(a.皮试结果, '无') <> '免试' And a.开始执行时间 Is Not Null And a.病人来源 <> 3 And a.医嘱状态 = 1 And
            a.Id In (Select /*+cardinality(x,10)*/
                      x.Column_Value
                     From Table(f_Num2list(医嘱ids_In)) X)
      Order By a.婴儿, 组号, 组id, a.序号;
    r_Advice c_Advice%RowType;

    n_Row       Number := 0;
    n_Break     Number;
    v_停用      Varchar2(4000);
    v_分解      Varchar2(4000);
    n_Del医嘱id Number(18) := 0;
    n_Del相关id Number(18) := 0;
    n_最小次数  Number := 0;
    n_次数      Number := 0;
    n_总量      Number(16, 5) := 0;
    n_金额      Number(16, 5) := 0;
    n_Tmp       Number := 0;
    v_Tmp       Varchar2(1000);
    v_用法      Varchar2(1000);
  Begin
    Vsadvice := t_Advice();
    Rs_Price := t_Price();
    Vsadvice.Extend; --添加一个空行
    Open c_Advice(Mv_医嘱ids);

    Loop
      Fetch c_Advice
        Into r_Advice;
      Exit When c_Advice%NotFound;
      If c_Advice%RowCount > 0 Then
        n_Break := 1;
        --一并给药或配方或检验组合中的一个可能已经不能发送,则整组不能发送
        If n_Del相关id <> 0 Then
          If (r_Advice.Id = n_Del相关id Or Nvl(r_Advice.相关id, 0) = n_Del相关id) Then
            n_Break := 0;
          Else
            n_Del相关id := 0;
          End If;
        End If;
        --检查组合或手术组合中的一个可能已经不能发送,则整组不能发送
        If n_Del医嘱id <> 0 Then
          If Nvl(r_Advice.相关id, 0) = n_Del医嘱id Then
            n_Break := 0;
          Else
            n_Del医嘱id := 0;
          End If;
        End If;
        If n_Break = 1 Then
          Vsadvice.Extend;
          n_Row := Vsadvice.Count; --当前行
          Vsadvice(n_Row).选择 := 1; --1表示可以发送,非1不能发送;2-表示一般的叮嘱
          If Nvl(r_Advice.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) <> To_Date('3000-01-01', 'yyyy-mm-dd') Then
            Vsadvice(n_Row).选择 := 0;
            If Instr(v_停用 || ',', ',' || r_Advice.医嘱内容 || ',') = 0 Then
              v_停用 := v_停用 || ',' || r_Advice.医嘱内容;
            End If;
          End If;

          If r_Advice.诊疗类别 = 'E' Then
            If r_Advice.相关id Is Not Null Then
              If Vsadvice(n_Row - 1).诊疗类别 = 'K' Then
                Vsadvice(n_Row).Id_Data := 5; --输血途径
              Else
                Vsadvice(n_Row).Id_Data := 2; --中药煎法
              End If;
            Elsif Vsadvice(n_Row - 1).相关id = r_Advice.Id Then
              If Instr(',5,6,', Vsadvice(n_Row - 1).诊疗类别) > 0 Then
                Vsadvice(n_Row).Id_Data := 1; --给药途径
              Elsif Vsadvice(n_Row - 1).诊疗类别 = 'C' Then
                Vsadvice(n_Row).Id_Data := 4; --采集方法
              Else
                Vsadvice(n_Row).Id_Data := 3; --中药用法
              End If;
            End If;
          End If;

          --排开一般的叮嘱(不含给药途径,中药煎法,用法,采集方法,输血途径)
          If Nvl(r_Advice.执行性质, 0) = 0 Then
            If Instr(',1,2,3,4,5,', Vsadvice(n_Row).Id_Data) = 0 And Instr(',5,6,7,', r_Advice.诊疗类别) = 0 Then
              n_Break := 0;
              Vsadvice.Delete(n_Row);
            End If;
          End If;

          If n_Break = 1 Then
            Vsadvice(n_Row).婴儿 := r_Advice.婴儿;
            Vsadvice(n_Row).医嘱内容 := r_Advice.医嘱内容;
            Vsadvice(n_Row).频率 := r_Advice.执行频次;
            Vsadvice(n_Row).医生嘱托 := r_Advice.医生嘱托;
            Vsadvice(n_Row).医生嘱托_Data := r_Advice.摘要;
            Vsadvice(n_Row).执行时间 := r_Advice.执行时间方案;
            Vsadvice(n_Row).执行科室 := r_Advice.执行科室;
            Vsadvice(n_Row).执行性质 := r_Advice.执行性质;
            Vsadvice(n_Row).Id := r_Advice.Id;
            Vsadvice(n_Row).相关id := r_Advice.相关id;
            Vsadvice(n_Row).病人科室id := r_Advice.病人科室id;
            Vsadvice(n_Row).开嘱科室id := r_Advice.开嘱科室id;
            Vsadvice(n_Row).开嘱医生 := r_Advice.开嘱医生;
            Vsadvice(n_Row).诊疗类别 := r_Advice.诊疗类别;
            Vsadvice(n_Row).诊疗项目id := r_Advice.诊疗项目id;
            Vsadvice(n_Row).标本部位 := r_Advice.标本部位;
            Vsadvice(n_Row).检查方法 := r_Advice.检查方法;
            Vsadvice(n_Row).执行标记 := r_Advice.执行标记;
            Vsadvice(n_Row).计价特性 := r_Advice.计价特性;
            Vsadvice(n_Row).执行性质id := r_Advice.执行性质;
            Vsadvice(n_Row).执行科室id := r_Advice.执行科室id;
            Vsadvice(n_Row).频率次数 := r_Advice.频率次数;
            Vsadvice(n_Row).频率间隔 := r_Advice.频率间隔;
            Vsadvice(n_Row).间隔单位 := r_Advice.间隔单位;

            If Instr(',5,6,7,', ',' || r_Advice.诊疗类别 || ',') > 0 Then
              --药品对应的规格已撤档则不允许发送(诊疗项目本身也可以相同处理,目前暂未处理)
              If Nvl(r_Advice.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) <> To_Date('3000-01-01', 'yyyy-mm-dd') Or
                 Instr(',1,3,', Nvl(r_Advice.服务对象, 0)) = 0 Then
                --提示信息暂时不处理,跳过再处理其它医嘱
                n_Del医嘱id := r_Advice.Id;
                n_Del相关id := Nvl(r_Advice.相关id, 0);
                --往前删除整组医嘱 Call DeleteCurRow(lngRow)
                Vsadvice.Delete(n_Row);
                n_Row := n_Row - 1;
                For I In 1 .. n_Row Loop
                  If Nvl(Vsadvice(n_Row + I - 1).相关id, 0) = n_Del相关id Then
                    Vsadvice.Delete(n_Row + I - 1);
                  Else
                    Exit;
                  End If;
                End Loop;
                n_最小次数 := 0;
                n_Break    := 0;
              End If;
              If n_Break = 1 Then
                --毒理分类判断忽略
                --Vsadvice(n_Row).毒理分类 := r_Advice.毒理分类;
                Vsadvice(n_Row).收费细目id := r_Advice.收费细目id;
                Vsadvice(n_Row).剂量系数 := Nvl(r_Advice.剂量系数, 1);
                Vsadvice(n_Row).门诊包装 := Nvl(r_Advice.门诊包装, 1);
                Vsadvice(n_Row).门诊单位 := r_Advice.门诊单位;
                Vsadvice(n_Row).可否分零 := r_Advice.可否分零;
                Vsadvice(n_Row).库存 := f_库存(r_Advice.收费细目id, Nvl(r_Advice.执行科室id, 0));
              End If;
            Elsif r_Advice.诊疗类别 = '4' Then
              Vsadvice(n_Row).收费细目id := r_Advice.收费细目id;
              Vsadvice(n_Row).剂量系数 := 1;
              Vsadvice(n_Row).门诊包装 := 1;
              Vsadvice(n_Row).门诊单位 := r_Advice.计算单位;
              Vsadvice(n_Row).库存 := f_库存(r_Advice.收费细目id, Nvl(r_Advice.执行科室id, 0));
            End If;

            If n_Break = 1 Then
              --计算发送次数，执行的分解时间等
              If r_Advice.诊疗类别 = '7' Then
                Vsadvice(n_Row).次数 := r_Advice.总给予量;
                If r_Advice.执行时间方案 Is Not Null Or Nvl(r_Advice.间隔单位, ' ') = '分钟' Then
                  v_分解 := f_Calc次数分解时间(r_Advice.总给予量, r_Advice.开始执行时间, To_Date('3000-01-01', 'yyyy-mm-dd'),
                                       r_Advice.执行时间方案, r_Advice.频率间隔, r_Advice.间隔单位);
                  If v_分解 Is Not Null Then
                    Vsadvice(n_Row).分解时间 := v_分解;
                    Vsadvice(n_Row).首次时间 := Substr(v_分解, 1, 16);
                    Vsadvice(n_Row).末次时间 := Substr(v_分解, Instr(v_分解, ',', -1) + 1, 16);
                  End If;
                Else
                  --无分解时间(临嘱可能未输入执行时间而无法分解)
                  --记录费用发生时间(以医嘱开始执行时间)
                  Vsadvice(n_Row).分解时间_Data := To_Char(r_Advice.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
                End If;
                Vsadvice(n_Row).单量 := r_Advice.单次用量;
                Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
                Vsadvice(n_Row).总量 := r_Advice.总给予量;
                Vsadvice(n_Row).总量单位 := '付';
              Elsif Instr(',5,6,', ',' || r_Advice.诊疗类别 || ',') > 0 Then
                --计算临嘱用药次数
                If Nvl(r_Advice.天数, 0) <> 0 And r_Advice.执行频次 Is Not Null Then
                  --一个频率周期的次数
                  If r_Advice.间隔单位 = '周' Then
                    n_次数 := f_Intex(r_Advice.天数 * (r_Advice.频率次数 / 7));
                  Elsif r_Advice.间隔单位 = '天' Then
                    n_次数 := f_Intex(r_Advice.天数 * (r_Advice.频率次数 / r_Advice.频率间隔));
                  Elsif r_Advice.间隔单位 = '小时' Then
                    n_次数 := f_Intex(r_Advice.天数 * (r_Advice.频率次数 / r_Advice.频率间隔) * 24);
                  Elsif r_Advice.间隔单位 = '分钟' Then
                    n_次数 := f_Intex(r_Advice.天数 * (r_Advice.频率次数 / r_Advice.频率间隔) * (24 * 60));
                  End If;
                Else
                  --可分零药品时,按总量对单量的倍数计算给药途径的次数,不可分零与一次性使用药品时，按总量对（单量与剂量系数比值取整）的倍数计算给药途径的次数
                  --否则按一个频率周期的次数计算
                  If Nvl(r_Advice.可否分零, 0) = 0 And Nvl(r_Advice.单次用量, 0) <> 0 Then
                    n_次数 := f_Intex(r_Advice.总给予量 * r_Advice.剂量系数 / r_Advice.单次用量);
                  Elsif (Nvl(r_Advice.可否分零, 0) = 1 Or Nvl(r_Advice.可否分零, 0) = 2) And Nvl(r_Advice.单次用量, 0) <> 0 Then
                    n_次数 := f_Intex(r_Advice.总给予量 / f_Intex(r_Advice.单次用量 / r_Advice.剂量系数));
                  Else
                    n_次数 := Nvl(r_Advice.频率次数, 0);
                  End If;
                End If;
                If r_Advice.执行时间方案 Is Not Null Or Nvl(r_Advice.间隔单位, ' ') = '分钟' Then
                  v_分解 := f_Calc次数分解时间(n_次数, r_Advice.开始执行时间, To_Date('3000-01-01', 'yyyy-mm-dd'), r_Advice.执行时间方案,
                                       r_Advice.频率间隔, r_Advice.间隔单位);
                  If v_分解 Is Not Null Then
                    Vsadvice(n_Row).分解时间 := v_分解;
                    Vsadvice(n_Row).首次时间 := Substr(v_分解, 1, 16);
                    Vsadvice(n_Row).末次时间 := Substr(v_分解, Instr(v_分解, ',', -1) + 1, 16);
                  End If;
                Else
                  --无分解时间(临嘱可能未输入执行时间而无法分解)
                  --记录费用发生时间(以医嘱开始执行时间)
                  Vsadvice(n_Row).分解时间_Data := To_Char(r_Advice.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
                End If;
                Vsadvice(n_Row).次数 := n_次数;
                Vsadvice(n_Row).单量 := r_Advice.单次用量;
                Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
                Vsadvice(n_Row).总量 := Round(r_Advice.总给予量 / r_Advice.门诊包装, 5);
                Vsadvice(n_Row).总量单位 := r_Advice.门诊单位;
                If n_次数 < n_最小次数 Or n_最小次数 = 0 Then
                  n_最小次数 := n_次数;
                End If;
              Elsif r_Advice.诊疗类别 = 'E' And Nvl(Vsadvice(n_Row).Id_Data, '0') <> '0' Then
                --给药途径,中药煎法,中药用法,采集方法,输血途径
                --一并给药的按最小次数发送(影响给药途径计费)
                If Vsadvice(n_Row).Id_Data = '1' Then
                  --给药途径
                  For J In 1 .. n_Row Loop
                    If Vsadvice(n_Row + J - 2).相关id = r_Advice.Id Then
                      If Vsadvice(n_Row + J - 2).次数 > n_最小次数 Then
                        Vsadvice(n_Row + J - 2).次数 := n_最小次数;
                        If Vsadvice(n_Row + J - 2).分解时间 Is Not Null Then
                          v_分解 := f_Trim分解时间(n_最小次数, Vsadvice(n_Row + J - 2).分解时间);
                          Vsadvice(n_Row + J - 2).分解时间 := v_分解;
                          Vsadvice(n_Row + J - 2).首次时间 := Substr(v_分解, 1, 16);
                          Vsadvice(n_Row + J - 2).末次时间 := Substr(v_分解, Instr(v_分解, ',', -1) + 1, 16);
                        End If;
                      End If;
                    Else
                      Exit;
                    End If;
                  End Loop;
                  n_最小次数 := 0;
                End If;
                --忽略指定了给药执行次数情况
                Vsadvice(n_Row).总量 := Vsadvice(n_Row - 1).次数; --付数或次数
                Vsadvice(n_Row).次数 := Vsadvice(n_Row - 1).次数;
                Vsadvice(n_Row).分解时间 := Vsadvice(n_Row - 1).分解时间;
                Vsadvice(n_Row).首次时间 := Vsadvice(n_Row - 1).首次时间;
                Vsadvice(n_Row).末次时间 := Vsadvice(n_Row - 1).末次时间;
                Vsadvice(n_Row).分解时间_Data := Vsadvice(n_Row - 1).分解时间_Data;
                If Vsadvice(n_Row).Id_Data = '3' Then
                  --中药用法
                  Vsadvice(n_Row).总量单位 := '付';
                Else
                  Vsadvice(n_Row).总量单位 := r_Advice.计算单位;
                End If;
              Else
                --其它非药临嘱:采集方法在上面的分支中已作处理
                If r_Advice.相关id Is Null Or (r_Advice.相关id Is Not Null And r_Advice.诊疗类别 = 'C') Then
                  --主要医嘱,包括检验组合
                  If r_Advice.诊疗类别 = 'K' Then
                    --输血途径的执行次数
                    n_总量 := Nvl(r_Advice.总给予量, 0);
                    If r_Advice.执行时间方案 Is Null And
                       (Nvl(r_Advice.频率次数, 0) = 0 Or Nvl(r_Advice.频率间隔, 0) = 0 Or r_Advice.间隔单位 Is Null) Then
                      n_次数 := 1;
                    Else
                      n_次数 := Nvl(r_Advice.频率次数, 1);
                    End If;
                  Else
                    n_总量 := Nvl(r_Advice.总给予量, 1);
                    n_次数 := f_Intex(n_总量 / Nvl(r_Advice.单次用量, 1));
                  End If;

                  If r_Advice.执行时间方案 Is Null And
                     (Nvl(r_Advice.频率次数, 0) = 0 Or Nvl(r_Advice.频率间隔, 0) = 0 Or r_Advice.间隔单位 Is Null) Then
                    --执行频率为 一次性 的项目
                    v_分解 := Null;
                    Vsadvice(n_Row).频率_Data := 1;
                  Else
                    --执行频率为 可选频率 的项目:下医嘱时应输入了总量
                    If r_Advice.执行时间方案 Is Not Null Or Nvl(r_Advice.间隔单位, ' ') = '分钟' Then
                      v_分解 := f_Calc次数分解时间(n_次数, r_Advice.开始执行时间, To_Date('3000-01-01', 'yyyy-mm-dd'), r_Advice.执行时间方案,
                                           r_Advice.频率间隔, r_Advice.间隔单位);
                    Else
                      v_分解 := Null; --临嘱也许未输入执行时间,无法分解
                    End If;
                  End If;
                  Vsadvice(n_Row).次数 := n_次数;
                  Vsadvice(n_Row).分解时间 := v_分解;
                  If v_分解 Is Not Null Then
                    Vsadvice(n_Row).首次时间 := Substr(v_分解, 1, 16);
                    Vsadvice(n_Row).末次时间 := Substr(v_分解, Instr(v_分解, ',', -1) + 1, 16);
                  Else
                    --记录费用发生时间(当无分解时间时),以医嘱的开始执行时间
                    Vsadvice(n_Row).分解时间_Data := To_Char(r_Advice.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
                  End If;
                  Vsadvice(n_Row).单量 := r_Advice.单次用量;
                  If r_Advice.单次用量 Is Not Null Then
                    Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
                  End If;
                  Vsadvice(n_Row).总量 := Round(n_总量, 5);
                  Vsadvice(n_Row).总量单位 := r_Advice.计算单位;
                Else
                  Vsadvice(n_Row).总量 := Vsadvice(n_Row - 1).总量;
                  Vsadvice(n_Row).次数 := Vsadvice(n_Row - 1).次数;
                  Vsadvice(n_Row).分解时间 := Vsadvice(n_Row - 1).分解时间;
                  Vsadvice(n_Row).分解时间_Data := Vsadvice(n_Row - 1).分解时间_Data;
                  Vsadvice(n_Row).首次时间 := Vsadvice(n_Row - 1).首次时间;
                  Vsadvice(n_Row).末次时间 := Vsadvice(n_Row - 1).末次时间;
                End If;
              End If;

              Vsadvice(n_Row).前提id := r_Advice.前提id;
              Vsadvice(n_Row).签名id := r_Advice.签名id;
              --采集方式的管码与检验相同(暂不考虑一并检验的情况)
              If Vsadvice(n_Row).Id_Data = '4' Then
                Vsadvice(n_Row).试管编码 := Vsadvice(n_Row - 1).试管编码;
              Else
                Vsadvice(n_Row).试管编码 := r_Advice.试管编码;
              End If;
              Vsadvice(n_Row).操作类型 := r_Advice.操作类型;
              Vsadvice(n_Row).紧急标志 := r_Advice.紧急标志;
              Vsadvice(n_Row).零费记帐 := r_Advice.零费记帐;
              --计算方式
              If Instr(',4,5,6,7,', ',' || r_Advice.诊疗类别 || ',') = 0 Then
                Vsadvice(n_Row).计算方式 := r_Advice.计算方式;
              Else
                Vsadvice(n_Row).计算方式 := '0';
              End If;
              Vsadvice(n_Row).开始时间 := To_Char(r_Advice.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
              Vsadvice(n_Row).执行安排 := r_Advice.执行安排;
              Vsadvice(n_Row).执行分类 := r_Advice.执行分类;

              --计算项目发送金额
              n_Tmp := f_Loadadviceprice(n_Row, r_Advice.Id, r_Advice.相关id, r_Advice.诊疗项目id, r_Advice.收费细目id,
                                         r_Advice.执行科室id, r_Advice.是否变价, r_Advice.跟踪在用, r_Advice.可否分零, r_Advice.诊疗类别,
                                         r_Advice.执行性质, r_Advice.门诊包装, r_Advice.剂量系数, r_Advice.计价特性, r_Advice.标本部位,
                                         r_Advice.检查方法, r_Advice.执行标记, n_金额);
              If n_Tmp = 0 Then
                n_Del医嘱id := r_Advice.Id;
                n_Del相关id := Nvl(r_Advice.相关id, 0);
                --往前删除整组医嘱 Call DeleteCurRow(lngRow)
                Vsadvice.Delete(n_Row);
                n_Row := n_Row - 1;
                For I In 1 .. n_Row Loop
                  If Nvl(Vsadvice(n_Row + I - 1).相关id, 0) = n_Del相关id Then
                    Vsadvice.Delete(n_Row + I - 1);
                  Else
                    Exit;
                  End If;
                End Loop;
                n_最小次数 := 0;
                n_Break    := 0;
              End If;
              If n_Break = 1 Then
                Vsadvice(n_Row).金额 := Round(n_金额, Gn_Dec);
                Vsadvice(n_Row).金额_Data := Vsadvice(n_Row).金额;
                --相关行时的一些处理：累计显示金额,给药途径,用法,执行科室,执行性质
                If r_Advice.诊疗类别 = 'E' And Instr(',1,3,', ',' || Vsadvice(n_Row).Id_Data || ',') > 0 Then
                  n_金额 := 0;
                  n_Tmp  := 0; --药品首行

                  For I In 1 .. n_Row - 1 Loop
                    If Nvl(Vsadvice(n_Row + I - 2).相关id, 0) = r_Advice.Id Then
                      n_Tmp := n_Row + I - 2;
                    Else
                      Exit;
                    End If;
                  End Loop;

                  If Vsadvice(n_Row).Id_Data = '1' Then
                    For I In n_Tmp .. n_Row - 1 Loop
                      v_Tmp := Null;
                      If Vsadvice(I).执行性质id = 5 And Nvl(Vsadvice(n_Row).执行性质id, 0) <> 5 Then
                        v_Tmp := '自备药';
                      Elsif Nvl(Vsadvice(I).执行性质id, 0) <> 5 And Vsadvice(n_Row).执行性质id = 5 Then
                        v_Tmp := '离院带药';
                      End If;
                      Vsadvice(I).执行性质 := v_Tmp;
                      Vsadvice(I).用法 := r_Advice.诊疗项目;
                    End Loop;
                  Else
                    v_Tmp := Null;
                    If Vsadvice(n_Tmp).执行性质id = 5 And Nvl(Vsadvice(n_Row).执行性质id, 0) <> 5 Then
                      v_Tmp := '自备药';
                    Elsif Nvl(Vsadvice(n_Tmp).执行性质id, 0) <> 5 And Vsadvice(n_Row).执行性质id = 5 Then
                      v_Tmp := '离院带药';
                    End If;
                    Vsadvice(n_Row).执行性质 := v_Tmp;
                    Vsadvice(n_Row).执行科室 := Vsadvice(n_Tmp).执行科室;
                    v_用法 := Null;
                    If Vsadvice(n_Row - 1).Id_Data = '2' Then
                      Select Max(名称) Into v_用法 From 诊疗项目目录 Where ID = Vsadvice(n_Row - 1).诊疗项目id;
                    End If;
                    If v_用法 Is Null Then
                      v_用法 := r_Advice.诊疗项目;
                    Else
                      v_用法 := r_Advice.诊疗项目 || '|' || v_用法;
                    End If;
                    For I In n_Tmp .. n_Row - 1 Loop
                      Vsadvice(I).用法 := v_用法;
                    End Loop;
                  End If;
                  --使相关医嘱选择状态相同(固为库存的原因；非药医嘱不用)忽略
                Elsif Instr(',5,6,7,', ',' || r_Advice.诊疗类别 || ',') = 0 Then
                  --输血途径
                  If r_Advice.诊疗类别 = 'E' And Vsadvice(n_Row).Id_Data = '5' Then
                    Vsadvice(n_Row - 1).用法 := r_Advice.诊疗项目;
                  End If;
                End If;
                --药品、卫材库存检查(0-不检查;1-检查,不足提醒;2-检查，不足禁止),自备药不检查
              End If;
            End If;
          End If;
        End If;
      End If;
    End Loop;

    Mv_Msg := Null;
    If Vsadvice.Count = 1 Then
      Return(0);
    Else
      Return(1);
    End If;
  Exception
    When Others Then
      p_Errcenter(SQLErrM);
      --zl_ErrorCenter(SQLCode, SQLErrM);
      Return(0);
  End;

  --医嘱发送
  Function f_Sendadvice(记帐_In In Number) Return Number Is

    Type r_Seek Is Record(
      费用性质 Number,
      主项标签 Number,
      主收入id Number(18),
      合计     Number(16, 5));
    Type t_Seek Is Table Of r_Seek;

    Type r_Money Is Record(
      ID         Number(18),
      类别       Varchar2(20),
      类别名称   Varchar2(2000),
      名称       Varchar2(2000),
      计算单位   Varchar2(20),
      是否变价   Number(1),
      屏蔽费别   Number(1),
      费用确认   Number(1),
      加班加价   Number(1),
      加班加价率 Number(16, 5),
      附术收费率 Number(16, 5),
      门诊单位   Varchar2(20),
      门诊包装   Number(16, 5),
      剂量系数   Number(16, 5),
      分批       Number(1),
      跟踪在用   Number(1),
      收入项目id Number(18),
      收据费目   Varchar2(20),
      数量       Number(16, 5),
      单价       Number(16, 5),
      执行科室id Number(18),
      从项       Number(1),
      费用性质   Number(1),
      收费方式   Number(1));
    Type t_Money Is Table Of r_Money;

    Rs_Seek  t_Seek;
    Rs_Money t_Money;

    c_Tmp Rs_Recordset;

    n_发送号        病人医嘱发送.发送号%Type;
    n_发送序号      病人医嘱发送.发送号%Type;
    d_Cur           Date;
    b_处方数限制    Boolean;
    n_配方数        Number;
    v_Nokey         Varchar2(600);
    v_No            Varchar2(600);
    n_Pre诊疗单据id Number(18) := 0;
    n_Tmp           Number;
    n_Tmp1          Number;
    b_离院带药      Boolean;
    n_Okrowmney     Number;
    v_Sql           Varchar2(20000);
    v_收费项目      Varchar2(6000);
    n_执行科室id    部门表.Id%Type;
    n_父序号        Number;
    n_父项目id      Number(18);
    v_Havesub       Varchar2(600);
    v_Nonesub       Varchar2(600);
    v_Cuvettenumber Varchar2(600);
    n_费用次数      Number;
    n_收费数量      Number;
    n_采集科室id    Number(18);
    n_执行状态      Number;
    n_计费状态      Number;
    b_附加手术      Boolean := False;
    b_First         Boolean;
    n_Idx           Number;
    v_分解时间      Varchar2(20000);
    I               Number;
    J               Number;
    K               Number;
    n_付数          Number(16, 5);
    n_数量          Number(16, 5);
    n_Other数量     Number(16, 5);
    n_单价          Number(16, 5);
    n_应收          Number(16, 5);
    n_实收          Number(16, 5);
    n_合计          Number(16, 5);
    n_记帐合计      Number(16, 5);
    n_发送数次      Number(16, 5);
    b_Bool          Boolean;
    n_费用父号      Number;
    n_费用序号      Number;
    v_费别          Varchar2(3000);
    v_类别          Varchar2(3000);
    d_发生时间      Date;
    d_登记时间      Date;
    n_划价          Number;
    v_自动发料      Varchar2(6000);
    b_记帐          Boolean;

    d_首次时间 Date;
    d_末次时间 Date;

  Begin
    If 记帐_In = 1 Then
      b_记帐 := True;
    Else
      b_记帐 := False;
    End If;
    Mn_Nosequence := 0;
    n_发送号      := Nextno(10, Null, Null, 1);
    If Mb_Auto Then
      Select (Sysdate + 1 / 60 / 24) As 发送时间 Into d_Cur From Dual;
    Else
      Select Sysdate Into d_Cur From Dual;
    End If;

    n_配方数 := 1; --表示发送的第几付配方,用于分单据号
    Rs_Exec  := t_Exec();
    --从第二行开始循环,因为前面加了空行
    For I In 2 .. Vsadvice.Count Loop
      --产生单据号分配关键字
      b_处方数限制 := False;
      If Mn_Sendno = 1 And Not Gb_执行前先结算 Then
        v_Nokey := '只产生一个单据号';
      Elsif Mn_Sendno = 2 Then
        v_Nokey := Nvl(Vsadvice(I).执行科室id, 0);
        If Instr(',5,6,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 And Gn_Rxcount > 0 Then
          b_处方数限制 := True;
        End If;
      Else
        If Instr(',5,6,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
          v_Nokey := '中西成药_' || Mn_病人id || '_' || Mv_挂号单 || '_' || Vsadvice(I).病人科室id || Vsadvice(I).开嘱科室id;
          v_Nokey := v_Nokey || '_' || f_Getmergedrugstore(I);

          If Mb_一并给药发一张 Then
            If Nvl(Vsadvice(I).相关id, 0) <> Nvl(Vsadvice(I - 1).相关id, 0) Then
              --再按要打印的诊疗单据分号(一并给药的，只取第一个药品的诊疗单据ID)
              n_Pre诊疗单据id := f_Getclinicbillid(Vsadvice(I).诊疗项目id);
            End If;
            v_Nokey := v_Nokey || '_' || n_Pre诊疗单据id;
          Else
            v_Nokey := v_Nokey || '_' || f_Getclinicbillid(Vsadvice(I).诊疗项目id);
          End If;
          If Gn_Rxcount > 0 Then
            b_处方数限制 := True;
          End If;
        Elsif Instr(',4,M,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
          v_Nokey := '材料医嘱_' || Mn_病人id || '_' || Mv_挂号单 || '_' || Vsadvice(I).病人科室id || Vsadvice(I).开嘱科室id || '_' ||
                     Nvl(Vsadvice(I).执行科室id, 0);
          v_Nokey := v_Nokey || '_' || f_Getclinicbillid(Vsadvice(I).诊疗项目id);
        Elsif Vsadvice(I).诊疗类别 = '7' Then
          --一个配方中的所有草药分配一个独立单据号
          v_Nokey := '中药配方_' || Mn_病人id || '_' || Mv_挂号单 || '_' || n_配方数;
        Elsif Instr(Mv_单据组合类别, Vsadvice(I).诊疗类别) > 0 Then
          v_Nokey := '非药医嘱_' || Vsadvice(I).诊疗类别 || '_' || Nvl(Vsadvice(I).执行科室id, 0);
        Elsif Vsadvice(I).相关id Is Not Null And Vsadvice(I).诊疗类别 = 'C' Then
          If Mb_检验单独产生单据 Then
            v_Nokey := '一并采集_' || Vsadvice(I).相关id;
          Else
            v_Nokey := '一并采集_' || Mn_病人id || '_' || Mv_挂号单 || '_' || Vsadvice(I).标本部位 || '_' || Vsadvice(I).执行科室id || '_' || Vsadvice(I).操作类型 || '_' || Vsadvice(I).试管编码;

            --往后找检验医嘱的主行
            For J In I + 1 .. Vsadvice.Count Loop
              If Vsadvice(J).相关id Is Null Then
                v_Nokey := v_Nokey || '_' || Vsadvice(J).诊疗项目id || '_' || Nvl(Vsadvice(J).执行科室id, 0);
                Exit;
              End If;
            End Loop;
          End If;
        Elsif Vsadvice(I).相关id Is Not Null And Instr(',F,D,', Vsadvice(I).诊疗类别) > 0 Then
          v_Nokey := '非药医嘱_' || Vsadvice(I).相关id;
        Else
          v_Nokey := '非药医嘱_' || Vsadvice(I).Id;
        End If;
      End If;

      --开始时间不是同一天的分别产生单据
      If Mb_Starttimedef Then
        v_Nokey := v_Nokey || '_' || Substr(Vsadvice(I).开始时间, 1, 10);
      End If;

      --开单人不同的，默认全部分别产生单据
      v_Nokey := v_Nokey || '_' || Vsadvice(I).开嘱医生;

      --(忽略)不同诊断的医嘱分别产生单据
      --(忽略)启用参数：特殊药品分开发送 时，特殊药品医嘱的药品行单独生成单据号，一组医嘱分配一个号
      --(忽略)处理方条数限制应该放到最后
      If b_处方数限制 Then
        Null;
      End If;

      --是否离院带药
      b_离院带药 := False;
      If Instr(',5,6,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
        If Vsadvice(I).执行性质 = '离院带药' Then
          b_离院带药 := True;
        End If;
      Elsif Vsadvice(I).诊疗类别 = '7' Then
        For J In I + 1 .. Vsadvice.Count Loop
          If Vsadvice(J).Id = Vsadvice(I).相关id Then
            If Vsadvice(J).执行性质 = '离院带药' Then
              b_离院带药 := True;
            End If;
            Exit;
          End If;
        End Loop;
      End If;

      --产生医嘱记帐费用:以最新价格计算
      -----------------------------------------------------------------
      v_Sql      := Null;
      v_收费项目 := Null;
      If Instr(',5,6,7,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
        --药品缺省固定为正常计价,但下医嘱时指定了为自备药(院外执行)的不读取;药品不可能为叮嘱
        If Nvl(Vsadvice(I).执行性质id, 0) <> 5 Then
          v_Sql := ' Select A.ID,A.类别,D.名称 as 类别名称,RTrim(A.名称||'' ''||A.规格) as 名称,' ||
                   ' A.计算单位,A.是否变价,A.屏蔽费别,A.费用确认,A.加班加价,B.加班加价率,100 as 附术收费率,' ||
                   ' Y.门诊单位,Y.门诊包装,Y.剂量系数,Y.药房分批 as 分批,0 as 跟踪在用,B.收入项目ID,' || ' C.收据费目,1 as 数量,B.现价 as 单价,' ||
                   Nvl(Vsadvice(I).执行科室id, 0) || ' as 执行科室ID,0 as 从项,0 as 费用性质,0 as 收费方式' ||
                   ' From 收费项目目录 A,收费价目 B,收入项目 C,收费项目类别 D,药品规格 Y' ||
                   ' Where A.ID=B.收费细目ID And B.收入项目ID=C.ID And A.类别=D.编码' || ' And A.ID=Y.药品ID(+) And A.ID=:1 ' ||
                   ' And ((Sysdate Between B.执行日期 and B.终止日期) Or (Sysdate>=B.执行日期 And B.终止日期 is NULL))' ||
                   ' Order by A.编码';
        End If;
      Else
        --先删除原非药医嘱的计价(应该没有)
        r_计价.Extend;
        n_Tmp := r_计价.Count;
        r_计价(n_Tmp).医嘱id := Vsadvice(I).Id;
        r_计价(n_Tmp).删单行 := 1;
        r_计价(n_Tmp).过程名 := 1;

        --不计价,手工计价；叮嘱,院外执行的医嘱不读取
        If Nvl(Vsadvice(I).计价特性, 0) = 0 And Instr(',0,5,', Nvl(Vsadvice(I).执行性质id, 0)) = 0 Then
          For J In 1 .. Rs_Price.Count Loop
            If Rs_Price(J).医嘱id = Vsadvice(I).Id Then
              --对照数量为0的自动过滤掉
              If Nvl(Rs_Price(J).收费细目id, 0) <> 0 And Nvl(Rs_Price(J).数量, 0) <> 0 Then
                --(忽略:不涉及到)普通项目的变价单价要求输入，包括非跟踪在用的时价卫材医嘱

                --计价执行科室:只保存非药品及卫材医嘱的，药品和卫材计价的执行科室
                If Instr(',4,5,6,7,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 And
                   (Instr(',5,6,7,', Rs_Price(J).收费类别) > 0 Or Rs_Price(J).收费类别 = '4' And Nvl(Rs_Price(J).在用, 0) = 1) Then
                  n_执行科室id := Nvl(Rs_Price(J).执行科室id, 0);
                  --(忽略)卫材必须设置执行科室
                Else
                  n_执行科室id := 0;
                End If;
                --药品、卫材医嘱的计价固定对应不保存；非跟踪在用的时价卫材的变价需要输入，因此要保存到计价表中
                If Instr(',4,5,6,7,', Vsadvice(I).诊疗类别) = 0 Or Vsadvice(I)
                  .诊疗类别 = '4' And Nvl(Rs_Price(J).在用, 0) = 0 And Nvl(Rs_Price(J).变价, 0) = 1 Then

                  r_计价.Extend;
                  n_Tmp := r_计价.Count;
                  r_计价(n_Tmp).医嘱id := Vsadvice(I).Id;
                  r_计价(n_Tmp).过程名 := 2;
                  r_计价(n_Tmp).收费细目id := Rs_Price(J).收费细目id;
                  r_计价(n_Tmp).数量 := Rs_Price(J).数量;
                  r_计价(n_Tmp).单价 := Rs_Price(J).单价;
                  r_计价(n_Tmp).从项 := Rs_Price(J).从项;
                  If n_执行科室id > 0 Then
                    r_计价(n_Tmp).执行科室id := n_执行科室id;
                  Else
                    r_计价(n_Tmp).执行科室id := Null;
                  End If;
                  r_计价(n_Tmp).费用性质 := Rs_Price(J).费用性质;
                  r_计价(n_Tmp).收费方式 := Rs_Price(J).收费方式;
                End If;
                --临时病人医嘱计价表
                If Nvl(Vsadvice(I).总量, 0) <> 0 Then
                  If v_Sql Is Not Null Then
                    v_Sql := v_Sql || ' Union ALL ';
                  End If;
                  v_Sql := v_Sql || 'Select ' || Rs_Price(J).收费细目id || ' as 收费细目ID,' || Nvl(Rs_Price(J).执行科室id, 0) ||
                           ' as 执行科室ID,' || Nvl(Rs_Price(J).数量, 0) || ' as 数量,' || Nvl(Rs_Price(J).单价, 0) || ' as 单价,' ||
                           Nvl(Rs_Price(J).从项, 0) || ' as 从项,' || Nvl(Rs_Price(J).费用性质, 0) || ' as 费用性质,' ||
                           Nvl(Rs_Price(J).收费方式, 0) || ' as 收费方式 From Dual';

                End If;
              End If;
            End If;
          End Loop;
        End If;
        If v_Sql Is Not Null Then
          v_Sql := ' Select A.ID,A.类别,D.名称 as 类别名称,A.名称,A.计算单位,A.是否变价,' ||
                   ' A.屏蔽费别,A.费用确认,A.加班加价,B.加班加价率,B.附术收费率,Y.门诊单位,Y.门诊包装,Y.剂量系数,' ||
                   ' Decode(A.类别,''4'',E.在用分批,Y.药房分批) as 分批,E.跟踪在用,B.收入项目ID,' ||
                   ' C.收据费目,X.数量,Decode(A.是否变价,1,X.单价,B.现价) as 单价,X.执行科室ID,X.从项,X.费用性质,X.收费方式' ||
                   ' From 收费项目目录 A,收费价目 B,收入项目 C,收费项目类别 D,材料特性 E,(' || v_Sql || ') X,药品规格 Y' ||
                   ' Where A.ID=B.收费细目ID And B.收入项目ID=C.ID And A.ID=E.材料ID(+)' ||
                   ' And A.类别=D.编码 And X.收费细目ID=A.ID And A.ID=Y.药品ID(+) and (1=1 or A.ID=:1 )' ||
                   ' And ((Sysdate Between B.执行日期 and B.终止日期) or (Sysdate>=B.执行日期 And B.终止日期 is NULL))' ||
                   ' Order by X.费用性质,X.从项,X.收费方式 Desc,A.ID';
          --一定要把主项排在前面,以便于计算和在费用记录中保持主从关系
        End If;
      End If;

      --汇总折扣变量初始
      v_Havesub := Null;
      v_Nonesub := Null;
      Rs_Seek   := t_Seek();
      --提前生成样本条码
      v_Cuvettenumber := Null;
      If Nvl(Vsadvice(I).执行性质id, 0) <> 0 Then
        If Vsadvice(I).诊疗类别 = 'C' Or Vsadvice(I).诊疗类别 = 'E' And Vsadvice(I).操作类型 = '6' Then
          n_采集科室id := 0;
          If Vsadvice(I).诊疗类别 = 'E' Then
            n_采集科室id := Nvl(Vsadvice(I).执行科室id, 0);
          Else
            For J In I + 1 .. Vsadvice.Count Loop
              If Vsadvice(J).Id = Vsadvice(I).相关id Then
                n_采集科室id := Nvl(Vsadvice(J).执行科室id, 0);
                Exit;
              End If;
            End Loop;
          End If;
          v_Cuvettenumber := f_Getcuvettenumber(Vsadvice(I).试管编码, Vsadvice(I).Id, Vsadvice(I).相关id, Vsadvice(I).诊疗类别,
                                                Vsadvice(I).操作类型, Vsadvice(I).执行科室id, Vsadvice(I).婴儿, Vsadvice(I).诊疗项目id,
                                                Vsadvice(I).紧急标志, Vsadvice(I).标本部位, n_采集科室id);
        End If;
      End If;
      --(忽略)诊间支付相关
      --(忽略)本科执行的自动执行：特殊医嘱不用处理
      n_执行状态 := 0;

      --无需计费或未计费
      If Vsadvice(I).计价特性 = 1 Then
        n_计费状态 := -1;
      Else
        n_计费状态 := 0;
      End If;
      If v_Sql Is Not Null Then
        Open c_Tmp For v_Sql
          Using In Nvl(Vsadvice(I).收费细目id, 0);
        Fetch c_Tmp Bulk Collect
          Into Rs_Money;
        Close c_Tmp;
        If Rs_Money.Count > 0 Then
          n_计费状态 := 1; --已计费
        End If;

        --处理收入项目级的费用明细
        If Vsadvice(I).诊疗类别 = 'F' And Nvl(Vsadvice(I).相关id, 0) <> 0 Then
          b_附加手术 := True;
        End If;
        For n_Idx In 1 .. Rs_Money.Count Loop
          --执行科室ID
          n_执行科室id := Nvl(Rs_Money(n_Idx).执行科室id, 0);
          --在原值基础上取有效的非药嘱药品及跟踪卫材的执行科室
          If Instr(',4,5,6,7,', Vsadvice(I).诊疗类别) = 0 And
             (Rs_Money(n_Idx).类别 = '4' And Nvl(Rs_Money(n_Idx).跟踪在用, 0) = 1 Or Instr(',5,6,7,', Rs_Money(n_Idx).类别) > 0) Then
            --(忽略)n_执行科室id := f_Get收费执行科室id;
            n_执行科室id := Nvl(Rs_Money(n_Idx).执行科室id, 0);
            -- Get收费执行科室ID(mlng病人ID, 0, Rs_Money(n_idx).类别, Rs_Money(n_idx).ID, 4, Val(Vsadvice(I).病人科室ID)), 0, 1, lng执行科室ID)
          End If;

          --分解时间
          If Vsadvice(I).分解时间 Is Not Null Then
            v_分解时间 := Vsadvice(I).分解时间;
          Else
            v_分解时间 := Vsadvice(I).分解时间_Data; --开始执行时间
          End If;
          --------------------------------------------
          --根据收费方式，确定当前收费项目是否应收费
          If Rs_Money(n_Idx).费用性质 || '_' || Rs_Money(n_Idx).Id <> Nvl(v_收费项目, 'NULL') Then
            n_收费数量  := 0;
            n_Okrowmney := n_Idx;
            --默认返回值是1,处理后可能0
            n_Tmp := f_Advicemoneymake(Mn_病人id, Nvl(Vsadvice(I).相关id, Vsadvice(I).Id), Vsadvice(I).诊疗项目id,
                                       Rs_Money(n_Idx).Id, n_执行科室id, Vsadvice(I).试管编码, Rs_Money(n_Idx).类别,
                                       Nvl(Rs_Money(n_Idx).收费方式, 0), v_分解时间, Vsadvice(I).总量, Vsadvice(I).Id, n_发送号,
                                       Rs_Money(n_Idx).数量, Vsadvice(I).计算方式, Vsadvice(I).频率, Vsadvice(I).单量, 1, 0,
                                       Vsadvice(I).诊疗类别, v_Cuvettenumber, n_费用次数);
            If n_Tmp = 0 Then
              --跳过当前收费项目(多个收入项目)
              v_收费项目 := Rs_Money(n_Idx).费用性质 || '_' || Rs_Money(n_Idx).Id;
              K          := n_Idx;
              While K Is Not Null Loop
                If Rs_Money(K).费用性质 || '_' || Rs_Money(K).Id = v_收费项目 Then
                  K := Rs_Money.Next(K);
                Else
                  Exit;
                End If;
              End Loop;
              If K Is Null Then
                --已经到了结尾跳出循环
                Exit;
              End If;
              n_Okrowmney := K;
            End If;

            If n_Okrowmney = n_Idx Then
              If Instr(',5,6,7', Rs_Money(n_Idx).类别) > 0 Then
                If Instr(',5,6,7', Vsadvice(I).诊疗类别) > 0 Then
                  If Vsadvice(I).诊疗类别 = '7' Then
                    n_付数 := Vsadvice(I).总量;
                    --中药药房单位按不可分零处理:每付
                    If Nvl(Vsadvice(I).可否分零, 0) = 0 Then
                      n_数量 := Vsadvice(I).单量 / Nvl(Rs_Money(n_Idx).剂量系数, 1);
                    Else
                      n_数量 := f_Intex(Vsadvice(I).单量 / Nvl(Rs_Money(n_Idx).剂量系数, 1) / Nvl(Rs_Money(n_Idx).门诊包装, 1)) *
                              Nvl(Rs_Money(n_Idx).门诊包装, 1);
                    End If;
                  Else
                    n_付数 := 1;
                    n_数量 := Vsadvice(I).总量 * Nvl(Rs_Money(n_Idx).门诊包装, 1);
                  End If;
                Else
                  n_付数 := 1;
                  --中药药房单位按不可分零处理:每付
                  --非药嘱药品计价:因为这里预定了售价数量,因此不作不分零处理
                  --对于收费对照中的药品，且为当天只收取一次，数量为费用次数*对照数量
                  If Instr(',2,3,4,5,6,7,9,', Rs_Money(n_Idx).收费方式) > 0 Then
                    If n_Other数量 > 0 Then
                      n_数量 := n_Other数量;
                    Else
                      n_数量 := n_费用次数 * Nvl(Rs_Money(n_Idx).数量, 0);
                    End If;
                  Else
                    n_数量 := Vsadvice(I).总量 * Nvl(Rs_Money(n_Idx).数量, 0);
                  End If;
                End If;
                n_数量 := n_数量;

                If Nvl(Rs_Money(n_Idx).是否变价, 0) = 1 Then
                  n_单价 := f_Calcdrugprice(Rs_Money(n_Idx).Id, n_执行科室id, n_付数 * n_数量, Null);
                Else
                  n_单价 := Nvl(Rs_Money(n_Idx).单价, 0);
                End If;
              Elsif Rs_Money(n_Idx).类别 = '4' And Nvl(Rs_Money(n_Idx).跟踪在用, 0) = 1 Then
                --检查卫生材料入出类别
                --  If lng卫材类别ID = 0 Then
                --   Screen.MousePointer = 0
                --      MsgBox '不能确定卫生材料单据的入出类别,请先到入出类别管理中设置！', vbInformation, gstrSysName
                --     GoTo FuncEnd
                --  end if;
                n_付数 := 1;
                If Instr(',1,2,3,4,5,6,7,9,', Rs_Money(n_Idx).收费方式) > 0 Then
                  If n_Other数量 > 0 Then
                    n_数量 := n_Other数量;
                  Else
                    n_数量 := n_费用次数 * Nvl(Rs_Money(n_Idx).数量, 0);
                  End If;
                Else
                  n_数量 := Vsadvice(I).总量 * Nvl(Rs_Money(n_Idx).数量, 0);
                End If;
                --确定时价卫材价格
                If Nvl(Rs_Money(n_Idx).是否变价, 0) = 1 Then
                  n_单价 := f_Calcdrugprice(Rs_Money(n_Idx).Id, n_执行科室id, n_数量, Null);
                Else
                  n_单价 := Nvl(Rs_Money(n_Idx).单价, 0);
                End If;
              Else
                --总量等于单次用量乘数次。一天只收一次时，有多少天要执行，就收多少次，不管单次用量（例如：每天两次）,但要管收费对照的次数


                n_付数 := 1;
                If Instr(',1,2,3,4,5,6,7,9,', Rs_Money(n_Idx).收费方式) > 0 Then
                  If n_Other数量 > 0 Then
                    n_数量 := n_Other数量;
                  Else
                    n_数量 := n_费用次数 * Nvl(Rs_Money(n_Idx).数量, 0);
                  End If;
                Else
                  n_数量 := Vsadvice(I).总量 * Nvl(Rs_Money(n_Idx).数量, 0);
                End If;
                n_单价 := Nvl(Rs_Money(n_Idx).单价, 0);
              End If;
              --(忽略)非药嘱药品及跟踪卫材的库存检查
              --发送金额
              n_应收 := n_付数 * n_数量 * n_单价;
              If b_附加手术 Then
                n_应收 := n_应收 * Nvl(Rs_Money(n_Idx).附术收费率, 100) / 100;
              End If;

              --处理加班加价
              If Gb_加班加价 And Nvl(Rs_Money(n_Idx).加班加价, 0) = 1 Then
                n_应收 := n_应收 * (1 + Nvl(Rs_Money(n_Idx).加班加价率, 0) / 100);
              End If;

              n_应收 := n_应收;

              --NO,序号
              p_Getcurbillset(v_Nokey, 0, -1, b_记帐, v_No, n_费用序号, n_Tmp1);
              r_费用.Extend;
              b_Bool := False;
              If Rs_Money(n_Idx).费用性质 || '_' || Rs_Money(n_Idx).Id <> Nvl(v_收费项目, 'NULL') Then
                n_费用父号 := n_费用序号;
                If Rs_Money(n_Idx).从项 = 0 Then
                  --记录主项信息，主项肯定在从项前
                  --即使不汇总折扣，也要记录主从项关系
                  If Instr(v_Havesub || ',', ',' || Rs_Money(n_Idx).费用性质 || ',') = 0 And
                     Instr(v_Nonesub || ',', ',' || Rs_Money(n_Idx).费用性质 || ',') = 0 Then
                    n_Tmp := Null;
                    For J In 1 .. Rs_Money.Count Loop
                      If Rs_Money(J).费用性质 = Rs_Money(n_Idx).费用性质 And Rs_Money(J).从项 = 1 Then
                        n_Tmp := 1;
                        Exit;
                      End If;
                    End Loop;

                    If n_Tmp = 1 Then
                      n_父序号   := n_费用序号;
                      n_父项目id := Rs_Money(n_Idx).Id;

                      Rs_Seek.Extend;
                      n_Tmp := Rs_Seek.Count;
                      Rs_Seek(n_Tmp).费用性质 := Rs_Money(n_Idx).费用性质;
                      Rs_Seek(n_Tmp).主项标签 := r_费用.Count;
                      Rs_Seek(n_Tmp).主收入id := Rs_Money(n_Idx).收入项目id;
                      v_Havesub := v_Havesub || ',' || Rs_Money(n_Idx).费用性质;
                      b_Bool := True;
                    Else
                      v_Nonesub := v_Nonesub || ',' || Rs_Money(n_Idx).费用性质;
                    End If;
                  End If;
                End If;
              End If;
              --计算汇总折扣合计
              v_费别 := Mv_费别;
              If Gb_从项汇总折扣 And
                 (Rs_Money(n_Idx).从项 = 1 Or Instr(v_Havesub || ',', ',' || Rs_Money(n_Idx).费用性质 || ',') > 0) Then
                If Vsadvice(I).零费记帐 = 1 Then
                  n_实收 := 0;
                Else
                  n_实收 := n_应收;
                End If;

                --累计医嘱合计来计算折扣
                For J In 1 .. Rs_Seek.Count Loop
                  If Rs_Seek(J).费用性质 = Rs_Money(n_Idx).费用性质 Then
                    Rs_Seek(J).合计 := Nvl(Rs_Seek(J).合计, 0) + n_实收;
                    Exit;
                  End If;
                End Loop;
              Elsif Nvl(Rs_Money(n_Idx).屏蔽费别, 0) = 0 Then
                If Gv_动态费别 Is Not Null And Not b_记帐 Then
                  v_费别 := Mv_费别 || ',' || Gv_动态费别;
                End If;
                If Vsadvice(I).零费记帐 = 1 Then
                  n_实收 := 0;
                Else
                  If Gb_加班加价 And Nvl(Rs_Money(n_Idx).加班加价, 0) = 1 Then
                    n_Tmp := Nvl(Rs_Money(n_Idx).加班加价率, 0) / 100;
                  Else
                    n_Tmp := 0;
                  End If;
                  n_实收 := Round(f_Actualmoney(v_费别, Rs_Money(n_Idx).收入项目id, n_应收, Rs_Money(n_Idx).Id, n_执行科室id,
                                              n_付数 * n_数量, n_Tmp, v_费别), Gn_Dec);
                End If;
                If Instr(v_费别, ',') > 0 Then
                  v_费别 := Mv_费别;
                End If;
              Else
                If Vsadvice(I).零费记帐 = 1 Then
                  n_实收 := 0;
                Else
                  n_实收 := n_应收;
                End If;
              End If;
              --汇总折扣时，对主项的实收金额作特殊处理,直接记入扩展字段中
              --(忽略)医保相关字段
              --收集记帐报警类别
              If Instr(v_类别, Rs_Money(n_Idx).类别) = 0 Then
                v_类别 := v_类别 || Rs_Money(n_Idx).类别;
              End If;
              --发生时间
              If Vsadvice(I).分解时间 Is Not Null Then
                d_发生时间 := To_Date(Substr(Vsadvice(I).分解时间, 1, 19), 'YYYY-MM-DD HH24:MI:SS');
              Else
                d_发生时间 := To_Date(Substr(Vsadvice(I).分解时间_Data, 1, 19), 'YYYY-MM-DD HH24:MI:SS');
              End If;
              --因为现在不计价的医嘱不产生费用,所以传入的计价特性都为(0-正常计价)
              n_合计 := Nvl(n_合计, 0) + n_实收;
              If Not b_记帐 Then
                r_费用(r_费用.Count).过程名 := 1;
                d_登记时间 := d_Cur;
              Else
                --是否划价费用
                If Instr(',5,6,7,', Vsadvice(I).诊疗类别) > 0 Then
                  If Instr(Gv_门诊发送划价单, '5') > 0 Then
                    n_划价 := 1;
                  Else
                    n_划价 := 0;
                  End If;
                Else
                  If Instr(Gv_门诊发送划价单, Vsadvice(I).诊疗类别) > 0 Then
                    n_划价 := 1;
                  Else
                    n_划价 := 0;
                  End If;
                End If;

                If n_划价 = 0 Then
                  If Rs_Money(n_Idx).费用确认 = 1 Then
                    n_划价 := 1;
                  Else
                    n_划价 := 0;
                  End If;
                End If;

                If n_划价 = 0 Or n_执行状态 = 1 Then
                  If Nvl(Gn_消费验证, 0) <> 0 Then
                    n_记帐合计 := Nvl(n_记帐合计, 0) + n_实收;
                  End If;
                End If;

                --登记时间
                If n_划价 = 1 Then
                  d_登记时间 := d_Cur + 1 / 24 / 60;
                Else
                  d_登记时间 := d_Cur;
                End If;
                r_费用(r_费用.Count).过程名 := 2;
              End If;
              --暂未取发药窗口

              n_Tmp := r_费用.Count;
              r_费用(n_Tmp).No := v_No;
              r_费用(n_Tmp).主页id := Null;
              r_费用(n_Tmp).病人来源 := 1;
              r_费用(n_Tmp).保险编码 := Null;
              r_费用(n_Tmp).费用类型 := Null;
              r_费用(n_Tmp).保险项目否 := Null;
              r_费用(n_Tmp).保险大类id := Null;
              r_费用(n_Tmp).中药形态 := Null;

              r_费用(n_Tmp).序号 := n_费用序号;
              r_费用(n_Tmp).病人id := Mn_病人id;
              r_费用(n_Tmp).标识号 := Mv_门诊号;
              r_费用(n_Tmp).姓名 := Mv_姓名;
              r_费用(n_Tmp).性别 := Mv_性别;
              r_费用(n_Tmp).年龄 := Mv_年龄;
              r_费用(n_Tmp).费别 := v_费别;
              r_费用(n_Tmp).加班标志 := Null;
              r_费用(n_Tmp).婴儿费 := Vsadvice(I).婴儿;
              r_费用(n_Tmp).病人科室id := Vsadvice(I).开嘱科室id;
              r_费用(n_Tmp).开单部门id := Vsadvice(I).开嘱科室id;
              r_费用(n_Tmp).开单人 := Vsadvice(I).开嘱医生;
              If Rs_Money(n_Idx).从项 = 1 And n_父序号 > 0 Then
                r_费用(n_Tmp).从属父号 := n_父序号;
              Else
                r_费用(n_Tmp).从属父号 := Null;
              End If;
              r_费用(n_Tmp).收费细目id := Rs_Money(n_Idx).Id;
              r_费用(n_Tmp).收费类别 := Rs_Money(n_Idx).类别;
              r_费用(n_Tmp).计算单位 := Rs_Money(n_Idx).计算单位;
              r_费用(n_Tmp).付数 := n_付数;
              r_费用(n_Tmp).数次 := n_数量;
              If b_附加手术 Then
                r_费用(n_Tmp).附加标志 := 1;
              Else
                r_费用(n_Tmp).附加标志 := 0;
              End If;
              If n_执行科室id > 0 Then
                r_费用(n_Tmp).执行部门id := n_执行科室id;
              Else
                r_费用(n_Tmp).执行部门id := Null;
              End If;
              If n_费用父号 = n_费用序号 Then
                r_费用(n_Tmp).价格父号 := Null;
              Else
                r_费用(n_Tmp).价格父号 := n_费用父号;
              End If;
              r_费用(n_Tmp).收入项目id := Rs_Money(n_Idx).收入项目id;
              r_费用(n_Tmp).收据费目 := Rs_Money(n_Idx).收据费目;
              r_费用(n_Tmp).标准单价 := n_单价;
              r_费用(n_Tmp).应收金额 := n_应收;
              r_费用(n_Tmp).实收金额 := n_实收;
              r_费用(n_Tmp).发生时间 := d_发生时间;
              r_费用(n_Tmp).登记时间 := d_登记时间;
              r_费用(n_Tmp).药品摘要 := '医嘱发送';
              r_费用(n_Tmp).划价 := n_划价;
              r_费用(n_Tmp).操作员编号 := Mv_操作员编号;
              r_费用(n_Tmp).操作员姓名 := Mv_操作员姓名;
              r_费用(n_Tmp).记帐单id := Null;
              r_费用(n_Tmp).费用摘要 := Vsadvice(I).医嘱内容;
              r_费用(n_Tmp).医嘱序号 := Vsadvice(I).Id;
              r_费用(n_Tmp).频次 := Vsadvice(I).频率;
              r_费用(n_Tmp).单量 := Vsadvice(I).单量;
              r_费用(n_Tmp).用法 := Vsadvice(I).用法;
              r_费用(n_Tmp).期效 := 1;
              If b_离院带药 Then
                r_费用(n_Tmp).计价特性 := 3;
              Else
                r_费用(n_Tmp).计价特性 := Vsadvice(I).计价特性;
              End If;
              r_费用(n_Tmp).门诊标志 := 1;
              r_费用(n_Tmp).中药形态 := Null;
              r_费用(n_Tmp).备货材料 := 0;
              r_费用(n_Tmp).批次 := Zl_To_Number(Nvl(Vsadvice(I).检查方法, 0));
              If r_费用(n_Tmp).批次 = 0 Then
                r_费用(n_Tmp).批次 := Null;
              End If;
              --记录自动发料的SQL
              If Gb_门诊自动发料 And b_记帐 And n_划价 = 0 And Nvl(n_执行科室id, 0) <> 0 And Rs_Money(n_Idx).类别 = '4' And
                 Nvl(Rs_Money(n_Idx).跟踪在用, 0) = 1 Then
                If Instr(v_自动发料 || ';', ';' || v_No || ',' || n_执行科室id || ';') = 0 Then
                  r_发料.Extend;
                  n_Tmp := r_发料.Count;
                  r_发料(n_Tmp).Partid := n_执行科室id;
                  r_发料(n_Tmp).Bill := 25;
                  r_发料(n_Tmp).No := v_No;
                  r_发料(n_Tmp).People := Mv_操作员姓名;
                  r_发料(n_Tmp).配药人 := Mv_操作员姓名;
                  r_发料(n_Tmp).校验人 := Mv_操作员姓名;
                  r_发料(n_Tmp).发药方式 := 1;
                  r_发料(n_Tmp).发药时间 := Sysdate;
                  v_自动发料 := v_自动发料 || ';' || v_No || ',' || n_执行科室id;
                End If;
              End If;
              --(忽略)医保管控实时监测：生成费用项目记录集,以收费细目汇总
            End If;
          End If;
        End Loop;
      End If;

      --对医嘱金额进行汇总折扣处理
      If Gb_从项汇总折扣 And v_Havesub Is Not Null Then

        For J In 1 .. Rs_Seek.Count Loop
          n_Tmp := Rs_Seek(J).主项标签;

          v_费别 := Mv_费别;
          If Gv_动态费别 Is Not Null And Not b_记帐 Then
            v_费别 := v_费别 || ',' || Gv_动态费别;
          End If;

          If Vsadvice(I).零费记帐 = 1 Then
            n_实收 := 0;
          Else
            n_实收 := Round(f_Actualmoney(v_费别, Rs_Seek(J).主收入id, Rs_Seek(J).合计, 0, 0, 0, 0, v_费别), Gn_Dec);

          End If;

          If Instr(v_费别, ',') > 0 Then
            v_费别 := Mv_费别;
          End If;
          --替换费别和实收
          r_费用(n_Tmp).费别 := v_费别;

          n_实收 := n_实收 - Rs_Seek(J).合计; --打折差额
          r_费用(n_Tmp).实收金额 := n_实收;

        End Loop;
      End If;
      --产生医嘱发送记录
      -------------------------------------
      If Nvl(Vsadvice(I).执行性质id, 0) <> 0 Then
        --叮嘱不发送(给药途径，配方煎法、用法,采集方法、输血途径可能为)

        --(忽略)医嘱的发送合性检查提示
        --一样要产生费用NO
        p_Getcurbillset(v_Nokey, -1, 0, b_记帐, v_No, n_Tmp, n_发送序号);
        --是否一组医嘱的第一医嘱行:药疗的第一药品行为第一医嘱行
        b_First := False;
        If Instr(',5,6,7,', Vsadvice(I).诊疗类别) > 0 Then
          If Nvl(Vsadvice(I).相关id, 0) <> Nvl(Vsadvice(I - 1).相关id, 0) Then
            b_First := True;
          End If;
        Elsif Vsadvice(I).诊疗类别 = 'C' And Nvl(Vsadvice(I).相关id, 0) <> 0 Then
          If Nvl(Vsadvice(I).相关id, 0) <> Nvl(Vsadvice(I - 1).相关id, 0) Then
            b_First := True; --检验组合中的第一检验行
          End If;
        Elsif Instr(',1,2,3,4,5,', ',' || Vsadvice(I).Id_Data || ',') = 0 Then
          --排开给药途径、中药煎法、中药用法、采集方法、输血途径
          If Nvl(Vsadvice(I).相关id, 0) = 0 Then
            b_First := True;
          End If;
        End If;
        --发送数次:药品为剂量单位的总量,其它为次数
        If Vsadvice(I).诊疗类别 = '7' Then
          n_发送数次 := Vsadvice(I).总量 * Vsadvice(I).单量;
        Elsif Instr(',5,6,', Vsadvice(I).诊疗类别) > 0 Then
          n_发送数次 := Vsadvice(I).总量 * Vsadvice(I).门诊包装 * Vsadvice(I).剂量系数;
        Else
          n_发送数次 := Vsadvice(I).总量;
        End If;

        --首末时间
        v_分解时间 := Vsadvice(I).分解时间;
        If v_分解时间 Is Not Null Then
          d_首次时间 := To_Date(Substr(v_分解时间, 1, 19), 'YYYY-MM-DD HH24:MI:SS');
          d_末次时间 := To_Date(Substr(v_分解时间, Instr(v_分解时间, ',', -1) + 1, 19), 'YYYY-MM-DD HH24:MI:SS');
        Else
          --无法分解或为'一次性'临嘱，填为开始执行时间
          d_首次时间 := To_Date(Vsadvice(I).开始时间, 'YYYY-MM-DD HH24:MI:SS');
          d_末次时间 := d_首次时间;
        End If;

        If Not Gb_发送生成条形码 Then
          v_Cuvettenumber := Null;
        End If;
        r_发送.Extend;
        n_Tmp := r_发送.Count;
        r_发送(n_Tmp).医嘱id := Vsadvice(I).Id;
        r_发送(n_Tmp).发送号 := n_发送号;
        If b_记帐 Then
          r_发送(n_Tmp).记录性质 := 2;
        Else
          r_发送(n_Tmp).记录性质 := 1;
        End If;
        r_发送(n_Tmp).No := v_No;
        r_发送(n_Tmp).记录序号 := n_发送序号; --   病人医嘱发送.记录序号%Type,
        If n_发送数次 > 0 Then
          r_发送(n_Tmp).发送数次 := n_发送数次;
        Else
          r_发送(n_Tmp).发送数次 := Null;
        End If;
        r_发送(n_Tmp).首次时间 := d_首次时间;
        r_发送(n_Tmp).末次时间 := d_末次时间;
        r_发送(n_Tmp).发送时间 := d_Cur;
        r_发送(n_Tmp).执行状态 := n_执行状态;
        r_发送(n_Tmp).执行部门id := Vsadvice(I).执行科室id;
        r_发送(n_Tmp).计费状态 := n_计费状态;
        If b_First Then
          r_发送(n_Tmp).First := 1;
        Else
          r_发送(n_Tmp).First := 0;
        End If;
        r_发送(n_Tmp).样本条码 := v_Cuvettenumber;
        r_发送(n_Tmp).操作员编号 := Mv_操作员编号;
        r_发送(n_Tmp).操作员姓名 := Mv_操作员姓名;

        --医嘱执行计价
        For J In 1 .. Rs_Exec.Count Loop
          If Rs_Exec(J).医嘱id = Vsadvice(I).Id And Rs_Exec(J).发送号 = n_发送号 Then
            r_执行计价.Extend;
            n_Tmp := r_执行计价.Count;
            r_执行计价(n_Tmp).医嘱id := Rs_Exec(J).医嘱id;
            r_执行计价(n_Tmp).发送号 := n_发送号;
            r_执行计价(n_Tmp).要求时间 := To_Date(Rs_Exec(J).要求时间, 'YYYY-MM-DD HH24:MI:SS');
            r_执行计价(n_Tmp).收费细目id := Rs_Exec(J).收费细目id;
            r_执行计价(n_Tmp).数量 := Rs_Exec(J).数量;
            r_执行计价(n_Tmp).费用性质 := 0;
          End If;
        End Loop;
        --(忽略)血库系统调用 Zl_血液配血费用_Insert
        --(忽略)要发送的尚未签名的医嘱ID(组ID,一组中的叮嘱也会被签名)
      End If;
      --计算中药配方数
      If Vsadvice(I).Id_Data = '3' Then
        --中药用法
        n_配方数 := n_配方数 + 1;
      End If;
    End Loop;
    --(忽略)自动进行电子签名(未签名部份)
    --(忽略)医保管控实时监测
    --(忽略)调用外挂接口
    Return(1);
  End;

  --提交本次发送的HIS数据
  Procedure p_Completepatisend Is
  Begin
    p_Replacetrueno;
    For I In 1 .. r_计价.Count Loop
      If r_计价(I).过程名 = 1 Then
        Zl_病人医嘱计价_Delete(r_计价(I).医嘱id, r_计价(I).删单行);
      Else
        Zl_病人医嘱计价_Insert(r_计价(I).医嘱id, r_计价(I).收费细目id, r_计价(I).数量, r_计价(I).单价, r_计价(I).从项, r_计价(I).执行科室id, r_计价(I).费用性质,
                         r_计价(I).收费方式);
      End If;
    End Loop;
    For I In 1 .. r_费用.Count Loop
      If r_费用(I).过程名 = 1 Then
        Zl_门诊划价记录_Insert(r_费用(I).No, r_费用(I).序号, r_费用(I).病人id, r_费用(I).主页id, r_费用(I).标识号, r_费用(I).付款方式, r_费用(I).姓名,
                         r_费用(I).性别, r_费用(I).年龄, r_费用(I).费别, r_费用(I).加班标志, r_费用(I).病人科室id, r_费用(I).开单部门id, r_费用(I).开单人,
                         r_费用(I).从属父号, r_费用(I).收费细目id, r_费用(I).收费类别, r_费用(I).计算单位, r_费用(I).发药窗口, r_费用(I).付数, r_费用(I).数次,
                         r_费用(I).附加标志, r_费用(I).执行部门id, r_费用(I).价格父号, r_费用(I).收入项目id, r_费用(I).收据费目, r_费用(I).标准单价,
                         r_费用(I).应收金额, r_费用(I).实收金额, r_费用(I).发生时间, r_费用(I).登记时间, r_费用(I).药品摘要, r_费用(I).操作员姓名,
                         r_费用(I).费用摘要, r_费用(I).医嘱序号, r_费用(I).频次, r_费用(I).单量, r_费用(I).用法, r_费用(I).期效, r_费用(I).计价特性,
                         r_费用(I).病人来源, r_费用(I).保险编码, r_费用(I).费用类型, r_费用(I).保险项目否, r_费用(I).保险大类id, r_费用(I).中药形态,
                         r_费用(I).备货材料, r_费用(I).批次);
      Else
        Zl_门诊记帐记录_Insert(r_费用(I).No, r_费用(I).序号, r_费用(I).病人id, r_费用(I).标识号, r_费用(I).姓名, r_费用(I).性别, r_费用(I).年龄,
                         r_费用(I).费别, r_费用(I).加班标志, r_费用(I).婴儿费, r_费用(I).病人科室id, r_费用(I).开单部门id, r_费用(I).开单人,
                         r_费用(I).从属父号, r_费用(I).收费细目id, r_费用(I).收费类别, r_费用(I).计算单位, r_费用(I).付数, r_费用(I).数次, r_费用(I).附加标志,
                         r_费用(I).执行部门id, r_费用(I).价格父号, r_费用(I).收入项目id, r_费用(I).收据费目, r_费用(I).标准单价, r_费用(I).应收金额,
                         r_费用(I).实收金额, r_费用(I).发生时间, r_费用(I).登记时间, r_费用(I).药品摘要, r_费用(I).划价, r_费用(I).操作员编号,
                         r_费用(I).操作员姓名, r_费用(I).记帐单id, r_费用(I).费用摘要, r_费用(I).医嘱序号, r_费用(I).频次, r_费用(I).单量, r_费用(I).用法,
                         r_费用(I).期效, r_费用(I).计价特性, r_费用(I).门诊标志, r_费用(I).中药形态, r_费用(I).备货材料, r_费用(I).批次);
      End If;
    End Loop;

    For I In 1 .. r_发送.Count Loop
      Zl_门诊医嘱发送_Insert(r_发送(I).医嘱id, r_发送(I).发送号, r_发送(I).记录性质, r_发送(I).No, r_发送(I).记录序号, r_发送(I).发送数次, r_发送(I).首次时间,
                       r_发送(I).末次时间, r_发送(I).发送时间, r_发送(I).执行状态, r_发送(I).执行部门id, r_发送(I).计费状态, r_发送(I).First,
                       r_发送(I).样本条码, r_发送(I).操作员编号, r_发送(I).操作员姓名);

    End Loop;

    For I In 1 .. r_执行计价.Count Loop
      Zl_医嘱执行计价_Insert(r_执行计价(I).医嘱id, r_执行计价(I).发送号, r_执行计价(I).要求时间, r_执行计价(I).收费细目id, r_执行计价(I).数量, r_执行计价(I).费用性质);
    End Loop;

    For I In 1 .. r_发料.Count Loop
      Zl_材料收发记录_处方发料(r_发料(I).Partid, r_发料(I).Bill, r_发料(I).No, r_发料(I).People, r_发料(I).配药人, r_发料(I).校验人, r_发料(I).发药方式,
                     r_发料(I).发药时间);
    End Loop;
  Exception
    When Others Then
      Rollback;
      p_Errcenter(SQLErrM);
      --zl_ErrorCenter(SQLCode, SQLErrM);
  End;
Begin
  --传入参数
  Select Extractvalue(Value(A), 'IN/BRID') As 病人id, Extractvalue(Value(A), 'IN/JZID') As 就诊id,
         Extractvalue(Value(A), 'IN/YZIDS') As 医嘱ids, Extractvalue(Value(A), 'IN/ZD') As 站点,
         To_Number(Extractvalue(Value(A), 'IN/JZD')) As 记帐, Extractvalue(Value(A), 'IN/CZYXM') As 操作员,
         Extractvalue(Value(A), 'IN/CZYBH') As 操作员编号, To_Number(Extractvalue(Value(A), 'IN/JBJJ')) As 加班加价,
         To_Number(Extractvalue(Value(A), 'IN/CLLIS')) As 调用, To_Number(Extractvalue(Value(A), 'IN/FHLISDATA')) As 返回
  Into n_病人id, n_就诊id, v_医嘱ids, v_站点, n_记帐, v_操作员姓名, v_操作员编号, n_加班加价, n_调用, n_返回
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  I := f_Main(v_站点, n_就诊id, n_病人id, v_医嘱ids, n_加班加价, v_操作员编号, v_操作员姓名);
  p_Load;
  I := f_Loadadvicesend;
  If I = 1 Then
    I := f_Sendadvice(n_记帐);
    p_Completepatisend;
    p_Lis接口(n_调用, n_返回, x_t);
  End If;
  If x_t Is Null Then
    v_Tmp   := '<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  Else
    Xml_Out := x_t;
  End If;
Exception
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
End Zl_Third_Advicesend;
/

CREATE OR REPLACE Procedure Zl_Third_Advicesavesend
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:病人生成医嘱发送医嘱(检查检验)，一个病人调用一次
  --入参:Xml_In:
  --特殊说明：入参结构和Zl_Third_Advicesave入参数相同
  --           除此之外在<IN> 结点下增加<FSXGXX>结点

  --  <IN>
  --   <///...>......... Zl_Third_Advicesave入参
  --   <FSXGXX> 发送相关信息
  --      <CZYBH></CZYBH> 操作员编号
  --      <JZD>0</JZD> 是否发送为记帐单，0-划价单，1-记帐单
  --      <JBJJ></JBJJ>加班加价 由外部传入决定
  --      <CLLIS></CLLIS>处理LIS申请，定决是否要在过程内部调用LIS接口， 0-不处理，1-要处理
  --      <FHLISDATA></FHLISDATA>是否需要返回LIS申请信息，0-不返回，1-返回
  --   </FSXGXX>
  --  </IN>

  --出参:Xml_Out，生成的医嘱ID串，错误信息
  --  <OUTPUT>
  --    <YZIDS>1234,41234,64645,...</YZIDS>医嘱ID串，逗号分割
  --    <FSH>1234</FSH> 发送号
  --    <LISAPP>C:44271,E:44272;C:44273,E:44274</LISAPP>检验医嘱信息，固定格式：类别:医嘱ID,类别:医嘱ID;....
  --    <LISDATA></LISDATA>新版LIS检验信息，返回值
  --         LISDATA 此结点的内容，为 Zl_Thrid_Sendlisapplication 过程的 入参数，
  --         结点内容可以有行<IN>XXX1</IN><IN>XXX2</IN>.....
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------

  v_Tmp     Varchar(32767);
  v_医嘱ids Varchar2(32767);
  v_发送号  Varchar2(32767);

  x_Tmp     Xmltype;
  x_Par     Xmltype;
  v_Err_Msg Varchar(2000);
  Err_Item Exception;

Begin

  --调用医嘱保存过程
  Zl_Third_Advicesave(Xml_In, x_Tmp);

  --获取保存后的医嘱IDs串
  Select Extractvalue(Value(A), 'OUTPUT/YZIDS') As 医嘱ids, Extractvalue(Value(A), 'OUTPUT/ERROR/MSG') As 错误信息
  Into v_医嘱ids, v_Err_Msg
  From Table(Xmlsequence(Extract(x_Tmp, 'OUTPUT'))) A;

  If v_Err_Msg Is Not Null Then
    Raise Err_Item;
  End If;
  x_Tmp := Null;

  --重新生成发送接口的入参
  Select Xmlelement("IN",
                     Xmlforest(b.病人id As "BRID", b.就诊id As "JZID", v_医嘱ids As "YZIDS", b.操作员 As "CZYXM",
                                b.操作员编号 As "CZYBH", b.站点 As "ZD", b.是否发送记帐单 As "JZD", b.加班加价 As "JBJJ", b.处理lis申请 As "CLLIS",
                                b.Lis申请信息 As "FHLISDATA")) As 数据
  Into x_Par
  From Xmltable('$a/IN' Passing Xml_In As "a" Columns 病人id Number(18) Path 'BRID', 就诊id Number(18) Path 'JZID',
                 操作员 Varchar2(20) Path 'CZYXM', 站点 Varchar2(1) Path 'ZD', 操作员编号 Varchar2(20) Path 'FSXGXX/CZYBH',
                 是否发送记帐单 Number(1) Path 'FSXGXX/JZD', 加班加价 Number(1) Path 'FSXGXX/JBJJ',
                 处理lis申请 Number(1) Path 'FSXGXX/CLLIS', Lis申请信息 Number(1) Path 'FSXGXX/FHLISDATA') B;

  Zl_Third_Advicesend(x_Par, x_Tmp);

  Select Max(发送号)
  Into v_发送号
  From 病人医嘱发送
  Where 医嘱id In (Select /*+cardinality(x,10)*/
                  x.Column_Value
                 From Table(f_Num2list(v_医嘱ids)) X);

  Select Appendchildxml(x_Tmp, '/OUTPUT', Xmltype('<YZIDS>' || v_医嘱ids || '</YZIDS>')) Into x_Tmp From Dual;
  Select Appendchildxml(x_Tmp, '/OUTPUT', Xmltype('<FSH>' || v_发送号 || '</FSH>')) Into x_Tmp From Dual;
  Xml_Out := x_Tmp;
Exception
  When Err_Item Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Advicesavesend;
/

Create Or Replace Procedure Zl_Third_Getadvicelist
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：通过历史就诊记录返回门诊、住院病人医嘱列表
  --入参：Xml_In
  --<IN>
  --     <BRID></BRID>     --病人ID
  --     <JZID></JZID>     --就诊ID    住院：主页ID  门诊：挂号单ID
  --     <BRLY></BRLY>     --病人来源  1-门诊  2-住院

  --</IN>
  --出参：Xml_Out
  --<OUTPUT>
  --  <YZLIST>医嘱列表[数组]
  --    <YZ>
  --       <PATIID></PATIID>     --病人医嘱记录.病人ID
  --       <PAGEID></PAGEID>     --病人医嘱记录.主页ID
  --       <BABY></BABY>   --病人医嘱记录.婴儿
  --       <YZID>1145878</YZID>   --病人医嘱记录.医嘱ID， 主医嘱ID
  --       <RELATEDID></RELATEDID>   --病人医嘱记录.相关ID
  --       <ZXKSID></ZXKSID>   --病人医嘱记录.执行科室id
  --       <YZQX>0</YZQX>      --病人医嘱记录.医嘱期效
  --       <STATE>8</STATE>    --病人医嘱记录.医嘱状态
  --       <JJBZ>0</JJBZ>      --病人医嘱记录.紧急标志
  --       <KZYS>代翔</KZYS>   --病人医嘱记录.开嘱医生
  --       <KZSJ>2015-03-25 16:37:00</KZSJ>   --病人医嘱记录.开嘱时间
  --       <ZLXMID></ZLXMID>   --诊疗项目目录.ID
  --       <ZLLB>E</ZLLB>      --诊疗项目目录.类别
  --       <ZLXMMC></ZLXMMC>   --诊疗项目目录.名称 ，检查，检验(检验行 C)，手术(主手术行 F)，输血(K)，中药配方(服法行 E)，其它(本身)
  --       <ZLXMCZLX></<ZLXMCZLX>   --诊疗项目目录.操作类型
  --       <ZLXMZXFL></ZLXMZXFL>   --诊疗项目目录.执行分类
  --       <BZ>21</BZ> 诊疗项目目录.操作类型||诊疗项目目录.执行分类
  --       <YF>静脉滴注</YF>   --病人医嘱记录.医嘱内容 ，主医嘱行中的  医嘱内容
  --       <PC>BID</PC>   --诊疗频率项目.英文名称
  --       <ZXPC>每天一次</ZXPC>   -执行频次
  --       <ZXSJFY>18-20</ZXSJFY>   --病人医嘱记录.执行时间方案
  --       <PLCS>2</PLCS>   --病人医嘱记录.频率次数
  --       <PLJG>1</PLJG>   --病人医嘱记录.频率间隔
  --       <PSJG></PSJG>   --病人医嘱记录.皮试结果
  --       <YSZT></YSZT>   --病人医嘱记录.医生嘱托
  --       <KSZXSJ>2015-03-25 16:35:00</KSZXSJ>  --病人医嘱记录.开始执行时间
  --       <ZXZZSJ></ZXZZSJ>   --病人医嘱记录.执行终止时间
  --       <TZYS></TZYS>   --病人医嘱记录.停嘱医生
  --       <TZSJ></TZSJ>   --病人医嘱记录.停嘱时间
  --       <DW>次</DW>   --诊疗项目目录.计算单位
  --       <DL></DL>   --病人医嘱记录.单次用量
  --       <ZL></ZL>   --病人医嘱记录.总给予量
  --       <BBBW></BBBW>   --标本部位，诊疗项目目录.标本部位
  --       <ITEMLIST> 仅输血项目和西/成药医嘱项目明细相关信息；输血的血袋信息，药品行明细信息
  --        <ITEM>
  --         <ZLLB>E</ZLLB>      --诊疗项目目录.类别
  --         <ZLXMCZLX></<ZLXMCZLX>   --诊疗项目目录.操作类型
  --         <YSZT></YSZT>   --病人医嘱记录.医生嘱托
  --         <YZID>1145878</YZID>   --病人医嘱记录.医嘱ID
  --         <RELATEDID></RELATEDID>   --病人医嘱记录.相关ID
  --         <YZNR>静脉滴注</YZNR>   --病人医嘱记录.医嘱内容
  --         <ZLXMID></ZLXMID>   --诊疗项目目录.ID
  --         <ZLXMMC></ZLXMMC>   --诊疗项目目录.名称 ，检查，检验(检验行 C)，手术(主手术行 F)，输血(K)，中药配方(服法行 E)，其它(本身)
  --         <SFXMID></SFXMID>   --收费项目目录.id
  --         <SFXMMC></SFXMMC>   --收费项目目录.名称
  --         <SFXMGG></SFXMGG>   --收费项目目录.规格
  --         <BM></BM>           --收费项目别名.名称（商品名）
  --         <ZL></ZL>           --病人医嘱记录.总给予量
  --         <DL>10</DL>         --病人医嘱记录.单次用量
  --         <DW>ml</DW>         --收费项目目录.计算单位
  --         <ZLDW>ml</ZLDW>   --诊疗项目目录.计算单位
  --         <ZXXZ></ZXXZ>   --病人医嘱记录.执行性质
  --         <ZXKS></ZXKS>   --诊疗项目目录.执行科室
  --         <XDBH></XDBH>   --血液收发记录.血袋编号
  --         <SXXH></SXXH>   --血液收发记录.序号
  --         <BBBW></BBBW>   --标本部位，诊疗项目目录.标本部位

  --        </ITEM>
  --        <ITEM/>...
  --       </ITEMLIST>
  --      </YZ>
  --  </YZLIST>
  --  .....
  --</OUTPUT>

  n_病人id   Number;
  n_就诊id   Number;
  n_病人来源 Number;

  n_医嘱id  病人医嘱记录.Id%Type;
  x_医嘱    Xmltype;
  x_Item    Xmltype;
  v_Xtmp    Clob; --临时XML
  n_Cnt     Number;
  x_Templet Xmltype;

  v_英文名     诊疗频率项目.英文名称%Type;
  v_试管名称   采血管类型.名称%Type;
  v_添加剂     采血管类型.添加剂%Type;
  v_试管规格   采血管类型.规格%Type;
  n_试管颜色   采血管类型.颜色%Type;
  v_收费商品名 收费项目别名.名称%Type;
  n_启用血库   Number;
  v_Sql血库    Varchar2(4000);
  n_血库申请id Number(18);
  v_Tmp输血    Varchar2(4000);

  Type Bloodlist_Type Is Ref Cursor;
  Cbloodlist Bloodlist_Type;

  Type t_Code Is Record(
    ID       收费项目目录.Id%Type,
    名称     收费项目目录.名称%Type,
    规格     收费项目目录.规格%Type,
    单位     收费项目目录.计算单位%Type,
    血袋编号 Varchar2(50),
    序号     Number(5));
  r_b t_Code;

Begin

  Select Nvl(To_Number(Extractvalue(Value(A), 'IN/BRLY')), 2), Nvl(To_Number(Extractvalue(Value(A), 'IN/BRID')), 0),
         Nvl(To_Number(Extractvalue(Value(A), 'IN/JZID')), 0)
  Into n_病人来源, n_病人id, n_就诊id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT><YZLIST></YZLIST></OUTPUT>');

  --加载主医嘱列表
  For r_Pati In (Select ID
                 From 病人医嘱记录
                 Where 病人id = n_病人id And ((n_病人来源 <> 2 And 挂号单 = (Select NO From 病人挂号记录 Where ID = n_就诊id)) Or
                       (n_病人来源 = 2 And 主页id = n_就诊id)) And 相关id Is Null And 医嘱状态 Not In (-1, 4)
                 Order By 序号) Loop
  
    n_医嘱id := r_Pati.Id;
  
    n_Cnt := 0;
  
    x_Item := Xmltype('<ITEMLIST></ITEMLIST>');
    v_Xtmp := '';
  
    For R In (Select a.病人id, a.主页id, a.婴儿, a.Id As 医嘱id, a.相关id, a.执行科室id, a.医嘱期效, a.医嘱状态, a.紧急标志, a.开嘱医生, a.开嘱时间,
                     a.诊疗项目id, a.诊疗类别, a.医嘱内容, a.执行时间方案, a.执行频次, a.频率次数, a.频率间隔, a.皮试结果, a.医生嘱托, a.开始执行时间, a.执行终止时间,
                     a.停嘱医生, a.停嘱时间, b.名称 As 项目名称,
                     Decode(b.类别, 'E', Decode(b.操作类型, '2', b.操作类型 || b.执行分类, '1', '1', '4', '4', '6', '6', '99'), 'D', '',
                             '99') As 操执, b.操作类型, b.执行分类, b.计算单位 As 诊疗单位, a.单次用量, a.总给予量, Nvl(b.标本部位, a.标本部位) As 标本部位,
                     a.检查方法, a.收费细目id, c.名称 As 收费名称, c.规格, Null As 收费商品名, c.计算单位 As 收费单位, a.执行性质, b.执行科室, b.试管编码, c.产地,
                     d.高危药品
              From 病人医嘱记录 A, 诊疗项目目录 B, 收费项目目录 C, 药品规格 D
              Where a.诊疗项目id = b.Id And a.收费细目id = c.Id(+) And a.收费细目id = d.药品id(+) And
                    (a.Id = n_医嘱id Or a.相关id = n_医嘱id)
              Order By a.序号) Loop
      n_Cnt := n_Cnt + 1;
      If n_Cnt = 1 Then
        Select Max(a.英文名称) Into v_英文名 From 诊疗频率项目 A Where a.名称 = r.执行频次;
      End If;
      v_试管名称 := Null;
      v_添加剂   := Null;
      v_试管规格 := Null;
      n_试管颜色 := Null;
      If r.试管编码 Is Not Null Then
        Select Max(a.名称), Max(a.添加剂), Max(a.规格), Max(a.颜色)
        Into v_试管名称, v_添加剂, v_试管规格, n_试管颜色
        From 采血管类型 A
        Where a.编码 = r.试管编码;
      End If;
      --主医行
      If r.相关id Is Null Then
        v_Xtmp := '<YZ>';
        v_Xtmp := v_Xtmp || '<PATIID>' || r.病人id || '</PATIID>'; --病人医嘱记录.病人ID
        v_Xtmp := v_Xtmp || '<PAGEID>' || r.主页id || '</PAGEID>'; --病人医嘱记录.主页ID
        v_Xtmp := v_Xtmp || '<BABY>' || r.婴儿 || '</BABY>'; --病人医嘱记录.婴儿
        v_Xtmp := v_Xtmp || '<YZID>' || r.医嘱id || '</YZID>'; --病人医嘱记录.医嘱ID
        v_Xtmp := v_Xtmp || '<RELATEDID>' || r.相关id || '</RELATEDID>'; --病人医嘱记录.相关ID
        v_Xtmp := v_Xtmp || '<ZXKSID>' || r.执行科室id || '</ZXKSID>'; --病人医嘱记录.执行科室id
        v_Xtmp := v_Xtmp || '<YZQX>' || r.医嘱期效 || '</YZQX>'; --病人医嘱记录.医嘱期效
        v_Xtmp := v_Xtmp || '<STATE>' || r.医嘱状态 || '</STATE>'; --病人医嘱记录.医嘱状态
        v_Xtmp := v_Xtmp || '<JJBZ>' || r.紧急标志 || '</JJBZ>'; --病人医嘱记录.紧急标志
        v_Xtmp := v_Xtmp || '<KZYS>' || r.开嘱医生 || '</KZYS>'; --病人医嘱记录.开嘱医生
        v_Xtmp := v_Xtmp || '<KZSJ>' || To_Char(r.开嘱时间, 'yyyy-mm-dd hh24:mi:ss') || '</KZSJ>'; --病人医嘱记录.开嘱时间
        v_Xtmp := v_Xtmp || '<BZ>' || r.操执 || '</BZ>'; -- 诊疗项目目录.操作类型||诊疗项目目录.执行分类
        v_Xtmp := v_Xtmp || '<ZLXMID>' || r.诊疗项目id || '</ZLXMID>'; --诊疗项目目录.ID
        v_Xtmp := v_Xtmp || '<ZLLB>' || r.诊疗类别 || '</ZLLB>'; --诊疗项目目录.类别
        v_Xtmp := v_Xtmp || '<YZNR>' || r.医嘱内容 || '</YZNR>'; --医嘱内容
        v_Xtmp := v_Xtmp || '<YF>' || r.项目名称 || '</YF>'; --病人医嘱记录.医嘱内容
        v_Xtmp := v_Xtmp || '<PC>' || v_英文名 || '</PC>'; --诊疗频率项目.英文名称
        v_Xtmp := v_Xtmp || '<ZXPC>' || r.执行频次 || '</ZXPC>'; --病人医嘱记录.执行频次
        v_Xtmp := v_Xtmp || '<ZXSJFY>' || r.执行时间方案 || '</ZXSJFY>'; --病人医嘱记录.执行时间方案
        v_Xtmp := v_Xtmp || '<PLCS>' || r.频率次数 || '</PLCS>'; --病人医嘱记录.频率次数
        v_Xtmp := v_Xtmp || '<PLJG>' || r.频率间隔 || '</PLJG>'; --病人医嘱记录.频率间隔
        v_Xtmp := v_Xtmp || '<PSJG>' || r.皮试结果 || '</PSJG>'; --病人医嘱记录.皮试结果
        v_Xtmp := v_Xtmp || '<YSZT>' || r.医生嘱托 || '</YSZT>'; --病人医嘱记录.医生嘱托
        v_Xtmp := v_Xtmp || '<KSZXSJ>' || To_Char(r.开始执行时间, 'yyyy-mm-dd hh24:mi:ss') || '</KSZXSJ>'; --病人医嘱记录.开始执行时间
        v_Xtmp := v_Xtmp || '<ZXZZSJ>' || To_Char(r.执行终止时间, 'yyyy-mm-dd hh24:mi:ss') || '</ZXZZSJ>'; --病人医嘱记录.执行终止时间
        v_Xtmp := v_Xtmp || '<TZYS>' || r.停嘱医生 || '</TZYS>'; --病人医嘱记录.停嘱医生
        v_Xtmp := v_Xtmp || '<TZSJ>' || To_Char(r.停嘱时间, 'yyyy-mm-dd hh24:mi:ss') || '</TZSJ>'; --病人医嘱记录.停嘱时间
        v_Xtmp := v_Xtmp || '<ZLXMMC>' || r.项目名称 || '</ZLXMMC>'; --诊疗项目目录.名称
        v_Xtmp := v_Xtmp || '<ZLXMCZLX>' || r.操作类型 || '</ZLXMCZLX>'; --诊疗项目目录.操作类型
        v_Xtmp := v_Xtmp || '<ZLXMZXFL>' || r.执行分类 || '</ZLXMZXFL>'; --诊疗项目目录.执行分类
        --       (仅采血管返回)
        v_Xtmp := v_Xtmp || '<CXGMC>' || v_试管名称 || '</CXGMC>'; --采血管名称
        v_Xtmp := v_Xtmp || '<CXGTJJ>' || v_添加剂 || '</CXGTJJ>'; --采血管添加剂
        v_Xtmp := v_Xtmp || '<CXGGG>' || v_试管规格 || '</CXGGG>'; --采血管规格
        v_Xtmp := v_Xtmp || '<CXGYS>' || n_试管颜色 || '</CXGYS>'; --采血管颜色
        v_Xtmp := v_Xtmp || '<DW>' || r.诊疗单位 || '</DW>'; --诊疗项目目录.计算单位
        v_Xtmp := v_Xtmp || '<DL>' || r.单次用量 || '</DL>'; --病人医嘱记录.单次用量
        v_Xtmp := v_Xtmp || '<ZL>' || r.总给予量 || '</ZL>'; --病人医嘱记录.总给予量
        v_Xtmp := v_Xtmp || '<BBBW>' || r.标本部位 || '</BBBW>'; --诊疗项目目录.标本部位
        v_Xtmp := v_Xtmp || '</YZ>';
        x_医嘱 := Xmltype(v_Xtmp);
      End If;
    
      --输血
      If r.诊疗类别 = 'K' Then
        --判断是否安装血库
        Select Zl_Checkobject(1, '血液收发记录') Into n_启用血库 From Dual;
        If n_启用血库 > 0 Then
          n_血库申请id := r.医嘱id;
          --医嘱部分
          v_Xtmp    := '<YSZT>' || r.医生嘱托 || '</YSZT>'; --病人医嘱记录.医生嘱托
          v_Xtmp    := v_Xtmp || '<YZID>' || r.医嘱id || '</YZID>'; --病人医嘱记录.医嘱ID
          v_Xtmp    := v_Xtmp || '<RELATEDID>' || r.相关id || '</RELATEDID>'; --病人医嘱记录.相关ID
          v_Xtmp    := v_Xtmp || '<ZLXMID>' || r.诊疗项目id || '</ZLXMID>'; --诊疗项目目录.ID
          v_Xtmp    := v_Xtmp || '<ZL>' || r.总给予量 || '</ZL>'; --病人医嘱记录.总给予量
          v_Xtmp    := v_Xtmp || '<DL>' || r.单次用量 || '</DL>'; --病人医嘱记录.单次用量
          v_Xtmp    := v_Xtmp || '<ZLDW>' || r.诊疗单位 || '</ZLDW>'; --诊疗项目目录.计算单位
          v_Xtmp    := v_Xtmp || '<ZXXZ>' || r.执行性质 || '</ZXXZ>'; --病人医嘱记录.执行性质
          v_Xtmp    := v_Xtmp || '<ZXKS>' || r.执行科室 || '</ZXKS>'; --诊疗项目目录.执行科室
          v_Tmp输血 := v_Xtmp;
          If r.检查方法 = '1' Then
            v_Sql血库 := 'Select d.Id,d.名称,d.规格,d.计算单位 as 单位, a.血袋编号,a.序号
                       From 血液收发记录 a,血液发送记录 b,血液配血记录 c,收费项目目录 d
                       Where a.Id = b.收发id And b.配发id = c.Id and a.血液id =d.id  And c.申请id =:1';
          End If;
        End If;
      Elsif r.相关id Is Not Null And r.诊疗类别 = 'E' And r.操作类型 = '8' And Nvl(r.执行分类, 0) = 0 And n_启用血库 = 1 And
            v_Sql血库 Is Null Then
        v_Sql血库 := 'Select b.Id,b.名称,  b.规格,b.计算单位 as 单位, a.血袋编号,a.序号
                  From 血液收发记录 a,收费项目目录 b
                  Where a.血液id =b.id and a.配发id = (Select Id From 血液配血记录 Where 申请id=:1)';
      Else
        v_Sql血库 := Null;
      End If;
    
      If v_Sql血库 Is Not Null And n_血库申请id Is Not Null Then
        --输血医嘱，只有发医嘱后才可能有血袋信息
        x_Item := Xmltype('<ITEMLIST></ITEMLIST>');
        Open Cbloodlist For v_Sql血库
          Using n_血库申请id;
        Loop
          Fetch Cbloodlist
            Into r_b.Id, r_b.名称, r_b.规格, r_b.单位, r_b.血袋编号, r_b.序号;
          Exit When Cbloodlist%NotFound;
          v_收费商品名 := Null;
          If r_b.Id Is Not Null Then
            For Z In (Select a.名称, a.性质
                      From 收费项目别名 A
                      Where a.收费细目id = r_b.Id
                      Group By a.名称, a.性质
                      Order By a.性质) Loop
              v_收费商品名 := z.名称;
              If z.性质 = 3 Then
                v_收费商品名 := z.名称;
                Exit;
              End If;
            End Loop;
          End If;
        
          v_Xtmp := '<ITEM jsonArray="True" >';
        
          v_Xtmp := v_Xtmp || v_Tmp输血;
        
          --血库部分
          v_Xtmp := v_Xtmp || '<SFXMID>' || r_b.Id || '</SFXMID>'; --收费项目目录.id
          v_Xtmp := v_Xtmp || '<SFXMMC>' || r_b.名称 || '</SFXMMC>'; --收费项目目录.名称
          v_Xtmp := v_Xtmp || '<SFXMGG>' || r_b.规格 || '</SFXMGG>'; --收费项目目录.规格
          v_Xtmp := v_Xtmp || '<BM>' || v_收费商品名 || '</BM>'; --收费项目别名.名称（商品名）
          v_Xtmp := v_Xtmp || '<DW>' || r_b.单位 || '</DW>'; --收费项目目录.计算单位
          v_Xtmp := v_Xtmp || '<XDBH>' || r_b.血袋编号 || '</XDBH>'; --血液收发记录.血袋编号
          v_Xtmp := v_Xtmp || '<SXXH>' || r_b.序号 || '</SXXH>'; --血液收发记录.序号
        
          v_Xtmp := v_Xtmp || '</ITEM>';
          Select Appendchildxml(x_Item, '/ITEMLIST', Xmltype(v_Xtmp)) Into x_Item From Dual;
        End Loop;
        Close Cbloodlist;
      End If;
    
      --西药成药医嘱
      If r.诊疗类别 = '5' Or r.诊疗类别 = '6' Or r.诊疗类别 = '7' Or (r.诊疗类别 = 'E' And r.操作类型 = '3') Then
        --西/成 药
        If x_Item Is Null Then
          --只初始化一次
          x_Item := Xmltype('<ITEMLIST></ITEMLIST>');
        End If;
        v_收费商品名 := Null;
        If r.收费细目id Is Not Null Then
          For Z In (Select a.名称, a.性质
                    From 收费项目别名 A
                    Where a.收费细目id = r.收费细目id
                    Group By a.名称, a.性质
                    Order By a.性质) Loop
            v_收费商品名 := z.名称;
            If z.性质 = 3 Then
              v_收费商品名 := z.名称;
              Exit;
            End If;
          End Loop;
        End If;
      
        v_Xtmp := '<ITEM jsonArray="True" >';
        v_Xtmp := v_Xtmp || '<ZLLB>' || r.诊疗类别 || '</ZLLB>'; --病人医嘱记录.诊疗类别
        v_Xtmp := v_Xtmp || '<ZLXMCZLX>' || r.操作类型 || '</ZLXMCZLX>';
        v_Xtmp := v_Xtmp || '<YSZT>' || r.医生嘱托 || '</YSZT>'; --病人医嘱记录.医生嘱托
        v_Xtmp := v_Xtmp || '<YZID>' || r.医嘱id || '</YZID>'; --病人医嘱记录.医嘱ID
        v_Xtmp := v_Xtmp || '<RELATEDID>' || r.相关id || '</RELATEDID>'; --病人医嘱记录.相关ID
        v_Xtmp := v_Xtmp || '<YZNR>' || r.医嘱内容 || '</YZNR>'; --医嘱内容
        v_Xtmp := v_Xtmp || '<GW>' || Nvl(r.高危药品, 0) || '</GW>'; --高危药标识，1表示高危药，0表示普通
        v_Xtmp := v_Xtmp || '<CDM>' || r.产地 || '</CDM>'; --产地名，收费项目目录.产地
        v_Xtmp := v_Xtmp || '<ZLXMID>' || r.诊疗项目id || '</ZLXMID>'; --诊疗项目目录.ID
        v_Xtmp := v_Xtmp || '<ZLXMMC>' || r.项目名称 || '</ZLXMMC>'; --诊疗项目目录.名称
        v_Xtmp := v_Xtmp || '<SFXMID>' || r.收费细目id || '</SFXMID>'; --收费项目目录.id
        v_Xtmp := v_Xtmp || '<SFXMMC>' || r.收费名称 || '</SFXMMC>'; --收费项目目录.名称
        v_Xtmp := v_Xtmp || '<SFXMGG>' || r.规格 || '</SFXMGG>'; --收费项目目录.规格
        v_Xtmp := v_Xtmp || '<BM>' || v_收费商品名 || '</BM>'; --收费项目别名.名称（商品名）
        v_Xtmp := v_Xtmp || '<ZL>' || r.总给予量 || '</ZL>'; --病人医嘱记录.总给予量
        v_Xtmp := v_Xtmp || '<DL>' || r.单次用量 || '</DL>'; --病人医嘱记录.单次用量
        v_Xtmp := v_Xtmp || '<DW>' || r.收费单位 || '</DW>'; --收费项目目录.计算单位
        v_Xtmp := v_Xtmp || '<ZLDW>' || r.诊疗单位 || '</ZLDW>'; --诊疗项目目录.计算单位
        v_Xtmp := v_Xtmp || '<ZXXZ>' || r.执行性质 || '</ZXXZ>'; --病人医嘱记录.执行性质
        v_Xtmp := v_Xtmp || '<ZXKS>' || r.执行科室 || '</ZXKS>'; --诊疗项目目录.执行科室
        v_Xtmp := v_Xtmp || '<XDBH></XDBH>'; --血液收发记录.血袋编号
        v_Xtmp := v_Xtmp || '<SXXH></SXXH>'; --血液收发记录.序号
        v_Xtmp := v_Xtmp || '<BBBW>' || r.标本部位 || '</BBBW>'; --诊疗项目目录.标本部位   煎法行 标本部位存的煎量
        v_Xtmp := v_Xtmp || '</ITEM>';
        Select Appendchildxml(x_Item, '/ITEMLIST', Xmltype(v_Xtmp)) Into x_Item From Dual;
      End If;
    End Loop;
    If x_Item Is Not Null Then
      Select Appendchildxml(x_医嘱, '/YZ', x_Item) Into x_医嘱 From Dual;
    End If;
    Select Appendchildxml(x_Templet, '/OUTPUT/YZLIST', x_医嘱) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getadvicelist;
/



Create Or Replace Procedure Zl_Third_Revokeoutadvice
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:作废医嘱
  --入参:Xml_In:
  --  <IN>
  --  <YZID></YZID>医嘱ID --主医嘱ID
  --  <CZYXM></CZYXM> 操作员姓名
  --  <CZYBH></CZYBH> 操作员编号
  --  <CLLIS></CLLIS>处理LIS申请 0-不处理，1-要处理
  --  <JYXM></JYXM> 检验项目，是否是检验项目，0-不是检验，1-是检验
  --  <TYPE</TYPE> 等于0或者NULL 默认是门诊医嘱作废 |等于1为住院临嘱作废
  --   <QMGZ></QMGZ>          --签名规则 固定传1
  --   <QMXX></QMXX>          --签名信息
  --   <ZSID></ZSID>          --证书id
  --   <SJC></SJC>            --时间戳  日期类型格式：2017-12-21 16:14:12
  --   <SJCXX></SJCXX>        --时间戳信息 

  --  </IN>
  --出参:Xml_Out
  --  <OUTPUT>
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Tmp      Varchar2(2000);
  n_医嘱状态 Number;
  n_签名id   Number;
  x_T1       Xmltype;
  x_T2       Xmltype;
  v_Error    Varchar(255);
  Err_Custom Exception;
Begin

  --参数名：病人接诊控制，模块：1260，忽略
  For R In (Select Extractvalue(Value(A), 'IN/YZID') As 医嘱id, Extractvalue(Value(A), 'IN/CZYXM') As 操作员姓名,
                   Extractvalue(Value(A), 'IN/CZYBH') As 操作员编号, Extractvalue(Value(A), 'IN/CLLIS') As 处理lis,
                   Extractvalue(Value(A), 'IN/JYXM') As 检验项目, Extractvalue(Value(A), 'IN/TYPE') As Usetype,
                   To_Number(Extractvalue(Value(A), 'IN/QMGZ')) As 签名规则, Extractvalue(Value(A), 'IN/QMXX') As 签名信息,
                   To_Number(Extractvalue(Value(A), 'IN/ZSID')) As 证书id,
                   To_Date(Extractvalue(Value(A), 'IN/SJC'), 'yyyy-MM-dd HH24:MI:SS') As 时间戳,
                   Extractvalue(Value(A), 'IN/SJCXX') As 时间戳信息
            From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A) Loop
  
    Select Max(医嘱状态) Into n_医嘱状态 From 病人医嘱记录 Where ID = r.医嘱id;
  
    If n_医嘱状态 = 1 Or n_医嘱状态 = 2 Then
      Zl_病人医嘱记录_Delete(r.医嘱id, 1);
    Else
      --住院临嘱回退
      If To_Number(Nvl(r.Usetype, 0)) = 1 Then
        If n_医嘱状态 = 8 Then
          Zl_病人医嘱记录_回退(r.医嘱id, '0', Null, Null, r.操作员编号, r.操作员姓名);
        End If;
      End If;
    
      Zl_病人医嘱记录_作废(r.医嘱id, r.操作员编号, r.操作员姓名);
    
      --医嘱签名处理
      If r.签名信息 Is Not Null Then
        Select 医嘱签名记录_Id.Nextval Into n_签名id From Dual;
        Zl_医嘱签名记录_Insert(n_签名id, 4, r.签名规则, r.签名信息, r.证书id, r.医嘱id, r.时间戳, r.操作员姓名, r.时间戳信息);
      End If;
    
      Zl_病人诊断医嘱_Delete(r.医嘱id);
      If r.检验项目 = 1 And r.处理lis = 1 Then
        --调用LIS处理接口，要用动态SQL
        Begin
          x_T1 := Xmltype('<IN><TYPE>1</TYPE><ADVICE><SQID>' || r.医嘱id || '</SQID></ADVICE></IN>');
          Execute Immediate 'Begin Zl_Thrid_Sendlisapplication(:1,:2); End;'
            Using In x_T1, Out x_T2;
          If x_T2 Is Not Null Then
            Select Extractvalue(Value(A), 'OUTPUT/ERROR/MSG')
            Into v_Error
            From Table(Xmlsequence(Extract(x_T2, 'OUTPUT'))) A;
            If v_Error Is Not Null Then
              Raise Err_Custom;
            End If;
          End If;
        Exception
          When Others Then
            v_Error := '调用LIS检验撤消接口出错。';
            Raise Err_Custom;
        End;
      End If;
    End If;
  End Loop;
  Xml_Out := Xmltype('<OUTPUT><ERROR><MSG></MSG></ERROR></OUTPUT>');
Exception
  When Err_Custom Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Revokeoutadvice;
/


CREATE OR REPLACE Procedure Zl_Third_Getapplist
( 
  Xml_In  In Xmltype, 
  Xml_Out Out Xmltype 
) Is 
  -------------------------------------------------------------------------------------------------- 
  --功能:获取病人已经申请的检查检验项目 
  --入参:Xml_In: 
  --  <IN> 
  --   <GHDH></GHDH>挂号单号 
  --  </IN> 
  --出参:Xml_Out 
  --  <OUTPUT> 
  --     <ITEM> 
  --       <ID></ID>医嘱ID，主医嘱ID 
  --       <XMMC></XMMC>项目名称 
  --       <JG></JG> 结果 
  --       <ZT></ZT>状态 
  --     </ITEM> 
  --  </OUTPUT> 
  -------------------------------------------------------------------------------------------------- 
  v_Tmp   Varchar2(2000); 
  v_No    Varchar2(20); 
  v_Error Varchar(255); 
  Err_Custom Exception; 
Begin 
  Xml_Out := Xmltype('<OUTPUT></OUTPUT>'); 
  Select Extractvalue(Value(A), 'IN/GHDH') Into v_No From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A; 
  For R In (Select a.Id, a.医嘱内容 As 名称, Null As 结果, Decode(b.执行状态, 1, '完全执行', 2, '拒绝执行', 3, '正在执行', '已申请') As 状态 
            From 病人医嘱记录 A, 病人医嘱发送 B, 诊疗项目目录 C 
            Where a.Id = b.医嘱id And a.诊疗项目id = c.Id And a.医嘱状态 = 8 And 
                  (a.诊疗类别 = 'D' And a.相关id Is Null Or a.诊疗类别 = 'E' And c.操作类型 = '6') And a.挂号单 = v_No 
            Order By a.序号) Loop 
    v_Tmp := '<ITEM>'; 
    v_Tmp := v_Tmp || '<ID>' || r.Id || '</ID>'; 
    v_Tmp := v_Tmp || '<XMMC>' || r.名称 || '</XMMC>'; 
    v_Tmp := v_Tmp || '<JG>' || r.结果 || '</JG>'; 
    v_Tmp := v_Tmp || '<ZT>' || r.状态 || '</ZT>'; 
    v_Tmp := v_Tmp || '</ITEM>'; 
    Select Appendchildxml(Xml_Out, '/OUTPUT', Xmltype(v_Tmp)) Into Xml_Out From Dual; 
  End Loop; 
Exception 
  When Err_Custom Then 
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>'; 
    Xml_Out := Xmltype(v_Tmp); 
  When Others Then 
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>'; 
    Xml_Out := Xmltype(v_Tmp); 
	zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getapplist;
/
----------------------------------------------------------------------------
--[[7.临床路径基础]]
----------------------------------------------------------------------------

----------------------------------------------------------------------------
--[[8.病历基础]]
----------------------------------------------------------------------------

----------------------------------------------------------------------------
--[[9.护理基础]]
----------------------------------------------------------------------------
Create Or Replace Procedure Zl_Third_Tendfile_Itemsave
(
  Xmlfilelist_In  Xmltype,
  Xmlfilelist_Out Out Xmltype
) Is
  n_Fileid       Number(18);
  n_格式id       Number(18);
  n_Xh           Number(5);
  n_Brid         Number(18);
  n_Zyid         Number(5);
  n_Babby        Number(1);
  v_Czy          Varchar2(20);
  n_Newadd       Number(1);
  n_Kind         Number(1);
  n_Num          Number(1);
  Intins         Number(1);
  n_归档         Number(1);
  v_科室id       Number(18);
  v_Name         Varchar2(20);
  d_婴儿出院时间 Date;
  v_Error        Varchar2(255);
  v_Temp         Varchar2(32767);
  x_Templet      Xmltype; --模板XML
  Err_Custom Exception;
Begin

  Select To_Number(Extractvalue(Value(A), 'IN/BRID'))
  Into n_Brid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/ZYID'))
  Into n_Zyid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/YEXH'))
  Into n_Babby
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Char(Extractvalue(Value(A), 'IN/CZY')) Into v_Czy From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Begin
    Select Max(1)
    Into n_归档
    From 病人护理文件
    Where 病人id = n_Brid And 主页id = n_Zyid And 婴儿 = n_Babby And 归档时间 Is Null;
  End;

  For r_Input In (Select To_Char(To_Date(发生时间, 'yyyy-mm-dd hh24:mi:ss'), 'yyyy-mm-dd hh24:mi') 发生时间, Lx, Ly, Mc, Nr, Bw,
                         Wj
                  From Xmltable('$a/IN/ITEMLIST/ITEM' Passing Xmlfilelist_In As "a" Columns 发生时间 Varchar2(20) Path
                                 'TIME', Lx Number(1) Path 'LX', Ly Number(2) Path 'LY', Mc Varchar2(20) Path 'MC',
                                 Nr Varchar2(20) Path 'NR', Bw Varchar2(10) Path 'BW', Wj Varchar2(4000) Path 'Wj') B) Loop
    If r_Input.Mc Is Null Then
      v_Error := '未录入数据，不允许操作，请检查！';
      Raise Err_Custom;
    Else
      Select Max(项目序号) Into n_Xh From 护理记录项目 Where 项目名称 = r_Input.Mc;
    End If;
  
    If n_Babby <> 0 Then
      Begin
        Select 开始执行时间
        Into d_婴儿出院时间
        From 病人医嘱记录 B, 诊疗项目目录 C
        Where b.诊疗项目id + 0 = c.Id And b.医嘱状态 = 8 And Nvl(b.婴儿, 0) <> 0 And c.类别 = 'Z' And
              Instr(',3,5,11,', ',' || c.操作类型 || ',', 1) > 0 And b.病人id = n_Brid And b.主页id = n_Zyid And b.婴儿 = n_Babby;
      Exception
        When Others Then
          d_婴儿出院时间 := Null;
      End;
    End If;
  
    If d_婴儿出院时间 Is Null Then
      v_科室id := 0;
      Begin
        Select a.科室id
        Into v_科室id
        From 病人变动记录 A
        Where a.科室id Is Not Null And a.病人id = n_Brid And a.主页id = n_Zyid And
              (To_Date(To_Char(To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss'), 'YYYY-MM-DD HH24:MI') || '59',
                       'YYYY-MM-DD HH24:MI:SS') >= a.开始时间 And
              (To_Date(To_Char(To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss'), 'YYYY-MM-DD HH24:MI') || '00',
                        'YYYY-MM-DD HH24:MI:SS') <= Nvl(a.终止时间, Sysdate) Or a.终止时间 Is Null)) And Rownum < 2;
      Exception
        When Others Then
          v_科室id := 0;
      End;
      If v_科室id = 0 Then
        v_Error := '数据发生时间 ' || To_Date(r_Input.发生时间, 'YYYY-MM-DD HH24:MI:SS') || ' 不在病人有效变动时间范围内，不允许操作！';
        Raise Err_Custom;
      End If;
    End If;
  
    Select Max(a.Id)
    Into n_Fileid
    From 病人护理文件 A, 病历文件结构 B, 病历文件列表 C
    Where a.格式id = c.Id And 保留 = 0 And 病人id = n_Brid And 主页id = n_Zyid And 婴儿 = n_Babby And a.格式id = b.文件id And
          要素名称 = r_Input.Mc And b.文件id = c.Id And a.开始时间 <= To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss') And
          (结束时间 >= To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss') Or 结束时间 Is Null)
    Order By a.开始时间;
  
    If n_Fileid Is Null Then
      Select Max(a.Id), Max(c.子类), Max(c.Id)
      Into n_Fileid, n_Kind, n_格式id
      From 病人护理文件 A, 病历文件列表 C
      Where a.格式id = c.Id And 保留 = -1 And 病人id = n_Brid And 主页id = n_Zyid And 婴儿 = n_Babby And
            a.开始时间 < To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss') And
            (结束时间 > To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss') Or 结束时间 Is Null)
      Order By a.开始时间;
      If n_Fileid <> 0 Then
        v_Name := r_Input.Mc;
        If n_Kind = '1' Then
          If n_Xh = 4 Or n_Xh = 5 Then
            Select Max(内容文本)
            Into n_Num
            From 病人护理文件 A, 病历文件结构 B
            Where a.格式id = b.文件id And a.Id = n_Fileid And 要素名称 = '婴儿体温单';
            If Not (n_Num = 1) Then
              v_Name := '血压';
            End If;
          End If;
          Begin
            Select 1
            Into Intins
            From (Select To_Char(f.记录名) As 项目名称, g.项目性质
                   From 体温记录项目 F, 护理记录项目 G
                   Where f.项目序号 = g.项目序号 And g.项目性质 = 2 And
                         (g.适用科室 = 1 Or
                         (g.适用科室 = 2 And Exists
                          (Select 1 From 护理适用科室 D Where g.项目序号 = d.项目序号 And d.科室id = v_科室id))) And Nvl(g.应用方式, 0) <> 0 And
                         (Nvl(g.适用病人, 0) = 0 Or Nvl(g.适用病人, 0) = Decode(n_Babby, 0, 1, 2))
                   Union All
                   Select b.要素名称 As 项目名称, 1 As 项目性质
                   From 病历文件结构 A, 病历文件结构 B
                   Where a.文件id = n_格式id And a.父id Is Null And a.对象序号 In (2, 3) And b.父id = a.Id) H
            Where Instr(',' || h.项目名称 || ',', ',' || v_Name || ',', 1) > 0;
          
          Exception
            When Others Then
              Intins := 0;
          End;
        Else
          Begin
            Select 1
            Into Intins
            From 体温记录项目 F, 护理记录项目 G
            Where f.项目序号 = g.项目序号 And Nvl(g.应用方式, 0) <> 0 And g.护理等级 >= 0 And
                  (Nvl(g.适用病人, 0) = 0 Or Nvl(g.适用病人, 0) = Decode(n_Babby, 0, 1, 2)) And f.项目序号 = n_Xh And
                  (g.适用科室 = 1 Or (g.适用科室 = 2 And Exists
                   (Select 1 From 护理适用科室 D Where g.项目序号 = d.项目序号 And d.科室id = v_科室id)));
          Exception
            When Others Then
              Intins := 0;
          End;
        End If;
      
        If Intins = 1 Then
          n_Newadd := 0;
          Select Max(1)
          Into n_Newadd
          From 病人护理数据
          Where 发生时间 = To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss') And 文件id = n_Fileid And 保存人 <> v_Czy;
          If n_Newadd = 1 Then
            v_Error := '当前时间节点已存在护理记录！';
            Raise Err_Custom;
          End If;
          Zl_体温单数据_Update(n_Fileid, To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss'), 1, n_Xh, r_Input.Nr, r_Input.Bw, 0,
                          Null, 1, r_Input.Ly, Null, 0, 0, Null, Null, v_Czy);
        End If;
      End If;
    Else
      Select Max(1)
      Into n_Newadd
      From 病人护理数据
      Where 发生时间 = To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss') And 文件id = n_Fileid;
    
      If n_Newadd = 1 Then
        n_Newadd := 0;
        Select Max(1)
        Into n_Newadd
        From 病人护理数据
        Where 发生时间 = To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss') And 文件id = n_Fileid And 保存人 <> v_Czy;
        If n_Newadd = 1 Then
          v_Error := '当前时间节点已存在护理记录！';
          Raise Err_Custom;
        End If;
        Zl_病人护理数据_Update(n_Fileid, To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss'), 1, n_Xh, r_Input.Nr, r_Input.Bw, 1,
                         r_Input.Ly, 0, v_Czy, Null, Null, Null);
      Else
        Select Max(1)
        Into n_Num
        From 病人护理数据
        Where 发生时间 = To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss') And 签名人 Is Not Null And 文件id = n_Fileid;
        If n_Num = 1 Then
          v_Error := '当前病人的护理文件已签名，不允许修改，请先回退签名！';
          Raise Err_Custom;
        Else
          Zl_病人护理数据_Update(n_Fileid, To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss'), 1, n_Xh, r_Input.Nr, r_Input.Bw, 1,
                           r_Input.Ly, 0, v_Czy, Null, Null, Null);
          Zl_病人护理打印_Update(n_Fileid, To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss'), 1);
        End If;
      End If;
    End If;
  End Loop;
  v_Temp := '<RESULT>True</RESULT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xmlfilelist_Out := x_Templet;

Exception
  When Err_Custom Then
    v_Temp := '<RESULT>False</RESULT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<ERROR><MSG>' || v_Error || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xmlfilelist_Out := x_Templet;
  
  When Others Then
    v_Temp := '<RESULT>False</RESULT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xmlfilelist_Out := x_Templet;
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Tendfile_Itemsave;
/
Create Or Replace Procedure Zl_Third_Tendfile_Getdatasign
(
  Xmlfilelist_In  Xmltype,
  Xmlfilelist_Out Out Xmltype
) Is
  n_Brid  Number(18);
  n_Zyid  Number(5);
  n_Babby Number(1);
  v_Time  Varchar2(20);
  n_Count Number(1);

  v_Temp Varchar2(32767);
Begin
  Select To_Number(Extractvalue(Value(a), 'IN/BRID')), To_Number(Extractvalue(Value(a), 'IN/ZYID')),
         To_Number(Extractvalue(Value(a), 'IN/YEXH')),
         To_Char(To_Date(Extractvalue(Value(a), 'IN/TIME'), 'yyyy-mm-dd hh24:mi:ss'), 'yyyy-mm-dd hh24:mi')
  Into n_Brid, n_Zyid, n_Babby, v_Time
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) a;

  Select Count(1)
  Into n_Count
  From 病人护理数据 b, 病人护理文件 a
  Where b.发生时间 Between To_Date(v_Time, 'yyyy-mm-dd hh24:mi:ss') And
        To_Date(To_Char(To_Date(v_Time, 'yyyy-mm-dd hh24:mi:ss'), 'YYYY-MM-DD HH24:MI') || '59',
                'YYYY-MM-DD HH24:MI:SS') And b.签名人 Is Not Null And b.文件id = a.Id And
        a.开始时间 <= To_Date(v_Time, 'yyyy-mm-dd hh24:mi:ss') And
        (结束时间 >= To_Date(v_Time, 'yyyy-mm-dd hh24:mi:ss') Or 结束时间 Is Null) And a.病人id = n_Brid And a.主页id = n_Zyid And
        a.婴儿 = n_Babby And Rownum < 2;

  v_Temp          := '<OUTPUT><ZT>' || n_Count || '</ZT></OUTPUT>';
  Xmlfilelist_Out := Xmltype(v_Temp);
Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_Third_Tendfile_Getdatasign;
/
CREATE OR REPLACE Procedure Zl_Third_Tendfile_Gettemphdata
(
  Xmlfilelist_In  Xmltype,
  Xmlfilelist_Out Out Xmltype
) Is
  ---------------------------------------------------------------------------------------------------------------------------
  --功能:获取某病人指定范围内的体温单历史数据
  --入参:Xml_In
  --<IN>
  --<BQ></BQ>       --病区ID
  --<PATIID></PATIID>     --病人ID
  --<PAGEID></PAGEID>     --主页ID
  --<BABY></BABY>      --婴儿
  --<FILE></FILE>      --查询数据文件id
  -- <FW></FW>   --范围：当天、三天、 一周
  --</IN>
  -- 出参:Xml_Out
  --<OUTPUT>
  -- <GROUPS>
  --  <GROUP>
  --   <SJ></SJ>   --发生时间
  --   <CZY></CZY>  --操作员
  --   <ITEMS>
  --    <ITEM>
  --     <XH></XH>   --序号
  --     <MC></MC>   --名称
  --     <NR></NR>   --内容
  --     <WJ />     --未记说明
  --     <BW />     --部位
  --    </ITEM>
  --   </ITEMS>
  --  </GROUP>
  -- </GROUPS>
  --</OUTPUT>
  ----------------------------------------------------------------------------------------------------------------------------
  n_Fileid   Number(18);
  n_Fw       Number(18);
  n_Count    Number(18);
  d_开始时间 Date;
  d_结束时间 Date;
  v_Temp     Varchar2(32767);
  x_Templet  Xmltype; --模板XML
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/FILE'))
  Into n_Fileid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/FW')) Into n_Fw From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;
  d_结束时间 := Sysdate;
  d_开始时间 := d_结束时间 - n_Fw;

  x_Templet := Xmltype('<OUTPUT><GROUPS></GROUPS></OUTPUT>');
  For r_Twd In (Select ID, To_Char(发生时间, 'yyyy-mm-dd hh24:mi:ss') 发生时间, 保存人
                From 病人护理数据
                Where 文件id = n_Fileid And 发生时间 Between d_开始时间 And d_结束时间
                Order By 发生时间 Desc) Loop
    v_Temp := '<GROUP jsonArray="True"><SJ>' || r_Twd.发生时间 || '</SJ><CZY>' || r_Twd.保存人 ||
              '</CZY><ITEMS></ITEMS></GROUP>';
    Select Appendchildxml(x_Templet, '/OUTPUT/GROUPS', Xmltype(v_Temp)) Into x_Templet From Dual;
    For r_Nr In (Select 项目序号, 项目名称, 记录内容, 未记说明, 体温部位 From 病人护理明细 Where 记录id = r_Twd.Id) Loop
      v_Temp := '<ITEM jsonArray="True"><XH>' || r_Nr.项目序号 || '</XH><MC>' || r_Nr.项目名称 || '</MC><NR>' || r_Nr.记录内容 ||
                '</NR><WJ>' || r_Nr.未记说明 || '</WJ><BW>' || r_Nr.体温部位 || '</BW></ITEM>';
      Select Length(x_Templet) - Length(Replace(x_Templet, '<ITEMS', 'ITEMS')) into n_Count From Dual;
      Select Appendchildxml(x_Templet, '/OUTPUT/GROUPS/GROUP['||n_Count ||']/ITEMS', Xmltype(v_Temp)) Into x_Templet From Dual;
    
    End Loop;
  End Loop;

  Xmlfilelist_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Tendfile_Gettemphdata;
/

Create Or Replace Procedure Zl_Third_Tendfile_Getmitems
(
  Xmlfilelist_In  Xmltype,
  Xmlfilelist_Out Out Xmltype
) Is
  ---------------------------------------------------------------------------------------------------------------------------
  --功能:获取体温单/护理记录单中的可用活动项目
  --入参:Xml_In
  --无
  -- 出参:Xml_Out
  --<OUTPUT>
  -- <ITEMLIST>
  --  <ITEM>
  --    <XH/>      --序号
  --    <MC/>      --名称
  --    <LX/>      --项目类型
  --    <BS/>      --项目表示
  --    <CD/>      --项目长度
  --    <XS/>      --项目小数
  --    <DW/>     --项目单位
  --    <ZY/>      --项目值域
  --    <SYBR/>      --适用病人
  --    <YYFS/>      --应用方式
  --    <BW/>       --活动项目部位
  --  <ITEM/>
  -- </ITEMLIST>
  --</OUTPUT>
  ----------------------------------------------------------------------------------------------------------------------------
  v_Temp    Varchar2(32767);
  v_Bw      Varchar2(100);
  x_Templet Xmltype; --模板XML
Begin

  x_Templet := Xmltype('<OUTPUT><ITEMLIST></ITEMLIST></OUTPUT>');

  For r_Hdxm In (Select a.项目序号, a.项目名称, a.项目类型, a.项目表示, a.项目长度, a.项目小数, a.项目单位, a.项目值域, a.适用病人, a.应用方式
                 From 护理记录项目 A
                 Where a.项目性质 = 2 And Nvl(a.应用场合, 0) <> 1) Loop
    Select f_List2str(Cast(Collect(部位) As t_Strlist)) Into v_Bw From 体温部位 Where 项目序号 = r_Hdxm.项目序号;
  
    v_Temp := '<ITEM jsonArray="True"><XH>' || r_Hdxm.项目序号 || '</XH><MC>' || r_Hdxm.项目名称 || '</MC><LX>' || r_Hdxm.项目类型 ||
              '</LX><BS>' || r_Hdxm.项目表示 || '</BS><CD>' || r_Hdxm.项目长度 || '</CD><XS>' || r_Hdxm.项目小数 || '</XS><DW>' ||
              r_Hdxm.项目单位 || '</DW><ZY>' || r_Hdxm.项目值域 || '</ZY><SYBR>' || r_Hdxm.适用病人 || '</SYBR><YYFS>' ||
              r_Hdxm.项目表示 || '</YYFS><BW>' || v_Bw || '</BW></ITEM>';
    Select Appendchildxml(x_Templet, '/OUTPUT/ITEMLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xmlfilelist_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Tendfile_Getmitems;
/
Create Or Replace Procedure Zl_Third_Tendfile_BindMItems
(
  Xmlfilelist_In  Xmltype,
  Xmlfilelist_Out Out Xmltype
) Is
  ---------------------------------------------------------------------------------------------------------------------------
  --功能:绑定活动项目
  --入参:Xml_In
  --<IN>
  -- <FILE></ FILE >      --护理文件ID
  -- <YH></YH>            --页号
  -- <LH></LH>            --列号
  -- <MC></MC>            --名称
  -- <XH></XH >           --序号
  -- <CZY></CZY>          --操作员
  --</IN>
  --出参:Xml_Out
  --成功：
  --<OUTPUT>
  -- <RESULT>true</RESULT>
  --</OUTPUT>
  --失败：
  --<OUTPUT>
  -- <RESULT>false</RESULT>
  -- <ERROR>
  --   <MSG>详细错误提示</MSG>
  -- </ERROR>
  --</OUTPUT>
  ----------------------------------------------------------------------------------------------------------------------------
  n_Fileid  Number(18);
  n_Yh      Number(18);
  n_Lh      Number(18);
  n_Xh      Number(18);
  v_Mc      Varchar2(4000);
  v_Czy     Varchar2(20);
  v_Temp    Varchar2(32767);
  x_Templet Xmltype; --模板XML
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/FILE'))
  Into n_Fileid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/YH'))
  Into n_Yh
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Char(Extractvalue(Value(A), 'IN/LH'))
  Into n_Lh
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Char(Extractvalue(Value(A), 'IN/XH'))
  Into n_Xh
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Char(Extractvalue(Value(A), 'IN/MC'))
  Into v_Mc
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Char(Extractvalue(Value(A), 'IN/CZY'))
  Into v_Czy
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Zl_病人护理页面_Update(n_Fileid, n_Yh, n_Lh, v_Mc||'|'||n_Xh, v_Czy);
  v_Temp := '<RESULT>Ture</RESULT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xmlfilelist_Out := x_Templet;
Exception
  When Others Then
    v_Temp := '<RESULT>False</RESULT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xmlfilelist_Out := x_Templet;
End Zl_Third_Tendfile_BindMItems;
/
Create Or Replace Procedure Zl_Third_Tendfile_Getdetail
(
  Xmlfilelist_In  Xmltype,
  Xmlfilelist_Out Out Xmltype
) Is
  ---------------------------------------------------------------------------------------------------------------------------
  --功能:获取指定的护理记录单中，某一个护理项目最近若干次的记录内容，按时间由近到远排序
  --入参:Xml_In
  --<IN>
  -- <FILE></FILE>       --文件id
  -- <XH></XH>   --项目序号
  -- <FW></FW>   --范围数值，传3，表示最近3次
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  -- <LISTS>
  --  <ITEM>
  --   <TIME></TIME>   --发生时间
  --   <DATA></DATA>   --内容
  --  </ITEM>
  -- </LISTS>
  --</OUTPUT>
  ----------------------------------------------------------------------------------------------------------------------------
  n_Fileid  Number(18);
  n_Xh      Number(18);
  n_Fw      Number(18);
  v_Temp    Varchar2(32767);
  x_Templet Xmltype; --模板XML
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/FILE'))
  Into n_Fileid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;
  Select To_Number(Extractvalue(Value(A), 'IN/XH')) Into n_Xh From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;
  Select To_Number(Extractvalue(Value(A), 'IN/FW')) Into n_Fw From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT><LISTS></LISTS></OUTPUT>');
  For r_Hljl In (Select To_Char(时间, 'YYYY-MM-DD hh24:mi:ss') 时间, 内容
                 From (Select b.发生时间 时间, Decode(c.记录内容, Null, c.未记说明, c.记录内容) 内容,
                               Row_Number() Over(Partition By b.文件id Order By b.发生时间 Desc) As Top
                        From 病人护理数据 B, 病人护理明细 C
                        Where b.Id = c.记录id And 项目序号 = n_Xh And 文件id = n_Fileid And 记录类型 = 1)
                 Where Top <= n_Fw) Loop
    v_Temp := '<ITEM jsonArray="True"><TIME>' || r_Hljl.时间 || '</TIME><DATA>' || r_Hljl.内容 || '</DATA></ITEM>';
    Select Appendchildxml(x_Templet, '/OUTPUT/LISTS', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  Xmlfilelist_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Tendfile_Getdetail;
/
CREATE OR REPLACE Procedure Zl_Third_Tendfile_Save
(
  Xmlfilelist_In  Xmltype,
  Xmlfilelist_Out Out Xmltype
) Is
  ---------------------------------------------------------------------------------------------------------------------------
  --功能:体温单/护理记录单填写的数据保存
  --入参:Xml_In
  --<IN>
  -- <FILELIST>
  --  <FILEINFO>
  --   <CZY></CZY>     --操作员
  --   <ZDQM></ZDQM>   --自动签名 1表示转抄记录单时自动签名;0或空表示仅转抄不签名
  --   <CZSJ></CZSJ>   --操作时间
  --   <FILE></FILE>   --文件ID
  --   <LX/>           --0-新增;1-修改或删除
  --   <FZ></FZ>       --分组标志，未分组传0
  --   <LY></LY>       --来源，3，表示移动端？
  --   <ITEMLIST>
  --    <ITEM>
  --     <TIME></TIME>   --发生时间
  --     <XH></XH>       --项目序号
  --     <MC></MC>       --项目名称
  --     <NR></NR>       --项目内容
  --     <BW></BW>       --部位，如果有就传
  --     <WJ></WJ>       --未记说明，如果有就传
  --     <JLLX></JLLX>   --记录类型
  --    </ITEM>
  --   </ITEMLIST>
  --  </FILEINFO>
  -- </FILELIST>
  --</IN>
  --出参:Xml_Out
  --成功：
  --<OUTPUT>
  -- <RESULT>true</RESULT>
  --</OUTPUT>
  --失败：
  --<OUTPUT>
  -- <RESULT>false</RESULT>
  -- <ERROR>
  --   <MSG>详细错误提示</MSG>
  -- </ERROR>
  --</OUTPUT>
  ----------------------------------------------------------------------------------------------------------------------------
  n_Fileid  Number(18);
  v_Czy     Varchar2(20);
  n_Zdqm    Number(1);
  d_Czsj    Date;
  n_Newadd  Number(1);
  n_Fz      Number(1);
  n_Ly      Number(2);
  n_Kind    Number(1);
  v_Ctime   Varchar2(20);
  n_Exist   Number(1);
  v_Temp    Varchar2(32767);
  x_Templet Xmltype; --模板XML
Begin
  n_Exist := 0;
  v_Ctime := '';

  Select To_Number(Extractvalue(Value(A), 'IN/FILELIST/FILEINFO/FILE'))
  Into n_Fileid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Char(Extractvalue(Value(A), 'IN/FILELIST/FILEINFO/CZY'))
  Into v_Czy
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/FILELIST/FILEINFO/ZDQM'))
  Into n_Zdqm
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Date(Extractvalue(Value(A), 'IN/FILELIST/FILEINFO/CZSJ'), 'yyyy-MM-dd hh24:mi:ss')
  Into d_Czsj
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/FILELIST/FILEINFO/LX'))
  Into n_Newadd
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/FILELIST/FILEINFO/FZ'))
  Into n_Fz
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/FILELIST/FILEINFO/LY'))
  Into n_Ly
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  For r_Input In (Select 发生时间, Xh, Mc, Nr, Bw, Wj, Jllx
                  From Xmltable('$a/IN/FILELIST/FILEINFO/ITEMLIST/ITEM' Passing Xmlfilelist_In As "a" Columns 发生时间
                                 Varchar2(20) Path 'TIME', Xh Number(18) Path 'XH', Mc Varchar2(20) Path 'MC',
                                 Nr Varchar2(20) Path 'NR', Bw Varchar2(10) Path 'BW', Wj Varchar2(4000) Path 'Wj',
                                 Jllx Varchar2(4000) Path 'JLLX') B) Loop
    x_Templet := Xmltype('<OUTPUT></OUTPUT>');
    Select Max(保留) Into n_Kind From 病历文件列表 A, 病人护理文件 B Where a.Id = b.格式id And b.Id = n_Fileid;
    If n_Newadd = 0 Then
      Select Max(1)
      Into n_Exist
      From 病人护理文件 A, 病人护理数据 B, 病人护理明细 C
      Where a.Id = b.文件id And b.Id = c.记录id And a.Id = n_Fileid And
            b.发生时间 = To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss') And c.项目序号 = r_Input.Xh;
    End If;
    If n_Newadd = 0 And n_Exist = 1 Then
      v_Temp := '<RESULT>False</RESULT>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      v_Temp := '<ERROR><MSG>您录入的时点已经存在历史数据！</MSG></ERROR>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      Xmlfilelist_Out := x_Templet;
    Else
      If n_Kind = 0 Then
        Zl_病人护理数据_Update(n_Fileid, To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss'), r_Input.Jllx, r_Input.Xh, r_Input.Nr,
                         r_Input.Bw, 1, n_Ly, 0, v_Czy, n_Fz, Null, r_Input.Wj);
        Zl_病人护理打印_Update(n_Fileid, To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss'), 1);
        If v_Ctime <> r_Input.发生时间 And n_Zdqm = 1 And v_Ctime Is Not Null Then
          Zl_病人护理数据_Signname(n_Fileid, To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss'), 0, v_Czy, '', 4, 0, 1);
        End If;
        v_Ctime := r_Input.发生时间;
      Else
        Zl_体温单数据_Update(n_Fileid, To_Date(r_Input.发生时间, 'yyyy-mm-dd hh24:mi:ss'), r_Input.Jllx, r_Input.Xh, r_Input.Nr,
                        r_Input.Bw, 0, r_Input.Wj, 1, n_Ly);

      End If;
      v_Temp := '<RESULT>True</RESULT>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      Xmlfilelist_Out := x_Templet;
    End If;
  End Loop;
  If n_Zdqm = 1 Then
    Zl_病人护理数据_Signname(n_Fileid, To_Date(v_Ctime, 'yyyy-mm-dd hh24:mi:ss'), 0, v_Czy, '', 4, 0, 1);
  End If;
Exception
  When Others Then
    v_Temp := '<RESULT>False</RESULT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xmlfilelist_Out := x_Templet;
End Zl_Third_Tendfile_Save;
/

Create Or Replace Procedure Zl_Third_Tendfile_Getitems
(
  Xmlfilelist_In  Xmltype,
  Xmlfilelist_Out Out Xmltype
) Is
  ---------------------------------------------------------------------------------------------------------------------------
  --功能:获取可填写的护理项目（含活动项目及空项目）
  --入参:Xml_In
  --<IN>
  -- <BQ></BQ>       --病区ID
  -- <PATIID></PATIID>     --病人ID
  -- <PAGEID></PAGEID>     --主页ID
  -- <BABY></BABY>      --婴儿
  -- <FILE></FILE>   --传空表示获取在用体温单项目，否则获取id对应的护理记录单项目
  --</IN>
  --出参:Xml_Out
  --<OUTPUT />
  -- <YH></YH>      --页号，用于绑定活动项目
  -- <FILE></FILE>   --文件id
  -- <ITEMLIST>
  --  <ITEM>
  --   <LH></LH>     --列号，用于绑定活动项目
  --   <XH></XH>     --项目序号
  --   <MC></MC>     --项目名称
  --   <LX></LX>     --项目类型0数值1-文本
  --   <BS></BS>     --项目表示
  --   <CD></CD>     --项目长度
  --   <XS></XS>     --项目小数
  --   <DW</DW>      --单位
  --   <ZY></ZY>     --值域
  --   <SYBR></SYBR>    --适用病人0所有1病人本人2婴儿
  --   <YYFS></YYFS>    --应用方式0禁止使用1单独使用2与脉搏共用
  --   <BW></BW>   --部位
  --   <XMXZ></XMXZ>  --项目性质1-普通2-活动项目,表示该项目为预留的活动项目位置
  --  </ITEM>
  -- </ITEMLIST>
  --<OUTPUT/>
  ----------------------------------------------------------------------------------------------------------------------------
  n_Patiid  Number(18);
  n_Pageid  Number(18);
  n_Baby    Number(18);
  n_Areaid  Number(18);
  n_Fileid  Number(18);
  n_Format  Number(18);
  n_Yh      Number(18);
  v_Nnit    Varchar2(100);
  v_Hdlh    Varchar2(40);
  v_Temp    Varchar2(32767);
  v_Temp2   Varchar2(32767);
  x_Templet Xmltype; --模板XML
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/BQ'))
  Into n_Areaid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/PATIID'))
  Into n_Patiid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/PAGEID'))
  Into n_Pageid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/BABY'))
  Into n_Baby
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/FILE'))
  Into n_Fileid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT><ITEMLIST></ITEMLIST></OUTPUT>');
  If Nvl(n_Fileid, 0) = 0 Then
    Select a.格式id
    Into n_Format
    From 病人护理文件 A, 病历文件列表 B
    Where a.格式id = b.Id And b.种类 = 3 And b.保留 = -1 And a.病人id = n_Patiid And a.主页id = n_Pageid And a.婴儿 = n_Baby And
          a.结束时间 Is Null;
    If n_Format = 30 Then
      For r_Twd In (Select b.项目序号, b.项目名称, b.项目类型, b.项目表示, b.项目长度, b.项目小数, b.项目单位, b.项目值域, b.适用病人, b.应用方式, b.项目性质
                    From 体温记录项目 F, 护理记录项目 B
                    Where f.项目序号 = b.项目序号) Loop
        Select f_List2str(Cast(Collect(部位) As t_Strlist)) Into v_Nnit From 体温部位 Where 项目序号 = r_Twd.项目序号;
        v_Temp2 := '<ITEM jsonArray="True"><XH>' || r_Twd.项目序号 || '</XH><MC>' || r_Twd.项目名称 || '</MC><LX>' ||
                   r_Twd.项目类型 || '</LX><BS>' || r_Twd.项目表示 || '</BS><CD>' || r_Twd.项目长度 || '</CD><XS>' || r_Twd.项目小数 ||
                   '</XS><DW>' || r_Twd.项目单位 || '</DW><ZY>' || r_Twd.项目值域 || '</ZY><SYBR>' || r_Twd.适用病人 ||
                   '</SYBR><YYFS>' || r_Twd.应用方式 || '</YYFS><BW>' || v_Nnit || '</BW><XMXZ>' || r_Twd.项目性质 ||
                   '</XMXZ></ITEM>';
        Select Appendchildxml(x_Templet, '/OUTPUT/ITEMLIST', Xmltype(v_Temp2)) Into x_Templet From Dual;
      End Loop;
    Else
      For r_Twd In (Select d.对象序号 列号, b.项目序号, b.项目名称, b.项目类型, b.项目表示, b.项目长度, b.项目小数, b.项目单位, b.项目值域, b.适用病人, b.应用方式,
                           b.项目性质
                    From 病历文件结构 C, 病历文件结构 D, 护理记录项目 B
                    Where c.文件id = n_Format And c.父id Is Null And c.对象序号 In (2, 3) And d.父id = c.Id And b.项目名称 = d.要素名称) Loop
        Select f_List2str(Cast(Collect(部位) As t_Strlist)) Into v_Nnit From 体温部位 Where 项目序号 = r_Twd.项目序号;
        v_Temp2 := '<ITEM jsonArray="True"><XH>' || r_Twd.项目序号 || '</XH><MC>' || r_Twd.项目名称 || '</MC><LX>' ||
                   r_Twd.项目类型 || '</LX><BS>' || r_Twd.项目表示 || '</BS><CD>' || r_Twd.项目长度 || '</CD><XS>' || r_Twd.项目小数 ||
                   '</XS><DW>' || r_Twd.项目单位 || '</DW><ZY>' || r_Twd.项目值域 || '</ZY><SYBR>' || r_Twd.适用病人 ||
                   '</SYBR><YYFS>' || r_Twd.应用方式 || '</YYFS><BW>' || v_Nnit || '</BW><XMXZ>' || r_Twd.项目性质 ||
                   '</XMXZ></ITEM>';
        Select Appendchildxml(x_Templet, '/OUTPUT/ITEMLIST', Xmltype(v_Temp2)) Into x_Templet From Dual;
      End Loop;
    
    End If;
  Else
    Select Max(结束页号) Into n_Yh From 病人护理打印 Where 文件id = n_Fileid;
    If n_Yh Is Null Then
      n_Yh := 1;
    End If;
    v_Temp := '<YH>' || n_Yh || '</YH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := ' <FILE>' || n_Fileid || '</FILE>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    For r_Jld In (Select a.页号, a.文件id, a.列号, b.项目序号, b.项目名称, b.项目类型, b.项目表示, b.项目长度, b.项目小数, b.项目单位, b.项目值域, b.适用病人,
                         b.应用方式, b.项目性质
                  From 病人护理活动项目 A, 护理记录项目 B
                  Where b.项目序号 = a.项目序号 And b.项目序号 = a.项目序号 And a.文件id = n_Fileid And a.页号 = n_Yh) Loop
    
      v_Temp2 := '<ITEM jsonArray="True"><LH>' || r_Jld.列号 || '</LH><XH>' || r_Jld.项目序号 || '</XH><MC>' || r_Jld.项目名称 ||
                 '</MC><LX>' || r_Jld.项目类型 || '</LX><BS>' || r_Jld.项目表示 || '</BS><CD>' || r_Jld.项目长度 || '</CD><XS>' ||
                 r_Jld.项目小数 || '</XS><DW>' || r_Jld.项目单位 || '</DW><ZY>' || r_Jld.项目值域 || '</ZY><SYBR>' || r_Jld.适用病人 ||
                 '</SYBR><YYFS>' || r_Jld.应用方式 || '</YYFS><BW>' || v_Nnit || '</BW><XMXZ>' || r_Jld.项目性质 ||
                 '</XMXZ></ITEM>';
      Select Appendchildxml(x_Templet, '/OUTPUT/ITEMLIST', Xmltype(v_Temp2)) Into x_Templet From Dual;
      v_Hdlh := v_Hdlh || ',' || r_Jld.列号;
    End Loop;
  
    --记录单已绑定的项目
    For r_Jldb In (Select d.对象序号 列号, b.项目序号, d.要素名称  项目名称, b.项目类型, b.项目表示, b.项目长度, b.项目小数, b.项目单位, b.项目值域, b.适用病人, b.应用方式,
                          b.项目性质
                   From 护理记录项目 B, 病历文件结构 C, 病历文件结构 D, 病人护理文件 E
                   Where c.文件id = e.格式id And e.Id = n_Fileid And c.内容文本 = '表列集合' And d.父id = c.Id And  b.项目名称(+)=d.要素名称) Loop
      Select f_List2str(Cast(Collect(部位) As t_Strlist)) Into v_Nnit From 体温部位 Where 项目序号 = r_Jldb.项目序号;
      If Not Instr(v_Hdlh || ',', ',' || r_Jldb.列号 || ',') > 0 Then
        v_Temp2 := '<ITEM jsonArray="True"><LH>' || r_Jldb.列号 || '</LH><XH>' || r_Jldb.项目序号 || '</XH><MC>' ||
                   r_Jldb.项目名称 || '</MC><LX>' || r_Jldb.项目类型 || '</LX><BS>' || r_Jldb.项目表示 || '</BS><CD>' ||
                   r_Jldb.项目长度 || '</CD><XS>' || r_Jldb.项目小数 || '</XS><DW>' || r_Jldb.项目单位 || '</DW><ZY>' ||
                   r_Jldb.项目值域 || '</ZY><SYBR>' || r_Jldb.适用病人 || '</SYBR><YYFS>' || r_Jldb.应用方式 || '</YYFS><BW>' ||
                   v_Nnit || '</BW><XMXZ>' || r_Jldb.项目性质 || '</XMXZ></ITEM>';
        Select Appendchildxml(x_Templet, '/OUTPUT/ITEMLIST', Xmltype(v_Temp2)) Into x_Templet From Dual;
      End If;
    End Loop;
  
  End If;
  Xmlfilelist_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Tendfile_Getitems;
/
CREATE OR REPLACE Procedure Zl_Third_Tendfile_Add
(
  Xmlfilelist_In  Xmltype,
  Xmlfilelist_Out Out Xmltype
) Is
  ---------------------------------------------------------------------------------------------------------------------------
  --功能:创建护理记录单
  --入参:Xml_In
  --<IN>
  -- <BQ></BQ>        --病区ID
  -- <PATIID></PATIID>      --病人ID
  -- <PAGEID></PAGEID>      --主页ID
  -- <BABY></BABY>       --婴儿
  -- <FORMAT></ FORMAT >    --护理文件格式ID
  -- <CZY></CZY>   --操作员
  -- <CZSJ></CZSJ>   --操作时间
  --</IN>
  --出参:Xml_Out
  --成功：
  --<OUTPUT>
  -- <RESULT>true</RESULT>
  -- <DATA><FILE>文件ID</FILE></DATA>   --创建成功，返回生成的文件id
  --</OUTPUT>
  --失败：
  --<OUTPUT>
  -- <RESULT>false</RESULT>
  -- <ERROR>
  --  <MSG>详细错误提示</MSG>
  -- </ERROR>
  --</OUTPUT>
  ----------------------------------------------------------------------------------------------------------------------------
  n_Patiid   Number(18);
  n_Pageid   Number(18);
  n_Baby     Number(18);
  n_Areaid   Number(18);
  n_Format   Number(18);
  v_Czy      Varchar2(20);
  d_Czsj     Date;
  v_Deptname Varchar2(100);
  v_Filename Varchar2(20);
  n_Fileid   Number(18);
  v_Temp     Varchar2(32767);
  x_Templet  Xmltype; --模板XML
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/BQ'))
  Into n_Areaid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/PATIID'))
  Into n_Patiid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/PAGEID'))
  Into n_Pageid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/BABY'))
  Into n_Baby
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/FORMAT'))
  Into n_Format
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Char(Extractvalue(Value(A), 'IN/CZY'))
  Into v_Czy
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Date(Extractvalue(Value(A), 'IN/CZSJ'), 'yyyy-MM-dd hh24:mi:ss')
  Into d_Czsj
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select b.名称
  Into v_Deptname
  From 病案主页 A, 部门表 B
  Where a.病人id = n_Patiid And a.主页id = n_Pageid And a.出院科室id = b.Id(+);

  Select 名称 Into v_Filename From 病历文件列表 Where 种类 = 3 And ID = n_Format;
  
  Select 病人护理文件_Id.Nextval Into n_Fileid From Dual;
  Zl_病人护理文件_Update(n_Fileid, n_Areaid, n_Patiid, n_Pageid, n_Baby, n_Format, '[' || v_Deptname || ']' || v_Filename,
                   d_Czsj, 0, v_Czy);
  v_Temp := '<RESULT>True</RESULT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<DATA><FILE>' || n_Fileid || '</FILE></DATA>';

  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xmlfilelist_Out := x_Templet;
Exception
  When Others Then
    v_Temp := '<RESULT>False</RESULT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<ERROR><MSG>' || SQLErrM || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xmlfilelist_Out := x_Templet;
End Zl_Third_Tendfile_Add;
/
Create Or Replace Procedure Zl_Third_Tendfile_Getall
(
  Xmlfilelist_In  Xmltype,
  Xmlfilelist_Out Out Xmltype
) Is
  ---------------------------------------------------------------------------------------------------------------------------
  --功能:获取所选病人当前已创建的护理记录单和可创建的护理记录单列表
  --入参:Xml_In
  --<IN>
  -- <BQ></BQ>        --病区ID
  -- <PATIID></PATIID>      --病人ID
  -- <PAGEID></PAGEID>      --主页ID
  -- <BABY></BABY>       --婴儿
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  -- <ITEMLIST>
  --  <ITEM>
  --   <ID></ID>   --已创建的为文件ID，未创建的为格式ID
  --   <MC></MC>
  --   <TYPE></TYPE>   --0表示未创建，1表示已创建
  --  </ITEM>
  -- </ITEMLIST>
  --<OUTPUT/>
  ----------------------------------------------------------------------------------------------------------------------------
  n_Patiid  Number(18);
  n_Pageid  Number(18);
  n_Baby    Number(18);
  n_Areaid  Number(18);
  v_Temp    Varchar2(32767);
  x_Templet Xmltype; --模板XML
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/BQ'))
  Into n_Areaid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/PATIID'))
  Into n_Patiid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/PAGEID'))
  Into n_Pageid
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/BABY'))
  Into n_Baby
  From Table(Xmlsequence(Extract(Xmlfilelist_In, 'IN'))) A;

  x_Templet := Xmltype('<OUT><ITEMLIST></ITEMLIST></OUT>');

  For r_Ycj In (Select a.Id, a.格式id, a.科室id, c.名称 As 科室, a.文件名称, a.开始时间, a.创建时间, b.保留, b.编号
                From 病人护理文件 A, 病历文件列表 B, 部门表 C
                Where a.格式id = b.Id And a.科室id = c.Id And a.病人id = n_Patiid And a.主页id = n_Pageid And a.婴儿 = n_Baby
                Order By b.保留, a.开始时间) Loop
    v_Temp := '<ITEM jsonArray="True"><ID>' || r_Ycj.Id || '</ID><MC>' || r_Ycj.文件名称 || '</MC><TYPE>1</TYPE></ITEM>';
    Select Appendchildxml(x_Templet, '/OUT/ITEMLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  For r_Kcj In (Select ID, 保留, 编号, 格式
                From (Select ID, 保留, 编号, 名称 As 格式
                       From 病历文件列表
                       Where 种类 = 3 And 保留 <> 1 And
                             (通用 = 1 Or (通用 = 2 And ID In (Select 文件id From 病历应用科室 Where 科室id = n_Areaid))))
                Order By 保留, 编号) Loop
    v_Temp := '<ITEM jsonArray="True"><ID>' || r_Kcj.Id || '</ID><MC>' || r_Kcj.格式 || '</MC><TYPE>0</TYPE></ITEM>';
    Select Appendchildxml(x_Templet, '/OUT/ITEMLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xmlfilelist_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Tendfile_Getall;
/
----------------------------------------------------------------------------
--[[10.检验基础]]
----------------------------------------------------------------------------

----------------------------------------------------------------------------
--[[11.检查基础]]
----------------------------------------------------------------------------

----------------------------------------------------------------------------
--[[12.医保业务]]
----------------------------------------------------------------------------

----------------------------------------------------------------------------
--[[13.病人病案业务]]
----------------------------------------------------------------------------
Create Or Replace Procedure Zl_Third_Getpativisits
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:通过病人ID，提取病人历史就诊记录

  --入参:Xml_In:
  --<IN>
  --  <BRID></BRID>  --病人ID
  --</IN>

  --出参
  --<OUTPUT>
  --  <JZLIST>   --就诊列表[数组]
  --      <JZXX>   --就诊信息
  --         <BRID></BRID>--病人ID
  --         <JZID></JZID>--就诊ID
  --         <GHD></GHD>--挂号单   为门诊就诊时传出
  --         <KSSJ></KSSJ>--开始时间
  --         <JSSJ></JSSJ>--结束时间
  --         <JZKS></JZKS>--就诊科室
  --         <JZKSID></JZKSID>--就诊科室ID
  --         <JZLX></JZLX>--就诊类型
  --         <BSH></BSH>--标识号
  --         <BRXM></BRXM>--病人姓名
  --         <BRXB></BRXB>--病人性别
  --         <BRNL></BRNL>--病人年龄

  --      </JZXX>
  --  ....
  --  </JZLIST>

  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_病人id Number;

  v_Tmp Varchar2(5000); --临时XML

  v_就诊列表 Varchar2(5000);

  v_身份证号 Varchar2(50);

  v_身份证关联 Varchar2(5000);
  v_身份关联   Varchar2(5000);
  v_病人ids    Varchar2(5000);

  v_姓名 Varchar2(200);
  v_性别 Varchar2(200);
  v_年龄 Varchar2(200);

  v_Idcheckmsg Varchar2(2000);
  v_Idcheckxml Xmltype;

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/BRID')) Into n_病人id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --获取关联病人IDs
  v_病人ids := n_病人id;
  Select Nvl(a.身份证号, '-'), 姓名, 性别, 年龄
  Into v_身份证号, v_姓名, v_性别, v_年龄
  From 病人信息 A
  Where a.病人id = n_病人id;

  If v_身份证号 <> '-' Then
    --判断是否是有效的身份证号
    Begin
      v_Idcheckxml := Xmltype(Zl_Fun_Checkidcard(v_身份证号));
      Select Extractvalue(Value(A), 'OUTPUT/MSG')
      Into v_Idcheckmsg
      From Table(Xmlsequence(Extract(v_Idcheckxml, 'OUTPUT'))) A;
    Exception
      When Others Then
        Null;
    End;
  
    If v_Idcheckmsg Is Null Then
      Select f_List2str(Cast(Collect(a.病人id || '') As t_Strlist))
      Into v_身份证关联
      From 病人信息 A
      Where a.病人id <> n_病人id And a.身份证号 = v_身份证号;
    
      If v_身份证关联 Is Not Null Then
        v_病人ids := v_病人ids || ',' || v_身份证关联;
      End If;
    End If;
  
    Select f_List2str(Cast(Collect(b.病人id || '') As t_Strlist))
    Into v_身份关联
    From 病人身份关联 A, 病人身份关联 B, 病人信息 C
    Where a.关联id = b.关联id And b.病人id = c.病人id And a.病人id = n_病人id And b.病人id + 0 <> n_病人id And
          Nvl(c.身份证号, '-') <> v_身份证号;
  
    If v_身份关联 Is Not Null Then
      v_病人ids := v_病人ids || ',' || v_身份关联;
    End If;
  Else
    Select f_List2str(Cast(Collect(b.病人id || '') As t_Strlist))
    Into v_身份关联
    From 病人身份关联 A, 病人身份关联 B
    Where a.关联id = b.关联id And a.病人id = n_病人id And b.病人id + 0 <> n_病人id;
  
    If v_身份关联 Is Not Null Then
      v_病人ids := v_病人ids || ',' || v_身份关联;
    End If;
  End If;

  For v_就诊信息 In (Select *
                 From (Select a.病人id, a.就诊id, To_Char(a.开始时间, 'YYYY-MM-DD HH24:MI:SS') As 开始时间,
                               To_Char(a.结束时间, 'YYYY-MM-DD HH24:MI:SS') As 结束时间, b.名称 As 科室, a.科室id, a.就诊类型, 标识号, NO
                        From (Select 病人id, ID As 就诊id, 发生时间 As 开始时间, 完成时间 As 结束时间, 执行部门id As 科室id, 1 As 就诊类型, 门诊号 As 标识号, NO
                               From 病人挂号记录
                               Where 病人id In (Select Column_Value As 病人id
                                              From Table(Cast(f_Str2list(v_病人ids) As Zltools.t_Strlist))) And 记录性质 = 1 And
                                     记录状态 = 1
                               Union All
                               Select 病人id, 主页id As 就诊id, 入院日期 As 开始时间, 出院日期, 出院科室id, 2 As 就诊类型, 住院号 As 标识号, Null As NO
                               From 病案主页
                               Where 病人id In (Select Column_Value As 病人id
                                              From Table(Cast(f_Str2list(v_病人ids) As Zltools.t_Strlist))) And
                                     Nvl(主页id, 0) <> 0) A, 部门表 B
                        Where a.科室id = b.Id
                        Group By a.病人id, a.就诊id, 开始时间, 结束时间, b.名称, a.科室id, a.就诊类型, 标识号,a.NO)
                 Order By 开始时间 Desc) Loop
  
    v_Tmp := '<JZXX>';
    v_Tmp := v_Tmp || '<BRID>' || v_就诊信息.病人id || '</BRID>';
    v_Tmp := v_Tmp || '<JZID>' || v_就诊信息.就诊id || '</JZID>';
    v_Tmp := v_Tmp || '<GHD>' || v_就诊信息.No || '</GHD>';
    v_Tmp := v_Tmp || '<KSSJ>' || v_就诊信息.开始时间 || '</KSSJ>';
    v_Tmp := v_Tmp || '<JSSJ>' || v_就诊信息.结束时间 || '</JSSJ>';
    v_Tmp := v_Tmp || '<JZKS>' || v_就诊信息.科室 || '</JZKS>';
    v_Tmp := v_Tmp || '<JZKSID>' || v_就诊信息.科室id || '</JZKSID>';
    v_Tmp := v_Tmp || '<JZLX>' || v_就诊信息.就诊类型 || '</JZLX>';
    v_Tmp := v_Tmp || '<BSH>' || v_就诊信息.标识号 || '</BSH>';
    v_Tmp := v_Tmp || '<BRXM>' || v_姓名 || '</BRXM>';
    v_Tmp := v_Tmp || '<BRXB>' || v_性别 || '</BRXB>';
    v_Tmp := v_Tmp || '<BRNL>' || v_年龄 || '</BRNL>';
    v_Tmp := v_Tmp || '</JZXX>';
  
    v_就诊列表 := v_就诊列表 || v_Tmp;
  End Loop;

  Xml_Out := Xmltype('<OUTPUT><JZLIST>' || v_就诊列表 || '</JZLIST><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpativisits;
/



Create Or Replace Procedure Zl_Third_Getblacklistinfor
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:HIS挂号
  --入参:Xml_In:
  --<IN>
  --   <BRID>病人ID</BRID>    //病人ID
  --   <YWCH>预约</YWCH>    //业务场合：预约;挂号
  --   <YYFS>预约方式</YYFS>    //预约方式:预约方式.名称  
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  -- <TSZT>1</TSZT>          //提示状态:0-非黑名单病人;1-禁止操作;2-提示
  -- <HMDMSG>操作时间</HMDMSG> //为空时，不是黑名单病人,不作提示或禁止,否则表示该病人是黑名单病人，需要根据TSZT接点的值来控制
  --</ OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_病人id   病人信息.病人id%Type;
  v_场合     不良行为控制.应用场合%Type;
  v_预约方式 预约方式.名称%Type;

  v_Temp    Varchar2(32767); --临时XML
  v_Infor   Varchar2(4000); --不良记录信息
  n_Opt     Number(2);
  x_Templet Xmltype; --模板XML

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/YWCH'), Extractvalue(Value(A), 'IN/YYFS')
  Into n_病人id, v_场合, v_预约方式
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  v_Infor := Null;

  If Nvl(n_病人id, 0) <> 0 Then
    --需要先确认病人是否有需要加入不良记录的信息
    Zl_Regist_Autointoblacklist(n_病人id);
  
    --获取病人的不良记录
    v_Infor := Zl_Fun_Getblacklistinfor(n_病人id, v_场合, v_预约方式);
  End If;
  n_Opt := 0;
  If v_Infor Is Not Null Then
    n_Opt   := To_Number(Substr(v_Infor, 1, Instr(v_Infor, '|') - 1));
    v_Infor := Substr(v_Infor, Instr(v_Infor, '|') + 1);
  End If;

  v_Temp := '<TSZT>' || n_Opt || '</TSZT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<HMDMSG>' || Nvl(v_Infor, '') || '</HMDMSG>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getblacklistinfor;
/
Create Or Replace Procedure Zl_Third_Buildpatient
(
  Patiinfo_In  In Xmltype,
  Patiinfo_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------
  --参数说明:
  -- 入参 Patiinfo_In:
  --<IN>
  --  <ZJH></ZJH>                 //证件号，目前仅支持身份证号
  --  <ZJLX></ZJLX>                       //证件类型(目前仅支持身份证,为空时默认为身份证)
  --  <XM></XM>                       //姓名
  --  <SJH></SJH>                      //手机号
  --</IN>

  --出参 Patiinfo_Out：
  --<OUTPUT>
  --       <BRID></BRID>                //病人ID
  --       <MZH></MZH>                  //门诊号
  --     <ERROR></ERROR>         //如果有错误返回该节点
  --</OUTPUT>
  -------------------------------------------------------------------------------
  n_Pati_Id      病人信息.病人id%Type;
  n_Card_Type_Id 医疗卡类别.Id%Type;
  n_Count        Number(5);
  n_Sum          Number(5);
  v_校验位       Varchar2(50);

  v_姓名         病人信息.姓名%Type;
  v_身份证号     病人信息.身份证号%Type;
  v_手机号       病人信息.家庭电话%Type;
  v_性别         病人信息.性别%Type;
  v_年龄         病人信息.年龄%Type;
  v_操作员       人员表.姓名%Type;
  v_医疗付款方式 病人信息.医疗付款方式%Type;
  n_门诊号       病人信息.门诊号%Type;
  v_证件类型     医疗卡类别.名称%Type;
  v_证件号       病人医疗卡信息.卡号%Type;

  v_Pattern Varchar2(500);
  v_Temp    Varchar2(32767); --临时XML
  v_Err_Msg Varchar2(2000);
  n_存在    Number(2);

  d_出生日期  病人信息.出生日期%Type;
  d_Curr_Time Date;

  Err_Item Exception;
Begin
  Patiinfo_Out := Xmltype('<OUTPUT></OUTPUT>');
  Select Sysdate Into d_Curr_Time From Dual;

  --新建病人：姓名、身份证号、手机号（存在家庭电话中）、出生日期、性别、年龄(后面三项可从身份证中获取)。
  Select Extractvalue(Value(I), 'IN/XM'), Extractvalue(Value(I), 'IN/ZJH'), Extractvalue(Value(I), 'IN/SJH'),
         Extractvalue(Value(I), 'IN/ZJLX')
  Into v_姓名, v_证件号, v_手机号, v_证件类型
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) I;

  Begin
    If v_证件类型 Is Null Then
      Select 病人id
      Into n_Pati_Id
      From 病人医疗卡信息
      Where 卡号 = v_证件号 And 卡类别id In (Select ID From 医疗卡类别 Where 名称 Like '%身份证%') And Rownum < 2;
    Else
      Select 病人id
      Into n_Pati_Id
      From 病人医疗卡信息
      Where 卡号 = v_证件号 And 卡类别id In (Select ID From 医疗卡类别 Where 名称 = v_证件类型) And Rownum < 2;
    End If;
    n_存在 := 1;
  Exception
    When Others Then
      n_存在 := 0;
  End;

  If Nvl(n_存在, 0) = 1 Then
    v_Temp := '<BRID>' || n_Pati_Id || '</BRID>';
    Select Appendchildxml(Patiinfo_Out, '/OUTPUT', Xmltype(v_Temp)) Into Patiinfo_Out From Dual;
    Select 门诊号 Into n_门诊号 From 病人信息 Where 病人id = n_Pati_Id;
    If n_门诊号 Is Null Then
      n_门诊号 := Nextno(3);
      Update 病人信息 Set 门诊号 = n_门诊号 Where 病人id = n_Pati_Id;
    End If;
    v_Temp := '<MZH>' || n_门诊号 || '</MZH>';
    Select Appendchildxml(Patiinfo_Out, '/OUTPUT', Xmltype(v_Temp)) Into Patiinfo_Out From Dual;
  Else
    If v_姓名 Is Null Then
      v_Err_Msg := '传入姓名为空!';
      Raise Err_Item;
    End If;
    If v_证件类型 Like '%身份证%' Or v_证件类型 Is Null Then
      v_身份证号 := v_证件号;
    Else
      v_Err_Msg := '目前不支持身份证以外的方式建档！';
      Raise Err_Item;
    End If;
  
    If v_身份证号 Is Null Then
      v_Err_Msg := '传入身份证号为空!';
      Raise Err_Item;
    Else
      --身份证合法验证
      v_Pattern := '11,12,13,14,15,21,22,23,31,32,33,34,35,36,37,41,42,43,44,45,46,50,51,52,53,54,61,62,63,64,65,71,81,82,83,91';
    
      --地区检验
      If Instr(v_Pattern, Substr(v_身份证号, 1, 2)) = 0 Then
        v_Err_Msg := '身份证前两位地区码不正确!';
        Raise Err_Item;
      End If;
      --身份证长度检查
      If Length(v_身份证号) = 15 Then
        --检查身份证号:15位身份证号要求全部为数字
        v_Pattern := '^\d{15}$';
        Select Count(1) Into n_Count From Dual Where Regexp_Like(v_身份证号, v_Pattern);
        If n_Count = 0 Then
          v_Err_Msg := '身份证中包含非法字符，请检查!';
          Raise Err_Item;
        End If;
        --获取性别
        If Mod(To_Number(Substr(v_身份证号, 15, 1)), 2) = 1 Then
          v_性别 := '男';
        Else
          v_性别 := '女';
        End If;
        --出生日期的合法性检查
      
        v_Pattern := '^19[0-9]{2}((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))$';
        Select Count(1) Into n_Count From Dual Where Regexp_Like('19' || Substr(v_身份证号, 7, 6), v_Pattern);
        If n_Count = 0 Then
          v_Err_Msg := '身份证中的出生日期无效，请检查!';
          Raise Err_Item;
        Else
          --以前的老身份证没有区分闰年的情况兼容处理将出生日期改为2月28号，如：19470229这种情况
          If Instr(',0229,0230,', ',' || Substr(v_身份证号, 9, 4) || ',') > 0 Then
            v_Temp     := '19' || Substr(v_身份证号, 7, 2) || '0301';
            d_出生日期 := To_Date(v_Temp, 'yyyy-mm-dd') - 1;
          Else
            d_出生日期 := To_Date('19' || Substr(v_身份证号, 7, 6), 'yyyy-mm-dd');
          End If;
          If d_出生日期 > To_Date(To_Char(d_Curr_Time, 'YYYY-MM-DD'), 'YYYY-MM-dd') Then
            v_Err_Msg := '身份证中的出生日期无效，请检查!';
            Raise Err_Item;
          End If;
        End If;
      Elsif Length(v_身份证号) = 18 Then
        -- 18 位身份证号前17 位全部为数字，最后1位可为数字或x
        v_Pattern := '^\d{17}[0-9Xx]$';
        Select Count(1) Into n_Count From Dual Where Regexp_Like(v_身份证号, v_Pattern);
        If n_Count = 0 Then
          v_Err_Msg := '身份证中包含非法字符!';
          Raise Err_Item;
        End If;
        --获取性别
        If Mod(To_Number(Substr(v_身份证号, 17, 1)), 2) = 1 Then
          v_性别 := '男';
        Else
          v_性别 := '女';
        End If;
        --出生日期的合法性检查
        v_Pattern := '^(1[6-9]|[2-9][0-9])[0-9]{2}((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))$';
        Select Count(1) Into n_Count From Dual Where Regexp_Like(Substr(v_身份证号, 7, 8), v_Pattern);
        If n_Count = 0 Then
          v_Err_Msg := '身份证中的出生日期无效，请检查!';
          Raise Err_Item;
        Else
          --以前的老身份证没有区分闰年的情况兼容处理将出生日期改为2月28号，如：19470229这种情况
          If Instr(',0229,0230,', ',' || Substr(v_身份证号, 11, 4) || ',') > 0 Then
            v_Temp     := Substr(v_身份证号, 7, 4) || '0301';
            d_出生日期 := To_Date(v_Temp, 'yyyy-mm-dd') - 1;
          Else
            d_出生日期 := To_Date(Substr(v_身份证号, 7, 8), 'yyyy-mm-dd');
          End If;
          If d_出生日期 > To_Date(To_Char(d_Curr_Time, 'YYYY-MM-DD'), 'YYYY-MM-dd') Then
            v_Err_Msg := '身份证中的出生日期无效，请检查!';
            Raise Err_Item;
          End If;
          --计算校验位
          n_Sum     := (To_Number(Substr(v_身份证号, 1, 1)) + To_Number(Substr(v_身份证号, 11, 1))) * 7 +
                       (To_Number(Substr(v_身份证号, 2, 1)) + To_Number(Substr(v_身份证号, 12, 1))) * 9 +
                       (To_Number(Substr(v_身份证号, 3, 1)) + To_Number(Substr(v_身份证号, 13, 1))) * 10 +
                       (To_Number(Substr(v_身份证号, 4, 1)) + To_Number(Substr(v_身份证号, 14, 1))) * 5 +
                       (To_Number(Substr(v_身份证号, 5, 1)) + To_Number(Substr(v_身份证号, 15, 1))) * 8 +
                       (To_Number(Substr(v_身份证号, 6, 1)) + To_Number(Substr(v_身份证号, 16, 1))) * 4 +
                       (To_Number(Substr(v_身份证号, 7, 1)) + To_Number(Substr(v_身份证号, 17, 1))) * 2 +
                       To_Number(Substr(v_身份证号, 8, 1)) * 1 + To_Number(Substr(v_身份证号, 9, 1)) * 6 +
                       To_Number(Substr(v_身份证号, 10, 1)) * 3;
          n_Count   := Mod(n_Sum, 11);
          v_Pattern := '10X98765432';
          v_校验位  := Substr(v_Pattern, n_Count + 1, 1);
          If v_校验位 <> Upper(Substr(v_身份证号, 18, 1)) Then
            v_Err_Msg := '身份证号码不正确，请检查。';
            Raise Err_Item;
          End If;
        End If;
      Else
        v_Err_Msg := '身份证长度不对,请检查。';
        Raise Err_Item;
      End If;
    
      If Nvl(v_年龄, '_') = '_' Then
        v_年龄 := Zl_Age_Calc(0, d_出生日期, d_Curr_Time);
      End If;
    End If;
  
    Select 名称 Into v_医疗付款方式 From 医疗付款方式 Where 缺省标志 = 1;
    n_Pati_Id := Nextno(1);
    n_门诊号  := Nextno(3);
    Insert Into 病人信息
      (病人id, 姓名, 身份证号, 家庭电话, 出生日期, 性别, 年龄, 登记时间, 门诊号, 医疗付款方式, 手机号)
      Select n_Pati_Id, v_姓名, v_身份证号, v_手机号, d_出生日期, v_性别, v_年龄, d_Curr_Time, n_门诊号, v_医疗付款方式, v_手机号



      From Dual;
    --病人信息保存完后，完成医疗卡绑定（二代身份证卡类别的绑定）
    Begin
      If v_证件类型 Is Null Then
        Select ID Into n_Card_Type_Id From 医疗卡类别 Where 名称 Like '%身份证%' And Rownum < 2;
      Else
        Select ID Into n_Card_Type_Id From 医疗卡类别 Where 名称 = v_证件类型 And Rownum < 2;
      End If;
    Exception
      When No_Data_Found Then
        v_Err_Msg := '身份证卡类别不存在！';
        Raise Err_Item;
    End;
    Select b.姓名 Into v_操作员 From 上机人员表 A, 人员表 B Where a.人员id = b.Id And a.用户名 = User;
  
    Zl_医疗卡变动_Insert(11, n_Pati_Id, n_Card_Type_Id, Null, v_身份证号, '创建虚拟卡', Null, v_操作员, d_Curr_Time);
  
    v_Temp := '<BRID>' || n_Pati_Id || '</BRID>';
    Select Appendchildxml(Patiinfo_Out, '/OUTPUT', Xmltype(v_Temp)) Into Patiinfo_Out From Dual;
    v_Temp := '<MZH>' || n_门诊号 || '</MZH>';
    Select Appendchildxml(Patiinfo_Out, '/OUTPUT', Xmltype(v_Temp)) Into Patiinfo_Out From Dual;
    b_Message.Zlhis_Patient_015(n_Pati_Id);
  End If;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Buildpatient;
/
----------------------------------------------------------------------------
--[[14.费用业务]]
----------------------------------------------------------------------------
Create Or Replace Function Zl_Third_Get_Mergepatiinfo
(
  病人id_In 病人信息.病人id%Type,
  Xml_Out   Out Xmltype
) Return Number Is
  --功能：判断病人是否进行过合并,并返回合并后信息
  --出参：Xml_Out：
  --<OUTPUT>
  --  <TYPE>1</TYPE>        //类型，1表示返回病人合并信息。目前只有1,以后可以扩展
  --  <YBRID></YBRID>       //原病人ID
  --  <XBRID></XBRID>       //现病人ID
  --  <XM></XM>             //现姓名
  --  <SFZ></SFZ>           //现身份证
  --</OUTPUT>
  --返回：
  --     0-未合并过；1-合并过，同时返回Xml_Out
  n_合并病人id 病人信息.病人id%Type;
  v_姓名       病人信息.姓名%Type;
  v_身份证号   病人信息.身份证号%Type;

  v_Temp    Varchar2(32767); --临时XML
  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  If Nvl(病人id_In, 0) = 0 Then
    Return 0;
  End If;

  Select Max(病人id) Into n_合并病人id From 病人合并记录 Where 原病人id = 病人id_In;
  If Nvl(n_合并病人id, 0) = 0 Then
    Return 0;
  End If;

  Select Max(姓名), Max(身份证号) Into v_姓名, v_身份证号 From 病人信息 Where 病人id = n_合并病人id;
  v_Temp  := '<TYPE>1</TYPE>';
  v_Temp  := v_Temp || '<YBRID>' || 病人id_In || '</YBRID>';
  v_Temp  := v_Temp || '<XBRID>' || n_合并病人id || '</XBRID>';
  v_Temp  := v_Temp || '<XM>' || v_姓名 || '</XM>';
  v_Temp  := v_Temp || '<SFZ>' || v_身份证号 || '</SFZ>';
  Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
  Return 1;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Get_Mergepatiinfo;
/

Create Or Replace Procedure Zl_Third_Exesverifybyno
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:按单据审核费用
  --入参:Xml_In:
  --<IN>
  --  <MZBZ></MZBZ>   //门诊标志，1-门诊，2-住院
  --  <DJH></DJH>     //单据号,多个用英文逗号分隔
  --  <SHR></SHR>     //审核人
  --  <SHSJ></SHSJ>   //审核时间，格式：yyyy-mm-dd HH24:mi:ss
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --   <RESULT></RESULT> //true-表示成功;false-表示失败
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_门诊标志   门诊费用记录.门诊标志%Type; --1-门诊，2-住院
  v_单据号     Varchar2(32767);
  d_审核时间   门诊费用记录.执行时间%Type;
  v_审核人     门诊费用记录.执行人%Type;
  v_操作员编号 门诊费用记录.操作员编号%Type;
  v_Nos        Varchar2(32767);

  v_Err_Msg Varchar2(255);
  Err_Item Exception;
Begin
  --获取入参
  Select Nvl(Extractvalue(Value(A), 'IN/MZBZ'), 1), Extractvalue(Value(A), 'IN/DJH'), Extractvalue(Value(A), 'IN/SHR'),
         Nvl(To_Date(Extractvalue(Value(A), 'IN/SHSJ'), 'yyyy-mm-dd hh24:mi:ss'), Sysdate)
  Into n_门诊标志, v_单据号, v_审核人, d_审核时间
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Begin
    Select a.编号 Into v_操作员编号 From 人员表 A Where a.姓名 = v_审核人;
  Exception
    When Others Then
      v_Err_Msg := '未查找到审核人信息，费用审核失败！';
      Raise Err_Item;
  End;

  If v_单据号 Is Null Then
    v_Err_Msg := '未传入单据信息，费用审核失败！';
    Raise Err_Item;
  End If;

  If Nvl(n_门诊标志, 0) = 1 Then
    Select /*+cardinality(a,10)*/
     f_List2Str(Cast(Collect(a.Column_Value) As t_StrList), '、')
    Into v_Nos
    From Table(f_Str2List(v_单据号)) A
    Where Not Exists (Select 1 From 门诊费用记录 Where 记录性质 = 2 And NO = a.Column_Value);
  Else
    Select /*+cardinality(a,10)*/
     f_List2Str(Cast(Collect(a.Column_Value) As t_StrList), '、')
    Into v_Nos
    From Table(f_Str2List(v_单据号)) A
    Where Not Exists (Select 1 From 住院费用记录 Where 记录性质 = 2 And NO = a.Column_Value);
  End If;
  If v_Nos Is Not Null Then
    v_Err_Msg := '单据【' || v_Nos || '】不存在，可能已经被他人删除，费用审核失败！';
    Raise Err_Item;
  End If;

  For r_No In (Select Column_Value As NO From Table(f_Str2List(v_单据号))) Loop
    If Nvl(n_门诊标志, 0) = 1 Then
      Zl_门诊记帐记录_Verify(r_No.No, v_操作员编号, v_审核人, Null, d_审核时间);
    Else
      Zl_住院记帐记录_Verify(r_No.No, v_操作员编号, v_审核人, Null, Null, d_审核时间);
    End If;
  End Loop;

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Exesverifybyno;
/

Create Or Replace Procedure Zl_Third_Deleteexesbyno
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:删除/作废费用单据
  --入参:Xml_In:
  --<IN>
  --  <MZBZ></MZBZ>   //门诊标志，1-门诊，2-住院
  --  <JZBZ></JZBZ>   //记帐标志，0-收费，1-记帐
  --  <DJH></DJH>     //单据号,多个用英文逗号分隔
  --  <CZY></CZY>     //操作员姓名
  --  <CZSJ></CZSJ>   //操作时间，格式：yyyy-mm-dd HH24:mi:ss
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --   <RESULT></RESULT> //true-表示保存成功;false-表示保存失败
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_门诊标志   门诊费用记录.门诊标志%Type; --1-门诊，2-住院
  n_记帐标志   Number(2); --0-收费，1-记帐
  v_单据号     Varchar2(32767);
  d_操作时间   门诊费用记录.登记时间%Type;
  v_操作员姓名 门诊费用记录.操作员姓名%Type;
  v_操作员编号 门诊费用记录.操作员编号%Type;

  v_Err_Msg Varchar2(255);
  Err_Item Exception;
Begin
  --获取入参
  Select Nvl(Extractvalue(Value(A), 'IN/MZBZ'), 1), Nvl(Extractvalue(Value(A), 'IN/JZBZ'), 0),
         Extractvalue(Value(A), 'IN/DJH'), Extractvalue(Value(A), 'IN/CZY'),
         Nvl(To_Date(Extractvalue(Value(A), 'IN/CZSJ'), 'yyyy-mm-dd hh24:mi:ss'), Sysdate)
  Into n_门诊标志, n_记帐标志, v_单据号, v_操作员姓名, d_操作时间
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Begin
    Select a.编号 Into v_操作员编号 From 人员表 A Where a.姓名 = v_操作员姓名;
  Exception
    When Others Then
      v_Err_Msg := '未查找到操作员信息，删除单据失败！';
      Raise Err_Item;
  End;

  If v_单据号 Is Null Then
    v_Err_Msg := '未传入单据信息，删除单据失败！';
    Raise Err_Item;
  End If;

  For r_No In (Select Column_Value As NO From Table(f_Str2list(v_单据号))) Loop
    If n_门诊标志 = 1 Then
      If n_记帐标志 = 0 Then
        --门诊划价单
        Zl_门诊划价记录_Delete(r_No.No);
      Else
        --门诊记帐单
        Zl_门诊记帐记录_Delete(r_No.No, '', v_操作员编号, v_操作员姓名);
      End If;
    Elsif n_门诊标志 = 2 Then
      --住院记帐单
      Zl_住院记帐记录_Delete(r_No.No, '', v_操作员编号, v_操作员姓名);
    End If;
  End Loop;

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Deleteexesbyno;
/
Create Or Replace Procedure Zl_Third_Executeexesbyno
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:按单据执行费用
  --入参:Xml_In:
  --<IN>
  --  <MZBZ></MZBZ>   //门诊标志，1-门诊，2-住院
  --  <JZBZ></JZBZ>   //记帐标志，0-收费，1-记帐
  --  <DJH></DJH>     //单据号,多个用英文逗号分隔
  --  <ZXR></ZXR>     //执行人，表示完全执行
  --  <ZXSJ></ZXSJ>   //执行时间，格式：yyyy-mm-dd HH24:mi:ss
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --   <RESULT></RESULT> //true-表示成功;false-表示失败
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_门诊标志   门诊费用记录.门诊标志%Type; --1-门诊，2-住院
  n_记帐标志   Number(2); --0-收费，1-记帐
  v_单据号     Varchar2(32767);
  d_执行时间   门诊费用记录.执行时间%Type;
  v_执行人     门诊费用记录.执行人%Type;
  v_操作员编号 门诊费用记录.操作员编号%Type;
  v_Nos        Varchar2(32767);

  v_Err_Msg Varchar2(255);
  Err_Item Exception;
Begin
  --获取入参
  Select Nvl(Extractvalue(Value(A), 'IN/MZBZ'), 1), Nvl(Extractvalue(Value(A), 'IN/JZBZ'), 0),
         Extractvalue(Value(A), 'IN/DJH'), Extractvalue(Value(A), 'IN/ZXR'),
         Nvl(To_Date(Extractvalue(Value(A), 'IN/ZXSJ'), 'yyyy-mm-dd hh24:mi:ss'), Sysdate)
  Into n_门诊标志, n_记帐标志, v_单据号, v_执行人, d_执行时间
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Begin
    Select a.编号 Into v_操作员编号 From 人员表 A Where a.姓名 = v_执行人;
  Exception
    When Others Then
      v_Err_Msg := '未查找到执行人信息，费用执行失败！';
      Raise Err_Item;
  End;

  If v_单据号 Is Null Then
    v_Err_Msg := '未传入单据信息，费用执行失败！';
    Raise Err_Item;
  End If;

  If Nvl(n_门诊标志, 0) = 1 Then
    Select /*+Cardinality(a,10)*/
     f_List2Str(Cast(Collect(a.Column_Value) As t_StrList), '、')
    Into v_Nos
    From Table(f_Str2List(v_单据号)) A
    Where Not Exists (Select 1 From 门诊费用记录 Where 记录性质 = Decode(n_记帐标志, 1, 2, 1) And NO = a.Column_Value);
  Else
    Select /*+Cardinality(a,10)*/
     f_List2Str(Cast(Collect(a.Column_Value) As t_StrList), '、')
    Into v_Nos
    From Table(f_Str2List(v_单据号)) A
    Where Not Exists (Select 1 From 住院费用记录 Where 记录性质 = 2 And NO = a.Column_Value);
  End If;
  If v_Nos Is Not Null Then
    v_Err_Msg := '单据【' || v_Nos || '】不存在，可能已经被他人删除，费用执行失败！';
    Raise Err_Item;
  End If;

  For r_No In (Select Column_Value As NO From Table(f_Str2List(v_单据号))) Loop
    If n_记帐标志 = 1 Then
      Zl_病人费用记录_Execute(r_No.No, 2, '', n_门诊标志, '', v_执行人, d_执行时间, 1);
    Else
      Zl_病人费用记录_Execute(r_No.No, 1, '', n_门诊标志, '', v_执行人, d_执行时间, 1);
    End If;
  End Loop;

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Executeexesbyno;
/
Create Or Replace Procedure Zl_Third_Getexesbyno
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:按单据号获取费用数据
  --入参:Xml_In
  --<IN>
  --  <MZBZ></MZBZ>   //门诊标志，1-门诊，2-住院
  --  <JZBZ></JZBZ>   //记帐标志，0-收费，1-记帐
  --  <DJH></DJH>     //单据号,多个用英文逗号分隔
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <FYLIST jsonArray='true'>
  --    <DJH></DJH>  //单据号
  --    <XMID></XMID>  //收费项目ID
  --    <XMMC></XMMC>  //收费项目名称
  --    <GG></GG>  //规格
  --    <SL></SL>  //数量
  --    <DW></DW>  //单位
  --    <DJ></DJ>  //标准单价
  --    <YSJE></YSJE>  //应收金额
  --    <SSJE></SSJE>  //实收金额
  --    <ZXKS></ZXKS>  //执行科室名称
  --    <ZXZT></ZXZT>  //执行状态：0-未执行,1-完全执行,2-部分执行
  --    <KDKS></KDKS>  //开单科室名称
  --    <KDR></KDR>  //开单人姓名
  --    <FSSJ></FSSJ>  //发生时间
  --    <CZY></CZY>  //操作员姓名
  --  </FYLIST>
  --    ...
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_门诊标志 门诊费用记录.门诊标志%Type; --1-门诊，2-住院
  n_记帐标志 Number(2); --0-收费，1-记帐
  v_单据号   Varchar2(32767);
  v_Nos      Varchar2(32767);

  v_Err_Msg Varchar2(255);
  Err_Item Exception;
Begin
  --获取入参
  Select Nvl(Extractvalue(Value(A), 'IN/MZBZ'), 1), Nvl(Extractvalue(Value(A), 'IN/JZBZ'), 0),
         Extractvalue(Value(A), 'IN/DJH')
  Into n_门诊标志, n_记帐标志, v_单据号
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_单据号 Is Null Then
    v_Err_Msg := '未传入单据信息，获取费用数据失败！';
    Raise Err_Item;
  End If;

  If Nvl(n_门诊标志, 0) = 1 Then
    Select /*+Cardinality(a,10)*/
     f_List2Str(Cast(Collect(a.Column_Value) As t_StrList), '、')
    Into v_Nos
    From Table(f_Str2List(v_单据号)) A
    Where Not Exists (Select 1 From 门诊费用记录 Where 记录性质 = Decode(n_记帐标志, 1, 2, 1) And NO = a.Column_Value);
  Else
    Select /*+Cardinality(a,10)*/
     f_List2Str(Cast(Collect(a.Column_Value) As t_StrList), '、')
    Into v_Nos
    From Table(f_Str2List(v_单据号)) A
    Where Not Exists (Select 1 From 住院费用记录 Where 记录性质 = 2 And NO = a.Column_Value);
  End If;
  If v_Nos Is Not Null Then
    v_Err_Msg := '单据【' || v_Nos || '】不存在，可能已经被他人删除，获取费用数据失败！';
    Raise Err_Item;
  End If;

  If Nvl(n_门诊标志, 0) = 1 Then
    --门诊
    Select Xmlelement("OUTPUT",
                       Xmlagg(Xmlelement("FYLIST", Xmlattributes('true' As "jsonArray"),
                                          Xmlforest(a.单据号 As "DJH", a.收费细目id As "XMID", a.收费项目名称 As "XMMC", a.规格 As "GG",
                                                     a.数量 As "SL", a.计算单位 As "DW", a.标准单价 As "DJ", a.应收金额 As "YSJE",
                                                     a.实收金额 As "SSJE", a.执行科室 As "ZXKS", a.执行状态 As "ZXZT", a.开单科室 As "KDKS",
                                                     a.开单人 As "KDR", a.发生时间 As "FSSJ", a.操作员姓名 As "CZY"))))
    Into Xml_Out
    From (Select a.No As 单据号, a.收费细目id, c.名称 As 收费项目名称, c.规格, a.计算单位, Avg(a.标准单价) As 标准单价, Sum(a.数量) As 数量,
                  Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额, To_Char(a.发生时间, 'yyyy-mm-dd hh24:mi:ss') As 发生时间, a.开单人,
                  a.操作员姓名, f.名称 As 开单科室, d.名称 As 执行科室, Max(a.执行状态) As 执行状态
           From (
                  --先处理一个收费项目多个收入项目的情况
                  Select /*+Cardinality(b,10)*/
                   a.No, Nvl(a.价格父号, a.序号) As 序号, a.收费细目id, a.计算单位, Sum(a.标准单价) As 标准单价, Avg(Nvl(a.付数, 1) * a.数次) As 数量,
                    Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额, a.发生时间, a.开单人, a.开单部门id, a.执行部门id, a.执行状态, a.操作员姓名
                  From 门诊费用记录 A, Table(f_Str2List(v_单据号)) B
                  Where a.No = b.Column_Value And a.记录性质 = Decode(n_记帐标志, 1, 2, 1) And a.记录状态 In (0, 1, 3)
                  Group By a.No, Nvl(a.价格父号, a.序号), a.收费细目id, a.计算单位, a.发生时间, a.开单人, a.开单部门id, a.执行部门id, a.执行状态, a.操作员姓名
                  
                  ) A, 收费项目目录 C, 部门表 D, 部门表 F
           Where a.收费细目id = c.Id And a.执行部门id = d.Id And a.开单部门id = f.Id
           Group By a.No, a.序号, a.收费细目id, c.名称, c.规格, a.计算单位, a.发生时间, a.开单人, f.名称, d.名称, a.操作员姓名
           Order By a.No, a.序号) A;
  Else
    --住院
    Select Xmlelement("OUTPUT",
                       Xmlagg(Xmlelement("FYLIST", Xmlattributes('true' As "jsonArray"),
                                          Xmlforest(a.单据号 As "DJH", a.收费细目id As "XMID", a.收费项目名称 As "XMMC", a.规格 As "GG",
                                                     a.数量 As "SL", a.计算单位 As "DW", a.标准单价 As "DJ", a.应收金额 As "YSJE",
                                                     a.实收金额 As "SSJE", a.执行科室 As "ZXKS", a.执行状态 As "ZXZT", a.开单科室 As "KDKS",
                                                     a.开单人 As "KDR", a.发生时间 As "FSSJ", a.操作员姓名 As "CZY"))))
    Into Xml_Out
    From (Select a.No As 单据号, a.收费细目id, c.名称 As 收费项目名称, c.规格, a.计算单位, Avg(a.标准单价) As 标准单价, Sum(a.数量) As 数量,
                  Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额, To_Char(a.发生时间, 'yyyy-mm-dd hh24:mi:ss') As 发生时间, a.开单人,
                  a.操作员姓名, f.名称 As 开单科室, d.名称 As 执行科室, Max(a.执行状态) As 执行状态
           From (
                  --先处理一个收费项目多个收入项目的情况
                  Select /*+Cardinality(b,10)*/
                   a.No, Nvl(a.价格父号, a.序号) As 序号, a.收费细目id, a.计算单位, Sum(a.标准单价) As 标准单价, Avg(Nvl(a.付数, 1) * a.数次) As 数量,
                    Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额, a.发生时间, a.开单人, a.开单部门id, a.执行部门id, a.执行状态, a.操作员姓名
                  From 住院费用记录 A, Table(f_Str2List(v_单据号)) B
                  Where a.No = b.Column_Value And a.记录性质 = 2 And a.记录状态 In (0, 1, 3)
                  Group By a.No, Nvl(a.价格父号, a.序号), a.收费细目id, a.计算单位, a.发生时间, a.开单人, a.开单部门id, a.执行部门id, a.执行状态, a.操作员姓名
                  
                  ) A, 收费项目目录 C, 部门表 D, 部门表 F
           Where a.收费细目id = c.Id And a.执行部门id = d.Id And a.开单部门id = f.Id
           Group By a.No, a.序号, a.收费细目id, c.名称, c.规格, a.计算单位, a.发生时间, a.开单人, f.名称, d.名称, a.操作员姓名
           Order By a.No, a.序号) A;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getexesbyno;
/
Create Or Replace Procedure Zl_Third_Getexesstatusbyno
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取单据的费用状态
  --入参:Xml_In
  --<IN>
  --  <MZBZ></MZBZ>   //门诊标志，1-门诊，2-住院
  --  <JZBZ></JZBZ>   //记帐标志，0-收费，1-记帐
  --  <DJH></DJH>     //单据号,多个用英文逗号分隔
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <FYZT></FYZT> //费用状态：门诊：0-未收费,1-部分收费/退费,2-全部收费,3-全部退费,9-收费/退费异常；住院：0-记帐划价,1-部分记帐/销账,2-全部记帐,3-全部销账
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_门诊标志 门诊费用记录.门诊标志%Type; --1-门诊，2-住院
  n_记帐标志 Number(2); --0-收费，1-记帐
  v_单据号   Varchar2(32767);

  n_记录性质 门诊费用记录.记录性质%Type;

  n_剩余数量 门诊费用记录.数次%Type;
  n_原始数量 门诊费用记录.数次%Type;
  n_未收数量 门诊费用记录.数次%Type;
  n_异常记录 Number;
  n_Status   Number;

  v_Err_Msg Varchar2(255);
  Err_Item Exception;
  n_Count Number;
Begin
  --获取入参
  Select Nvl(Extractvalue(Value(A), 'IN/MZBZ'), 1), Nvl(Extractvalue(Value(A), 'IN/JZBZ'), 0),
         Extractvalue(Value(A), 'IN/DJH')
  Into n_门诊标志, n_记帐标志, v_单据号
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_单据号 Is Null Then
    v_Err_Msg := '未传入单据信息，获取费用状态失败！';
    Raise Err_Item;
  End If;

  If Nvl(n_门诊标志, 0) = 1 Then
    --门诊
    n_记录性质 := 1;
    If n_记帐标志 = 1 Then
      n_记录性质 := 2;
    End If;
  
    Select /*+Cardinality(b,10)*/
     Sum(Nvl(a.付数, 1) * a.数次) As 剩余数量,
     Sum(Decode(a.记录性质, n_记录性质, 1, 0) * Decode(a.记录状态, 2, 0, 1) * Nvl(a.付数, 1) * a.数次) As 原始数量,
     Sum(Decode(a.记录性质, n_记录性质, 1, 0) *
          Decode(a.结帐id, Null, 1, Decode(a.记录状态, 0, 1, 1, Decode(Nvl(a.费用状态, 0), 1, 1, 0), 0)) * Nvl(a.付数, 1) * a.数次) As 未收数量,
     Sum(Decode(Nvl(a.费用状态, 0), 1, 1, 0)) As 异常记录, Count(1)
    Into n_剩余数量, n_原始数量, n_未收数量, n_异常记录, n_Count
    From 门诊费用记录 A, Table(f_Str2List(v_单据号)) B
    Where a.No = b.Column_Value And Mod(a.记录性质, 10) = n_记录性质;
  
    If Nvl(n_异常记录, 0) > 0 Then
      n_Status := 9; --收费/退费异常
    Else
      If Nvl(n_Count, 0) = 0 Then
        n_Status := 2; --无记录，全部收费
      Elsif Nvl(n_原始数量, 0) = Nvl(n_未收数量, 0) Then
        n_Status := 0; --未收费
      Elsif Nvl(n_原始数量, 0) = Nvl(n_剩余数量, 0) And Nvl(n_未收数量, 0) = 0 Then
        n_Status := 2; --全部收费
      Elsif Nvl(n_剩余数量, 0) = 0 Then
        n_Status := 3; --全部退费
      Else
        n_Status := 1; --部分收费/退费
      End If;
    End If;
  Else
    --住院
    Select /*+Cardinality(b,10)*/
     Sum(Nvl(a.付数, 1) * a.数次) As 剩余数量, Sum(Decode(a.记录状态, 2, 0, 1) * Nvl(a.付数, 1) * a.数次) As 原始数量,
     Sum(Decode(a.记录状态, 0, 1, 0) * Nvl(a.付数, 1) * a.数次) As 未收数量, Count(1)
    Into n_剩余数量, n_原始数量, n_未收数量, n_Count
    From 住院费用记录 A, Table(f_Str2List(v_单据号)) B
    Where a.No = b.Column_Value And a.记录性质 = 2;
  
    If Nvl(n_Count, 0) = 0 Then
      n_Status := 2; --无记录，全部记帐
    Elsif Nvl(n_原始数量, 0) = Nvl(n_未收数量, 0) Then
      n_Status := 0; --记帐划价
    Elsif Nvl(n_原始数量, 0) = Nvl(n_剩余数量, 0) And Nvl(n_未收数量, 0) = 0 Then
      n_Status := 2; --全部记帐
    Elsif Nvl(n_剩余数量, 0) = 0 Then
      n_Status := 3; --全部销账
    Else
      n_Status := 1; --部分记帐/销账
    End If;
  End If;

  Xml_Out := Xmltype('<OUTPUT><FYZT>' || n_Status || '</FYZT></OUTPUT>');
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getexesstatusbyno;
/
Create Or Replace Procedure Zl_Third_Unexecuteexesbyno
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:按单据取消费用执行
  --入参:Xml_In:
  --<IN>
  --  <MZBZ></MZBZ>   //门诊标志，1-门诊，2-住院
  --  <JZBZ></JZBZ>   //记帐标志，0-收费，1-记帐
  --  <DJH></DJH>     //单据号,多个用英文逗号分隔
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --   <RESULT></RESULT> //true-表示成功;false-表示失败
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_门诊标志 门诊费用记录.门诊标志%Type; --1-门诊，2-住院
  n_记帐标志 Number(2); --0-收费，1-记帐
  v_单据号   Varchar2(32767);
  v_Nos      Varchar2(32767);

  v_Err_Msg Varchar2(255);
  Err_Item Exception;
Begin
  --获取入参
  Select Nvl(Extractvalue(Value(A), 'IN/MZBZ'), 1), Nvl(Extractvalue(Value(A), 'IN/JZBZ'), 0),
         Extractvalue(Value(A), 'IN/DJH')
  Into n_门诊标志, n_记帐标志, v_单据号
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_单据号 Is Null Then
    v_Err_Msg := '未传入单据信息，取消费用执行失败！';
    Raise Err_Item;
  End If;

  If Nvl(n_门诊标志, 0) = 1 Then
    Select /*+Cardinality(a,10)*/
     f_List2Str(Cast(Collect(a.Column_Value) As t_StrList), '、')
    Into v_Nos
    From Table(f_Str2List(v_单据号)) A
    Where Not Exists (Select 1 From 门诊费用记录 Where 记录性质 = Decode(n_记帐标志, 1, 2, 1) And NO = a.Column_Value);
  Else
    Select /*+Cardinality(a,10)*/
     f_List2Str(Cast(Collect(a.Column_Value) As t_StrList), '、')
    Into v_Nos
    From Table(f_Str2List(v_单据号)) A
    Where Not Exists (Select 1 From 住院费用记录 Where 记录性质 = 2 And NO = a.Column_Value);
  End If;
  If v_Nos Is Not Null Then
    v_Err_Msg := '单据【' || v_Nos || '】不存在，可能已经被他人删除，取消费用执行失败！';
    Raise Err_Item;
  End If;

  For r_No In (Select Column_Value As NO From Table(f_Str2List(v_单据号))) Loop
    If n_记帐标志 = 1 Then
      Zl_病人费用记录_Unexecute(r_No.No, 2, '', n_门诊标志, 1);
    Else
      Zl_病人费用记录_Unexecute(r_No.No, 1, '', n_门诊标志, 1);
    End If;
  End Loop;

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Unexecuteexesbyno;
/
Create Or Replace Procedure Zl_Third_Getorderfee
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:根据医嘱id获取医嘱对应的费用记录(包括生成的主费用和附加费用)
  --入参:Xml_In
  --  <IN>
  --    <YZID>12563,23568</YZID>  //医嘱ID，多个用英文逗号分隔
  --  </IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <FYLIST>
  --    <ITEM jsonArray='true'>
  --      <FYLX></FYLX>  //费用类型：0-主费用，1-附加费用
  --      <FYXZ></FYXZ>  //费用性质：1-收费，2-记帐
  --      <FYZT></FYZT>  //费用状态，收费：0-未收费,1-已收费,2-全部退费,3-部分退费,9-收费/退费异常；记帐：0-记帐划价,1-已记帐,2-全部销账,3-部分销账
  --      <NO></NO>  //单据号
  --      <XMID></XMID>  //收费项目ID
  --      <XMMC></XMMC>  //收费项目名称
  --      <GG></GG>  //规格
  --      <SL></SL>  //数量
  --      <DW></DW>  //单位
  --      <DJ></DJ>  //标准单价
  --      <YSJE></YSJE>  //应收金额
  --      <SSJE></SSJE>  //实收金额
  --      <FSSJ></FSSJ>  //发生时间
  --      <KDR></KDR>  //开单人姓名
  --      <CZY></CZY>  //操作员姓名
  --      <KDKS></KDKS>  //开单科室名称
  --      <ZXKS></ZXKS>  //执行科室名称
  --      <ZXZT></ZXZT>  //执行状态：0-未执行,1-完全执行,2-部分执行
  --    </ITEM>
  --    ...
  --  </FYLIST>
  --</OUTPUT>
  --说明：
  --费用状态，门诊：0-未收费,1-已收费,2-全部退费,3-部分退费,9-收费/退费异常；住院：0-记帐划价,1-已记帐,2-全部销账,3-部分销账
  --  0)费用记录.费用状态=1，则费用状态=9
  --  1)费用记录.记录状态=0，则费用状态=0
  --  2)费用记录.剩余数量=0，则费用状态=2
  --  3)费用记录.剩余数量=费用记录.原始数量，则费用状态=1
  --  4)其它，则费用状态=3
  --------------------------------------------------------------------------------------------------
  v_医嘱ids Varchar2(32767);
Begin
  --获取入参
  Select Extractvalue(Value(A), 'IN/YZID') Into v_医嘱ids From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Xmlelement("OUTPUT",
                     Xmlforest(Xmlagg(Xmlelement("ITEM", Xmlattributes('true' As "jsonArray"),
                                                  Xmlforest(a.费用类型 As "FYLX", a.记录性质 As "FYXZ", a.费用状态 As "FYZT",
                                                             a.单据号 As "NO", a.收费细目id As "XMID", a.收费项目名称 As "XMMC",
                                                             a.规格 As "GG", a.数量 As "SL", a.计算单位 As "DW", a.标准单价 As "DJ",
                                                             a.应收金额 As "YSJE", a.实收金额 As "SSJE", a.发生时间 As "FSSJ",
                                                             a.开单人 As "KDR", a.操作员姓名 As "CZY", a.开单科室 As "KDKS",
                                                             a.执行科室 As "ZXKS", a.执行状态 As "ZXZT"))) As "FYLIST"))
  Into Xml_Out
  From (Select a.费用类型, a.记录性质, a.No As 单据号, a.收费细目id, c.名称 As 收费项目名称, c.规格, a.计算单位, Avg(a.标准单价) As 标准单价,
                Sum(Decode(a.记录状态, 2, 0, a.数量)) As 数量, Sum(Decode(a.记录状态, 2, 0, a.应收金额)) As 应收金额,
                Sum(Decode(a.记录状态, 2, 0, a.实收金额)) As 实收金额, To_Char(a.发生时间, 'yyyy-mm-dd hh24:mi:ss') As 发生时间, a.开单人,
                a.操作员姓名, f.名称 As 开单科室, d.名称 As 执行科室, Max(a.执行状态) As 执行状态,
                Decode(Min(a.记录状态), 0, 0, Decode(Sum(a.数量), 0, 2, Sum(Decode(a.记录状态, 2, 0, a.数量)), 1, 3)) As 费用状态


         
         From (
              --先处理一个收费项目多个收入项目的情况
              With 医嘱费用 As (
                            --01.主费用
                            --特殊：只传入了主医嘱ID，将相关医嘱一起查询出来
                            Select 0 As 费用类型, 医嘱id, 记录性质, NO
                            From 病人医嘱发送
                            Where 医嘱id In (Select /*+cardinality(j,10)*/
                                            a.Id
                                           From 病人医嘱记录 A, Table(f_Num2list(v_医嘱ids)) J
                                           Where a.Id = j.Column_Value Or a.相关id = j.Column_Value)
                            --02.附加费用
                            Union All
                            Select 1 As 费用类型, 医嘱id, 记录性质, NO
                            From 病人医嘱附费
                            Where 医嘱id In (Select /*+cardinality(j,10)*/
                                            a.Id
                                           From 病人医嘱记录 A, Table(f_Num2list(v_医嘱ids)) J
                                           Where a.Id = j.Column_Value Or a.相关id = j.Column_Value))
              --1.住院费用
                Select b.费用类型, a.记录性质, a.No, a.记录状态, a.收费细目id, a.计算单位, Sum(a.标准单价) As 标准单价, Avg(Nvl(a.付数, 1) * a.数次) As 数量,
                       Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额, a.发生时间, a.开单人, a.开单部门id, a.执行部门id, a.执行状态, a.操作员姓名
                From 住院费用记录 A, 医嘱费用 B
                Where a.医嘱序号 = b.医嘱id And a.No = b.No And a.记录性质 = b.记录性质
                Group By b.费用类型, a.记录性质, a.No, a.记录状态, Nvl(a.价格父号, a.序号), a.收费细目id, a.计算单位, a.发生时间, a.开单人, a.开单部门id,
                         a.执行部门id, a.执行状态, a.操作员姓名
                --2.门诊费用
                Union All
                Select b.费用类型, Mod(a.记录性质, 10) As 记录性质, a.No, a.记录状态, a.收费细目id, a.计算单位, Sum(a.标准单价) As 标准单价,
                       Avg(Nvl(a.付数, 1) * a.数次) As 数量, Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额, a.发生时间, a.开单人, a.开单部门id,
                       a.执行部门id, a.执行状态, a.操作员姓名
                From 门诊费用记录 A, 医嘱费用 B
                Where a.医嘱序号 = b.医嘱id And a.No = b.No And Mod(a.记录性质, 10) = b.记录性质
                Group By b.费用类型, Mod(a.记录性质, 10), a.No, a.记录状态, Nvl(a.价格父号, a.序号), a.收费细目id, a.计算单位, a.发生时间, a.开单人,
                         a.开单部门id, a.执行部门id, a.执行状态, a.操作员姓名
                
                ) A, 收费项目目录 C, 部门表 D, 部门表 F
                Where a.收费细目id = c.Id And a.执行部门id = d.Id And a.开单部门id = f.Id
                Group By a.费用类型, a.记录性质, a.No, a.收费细目id, c.名称, c.规格, a.计算单位, a.发生时间, a.开单人, f.名称, d.名称, a.操作员姓名
                Order By a.费用类型, a.No
         ) A;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getorderfee;
/
Create Or Replace Procedure Zl_Third_Getpatifee
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:根据病人id等条件获取费用记录(包括医嘱生成的主费用和附加费用、以及手工记帐费用)
  --入参:Xml_In
  --<IN>
  --  <PATIID>732580</PATIID>  //病人ID
  --  <MZBZ>732580</MZBZ>  //门诊标志：1-门诊,2-住院
  --  <JZID>1</JZID>  //住院的主页id，门诊的挂号id
  --  <ZLLB>D,H,M</ZLLB>  //诊疗类别，多个用英文逗号分隔，为空表示所有：诊疗项目类别.编码
  --  <CZLX>病理,其他</CZLX>  //操作类型，多个用英文逗号分隔，为空表示所有：病理,其他,…
  --  <ZXKSID></ZXKSID>  //执行科室ID，仅用于查找手工记帐/划价费用，多个用英文逗号分隔，为空表示所有
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <FYLIST>
  --    <ITEM jsonArray='true'>
  --      <FYLX></FYLX>  //费用类型：0-主费用，1-附加费用，2-手工记帐/划价费用
  --      <FYXZ></FYXZ>  //费用性质：1-收费，2-记帐
  --      <FYZT></FYZT>  //费用状态，收费：0-未收费,1-已收费,2-全部退费,3-部分退费,9-收费/退费异常；记帐：0-记帐划价,1-已记帐,2-全部销账,3-部分销账
  --      <NO></NO>  //单据号
  --      <XMID></XMID>  //收费项目ID
  --      <XMMC></XMMC>  //收费项目名称
  --      <GG></GG>  //规格
  --      <SL></SL>  //数量
  --      <DW></DW>  //单位
  --      <DJ></DJ>  //标准单价
  --      <YSJE></YSJE>  //应收金额
  --      <SSJE></SSJE>  //实收金额
  --      <FSSJ></FSSJ>  //发生时间
  --      <KDR></KDR>  //开单人姓名
  --      <CZY></CZY>  //操作员姓名
  --      <KDKS></KDKS>  //开单科室名称
  --      <ZXKS></ZXKS>  //执行科室名称
  --      <ZXZT></ZXZT>  //执行状态：0-未执行,1-完全执行,2-部分执行
  --      <JCXM></JCXM>  //检查项目：诊疗项目目录.名称
  --    </ITEM>
  --    ...
  --  </FYLIST>
  --</OUTPUT>
  --说明：
  --费用状态，门诊：0-未收费,1-已收费,2-全部退费,3-部分退费,9-收费/退费异常；住院：0-记帐划价,1-已记帐,2-全部销账,3-部分销账
  --  0)费用记录.费用状态=1，则费用状态=9
  --  1)费用记录.记录状态=0，则费用状态=0
  --  2)费用记录.剩余数量=0，则费用状态=2
  --  3)费用记录.剩余数量=费用记录.原始数量，则费用状态=1
  --  4)其它，则费用状态=3
  --------------------------------------------------------------------------------------------------
  n_门诊标志 Number(2); --1-门诊,2-住院
  n_病人id   病人信息.病人id%Type;
  n_就诊id   Number(18);

  v_诊疗类别s   Varchar2(32767); --多个用英文逗号分隔，为空表示所有：诊疗项目类别.编码
  v_操作类型s   Varchar2(32767); --多个用英文逗号分隔，为空表示所有：病理,其他,…
  v_执行科室ids Varchar2(32767); --仅用于查找手工记帐/划价费用，多个用英文逗号分隔，为空表示所有
Begin
  --获取入参
  Select Extractvalue(Value(A), 'IN/PATIID'), Extractvalue(Value(A), 'IN/MZBZ'), Extractvalue(Value(A), 'IN/JZID'),
         Extractvalue(Value(A), 'IN/ZLLB'), Extractvalue(Value(A), 'IN/CZLX'), Extractvalue(Value(A), 'IN/ZXKSID')
  Into n_病人id, n_门诊标志, n_就诊id, v_诊疗类别s, v_操作类型s, v_执行科室ids
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_门诊标志, 0) = 1 Then
    --门诊
    Select Xmlelement("OUTPUT",
                       Xmlforest(Xmlagg(Xmlelement("ITEM", Xmlattributes('true' As "jsonArray"),
                                                    Xmlforest(a.费用类型 As "FYLX", a.记录性质 As "FYXZ", a.费用状态 As "FYZT",
                                                               a.单据号 As "NO", a.收费细目id As "XMID", a.收费项目名称 As "XMMC",
                                                               a.规格 As "GG", a.数量 As "SL", a.计算单位 As "DW", a.标准单价 As "DJ",
                                                               a.应收金额 As "YSJE", a.实收金额 As "SSJE", a.发生时间 As "FSSJ",
                                                               a.开单人 As "KDR", a.操作员姓名 As "CZY", a.开单科室 As "KDKS",
                                                               a.执行科室 As "ZXKS", a.执行状态 As "ZXZT", a.检查项目 As "JCXM"))) As
                                  "FYLIST"))
    Into Xml_Out
    From (Select a.费用类型, a.记录性质, a.No As 单据号, a.收费细目id, c.名称 As 收费项目名称, c.规格, a.计算单位, Avg(a.标准单价) As 标准单价,
                  Sum(Decode(a.记录状态, 2, 0, a.数量)) As 数量, Sum(Decode(a.记录状态, 2, 0, a.应收金额)) As 应收金额,
                  Sum(Decode(a.记录状态, 2, 0, a.实收金额)) As 实收金额, To_Char(a.发生时间, 'yyyy-mm-dd hh24:mi:ss') As 发生时间, a.开单人,
                  a.操作员姓名, f.名称 As 开单科室, d.名称 As 执行科室, Max(a.执行状态) As 执行状态,
                  Decode(Max(a.费用状态), 1, 9,
                          Decode(Min(a.记录状态), 0, 0, Decode(Sum(a.数量), 0, 2, Sum(Decode(a.记录状态, 2, 0, a.数量)), 1, 3))) As 费用状态,
                  a.检查项目
           From (
                --先处理一个收费项目多个收入项目的情况
                With 医嘱费用 As (
                              --01.主费用
                              Select 0 As 费用类型, a.医嘱id, a.记录性质, a.No, c.名称 As 检查项目
                              From 病人医嘱发送 A, 病人医嘱记录 B, 诊疗项目目录 C
                              Where a.医嘱id = b.Id And b.诊疗项目id = c.Id And
                                    (v_诊疗类别s Is Null Or Instr(',' || v_诊疗类别s || ',', ',' || c.类别 || ',') > 0) And
                                    (v_操作类型s Is Null Or Instr(',' || v_操作类型s || ',', ',' || c.操作类型 || ',') > 0) And
                                    b.挂号单 In (Select NO From 病人挂号记录 Where ID = n_就诊id) And b.病人id = n_病人id
                              --02.附加费用
                              Union All
                              Select 1 As 费用类型, d.医嘱id, d.记录性质, d.No, c.名称 As 检查项目
                              From 病人医嘱发送 A, 病人医嘱记录 B, 诊疗项目目录 C, 病人医嘱附费 D
                              Where a.医嘱id = b.Id And d.医嘱id = a.医嘱id And d.发送号 = a.发送号 And b.诊疗项目id = c.Id And
                                    (v_诊疗类别s Is Null Or Instr(',' || v_诊疗类别s || ',', ',' || c.类别 || ',') > 0) And
                                    (v_操作类型s Is Null Or Instr(',' || v_操作类型s || ',', ',' || c.操作类型 || ',') > 0) And
                                    b.挂号单 In (Select NO From 病人挂号记录 Where ID = n_就诊id) And b.病人id = n_病人id)
                --医嘱主费用/附加费用
                  Select b.费用类型, Mod(a.记录性质, 10) As 记录性质, a.No, a.记录状态, a.收费细目id, a.计算单位, Sum(a.标准单价) As 标准单价,
                         Avg(Nvl(a.付数, 1) * a.数次) As 数量, Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额, a.发生时间, a.开单人, a.开单部门id,
                         a.执行部门id, a.执行状态, a.操作员姓名, b.检查项目, Max(a.费用状态) As 费用状态
                  From 门诊费用记录 A, 医嘱费用 B
                  Where a.医嘱序号 = b.医嘱id And a.No = b.No And Mod(a.记录性质, 10) = b.记录性质
                  Group By b.费用类型, Mod(a.记录性质, 10), a.No, a.记录状态, Nvl(a.价格父号, a.序号), a.收费细目id, a.计算单位, a.发生时间, a.开单人,
                           a.开单部门id, a.执行部门id, a.执行状态, a.操作员姓名, b.检查项目
                  --手工划价收费费用
                  Union All
                  Select 2 As 费用类型, Mod(a.记录性质, 10) As 记录性质, a.No, a.记录状态, a.收费细目id, a.计算单位, Sum(a.标准单价) As 标准单价,
                         Avg(Nvl(a.付数, 1) * a.数次) As 数量, Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额, a.发生时间, a.开单人, a.开单部门id,
                         a.执行部门id, a.执行状态, a.操作员姓名, '' As 检查项目, Max(a.费用状态) As 费用状态
                  From 门诊费用记录 A
                  Where a.医嘱序号 Is Null And a.记录性质 In (1, 11, 2) And
                        (v_执行科室ids Is Null Or Instr(',' || v_执行科室ids || ',', ',' || a.执行部门id || ',') > 0) And
                        a.病人id = n_病人id
                  Group By Mod(a.记录性质, 10), a.No, a.记录状态, Nvl(a.价格父号, a.序号), a.收费细目id, a.计算单位, a.发生时间, a.开单人, a.开单部门id,
                           a.执行部门id, a.执行状态, a.操作员姓名
                  
                  ) A, 收费项目目录 C, 部门表 D, 部门表 F
                  Where a.收费细目id = c.Id And a.执行部门id = d.Id And a.开单部门id = f.Id
                  Group By a.费用类型, a.记录性质, a.No, a.收费细目id, c.名称, c.规格, a.计算单位, a.发生时间, a.开单人, f.名称, d.名称, a.操作员姓名, a.检查项目
                  Order By a.费用类型, a.No
           ) A;
  Else
    --住院
    Select Xmlelement("OUTPUT",
                       Xmlforest(Xmlagg(Xmlelement("ITEM", Xmlattributes('true' As "jsonArray"),
                                                    Xmlforest(a.费用类型 As "FYLX", a.记录性质 As "FYXZ", a.费用状态 As "FYZT",
                                                               a.单据号 As "NO", a.收费细目id As "XMID", a.收费项目名称 As "XMMC",
                                                               a.规格 As "GG", a.数量 As "SL", a.计算单位 As "DW", a.标准单价 As "DJ",
                                                               a.应收金额 As "YSJE", a.实收金额 As "SSJE", a.发生时间 As "FSSJ",
                                                               a.开单人 As "KDR", a.操作员姓名 As "CZY", a.开单科室 As "KDKS",
                                                               a.执行科室 As "ZXKS", a.执行状态 As "ZXZT", a.检查项目 As "JCXM"))) As
                                  "FYLIST"))
    Into Xml_Out
    From (Select a.费用类型, a.记录性质, a.No As 单据号, a.收费细目id, c.名称 As 收费项目名称, c.规格, a.计算单位, Avg(a.标准单价) As 标准单价,
                  Sum(Decode(a.记录状态, 2, 0, a.数量)) As 数量, Sum(Decode(a.记录状态, 2, 0, a.应收金额)) As 应收金额,
                  Sum(Decode(a.记录状态, 2, 0, a.实收金额)) As 实收金额, To_Char(a.发生时间, 'yyyy-mm-dd hh24:mi:ss') As 发生时间, a.开单人,
                  a.操作员姓名, f.名称 As 开单科室, d.名称 As 执行科室, Max(a.执行状态) As 执行状态,
                  Decode(Min(a.记录状态), 0, 0, Decode(Sum(a.数量), 0, 2, Sum(Decode(a.记录状态, 2, 0, a.数量)), 1, 3)) As 费用状态,
                  a.检查项目
           From (
                --先处理一个收费项目多个收入项目的情况
                With 医嘱费用 As (
                              --01.主费用
                              Select 0 As 费用类型, a.医嘱id, a.记录性质, a.No, c.名称 As 检查项目
                              From 病人医嘱发送 A, 病人医嘱记录 B, 诊疗项目目录 C
                              Where a.医嘱id = b.Id And b.诊疗项目id = c.Id And
                                    (v_诊疗类别s Is Null Or Instr(',' || v_诊疗类别s || ',', ',' || c.类别 || ',') > 0) And
                                    (v_操作类型s Is Null Or Instr(',' || v_操作类型s || ',', ',' || c.操作类型 || ',') > 0) And
                                    b.病人id = n_病人id And b.主页id = n_就诊id
                              --02.附加费用
                              Union All
                              Select 1 As 费用类型, d.医嘱id, d.记录性质, d.No, c.名称 As 检查项目
                              From 病人医嘱发送 A, 病人医嘱记录 B, 诊疗项目目录 C, 病人医嘱附费 D
                              Where a.医嘱id = b.Id And d.医嘱id = a.医嘱id And d.发送号 = a.发送号 And b.诊疗项目id = c.Id And
                                    (v_诊疗类别s Is Null Or Instr(',' || v_诊疗类别s || ',', ',' || c.类别 || ',') > 0) And
                                    (v_操作类型s Is Null Or Instr(',' || v_操作类型s || ',', ',' || c.操作类型 || ',') > 0) And
                                    b.病人id = n_病人id And b.主页id = n_就诊id)
                --医嘱主费用/附加费用
                  Select b.费用类型, a.记录性质, a.No, a.记录状态, a.收费细目id, a.计算单位, Sum(a.标准单价) As 标准单价,
                         Avg(Nvl(a.付数, 1) * a.数次) As 数量, Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额, a.发生时间, a.开单人, a.开单部门id,
                         a.执行部门id, a.执行状态, a.操作员姓名, b.检查项目
                  From 住院费用记录 A, 医嘱费用 B
                  Where a.医嘱序号 = b.医嘱id And a.No = b.No And a.记录性质 = b.记录性质
                  Group By b.费用类型, a.记录性质, a.No, a.记录状态, Nvl(a.价格父号, a.序号), a.收费细目id, a.计算单位, a.发生时间, a.开单人, a.开单部门id,
                           a.执行部门id, a.执行状态, a.操作员姓名, b.检查项目
                  --手工记帐费用
                  Union All
                  Select 2 As 费用类型, a.记录性质, a.No, a.记录状态, a.收费细目id, a.计算单位, Sum(a.标准单价) As 标准单价,
                         Avg(Nvl(a.付数, 1) * a.数次) As 数量, Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额, a.发生时间, a.开单人, a.开单部门id,
                         a.执行部门id, a.执行状态, a.操作员姓名, '' As 检查项目
                  From 住院费用记录 A
                  Where a.医嘱序号 Is Null And 记录性质 = 2 And
                        (v_执行科室ids Is Null Or Instr(',' || v_执行科室ids || ',', ',' || a.执行部门id || ',') > 0) And
                        a.病人id = n_病人id And a.主页id = n_就诊id
                  Group By a.记录性质, a.No, a.记录状态, Nvl(a.价格父号, a.序号), a.收费细目id, a.计算单位, a.发生时间, a.开单人, a.开单部门id, a.执行部门id,
                           a.执行状态, a.操作员姓名
                  
                  ) A, 收费项目目录 C, 部门表 D, 部门表 F
                  Where a.收费细目id = c.Id And a.执行部门id = d.Id And a.开单部门id = f.Id
                  Group By a.费用类型, a.记录性质, a.No, a.收费细目id, c.名称, c.规格, a.计算单位, a.发生时间, a.开单人, f.名称, d.名称, a.操作员姓名, a.检查项目
                  Order By a.费用类型, a.No
           ) A;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpatifee;
/
Create Or Replace Procedure Zl_Third_Paymentcheck
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is

  --------------------------------------------------------------------------------------------------
  --功能:三方接口支付检查
  --入参:Xml_In:
  --<IN>
  --  <NO></NO>                       //收费单据号串,逗号分隔多个单据号
  --  <BRID>病人ID</BRID>             //病人ID
  --  <XM>姓名</XM>                   //姓名
  --  <SFZH>身份证号</SFZH>           //身份证号
  --  <SFGH></SFGH>                   //是否挂号单
  --</IN>

  --出参:Xml_Out
  --对于有病人合并的，格式如下：
  --<OUTPUT>
  --  <TYPE>1</TYPE>        //类型，1表示返回病人合并信息。目前只有1,以后可以扩展。对于合并病人，需要以新病人ID再调一次
  --  <YBRID></YBRID>       //原病人ID
  --  <XBRID></XBRID>       //现病人ID
  --  <XM></XM>             //现姓名
  --  <SFZ></SFZ>           //现身份证
  --</OUTPUT>
  --其它：
  --<OUTPUT>
  -- <JZYJZF></JZYJZF>     //禁止预交支付
  -- <ERROR><MSG></MSG></ERROR> //为空表示检查成功
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Nos      Varchar2(4000);
  n_病人id   门诊费用记录.病人id%Type;
  n_是否挂号 Number(1);
  v_身份证号 病人信息.身份证号%Type;
  v_姓名     门诊费用记录.姓名%Type;

  v_操作员姓名 门诊费用记录.操作员姓名%Type;
  n_合并病人   Number(1);

  v_Temp   Varchar2(32767); --临时XML
  n_Count  Number;
  n_Exists Number;

  Procedure Get_Errmsg
  (
    Errmsg_In Varchar2,
    Xml_Out   Out Xmltype
  ) Is
    v_Temp Varchar2(4000);
  Begin
    v_Temp  := '<MSG>' || Errmsg_In || '</MSG>';
    v_Temp  := '<ERROR>' || v_Temp || '</ERROR>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
  End;
Begin
  Select Extractvalue(Value(A), 'IN/NO'), To_Number(Extractvalue(Value(A), 'IN/BRID')),
         To_Number(Extractvalue(Value(A), 'IN/SFGH')), Extractvalue(Value(A), 'IN/SFZH'),
         Extractvalue(Value(A), 'IN/XM')
  Into v_Nos, n_病人id, n_是否挂号, v_身份证号, v_姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_Nos Is Null Then
    Get_Errmsg('没有指定相关的收费单据,不允许缴费!', Xml_Out);
    Return;
  End If;

  n_合并病人 := Zl_Third_Get_Mergepatiinfo(n_病人id, Xml_Out);
  If Nvl(n_合并病人, 0) = 1 Then
    Return;
  End If;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;

  If Nvl(n_病人id, 0) = 0 Then
    Get_Errmsg('不能有效识别病人身份,不允许缴费!', Xml_Out);
    Return;
  End If;

  Select Count(1) Into n_Count From 病人信息 A Where a.病人id = n_病人id;
  If n_Count = 0 Then
    Get_Errmsg('指定的缴费单据中不能有效识别病人,不允许缴费!', Xml_Out);
    Return;
  End If;

  For c_No In (Select Column_Value As NO From Table(f_Str2List(v_Nos))) Loop
    If Nvl(n_是否挂号, 0) = 0 Then
      Select Count(1)
      Into n_Count
      From 门诊费用记录
      Where 记录性质 = 1 And 结帐id Is Null And NO = c_No.No And 操作员姓名 Is Null;
      If n_Count = 0 Then
        Select Max(操作员姓名) Into v_操作员姓名 From 门诊费用记录 Where 记录性质 = 1 And NO = c_No.No;
        If v_操作员姓名 Is Not Null Then
          Get_Errmsg('不能读取划价单[' || c_No.No || ']内容，该单据已经被收费！', Xml_Out);
          Return;
        Else
          Get_Errmsg('不能读取划价单[' || c_No.No || ']内容，该单据已经被删除！', Xml_Out);
          Return;
        End If;
      End If;
    Else
      --挂号单据
      Select Count(1) Into n_Count From 门诊费用记录 Where NO = c_No.No And 记录性质 = 4;
      If n_Count = 0 Then
        Get_Errmsg('没有找到指定的单据[' || c_No.No || ']数据！', Xml_Out);
        Return;
      End If;
    End If;
  End Loop;

  Xml_Out := Xmltype('<OUTPUT></OUTPUT>');

  n_Exists := To_Number(Nvl(zl_GetSysParameter(323), '0'));
  If n_Exists <> 0 Then
    Select Count(1)
    Into n_Count
    From 病案主页 A, 病人信息 B
    Where a.病人id = n_病人id And a.病人性质 = 1 And a.病人id = b.病人id And a.主页id = b.主页id And Nvl(b.在院, 0) = 1;
    If n_Count <> 0 Then
      Xml_Out := Xmltype('<OUTPUT><JZYJZF>1</JZYJZF></OUTPUT>');
    End If;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Paymentcheck;
/
Create Or Replace Procedure Zl_Third_Settlementcheck
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:三方接口支付检查 
  --入参:Xml_In: 
  --<IN> 
  --  <BRID>病人ID</BRID>         //病人ID 
  --  <ZYID>主页ID</ZYID>         //主页ID 
  --  <XM>姓名</XM>               //姓名 
  --  <SFZH>身份证号</SFZH>       //身份证号 
  --  <ZYID>主页ID</ZYID>         //主页ID 
  --</IN> 

  --出参:Xml_Out 
  --对于有病人合并的，格式如下： 
  --<OUTPUT> 
  --  <TYPE>1</TYPE>        //类型，1表示返回病人合并信息。目前只有1,以后可以扩展 
  --  <YBRID></YBRID>       //原病人ID 
  --  <XBRID></XBRID>       //现病人ID 
  --  <XM></XM>             //现姓名 
  --  <SFZ></SFZ>           //现身份证 
  --</OUTPUT> 
  --其它： 
  --<OUTPUT> 
  -- <ERROR><MSG></MSG></ERROR> //为空表示检查成功 
  --</OUTPUT> 
  -------------------------------------------------------------------------------------------------- 
  n_病人id   病案主页.病人id%Type;
  n_主页id   病案主页.主页id%Type;
  v_姓名     病人信息.姓名%Type;
  v_身份证号 病人信息.身份证号%Type;

  n_合并病人 Number(1);
  n_Count    Number;

  Procedure Get_Errmsg
  (
    Errmsg_In Varchar2,
    Xml_Out   Out Xmltype
  ) Is
    v_Temp Varchar2(4000);
  Begin
    v_Temp  := '<MSG>' || Errmsg_In || '</MSG>';
    v_Temp  := '<ERROR>' || v_Temp || '</ERROR>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
  End;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/BRID')), Extractvalue(Value(A), 'IN/ZYID'),
         Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM')
  Into n_病人id, n_主页id, v_身份证号, v_姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  n_合并病人 := Zl_Third_Get_Mergepatiinfo(n_病人id, Xml_Out);
  If Nvl(n_合并病人, 0) = 1 Then
    Return;
  End If;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;

  If Nvl(n_病人id, 0) = 0 Then
    Get_Errmsg('不能有效识别病人身份，不允许结算!', Xml_Out);
    Return;
  End If;

  If Nvl(n_主页id, 0) = 0 Then
    Select Count(1) Into n_Count From 病人信息 A Where a.病人id = n_病人id;
  Else
    Select Count(1) Into n_Count From 病案主页 A Where a.病人id = n_病人id And a.主页id = n_主页id;
  End If;
  If n_Count = 0 Then
    Get_Errmsg('不能有效识别病人身份，不允许结算！', Xml_Out);
    Return;
  End If;

  Xml_Out := Xmltype('<OUTPUT></OUTPUT>');
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Settlementcheck;
/
Create Or Replace Procedure Zl_Third_Depositcheck
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:预交款充值检查 
  --入参:Xml_In: 
  --    <IN> 
  --        <BRID>病人ID</BRID> 
  --        <ZYID>主页ID</ZYID> 
  --        <XM>姓名</XM> 
  --        <SFZH>身份证号</SFZH> 
  --    </IN> 

  --出参:Xml_Out 
  --对于有病人合并的，格式如下： 
  --<OUTPUT> 
  --  <TYPE>1</TYPE>        //类型，1表示返回病人合并信息。目前只有1,以后可以扩展 
  --  <YBRID></YBRID>       //原病人ID 
  --  <XBRID></XBRID>       //现病人ID 
  --  <XM></XM>             //现姓名 
  --  <SFZ></SFZ>           //现身份证 
  --</OUTPUT> 
  --其它： 
  --<OUTPUT> 
  -- <ERROR><MSG></MSG></ERROR> //为空表示检查成功 
  --</OUTPUT> 
  -------------------------------------------------------------------------------------------------- 
  n_病人id   病人信息.病人id%Type;
  n_主页id   病案主页.主页id%Type;
  v_姓名     病人信息.姓名%Type;
  v_身份证号 病人信息.身份证号%Type;

  n_合并病人 Number(1);
  n_Count    Number;

  Procedure Get_Errmsg
  (
    Errmsg_In Varchar2,
    Xml_Out   Out Xmltype
  ) Is
    v_Temp Varchar2(4000);
  Begin
    v_Temp  := '<MSG>' || Errmsg_In || '</MSG>';
    v_Temp  := '<ERROR>' || v_Temp || '</ERROR>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
  End;
Begin
  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/ZYID'), Extractvalue(Value(A), 'IN/SFZH'),
         Extractvalue(Value(A), 'IN/XM')
  Into n_病人id, n_主页id, v_身份证号, v_姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  n_合并病人 := Zl_Third_Get_Mergepatiinfo(n_病人id, Xml_Out);
  If Nvl(n_合并病人, 0) = 1 Then
    Return;
  End If;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;

  If Nvl(n_病人id, 0) = 0 Then
    Get_Errmsg('不能有效识别病人身份，不允许充值！', Xml_Out);
    Return;
  End If;

  If Nvl(n_主页id, 0) = 0 Then
    Select Count(1) Into n_Count From 病人信息 A Where a.病人id = n_病人id;
  Else
    Select Count(1) Into n_Count From 病案主页 A Where a.病人id = n_病人id And a.主页id = n_主页id;
  End If;
  If n_Count = 0 Then
    Get_Errmsg('不能有效识别病人身份，不允许充值！', Xml_Out);
    Return;
  End If;

  Xml_Out := Xmltype('<OUTPUT></OUTPUT>');
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Depositcheck;
/
Create Or Replace Procedure Zl_Third_Paymentdetail
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取指定单据交易信息详情
  --入参:Xml_In:
  --<IN>
  --    <DJ>单据号,性质|....</DJ> //可以传入多个单据，但必须是同一次结算的
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --    <JSMX> //结算明细,如果为空表示没有找到数据或已全部退费
  --         <MX>
  --            <JSFS></JSFS>   //结算方式
  --            <JE></JE>   //结算金额
  --            <JYLSH></JYLSH>     //交易流水号
  --            <JYSM></JYSM>   //交易说明
  --            <ZFZT></ZFZT>     //支付状态：0-已支付，1-正在支付
  --        </MX>
  --    </JSMX>
  --<ERROR><MSG></MSG></ERROR>          //错误情况返回
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(200);
  Err_Item Exception;

  x_Templet Xmltype; --模板XML
  v_Temp    Varchar2(32767); --临时XML
  v_Nos     Varchar2(4000);
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/DJ') Into v_Nos From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  If v_Nos Is Null Then
    v_Err_Msg := '不能找到指定的收费单据(当前单据为空)！';
    Raise Err_Item;
  End If;

  v_Temp := '';
  For c_结算 In (Select Decode(a.结算方式, Null, '未结金额', Decode(Mod(a.记录性质, 10), 1, '预交款', a.结算方式)) As 结算方式, Sum(a.冲预交) As 冲预交,
                      Max(Decode(a.记录状态, 2, Null, a.交易流水号)) As 交易流水号, Max(Decode(a.记录状态, 2, Null, a.交易说明)) As 交易说明,
                      Max(Decode(a.记录状态, 2, 0, Decode(Nvl(a.校对标志, 0), 1, 1, 0))) As 支付状态
               From 病人预交记录 A
               Where a.结帐id In
                     (Select /*+cardinality(j,10)*/
                       a.结帐id
                      From 门诊费用记录 A, 门诊费用记录 B, 门诊费用记录 C, Table(f_Str2list2(v_Nos, '|', ',')) J
                      Where Mod(a.记录性质, 10) = Mod(b.记录性质, 10) And a.No = b.No And a.序号 = b.序号 And b.结帐id = c.结帐id And
                            Mod(c.记录性质, 10) = j.C2 And c.记录状态 In (1, 3) And c.No = j.C1)
               Group By Decode(a.结算方式, Null, '未结金额', Decode(Mod(a.记录性质, 10), 1, '预交款', a.结算方式)), 关联交易id
               Having Nvl(Sum(a.冲预交), 0) <> 0) Loop
  
    v_Temp := v_Temp || '<MX>';
    v_Temp := v_Temp || '<JSFS>' || c_结算.结算方式 || '</JSFS>';
    v_Temp := v_Temp || '<JE>' || c_结算.冲预交 || '</JE>';
    v_Temp := v_Temp || '<JYLSH>' || c_结算.交易流水号 || '</JYLSH>';
    v_Temp := v_Temp || '<JYSM>' || c_结算.交易说明 || '</JYSM>';
    v_Temp := v_Temp || '<ZFZT>' || c_结算.支付状态 || '</ZFZT>';
    v_Temp := v_Temp || '</MX>';
  End Loop;

  If v_Temp Is Not Null Then
    v_Temp := '<JSMX>' || v_Temp || '</JSMX>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End If;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Paymentdetail;
/
Create Or Replace Procedure Zl_Third_Getexesoverview
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取住院病人费用概况
  --入参:Xml_In
  -- <IN>
  --  <PATIID></PATIID>         --病人ID
  --  <PAGEID></PAGEID>     --主页ID
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <FY>
  --    <YJZE></YJZE> --预交总额
  --    <YJYE></YJYE> --预交余额
  --    <ZJE></ZJE>  --总金额
  --    <WJJE></WJJE> --未结金额
  --    <YJJE></YJJE> --预结金额
  --    <FYYE></FYYE> --费用余额
  --    <DBJE></DBJE> --担保金额
  --  <FY>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_病人id 病人信息.病人id%Type;
  n_主页id 病案主页.主页id%Type;

  n_预交总额 病人预交记录.金额%Type;
  n_预交余额 病人余额.预交余额%Type;
  n_费用余额 病人余额.费用余额%Type;

  n_总金额   住院费用记录.实收金额%Type;
  n_未结金额 住院费用记录.实收金额%Type;
  n_预结金额 住院费用记录.实收金额%Type;
  v_担保金额 Varchar2(30);
  n_担保     病人余额.费用余额%Type;
  n_无限     Number;

  x_Templet Xmltype; --模板XML
Begin
  --获取入参
  Select Extractvalue(Value(A), 'IN/PATIID'),
         Decode(Extractvalue(Value(A), 'IN/PAGEID'), 0, Null, Extractvalue(Value(A), 'IN/PAGEID'))
  Into n_病人id, n_主页id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Nvl(Sum(金额), 0)
  Into n_预交总额
  From 病人预交记录
  Where 记录性质 = 1 And 预交类别 = 2 And 病人id = n_病人id And Nvl(校对标志, 0) = 0;

  Select Nvl(Sum(预交余额), 0) Into n_预交余额 From 病人余额 Where 性质 = 1 And 类型 = 2 And 病人id = n_病人id;

  Select Nvl(Sum(金额), 0) Into n_预结金额 From 保险模拟结算 A Where a.病人id = n_病人id And a.主页id = n_主页id;

  Select Nvl(Sum(a.实收金额), 0), Nvl(Sum(a.实收金额), 0) - Nvl(Sum(a.结帐金额), 0)
  Into n_总金额, n_未结金额
  From 住院费用记录 A
  Where a.病人id = n_病人id And a.主页id = n_主页id And Nvl(a.门诊标志, 0) = 2;

  n_费用余额 := n_预交余额 - n_未结金额 + n_预结金额;

  For Rs_Db In (Select 担保性质, 担保额
                From 病人担保记录
                Where 病人id = n_病人id And 主页id = n_主页id And 删除标志 = 1 And Nvl(到期时间, Sysdate + 1) > Sysdate) Loop
    If Trim(To_Char(Rs_Db.担保额, '9999999990.00')) = '999999999.00' Then
      n_无限 := 1;
      Exit;
    Else
      n_担保 := n_担保 + Rs_Db.担保额;
    End If;
  End Loop;
  If n_无限 = 1 Then
    v_担保金额 := '无限担保';
  Else
    v_担保金额 := Trim(To_Char(n_担保, '9999999990.00'));
  End If;

  Select Xmlelement("OUTPUT",
                     Xmlelement("FY",
                                 Xmlforest(n_预交总额 As "YJZE", n_预交余额 As "YJYE", n_总金额 As "ZJE", n_未结金额 As "WJJE",
                                            n_预结金额 As "YJJE", n_费用余额 As "FYYE", v_担保金额 As "DBJE")))
  Into x_Templet
  From Dual;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getexesoverview;
/
Create Or Replace Procedure Zl_Third_Getexessort
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:获取住院病人费用分类汇总 
  --入参:Xml_In 
  -- <IN> 
  --  <PATIID></PATIID>         --病人ID 
  --  <PAGEID></PAGEID>     --主页ID 
  --</IN> 
  --出参:Xml_Out 
  --<OUTPUT> 
  --  <ZFY></ZFY>    --总费用 
  --  <FYLIST> 
  --    <ITEM> 
  --      <XM></XM> --收据费目 
  --      <JE></JE> --金额 
  --    </ITEM> 
  --  <FYLIST> 
  --</OUTPUT> 
  -------------------------------------------------------------------------------------------------- 
  n_病人id 病人信息.病人id%Type;
  n_主页id 病案主页.主页id%Type;
  n_总费用 住院费用记录.实收金额%Type;

  x_Templet Xmltype; --模板XML 
Begin
  --获取入参 
  Select Extractvalue(Value(A), 'IN/PATIID'),
         Decode(Extractvalue(Value(A), 'IN/PAGEID'), 0, Null, Extractvalue(Value(A), 'IN/PAGEID'))
  Into n_病人id, n_主页id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Nvl(Sum(a.实收金额), 0)
  Into n_总费用
  From 住院费用记录 A
  Where a.病人id = n_病人id And a.主页id = n_主页id And Nvl(a.门诊标志, 0) = 2;

  Select Xmlelement("OUTPUT",
                     Xmlforest(n_总费用 As "ZFY",
                                Xmlagg(Xmlelement("ITEM", Xmlattributes('true' As "jsonArray"),
                                                   Xmlforest(a.收据费目 As "XM", Nvl(Sum(a.实收金额), 0) As "JE"))) As "FYLIST"))
  Into x_Templet
  From 住院费用记录 A
  Where a.病人id = n_病人id And a.主页id = n_主页id And Nvl(a.门诊标志, 0) = 2
  Group By a.收据费目;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getexessort;
/
Create Or Replace Procedure Zl_Third_Saveexes
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:保存费用记录 
  --入参:Xml_In: 
  --<IN> 
  --  <YZID><YZID> //医嘱ID 
  --  <PATIID></PATIID>  //病人ID 
  --  <PAGEID></PAGEID>  //主页ID 
  --  <MZBZ></MZBZ>   //门诊标志，1-门诊，2-住院 
  --  <JZBZ></JZBZ>   //记帐标志，0-收费，1-记帐 
  --  <CZY></CZY>   //操作员 
  --  <CZSJ></CZSJ>   //操作时间 
  --  <KDR></KDR>  //开单人 
  --  <KDKSID></KDKSID>  //开单科室ID 
  --  <YQBH></YQBH>  //院区编号 
  --  <MXLIST> 
  --    <MX> 
  --      <YZID><YZID> //医嘱ID 
  --      <SFXMID></SFXMID>  //收费细目ID 
  --      <SL></SL>   //数次 
  --      <ZXR></ZXR>  //执行人,表示完全执行 
  --      <ZXKSID></ZXKSID>  //执行科室ID 
  --    </MX> 
  --    ... 
  --  </MXLIST> 
  --</IN> 
  --出参:Xml_Out 
  --<OUTPUT> 
  --   <RESULT></RESULT> //true-表示保存成功;false-表示保存失败 
  --   <DJH></DJH>  //单据号 
  --</OUTPUT> 
  --说明：
  --  为了保持兼容，做如下处理：
  --  1.外层 医嘱ID 不传时，必须传入 病人ID、主页ID、门诊标志及记帐标志；
  --  2.外层 医嘱ID 传入时，病人ID、主页ID和门诊标志 根据病人医嘱记录获取；
  --       针对门诊病人，记帐标志 根据主医嘱记录的发送记录确定：记录性质为1则表示划价收费，记录性质为2则表示记帐收费
  -------------------------------------------------------------------------------------------------- 
  n_医嘱id     病人医嘱记录.Id%Type;
  n_病人id     病人信息.病人id%Type;
  n_主页id     病案主页.主页id%Type;
  n_门诊标志   门诊费用记录.门诊标志%Type; --1-门诊，2-住院 
  n_记帐标志   Number(2); --0-收费，1-记帐 
  v_操作员姓名 门诊费用记录.操作员姓名%Type;
  d_操作时间   门诊费用记录.登记时间%Type;
  v_开单人     门诊费用记录.开单人%Type;
  n_开单部门id 门诊费用记录.开单部门id%Type;
  v_站点       部门表.站点%Type;
  Xml_明细列表 Xmltype;

  v_No           门诊费用记录.No%Type;
  n_标识号       门诊费用记录.标识号%Type;
  v_姓名         门诊费用记录.姓名%Type;
  v_性别         门诊费用记录.性别%Type;
  v_年龄         门诊费用记录.年龄%Type;
  v_费别         门诊费用记录.费别%Type;
  v_付款方式编码 门诊费用记录.付款方式%Type;
  v_付款方式名称 病人信息.医疗付款方式%Type;
  n_病区id       住院费用记录.病人病区id%Type;
  n_科室id       门诊费用记录.病人科室id%Type;
  v_床号         住院费用记录.床号%Type;
  v_操作员编号   门诊费用记录.操作员编号%Type;
  d_出院日期     病案主页.出院日期%Type;
  d_入院日期     病案主页.入院日期%Type;

  Type Ty_Rec_Bill Is Record(
    序号       门诊费用记录.序号%Type,
    价格父号   门诊费用记录.价格父号%Type,
    收费细目id 门诊费用记录.收费细目id%Type,
    收费类别   门诊费用记录.收费类别%Type,
    计算单位   门诊费用记录.计算单位%Type,
    收入项目id 门诊费用记录.收入项目id%Type,
    收据费目   门诊费用记录.收据费目%Type,
    数次       门诊费用记录.数次%Type,
    标准单价   门诊费用记录.标准单价%Type,
    应收金额   门诊费用记录.应收金额%Type,
    实收金额   门诊费用记录.实收金额%Type,
    执行人     门诊费用记录.执行人%Type,
    执行部门id 门诊费用记录.执行部门id%Type,
    费用摘要   门诊费用记录.摘要%Type,
    医嘱id     门诊费用记录.医嘱序号%Type);

  Type Ty_Tb_Bill Is Table Of Ty_Rec_Bill;
  c_Bill Ty_Tb_Bill := Ty_Tb_Bill();

  n_单价小数 Number;
  n_金额小数 Number;

  v_Temp     Varchar2(4000);
  v_价格等级 收费价目.价格等级%Type;
  v_普通等级 收费价目.价格等级%Type;
  v_药品等级 收费价目.价格等级%Type;
  v_卫材等级 收费价目.价格等级%Type;

  n_序号         门诊费用记录.序号%Type;
  n_价格父号     门诊费用记录.价格父号%Type;
  n_当前价格父号 门诊费用记录.价格父号%Type;
  n_价格         门诊费用记录.标准单价%Type;
  n_剩余数       门诊费用记录.数次%Type;
  n_实收金额     门诊费用记录.实收金额%Type;
  d_登记时间     门诊费用记录.登记时间%Type;

  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  Procedure Zl_Third_Checkdata
  (
    病人来源_In   In Number,
    病人id_In     门诊费用记录.病人id%Type,
    主页id_In     病案主页.主页id%Type,
    病区id_In     病案主页.当前病区id%Type,
    收费细目id_In 门诊费用记录.收费细目id%Type,
    数次_In       门诊费用记录.数次%Type,
    实收金额_In   门诊费用记录.实收金额%Type,
    执行部门id_In 门诊费用记录.执行部门id%Type,
    是否记账_In   Number := 0
  ) Is
  
    --入参： 
    --        病人来源_In  1-门诊/2-住院 
    --        是否记账_In 是否记账费用:0-收费/1-记帐 
    n_跟踪在用 材料特性.跟踪在用%Type;
    n_在用分批 材料特性.在用分批%Type;
    n_是否变价 收费项目目录.是否变价%Type;
    n_库存     药品库存.可用数量%Type;
    n_项目名称 收费项目目录.名称%Type;
  
    n_检查方式  材料出库检查.检查方式%Type;
    v_收费类别  门诊费用记录.收费类别%Type;
    n_报警方法  记帐报警线.报警方法%Type;
    n_报警值    记帐报警线.报警值%Type;
    v_报警标志2 记帐报警线.报警标志2%Type;
    v_报警标志3 记帐报警线.报警标志3%Type;
    n_标志      Number;
    v_类别名称  收费项目类别.名称%Type;
    n_担保金额  门诊费用记录.实收金额%Type;
    v_担保      Varchar2(100);
    n_剩余款额  门诊费用记录.实收金额%Type;
    n_当日金额  门诊费用记录.实收金额%Type;
  
    v_Err_Msg Varchar2(255);
    Err_Item Exception;
  Begin
  
    --1.药品/卫材库存检查，要分开 
    Begin
      Select b.是否变价, b.名称, b.类别, a.跟踪在用, Decode(b.类别, '4', a.在用分批, c.药房分批)
      Into n_是否变价, n_项目名称, v_收费类别, n_跟踪在用, n_在用分批
      From 材料特性 A, 收费项目目录 B, 药品规格 C
      Where b.Id = a.材料id(+) And b.Id = c.药品id(+) And b.Id = 收费细目id_In;
    Exception
      When Others Then
        v_Err_Msg := '未发现收费项目！';
        Raise Err_Item;
    End;
  
    If Instr('5,6,7', v_收费类别) > 0 Or v_收费类别 = '4' And Nvl(n_跟踪在用, 0) = 1 Then
      Select Nvl(Sum(a.可用数量), 0)
      Into n_库存
      From 药品库存 A
      Where a.性质 = 1 And a.库房id = 执行部门id_In And (Nvl(a.批次, 0) = 0 Or a.效期 Is Null Or a.效期 > Trunc(Sysdate)) And
            a.药品id = 收费细目id_In;
      If n_库存 < 数次_In Then
        If Nvl(n_在用分批, 0) = 1 Or Nvl(n_是否变价, 0) = 1 Then
          v_Err_Msg := '[' || n_项目名称 || ']的当前可用库存不足输入数量！';
          Raise Err_Item;
        Else
          Begin
            If Instr('5,6,7', v_收费类别) > 0 Then
              Select a.检查方式 Into n_检查方式 From 药品出库检查 A Where a.库房id = 执行部门id_In;
            Else
              Select a.检查方式 Into n_检查方式 From 材料出库检查 A Where a.库房id = 执行部门id_In;
            End If;
          Exception
            When Others Then
              n_检查方式 := 0;
          End;
          If Nvl(n_检查方式, 0) = 2 Then
            v_Err_Msg := '[' || n_项目名称 || ']的当前可用库存不足输入数量！';
            Raise Err_Item;
          End If;
        End If;
      End If;
    End If;
  
    --2.住院记账和门诊记账要进行记账分类报警 
    If Nvl(是否记账_In, 0) = 1 Then
      --记帐分类报警 
      Begin
        Select Nvl(报警方法, 1) As 报警方法, 报警值, 报警标志2, 报警标志3
        Into n_报警方法, n_报警值, v_报警标志2, v_报警标志3
        From 记帐报警线
        Where 适用病人 = Zl_Patiwarnscheme(病人id_In, 主页id_In) And 病区id = 病区id_In;
      Exception
        When Others Then
          n_报警方法 := 0;
      End;
    
      If n_报警值 Is Not Null And Nvl(n_报警方法, 0) > 0 Then
        If v_报警标志2 Is Not Null Then
          If v_报警标志2 = '-' Or Instr(v_报警标志2, v_收费类别) > 0 Then
            n_标志 := 2;
          End If;
          If v_报警标志2 = '-' Then
            v_类别名称 := ''; --所有类别时,不必提示具体的类别 
          End If;
        End If;
        If Nvl(n_标志, 0) = 0 And v_报警标志3 Is Not Null Then
          If v_报警标志3 = '-' Or Instr(v_报警标志3, v_收费类别) > 0 Then
            n_标志 := 3;
          End If;
          If v_报警标志3 = '-' Then
            v_类别名称 := ''; --所有类别时,不必提示具体的类别 
          End If;
        End If;
      
        If n_报警方法 = 1 Then
          --累计费用报警(低于)\ 
          n_担保金额 := Zl_Patientsurety(病人id_In, 主页id_In);
          If n_担保金额 > 0 Then
            v_担保 := '(含担保额：' || n_担保金额 || ')';
          End If;
        
          Select Nvl(Sum(预交余额 - 费用余额), 0)
          Into n_剩余款额
          From 病人余额
          Where 性质 = 1 And 类型 = Decode(病人来源_In, 1, 2, 1) And 病人id = 病人id_In;
        
          n_剩余款额 := n_剩余款额 + n_担保金额 - Nvl(实收金额_In, 0);
          If n_标志 = 2 Then
            --预交款耗尽时禁止记帐 
            If n_剩余款额 < 0 Then
              v_Err_Msg := '剩余款' || v_担保 || '已经耗尽，' || v_类别名称 || '禁止记帐。';
              Raise Err_Item;
            End If;
          Elsif n_标志 = 3 Then
            --低于报警值禁止记帐 
            If n_剩余款额 < n_报警值 Then
              v_Err_Msg := '剩余款' || v_担保 || '低于' || v_类别名称 || '报警值：' || n_报警值 || '，禁止记帐。';
              Raise Err_Item;
            End If;
          End If;
        Elsif n_报警方法 = 2 Then
          --每日费用报警(高于) 
          If n_标志 = 3 Then
            --高于报警值禁止记帐 
            n_当日金额 := Zl_Patidaycharge(病人id_In);
            n_当日金额 := n_当日金额 + Nvl(实收金额_In, 0);
            If n_当日金额 > n_报警值 Then
              v_Err_Msg := '当日费用：' || n_当日金额 || '，高于' || v_类别名称 || '报警值：' || n_报警值 || '，禁止记帐。';
              Raise Err_Item;
            End If;
          End If;
        End If;
      End If;
    End If;
  Exception
    When Err_Item Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End Zl_Third_Checkdata;

Begin
  --获取入参 
  Select Extractvalue(Value(A), 'IN/YZID'), Extractvalue(Value(A), 'IN/PATIID'),
         Decode(Extractvalue(Value(A), 'IN/PAGEID'), 0, Null, Extractvalue(Value(A), 'IN/PAGEID')),
         Nvl(Extractvalue(Value(A), 'IN/MZBZ'), 0), Nvl(Extractvalue(Value(A), 'IN/JZBZ'), 0),
         Extractvalue(Value(A), 'IN/CZY'), To_Date(Extractvalue(Value(A), 'IN/CZSJ'), 'yyyy-mm-dd hh24:mi:ss'),
         Extractvalue(Value(A), 'IN/KDR'),
         Decode(Extractvalue(Value(A), 'IN/KDKSID'), 0, Null, Extractvalue(Value(A), 'IN/KDKSID')),
         Extractvalue(Value(A), 'IN/YQBH'), Extract(Value(A), 'IN/MXLIST')
  Into n_医嘱id, n_病人id, n_主页id, n_门诊标志, n_记帐标志, v_操作员姓名, d_操作时间, v_开单人, n_开单部门id, v_站点, Xml_明细列表

  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Begin
    Select a.编号 Into v_操作员编号 From 人员表 A Where a.姓名 = v_操作员姓名;
  Exception
    When Others Then
      v_Err_Msg := '未查找到操作员信息，单据保存失败！';
      Raise Err_Item;
  End;

  --医嘱ID 传入时，病人ID、主页ID和门诊标志 根据病人医嘱记录获取；
  --针对门诊病人，记帐标志 根据主医嘱记录的发送记录确定：记录性质为1则表示划价收费，记录性质为2则表示记帐收费
  If Nvl(n_医嘱id, 0) <> 0 Then
    Begin
      Select 病人id, 主页id, Nvl(Decode(病人来源, 2, 2, 1), 0)
      Into n_病人id, n_主页id, n_门诊标志
      From 病人医嘱记录 A
      Where a.Id = n_医嘱id;
    Exception
      When Others Then
        v_Err_Msg := '未查找到病人医嘱信息，单据保存失败！';
        Raise Err_Item;
    End;
  
    Select Nvl(Max(Decode(a.记录性质, 2, 1, 0)), 0)
    Into n_记帐标志
    From 病人医嘱发送 A, 病人医嘱记录 B
    Where a.医嘱id = Nvl(b.相关id, b.Id) And b.Id = n_医嘱id;
  End If;

  Begin
    If n_门诊标志 = 2 Then
      Select a.姓名, a.性别, a.年龄, a.费别, a.住院号, a.当前病区id, Nvl(a.出院科室id, n_开单部门id), a.出院病床, c.编码, c.名称, a.出院日期, a.入院日期,
             a.当前病区id
      Into v_姓名, v_性别, v_年龄, v_费别, n_标识号, n_病区id, n_科室id, v_床号, v_付款方式编码, v_付款方式名称, d_出院日期, d_入院日期, n_病区id
      From 病案主页 A, 病人信息 B, 医疗付款方式 C
      Where a.病人id = b.病人id And b.病人id = n_病人id And a.主页id = n_主页id And a.医疗付款方式 = c.名称(+);
    Else
      Select a.姓名, a.性别, a.年龄, a.费别, a.门诊号, n_开单部门id, b.编码, b.名称
      Into v_姓名, v_性别, v_年龄, v_费别, n_标识号, n_科室id, v_付款方式编码, v_付款方式名称
      From 病人信息 A, 医疗付款方式 B
      Where a.病人id = n_病人id And a.医疗付款方式 = b.名称(+);
    End If;
  Exception
    When Others Then
      v_Err_Msg := '未查找到病人信息，单据保存失败！';
      Raise Err_Item;
  End;

  --住院病人发生时间的检查 
  If Nvl(n_门诊标志, 0) = 2 Then
    If d_出院日期 Is Not Null Then
      If d_操作时间 > d_出院日期 Then
        v_Err_Msg := '强制对出院病人记帐时，费用时间不能大于病人出院时间:' || To_Char(d_出院日期, 'yyyy-mm-dd hh24:mi:ss') || '！';
        Raise Err_Item;
      End If;
    End If;
    If d_入院日期 Is Not Null Then
      If d_操作时间 < d_入院日期 Then
        v_Err_Msg := '费用的发生时间不能小于病人的入院时间:' || To_Char(d_入院日期, 'yyyy-mm-dd hh24:mi:ss') || '！';
        Raise Err_Item;
      End If;
    End If;
  End If;

  If v_费别 Is Null Then
    Select Max(名称) Into v_费别 From 费别 Where 缺省标志 = 1 And Rownum < 2;
    If v_费别 Is Null Then
      v_Err_Msg := '无法确定病人费别，请检查缺省费别是否正确设置！';
      Raise Err_Item;
    End If;
  End If;

  --金额及单价小数位数 
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')), Zl_To_Number(Nvl(zl_GetSysParameter(157), '5'))
  Into n_金额小数, n_单价小数
  From Dual;

  --价格等级 
  v_Temp := Zl_Get_Pricegrade(v_站点, n_病人id, n_主页id, v_付款方式名称);
  For c_价格等级 In (Select Rownum As 序号, Column_Value As 价格等级 From Table(f_Str2list(v_Temp, '|'))) Loop
    If c_价格等级.序号 = 1 Then
      v_普通等级 := c_价格等级.价格等级;
    End If;
    If c_价格等级.序号 = 2 Then
      v_药品等级 := c_价格等级.价格等级;
    End If;
    If c_价格等级.序号 = 3 Then
      v_卫材等级 := c_价格等级.价格等级;
    End If;
  End Loop;

  n_序号 := 1;
  For c_明细 In (Select a.收费细目id, a.数次, a.执行人, a.执行科室id, a.摘要, a.医嘱id, b.类别, b.名称, b.计算单位, b.是否变价, b.屏蔽费别, b.撤档时间
               From (Select Extractvalue(Value(J), '/MX/SFXMID') As 收费细目id, Extractvalue(Value(J), '/MX/SL') As 数次,
                             Extractvalue(Value(J), '/MX/ZXR') As 执行人, Extractvalue(Value(J), '/MX/ZXKSID') As 执行科室id,
                             Extractvalue(Value(J), '/MX/FYZY') As 摘要,
                             Nvl(Extractvalue(Value(J), '/MX/YZID'), n_医嘱id) As 医嘱id
                      From Table(Xmlsequence(Extract(Xml_明细列表, '/MXLIST/MX'))) J) A, 收费项目目录 B
               Where a.收费细目id = b.Id) Loop
  
    If Nvl(c_明细.撤档时间, Sysdate + 1) < Sysdate Then
      v_Err_Msg := '“' || c_明细.名称 || '”已停用，单据保存失败！';
      Raise Err_Item;
    End If;
  
    n_价格父号 := n_序号;
    If c_明细.类别 = '4' Then
      v_价格等级 := v_卫材等级;
    Elsif Instr(',5,6,7,', ',' || c_明细.类别 || ',') > 0 Then
      v_价格等级 := v_药品等级;
    Else
      v_价格等级 := v_普通等级;
    End If;
    For c_收费价目 In (Select a.收入项目id, b.收据费目, a.现价, a.缺省价格
                   From 收费价目 A, 收入项目 B
                   Where a.收入项目id = b.Id And Sysdate Between a.执行日期 And Nvl(a.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')) And
                         a.收费细目id = c_明细.收费细目id And
                         (a.价格等级 = v_价格等级 Or
                         (a.价格等级 Is Null And Not Exists
                          (Select 1
                            From 收费价目
                            Where a.收费细目id = 收费细目id And 价格等级 = v_价格等级 And Sysdate Between 执行日期 And
                                  Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')))))) Loop
    
      If n_价格父号 = n_序号 Then
        n_当前价格父号 := Null;
      Else
        n_当前价格父号 := n_价格父号;
      End If;
    
      If Instr(',4,5,6,7,', ',' || c_明细.类别 || ',') = 0 Then
        --普通收费项目 
        If Nvl(c_明细.是否变价, 0) = 0 Then
          n_价格 := Nvl(c_收费价目.现价, 0);
        Else
          n_价格 := Nvl(c_收费价目.缺省价格, 0);
        End If;
      Else
        --药品卫材 
        v_Temp   := Zl_Get_Retailprice(c_明细.收费细目id, v_价格等级, c_明细.执行科室id, c_明细.数次) || '||';
        n_价格   := Nvl(Substr(v_Temp, 1, Instr(v_Temp, '|') - 1), 0);
        v_Temp   := Substr(v_Temp, Instr(v_Temp, '|') + 1);
        n_剩余数 := Substr(v_Temp, 1, Instr(v_Temp, '|') - 1);
      
        If Nvl(n_剩余数, 0) <> 0 And Nvl(c_明细.是否变价, 0) = 1 Then
          --数量未分解完毕 
          If Instr(',5,6,7,', ',' || c_明细.类别 || ',') > 0 Then
            v_Err_Msg := '时价药品"' || c_明细.名称 || '"库存不足，无法计算价格！';
          Else
            v_Err_Msg := '时价卫生材料"' || c_明细.名称 || '"库存不足，无法计算价格！';
          End If;
          Raise Err_Item;
        End If;
      End If;
    
      c_Bill.Extend;
      c_Bill(c_Bill.Count).序号 := n_序号;
      c_Bill(c_Bill.Count).价格父号 := n_当前价格父号;
      c_Bill(c_Bill.Count).收费细目id := c_明细.收费细目id;
      c_Bill(c_Bill.Count).收费类别 := c_明细.类别;
      c_Bill(c_Bill.Count).计算单位 := c_明细.计算单位;
      c_Bill(c_Bill.Count).收入项目id := c_收费价目.收入项目id;
      c_Bill(c_Bill.Count).收据费目 := c_收费价目.收据费目;
      c_Bill(c_Bill.Count).数次 := c_明细.数次;
      c_Bill(c_Bill.Count).标准单价 := Round(n_价格, n_单价小数);
      c_Bill(c_Bill.Count).应收金额 := Round(c_Bill(c_Bill.Count).标准单价 * c_Bill(c_Bill.Count).数次, n_金额小数);
      If Nvl(c_明细.屏蔽费别, 0) = 1 Or c_Bill(c_Bill.Count).应收金额 = 0 Then
        c_Bill(c_Bill.Count).实收金额 := c_Bill(c_Bill.Count).应收金额;
      Else
        v_Temp := Zl_Actualmoney(v_费别, c_明细.收费细目id, c_收费价目.收入项目id, c_Bill(c_Bill.Count).应收金额, c_明细.数次, c_明细.执行科室id) || '::';
        v_Temp := Substr(v_Temp, Instr(v_Temp, ':') + 1);
        n_实收金额 := Substr(v_Temp, 1, Instr(v_Temp, ':') - 1);
        c_Bill(c_Bill.Count).实收金额 := Round(Nvl(n_实收金额, 0), n_金额小数);
      End If;
      c_Bill(c_Bill.Count).执行人 := c_明细.执行人;
      c_Bill(c_Bill.Count).执行部门id := c_明细.执行科室id;
      c_Bill(c_Bill.Count).费用摘要 := c_明细.摘要;
      c_Bill(c_Bill.Count).医嘱id := c_明细.医嘱id;
    
      n_序号 := n_序号 + 1;
      Zl_Third_Checkdata(n_门诊标志, n_病人id, n_主页id, n_病区id, c_明细.收费细目id, c_明细.数次, c_Bill(c_Bill.Count).实收金额, c_明细.执行科室id,
                         n_记帐标志);
    End Loop;
  End Loop;

  --单据号 
  If (n_门诊标志 = 1 And n_记帐标志 = 1) Or n_门诊标志 = 2 Then
    v_No := Nextno(14);
  Else
    v_No := Nextno(13);
  End If;

  --保存单据 
  d_登记时间 := Sysdate;
  For I In 1 .. c_Bill.Count Loop
    If n_门诊标志 = 1 Then
      If n_记帐标志 = 0 Then
        --门诊划价 
        Zl_门诊划价记录_Insert(v_No, c_Bill(I).序号, n_病人id, n_主页id, n_标识号, v_付款方式编码, v_姓名, v_性别, v_年龄, v_费别, 0, n_科室id,
                         n_开单部门id, v_开单人, Null, c_Bill(I).收费细目id, c_Bill(I).收费类别, c_Bill(I).计算单位, Null, 1, c_Bill(I).数次,
                         0, c_Bill(I).执行部门id, c_Bill(I).价格父号, c_Bill(I).收入项目id, c_Bill(I).收据费目, c_Bill(I).标准单价,
                         c_Bill(I).应收金额, c_Bill(I).实收金额, d_操作时间, d_登记时间, Null, v_操作员姓名, c_Bill(I).费用摘要, c_Bill(I).医嘱id);
      
        If c_Bill(I).执行人 Is Not Null Then
          --标记为完全执行 
          Update 门诊费用记录
          Set 执行状态 = 1, 执行人 = c_Bill(I).执行人, 执行时间 = Sysdate
          Where 记录性质 = 1 And NO = v_No And 序号 = c_Bill(I).序号;
        End If;
      Else
        --门诊记帐 
        Zl_门诊记帐记录_Insert(v_No, c_Bill(I).序号, n_病人id, n_标识号, v_姓名, v_性别, v_年龄, v_费别, 0, 0, n_科室id, n_开单部门id, v_开单人, Null,
                         c_Bill(I).收费细目id, c_Bill(I).收费类别, c_Bill(I).计算单位, 1, c_Bill(I).数次, 0, c_Bill(I).执行部门id,
                         c_Bill(I).价格父号, c_Bill(I).收入项目id, c_Bill(I).收据费目, c_Bill(I).标准单价, c_Bill(I).应收金额,
                         c_Bill(I).实收金额, d_操作时间, d_登记时间, Null, 0, v_操作员编号, v_操作员姓名, Null, c_Bill(I).费用摘要, c_Bill(I).医嘱id);
      
        If c_Bill(I).执行人 Is Not Null Then
          --标记为完全执行 
          Update 门诊费用记录
          Set 执行状态 = 1, 执行人 = c_Bill(I).执行人, 执行时间 = Sysdate
          Where 记录性质 = 2 And NO = v_No And 序号 = c_Bill(I).序号;
        End If;
      End If;
    Elsif n_门诊标志 = 2 Then
      --住院记帐 
      Zl_住院记帐记录_Insert(v_No, c_Bill(I).序号, n_病人id, n_主页id, n_标识号, v_姓名, v_性别, v_年龄, v_床号, v_费别, n_病区id, n_科室id, 0, 0,
                       n_开单部门id, v_开单人, Null, c_Bill(I).收费细目id, c_Bill(I).收费类别, c_Bill(I).计算单位, 0, Null, Null, 1,
                       c_Bill(I).数次, 0, c_Bill(I).执行部门id, c_Bill(I).价格父号, c_Bill(I).收入项目id, c_Bill(I).收据费目,
                       c_Bill(I).标准单价, c_Bill(I).应收金额, c_Bill(I).实收金额, Null, d_操作时间, d_登记时间, Null, 0, v_操作员编号, v_操作员姓名,
                       0, Null, Null, c_Bill(I).费用摘要, 0, c_Bill(I).医嘱id);
    
      If c_Bill(I).执行人 Is Not Null Then
        --标记为完全执行 
        Update 住院费用记录
        Set 执行状态 = 1, 执行人 = c_Bill(I).执行人, 执行时间 = Sysdate
        Where 记录性质 = 2 And NO = v_No And 序号 = c_Bill(I).序号;
      End If;
    End If;
  End Loop;

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT><DJH>' || v_No || '</DJH></OUTPUT>');
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Saveexes;
/
Create Or Replace Procedure Zl_Third_Getroom
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:获取某个科室下的当天排班的诊室，用于护士分诊时选择诊室
  --入参:Xml_In: 
  --  <IN> 
  --      <KSID></KSID>   --科室ID
  --  </IN> 
  --出参:Xml_Out 
  --  <OUTPUT> 
  --    <ZS>
  --      <ZSID></ZSID>    --医生ID
  --      <ZSMC></ZSMC>     --医生姓名
  --    </ZS>
  --    <ZS>
  --      ...
  --    </ZS>  
  --  </OUTPUT> 
  -------------------------------------------------------------------------------------------------- 

  n_科室id   挂号安排.科室id%Type;
  d_日期     Date;
  v_Para     varchar2(5000);
  n_挂号模式 Number(3);
  d_启用时间 Date;
  v_Temp     varchar2(32767); --临时XML 
  x_Templet  Xmltype; --模板XML 
  v_Err_Msg  varchar2(200);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/KSID') Into n_科室id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  d_日期 := Sysdate;

  v_Para     := zl_GetSysParameter(256);
  n_挂号模式 := Substr(v_Para, 1, 1);
  Begin
    d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
  Exception
    When Others Then
      d_启用时间 := Null;
  End;

  If n_挂号模式 = 0 Or (n_挂号模式 = 1 And d_日期 < d_启用时间) Then
    --计划排班模式
    For r_诊室 In (Select Distinct c.Id, c.名称
                 From 挂号安排 A, 挂号安排诊室 B, 门诊诊室 C
                 Where a.科室id = n_科室id And a.Id = b.号表id And b.门诊诊室 = c.名称) Loop
      v_Temp := '<ZS><ZSID>' || r_诊室.Id || '</ZSID><ZSMC>' || r_诊室.名称 || '</ZSMC></ZS>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
  Else
    --出诊表排班模式
    For r_诊室 In (Select Distinct b.Id, b.名称
                 From 门诊诊室适用科室 A, 门诊诊室 B
                 Where a.科室id = n_科室id And a.诊室id = b.Id
                 Order By a.缺省标志 Desc) Loop
      v_Temp := '<ZS><ZSID>' || r_诊室.Id || '</ZSID><ZSMC>' || r_诊室.名称 || '</ZSMC></ZS>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
  End If;

  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getroom;
/
Create Or Replace Procedure Zl_Third_Getpatiinfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:获取病人基本信息
  --入参:Xml_In: 
  --  <IN> 
  --      <BRID></BRID>     --病人ID
  --      <SFZH></SFZH>     --身份证号
  --      <CXKLB></CXKLB>   --查询卡类别
  --      <MZH></MZH>       --门诊号
  --      <GHDH></GHDH>     --挂号单号
  --      <YLKLB></YLKLB>   --医疗卡类别，ID或者名称
  --      <YLKH></YLKH>     --医疗卡号
  --      <BRXM></BRXM>     --病人姓名
  --  </IN> 
  --  病人识别顺序:
  --  1.传入病人ID ,以病人ID为准
  --  2.传入挂号单，则以挂号单为准
  --  3.传入卡类别ID，则以卡类别ID和卡号为准
  --  4.传入门诊号，则以门诊号为准
  --  5.传入身份证，则以身份证号和姓名为准  
  --出参:Xml_Out 
  -- <OUTPUT>
  --   <BR>
  --     <BRID></BRID>       --病人ID
  --     <XM></XM>           --姓名
  --     <XB></XB>           --性别
  --     <Nl></NL>           --年龄
  --     <CSRQ></CSRQ>       --出生日期
  --     <MZH></MZH>         --门诊号
  --     <HY></HY>           --婚姻
  --     <GJ></GJ>           --国籍
  --     <MZ></MZ>           --民族
  --     <XL></XL>           --学历
  --     <SF></SF>           --身份
  --     <ZY></ZY>           --职业
  --     <SFZH></SFZH>       --身份证号
  --     <FKFS></FKFS>       --付款方式
  --     <LXFS></LXFS>       --联系方式
  --     <LXRXM></LXRXM>     --联系人姓名
  --     <LXRDH></LXRDH>     --联系人电话
  --     <LXRDZ></LXRDZ>     --联系人地址
  --     <LXDH></LXDH>       --联系电话
  --     <XJZDZ></XJZDZ>     --现居住地址 
  --     <HJDZ></HJDZ>       --户籍地址
  --     <CSDD></CSDD>       --出生地点
  --     <KSID></KSID>       --科室ID
  --     <CXKH></CXKH>       --查询卡号
  --     <GMS></GMS>         --过敏史         
  --     <GHD></GHD>         --挂号单号
  --     <GHSJ></GHSJ>       --挂号时间
  --     <JZSJ></JZSJ>       --就诊时间
  --     <JZKS></JZKS>       --就诊科室
  --     <JZYS></JZYS>       --就诊医生
  --   </BR>
  -- </OUTPUT>
  -------------------------------------------------------------------------------------------------- 

  v_病人id       Varchar2(30000);
  v_医疗卡       Varchar2(500);
  v_门诊号       Varchar2(500);
  v_挂号单       病人挂号记录.No%Type;
  v_卡号         病人医疗卡信息.卡号%Type;
  v_姓名         病人信息.姓名%Type;
  v_身份证号     病人信息.身份证号%Type;
  v_查询卡类别   Varchar2(20);
  n_查询卡类别id 病人医疗卡信息.卡类别id%Type;
  n_卡类别id     医疗卡类别.Id%Type;
  v_No           病人挂号记录.No%Type;
  v_付款方式     病人挂号记录.医疗付款方式%Type;
  d_挂号时间     病人挂号记录.登记时间%Type;
  d_就诊时间     病人挂号记录.执行时间%Type;
  v_就诊科室     部门表.名称%Type;
  v_就诊医生     病人挂号记录.执行人%Type;
  v_过敏史       病人过敏记录.药物名%Type;
  v_Temp         Varchar2(32767); --临时XML 
  x_Templet      Xmltype; --模板XML 
  v_Err_Msg      Varchar2(200);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(a), 'IN/SFZH'), Extractvalue(Value(a), 'IN/YLKLB'), Extractvalue(Value(a), 'IN/YLKH'),
         Extractvalue(Value(a), 'IN/BRXM'), Extractvalue(Value(a), 'IN/MZH'), Extractvalue(Value(a), 'IN/GHDH'),
         Extractvalue(Value(a), 'IN/BRID'), Extractvalue(Value(a), 'IN/CXKLB')
  Into v_身份证号, v_医疗卡, v_卡号, v_姓名, v_门诊号, v_挂号单, v_病人id, v_查询卡类别
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) a;

  If v_查询卡类别 Is Not Null Then
    Select Max(Id) Into n_查询卡类别id From 医疗卡类别 Where 名称 = v_查询卡类别;
    If n_查询卡类别id Is Null Then
      n_查询卡类别id := To_Number(v_查询卡类别);
    End If;
  End If;

  If v_病人id Is Null Then
  
    If v_身份证号 Is Null And v_医疗卡 Is Null And v_卡号 Is Null And v_姓名 Is Null And v_门诊号 Is Null And v_挂号单 Is Null Then
      v_Err_Msg := '未传入任何条件,无法完成查询!';
      Raise Err_Item;
    End If;
  
    If v_医疗卡 Is Not Null Then
      Select Max(Id) Into n_卡类别id From 医疗卡类别 Where 名称 = v_医疗卡;
      If n_卡类别id Is Null Then
        n_卡类别id := To_Number(v_医疗卡);
      End If;
    End If;
  
    If v_挂号单 Is Null Then
      If Nvl(n_卡类别id, 0) = 0 Then
        If Nvl(v_门诊号, 0) <> 0 Then
          Select 病人id Into v_病人id From 病人信息 Where 门诊号 = v_门诊号;
        Else
          Select Max(病人id)
          Into v_病人id
          From 病人信息
          Where Nvl(身份证号, '-') = Nvl(v_身份证号, Nvl(身份证号, '-')) And 姓名 = Nvl(v_姓名, 姓名);
        End If;
      Else
        Select Max(病人id) Into v_病人id From 病人医疗卡信息 Where 卡类别id = n_卡类别id And 卡号 = v_卡号;
      End If;
    Else
      Select Max(病人id) Into v_病人id From 病人挂号记录 Where No = v_挂号单 And 记录性质 = 1 And 记录状态 In (1, 3);
    End If;
  End If;
  If Nvl(v_病人id, 0) = 0 Then
    v_Err_Msg := '根据传入条件,无法完成查询!';
    Raise Err_Item;
  End If;
  For r_挂号 In (Select c.病人id, c.当前科室id, c.门诊号, c.姓名, c.性别, c.年龄, c.婚姻状况, c.国籍, c.出生日期, c.身份证号, c.职业, c.学历, c.民族, c.家庭电话,
                      c.家庭地址, c.户口地址, c.身份, c.手机号, c.联系人姓名, c.联系人电话, c.联系人地址, c.出生地点, Max(f.卡号) As 卡号
               From 病人信息 c, 病人医疗卡信息 f
               Where c.病人id = v_病人id And c.病人id = f.病人id(+) And f.卡类别id(+) = n_查询卡类别id And Nvl(f.状态, 0) = 0
               Group By c.病人id, c.当前科室id, c.门诊号, c.姓名, c.性别, c.出生日期, c.身份证号, c.职业, c.学历, c.民族, c.家庭电话, c.家庭地址, c.户口地址,
                        c.身份, c.手机号, c.联系人姓名, c.联系人电话, c.联系人地址, c.出生地点, c.年龄, c.婚姻状况, c.国籍) Loop
    v_Temp := '<BR>';
  
    If v_挂号单 Is Null Then
      Select Max(No), Max(医疗付款方式), Max(登记时间), Max(执行时间), Max(执行人), Max(就诊科室)
      Into v_No, v_付款方式, d_挂号时间, d_就诊时间, v_就诊医生, v_就诊科室
      From (Select a.No, a.医疗付款方式, a.登记时间, a.执行时间, a.执行人, b.名称 As 就诊科室
             From 病人挂号记录 a, 部门表 b
             Where a.执行部门id = b.Id(+) And a.病人id = r_挂号.病人id And a.记录性质 = 1 And a.记录状态 = 1
             Order By a.登记时间 Desc)
      Where Rownum < 2;
    Else
      Select Max(a.No), Max(a.医疗付款方式), Max(a.登记时间), Max(a.执行时间), Max(a.执行人), Max(b.名称) As 就诊科室
      Into v_No, v_付款方式, d_挂号时间, d_就诊时间, v_就诊医生, v_就诊科室
      From 病人挂号记录 a, 部门表 b
      Where a.执行部门id = b.Id(+) And a.No = v_挂号单 And a.记录性质 = 1 And a.记录状态 In (1, 3);
    End If;
  
    For r In (Select 药物名 From 病人过敏记录 Where 病人id = r_挂号.病人id) Loop
      v_过敏史 := v_过敏史 || ',' || r.药物名;
    End Loop;
    v_过敏史 := Substr(v_过敏史, 2);
  
    v_Temp := v_Temp || '<BRID>' || r_挂号.病人id || '</BRID>';
    v_Temp := v_Temp || '<XM>' || r_挂号.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || r_挂号.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || r_挂号.年龄 || '</NL>';
    v_Temp := v_Temp || '<CSRQ>' || To_Char(r_挂号.出生日期, 'yyyy-mm-dd hh24:mi:ss') || '</CSRQ>';
    v_Temp := v_Temp || '<MZH>' || r_挂号.门诊号 || '</MZH>';
    v_Temp := v_Temp || '<HY>' || r_挂号.婚姻状况 || '</HY>';
    v_Temp := v_Temp || '<GJ>' || r_挂号.国籍 || '</GJ>';
    v_Temp := v_Temp || '<MZ>' || r_挂号.民族 || '</MZ>';
    v_Temp := v_Temp || '<XL>' || r_挂号.学历 || '</XL>';
    v_Temp := v_Temp || '<SF>' || r_挂号.身份 || '</SF>';
    v_Temp := v_Temp || '<ZY>' || r_挂号.职业 || '</ZY>';
    v_Temp := v_Temp || '<SFZH>' || r_挂号.身份证号 || '</SFZH>';
    v_Temp := v_Temp || '<FKFS>' || v_付款方式 || '</FKFS>';
    v_Temp := v_Temp || '<LXFS>' || r_挂号.手机号 || '</LXFS>';
    v_Temp := v_Temp || '<LXRXM>' || r_挂号.联系人姓名 || '</LXRXM>';
    v_Temp := v_Temp || '<LXRDH>' || r_挂号.联系人电话 || '</LXRDH>';
    v_Temp := v_Temp || '<LXRDZ>' || r_挂号.联系人地址 || '</LXRDZ>';
    v_Temp := v_Temp || '<LXDH>' || r_挂号.家庭电话 || '</LXDH>';
    v_Temp := v_Temp || '<XJZDZ>' || r_挂号.家庭地址 || '</XJZDZ>';
    v_Temp := v_Temp || '<HJDZ>' || r_挂号.户口地址 || '</HJDZ>';
    v_Temp := v_Temp || '<CSDD>' || r_挂号.出生地点 || '</CSDD>';
    v_Temp := v_Temp || '<KSID>' || r_挂号.当前科室id || '</KSID>';
    v_Temp := v_Temp || '<CXKH>' || r_挂号.卡号 || '</CXKH>';
    v_Temp := v_Temp || '<GMS>' || v_过敏史 || '</GMS>';
    v_Temp := v_Temp || '<GHD>' || v_No || '</GHD>';
    v_Temp := v_Temp || '<GHSJ>' || To_Char(d_挂号时间, 'yyyy-mm-dd hh24:mi:ss') || '</GHSJ>';
    v_Temp := v_Temp || '<JZSJ>' || To_Char(d_就诊时间, 'yyyy-mm-dd hh24:mi:ss') || '</JZSJ>';
    v_Temp := v_Temp || '<JZKS>' || v_就诊科室 || '</JZKS>';
    v_Temp := v_Temp || '<JZYS>' || v_就诊医生 || '</JZYS>';
    v_Temp := v_Temp || '</BR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_Third_Getpatiinfo;
/
Create Or Replace Procedure Zl_Third_Distroom
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:分诊操作数据处理
  --入参:Xml_In: 
  --  <IN> 
  --      <GHD></GHD>       --挂号单据号
  --      <FZSJ></FZSJ>   --分诊时间,默认为当前时间
  --      <FZYS></FZYS>   --分诊医生
  --      <FZZS></FZZS>   --分诊诊室
  --      <SFQD></SFQD>   --分诊时是否同步签到，0-不签到，1-签到,默认不签到
  --  </IN> 
  --出参:Xml_Out 
  --  <OUTPUT> 
  ---  <ERROR><MSG></MSG></ERROR> //无此节点表示分诊成功 
  --  </OUTPUT> 
  -------------------------------------------------------------------------------------------------- 

  v_No       病人挂号记录.No%Type;
  d_日期     Date;
  n_签到     Number;
  v_分诊医生 病人挂号记录.执行人%Type;
  v_分诊诊室 病人挂号记录.诊室%Type;
  n_病人id   病人挂号记录.病人id%Type;
  v_预约方式 病人挂号记录.预约方式%Type;
  n_挂号id   病人挂号记录.Id%Type;
  v_Temp     varchar2(32767); --临时XML 
  x_Templet  Xmltype; --模板XML 
  v_Err_Msg  varchar2(200);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/GHD'), To_Date(Extractvalue(Value(A), 'IN/FZSJ'), 'yyyy-mm-dd hh24:mi:ss'),
         Extractvalue(Value(A), 'IN/FZYS'), Extractvalue(Value(A), 'IN/FZZS'), Extractvalue(Value(A), 'IN/SFQD')
  Into v_No, d_日期, v_分诊医生, v_分诊诊室, n_签到
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If d_日期 Is Null Then
    d_日期 := Sysdate;
  End If;

  Begin
    Select 病人id, 预约方式, ID
    Into n_病人id, v_预约方式, n_挂号id
    From 病人挂号记录
    Where 记录性质 = 1 And 记录状态 = 1 And NO = v_No And Nvl(执行状态, 0) = 0;
  Exception
    When Others Then
      v_Err_Msg := '病人已经接诊或已经退号，不能再分诊';
      Raise Err_Item;
  End;

  Zl_病人挂号记录_更新诊室(v_No, n_病人id, v_分诊诊室, v_分诊医生, d_日期, 1, v_预约方式);

  If Nvl(n_签到, 0) = 1 Then
    Zl_病人挂号记录_签到(n_挂号id, 0, v_预约方式);
  End If;

  v_Temp := '<ERROR><MSG>' || '</MSG></ERROR>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '<ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Distroom;
/
Create Or Replace Procedure Zl_Third_Getregstatus
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:获取某个科室当天排班医生的挂号数量
  --入参:Xml_In: 
  --  <IN> 
  --      <KSID></KSID>   --科室ID
  --  </IN> 
  --出参:Xml_Out 
  --  <OUTPUT> 
  --    <YS>
  --      <YSXM></YSXM>    --医生姓名
  --      <SYGHS></SYGHS>  --剩余挂号数
  --      <DDJZS></DDJZS>  --等待就诊数
  --      <SWGHS></SWGHS>  --上午挂号数
  --      <XWGHS></XWGHS>  --下午挂号数
  --      <QTGHS></QTGHS>  --全天挂号数
  --      <YSZJ><YSZJ>     --医生职级
  --    </YS>
  --    <YS>
  --      ...
  --    </YS>  
  --  </OUTPUT> 
  -------------------------------------------------------------------------------------------------- 

  n_科室id      挂号安排.科室id%Type;
  d_日期        Date;
  v_Para        Varchar2(5000);
  n_挂号模式    Number(3);
  d_启用时间    Date;
  v_Temp        Varchar2(32767); --临时XML 
  x_Templet     Xmltype; --模板XML 
  v_Err_Msg     Varchar2(200);
  n_已挂数      病人挂号汇总.已挂数%Type;
  n_限号数      挂号安排限制.限号数%Type;
  n_上午接诊    Number;
  n_下午接诊    Number;
  n_等待就诊    Number;
  v_出诊记录ids Varchar2(5000);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/KSID') Into n_科室id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  d_日期 := Sysdate;

  v_Para     := zl_GetSysParameter(256);
  n_挂号模式 := Substr(v_Para, 1, 1);
  Begin
    d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
  Exception
    When Others Then
      d_启用时间 := Null;
  End;

  If n_挂号模式 = 0 Or (n_挂号模式 = 1 And d_日期 < d_启用时间) Then
    --计划排班模式
    For r_医生 In (Select Distinct 医生id, 医生姓名, y.专业技术职务
                 From (Select a.医生id, a.医生姓名
                        From 挂号安排计划 A, 挂号安排 B
                        Where a.安排id = b.Id And b.停用日期 Is Null And a.审核时间 Is Not Null And b.科室id = n_科室id And
                              a.生效时间 = (Select Max(生效时间)
                                        From 挂号安排计划
                                        Where 安排id = b.Id And 审核时间 Is Not Null And d_日期 Between 生效时间 + 0 And 失效时间) And
                              Not Exists (Select 1
                               From 挂号安排停用状态
                               Where 安排id = b.Id And d_日期 Between 开始停止时间 And 结束停止时间) And
                              d_日期 Between Nvl(b.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                              Nvl(b.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD'))
                        Union All
                        Select a.医生id, a.医生姓名
                        From 挂号安排 A
                        Where a.停用日期 Is Null And a.科室id = n_科室id And
                              d_日期 Between Nvl(a.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                              Nvl(a.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Not Exists
                         (Select 1
                               From 挂号安排停用状态
                               Where 安排id = a.Id And d_日期 Between 开始停止时间 And 结束停止时间) And Not Exists
                         (Select 1
                               From 挂号安排计划
                               Where 安排id = a.Id And 审核时间 Is Not Null And d_日期 Between 生效时间 + 0 And 失效时间)) X, 人员表 Y
                 Where x.医生id = y.Id(+)) Loop
      If r_医生.医生姓名 Is Not Null Then
        v_Temp := '<YS>';
        v_Temp := v_Temp || '<YSXM>' || r_医生.医生姓名 || '</YSXM>';
        Select Nvl(Sum(a.已挂数), 0)
        Into n_已挂数
        From 病人挂号汇总 A,
             (Select Distinct 号码
               From (Select b.号码
                      From 挂号安排计划 A, 挂号安排 B
                      Where a.安排id = b.Id And b.停用日期 Is Null And a.审核时间 Is Not Null And b.科室id = n_科室id And
                            a.生效时间 = (Select Max(生效时间)
                                      From 挂号安排计划
                                      Where 安排id = b.Id And 审核时间 Is Not Null And d_日期 Between 生效时间 + 0 And 失效时间) And Not Exists
                       (Select 1
                             From 挂号安排停用状态
                             Where 安排id = b.Id And d_日期 Between 开始停止时间 And 结束停止时间) And
                            d_日期 Between Nvl(b.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                            Nvl(b.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD'))
                      Union All
                      Select a.号码
                      From 挂号安排 A
                      Where a.停用日期 Is Null And a.科室id = n_科室id And
                            d_日期 Between Nvl(a.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                            Nvl(a.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Not Exists
                       (Select 1
                             From 挂号安排停用状态
                             Where 安排id = a.Id And d_日期 Between 开始停止时间 And 结束停止时间) And Not Exists
                       (Select 1
                             From 挂号安排计划
                             Where 安排id = a.Id And 审核时间 Is Not Null And d_日期 Between 生效时间 + 0 And 失效时间))) B
        Where a.医生姓名 = r_医生.医生姓名 And a.科室id = n_科室id And a.号码 = b.号码 And 日期 = Trunc(d_日期);
      
        Select Nvl(Sum(限号数), 0)
        Into n_限号数
        From (Select c.限号数
               From 挂号安排计划 A, 挂号安排 B, 挂号计划限制 C
               Where a.Id = c.计划id And c.限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                       '周四', '6', '周五', '7', '周六', Null) And a.安排id = b.Id And
                     b.停用日期 Is Null And a.审核时间 Is Not Null And b.科室id = n_科室id And
                     a.生效时间 = (Select Max(生效时间)
                               From 挂号安排计划
                               Where 安排id = b.Id And 审核时间 Is Not Null And d_日期 Between 生效时间 + 0 And 失效时间) And Not Exists
                (Select 1 From 挂号安排停用状态 Where 安排id = b.Id And d_日期 Between 开始停止时间 And 结束停止时间) And
                     d_日期 Between Nvl(b.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                     Nvl(b.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD'))
               Union All
               Select b.限号数
               From 挂号安排 A, 挂号安排限制 B
               Where a.Id = b.安排id And b.限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                       '周四', '6', '周五', '7', '周六', Null) And a.停用日期 Is Null And
                     a.科室id = n_科室id And d_日期 Between Nvl(a.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                     Nvl(a.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Not Exists
                (Select 1 From 挂号安排停用状态 Where 安排id = a.Id And d_日期 Between 开始停止时间 And 结束停止时间) And Not Exists
                (Select 1
                      From 挂号安排计划
                      Where 安排id = a.Id And 审核时间 Is Not Null And d_日期 Between 生效时间 + 0 And 失效时间));
        If n_限号数 - n_已挂数 < 0 Then
          v_Temp := v_Temp || '<SYGHS>' || 0 || '</SYGHS>';
        Else
          v_Temp := v_Temp || '<SYGHS>' || To_Char(n_限号数 - n_已挂数) || '</SYGHS>';
        End If;
        
        Select Count(1)
        Into n_等待就诊
        From 病人挂号记录
        Where 执行人 = r_医生.医生姓名 And 执行部门id = n_科室id And Nvl(执行状态, 0) = 0 And 记录性质 = 1 And 记录状态 = 1 And
              发生时间 Between Trunc(d_日期) And Trunc(d_日期 + 1) - 1 / 24 / 60 / 60;
        v_Temp := v_Temp || '<DDJZS>' || n_等待就诊 || '</DDJZS>';
        
        Select Count(1)
        Into n_上午接诊
        From 病人挂号记录
        Where 执行人 = r_医生.医生姓名 And 执行部门id = n_科室id And 记录性质 = 1 And 记录状态 = 1 And
              发生时间 Between Trunc(d_日期) And Trunc(d_日期) + 0.5 - 1 / 24 / 60 / 60;
        v_Temp := v_Temp || '<SWGHS>' || n_上午接诊 || '</SWGHS>';
        
        Select Count(1)
        Into n_下午接诊
        From 病人挂号记录
        Where 执行人 = r_医生.医生姓名 And 执行部门id = n_科室id And 记录性质 = 1 And 记录状态 = 1 And
              发生时间 Between Trunc(d_日期) + 0.5 And Trunc(d_日期 + 1) - 1 / 24 / 60 / 60;
        v_Temp := v_Temp || '<XWGHS>' || n_下午接诊 || '</XWGHS>';
        
        v_Temp := v_Temp || '<QTGHS>' || To_Char(n_上午接诊 + n_下午接诊) || '</QTGHS>';
        v_Temp := v_Temp || '<YSZJ>' || r_医生.专业技术职务 || '</YSZJ>';
        v_Temp := v_Temp || '</YS>';
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      End If;
    End Loop;
  Else
    --出诊表排班模式
    For r_医生 In (Select Distinct a.医生id, a.医生姓名, b.专业技术职务
                 From 临床出诊记录 A, 人员表 B
                 Where a.医生id = b.Id(+) And a.科室id = n_科室id And 是否发布 = 1 And Nvl(是否锁定, 0) = 0 And
                       (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间))) Loop
      For r_出诊记录 In (Select Distinct ID
                     From 临床出诊记录
                     Where 医生姓名 = r_医生.医生姓名 And 科室id = n_科室id And 出诊日期 = Trunc(d_日期) And 是否发布 = 1 And Nvl(是否锁定, 0) = 0 And
                           (开始时间 < Nvl(停诊开始时间, 终止时间) Or 终止时间 > Nvl(停诊终止时间, 开始时间))) Loop
        v_出诊记录ids := v_出诊记录ids || ',' || r_出诊记录.Id;
      End Loop;
      If v_出诊记录ids Is Not Null Then
        v_出诊记录ids := Substr(v_出诊记录ids, 2);
      End If;
      Select Sum(限号数), Sum(已挂数)
      Into n_限号数, n_已挂数
      From 临床出诊记录 A, Table(f_Str2list(v_出诊记录ids)) B
      Where a.Id = b.Column_Value;
      v_Temp := '<YS>';
      v_Temp := v_Temp || '<YSXM>' || r_医生.医生姓名 || '</YSXM>';
      If n_限号数 - n_已挂数 < 0 Then
        v_Temp := v_Temp || '<SYGHS>' || 0 || '</SYGHS>';
      Else
        v_Temp := v_Temp || '<SYGHS>' || To_Char(n_限号数 - n_已挂数) || '</SYGHS>';
      End If;
      Select Count(1)
      Into n_等待就诊
      From 病人挂号记录 A, Table(f_Str2list(v_出诊记录ids)) B
      Where 执行人 = r_医生.医生姓名 And 执行部门id = n_科室id And Nvl(执行状态, 0) = 0 And 记录性质 = 1 And 记录状态 = 1 And
            a.出诊记录id = b.Column_Value;
      v_Temp := v_Temp || '<DDJZS>' || n_等待就诊 || '</DDJZS>';
      
      Select Count(1)
      Into n_上午接诊
      From 病人挂号记录 A, Table(f_Str2list(v_出诊记录ids)) B
      Where 执行人 = r_医生.医生姓名 And 执行部门id = n_科室id And 记录性质 = 1 And 记录状态 = 1 And
            发生时间 Between Trunc(d_日期) And Trunc(d_日期) + 0.5 - 1 / 24 / 60 / 60 And a.出诊记录id = b.Column_Value;
      v_Temp := v_Temp || '<SWGHS>' || n_上午接诊 || '</SWGHS>';
      
      Select Count(1)
      Into n_下午接诊
      From 病人挂号记录 A, Table(f_Str2list(v_出诊记录ids)) B
      Where 执行人 = r_医生.医生姓名 And 执行部门id = n_科室id And 记录性质 = 1 And 记录状态 = 1 And
            发生时间 Between Trunc(d_日期) + 0.5 And Trunc(d_日期 + 1) - 1 / 24 / 60 / 60 And a.出诊记录id = b.Column_Value;
      v_Temp := v_Temp || '<XWGHS>' || n_下午接诊 || '</XWGHS>';
      
      v_Temp := v_Temp || '<QTGHS>' || To_Char(n_上午接诊 + n_下午接诊) || '</QTGHS>';
      v_Temp := v_Temp || '<YSZJ>' || r_医生.专业技术职务 || '</YSZJ>';
      v_Temp := v_Temp || '</YS>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
  End If;

  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getregstatus;
/
Create Or Replace Procedure Zl_Third_Getdoctor
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:获取某个科室下的排班的医生，用于护士分诊时选择医生
  --入参:Xml_In: 
  --  <IN> 
  --      <KSID></KSID>   --科室ID
  --      <RQ></RQ>   --日期,默认为当天
  --  </IN> 
  --出参:Xml_Out 
  --  <OUTPUT> 
  --    <YS>
  --      <YSID></YSID>    --医生ID
  --      <YSXM></YSXM>     --医生姓名
  --    </YS>
  --    <YS>
  --      ...
  --    </YS>  
  --  </OUTPUT> 
  -------------------------------------------------------------------------------------------------- 

  n_科室id   挂号安排.科室id%Type;
  d_日期     Date;
  v_Para     Varchar2(5000);
  n_挂号模式 Number(3);
  d_启用时间 Date;
  n_所有医生 Number(3);
  v_Temp     Varchar2(32767); --临时XML 
  x_Templet  Xmltype; --模板XML 
  v_Err_Msg  Varchar2(200);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/KSID'), To_Date(Extractvalue(Value(A), 'IN/RQ'), 'yyyy-mm-dd hh24:mi:ss')
  Into n_科室id, d_日期
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If d_日期 Is Null Then
    d_日期 := Sysdate;
  End If;

  v_Para     := zl_GetSysParameter(256);
  n_挂号模式 := Substr(v_Para, 1, 1);
  Begin
    d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
  Exception
    When Others Then
      d_启用时间 := Null;
  End;

  If n_挂号模式 = 0 Or (n_挂号模式 = 1 And d_日期 < d_启用时间) Then
    --计划排班模式
    For r_医生 In (Select Distinct 医生id, 医生姓名
                 From (Select a.医生id, a.医生姓名
                        From 挂号安排计划 A, 挂号安排 B
                        Where a.安排id = b.Id And b.停用日期 Is Null And a.审核时间 Is Not Null And b.科室id = n_科室id And
                              a.生效时间 = (Select Max(生效时间)
                                        From 挂号安排计划
                                        Where 安排id = b.Id And 审核时间 Is Not Null And d_日期 Between 生效时间 + 0 And 失效时间) And
                              Not Exists (Select 1
                               From 挂号安排停用状态
                               Where 安排id = b.Id And d_日期 Between 开始停止时间 And 结束停止时间) And
                              d_日期 Between Nvl(b.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                              Nvl(b.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD'))
                        Union All
                        Select a.医生id, a.医生姓名
                        From 挂号安排 A
                        Where a.停用日期 Is Null And a.科室id = n_科室id And
                              d_日期 Between Nvl(a.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                              Nvl(a.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Not Exists
                         (Select 1
                               From 挂号安排停用状态
                               Where 安排id = a.Id And d_日期 Between 开始停止时间 And 结束停止时间) And Not Exists
                         (Select 1
                               From 挂号安排计划
                               Where 安排id = a.Id And 审核时间 Is Not Null And d_日期 Between 生效时间 + 0 And 失效时间))) Loop
      If Nvl(r_医生.医生id, 0) <> 0 Or Nvl(r_医生.医生姓名, '-') <> '-' Then
        v_Temp := '<YS><YSID>' || r_医生.医生id || '</YSID><YSXM>' || r_医生.医生姓名 || '</YSXM></YS>';
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      Else
        n_所有医生 := 1;
        Exit;
      End If;
    End Loop;
  Else
    --出诊表排班模式
    For r_医生 In (Select Distinct 医生id, 医生姓名
                 From 临床出诊记录
                 Where 科室id = n_科室id And 出诊日期 = Trunc(d_日期) And 是否发布 = 1 And Nvl(是否锁定, 0) = 0 And
                       (开始时间 < Nvl(停诊开始时间, 终止时间) Or 终止时间 > Nvl(停诊终止时间, 开始时间))) Loop
      If Nvl(r_医生.医生id, 0) <> 0 Or Nvl(r_医生.医生姓名, '-') <> '-' Then
        v_Temp := '<YS><YSID>' || r_医生.医生id || '</YSID><YSXM>' || r_医生.医生姓名 || '</YSXM></YS>';
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      Else
        n_所有医生 := 1;
        Exit;
      End If;
    End Loop;
  End If;

  If Nvl(n_所有医生, 0) = 1 Then
    x_Templet := Xmltype('<OUTPUT></OUTPUT>');
    For r_医生 In (Select Distinct a.Id, a.姓名
                 From 人员表 A, 部门人员 B, 人员性质说明 C
                 Where a.Id = b.人员id And b.部门id = n_科室id And a.Id = c.人员id And c.人员性质 = '医生' And
                       (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null)) Loop
      v_Temp := '<YS><YSID>' || r_医生.Id || '</YSID><YSXM>' || r_医生.姓名 || '</YSXM></YS>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
  End If;

  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getdoctor;
/
Create Or Replace Procedure Zl_Third_Getdeptreg
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:获取某个科室下的指定日期所有未分诊的挂号记录，用于分诊
  --入参:Xml_In: 
  --  <IN> 
  --      <KSID></KSID>   --科室ID
  --      <RQ></RQ>       --日期,默认为当天
  --      <CXKLB></CXKLB> --查询卡类别
  --      <CZYY></CZYY>     --查找预约，0-不查找预约单，1-查找时包含预约单
  --  </IN> 
  --出参:Xml_Out 
  --  <OUTPUT> 
  --    <GH>
  --      <ID></ID>    --挂号记录ID
  --      <GHD></GHD>  --挂号单据
  --      <SFYY></SFYY>  --是否预约：0-当前单据是挂号单；1-当前单据是预约单
  --      <BRID></BRID>  --病人ID
  --      <MZH></MZH>  --门诊号
  --      <XM></XM>  --姓名
  --      <XB></XB>  --性别
  --      <NL></NL>  --年龄
  --      <CSRQ></CSRQ>    --出生日期   格式为:'yyyy-mm-dd hh24:mi:ss'
  --      <SFZH></SFZH>  --身份证号
  --      <CXKH></CXKH>  --查询卡号
  --      <YSID></YSID>  --医生ID
  --      <YSXM></YSXM>  --医生姓名
  --      <KSID></KSID>  --科室ID
  --      <KSMC></KSMC>  --科室名称
  --      <GHSJ></GHSJ>  --挂号时间
  --    </GH>
  --    <GH>
  --      ...
  --    </GH>  
  --  </OUTPUT> 
  -------------------------------------------------------------------------------------------------- 

  n_科室id       挂号安排.科室id%Type;
  d_日期         Date;
  n_挂号天数     Number(3);
  v_查询卡类别   Varchar2(20);
  n_查询卡类别id 医疗卡类别.Id%Type;
  n_查询预约     Number(1);
  v_Temp         Varchar2(32767); --临时XML 
  x_Templet      Xmltype; --模板XML 
  v_Err_Msg      Varchar2(200);
  d_开始时间     Date;
  d_终止时间     Date;
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/KSID'), To_Date(Extractvalue(Value(A), 'IN/RQ'), 'yyyy-mm-dd hh24:mi:ss'),
         Extractvalue(Value(A), 'IN/CXKLB'), Extractvalue(Value(A), 'IN/CZYY')
  Into n_科室id, d_日期, v_查询卡类别, n_查询预约
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If d_日期 Is Null Then
    d_日期 := Sysdate;
  End If;

  If v_查询卡类别 Is Not Null Then
    Select Max(ID) Into n_查询卡类别id From 医疗卡类别 Where 名称 = v_查询卡类别;
    If n_查询卡类别id Is Null Then
      n_查询卡类别id := To_Number(v_查询卡类别);
    End If;
  End If;

  n_挂号天数 := To_Number(Substr(Nvl(zl_GetSysParameter(21), '11'), 1, 1));
  d_开始时间 := Trunc(d_日期 - n_挂号天数);
  d_终止时间 := Trunc(d_日期 + 1) - 1 / 24 / 60 / 60;

  For r_挂号 In (Select a.Id, a.No, a.病人id, a.门诊号, a.姓名, c.出生日期, a.性别, b.Id As 医生id, a.医生姓名, c.身份证号, d.Id As 科室id,
                      d.名称 As 科室名称, a.登记时间, a.年龄, Max(f.卡号) As 卡号, a.预约单
               From (Select a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, Decode(Nvl(转诊科室id, 0), n_科室id, a.转诊医生, a.执行人) As 医生姓名,
                             a.登记时间, a.年龄, Decode(a.记录性质, 2, 1, 0) As 预约单,
                             Decode(Nvl(转诊科室id, 0), n_科室id, a.转诊科室id, a.执行部门id) As 科室id
                      From 病人挂号记录 A
                      Where a.记录性质 = Decode(Nvl(n_查询预约, 0), 1, a.记录性质, 1) And a.记录状态 = 1 And
                            ((a.执行部门id = n_科室id And Nvl(a.执行状态, 0) = 0) Or
                            (a.转诊科室id = n_科室id And Nvl(a.执行状态, 0) In (0, 2))) And a.发生时间 Between d_开始时间 And d_终止时间) A,
                    人员表 B, 病人信息 C, 部门表 D, 病人医疗卡信息 F
               Where a.科室id = d.Id(+) And a.病人id = c.病人id And a.医生姓名 = b.姓名(+) And a.病人id = f.病人id(+) And
                     f.卡类别id(+) = n_查询卡类别id And Nvl(f.状态, 0) = 0
               Group By a.Id, a.No, a.病人id, a.门诊号, a.姓名, c.出生日期, a.性别, b.Id, a.医生姓名, c.身份证号, d.Id, d.名称, a.登记时间, a.年龄,
                        a.预约单) Loop
    v_Temp := '<GH>';
    v_Temp := v_Temp || '<ID>' || r_挂号.Id || '</ID>';
    v_Temp := v_Temp || '<GHD>' || r_挂号.No || '</GHD>';
    v_Temp := v_Temp || '<SFYY>' || r_挂号.预约单 || '</SFYY>';
    v_Temp := v_Temp || '<BRID>' || r_挂号.病人id || '</BRID>';
    v_Temp := v_Temp || '<MZH>' || r_挂号.门诊号 || '</MZH>';
    v_Temp := v_Temp || '<XM>' || r_挂号.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || r_挂号.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || r_挂号.年龄 || '</NL>';
    v_Temp := v_Temp || '<CSRQ>' || To_Char(r_挂号.出生日期, 'yyyy-mm-dd hh24:mi:ss') || '</CSRQ>';
    v_Temp := v_Temp || '<SFZH>' || r_挂号.身份证号 || '</SFZH>';
    v_Temp := v_Temp || '<CXKH>' || r_挂号.卡号 || '</CXKH>';
    v_Temp := v_Temp || '<YSID>' || r_挂号.医生id || '</YSID>';
    v_Temp := v_Temp || '<YSXM>' || r_挂号.医生姓名 || '</YSXM>';
    v_Temp := v_Temp || '<KSID>' || r_挂号.科室id || '</KSID>';
    v_Temp := v_Temp || '<KSMC>' || r_挂号.科室名称 || '</KSMC>';
    v_Temp := v_Temp || '<GHSJ>' || To_Char(r_挂号.登记时间, 'yyyy-mm-dd hh24:mi:ss') || '</GHSJ>';
    v_Temp := v_Temp || '</GH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getdeptreg;
/
Create Or Replace Procedure Zl_Third_Getpatireg
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取某个人指定日期未分诊的挂号记录
  --入参:Xml_In:
  --  <IN>
  --      <RQ></RQ>         --日期,默认为当天
  --      <SFZH></SFZH>     --身份证号
  --      <MZH></MZH>       --门诊号
  --      <GHDH></GHDH>     --挂号单号
  --      <YLKLB></YLKLB>   --医疗卡类别，ID或者名称
  --      <YLKH></YLKH>     --医疗卡号
  --      <CXKLB></CXKLB>   --查询卡类别
  --      <KSID></KSID>     --科室ID
  --      <BRXM></BRXM>     --病人姓名
  --      <CZYY></CZYY>     --查找预约，0-不查找预约单，1-查找时包含预约单
  --  </IN>
  --出参:Xml_Out
  --  <OUTPUT>
  --    <GH>
  --      <ID></ID>    --挂号记录ID
  --      <GHD></GHD>  --挂号单据
  --      <SFYY></SFYY>  --是否预约：0-当前单据是挂号单；1-当前单据是预约单
  --      <BRID></BRID>  --病人ID
  --      <MZH></MZH>  --门诊号
  --      <XM></XM>  --姓名
  --      <XB></XB>  --性别
  --      <NL></NL>  --年龄
  --      <CSRQ></CSRQ>    --出生日期   格式为:'yyyy-mm-dd hh24:mi:ss'
  --      <SFZH></SFZH>  --身份证号
  --      <YSID></YSID>  --医生ID
  --      <YSXM></YSXM>  --医生姓名
  --      <KSID></KSID>  --科室ID
  --      <KSMC></KSMC>  --科室名称
  --      <GHSJ></GHSJ>  --挂号时间
  --    </GH>
  --    <GH>
  --      ...
  --    </GH>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------

  v_病人ids      Varchar2(30000);
  v_医疗卡       Varchar2(500);
  v_门诊号       Varchar2(500);
  v_挂号单       病人挂号记录.No%Type;
  n_挂号天数     Number(3);
  d_日期         Date;
  v_卡号         病人医疗卡信息.卡号%Type;
  n_科室id       部门表.Id%Type;
  v_姓名         病人信息.姓名%Type;
  v_身份证号     病人信息.身份证号%Type;
  v_查询卡类别   Varchar2(20);
  n_查询卡类别id 医疗卡类别.Id%Type;
  n_卡类别id     医疗卡类别.Id%Type;
  n_查询预约     Number(1);
  d_开始时间     Date;
  d_终止时间     Date;

  Cursor c_挂号信息 Is
    Select a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, b.Id As 医生id, a.执行人 As 医生姓名, c.身份证号, d.Id As 科室id, d.名称 As 科室名称,
           a.登记时间, a.年龄, c.出生日期, f.卡号, 0 As 预约单
    From 病人挂号记录 A, 人员表 B, 病人信息 C, 部门表 D, 病人医疗卡信息 F
    Where a.病人id = c.病人id And a.执行人 = b.姓名 And a.执行部门id = d.Id And a.病人id = f.病人id And Rownum < 1;
  r_挂号信息 c_挂号信息%RowType;
  Type My_挂号单 Is Ref Cursor; --声明动态游标类型
  c_挂号单 My_挂号单; --定义动态游标变量

  v_Temp    Varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML
  v_Err_Msg Varchar2(200);

  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/SFZH'), To_Date(Extractvalue(Value(A), 'IN/RQ'), 'yyyy-mm-dd hh24:mi:ss'),
         Extractvalue(Value(A), 'IN/YLKLB'), Extractvalue(Value(A), 'IN/YLKH'), Extractvalue(Value(A), 'IN/BRXM'),
         Extractvalue(Value(A), 'IN/KSID'), Extractvalue(Value(A), 'IN/MZH'), Extractvalue(Value(A), 'IN/GHDH'),
         Extractvalue(Value(A), 'IN/CXKLB'), Extractvalue(Value(A), 'IN/CZYY')
  Into v_身份证号, d_日期, v_医疗卡, v_卡号, v_姓名, n_科室id, v_门诊号, v_挂号单, v_查询卡类别, n_查询预约
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_身份证号 Is Null And v_门诊号 Is Null And v_挂号单 Is Null And v_医疗卡 Is Null And v_卡号 Is Null And v_姓名 Is Null Then
    v_Err_Msg := '未传入任何条件,无法完成查询!';
    Raise Err_Item;
  End If;

  If d_日期 Is Null Then
    d_日期 := Sysdate;
  End If;

  If v_查询卡类别 Is Not Null Then
    Select Max(ID) Into n_查询卡类别id From 医疗卡类别 Where 名称 = v_查询卡类别;
    If n_查询卡类别id Is Null Then
      n_查询卡类别id := To_Number(v_查询卡类别);
    End If;
  End If;

  If v_挂号单 Is Null Then
    If v_医疗卡 Is Not Null Then
      Select Max(ID) Into n_卡类别id From 医疗卡类别 Where 名称 = v_医疗卡;
      If n_卡类别id Is Null Then
        n_卡类别id := To_Number(v_医疗卡);
      End If;
      --根据医疗卡查询病人信息
      For r_病人 In (Select Distinct a.病人id
                   From 病人信息 A, 病人医疗卡信息 B
                   Where a.病人id = b.病人id And b.卡类别id = n_卡类别id And b.卡号 = v_卡号) Loop
        v_病人ids := v_病人ids || ',' || r_病人.病人id;
      End Loop;
    Elsif v_身份证号 Is Not Null Then
      --根据身份证号查询病人信息
      For r_病人 In (Select Distinct 病人id From 病人信息 Where Nvl(身份证号, '-') = Nvl(v_身份证号, Nvl(身份证号, '-'))) Loop
        v_病人ids := v_病人ids || ',' || r_病人.病人id;
      End Loop;
    Elsif v_门诊号 Is Not Null Then
      --根据门诊号查询病人信息
      For r_病人 In (Select Distinct 病人id From 病人信息 Where Nvl(门诊号, 0) = Nvl(v_门诊号, Nvl(门诊号, 0))) Loop
        v_病人ids := v_病人ids || ',' || r_病人.病人id;
      End Loop;
    Else
      --根据病人姓名查询病人信息
      For r_病人 In (Select Distinct 病人id From 病人信息 Where 姓名 = v_姓名) Loop
        v_病人ids := v_病人ids || ',' || r_病人.病人id;
      End Loop;
    End If;
  
    If v_病人ids Is Not Null Then
      v_病人ids := Substr(v_病人ids, 2);
    End If;
  End If;

  n_挂号天数 := To_Number(Substr(Nvl(zl_GetSysParameter(21), '11'), 1, 1));
  d_开始时间 := Trunc(d_日期 - n_挂号天数);
  d_终止时间 := Trunc(d_日期 + 1) - 1 / 24 / 60 / 60;

  If v_挂号单 Is Not Null Then
    If Length(v_挂号单) = 3 Then
      v_挂号单 := '%' || v_挂号单;
      Open c_挂号单 For
        Select a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, b.Id As 医生id, a.执行人 As 医生姓名, c.身份证号, d.Id As 科室id, d.名称 As 科室名称,
               a.登记时间, a.年龄, c.出生日期, Max(f.卡号) As 卡号, Decode(a.记录性质, 2, 1, 0) As 预约单
        From 病人挂号记录 A, 人员表 B, 病人信息 C, 部门表 D, 病人医疗卡信息 F
        Where a.记录状态 = 1 And Nvl(a.执行状态, 0) = 0 And a.执行人 = b.姓名(+) And a.病人id = c.病人id And a.No Like v_挂号单 And
              a.执行部门id = d.Id And a.诊室 Is Null And a.发生时间 Between d_开始时间 And d_终止时间 And c.病人id = f.病人id(+) And
              f.卡类别id(+) = n_查询卡类别id And Nvl(f.状态, 0) = 0
        Group By a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, b.Id, a.执行人, c.身份证号, d.Id, d.名称, a.登记时间, a.年龄, c.出生日期,
                 Decode(a.记录性质, 2, 1, 0);
    Else
      Open c_挂号单 For
        Select a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, b.Id As 医生id, a.执行人 As 医生姓名, c.身份证号, d.Id As 科室id, d.名称 As 科室名称,
               a.登记时间, a.年龄, c.出生日期, Max(f.卡号) As 卡号, Decode(a.记录性质, 2, 1, 0) As 预约单
        From 病人挂号记录 A, 人员表 B, 病人信息 C, 部门表 D, 病人医疗卡信息 F
        Where a.记录状态 = 1 And Nvl(a.执行状态, 0) = 0 And a.执行人 = b.姓名(+) And a.病人id = c.病人id And a.No = v_挂号单 And
              a.执行部门id = d.Id And a.诊室 Is Null And a.发生时间 Between d_开始时间 And d_终止时间 And c.病人id = f.病人id(+) And
              f.卡类别id(+) = n_查询卡类别id And Nvl(f.状态, 0) = 0
        Group By a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, b.Id, a.执行人, c.身份证号, d.Id, d.名称, a.登记时间, a.年龄, c.出生日期,
                 Decode(a.记录性质, 2, 1, 0);
    End If;
  Else
    Open c_挂号单 For
      Select a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, b.Id As 医生id, a.执行人 As 医生姓名, c.身份证号, d.Id As 科室id, d.名称 As 科室名称,
             a.登记时间, a.年龄, c.出生日期, Max(f.卡号) As 卡号, a.预约单
      From (Select /* +cardinality(E,10) */
              a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, Decode(Nvl(转诊科室id, 0), n_科室id, a.转诊医生, a.执行人) As 执行人, a.登记时间, a.年龄,
              Decode(a.记录性质, 2, 1, 0) As 预约单, Decode(Nvl(转诊科室id, 0), n_科室id, a.转诊科室id, a.执行部门id) As 科室id
             From 病人挂号记录 A, Table(f_Num2list(v_病人ids)) E
             Where a.记录性质 = Decode(Nvl(n_查询预约, 0), 1, a.记录性质, 1) And a.记录状态 = 1 And
                   ((a.执行部门id = n_科室id And Nvl(a.执行状态, 0) = 0) Or (a.转诊科室id = n_科室id And Nvl(a.执行状态, 0) In (0, 2))) And
                   a.发生时间 Between d_开始时间 And d_终止时间 And a.病人id = e.Column_Value) A, 人员表 B, 病人信息 C, 部门表 D, 病人医疗卡信息 F
      Where a.执行人 = b.姓名(+) And a.病人id = c.病人id And a.科室id = d.Id(+) And c.病人id = f.病人id(+) And f.卡类别id(+) = n_查询卡类别id And
            Nvl(f.状态, 0) = 0
      Group By a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, b.Id, a.执行人, c.身份证号, d.Id, d.名称, a.登记时间, a.年龄, c.出生日期, a.预约单;
  End If;

  Loop
    Fetch c_挂号单
      Into r_挂号信息;
    Exit When c_挂号单%NotFound;
    v_Temp := '<GH>';
    v_Temp := v_Temp || '<ID>' || r_挂号信息.Id || '</ID>';
    v_Temp := v_Temp || '<GHD>' || r_挂号信息.No || '</GHD>';
    v_Temp := v_Temp || '<SFYY>' || r_挂号信息.预约单 || '</SFYY>';
    v_Temp := v_Temp || '<BRID>' || r_挂号信息.病人id || '</BRID>';
    v_Temp := v_Temp || '<MZH>' || r_挂号信息.门诊号 || '</MZH>';
    v_Temp := v_Temp || '<XM>' || r_挂号信息.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || r_挂号信息.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || r_挂号信息.年龄 || '</NL>';
    v_Temp := v_Temp || '<CSRQ>' || To_Char(r_挂号信息.出生日期, 'yyyy-mm-dd hh24:mi:ss') || '</CSRQ>';
    v_Temp := v_Temp || '<SFZH>' || r_挂号信息.身份证号 || '</SFZH>';
    v_Temp := v_Temp || '<CXKH>' || r_挂号信息.卡号 || '</CXKH>';
    v_Temp := v_Temp || '<YSID>' || r_挂号信息.医生id || '</YSID>';
    v_Temp := v_Temp || '<YSXM>' || r_挂号信息.医生姓名 || '</YSXM>';
    v_Temp := v_Temp || '<KSID>' || r_挂号信息.科室id || '</KSID>';
    v_Temp := v_Temp || '<KSMC>' || r_挂号信息.科室名称 || '</KSMC>';
    v_Temp := v_Temp || '<GHSJ>' || To_Char(r_挂号信息.登记时间, 'yyyy-mm-dd hh24:mi:ss') || '</GHSJ>';
    v_Temp := v_Temp || '</GH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  Close c_挂号单;

  --根据查询条件如果再本科室查询不到数据，然后再去其他科室查询；
  If v_Temp Is Null And v_挂号单 Is Null Then
    For r_挂号 In (Select /* +cardinality(E,10) */
                  a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, b.Id As 医生id, a.执行人 As 医生姓名, c.身份证号, d.Id As 科室id, d.名称 As 科室名称,
                  a.登记时间, a.年龄, c.出生日期, Max(f.卡号) As 卡号, Decode(a.记录性质, 2, 1, 0) As 预约单
                 From 病人挂号记录 A, 人员表 B, 病人信息 C, 部门表 D, Table(f_Num2list(v_病人ids)) E, 病人医疗卡信息 F
                 Where a.记录性质 = Decode(Nvl(n_查询预约, 0), 1, a.记录性质, 1) And a.记录状态 = 1 And Nvl(a.执行状态, 0) = 0 And
                       a.执行人 = b.姓名(+) And a.病人id = c.病人id And a.病人id = e.Column_Value And a.执行部门id = d.Id And
                       a.诊室 Is Null And a.发生时间 Between Trunc(d_日期 - n_挂号天数) And Trunc(d_日期 + 1) - 1 / 24 / 60 / 60 And
                       c.病人id = f.病人id(+) And f.卡类别id(+) = n_查询卡类别id And Nvl(f.状态, 0) = 0
                 Group By a.Id, a.No, a.病人id, a.门诊号, a.姓名, a.性别, b.Id, a.执行人, c.身份证号, d.Id, d.名称, a.登记时间, a.年龄, c.出生日期,
                          Decode(a.记录性质, 2, 1, 0)) Loop
      v_Temp := '<GH>';
      v_Temp := v_Temp || '<ID>' || r_挂号.Id || '</ID>';
      v_Temp := v_Temp || '<GHD>' || r_挂号.No || '</GHD>';
      v_Temp := v_Temp || '<SFYY>' || r_挂号.预约单 || '</SFYY>';
      v_Temp := v_Temp || '<BRID>' || r_挂号.病人id || '</BRID>';
      v_Temp := v_Temp || '<MZH>' || r_挂号.门诊号 || '</MZH>';
      v_Temp := v_Temp || '<XM>' || r_挂号.姓名 || '</XM>';
      v_Temp := v_Temp || '<XB>' || r_挂号.性别 || '</XB>';
      v_Temp := v_Temp || '<NL>' || r_挂号.年龄 || '</NL>';
      v_Temp := v_Temp || '<CSRQ>' || To_Char(r_挂号.出生日期, 'yyyy-mm-dd hh24:mi:ss') || '</CSRQ>';
      v_Temp := v_Temp || '<SFZH>' || r_挂号.身份证号 || '</SFZH>';
      v_Temp := v_Temp || '<CXKH>' || r_挂号.卡号 || '</CXKH>';
      v_Temp := v_Temp || '<YSID>' || r_挂号.医生id || '</YSID>';
      v_Temp := v_Temp || '<YSXM>' || r_挂号.医生姓名 || '</YSXM>';
      v_Temp := v_Temp || '<KSID>' || r_挂号.科室id || '</KSID>';
      v_Temp := v_Temp || '<KSMC>' || r_挂号.科室名称 || '</KSMC>';
      v_Temp := v_Temp || '<GHSJ>' || To_Char(r_挂号.登记时间, 'yyyy-mm-dd hh24:mi:ss') || '</GHSJ>';
      v_Temp := v_Temp || '</GH>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
  End If;

  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpatireg;
/
Create Or Replace Procedure Zl_Third_Getregistalter
(
  Xml_In  Xmltype,
  Xml_Out Out Xmltype
) Is
  -----------------------------------------------
  --功能：获取当天操作的停换诊安排
  --入参：XML_IN
  --<IN>
  --  <JSKLB>结算卡类别</JSKLB>
  --  <RQ>日期</RQ>
  --</IN>
  --出参:XML_OUT
  --<OUTPUT>
  --  <TZLISTS>          //停诊列表
  --    <ITEM>
  --      <HM>号码</HM>
  --      <YSID>医生ID</YSID>
  --      <YS>医生姓名</YS>
  --      <KSSJ>停诊开始时间</KSSJ>
  --      <JSSJ>停诊结束时间</JSSJ>
  --      <BRLIST>
  --        <INFO>
  --          <YYNO>预约单据号</YYNO>
  --          <BRID>病人ID</BRID>
  --          <YYSJ>预约时间</YYSJ>
  --          <CZSJ>操作时间</CZSJ>
  --          <YYKS>预约科室</YYKS>
  --          <GHLX>号类</GHLX>
  --          <YSXM>医生姓名</YSXM>
  --        </INFO>
  --      </BRLIST>
  --    </ITEM>
  --  </TZLISTS>
  --  <HZLISTS>          //换诊列表
  --    <ITEM>
  --      <BRID>病人ID</BRID>
  --      <YYSJ>预约的操作时间</YYSJ>
  --      <YSJ>原预约时间</YSJ>
  --      <YHM>原号码</YHM>
  --      <YYS>原医生</YYS>
  --      <YZC>原医生的职称</YZC>
  --      <XSJ>现预约时间</XSJ>
  --      <XHM>现号码</XHM>
  --      <XYS>现医生</XYS>
  --      <XZC>现医生的职称</XZC>
  --    </ITEM>
  --  </HZLIST>
  --</OUTPUT>
  -----------------------------------------------------

  d_Date     Date;
  v_Jsklb    Varchar2(100);
  n_卡类别id 医疗卡类别.Id%Type;
  n_Cnt      Number(3);
  v_Temp     Clob;
  v_Brinfo   Varchar2(4000);
  d_启用时间 Date;
  v_Para     Varchar2(2000);
  n_Exists   Number(3);
  n_挂号模式 Number(3);
  x_Templet  Xmltype;
Begin
  Select Extractvalue(Value(A), 'IN/JSKLB') Into v_Jsklb From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  Select To_Date(Extractvalue(Value(A), 'IN/RQ'), 'yyyy-mm-dd')
  Into d_Date
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select b.Id Into n_卡类别id From 医疗卡类别 B Where b.名称 = v_Jsklb And Rownum < 2;
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  v_Para     := zl_GetSysParameter(256);
  n_挂号模式 := Substr(v_Para, 1, 1);
  Begin
    d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
  Exception
    When Others Then
      d_启用时间 := Null;
  End;

  If n_挂号模式 = 1 And Nvl(d_Date, Sysdate) > Nvl(d_启用时间, Sysdate - 30) Then
    --出诊表排班模式
    --获取停诊安排
    For r_停诊 In (Select a.Id As 记录id, b.号码, a.医生id, a.医生姓名, a.停诊开始时间, a.停诊终止时间
                 From 临床出诊记录 A, 临床出诊号源 B, 临床出诊停诊记录 C
                 Where a.Id = c.记录id And a.号源id = b.Id And a.停诊开始时间 Is Not Null And c.审批时间 Between d_Date And
                       d_Date + 1 - 1 / 24 / 60 / 60) Loop
      v_Temp := v_Temp || '<ITEM><HM>' || r_停诊.号码 || '</HM><YSID>' || r_停诊.医生id || '</YSID><YS>' || r_停诊.医生姓名 ||
                '</YS><KSSJ>' || r_停诊.停诊开始时间 || '</KSSJ><JSSJ>' || r_停诊.停诊终止时间 || '</JSSJ><BRLIST>';
      For r_停诊病人 In (Select a.记录性质, a.No, a.病人id, To_Char(a.发生时间, 'yyyy-mm-dd') As 发生时间,
                            To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, b.名称, d.号类, c.医生姓名 As 医生姓名
                     From 病人挂号记录 A, 部门表 B, 临床出诊记录 C, 临床出诊号源 D
                     Where a.执行部门id = b.Id And a.出诊记录id = c.Id And c.号源id = d.Id And 记录状态 = 1 And
                           发生时间 Between r_停诊.停诊开始时间 And r_停诊.停诊终止时间 And a.出诊记录id = r_停诊.记录id And Not Exists
                      (Select 1 From 就诊变动记录 Where 挂号单 = a.No)) Loop
        --停诊病人列表，不包含已经换诊和取消了的病人
        If r_停诊病人.记录性质 = 2 Then
          v_Brinfo := '<INFO><YYNO>' || r_停诊病人.No || '</YYNO><BRID>' || r_停诊病人.病人id || '</BRID><YYSJ>' || r_停诊病人.发生时间 ||
                      '</YYSJ><CZSJ>' || r_停诊病人.登记时间 || '</CZSJ>' || '<YYKS>' || r_停诊病人.名称 || '</YYKS><GHLX>' ||
                      r_停诊病人.号类 || '</GHLX><YSXM>' || r_停诊病人.医生姓名 || '</YSXM></INFO>';
          v_Temp   := v_Temp || v_Brinfo;
        Else
          Begin
            Select 1
            Into n_Exists
            From 病人预交记录
            Where NO = r_停诊病人.No And 记录性质 = 4 And 卡类别id = n_卡类别id;
          Exception
            When Others Then
              n_Exists := 0;
          End;
          If n_Exists = 1 Then
            v_Brinfo := '<INFO><YYNO>' || r_停诊病人.No || '</YYNO><BRID>' || r_停诊病人.病人id || '</BRID><YYSJ>' || r_停诊病人.发生时间 ||
                        '</YYSJ><CZSJ>' || r_停诊病人.登记时间 || '</CZSJ>' || '<YYKS>' || r_停诊病人.名称 || '</YYKS><GHLX>' ||
                        r_停诊病人.号类 || '</GHLX><YSXM>' || r_停诊病人.医生姓名 || '</YSXM></INFO>';
            v_Temp   := v_Temp || v_Brinfo;
          End If;
        End If;
        v_Brinfo := '';
      End Loop;
      v_Temp := v_Temp || '</BRLIST></ITEM>';
    End Loop;
    v_Temp := '<TZLISTS>' || v_Temp || '</TZLISTS>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    --换取换诊列表
    v_Temp := '';
    For r_换诊 In (Select d.记录性质, d.No, a.病人id, To_Char(d.发生时间, 'yyyy-mm-dd hh24:mi:ss') As 预约时间,
                        To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, a.原号码, a.原医生姓名, b.专业技术职务 As 原职务, a.现号码, a.现医生姓名,
                        c.专业技术职务 As 现职务
                 From 就诊变动记录 A, 人员表 B, 人员表 C, 病人挂号记录 D
                 Where a.登记时间 Between d_Date And d_Date + 1 - 1 / 24 / 60 / 60 And a.原医生id = b.Id And a.现医生id = c.Id And
                       a.挂号单 = d.No) Loop
      --只返回该卡类别挂号的病人         
      If r_换诊.记录性质 = 2 Then
        v_Temp := v_Temp || '<ITEM><BRID>' || r_换诊.病人id || '</BRID><YYSJ>' || r_换诊.登记时间 || '</YYSJ>';
        v_Temp := v_Temp || '<YSJ>' || r_换诊.预约时间 || '</YSJ><YHM>' || r_换诊.原号码 || '</YHM><YYS>' || r_换诊.原医生姓名 ||
                  '</YYS><YZC>' || r_换诊.原职务 || '</YZC>';
        v_Temp := v_Temp || '<XSJ>' || r_换诊.预约时间 || '</XSJ><XHM>' || r_换诊.现号码 || '</XHM><XYS>' || r_换诊.现医生姓名 ||
                  '</XYS><XZC>' || r_换诊.现职务 || '</XZC></ITEM>';
      Else
        Begin
          Select 1 Into n_Exists From 病人预交记录 Where NO = r_换诊.No And 记录性质 = 4 And 卡类别id = n_卡类别id;
        Exception
          When Others Then
            n_Exists := 0;
        End;
        If n_Exists = 1 Then
          v_Temp := v_Temp || '<ITEM><BRID>' || r_换诊.病人id || '</BRID><YYSJ>' || r_换诊.登记时间 || '</YYSJ>';
          v_Temp := v_Temp || '<YSJ>' || r_换诊.预约时间 || '</YSJ><YHM>' || r_换诊.原号码 || '</YHM><YYS>' || r_换诊.原医生姓名 ||
                    '</YYS><YZC>' || r_换诊.原职务 || '</YZC>';
          v_Temp := v_Temp || '<XSJ>' || r_换诊.预约时间 || '</XSJ><XHM>' || r_换诊.现号码 || '</XHM><XYS>' || r_换诊.现医生姓名 ||
                    '</XYS><XZC>' || r_换诊.现职务 || '</XZC></ITEM>';
        End If;
      End If;
    End Loop;
    v_Temp := '<HZLISTS>' || v_Temp || '</HZLISTS>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Else
    --计划排班模式
    --获取停诊安排
    For Rs In (Select b.号码, b.医生id, b.医生姓名, To_Char(a.开始停止时间, 'yyyy-mm-dd hh24:mi:ss') As 开始停止时间,
                      To_Char(a.结束停止时间, 'yyyy-mm-dd hh24:mi:ss') As 结束停止时间
               From 挂号安排停用状态 A, 挂号安排 B
               Where a.安排id = b.Id And a.制订日期 Between d_Date And d_Date + 1 - 1 / 24 / 60 / 60) Loop
      v_Temp := v_Temp || '<ITEM><HM>' || Rs.号码 || '</HM><YSID>' || Rs.医生id || '</YSID><YS>' || Rs.医生姓名 ||
                '</YS><KSSJ>' || Rs.开始停止时间 || '</KSSJ><JSSJ>' || Rs.结束停止时间 || '</JSSJ><BRLIST>';
      ----2015/7/28
      For Rs_Br In (Select a.No, a.病人id, To_Char(a.发生时间, 'yyyy-mm-dd') As 发生时间,
                           To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, b.名称, c.号类, a.执行人 As 医生姓名
                    From 病人挂号记录 A, 部门表 B, 挂号安排 C
                    Where a.号别 = Rs.号码 And a.执行状态 = 0 And a.执行部门id = b.Id And b.Id = c.科室id And a.号别 = c.号码 And
                          Trunc(发生时间) Between Trunc(To_Date(Rs.开始停止时间, 'yyyy-mm-dd hh24:mi:ss')) And
                          Trunc(To_Date(Rs.结束停止时间, 'yyyy-mm-dd hh24:mi:ss'))) Loop
        --只返回该卡类别挂号的病人
        Select Count(*)
        Into n_Cnt
        From (Select 1
               From 病人预交记录 A
               Where a.No = Rs_Br.No And a.记录性质 = 4 And a.记录状态 = 1 And a.病人id = Rs_Br.病人id And 卡类别id = n_卡类别id
               Union All
               Select 1 From 病人挂号记录 Where NO = Rs_Br.No And 记录状态 = 1 And 交易说明 = v_Jsklb);
        If n_Cnt > 0 Then
          v_Brinfo := '<INFO><YYNO>' || Rs_Br.No || '</YYNO><BRID>' || Rs_Br.病人id || '</BRID><YYSJ>' || Rs_Br.发生时间 ||
                      '</YYSJ><CZSJ>' || Rs_Br.登记时间 || '</CZSJ>' || '<YYKS>' || Rs_Br.名称 || '</YYKS><GHLX>' || Rs_Br.号类 ||
                      '</GHLX><YSXM>' || Rs_Br.医生姓名 || '</YSXM></INFO>';
          v_Temp   := v_Temp || v_Brinfo;
        End If;
        v_Brinfo := '';
      End Loop;
      v_Temp := v_Temp || '</BRLIST></ITEM>';
    End Loop;
    v_Temp := '<TZLISTS>' || v_Temp || '</TZLISTS>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    --获取换诊记录
    v_Temp := '';
    For Rs In (Select d.No, a.病人id, To_Char(d.发生时间, 'yyyy-mm-dd hh24:mi:ss') As 预约时间,
                      To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, a.原号码, a.原医生姓名, b.专业技术职务 As 原职务, a.现号码, a.现医生姓名,
                      c.专业技术职务 As 现职务
               From 就诊变动记录 A, 人员表 B, 人员表 C, 病人挂号记录 D
               Where a.登记时间 Between d_Date And d_Date + 1 - 1 / 24 / 60 / 60 And a.原医生id = b.Id And a.现医生id = c.Id And
                     a.挂号单 = d.No) Loop
      --只返回该卡类别挂号的病人         
      Select Count(*)
      Into n_Cnt
      From (Select 1
             From 病人预交记录 A
             Where a.No = Rs.No And a.记录性质 = 4 And a.记录状态 = 1 And a.病人id = Rs.病人id And 卡类别id = n_卡类别id
             Union All
             Select 1 From 病人挂号记录 Where NO = Rs.No And 记录状态 = 1 And 交易说明 = v_Jsklb);
      If n_Cnt > 0 Then
        v_Temp := v_Temp || '<ITEM><BRID>' || Rs.病人id || '</BRID><YYSJ>' || Rs.登记时间 || '</YYSJ>';
        v_Temp := v_Temp || '<YSJ>' || Rs.预约时间 || '</YSJ><YHM>' || Rs.原号码 || '</YHM><YYS>' || Rs.原医生姓名 || '</YYS><YZC>' ||
                  Rs.原职务 || '</YZC>';
        v_Temp := v_Temp || '<XSJ>' || Rs.预约时间 || '</XSJ><XHM>' || Rs.现号码 || '</XHM><XYS>' || Rs.现医生姓名 || '</XYS><XZC>' ||
                  Rs.现职务 || '</XZC></ITEM>';
      End If;
    End Loop;
    v_Temp := '<HZLISTS>' || v_Temp || '</HZLISTS>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End If;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getregistalter;
/
Create Or Replace Procedure Zl_Third_Getpayfeedetail
(
  Xml_In  In Xmltype,
  Xml_Out In Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取收费划价单费用明细
  --入参:Xml_In:
  --<IN>
  --  <BRID></BRID> //病人ID
  --  <XM></XM> //姓名
  --  <SFZH></SFZH> //身份证号
  --  <DJH></DJH> //单据号
  --</IN>
  --出参:Xml_Out
  -- <OUTPUT>
  --  <ZJE></ZJE>   //总实收金额
  --  <MXLIST>        //项目明细
  --    <ITEM>
  --      <DJH></DJH>       //单据号
  --      <MC></MC>   //项目名称
  --      <ID></ID>   //项目ID
  --      <SL></SL>   //数量，数次*付数
  --      <YSJE></YSJE>   //应收金额
  --      <SSJE></SSJE>   //实收金额
  --      <SJFM></SJFM>       //收据费目
  --    </ITEM>
  --    <ITEM>
  --    ...
  --    </ITEM>
  --  </MXLIST>
  -- </OUTPUT>

  --------------------------------------------------------------------------------------------------
  x_Templet    Xmltype; --模板XML
  v_Err_Msg    varchar2(200);
  v_Temp       varchar2(4000);
  v_Nos        varchar2(4000);
  n_病人id     病人信息.病人id%Type;
  v_姓名     病人信息.姓名%Type;
  v_身份证号   病人信息.身份证号%Type;
  v_费别       病人信息.费别%Type;
  v_号码       挂号安排.号码%Type;
  n_总金额     门诊费用记录.实收金额%Type;
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/DJH'), Extractvalue(Value(A), 'IN/SFZH'),
  Extractvalue(Value(A), 'IN/XM')
  Into n_病人id, v_Nos, v_身份证号, v_姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '无法确定病人信息,请检查';
    Raise Err_Item;
  End If;

  n_总金额 := 0;

  For c_项目 In (Select a.收费细目id As 项目id, a.应收金额, a.实收金额, a.计算单位, a.收据费目, b.名称 As 项目名称, a.No, Nvl(a.付数, 1) As 付数, a.数次
               From 门诊费用记录 A, 收费项目目录 B, Table(f_Str2list(v_Nos)) C
               Where a.收费细目id = b.Id And a.No = c.Column_Value And a.记录性质 = 1 And a.记录状态 = 0
               Order By NO, 序号) Loop
    n_总金额 := n_总金额 + Nvl(c_项目.实收金额, 0);
    v_号码   := c_项目.计算单位;
    v_Temp   := v_Temp || '<ITEM><DJH>' || c_项目.No || '</DJH><MC>' || c_项目.项目名称 || '</MC>' || '<ID>' || c_项目.项目id ||
                '</ID>' || '<SL>' || c_项目.付数 * c_项目.数次 || '</SL>' || '<YSJE>' || c_项目.应收金额 || '</YSJE>' || '<SSJE>' ||
                c_项目.实收金额 || '</SSJE>' || '<SJFM>' || c_项目.收据费目 || '</SJFM></ITEM>';
  End Loop;

  v_Temp := '<MXLIST>' || v_Temp || '</MXLIST>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<ZJE>' || n_总金额 || '</ZJE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpayfeedetail;
/
Create Or Replace Procedure Zl_Third_Getregfeedetail
(
  Xml_In  In Xmltype,
  Xml_Out In Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取挂号费用明细
  --入参:Xml_In:
  --<IN>
  --  <BRID></BRID> //病人ID
  --  <XM></XM>     //姓名
  --  <SFZH></SFZH> //身份证号
  --  <APID></APID>     //安排ID
  --  <JHID></JHID>     //计划ID
  --  <CZJLID><CZJLID>  //出诊记录ID
  --  <SFYY></SFYY> //是否仅预约不支付,1-仅预约不支付,0-挂号,预约支付,预约接收，默认为0
  --  <GHDH></GHDH> //挂号单号,预约接收时传入
  --  <GHHM></GHHM> //挂号安排号码,挂号和预约时传入
  --  <XMID></XMID> //挂号安排的项目ID,挂号和预约时传入
  --  <FB></FB>     //病人费别
  --  <FKFS></FKFS> //付款方式
  --  <RQ></RQ>     //日期
  --  <ZD></ZD>     //站点
  --</IN>
  --出参:Xml_Out
  -- <OUTPUT>
  --  <ZJE></ZJE>   //总实收金额
  --  <XMMX>        //项目明细
  --    <XM>
  --      <DJH></DJH>       //单据号
  --      <MC></MC>   //项目名称
  --      <ID></ID>   //项目ID
  --      <SL></SL>   //数量，数次*付数
  --      <YSJE></YSJE>   //应收金额
  --      <SSJE></SSJE>   //实收金额
  --      <SJFM></SJFM>       //收据费目
  --    </XM>
  --    <XM>
  --    ...
  --    </XM>
  --  </XMMX>
  -- </OUTPUT>

  --------------------------------------------------------------------------------------------------
  x_Templet    Xmltype; --模板XML
  v_Err_Msg    Varchar2(200);
  v_Temp       Varchar2(4000);
  n_项目id     挂号安排.项目id%Type;
  v_No         门诊费用记录.No%Type;
  n_预约       Number(3);
  n_病人id     病人信息.病人id%Type;
  v_姓名       病人信息.姓名%Type;
  v_身份证号   病人信息.身份证号%Type;
  v_费别       病人信息.费别%Type;
  v_付款方式   医疗付款方式.名称%Type;
  v_方式       Varchar2(20);
  d_日期       Date;
  v_站点       部门表.站点%Type;
  v_号码       挂号安排.号码%Type;
  n_总金额     门诊费用记录.实收金额%Type;
  n_实收金额   门诊费用记录.实收金额%Type;
  v_实收       Varchar(500);
  v_附加项目id Varchar2(500);
  v_性别       病人信息.性别%Type;
  v_年龄       病人信息.年龄%Type;
  d_出生日期   病人信息.出生日期%Type;
  n_更新项目id 挂号安排.项目id%Type;
  n_安排id     挂号安排.Id%Type;
  n_计划id     挂号安排计划.Id%Type;
  n_出诊记录id 临床出诊记录.Id%Type;
  v_传入       Varchar2(100);
  v_普通等级   Varchar2(100);
  v_Pricegrade Varchar2(500);
  v_附加内容   Varchar2(500);
  v_附加值     Varchar2(100);
  n_cursor     Number(3);
  
  TYPE Price_type IS RECORD(项目ID 门诊费用记录.收费细目ID%Type,
                              数次 门诊费用记录.数次%TYPE, 
                              单价 门诊费用记录.标准单价%TYPE, 
                              应收 门诊费用记录.应收金额%TYPE, 
                              实收 门诊费用记录.实收金额%TYPE);--定义Price记录类型 
  TYPE Price_type_array IS TABLE OF Price_type INDEX BY BINARY_INTEGER;--定义存放Price记录的数组类型 
  Price_rec Price_type;--声明变量，类型：Price记录类型
  Price_rec_array Price_type_array;--声明变量，类型：存放Price记录的数组类型
  
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/XMID'), Extractvalue(Value(A), 'IN/GHHM'),
         Extractvalue(Value(A), 'IN/FB'), Extractvalue(Value(A), 'IN/ZD'), Extractvalue(Value(A), 'IN/SFYY'),
         Extractvalue(Value(A), 'IN/GHDH'), Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM'),
         To_Date(Extractvalue(Value(A), 'IN/RQ'), 'yyyy-mm-dd hh24:mi:ss'), Extractvalue(Value(A), 'IN/FKFS')
  Into n_病人id, n_项目id, v_号码, v_费别, v_站点, n_预约, v_No, v_身份证号, v_姓名, d_日期, v_方式
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If d_日期 Is Null Then
    d_日期 := Sysdate;
  End If;

  If v_方式 Is Null Then
    Select Max(名称) Into v_付款方式 From 医疗付款方式 Where 缺省标志 = 1;
  Else
    Select Max(名称) Into v_付款方式 From 医疗付款方式 Where 编码 = v_方式;
    If v_付款方式 Is Null Then
      v_付款方式 := v_方式;
    End If;
  End If;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '无法确定病人信息,请检查';
    Raise Err_Item;
  End If;

  Select 性别, 年龄, 出生日期 Into v_性别, v_年龄, d_出生日期 From 病人信息 Where 病人id = n_病人id;

  If Nvl(n_出诊记录id, 0) <> 0 Then
    v_传入 := '2|' || n_出诊记录id;
  Else
    If Nvl(n_计划id, 0) <> 0 Then
      v_传入 := '1|' || n_计划id;
    Else
      If Nvl(n_安排id, 0) <> 0 Then
        v_传入 := '0|' || n_安排id;
      End If;
    End If;
  End If;
  If v_传入 Is Null Then
    v_传入 := '3|' || v_号码;
  End If;

  n_更新项目id := Zl_Custom_Getregeventitem(n_病人id, v_姓名, v_身份证号, d_出生日期, v_性别, v_年龄, v_传入);
  If Nvl(n_更新项目id, 0) <> 0 Then
    n_项目id := n_更新项目id;
  End If;

  v_Pricegrade := Zl_Get_Pricegrade(v_站点, n_病人id, Null, v_付款方式);
  v_普通等级   := Substr(v_Pricegrade, 1, Instr(v_Pricegrade, '|') - 1);

  n_总金额 := 0;
  If v_No Is Null Then
    --挂号或者预约
    For c_挂号项目 In (Select 1 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次,
                          c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                   From 收费项目目录 A, 收费价目 B, 收入项目 C
                   Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = n_项目id And d_日期 Between b.执行日期 And
                         Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                         (b.价格等级 = v_普通等级 Or (b.价格等级 Is Null And Not Exists
                          (Select 1
                                               From 收费价目
                                               Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And d_日期 Between 执行日期 And
                                                     Nvl(终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')))))
                   Union All
                   Select 2 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, d.从项数次 As 数次,
                          c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                   From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费从属项目 D
                   Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.从项id And d.主项id = n_项目id And
                         d_日期 Between b.执行日期 And Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                         (b.价格等级 = v_普通等级 Or (b.价格等级 Is Null And Not Exists
                          (Select 1
                                               From 收费价目
                                               Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And d_日期 Between 执行日期 And
                                                     Nvl(终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')))))) Loop
      v_实收     := Zl_Actualmoney(v_费别, c_挂号项目.项目id, c_挂号项目.收入项目id, c_挂号项目.数次 * c_挂号项目.单价);
      n_实收金额 := To_Number(Substr(v_实收, Instr(v_实收, ':') + 1));
      n_总金额   := n_总金额 + Nvl(n_实收金额, 0);
      v_Temp     := v_Temp || '<XM><DJH></DJH><MC>' || c_挂号项目.项目名称 || '</MC>' || '<ID>' || c_挂号项目.项目id || '</ID>' ||
                    '<SL>' || c_挂号项目.数次 || '</SL>' || '<YSJE>' || c_挂号项目.数次 * c_挂号项目.单价 || '</YSJE>' || '<SSJE>' ||
                    n_实收金额 || '</SSJE>' || '<SJFM>' || c_挂号项目.收据费目 || '</SJFM></XM>';
    End Loop;
  Else
    --预约接收
    For c_挂号项目 In (Select a.收费细目id As 项目id, a.应收金额, a.实收金额, a.计算单位, a.收据费目, b.名称 As 项目名称, a.No, Nvl(a.付数, 1) As 付数, a.数次
                   From 门诊费用记录 A, 收费项目目录 B
                   Where a.收费细目id = b.Id And a.No = v_No And a.记录性质 = 4 And a.记录状态 = 0) Loop
      n_总金额 := n_总金额 + Nvl(c_挂号项目.实收金额, 0);
      v_号码   := c_挂号项目.计算单位;
      v_Temp   := v_Temp || '<XM><DJH>' || c_挂号项目.No || '</DJH><MC>' || c_挂号项目.项目名称 || '</MC>' || '<ID>' || c_挂号项目.项目id ||
                  '</ID>' || '<SL>' || c_挂号项目.付数 * c_挂号项目.数次 || '</SL>' || '<YSJE>' || c_挂号项目.应收金额 || '</YSJE>' ||
                  '<SSJE>' || c_挂号项目.实收金额 || '</SSJE>' || '<SJFM>' || c_挂号项目.收据费目 || '</SJFM></XM>';
    End Loop;
  End If;

  If Nvl(n_预约, 0) = 0 Then
    Begin
      Select Zl_Fun_Customregexpenses(n_病人id, 0, v_号码, v_姓名, v_性别, v_年龄, v_身份证号, v_费别, v_付款方式) Into v_附加项目id From Dual;
    Exception
      When Others Then
        v_附加项目id := Null;
    End;
    If v_附加项目id Is Not Null Then
      IF Instr(v_附加项目id, '|') > 0 Then
        v_附加内容 := v_附加项目id || ','; --以空格分开以|结尾,没有结算号码的
        v_附加项目id := '';
        n_cursor   := 0;
        While v_附加内容 Is Not Null Loop
          v_附加值 := Substr(v_附加内容, 1, Instr(v_附加内容, ',') - 1);
          Price_rec.项目ID := To_Number(Substr(v_附加值, 1, Instr(v_附加值, '|') - 1));
        
          v_附加值 := Substr(v_附加值, Instr(v_附加值, '|') + 1);
          Price_rec.数次 := To_Number(Substr(v_附加值, 1, Instr(v_附加值, '|') - 1));
        
          v_附加值 := Substr(v_附加值, Instr(v_附加值, '|') + 1);
          Price_rec.单价 := To_Number(Substr(v_附加值, 1, Instr(v_附加值, '|') - 1));
          
          v_附加值 := Substr(v_附加值, Instr(v_附加值, '|') + 1);
          Price_rec.应收 := To_Number(Substr(v_附加值, 1, Instr(v_附加值, '|') - 1));
        
          v_附加值 := Substr(v_附加值, Instr(v_附加值, '|') + 1);
          Price_rec.实收 := To_Number(v_附加值);
          n_cursor := n_cursor + 1;
          Price_rec_array(n_cursor):=Price_rec;
          v_附加内容 := Substr(v_附加内容, Instr(v_附加内容, ',') + 1);
          v_附加项目id := v_附加项目id || ',' || Price_rec_array(n_cursor).项目ID;
        End Loop;
        
        If v_附加项目id is not null then
          v_附加项目id := substr(v_附加项目id, 2);
        End if;
        
        For c_附加项目 In (Select /*+cardinality(D,10)*/
                        5 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次, c.Id As 收入项目id,
                        c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                       From 收费项目目录 A, 收费价目 B, 收入项目 C, Table(f_Str2list(v_附加项目id)) D
                       Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.Column_Value And d_日期 Between b.执行日期 And
                             Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                             (b.价格等级 = v_普通等级 Or
                             (b.价格等级 Is Null And Not Exists
                              (Select 1
                                From 收费价目
                                Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And d_日期 Between 执行日期 And
                                      Nvl(终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))))))  Loop
          FOR n_cursor IN 1..Price_rec_array.count LOOP        
            IF c_附加项目.项目id = Price_rec_array(n_cursor).项目ID Then
              n_实收金额 := Price_rec_array(n_cursor).实收;
              n_总金额   := n_总金额 + Nvl(n_实收金额, 0);
              v_Temp     := v_Temp || '<XM><DJH></DJH><MC>' || c_附加项目.项目名称 || '</MC>' || '<ID>' || c_附加项目.项目id || '</ID>' ||
                          '<SL>' || Price_rec_array(n_cursor).数次 || '</SL>' || '<YSJE>' || Price_rec_array(n_cursor).应收 || '</YSJE>' || '<SSJE>' ||
                          Price_rec_array(n_cursor).实收 || '</SSJE>' || '<SJFM>' || c_附加项目.收据费目 || '</SJFM></XM>';
              EXIT;
            End IF;
          End LOOP;
        End Loop;  
      Else
        For c_附加项目 In (Select /*+cardinality(D,10)*/
                        5 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次, c.Id As 收入项目id,
                        c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                       From 收费项目目录 A, 收费价目 B, 收入项目 C, Table(f_Str2list(v_附加项目id)) D
                       Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.Column_Value And d_日期 Between b.执行日期 And
                             Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                             (b.价格等级 = v_普通等级 Or
                             (b.价格等级 Is Null And Not Exists
                              (Select 1
                                From 收费价目
                                Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And d_日期 Between 执行日期 And
                                      Nvl(终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')))))
                       Union All
                       Select /*+cardinality(E,10)*/
                        5 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, d.从项数次 As 数次,
                        c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                       From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费从属项目 D, Table(f_Str2list(v_附加项目id)) E
                       Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.从项id And d.主项id = e.Column_Value And
                             d_日期 Between b.执行日期 And Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                             (b.价格等级 = v_普通等级 Or
                             (b.价格等级 Is Null And Not Exists
                              (Select 1
                                From 收费价目
                                Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And d_日期 Between 执行日期 And
                                      Nvl(终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')))))) Loop
          v_实收     := Zl_Actualmoney(v_费别, c_附加项目.项目id, c_附加项目.收入项目id, c_附加项目.数次 * c_附加项目.单价);
          n_实收金额 := To_Number(Substr(v_实收, Instr(v_实收, ':') + 1));
          n_总金额   := n_总金额 + Nvl(n_实收金额, 0);
          v_Temp     := v_Temp || '<XM><DJH></DJH><MC>' || c_附加项目.项目名称 || '</MC>' || '<ID>' || c_附加项目.项目id || '</ID>' ||
                        '<SL>' || c_附加项目.数次 || '</SL>' || '<YSJE>' || c_附加项目.数次 * c_附加项目.单价 || '</YSJE>' || '<SSJE>' ||
                        n_实收金额 || '</SSJE>' || '<SJFM>' || c_附加项目.收据费目 || '</SJFM></XM>';
        End Loop;
      End IF;
    End If;
  End If;

  v_Temp := '<XMMX>' || v_Temp || '</XMMX>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<ZJE>' || n_总金额 || '</ZJE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getregfeedetail;
/
Create Or Replace Procedure Zl_Third_Registercheck
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:HIS挂号检查
  --入参:Xml_In:
  --<IN>
  --  <BRID>1</BRID>                    //病人ID
  --  <XM>姓名</XM>                     //姓名
  --  <SFZH>510221197008184710</SFZH>   //身份证号
  --  <HM>0100</HM>                     //号码
  --  <HX>01</HX>                       //号序
  --  <CZJLID>100</CZJLID>              //出诊记录ID,计划排班模式可以不传
  --  <GHSJ>2016-08-10 09:52:00</GHSJ>  //挂号时间
  --  <KSID>1</KSID>                    //科室ID
  --  <YSXM>张震</YSXM>                 //医生姓名
  --  <GHXMID>1</GHXMID>                 //挂号主项目，不传时不检查
  --</IN>

  --出参:Xml_Out
  --对于有病人合并的，格式如下：
  --<OUTPUT>
  --  <TYPE>1</TYPE>        //类型，1表示返回病人合并信息。目前只有1,以后可以扩展。对于合并病人，需要以新病人ID再调一次
  --  <YBRID></YBRID>       //原病人ID
  --  <XBRID></XBRID>       //现病人ID
  --  <XM></XM>             //现姓名
  --  <SFZ></SFZ>           //现身份证
  --</OUTPUT>
  --其它：
  --<OUTPUT>
  -- <JZYJZF></JZYJZF>     //禁止预交支付
  -- <ERROR><MSG></MSG></ERROR> //为空表示检查成功
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_病人id         病人信息.病人id%Type;
  v_姓名           病人信息.姓名%Type;
  v_身份证号       病人信息.身份证号%Type;
  v_号码           挂号安排.号码%Type;
  n_号序           病人挂号记录.号序%Type;
  n_项目ID         挂号安排.项目ID%Type;
  n_出诊记录id     Number(18);
  d_发生时间       病人挂号记录.发生时间%Type;
  v_Para           Varchar2(500);
  d_启用时间       Date;
  n_挂号模式       Number(3);
  n_同科限号数     Number;
  n_同科限约数     Number;
  n_同源限号数     Number;
  n_病人挂号科室数 Number;
  n_病人预约科室数 Number;
  n_专家号挂号限制 Number;
  n_专家号预约限制 Number;
  n_Exists         Number;
  n_Count          Number;
  n_科室id         病人挂号记录.执行部门id%Type;
  v_医生姓名       病人挂号记录.执行人%Type;
  v_性别           病人信息.性别%Type;
  v_年龄           病人信息.年龄%Type;
  n_已约科室       Number;
  v_Checkresult    Varchar2(500);
  v_Temp           Varchar2(32767); --临时XML

  n_合并病人 Number(1);

  Procedure Get_Errmsg
  (
    Errmsg_In Varchar2,
    Xml_Out   Out Xmltype
  ) Is
    v_Temp Varchar2(4000);
  Begin
    v_Temp  := '<MSG>' || Errmsg_In || '</MSG>';
    v_Temp  := '<ERROR>' || v_Temp || '</ERROR>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
  End;
Begin
  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/HM'), Extractvalue(Value(A), 'IN/CZJLID'),
         To_Date(Extractvalue(Value(A), 'IN/GHSJ'), 'yyyy-mm-dd hh24:mi:ss'),
         To_Number(Extractvalue(Value(A), 'IN/KSID')), Extractvalue(Value(A), 'IN/YSXM'),
         Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM'), Extractvalue(Value(A), 'IN/HX'),
         To_Number(Extractvalue(Value(A), 'IN/GHXMID'))
  Into n_病人id, v_号码, n_出诊记录id, d_发生时间, n_科室id, v_医生姓名, v_身份证号, v_姓名, n_号序, n_项目ID
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  n_合并病人 := Zl_Third_Get_Mergepatiinfo(n_病人id, Xml_Out);
  If Nvl(n_合并病人, 0) = 1 Then
    Return;
  End If;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  If Nvl(n_病人id, 0) = 0 Then
    Get_Errmsg('无法确定病人信息,请检查！', Xml_Out);
    Return;
  End If;

  v_Para := zl_GetSysParameter(256);
  If v_Para Is Not Null Then
    n_挂号模式 := Substr(v_Para, 1, 1);
    Begin
      d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
    Exception
      When Others Then
        d_启用时间 := Null;
    End;
  
    If Sysdate - 10 > Nvl(d_启用时间, Sysdate - 30) Then
      If n_挂号模式 = 1 And Nvl(d_发生时间, Sysdate) > Nvl(d_启用时间, Sysdate - 30) And n_出诊记录id Is Null Then
        Get_Errmsg('系统当前处于出诊表排班模式，传入的参数无法确定挂号安排，请重试！', Xml_Out);
        Return;
      End If;
    Else
      If n_挂号模式 = 1 And Nvl(d_发生时间, Sysdate) > Nvl(d_启用时间, Sysdate - 30) And n_出诊记录id Is Null Then
        Begin
          Select a.Id
          Into n_出诊记录id
          From 临床出诊记录 A, 临床出诊号源 B
          Where a.号源id = b.Id And b.号码 = v_号码 And Nvl(d_发生时间, Sysdate) Between a.开始时间 And a.终止时间;
        Exception
          When Others Then
            Get_Errmsg('系统当前处于出诊表排班模式，传入的参数无法确定挂号安排，请重试！', Xml_Out);
            Return;
        End;
      End If;
    End If;
  End If;

  If n_出诊记录id Is Not Null Then
    Begin
      Select 性别, 年龄 Into v_性别, v_年龄 From 病人信息 Where 病人id = n_病人id And Rownum < 2;
    Exception
      When Others Then
        Get_Errmsg('无法确定病人信息,请检查！', Xml_Out);
        Return;
    End;
    v_Checkresult := Zl_临床出诊限制_Check(n_出诊记录id, v_性别, v_年龄);
    If Substr(Nvl(v_Checkresult, '0'), 1, 1) <> '0' Then
      Get_Errmsg('病人不适用该本号别,请检查！', Xml_Out);
      Return;
    End If;
    
    for C_排班 In (Select a.号码, b.科室id, a.项目id From 临床出诊号源 a, 临床出诊记录 b 
                    where a.id = b.号源id And b.Id = n_出诊记录id) loop
      n_Count := 1;
      if v_号码 <> C_排班.号码 then
        Get_Errmsg('挂号信息的号码错误,请检查！', Xml_Out);
        Return;
      Elsif n_科室id <> C_排班.科室id then
        Get_Errmsg('挂号信息的科室错误,请检查！', Xml_Out);
        Return;
      Elsif n_项目id <> C_排班.项目id And Nvl(n_项目id, 0) <> 0 then
        Get_Errmsg('挂号信息的收费项目错误,请检查！', Xml_Out);
        Return;
      end IF;
    end loop;
    
    IF NVL(n_Count, 0) <> 1 Then
      Get_Errmsg('挂号信息错误,请重试！', Xml_Out);
      Return;
    End IF;
  End If;

  If Trunc(Sysdate) > Trunc(d_发生时间) Then
    Get_Errmsg('不能挂以前的号(' || To_Char(d_发生时间, 'yyyy-mm-dd') || ')。', Xml_Out);
    Return;
  End If;

  --当前的序号需要检查是否已过有效时间
  If Nvl(n_号序, 0) <> 0 And Trunc(Sysdate) = Trunc(d_发生时间) Then
    v_Temp := To_Char(Sysdate, 'yyyy-mm-dd') || ' ';
    If n_出诊记录id Is Not Null Then
      --追加号不检查
      For v_时段 In (Select To_Date(v_Temp || To_Char(b.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                          To_Date(To_Char(Sysdate + Decode(Sign(b.开始时间 - b.终止时间), 1, 1, 0), 'yyyy-mm-dd') || ' ' ||
                                   To_Char(b.终止时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 终止时间
                   From 临床出诊记录 A, 临床出诊序号控制 B
                   Where a.Id = b.记录id And a.Id = n_出诊记录id And a.是否序号控制 = 1 And a.是否分时段 = 1 And Nvl(a.是否锁定, 0) = 0 And
                         b.序号 = n_号序 And b.开始时间 <> b.终止时间) Loop
        If Sysdate > v_时段.终止时间 Then
          Get_Errmsg('号别为' || v_号码 || '及号序为' || Nvl(n_号序, 0) || '的安排,已经超过时点！', Xml_Out);
          Return;
        End If;
      End Loop;
    Else
      For v_时段 In (Select To_Date(v_Temp || To_Char(c.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                          To_Date(To_Char(d_发生时间 + Decode(Sign(c.开始时间 - c.结束时间), 1, 1, 0), 'yyyy-mm-dd') || ' ' ||
                                   To_Char(c.结束时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 结束时间
                   From 挂号安排 A, 挂号安排限制 B, 挂号安排时段 C
                   Where a.停用日期 Is Null And a.Id = b.安排id(+) And a.Id = c.安排id And a.号码 = v_号码 And a.序号控制 = 1 And
                         c.序号 = n_号序 And
                         b.限制项目(+) = Decode(To_Char(d_发生时间, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四',
                                            '6', '周五', '7', '周六', Null) And
                         c.星期 = Decode(To_Char(d_发生时间, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                       '周五', '7', '周六', Null) And
                         d_发生时间 Between Nvl(a.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                         Nvl(a.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Not Exists
                    (Select 1
                          From 挂号安排计划
                          Where 安排id = a.Id And (d_发生时间 Between 生效时间 + 0 And 失效时间) And 审核时间 Is Not Null) And Not Exists
                    (Select 1
                          From 挂号安排停用状态
                          Where 安排id = a.Id And d_发生时间 Between 开始停止时间 And 结束停止时间)
                   Union All
                   Select To_Date(To_Char(d_发生时间, 'yyyy-mm-dd') || ' ' || To_Char(c.开始时间, 'hh24:mi:ss'),
                                   'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                          To_Date(To_Char(d_发生时间 + Decode(Sign(c.开始时间 - c.结束时间), 1, 1, 0), 'yyyy-mm-dd') || ' ' ||
                                   To_Char(c.结束时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 结束时间
                   From 挂号安排计划 A, 挂号安排 P, 挂号计划限制 B, 挂号计划时段 C
                   Where a.安排id = p.Id And a.号码 = v_号码 And a.序号控制 = 1 And a.Id = c.计划id And p.Id = b.计划id(+) And
                         c.序号 = n_号序 And
                         a.生效时间 = (Select Max(生效时间)
                                   From 挂号安排计划
                                   Where 安排id = a.安排id And 审核时间 Is Not Null And
                                         d_发生时间 Between Nvl(生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                         失效时间) And
                         b.限制项目(+) = Decode(To_Char(d_发生时间, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四',
                                            '6', '周五', '7', '周六', Null) And
                         c.星期 = Decode(To_Char(d_发生时间, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                       '周五', '7', '周六', Null) And
                         (d_发生时间 Between Nvl(a.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                         a.失效时间) And a.审核时间 Is Not Null And Not Exists
                    (Select 1
                          From 挂号安排停用状态
                          Where 安排id = p.Id And d_发生时间 Between 开始停止时间 And 结束停止时间)) Loop
        If Sysdate > v_时段.结束时间 Then
          Get_Errmsg('号别为' || v_号码 || '及号序为' || n_号序 || '的安排,已经超过时点！', Xml_Out);
          Return;
        End If;
      End Loop;
    End If;
  End If;

  v_Temp := Zl_Identity(0);
  If Nvl(v_Temp, ' ') = ' ' Then
    Get_Errmsg('当前操作人员未设置对应的人员关系,不能继续。', Xml_Out);
    Return;
  End If;

  v_Temp           := Nvl(zl_GetSysParameter('病人同科限挂N个号', 1111), '0|0') || '|';
  n_同科限号数     := To_Number(Substr(v_Temp, 1, Instr(v_Temp, '|') - 1));
  n_同科限约数     := To_Number(Nvl(zl_GetSysParameter('病人同科限约N个号', 1111), '0'));
  n_病人预约科室数 := To_Number(Nvl(zl_GetSysParameter('病人预约科室数', 1111), '0'));
  n_病人挂号科室数 := To_Number(Nvl(zl_GetSysParameter('病人挂号科室限制', 1111), '0'));
  n_专家号挂号限制 := To_Number(Nvl(zl_GetSysParameter('专家号挂号限制'), '0'));
  n_专家号预约限制 := To_Number(Nvl(zl_GetSysParameter('专家号预约限制'), '0'));
  n_同源限号数     := To_Number(Nvl(zl_GetSysParameter('病人同一号源限挂N个号', 1111), '0'));

  If Trunc(Sysdate) <> Trunc(d_发生时间) Then
    If Nvl(n_病人预约科室数, 0) <> 0 Then
      n_已约科室 := 0;
      For c_Chkitem In (Select Distinct 执行部门id
                        From 病人挂号记录
                        Where 病人id = n_病人id And 记录状态 = 1 And 记录性质 = 2 And 预约时间 Between Trunc(d_发生时间) And
                              Trunc(d_发生时间) + 1 - 1 / 24 / 60 / 60 And 执行部门id <> n_科室id) Loop
        n_已约科室 := n_已约科室 + 1;
      End Loop;
      If n_已约科室 >= Nvl(n_病人预约科室数, 0) And Nvl(n_病人预约科室数, 0) > 0 Then
        Get_Errmsg('同一病人最多同时能预约[' || Nvl(n_病人预约科室数, 0) || ']个科室,不能再预约！', Xml_Out);
        Return;
      End If;
    End If;
    If Nvl(n_同科限约数, 0) <> 0 Then
      Select Count(1)
      Into n_Count
      From 病人挂号记录
      Where 病人id = n_病人id And 记录状态 = 1 And 记录性质 = 2 And 预约时间 Between Trunc(d_发生时间) And
            Trunc(d_发生时间) + 1 - 1 / 24 / 60 / 60 And 执行部门id = n_科室id;
      If n_Count >= Nvl(n_同科限约数, 0) And Nvl(n_同科限约数, 0) > 0 Then
        Get_Errmsg('该病人已经在该科室预约了' || n_Count || '次,不能再预约！', Xml_Out);
        Return;
      End If;
    End If;
  Else
    If Nvl(n_病人挂号科室数, 0) <> 0 Then
      n_已约科室 := 0;
      For c_Chkitem In (Select Distinct 执行部门id
                        From 病人挂号记录
                        Where 病人id = n_病人id And 记录状态 = 1 And 记录性质 = 1 And 发生时间 Between Trunc(d_发生时间) And
                              Trunc(d_发生时间) + 1 - 1 / 24 / 60 / 60 And 执行部门id <> n_科室id) Loop
        n_已约科室 := n_已约科室 + 1;
      End Loop;
      If n_已约科室 >= Nvl(n_病人挂号科室数, 0) And Nvl(n_病人挂号科室数, 0) > 0 Then
        Get_Errmsg('同一病人最多同时能挂号[' || Nvl(n_病人挂号科室数, 0) || ']个科室,不能再挂号！', Xml_Out);
        Return;
      End If;
    End If;
    If Nvl(n_同科限号数, 0) <> 0 Then
      Select Count(1)
      Into n_Count
      From 病人挂号记录
      Where 病人id = n_病人id And 记录状态 = 1 And 记录性质 = 1 And 发生时间 Between Trunc(d_发生时间) And
            Trunc(d_发生时间) + 1 - 1 / 24 / 60 / 60 And 执行部门id = n_科室id;
      If n_Count >= Nvl(n_同科限号数, 0) And Nvl(n_同科限号数, 0) > 0 Then
        Get_Errmsg('该病人已经在该科室挂号了' || n_Count || '次,不能再挂号！', Xml_Out);
        Return;
      End If;
    End If;
  End If;

  If Nvl(n_同源限号数, 0) <> 0 Then
    If n_出诊记录id Is Null Then
      Select Count(1)
      Into n_Count
      From 病人挂号记录
      Where 病人id = n_病人id And 记录状态 = 1 And 记录性质 In (1, 2) And 发生时间 Between Trunc(d_发生时间) And
            Trunc(d_发生时间) + 1 - 1 / 24 / 60 / 60 And 号别 = v_号码;
    Else
      Select Count(1)
      Into n_Count
      From 病人挂号记录
      Where 病人id = n_病人id And 记录状态 = 1 And 记录性质 In (1, 2) And 出诊记录id = n_出诊记录id;
    End If;
    If n_Count >= Nvl(n_同源限号数, 0) And Nvl(n_同源限号数, 0) > 0 Then
      Get_Errmsg('同一病人最多能同时挂(预约)[' || Nvl(n_同源限号数, 0) || ']个相同号别的号,不能再挂号(预约)！', Xml_Out);
      Return;
    End If;
  End If;

  If Trunc(Sysdate) = Trunc(d_发生时间) Then
    --挂号
    If Nvl(n_专家号挂号限制, 0) <> 0 And v_医生姓名 Is Not Null Then
      If n_出诊记录id Is Null Then
        --无出诊记录对应
        Select Count(1)
        Into n_Exists
        From 病人挂号记录
        Where 病人id = n_病人id And 号别 = v_号码 And 发生时间 Between Trunc(d_发生时间) And Trunc(d_发生时间) + 1 - 1 / 24 / 60 / 60 And
              记录状态 = 1 And 记录性质 = 1;
        If n_Exists >= n_专家号挂号限制 Then
          Get_Errmsg('该病人已经超过本号挂号限制,不能再次挂号！', Xml_Out);
          Return;
        End If;
      Else
        --对应出诊记录
        Select Count(1)
        Into n_Exists
        From 病人挂号记录
        Where 病人id = n_病人id And 出诊记录id = n_出诊记录id And 记录状态 = 1 And 记录性质 = 1;
        If n_Exists >= n_专家号挂号限制 Then
          Get_Errmsg('该病人已经超过本号挂号限制,不能再次挂号！', Xml_Out);
          Return;
        End If;
      End If;
    End If;
  Else
    --预约
    If Nvl(n_专家号预约限制, 0) <> 0 And v_医生姓名 Is Not Null Then
      If n_出诊记录id Is Null Then
        --无出诊记录对应
        Select Count(1)
        Into n_Exists
        From 病人挂号记录
        Where 病人id = n_病人id And 号别 = v_号码 And 发生时间 Between Trunc(d_发生时间) And Trunc(d_发生时间) + 1 - 1 / 24 / 60 / 60 And
              记录状态 = 1 And 记录性质 = 2;
        If n_Exists >= n_专家号预约限制 Then
          Get_Errmsg('该病人已经超过本号预约限制,不能再次预约！', Xml_Out);
          Return;
        End If;
      Else
        --对应出诊记录
        Select Count(1)
        Into n_Exists
        From 病人挂号记录
        Where 病人id = n_病人id And 出诊记录id = n_出诊记录id And 记录状态 = 1 And 记录性质 = 2;
        If n_Exists >= n_专家号预约限制 Then
          Get_Errmsg('该病人已经超过本号预约限制,不能再次预约！', Xml_Out);
          Return;
        End If;
      End If;
    End If;
  End If;
  
  Xml_Out := Xmltype('<OUTPUT></OUTPUT>');
  
  n_Exists := To_Number(Nvl(zl_GetSysParameter(323), '0'));
  If n_Exists <> 0 Then
    Select Count(1)
    Into n_Count
    From 病案主页 a, 病人信息 b
    Where a.病人id = n_病人id And a.病人性质 = 1 And a.病人id = b.病人id And a.主页id = b.主页id And Nvl(b.在院, 0) = 1;
    If n_Count <> 0 Then
      Xml_Out := Xmltype('<OUTPUT><JZYJZF>1</JZYJZF></OUTPUT>');
    End if;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Registercheck;
/
Create Or Replace Procedure Zl_Third_Settlement
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:三方接口支付
  --入参:Xml_In:
  --<IN>
  --  <BRID>病人ID</BRID>         //病人ID
  --  <XM>姓名</XM>               //姓名
  --  <SFZH>身份证号</SFZH>       //身份证号
  --  <ZYID>主页ID</ZYID>         //主页ID
  --  <JSLX>2</JSLX>         //结算类型,1-门诊,2-住院，默认为 2
  --  <JE></JE>         //本次结算总金额
  --  <NO></NO>         //结帐的费用单据号(门诊记帐单),目前仅结算类型=1时候使用
  --  <JZKNO></JZKNO>   //结帐的就诊卡单据号,目前仅结算类型=1时候使用
  --  <JZSJ></JZSJ>     //结帐时间
  --  <JSMS>1</JSMS>    //结算模式：0-普通模式，1-异步结算模式
  --  <CZLX>0</CZLX>    //操作类型：结算模式为1时传入，0-开始结算，1-完成结算，2-回退结算
  --  <JZID>1</JZID>    //结帐ID，操作类型为1或2时传入
  --  <ZFBZH>支付宝公众号UserID</ZFBZH>
  --  <ZFBXCY>支付宝小程序UserID</ZFBXCY>
  --  <WXGZHID>微信公众号OpenID</WXGZH>
  --  <WXXCXID>微信小程序OpenID</WXXCXID>
  --  <JSLIST>          //结算列表，操作类型为2时可不传入 
  --    <JS>
  --      <JSKLB>支付卡类别</JSKLB >
  --      <JSKH>支付卡号</ JSKH >
  --      <JSFS>支付方式</JSFS> //支付方式:现金;支票,如果是三方卡,可以传空
  --      <JSJE>结算金额</JSJE> //结算金额，均为正金额；SFCYJ为1时为总的冲预交金额
  --      <JYLSH>交易流水号</JYLSH>
  --      <JYSM>交易说明</JYSM>
  --      <ZY>摘要</ZY>
  --      <SFXFK>是否消费卡</SFXFK>  //(1-是消费卡),消费卡时,传入结算卡类别,结算卡号,结算金额等接点
  --      <SFCYJ>是否冲预交</SFCYJ>  //是否冲预交，0-结算，1-冲预交.允冲预交时,只填JSJE节点
  --      <CYJLIST>  //冲预交款集合：是否冲预交=1时传入，此时以传入的单据进行冲预交款；如果不传入该节点，则按HIS的先缴先用规则进行冲预交款，此时不能进行退预交款（如果存在退预交款，则只能使用预交款进行结帐）
  --        <TKFS>退款方式<TKFS>  //退款方式，存在退款时传入：0-分交易退款;1-调用一次交易接口退款;2-转帐方式退款(暂不支持)(应以线下一致，主要用于异步模式下，线下窗口处理异常结算)
  --        <ITEM>  //说明：有退必有冲；如单据A001，预交款金额1000，本次结帐800，则传入两条记录①冲1000，②退200，Sum(冲金额-退金额)=结帐金额
  --          <DJH>预交款单据号</DJH>
  --          <JE>交易金额</JE>
  --          <SFTK>是否退预交款</SFTK>  //是否退预交款：0-冲预交款;1-退预交款
  --          <JYLSH>交易流水号</JYLSH>  //退款交易流水号
  --          <JYSM>交易说明</JYSM>  //退款交易说明
  --          <EXPENDLIST>  //退款交易的扩展信息，退款方式=0时传入
  --            <EXPEND>
  --              <JYMC>交易名称</JYMC> //交易名称
  --              <JYLR>交易内容</JYLR> //交易内容
  --            </EXPEND>
  --          </EXPENDLIST>
  --        </ITEM>
  --        <EXPENDLIST>  //退款交易的扩展信息，退款方式=1、2时传入
  --          <EXPEND>      
  --            <JYMC>交易名称</JYMC> //交易名称
  --            <JYLR>交易内容</JYLR> //交易内容
  --          </EXPEND>
  --        </EXPENDLIST>
  --      </CYJLIST>
  --      <EXPENDLIST>  //扩展交易信息
  --        <EXPEND>
  --          <JYMC>交易名称</JYMC> //交易名称
  --          <JYLR>交易内容</JYLR> //交易内容
  --        </EXPEND>
  --      </EXPENDLIST>
  --    </JS>
  --  </JSLIST >
  --</IN>

  --出参:Xml_Out
  --<OUT>
  --  <CZSJ>操作时间</CZSJ>          //HIS的登记时间
  --  <JZID>结帐ID</JZID>
  --  <KPBZ>开票标志</KPBZ> //1-成功开具电子票据;0-未开票成功标志
  --  <URL>H5页面URL</URL>
  --  <NETURL>外网H5页面URL</NETURL>
  --  <FPTT>发票抬头</FPTT>        //病人姓名
  --  <FPH>发票号</FPH>             //发票编号
  --  <FPJE>发票金额</FPJE>        //100.00
  --  <KPRQ>开票日期</KPRQ>   //yyyy-mm-dd
  --  <ERROR>  //如无该错误结点则说明正确执行
  --    <MSG>错误信息</MSG>
  --  </ERROR>
  --</OUT>
  --------------------------------------------------------------------------------------------------
  n_主页id       病案主页.主页id%Type;
  n_病人id       病案主页.病人id%Type;
  v_姓名         病人信息.姓名%Type;
  v_身份证号     病人信息.身份证号%Type;
  n_结帐总额     病人预交记录.冲预交%Type;
  n_结算类型     Number(3);
  v_就诊卡单据号 Varchar2(20000);
  d_结帐时间     Date;
  v_单据号       Varchar2(20000);
  n_结算模式     Number(1); --0-普通模式，1-异步结算模式
  n_操作类型     Number(1); --结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算

  v_操作员编码 病人结帐记录.操作员编号%Type;
  v_操作员姓名 病人结帐记录.操作员姓名%Type;
  n_结帐id     病人结帐记录.Id%Type;
  n_待结帐金额 病人预交记录.冲预交%Type;
  d_开始日期   Date;
  d_结束日期   Date;
  d_最小日期   Date;
  d_最大日期   Date;
  n_关联交易id 病人预交记录.关联交易id%Type;
  n_预交id     病人预交记录.Id%Type;
  n_删除原结算 Number;

  v_结帐单号 病人结帐记录.No%Type;
  d_作废时间 病人结帐记录.收费时间%Type;
  n_冲销id   病人结帐记录.Id%Type;

  n_结算卡序号 消费卡类别目录.编号%Type;
  n_时间类型   Number(3);
  v_No         病人结帐记录.No%Type;
  n_卡类别id   医疗卡类别.Id%Type;
  v_结算方式   病人预交记录.结算方式%Type;
  v_Temp       Varchar2(500);
  v_Ids        Varchar2(20000);
  x_Templet    Xmltype; --模板XML
  v_消费卡结算 Varchar2(20000);
  n_结算金额   病人预交记录.冲预交%Type;

  v_Err_Msg Varchar2(200);
  Err_Item    Exception;
  Err_Special Exception;
  v_卡类别 三方交易记录.类别%Type;
  n_Number Number(2);
  n_Step   Number(2);

  n_费用id   门诊费用记录.Id%Type;
  n_记录性质 门诊费用记录.记录性质%Type;
  v_费用no   门诊费用记录.No%Type;
  n_序号     门诊费用记录.序号%Type;
  n_记录状态 门诊费用记录.记录状态%Type;
  n_执行状态 门诊费用记录.执行状态%Type;
  n_未结金额 门诊费用记录.实收金额%Type;
  n_结帐金额 门诊费用记录.实收金额%Type;
  n_误差费   门诊费用记录.实收金额%Type;
  Type t_费用结算明细 Is Ref Cursor;
  c_费用结算明细 t_费用结算明细;

  Type Ty_预交款 Is Record(
    退款方式   Number(1), --0-分交易退款;1-调用一次交易接口退款;2-转帐方式退款(暂不支持)
    单据号     病人预交记录.No%Type,
    冲预交     病人预交记录.冲预交%Type,
    交易流水号 病人预交记录.交易流水号%Type,
    交易说明   病人预交记录.交易说明%Type,
    
    预交id       病人预交记录.Id%Type,
    结算方式     病人预交记录.结算方式%Type,
    卡类别id     病人预交记录.卡类别id%Type,
    卡号         病人预交记录.卡号%Type,
    原交易流水号 病人预交记录.交易流水号%Type,
    原交易说明   病人预交记录.交易说明%Type,
    关联交易id   病人预交记录.关联交易id%Type,
    是否转账     Number(1),
    交易扩展信息 Xmltype, --分交易退款的扩展信息
    
    是否退款 Number(1),
    扩展信息 Xmltype);
  Type t_预交款 Is Table Of Ty_预交款;
  l_预交款 t_预交款;

  n_非预交款结算       Number(1);
  n_冲预交金额         病人预交记录.冲预交%Type;
  n_退预交金额         病人预交记录.冲预交%Type;
  n_存在退预交         Number(1);
  n_是否电子票据       病人预交记录.是否电子票据%Type;
  v_支付宝公众号userid Varchar2(100);
  v_支付宝小程序userid Varchar2(100);
  v_微信公众号openid   Varchar2(100);
  v_微信小程序openid   Varchar2(100);
  n_开票标志           Number(2);
  v_患者姓名           电子票据使用记录.姓名%Type;
  v_发票编号           电子票据使用记录.号码%Type;
  v_开票日期           Varchar2(20);
  n_发票金额           电子票据使用记录.票据金额%Type;
  v_Url                电子票据使用记录.Url内网%Type;
  v_Url外网            电子票据使用记录.Url外网%Type;

  Procedure 病人预交款_List
  (
    预交款信息_In  Xmltype,
    预交款支付_In  Number,
    预交款_Out     In Out t_预交款,
    存在退预交_Out In Out Number
  ) As
    n_原预交id 病人预交记录.Id%Type;
    n_剩余金额 病人预交记录.冲预交%Type;
  
    v_结算方式     病人预交记录.结算方式%Type;
    n_卡类别id     病人预交记录.卡类别id%Type;
    v_卡号         病人预交记录.卡号%Type;
    v_原交易流水号 病人预交记录.交易流水号%Type;
    v_原交易说明   病人预交记录.交易说明%Type;
    n_关联交易id   病人预交记录.关联交易id%Type;
  
    n_退款方式 Number(1);
    x_扩展信息 Xmltype;
  
    I         Number(18);
    v_Err_Msg Varchar2(200);
    Err_Item Exception;
  Begin
    If 预交款_Out Is Null Then
      预交款_Out := t_预交款();
    End If;
  
    --退款方式:0-分交易退款;1-调用一次交易接口退款;2-转帐方式退款(暂不支持)
    Select Extractvalue(Value(A), 'CYJLIST/TKFS'), Extract(a.Column_Value, 'CYJLIST/EXPENDLIST')
    Into n_退款方式, x_扩展信息
    From Table(Xmlsequence(Extract(预交款信息_In, 'CYJLIST'))) A;
  
    For r_预交款 In (Select Extractvalue(b.Column_Value, 'ITEM/DJH') As 单据号, Extractvalue(b.Column_Value, 'ITEM/JE') As 冲预交,
                         Extractvalue(b.Column_Value, 'ITEM/SFTK') As 是否退款,
                         Extractvalue(b.Column_Value, 'ITEM/JYLSH') As 交易流水号,
                         Extractvalue(b.Column_Value, 'ITEM/JYSM') As 交易说明,
                         Extract(b.Column_Value, 'ITEM/EXPENDLIST') As 扩展信息
                  From Table(Xmlsequence(Extract(预交款信息_In, 'CYJLIST/ITEM'))) B
                  Order By Nvl(是否退款, 0)) Loop
    
      Select Max(Decode(记录性质, 1, ID, 0)), Sum(Nvl(金额, 0) - Nvl(冲预交, 0))
      Into n_原预交id, n_剩余金额
      From 病人预交记录
      Where 记录性质 In (1, 11) And NO = r_预交款.单据号;
      If Nvl(n_原预交id, 0) = 0 Then
        v_Err_Msg := '预交款单据[' || r_预交款.单据号 || ']不存在，结算失败！';
        Raise Err_Item;
      End If;
    
      If Nvl(r_预交款.是否退款, 0) = 0 Then
        If Nvl(n_剩余金额, 0) < Nvl(r_预交款.冲预交, 0) And Nvl(预交款支付_In, 0) = 1 Then
          v_Err_Msg := '预交款单据[' || r_预交款.单据号 || ']余额不足，结算失败！';
          Raise Err_Item;
        End If;
      End If;
    
      Begin
        Select ID, 结算方式, 卡类别id, 卡号, 交易流水号, 交易说明, 关联交易id
        Into n_原预交id, v_结算方式, n_卡类别id, v_卡号, v_原交易流水号, v_原交易说明, n_关联交易id
        From 病人预交记录
        Where 记录性质 = 1 And NO = r_预交款.单据号;
      Exception
        When Others Then
          v_Err_Msg := '预交款单据[' || r_预交款.单据号 || ']不存在，结算失败！';
          Raise Err_Item;
      End;
    
      If Nvl(r_预交款.是否退款, 0) = 1 Then
        存在退预交_Out := 1;
      End If;
    
      预交款_Out.Extend();
      I := 预交款_Out.Count;
      预交款_Out(I).单据号 := r_预交款.单据号;
      预交款_Out(I).冲预交 := r_预交款.冲预交;
      预交款_Out(I).是否退款 := r_预交款.是否退款;
      预交款_Out(I).交易流水号 := r_预交款.交易流水号;
      预交款_Out(I).交易说明 := r_预交款.交易说明;
    
      预交款_Out(I).预交id := n_原预交id;
      预交款_Out(I).结算方式 := v_结算方式;
      预交款_Out(I).卡类别id := n_卡类别id;
      预交款_Out(I).卡号 := v_卡号;
      预交款_Out(I).原交易流水号 := v_原交易流水号;
      预交款_Out(I).原交易说明 := v_原交易说明;
      预交款_Out(I).关联交易id := n_关联交易id;
      If Nvl(n_退款方式, 0) = 2 Then
        预交款_Out(I).是否转账 := 1;
      Else
        预交款_Out(I).是否转账 := 0;
      End If;
      预交款_Out(I).交易扩展信息 := r_预交款.扩展信息;
    
      预交款_Out(I).退款方式 := n_退款方式;
      预交款_Out(I).扩展信息 := x_扩展信息;
    End Loop;
  
    If Nvl(存在退预交_Out, 0) = 1 And Nvl(n_退款方式, 0) = 2 Then
      v_Err_Msg := '预交款暂不支持转账退款，结算失败！';
      Raise Err_Item;
    End If;
  Exception
    When Err_Item Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  End;

  Procedure 三方结算交易_Save
  (
    结帐id_In   病人预交记录.结帐id%Type,
    卡类别id_In 病人预交记录.卡类别id%Type,
    卡号_In     病人预交记录.卡号%Type,
    扩展信息_In Xmltype
  ) As
  Begin
    If 扩展信息_In Is Null Then
      Return;
    End If;
  
    For c_扩展 In (Select Extractvalue(j.Column_Value, 'EXPEND/JYMC') As 名称,
                        Extractvalue(j.Column_Value, 'EXPEND/JYLR') As 内容
                 From Table(Xmlsequence(Extract(扩展信息_In, 'EXPENDLIST/EXPEND'))) J) Loop
      Zl_三方结算交易_Insert(卡类别id_In, 0, 卡号_In, 结帐id_In, c_扩展.名称 || '|' || c_扩展.内容);
    End Loop;
  End;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/ZYID'), To_Number(Extractvalue(Value(A), 'IN/BRID')),
         To_Number(Extractvalue(Value(A), 'IN/JE')), Nvl(To_Number(Extractvalue(Value(A), 'IN/JSLX')), 2),
         Extractvalue(Value(A), 'IN/NO'), To_Number(Extractvalue(Value(A), 'IN/JZKNO')),
         To_Date(Extractvalue(Value(A), 'IN/JZSJ'), 'yyyy-mm-dd hh24:mi:ss'), Extractvalue(Value(A), 'IN/SFZH'),
         Extractvalue(Value(A), 'IN/XM'), Extractvalue(Value(A), 'IN/JSMS'), Extractvalue(Value(A), 'IN/CZLX'),
         Extractvalue(Value(A), 'IN/JZID'), Extractvalue(Value(A), 'IN/ZFBZH'), Extractvalue(Value(A), 'IN/ZFBXCY'),
         Extractvalue(Value(A), 'IN/WXGZHID'), Extractvalue(Value(A), 'IN/WXXCXID')
  Into n_主页id, n_病人id, n_结帐总额, n_结算类型, v_单据号, v_就诊卡单据号, d_结帐时间, v_身份证号, v_姓名, n_结算模式, n_操作类型, n_结帐id, v_支付宝公众号userid,
       v_支付宝小程序userid, v_微信公众号openid, v_微信小程序openid
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If n_结算类型 = 1 And Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;

  --0.相关检查
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '不能有效识别病人身份,不允许结算!';
    Raise Err_Item;
  End If;
  If Not v_支付宝公众号userid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('支付宝公众号UserID'), v_支付宝公众号userid);
  End If;

  If Not v_支付宝小程序userid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('支付宝小程序UserID'), v_支付宝公众号userid);
  End If;

  If Not v_微信公众号openid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('微信公众号OpenID'), v_支付宝公众号userid);
  End If;

  If Not v_微信小程序openid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('微信小程序OpenID'), v_支付宝公众号userid);
  End If;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) <> 0 Then
    If Nvl(n_结帐id, 0) = 0 Then
      v_Err_Msg := '没有指定相关的结算数据！';
      Raise Err_Item;
    End If;
  
    Begin
      Select 收款时间, 关联交易id, 卡类别id
      Into d_结帐时间, n_关联交易id, n_卡类别id
      From 病人预交记录
      Where 结帐id = n_结帐id And Nvl(校对标志, 0) = 1 And 卡类别id Is Not Null And Rownum < 2;
    Exception
      When Others Then
        v_Err_Msg := '没有找到指定的相关结算数据，可能已被处理！';
        Raise Err_Item;
    End;
  End If;

  v_操作员编码 := Zl_操作员信息(1);
  v_操作员姓名 := Zl_操作员信息(2);

  --【1】异步模式回退交易
  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 2 Then
    --删除结算数据
    Zl_病人结帐结算_Delete(n_结帐id, n_卡类别id, n_关联交易id);
    --作废原结帐
    Begin
      Select NO Into v_结帐单号 From 病人结帐记录 Where ID = n_结帐id And Nvl(结算状态, 0) = 1 And Rownum < 2;
    Exception
      When Others Then
        v_Err_Msg := '没有找到原结帐数据，可能已被处理！';
        Raise Err_Item;
    End;
  
    d_作废时间 := Sysdate;
    Select 病人结帐记录_Id.Nextval Into n_冲销id From Dual;
    Zl_病人结帐记录_Cancel(v_结帐单号, n_冲销id, v_操作员编码, v_操作员姓名, d_作废时间);
    Zl_病人结帐作废_Modify(0, n_病人id, n_冲销id, Null, Null, Null, Null, Null, Null, Null, Null, Null, v_操作员编码, v_操作员姓名, d_作废时间,
                     Null, 1);
  
    v_Temp := '<CZSJ>' || To_Char(d_结帐时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<JZID>' || n_结帐id || '</JZID>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<KPBZ>' || 0 || '</KPBZ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    v_Temp := '<URL>' || '' || '</URL>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    v_Temp := '<NETURL>' || '' || '</NETURL>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    v_Temp := '<FPTT>' || v_姓名 || '</FPTT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    v_Temp := '<FPH>' || '' || '</FPH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<FPJE>' || '' || '</FPJE>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<KPRQ>' || '' || '</KPRQ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
    Return;
  End If;

  --【2】非异步模式或异步模式开始交易
  If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
    --【2.1】锁定三方卡支付交易
    For c_交易记录 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                          Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                          Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                          Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要,
                          Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交,
                          Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡
                   From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
    
      If Not (c_交易记录.结算卡类别 Is Null Or Nvl(c_交易记录.是否消费卡, '0') = '1' Or Nvl(c_交易记录.是否冲预交, 0) = 1) Then
        Select Decode(Translate(Nvl(c_交易记录.结算卡类别, 'abcd'), '#1234567890', '#'), Null, 1, 0)
        Into n_Number
        From Dual;
      
        If Nvl(n_Number, 0) = 1 Then
          Select Max(名称) Into v_卡类别 From 医疗卡类别 Where ID = To_Number(c_交易记录.结算卡类别);
        Else
          Select Max(名称) Into v_卡类别 From 医疗卡类别 Where 名称 = c_交易记录.结算卡类别;
        End If;
        If v_卡类别 Is Null Then
          v_Err_Msg := '不支持的结算方式,请检查！';
          Raise Err_Item;
        End If;
      
        --仅第一个结算方式才检查交易锁
        n_Step := Nvl(n_Step, 0) + 1;
        If Zl_Fun_三方交易记录_Locked(v_卡类别, c_交易记录.交易流水号, c_交易记录.结算卡号, c_交易记录.摘要, 2) = 0 And n_Step = 1 Then
          v_Err_Msg := '交易流水号为:' || c_交易记录.交易流水号 || '的交易正在进行中，不允许再次提交此交易!';
          Raise Err_Special;
        End If;
      End If;
    End Loop;
  
    --【2.2】费用结帐记录
    Select Nvl(zl_GetSysParameter('结帐费用时间', 1137), 0) Into n_时间类型 From Dual;
    If n_结算类型 = 2 Then
      Open c_费用结算明细 For
        Select Max(Decode(结帐id, Null, ID, Null)) As ID, Mod(记录性质, 10) As 记录性质, NO, 序号, 记录状态, 执行状态,
               Trunc(Min(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最小时间, Trunc(Max(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最大时间,
               Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) As 金额, Sum(Nvl(结帐金额, 0)) As 结帐金额
        From 住院费用记录
        Where 病人id = n_病人id And 记录状态 <> 0 And 主页id = n_主页id And 记帐费用 = 1
        Group By Mod(记录性质, 10), NO, 序号, 记录状态, 执行状态
        Having(Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) <> 0) Or (Sum(Nvl(实收金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Sum(Nvl(结帐金额, 0)) = 0 And Mod(Count(*), 2) = 0) Or Sum(Nvl(结帐金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Mod(Count(*), 2) = 0
        Order By NO, 序号;
    Else
      If v_单据号 Is Null And v_就诊卡单据号 Is Null Then
        Open c_费用结算明细 For
          Select Min(Decode(结帐id, Null, ID, Null)) As ID, Mod(记录性质, 10) As 记录性质, NO, 序号, 记录状态, 执行状态,
                 Trunc(Min(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最小时间, Trunc(Max(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最大时间,
                 Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) As 金额, Sum(Nvl(结帐金额, 0)) As 结帐金额
          From 门诊费用记录
          Where 病人id = n_病人id And 记录状态 <> 0 And 记帐费用 = 1
          Group By Mod(记录性质, 10), NO, 序号, 记录状态, 执行状态
          Having(Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) <> 0) Or (Sum(Nvl(实收金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Sum(Nvl(结帐金额, 0)) = 0 And Mod(Count(*), 2) = 0) Or Sum(Nvl(结帐金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Mod(Count(*), 2) = 0
          Union All
          Select Min(Decode(结帐id, Null, ID, Null)) As ID, Mod(记录性质, 10) As 记录性质, NO, 序号, 记录状态, 执行状态,
                 Trunc(Min(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最小时间, Trunc(Max(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最大时间,
                 Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) As 金额, Sum(Nvl(结帐金额, 0)) As 结帐金额
          From 住院费用记录
          Where 病人id = n_病人id And 记录状态 <> 0 And 记帐费用 = 1 And Mod(记录性质, 10) = 5
          Group By Mod(记录性质, 10), NO, 序号, 记录状态, 执行状态
          Having(Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) <> 0) Or (Sum(Nvl(实收金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Sum(Nvl(结帐金额, 0)) = 0 And Mod(Count(*), 2) = 0) Or Sum(Nvl(结帐金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Mod(Count(*), 2) = 0
          Order By NO, 序号;
      Elsif v_单据号 Is Not Null And v_就诊卡单据号 Is Not Null Then
        Open c_费用结算明细 For
          Select Min(Decode(结帐id, Null, ID, Null)) As ID, Mod(记录性质, 10) As 记录性质, NO, 序号, 记录状态, 执行状态,
                 Trunc(Min(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最小时间, Trunc(Max(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最大时间,
                 Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) As 金额, Sum(Nvl(结帐金额, 0)) As 结帐金额
          From 门诊费用记录
          Where 病人id + 0 = n_病人id And 记录状态 <> 0 And Mod(记录性质, 10) = 2 And 记帐费用 = 1 And
                NO In (Select /*+cardinality(b,10) */
                        Column_Value
                       From Table(f_Str2List(v_单据号)) B)
          Group By Mod(记录性质, 10), NO, 序号, 记录状态, 执行状态
          Having(Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) <> 0) Or (Sum(Nvl(实收金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Sum(Nvl(结帐金额, 0)) = 0 And Mod(Count(*), 2) = 0) Or Sum(Nvl(结帐金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Mod(Count(*), 2) = 0
          Union All
          Select Min(Decode(结帐id, Null, ID, Null)) As ID, Mod(记录性质, 10) As 记录性质, NO, 序号, 记录状态, 执行状态,
                 Trunc(Min(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最小时间, Trunc(Max(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最大时间,
                 Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) As 金额, Sum(Nvl(结帐金额, 0)) As 结帐金额
          From 住院费用记录
          Where 病人id + 0 = n_病人id And 记录状态 <> 0 And 记帐费用 = 1 And Mod(记录性质, 10) = 5 And
                NO In (Select /*+cardinality(b,10) */
                        Column_Value
                       From Table(f_Str2List(v_就诊卡单据号)) B)
          Group By Mod(记录性质, 10), NO, 序号, 记录状态, 执行状态
          Having(Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) <> 0) Or (Sum(Nvl(实收金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Sum(Nvl(结帐金额, 0)) = 0 And Mod(Count(*), 2) = 0) Or Sum(Nvl(结帐金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Mod(Count(*), 2) = 0
          Order By 记录性质, NO, 序号;
      Elsif v_单据号 Is Not Null Then
        Open c_费用结算明细 For
          Select Min(Decode(结帐id, Null, ID, Null)) As ID, Mod(记录性质, 10) As 记录性质, NO, 序号, 记录状态, 执行状态,
                 Trunc(Min(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最小时间, Trunc(Max(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最大时间,
                 Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) As 金额, Sum(Nvl(结帐金额, 0)) As 结帐金额
          From 门诊费用记录
          Where 病人id + 0 = n_病人id And 记录状态 <> 0 And Mod(记录性质, 10) = 2 And 记帐费用 = 1 And
                NO In (Select /*+cardinality(b,10) */
                        Column_Value
                       From Table(f_Str2List(v_单据号)) B)
          Group By Mod(记录性质, 10), NO, 序号, 记录状态, 执行状态
          Having(Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) <> 0) Or (Sum(Nvl(实收金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Sum(Nvl(结帐金额, 0)) = 0 And Mod(Count(*), 2) = 0) Or Sum(Nvl(结帐金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Mod(Count(*), 2) = 0
          Order By NO, 序号;
      Else
        Open c_费用结算明细 For
          Select Min(Decode(结帐id, Null, ID, Null)) As ID, Mod(记录性质, 10) As 记录性质, NO, 序号, 记录状态, 执行状态,
                 Trunc(Min(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最小时间, Trunc(Max(Decode(n_时间类型, 0, 登记时间, 发生时间))) As 最大时间,
                 Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) As 金额, Sum(Nvl(结帐金额, 0)) As 结帐金额
          From 住院费用记录
          Where 病人id + 0 = n_病人id And 记录状态 <> 0 And 记帐费用 = 1 And Mod(记录性质, 10) = 5 And
                NO In (Select /*+cardinality(b,10) */
                        Column_Value
                       From Table(f_Str2List(v_就诊卡单据号)) B)
          Group By Mod(记录性质, 10), NO, 序号, 记录状态, 执行状态
          Having(Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) <> 0) Or (Sum(Nvl(实收金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Sum(Nvl(结帐金额, 0)) = 0 And Mod(Count(*), 2) = 0) Or Sum(Nvl(结帐金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Mod(Count(*), 2) = 0
          Order By NO, 序号;
      End If;
    End If;
  
    Select 病人结帐记录_Id.Nextval, Sysdate, Nextno(15) Into n_结帐id, d_结帐时间, v_No From Dual;
    n_待结帐金额 := 0;
    Loop
      Fetch c_费用结算明细
        Into n_费用id, n_记录性质, v_费用no, n_序号, n_记录状态, n_执行状态, d_最小日期, d_最大日期, n_未结金额, n_结帐金额;
      Exit When c_费用结算明细%NotFound;
    
      n_待结帐金额 := n_待结帐金额 + Nvl(n_未结金额, 0);
      If d_开始日期 Is Null Then
        d_开始日期 := d_最小日期;
      Elsif d_开始日期 > d_最小日期 Then
        d_开始日期 := d_最小日期;
      End If;
      If d_结束日期 Is Null Then
        d_结束日期 := d_最大日期;
      Elsif d_结束日期 < d_最大日期 Then
        d_结束日期 := d_最大日期;
      End If;
    
      If Nvl(n_结帐金额, 0) = 0 Then
        If n_费用id Is Not Null Then
          If Length(v_Ids || ',' || n_费用id) > 4000 Then
            v_Ids := Substr(v_Ids, 2);
            Zl_结帐费用记录_Batch(v_Ids, n_病人id, n_结帐id);
            v_Ids := '';
          End If;
          v_Ids := v_Ids || ',' || n_费用id;
        Else
          Zl_结帐费用记录_Insert(0, v_费用no, n_记录性质, n_记录状态, n_执行状态, n_序号, n_未结金额, n_结帐id);
        End If;
      Else
        Zl_结帐费用记录_Insert(0, v_费用no, n_记录性质, n_记录状态, n_执行状态, n_序号, n_未结金额, n_结帐id);
      End If;
    End Loop;
  
    If v_Ids Is Not Null Then
      v_Ids := Substr(v_Ids, 2);
      Zl_结帐费用记录_Batch(v_Ids, n_病人id, n_结帐id);
    End If;
  
    If Round(n_待结帐金额, 6) <> Nvl(n_结帐总额, 0) Then
      v_Err_Msg := '传入的结帐金额与实际结帐金额不符,不允许结算!';
      Raise Err_Item;
    End If;
  
    Zl_病人结帐记录_Insert(n_结帐id, v_No, n_病人id, d_结帐时间, d_开始日期, d_结束日期, 0, 0, n_主页id, Null, n_结算类型, Null, n_结算类型, 1, n_主页id,
                     n_结帐总额);
  
    --【2.3】结算数据预先保存,三方卡支付和存在退款的预交款支付
    n_非预交款结算 := 0;
    n_存在退预交   := 0;
    l_预交款       := t_预交款();
    For r_结算方式 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                          Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号,
                          Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                          Extractvalue(b.Column_Value, '/JS/JSJE') As 结算金额,
                          Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                          Extractvalue(b.Column_Value, '/JS/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要,
                          Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡,
                          Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交,
                          Extract(b.Column_Value, '/JS/CYJLIST') As 冲预交列表
                   From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
    
      If Nvl(r_结算方式.是否冲预交, 0) = 0 Then
        n_非预交款结算 := 1;
        n_卡类别id     := Null;
        If r_结算方式.结算卡类别 Is Not Null And Nvl(r_结算方式.是否消费卡, 0) = 0 Then
          Select Decode(Translate(Nvl(r_结算方式.结算卡类别, 'abcd'), '#1234567890', '#'), Null, 1, 0)
          Into n_Number
          From Dual;
        
          If Nvl(n_Number, 0) = 1 Then
            Select Max(ID) Into n_卡类别id From 医疗卡类别 Where ID = r_结算方式.结算卡类别 And Nvl(是否启用, 0) = 1;
          Else
            Select Max(ID) Into n_卡类别id From 医疗卡类别 Where 名称 = r_结算方式.结算卡类别 And Nvl(是否启用, 0) = 1;
          End If;
        
          If n_卡类别id Is Null Then
            v_Err_Msg := '未找到对应的医疗卡信息!';
            Raise Err_Item;
          End If;
        
          Select Max(关联交易id)
          Into n_关联交易id
          From 病人预交记录
          Where 结帐id = n_结帐id And 卡类别id = n_卡类别id And Rownum < 2 And Mod(记录性质, 10) <> 1;
          If Nvl(n_关联交易id, 0) = 0 Then
            Select 病人预交记录_Id.Nextval Into n_关联交易id From Dual;
            n_预交id := n_关联交易id;
          Else
            n_预交id := Null;
          End If;
        
          v_结算方式 := r_结算方式.结算方式 || '|' || r_结算方式.结算金额 || '|';
          Zl_病人结帐结算_Modify(1, n_病人id, n_结帐id, v_结算方式, Null, 0, n_卡类别id, r_结算方式.结算卡号, r_结算方式.交易流水号, r_结算方式.交易说明, 0, 0, 0,
                           n_结算类型, Null, v_操作员编码, v_操作员姓名, d_结帐时间, Null, 0, 1, n_预交id, n_关联交易id);
        End If;
      
      Elsif r_结算方式.冲预交列表 Is Not Null Then
        --【*】按指定单据进行预交款支付
        病人预交款_List(r_结算方式.冲预交列表, 1, l_预交款, n_存在退预交);
      End If;
    End Loop;
  
    --【*】按指定单据进行预交款支付
    If l_预交款.Count > 0 And Nvl(n_存在退预交, 0) = 1 Then
      --  1.如果存在退预交款，则只能使用预交款进行结帐
      If Nvl(n_非预交款结算, 0) = 1 Then
        v_Err_Msg := '存在对预交款进行退款时，全部结帐金额都必须使用预交款进行支付！';
        Raise Err_Item;
      End If;
    
      --先保存预交款数据
      n_冲预交金额 := 0;
      n_退预交金额 := 0;
      For I In 1 .. l_预交款.Count Loop
        If Nvl(l_预交款(I).是否退款, 0) = 0 Then
          --冲预交款  
          Zl_结帐预交记录_Insert(l_预交款(I).预交id, l_预交款(I).单据号, 1, l_预交款(I).冲预交, n_结帐id, n_病人id, v_操作员编码, v_操作员姓名, d_结帐时间);
        
          n_冲预交金额 := n_冲预交金额 + Nvl(l_预交款(I).冲预交, 0);
        Else
          --退预交款  
          Zl_三方退款信息_Insert(n_结帐id, l_预交款(I).预交id, l_预交款(I).冲预交, l_预交款(I).卡号, Null, Null, 0, 1, l_预交款(I).是否转账,
                           l_预交款(I).卡类别id, l_预交款(I).原交易流水号, l_预交款(I).原交易说明);
          Zl_病人结帐结算_Modify(1, n_病人id, n_结帐id, l_预交款(I).结算方式 || '|' || -1 * l_预交款(I).冲预交 || '| | ', Null, Null,
                           l_预交款(I).卡类别id, l_预交款(I).卡号, l_预交款(I).原交易流水号, l_预交款(I).原交易说明, Null, Null, Null, n_结算类型, Null,
                           v_操作员编码, v_操作员姓名, d_结帐时间, Null, 0, 1, Null, l_预交款(I).关联交易id, 0, Nvl(l_预交款(I).退款方式, 0) + 1);
        
          n_退预交金额 := n_退预交金额 + Nvl(l_预交款(I).冲预交, 0);
        End If;
      End Loop;
    
      --  2.有退必有冲；如单据A001，预交款金额1000，本次结帐800，则传入两条记录①冲1000，②退200，Sum(冲金额-退金额)=结帐金额
      --  说明：允许有误差金额
      If Abs(Nvl(n_结帐总额, 0) - (Nvl(n_冲预交金额, 0) - Nvl(n_退预交金额, 0))) >= 1.00 Then
        v_Err_Msg := '预交款支付金额与结帐金额不相等，不允许结算！';
        Raise Err_Item;
      End If;
    End If;
  End If;

  --【3】异步模式开始交易已处理完，返回结果
  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
    v_Temp := '<CZSJ>' || To_Char(d_结帐时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<JZID>' || n_结帐id || '</JZID>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<KPBZ>' || 0 || '</KPBZ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    v_Temp := '<URL>' || '' || '</URL>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    v_Temp := '<NETURL>' || '' || '</NETURL>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    v_Temp := '<FPTT>' || v_姓名 || '</FPTT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    v_Temp := '<FPH>' || '' || '</FPH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<FPJE>' || '' || '</FPJE>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<KPRQ>' || '' || '</KPRQ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    Xml_Out := x_Templet;
    Return;
  End If;

  --【4】非异步模式或异步模式完成交易，结算数据修正
  n_结算金额     := 0;
  n_删除原结算   := 1;
  n_结帐金额     := 0;
  n_非预交款结算 := 0;
  n_存在退预交   := 0;
  l_预交款       := t_预交款();
  For r_结算方式 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                        Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号,
                        Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                        Extractvalue(b.Column_Value, '/JS/JSJE') As 结算金额,
                        Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                        Extractvalue(b.Column_Value, '/JS/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要,
                        Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡,
                        Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交,
                        Extract(b.Column_Value, '/JS/CYJLIST') As 冲预交列表,
                        Extract(b.Column_Value, '/JS/EXPENDLIST') As Expend
                 From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
  
    v_卡类别   := r_结算方式.结算方式;
    n_结帐金额 := n_结帐金额 + Nvl(r_结算方式.结算金额, 0);
    If Nvl(r_结算方式.是否冲预交, 0) = 0 Then
      n_非预交款结算 := 1;
      n_卡类别id     := Null;
      If r_结算方式.结算卡类别 Is Not Null Then
        Select Decode(Translate(Nvl(r_结算方式.结算卡类别, 'abcd'), '#1234567890', '#'), Null, 1, 0)
        Into n_Number
        From Dual;
      
        If Nvl(r_结算方式.是否消费卡, 0) = 1 Then
          If Nvl(n_Number, 0) = 1 Then
            Select Max(编号), Max(名称)
            Into n_结算卡序号, v_卡类别
            From 消费卡类别目录
            Where 编号 = r_结算方式.结算卡类别 And Nvl(启用, 0) = 1;
          Else
            Select Max(编号), Max(名称)
            Into n_结算卡序号, v_卡类别
            From 消费卡类别目录
            Where 名称 = r_结算方式.结算卡类别 And Nvl(启用, 0) = 1;
          End If;
        
          If n_结算卡序号 Is Null Then
            v_Err_Msg := '未找到对应的消费卡信息';
            Raise Err_Item;
          End If;
        Else
          If Nvl(n_Number, 0) = 1 Then
            Select Max(ID), Max(名称)
            Into n_卡类别id, v_卡类别
            From 医疗卡类别
            Where ID = r_结算方式.结算卡类别 And Nvl(是否启用, 0) = 1;
          Else
            Select Max(ID), Max(名称)
            Into n_卡类别id, v_卡类别
            From 医疗卡类别
            Where 名称 = r_结算方式.结算卡类别 And Nvl(是否启用, 0) = 1;
          End If;
        
          If n_卡类别id Is Null Then
            v_Err_Msg := '未找到对应的医疗卡信息!';
            Raise Err_Item;
          End If;
        End If;
      End If;
    
      If n_卡类别id Is Not Null Then
        --三方卡
        Select Max(关联交易id)
        Into n_关联交易id
        From 病人预交记录
        Where 结帐id = n_结帐id And 卡类别id = n_卡类别id And Rownum < 2 And Mod(记录性质, 10) <> 1;
      
        If n_删除原结算 = 1 Then
          n_预交id := n_关联交易id;
        Else
          n_预交id := Null;
        End If;
      
        v_结算方式 := r_结算方式.结算方式 || '|' || r_结算方式.结算金额 || '|';
        Zl_病人结帐结算_Modify(1, n_病人id, n_结帐id, v_结算方式, Null, 0, n_卡类别id, r_结算方式.结算卡号, r_结算方式.交易流水号, r_结算方式.交易说明, 0, 0, 0,
                         n_结算类型, Null, v_操作员编码, v_操作员姓名, d_结帐时间, Null, 0, 1, n_预交id, n_关联交易id, n_删除原结算);
        n_删除原结算 := 0;
      
        三方结算交易_Save(n_结帐id, n_卡类别id, r_结算方式.结算卡号, r_结算方式.Expend);
      Else
        If n_结算卡序号 Is Not Null Then
          --消费卡
          v_消费卡结算 := Nvl(v_消费卡结算, '') || '||' || n_结算卡序号 || '|' || r_结算方式.结算卡号 || '|0|' || r_结算方式.结算金额;
        Else
          --其他结算
          v_结算方式 := r_结算方式.结算方式 || '|' || r_结算方式.结算金额 || '||';
          Zl_病人结帐结算_Modify(0, n_病人id, n_结帐id, v_结算方式, Null, 0, n_卡类别id, r_结算方式.结算卡号, r_结算方式.交易流水号, r_结算方式.交易说明, 0, 0, 0,
                           n_结算类型, Null, v_操作员编码, v_操作员姓名, d_结帐时间, Null, 0);
        End If;
      End If;
    
      n_结算金额 := n_结算金额 + Nvl(r_结算方式.结算金额, 0);
    Elsif r_结算方式.冲预交列表 Is Null Then
      --【**】冲预交,目前默认全冲
      n_冲预交金额 := r_结算方式.结算金额;
      Zl_病人结帐结算_Modify(0, n_病人id, n_结帐id, Null, n_冲预交金额, 0, Null, Null, Null, Null, 0, 0, 0, n_结算类型, Null, v_操作员编码,
                       v_操作员姓名, d_结帐时间, Null, 0);
    
      n_结算金额 := n_结算金额 + Nvl(r_结算方式.结算金额, 0);
    Else
      --【*】按指定单据进行预交款支付
      病人预交款_List(r_结算方式.冲预交列表, 0, l_预交款, n_存在退预交);
    End If;
  
    Update 三方交易记录
    Set 业务结算id = n_结帐id
    Where 流水号 = Nvl(r_结算方式.交易流水号, '-') And 类别 = v_卡类别 And 业务类型 = 2;
  End Loop;

  --消费卡处理
  If v_消费卡结算 Is Not Null Then
    v_消费卡结算 := Substr(v_消费卡结算, 3);
    Zl_病人结帐结算_Modify(3, n_病人id, n_结帐id, v_消费卡结算, Null, 0, Null, Null, Null, Null, 0, 0, 0, n_结算类型, Null, v_操作员编码,
                     v_操作员姓名, d_结帐时间, Null, 0);
  End If;

  --【*】按指定单据进行预交款支付
  If l_预交款.Count > 0 Then
    n_冲预交金额 := 0;
    n_退预交金额 := 0;
    If Nvl(n_存在退预交, 0) = 0 Then
      --新增预交款结算数据
      For I In 1 .. l_预交款.Count Loop
        Zl_结帐预交记录_Insert(l_预交款(I).预交id, l_预交款(I).单据号, 1, l_预交款(I).冲预交, n_结帐id, n_病人id, v_操作员编码, v_操作员姓名, d_结帐时间);
      
        n_冲预交金额 := n_冲预交金额 + Nvl(l_预交款(I).冲预交, 0);
      End Loop;
    Else
      --修正预交款结算数据
      --  1.如果存在退预交款，则只能使用预交款进行结帐
      If Nvl(n_非预交款结算, 0) = 1 Then
        v_Err_Msg := '存在对预交款进行退款时，所有全部结帐金额都必须使用预交款进行支付！';
        Raise Err_Item;
      End If;
    
      For I In 1 .. l_预交款.Count Loop
        If Nvl(l_预交款(I).是否退款, 0) = 0 Then
          n_冲预交金额 := n_冲预交金额 + Nvl(l_预交款(I).冲预交, 0);
        Else
          Zl_三方退款信息_Insert(n_结帐id, l_预交款(I).预交id, l_预交款(I).冲预交, l_预交款(I).卡号, l_预交款(I).交易流水号, l_预交款(I).交易说明, 1, 0,
                           l_预交款(I).是否转账, l_预交款(I).卡类别id, l_预交款(I).原交易流水号, l_预交款(I).原交易说明);
          Zl_病人结帐结算_Modify(1, n_病人id, n_结帐id, l_预交款(I).结算方式 || '|' || -1 * l_预交款(I).冲预交 || '| | ', Null, Null,
                           l_预交款(I).卡类别id, l_预交款(I).卡号, l_预交款(I).原交易流水号, l_预交款(I).原交易说明, Null, Null, Null, n_结算类型, Null,
                           v_操作员编码, v_操作员姓名, d_结帐时间, Null, 0, 2, Null, l_预交款(I).关联交易id, 1, Nvl(l_预交款(I).退款方式, 0) + 1);
        
          --保存扩展结算信息
          If Nvl(l_预交款(I).退款方式, 0) = 0 Then
            三方结算交易_Save(n_结帐id, l_预交款(I).卡类别id, l_预交款(I).卡号, l_预交款(I).交易扩展信息);
          End If;
        
          n_退预交金额 := n_退预交金额 + Nvl(l_预交款(I).冲预交, 0);
        End If;
      End Loop;
    
      --  2.有退必有冲；如单据A001，预交款金额1000，本次结帐800，则传入两条记录①冲1000，②退200，Sum(冲金额-退金额)=结帐金额
      If Abs(Nvl(n_结帐总额, 0) - (Nvl(n_冲预交金额, 0) - Nvl(n_退预交金额, 0))) > 1.00 Then
        v_Err_Msg := '预交款支付金额与结帐金额不相等，不允许结算！';
        Raise Err_Item;
      End If;
    End If;
  
    If Nvl(l_预交款(1).退款方式, 0) <> 0 Then
      For I In 1 .. l_预交款.Count Loop
        If Nvl(l_预交款(I).是否退款, 0) = 1 Then
          三方结算交易_Save(n_结帐id, l_预交款(I).卡类别id, l_预交款(I).卡号, l_预交款(I).扩展信息);
          Exit;
        End If;
      End Loop;
    End If;
  
    n_结算金额 := n_结算金额 + (Nvl(n_冲预交金额, 0) - Nvl(n_退预交金额, 0));
  End If;

  n_误差费 := Round(Nvl(n_结帐总额, 0) - Nvl(n_结算金额, 0), 6);
  If Abs(Nvl(n_误差费, 0)) > 1 Then
    v_Err_Msg := '计算的误差金额大于了1.00或小于-1.00元,不允许结帐操作,请检查!';
    Raise Err_Item;
  End If;

  --【5】完成结算，返回结果
  --电子票据处理
  n_是否电子票据 := b_Einvoice_Request.Einvoice_Start(3, Null, n_结算类型);

  Zl_病人结帐结算_Modify(0, n_病人id, n_结帐id, '', Null, 0, Null, Null, Null, Null, 0, 0, n_误差费, n_结算类型, Null, v_操作员编码, v_操作员姓名,
                   d_结帐时间, Null, 1, 2, Null, Null, 0, Null, 0, n_是否电子票据);

  --需要开具电子票据
  If Nvl(n_是否电子票据, 0) = 1 Then
    If b_Einvoice_Request.Einvoice_Create(3, n_结帐id, Null, v_Err_Msg) = 1 Then
      Select Max(1), Max(姓名), Max(号码), Max(To_Char(To_Date(Substr(生成时间, 1, 8), 'yyyymmdd'), 'yyyy-mm-dd')), Max(Url内网),
             Max(Url外网), Max(票据金额)
      Into n_开票标志, v_患者姓名, v_发票编号, v_开票日期, v_Url, v_Url外网, n_发票金额
      From 电子票据使用记录
      Where 结算id = n_结帐id And 票种 = 3 And 记录状态 = 1;
    
      If v_患者姓名 Is Not Null Then
        v_姓名 := v_患者姓名;
      End If;
    End If;
  End If;
  v_Temp := '<CZSJ>' || To_Char(d_结帐时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<JZID>' || n_结帐id || '</JZID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<KPBZ>' || Nvl(n_开票标志, 0) || '</KPBZ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<URL>' || Htf.Escape_Sc(Nvl(v_Url, '')) || '</URL>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<NETURL>' || Htf.Escape_Sc(Nvl(v_Url外网, '')) || '</NETURL>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<FPTT>' || v_姓名 || '</FPTT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<FPH>' || v_发票编号 || '</FPH>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<FPJE>' || Nvl(n_发票金额, 0) || '</FPJE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<KPRQ>' || v_开票日期 || '</KPRQ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Err_Special Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20105, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Settlement;
/
Create Or Replace Procedure Zl_Third_Getsettlement
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取HIS结帐数据
  --入参:Xml_In:
  --<IN>
  -- <BRID></BRID>       //病人ID
  -- <XM></XM>          //姓名
  -- <SFZH></SFZH>       //身份证号
  -- <ZYID></ZYID>         //主页ID
  -- <JSLX></JSLX>       //结算类型。1-门诊,2-住院。固定传2
  -- <JSKLB></JSKLB>       //结算卡类别
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --<JBXX>              //基本信息
  --   <XM></XM>           //姓名
  --   <XB></XB>           //性别
  --   <NL></NL>         //年龄
  --   <ZYH></ ZYH>        //住院号
  --   <ZYKS></ ZYKS>          //住院科室
  --   <KSID></KSID>         //科室ID
  --   <ZZYS></ ZZYS>          //主治医生
  --   <RYSJ></ RYSJ>          //入院时间
  --   <CYSJ></ CYSJ >         //出院时间
  --   <JZSJ></JZSJ>         //结帐时间(未结帐为空)
  --   <DJH></DJH>         //单据号(未结帐为空)
  --   <JSZFY></JSZFY>         //结算总费用
  --</JBXX>
  --<YJKLIST>              //冲抵预缴款集合
  --   <ITEM>
  --     <DJH><DJH>        //预交款单据号
  --     <JSFS></JSFS>     //结算方式（为名称，返回什么就取什么）
  --     <JE></JE>           //预缴款金额
  --     <JYLSH></JYLSH>       //交易流水号（便于冲销使用）
  --     <JYSM></JYSM>        //交易说明
  --     <SFJSK></SFJSK>       //是否结算卡，1-是，0-否。如果是由传入的卡类别缴费，返回1，否则返回0
  --     <ZFZT></ZFZT>        //支付状态：0-已支付，1-正在支付
  --   </ITEM>
  --</YJKLIST >
  --<TBQK>               //退补情况
  --   <TBLX></TBLX>         //退补类型(1:个人补款，2:医院退款)
  --   <TBJE></TBJE>         //退补金额
  --</TBQK>
  --<JSMX>                 //结算明细
  --  <ITEM>
  --    <JSFS></JSFS>         //结算方式
  --    <JSJE></JSJE>         //结算金额
  --    <SFYB></SFYB>         //是否医保结算方式,1-是，0-否
  --    <SFYJK></SFYJK>         //是否预交款,1-是，0-否
  --  </ITEM>
  --</JSMX>
  -- <ERROR><MSG></MSG></ERROR>    //出现错误时返回具体原因，error节点为空表示成功
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_病人id     病人信息.病人id%Type;
  v_姓名       病人信息.姓名%Type;
  v_身份证号   病人信息.身份证号%Type;
  n_主页id     病人信息.主页id%Type;
  n_结算类型   Number(3);
  n_卡类别id   医疗卡类别.Id%Type;
  v_结算卡类别 Varchar2(200);
  n_是否结清   Number(3); -- 1-未结清,0-结清
  n_结帐金额   住院费用记录.结帐金额%Type;
  v_Temp       Varchar2(32767); --临时XML
  v_Subtemp    Varchar2(32767);
  n_退补金额   病人预交记录.冲预交%Type;
  n_病人余额   病人预交记录.金额%Type;
  n_结帐id     病人预交记录.结帐id%Type;

  n_Number  Number(2);
  x_Templet Xmltype; --模板XML
  x_Temp    Xmltype;

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/ZYID'), Nvl(Extractvalue(Value(A), 'IN/JSLX'), 2),
         Extractvalue(Value(A), 'IN/JSKLB'), Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM')
  Into n_病人id, n_主页id, n_结算类型, v_结算卡类别, v_身份证号, v_姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If n_结算类型 = 1 And Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '无法确定病人信息,请检查!';
    Raise Err_Item;
  End If;

  Select Decode(Translate(Nvl(v_结算卡类别, 'abcd'), '#1234567890', '#'), Null, 1, 0) Into n_Number From Dual;
  If Nvl(n_Number, 0) = 1 Then
    Select Max(ID) Into n_卡类别id From 医疗卡类别 Where ID = To_Number(v_结算卡类别);
  Else
    Select Max(ID) Into n_卡类别id From 医疗卡类别 Where 名称 = v_结算卡类别;
  End If;
  If Nvl(n_卡类别id, 0) = 0 Then
    v_Err_Msg := '无法确认传入的结算卡,请检查!';
    Raise Err_Item;
  End If;

  If n_结算类型 = 2 Then
    Select Count(1)
    Into n_是否结清
    From (Select 1
           From 住院费用记录
           Where 病人id = n_病人id And 记录状态 <> 0 And 主页id = n_主页id And 记帐费用 = 1
           Group By 病人id, 主页id
           Having Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) <> 0)
    Where Rownum < 2;
  
    If n_是否结清 = 0 Then
      --结清,读取结帐数据
      For r_结帐 In (Select 姓名, 性别, 年龄, 住院号, 住院科室, 科室id, 主治医生, To_Char(入院时间, 'yyyy-mm-dd') As 入院时间,
                          To_Char(出院时间, 'yyyy-mm-dd') As 出院时间, To_Char(结帐时间, 'yyyy-mm-dd') As 结帐时间, 单据号, 结算总费用, 结帐id
                   From (Select c.姓名, c.性别, c.年龄, c.住院号, d.名称 As 住院科室, c.入院科室id As 科室id, c.住院医师 As 主治医生, c.入院日期 As 入院时间,
                                 c.出院日期 As 出院时间, a.收费时间 As 结帐时间, a.No As 单据号, a.结帐金额 As 结算总费用, a.Id As 结帐id
                          From 病人结帐记录 A, 病案主页 C, 部门表 D
                          Where a.记录状态 = 1 And Nvl(a.结算状态, 0) In (0, 2) And a.病人id = c.病人id And a.病人id = n_病人id And
                                a.主页id = n_主页id And a.主页id = c.主页id And c.入院科室id = d.Id(+) And Exists
                           (Select 1 From 病人预交记录 Where 结帐id = a.Id And 卡类别id = n_卡类别id)
                          Order By 结帐时间 Desc)
                   Where Rownum < 2) Loop
        v_Temp := '<XM>' || r_结帐.姓名 || '</XM>';
        v_Temp := v_Temp || '<XB>' || r_结帐.性别 || '</XB>';
        v_Temp := v_Temp || '<NL>' || r_结帐.年龄 || '</NL>';
        v_Temp := v_Temp || '<ZYH>' || r_结帐.住院号 || '</ZYH>';
        v_Temp := v_Temp || '<ZYKS>' || r_结帐.住院科室 || '</ZYKS>';
        v_Temp := v_Temp || '<KSID>' || r_结帐.科室id || '</KSID>';
        v_Temp := v_Temp || '<ZZYS>' || r_结帐.主治医生 || '</ZZYS>';
        v_Temp := v_Temp || '<RYSJ>' || r_结帐.入院时间 || '</RYSJ>';
        v_Temp := v_Temp || '<CYSJ>' || r_结帐.出院时间 || '</CYSJ>';
        v_Temp := v_Temp || '<JZSJ>' || r_结帐.结帐时间 || '</JZSJ>';
        v_Temp := v_Temp || '<DJH>' || r_结帐.单据号 || '</DJH>';
        v_Temp := v_Temp || '<JSZFY>' || r_结帐.结算总费用 || '</JSZFY>';
        v_Temp := '<JBXX>' || v_Temp || '</JBXX>';
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
        n_结帐id := r_结帐.结帐id;
      End Loop;
    
      If n_结帐id Is Null Then
        v_Err_Msg := '该病人没有结帐数据!';
        Raise Err_Item;
      End If;
    
      --冲抵预缴款集合
      v_Temp := '';
      For r_预交 In (Select NO As 单据号, 结算方式, Sum(冲预交) As 金额, 卡类别id, 交易流水号, 交易说明, Decode(Nvl(校对标志, 0), 0, 0, 1) As 支付状态
                   From 病人预交记录
                   Where 结帐id = n_结帐id And Mod(记录性质, 10) = 1
                   Group By NO, 结算方式, 卡类别id, 交易流水号, 交易说明, Nvl(校对标志, 0)
                   Order By 单据号 Desc) Loop
        v_Temp := '<DJH>' || r_预交.单据号 || '</DJH>';
        v_Temp := v_Temp || '<JSFS>' || r_预交.结算方式 || '</JSFS>';
        v_Temp := v_Temp || '<JE>' || r_预交.金额 || '</JE>';
        v_Temp := v_Temp || '<JYLSH>' || r_预交.交易流水号 || '</JYLSH>';
        v_Temp := v_Temp || '<JYSM>' || r_预交.交易说明 || '</JYSM>';
        If n_卡类别id = r_预交.卡类别id Then
          v_Temp := v_Temp || '<SFJSK>' || 1 || '</SFJSK>';
        Else
          v_Temp := v_Temp || '<SFJSK>' || 0 || '</SFJSK>';
        End If;
        v_Temp    := v_Temp || '<ZFZT>' || r_预交.支付状态 || '</ZFZT>';
        v_Temp    := '<ITEM>' || v_Temp || '</ITEM>';
        v_Subtemp := v_Subtemp || v_Temp;
      End Loop;
      v_Subtemp := '<YJKLIST>' || v_Subtemp || '</YJKLIST>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Subtemp)) Into x_Templet From Dual;
    
      --退补情况
      Select Nvl(Sum(冲预交), 0)
      Into n_退补金额
      From 病人预交记录
      Where 结帐id = n_结帐id And Mod(记录性质, 10) = 2 And Nvl(校对标志, 0) = 0;
      If n_退补金额 < 0 Then
        v_Temp := '<TBLX>' || 2 || '</TBLX>';
      Else
        v_Temp := '<TBLX>' || 1 || '</TBLX>';
      End If;
      v_Temp := v_Temp || '<TBJE>' || Abs(n_退补金额) || '</TBJE>';
      v_Temp := '<TBQK>' || v_Temp || '</TBQK>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    
      --结算明细
      Select Xmlelement("JSMX",
                         Xmlagg(Xmlelement("ITEM",
                                            Xmlforest(结算方式 As "JSFS", 结算金额 As "JSJE", 是否医保 As "SFYB", 是否预交款 As "SFYJK"))))
      Into x_Temp
      From (Select a.结算方式, Sum(a.冲预交) As 结算金额, Decode(Mod(a.记录性质, 10), 1, 1, 0) As 是否预交款,
                    Max(Decode(Nvl(b.性质, 0), 3, 1, 4, 1, 0)) As 是否医保
             From 病人预交记录 A, 结算方式 B
             Where a.结算方式 = b.名称(+) And a.结帐id = n_结帐id
             Group By Decode(Mod(a.记录性质, 10), 1, 1, 0), a.结算方式);
      Select Appendchildxml(x_Templet, '/OUTPUT', x_Temp) Into x_Templet From Dual;
    Else
      --未结清，读取未结数据
      For r_Info In (Select c.姓名, c.性别, c.年龄, c.住院号, d.名称 As 住院科室, c.入院科室id As 科室id, c.住院医师 As 主治医生,
                            To_Char(c.入院日期, 'yyyy-mm-dd') As 入院时间, To_Char(c.出院日期, 'yyyy-mm-dd') As 出院时间
                     From 病案主页 C, 部门表 D
                     Where c.病人id = n_病人id And c.入院科室id = d.Id(+) And c.主页id = n_主页id And Rownum < 2) Loop
        v_Temp := '<XM>' || r_Info.姓名 || '</XM>';
        v_Temp := v_Temp || '<XB>' || r_Info.性别 || '</XB>';
        v_Temp := v_Temp || '<NL>' || r_Info.年龄 || '</NL>';
        v_Temp := v_Temp || '<ZYH>' || r_Info.住院号 || '</ZYH>';
        v_Temp := v_Temp || '<ZYKS>' || r_Info.住院科室 || '</ZYKS>';
        v_Temp := v_Temp || '<KSID>' || r_Info.科室id || '</KSID>';
        v_Temp := v_Temp || '<ZZYS>' || r_Info.主治医生 || '</ZZYS>';
        v_Temp := v_Temp || '<RYSJ>' || r_Info.入院时间 || '</RYSJ>';
        v_Temp := v_Temp || '<CYSJ>' || r_Info.出院时间 || '</CYSJ>';
        v_Temp := v_Temp || '<JZSJ>' || '' || '</JZSJ>';
        v_Temp := v_Temp || '<DJH>' || '' || '</DJH>';
      End Loop;
    
      Begin
        Select Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0))
        Into n_结帐金额
        From 住院费用记录
        Where 病人id = n_病人id And 记录状态 <> 0 And 主页id = n_主页id And 记帐费用 = 1;
      Exception
        When Others Then
          n_结帐金额 := 0;
      End;
      v_Temp := v_Temp || '<JSZFY>' || n_结帐金额 || '</JSZFY>';
      v_Temp := '<JBXX>' || v_Temp || '</JBXX>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    
      --冲抵预缴款集合
      v_Subtemp := '';
      For r_预交 In (Select a.No As 单据号, a.结算方式, Sum(Nvl(a.金额, 0)) - Sum(Nvl(a.冲预交, 0)) As 金额, a.卡类别id, a.交易流水号, a.交易说明,
                          Decode(Nvl(a.校对标志, 0), 0, 0, 1) As 支付状态
                   From 病人预交记录 A, 结算方式 B
                   Where a.结算方式 = b.名称(+) And a.病人id = n_病人id And Mod(a.记录性质, 10) = 1 And Nvl(a.预交类别, 2) = 2 And
                         (a.主页id = n_主页id Or a.主页id Is Null) And Nvl(b.性质, 0) <> 5
                   Group By a.No, a.结算方式, a.卡类别id, a.交易流水号, a.交易说明, Nvl(a.校对标志, 0)
                   Having Sum(Nvl(a.金额, 0)) - Sum(Nvl(a.冲预交, 0)) <> 0
                   Order By 单据号) Loop
        v_Temp := '<DJH>' || r_预交.单据号 || '</DJH>';
        v_Temp := v_Temp || '<JSFS>' || r_预交.结算方式 || '</JSFS>';
        v_Temp := v_Temp || '<JE>' || r_预交.金额 || '</JE>';
        v_Temp := v_Temp || '<JYLSH>' || r_预交.交易流水号 || '</JYLSH>';
        v_Temp := v_Temp || '<JYSM>' || r_预交.交易说明 || '</JYSM>';
        If n_卡类别id = r_预交.卡类别id Then
          v_Temp := v_Temp || '<SFJSK>' || 1 || '</SFJSK>';
        Else
          v_Temp := v_Temp || '<SFJSK>' || 0 || '</SFJSK>';
        End If;
        v_Temp     := v_Temp || '<ZFZT>' || r_预交.支付状态 || '</ZFZT>';
        v_Temp     := '<ITEM>' || v_Temp || '</ITEM>';
        v_Subtemp  := v_Subtemp || v_Temp;
        n_病人余额 := Nvl(n_病人余额, 0) + Nvl(r_预交.金额, 0);
      End Loop;
      v_Subtemp := '<YJKLIST>' || v_Subtemp || '</YJKLIST>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Subtemp)) Into x_Templet From Dual;
    
      --退补情况
      If Nvl(n_病人余额, 0) - Nvl(n_结帐金额, 0) > 0 Then
        v_Temp := '<TBLX>' || 2 || '</TBLX>';
      Else
        v_Temp := '<TBLX>' || 1 || '</TBLX>';
      End If;
      v_Temp := v_Temp || '<TBJE>' || Abs(Nvl(n_病人余额, 0) - Nvl(n_结帐金额, 0)) || '</TBJE>';
      v_Temp := '<TBQK>' || v_Temp || '</TBQK>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    End If;
  End If;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getsettlement;
/

Create Or Replace Procedure Zl_Third_Deposit_Recharge
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:预交款充值
  --入参:Xml_In:
  --    <IN>
  --        <BRID>病人ID</BRID>
  --        <ZYID>主页ID</ZYID>
  --        <XM>姓名</XM>
  --        <SFZH>身份证号</SFZH>
  --        <SFMZ>是否门诊</SFMZ>   //1-是门诊,0-住院
  --        <SFYJ>是否押金</SFYJ>   //是否为押金：0-预交缴款，1-押金缴款
  --        <JSMS>0</JSMS>          //结算模式：0-普通模式，1-异步结算模式
  --        <CZLX>0</CZLX>          //操作类型：结算模式为1时传入，0-开始结算，1-完成结算，2-回退结算
  --        <YJDH></YJDH>           //预交单号，操作类型为1或2时传入
  --        <ZFBZH>支付宝公众号UserID</ZFBZH>
  --        <ZFBXCY>支付宝小程序UserID</ZFBXCY>
  --        <WXGZHID>微信公众号OpenID</WXGZH>
  --        <WXXCXID>微信小程序OpenID</WXXCXID>
  --        <JSLIST>                //结算列表，操作类型为2时可不传入
  --            <JS>
  --              <JSKLB>支付卡类别</JSKLB >
  --              <JSKH>支付卡号</JSKH>
  --              <JYLSH>交易流水号</JYLSH>
  --              <JYSM>交易说明</JYSM>
  --              <JSFS>支付方式</JSFS> //充值方式:现金;支票,如果是三方卡,可以传空
  --              <JSJE>交易金额</JSJE> //充值金额
  --              <ZY>摘要</ZY>
  --              <SFXFK>是否消费卡</SFXFK>
  --              <JSHM>结算号码(可以不传)</JSHM>
  --              <JKDW>缴款单位(可以不传)</JKDW>
  --              <DWKFH>单位开户行(可以不传)</DWKFH>
  --              <DWZH>单位帐号(可以不传)</DWZH>
  --              <HZDW>合作单位(可以不传)</HZDW>
  --              <EXPENDLIST>         //扩展交易信息
  --                   <EXPEND>
  --                        <JYMC>交易名称</JYMC>
  --                        <JYLR>交易内容</JYLR>
  --                   </EXPEND>
  --              </EXPENDLIST >
  --            </JS>
  --         </JSLIST>
  --    </IN>
  --出参:Xml_Out
  --  <OUTPUT>
  --     <CZSJ>操作时间</CZSJ>          //HIS的登记时间
  --     <YJDH>预交单号(多个逗号分隔)</YJDH>
  --     <KPBZ>开票标志</KPBZ> //1-成功开具电子票据;0-未开票成功标志
  --     <URL>H5页面URL</URL>
  --     <NETURL>外网H5页面URL</NETURL>
  --     <FPTT>发票抬头</FPTT>        //病人姓名
  --     <FPH>发票号</FPH>             //发票编号
  --     <FPJE>发票金额</FPJE>        //100.00
  --     <KPRQ>开票日期</KPRQ>   //yyyy-mm-dd
  --    DD如无下列错误结点则说明正确执行
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_结算方式   Varchar2(2000);
  v_No         病人预交记录.No%Type;
  v_操作员编码 病人预交记录.操作员编号%Type;
  v_操作员姓名 病人预交记录.操作员姓名%Type;
  n_结算模式   Number(2); --0-普通模式，1-异步结算模式
  n_操作类型   Number(2); --结算模式为1时传入，0-开始结算，1-完成结算，2-回退结算 

  n_卡类别id   医疗卡类别.Id%Type;
  n_病人id     门诊费用记录.病人id%Type;
  v_姓名       病人信息.姓名%Type;
  v_身份证号   病人信息.身份证号%Type;
  n_主页id     病人预交记录.主页id%Type;
  n_科室id     病人预交记录.科室id%Type;
  n_预交id     病人预交记录.Id%Type;
  n_结算卡序号 病人预交记录.结算卡序号%Type;
  n_预交类别   病人预交记录.预交类别%Type;
  n_消费卡     Number(2);
  n_门诊预存   Number(2);
  v_卡类别     三方交易记录.类别%Type;
  n_Step       Number(2);
  d_登记时间   Date;
  n_类型       Number(1);
  n_状态       Number(1);
  n_校对标志   病人预交记录.校对标志%Type;
  n_Billcount  Number;
  n_是否押金   Number(1);
  n_预交电子票据       病人预交记录.预交电子票据%Type;
  v_支付宝公众号userid Varchar2(100);
  v_支付宝小程序userid Varchar2(100);
  v_微信公众号openid   Varchar2(100);
  v_微信小程序openid   Varchar2(100);
  n_开票标志           Number(2);
  v_患者姓名           电子票据使用记录.姓名%Type;
  v_发票编号           电子票据使用记录.号码%Type;
  v_开票日期           Varchar2(20);
  n_发票金额           电子票据使用记录.票据金额%Type;
  v_Url                电子票据使用记录.Url内网%Type;
  v_Url外网            电子票据使用记录.Url外网%Type;
  v_Temp       Varchar2(32767); --临时XML
  v_Err_Msg    Varchar2(200);
  Err_Special Exception;
  Err_Item Exception;

  Function Get卡名称
  (
    卡类别_In Varchar2,
    消费卡_In Number
  ) Return Varchar2 As
    v_卡类别 Varchar2(200);
    n_Num    Number(1);
  Begin
    Select Decode(Translate(卡类别_In, '#1234567890', '#'), Null, 1, 0) Into n_Num From Dual;
    If Nvl(消费卡_In, 0) = 1 Then
      If Nvl(n_Num, 0) = 1 Then
        Select Max(名称) Into v_卡类别 From 消费卡类别目录 Where 编号 = To_Number(卡类别_In);
      Else
        Select Max(名称) Into v_卡类别 From 消费卡类别目录 Where 名称 = 卡类别_In;
      End If;
    Else
      If Nvl(n_Num, 0) = 1 Then
        Select Max(名称) Into v_卡类别 From 医疗卡类别 Where ID = To_Number(卡类别_In);
      Else
        Select Max(名称) Into v_卡类别 From 医疗卡类别 Where 名称 = 卡类别_In;
      End If;
    End If;
    Return v_卡类别;
  End Get卡名称;

  Function Get结算方式
  (
    卡类别_In    Varchar2,
    消费卡_In    Number,
    卡类别id_Out Out 病人预交记录.卡类别id%Type
  ) Return Varchar2 As
    --卡类别_In 卡类别名称
  Begin
    If Nvl(消费卡_In, 0) = 1 Then
      Begin
        Select 编号, 结算方式, Decode(Nvl(启用, 0), 1, Null, 名称 || '未启用，不允许进行缴费！')
        Into 卡类别id_Out, v_结算方式, v_Err_Msg
        From 消费卡类别目录
        Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := 卡类别_In || '不存在！';
      End;
    
      If v_Err_Msg Is Not Null Then
        Raise Err_Item;
      End If;
      If v_结算方式 Is Null Then
        v_Err_Msg := 卡类别_In || '未设置结算方式，请在消费卡管理中设置结算方式！';
        Raise Err_Item;
      End If;
    Else
      Begin
        Select ID, 结算方式, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用，不允许进行缴费！')
        Into 卡类别id_Out, v_结算方式, v_Err_Msg
        From 医疗卡类别
        Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := 卡类别_In || '不存在！';
      End;
    
      If v_Err_Msg Is Not Null Then
        Raise Err_Item;
      End If;
      If v_结算方式 Is Null Then
        v_Err_Msg := 卡类别_In || '未设置结算方式，请在医疗卡类别中设置结算方式！';
        Raise Err_Item;
      End If;
    End If;
  
    Return v_结算方式;
  End Get结算方式;
Begin
  Select Extractvalue(Value(A), 'IN/BRID'), To_Number(Extractvalue(Value(A), 'IN/ZYID')),
         To_Number(Extractvalue(Value(A), 'IN/SFMZ')), Extractvalue(Value(A), 'IN/SFZH'),
         Extractvalue(Value(A), 'IN/XM'), Extractvalue(Value(A), 'IN/JSMS'), Extractvalue(Value(A), 'IN/CZLX'),
         Extractvalue(Value(A), 'IN/YJDH'), Extractvalue(Value(A), 'IN/SFYJ'), Extractvalue(Value(A), 'IN/ZFBZH'),
         Extractvalue(Value(A), 'IN/ZFBXCY'), Extractvalue(Value(A), 'IN/WXGZHID'), Extractvalue(Value(A), 'IN/WXXCXID')
  Into n_病人id, n_主页id, n_门诊预存, v_身份证号, v_姓名, n_结算模式, n_操作类型, v_No, n_是否押金, v_支付宝公众号userid, v_支付宝小程序userid, v_微信公众号openid,
       v_微信小程序openid 
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_门诊预存, 0) = 1 And Nvl(n_病人id, 0) = 0 Then
    If Not v_身份证号 Is Null And Not v_姓名 Is Null Then
      n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
    End If;
  End If;

  --0.相关检查
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '不能有效识别病人身份，不允许充值！';
    Raise Err_Item;
  End If;

  If Not v_支付宝公众号userid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('支付宝公众号UserID'), v_支付宝公众号userid);
  End If;

  If Not v_支付宝小程序userid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('支付宝小程序UserID'), v_支付宝公众号userid);
  End If;

  If Not v_微信公众号openid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('微信公众号OpenID'), v_支付宝公众号userid);
  End If;

  If Not v_微信小程序openid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('微信小程序OpenID'), v_支付宝公众号userid);
  End If;

  Begin
    Select Nullif(Nvl(a.当前科室id, b.出院科室id), 0)
    Into n_科室id
    From 病人信息 A, 病案主页 B
    Where a.病人id = b.病人id(+) And a.主页id = b.主页id(+) And a.病人id = n_病人id;
  Exception
    When Others Then
      v_Err_Msg := '不能有效识别病人身份，不允许充值！';
      Raise Err_Item;
  End;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) <> 0 Then
    If v_No Is Null Then
      v_Err_Msg := '没有指定相关的结算数据！';
      Raise Err_Item;
    End If;
  
    Begin
      If n_是否押金 = 1 Then
        Select 收款时间, ID
        Into d_登记时间, n_预交id
        From 病人押金记录
        Where 记录状态 = 0 And NO = v_No And Nvl(校对标志, 0) = 1 And Rownum < 2;
      Else
        Select 收款时间, ID
        Into d_登记时间, n_预交id
        From 病人预交记录
        Where 记录性质 = 1 And 记录状态 = 0 And NO = v_No And Nvl(校对标志, 0) = 1 And Rownum < 2;
      End If;
    Exception
      When Others Then
        v_Err_Msg := '没有找到指定的相关结算数据，可能已被处理！';
        Raise Err_Item;
    End;
  End If;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 2 Then
    --删除结算数据，恢复划价单
    If n_是否押金 = 1 Then
      Zl_病人押金异常记录_Delete(v_No);
    Else
      Zl_病人预交异常记录_Delete(v_No);
    End If;
    v_Temp  := '<YJDH>' || v_No || '</YJDH>';
    v_Temp  := v_Temp || '<CZSJ>' || To_Char(d_登记时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
    v_Temp  := v_Temp || '<KPBZ>' || 0 || '</KPBZ>';
    v_Temp  := v_Temp || '<URL>' || '' || '</URL>';
    v_Temp  := v_Temp || '<NETURL>' || '' || '</NETURL>';
    v_Temp  := v_Temp || '<FPTT>' || v_姓名 || '</FPTT>';
    v_Temp  := v_Temp || '<FPH>' || '' || '</FPH>';
    v_Temp  := v_Temp || '<FPJE>' || '' || '</FPJE>';
    v_Temp  := v_Temp || '<KPRQ>' || '' || '</KPRQ>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
    Return;
  End If;

  --操作员信息:部门ID,部门名称;人员ID,人员编号,人员姓名
  v_Temp := Zl_Identity;
  If Nvl(v_Temp, '0') = '0' Or Nvl(v_Temp, '_') = '_' Then
    v_Err_Msg := '不能识别有效的操作员，不允许缴费！';
    Raise Err_Item;
  End If;
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_操作员编码 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
  v_操作员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);

  If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
    For c_交易记录 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                          Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                          Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                          Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡,
                          Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要
                   From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
    
      If c_交易记录.结算卡类别 Is Null Then
        v_卡类别 := c_交易记录.结算方式;
      Else
        v_卡类别 := Get卡名称(c_交易记录.结算卡类别, c_交易记录.是否消费卡);
      End If;
      If v_卡类别 Is Null Then
        v_Err_Msg := '不支持的结算方式，请检查！';
        Raise Err_Item;
      End If;
    
      --仅第一个结算方式才检查交易锁
      n_Step := Nvl(n_Step, 0) + 1;
      If Zl_Fun_三方交易记录_Locked(v_卡类别, c_交易记录.交易流水号, c_交易记录.结算卡号, c_交易记录.摘要, 1) = 0 And n_Step = 1 Then
        v_Err_Msg := '交易流水号为:' || c_交易记录.交易流水号 || '的交易正在进行中，不允许再次提交此交易！';
        Raise Err_Special;
      End If;
    End Loop;
  End If;

  --2.确定支付方式 
  If Nvl(n_门诊预存, 0) = 0 Then
    n_预交类别 := 2;
  Else
    n_预交类别 := 1;
  End If;
  d_登记时间  := Sysdate;
  n_Billcount := 0;
  For c_结算方式 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                        Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号,
                        Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                        Extractvalue(b.Column_Value, '/JS/JSJE') As 结算金额,
                        Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                        Extractvalue(b.Column_Value, '/JS/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要,
                        Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡,
                        Extractvalue(b.Column_Value, '/JS/JSHM') As 结算号码,
                        Extractvalue(b.Column_Value, '/JS/JKDW') As 缴款单位,
                        Extractvalue(b.Column_Value, '/JS/DWKFH') As 单位开户行,
                        Extractvalue(b.Column_Value, '/JS/DWZH') As 单位帐号,
                        Extractvalue(b.Column_Value, '/JS/HZDW') As 合作单位,
                        Extract(b.Column_Value, '/JS/EXPENDLIST') As Expend
                 From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
  
    If Nvl(c_结算方式.结算金额, 0) = 0 Then
      v_Err_Msg := '传入的充值金额为零，没必要进行充值处理，请检查充值金额是否传入错误！';
      Raise Err_Item;
    End If;
  
    n_消费卡     := Nvl(c_结算方式.是否消费卡, 0);
    n_结算卡序号 := Null;
    n_卡类别id   := Null;
    If c_结算方式.结算卡类别 Is Null Then
      v_卡类别   := c_结算方式.结算方式;
      v_结算方式 := c_结算方式.结算方式;
    Else
      v_卡类别   := Get卡名称(c_结算方式.结算卡类别, n_消费卡);
      v_结算方式 := Get结算方式(v_卡类别, n_消费卡, n_卡类别id);
      If Nvl(n_消费卡, 0) = 1 Then
        n_结算卡序号 := n_卡类别id;
        n_卡类别id   := Null;
      End If;
    End If;
    If v_结算方式 Is Null Then
      v_Err_Msg := '未确定本次充值的支付方式，请检查支付方式是否传入错误！';
      Raise Err_Item;
    End If;
  
    If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
      If Nvl(n_Billcount, 0) > 0 Then
        v_Err_Msg := '目前只支持一种支付方式，请检查充值信息是否传入错误！';
        Raise Err_Item;
      End If;
    
      v_No := Nextno(11);
      Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
    End If;
  
    --操作类型_In:0-正常缴预交;1-保存为未生效的预交款;3-余额退款
    --操作状态_In:0-正常结算，1-保存为异常单据，2-完成异常结算 
    If Nvl(n_结算模式, 0) = 0 Then
      n_类型     := 0;
      n_状态     := 0;
      n_校对标志 := 0;
    Else
      If Nvl(n_操作类型, 0) = 0 Then
        n_类型     := 1;
        n_状态     := 1;
        n_校对标志 := 1;
      Else
        n_类型     := 0;
        n_状态     := 2;
        n_校对标志 := 0;
      End If;
    End If;
    If n_是否押金 = 1 Then
      Zl_病人押金记录_Insert(n_预交id, v_No, Null, n_病人id, n_主页id, n_科室id, c_结算方式.缴款单位, c_结算方式.单位开户行, c_结算方式.单位帐号, c_结算方式.摘要,
                       c_结算方式.结算金额, v_结算方式, c_结算方式.结算号码, n_预交类别, Null, v_操作员编码, v_操作员姓名, c_结算方式.结算卡号, n_卡类别id,
                       c_结算方式.交易流水号, c_结算方式.交易说明, n_状态);
    Else
      Zl_病人预交记录_Insert(n_预交id, v_No, Null, n_病人id, n_主页id, n_科室id, c_结算方式.结算金额, v_结算方式, c_结算方式.结算号码, c_结算方式.缴款单位,
                       c_结算方式.单位开户行, c_结算方式.单位帐号, c_结算方式.摘要, v_操作员编码, v_操作员姓名, Null, n_预交类别, n_卡类别id, n_结算卡序号,
                       c_结算方式.结算卡号, c_结算方式.交易流水号, c_结算方式.交易说明, c_结算方式.合作单位, d_登记时间, n_类型, Null, Null, 0, 0, 1, 0, n_校对标志,
                       n_状态);
    End If;
    If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
      v_Temp  := '<YJDH>' || v_No || '</YJDH>';
      v_Temp  := v_Temp || '<CZSJ>' || To_Char(d_登记时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
      v_Temp := v_Temp || '<KPBZ>' || 0 || '</KPBZ>';
      v_Temp := v_Temp || '<URL>' || '' || '</URL>';
      v_Temp := v_Temp || '<NETURL>' || '' || '</NETURL>';
      v_Temp := v_Temp || '<FPTT>' || v_姓名 || '</FPTT>';
      v_Temp := v_Temp || '<FPH>' || '' || '</FPH>';
      v_Temp := v_Temp || '<FPJE>' || '' || '</FPJE>';
      v_Temp := v_Temp || '<KPRQ>' || '' || '</KPRQ>';
      Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');

      Return;
    End If;
  
    If Nvl(n_消费卡, 0) = 1 Then
      Zl_三方接口更新_Update(n_结算卡序号, 1, c_结算方式.结算卡号, n_预交id, c_结算方式.交易流水号, c_结算方式.交易说明, 1, 0);
    End If;
  
    --保存扩展结算信息
    For c_扩展 In (Select Extractvalue(j.Column_Value, '/EXPEND/JYMC') As Jymc,
                        Extractvalue(j.Column_Value, '/EXPEND/JYLR') As Jylr
                 From Table(Xmlsequence(Extract(c_结算方式.Expend, '/EXPENDLIST/EXPEND'))) J) Loop
    
      If Nvl(n_消费卡, 0) = 1 Then
        Zl_三方结算交易_Insert(n_结算卡序号, 1, c_结算方式.结算卡号, n_预交id, c_扩展.Jymc || '|' || c_扩展.Jylr, 1);
      Else
        Zl_三方结算交易_Insert(n_卡类别id, 0, c_结算方式.结算卡号, n_预交id, c_扩展.Jymc || '|' || c_扩展.Jylr, 1 + Nvl(n_是否押金, 0));
      End If;
    End Loop;
    Update 三方交易记录
    Set 业务结算id = n_预交id
    Where 流水号 = c_结算方式.交易流水号 And 类别 = v_卡类别 And 业务类型 = 1;
  
    n_Billcount := n_Billcount + 1;
  End Loop;

  If Nvl(n_Billcount, 0) = 0 Then
    v_Err_Msg := '不能有效确认当前充值的支付方式！';
    Raise Err_Item;
  End If;
  If Nvl(n_是否押金, 0) = 0 Then
    --电子票据处理
    n_预交电子票据 := b_Einvoice_Request.Einvoice_Start(2, Null, n_门诊预存);
    Update 病人预交记录 Set 预交电子票据 = n_预交电子票据 Where ID = n_预交id;
    --需要开具电子票据
    If Nvl(n_预交电子票据, 0) = 1 Then
      If b_Einvoice_Request.Einvoice_Create(2, n_预交id, Null, v_Err_Msg) = 1 Then
        Select Max(1), Max(姓名), Max(号码), Max(To_Char(To_Date(Substr(生成时间, 1, 8), 'yyyymmdd'), 'yyyy-mm-dd')), Max(Url内网), Max(Url外网), Max(票据金额)
        Into n_开票标志, v_患者姓名, v_发票编号, v_开票日期, v_Url, v_Url外网, n_发票金额
        From 电子票据使用记录
        Where 结算id = n_预交id And 票种 = 2 And 记录状态 = 1;

        If v_患者姓名 Is Not Null Then
          v_姓名 := v_患者姓名;
        End If;
      End If;
    End If;
  End If;

  v_Temp  := '<YJDH>' || v_No || '</YJDH>';
  v_Temp  := v_Temp || '<CZSJ>' || To_Char(d_登记时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
  v_Temp  := v_Temp || '<KPBZ>' || Nvl(n_开票标志, 0) || '</KPBZ>';
  v_Temp  := v_Temp || '<URL>' || htf.escape_sc(Nvl(v_Url, '')) || '</URL>';
  v_Temp  := v_Temp || '<NETURL>' || htf.escape_sc(Nvl(v_Url外网, '')) || '</NETURL>';
  v_Temp  := v_Temp || '<FPTT>' || v_姓名 || '</FPTT>';
  v_Temp  := v_Temp || '<FPH>' || v_发票编号 || '</FPH>';
  v_Temp  := v_Temp || '<FPJE>' || Nvl(n_发票金额, 0) || '</FPJE>';
  v_Temp  := v_Temp || '<KPRQ>' || v_开票日期 || '</KPRQ>';
  Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Err_Special Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20105, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Deposit_Recharge;
/

Create Or Replace Procedure Zl_Third_Getalarmline
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is

  -------------------------------------------------------------------------------------------------- 
  --功能:预交款充值 
  --入参:Xml_In: 
  --    <IN> 
  --        <BRID>病人ID</BRID> 
  --        <XM>姓名</XM> 
  --        <SFZH>身份证号</SFZH> 
  --        <ZYID>主页ID</ZYID> //主页ID不传入或为零表示取门诊 
  --    </IN> 
  --出参:Xml_Out 
  --  <OUTPUT> 
  --     <YJDH>预交单号(多个逗号分隔)</YJDH> 
  --    DD如无下列错误结点则说明正确执行 
  --    <ERROR> 
  --      <MSG>错误信息</MSG> 
  --    </ERROR> 
  --  </OUTPUT> 
  -------------------------------------------------------------------------------------------------- 
  n_类型     Number(2);
  v_方案     Varchar2(100);
  n_病人id   病人信息.病人id%Type;
  v_姓名     病人信息.姓名%Type;
  v_身份证号 病人信息.身份证号%Type;
  n_病区id   病人信息.当前病区id%Type;
  n_主页id   病案主页.主页id%Type;

  n_报警值    记帐报警线.报警值%Type;
  n_报警方法  记帐报警线.报警方法%Type;
  v_报警标志1 记帐报警线.报警标志1%Type;
  v_报警标志2 记帐报警线.报警标志2%Type;
  v_报警标志3 记帐报警线.报警标志3%Type;

  n_预交余额   病人余额.预交余额%Type;
  n_费用余额   病人余额.预交余额%Type;
  n_担保额     病人担保记录.担保额%Type;
  n_Temp       病人余额.预交余额%Type;
  n_险类       病案主页.险类%Type;
  n_医保结算额 保险模拟结算.金额%Type;
  v_Temp       Varchar2(32767); --临时XML 
  x_Templet    Xmltype; --模板XML 

  v_Err_Msg Varchar2(200);
  Err_Item Exception;

Begin

  v_Err_Msg := Null;

  Select Extractvalue(Value(A), 'IN/BRID'), To_Number(Extractvalue(Value(A), 'IN/ZYID')),
         Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM')
  Into n_病人id, n_主页id, v_身份证号, v_姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_主页id, 0) = 0 And Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;

  --0.相关检查 
  If Nvl(n_主页id, 0) = 0 Then
    n_类型 := 1;
  Else
    n_类型 := 2;
  End If;

  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '不能有效识别病人身份!';
    Raise Err_Item;
  
  End If;
  n_病区id := 0;
  If Nvl(n_主页id, 0) <> 0 Then
    Begin
      Select Nvl(Nvl(b.当前病区id, a.当前病区id), 0), b.险类
      Into n_病区id, n_险类
      From 病人信息 A, 病案主页 B
      Where a.病人id = b.病人id And a.病人id = n_病人id And b.主页id = n_主页id And Rownum < 2;
    Exception
      When Others Then
        n_病区id  := Null;
        v_Err_Msg := '未找到病案主页,请检查主页ID是否传入正确!';
    End;
    If v_Err_Msg Is Not Null Then
      Raise Err_Item;
    End If;
    If Nvl(n_险类, 0) <> 0 Then
      --医保包含医保模拟计算 
      Select Nvl(Sum(金额), 0) Into n_医保结算额 From 保险模拟结算 Where 病人id = n_病人id And 主页id = n_主页id;
    End If;
    n_担保额 := Zl_Patientsurety(n_病人id, n_主页id);
  Else
    n_担保额 := Zl_Patientsurety(n_病人id, Null);
  End If;

  v_方案 := Zl_Patiwarnscheme(n_病人id, n_主页id);
  Begin
    Select 报警值, Nvl(报警方法, 1), 报警标志1, 报警标志2, 报警标志3
    Into n_报警值, n_报警方法, v_报警标志1, v_报警标志2, v_报警标志3
    From 记帐报警线
    Where 适用病人 = v_方案 And Nvl(病区id, 0) = Decode(n_类型, 1, 0, n_病区id) And Rownum < 2;
  Exception
    When Others Then
      n_报警值 := 0;
  End;
  Begin
    Select 预交余额, 费用余额
    Into n_预交余额, n_费用余额
    From 病人余额
    Where 病人id = n_病人id And 性质 = 1 And 类型 = n_类型;
  Exception
    When Others Then
      n_预交余额 := 0;
      n_费用余额 := 0;
  End;
  n_Temp := Nvl(n_预交余额, 0) - Nvl(n_费用余额, 0) + Nvl(n_医保结算额, 0);

  v_Temp := '<YJYE>' || Nvl(n_预交余额, 0) || '</YJYE>';
  v_Temp := v_Temp || '<WJFY>' || Nvl(n_费用余额, 0) || '</WJFY>';
  v_Temp := v_Temp || '<BXMLJE>' || Nvl(n_医保结算额, 0) || '</BXMLJE>';
  v_Temp := v_Temp || '<SYK>' || Nvl(n_Temp, 0) || '</SYK>';
  v_Temp := v_Temp || '<DBE>' || Nvl(n_担保额, 0) || '</DBE>';
  v_Temp := v_Temp || '<BJJE>' || Nvl(n_报警值, 0) || '</BJJE>';

  v_Temp := '<OUTPUT>' || v_Temp || '</OUTPUT>';

  x_Templet := Xmltype(v_Temp);
  Xml_Out   := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getalarmline;
/
Create Or Replace Procedure Zl_Third_Salereginfo
(
  Xml_In  In Xmltype,
  Xml_Out In Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:调用用户自定义函数获取指定的费别
  --入参:Xml_In:
  --  <IN>
  --       <XMID>123</XMID>   //要计算的收费项目的ID
  --       <BRID>421</BRID>   //病人ID
  --       <APID></APID>     //安排ID
  --       <JHID></JHID>     //计划ID
  --       <CZJLID><CZJLID>  //出诊记录ID
  --       <HM></HM>         //号码
  --       <XM>姓名</XM>        //姓名
  --       <SFZH>身份证号</SFZH>   //身份证号
  --       <FKFS>付款方式</FKFS>   //付款方式
  --       <ZD>1</ZD>         //站点
  --       <RQ></RQ>          //日期
  --  </IN>
  --出参:Xml_Out
  -- <OUTPUT>
  --  <YHJE>优惠金额</YHJE>
  --  <JE>计算后的金额</JE>
  --  <FB>计算后的费别</FB>
  -- </OUTPUT>
  --    如无下列错误结点则说明正确执行
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  -- </OUTPUT>

  --------------------------------------------------------------------------------------------------
  x_Templet    Xmltype; --模板XML
  v_Err_Msg    Varchar2(200);
  v_Temp       Varchar2(500);
  n_项目id     挂号安排.项目id%Type;
  n_病人id     病人信息.病人id%Type;
  v_姓名       病人信息.姓名%Type;
  v_身份证号   病人信息.身份证号%Type;
  v_费别       病人信息.费别%Type;
  v_付款方式   医疗付款方式.名称%Type;
  v_方式       Varchar2(20);
  n_实收金额   门诊费用记录.实收金额%Type := 0;
  n_应收金额   门诊费用记录.应收金额%Type := 0;
  n_优惠金额   门诊费用记录.实收金额%Type := 0;
  v_站点       部门表.站点%Type;
  d_日期       Date;
  v_药品等级   Varchar2(100);
  v_性别       病人信息.性别%Type;
  v_年龄       病人信息.年龄%Type;
  d_出生日期   病人信息.出生日期%Type;
  n_更新项目id 挂号安排.项目id%Type;
  n_安排id     挂号安排.Id%Type;
  n_计划id     挂号安排计划.Id%Type;
  n_出诊记录id 临床出诊记录.Id%Type;
  v_号码       挂号安排.号码%Type;
  v_传入       Varchar2(100);
  v_卫材等级   Varchar2(100);
  v_普通等级   Varchar2(100);
  v_Pricegrade Varchar2(500);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/XMID'), Extractvalue(Value(A), 'IN/ZD'),
         Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM'),
         To_Date(Extractvalue(Value(A), 'IN/RQ'), 'yyyy-mm-dd hh24:mi:ss'), Extractvalue(Value(A), 'IN/FKFS'),
         Extractvalue(Value(A), 'IN/APID'), Extractvalue(Value(A), 'IN/JHID'), Extractvalue(Value(A), 'IN/CZJLID'),
         Extractvalue(Value(A), 'IN/HM')
  Into n_病人id, n_项目id, v_站点, v_身份证号, v_姓名, d_日期, v_方式, n_安排id, n_计划id, n_出诊记录id, v_号码
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If d_日期 Is Null Then
    d_日期 := Sysdate;
  End If;

  If v_方式 Is Null Then
    Select Max(名称) Into v_付款方式 From 医疗付款方式 Where 缺省标志 = 1;
  Else
    Select Max(名称) Into v_付款方式 From 医疗付款方式 Where 编码 = v_方式;
    If v_付款方式 Is Null Then
      v_付款方式 := v_方式;
    End If;
  End If;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And v_姓名 Is Not Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '无法确定病人信息,请检查!';
    Raise Err_Item;
  End If;

  Select 性别, 年龄, 出生日期
  Into v_性别, v_年龄, d_出生日期
  From 病人信息
  Where 病人id = n_病人id;

  If Nvl(n_出诊记录id, 0) <> 0 Then
    v_传入 := '2|' || n_出诊记录id;
  Else
    If Nvl(n_计划id, 0) <> 0 Then
      v_传入 := '1|' || n_计划id;
    Else
      If Nvl(n_安排id, 0) <> 0 Then
        v_传入 := '0|' || n_安排id;
      End If;
    End If;
  End If;
  If v_传入 Is Null Then
    v_传入 := '3|' || v_号码;
  End If;

  n_更新项目id := Zl_Custom_Getregeventitem(n_病人id, v_姓名, v_身份证号, d_出生日期, v_性别, v_年龄, v_传入);
  If Nvl(n_更新项目id, 0) <> 0 Then
    n_项目id := n_更新项目id;
  End If;

  v_费别       := Zl_Custom_Getpatifeetype(1, n_病人id);
  v_Pricegrade := Zl_Get_Pricegrade(v_站点, n_病人id, Null, v_付款方式);
  v_普通等级   := Substr(v_Pricegrade, 1, Instr(v_Pricegrade, '|') - 1);
  v_Pricegrade := Substr(v_Pricegrade, Instr(v_Pricegrade, '|') + 1);
  v_药品等级   := Substr(v_Pricegrade, 1, Instr(v_Pricegrade, '|') - 1);
  v_卫材等级   := Substr(v_Pricegrade, Instr(v_Pricegrade, '|') + 1);

  For r_Fb In (Select 1 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次, c.Id As 收入项目id,
                      c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, Null As 从属父号
               From 收费项目目录 A, 收费价目 B, 收入项目 C
               Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = n_项目id And d_日期 Between b.执行日期 And
                     Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                     ((Instr(';5;6;7;', ';' || a.类别 || ';') > 0 And b.价格等级 = v_药品等级) Or
                     (Instr(';4;', ';' || a.类别 || ';') > 0 And b.价格等级 = v_卫材等级) Or
                     (Instr(';4;5;6;7;', ';' || a.类别 || ';') = 0 And b.价格等级 = v_普通等级) Or
                     (b.价格等级 Is Null And Not Exists
                      (Select 1
                        From 收费价目
                        Where b.收费细目id = 收费细目id And d_日期 Between 执行日期 And Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')) And
                              ((Instr(';5;6;7;', ';' || a.类别 || ';') > 0 And 价格等级 = v_药品等级) Or
                              (Instr(';4;', ';' || a.类别 || ';') > 0 And 价格等级 = v_卫材等级) Or
                              (Instr(';4;5;6;7;', ';' || a.类别 || ';') = 0 And 价格等级 = v_普通等级)))))
               Union All
               Select 2 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, d.从项数次 As 数次,
                      c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, 1 As 从属父号
               From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费从属项目 D
               Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.从项id And d.主项id = n_项目id And d_日期 Between b.执行日期 And
                     Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                     ((Instr(';5;6;7;', ';' || a.类别 || ';') > 0 And b.价格等级 = v_药品等级) Or
                     (Instr(';4;', ';' || a.类别 || ';') > 0 And b.价格等级 = v_卫材等级) Or
                     (Instr(';4;5;6;7;', ';' || a.类别 || ';') = 0 And b.价格等级 = v_普通等级) Or
                     (b.价格等级 Is Null And Not Exists
                      (Select 1
                        From 收费价目
                        Where b.收费细目id = 收费细目id And d_日期 Between 执行日期 And Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')) And
                              ((Instr(';5;6;7;', ';' || a.类别 || ';') > 0 And 价格等级 = v_药品等级) Or
                              (Instr(';4;', ';' || a.类别 || ';') > 0 And 价格等级 = v_卫材等级) Or
                              (Instr(';4;5;6;7;', ';' || a.类别 || ';') = 0 And 价格等级 = v_普通等级)))))
               Order By 性质, 项目编码, 收入编码) Loop
    v_Temp     := Zl_Actualmoney(v_费别, r_Fb.项目id, r_Fb.收入项目id, r_Fb.单价);
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ':') + 1);
    n_实收金额 := n_实收金额 + Zl_To_Number(v_Temp);
    n_应收金额 := n_应收金额 + r_Fb.单价;
  End Loop;
  n_优惠金额 := n_应收金额 - n_实收金额;
  v_Temp     := '<YHJE>' || n_优惠金额 || '</YHJE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<JE>' || n_实收金额 || '</JE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<FB>' || v_费别 || '</FB>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Salereginfo;
/
Create Or Replace Procedure Zl_Third_Custom_Findcards
(
  Xml_In  In Xmltype,
  Xml_Out In Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取医疗卡类别(用户自定义）
  --入参:Xml_In:
  --  <IN>
  --       <SFZ>身份证号</SFZ >不传入时,表示查询全部启用的医疗卡类别ID
  --  </IN>
  --出参:Xml_Out
  -- <OUTPUT>
  --    <LIST>
  --        <JZK>
  --            <LB>卡类别</LB>
  --            <KH>卡号</KH>
  --        </JZK>
  --        <JZK>
  --            ...
  --        </JZK>
  --    </LIST>
  --    如无下列错误结点则说明正确执行
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  -- </OUTPUT>

  --------------------------------------------------------------------------------------------------
  v_Temp    varchar2(32767);
  v_Err_Msg varchar2(200);
  Err_Item Exception;
Begin
  Null;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Custom_Findcards;
/
Create Or Replace Procedure Zl_Third_Registdelcheck
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:HIS退号检查
  --入参:Xml_In:
  --<IN>
  --  <GHDH>A000001</GHDH>    //挂号单号
  --  <JSKLB>支付宝</JSKLB>      //结算卡类别
  --  <JCFP>1</JCFP>            //检查发票
  --  <GHJE>20</GHJE>            //挂号金额
  --  <LSH>34563</LSH>           //交易流水号
  --  <JKFS>0</JKFS>             //缴款方式,0-挂号或预约缴款;1-预约不缴款
  --  <YYFS></YYFS>              //缴款方式=1时传入，预约的预约方式
  --  <XL></XL>                  //险类
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  -- <ERROR><MSG></MSG></ERROR> //为空表示检查成功
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_卡类别     Varchar2(100);
  v_No         病人挂号记录.No%Type;
  n_挂号金额   门诊费用记录.实收金额%Type;
  v_结算方式   医疗卡类别.结算方式%Type;
  n_实收金额   门诊费用记录.实收金额%Type;
  v_交易流水号 病人预交记录.交易流水号%Type;
  n_存在       Number(3);
  v_Type       Varchar2(50);
  v_Temp       Varchar2(32767); --临时XML
  x_Templet    Xmltype; --模板XML

  n_已开医嘱 Number(2);
  n_检查发票 Number(3);
  n_是否打印 Number(3);
  n_缴款方式 Number(3);
  n_险类     病人信息.险类%Type;
  v_预约方式 病人挂号记录.预约方式%Type;
  v_收费单   门诊费用记录.No%Type;
  n_结帐id   门诊费用记录.结帐id%Type;
  v_Err_Msg  Varchar2(200);
  Err_Item Exception;
  n_Count Number;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/GHDH'), Extractvalue(Value(A), 'IN/JSKLB'), Extractvalue(Value(A), 'IN/GHJE'),
         Extractvalue(Value(A), 'IN/LSH'), To_Number(Extractvalue(Value(A), 'IN/JCFP')),
         To_Number(Extractvalue(Value(A), 'IN/JKFS')), Extractvalue(Value(A), 'IN/YYFS'),
         To_Number(Extractvalue(Value(A), 'IN/XL'))
  Into v_No, v_卡类别, n_挂号金额, v_交易流水号, n_检查发票, n_缴款方式, v_预约方式, n_险类
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Max(收费单) Into v_收费单 From 病人挂号记录 Where NO = v_No;

  n_缴款方式 := Nvl(n_缴款方式, 0);
  If v_卡类别 Is Not Null And n_缴款方式 = 0 Then
    Select Nvl2(Translate(v_卡类别, '\1234567890', '\'), 'Char', 'Num') Into v_Type From Dual;
    If v_Type = 'Num' Then
      --传入的是卡类别ID
      Select 结算方式 Into v_结算方式 From 医疗卡类别 Where ID = To_Number(v_卡类别);
    Else
      --传入的是卡类别名称
      Select 结算方式 Into v_结算方式 From 医疗卡类别 Where 名称 = v_卡类别;
    End If;
    If Nvl(n_缴款方式, 0) = 0 Then
      If Nvl(n_险类, 0) = 0 Then
        Select Nvl(Max(1), 0)
        Into n_存在
        From 病人预交记录 A,
             (Select Distinct 结帐id
               From 门诊费用记录
               Where NO = v_No And 记录性质 = 4
               Union
               Select Distinct 结帐id
               From 住院费用记录
               Where NO = v_No And 记录性质 = 5
               Union
               Select Distinct 结帐id
               From 门诊费用记录
               Where NO = v_收费单 And 记录性质 = 1) B
        Where a.结帐id = b.结帐id And 结算方式 <> v_结算方式 And Mod(记录性质, 10) <> 1 And Rownum < 2;
      Else
        Select Nvl(Max(1), 0)
        Into n_存在
        From 病人预交记录 A,
             (Select Distinct 结帐id
               From 门诊费用记录
               Where NO = v_No And 记录性质 = 4
               Union
               Select Distinct 结帐id
               From 住院费用记录
               Where NO = v_No And 记录性质 = 5
               Union
               Select Distinct 结帐id
               From 门诊费用记录
               Where NO = v_收费单 And 记录性质 = 1) B, 结算方式 C
        Where a.结帐id = b.结帐id And 结算方式 <> v_结算方式 And Mod(记录性质, 10) <> 1 And a.结算方式 = c.名称 And c.性质 Not In (3, 4) And
              Rownum < 2;
        If n_存在 = 0 Then
          Select Nvl(Max(1), 0)
          Into n_存在
          From 保险结算记录 A,
               (Select Distinct 结帐id
                 From 门诊费用记录
                 Where NO = v_No And 记录性质 = 4
                 Union
                 Select Distinct 结帐id
                 From 住院费用记录
                 Where NO = v_No And 记录性质 = 5
                 Union
                 Select Distinct 结帐id
                 From 门诊费用记录
                 Where NO = v_收费单 And 记录性质 = 1) B
          Where a.记录id = b.结帐id And 险类 <> n_险类 And Rownum < 2;
        End If;
      End If;
      If n_存在 = 1 Then
        v_Err_Msg := '传入的挂号单据包含' || v_结算方式 || '以外的结算方式,无法退号!';
        Raise Err_Item;
      End If;
    Else
      Begin
        Select 1 Into n_存在 From 病人挂号记录 A Where a.No = v_No And a.预约方式 = v_预约方式 And Rownum < 2;
      Exception
        When Others Then
          n_存在 := 0;
      End;
      If n_存在 = 0 Then
        v_Err_Msg := '传入的挂号单据不是' || v_预约方式 || '预约的,无法退号!';
        Raise Err_Item;
      End If;
    End If;
  End If;

  If n_缴款方式 = 0 Then
    Select Sum(实收金额), Max(Decode(记录状态, 2, 0, 结帐id))
    Into n_实收金额, n_结帐id
    From 门诊费用记录
    Where NO = v_No And 记录性质 = 4;
    If Not v_收费单 Is Null Then
      Select Sum(实收金额) Into n_实收金额 From 门诊费用记录 Where NO = v_收费单 And 记录性质 = 1;
    End If;
    If n_实收金额 <> n_挂号金额 Then
      v_Err_Msg := '传入的退款金额与实际挂号金额不符，请检查!';
      Raise Err_Item;
    End If;
    --电子票据检查
    If b_Einvoice_Request.Einvoice_Cancel_Check(4, n_结帐id, v_Err_Msg) = 0 Then
      --失败后，直接抛错
      Raise Err_Item;
    End If;
  End If;

  --补充结算检查，已存在补结算数据的，不能退号
  Begin
    Select 1
    Into n_存在
    From 费用补充记录 A,
         (Select Distinct 结帐id
           From 门诊费用记录
           Where NO = v_No And 记录性质 = 4
           Union
           Select Distinct 结帐id
           From 住院费用记录
           Where NO = v_No And 记录性质 = 5
           Union
           Select Distinct 结帐id
           From 门诊费用记录
           Where NO = v_收费单 And 记录性质 = 1) B
    Where a.收费结帐id = b.结帐id And a.记录性质 = 1 And a.附加标志 = 1 And Nvl(a.费用状态, 0) <> 2 And Rownum < 2;
  Exception
    When Others Then
      n_存在 := 0;
  End;
  If n_存在 = 1 Then
    v_Err_Msg := '传入的挂号单据已经进行了二次结算,无法退号!';
    Raise Err_Item;
  End If;
  --医嘱检查，已经开过医嘱的，不能退号
  Begin
    Select Distinct 1 Into n_已开医嘱 From 病人医嘱记录 Where 挂号单 = v_No;
  Exception
    When Others Then
      n_已开医嘱 := 0;
  End;
  If n_已开医嘱 = 1 Then
    v_Err_Msg := '传入的挂号单据已经开过医嘱,无法退号!';
    Raise Err_Item;
  End If;
  If Nvl(n_检查发票, 0) = 1 Then
    Select Max(Decode(a.实际票号, Null, 0, 1)) Into n_是否打印 From 门诊费用记录 A Where NO = v_No And 记录性质 = 4;
    If Nvl(n_是否打印, 0) = 1 Then
      v_Err_Msg := '本次退号的单据已开发票,不能退费!';
      Raise Err_Item;
    End If;
    Select Max(Decode(a.实际票号, Null, 0, 1))
    Into n_是否打印
    From 门诊费用记录 A
    Where NO = v_收费单 And 记录性质 = 1;
    If Nvl(n_是否打印, 0) = 1 Then
      v_Err_Msg := '本次退号的单据已开发票,不能退费!';
      Raise Err_Item;
    End If;
  End If;

  Select Count(1) Into n_Count From 病人挂号记录 Where NO = v_No And 记录标志 = -1;
  If n_Count <> 0 Then
    v_Err_Msg := '本次退号的单据处于交易异常状态,不能再退费!';
    Raise Err_Item;
  End If;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Registdelcheck;
/
Create Or Replace Procedure Zl_Third_Getmoney
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:计算项目的实收金额
  --入参:Xml_In: 
  --  <IN> 
  --    <FB>费别</FB>                      //费别名称,可以不传
  --    <XMID>收费项目ID</XMID>        //收费项目的ID
  --    <CXFY>1</CXFY>                     //是否计算从项费用,-0不计算,1-计算，默认计算
  --    <ZD></ZD>                          //站点
  --  </IN> 
  --出参:Xml_Out 
  --  <OUTPUT> 
  --    <JE>5</JE>                   //返回根据费别计算好的金额
  --                                     //如无下列错误结点则说明正确执行 
  --    <ERROR> 
  --      <MSG>错误信息</MSG> 
  --    </ERROR> 
  --  </OUTPUT> 
  -------------------------------------------------------------------------------------------------- 

  v_费别       费别.名称%Type;
  n_收费项目id 收费项目目录.Id%Type;
  n_收入项目id 收费价目.收入项目id%Type;
  n_标准单价   收费价目.现价%Type;
  v_收费类别   收费项目目录.类别%Type;
  v_收据费目   收入项目.收据费目%Type;
  n_屏蔽费别   收费项目目录.屏蔽费别%Type;
  n_实收金额   门诊费用记录.实收金额%Type;
  v_金额       Varchar2(200);
  v_站点       部门表.站点%Type;
  n_从项费用   Number(3);
  n_不计算     Number(3);
  v_Temp       Varchar2(32767); --临时XML 
  x_Templet    Xmltype; --模板XML 
  v_Err_Msg    Varchar2(200);
  v_药品等级   Varchar2(100);
  v_卫材等级   Varchar2(100);
  v_普通等级   Varchar2(100);
  v_Pricegrade Varchar2(500);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/FB'), Extractvalue(Value(A), 'IN/XMID'), Extractvalue(Value(A), 'IN/CXFY'),
         Extractvalue(Value(A), 'IN/ZD')
  Into v_费别, n_收费项目id, n_从项费用, v_站点
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  v_Pricegrade := Zl_Get_Pricegrade(v_站点);
  v_普通等级   := Substr(v_Pricegrade, 1, Instr(v_Pricegrade, '|') - 1);
  v_Pricegrade := Substr(v_Pricegrade, Instr(v_Pricegrade, '|') + 1);
  v_药品等级   := Substr(v_Pricegrade, 1, Instr(v_Pricegrade, '|') - 1);
  v_卫材等级   := Substr(v_Pricegrade, Instr(v_Pricegrade, '|') + 1);

  n_不计算 := 0;
  If v_费别 Is Null Then
    n_不计算 := 1;
    Select 名称 Into v_费别 From 费别 Where 缺省标志 = 1 And Rownum < 2;
  End If;

  Select a.类别, b.现价, b.收入项目id, c.收据费目, a.屏蔽费别
  Into v_收费类别, n_标准单价, n_收入项目id, v_收据费目, n_屏蔽费别
  From 收费项目目录 A, 收费价目 B, 收入项目 C
  Where a.Id = n_收费项目id And b.收费细目id = a.Id And b.收入项目id = c.Id And Sysdate Between b.执行日期 And
        Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
        ((Instr(';5;6;7;', ';' || a.类别 || ';') > 0 And b.价格等级 = v_药品等级) Or
        (Instr(';4;', ';' || a.类别 || ';') > 0 And b.价格等级 = v_卫材等级) Or
        (Instr(';4;5;6;7;', ';' || a.类别 || ';') = 0 And b.价格等级 = v_普通等级) Or
        (b.价格等级 Is Null And Not Exists
         (Select 1
           From 收费价目
           Where b.收费细目id = 收费细目id And Sysdate Between 执行日期 And Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')) And
                 ((Instr(';5;6;7;', ';' || a.类别 || ';') > 0 And 价格等级 = v_药品等级) Or
                 (Instr(';4;', ';' || a.类别 || ';') > 0 And 价格等级 = v_卫材等级) Or
                 (Instr(';4;5;6;7;', ';' || a.类别 || ';') = 0 And 价格等级 = v_普通等级))))) And Rownum < 2;

  If Nvl(n_屏蔽费别, 0) = 0 And n_不计算 = 0 Then
    v_金额     := Zl_Actualmoney(v_费别, n_收费项目id, n_收入项目id, n_标准单价);
    v_金额     := Substr(v_金额, Instr(v_金额, ':') + 1);
    n_实收金额 := zl_To_Number(v_金额);
  Else
    n_实收金额 := n_标准单价;
  End If;

  If Nvl(n_从项费用, 1) = 1 Then
    For r_Subfee In (Select b.现价, a.从项数次, b.收入项目id, c.屏蔽费别, a.从项id As 收费细目id
                     From 收费从属项目 A, 收费价目 B, 收费项目目录 C
                     Where a.主项id = n_收费项目id And c.Id = a.从项id And a.从项id = b.Id And
                           ((Instr(';5;6;7;', ';' || c.类别 || ';') > 0 And b.价格等级 = v_药品等级) Or
                           (Instr(';4;', ';' || c.类别 || ';') > 0 And b.价格等级 = v_卫材等级) Or
                           (Instr(';4;5;6;7;', ';' || c.类别 || ';') = 0 And b.价格等级 = v_普通等级) Or
                           (b.价格等级 Is Null And Not Exists
                            (Select 1
                              From 收费价目
                              Where b.收费细目id = 收费细目id And Sysdate Between 执行日期 And
                                    Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')) And
                                    ((Instr(';5;6;7;', ';' || c.类别 || ';') > 0 And 价格等级 = v_药品等级) Or
                                    (Instr(';4;', ';' || c.类别 || ';') > 0 And 价格等级 = v_卫材等级) Or
                                    (Instr(';4;5;6;7;', ';' || c.类别 || ';') = 0 And 价格等级 = v_普通等级))))) And
                           Sysdate Between b.执行日期 And Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))) Loop
      If Nvl(r_Subfee.屏蔽费别, 0) = 0 And n_不计算 = 0 Then
        v_金额     := Zl_Actualmoney(v_费别, r_Subfee.收费细目id, r_Subfee.收入项目id, r_Subfee.现价);
        v_金额     := Substr(v_金额, Instr(v_金额, ':') + 1);
        n_实收金额 := n_实收金额 + zl_To_Number(v_金额) * r_Subfee.从项数次;
      Else
        n_实收金额 := n_实收金额 + r_Subfee.现价 * r_Subfee.从项数次;
      End If;
    End Loop;
  End If;

  v_Temp := '<JE>' || n_实收金额 || '</JE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getmoney;
/
Create Or Replace Procedure Zl_Third_Getvisitinfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:根据挂号单号获取该次就诊详情(医嘱为主要显示)
  --入参:Xml_In:
  --<IN>
  --    <GHDH>挂号单号</GHDH>
  --    <JSKLB>结算卡类别</JSKLB>
  --    <MXGL>明细过滤</MXGL> 0-不过滤,明细包含治疗 1-过滤,明细不包含治疗,默认为1
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <GH>
  --     <GHDH>挂号单号</GHDH> //本次查询的挂号单号
  --     <YYSJ>预约时间</YYSJ> //yyyy-mm-dd hh24:mi:ss
  --     <JZSJ></JZSJ>      //实际就诊时间
  --     <DJH></DJH>        //单据号
  --     <JE></JE>          //金额
  --     <DJLX></DJLX>      //单据类型,1-收费单，4-挂号单
  --     <KDSJ></KDSJ>      //开单时间
  --     <JKFS></JKFS>      //缴款方式,0-挂号或预约缴款;1-预约不缴款
  --     <ZFZT></ZFZT>  //支付状态,0-待支付，1-已支付，2-已退费，3-正在支付,4-正在退费
  --     <SFJSK></SFJSK>    //是否结算卡支付，0-否，1-是
  --      <DL> //队列
  --             <XH>序号</XH>
  --              <QMRS>前面人数</QMRS>  //(由Oracle函数zl_GetSequenceBeforPerons获取)
  --      </DL>
  --  </GH>
  --  <YZLIST>
  --     <YZ>                   //医嘱返回与HIS中显示的内容相同
  --        <YZID><YZID>        //医嘱ID，返回组医嘱ID
  --        <YZLX><YZLX>        //医嘱类型,如处方、检查、检验
  --         <YZMC></YZMC>        //医嘱名称
  --        <ZXKS></ZXKS>       //执行科室
  --        <ZXKSID></ZXKSID>   //执行科室ID
  --        <FYCK></FYCK>       //发药窗口
  --        <YZMX>
  --           <MX>
  --              <YZNR></YZNR>        //医嘱内容
  --              <ZXZT></ZXZT>        //医嘱执行状态
  --              <SFFY>是否发药</SFFY> // 0-否 ，1-是
  --              <GG>规格</GG>
  --              <SL>数量</SL>
  --              <DW>计算单位</DW>
  --              <BZDJ>标准单价</BZDJ>
  --              <YSJE>应收金额</YSJE>
  --              <SSJE>实收金额</SSJE>
  --           </MX>
  --           <MX/>
  --        </YZMX>
  --        <BG></BG>                   //是否已出报告，是否签名
  --        <BGLY></BGLY>               //是否外检项目,1-院内项目，2-外检项目
  --        <BGLYSM></BGLYSM>           //外检项目说明
  --        <JZBG></JZBG>                //禁止显示报告。0-允许，1-禁止
  --        <JZTS></JZTS>                 //提示文字。对于禁止查看的报告，可返回用于提示病人的信息
  --        <BLID></BLID>              //病历ID，如果<BG>字段为1，该值不为空
  --        <DJLIST>
  --           <DJ>                //费用单据信息
  --              <DJH></DJH>      //费用单据号
  --              <DJLX></DJLX>    //单据类型
  --              <JE></JE>        //单据总金额
  --              <KDSJ></KDSJ>    //开单时间
  --              <ZFZT></ZFZT>    //支付状态,0-待支付，1-已支付，2-已退费,3-退费申请中,4-审核通过,5-审核未通过，6-正在支付,7-正在退费
  --              <SHSM></SHSM>    //审核说明,审核未通过原因
  --              <SFJSK></SFJSK>  //是否结算卡支付，0-否，1-是
  --           </DJ>
  --           <DJ/>
  --        </DJLIST>
  --     </YZ>
  --  </YZLIST>
  --    <ERROR><MSG></MSG></ERROR>                      //如果错误返回
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(200);
  Err_Item Exception;
  x_Templet Xmltype; --模板XML

  v_卡类别   Varchar2(100);
  n_卡类别id Number(18);
  v_挂号单   Varchar2(10);
  v_排队号码 Varchar2(10);
  n_Temp     Number(18);
  v_队列名称 排队叫号队列.队列名称%Type;

  n_Count Number(18);

  v_Temp       Varchar2(32767); --临时XML
  v_队列       Varchar2(32767);
  v_No         Varchar2(50);
  n_Add_Djlist Number(1); --是否增加了DJLIST的
  n_性质       Number(2);
  n_组医嘱id   Number(18);
  n_独立医嘱   Number(8);
  n_执行科室id Number(18);
  v_执行科室   Varchar2(50);
  n_退款金额   病人预交记录.冲预交%Type;
  n_明细过滤   Number(3);
  v_原因       病人退费申请.申请原因%Type;
  v_发药窗口   门诊费用记录.发药窗口%Type;
  n_支付标志   Number;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/GHDH'), Extractvalue(Value(A), 'IN/JSKLB'),
         Nvl(Extractvalue(Value(A), 'IN/MXGL'), 1)
  Into v_挂号单, v_卡类别, n_明细过滤
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_挂号单 Is Null Then
    v_Err_Msg := '不能找到指定的挂号单号(当前挂号单号为空)';
    Raise Err_Item;
  End If;

  v_Err_Msg := Null;
  If v_卡类别 Is Not Null Then
    Begin
      n_卡类别id := To_Number(v_卡类别);
    Exception
      When Others Then
        n_卡类别id := 0;
    End;
  
    If n_卡类别id = 0 Then
      Begin
        Select ID, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!')
        Into n_卡类别id, v_Err_Msg
        From 医疗卡类别
        Where 名称 = v_卡类别;
      Exception
        When Others Then
          v_Err_Msg := '卡类别:' || v_卡类别 || '不存在!';
      End;
    Else
      Begin
        Select ID, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!')
        Into n_卡类别id, v_Err_Msg
        From 医疗卡类别
        Where ID = n_卡类别id;
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息!';
      End;
    End If;
    If Not v_Err_Msg Is Null Then
      Raise Err_Item;
    End If;
  End If;

  --1.获取挂号数据
  n_性质 := 4;
  Select Max(收费单) Into v_No From 病人挂号记录 Where NO = v_挂号单;
  If v_No Is Not Null Then
    Select Count(1) Into n_Count From 门诊费用记录 Where NO = v_No And 记录性质 = 1;
    If n_Count <> 0 Then
      n_性质 := 1;
    End If;
  End If;
  If n_性质 = 4 Then
    v_No := v_挂号单;
  End If;

  n_Count := 0;
  For c_挂号 In (Select a.Id, v_No As NO, n_性质 As 记录性质, a.执行部门id, c.名称 As 执行部门,
                      To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, To_Char(a.预约时间, 'yyyy-mm-dd hh24:mi:ss') As 预约时间,
                      a.接收时间, To_Char(a.发生时间, 'yyyy-mm-dd HH24:mi:ss') As 就诊时间, a.号别, a.号序, b.金额, a.记录状态,
                      Decode(Nvl(a.执行状态, 0), 0, '等待接诊', 1, '完成就诊', 2, '正在就诊', -1, '取消就诊') As 执行状态,
                      Decode(Nvl(a.记录性质, 0), 2, 1, 0) As 缴款方式, b.结帐id
               From 病人挂号记录 A,
                    (Select Max(Decode(记录状态, 2, 0, 结帐id)) As 结帐id, Sum(实收金额) As 金额
                      From 门诊费用记录
                      Where 记录性质 = n_性质 And NO = v_No) B, 部门表 C
               Where a.No = v_挂号单 And a.执行部门id = c.Id) Loop
  
    If Nvl(c_挂号.记录状态, 0) <> 1 Then
      v_Err_Msg := '单据号:' || v_挂号单 || '已经被退号!';
      Raise Err_Item;
    End If;
  
    Select Max(排队号码), Max(队列名称)
    Into v_排队号码, v_队列名称
    From 排队叫号队列
    Where 业务id = c_挂号.Id And Nvl(业务类型, 0) = 0;
    If v_排队号码 Is Not Null Then
      --业务id_In ,业务类型_In 排队号码_In Number := Null
      n_Temp := Zl_Getsequencebeforperons(c_挂号.Id, 0, v_排队号码, v_队列名称);
      v_队列 := v_队列 || '<DL><XH>' || v_排队号码 || '</XH><QMRS>' || n_Temp || '</QMRS></DL>';
    End If;
  
    n_Temp := 0;
    If Nvl(n_卡类别id, 0) <> 0 Then
      Select Count(1)
      Into n_Temp
      From 病人预交记录
      Where 结帐id = c_挂号.结帐id And 记录性质 = n_性质 And 记录状态 In (1, 3) And 卡类别id = n_卡类别id And Rownum < 2;
    End If;
  
    Select Nvl(Max(Decode(结帐id, 0, 0, Decode(记录状态, 2, Decode(费用状态, 1, 4, 2), Decode(费用状态, 1, 3, 1)))), 0)
    Into n_支付标志
    From (Select Decode(记录状态, 2, 2, 1) As 记录状态, Nvl(费用状态, 0) As 费用状态, Nvl(结帐id, 0) As 结帐id
           From 门诊费用记录
           Where 记录性质 = n_性质 And NO = v_No);
  
    v_Temp := '<GHDH>' || v_挂号单 || '</GHDH>';
    v_Temp := v_Temp || '<DJH>' || c_挂号.No || '</DJH>';
    v_Temp := v_Temp || '<YYSJ>' || c_挂号.预约时间 || '</YYSJ>';
    v_Temp := v_Temp || '<JZSJ>' || c_挂号.就诊时间 || '</JZSJ>';
    v_Temp := v_Temp || '<KDSJ>' || c_挂号.登记时间 || '</KDSJ>';
    v_Temp := v_Temp || '<JKFS>' || c_挂号.缴款方式 || '</JKFS>';
    v_Temp := v_Temp || '<JE>' || c_挂号.金额 || '</JE>';
    v_Temp := v_Temp || '<DJLX>' || n_性质 || '</DJLX>';
    v_Temp := v_Temp || '<ZFZT>' || n_支付标志 || '</ZFZT>';
    v_Temp := v_Temp || '<SFJSK>' || n_Temp || '</SFJSK>';
    v_Temp := v_Temp || v_队列;
    v_Temp := '<GH>' || v_Temp || '</GH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    n_Count := n_Count + 1;
  End Loop;
  If Nvl(n_Count, 0) = 0 Then
    v_Err_Msg := '未找到指定的挂号单据:' || v_挂号单 || '!';
    Raise Err_Item;
  End If;

  --2.组建医嘱及费用相关数据
  n_组医嘱id   := 0;
  n_Add_Djlist := 0;
  For c_医嘱 In (With 医嘱费用 As
                  (Select 医嘱id, 发送号, 记录性质, NO, Max(Nvl(执行状态, 0)) As 执行状态
                  From (Select b.医嘱id, b.发送号, b.记录性质, b.No, Nvl(b.执行状态, 0) As 执行状态
                         From 病人医嘱记录 A, 病人医嘱发送 B
                         Where a.挂号单 = v_挂号单 And a.Id = b.医嘱id
                         Union All
                         Select b.医嘱id, b.发送号, b.记录性质, b.No, Nvl(c.执行状态, 0) As 执行状态
                         From 病人医嘱记录 A, 病人医嘱发送 C, 病人医嘱附费 B
                         Where a.挂号单 = v_挂号单 And a.Id = b.医嘱id And b.医嘱id = c.医嘱id And b.发送号 = c.发送号)
                  Group By 医嘱id, 发送号, 记录性质, NO)
                 
                 Select Nvl(a.相关id, a.Id) As 组id, Decode(a.相关id, Null, 0, 1) As 附医嘱, a.Id, a.相关id, e.发药窗口,
                        Max(Decode(a.诊疗类别, 'E', Decode(q.操作类型, '2', '处方', '4', '处方', '6', '检验', m.名称), m.名称)) As 医嘱类型,
                        a.执行科室id, d.名称 As 执行科室, Decode(a.相关id, Null, a.医嘱内容, Null) As 组医嘱内容,
                        Max(Decode(a.诊疗类别, '5', 1, '6', 1, '7', 1, 0) * Decode(Nvl(e.执行状态, 0), 1, 1, 3, 1, 0)) As 发药状态,
                        Decode(a.相关id, Null, Null, q.名称) As 明细医嘱内容, s.规格, (e.数次 * e.付数) As 数量, e.计算单位 As 单位,
                        Decode(Nvl(b.执行状态, 0), 0, '未执行', 1, '完全执行', 2, '拒绝执行', 3, '正在执行', '正在执行') As 执行状态,
                        Max(Decode(p.审核时间, Null, Decode(C1.完成时间, Null, 0, 1), 1)) As 是否已出报告, c.病历id, e.No, e.记录性质 As 单据类型,
                        Max(e.标准单价) As 标准单价, Sum(e.应收金额) As 应收金额, Sum(e.实收金额) As 实收金额,
                        To_Char(e.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 开单时间, a.病人id
                 
                 From 病人医嘱记录 A, 医嘱费用 B, 病人医嘱报告 C, 电子病历记录 C1, 部门表 D, 门诊费用记录 E, 诊疗项目类别 M, 诊疗项目目录 Q, 收费项目目录 S, 检验标本记录 P
                 Where a.Id = b.医嘱id And a.执行科室id = d.Id And c.病历id = C1.Id(+) And a.Id = c.医嘱id(+) And a.Id = p.医嘱id(+) And
                       b.医嘱id = e.医嘱序号 And e.收费细目id = s.Id And b.No = e.No And b.记录性质 = e.记录性质 And e.记录状态 <> 2 And
                       a.挂号单 = v_挂号单 And a.诊疗类别 = m.编码 And a.诊疗项目id = q.Id And a.医嘱状态 In (3, 8)
                 Group By a.Id, a.婴儿, a.序号, a.相关id, e.发药窗口, a.诊疗类别, a.执行科室id, d.名称, a.医嘱内容, q.名称, s.规格, e.数次 * e.付数,
                          e.计算单位, Decode(Nvl(b.执行状态, 0), 0, '未执行', 1, '完全执行', 2, '拒绝执行', 3, '正在执行', '正在执行'), C1.完成时间,
                          Decode(c.病历id, Null, 0, 1), c.病历id, e.No, e.记录性质, e.登记时间, Decode(Nvl(e.记录状态, 0), 0, 0, 3, 2, 1),
                          p.审核时间, a.病人id
                 Order By 组id, 附医嘱, Nvl(a.婴儿, 0), a.序号) Loop
  
    If Nvl(n_Add_Djlist, 0) = 0 Then
      --增加DJList节点
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<YZLIST></YZLIST>')) Into x_Templet From Dual;
      n_Add_Djlist := 1;
    End If;
  
    If n_组医嘱id <> Nvl(c_医嘱.组id, 0) Then
      n_组医嘱id := Nvl(c_医嘱.组id, 0);
    
      Zl_Third_Custom_Getdeptinfo(n_组医嘱id, n_执行科室id, v_执行科室);
    
      If Nvl(n_执行科室id, 0) = 0 Then
        If c_医嘱.医嘱类型 = '检验' Then
          --检验医嘱以显示采集科室
          n_执行科室id := c_医嘱.执行科室id;
          v_执行科室   := c_医嘱.执行科室;
        Else
          Begin
            Select b.Id, b.名称, c.发药窗口
            Into n_执行科室id, v_执行科室, v_发药窗口
            From 病人医嘱记录 A, 部门表 B, 门诊费用记录 C
            Where a.Id = c.医嘱序号 And a.相关id = n_组医嘱id And a.执行科室id = b.Id And Rownum <= 1;
          Exception
            When Others Then
              n_执行科室id := c_医嘱.执行科室id;
              v_执行科室   := c_医嘱.执行科室;
              v_发药窗口   := c_医嘱.发药窗口;
          End;
        End If;
      End If;
    
      v_Temp := '<YZID>' || n_组医嘱id || '</YZID>';
      v_Temp := v_Temp || '<YZLX>' || c_医嘱.医嘱类型 || '</YZLX>';
      v_Temp := v_Temp || '<YZMC>' || c_医嘱.组医嘱内容 || '</YZMC>';
      v_Temp := v_Temp || '<ZXKS>' || v_执行科室 || '</ZXKS>';
      v_Temp := v_Temp || '<ZXKSID>' || n_执行科室id || '</ZXKSID>';
      v_Temp := v_Temp || '<FYCK>' || v_发药窗口 || '</FYCK>';
      v_Temp := v_Temp || '<BG>' || c_医嘱.是否已出报告 || '</BG>';
      v_Temp := v_Temp || Zl_Third_Custom_Getrptfrom(n_组医嘱id);
      v_Temp := v_Temp || Zl_Third_Custom_Rptlimit(c_医嘱.病人id, n_组医嘱id);
      If Nvl(c_医嘱.是否已出报告, 0) = 1 And c_医嘱.病历id Is Not Null Then
        v_Temp := v_Temp || '<BLID>' || c_医嘱.病历id || '</BLID>';
      End If;
      v_Temp := '<YZ 医嘱ID="' || n_组医嘱id || '">' || v_Temp || '<YZMX></YZMX><DJLIST></DJLIST></YZ>';
      Select Appendchildxml(x_Templet, '/OUTPUT/YZLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    
      For v_费用 In (Select /*+ Rule */
                    a.No, Mod(a.记录性质, 10) As 单据类型, To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 开单时间, Sum(a.实收金额) As 单据金额,
                    Max(a.结帐id) As 结算卡支付
                   From 门诊费用记录 A
                   Where (a.No, a.记录性质) In
                         (Select Distinct q.No, q.记录性质
                          From 病人医嘱记录 M, 病人医嘱发送 Q
                          Where m.Id = q.医嘱id And (m.Id = n_组医嘱id Or m.相关id = n_组医嘱id)
                          Union All
                          Select Distinct q.No, q.记录性质
                          From 病人医嘱记录 M, 病人医嘱附费 Q
                          Where m.Id = q.医嘱id And (m.Id = n_组医嘱id Or m.相关id = n_组医嘱id)) And Nvl(a.记录状态, 0) In (0, 1, 3)
                   Group By a.No, Mod(a.记录性质, 10), To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss')) Loop
      
        Select Count(1)
        Into n_Temp
        From 病人预交记录 A, 门诊费用记录 B
        Where a.结帐id = b.结帐id And b.No = v_费用.No And Mod(b.记录性质, 10) = 1 And b.记录状态 In (1, 3) And a.卡类别id = n_卡类别id And
              Rownum < 2;
      
        Select -1 * Nvl(Sum(结帐金额), 0)
        Into n_退款金额
        From 门诊费用记录 B
        Where b.No = v_费用.No And Mod(b.记录性质, 10) = 1 And b.记录状态 = 2;
      
        --支付状态,0-待支付，1-已支付，2-已退费,3-退费申请中,4-审核通过,5-审核未通过，6-正在支付,7-正在退费
        Select Nvl(Max(Decode(结帐id, 0, 0, Decode(记录状态, 2, Decode(费用状态, 1, 7, 2), Decode(费用状态, 1, 6, 1)))), 0)
        Into n_支付标志
        From (Select Decode(记录状态, 2, 2, 1) As 记录状态, Nvl(费用状态, 0) As 费用状态, Nvl(结帐id, 0) As 结帐id
               From 门诊费用记录
               Where 记录性质 = v_费用.单据类型 And NO = v_费用.No);
      
        v_原因 := '';
        If n_支付标志 = 1 Then
          --注意可能拒绝后又重新申请，一张单据会有多条记录 
          Begin
            --病人退费申请.状态：0-申请,1-审核通过,2-拒绝申请
            Select Decode(Nvl(Min(状态), 0), 0, 3, 1, 4, 5), Max(Decode(状态, 0, 申请原因, 审核原因))
            Into n_支付标志, v_原因
            From 病人退费申请
            Where NO = v_费用.No And 记录性质 = v_费用.单据类型
            Group By NO;
          Exception
            When Others Then
              n_支付标志 := 1;
              v_原因     := '';
          End;
        End If;
      
        v_Temp := '<DJH>' || v_费用.No || '</DJH>';
        v_Temp := v_Temp || '<DJLX>' || v_费用.单据类型 || '</DJLX>';
        v_Temp := v_Temp || '<JE>' || v_费用.单据金额 || '</JE>';
        v_Temp := v_Temp || '<KDSJ>' || v_费用.开单时间 || '</KDSJ>';
        v_Temp := v_Temp || '<ZFZT>' || n_支付标志 || '</ZFZT>';
        v_Temp := v_Temp || '<SHSM>' || v_原因 || '</SHSM>';
        v_Temp := v_Temp || '<YTJE>' || Nvl(n_退款金额, 0) || '</YTJE>';
        v_Temp := v_Temp || '<SFJSK>' || n_Temp || '</SFJSK>';
        v_Temp := '<DJ>' || v_Temp || '</DJ>';
        Select Appendchildxml(x_Templet, '/OUTPUT/YZLIST/YZ[@医嘱ID="' || n_组医嘱id || '"]/DJLIST', Xmltype(v_Temp))
        Into x_Templet
        From Dual;
      End Loop;
    End If;
  
    --只有一条记录的医嘱，在明细中增加该条医嘱，以获取执行状态
    Select Decode(Count(1), 0, 1, 0) Into n_独立医嘱 From 病人医嘱记录 Where 相关id = n_组医嘱id;
    If n_独立医嘱 = 1 Then
      v_Temp := '<YZNR>' || c_医嘱.组医嘱内容 || '</YZNR>';
      v_Temp := v_Temp || '<GG>' || c_医嘱.规格 || '</GG>';
      v_Temp := v_Temp || '<SFFY>' || c_医嘱.发药状态 || '</SFFY>';
      v_Temp := v_Temp || '<SL>' || c_医嘱.数量 || '</SL>';
      v_Temp := v_Temp || '<DW>' || c_医嘱.单位 || '</DW>';
      v_Temp := v_Temp || '<BZDJ>' || Nvl(c_医嘱.标准单价, 0) || '</BZDJ>';
      v_Temp := v_Temp || '<YSJE>' || Nvl(c_医嘱.应收金额, 0) || '</YSJE>';
      v_Temp := v_Temp || '<SSJE>' || Nvl(c_医嘱.实收金额, 0) || '</SSJE>';
      v_Temp := v_Temp || '<ZXZT>' || c_医嘱.执行状态 || '</ZXZT>';
      v_Temp := '<MX>' || v_Temp || '</MX>';
      Select Appendchildxml(x_Templet, '/OUTPUT/YZLIST/YZ[@医嘱ID="' || n_组医嘱id || '"]/YZMX', Xmltype(v_Temp))
      Into x_Templet
      From Dual;
    End If;
  
    If Nvl(c_医嘱.附医嘱, 0) = 1 Then
      If n_明细过滤 = 0 Or (n_明细过滤 = 1 And c_医嘱.医嘱类型 <> '治疗') Then
        v_Temp := '<YZNR>' || c_医嘱.明细医嘱内容 || '</YZNR>';
        v_Temp := v_Temp || '<GG>' || c_医嘱.规格 || '</GG>';
        v_Temp := v_Temp || '<SL>' || c_医嘱.数量 || '</SL>';
        v_Temp := v_Temp || '<DW>' || c_医嘱.单位 || '</DW>';
        v_Temp := v_Temp || '<SFFY>' || c_医嘱.发药状态 || '</SFFY>';
        v_Temp := v_Temp || '<ZXZT>' || c_医嘱.执行状态 || '</ZXZT>';
        v_Temp := v_Temp || '<BZDJ>' || Nvl(c_医嘱.标准单价, 0) || '</BZDJ>';
        v_Temp := v_Temp || '<YSJE>' || Nvl(c_医嘱.应收金额, 0) || '</YSJE>';
        v_Temp := v_Temp || '<SSJE>' || Nvl(c_医嘱.实收金额, 0) || '</SSJE>';
        v_Temp := '<MX>' || v_Temp || '</MX>';
        Select Appendchildxml(x_Templet, '/OUTPUT/YZLIST/YZ[@医嘱ID="' || n_组医嘱id || '"]/YZMX', Xmltype(v_Temp))
        Into x_Templet
        From Dual;
      End If;
    End If;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getvisitinfo;
/
Create Or Replace Procedure Zl_Third_Docarrange
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:医生排班计划 
  --入参:Xml_In: 
  --<IN> 
  --   <YSID>870</YSID>    //医生ID 
  --   <KDID>870</KSID>    //科室ID 
  --   <KSSJ>2014-10-29 </KSSJ>    //开始时间 
  --   <CXTS>14</CXTS>    //查询天数 
  --   <HZDW>支付宝</HZDW> //合作单位 
  --   <HL>号类</HL>      //号类，可传多个，用逗号分隔，格式:普通,专家,... 
  --   <ZD></ZD>        //站点 
  --</IN> 

  --出参:Xml_Out 
  --<OUTPUT> 
  --   <PBLIST>       //未返回该节点表示没有数据 
  --    <PB> 
  --     <RQ>2014-10-29</RQ>     //日期 
  --     <SYHS>5</SYHS>    //剩余号数 
  --     <SBSJ>全日</SBSJ>             //上班时间 
  --     <YGS>5</YGS>    //已挂号数 
  --    </PB> 
  --   <PBLIST> 
  --   <ERROR><MSG></MSG></ERROR> //错误情况返回 
  --</OUTPUT> 
  -------------------------------------------------------------------------------------------------- 
  n_限号数       挂号安排限制.限号数%Type;
  n_已挂数       挂号安排限制.限号数%Type;
  n_总已挂数     挂号安排限制.限号数%Type;
  n_限约数       挂号安排限制.限号数%Type;
  n_已约数       挂号安排限制.限号数%Type;
  n_剩余数       挂号安排限制.限号数%Type;
  v_上班时间     Varchar2(300);
  n_医生id       人员表.Id%Type;
  n_科室id       部门表.Id%Type;
  n_查询天数     Number(4);
  n_合作单位数量 Number(5);
  n_合约已挂数   Number(4);
  n_合约存在     Number(3);
  n_安排存在     Number(3);
  v_号码         挂号安排.号码%Type;
  n_安排id       挂号安排计划.安排id%Type;
  n_计划id       挂号安排计划.Id%Type;
  v_合作单位     挂号合作单位.名称%Type;
  n_Daycount     Number(4);
  d_开始时间     Date;
  d_原始时间     Date;
  n_禁用         Number(3);
  v_Temp         Varchar2(32767); --临时XML 
  x_Templet      Xmltype; --模板XML 
  v_Err_Msg      Varchar2(200);
  v_号类         Varchar2(200);
  n_Exists       Number(2);
  n_预约天数     Number(5);
  n_补充天数     Number(5);
  n_挂号模式     Number(3);
  n_合约模式     临床出诊挂号控制记录.控制方式%Type;
  v_启用时间     Varchar2(500);
  v_普通等级     Varchar2(100);
  v_Pricegrade   Varchar2(500);
  v_站点         部门表.站点%Type;
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/YSID'), Extractvalue(Value(A), 'IN/KSID'), Extractvalue(Value(A), 'IN/CXTS'),
         To_Date(Extractvalue(Value(A), 'IN/KSSJ'), 'YYYY-MM-DD hh24:mi:ss'), Extractvalue(Value(A), 'IN/HZDW'),
         Extractvalue(Value(A), 'IN/HL'), Extractvalue(Value(A), 'IN/ZD')
  Into n_医生id, n_科室id, n_查询天数, d_开始时间, v_合作单位, v_号类, v_站点
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  n_查询天数 := Nvl(n_查询天数, 14);
  n_预约天数 := Nvl(zl_GetSysParameter(66), 7);
  d_原始时间 := Trunc(d_开始时间);
  d_开始时间 := Trunc(d_开始时间);
  n_Daycount := 0;

  v_Pricegrade := Zl_Get_Pricegrade(v_站点);
  v_普通等级   := Substr(v_Pricegrade, 1, Instr(v_Pricegrade, '|') - 1);

  n_挂号模式 := To_Number(Substr(Nvl(zl_GetSysParameter('挂号排班模式'), '0'), 1, 1));
  v_启用时间 := Substr(Nvl(zl_GetSysParameter('挂号排班模式'), '0'), 3);
  If n_挂号模式 = 0 Then
    If Nvl(n_科室id, 0) = 0 Then
      While (n_Daycount < n_查询天数) Loop
        If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
          d_开始时间 := Sysdate - n_Daycount;
        Else
          d_开始时间 := d_原始时间;
        End If;
        n_安排存在 := 0;
        v_上班时间 := Null;
        n_总已挂数 := 0;
        n_已挂数   := 0;
        n_剩余数   := 0;
        n_限号数   := 0;
        n_已约数   := 0;
        n_限约数   := 0;
        For r_排班 In (Select d_开始时间 + n_Daycount As 日期, a.排班, a.限号数, a.限约数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数,
                            a.安排id, a.计划id, a.号码, a.号类
                     
                     From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称, Ap.号码,
                                   Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数

                            
                            From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                          Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                          Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4',
                                                  Ap.周三, '5', Ap.周四, '6', Ap.周五, '7', Ap.周六, Null) As 排班,
                                          Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                   From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                                   Where Ap.科室id = Bm.Id(+) And Ap.医生id = n_医生id And
                                         Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And Ap.停用日期 Is Null And
                                         d_开始时间 + n_Daycount Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                         Nvl(Ap.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                         Xz.限制项目(+) =
                                         Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                    (Select Rownum
                                          From 挂号安排停用状态 Ty
                                          Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                         Not Exists
                                    (Select Rownum
                                          From 挂号安排计划 Jh
                                          Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                                d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                Jh.失效时间)
                                   Union All
                                   Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id,
                                          Jh.Id As 计划id, Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                          Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4',
                                                  Jh.周三, '5', Jh.周四, '6', Jh.周五, '7', Jh.周六, Null) As 排班,
                                          Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                   From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                                   Where Jh.安排id = Ap.Id And Ap.科室id = Bm.Id(+) And
                                         Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And Ap.停用日期 Is Null And
                                         Jh.医生id = n_医生id And
                                         d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                         Jh.失效时间 And Xz.计划id(+) = Jh.Id And
                                         Xz.限制项目(+) =
                                         Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                    (Select Rownum
                                          From 挂号安排停用状态 Ty
                                          Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                         (Jh.生效时间, Jh.安排id) =
                                         (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                          From 挂号安排计划 Sxjh
                                          Where Sxjh.审核时间 Is Not Null And d_开始时间 + n_Daycount Between
                                                Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And Sxjh.失效时间 And
                                                Sxjh.安排id = Jh.安排id
                                          Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                            Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                          病人挂号汇总 Hz, 收费价目 B
                     Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_开始时间 + n_Daycount) And a.项目id = b.收费细目id And
                           b.终止日期 > d_开始时间 + n_Daycount And b.执行日期 <= d_开始时间 + n_Daycount And
                           (b.价格等级 = v_普通等级 Or
                           (b.价格等级 Is Null And Not Exists
                            (Select 1
                              From 收费价目
                              Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And Sysdate Between 执行日期 And
                                    Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')))))) Loop
          If v_号类 Is Null Or Instr(',' || v_号类 || ',', ',' || r_排班.号类 || ',') > 0 Then
            v_上班时间 := v_上班时间 || '+' || r_排班.排班;
            n_总已挂数 := n_总已挂数 + r_排班.已挂数;
            n_已挂数   := r_排班.已挂数;
            n_限号数   := r_排班.限号数;
            n_已约数   := r_排班.已约数;
            n_限约数   := r_排班.限约数;
            n_安排id   := Nvl(r_排班.安排id, 0);
            n_计划id   := Nvl(r_排班.计划id, 0);
            v_号码     := r_排班.号码;
            n_安排存在 := 1;
            If v_上班时间 Is Not Null Then
              If v_合作单位 Is Not Null Then
                If n_计划id <> 0 Then
                  Begin
                    Select 1
                    Into n_合约存在
                    From 合作单位计划控制
                    Where 计划id = n_计划id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_合约存在 := 0;
                  End;
                Else
                  Begin
                    Select 1
                    Into n_合约存在
                    From 合作单位安排控制
                    Where 安排id = n_安排id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_合约存在 := 0;
                  End;
                End If;
              End If;
            
              If v_合作单位 Is Null Or Nvl(n_合约存在, 0) = 0 Then
                If n_计划id <> 0 Then
                  Begin
                    Select Sum(数量)
                    Into n_合作单位数量
                    From 合作单位计划控制
                    Where 计划id = n_计划id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null);
                  Exception
                    When Others Then
                      n_合作单位数量 := 0;
                  End;
                Else
                  Begin
                    Select Sum(数量)
                    Into n_合作单位数量
                    From 合作单位安排控制
                    Where 安排id = n_安排id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null);
                  Exception
                    When Others Then
                      n_合作单位数量 := 0;
                  End;
                End If;
                Begin
                  Select Count(1)
                  Into n_合约已挂数
                  From 病人挂号记录
                  Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                        Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                Exception
                  When Others Then
                    n_合约已挂数 := 0;
                End;
                If n_合作单位数量 = 0 Then
                  n_合作单位数量 := Null;
                End If;
                If Trunc(d_开始时间 + n_Daycount) > Trunc(Sysdate) Then
                  n_剩余数 := Nvl(n_剩余数, 0) + n_限约数 - n_已约数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                Else
                  n_剩余数 := Nvl(n_剩余数, 0) + n_限号数 - n_已挂数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                End If;
              Else
                --合约单位 
                If n_计划id <> 0 Then
                  Begin
                    Select 1
                    Into n_禁用
                    From 合作单位计划控制
                    Where 计划id = n_计划id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                          Rownum < 2;
                  Exception
                    When Others Then
                      n_禁用 := 0;
                  End;
                Else
                  Begin
                    Select 1
                    Into n_禁用
                    From 合作单位安排控制
                    Where 安排id = n_安排id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                          Rownum < 2;
                  Exception
                    When Others Then
                      n_禁用 := 0;
                  End;
                End If;
                If Nvl(n_禁用, 0) = 0 Then
                  Begin
                    Select Count(1)
                    Into n_合约已挂数
                    From 病人挂号记录
                    Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                          Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                  Exception
                    When Others Then
                      n_合约已挂数 := 0;
                  End;
                  If n_计划id <> 0 Then
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  Else
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  End If;
                  If n_合作单位数量 = 0 Then
                    n_合作单位数量 := Null;
                  End If;
                  n_剩余数 := Nvl(n_剩余数, 0) + Nvl(n_合作单位数量, n_合约已挂数) - Nvl(n_合约已挂数, 0);
                
                End If;
              End If;
            End If;
            n_合作单位数量 := 0;
            n_合约存在     := 0;
            n_禁用         := 0;
          End If;
        End Loop;
        v_上班时间 := Substr(v_上班时间, 2);
        If n_安排存在 = 1 Then
          v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                    '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 || '</YGS>' ||
                    '</PB>';
        End If;
        n_Daycount := n_Daycount + 1;
      End Loop;
    Else
      While (n_Daycount < n_查询天数) Loop
        If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
          d_开始时间 := Sysdate - n_Daycount;
        Else
          d_开始时间 := d_原始时间;
        End If;
        v_上班时间 := Null;
        n_总已挂数 := 0;
        n_已挂数   := 0;
        n_剩余数   := 0;
        n_限号数   := 0;
        n_已约数   := 0;
        n_限约数   := 0;
        n_安排存在 := 0;
        For r_排班 In (Select d_开始时间 + n_Daycount As 日期, a.排班, a.限号数, a.限约数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数,
                            a.安排id, a.计划id, a.号码, a.号类
                     
                     From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称, Ap.号码,
                                   Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数

                            
                            From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                          Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                          Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4',
                                                  Ap.周三, '5', Ap.周四, '6', Ap.周五, '7', Ap.周六, Null) As 排班,
                                          Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                   From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                                   Where Ap.科室id = Bm.Id(+) And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                         Ap.医生id = n_医生id And Ap.科室id = n_科室id And Ap.停用日期 Is Null And
                                         d_开始时间 + n_Daycount Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                         Nvl(Ap.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                         Xz.限制项目(+) =
                                         Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                    (Select Rownum
                                          From 挂号安排停用状态 Ty
                                          Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                         Not Exists
                                    (Select Rownum
                                          From 挂号安排计划 Jh
                                          Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                                d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                Jh.失效时间)
                                   Union All
                                   Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id,
                                          Jh.Id As 计划id, Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                          Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4',
                                                  Jh.周三, '5', Jh.周四, '6', Jh.周五, '7', Jh.周六, Null) As 排班,
                                          Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                   From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                                   Where Jh.安排id = Ap.Id And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                         Ap.科室id = Bm.Id(+) And Ap.停用日期 Is Null And Jh.医生id = n_医生id And Ap.科室id = n_科室id And
                                         d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                         Jh.失效时间 And Xz.计划id(+) = Jh.Id And
                                         Xz.限制项目(+) =
                                         Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                    (Select Rownum
                                          From 挂号安排停用状态 Ty
                                          Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                         (Jh.生效时间, Jh.安排id) =
                                         (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                          From 挂号安排计划 Sxjh
                                          Where Sxjh.审核时间 Is Not Null And d_开始时间 + n_Daycount Between
                                                Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And Sxjh.失效时间 And
                                                Sxjh.安排id = Jh.安排id
                                          Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                            Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                          病人挂号汇总 Hz, 收费价目 B
                     Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_开始时间 + n_Daycount) And a.项目id = b.收费细目id And
                           b.终止日期 > d_开始时间 + n_Daycount And b.执行日期 <= d_开始时间 + n_Daycount And
                           (b.价格等级 = v_普通等级 Or
                           (b.价格等级 Is Null And Not Exists
                            (Select 1
                              From 收费价目
                              Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And Sysdate Between 执行日期 And
                                    Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')))))
                     
                     ) Loop
          If v_号类 Is Null Or Instr(',' || v_号类 || ',', ',' || r_排班.号类 || ',') > 0 Then
            v_上班时间 := v_上班时间 || '+' || r_排班.排班;
            n_总已挂数 := n_总已挂数 + r_排班.已挂数;
            n_已挂数   := r_排班.已挂数;
            n_限号数   := r_排班.限号数;
            n_已约数   := r_排班.已约数;
            n_限约数   := r_排班.限约数;
            n_安排id   := Nvl(r_排班.安排id, 0);
            n_计划id   := Nvl(r_排班.计划id, 0);
            v_号码     := r_排班.号码;
            n_安排存在 := 1;
          
            If v_上班时间 Is Not Null Then
              If v_合作单位 Is Not Null Then
                If n_计划id <> 0 Then
                  Begin
                    Select 1
                    Into n_合约存在
                    From 合作单位计划控制
                    Where 计划id = n_计划id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_合约存在 := 0;
                  End;
                Else
                  Begin
                    Select 1
                    Into n_合约存在
                    From 合作单位安排控制
                    Where 安排id = n_安排id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_合约存在 := 0;
                  End;
                End If;
              End If;
            
              If v_合作单位 Is Null Or Nvl(n_合约存在, 0) = 0 Then
                If n_计划id <> 0 Then
                  Begin
                    Select Sum(数量)
                    Into n_合作单位数量
                    From 合作单位计划控制
                    Where 计划id = n_计划id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null);
                  Exception
                    When Others Then
                      n_合作单位数量 := 0;
                  End;
                Else
                  Begin
                    Select Sum(数量)
                    Into n_合作单位数量
                    From 合作单位安排控制
                    Where 安排id = n_安排id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null);
                  Exception
                    When Others Then
                      n_合作单位数量 := 0;
                  End;
                End If;
                Begin
                  Select Count(1)
                  Into n_合约已挂数
                  From 病人挂号记录
                  Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                        Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                Exception
                  When Others Then
                    n_合约已挂数 := 0;
                End;
                If n_合作单位数量 = 0 Then
                  n_合作单位数量 := Null;
                End If;
                If Trunc(d_开始时间 + n_Daycount) > Trunc(Sysdate) Then
                  n_剩余数 := Nvl(n_剩余数, 0) + n_限约数 - n_已约数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                Else
                  n_剩余数 := Nvl(n_剩余数, 0) + n_限号数 - n_已挂数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                End If;
              Else
                --合约单位 
                If n_计划id <> 0 Then
                  Begin
                    Select 1
                    Into n_禁用
                    From 合作单位计划控制
                    Where 计划id = n_计划id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                          Rownum < 2;
                  Exception
                    When Others Then
                      n_禁用 := 0;
                  End;
                Else
                  Begin
                    Select 1
                    Into n_禁用
                    From 合作单位安排控制
                    Where 安排id = n_安排id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                          Rownum < 2;
                  Exception
                    When Others Then
                      n_禁用 := 0;
                  End;
                End If;
                If Nvl(n_禁用, 0) = 0 Then
                  Begin
                    Select Count(1)
                    Into n_合约已挂数
                    From 病人挂号记录
                    Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                          Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                  Exception
                    When Others Then
                      n_合约已挂数 := 0;
                  End;
                  If n_计划id <> 0 Then
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  Else
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  End If;
                  If n_合作单位数量 = 0 Then
                    n_合作单位数量 := Null;
                  End If;
                  n_剩余数 := Nvl(n_剩余数, 0) + Nvl(n_合作单位数量, n_合约已挂数) - Nvl(n_合约已挂数, 0);
                
                End If;
              End If;
            End If;
            n_合作单位数量 := 0;
            n_合约存在     := 0;
            n_禁用         := 0;
          End If;
        End Loop;
        v_上班时间 := Substr(v_上班时间, 2);
        If n_安排存在 = 1 Then
          v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                    '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 || '</YGS>' ||
                    '</PB>';
        End If;
        n_Daycount := n_Daycount + 1;
      End Loop;
    End If;
    v_Temp := '<PBLIST>' || v_Temp || '</PBLIST>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Else
    --出诊表排班模式 
    n_补充天数 := Zl_Fun_Getappointmentdays;
    If Nvl(n_科室id, 0) = 0 Then
      --通过医生查找 
      While (n_Daycount < n_查询天数) Loop
        If Trunc(d_开始时间 + n_Daycount) < To_Date(Substr(v_启用时间, 1, Instr(v_启用时间, ' ') - 1), 'yyyy-mm-dd') Then
          n_安排存在 := 0;
          v_上班时间 := Null;
          n_总已挂数 := 0;
          n_已挂数   := 0;
          n_剩余数   := 0;
          n_限号数   := 0;
          n_已约数   := 0;
          n_限约数   := 0;
          For r_排班 In (Select d_开始时间 + n_Daycount As 日期, a.排班, a.限号数, a.限约数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数,
                              a.安排id, a.计划id, a.号码, a.号类
                       From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称,
                                     Ap.号码, Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数
                              
                              From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                            Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                            Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4',
                                                    Ap.周三, '5', Ap.周四, '6', Ap.周五, '7', Ap.周六, Null) As 排班,
                                            Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                     From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                                     Where Ap.科室id = Bm.Id(+) And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                           Ap.医生id = n_医生id And Ap.停用日期 Is Null And
                                           d_开始时间 + n_Daycount Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                           Nvl(Ap.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                           Xz.限制项目(+) =
                                           Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                                  '周三', '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                      (Select Rownum
                                            From 挂号安排停用状态 Ty
                                            Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                           Not Exists
                                      (Select Rownum
                                            From 挂号安排计划 Jh
                                            Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                                  d_开始时间 + n_Daycount Between
                                                  Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And Jh.失效时间)
                                     Union All
                                     Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id,
                                            Jh.Id As 计划id, Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                            Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4',
                                                    Jh.周三, '5', Jh.周四, '6', Jh.周五, '7', Jh.周六, Null) As 排班,
                                            Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                     From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                                     Where Jh.安排id = Ap.Id And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                           Ap.科室id = Bm.Id(+) And Ap.停用日期 Is Null And Jh.医生id = n_医生id And
                                           d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                           Jh.失效时间 And Xz.计划id(+) = Jh.Id And
                                           Xz.限制项目(+) =
                                           Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                                  '周三', '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                      (Select Rownum
                                            From 挂号安排停用状态 Ty
                                            Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                           (Jh.生效时间, Jh.安排id) = (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                                                 From 挂号安排计划 Sxjh
                                                                 Where Sxjh.审核时间 Is Not Null And
                                                                       d_开始时间 + n_Daycount Between
                                                                       Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                                       Sxjh.失效时间 And Sxjh.安排id = Jh.安排id
                                                                 Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                              Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                            病人挂号汇总 Hz, 收费价目 B
                       Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_开始时间 + n_Daycount) And a.项目id = b.收费细目id And
                             b.终止日期 > d_开始时间 + n_Daycount And b.执行日期 <= d_开始时间 + n_Daycount And
                             (b.价格等级 = v_普通等级 Or
                             (b.价格等级 Is Null And Not Exists
                              (Select 1
                                From 收费价目
                                Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And Sysdate Between 执行日期 And
                                      Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')))))) Loop
            If v_号类 Is Null Or Instr(',' || v_号类 || ',', ',' || r_排班.号类 || ',') > 0 Then
              v_上班时间 := v_上班时间 || '+' || r_排班.排班;
              n_总已挂数 := n_总已挂数 + r_排班.已挂数;
              n_已挂数   := r_排班.已挂数;
              n_限号数   := r_排班.限号数;
              n_已约数   := r_排班.已约数;
              n_限约数   := r_排班.限约数;
              n_安排id   := Nvl(r_排班.安排id, 0);
              n_计划id   := Nvl(r_排班.计划id, 0);
              v_号码     := r_排班.号码;
              n_安排存在 := 1;
              If v_上班时间 Is Not Null Then
                If v_合作单位 Is Not Null Then
                  If n_计划id <> 0 Then
                    Begin
                      Select 1
                      Into n_合约存在
                      From 合作单位计划控制
                      Where 计划id = n_计划id And 合作单位 = v_合作单位 And Rownum < 2;
                    Exception
                      When Others Then
                        n_合约存在 := 0;
                    End;
                  Else
                    Begin
                      Select 1
                      Into n_合约存在
                      From 合作单位安排控制
                      Where 安排id = n_安排id And 合作单位 = v_合作单位 And Rownum < 2;
                    Exception
                      When Others Then
                        n_合约存在 := 0;
                    End;
                  End If;
                End If;
              
                If v_合作单位 Is Null Or Nvl(n_合约存在, 0) = 0 Then
                  If n_计划id <> 0 Then
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null);
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  Else
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null);
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  End If;
                  Begin
                    Select Count(1)
                    Into n_合约已挂数
                    From 病人挂号记录
                    Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                          Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                  Exception
                    When Others Then
                      n_合约已挂数 := 0;
                  End;
                  If n_合作单位数量 = 0 Then
                    n_合作单位数量 := Null;
                  End If;
                  If Trunc(d_开始时间 + n_Daycount) > Trunc(Sysdate) Then
                    n_剩余数 := Nvl(n_剩余数, 0) + n_限约数 - n_已约数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                  Else
                    n_剩余数 := Nvl(n_剩余数, 0) + n_限号数 - n_已挂数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                  End If;
                Else
                  --合约单位 
                  If n_计划id <> 0 Then
                    Begin
                      Select 1
                      Into n_禁用
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                            Rownum < 2;
                    Exception
                      When Others Then
                        n_禁用 := 0;
                    End;
                  Else
                    Begin
                      Select 1
                      Into n_禁用
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                            Rownum < 2;
                    Exception
                      When Others Then
                        n_禁用 := 0;
                    End;
                  End If;
                  If Nvl(n_禁用, 0) = 0 Then
                    Begin
                      Select Count(1)
                      Into n_合约已挂数
                      From 病人挂号记录
                      Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                            Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                    Exception
                      When Others Then
                        n_合约已挂数 := 0;
                    End;
                    If n_计划id <> 0 Then
                      Begin
                        Select Sum(数量)
                        Into n_合作单位数量
                        From 合作单位计划控制
                        Where 计划id = n_计划id And
                              限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                            '周三', '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                      Exception
                        When Others Then
                          n_合作单位数量 := 0;
                      End;
                    Else
                      Begin
                        Select Sum(数量)
                        Into n_合作单位数量
                        From 合作单位安排控制
                        Where 安排id = n_安排id And
                              限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                            '周三', '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                      Exception
                        When Others Then
                          n_合作单位数量 := 0;
                      End;
                    End If;
                    If n_合作单位数量 = 0 Then
                      n_合作单位数量 := Null;
                    End If;
                    n_剩余数 := Nvl(n_剩余数, 0) + Nvl(n_合作单位数量, n_合约已挂数) - Nvl(n_合约已挂数, 0);
                  
                  End If;
                End If;
              End If;
              n_合作单位数量 := 0;
              n_合约存在     := 0;
              n_禁用         := 0;
            End If;
          End Loop;
          v_上班时间 := Substr(v_上班时间, 2);
          If n_安排存在 = 1 Then
            v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                      '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                      '</YGS>' || '</PB>';
          End If;
        Else
          n_安排存在 := 0;
          v_上班时间 := Null;
          n_总已挂数 := 0;
          n_已挂数   := 0;
          n_剩余数   := 0;
          n_限号数   := 0;
          n_已约数   := 0;
          n_限约数   := 0;
          If v_合作单位 Is Null Then
            --非合作单位 
            If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
              --当天挂号 
              For r_出诊 In (Select a.已挂数, a.限号数, a.上班时段
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And a.是否发布 = 1) Loop
                n_已挂数   := n_已挂数 + Nvl(r_出诊.已挂数, 0);
                n_限号数   := n_限号数 + r_出诊.限号数;
                v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                n_安排存在 := 1;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_限号数 - n_已挂数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            Else
              --预约挂号 
              For r_出诊 In (Select a.已约数, a.限号数, a.限约数, a.上班时段
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And a.是否发布 = 1) Loop
                n_已挂数   := n_已挂数 + Nvl(r_出诊.已约数, 0);
                n_限号数   := n_限号数 + Nvl(r_出诊.限约数, r_出诊.限号数);
                v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                n_安排存在 := 1;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_限号数 - n_已挂数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            End If;
          Else
            --合作单位 
            If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
              For r_出诊 In (Select a.Id, a.已挂数, a.限号数, a.限约数, a.上班时段, a.是否序号控制
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And a.是否发布 = 1) Loop
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_限号数
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_限号数 := n_限号数 * Nvl(r_出诊.限约数, r_出诊.限号数) / 100;
                  End If;
                  Select Count(1)
                  Into n_已挂数
                  From 病人挂号记录
                  Where 出诊记录id = r_出诊.Id And 记录状态 = 1 And 合作单位 = v_合作单位;
                  If r_出诊.限号数 - r_出诊.已挂数 < n_限号数 - n_已挂数 Then
                    n_剩余数 := n_剩余数 + r_出诊.限号数 - r_出诊.已挂数;
                  Else
                    n_剩余数 := n_剩余数 + n_限号数 - n_已挂数;
                  End If;
                  n_总已挂数 := n_总已挂数 + n_已挂数;
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
                If n_合约模式 = 3 Then
                  If r_出诊.是否序号控制 = 0 Then
                    n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                    n_剩余数   := n_剩余数 + r_出诊.限号数 - Nvl(r_出诊.已挂数, 0);
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                    n_安排存在 := 1;
                  Else
                    For r_合作 In (Select 序号, 数量
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Begin
                        Select 1
                        Into n_Exists
                        From 临床出诊序号控制
                        Where 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0;
                      Exception
                        When Others Then
                          n_Exists := 0;
                      End;
                      If n_Exists = 1 Then
                        n_剩余数   := n_剩余数 + 1;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                    n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                  n_剩余数   := n_剩余数 + r_出诊.限号数 - Nvl(r_出诊.已挂数, 0);
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
              End Loop;
            
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            Else
              --非当天 
              For r_出诊 In (Select a.Id, a.已约数, a.已挂数, a.限号数, a.限约数, a.上班时段, a.是否序号控制
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And a.是否发布 = 1) Loop
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_限号数
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_限号数 := n_限号数 * Nvl(r_出诊.限约数, r_出诊.限号数) / 100;
                  End If;
                  Select Count(1)
                  Into n_已挂数
                  From 病人挂号记录
                  Where 出诊记录id = r_出诊.Id And 记录状态 = 1 And 合作单位 = v_合作单位;
                  If Nvl(r_出诊.限约数, r_出诊.限号数) - r_出诊.已约数 < n_限号数 - n_已挂数 Then
                    n_剩余数 := n_剩余数 + Nvl(r_出诊.限约数, r_出诊.限号数) - r_出诊.已约数;
                  Else
                    n_剩余数 := n_剩余数 + n_限号数 - n_已挂数;
                  End If;
                  n_总已挂数 := n_总已挂数 + n_已挂数;
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
                If n_合约模式 = 3 Then
                  If r_出诊.是否序号控制 = 0 Then
                    --分时段非序号控制 
                    For r_合作 In (Select 序号, 数量
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Select Count(1)
                      Into n_Exists
                      From 临床出诊序号控制
                      Where 预约顺序号 Is Not Null And 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) <> 0;
                      If r_合作.数量 - n_Exists > 0 Then
                        n_剩余数   := n_剩余数 + r_合作.数量 - n_Exists;
                        n_总已挂数 := n_总已挂数 + n_Exists;
                        n_安排存在 := 1;
                      Else
                        n_总已挂数 := n_总已挂数 + n_Exists;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  Else
                    For r_合作 In (Select 序号
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Begin
                        Select 1
                        Into n_Exists
                        From 临床出诊序号控制
                        Where 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0;
                      Exception
                        When Others Then
                          n_Exists := 0;
                      End;
                      If n_Exists = 1 Then
                        n_剩余数   := n_剩余数 + 1;
                        n_安排存在 := 1;
                      Else
                        n_总已挂数 := n_总已挂数 + 1;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已约数, 0);
                  n_剩余数   := n_剩余数 + r_出诊.限约数 - Nvl(r_出诊.已约数, 0);
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            End If;
          End If;
        End If;
        n_Daycount := n_Daycount + 1;
      End Loop;
    Else
      --通过科室+医生查找 
      While (n_Daycount < n_查询天数) Loop
        If Trunc(d_开始时间 + n_Daycount) < To_Date(Substr(v_启用时间, 1, Instr(v_启用时间, ' ') - 1), 'yyyy-mm-dd') Then
          v_上班时间 := Null;
          n_总已挂数 := 0;
          n_已挂数   := 0;
          n_剩余数   := 0;
          n_限号数   := 0;
          n_已约数   := 0;
          n_限约数   := 0;
          n_安排存在 := 0;
          For r_排班 In (Select d_开始时间 + n_Daycount As 日期, a.排班, a.限号数, a.限约数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数,
                              a.安排id, a.计划id, a.号码, a.号类
                       
                       From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称,
                                     Ap.号码, Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数
                              
                              From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                            Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                            Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4',
                                                    Ap.周三, '5', Ap.周四, '6', Ap.周五, '7', Ap.周六, Null) As 排班,
                                            Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                     From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                                     Where Ap.科室id = Bm.Id(+) And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                           Ap.医生id = n_医生id And Ap.科室id = n_科室id And Ap.停用日期 Is Null And
                                           d_开始时间 + n_Daycount Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                           Nvl(Ap.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                           Xz.限制项目(+) =
                                           Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                                  '周三', '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                      (Select Rownum
                                            From 挂号安排停用状态 Ty
                                            Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                           Not Exists
                                      (Select Rownum
                                            From 挂号安排计划 Jh
                                            Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                                  d_开始时间 + n_Daycount Between
                                                  Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And Jh.失效时间)
                                     Union All
                                     Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id,
                                            Jh.Id As 计划id, Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                            Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4',
                                                    Jh.周三, '5', Jh.周四, '6', Jh.周五, '7', Jh.周六, Null) As 排班,
                                            Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                     From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                                     Where Jh.安排id = Ap.Id And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                           Ap.科室id = Bm.Id(+) And Ap.停用日期 Is Null And Jh.医生id = n_医生id And Ap.科室id = n_科室id And
                                           d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                           Jh.失效时间 And Xz.计划id(+) = Jh.Id And
                                           Xz.限制项目(+) =
                                           Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                                  '周三', '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                      (Select Rownum
                                            From 挂号安排停用状态 Ty
                                            Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                           (Jh.生效时间, Jh.安排id) = (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                                                 From 挂号安排计划 Sxjh
                                                                 Where Sxjh.审核时间 Is Not Null And
                                                                       d_开始时间 + n_Daycount Between
                                                                       Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                                       Sxjh.失效时间 And Sxjh.安排id = Jh.安排id
                                                                 Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                              Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                            病人挂号汇总 Hz, 收费价目 B
                       Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_开始时间 + n_Daycount) And a.项目id = b.收费细目id And
                             b.终止日期 > d_开始时间 + n_Daycount And b.执行日期 <= d_开始时间 + n_Daycount And
                             (b.价格等级 = v_普通等级 Or
                             (b.价格等级 Is Null And Not Exists
                              (Select 1
                                From 收费价目
                                Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And Sysdate Between 执行日期 And
                                      Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')))))) Loop
            If v_号类 Is Null Or Instr(',' || v_号类 || ',', ',' || r_排班.号类 || ',') > 0 Then
              v_上班时间 := v_上班时间 || '+' || r_排班.排班;
              n_总已挂数 := n_总已挂数 + r_排班.已挂数;
              n_已挂数   := r_排班.已挂数;
              n_限号数   := r_排班.限号数;
              n_已约数   := r_排班.已约数;
              n_限约数   := r_排班.限约数;
              n_安排id   := Nvl(r_排班.安排id, 0);
              n_计划id   := Nvl(r_排班.计划id, 0);
              v_号码     := r_排班.号码;
              n_安排存在 := 1;
            
              If v_上班时间 Is Not Null Then
                If v_合作单位 Is Not Null Then
                  If n_计划id <> 0 Then
                    Begin
                      Select 1
                      Into n_合约存在
                      From 合作单位计划控制
                      Where 计划id = n_计划id And 合作单位 = v_合作单位 And Rownum < 2;
                    Exception
                      When Others Then
                        n_合约存在 := 0;
                    End;
                  Else
                    Begin
                      Select 1
                      Into n_合约存在
                      From 合作单位安排控制
                      Where 安排id = n_安排id And 合作单位 = v_合作单位 And Rownum < 2;
                    Exception
                      When Others Then
                        n_合约存在 := 0;
                    End;
                  End If;
                End If;
              
                If v_合作单位 Is Null Or Nvl(n_合约存在, 0) = 0 Then
                  If n_计划id <> 0 Then
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null);
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  Else
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null);
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  End If;
                  Begin
                    Select Count(1)
                    Into n_合约已挂数
                    From 病人挂号记录
                    Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                          Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                  Exception
                    When Others Then
                      n_合约已挂数 := 0;
                  End;
                  If n_合作单位数量 = 0 Then
                    n_合作单位数量 := Null;
                  End If;
                  If Trunc(d_开始时间 + n_Daycount) > Trunc(Sysdate) Then
                    n_剩余数 := Nvl(n_剩余数, 0) + n_限约数 - n_已约数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                  Else
                    n_剩余数 := Nvl(n_剩余数, 0) + n_限号数 - n_已挂数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                  End If;
                Else
                  --合约单位 
                  If n_计划id <> 0 Then
                    Begin
                      Select 1
                      Into n_禁用
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                            Rownum < 2;
                    Exception
                      When Others Then
                        n_禁用 := 0;
                    End;
                  Else
                    Begin
                      Select 1
                      Into n_禁用
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                            Rownum < 2;
                    Exception
                      When Others Then
                        n_禁用 := 0;
                    End;
                  End If;
                  If Nvl(n_禁用, 0) = 0 Then
                    Begin
                      Select Count(1)
                      Into n_合约已挂数
                      From 病人挂号记录
                      Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                            Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                    Exception
                      When Others Then
                        n_合约已挂数 := 0;
                    End;
                    If n_计划id <> 0 Then
                      Begin
                        Select Sum(数量)
                        Into n_合作单位数量
                        From 合作单位计划控制
                        Where 计划id = n_计划id And
                              限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                            '周三', '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                      Exception
                        When Others Then
                          n_合作单位数量 := 0;
                      End;
                    Else
                      Begin
                        Select Sum(数量)
                        Into n_合作单位数量
                        From 合作单位安排控制
                        Where 安排id = n_安排id And
                              限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                            '周三', '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                      Exception
                        When Others Then
                          n_合作单位数量 := 0;
                      End;
                    End If;
                    If n_合作单位数量 = 0 Then
                      n_合作单位数量 := Null;
                    End If;
                    n_剩余数 := Nvl(n_剩余数, 0) + Nvl(n_合作单位数量, n_合约已挂数) - Nvl(n_合约已挂数, 0);
                  
                  End If;
                End If;
              End If;
              n_合作单位数量 := 0;
              n_合约存在     := 0;
              n_禁用         := 0;
            End If;
          End Loop;
          v_上班时间 := Substr(v_上班时间, 2);
          If n_安排存在 = 1 Then
            v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                      '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                      '</YGS>' || '</PB>';
          End If;
        Else
          n_安排存在 := 0;
          v_上班时间 := Null;
          n_总已挂数 := 0;
          n_已挂数   := 0;
          n_剩余数   := 0;
          n_限号数   := 0;
          n_已约数   := 0;
          n_限约数   := 0;
          If v_合作单位 Is Null Then
            --非合作单位 
            If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
              --当天挂号 
              For r_出诊 In (Select a.已挂数, a.限号数, a.上班时段
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 a.科室id = n_科室id And (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And a.是否发布 = 1) Loop
                n_已挂数   := n_已挂数 + Nvl(r_出诊.已挂数, 0);
                n_限号数   := n_限号数 + r_出诊.限号数;
                v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                n_安排存在 := 1;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_限号数 - n_已挂数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            Else
              --预约挂号 
              For r_出诊 In (Select a.已约数, a.限号数, a.限约数, a.上班时段
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 a.科室id = n_科室id And (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And a.是否发布 = 1) Loop
                n_已挂数   := n_已挂数 + Nvl(r_出诊.已约数, 0);
                n_限号数   := n_限号数 + Nvl(r_出诊.限约数, r_出诊.限号数);
                v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                n_安排存在 := 1;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_限号数 - n_已挂数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            End If;
          Else
            --合作单位 
            If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
              For r_出诊 In (Select a.Id, a.已挂数, a.限号数, a.限约数, a.上班时段, a.是否序号控制
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 a.科室id = n_科室id And (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And a.是否发布 = 1) Loop
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_限号数
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_限号数 := n_限号数 * Nvl(r_出诊.限约数, r_出诊.限号数) / 100;
                  End If;
                  Select Count(1)
                  Into n_已挂数
                  From 病人挂号记录
                  Where 出诊记录id = r_出诊.Id And 记录状态 = 1 And 合作单位 = v_合作单位;
                  If r_出诊.限号数 - r_出诊.已挂数 < n_限号数 - n_已挂数 Then
                    n_剩余数 := n_剩余数 + r_出诊.限号数 - r_出诊.已挂数;
                  Else
                    n_剩余数 := n_剩余数 + n_限号数 - n_已挂数;
                  End If;
                  n_总已挂数 := n_总已挂数 + n_已挂数;
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
                If n_合约模式 = 3 Then
                  If r_出诊.是否序号控制 = 0 Then
                    n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                    n_剩余数   := n_剩余数 + r_出诊.限号数 - Nvl(r_出诊.已挂数, 0);
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                    n_安排存在 := 1;
                  Else
                    For r_合作 In (Select 序号, 数量
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Begin
                        Select 1
                        Into n_Exists
                        From 临床出诊序号控制
                        Where 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0;
                      Exception
                        When Others Then
                          n_Exists := 0;
                      End;
                      If n_Exists = 1 Then
                        n_剩余数   := n_剩余数 + 1;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                    n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                  n_剩余数   := n_剩余数 + r_出诊.限号数 - Nvl(r_出诊.已挂数, 0);
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
              End Loop;
            
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            Else
              --非当天 
              For r_出诊 In (Select a.Id, a.已约数, a.已挂数, a.限号数, a.限约数, a.上班时段, a.是否序号控制
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 a.科室id = n_科室id And (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And a.是否发布 = 1) Loop
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_限号数
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_限号数 := n_限号数 * Nvl(r_出诊.限约数, r_出诊.限号数) / 100;
                  End If;
                  Select Count(1)
                  Into n_已挂数
                  From 病人挂号记录
                  Where 出诊记录id = r_出诊.Id And 记录状态 = 1 And 合作单位 = v_合作单位;
                  If Nvl(r_出诊.限约数, r_出诊.限号数) - r_出诊.已约数 < n_限号数 - n_已挂数 Then
                    n_剩余数 := n_剩余数 + Nvl(r_出诊.限约数, r_出诊.限号数) - r_出诊.已约数;
                  Else
                    n_剩余数 := n_剩余数 + n_限号数 - n_已挂数;
                  End If;
                  n_总已挂数 := n_总已挂数 + n_已挂数;
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
                If n_合约模式 = 3 Then
                  If r_出诊.是否序号控制 = 0 Then
                    --分时段非序号控制 
                    For r_合作 In (Select 序号, 数量
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Select Count(1)
                      Into n_Exists
                      From 临床出诊序号控制
                      Where 预约顺序号 Is Not Null And 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) <> 0;
                      If r_合作.数量 - n_Exists > 0 Then
                        n_剩余数   := n_剩余数 + r_合作.数量 - n_Exists;
                        n_总已挂数 := n_总已挂数 + n_Exists;
                        n_安排存在 := 1;
                      Else
                        n_总已挂数 := n_总已挂数 + n_Exists;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  Else
                    For r_合作 In (Select 序号
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Begin
                        Select 1
                        Into n_Exists
                        From 临床出诊序号控制
                        Where 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0;
                      Exception
                        When Others Then
                          n_Exists := 0;
                      End;
                      If n_Exists = 1 Then
                        n_剩余数   := n_剩余数 + 1;
                        n_安排存在 := 1;
                      Else
                        n_总已挂数 := n_总已挂数 + 1;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已约数, 0);
                  n_剩余数   := n_剩余数 + r_出诊.限约数 - Nvl(r_出诊.已约数, 0);
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            End If;
          End If;
        End If;
        n_Daycount := n_Daycount + 1;
      End Loop;
    End If;
    v_Temp := '<PBLIST>' || v_Temp || '</PBLIST>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End If;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Docarrange;
/
Create Or Replace Procedure Zl_Third_Getdeptlist
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取可挂号科室
  --入参:Xml_In:
  --<IN>
  --  <CXTS>14</CXTS>        //查询天数
  --  <HZDW>支付宝</HZDW>    //合作单位
  --  <ZD></ZD>              //站点
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  -- <KSLIST>
  --  <KS>
  --    <ID>科室ID</ID>       //科室ID
  --    <MC>科室名称</MC>     //科室名称
  --    <ZDYYTS>最大可预约天数</ZDYYTS>     //最大可预约天数
  --  </KS>
  --  <KS>
  --    ...
  --  </KS>
  -- </KSLIST>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  x_Templet Xmltype; --模板XML
  v_Temp    Varchar2(5000); --临时XML

  n_查询天数 Number(5);
  v_合作单位 合作单位安排控制.合作单位%Type;
  v_站点     部门表.站点%Type;

  v_Para     Varchar2(4000);
  n_预约天数 Number(5);
  n_补充天数 Number(5);

  n_挂号模式 Number(3);
  d_启用时间 Date;
Begin
  x_Templet := Xmltype('<OUTPUT><KSLIST></KSLIST></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/CXTS'), Extractvalue(Value(A), 'IN/HZDW'), Nvl(Extractvalue(Value(A), 'IN/ZD'), '-')
  Into n_查询天数, v_合作单位, v_站点
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  v_Para     := zl_GetSysParameter(256);
  n_挂号模式 := To_Number(Substr(v_Para, 1, 1));
  If n_挂号模式 = 1 Then
    Begin
      d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
    Exception
      When Others Then
        d_启用时间 := Null;
    End;
  End If;
  n_预约天数 := zl_GetSysParameter(66);

  If n_挂号模式 = 0 Then
    If v_合作单位 Is Null Then
      For r_Dept In (Select a.科室id, d.名称, Max(Nvl(a.预约天数, n_预约天数)) As 预约天数
                     From 挂号安排 A, 部门表 D
                     Where a.科室id = d.Id And a.停用日期 Is Null And Nvl(d.站点, v_站点) = v_站点 And
                           (d.撤档时间 Is Null Or d.撤档时间 >= To_Date('3000-01-01', 'yyyy-mm-dd'))
                     Group By a.科室id, d.名称) Loop
        v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>';
        v_Temp := v_Temp || '<ZDYYTS>' || r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
        Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      End Loop;
    Else
      For r_Dept In (Select 科室id, 名称, Max(预约天数) As 预约天数
                     From (
                            --1.计划
                            Select a.科室id, d.名称, Nvl(a.预约天数, n_预约天数) As 预约天数
                            From 挂号安排 A, 挂号安排计划 C, 部门表 D
                            Where a.Id = c.安排id And a.科室id = d.Id And a.停用日期 Is Null And c.审核时间 Is Not Null And
                                  Not (c.失效时间 < Sysdate Or c.生效时间 > Sysdate + Nvl(n_查询天数, Nvl(a.预约天数, n_预约天数)))
                                 
                                  And
                                  (Not Exists (Select 1 From 合作单位计划控制 Where 计划id = c.Id And 合作单位 = v_合作单位) Or Exists
                                   (Select 1
                                    From 合作单位计划控制
                                    Where 计划id = c.Id And 合作单位 = v_合作单位 And 数量 <> 0))
                                 
                                  And Nvl(d.站点, v_站点) = v_站点 And
                                  (d.撤档时间 Is Null Or d.撤档时间 >= To_Date('3000-01-01', 'yyyy-mm-dd'))
                            --2.安排
                            Union All
                            Select a.科室id, d.名称, Nvl(a.预约天数, n_预约天数) As 预约天数
                            From 挂号安排 A, 部门表 D
                            Where a.科室id = d.Id And a.停用日期 Is Null And Not Exists
                             (Select 1 From 挂号安排计划 Where 安排id = a.Id)
                                 
                                  And
                                  (Not Exists (Select 1 From 合作单位安排控制 Where 安排id = a.Id And 合作单位 = v_合作单位) Or Exists
                                   (Select 1
                                    From 合作单位安排控制
                                    Where 安排id = a.Id And 合作单位 = v_合作单位 And 数量 <> 0))
                                 
                                  And Nvl(d.站点, v_站点) = v_站点 And
                                  (d.撤档时间 Is Null Or d.撤档时间 >= To_Date('3000-01-01', 'yyyy-mm-dd')))
                     Group By 科室id, 名称) Loop
        v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>';
        v_Temp := v_Temp || '<ZDYYTS>' || r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
        Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      End Loop;
    End If;
  Else
    --出诊表排班模式
    n_补充天数 := Zl_Fun_Getappointmentdays;
    If v_合作单位 Is Null Then
      For r_Dept In (Select 科室id, 名称, Max(预约天数) As 预约天数
                     From (
                            --启用前
                            Select a.科室id, d.名称, Nvl(a.预约天数, n_预约天数) As 预约天数
                            From 挂号安排 A, 部门表 D
                            Where a.科室id = d.Id And a.停用日期 Is Null And Nvl(d.站点, v_站点) = v_站点 And
                                  (d.撤档时间 Is Null Or d.撤档时间 >= To_Date('3000-01-01', 'yyyy-mm-dd')) And Sysdate < d_启用时间
                            --启用后
                            Union All
                            Select a.科室id, d.名称, Nvl(c.预约天数, n_预约天数) + n_补充天数 As 预约天数
                            From 临床出诊记录 A, 临床出诊号源 C, 部门表 D
                            Where a.号源id = c.Id And a.科室id = d.Id And a.出诊日期 Between Trunc(Sysdate) And
                                  Trunc(Sysdate) + Nvl(n_查询天数, Nvl(c.预约天数, n_预约天数) + n_补充天数) And a.开始时间 > d_启用时间 And
                                  Nvl(a.是否发布, 0) = 1
                                 --排除全时段停诊了的
                                  And (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) And Nvl(a.停诊开始时间, a.终止时间) > Sysdate Or
                                  a.终止时间 > Nvl(a.停诊终止时间, a.开始时间) And a.终止时间 > Sysdate Or Exists
                                   (Select 1
                                        From 临床出诊序号控制
                                        Where 记录id = a.Id And Nvl(是否停诊, 0) = 0 And Nvl(a.是否序号控制, 0) = 1 And
                                              Nvl(a.是否分时段, 0) = 1 And 开始时间 <> 终止时间 And 开始时间 >= Sysdate))
                                 --
                                  And (c.撤档时间 Is Null Or c.撤档时间 >= To_Date('3000-01-01', 'yyyy-mm-dd')) And
                                  Nvl(d.站点, v_站点) = v_站点 And
                                  (d.撤档时间 Is Null Or d.撤档时间 >= To_Date('3000-01-01', 'yyyy-mm-dd')))
                     Group By 科室id, 名称) Loop
        v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>';
        v_Temp := v_Temp || '<ZDYYTS>' || r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
        Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      End Loop;
    Else
      For r_Dept In (Select 科室id, 名称, Max(预约天数) As 预约天数
                     From (
                            --1.启用前
                            --1.1.计划
                            Select a.科室id, d.名称, Nvl(a.预约天数, n_预约天数) As 预约天数
                            From 挂号安排 A, 挂号安排计划 C, 部门表 D
                            Where a.Id = c.安排id And a.科室id = d.Id And a.停用日期 Is Null And c.审核时间 Is Not Null And
                                  Not (c.失效时间 < Sysdate Or c.生效时间 > Sysdate + Nvl(n_查询天数, Nvl(a.预约天数, n_预约天数)))
                                 
                                  And
                                  (Not Exists (Select 1 From 合作单位计划控制 Where 计划id = c.Id And 合作单位 = v_合作单位) Or Exists
                                   (Select 1
                                    From 合作单位计划控制
                                    Where 计划id = c.Id And 合作单位 = v_合作单位 And 数量 <> 0))
                                 
                                  And Nvl(d.站点, v_站点) = v_站点 And
                                  (d.撤档时间 Is Null Or d.撤档时间 >= To_Date('3000-01-01', 'yyyy-mm-dd')) And Sysdate < d_启用时间
                            --1.2.安排
                            Union All
                            Select a.科室id, d.名称, Nvl(a.预约天数, n_预约天数) As 预约天数
                            From 挂号安排 A, 部门表 D
                            Where a.科室id = d.Id And a.停用日期 Is Null And Not Exists
                             (Select 1 From 挂号安排计划 Where 安排id = a.Id)
                                 
                                  And
                                  (Not Exists (Select 1 From 合作单位安排控制 Where 安排id = a.Id And 合作单位 = v_合作单位) Or Exists
                                   (Select 1
                                    From 合作单位安排控制
                                    Where 安排id = a.Id And 合作单位 = v_合作单位 And 数量 <> 0))
                                 
                                  And Nvl(d.站点, v_站点) = v_站点 And
                                  (d.撤档时间 Is Null Or d.撤档时间 >= To_Date('3000-01-01', 'yyyy-mm-dd')) And Sysdate < d_启用时间
                            --2.启用后
                            Union All
                            Select a.科室id, d.名称, Nvl(c.预约天数, n_预约天数) + n_补充天数 As 预约天数
                            From 临床出诊记录 A, 临床出诊号源 C, 部门表 D
                            Where a.号源id = c.Id And a.科室id = d.Id And a.出诊日期 Between Trunc(Sysdate) And
                                  Trunc(Sysdate) + Nvl(n_查询天数, Nvl(c.预约天数, n_预约天数) + n_补充天数) And a.开始时间 >= d_启用时间 And
                                  Nvl(a.是否发布, 0) = 1
                                 --排除全时段停诊了的
                                  And (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) And Nvl(a.停诊开始时间, a.终止时间) > Sysdate Or
                                  a.终止时间 > Nvl(a.停诊终止时间, a.开始时间) And a.终止时间 > Sysdate Or Exists
                                   (Select 1
                                        From 临床出诊序号控制
                                        Where 记录id = a.Id And Nvl(是否停诊, 0) = 0 And Nvl(a.是否序号控制, 0) = 1 And
                                              Nvl(a.是否分时段, 0) = 1 And 开始时间 <> 终止时间 And 开始时间 >= Sysdate))
                                 --临床出诊记录.预约控制：0-不作预约限制;1-该号别禁止预约;2-仅禁止三方机构平台的预约
                                  And
                                  (Not Exists (Select 1
                                               From 临床出诊挂号控制记录
                                               Where 记录id = a.Id And 性质 = 1 And 类型 = 1 And 名称 = v_合作单位) Or Exists
                                   (Select 1
                                    From 临床出诊挂号控制记录
                                    Where 记录id = a.Id And 性质 = 1 And 类型 = 1 And 名称 = v_合作单位
                                         --临床出诊挂号控制记录.控制方式：0-禁止预约;1-按比例控制预约;2-按总量控制预约;3-按序号控制预约;4-不作限制
                                          And (控制方式 In (1, 2, 3) And 数量 <> 0 Or 控制方式 = 4)))
                                 
                                  And (c.撤档时间 Is Null Or c.撤档时间 >= To_Date('3000-01-01', 'yyyy-mm-dd')) And
                                  Nvl(d.站点, v_站点) = v_站点 And
                                  (d.撤档时间 Is Null Or d.撤档时间 >= To_Date('3000-01-01', 'yyyy-mm-dd')))
                     Group By 科室id, 名称) Loop
        v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>';
        v_Temp := v_Temp || '<ZDYYTS>' || r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
        Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      End Loop;
    End If;
  End If;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getdeptlist;
/
Create Or Replace Procedure Zl_Third_Getnolist
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取号源列表(简易模式)
  --入参:Xml_In:
  --<IN>
  --  <RQ>日期</RQ>
  --  <KSID>科室ID</KSID>
  --  <YSID>医生ID</YSID>
  --  <YSXM>医生姓名</YSXM>
  --  <HZDW>支付宝</HZDW>    //合作单位，传入了的时候，只取合作单位的号;为空时，只取非合作单位的号
  --  <FKFS>付款方式</FKFS>  
  --  <SJJG>60</SJJG>     //时间间隔,不传则返回序号时段
  --  <ZD></ZD>           //站点
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --  <GROUP>
  --    <RQ>日期</RQ>
  --    <HBLIST>
  --     <HB>
  --        <CZJLID>1</CZJLID>     //出诊记录ID
  --        <APID></APID>          //挂号安排ID
  --        <JHID></JHID>          //挂号计划ID
  --        <HM>235</HM>       //号码
  --        <YSID>549</YSID>      //医生ID
  --        <YS>张锐</YS>       //医生姓名
  --        <KSID>123</KSID>   //科室ID
  --        <KSMC>内科</KSMC>   //科室名称
  --        <ZC>主治医师</ZC> //职称
  --        <XMID>10086<XMID> //挂号项目的ID
  --        <XMMC>挂号费</XMMC> //挂号项目的名称
  --        <YGHS>0</YGHS>      //已挂号数
  --        <SYHS>99</SYHS>   //剩余号数
  --        <PRICE>15</PRICE>      //价格
  --        <HL>普通</HL>       //挂号类型
  --        <HCXH>1</HCXH>    //是否存在缓冲序号时间段，1-存在 0或者空-不存在
  --        <FSD>0</FSD>      //是否分时段
  --        <FWMC>白天</FWMC>     //号别时段
  --        <HBTIME>(08:00-17:59)</HBTIME> //可挂时间
  --     <SPANLIST>
  --            <SPAN>
  --                  <SJD></SJD>          //时间段,格式:hh24:mi-hh24:mi
  --                  <GHZS></GHZS>      //时段挂号总数
  --                  <SL></SL>      //剩余数量
  --            </SPAN>
  --            ……
  --          </SPANLIST>
  --      </HB>
  --      <HB>
  --      ……
  --      </HB>
  --    </HBLIST>
  --  </GROUP>
  --</OUTPUT>
  --
  --“序号时段”<SPANLIST>和“剩余号数”<SYHS>节点说明：
  --  1.出诊表排班模式：
  --    1.1启用分时段，同时启用序号控制
  --      1.1.1传入合作单位
  --          1）当日：
  --                  序号时段：按比例或按总量时，号源剩余的可挂号时段；按序号时，分配给该合作单位剩余的可预约时段
  --                  剩余号数：分配给该合作单位剩余的可预约数量
  --          2）当日以后：
  --                  序号时段：按比例或按总量时，号源剩余的可预约时段；按序号时，分配给该合作单位剩余的可预约时段
  --                  剩余号数：分配给该合作单位剩余的可预约数量
  --      1.1.2不传入合作单位
  --          1）当日：
  --                  序号时段：号源剩余的可挂号时段
  --                  剩余号数：号源剩余的可挂号数量
  --          2）当日以后：
  --                  序号时段：号源剩余的可预约时段
  --                  剩余号数：号源剩余的可预约数量
  --------------------------------------------------------------------------------------------------
  x_Templet Xmltype; --模板XML

  d_日期     临床出诊记录.出诊日期%Type;
  n_科室id   挂号安排.科室id%Type;
  n_医生id   挂号安排.医生id%Type;
  v_医生姓名 挂号安排.医生姓名%Type;
  v_合作单位 挂号合作单位.名称%Type;
  n_时间间隔 挂号安排.默认时段间隔%Type;

  v_挂号模式 Varchar2(500);
  n_挂号模式 Number(3);
  d_启用时间 Date;
  n_预约天数 挂号安排.预约天数%Type;
  n_补充天数 挂号安排.预约天数%Type;

  v_剩余数量 挂号安排时段.限制数量%Type;
  n_禁用     Number(3);
  v_Temp     Varchar2(32767); --临时XML
  c_Xmlmain  Clob; --临时XML 
  v_Xmlmain  Clob; --临时XML 

  d_时段开始 挂号安排时段.开始时间%Type;
  d_时段结束 挂号安排时段.结束时间%Type;
  n_时段总数 挂号安排时段.限制数量%Type;
  n_时段剩余 挂号安排时段.限制数量%Type;
  n_时段已挂 挂号安排时段.限制数量%Type;

  v_星期         挂号安排限制.限制项目%Type;
  v_时间段       Varchar2(100);
  n_分时段       Number(3);
  n_单个剩余     Number(5);
  n_已挂数       Number(5);
  n_合约已挂数   Number(5);
  n_合计金额     收费价目.现价%Type;
  n_合约总数量   Number(5);
  n_合约剩余数量 Number(5);
  n_最大可用数量 Number(5);
  n_合约模式     Number(3); --合约模式:1-合约单位限数量模式 0-合约单位指定序号模式
  n_非合约       Number(3);
  n_是否预留     Number(3);

  d_开始时间 临床出诊记录.开始时间%Type;
  d_终止时间 临床出诊记录.终止时间%Type;
  d_加号时间 临床出诊记录.开始时间%Type;

  n_缓冲序号 Number(3);
  n_时段数量 Number(5);
  n_预留数量 Number(5);
  n_特殊预约 Number(3);
  v_Timetemp Varchar2(100);
  n_Exists   Number(5);

  v_普通等级   Varchar2(100);
  v_Pricegrade Varchar2(500);
  v_站点       部门表.站点%Type;
  v_付款方式   医疗付款方式.名称%Type;
  v_方式       Varchar2(20);
  n_严格按时段挂号 Number(1);
  n_剩余有效 Number(3);

  v_Err_Msg Varchar2(200);
  Err_Item Exception;

  --获取序号时段XML
  Function Gettimexml
  (
    时段开始_In 临床出诊序号控制.开始时间%Type,
    时段结束_In 临床出诊序号控制.终止时间%Type,
    时段总数_In 临床出诊序号控制.数量%Type,
    时段剩余_In 临床出诊序号控制.数量%Type
  ) Return Varchar2 Is
    v_Temp Varchar2(4000);
  Begin
    v_Temp := '';
    v_Temp := v_Temp || '<SPAN>';
    v_Temp := v_Temp || '<SJD>' || To_Char(时段开始_In, 'hh24:mi:ss') || '-' || To_Char(时段结束_In, 'hh24:mi:ss') || '</SJD>';
    v_Temp := v_Temp || '<GHZS>' || 时段总数_In || '</GHZS>';
    v_Temp := v_Temp || '<SL>' || 时段剩余_In || '</SL>';
    v_Temp := v_Temp || '</SPAN>';
    Return v_Temp;
  End;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select To_Date(Extractvalue(Value(A), 'IN/RQ'), 'YYYY-MM-DD hh24:mi:ss'), Extractvalue(Value(A), 'IN/KSID'),
         Extractvalue(Value(A), 'IN/YSID'), Extractvalue(Value(A), 'IN/YSXM'), Extractvalue(Value(A), 'IN/HZDW'),
         Extractvalue(Value(A), 'IN/SJJG'), Extractvalue(Value(A), 'IN/ZD'), Extractvalue(Value(A), 'IN/FKFS')
  Into d_日期, n_科室id, n_医生id, v_医生姓名, v_合作单位, n_时间间隔, v_站点, v_方式
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --日期节点为空的情况
  d_日期 := Nvl(d_日期, Trunc(Sysdate));

  If v_方式 Is Null Then
    Select Max(名称) Into v_付款方式 From 医疗付款方式 Where 缺省标志 = 1;
  Else
    Select Nvl(Max(名称), v_方式) Into v_付款方式 From 医疗付款方式 Where 编码 = v_方式;
  End If;
  v_Pricegrade := Zl_Get_Pricegrade(v_站点, Null, Null, v_付款方式);
  v_普通等级   := Substr(v_Pricegrade, 1, Instr(v_Pricegrade, '|') - 1);

  v_挂号模式 := zl_GetSysParameter('挂号排班模式') || '|||';
  n_挂号模式 := To_Number(Substr(v_挂号模式, 1, Instr(v_挂号模式, '|') - 1));
  If n_挂号模式 = 1 Then
    v_挂号模式 := Substr(v_挂号模式, Instr(v_挂号模式, '|') + 1);
    v_Temp     := Substr(v_挂号模式, 1, Instr(v_挂号模式, '|') - 1);
    d_启用时间 := To_Date(Nvl(v_Temp, '1900-01-01'), 'yyyy-mm-dd hh24:mi:ss');
    If d_日期 < d_启用时间 Then
      n_挂号模式 := 0;
    End If;
  End If;

  n_严格按时段挂号 := Nvl(zl_GetSysParameter('严格按时段挂号', 1111), 0);
  n_预约天数 := Nvl(zl_GetSysParameter(66), 7);
  c_Xmlmain  := '';

  --===========================================================================================
  --计划排班模式 
  --===========================================================================================
  If n_挂号模式 = 0 Then
    Select Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7', '周六', Null)
    Into v_星期
    From Dual;
    n_合约剩余数量 := 0;
  
    For r_No In (Select a.科室id, a.号类, a.科室名称, a.医生姓名, a.医生id, a.职称, a.号码, a.安排id, a.计划id, a.排班, a.项目id, a.项目名称, a.序号控制,
                        a.限号数, a.限约数, a.预约天数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数, Nvl(Hz.其中已接收, 0) As 已接收,
                        Sum(b.现价) As 价格
                 From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称, Ap.号码,
                               Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数, Ap.预约天数
                        From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                      Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                      Decode(To_Char(d_日期, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4', Ap.周三, '5', Ap.周四,
                                              '6', Ap.周五, '7', Ap.周六, Null) As 排班, Xz.限约数, Xz.限号数,
                                      Nvl(Ap.预约天数, n_预约天数) As 预约天数
                               From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                               Where Ap.科室id = Bm.Id(+) And Decode(Nvl(n_科室id, 0), 0, 0, Ap.科室id) = Nvl(n_科室id, 0) And
                                     Decode(Nvl(n_医生id, 0), 0, 0, Ap.医生id) = Nvl(n_医生id, 0) And
                                     Decode(Nvl(v_医生姓名, '-'), '-', '-', Ap.医生姓名) = Nvl(v_医生姓名, '-') And Ap.停用日期 Is Null And
                                     d_日期 Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                     Nvl(Ap.终止时间, To_Date('3000 - 01 - 01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                     Xz.限制项目(+) = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                         '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                (Select Rownum
                                      From 挂号安排停用状态 Ty
                                      Where Ty.安排id = Ap.Id And d_日期 Between Ty.开始停止时间 And Ty.结束停止时间) And Not Exists
                                (Select Rownum
                                      From 挂号安排计划 Jh
                                      Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                            d_日期 Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                            Jh.失效时间)
                               Union All
                               Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id, Jh.Id As 计划id,
                                      Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                      Decode(To_Char(d_日期, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4', Jh.周三, '5', Jh.周四,
                                              '6', Jh.周五, '7', Jh.周六, Null) As 排班, Xz.限约数, Xz.限号数,
                                      Nvl(Ap.预约天数, n_预约天数) As 预约天数
                               From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                               Where Jh.安排id = Ap.Id And Ap.科室id = Bm.Id(+) And Ap.停用日期 Is Null And
                                     Decode(Nvl(n_科室id, 0), 0, 0, Ap.科室id) = Nvl(n_科室id, 0) And
                                     Decode(Nvl(n_医生id, 0), 0, 0, Jh.医生id) = Nvl(n_医生id, 0) And
                                     Decode(Nvl(v_医生姓名, '-'), '-', '-', Jh.医生姓名) = Nvl(v_医生姓名, '-') And
                                     d_日期 Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                     Jh.失效时间 And Xz.计划id(+) = Jh.Id And
                                     Xz.限制项目(+) = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                         '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                (Select Rownum
                                      From 挂号安排停用状态 Ty
                                      Where Ty.安排id = Ap.Id And d_日期 Between Ty.开始停止时间 And Ty.结束停止时间) And
                                     (Jh.生效时间, Jh.安排id) =
                                     (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                      From 挂号安排计划 Sxjh
                                      Where Sxjh.审核时间 Is Not Null And
                                            d_日期 Between Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                            Sxjh.失效时间 And Sxjh.安排id = Jh.安排id
                                      Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                        Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                      病人挂号汇总 Hz, 收费价目 B
                 Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_日期) And a.项目id = b.收费细目id And
                       Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-Mm-DD')) > d_日期 And b.执行日期 <= d_日期 And
                       (b.价格等级 = v_普通等级 Or (b.价格等级 Is Null And Not Exists
                        (Select 1
                                             From 收费价目
                                             Where 收费细目id = b.收费细目id And 价格等级 = v_普通等级 And d_日期 Between 执行日期 And
                                                   Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')))))
                 Group By a.科室id, a.号类, a.科室名称, a.医生姓名, a.医生id, a.职称, a.号码, a.安排id, a.计划id, a.排班, a.项目id, a.项目名称, a.序号控制,
                          a.限号数, a.限约数, a.预约天数, Nvl(Hz.已挂数, 0), Nvl(Hz.已约数, 0), Nvl(Hz.其中已接收, 0)) Loop
      Zl_挂号序号状态_Delete(1, r_No.号码);
      If Sysdate + Nvl(r_No.预约天数, n_预约天数) >= d_日期 Then
        If r_No.计划id <> 0 Then
          Select Sign(Count(Rownum))
          Into n_分时段
          From 挂号安排计划 Jh, 挂号计划时段 Sd
          Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And
                Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7',
                               '周六', Null) And Rownum < 2;
        Else
          Select Sign(Count(Rownum))
          Into n_分时段
          From 挂号安排 Ap, 挂号安排时段 Sd
          Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And
                Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7',
                               '周六', Null) And Rownum < 2;
        End If;
        --分时段不序号控制当天号为普通号
        If Trunc(Sysdate) = Trunc(d_日期) And n_分时段 = 1 And r_No.序号控制 = 0 Then
          n_分时段 := 0;
        End If;
        If n_分时段 = 0 Then
          v_Temp := '';
          If v_合作单位 Is Not Null And r_No.序号控制 = 1 Then
            If r_No.计划id <> 0 Then
              Select Nvl(Sum(数量), 0)
              Into n_合约总数量
              From 合作单位计划控制
              Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
              Select Count(1)
              Into n_合约模式
              From 合作单位计划控制
              Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 序号 = 0;
            Else
              Select Nvl(Sum(数量), 0)
              Into n_合约总数量
              From 合作单位安排控制
              Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
              Select Count(1)
              Into n_合约模式
              From 合作单位安排控制
              Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 序号 = 0;
            End If;
            If n_合约模式 = 0 Then
              If r_No.计划id <> 0 Then
                Select Count(1)
                Into n_合约已挂数
                From 病人挂号记录 A
                Where 号别 = r_No.号码 And 记录状态 = 1 And 发生时间 Between Trunc(d_日期) And Trunc(d_日期 + 1) - 1 / 60 / 60 / 24 And
                      Exists
                 (Select 1
                       From 合作单位计划控制
                       Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And
                             限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                           '周五', '7', '周六', Null) And 序号 = a.号序 And 数量 <> 0);
              Else
                Select Count(1)
                Into n_合约已挂数
                From 病人挂号记录 A
                Where 号别 = r_No.号码 And 记录状态 = 1 And 发生时间 Between Trunc(d_日期) And Trunc(d_日期 + 1) - 1 / 60 / 60 / 24 And
                      Exists
                 (Select 1
                       From 合作单位安排控制
                       Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And
                             限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                           '周五', '7', '周六', Null) And 序号 = a.号序 And 数量 <> 0);
              End If;
            Else
              Select Count(1)
              Into n_合约已挂数
              From 病人挂号记录
              Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                    Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
            End If;
            If n_合约总数量 = 0 Then
              n_合约剩余数量 := 0;
            Else
              n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
              If n_合约剩余数量 > (Nvl(r_No.限号数, 0) - r_No.已挂数) Then
                n_合约剩余数量 := Nvl(r_No.限号数, 0) - r_No.已挂数;
              End If;
            End If;
          End If;
        Else
          v_Temp := '<SPANLIST>';
          If r_No.计划id <> 0 Then
            Select To_Date(To_Char(d_日期, 'yyyy-mm-dd') || To_Char(Max(结束时间), 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
            Into d_加号时间
            From 挂号计划时段
            Where 计划id = r_No.计划id And 星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                   '周四', '6', '周五', '7', '周六', Null);
            If r_No.序号控制 = 1 Then
              If Trunc(d_日期) = Trunc(Sysdate) Then
                n_特殊预约 := 0;
              Else
                Select Nvl(Max(Jh.是否预约), 0)
                Into n_特殊预约
                From (Select Sd.计划id, Sd.序号, Sd.星期, Jh.号码,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                       From 挂号安排计划 Jh, 挂号计划时段 Sd
                       Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And
                             Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                            '周五', '7', '周六', Null)) Jh, 挂号序号状态 Zt
                Where Trunc(Zt.日期(+)) = Trunc(Jh.开始时间) And Zt.号码(+) = Jh.号码 And Zt.序号(+) = Jh.序号 And
                      Decode(Sign(Sysdate - Jh.开始时间), -1, 0, 1) <> 1;
              End If;
            
              d_时段开始 := Null;
              d_时段结束 := Null;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              For r_Time In (Select Jh.号码, Jh.序号, Jh.星期, Jh.开始时间, Jh.结束时间, Jh.限制数量, Jh.是否预约, 0 As 已约数,
                                    Decode(Nvl(Zt.序号, 0), 0, 1, 0) As 剩余数,
                                    Decode(Sign(Sysdate - Jh.开始时间), -1, 0, 1) As 失效时段
                             From (Select Sd.计划id, Sd.序号, Sd.星期, Jh.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排计划 Jh, 挂号计划时段 Sd
                                    Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Jh.安排id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Jh, 挂号序号状态 Zt
                             Where Trunc(Zt.日期(+)) = Trunc(Jh.开始时间) And Zt.号码(+) = Jh.号码 And Zt.序号(+) = Jh.序号
                             Order By 序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Select Nvl(Max(1), 0)
                  Into n_合约模式
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = 0 And 合作单位 = v_合作单位;
                Else
                  n_合约模式 := 0;
                End If;
                If r_Time.剩余数 = 0 Then
                  n_单个剩余 := 0;
                Else
                  n_单个剩余 := r_Time.限制数量;
                End If;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                      End If;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位计划控制
                    Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_合约剩余数量 := n_合约剩余数量 + 1;
                      End If;
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            Else
              n_最大可用数量 := Nvl(r_No.限约数, Nvl(r_No.限号数, 0)) - Nvl(r_No.已约数, 0);
              n_时段总数     := 0;
              n_时段剩余     := 0;
              d_时段开始     := Null;
              d_时段结束     := Null;
              For r_Time In (Select Jh.号码, Jh.序号, Jh.星期, Jh.开始时间, Jh.结束时间, Jh.限制数量, Jh.是否预约,
                                    Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 已约数,
                                    Jh.限制数量 - Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 剩余数,
                                    Decode(Sign(Sysdate - Jh.开始时间), -1, 0, 1) As 失效时段
                             From (Select Sd.计划id, Sd.序号, Sd.星期, Jh.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排计划 Jh, 挂号计划时段 Sd
                                    Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Jh.安排id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Jh, 挂号序号状态 Zt
                             Where Jh.号码 = Zt.号码(+) And Trunc(Zt.日期(+)) = Trunc(Jh.开始时间) And
                                   Jh.序号 = Substr(Zt.序号(+), 1, Length(Zt.序号(+)) - Length(Nvl(r_No.限号数, 0)))
                             Group By Jh.号码, Jh.序号, Jh.星期, Jh.开始时间, Jh.结束时间, Jh.限制数量, Jh.是否预约
                             Order By Jh.序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Select Nvl(Max(1), 0)
                  Into n_合约模式
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = 0 And 合作单位 = v_合作单位;
                Else
                  n_合约模式 := 0;
                End If;
                n_单个剩余 := r_Time.剩余数;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_最大可用数量;
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位计划控制
                    Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_最大可用数量, 0);
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_单个剩余, 0);
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            End If;
          Else
            Select To_Date(To_Char(d_日期, 'yyyy-mm-dd') || To_Char(Max(结束时间), 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
            Into d_加号时间
            From 挂号安排时段
            Where 安排id = r_No.安排id And 星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                   '周四', '6', '周五', '7', '周六', Null);
            If r_No.序号控制 = 1 Then
              If Trunc(d_日期) = Trunc(Sysdate) Then
                n_特殊预约 := 0;
              Else
                Select Nvl(Max(Ap.是否预约), 0)
                Into n_特殊预约
                From (Select Sd.安排id, Sd.序号, Sd.星期, Ap.号码,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                       From 挂号安排 Ap, 挂号安排时段 Sd
                       Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And
                             Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                            '周五', '7', '周六', Null)) Ap, 挂号序号状态 Zt
                Where Trunc(Zt.日期(+)) = Trunc(Ap.开始时间) And Zt.号码(+) = Ap.号码 And Zt.序号(+) = Ap.序号 And
                      Decode(Sign(Sysdate - Ap.开始时间), -1, 0, 1) <> 1;
              End If;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              For r_Time In (Select Ap.号码, Ap.序号, Ap.星期, Ap.开始时间, Ap.结束时间, Ap.限制数量, Ap.是否预约, 0 As 已约数,
                                    Decode(Nvl(Zt.序号, 0), 0, 1, 0) As 剩余数,
                                    Decode(Sign(Sysdate - Ap.开始时间), -1, 0, 1) As 失效时段
                             
                             From (Select Sd.安排id, Sd.序号, Sd.星期, Ap.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排 Ap, 挂号安排时段 Sd
                                    Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Ap.Id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Ap, 挂号序号状态 Zt
                             Where Trunc(Zt.日期(+)) = Trunc(Ap.开始时间) And Zt.号码(+) = Ap.号码 And Zt.序号(+) = Ap.序号
                             Order By 序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Begin
                    Select 1
                    Into n_合约模式
                    From 合作单位安排控制
                    Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = 0 And 合作单位 = v_合作单位;
                  Exception
                    When Others Then
                      n_合约模式 := 0;
                  End;
                Else
                  n_合约模式 := 0;
                End If;
                If r_Time.剩余数 = 0 Then
                  n_单个剩余 := 0;
                Else
                  n_单个剩余 := r_Time.限制数量;
                End If;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                      End If;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位安排控制
                    Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_合约剩余数量 := n_合约剩余数量 + n_单个剩余;
                      End If;
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            Else
              n_最大可用数量 := Nvl(r_No.限约数, Nvl(r_No.限号数, 0)) - Nvl(r_No.已约数, 0);
              n_时段总数     := 0;
              n_时段剩余     := 0;
              d_时段开始     := Null;
              d_时段结束     := Null;
              For r_Time In (Select Ap.号码, Ap.序号, Ap.星期, Ap.开始时间, Ap.结束时间, Ap.限制数量, Ap.是否预约,
                                    Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 已约数,
                                    Ap.限制数量 - Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 剩余数,
                                    Decode(Sign(Sysdate - Ap.开始时间), -1, 0, 1) As 失效时段
                             From (Select Sd.安排id, Sd.序号, Sd.星期, Ap.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排 Ap, 挂号安排时段 Sd
                                    Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Ap.Id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Ap, 挂号序号状态 Zt
                             Where Ap.号码 = Zt.号码(+) And Trunc(Zt.日期(+)) = Trunc(Ap.开始时间) And
                                   Ap.序号 = Substr(Zt.序号(+), 1, Length(Zt.序号(+)) - Length(Nvl(r_No.限号数, 0)))
                             Group By Ap.号码, Ap.序号, Ap.星期, Ap.开始时间, Ap.结束时间, Ap.限制数量, Ap.是否预约
                             Order By Ap.序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Select Nvl(Max(1), 0)
                  Into n_合约模式
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = 0 And 合作单位 = v_合作单位;
                Else
                  n_合约模式 := 0;
                End If;
                n_单个剩余 := r_Time.剩余数;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_最大可用数量;
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位安排控制
                    Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_最大可用数量, 0);
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_单个剩余, 0);
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            End If;
          End If;
        End If;
        If v_合作单位 Is Not Null Then
          If Nvl(r_No.计划id, 0) <> 0 Then
            Begin
              Select 0
              Into n_非合约
              From 合作单位计划控制
              Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And Rownum < 2;
            Exception
              When Others Then
                n_非合约 := 1;
            End;
          Else
            Begin
              Select 0
              Into n_非合约
              From 合作单位安排控制
              Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And Rownum < 2;
            Exception
              When Others Then
                n_非合约 := 1;
            End;
          End If;
        End If;
        If v_合作单位 Is Null Or n_非合约 = 1 Then
          If r_No.限号数 = 0 Then
            v_剩余数量 := '';
          Else
            If Nvl(r_No.计划id, 0) <> 0 Then
              Select Sum(数量)
              Into n_合约总数量
              From 合作单位计划控制
              Where 计划id = r_No.计划id And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
            Else
              Select Sum(数量)
              Into n_合约总数量
              From 合作单位安排控制
              Where 安排id = r_No.安排id And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
            End If;
            Select Count(1)
            Into n_合约已挂数
            From 病人挂号记录
            Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_日期) And
                  Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
            Select Count(1)
            Into n_预留数量
            From 挂号序号状态
            Where 状态 = 3 And 号码 = r_No.号码 And Trunc(日期) = Trunc(d_日期);
            If Trunc(d_日期) = Trunc(Sysdate) Then
              If Nvl(n_合约总数量, 0) = 0 Then
                v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_预留数量;
              Else
                v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_合约总数量 + n_合约已挂数 - n_预留数量;
              End If;
              n_已挂数 := r_No.已挂数;
              If Nvl(n_时段数量, 0) < v_剩余数量 And n_分时段 <> 0 Then
                If n_严格按时段挂号 = 1 Then
                  v_剩余数量 := Nvl(n_时段数量, 0) + Nvl(n_合约剩余数量, 0);
                  n_缓冲序号 := 0;
                Else
                  n_缓冲序号 := 1;
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD>' ||
                                '<SL>' || To_Number(v_剩余数量 - Nvl(n_时段数量, 0) - Nvl(n_合约剩余数量, 0)) || '</SL>' || '</SPAN>';
                End If;
              Else
                n_缓冲序号 := 0;
              End If;
            Else
              If Nvl(n_合约总数量, 0) = 0 Then
                v_剩余数量 := r_No.限约数 - r_No.已约数 - n_预留数量;
                If v_剩余数量 Is Null Then
                  v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_预留数量;
                End If;
              Else
                v_剩余数量 := r_No.限约数 - r_No.已约数 - n_合约总数量 + n_合约已挂数 - n_预留数量;
                If v_剩余数量 Is Null Then
                  v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_合约总数量 + n_合约已挂数 - n_预留数量;
                End If;
              End If;
              n_已挂数 := r_No.已挂数;
            End If;
          End If;
        Else
          If Nvl(r_No.计划id, 0) <> 0 Then
            If v_合作单位 Is Not Null Then
              Select Nvl(Max(1), 0)
              Into n_合约模式
              From 合作单位计划控制
              Where 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 计划id = r_No.计划id And 序号 = 0 And 合作单位 = v_合作单位;
            Else
              n_合约模式 := 0;
            End If;
            Select Sum(数量)
            Into n_合约总数量
            From 合作单位计划控制
            Where 计划id = r_No.计划id And 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                     '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
          Else
            If v_合作单位 Is Not Null Then
              Select Nvl(Max(1), 0)
              Into n_合约模式
              From 合作单位安排控制
              Where 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 安排id = r_No.安排id And 序号 = 0 And 合作单位 = v_合作单位;
            Else
              n_合约模式 := 0;
            End If;
            Select Sum(数量)
            Into n_合约总数量
            From 合作单位安排控制
            Where 安排id = r_No.安排id And 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                     '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
          End If;
          If n_合约模式 = 0 Then
            v_剩余数量   := n_合约剩余数量;
            n_已挂数     := r_No.已挂数;
            n_合约已挂数 := Nvl(n_合约总数量, 0) - n_合约剩余数量;
          Else
            n_已挂数 := r_No.已挂数;
            Select Count(1)
            Into n_合约已挂数
            From 病人挂号记录
            Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                  Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
                  
            If n_分时段 = 1 And n_严格按时段挂号 = 1 And trunc(d_日期) = trunc(Sysdate) Then
              Select Sum(a.限制数量) into n_剩余有效
              From 挂号安排时段 a
              Where a.安排id = r_No.安排ID And a.星期 = Decode(To_Char(d_日期, 'D'),
                                                       '1','周日','2','周一','3','周二','4','周三','5','周四','6','周五','7','周六',Null) And
                    To_Date(To_Char(Sysdate, 'yyyy-mm-dd') || ' ' || To_Char(a.开始时间, 'hh24:mi:ss'),
                            'yyyy-mm-dd hh24:mi:ss') > Sysdate;
            End If;
            
            If Nvl(n_合约总数量, 0) = 0 Then
              v_剩余数量 := '0';
            Else
              v_剩余数量 := n_合约总数量 - n_合约已挂数;
              If To_Number(v_剩余数量) > n_剩余有效 And n_剩余有效 Is Not Null Then
                v_剩余数量 := n_剩余有效;
              End If;
            End If;
          End If;
        End If;
        Select To_Char(开始时间, 'hh24:mi') Into v_Timetemp From 时间段 Where 时间段 = r_No.排班;
        v_时间段 := v_Timetemp || '-';
        Select To_Char(终止时间, 'hh24:mi') Into v_Timetemp From 时间段 Where 时间段 = r_No.排班;
        v_时间段 := v_时间段 || v_Timetemp;
        If v_Temp Is Not Null Then
          v_Temp := v_Temp || '</SPANLIST>';
        End If;
        If v_合作单位 Is Not Null Then
          If Nvl(r_No.计划id, 0) <> 0 Then
            Select Nvl(Max(1), 0)
            Into n_禁用
            From 合作单位计划控制
            Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And 数量 = 0 And Rownum < 2;
          Else
            Select Nvl(Max(1), 0)
            Into n_禁用
            From 合作单位安排控制
            Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And 数量 = 0 And Rownum < 2;
          End If;
        End If;
        --限约数=0的预约禁止
        If Trunc(d_日期) <> Trunc(Sysdate) Then
          If r_No.限约数 = 0 Then
            n_禁用 := 1;
          End If;
        End If;
        If Nvl(n_禁用, 0) = 0 Then
          --从项金额计算
          n_合计金额 := r_No.价格;
          For r_Subfee In (Select 现价, 从项数次
                           From 收费从属项目 A, 收费价目 B
                           Where a.主项id = r_No.项目id And a.从项id = b.收费细目id And d_日期 Between b.执行日期 And
                                 Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                                 (b.价格等级 = v_普通等级 Or
                                 (b.价格等级 Is Null And Not Exists
                                  (Select 1
                                    From 收费价目
                                    Where 收费细目id = b.收费细目id And 价格等级 = v_普通等级 And d_日期 Between 执行日期 And
                                          Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')))))) Loop
            n_合计金额 := n_合计金额 + r_Subfee.现价 * r_Subfee.从项数次;
          End Loop;
          If Trunc(Sysdate) = Trunc(d_日期) Then
            Select Nvl(Max(1), 0)
            Into n_Exists
            From (Select 时间段
                   From 时间段
                   Where ('3000-01-10 ' || To_Char(Sysdate, 'HH24:MI:SS') < '3000-01-10 ' || To_Char(终止时间, 'HH24:MI:SS')) Or
                         ('3000-01-10 ' || To_Char(Sysdate, 'HH24:MI:SS') <
                         Decode(Sign(开始时间 - 终止时间), 1, '3000-01-11 ' || To_Char(终止时间, 'HH24:MI:SS'),
                                 '3000-01-10 ' || To_Char(终止时间, 'HH24:MI:SS'))))
            Where 时间段 = r_No.排班;
          Else
            n_Exists := 1;
          End If;
          If n_Exists = 1 Then
            If v_剩余数量 > 0 Then
              c_Xmlmain := '<HB>' || '<APID>' || r_No.安排id || '</APID>' || '<JHID>' || r_No.计划id || '</JHID>' || '<HM>' ||
                           r_No.号码 || '</HM>' || '<YSID>' || r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' ||
                           '<KSID>' || r_No.科室id || '</KSID>' || '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' ||
                           r_No.职称 || '</ZC>' || '<XMID>' || r_No.项目id || '</XMID>' || '<XMMC>' || r_No.项目名称 ||
                           '</XMMC>' || '<YGHS>' || n_已挂数 || '</YGHS>' || '<SYHS>' || v_剩余数量 || '</SYHS>' || '<PRICE>' ||
                           n_合计金额 || '</PRICE>' || '<HCXH>' || n_缓冲序号 || '</HCXH>' || '<HL>' || r_No.号类 || '</HL>' ||
                           '<FSD>' || n_分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' || '<FWMC>' || r_No.排班 ||
                           '</FWMC>' || v_Temp || '</HB>';
            Else
              c_Xmlmain := '<HB>' || '<APID>' || r_No.安排id || '</APID>' || '<JHID>' || r_No.计划id || '</JHID>' || '<HM>' ||
                           r_No.号码 || '</HM>' || '<YSID>' || r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' ||
                           '<KSID>' || r_No.科室id || '</KSID>' || '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' ||
                           r_No.职称 || '</ZC>' || '<XMID>' || r_No.项目id || '</XMID>' || '<XMMC>' || r_No.项目名称 ||
                           '</XMMC>' || '<YGHS>' || n_已挂数 || '</YGHS>' || '<SYHS>' || v_剩余数量 || '</SYHS>' || '<PRICE>' ||
                           n_合计金额 || '</PRICE>' || '<HL>' || r_No.号类 || '</HL>' || '<FSD>' || n_分时段 || '</FSD>' ||
                           '<HBTIME>' || v_时间段 || '</HBTIME>' || '<FWMC>' || r_No.排班 || '</FWMC>' || '</HB>';
            End If;
            v_Xmlmain := v_Xmlmain || c_Xmlmain;
          End If;
        End If;
      End If;
      n_合约剩余数量 := 0;
      n_合约总数量   := 0;
      n_时段数量     := 0;
      n_禁用         := 0;
      n_非合约       := 0;
    End Loop;
  
    v_Xmlmain := '<GROUP>' || '<RQ>' || To_Char(d_日期, 'yyyy-mm-dd') || '</RQ>' || '<HBLIST>' || v_Xmlmain ||
                 '</HBLIST>' || '</GROUP>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Xmlmain)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
    Return;
  End If;

  --===========================================================================================
  --出诊表排班模式 
  --===========================================================================================
  n_合约剩余数量 := 0;
  n_补充天数     := Zl_Fun_Getappointmentdays;
  --注意出诊记录停用了，但可能启用了部分时段
  --临床出诊序号控制 中，开始时间与终止时间相等的是加号的序号
  --记录性质：1-正常出诊记录,2-替诊出诊记录
  For r_No In (Select a.记录性质, a.记录id, a.号源id, b.号类, b.号码, a.科室id, c.名称 As 科室名称, a.项目id, e.名称 As 项目名称, a.医生id, a.医生姓名,
                      d.专业技术职务 As 职称, a.排班, a.开始时间, a.终止时间, a.序号控制, a.分时段, a.预约控制, a.限号数, a.限约数, a.已挂数, a.已约数, a.已接收,
                      a.替诊开始时间, a.替诊终止时间, a.停诊开始时间, a.停诊终止时间, Nvl(b.预约天数, n_预约天数) + n_补充天数 As 预约天数
               From (Select 1 As 记录性质, a.Id As 记录id, a.号源id, a.科室id, a.项目id, a.医生id, a.医生姓名, a.上班时段 As 排班, a.开始时间, a.终止时间,
                             Nvl(a.是否序号控制, 0) As 序号控制, Nvl(a.是否分时段, 0) As 分时段, a.预约控制, a.限号数, Nvl(a.限约数, a.限号数) As 限约数,
                             Nvl(a.已挂数, 0) As 已挂数, Nvl(a.已约数, 0) As 已约数, Nvl(a.其中已接收, 0) As 已接收, a.替诊开始时间, a.替诊终止时间,
                             a.停诊开始时间, a.停诊终止时间
                      From 临床出诊记录 A
                      Where Nvl(a.是否发布, 0) = 1 And Nvl(a.是否锁定, 0) = 0 And
                            (a.开始时间 < Nvl(a.替诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.替诊终止时间, a.开始时间)) And a.开始时间 > Trunc(d_启用时间) And
                            a.终止时间 > Sysdate And
                            (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) And Nvl(a.停诊开始时间, a.终止时间) > Sysdate Or
                             a.终止时间 > Nvl(a.停诊终止时间, a.开始时间) And a.终止时间 > Sysdate Or Exists
                             (Select 1
                              From 临床出诊序号控制
                              Where 记录id = a.Id And Nvl(是否停诊, 0) = 0 And Nvl(a.是否序号控制, 0) = 1 And Nvl(a.是否分时段, 0) = 1 And
                                    开始时间 <> 终止时间 And 开始时间 >= Sysdate)) And
                            Decode(Nvl(n_医生id, 0), 0, 0, a.医生id) = Nvl(n_医生id, 0) And
                            Decode(Nvl(v_医生姓名, '-'), '-', '-', a.医生姓名) = Nvl(v_医生姓名, '-') And
                            Decode(Nvl(n_科室id, 0), 0, 0, a.科室id) = Nvl(n_科室id, 0) And a.出诊日期 = Trunc(d_日期)
                      Union All
                      Select 2 As 记录性质, a.Id As 记录id, a.号源id, a.科室id, a.项目id, a.替诊医生id As 医生id, a.替诊医生姓名 As 医生姓名,
                             a.上班时段 As 排班, a.开始时间, a.终止时间, Nvl(a.是否序号控制, 0) As 序号控制, Nvl(a.是否分时段, 0) As 分时段, a.预约控制, a.限号数,
                             Nvl(a.限约数, a.限号数) As 限约数, Nvl(a.已挂数, 0) As 已挂数, Nvl(a.已约数, 0) As 已约数, Nvl(a.其中已接收, 0) As 已接收,
                             a.替诊开始时间, a.替诊终止时间, a.停诊开始时间, a.停诊终止时间
                      From 临床出诊记录 A
                      Where Nvl(a.是否发布, 0) = 1 And Nvl(a.是否锁定, 0) = 0 And a.开始时间 > Trunc(d_启用时间) And a.终止时间 > Sysdate And
                            (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) And Nvl(a.停诊开始时间, a.终止时间) > Sysdate Or
                             a.终止时间 > Nvl(a.停诊终止时间, a.开始时间) And a.终止时间 > Sysdate Or Exists
                             (Select 1
                              From 临床出诊序号控制
                              Where 记录id = a.Id And Nvl(是否停诊, 0) = 0 And Nvl(a.是否序号控制, 0) = 1 And Nvl(a.是否分时段, 0) = 1 And
                                    开始时间 <> 终止时间 And 开始时间 >= Sysdate)) And
                            Decode(Nvl(n_医生id, 0), 0, 0, a.替诊医生id) = Nvl(n_医生id, 0) And
                            Decode(Nvl(v_医生姓名, '-'), '-', '-', a.替诊医生姓名) = Nvl(v_医生姓名, '-') And
                            Decode(Nvl(n_科室id, 0), 0, 0, a.科室id) = Nvl(n_科室id, 0) And a.替诊医生姓名 Is Not Null And
                            a.出诊日期 = Trunc(d_日期)) A, 临床出诊号源 B, 部门表 C, 人员表 D, 收费项目目录 E
               Where a.号源id = b.Id And a.科室id = c.Id And a.项目id = e.Id And a.医生id = d.Id(+)) Loop
  
    Zl_挂号序号状态_出诊_Delete(r_No.记录id);
    v_Temp := '';
    n_禁用 := 0;
    If Sysdate + Nvl(r_No.预约天数, n_预约天数) + n_补充天数 >= d_日期 Then
      If Trunc(d_日期) = Trunc(Sysdate) Then
        --当日
        If v_合作单位 Is Null Then
          --未传入合作单位
          n_已挂数   := r_No.已挂数;
          v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0) - (Nvl(r_No.已约数, 0) - Nvl(r_No.已接收, 0));
          If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
            v_Temp     := '<SPANLIST>';
            n_Exists   := 0;
            n_时段总数 := 0;
            n_时段剩余 := 0;
            d_时段开始 := Null;
            d_时段结束 := Null;
            Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
            For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                           From 临床出诊序号控制
                           Where 记录id = r_No.记录id And (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                 Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                                 r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                 Nvl(r_No.替诊终止时间, Sysdate - 1)) And Nvl(是否停诊, 0) = 0) Loop
              If r_Time.开始时间 > Sysdate Then
                If Nvl(n_时间间隔, 0) = 0 Then
                  If Nvl(r_Time.挂号状态, 0) = 0 Then
                    n_时段剩余 := 1;
                    n_Exists   := n_Exists + 1;
                  Else
                    n_时段剩余 := 0;
                  End If;
                  v_Temp := v_Temp || Gettimexml(r_Time.开始时间, r_Time.终止时间, 1, n_时段剩余);
                Else
                  If d_时段开始 Is Null Then
                    n_时段总数 := 1;
                    n_时段剩余 := 0;
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                    
                      n_时段总数 := 1;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + 1;
                    End If;
                  End If;
                
                  If Nvl(r_Time.挂号状态, 0) = 0 Then
                    n_时段剩余 := n_时段剩余 + 1;
                    n_Exists   := n_Exists + 1;
                  End If;
                End If;
              End If;
            End Loop;
          
            If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
              v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
            End If;
          
            If r_No.记录性质 = 1 And n_Exists < To_Number(v_剩余数量) And n_严格按时段挂号 = 0 Then
              v_Temp := v_Temp || Gettimexml(d_加号时间, '', v_剩余数量, To_Number(v_剩余数量) - n_Exists);
            End If;
            v_Temp := v_Temp || '</SPANLIST>';
            
            If n_严格按时段挂号 = 1 Then
              v_剩余数量 := n_Exists;
            End If;
          End If;
        Else
          --传入合作单位
          n_已挂数 := r_No.已挂数;
          Begin
            Select 控制方式
            Into n_合约模式
            From 临床出诊挂号控制记录
            Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位 And Rownum < 2;
          Exception
            When Others Then
              n_合约模式 := 4;
          End;
        
          If n_合约模式 = 0 Then
            n_禁用 := 1;
          Elsif n_合约模式 = 1 Or n_合约模式 = 2 Then
            Select 数量
            Into n_合约总数量
            From 临床出诊挂号控制记录
            Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位;
            If n_合约模式 = 1 Then
              n_合约总数量 := Floor(r_No.限约数 * n_合约总数量 / 100);
            End If;
          
            Select Count(1)
            Into n_合约已挂数
            From 病人挂号记录
            Where 出诊记录ID = r_no.记录ID And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                  Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
            n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
          
            If r_No.限号数 - Nvl(r_No.已挂数, 0) < n_合约剩余数量 Then
              v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
            Else
              v_剩余数量 := n_合约剩余数量;
            End If;
          
            If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
              v_Temp     := '<SPANLIST>';
              n_Exists   := 0;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
              For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                             From 临床出诊序号控制
                             Where 记录id = r_No.记录id And (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                   Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                                   r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                   Nvl(r_No.替诊终止时间, Sysdate - 1)) And Nvl(是否停诊, 0) = 0) Loop
              
                If r_Time.开始时间 > Sysdate Then
                  If Nvl(n_时间间隔, 0) = 0 Then
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      n_时段剩余 := 1;
                      n_Exists   := n_Exists + 1;
                    Else
                      n_时段剩余 := 0;
                    End If;
                    v_Temp := v_Temp || Gettimexml(r_Time.开始时间, r_Time.终止时间, 1, n_时段剩余);
                  Else
                    If d_时段开始 Is Null Then
                      n_时段总数 := 1;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      If r_Time.开始时间 >= d_时段结束 Then
                        v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                      
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      n_时段剩余 := n_时段剩余 + 1;
                      n_Exists   := n_Exists + 1;
                    End If;
                  End If;
                End If;
              End Loop;
            
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
              End If;
            
              If r_No.记录性质 = 1 And n_Exists < To_Number(v_剩余数量) And n_严格按时段挂号 = 0 Then
                v_Temp := v_Temp || Gettimexml(d_加号时间, '', v_剩余数量, To_Number(v_剩余数量) - n_Exists);
              End If;
              v_Temp := v_Temp || '</SPANLIST>';
              
              If n_严格按时段挂号 = 1 Then
                v_剩余数量 := n_Exists;
              End If;
            End If;
          Elsif n_合约模式 = 3 Then
            If r_No.序号控制 = 0 Then
              n_已挂数   := r_No.已挂数;
              v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0) - (Nvl(r_No.已约数, 0) - Nvl(r_No.已接收, 0));
            Else
              v_Temp     := '<SPANLIST>';
              n_已挂数   := 0;
              v_剩余数量 := 0;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              For r_合作 In (Select 序号
                           From 临床出诊挂号控制记录
                           Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
              
                Begin
                  Select 1, 开始时间, 终止时间
                  Into n_Exists, d_开始时间, d_终止时间
                  From 临床出诊序号控制
                  Where 记录id = r_No.记录id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0 And
                        (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                        r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1)) And
                        Nvl(是否停诊, 0) = 0;
                Exception
                  When Others Then
                    n_Exists := 0;
                End;
              
                If n_Exists = 1 Then
                  If d_开始时间 > Sysdate Or n_严格按时段挂号 = 0 then
                    v_剩余数量 := v_剩余数量 + 1;
                  End If;
                Else
                  n_已挂数 := n_已挂数 + 1;
                End If;
              
                If d_开始时间 > Sysdate Then
                  If Nvl(n_时间间隔, 0) = 0 Then
                    If n_Exists = 1 Then
                      n_时段剩余 := 1;
                    Else
                      n_时段剩余 := 0;
                    End If;
                    v_Temp := v_Temp || Gettimexml(d_开始时间, d_终止时间, 1, n_时段剩余);
                  Else
                    If d_时段开始 Is Null Then
                      n_时段总数 := 1;
                      n_时段剩余 := 0;
                      d_时段开始 := d_开始时间;
                      d_时段结束 := d_开始时间 + n_时间间隔 / 24 / 60;
                    Else
                      If d_开始时间 >= d_时段结束 Then
                        v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                      
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := d_开始时间;
                        d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  
                    If n_Exists = 1 Then
                      n_时段剩余 := n_时段剩余 + 1;
                    End If;
                  End If;
                End If;
              End Loop;
            
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
              End If;
              v_Temp := v_Temp || '</SPANLIST>';
            End If;
          Elsif n_合约模式 = 4 Then
            n_已挂数   := r_No.已挂数;
            v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0) - (Nvl(r_No.已约数, 0) - Nvl(r_No.已接收, 0));
            If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
              v_Temp     := '<SPANLIST>';
              n_Exists   := 0;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
              For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                             From 临床出诊序号控制
                             Where 记录id = r_No.记录id And (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                   Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                                   r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                   Nvl(r_No.替诊终止时间, Sysdate - 1)) And Nvl(是否停诊, 0) = 0) Loop
              
                If r_Time.开始时间 > Sysdate Then
                  If Nvl(n_时间间隔, 0) = 0 Then
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      n_时段剩余 := 1;
                      n_Exists   := n_Exists + 1;
                    Else
                      n_时段剩余 := 0;
                    End If;
                    v_Temp := v_Temp || Gettimexml(r_Time.开始时间, r_Time.终止时间, 1, n_时段剩余);
                  Else
                    If d_时段开始 Is Null Then
                      n_时段总数 := 1;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      If r_Time.开始时间 >= d_时段结束 Then
                        v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                      
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      n_时段剩余 := n_时段剩余 + 1;
                      n_Exists   := n_Exists + 1;
                    End If;
                  End If;
                End If;
              End Loop;
            
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
              End If;
            
              --严格按时段挂号就不存在追加时段
              If r_No.记录性质 = 1 And n_Exists < To_Number(v_剩余数量) And n_严格按时段挂号 = 0 Then
                v_Temp := v_Temp || Gettimexml(d_加号时间, '', v_剩余数量, To_Number(v_剩余数量) - n_Exists);
              End If;
              v_Temp := v_Temp || '</SPANLIST>';
              
              If n_严格按时段挂号 = 1 Then
                v_剩余数量 := n_Exists;
              End If;
            End If;
          End If;
        End If;
      Else
        --预约挂号
        If r_No.预约控制 = 1 Then
          n_禁用 := 1;
        Else
          --不限制预约
          If v_合作单位 Is Null Then
            If r_No.分时段 = 0 Then
              n_已挂数   := r_No.已约数;
              v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
            Else
              --分时段
              v_Temp     := '<SPANLIST>';
              n_已挂数   := 0;
              v_剩余数量 := 0;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
              If r_No.序号控制 = 0 Then
                --非序号控制分时段预约
                For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                               From 临床出诊序号控制
                               Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                     (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                                     r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.停诊开始时间, Sysdate) And
                                     Nvl(r_No.停诊终止时间, Sysdate - 1))) Loop
                
                  Select Count(1)
                  Into n_时段已挂
                  From 临床出诊序号控制
                  Where 记录id = r_No.记录id And 序号 = r_Time.序号 And 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                
                  n_已挂数   := n_已挂数 + n_时段已挂;
                  v_剩余数量 := v_剩余数量 + (r_Time.数量 - n_时段已挂);
                
                  If r_Time.开始时间 > Sysdate Then
                    If Nvl(n_时间间隔, 0) = 0 Then
                      n_时段剩余 := r_Time.数量 - n_时段已挂;
                      v_Temp     := v_Temp || Gettimexml(r_Time.开始时间, r_Time.终止时间, r_Time.数量, n_时段剩余);
                    Else
                      If d_时段开始 Is Null Then
                        n_时段总数 := r_Time.数量;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        If r_Time.开始时间 >= d_时段结束 Then
                          v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                        
                          n_时段总数 := r_Time.数量;
                          n_时段剩余 := 0;
                          d_时段开始 := r_Time.开始时间;
                          d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                          If d_加号时间 < d_时段结束 Then
                            d_时段结束 := d_加号时间;
                          End If;
                        Else
                          n_时段总数 := n_时段总数 + r_Time.数量;
                        End If;
                      End If;
                    
                      n_时段剩余 := n_时段剩余 + r_Time.数量 - n_时段已挂;
                    End If;
                  End If;
                End Loop;
              
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                End If;
              Else
                --序号控制分时段预约
                For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                               From 临床出诊序号控制
                               Where 记录id = r_No.记录id And 是否预约 = 1 And
                                     (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                                     r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1)) And Nvl(是否停诊, 0) = 0) Loop
                
                  If Nvl(r_Time.挂号状态, 0) = 0 Then
                    v_剩余数量 := v_剩余数量 + 1;
                  Else
                    n_已挂数 := n_已挂数 + 1;
                  End If;
                
                  If r_Time.开始时间 > Sysdate Then
                    If Nvl(n_时间间隔, 0) = 0 Then
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        n_时段剩余 := 1;
                      Else
                        n_时段剩余 := 0;
                      End If;
                      v_Temp := v_Temp || Gettimexml(r_Time.开始时间, r_Time.终止时间, 1, n_时段剩余);
                    Else
                      If d_时段开始 Is Null Then
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        If r_Time.开始时间 >= d_时段结束 Then
                          v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                        
                          n_时段总数 := 1;
                          n_时段剩余 := 0;
                          d_时段开始 := r_Time.开始时间;
                          d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                          If d_加号时间 < d_时段结束 Then
                            d_时段结束 := d_加号时间;
                          End If;
                        Else
                          n_时段总数 := n_时段总数 + 1;
                        End If;
                      End If;
                    
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        n_时段剩余 := n_时段剩余 + 1;
                      End If;
                    End If;
                  End If;
                End Loop;
              
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                End If;
              End If;
              v_Temp := v_Temp || '</SPANLIST>';
            End If;
          Else
            --合作单位预约挂号
            If r_No.预约控制 = 2 Then
              n_禁用 := 1;
            Else
              Begin
                Select 控制方式
                Into n_合约模式
                From 临床出诊挂号控制记录
                Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位 And Rownum < 2;
              Exception
                When Others Then
                  n_合约模式 := 4;
              End;
            
              If n_合约模式 = 0 Then
                n_禁用 := 1;
              Elsif n_合约模式 = 1 Or n_合约模式 = 2 Then
                Select 数量
                Into n_合约总数量
                From 临床出诊挂号控制记录
                Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位;
                If n_合约模式 = 1 Then
                  n_合约总数量 := Floor(r_No.限约数 * n_合约总数量 / 100);
                End If;
              
                Select Count(1)
                Into n_合约已挂数
                From 病人挂号记录
                Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                      Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
              
                n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
              
                If Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0) < n_合约剩余数量 Then
                  v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                Else
                  v_剩余数量 := n_合约剩余数量;
                End If;
                n_已挂数 := r_No.已约数;
              
                If r_No.分时段 = 1 Then
                  v_Temp     := '<SPANLIST>';
                  n_Exists   := 0;
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  If r_No.序号控制 = 1 Then
                    --分时段,序号控制
                    For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                   From 临床出诊序号控制
                                   Where 记录id = r_No.记录id And 是否预约 = 1 And
                                         (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                         Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                                         r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                         Nvl(r_No.替诊终止时间, Sysdate - 1)) And Nvl(是否停诊, 0) = 0) Loop
                    
                      If r_Time.开始时间 > Sysdate Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          If Nvl(r_Time.挂号状态, 0) = 0 Then
                            n_时段剩余 := 1;
                            n_Exists   := n_Exists + 1;
                          Else
                            n_时段剩余 := 0;
                          End If;
                          v_Temp := v_Temp || Gettimexml(r_Time.开始时间, r_Time.终止时间, 1, n_时段剩余);
                        Else
                          If d_时段开始 Is Null Then
                            n_时段总数 := 1;
                            n_时段剩余 := 0;
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                            
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        
                          If Nvl(r_Time.挂号状态, 0) = 0 Then
                            n_时段剩余 := 1;
                            n_Exists   := n_Exists + 1;
                          End If;
                        End If;
                      End If;
                    End Loop;
                  
                    If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                      v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                    End If;
                  
                    If n_Exists < To_Number(v_剩余数量) Then
                      v_剩余数量 := n_Exists;
                    End If;
                  Else
                    --分时段,非序号控制
                    For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                   From 临床出诊序号控制
                                   Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                         (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                         Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                                         r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.停诊开始时间, Sysdate) And
                                         Nvl(r_No.停诊终止时间, Sysdate - 1))) Loop
                    
                      Select Count(1)
                      Into n_时段已挂
                      From 临床出诊序号控制
                      Where 记录id = r_No.记录id And 序号 = r_Time.序号 And 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                    
                      If r_Time.开始时间 > Sysdate Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          n_时段剩余 := r_Time.数量 - n_时段已挂;
                          n_Exists   := n_Exists + n_时段剩余;
                          v_Temp     := v_Temp || Gettimexml(r_Time.开始时间, r_Time.终止时间, r_Time.数量, n_时段剩余);
                        Else
                          If d_时段开始 Is Null Then
                            n_时段总数 := r_Time.数量;
                            n_时段剩余 := 0;
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                            
                              n_时段总数 := r_Time.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_Time.数量;
                            End If;
                          End If;
                        
                          n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                          n_Exists   := n_Exists + (r_Time.数量 - n_时段已挂);
                        End If;
                      End If;
                    End Loop;
                  
                    If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                      v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                    End If;
                  
                    If n_Exists < To_Number(v_剩余数量) Then
                      v_剩余数量 := n_Exists;
                    End If;
                  End If;
                  v_Temp := v_Temp || '</SPANLIST>';
                End If;
              Elsif n_合约模式 = 3 Then
                If r_No.分时段 = 0 Then
                  If r_No.序号控制 = 0 Then
                    n_禁用 := 1;
                  Else
                    --序号控制不分时段
                    n_已挂数   := 0;
                    v_剩余数量 := 0;
                    For r_合作 In (Select 序号
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                    
                      Select Count(1)
                      Into n_Exists
                      From 临床出诊序号控制
                      Where 记录id = r_No.记录id And 序号 = r_合作.序号 And 是否预约 = 1 And Nvl(挂号状态, 0) = 0 And
                            (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                            Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                            r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1)) And
                            Nvl(是否停诊, 0) = 0;
                    
                      If n_Exists = 1 Then
                        v_剩余数量 := v_剩余数量 + 1;
                      Else
                        n_已挂数 := n_已挂数 + 1;
                      End If;
                    End Loop;
                  
                    If Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0) < v_剩余数量 Then
                      v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                    End If;
                  End If;
                Else
                  v_Temp     := '<SPANLIST>';
                  n_已挂数   := 0;
                  v_剩余数量 := 0;
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  If r_No.序号控制 = 0 Then
                    --分时段,非序号控制
                    For r_合作 In (Select 序号, 数量
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                    
                      Select Count(1), Max(开始时间), Max(终止时间)
                      Into n_时段已挂, d_开始时间, d_终止时间
                      From 临床出诊序号控制
                      Where 记录id = r_No.记录id And 序号 = r_合作.序号 And 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0 And
                            (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                            Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                            r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1));
                    
                      n_已挂数   := n_已挂数 + n_时段已挂;
                      v_剩余数量 := v_剩余数量 + r_合作.数量 - n_时段已挂;
                    
                      If d_开始时间 > Sysdate Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          n_时段剩余 := r_合作.数量 - n_时段已挂;
                          v_Temp     := v_Temp || Gettimexml(d_开始时间, d_终止时间, r_合作.数量, n_时段剩余);
                        Else
                          If d_时段开始 Is Null Then
                            n_时段总数 := r_合作.数量;
                            n_时段剩余 := 0;
                            d_时段开始 := d_开始时间;
                            d_时段结束 := d_开始时间 + n_时间间隔 / 24 / 60;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If d_开始时间 >= d_时段结束 Then
                              v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                            
                              n_时段总数 := r_合作.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := d_开始时间;
                              d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_合作.数量;
                            End If;
                          End If;
                        
                          n_时段剩余 := n_时段剩余 + r_合作.数量 - n_时段已挂;
                        End If;
                      End If;
                    End Loop;
                  
                    If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                      v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                    End If;
                  Else
                    --分时段,序号控制
                    For r_合作 In (Select 序号
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                    
                      Select Max(1), Max(开始时间), Max(终止时间)
                      Into n_Exists, d_开始时间, d_终止时间
                      From 临床出诊序号控制
                      Where 记录id = r_No.记录id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0 And
                            (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                            Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                            r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1)) And
                            Nvl(是否停诊, 0) = 0;
                    
                      If n_Exists = 1 Then
                        v_剩余数量 := v_剩余数量 + 1;
                      Else
                        n_已挂数 := n_已挂数 + 1;
                      End If;
                    
                      If d_开始时间 > Sysdate Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          If n_Exists = 1 Then
                            n_时段剩余 := 1;
                          Else
                            n_时段剩余 := 0;
                          End If;
                          v_Temp := v_Temp || Gettimexml(d_开始时间, d_终止时间, 1, n_时段剩余);
                        Else
                          If d_时段开始 Is Null Then
                            n_时段总数 := 1;
                            n_时段剩余 := 0;
                            d_时段开始 := d_开始时间;
                            d_时段结束 := d_开始时间 + n_时间间隔 / 24 / 60;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If d_开始时间 >= d_时段结束 Then
                              v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                            
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := d_开始时间;
                              d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        
                          If n_Exists = 1 Then
                            n_时段剩余 := n_时段剩余 + 1;
                          End If;
                        End If;
                      End If;
                    End Loop;
                  
                    If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                      v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                    End If;
                  End If;
                  v_Temp := v_Temp || '</SPANLIST>';
                End If;
              Elsif n_合约模式 = 4 Then
                If r_No.分时段 = 0 Then
                  n_已挂数   := r_No.已约数;
                  v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                Else
                  --分时段
                  v_Temp     := '<SPANLIST>';
                  n_已挂数   := 0;
                  v_剩余数量 := 0;
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  If r_No.序号控制 = 0 Then
                    --非序号控制分时段预约
                    For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                   From 临床出诊序号控制
                                   Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                         (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                         Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                                         r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.停诊开始时间, Sysdate) And
                                         Nvl(r_No.停诊终止时间, Sysdate - 1))) Loop
                    
                      Select Count(1)
                      Into n_时段已挂
                      From 临床出诊序号控制
                      Where 记录id = r_No.记录id And 序号 = r_Time.序号 And 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                    
                      n_已挂数   := n_已挂数 + n_时段已挂;
                      v_剩余数量 := v_剩余数量 + n_时段剩余;
                    
                      If r_Time.开始时间 > Sysdate Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          n_时段剩余 := r_Time.数量 - n_时段已挂;
                          v_Temp     := v_Temp || Gettimexml(r_Time.开始时间, r_Time.终止时间, r_Time.数量, n_时段剩余);
                        Else
                          If d_时段开始 Is Null Then
                            n_时段总数 := r_Time.数量;
                            n_时段剩余 := 0;
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                            
                              n_时段总数 := r_Time.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_Time.数量;
                            End If;
                          End If;
                        
                          n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                        End If;
                      End If;
                    End Loop;
                  
                    If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                      v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                    End If;
                  Else
                    For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                   From 临床出诊序号控制
                                   Where 记录id = r_No.记录id And 是否预约 = 1 And
                                         (r_No.记录性质 = 1 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                         Nvl(r_No.替诊终止时间, Sysdate - 1) Or
                                         r_No.记录性质 = 2 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                         Nvl(r_No.替诊终止时间, Sysdate - 1)) And Nvl(是否停诊, 0) = 0) Loop
                    
                      If Nvl(r_Time.挂号状态, 0) = 0 And (r_Time.开始时间 > Sysdate Or n_严格按时段挂号 = 0) Then
                        v_剩余数量 := v_剩余数量 + 1;
                      Elsif Nvl(r_Time.挂号状态, 0) <> 0 Then
                        n_已挂数 := n_已挂数 + 1;
                      End If;
                    
                      If r_Time.开始时间 > Sysdate Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          If Nvl(r_Time.挂号状态, 0) = 0 Then
                            n_时段剩余 := 1;
                          Else
                            n_时段剩余 := 0;
                          End If;
                          v_Temp := v_Temp || Gettimexml(r_Time.开始时间, r_Time.终止时间, 1, n_时段剩余);
                        Else
                          If d_时段开始 Is Null Then
                            n_时段总数 := 1;
                            n_时段剩余 := 0;
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + n_时间间隔 / 24 / 60;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                            
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + n_时间间隔 / 24 / 60;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        
                          If Nvl(r_Time.挂号状态, 0) = 0 Then
                            n_时段剩余 := n_时段剩余 + 1;
                          End If;
                        End If;
                      End If;
                    End Loop;
                  
                    If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                      v_Temp := v_Temp || Gettimexml(d_时段开始, d_时段结束, n_时段总数, n_时段剩余);
                    End If;
                  End If;
                  v_Temp := v_Temp || '</SPANLIST>';
                End If;
              End If;
            End If;
          End If;
        End If;
      End If;
    
      If Not (r_No.分时段 = 1 And r_No.序号控制 = 1) Then
        If d_日期 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) Then
          n_禁用 := 1;
        End If;
        If d_日期 Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1) Then
          n_禁用 := 1;
        End If;
      End If;
    
      If Nvl(n_禁用, 0) = 0 Then
        n_合计金额 := 0;
        For r_Fee In (Select b.现价, a.从项数次
                      From 收费从属项目 A, 收费价目 B
                      Where a.从项id = b.收费细目id And a.主项id = r_No.项目id And d_日期 Between b.执行日期 And
                            Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                            (b.价格等级 = v_普通等级 Or
                            (b.价格等级 Is Null And Not Exists
                             (Select 1
                               From 收费价目
                               Where 收费细目id = b.收费细目id And 价格等级 = v_普通等级 And d_日期 Between 执行日期 And
                                     Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')))))
                      Union All
                      Select b.现价, 1 As 从项数次
                      From 收费项目目录 A, 收费价目 B
                      Where a.Id = b.收费细目id And a.Id = r_No.项目id And d_日期 Between b.执行日期 And
                            Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                            (b.价格等级 = v_普通等级 Or
                            (b.价格等级 Is Null And Not Exists
                             (Select 1
                               From 收费价目
                               Where 收费细目id = b.收费细目id And 价格等级 = v_普通等级 And d_日期 Between 执行日期 And
                                     Nvl(终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')))))) Loop
          n_合计金额 := n_合计金额 + r_Fee.现价 * r_Fee.从项数次;
        End Loop;
      
        v_时间段  := To_Char(r_No.开始时间, 'HH24:MI') || '-' || To_Char(r_No.终止时间, 'HH24:MI');
        c_Xmlmain := '<HB>';
        c_Xmlmain := c_Xmlmain || '<CZJLID>' || r_No.记录id || '</CZJLID>';
        c_Xmlmain := c_Xmlmain || '<HM>' || r_No.号码 || '</HM>';
        c_Xmlmain := c_Xmlmain || '<YSID>' || r_No.医生id || '</YSID>';
        c_Xmlmain := c_Xmlmain || '<YS>' || r_No.医生姓名 || '</YS>';
        c_Xmlmain := c_Xmlmain || '<KSID>' || r_No.科室id || '</KSID>';
        c_Xmlmain := c_Xmlmain || '<KSMC>' || r_No.科室名称 || '</KSMC>';
        c_Xmlmain := c_Xmlmain || '<ZC>' || r_No.职称 || '</ZC>';
        c_Xmlmain := c_Xmlmain || '<XMID>' || r_No.项目id || '</XMID>';
        c_Xmlmain := c_Xmlmain || '<XMMC>' || r_No.项目名称 || '</XMMC>';
        c_Xmlmain := c_Xmlmain || '<PRICE>' || n_合计金额 || '</PRICE>';
        c_Xmlmain := c_Xmlmain || '<HL>' || r_No.号类 || '</HL>';
        c_Xmlmain := c_Xmlmain || '<FSD>' || r_No.分时段 || '</FSD>';
        c_Xmlmain := c_Xmlmain || '<HBTIME>' || v_时间段 || '</HBTIME>';
        c_Xmlmain := c_Xmlmain || '<FWMC>' || r_No.排班 || '</FWMC>';
        If Trunc(Sysdate) = Trunc(d_日期) Or r_No.已约数 < r_No.限约数 Then
          c_Xmlmain := c_Xmlmain || '<YGHS>' || n_已挂数 || '</YGHS>';
          c_Xmlmain := c_Xmlmain || '<SYHS>' || v_剩余数量 || '</SYHS>';
          c_Xmlmain := c_Xmlmain || v_Temp;
        Else
          c_Xmlmain := c_Xmlmain || '<YGHS>' || r_No.已约数 || '</YGHS>';
          c_Xmlmain := c_Xmlmain || '<SYHS>' || 0 || '</SYHS>';
        End If;
        c_Xmlmain := c_Xmlmain || '</HB>';
        v_Xmlmain := v_Xmlmain || c_Xmlmain;
      End If;
    End If;
  End Loop;
  v_Xmlmain := '<GROUP>' || '<RQ>' || To_Char(d_日期, 'yyyy-mm-dd') || '</RQ>' || '<HBLIST>' || v_Xmlmain || '</HBLIST>' ||
               '</GROUP>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Xmlmain)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getnolist;
/
Create Or Replace Procedure Zl_Third_Lockno
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:HIS锁号
  --入参:Xml_In:
  --<IN>
  --  <HM>5</HM>           //号码
  --  <CZJLID>1</CZJLID>       //出诊记录ID,出诊表排班模式下传入
  --  <RQ>2013-11-21 09:00</RQ>  //预约时间
  --  <CZ>1</CZ>           //操作
  --  <HX></HX>          //号序
  --  <HZDW>支付宝</HZDW>   //合作单位
  --  <JQM>机器名</JQM>        //机器名
  --  <SJD>时间段</SJD>        //锁号的时间段
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  -- <HX>号序</HX>          //锁号操作并且成功时返回
  -- 错误信息  //出错时返回
  --</ OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_号码       挂号安排.号码%Type;
  d_日期       Date;
  n_操作类型   Number(3);
  n_号序       挂号序号状态.序号%Type;
  v_操作员姓名 挂号序号状态.操作员姓名%Type;
  v_机器名     挂号序号状态.机器名%Type;
  v_合作单位   合作单位安排控制.合作单位%Type;
  v_Temp       Varchar2(32767); --临时XML
  x_Templet    Xmltype; --模板XML
  n_记录id     临床出诊记录.Id%Type;
  d_启用时间   Date;
  v_时间段     Varchar2(200);
  v_Para       Varchar2(2000);
  n_挂号模式   Number(3);
  n_序号_Out   临床出诊序号控制.序号%Type;
  n_是否预约   number(3);
  Err_Item Exception;
  
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/HM'), To_Date(Extractvalue(Value(A), 'IN/RQ'), 'YYYY-MM-DD hh24:mi:ss'),
         Extractvalue(Value(A), 'IN/CZ'), Extractvalue(Value(A), 'IN/HX'), Extractvalue(Value(A), 'IN/HZDW'),
         Extractvalue(Value(A), 'IN/JQM'), Extractvalue(Value(A), 'IN/CZJLID'), Extractvalue(Value(A), 'IN/SJD')
  Into v_号码, d_日期, n_操作类型, n_号序, v_合作单位, v_机器名, n_记录id, v_时间段
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  v_Para := Nvl(Zl_Getsysparameter(256), '0');

  n_挂号模式 := To_Number(Substr(v_Para, 1, 1));

  If n_挂号模式 = 1 Then
    Begin
      d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
    Exception
      When Others Then
        d_启用时间 := Null;
    End;
  
    If Nvl(d_日期, Sysdate) < Nvl(d_启用时间, Sysdate) Then
      n_挂号模式 := 0;
    End If;
  End If;

  If v_机器名 Is Null Then
    Select Terminal Into v_机器名 From V$session Where Audsid = Userenv('sessionid');
  End If;

  v_操作员姓名 := Zl_Username;
  n_是否预约:=1;
  IF trunc(d_日期)=trunc(SYSDATE) THEN 
      n_是否预约:=0;
  END IF ;

  If Nvl(n_挂号模式, 0) = 0 Then
    --1.传统模式
    Zl_挂号安排_传统_Lockno(n_操作类型, v_号码, d_日期, n_号序, n_序号_Out, v_机器名, v_操作员姓名,NULL,NULL,n_是否预约,'移动锁号',v_合作单位, v_时间段);
  Else
    --2.临床出诊模式
    Zl_挂号安排_临床出诊_Lockno(n_操作类型, n_记录id, d_日期, n_号序, n_序号_Out,n_是否预约,'移动锁号',v_机器名, v_操作员姓名, d_启用时间, v_合作单位, v_时间段,  v_号码);
  End If;

  If n_序号_Out Is NOT Null Then
    v_Temp := '<HX>' || Nvl(n_序号_Out, 0) || '</HX>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End If;
  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Temp || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_Third_Lockno;
/
Create Or Replace Procedure Zl_Third_Reghistory
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取历史挂号数据
  --入参:Xml_In:
  --<IN>
  --   <BRID>88393</BRID>    //病人ID
  --   <XM>姓名</XM>            //姓名
  --   <SFZH>身份证号</SFZH>    //身份证号
  --   <JLS>5</JLS >       //记录条数，按日期由近到远
  --   <JSKLB></JSKLB>     //结算卡类别
  --   <ZD></ZD>           //站点
  --   <HZDW> </HZDW>  //合作单位
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --   <GHLIST>       //如果为空表示没有找到数据
  --    <GH>
  --     <GHDH>N001</GHDH>   //挂号单号
  --     <KS>门诊外科</KS>     //挂号科室
  --     <KSID>42</KSID>    //科室id
  --     <DJSJ>2014-10-21 14:12:44</DJSJ>    //登记时间
  --     <YYSJ>2014-10-21 14:10</YYSJ>    //预约时间
  --     <ZXZT>1</ZXZT>     //状态(预约中等待付款、已挂号、候诊等)
  --     <DDFK>1</DDFK>     //是否付款 :0-未付款 1-付款,2-正在付款
  --     <GHFS>支付宝</GHFS>    //挂号方式(支付宝、自助机、窗口)
  --     <YSXM>LEX</YSXM>    //医生姓名
  --    </GH>
  --   </GHLIST>
  --   <ERROR><MSG>错误信息</MSG></ERROR>     //如果有错误返回
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_姓名         病人信息.姓名%Type;
  v_身份证号     病人信息.身份证号%Type;
  n_卡类别id     医疗卡类别.Id%Type;
  n_病人id       病人信息.病人id%Type;
  n_记录数       Number(4);
  v_结算卡类别   Varchar2(100);
  n_是否付款     Number(3);
  v_Temp         Varchar2(32767); --临时XML
  x_Templet      Xmltype; --模板XML
  v_Err_Msg      Varchar2(200);
  v_状态         Varchar2(100);
  n_站点         Number(1);
  n_预约有效时间 Number(5);
  v_Para         Varchar2(100);
  v_合作单位     病人挂号记录.合作单位%Type;
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT><GHLIST></GHLIST></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/JLS'), Extractvalue(Value(A), 'IN/JSKLB'),
         Extractvalue(Value(A), 'IN/ZD'), Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM'),
         Extractvalue(Value(A), 'IN/HZDW')
  Into n_病人id, n_记录数, v_结算卡类别, n_站点, v_身份证号, v_姓名, v_合作单位
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '无法确定病人信息,请检查!';
    Raise Err_Item;
  End If;

  If v_结算卡类别 Is Not Null Then
    Begin
      n_卡类别id := To_Number(v_结算卡类别);
    Exception
      When Others Then
        n_卡类别id := 0;
    End;
    If n_卡类别id = 0 Then
      Begin
        Select ID Into n_卡类别id From 医疗卡类别 Where 名称 = v_结算卡类别;
      Exception
        When Others Then
          v_Err_Msg := '无法确认传入的结算卡！';
          Raise Err_Item;
      End;
    End If;
  Else
    n_卡类别id := 0;
  End If;

  n_记录数       := Nvl(n_记录数, 0);
  v_Para         := zl_GetSysParameter('预约有效就诊期限', 1111);
  n_预约有效时间 := Zl_To_Number(Substr(v_Para, 1, Instr(v_Para || '|', '|') - 1));

  If Nvl(n_卡类别id, 0) = 0 Then
    For r_Reg In (Select Distinct a.No, a.执行部门id As 科室id, b.名称 As 科室, a.登记时间 As 创建时间, a.发生时间 As 预约时间,
                                  Decode(a.记录性质, 2, '预约中',
                                          Decode(a.执行状态, -1, '不就诊', 0, '等待就诊', 1, '完成就诊', 2, '正在就诊', '已挂号')) As 状态,
                                  a.预约方式 As 挂号方式, a.执行人 As 医生姓名, a.收费单, c.记录状态, c.费用状态
                  From 病人挂号记录 A, 部门表 B, 门诊费用记录 C
                  Where a.病人id = n_病人id And a.执行部门id = b.Id And c.No = a.No And c.序号 = 1 And
                        (a.合作单位 = Nvl(v_合作单位, '-') Or v_合作单位 Is Null) And c.记录性质 = 4 And a.记录状态 = 1 And
                        (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null)
                  Order By a.登记时间 Desc) Loop
      If n_记录数 <> 0 Then
        --是否付款 :0-未付款 1-付款,2-正在付款
        Begin
          Select Decode(Nvl(费用状态, 0), 1, 2, Decode(记录状态, 0, 0, 1))
          Into n_是否付款
          From 门诊费用记录
          Where 记录性质 = 1 And 记录状态 = 1 And 病人id = n_病人id And NO = r_Reg.收费单 And Rownum < 2;
        Exception
          When Others Then
            If Nvl(r_Reg.费用状态, 0) = 1 Then
              n_是否付款 := 2;
            Elsif r_Reg.记录状态 = 0 Then
              n_是否付款 := 0;
            Else
              n_是否付款 := 1;
            End If;
        End;
      
        If n_是否付款 = 0 And r_Reg.状态 = '预约中' And Sysdate > r_Reg.预约时间 - n_预约有效时间 / 60 / 24 Then
          v_状态 := '已失效';
        Else
          v_状态 := r_Reg.状态;
        End If;
      
        v_Temp := '<GH>' || '<GHDH>' || r_Reg.No || '</GHDH>' || '<KS>' || r_Reg.科室 || '</KS>' || '<KSID>' ||
                  r_Reg.科室id || '</KSID>' || '<DJSJ>' || To_Char(r_Reg.创建时间, 'YYYY-MM-DD hh24:mi:ss') || '</DJSJ>' ||
                  '<YYSJ>' || To_Char(r_Reg.预约时间, 'YYYY-MM-DD hh24:mi:ss') || '</YYSJ>' || '<ZXZT>' || v_状态 ||
                  '</ZXZT>' || '<DDFK>' || n_是否付款 || '</DDFK>' || '<GHFS>' || r_Reg.挂号方式 || '</GHFS>' || '<YSXM>' ||
                  r_Reg.医生姓名 || '</YSXM>' || '</GH>';
        Select Appendchildxml(x_Templet, '/OUTPUT/GHLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        n_记录数 := n_记录数 - 1;
      End If;
    End Loop;
  Else
    For r_Reg In (Select Distinct a.No, a.执行部门id As 科室id, b.名称 As 科室, a.登记时间 As 创建时间, a.发生时间 As 预约时间,
                                  Decode(a.记录性质, 2, '预约中',
                                          Decode(a.执行状态, -1, '不就诊', 0, '等待就诊', 1, '完成就诊', 2, '正在就诊', '已挂号')) As 状态,
                                  a.预约方式 As 挂号方式, a.执行人 As 医生姓名, a.收费单, c.记录状态, c.费用状态
                  From 病人挂号记录 A, 部门表 B, 门诊费用记录 C
                  Where a.病人id = n_病人id And a.执行部门id = b.Id And c.No = a.No And c.序号 = 1 And c.记录性质 = 4 And a.记录状态 = 1 And
                        (Exists
                         (Select 1 From 病人预交记录 Where c.结帐id = 结帐id And (卡类别id = n_卡类别id Or 卡类别id Is Null)) Or
                         (a.合作单位 = Nvl(v_合作单位, '-') And a.记录性质 = 2)) And Not Exists
                   (Select 1
                         From 病人预交记录
                         Where 结帐id = c.结帐id And Nvl(卡类别id, 0) <> 0 And Nvl(卡类别id, 0) <> n_卡类别id) And
                        (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null)
                  Order By a.登记时间 Desc) Loop
      If n_记录数 <> 0 Then
        --是否付款 :0-未付款 1-付款,2-正在付款
        Begin
          Select Decode(Nvl(费用状态, 0), 1, 2, Decode(记录状态, 0, 0, 1))
          Into n_是否付款
          From 门诊费用记录
          Where 记录性质 = 1 And 记录状态 = 1 And 病人id = n_病人id And NO = r_Reg.收费单 And Rownum < 2;
        Exception
          When Others Then
            If Nvl(r_Reg.费用状态, 0) = 1 Then
              n_是否付款 := 2;
            Elsif r_Reg.记录状态 = 0 Then
              n_是否付款 := 0;
            Else
              n_是否付款 := 1;
            End If;
        End;
      
        If n_是否付款 = 0 And r_Reg.状态 = '预约中' And Sysdate > r_Reg.预约时间 - n_预约有效时间 / 60 / 24 Then
          v_状态 := '已失效';
        Else
          v_状态 := r_Reg.状态;
        End If;
      
        v_Temp := '<GH>' || '<GHDH>' || r_Reg.No || '</GHDH>' || '<KS>' || r_Reg.科室 || '</KS>' || '<KSID>' ||
                  r_Reg.科室id || '</KSID>' || '<DJSJ>' || To_Char(r_Reg.创建时间, 'YYYY-MM-DD hh24:mi:ss') || '</DJSJ>' ||
                  '<YYSJ>' || To_Char(r_Reg.预约时间, 'YYYY-MM-DD hh24:mi:ss') || '</YYSJ>' || '<ZXZT>' || v_状态 ||
                  '</ZXZT>' || '<DDFK>' || n_是否付款 || '</DDFK>' || '<GHFS>' || r_Reg.挂号方式 || '</GHFS>' || '<YSXM>' ||
                  r_Reg.医生姓名 || '</YSXM>' || '</GH>';
        Select Appendchildxml(x_Templet, '/OUTPUT/GHLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        n_记录数 := n_记录数 - 1;
      End If;
    End Loop;
  End If;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Reghistory;
/
Create Or Replace Procedure Zl_Third_Registdel
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:HIS退号
  --入参:Xml_In:
  --<IN>
  --  <GHDH>A000001</GHDH>    //挂号单号
  --  <JSKLB>支付宝</JSKLB>      //结算卡类别
  --  <JCFP>1</JCFP>            //检查发票
  --  <GHJE>20</GHJE>            //挂号金额
  --  <JSMS>1</JSMS>          //结算模式：0-普通模式，1-异步结算模式
  --  <CZLX>0</CZLX>          //操作类型：结算模式为1时传入，0-开始结算，1-完成结算，2-回退结算
  --  <CXID>1</CXID>          //冲销结帐ID，操作类型为1或2时传入
  --  <JKFS>0</JKFS>             //缴款方式,0-挂号或预约缴款;1-预约不缴款
  --  <YYFS></YYFS>              //缴款方式=1时传入，预约的预约方式
  --  <LSH>34563</LSH>           //交易流水号
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  -- <CZSJ>操作时间</CZSJ>          //HIS的登记时间
  -- <YJZID>原结帐ID</YJZID>
  -- <CXID>冲销ID</CXID>
  --  <KPBZ>开票标志</KPBZ> //部分退才有效:1-成功开具电子票据;0-未开票成功标志
  --  <URL>H5页面URL</URL>
  --  <NETURL>外网H5页面URL</NETURL>
  --  <FPTT>发票抬头</FPTT>        //病人姓名
  --  <FPH>发票号</FPH>             //发票编号
  --  <FPJE>发票金额</FPJE>        //100.00
  --  <KPRQ>开票日期</KPRQ>   //yyyy-mm-dd
  -- <ERROR><MSG></MSG></ERROR> //为空表示取消挂号成功
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_No         病人挂号记录.No%Type;
  v_卡类别     Varchar2(100);
  n_挂号金额   门诊费用记录.实收金额%Type;
  v_交易流水号 病人预交记录.交易流水号%Type;
  n_检查发票   Number(3);
  n_缴款方式   Number(3);
  v_预约方式   病人挂号记录.预约方式%Type;
  n_结算模式   Number(1); --0-普通模式，1-异步结算模式
  n_操作类型   Number(1); --结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算

  v_操作员编号 门诊费用记录.操作员编号%Type;
  v_操作员姓名 门诊费用记录.操作员姓名%Type;
  v_结算方式   医疗卡类别.结算方式%Type;
  v_Type       Varchar2(50);
  n_已开医嘱   Number(2);
  n_是否打印   Number(3);
  n_结帐id     门诊费用记录.结帐id%Type;
  n_冲销id     门诊费用记录.结帐id%Type;
  n_挂号原结帐id 门诊费用记录.结帐id%Type;
  n_挂号冲销id   门诊费用记录.结帐id%Type;
  n_剩余金额     门诊费用记录.结帐id%Type;
  d_登记时间   Date;
  v_收费单     门诊费用记录.No%Type;
  n_病人id     门诊费用记录.病人id%Type;
  n_卡类别id   医疗卡类别.Id%Type;
  v_退费结算   Varchar2(1000);
  n_Temp       Number(18);
  n_预交id     病人预交记录.Id%Type;
  n_是否电子票据 病人预交记录.是否电子票据%Type;

  n_开票标志 Number(2);
  v_患者姓名 电子票据使用记录.姓名%Type;
  v_发票编号 电子票据使用记录.号码%Type;
  v_开票日期 Varchar2(20);
  n_发票金额 电子票据使用记录.票据金额%Type;
  v_Url      电子票据使用记录.Url内网%Type;
  v_Url外网  电子票据使用记录.Url外网%Type;

  v_Temp    Varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML

  n_Count   Number;
  v_Err_Msg Varchar2(200);
  Err_Item Exception;

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/GHDH'), Extractvalue(Value(A), 'IN/JSKLB'), Extractvalue(Value(A), 'IN/GHJE'),
         Extractvalue(Value(A), 'IN/LSH'), To_Number(Extractvalue(Value(A), 'IN/JCFP')),
         Nvl(To_Number(Extractvalue(Value(A), 'IN/JKFS')), 0), Extractvalue(Value(A), 'IN/YYFS'),
         Extractvalue(Value(A), 'IN/JSMS'), Extractvalue(Value(A), 'IN/CZLX'), Extractvalue(Value(A), 'IN/CXID')
  Into v_No, v_卡类别, n_挂号金额, v_交易流水号, n_检查发票, n_缴款方式, v_预约方式, n_结算模式, n_操作类型, n_冲销id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Max(结帐id) Into n_结帐id From 门诊费用记录 Where NO = v_No And 记录性质 = 4 And 记录状态 In (1, 3);

    --先要对电子票据冲红处理
  If b_Einvoice_Request.Einvoice_Cancel(4, n_结帐id, v_Err_Msg) = 0 Then
    --电子票据作废失败
    Raise Err_Item;
  End If;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) <> 0 Then
    If Nvl(n_冲销id, 0) = 0 And Nvl(n_结帐id, 0) <> 0 Then
      v_Err_Msg := '没有指定相关的结算数据！';
      Raise Err_Item;
    End If;
  
    Begin
      Select 登记时间 Into d_登记时间 From 病人挂号记录 Where NO = v_No And 记录状态 In (1, 3) And Rownum < 2;
    Exception
      When Others Then
        v_Err_Msg := '没有找到指定的相关结算数据，可能已被处理！';
        Raise Err_Item;
    End;
  End If;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 2 Then
    --删除结算数据
    Zl_病人挂号记录_Cancel(n_冲销id);
  
    v_Temp := '<CZSJ>' || To_Char(d_登记时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<YJZID>' || n_结帐id || '</YJZID>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<CXID>' || n_冲销id || '</CXID>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<KPBZ>' || 0 || '</KPBZ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<URL>' || '' || '</URL>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<NETURL>' || '' || '</NETURL>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<FPTT>' || '' || '</FPTT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<FPH>' || '' || '</FPH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<FPJE>' || '' || '</FPJE>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<KPRQ>' || '' || '</KPRQ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    Xml_Out := x_Templet;
    Return;
  End If;

  --获取操作员信息
  v_操作员编号 := Zl_操作员信息(1);
  v_操作员姓名 := Zl_操作员信息(2);

  Select Max(收费单) Into v_收费单 From 病人挂号记录 Where NO = v_No;
  If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
    If n_缴款方式 = 1 Then
      Select Count(1)
      Into n_Count
      From 门诊费用记录
      Where NO = v_No And 记录性质 = 4 And 结帐id Is Not Null And Rownum < 2;
      If n_Count = 0 Then
        Select Count(1)
        Into n_Count
        From 门诊费用记录
        Where NO In (Select /*+cardinality(B,10)*/
                      Column_Value
                     From Table(f_Str2List(v_收费单)) B) And 记录性质 = 1 And 结帐id Is Not Null And Rownum < 2;
      End If;
      If n_Count <> 0 Then
        v_Err_Msg := '传入的挂号单据不是预约挂号单,无法取消预约!';
        Raise Err_Item;
      End If;
    
      Select Count(1) Into n_Count From 病人挂号记录 A Where a.No = v_No And a.预约方式 = v_预约方式 And Rownum < 2;
      If n_Count = 0 Then
        v_Err_Msg := '传入的挂号单据不是' || v_预约方式 || '预约的,无法取消预约!';
        Raise Err_Item;
      End If;
    End If;
  
    If v_卡类别 Is Not Null And Nvl(n_缴款方式, 0) = 0 Then
      Select Nvl2(Translate(v_卡类别, '\1234567890', '\'), 'Char', 'Num') Into v_Type From Dual;
      If v_Type = 'Num' Then
        --传入的是卡类别ID
        Select 结算方式, ID Into v_结算方式, n_卡类别id From 医疗卡类别 Where ID = To_Number(v_卡类别);
      Else
        --传入的是卡类别名称
        Select 结算方式, ID Into v_结算方式, n_卡类别id From 医疗卡类别 Where 名称 = v_卡类别;
      End If;
    
      --要退的单据不是以该结算卡结算的，则禁止退号
      Select Count(1)
      Into n_Count
      From 病人预交记录 A,
           (Select Distinct 结帐id
             From 门诊费用记录
             Where NO = v_No And 记录性质 = 4
             Union
             Select Distinct 结帐id
             From 住院费用记录
             Where NO = v_No And 记录性质 = 5
             Union
             Select Distinct 结帐id
             From 门诊费用记录
             Where NO In (Select /*+cardinality(B,10)*/
                           Column_Value
                          From Table(f_Str2List(v_收费单)) B) And 记录性质 = 1) B
      Where a.结帐id = b.结帐id And a.卡类别id = n_卡类别id And Rownum < 2;
      If n_Count = 0 Then
        v_Err_Msg := '传入的挂号单据不是' || v_结算方式 || '结算的,无法退号!';
        Raise Err_Item;
      End If;
    End If;
  
    --补充结算检查，已存在补结算数据的，不能退号
    Select Count(1)
    Into n_Count
    From 费用补充记录 A,
         (Select Distinct 结帐id
           From 门诊费用记录
           Where NO = v_No And 记录性质 = 4
           Union
           Select Distinct 结帐id
           From 住院费用记录
           Where NO = v_No And 记录性质 = 5
           Union
           Select Distinct 结帐id
           From 门诊费用记录
           Where NO In (Select /*+cardinality(B,10)*/
                         Column_Value
                        From Table(f_Str2List(v_收费单)) B) And 记录性质 = 1) B
    Where a.收费结帐id = b.结帐id And a.记录性质 = 1 And a.附加标志 = 1 And Nvl(a.费用状态, 0) <> 2 And Rownum < 2;
    If n_Count = 1 Then
      v_Err_Msg := '传入的挂号单据已经进行了二次结算,无法退号!';
      Raise Err_Item;
    End If;
  
    --医嘱检查，已经开过医嘱的，不能退号
    Select Count(1) Into n_已开医嘱 From 病人医嘱记录 Where 挂号单 = v_No And Rownum < 2;
    If n_已开医嘱 = 1 Then
      v_Err_Msg := '传入的挂号单据已经开过医嘱,无法退号!';
      Raise Err_Item;
    End If;
  
    If Nvl(n_检查发票, 0) = 1 Then
      Select Max(Decode(a.实际票号, Null, 0, 1)) Into n_是否打印 From 门诊费用记录 A Where NO = v_No And 记录性质 = 4;
      If Nvl(n_是否打印, 0) = 1 Then
        v_Err_Msg := '本次退号的单据已开发票,不能退费!';
        Raise Err_Item;
      End If;
    
      Select Max(Decode(a.实际票号, Null, 0, 1))
      Into n_是否打印
      From 门诊费用记录 A
      Where NO In (Select /*+cardinality(B,10)*/
                    Column_Value
                   From Table(f_Str2List(v_收费单)) B) And 记录性质 = 1;
      If Nvl(n_是否打印, 0) = 1 Then
        v_Err_Msg := '本次退号的单据已开发票,不能退费!';
        Raise Err_Item;
      End If;
    End If;
  
    d_登记时间 := Sysdate;
    Select 病人结帐记录_Id.Nextval Into n_冲销id From Dual;
    Zl_三方机构挂号_Delete(v_No, v_交易流水号, '移动平台退号', d_登记时间, Null, 1, 0, n_冲销id);
  
    If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 And Nvl(n_卡类别id, 0) > 0 Then
      For c_记录 In (Select NO, 实际票号, 记录性质, 2, 病人id, 主页id, 姓名, 性别, 年龄, 门诊号, 住院号, 付款方式名称, 科室id, 摘要, 结算方式, -1 * 冲预交 As 冲预交,
                          合作单位, 卡类别id, 卡号, 交易流水号, 结算性质, 关联交易id
                   From 病人预交记录
                   Where 记录性质 = 4 And 记录状态 In (1, 3) And 结帐id = n_结帐id And 卡类别id = n_卡类别id) Loop
      
        Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 姓名, 性别, 年龄, 门诊号, 住院号, 付款方式名称, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交,
           结帐id, 缴款组id, 交易流水号, 交易说明, 合作单位, 结算序号, 卡类别id, 卡号, 结算性质, 交易时间, 交易人员, 关联交易id, 校对标志)
          Select n_预交id, c_记录.No, c_记录.实际票号, c_记录.记录性质, 2, c_记录.病人id, c_记录.主页id, c_记录.姓名, c_记录.性别, c_记录.年龄, c_记录.门诊号,
                 c_记录.住院号, c_记录.付款方式名称, c_记录.科室id, c_记录.摘要, c_记录.结算方式, d_登记时间, 操作员编号, 操作员姓名, c_记录.冲预交, n_冲销id, 缴款组id,
                 c_记录.交易流水号, '移动平台退号', c_记录.合作单位, n_冲销id, c_记录.卡类别id, c_记录.卡号, c_记录.结算性质, d_登记时间, 操作员姓名, c_记录.关联交易id, 1
          From 门诊费用记录
          Where 记录性质 = 4 And 结帐id = n_冲销id And Rownum < 2;
      End Loop;
    End If;
  Else
    If v_卡类别 Is Not Null And Nvl(n_缴款方式, 0) = 0 Then
      Select Nvl2(Translate(v_卡类别, '\1234567890', '\'), 'Char', 'Num') Into v_Type From Dual;
      If v_Type = 'Num' Then
        Select ID Into n_卡类别id From 医疗卡类别 Where ID = To_Number(v_卡类别);
      Else
        Select ID Into n_卡类别id From 医疗卡类别 Where 名称 = v_卡类别;
      End If;
      Delete From 病人预交记录 Where 结帐id = n_冲销id And n_卡类别id = n_卡类别id;
    End If;
  End If;

  If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 1 Then
    Zl_三方机构挂号_Delete(v_No, v_交易流水号, '移动平台退号', d_登记时间, Null, 1, 1, n_冲销id);
    n_挂号原结帐id := n_结帐id;
    n_挂号冲销id   := n_冲销id;

    --同步处理划价单
    If v_收费单 Is Not Null Then
      n_Temp := 0;
      For c_挂号 In (Select NO, Max(记录状态) As 记录状态, Max(病人id) As 病人id, Max(Decode(记录状态, 2, 0, 结帐id)) As 原结帐id,
                          Max(Decode(记录状态, 2, 结帐id, 0)) As 冲销id
                   From 门诊费用记录
                   Where NO In (Select /*+cardinality(B,10)*/
                                 Column_Value
                                From Table(f_Str2List(v_收费单)) B) And 记录性质 = 1) Loop
      
        If Nvl(c_挂号.记录状态, 0) = 0 Then
          Zl_门诊划价记录_Delete(c_挂号.No);
          n_结帐id := c_挂号.原结帐id;
          n_冲销id := c_挂号.冲销id;
        Elsif Nvl(c_挂号.记录状态, 0) = 1 Then
          If v_结算方式 Is Null Then
            v_Err_Msg := '本次挂号单据退款失败,请检查!';
            Raise Err_Item;
          End If;
          --先要对电子票据冲红处理
          If b_Einvoice_Request.Einvoice_Cancel(1, c_挂号.原结帐id, v_Err_Msg) = 0 Then
            --电子票据作废失败
            Raise Err_Item;
          End If;
		  
          Select 病人结帐记录_Id.Nextval Into n_冲销id From Dual;
          Zl_门诊收费记录_销帐(c_挂号.No, v_操作员编号, v_操作员姓名, Null, d_登记时间, Null, n_冲销id);
          v_退费结算 := v_结算方式 || '|' || -1 * n_挂号金额 || '|' || ' |' || ' ';
          Zl_门诊退费结算_Modify(2, n_病人id, n_冲销id, v_退费结算, 0, n_卡类别id, Null, v_交易流水号, Null, 0, 0, 0, 2);
        
          n_结帐id := c_挂号.原结帐id;
          n_冲销id := c_挂号.冲销id;
          n_Temp   := n_Temp + 1;
        Else
          n_结帐id := c_挂号.原结帐id;
          n_冲销id := c_挂号.冲销id;
        End If;
      End Loop;
    
      If n_Temp > 1 Then
        v_Err_Msg := '本次挂号存在多次收费，请先退费后再退号!';
        Raise Err_Item;
      End If;
    End If;

    --处理电子票据
    Select Sum(结帐金额) Into n_剩余金额 From 门诊费用记录 Where NO = v_No And 记录性质 = 4;
    Select Max(是否电子票据) Into n_是否电子票据 From 病人预交记录 Where 结帐id = n_挂号原结帐id;

    Update 病人预交记录 Set 是否电子票据 = n_是否电子票据 Where 结帐id = n_挂号冲销id;

    If Nvl(n_剩余金额, 0) <> 0 And Nvl(n_是否电子票据, 0) = 1 Then
      --部分结帐，需要重新开具电子票据
      If b_Einvoice_Request.Einvoice_Create(4, n_挂号原结帐id, n_挂号冲销id, v_Err_Msg) = 1 Then
        Select Max(1), Max(姓名), Max(号码), Max(To_Char(生成时间, 'yyyy-mm-dd')), Max(Url内网), Max(Url外网), Max(票据金额)
        Into n_开票标志, v_患者姓名, v_发票编号, v_开票日期, v_Url, v_Url外网, n_发票金额
        From 电子票据使用记录
        Where 结算id = n_结帐id And 票种 = 4 And 记录状态 = 1;
      End If;
    End If;

    If Nvl(n_挂号原结帐id, 0) <> Nvl(n_结帐id, 0) Then
      --收费部分的处理
      Select Max(是否电子票据) Into n_是否电子票据 From 病人预交记录 Where 结帐id = n_结帐id;
      If Nvl(n_是否电子票据, 0) = 1 Then

        Update 病人预交记录 Set 是否电子票据 = n_是否电子票据 Where 结帐id = n_冲销id;

        Select Sum(结帐金额)
        Into n_剩余金额
        From 门诊费用记录
        Where NO In (Select Distinct NO From 门诊费用记录 Where 结帐id = n_结帐id) And Mod(记录性质, 10) = 1;

        If Nvl(n_剩余金额, 10) <> 0 Then
          --部分开具
          If b_Einvoice_Request.Einvoice_Create(1, n_结帐id, n_冲销id, v_Err_Msg) = 1 Then
            If Nvl(n_开票标志, 0) = 1 Then
              Select Max(1), Max(姓名), Max(号码), Max(To_Char(To_Date(Substr(生成时间, 1, 8), 'yyyymmdd'), 'yyyy-mm-dd')), Max(Url内网), Max(Url外网), Max(票据金额)
              Into n_开票标志, v_患者姓名, v_发票编号, v_开票日期, v_Url, v_Url外网, n_发票金额
              From 电子票据使用记录
              Where 结算id = n_结帐id And 票种 = 1 And 记录状态 = 1;

            End If;
          End If;
        End If;
      End If;
    End If;
  End If;

  v_Temp := '<CZSJ>' || To_Char(d_登记时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<YJZID>' || n_结帐id || '</YJZID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<CXID>' || n_冲销id || '</CXID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<KPBZ>' || Nvl(n_开票标志, 0) || '</KPBZ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<URL>' || htf.escape_sc(Nvl(v_Url, '')) || '</URL>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<NETURL>' || htf.escape_sc(Nvl(v_Url外网, '')) || '</NETURL>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<FPTT>' || v_患者姓名 || '</FPTT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<FPH>' || v_发票编号 || '</FPH>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<FPJE>' || Nvl(n_发票金额, 0) || '</FPJE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<KPRQ>' || v_开票日期 || '</KPRQ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Registdel;
/
Create Or Replace Procedure Zl_Third_Getpati_Unique
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:获取病人的唯一标识(病人ID) 
  --入参:Xml_In: 
  --   <IN> 
  --     <ZJH>证件号</ZJH>     //卡号 
  --     <ZJLX>证件类型</ZJLX>  //医疗卡类别.名称 
  --     <XM>姓名</XM> 
  --     <KH>卡号</KH> 
  --     <KLB>卡类别</KLB> 
  --    </IN> 
  --出参:Xml_Out 
  -- <OUTPUT> 
  --   <BRID>病人ID</BRID> 
  --   <MZH>门诊号</MZH> 
  --   <ERROR><MSG>错误信息</MSG></ERROR> 
  --  </OUTPUT> 

  -------------------------------------------------------------------------------------------------- 
  v_Err_Msg varchar2(200);
  Err_Item Exception;

  x_Templet Xmltype; --模板XML 

  v_证件号       varchar2(50);
  v_证件类型     医疗卡类别.名称%Type;
  v_姓名         varchar2(100);
  v_验证姓名     varchar2(100);
  v_卡号         varchar2(100);
  v_卡类别       varchar2(100);
  n_存在         Number(3);
  n_卡类别id     病人医疗卡信息.卡类别id%Type;
  v_操作员       人员表.姓名%Type;
  v_验证身份证号 病人信息.身份证号%Type;

  n_病人id     病人信息.病人id%Type;
  n_验证病人id 病人信息.病人id%Type;
  n_门诊号     病人信息.门诊号%Type;

  v_Temp varchar2(32767); --临时XML 
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/ZJH'), Extractvalue(Value(A), 'IN/ZJLX'), Extractvalue(Value(A), 'IN/XM'),
         Extractvalue(Value(A), 'IN/KH'), Extractvalue(Value(A), 'IN/KLB')
  Into v_证件号, v_证件类型, v_姓名, v_卡号, v_卡类别
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --先从用户自定义过程获取病人ID 
  n_病人id := Zl_Third_Custom_Getpati(v_卡类别, v_卡号);

  If Nvl(n_病人id, 0) = 0 Then
    If v_证件类型 Like '%身份证%' And v_证件号 Is Not Null And v_姓名 Is Not Null Then
      n_病人id := Zl_Third_Getpatiid(v_证件号,v_姓名);
    Else
      If Nvl(v_卡类别, '-') <> '-' And Nvl(v_卡号, '-') <> '-' Then
	    Select Max(a.病人id)
	    Into n_病人id
	    From 病人医疗卡信息 A
	    Where a.卡类别id = (Select Max(ID) From 医疗卡类别 Where 名称 = v_卡类别 And Nvl(是否启用, 0) = 1) And 卡号 = v_卡号 And
              (a.状态 = 0 Or Nvl(a.状态, 0) = 1 And Exists
               (Select 1 From 医疗卡挂失方式 Where a.挂失方式 = 名称 And a.挂失时间 + 有效天数 < Trunc(Sysdate)));
	  End If;
	End IF;
  
    If Nvl(n_病人id, 0) = 0 Then
      v_Err_Msg := '未找到该登记号的病人信息，请检查输入的登记号是否正确!';
      Raise Err_Item;
    End If;
  
  End If;

  If Nvl(n_病人id, 0) <> 0 Then
    v_Temp := '<BRID>' || n_病人id || '</BRID>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Select 门诊号, 姓名, 身份证号 Into n_门诊号, v_验证姓名, v_验证身份证号 From 病人信息 Where 病人id = n_病人id;
    If v_姓名 <> v_验证姓名 Then
      v_Err_Msg := '传入的病人姓名与已有的病人姓名不符,请检查!';
      Raise Err_Item;
    End If;
    If Not v_证件号 Is Null Then
      If v_证件类型 Like '%身份证%' Then
        If v_证件号 <> v_验证身份证号 Then
          v_Err_Msg := '传入的病人身份证号与已有的病人身份证号不符,请检查!';
          Raise Err_Item;
        End If;
      Else
        Select Max(病人id)
        Into n_验证病人id
        From 病人医疗卡信息 A
        Where 卡类别id = (Select Max(ID) From 医疗卡类别 Where 名称 = v_证件类型 And Nvl(是否启用, 0) = 1) And 卡号 = v_证件号 And
              (a.状态 = 0 Or Nvl(a.状态, 0) = 1 And Exists
               (Select 1 From 医疗卡挂失方式 Where a.挂失方式 = 名称 And a.挂失时间 + 有效天数 < Trunc(Sysdate)));
        If n_验证病人id <> n_病人id Then
          v_Err_Msg := '传入的病人证件类型与已有的病人证件类型不符,请检查!';
          Raise Err_Item;
        End If;
      End If;
    End If;
    If n_门诊号 Is Null Then
      n_门诊号 := Nextno(3);
      Update 病人信息 Set 门诊号 = n_门诊号 Where 病人id = n_病人id;
    End If;
    v_Temp := '<MZH>' || n_门诊号 || '</MZH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End If;

  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpati_Unique;
/
Create Or Replace Procedure Zl_Third_Charge_Delapply
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  ---入参：
  ---<IN> 
  ---  <BRID></BRID>        //病人ID
  ---  <XM></XM>        //姓名
  ---  <SFZH></SFZH>      //身份证号
  ---  <JSKLB></JSKLB >　//结算卡类别(暂固定传“支付宝”，同医疗卡类别名称，主要用于不同平台的区分)
  ---  <SQSM></ SQSM >      //固定传“支付宝退款申请”
  ---  <FYLIST>
  ---    <FY>
  ---      <DJH> </DJH>   //单据号
  ---      <DJLX></DJLX>   //单据类型
  ---      <JE></JE>       //单据金额
  ---    </FY>
  ---  </FYLIST>
  ---</IN>
  ---出参:
  ---<OUTPUT>
  ---  <ERROR><MSG></MSG></ERROR> //error节点为空表示退费申请成功
  ---</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_病人id     门诊费用记录.病人id%Type;
  v_身份证号   病人信息.身份证号%Type;
  v_结算卡类别 varchar2(100);
  n_卡类别id   医疗卡类别.Id%Type;
  v_申请说明   病人退费申请.申请原因%Type;
  n_金额       Number(8, 2);
  n_Klbid      Number(8);
  n_结帐id     Number(8);
  v_姓名       varchar2(10);
  x_Templet    Xmltype; --模板XML
  v_Temp       varchar2(1000);
  v_Err_Msg    varchar2(200);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  ---获取基本信息
  Select To_Number(Extractvalue(Value(A), 'IN/BRID')), Extractvalue(Value(A), 'IN/JSKLB'),
         Extractvalue(Value(A), 'IN/SQSM'), Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM')
  Into n_病人id, v_结算卡类别, v_申请说明, v_身份证号,v_姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号,v_姓名);
  End If;
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '无法确定病人信息,请检查';
    Raise Err_Item;
  End If;

  Select ID Into n_卡类别id From 医疗卡类别 Where 名称 = v_结算卡类别;
  Select 姓名 Into v_姓名 From 病人信息 Where 病人id = n_病人id;

  ---退费申请检查
  For Mx In (Select Extractvalue(b.Column_Value, '/FY/DJH') As 单据号,
                    To_Number(Extractvalue(b.Column_Value, '/FY/DJLX')) As 单据类型,
                    To_Number(Extractvalue(b.Column_Value, '/FY/JE')) As 金额
             From Table(Xmlsequence(Extract(Xml_In, '/IN/FYLIST/FY'))) B) Loop
  
    If Mx.单据号 Is Null Then
      v_Err_Msg := '未确定指定退费申请的单据号,不能退费申请!';
      Raise Err_Item;
    End If;
  
    Begin
      Select a.结帐id, Sum(a.实收金额)
      Into n_结帐id, n_金额
      From 门诊费用记录 A
      Where a.No = Mx.单据号 And a.记录性质 = Mx.单据类型 And a.病人id = n_病人id And a.记录状态 In (1, 3)
      Group By a.结帐id;
    Exception
      When Others Then
        v_Err_Msg := '未确定指定退费申请的单据号,不能退费申请!';
        Raise Err_Item;
    End;
  
    If Mx.金额 <> n_金额 Then
      v_Err_Msg := '申请退费金额不正确，退费申请失败!';
      Raise Err_Item;
    End If;
  
    Select Distinct 卡类别id Into n_Klbid From 病人预交记录 Where 结帐id = n_结帐id;
  
    If n_卡类别id <> n_Klbid Then
      v_Err_Msg := '申请退费的单据不是由' || v_结算卡类别 || '结算，不能进行退费申请!';
      Raise Err_Item;
    End If;
  
    Zl_病人退费申请_Apply(0, Mx.单据号, Mx.单据类型, v_姓名, Sysdate, v_申请说明);
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '<ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Charge_Delapply;
/
Create Or Replace Procedure Zl_Third_Charge_Delcheck
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:三方退费检查 
  --入参:Xml_In: 
  --<IN> 
  --    <BRID>病人ID</BRID> 
  --    <XM>姓名</XM> 
  --    <SFZH>身份证号</SFZH> 
  --    <JE></JE> //退款总金额 
  --    <JSKLB></JSKLB>     //结算卡类别 
  --    <TFZY>退费摘要</TFZY> 
  --    <JCFP>1</JCFP>      //检查发票,0-不检查;1-检查;为1时，打印了发票的单据不能退费 
  --    <XL>险类</XL>         //医保病人险类,空代表普通病人 
  --    <FYLIST> 
  --        <FY> 
  --           <DJH>退款单据号</DJH> 
  --           <XH>退款序号(格式:1,2,3..为空代表退剩余数量)</DJH> 
  --        <FY> 
  --    </FYLIST> 
  --    <TKLIST> 
  --        <TK> 
  --            <TKKLB>退款卡类别</TKKLB> 
  --            <TKKH>退款卡号</TKKH> 
  --            <TKFS>退款方式</TKFS> //退款方式:现金;支票,如果是三方卡,可以传空 
  --            <TKJE>支付金额</TKJE> 
  --            <JYLSH>交易流水号</JYLSH> 
  --            <JYSM>交易说明</JYSM> 
  --            <TKZY>摘要</TKZY> 
  --            <TYJK>退回预交款</TYJK> //允冲预交时,只填JSJE节点:1-冲预交 
  --            <SFXFK>是否消费卡</SFXFK>   //(1-是消费卡),消费卡时,传入结算卡类别,结算卡号,结算金额等接点 
  --            <DJH>S0000001</DJH> //分单据结算时传入 
  --            <EXPENDLIST>  //扩展交易信息 
  --                <EXPEND> 
  --                    <JYMC>交易名称</JYMC> 
  --                    <JYLR>交易内容</JYLR> 
  --                </EXPEND> 
  --            </EXPENDLIST> 
  --        </TK> 
  --    </TKLIST> 
  --</IN> 

  --出参:Xml_Out 
  --  <OUT> 
  --    DD如无下列错误结点则说明通过检查 
  --    <ERROR> 
  --      <MSG>错误信息</MSG> 
  --    </ERROR> 
  --  </OUT> 
  -------------------------------------------------------------------------------------------------- 
  n_退款总额 门诊费用记录.实收金额%Type;

  n_病人id     门诊费用记录.病人id%Type;
  v_姓名       病人信息.姓名%Type;
  v_身份证号   病人信息.身份证号%Type;
  n_单据病人id 门诊费用记录.病人id%Type;
  n_结帐id     门诊费用记录.结帐id%Type;
  n_原结算序号 病人预交记录.结算序号%Type;
  v_结算卡类别 Varchar2(100);
  v_结算方式   医疗卡类别.结算方式%Type;
  n_卡类别id   医疗卡类别.Id%Type;
  v_卡名称     医疗卡类别.名称%Type;

  v_摘要     门诊费用记录.摘要%Type;
  n_Count    Number(18);
  n_Temp     Number(18);
  n_检查发票 Number(3);
  n_是否打印 Number(3);
  n_退费模式 Number(3);
  n_状态     Number(3);
  n_险类     病人信息.险类%Type;

  v_Temp    Varchar2(32767); --临时XML 
  x_Templet Xmltype; --模板XML 

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  --0.获取入参中的病人ID等信息 
  Select To_Number(Extractvalue(Value(A), 'IN/BRID')), To_Number(Extractvalue(Value(A), 'IN/JE')),
         Extractvalue(Value(A), 'IN/TFZY'), To_Number(Extractvalue(Value(A), 'IN/JCFP')),
         Extractvalue(Value(A), 'IN/JSKLB'), To_Number(Extractvalue(Value(A), 'IN/XL')),
         Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM')
  Into n_病人id, n_退款总额, v_摘要, n_检查发票, v_结算卡类别, n_险类, v_身份证号, v_姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  --0.相关检查 
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '不能有效识别病人身份,不允许退费操作!';
    Raise Err_Item;
  End If;

  n_退费模式 := zl_GetSysParameter('门诊退费须先申请');

  If v_结算卡类别 Is Not Null Then
    Begin
      n_卡类别id := To_Number(v_结算卡类别);
    Exception
      When Others Then
        n_卡类别id := 0;
    End;
    If n_卡类别id = 0 Then
      Begin
        Select ID, 名称 Into n_卡类别id, v_卡名称 From 医疗卡类别 Where 名称 = v_结算卡类别;
      Exception
        When Others Then
          v_Err_Msg := '无法确认传入的结算卡！';
          Raise Err_Item;
      End;
    Else
      Begin
        Select 名称 Into v_卡名称 From 医疗卡类别 Where ID = n_卡类别id;
      Exception
        When Others Then
          v_Err_Msg := '无法确认传入的结算卡！';
          Raise Err_Item;
      End;
    End If;
  Else
    n_卡类别id := 0;
  End If;

  If Nvl(n_卡类别id, 0) <> 0 Then
    Select 结算方式 Into v_结算方式 From 医疗卡类别 Where ID = n_卡类别id;
  End If;

  --人员id,人员编号,人员姓名 
  v_Temp := Zl_Identity(1);
  If Nvl(v_Temp, '0') = '0' Or Nvl(v_Temp, '_') = '_' Then
    v_Err_Msg := '系统不能认别有效的操作员,不允许退费!';
    Raise Err_Item;
  End If;

  --1.退费检查 
  n_Count      := 0;
  n_原结算序号 := 0;
  For c_费用 In (Select Extractvalue(b.Column_Value, '/FY/DJH') As 单据号, Extractvalue(b.Column_Value, '/FY/XH') As 退款序号
               From Table(Xmlsequence(Extract(Xml_In, '/IN/FYLIST/FY'))) B) Loop
  
    If c_费用.单据号 Is Null Then
      v_Err_Msg := '未确定指定退费的单据号,不能退费!';
      Raise Err_Item;
    End If;
  
    If Nvl(n_退费模式, 0) = 1 Then
      Begin
        Select Nvl(状态, 0) Into n_状态 From 病人退费申请 Where NO = c_费用.单据号 And Mod(记录性质, 10) = 1;
      Exception
        When Others Then
          n_状态 := 0;
      End;
      If n_状态 <> 1 Then
        v_Err_Msg := '当前为退费申请模式,退费之前需申请并审核通过该单据!';
        Raise Err_Item;
      End If;
    End If;
  
    Begin
      Select a.结算序号, a.结帐id, a.病人id
      Into n_Temp, n_结帐id, n_单据病人id
      From 病人预交记录 A, 门诊费用记录 B
      Where a.结帐id = b.结帐id And b.No = c_费用.单据号 And b.记录性质 = 1 And Nvl(b.费用状态, 0) = 0 And b.记录状态 In (1, 3) And
            Rownum < 2;
    Exception
      When Others Then
        n_Temp := Null;
    End;
  
    If n_Temp Is Null Then
      v_Err_Msg := '指定的单据号:' || c_费用.单据号 || '未找到,不能退费!';
      Raise Err_Item;
    End If;
  
    If Nvl(n_单据病人id, 0) = 0 Then
      Begin
        Select 病人id
        Into n_单据病人id
        From 门诊费用记录
        Where NO = c_费用.单据号 And 记录性质 = 1 And Nvl(费用状态, 0) = 0 And 记录状态 In (1, 3) And Rownum < 2;
      Exception
        When Others Then
          n_单据病人id := 0;
      End;
    End If;
  
    If Nvl(n_病人id, 0) <> Nvl(n_单据病人id, 0) Then
      v_Err_Msg := '本次退费的收费单:' || c_费用.单据号 || '不是当前病人的收费单,不能退费!';
      Raise Err_Item;
    End If;
  
    If n_原结算序号 <> 0 And n_原结算序号 <> n_Temp Then
      v_Err_Msg := '本次退费的单据号不是一次收费结算,不能退费!';
      Raise Err_Item;
    End If;
    n_原结算序号 := n_Temp;
  
    Select Count(1) Into n_Temp From 费用补充记录 Where 收费结帐id = n_结帐id;
    If Nvl(n_Temp, 0) <> 0 Then
      v_Err_Msg := '本次退费的单据号已经进行了保险补充结算,不能退费!';
      Raise Err_Item;
    End If;
  
    If Nvl(n_卡类别id, 0) <> 0 Then
      If Nvl(n_险类, 0) = 0 Then
        Select Count(1) Into n_Temp From 病人预交记录 Where 结帐id = n_结帐id And 卡类别id <> n_卡类别id;
      Else
        Select Count(1)
        Into n_Temp
        From 病人预交记录 A, 结算方式 B
        Where a.结帐id = n_结帐id And 卡类别id <> n_卡类别id And a.结算方式 = b.名称 And b.性质 Not In (3, 4);
        If n_Temp = 0 Then
          Select Nvl(Max(1), 0)
          Into n_Temp
          From 保险结算记录 A
          Where a.记录id = n_结帐id And 险类 <> n_险类 And Rownum < 2;
        End If;
      End If;
      If Nvl(n_Temp, 0) > 0 Then
        v_Err_Msg := '本次退费的单据包含' || v_结算方式 || '以外的结算方式,不能退费!';
        Raise Err_Item;
      End If;
    End If;
  
    If Nvl(n_检查发票, 0) = 1 Then
      Select Max(Decode(a.实际票号, Null, 0, 1))
      Into n_是否打印
      From 门诊费用记录 A
      Where NO = c_费用.单据号 And 记录性质 = 1;
      If Nvl(n_是否打印, 0) = 1 Then
        v_Err_Msg := '本次退费的单据号已开发票,不能退费!';
        Raise Err_Item;
      End If;
    End If;
  
    --电子票据检查 
    If b_Einvoice_Request.Einvoice_Cancel_Check(1, n_结帐id, v_Err_Msg) = 0 Then
      --失败后，直接抛错
      Raise Err_Item;
    End If;
  
    n_Count := n_Count + 1;
  End Loop;

  If n_Count = 0 Then
    v_Err_Msg := '未确定本次需要退费的单据,不能退费!';
    Raise Err_Item;
  End If;

  --2.支付方式检查 
  n_Count := 0;
  For c_结算方式 In (Select Extractvalue(b.Column_Value, '/TK/TKKLB') As 卡类别, Extractvalue(b.Column_Value, '/TK/TKKH') As 卡号,
                        Extractvalue(b.Column_Value, '/TK/TKFS') As 结算方式,
                        -1 * To_Number(Extractvalue(b.Column_Value, '/TK/TKJE')) As 退款金额,
                        Extractvalue(b.Column_Value, '/TK/JYLSH') As 交易流水号,
                        Extractvalue(b.Column_Value, '/TK/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/TK/TKZY') As 摘要,
                        Extractvalue(b.Column_Value, '/TK/TYJK') As 是否退预交,
                        Extractvalue(b.Column_Value, '/TK/SFXFK') As 是否消费卡,
                        Extract(b.Column_Value, '/TK/EXPENDLIST') As Expend
                 From Table(Xmlsequence(Extract(Xml_In, '/IN/TKLIST/TK'))) B) Loop
  
    --1.退回三方卡 
    If c_结算方式.卡类别 Is Not Null And Nvl(c_结算方式.是否消费卡, 0) = 0 Then
      --1.三方卡结算 
      Null;
    Elsif c_结算方式.卡类别 Is Not Null And Nvl(c_结算方式.是否消费卡, 0) = 1 Then
      --2.消费卡结算 
      Null;
    Elsif Nvl(c_结算方式.是否退预交, 0) = 1 Then
      --3.退预交款 
      Null;
    Else
      --4.普通结算 
      If c_结算方式.结算方式 Is Null Then
        v_Err_Msg := '未指定支付方式,不能退费!';
        Raise Err_Item;
      End If;
    End If;
    n_Count := n_Count + 1;
  End Loop;

  If n_Count = 0 Then
    v_Err_Msg := '不能有效确认当前的支付方式,不能退费!';
    Raise Err_Item;
  End If;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Charge_Delcheck;
/ 
CREATE OR REPLACE Procedure Zl_Third_Charge_Del
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is

  --------------------------------------------------------------------------------------------------
  --功能:三方退费交易
  --入参:Xml_In:
  --<IN>
  --    <BRID>病人ID</BRID>
  --    <XM>姓名</XM>
  --    <SFZH>身份证号</SFZH>
  --    <JE></JE> //退款总金额
  --    <JSKLB></JSKLB>     //结算卡类别
  --    <TFZY>退费摘要</TFZY>
  --    <JCFP>1</JCFP>      //检查发票
  --    <JSMS>1</JSMS>          //结算模式：0-普通模式，1-异步结算模式
  --    <CZLX>0</CZLX>          //操作类型：结算模式为1时传入，0-开始结算，1-完成结算，2-回退结算
  --    <CXID>1</CXID>          //冲销结帐ID，操作类型为1或2时传入
  --    <FYLIST>
  --        <FY>
  --           <DJH>退款单据号</DJH>
  --           <XH>退款序号(格式:1,2,3..为空代表退剩余数量)</DJH>
  --        <FY>
  --    </FYLIST>
  --    <TKLIST>          //结算列表，操作类型为2时可不传入
  --        <TK>
  --            <TKKLB>退款卡类别</TKKLB>
  --            <TKKH>退款卡号</TKKH>
  --            <TKFS>退款方式</TKFS> //退款方式:现金;支票,如果是三方卡,可以传空
  --            <TKJE>支付金额</TKJE>
  --            <JYLSH>交易流水号</JYLSH>
  --            <TKZY>摘要</TKZY>
  --            <TYJK>退回预交款</TYJK> //允冲预交时,只填JSJE节点:1-冲预交
  --            <SFXFK>是否消费卡</SFXFK>   //(1-是消费卡),消费卡时,传入结算卡类别,结算卡号,结算金额等接点
  --            <DJH>S0000001</DJH> //分单据结算时传入
  --            <EXPENDLIST>  //扩展交易信息
  --                <EXPEND>
  --                    <JYMC>交易名称</JYMC>
  --                    <JYLR>交易内容</JYLR>
  --                </EXPEND>
  --            </EXPENDLIST>
  --        </TK>
  --    </TKLIST>
  --</IN>

  --出参:Xml_Out
  --  <OUTPUT>
  --    <CZSJ>操作时间</CZSJ>          //HIS的登记时间
  --    <YJZID>原结帐ID</YJZID>       //原结帐ID
  --    <CXID>冲销ID</CXID>          //冲销ID
  --  <KPBZ>开票标志</KPBZ> //1-成功开具电子票据;0-未开票成功标志
  --  <URL>H5页面URL</URL>
  --  <NETURL>外网H5页面URL</NETURL>
  --  <FPTT>发票抬头</FPTT>        //病人姓名
  --  <FPH>发票号</FPH>             //发票编号
  --  <FPJE>发票金额</FPJE>        //100.00
  --  <KPRQ>开票日期</KPRQ>   //yyyy-mm-dd
  --    DD如无下列错误结点则说明正确执行
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_退款总额 门诊费用记录.实收金额%Type;
  n_卡类别id 医疗卡类别.Id%Type;
  v_结算方式 Varchar2(2000);
  n_结算模式 Number(1); --0-普通模式，1-异步结算模式
  n_操作类型 Number(1); --结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算

  n_病人id     门诊费用记录.病人id%Type;
  v_姓名       病人信息.姓名%Type;
  v_身份证号   病人信息.身份证号%Type;
  n_单据病人id 门诊费用记录.病人id%Type;
  v_操作员编码 门诊费用记录.操作员编号%Type;
  v_操作员姓名 门诊费用记录.操作员姓名%Type;
  n_冲销id     门诊费用记录.结帐id%Type;
  n_结帐id     门诊费用记录.结帐id%Type;
  n_结帐金额   门诊费用记录.结帐金额%Type;
  n_误差额     病人预交记录.冲预交%Type;
  n_原结算序号 病人预交记录.结算序号%Type;
  l_挂号单     t_StrList := t_StrList();
  n_结算序号   病人预交记录.结算序号%Type;
  n_检查发票   Number(3);
  n_是否打印   Number(3);
  v_结算卡类别 Varchar2(100);
  v_结帐ids    Varchar2(1000);

  n_消费卡     Number;
  n_消费卡id   消费卡信息.Id%Type;
  v_摘要       门诊费用记录.摘要%Type;
  n_Count      Number(18);
  n_Billcount  Number(18);
  n_关联交易id 病人预交记录.关联交易id%Type;
  n_删除原结算 Number;

  d_退费时间 病人预交记录.收款时间%Type;
  v_挂号单   病人挂号记录.No%Type;
  v_收费单   门诊费用记录.No%Type;

  v_退费结算 Varchar2(2000);
  v_普通结算 Varchar2(4000);
  n_剩余金额 门诊费用记录.结帐金额%Type;

  n_是否电子票据 病人预交记录.是否电子票据%Type;
  n_开票标志     Number(2);
  v_患者姓名     电子票据使用记录.姓名%Type;
  v_发票编号     电子票据使用记录.号码%Type;
  v_开票日期     Varchar2(20);
  n_发票金额     电子票据使用记录.票据金额%Type;
  v_Url          电子票据使用记录.Url内网%Type;
  v_Url外网      电子票据使用记录.Url外网%Type;

  v_Temp    Varchar2(32767); --临时XML
  v_Err_Msg Varchar2(200);
  Err_Item Exception;

  --获取卡类别名称
  Function Get_Cardname
  (
    卡类别_In Varchar2,
    消费卡_In Number
  ) Return Varchar2 As
    v_名称       医疗卡类别.名称%Type;
    n_By_Id_Find Number;

    v_Err_Msg Varchar2(200);
    Err_Item Exception;
  Begin
    If 卡类别_In Is Null Then
      Return Null;
    End If;

    Select Decode(Translate(Nvl(卡类别_In, 'abcd'), '#1234567890', '#'), Null, 1, 0) Into n_By_Id_Find From Dual;

    --1.按卡类别ID查找医疗卡
    If Nvl(消费卡_In, 0) = 0 And Nvl(n_By_Id_Find, 0) = 1 Then
      Begin
        Select 名称 Into v_名称 From 医疗卡类别 Where ID = To_Number(卡类别_In);
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息！';
          Raise Err_Item;
      End;
    End If;

    --2.按卡名称查找医疗卡
    If Nvl(消费卡_In, 0) = 0 And Nvl(n_By_Id_Find, 0) = 0 Then
      Begin
        Select 名称 Into v_名称 From 医疗卡类别 Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := 卡类别_In || '不存在!';
          Raise Err_Item;
      End;
    End If;

    --3.按卡类别ID查找消费卡
    If Nvl(消费卡_In, 0) = 1 And Nvl(n_By_Id_Find, 0) = 1 Then
      Begin
        Select 名称 Into v_名称 From 消费卡类别目录 Where 编号 = To_Number(卡类别_In);
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息！';
          Raise Err_Item;
      End;
    End If;

    --3.按卡名称查找消费卡
    If Nvl(消费卡_In, 0) = 1 And Nvl(n_By_Id_Find, 0) = 0 Then
      Begin
        Select 名称 Into v_名称 From 消费卡类别目录 Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := 卡类别_In || '不存在!';
          Raise Err_Item;
      End;
    End If;

    Return v_名称;
  Exception
    When Err_Item Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  End;

  --获取卡类别ID
  Function Get_Cardtypeid
  (
    卡类别_In    Varchar2,
    消费卡_In    Number,
    结算方式_Out In Out 医疗卡类别.结算方式%Type
  ) Return Number As
    n_卡类别id 医疗卡类别.Id%Type;
    v_名称     医疗卡类别.名称%Type;
    n_启用     医疗卡类别.是否启用%Type;
    v_结算方式 医疗卡类别.结算方式%Type;

    n_By_Id_Find Number;
    v_Err_Msg    Varchar2(200);
    Err_Item Exception;
  Begin
    If 卡类别_In Is Null Then
      Return 0;
    End If;

    Select Decode(Translate(Nvl(卡类别_In, 'abcd'), '#1234567890', '#'), Null, 1, 0) Into n_By_Id_Find From Dual;

    --1.按卡类别ID查找医疗卡
    If Nvl(消费卡_In, 0) = 0 And Nvl(n_By_Id_Find, 0) = 1 Then
      Begin
        Select ID, 结算方式, 名称, 是否启用
        Into n_卡类别id, v_名称, v_结算方式, n_启用
        From 医疗卡类别
        Where ID = To_Number(卡类别_In);
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息！';
          Raise Err_Item;
      End;
    End If;

    --2.按卡名称查找医疗卡
    If Nvl(消费卡_In, 0) = 0 And Nvl(n_By_Id_Find, 0) = 0 Then
      Begin
        Select ID, 结算方式, 名称, 是否启用
        Into n_卡类别id, v_名称, v_结算方式, n_启用
        From 医疗卡类别
        Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := 卡类别_In || '不存在!';
          Raise Err_Item;
      End;
    End If;

    --3.按卡类别ID查找消费卡
    If Nvl(消费卡_In, 0) = 1 And Nvl(n_By_Id_Find, 0) = 1 Then
      Begin
        Select 编号, 结算方式, 名称, 启用
        Into n_卡类别id, v_名称, v_结算方式, n_启用
        From 消费卡类别目录
        Where 编号 = To_Number(卡类别_In);
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息！';
          Raise Err_Item;
      End;
    End If;

    --3.按卡名称查找消费卡
    If Nvl(消费卡_In, 0) = 1 And Nvl(n_By_Id_Find, 0) = 0 Then
      Begin
        Select 编号, 结算方式, 名称, 启用
        Into n_卡类别id, v_名称, v_结算方式, n_启用
        From 消费卡类别目录
        Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := 卡类别_In || '不存在!';
          Raise Err_Item;
      End;
    End If;

    If Nvl(n_启用, 0) = 0 Then
      v_Err_Msg := v_名称 || '未启用，不允许进行缴费！';
      Raise Err_Item;
    End If;

    If 结算方式_Out Is Null Then
      If v_结算方式 Is Null Then
        v_Err_Msg := v_名称 || '未设置结算方式，不允许进行缴费！';
        Raise Err_Item;
      End If;

      结算方式_Out := v_结算方式;
    End If;

    Return n_卡类别id;
  Exception
    When Err_Item Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  End;

  Procedure Thirdcard_Balance
  (
    病人id_In     病人预交记录.病人id%Type,
    冲销id_In     病人预交记录.结帐id%Type,
    结算方式_In   病人预交记录.结算方式%Type,
    卡类别_In     病人预交记录.卡类别id%Type,
    卡号_In       病人预交记录.卡号%Type,
    退款金额_In   病人预交记录.冲预交%Type,
    交易流水号_In 病人预交记录.交易流水号%Type,
    交易说明_In   病人预交记录.交易说明%Type,
    No_In         病人预交记录.No%Type,
    关联交易id_In 病人预交记录.关联交易id%Type,
    摘要_In       病人预交记录.摘要%Type,
    Xmlexpned_In  Xmltype,
    结算模式_In   Number := 0,
    操作类型_In   Number := 0,
    删除原结算_In Number := 0
  ) Is
    --入参：
    --         结算模式_in   0-普通模式，1-异步结算模式
    --        操作类型_in   结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算
    --        删除原结算_in 操作类型_In为1时有效，多个结算方式时调用多次该过程
    v_退费结算 Varchar2(2000);
    n_校对标志 病人预交记录.校对标志%Type;
  Begin
    If Nvl(结算模式_In, 0) = 1 And Nvl(操作类型_In, 0) = 0 Then
      n_校对标志 := 1;
    Else
      n_校对标志 := 2;
    End If;

    --结算方式|结算金额|结算号码|结算摘要|单据号|是否普通结算
    v_退费结算 := 结算方式_In || '|' || 退款金额_In || '| |' || 摘要_In || '|' || No_In || '|0';
    Zl_门诊退费结算_Modify(5, 病人id_In, 冲销id_In, v_退费结算, 0, 卡类别_In, 卡号_In, 交易流水号_In, 交易说明_In, 0, 0, 0, 0, Null, 0, Null, Null,
                     关联交易id_In, 删除原结算_In, n_校对标志);

    If Nvl(结算模式_In, 0) = 1 And Nvl(操作类型_In, 0) = 0 Then
      Return;
    End If;

    --保存扩展结算信息
    For c_扩展 In (Select Extractvalue(j.Column_Value, '/EXPEND/JYMC') As Jymc,
                        Extractvalue(j.Column_Value, '/EXPEND/JYLR') As Jylr
                 From Table(Xmlsequence(Extract(Xmlexpned_In, '/EXPENDLIST/EXPEND'))) J) Loop
      Zl_三方结算交易_Insert(卡类别_In, 0, 卡号_In, 冲销id_In, c_扩展.Jymc || '|' || c_扩展.Jylr);
    End Loop;
  End Thirdcard_Balance;

  Procedure Squarecard_Balance
  (
    病人id_In     病人预交记录.病人id%Type,
    冲销id_In     病人预交记录.结帐id%Type,
    卡类别_In     病人预交记录.卡类别id%Type,
    卡号_In       病人预交记录.卡号%Type,
    退款金额_In   病人预交记录.冲预交%Type,
    交易流水号_In 病人预交记录.交易流水号%Type,
    交易说明_In   病人预交记录.交易说明%Type,
    Xmlexpned_In  Xmltype
  ) Is
    v_退费结算 Varchar2(2000);
    n_消费卡id 消费卡信息.Id%Type;
  Begin
    Select ID
    Into n_消费卡id
    From 消费卡信息
    Where 接口编号 = 卡类别_In And 卡号 = 卡号_In And
          序号 = (Select Max(序号) From 消费卡信息 Where 接口编号 = 卡类别_In And 卡号 = 卡号_In);

    --卡类别ID|卡号|消费卡ID|消费金额||.
    v_退费结算 := 卡类别_In || '|' || 卡号_In || '|' || n_消费卡id || '|' || 退款金额_In;
    Zl_门诊退费结算_Modify(4, 病人id_In, 冲销id_In, v_退费结算, 0, Null, 卡号_In, 交易流水号_In, 交易说明_In, 0, 0, 0, 0);

    --保存扩展结算信息
    For c_扩展 In (Select Extractvalue(j.Column_Value, '/EXPEND/JYMC') As Jymc,
                        Extractvalue(j.Column_Value, '/EXPEND/JYLR') As Jylr
                 From Table(Xmlsequence(Extract(Xmlexpned_In, '/EXPENDLIST/EXPEND'))) J) Loop
      Zl_三方结算交易_Insert(卡类别_In, 1, 卡号_In, 冲销id_In, c_扩展.Jymc || '|' || c_扩展.Jylr, 0);
    End Loop;
  End Squarecard_Balance;

Begin
  --0.获取入参中的病人ID等信息
  Select To_Number(Extractvalue(Value(A), 'IN/BRID')), To_Number(Extractvalue(Value(A), 'IN/JE')),
         Extractvalue(Value(A), 'IN/TFZY'), To_Number(Extractvalue(Value(A), 'IN/JCFP')),
         Extractvalue(Value(A), 'IN/JSKLB'), Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM'),
         Extractvalue(Value(A), 'IN/JSMS'), Extractvalue(Value(A), 'IN/CZLX'), Extractvalue(Value(A), 'IN/CXID')
  Into n_病人id, n_退款总额, v_摘要, n_检查发票, v_结算卡类别, v_身份证号, v_姓名, n_结算模式, n_操作类型, n_冲销id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;

  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '无法确定病人信息,请检查!';
    Raise Err_Item;
  End If;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) <> 0 Then
    --n_结算模式 --0-普通模式，1-异步结算模式
    --n_操作类型 :结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算

    If Nvl(n_冲销id, 0) = 0 Then
      v_Err_Msg := '没有指定相关的结算数据！';
      Raise Err_Item;
    End If;

    Begin
      Select 收款时间
      Into d_退费时间
      From 病人预交记录
      Where 结帐id = n_冲销id And Nvl(校对标志, 0) = 1 And Rownum < 2;
    Exception
      When Others Then
        v_Err_Msg := '没有找到指定的相关结算数据，可能已被处理！';
        Raise Err_Item;
    End;

    Select f_List2Str(Cast(Collect(To_Char(a.结帐id)) As t_StrList), ',', 1)
    Into v_结帐ids
    From 门诊费用记录 A, 门诊费用记录 B
    Where a.No = b.No And a.记录性质 = b.记录性质 And a.记录性质 = 1 And a.记录状态 In (1, 3) And b.结帐id = n_冲销id;
  End If;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 2 Then
    --删除结算数据，恢复划价单
    --n_结算模式 --0-普通模式，1-异步结算模式
    --n_操作类型 :结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算

    Zl_病人结算记录_Delete(n_冲销id);
    Zl_门诊退费结算_Cancel(n_冲销id);

    v_Temp  := '<CZSJ>' || To_Char(d_退费时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
    v_Temp  := v_Temp || '<YJZID>' || v_结帐ids || '</YJZID>';
    v_Temp  := v_Temp || '<CXID>' || n_冲销id || '</CXID>';
    v_Temp  := v_Temp || '<KPBZ>' || 0 || '</KPBZ>';
    v_Temp  := v_Temp || '<URL>' || '' || '</URL>';
    v_Temp  := v_Temp || '<NETURL>' || '' || '</NETURL>';
    v_Temp  := v_Temp || '<FPTT>' || v_姓名 || '</FPTT>';
    v_Temp  := v_Temp || '<FPH>' || '' || '</FPH>';
    v_Temp  := v_Temp || '<FPJE>' || '' || '</FPJE>';
    v_Temp  := v_Temp || '<KPRQ>' || '' || '</KPRQ>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
    Return;
  End If;

  --人员id,人员编号,人员姓名
  v_Temp       := Zl_Identity(1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_操作员编码 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_操作员姓名 := v_Temp;

  If v_结算卡类别 Is Not Null Then
    n_卡类别id := Get_Cardtypeid(v_结算卡类别, 0, v_结算方式);
    If Nvl(n_卡类别id, 0) = 0 Then
      v_Err_Msg := '无法确认传入的结算卡！';
      Raise Err_Item;
    End If;
  End If;

  If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
    --n_结算模式 --0-普通模式，1-异步结算模式
    --n_操作类型 :结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算
    --1.先进行退费
    Select 病人结帐记录_Id.Nextval, Sysdate Into n_冲销id, d_退费时间 From Dual;
    n_Billcount  := 0;
    n_原结算序号 := 0;
    For c_费用 In (Select Extractvalue(b.Column_Value, '/FY/DJH') As 单据号, Extractvalue(b.Column_Value, '/FY/XH') As 退款序号
                 From Table(Xmlsequence(Extract(Xml_In, '/IN/FYLIST/FY'))) B) Loop
      Begin
        Select 结算序号, 结帐id, 病人id
        Into n_结算序号, n_结帐id, n_单据病人id
        From 病人预交记录
        Where 结帐id In (Select 结帐id
                       From 门诊费用记录
                       Where NO = c_费用.单据号 And 记录性质 = 1 And Nvl(费用状态, 0) = 0 And 记录状态 In (1, 3) And Rownum < 2) And
              Rownum < 2;
      Exception
        When Others Then
          n_结算序号 := Null;
      End;

      If Instr(',' || v_结帐ids || ',', ',' || n_结帐id || ',') = 0 Then
        v_结帐ids := v_结帐ids || ',' || n_结帐id;
        --先要对电子票据冲红处理
        If b_Einvoice_Request.Einvoice_Cancel(1, n_结帐id, v_Err_Msg) = 0 Then
          --电子票据作废失败
          Raise Err_Item;
        End If;
      End If;
      If n_结算序号 Is Null Then
        v_Err_Msg := '指定的单据号:' || c_费用.单据号 || '未找到,不能退费!';
        Raise Err_Item;
      End If;

      --挂号划价模式
      Select Max(Substr(a.摘要, 4))
      Into v_挂号单
      From 门诊费用记录 A
      Where a.No = c_费用.单据号 And a.记录性质 = 1 And a.摘要 Like '挂号:%' And Rownum < 2;
      If v_挂号单 Is Not Null Then
        Select Max(收费单) Into v_收费单 From 病人挂号记录 Where NO = v_挂号单;
        If v_收费单 Is Not Null Then
          Select Count(1)
          Into n_Count
          From 门诊费用记录 A
          Where a.记录性质 = 1 And a.记录状态 = 1 And a.No <> c_费用.单据号 And a.序号 = 1 And
                a.No In (Select /*+ cardinality(b, 10) */
                          Column_Value
                         From Table(f_Str2List(v_收费单)) B);
          If n_Count = 0 Then
            l_挂号单.Extend;
            l_挂号单(l_挂号单.Count) := v_挂号单;
          End If;
        End If;
      End If;

      If Nvl(n_单据病人id, 0) = 0 Then
        Select Nvl(Max(病人id), 0)
        Into n_单据病人id
        From 门诊费用记录
        Where NO = c_费用.单据号 And 记录性质 = 1 And Nvl(费用状态, 0) = 0 And 记录状态 In (1, 3) And Rownum < 2;
      End If;

      If Nvl(n_病人id, 0) <> Nvl(n_单据病人id, 0) Then
        v_Err_Msg := '本次退费的收费单:' || c_费用.单据号 || '不是当前病人的收费单,不能退费!';
        Raise Err_Item;
      End If;

      If n_原结算序号 <> 0 And n_原结算序号 <> n_结算序号 Then
        v_Err_Msg := '本次退费的单据不是一次收费结算,不能退费!';
        Raise Err_Item;
      End If;

      n_原结算序号 := n_结算序号;
      Select Count(1) Into n_Count From 费用补充记录 Where 收费结帐id = n_结帐id And Rownum < 2;
      If n_Count <> 0 Then
        v_Err_Msg := '本次退费的单据已经进行了保险补充结算,不能退费!';
        Raise Err_Item;
      End If;

      If v_结算卡类别 Is Not Null Then
        Select Count(1) Into n_Count From 病人预交记录 Where 结帐id = n_结帐id And 卡类别id = n_卡类别id;
        If n_Count = 0 Then
          v_Err_Msg := '本次退费的单据不是' || v_结算方式 || '结算的,不能退费!';
          Raise Err_Item;
        End If;
      End If;

      If Nvl(n_检查发票, 0) = 1 Then
        Select Max(Decode(a.实际票号, Null, 0, 1))
        Into n_是否打印
        From 门诊费用记录 A
        Where NO = c_费用.单据号 And 记录性质 = 1;
        If Nvl(n_是否打印, 0) = 1 Then
          v_Err_Msg := '本次退费的单据号已开发票,不能退费!';
          Raise Err_Item;
        End If;
      End If;

      Zl_门诊收费记录_销帐(c_费用.单据号, v_操作员编码, v_操作员姓名, c_费用.退款序号, d_退费时间, v_摘要, n_冲销id);
      n_Billcount := n_Billcount + 1;
    End Loop;
    If n_Billcount = 0 Then
      v_Err_Msg := '未确定本次需要退费的单据,不能退费!';
      Raise Err_Item;
    End If;

    --检查总金额是否正确
    Select Sum(结帐金额) Into n_结帐金额 From 门诊费用记录 Where 结帐id = n_冲销id;
    n_误差额 := -1 * Nvl(n_结帐金额, 0) - Nvl(n_退款总额, 0);
    If Abs(n_误差额) > 1.00 Then
      v_Err_Msg := '单据缴款金额与实际结算的误差太大!';
      Raise Err_Item;
    End If;
  End If;

  --2.处理退费的结算信息
  --2.确定支付方式
  n_删除原结算 := 0;
  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 1 Then
    n_删除原结算 := 1;
  End If;
  For c_结算方式 In (Select Extractvalue(b.Column_Value, '/TK/TKKLB') As 卡类别, Extractvalue(b.Column_Value, '/TK/TKKH') As 卡号,
                        Extractvalue(b.Column_Value, '/TK/TKFS') As 结算方式,
                        -1 * To_Number(Extractvalue(b.Column_Value, '/TK/TKJE')) As 退款金额,
                        Extractvalue(b.Column_Value, '/TK/JYLSH') As 交易流水号,
                        Extractvalue(b.Column_Value, '/TK/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/TK/TKZY') As 摘要,
                        Extractvalue(b.Column_Value, '/TK/TYJK') As 是否退预交,
                        Extractvalue(b.Column_Value, '/TK/SFXFK') As 是否消费卡,
                        Extractvalue(b.Column_Value, '/TK/DJH') As 单据号,
                        Extract(b.Column_Value, '/TK/EXPENDLIST') As Expend
                 From Table(Xmlsequence(Extract(Xml_In, '/IN/TKLIST/TK'))) B) Loop

    n_消费卡 := Nvl(c_结算方式.是否消费卡, 0);
    --1.三方卡结算
    If c_结算方式.卡类别 Is Not Null And n_消费卡 = 0 Then
      n_卡类别id := Get_Cardtypeid(c_结算方式.卡类别, 0, v_结算方式);
      Select Max(关联交易id)
      Into n_关联交易id
      From 病人预交记录 A,
           (Select a.结帐id
             From 门诊费用记录 A, 门诊费用记录 B
             Where a.No = b.No And Mod(a.记录性质, 10) = 1 And a.记录状态 In (1, 3) And b.结帐id = n_冲销id) B
      Where a.结帐id = b.结帐id And Mod(a.记录性质, 10) <> 1 And a.卡类别id = n_卡类别id;

      Thirdcard_Balance(n_病人id, n_冲销id, Nvl(c_结算方式.结算方式, v_结算方式), n_卡类别id, c_结算方式.卡号, c_结算方式.退款金额, c_结算方式.交易流水号,
                        c_结算方式.交易说明, c_结算方式.单据号, n_关联交易id, c_结算方式.摘要, c_结算方式.Expend, n_结算模式, n_操作类型, n_删除原结算);
      n_删除原结算 := 0;

      --完成结算时才处理非三方卡结算的
    Elsif Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 1 Then
      --2.消费卡结算
      If c_结算方式.卡类别 Is Not Null And n_消费卡 = 1 Then
        n_卡类别id := Get_Cardtypeid(c_结算方式.卡类别, 1, v_结算方式);
        Squarecard_Balance(n_病人id, n_冲销id, n_卡类别id, c_结算方式.卡号, c_结算方式.退款金额, c_结算方式.交易流水号, c_结算方式.交易说明, c_结算方式.Expend);

        --3.退预交款
      Elsif Nvl(c_结算方式.是否退预交, 0) = 1 Then
        Zl_门诊退费结算_Modify(1, n_病人id, n_冲销id, Null, c_结算方式.退款金额, Null, Null, Null, Null, 0, 0, 0, 0);

        --4.普通结算
      Else
        If c_结算方式.结算方式 Is Null Then
          v_Err_Msg := '未指定指付方式，不允缴款!';
          Raise Err_Item;
        End If;

        --结算方式|结算金额|结算号码|结算摘要||..
        v_退费结算 := c_结算方式.结算方式 || '|' || c_结算方式.退款金额 || '| |' || Nvl(c_结算方式.摘要, '  ');
        v_普通结算 := Nvl(v_普通结算, '') || '||' || v_退费结算;
      End If;
    End If;
  End Loop;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
    --n_结算模式 --0-普通模式，1-异步结算模式
    --n_操作类型 :结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算

    v_Temp  := '<CZSJ>' || To_Char(d_退费时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
    v_Temp  := v_Temp || '<YJZID>' || v_结帐ids || '</YJZID>';
    v_Temp  := v_Temp || '<CXID>' || n_冲销id || '</CXID>';
    v_Temp  := v_Temp || '<KPBZ>' || 0 || '</KPBZ>';
    v_Temp  := v_Temp || '<URL>' || '' || '</URL>';
    v_Temp  := v_Temp || '<NETURL>' || '' || '</NETURL>';
    v_Temp  := v_Temp || '<FPTT>' || v_姓名 || '</FPTT>';
    v_Temp  := v_Temp || '<FPH>' || '' || '</FPH>';
    v_Temp  := v_Temp || '<FPJE>' || '' || '</FPJE>';
    v_Temp  := v_Temp || '<KPRQ>' || '' || '</KPRQ>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');

    Return;
  End If;

  --5.普通结算及完成结算
  If v_普通结算 Is Not Null Then
    v_普通结算 := Substr(v_普通结算, 3);
  End If;

  Zl_门诊退费结算_Modify(1, n_病人id, n_冲销id, v_普通结算, 0, Null, Null, Null, Null, 0, 0, n_误差额, 2);

  If v_结帐ids Is Not Null Then
    v_结帐ids := Substr(v_结帐ids, 2);
  End If;

  If l_挂号单.Count <> 0 Then
    For I In 0 .. l_挂号单.Count Loop
      v_Temp := '<GHDH>' || l_挂号单(I) || '</GHDH>';
      v_Temp := v_Temp || '<JSKLB>' || v_结算卡类别 || '</JSKLB>';
      v_Temp := v_Temp || '<GHJE>' || 0 || '</GHJE>';
      Zl_Third_Registdel(Xmltype('<IN>' || v_Temp || '</IN>'), Xml_Out);
    End Loop;
  End If;

  If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 1 Then
    --n_结算模式 --0-普通模式，1-异步结算模式
    --n_操作类型 :结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算
    --电子票据处理

    For c_原结帐 In (Select Distinct a.结帐id
                  From 门诊费用记录 A, 门诊费用记录 B
                  Where a.No = b.No And a.记录性质 = b.记录性质 And a.记录性质 = 1 And a.记录状态 In (1, 3) And b.结帐id = n_冲销id) Loop
      Select Sum(结帐金额)
      Into n_剩余金额
      From 门诊费用记录
      Where NO In (Select Distinct NO From 门诊费用记录 Where 结帐id = c_原结帐.结帐id) And Mod(记录性质, 10) = 1;

      Select Max(是否电子票据) Into n_是否电子票据 From 病人预交记录 Where 结帐id = c_原结帐.结帐id;

      If Nvl(n_剩余金额, 0) <> 0 And Nvl(n_是否电子票据, 0) = 1 Then
        --部分退，需要重新开具电子票据
        If b_Einvoice_Request.Einvoice_Create(1, c_原结帐.结帐id, n_冲销id, v_Err_Msg) = 1 Then
          Select Max(1), Max(姓名), Max(号码), Max(To_Char(To_Date(Substr(生成时间, 1, 8), 'yyyymmdd'), 'yyyy-mm-dd')), Max(Url内网), Max(Url外网), Max(票据金额)
          Into n_开票标志, v_患者姓名, v_发票编号, v_开票日期, v_Url, v_Url外网, n_发票金额
          From 电子票据使用记录
          Where 结算id = n_结帐id And 票种 = 1 And 记录状态 = 1;

          If v_患者姓名 Is Not Null Then
            v_姓名 := v_患者姓名;
          End If;
        End If;
      End If;
    End Loop;
  End If;
  v_Temp  := '<CZSJ>' || To_Char(d_退费时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
  v_Temp  := v_Temp || '<YJZID>' || v_结帐ids || '</YJZID>';
  v_Temp  := v_Temp || '<CXID>' || n_冲销id || '</CXID>';
  v_Temp  := v_Temp || '<KPBZ>' || Nvl(n_开票标志, 0) || '</KPBZ>';
  v_Temp  := v_Temp || '<URL>' || htf.escape_sc(Nvl(v_Url, '')) || '</URL>';
  v_Temp  := v_Temp || '<NETURL>' || htf.escape_sc(Nvl(v_Url外网, '')) || '</NETURL>';
  v_Temp  := v_Temp || '<FPTT>' || v_姓名 || '</FPTT>';
  v_Temp  := v_Temp || '<FPH>' || v_发票编号 || '</FPH>';
  v_Temp  := v_Temp || '<FPJE>' || Nvl(n_发票金额, 0) || '</FPJE>';
  v_Temp  := v_Temp || '<KPRQ>' || v_开票日期 || '</KPRQ>';
  Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Charge_Del;
/
--宁波一卡通
Create Or Replace Procedure Zl_Third_Custom_Getdeptinfo
(
  医嘱id_In      In 病人医嘱记录.Id%Type,
  执行科室id_Out Out 病人医嘱记录.执行科室id%Type,
  执行科室_Out   Out varchar2
) Is
  --------------------------------------
  --功能：返回自定义的执行科室ID或名称
  --入参：
  --医嘱ID_IN:医嘱ID，也可能是组医嘱ID
  --出参:执行科室ID_Out,0为不自定义执行科室
  --     执行科室_Out:执行科室名称
  --------------------------------------
  v_Temp    varchar2(32767);
  v_Err_Msg varchar2(200);
  Err_Item Exception;
Begin
  执行科室id_Out := 0;
  执行科室_Out   := '';
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Custom_Getdeptinfo;
/
Create Or Replace Function Zl_Third_Custom_Rptlimit
(
  病人id_In 病人信息.病人id%Type,
  医嘱id_In 病人医嘱记录.Id%Type
) Return varchar2 As

  ----------------------------------------------------
  --功能:设置不允许查看的报告
  --入参:病人ID
  --     医嘱ID，如果是一组医嘱，则传入组医嘱ID（即相关ID）
  --通过医嘱ID，判断组医嘱中是否有不允许查看报告的项目
  --返回值:<JZBG></JZBG>    //禁止显示报告。0-允许，1-禁止
  --       <JZTS></JZTS>    //禁止提示文字。对于禁止查看的报告，可返回用于提示病人的文字信息
  ----------------------------------------------------
  v_Tmp     varchar2(100);
  v_Temp    varchar2(32767);
  v_Err_Msg varchar2(200);
  Err_Item Exception;
Begin
  v_Tmp := '<JZBG>0</JZBG><JZTS></JZTS>';
  Return(v_Tmp);
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Custom_Rptlimit;
/
Create Or Replace Function Zl_Third_Custom_Getrptfrom(医嘱id_In In 病人医嘱记录.Id%Type) Return varchar2 As
  ----------------------------------------
  --功能：返回当前医嘱对应的诊疗项目是否外检项目
  --入参：医嘱ID
  --出参：<BGLY>标志<BGLY><BGLYSM>提醒信息</BGLYSM>
  --   标志：1-HIS项目，2-外检项目
  --   提醒信息：自定义文字说明，如取报告的地址，提示信息等
  --说明：如果传入的医嘱ID为组医嘱ID，只要该组医嘱下有1个医嘱为外检项目，则整个医嘱全部为外检项目。
  ----------------------------------------
  v_Return  varchar2(200);
  v_Temp    varchar2(32767);
  v_Err_Msg varchar2(200);
  Err_Item Exception;
Begin
  v_Return := '<BGLY>1</BGLY><BGLYSM></BGLYSM>'; --医院项目返回内容
  Return(v_Return);
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Custom_Getrptfrom;
/
Create Or Replace Function Zl_Third_Custom_Getpati
(
  卡类别_In varchar2,
  卡号_In   varchar2
) Return Number As
  --------------------------------------------------------------------------------------------------
  --功能:获取病人ID(用户自定义）
  --入参:
  --  卡类别_In : 卡类别名称
  --  卡号_In   : 卡号
  --返回:病人ID
  --------------------------------------------------------------------------------------------------
  v_Temp    varchar2(32767);
  v_Err_Msg varchar2(200);
  Err_Item Exception;
Begin
  Return 0;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End;
/
Create Or Replace Procedure Zl_Third_Findcards
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is

  -------------------------------------------------------------------------------------------------- 
  --功能:获取医疗卡类别 
  --入参:Xml_In: 
  --  <IN>
  --      <ZJH>证件号<ZJH>     //卡号
  --      <ZJLX>证件类型<ZJLX>  //医疗卡类别.名称
  --  </IN>
  --出参:Xml_Out 
  -- <OUTPUT>
  --    <LIST>
  --        <JZK>
  --            <LB>卡类别</LB>
  --            <KH>卡号</KH>
  --        </JZK>
  --        <JZK>
  --            ...
  --        </JZK>
  --    </LIST>
  --    如无下列错误结点则说明正确执行 
  --    <ERROR> 
  --      <MSG>错误信息</MSG> 
  --    </ERROR> 
  -- </OUTPUT>

  -------------------------------------------------------------------------------------------------- 
  v_Err_Msg varchar2(200);
  Err_Item Exception;

  x_Templet Xmltype; --模板XML 

  v_证件号   varchar2(50);
  v_证件类型 医疗卡类别.名称%Type;
  n_存在     Number(3);
  v_操作员   人员表.姓名%Type;
  n_病人id   病人信息.病人id%Type;
  n_卡类别id 医疗卡类别.Id%Type;

  v_Temp varchar2(32767); --临时XML 
Begin
  x_Templet := Xmltype('<OUTPUT><LIST></LIST></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/ZJH'), Extractvalue(Value(A), 'IN/ZJLX')
  Into v_证件号, v_证件类型
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_证件类型 Like '%身份证%' Then
    For c_Item In (Select Distinct b.名称, a.卡号
                   From 病人医疗卡信息 A, 医疗卡类别 B
                   Where a.卡类别id = b.Id And Nvl(b.是否启用, 0) = 1 And
                         a.病人id In
                         (Select 病人id
                          From 病人信息
                          Where 身份证号 = v_证件号
                          Union All
                          Select a.病人id
                          From 病人医疗卡信息 A
                          Where a.卡类别id = (Select Max(ID) From 医疗卡类别 Where 名称 = v_证件类型 And Nvl(是否启用, 0) = 1) And
                                a.卡号 = v_证件号) And
                         (a.状态 = 0 Or Nvl(a.状态, 0) = 1 And Exists
                          (Select 1 From 医疗卡挂失方式 Where a.挂失方式 = 名称 And a.挂失时间 + 有效天数 < Trunc(Sysdate)))) Loop
      v_Temp := '<LB>' || c_Item.名称 || '</LB>';
      v_Temp := v_Temp || '<KH>' || c_Item.卡号 || '</KH>';
      v_Temp := '<JZK>' || v_Temp || '</JZK>';
      Select Appendchildxml(x_Templet, '/OUTPUT/LIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
  Else
    For c_Item In (Select Distinct b.名称, a.卡号
                   From 病人医疗卡信息 A, 医疗卡类别 B
                   Where a.卡类别id = b.Id And Nvl(b.是否启用, 0) = 1 And
                         a.病人id In
                         (Select 病人id
                          From 病人医疗卡信息
                          Where 卡类别id = (Select Max(ID) From 医疗卡类别 Where 名称 = v_证件类型 And Nvl(是否启用, 0) = 1) And 卡号 = v_证件号) And
                         (a.状态 = 0 Or Nvl(a.状态, 0) = 1 And Exists
                          (Select 1 From 医疗卡挂失方式 Where a.挂失方式 = 名称 And a.挂失时间 + 有效天数 < Trunc(Sysdate)))) Loop
      v_Temp := '<LB>' || c_Item.名称 || '</LB>';
      v_Temp := v_Temp || '<KH>' || c_Item.卡号 || '</KH>';
      v_Temp := '<JZK>' || v_Temp || '</JZK>';
      Select Appendchildxml(x_Templet, '/OUTPUT/LIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
  End If;
  --绑定证件
  If v_证件类型 Like '%身份证%' Then
    Select Max(a.病人id)
    Into n_病人id
    From (Select 病人id
           From 病人信息
           Where 身份证号 = v_证件号
           Union All
           Select a.病人id
           From 病人医疗卡信息 A
           Where a.卡类别id = (Select Max(ID) From 医疗卡类别 Where 名称 = v_证件类型 And Nvl(是否启用, 0) = 1) And a.卡号 = v_证件号 And
                 (a.状态 = 0 Or Nvl(a.状态, 0) = 1 And Exists
                  (Select 1 From 医疗卡挂失方式 Where a.挂失方式 = 名称 And a.挂失时间 + 有效天数 < Trunc(Sysdate)))) A;
  Else
    Select Max(a.病人id)
    Into n_病人id
    From (Select a.病人id
           From 病人医疗卡信息 A
           Where a.卡类别id = (Select Max(ID) From 医疗卡类别 Where 名称 = v_证件类型 And Nvl(是否启用, 0) = 1) And a.卡号 = v_证件号 And
                 (a.状态 = 0 Or Nvl(a.状态, 0) = 1 And Exists
                  (Select 1 From 医疗卡挂失方式 Where a.挂失方式 = 名称 And a.挂失时间 + 有效天数 < Trunc(Sysdate)))) A;
  End If;

  --自定义查询  
  Zl_Third_Custom_Findcards(Xml_In, x_Templet);

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Findcards;
/
Create Or Replace Procedure Zl_Third_Waitingpay
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取待付款收费单(即付款单据)
  --入参:Xml_In:
  --<IN>
  --    <GHDH>挂号单号</GHDH>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --        <FYLIST> 如果为空表示未找到数据
  --            <FY>
  --                <NO>单据号</NO>
  --                <KDSJ>开单时间</SJ>
  --                <KDKS>开单科室</KDKS>
  --                <YS></YS>                           //医生
  --                <SFGH></SFGH>                       //是否挂号单,0-收费单,1-挂号单
  --                <ZFZT></ZFZT>           支付状态：0-待支付，1-正在支付
  --                <FMLIST>
  --                    <FM>
  --                        <MC></MC>                           //费目名称
  --                        <MXLIST>
  --                            <MX>
  --                                <XMMC></XMMC>           //项目名称
  --                                <GG></GG>                   //规格
  --                                <DW></DW>               //单位
  --                                <SL></SL>                   //数量
  --                                <DJ></DJ>                   //单价
  --                                <YSJE></YSJE>               //应收金额
  --                                <SSJE></SSJE>               //实收金额
  --                            </MX>
  --                        </MXLIST>
  --                    </FM>
  --                </FMLIST>
  --            </FY>
  --        </FYLIST>
  --        <ERROR><MSG></MSG></ERROR>                  //如果有错误返回
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(200);
  Err_Item Exception;
  x_Templet Xmltype; --模板XML

  v_挂号单     Varchar2(10);
  n_预约挂号单 Number(3);
  n_Count      Number(18);

  v_Temp     Varchar2(32767); --临时XML
  v_No       Varchar2(50);
  v_费目     Varchar2(50);
  n_异步结算 Number;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/GHDH') Into v_挂号单 From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  If v_挂号单 Is Null Then
    v_Err_Msg := '不能找到指定的挂号单号(当前挂号单号为空)';
    Raise Err_Item;
  End If;

  --1.检查是否有挂号单
  Select Count(1) Into n_Count From 病人挂号记录 A Where NO = v_挂号单;
  If Nvl(n_Count, 0) = 0 Then
    v_Err_Msg := '未找到指定的挂号单据:' || v_挂号单 || '!';
    Raise Err_Item;
  End If;

  If Nvl(n_Count, 0) > 1 Then
    v_Err_Msg := '单据号:' || v_挂号单 || '已经被退号!';
    Raise Err_Item;
  End If;

  n_异步结算 := Zl_To_Number(Nvl(zl_GetSysParameter(304), '0'));
  Select Count(1) Into n_预约挂号单 From 病人挂号记录 Where NO = v_挂号单 And 记录性质 = 2;

  --2.费用汇总
  v_No   := '-_';
  v_费目 := '-_';
  If n_预约挂号单 = 0 Then
    --正常挂号
    For c_费用 In (Select 1 As 顺序号, b.No, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人,
                        To_Char(b.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, Nvl(b.价格父号, b.序号) As 序号, b.收费细目id, b.计算单位,
                        Max(m.名称) As 名称, Max(m.规格) As 规格, Sum(b.标准单价) As 单价, Avg(Nvl(b.付数, 1) * b.数次) As 数量,
                        Sum(b.实收金额) As 实收金额, Max(j.名称) As 开单科室, Max(q.名称) As 执行科室,
                        Decode(b.记录状态, 0, 0, 1) * Decode(b.结帐id, Null, 0, 1) As 支付状态
                 From 门诊费用记录 B, 收费项目目录 M, 部门表 J, 部门表 Q
                 Where b.No In (Select 收费单 From 病人挂号记录 Where NO = v_挂号单) And Mod(b.记录性质, 10) = 1 And
                       (b.记录状态 = 0 Or b.记录状态 = 1 And b.结帐id Is Null Or
                       Nvl(n_异步结算, 0) = 1 And b.记录状态 = 1 And Nvl(b.费用状态, 0) = 1) And b.收费细目id = m.Id And
                       b.开单部门id = j.Id(+) And b.执行部门id = q.Id(+)
                 Group By b.No, b.记录状态, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人, b.登记时间, Nvl(b.价格父号, b.序号), b.收费细目id,
                          b.计算单位
                 Union All
                 Select 1 As 顺序号, b.No, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人,
                        To_Char(b.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, Nvl(b.价格父号, b.序号) As 序号, b.收费细目id, b.计算单位,
                        Max(m.名称) As 名称, Max(m.规格) As 规格, Sum(b.标准单价) As 单价, Avg(Nvl(b.付数, 1) * b.数次) As 数量,
                        Sum(b.实收金额) As 实收金额, Max(j.名称) As 开单科室, Max(q.名称) As 执行科室,
                        Decode(b.记录状态, 0, 0, 1) * Decode(b.结帐id, Null, 0, 1) As 支付状态
                 From 病人医嘱记录 A1, 门诊费用记录 B, 收费项目目录 M, 部门表 J, 部门表 Q
                 Where A1.挂号单 = v_挂号单 And Mod(b.记录性质, 10) = 1 And A1.Id = b.医嘱序号 And
                       (b.记录状态 = 0 Or b.记录状态 = 1 And b.结帐id Is Null Or
                       Nvl(n_异步结算, 0) = 1 And b.记录状态 = 1 And Nvl(b.费用状态, 0) = 1) And b.收费细目id = m.Id And
                       b.开单部门id = j.Id(+) And b.执行部门id = q.Id(+)
                 Group By b.No, b.记录状态, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人, b.登记时间, Nvl(b.价格父号, b.序号), b.收费细目id,
                          b.计算单位
                 Order By 顺序号, NO, 收据费目, 序号) Loop
      If v_No <> c_费用.No Then
        v_Temp := '<NO>' || c_费用.No || '</NO>';
        v_Temp := v_Temp || '<KDSJ>' || c_费用.登记时间 || '</KDSJ>';
        v_Temp := v_Temp || '<KDKS>' || c_费用.开单科室 || '</KDKS>';
        v_Temp := v_Temp || '<YS>' || c_费用.开单人 || '</YS>';
        v_Temp := v_Temp || '<SFGH>' || n_预约挂号单 || '</SFGH>';
        v_Temp := v_Temp || '<ZFZT>' || c_费用.支付状态 || '</ZFZT>';
        v_Temp := '<FYLIST NO="' || c_费用.No || '"><FY>' || v_Temp || '<FMLIST></FMLIST></FY></FYLIST>';
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      
        v_No   := c_费用.No;
        v_费目 := '-_';
      End If;
    
      If v_费目 <> c_费用.收据费目 Then
        v_费目 := c_费用.收据费目;
        v_Temp := '<MC>' || v_费目 || '</MC>';
        v_Temp := '<FM SJFM="' || v_费目 || '">' || v_Temp || '<MXLIST></MXLIST></FM>';
        Select Appendchildxml(x_Templet, '/OUTPUT/FYLIST[@NO="' || v_No || '"]/FY/FMLIST', Xmltype(v_Temp))
        Into x_Templet
        From Dual;
      End If;
    
      v_Temp := '<XMMC>' || c_费用.名称 || '</XMMC>';
      v_Temp := v_Temp || '<GG>' || c_费用.规格 || '</GG>';
      v_Temp := v_Temp || '<SL>' || c_费用.数量 || '</SL>';
      v_Temp := v_Temp || '<DW>' || c_费用.计算单位 || '</DW>';
      v_Temp := v_Temp || '<SL>' || c_费用.数量 || '</SL>';
      v_Temp := v_Temp || '<DJ>' || c_费用.单价 || '</DJ>';
      v_Temp := v_Temp || '<YSJE>' || c_费用.实收金额 || '</YSJE>';
      v_Temp := v_Temp || '<SSJE>' || c_费用.实收金额 || '</SSJE>';
      v_Temp := '<MX>' || v_Temp || '</MX>';
      Select Appendchildxml(x_Templet,
                             '/OUTPUT/FYLIST[@NO="' || v_No || '"]/FY/FMLIST/FM[@SJFM="' || v_费目 || '"]/MXLIST',
                             Xmltype(v_Temp))
      Into x_Templet
      From Dual;
    End Loop;
  Else
    --预约挂号
    For c_费用 In (Select 1 As 顺序号, b.No, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人,
                        To_Char(b.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, Nvl(b.价格父号, b.序号) As 序号, b.收费细目id, b.计算单位,
                        Max(m.名称) As 名称, Max(m.规格) As 规格, Sum(b.标准单价) As 单价, Avg(Nvl(b.付数, 1) * b.数次) As 数量,
                        Sum(b.实收金额) As 实收金额, Max(j.名称) As 开单科室, Max(q.名称) As 执行科室, Decode(b.记录状态, 0, 0, 1) As 支付状态
                 From 门诊费用记录 B, 收费项目目录 M, 部门表 J, 部门表 Q
                 Where b.No = v_挂号单 And b.记录性质 = 4 And
                       b.收费细目id Not In (Select 收费细目id From 收费特定项目 Where 特定项目 = '病历费') And
                       (b.记录状态 = 0 Or b.记录状态 = 1 And Nvl(b.费用状态, 0) = 1) And b.收费细目id = m.Id And b.开单部门id = j.Id(+) And
                       b.执行部门id = q.Id(+)
                 Group By b.No, b.记录状态, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人, b.登记时间, Nvl(b.价格父号, b.序号), b.收费细目id,
                          b.计算单位) Loop
      If v_No <> c_费用.No Then
        v_Temp := '<NO>' || c_费用.No || '</NO>';
        v_Temp := v_Temp || '<KDSJ>' || c_费用.登记时间 || '</KDSJ>';
        v_Temp := v_Temp || '<KDKS>' || c_费用.开单科室 || '</KDKS>';
        v_Temp := v_Temp || '<YS>' || c_费用.开单人 || '</YS>';
        v_Temp := v_Temp || '<SFGH>' || n_预约挂号单 || '</SFGH>';
        v_Temp := v_Temp || '<ZFZT>' || c_费用.支付状态 || '</ZFZT>';
        v_Temp := '<FYLIST NO="' || c_费用.No || '"><FY>' || v_Temp || '<FMLIST></FMLIST></FY></FYLIST>';
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      
        v_No   := c_费用.No;
        v_费目 := '-_';
      End If;
    
      If v_费目 <> c_费用.收据费目 Then
        v_费目 := c_费用.收据费目;
        v_Temp := '<MC>' || v_费目 || '</MC>';
        v_Temp := '<FM SJFM="' || v_费目 || '">' || v_Temp || '<MXLIST></MXLIST></FM>';
        Select Appendchildxml(x_Templet, '/OUTPUT/FYLIST[@NO="' || v_No || '"]/FY/FMLIST', Xmltype(v_Temp))
        Into x_Templet
        From Dual;
      End If;
    
      v_Temp := '<XMMC>' || c_费用.名称 || '</XMMC>';
      v_Temp := v_Temp || '<GG>' || c_费用.规格 || '</GG>';
      v_Temp := v_Temp || '<SL>' || c_费用.数量 || '</SL>';
      v_Temp := v_Temp || '<DW>' || c_费用.计算单位 || '</DW>';
      v_Temp := v_Temp || '<SL>' || c_费用.数量 || '</SL>';
      v_Temp := v_Temp || '<DJ>' || c_费用.单价 || '</DJ>';
      v_Temp := v_Temp || '<YSJE>' || c_费用.实收金额 || '</YSJE>';
      v_Temp := v_Temp || '<SSJE>' || c_费用.实收金额 || '</SSJE>';
      v_Temp := '<MX>' || v_Temp || '</MX>';
      Select Appendchildxml(x_Templet,
                             '/OUTPUT/FYLIST[@NO="' || v_No || '"]/FY/FMLIST/FM[@SJFM="' || v_费目 || '"]/MXLIST',
                             Xmltype(v_Temp))
      Into x_Templet
      From Dual;
    End Loop;
  End If;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Waitingpay;
/
Create Or Replace Procedure Zl_Third_Paymentinfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取指定单据交易信息
  --入参:Xml_In:
  --<IN>
  --    <DJ>单据号,性质|....</DJ> //可以传入多个单据
  --    <JSKLB>结算卡类别</JSKLB>
  --    <XL>险类</XL>          //为空代表普通病人
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --<DJ>  //如果为空表示没有找到数据
  --    <DJH>单据号</DJH>
  --    <JLXZ>记录性质</JLXZ>
  --    <YSJE>应收金额</YSJE>
  --    <SSJE>实收金额</SSJE>
  --    <FYMC>收据费目</FYMC> //(多个用逗号分离 )
  --    <JSKZF>结算卡支付</JSKZF> //:0-不是结算卡支付;1-结算卡支付(入参中:JSKLB判断,存在该类别支付的,返回1,否则返回0)
  --    <FKSJ>付款时间</FKSJ>
  --    <JYLSH>交易流水号</JYLSH> //(非结算卡支付的，不返回)
  --    <YXTK>是否允许退款</YXTK>            //0不允许1允许 
  --    <YBJS>医保是否结算</YBJS>   //0-未结算，1-线下本地医保结算，2-结算卡医保结算
  --    <KP>是否开票</KP>  1是0否
  --    <SQZT>退费申请状态</SQZT>                  //退费申请状态,0-未申请,1-申请中,2-审核通过,3-审核未通过
  --    <JZTFSM>禁止退款说明</JZTFSM>
  --    <YJZID>结帐ID</YJZID>                  //已收费单据的结帐ID
  --</DJ>
  --<ERROR><MSG></MSG></ERROR>          //错误情况返回
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(200);
  Err_Item Exception;
  n_Count Number;

  n_Number   Number;
  x_Templet  Xmltype; --模板XML
  v_Temp     Varchar2(32767); --临时XML
  v_No       Varchar2(4000);
  v_卡类别id Varchar2(100);
  n_卡类别id 医疗卡类别.Id%Type;
  n_险类     病人信息.险类%Type;

  n_结算卡支付 Number(18);
  n_其它结算   Number;
  v_交易流水号 病人预交记录.交易流水号%Type;
  n_医保结算   Number(2);
  n_允许退款   Number(2);
  n_申请状态   病人退费申请.状态%Type;
  v_审核原因   病人退费申请.审核原因%Type;
  v_说明       Varchar2(100);
  n_补结算     Number(18);
  v_挂号单     病人挂号记录.No%Type;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/DJ'), Extractvalue(Value(A), 'IN/JSKLB'), To_Number(Extractvalue(Value(A), 'IN/XL'))
  Into v_No, v_卡类别id, n_险类
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_No Is Null Then
    v_Err_Msg := '不能找到指定的收费单据(当前单据为空)！';
    Raise Err_Item;
  End If;

  n_卡类别id := 0;
  If v_卡类别id Is Not Null Then
    Select Decode(Translate(v_卡类别id, '#1234567890', '#'), Null, 1, 0) Into n_Number From Dual;
    If Nvl(n_Number, 0) = 0 Then
      Begin
        Select ID Into n_卡类别id From 医疗卡类别 Where 名称 = v_卡类别id;
      Exception
        When Others Then
          v_Err_Msg := v_卡类别id || '不存在!';
          Raise Err_Item;
      End;
    Else
      n_卡类别id := To_Number(v_卡类别id);
    End If;
  End If;

  For c_收费单 In (Select /*+cardinality(b,10)*/
                 记录性质, NO, Sum(应收金额) As 应收金额, Sum(实收金额) As 实收金额, Max(收款时间) As 收款时间, Max(结帐id) As 结帐id, Max(是否退款) As 是否退款,
                 Max(是否打印) As 是否打印, Max(记录状态) As 记录状态, f_List2str(Cast(Collect(收据费目) As t_Strlist)) As 收据费目

                From (Select a.记录性质, a.No, 收据费目, Sum(应收金额) As 应收金额, Sum(实收金额) As 实收金额,
                              To_Char(Max(a.登记时间), 'yyyy-mm-dd hh24:mi:ss') As 收款时间, Max(结帐id) As 结帐id,
                              Max(Decode(Nvl(a.执行状态, 0), 1, 0, 1)) As 是否退款, Max(Decode(a.实际票号, Null, 0, 1)) 是否打印,
                              Max(a.记录状态) As 记录状态
                       From 门诊费用记录 A, Table(f_Str2list2(v_No, '|', ',')) B
                       Where a.No = b.C1 And a.记录性质 = b.C2 And a.记录状态 In (1, 3) And a.结帐id Is Not Null
                       Group By a.记录性质, a.No, 收据费目
                       Order By 记录性质, NO, 收据费目)
                Group By 记录性质, NO) Loop
  
    v_说明     := '';
    n_允许退款 := Nvl(c_收费单.是否退款, 0);
    If Nvl(n_允许退款, 0) = 0 Then
      v_说明 := '单据已经执行';
    End If;
  
    --注意可能拒绝后又重新申请，一张单据会有多条记录 
    Begin
      --病人退费申请.状态：0-申请,1-审核通过,2-拒绝申请
      --退费申请状态：0-未申请,1-申请中,2-审核通过,3-审核未通过
      Select Nvl(Min(状态), 0) + 1, Max(审核原因)
      Into n_申请状态, v_审核原因
      From 病人退费申请
      Where NO = c_收费单.No And 记录性质 = c_收费单.记录性质
      Group By NO;
    Exception
      When Others Then
        n_申请状态 := 0;
        v_审核原因 := '';
    End;
    If n_申请状态 = 3 Then
      v_说明     := v_审核原因;
      n_允许退款 := 0;
    End If;
  
    v_挂号单 := Null;
    If c_收费单.记录性质 = 4 Then
      v_挂号单 := c_收费单.No;
    Elsif c_收费单.记录性质 = 1 Then
      --挂号划价模式
      Select Max(Substr(a.摘要, 4))
      Into v_挂号单
      From 门诊费用记录 A
      Where a.No = c_收费单.No And a.记录性质 = 1 And a.摘要 Like '挂号:%' And Rownum < 2;
    End If;
    If v_挂号单 Is Not Null Then
      Select Count(1) Into n_Count From 病人医嘱记录 Where 挂号单 = v_挂号单 And Rownum < 2;
      If Nvl(n_Count, 0) <> 0 Then
        v_说明     := '挂号单已开医嘱';
        n_允许退款 := 0;
      End If;
    End If;
  
    Select Nvl(Min(Decode(a.卡类别id, Null, 1, 2)), 0)
    Into n_医保结算
    From 病人预交记录 A, 结算方式 B
    Where a.结算方式 = b.名称 And b.性质 In (3, 4) And a.记录性质 Not In (1, 11) And a.结帐id = c_收费单.结帐id;
  
    Select Count(1) Into n_补结算 From 费用补充记录 Where 收费结帐id = c_收费单.结帐id And Rownum < 2;
    If Nvl(n_补结算, 0) <> 0 Then
      v_说明     := '单据已经补充结算';
      n_允许退款 := 0;
      n_医保结算 := 1;
    End If;
  
    n_其它结算 := 0;
    If n_险类 Is Null Then
      If Nvl(n_医保结算, 0) = 1 Then
        v_说明     := '单据已经医保结算';
        n_允许退款 := 0;
      Elsif n_卡类别id <> 0 Then
        Select Count(1)
        Into n_其它结算
        From 病人预交记录 A
        Where a.结帐id = c_收费单.结帐id And Not (a.记录性质 Not In (1, 11) And a.卡类别id = n_卡类别id);
      End If;
    Else
      Select Count(1)
      Into n_其它结算
      From 病人预交记录 A, 结算方式 B, 保险结算记录 C
      Where a.结算方式 = b.名称 And a.结帐id = c.记录id(+) And a.结帐id = c_收费单.结帐id And
            Not (a.记录性质 Not In (1, 11) And
             (b.性质 In (3, 4) And Nvl(c.险类, 0) = n_险类 Or a.卡类别id Is Not Null And a.卡类别id = n_卡类别id));
    End If;
    If Nvl(n_其它结算, 0) <> 0 Then
      v_说明     := '该单据包含不能退费的结算方式';
      n_允许退款 := 0;
    End If;
  
    If Nvl(n_允许退款, 0) = 1 Then
      --检查是否有可退数量
      Select Decode(Nvl(Sum(Nvl(付数, 1) * 数次), 0), 0, 0, 1)
      Into n_允许退款
      From 门诊费用记录
      Where NO = c_收费单.No And Mod(记录性质, 10) = c_收费单.记录性质;
      If Nvl(c_收费单.记录状态, 0) = 3 Then
        If n_允许退款 = 0 Then
          v_说明 := '单据已全退';
        Else
          v_说明     := '单据已部分退费';
          n_允许退款 := 0;
        End If;
      End If;
    End If;
  
    If Nvl(c_收费单.是否打印, 0) = 1 Then
      v_说明     := '单据已开发票';
      n_允许退款 := 0;
    End If;
  
    n_结算卡支付 := 0;
    v_交易流水号 := '';
    If n_卡类别id <> 0 Then
      Begin
        Select 交易流水号, 1
        Into v_交易流水号, n_结算卡支付
        From 病人预交记录
        Where 记录性质 Not In (1, 11) And 卡类别id = n_卡类别id And 结帐id = c_收费单.结帐id And Rownum < 2;
      Exception
        When Others Then
          n_结算卡支付 := 0;
      End;
    End If;
  
    v_Temp := '<DJH>' || c_收费单.No || '</DJH>';
    v_Temp := v_Temp || '<JLXZ>' || c_收费单.记录性质 || '</JLXZ>';
    v_Temp := v_Temp || '<YSJE>' || c_收费单.应收金额 || '</YSJE>';
    v_Temp := v_Temp || '<SSJE>' || c_收费单.实收金额 || '</SSJE>';
    v_Temp := v_Temp || '<FYMC>' || c_收费单.收据费目 || '</FYMC>';
    v_Temp := v_Temp || '<FKSJ>' || c_收费单.收款时间 || '</FKSJ>';
    v_Temp := v_Temp || '<JSKZF>' || n_结算卡支付 || '</JSKZF>';
    v_Temp := v_Temp || '<JYLSH>' || v_交易流水号 || '</JYLSH>';
    v_Temp := v_Temp || '<YXTK>' || n_允许退款 || '</YXTK>';
    v_Temp := v_Temp || '<YBJS>' || n_医保结算 || '</YBJS>';
    v_Temp := v_Temp || '<KP>' || Nvl(c_收费单.是否打印, 0) || '</KP>';
    v_Temp := v_Temp || '<SQZT>' || n_申请状态 || '</SQZT>';
    v_Temp := v_Temp || '<JZTFSM>' || v_说明 || '</JZTFSM>';
    v_Temp := v_Temp || '<YJZID>' || c_收费单.结帐id || '</YJZID>';
    v_Temp := '<DJ>' || v_Temp || '</DJ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Paymentinfo;
/
Create Or Replace Procedure Zl_Third_Getvisitdetails
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:根据挂号单号获取该次就诊详情
  --入参:Xml_In:
  --<IN>
  --    <GHDH>挂号单号</GHDH>
  --    <JSKLB>结算卡类别</JSKLB>
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --    <DJLIST>  //如果为空表示为找到数据
  --        <DJ>
  --            <NO>单据号</NO>
  --            <DJLX>单据类型</DJLX> //1-收费单;4-挂号单
  --            <KDSJ>开单时间</KDSJ>
  --            <ZFZT>支付状态</ZFZT>    //0未支付1已支付，2-已退费，3-正在支付,4-正在退费
  --            <SFJSK>是否结算卡支付</SFJSK> //即该单据是否存在入参<JSKLB>来进行支付的,是返回1,否则返回0
  --            <LX>类型</LX> //挂号单固定为挂号,其他按收费类别汇总
  --            <ZXKS>执行科室</ZXKS>
  --            <ZXKSID>执行科室ID</ZXKSID>
  --            <MXLIST>
  --                     <MX>
  --                                <JZSJ>就诊时间</JZSJ>    //挂号有效:yyyy-mm-dd hh24:mi:ss
  --                                <BW>部位</BW>               //检查,检验时有效
  --                                <XM>项目名称</XM>     //挂号无效:其他项目有效
  --                                <ZXZT>执行状态</ZXZT> //挂号:未接诊;已接诊;完成就诊;收费:未执行;已执行;部分执行
  --                                <BG>报告状态</BG>// 1-已出报告;0未出报告,检查,检验时有效
  --                                <BLID>病历ID</BLID>  //如果<BG>字段为1，该值不为空,检查,检验时有效
  --                                <GG>规格</GG>                       //药品有效
  --                                <SL>数量</SL> //非挂号有效
  --                                <DW>单位</DW> //非挂号有效
  --                                <DJ>单价</DJ> //非挂号有效
  --                                <JE>金额</JE>
  --                     </MX>
  --             </MXLIST>
  --             <DL> //队列
  --                        <XH>序号</XH>
  --                        <QMRS>前面人数</QMRS>  //(由Oracle函数zl_GetSequenceBeforPerons获取)
  --             </DL>
  --        </DJ>
  --    </DJLIST>
  --    <ERROR><MSG></MSG></ERROR>                      //如果错误返回
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(200);
  Err_Item Exception;
  x_Templet Xmltype; --模板XML

  v_卡类别   Varchar2(100);
  n_卡类别id Number(18);
  v_挂号单   Varchar2(10);
  v_排队号码 Varchar2(10);
  n_Temp     Number(18);

  n_Count    Number(18);
  n_支付标志 Number;

  v_Temp       Varchar2(32767); --临时XML
  v_队列       Varchar2(32767);
  v_No         Varchar2(50);
  v_Tmp        Varchar2(4000);
  n_Add_Djlist Number(1); --是否增加了DJLIST的;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/GHDH'), Extractvalue(Value(A), 'IN/JSKLB')
  Into v_挂号单, v_卡类别
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_挂号单 Is Null Then
    v_Err_Msg := '不能找到指定的挂号单号(当前挂号单号为空)';
    Raise Err_Item;
  End If;
  n_Add_Djlist := 0;

  v_Err_Msg := Null;
  If v_卡类别 Is Not Null Then
    Begin
      n_卡类别id := To_Number(v_卡类别);
    Exception
      When Others Then
        n_卡类别id := 0;
    End;
  
    If n_卡类别id = 0 Then
      Begin
        Select ID, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!')
        Into n_卡类别id, v_Err_Msg
        From 医疗卡类别
        Where 名称 = v_卡类别;
      Exception
        When Others Then
          v_Err_Msg := '卡类别:' || v_卡类别 || '不存在!';
      End;
    Else
      Begin
        Select ID, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!')
        Into n_卡类别id, v_Err_Msg
        From 医疗卡类别
        Where ID = n_卡类别id;
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息!';
      End;
    End If;
    If Not v_Err_Msg Is Null Then
      Raise Err_Item;
    End If;
  End If;

  --1.获取挂号数据
  n_Count := 0;
  For c_挂号 In (Select a.Id, a.No, a.记录性质, a.执行部门id, c.名称 As 执行部门, To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间,
                      a.预约时间, a.接收时间, To_Char(a.发生时间, 'yyyy-mm-dd HH24:mi') As 就诊时间, a.号别, a.号序, b.金额, a.记录状态,
                      Decode(Nvl(a.执行状态, 0), 0, '等待接诊', 1, '完成就诊', 2, '正在就诊', -1, '取消就诊') As 执行状态
               From 病人挂号记录 A,
                    (Select NO, Max(Nvl(结帐id, 0)) As 结帐id, Sum(实收金额) As 金额
                      From 门诊费用记录 B
                      Where 记录性质 = 4 And NO = v_挂号单
                      Group By NO) B, 部门表 C
               Where a.No = v_挂号单 And a.No = b.No And a.执行部门id = c.Id(+)) Loop
  
    If Nvl(c_挂号.记录状态, 0) <> 1 Then
      v_Err_Msg := '单据号:' || v_挂号单 || '已经被退号!';
      Raise Err_Item;
    End If;
  
    Begin
      Select 排队号码 Into v_排队号码 From 排队叫号队列 Where 业务id = c_挂号.Id And Nvl(业务类型, 0) = 0;
    Exception
      When Others Then
        v_排队号码 := Null;
    End;
    If v_排队号码 Is Not Null Then
      --业务id_In ,业务类型_In 排队号码_In Number := Null
      n_Temp := Zl_Getsequencebeforperons(c_挂号.Id, 0, v_排队号码);
      v_队列 := v_队列 || '<DL><XH>' || v_排队号码 || '</XH><QMRS>' || n_Temp || '</QMRS></DL>';
    End If;
  
    n_Temp := 0;
    If Nvl(n_卡类别id, 0) <> 0 Then
      Select Count(1)
      Into n_Temp
      From 病人预交记录
      Where NO = v_挂号单 And 记录性质 = 4 And 记录状态 In (1, 3) And 卡类别id = n_卡类别id And Rownum < 2;
    End If;
  
    --支付状态,0-待支付，1-已支付，2-已退费，3-正在支付,4-正在退费
    Select Nvl(Max(Decode(结帐id, 0, 0, Decode(记录状态, 2, Decode(费用状态, 1, 4, 2), Decode(费用状态, 1, 3, 1)))), 0)
    Into n_支付标志
    From (Select Decode(记录状态, 2, 2, 1) As 记录状态, Nvl(费用状态, 0) As 费用状态, Nvl(结帐id, 0) As 结帐id
           From 门诊费用记录
           Where 记录性质 = 4 And NO = v_No);
  
    v_Temp := '<NO>' || c_挂号.No || '</NO>';
    v_Temp := v_Temp || '<DJLX>' || 4 || '</DJLX>';
    v_Temp := v_Temp || '<KDSJ>' || c_挂号.登记时间 || '</KDSJ>';
    v_Temp := v_Temp || '<ZFZT>' || n_支付标志 || '</ZFZT>';
    v_Temp := v_Temp || '<SFJSK>' || n_Temp || '</SFJSK>';
    v_Temp := v_Temp || '<LX>挂号</LX>';
    v_Temp := v_Temp || '<ZXKS>' || c_挂号.执行部门 || '</ZXKS>';
    v_Temp := v_Temp || '<ZXKSID>' || c_挂号.执行部门id || '</ZXKSID>';
    v_Temp := v_Temp || '<MXLIST><MX><JZSJ>' || c_挂号.就诊时间 || '</JZSJ><JE>' || c_挂号.金额 || '</JE></MX></MXLIST>';
    If v_队列 Is Not Null Then
      v_Temp := v_Temp || v_队列;
    End If;
  
    If Nvl(n_Add_Djlist, 0) = 0 Then
      --增加DJList节点
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<DJLIST></DJLIST>')) Into x_Templet From Dual;
      n_Add_Djlist := 1;
    End If;
    v_Temp := '<DJ>' || v_Temp || '</DJ>';
    Select Appendchildxml(x_Templet, '/OUTPUT/DJLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    n_Count := n_Count + 1;
  End Loop;
  If Nvl(n_Count, 0) = 0 Then
    v_Err_Msg := '未找到指定的挂号单据:' || v_挂号单 || '!';
    Raise Err_Item;
  End If;

  --2.分类汇总收费单
  v_No := '-_';
  For c_费用 In (Select j.医嘱id, j.相关id As 组号, j.No, j.序号, j.收费类别, i.名称 As 收费类别名, j.执行部门id, q.名称 As 执行部门, j.收费细目id, m.名称,
                      m.规格, Max(j.计算单位) As 计算单位, Decode(Max(j.执行状态), 0, '未执行', 1, '完全执行', 2, '部分执行', '') As 执行状态,
                      To_Char(Max(j.登记时间), 'yyyy-mm-dd hh24:mi:ss') As 登记时间, Max(j.单价) As 单价, Sum(j.数量) As 数量,
                      Sum(j.实收金额) As 实收金额
               From (Select a.相关id, a.Id As 医嘱id, b.No, b.收费类别, b.结帐id, b.执行部门id,
                             Max(Decode(b.记录状态, 2, 0, b.执行状态)) As 执行状态,
                             Max(Decode(b.记录状态, 2, Null + Sysdate, b.登记时间)) As 登记时间, Nvl(b.价格父号, b.序号) As 序号, b.收费细目id,
                             b.计算单位, Sum(b.标准单价) As 单价, Avg(Nvl(b.付数, 1) * b.数次) As 数量, Sum(b.实收金额) As 实收金额

                      From 门诊费用记录 B, 病人医嘱记录 A
                      Where Mod(b.记录性质, 10) = 1 And a.Id = b.医嘱序号 And Nvl(b.费用状态, 0) = 0 And a.挂号单 = v_挂号单
                      Group By a.相关id, a.Id, b.No, b.收费类别, b.结帐id, b.执行部门id, Nvl(b.价格父号, b.序号), b.收费细目id, b.计算单位) J,
                    收费项目目录 M, 部门表 Q, 收费项目类别 I
               Where j.收费细目id = m.Id And j.执行部门id = q.Id(+) And j.收费类别 = i.编码(+)
               Group By j.医嘱id, j.相关id, j.No, j.序号, j.收费类别, i.名称, j.执行部门id, q.名称, j.收费细目id, m.名称, m.规格
               Order By 登记时间 Desc, NO Desc, 收费类别, 序号) Loop
  
    If c_费用.No <> v_No Then
      n_Temp := 0;
      --单据不同,则产生的结构不同
      If Nvl(n_卡类别id, 0) <> 0 Then
        --是否结算卡支付的
        Select Count(1)
        Into n_Temp
        From 病人预交记录 A, 门诊费用记录 B
        Where a.结帐id = b.结帐id And b.No = c_费用.No And Mod(b.记录性质, 10) = 1 And b.记录状态 In (1, 3) And a.卡类别id = n_卡类别id And
              Rownum < 2;
      End If;
    
      Select f_List2str(Cast(Collect(名称) As t_Strlist), '/')
      Into v_Tmp
      From (Select Distinct b.名称
             From 门诊费用记录 A, 收费项目类别 B
             Where a.收费类别 = b.编码 And a.No = c_费用.No And a.记录性质 = 1 And a.记录状态 In (1, 3));
    
      --支付状态,0-待支付，1-已支付，2-已退费，3-正在支付,4-正在退费
      Select Nvl(Max(Decode(结帐id, 0, 0, Decode(记录状态, 2, Decode(费用状态, 1, 4, 2), Decode(费用状态, 1, 3, 1)))), 0)
      Into n_支付标志
      From (Select Decode(记录状态, 2, 2, 1) As 记录状态, Nvl(费用状态, 0) As 费用状态, Nvl(结帐id, 0) As 结帐id
             From 门诊费用记录
             Where 记录性质 = 1 And NO = c_费用.No);
    
      If Nvl(n_Add_Djlist, 0) = 0 Then
        --增加DJList节点
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<DJLIST></DJLIST>')) Into x_Templet From Dual;
        n_Add_Djlist := 1;
      End If;
    
      v_No   := c_费用.No;
      v_Temp := '<NO>' || c_费用.No || '</NO>';
      v_Temp := v_Temp || '<DJLX>' || 1 || '</DJLX>';
      v_Temp := v_Temp || '<KDSJ>' || c_费用.登记时间 || '</KDSJ>';
      v_Temp := v_Temp || '<ZFZT>' || n_支付标志 || '</ZFZT>';
      v_Temp := v_Temp || '<SFJSK>' || n_Temp || '</SFJSK>';
      v_Temp := v_Temp || '<LX>' || v_Tmp || '</LX>';
      v_Temp := v_Temp || '<ZXKS>' || c_费用.执行部门 || '</ZXKS>';
      v_Temp := v_Temp || '<ZXKSID>' || c_费用.执行部门id || '</ZXKSID>';
      v_Temp := v_Temp || '<MXLIST></MXLIST>' || Nvl(v_队列, '') || '';
      v_Temp := '<DJ NO="' || c_费用.No || '">' || v_Temp || '</DJ>';
      Select Appendchildxml(x_Templet, '/OUTPUT/DJLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    End If;
  
    v_Temp := '<XM>' || Nvl(c_费用.名称, '') || '</XM>';
    If c_费用.收费类别 = 'D' Then
      --检查获取部位
      Begin
        Select f_List2str(Cast(Collect(标本部位) As t_Strlist))
        Into v_Tmp
        From 病人医嘱记录
        Where 相关id = c_费用.医嘱id;
      Exception
        When Others Then
          v_Tmp := Null;
      End;
      v_Temp := v_Temp || '<BW>' || Nvl(v_Tmp, '') || '</BW>';
    Elsif c_费用.收费类别 = 'C' Then
      --检验
      Select Max(Decode(b.审核时间, Null, 0, 1))
      Into n_Temp
      From 病人医嘱记录 A, 检验标本记录 B
      Where a.Id = c_费用.医嘱id And a.Id = b.医嘱id(+) And Exists
       (Select 1 From 病人医嘱记录 Where 相关id = c_费用.医嘱id And 诊疗类别 = 'C');
      v_Temp := v_Temp || '<BG>' || n_Temp || '</BG>';
    
      If n_Temp = 1 Then
        --取病历ID
        Select Max(病历id)
        Into n_Temp
        From 病人医嘱报告
        Where 医嘱id = c_费用.医嘱id And Nvl(病历id, 0) <> 0 And Rownum < 2;
        v_Temp := v_Temp || '<BLID>' || Nvl(n_Temp, '') || '</BLID>';
      End If;
    End If;
  
    v_Temp := v_Temp || '<GG>' || Nvl(c_费用.规格, '') || '</GG>';
    v_Temp := v_Temp || '<SL>' || Nvl(c_费用.数量, 0) || '</SL>';
    v_Temp := v_Temp || '<DW>' || Nvl(c_费用.计算单位, '') || '</DW>';
    v_Temp := v_Temp || '<DJ>' || Nvl(c_费用.单价, 0) || '</DJ>';
    v_Temp := v_Temp || '<JE>' || Nvl(c_费用.实收金额, 0) || '</JE>';
    v_Temp := '<MX>' || v_Temp || '</MX>';
    Select Appendchildxml(x_Templet, '/OUTPUT/DJLIST/DJ[@NO="' || v_No || '"]/MXLIST', Xmltype(v_Temp))
    Into x_Templet
    From Dual;
  
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getvisitdetails;
/
Create Or Replace Procedure Zl_Third_Payment
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is

  --------------------------------------------------------------------------------------------------
  --功能:三方接口支付
  --入参:Xml_In:
  --<IN>
  --    <NO></NO>                       //收费单据号串,逗号分隔多个单据号
  --    <JE></JE>                       //总金额
  --    <BRID>病人ID</BRID>             //病人ID
  --    <XM>姓名</XM>                   //姓名
  --    <SFZH>身份证号</SFZH>           //身份证号
  --    <SFGH></SFGH>                   //是否挂号单
  --    <WCJE>误差额</WCJE>             //误差项不传时,以总金额-本次结算费用总额为准
  --    <JSMS>1</JSMS>          //结算模式：0-普通模式，1-异步结算模式
  --    <CZLX>0</CZLX>          //操作类型：结算模式为1时传入，0-开始结算，1-完成结算，2-回退结算
  --    <JZID>1</JZID>          //结帐ID，操作类型为1或2时传入
  --    <ZFBZH>支付宝公众号UserID</ZFBZH>
  --    <ZFBXCY>支付宝小程序UserID</ZFBXCY>
  --    <WXGZHID>微信公众号OpenID</WXGZH>
  --    <WXXCXID>微信小程序OpenID</WXXCXID>
  --        <JSLIST>          //结算列表，操作类型为2时可不传入
  --         <JS>
  --              <JSKLB>支付卡类别</JSKLB >
  --              <JSKH>支付卡号</ JSKH >
  --              <JSFS>支付方式</JSFS> //支付方式:现金;支票,如果是三方卡,可以传空
  --              <JSJE>支付金额</JSJE>
  --              <JYLSH>交易流水号</JYLSH>
  --              <JYSM>交易说明</JYSM>
  --              <ZY>摘要</ZY>
  --              <SFCYJ>是否冲预交</SFCYJ>  //允冲预交时,只填JSJE节点:1-冲预交
  --              <SFXFK>是否消费卡</SFXFK>  //(1-是消费卡),消费卡时,传入结算卡类别,结算卡号,结算金额等接点
  --              <DJH>S0000001</DJH> //分单据结算时传入
  --              <EXPENDLIST>  //扩展交易信息
  --                  <EXPEND>
  --                        <JYMC >交易名称</交易名称>
  --                        <JYLR>交易内容</JYLR>
  --                  </EXPEND>
  --              </EXPENDLIST>
  --         </JS>
  --       </JSLIST >
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --  <JZID>结帐ID</JZID>       //结帐ID
  --  <CZSJ>操作时间</CZSJ>          //HIS的登记时间
  --  <KPBZ>开票标志</KPBZ> //1-成功开具电子票据;0-未开票成功标志
  --  <URL>H5页面URL</URL>
  --  <NETURL>外网H5页面URL</NETURL>
  --  <FPTT>发票抬头</FPTT>        //病人姓名
  --  <FPH>发票号</FPH>             //发票编号
  --  <FPJE>发票金额</FPJE>        //100.00
  --  <KPRQ>开票日期</KPRQ>   //yyyy-mm-dd
  --    DD如无下列错误结点则说明正确执行
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Nos      Varchar2(4000);
  n_结算金额 门诊费用记录.实收金额%Type;

  n_卡类别id   医疗卡类别.Id%Type;
  n_结算卡序号 病人预交记录.结算卡序号%Type;
  v_结算方式   Varchar2(2000);
  n_病人id     门诊费用记录.病人id%Type;
  v_身份证号   病人信息.身份证号%Type;
  v_姓名       门诊费用记录.姓名%Type;
  v_性别       门诊费用记录.性别%Type;
  v_年龄       门诊费用记录.年龄%Type;
  n_结算模式   Number(1); --0-普通模式，1-异步结算模式
  n_操作类型   Number(1); --结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算

  n_关联交易id 病人预交记录.关联交易id%Type;
  n_预交id     病人预交记录.Id%Type;
  n_消费卡     Number;
  n_删除原结算 Number;

  v_医疗付款方式编码 医疗付款方式.编码%Type;
  v_付款方式         医疗付款方式.名称%Type;
  v_操作员编码       门诊费用记录.操作员编号%Type;
  v_操作员姓名       门诊费用记录.操作员姓名%Type;
  n_结帐id           门诊费用记录.结帐id%Type;
  n_结帐金额         门诊费用记录.结帐金额%Type;
  d_收费时间         病人预交记录.收款时间%Type;
  n_消费卡id         消费卡信息.Id%Type;
  v_收费结算         Varchar2(2000);
  v_普通结算         Varchar2(4000);
  n_是否挂号         Number(3);
  n_预交支付         门诊费用记录.实收金额%Type;
  n_普通支付         门诊费用记录.实收金额%Type;
  v_结算卡号         病人预交记录.卡号%Type;
  v_交易流水号       病人预交记录.交易流水号%Type;
  v_交易说明         病人预交记录.交易说明%Type;
  v_摘要             病人预交记录.摘要%Type;
  n_科室id           挂号安排.科室id%Type;
  n_项目id           挂号安排.项目id%Type;
  n_医生id           挂号安排.医生id%Type;
  v_医生姓名         挂号安排.医生姓名%Type;
  v_号码             挂号安排.号码%Type;
  n_门诊号           病人信息.门诊号%Type;
  d_发生时间         病人挂号记录.发生时间%Type;
  v_费别             病人信息.费别%Type;
  n_号序             病人挂号记录.号序%Type;
  v_Para             Varchar2(500);
  n_挂号模式         Number(3);
  d_启用时间         Date;
  v_临时结算方式     病人预交记录.结算方式%Type;
  n_出诊记录id       临床出诊记录.Id%Type;
  n_安排id           挂号安排.Id%Type;
  n_计划id           挂号安排计划.Id%Type;
  n_序号             门诊费用记录.序号%Type;
  v_附加项目id       Varchar2(500);
  v_附加内容         Varchar2(500);
  v_附加值           Varchar2(100);
  n_Cursor           Number(3);
  n_实收金额         门诊费用记录.实收金额%Type;
  v_实收             Varchar2(500);
  n_从属父号         门诊费用记录.从属父号%Type;
  n_病人科室id       门诊费用记录.病人科室id%Type;
  n_执行部门id       门诊费用记录.执行部门id%Type;
  v_No               门诊费用记录.No%Type;
  v_普通等级         Varchar2(100);
  v_Pricegrade       Varchar2(500);
  n_医保支付         病人预交记录.冲预交%Type;
  n_Exists           Number;
  v_站点             部门表.站点%Type;
  n_结算序号         病人预交记录.结算序号%Type;
  n_业务类型         三方交易记录.业务类型%Type;
  v_Temp             Varchar2(32767); --临时XML
  x_Templet          Xmltype; --模板XML
  v_卡类别           三方交易记录.类别%Type;
  v_操作员           门诊费用记录.操作员姓名%Type;
  v_发药窗口         Varchar2(4000);
  n_误差额           病人预交记录.冲预交%Type;
  n_连续更新         Number;
  n_实名制           Number(3);
  n_认证             Number(3);
  n_Step             Number(2);
  n_Checkmzlg        Number(2);
  n_Count            Number(2);
  n_是否电子票据       病人预交记录.是否电子票据%Type;
  v_支付宝公众号userid Varchar2(100);
  v_支付宝小程序userid Varchar2(100);
  v_微信公众号openid   Varchar2(100);
  v_微信小程序openid   Varchar2(100);
  n_开票标志           Number(2);

  v_开票日期 Varchar2(20);
  v_患者姓名 电子票据使用记录.姓名%Type;
  v_发票编号 电子票据使用记录.号码%Type;
  n_发票金额 电子票据使用记录.票据金额%Type;
  v_Url      电子票据使用记录.Url内网%Type;
  v_Url外网  电子票据使用记录.Url外网%Type;
  n_自动发料 Number(2);

  Type Price_Type Is Record(
    项目id 门诊费用记录.收费细目id%Type,
    数次   门诊费用记录.数次%Type,
    单价   门诊费用记录.标准单价%Type,
    应收   门诊费用记录.应收金额%Type,
    实收   门诊费用记录.实收金额%Type); --定义Price记录类型
  Type Price_Type_Array Is Table Of Price_Type Index By Binary_Integer; --定义存放Price记录的数组类型
  Price_Rec       Price_Type; --声明变量，类型：Price记录类型
  Price_Rec_Array Price_Type_Array; --声明变量，类型：存放Price记录的数组类型

  v_Err_Msg Varchar2(200);
  Err_Item    Exception;
  Err_Special Exception;

  --获取卡类别名称
  Function Get_Cardname
  (
    卡类别_In Varchar2,
    消费卡_In Number
  ) Return Varchar2 As
    v_名称       医疗卡类别.名称%Type;
    n_By_Id_Find Number;
  
    v_Err_Msg Varchar2(200);
    Err_Item Exception;
  Begin
    If 卡类别_In Is Null Then
      Return Null;
    End If;
  
    Select Decode(Translate(Nvl(卡类别_In, 'abcd'), '#1234567890', '#'), Null, 1, 0) Into n_By_Id_Find From Dual;
  
    --1.按卡类别ID查找医疗卡
    If Nvl(消费卡_In, 0) = 0 And Nvl(n_By_Id_Find, 0) = 1 Then
      Begin
        Select 名称 Into v_名称 From 医疗卡类别 Where ID = To_Number(卡类别_In);
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息！';
          Raise Err_Item;
      End;
    End If;
  
    --2.按卡名称查找医疗卡
    If Nvl(消费卡_In, 0) = 0 And Nvl(n_By_Id_Find, 0) = 0 Then
      Begin
        Select 名称 Into v_名称 From 医疗卡类别 Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := 卡类别_In || '不存在!';
          Raise Err_Item;
      End;
    End If;
  
    --3.按卡类别ID查找消费卡
    If Nvl(消费卡_In, 0) = 1 And Nvl(n_By_Id_Find, 0) = 1 Then
      Begin
        Select 名称 Into v_名称 From 消费卡类别目录 Where 编号 = To_Number(卡类别_In);
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息！';
          Raise Err_Item;
      End;
    End If;
  
    --3.按卡名称查找消费卡
    If Nvl(消费卡_In, 0) = 1 And Nvl(n_By_Id_Find, 0) = 0 Then
      Begin
        Select 名称 Into v_名称 From 消费卡类别目录 Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := 卡类别_In || '不存在!';
          Raise Err_Item;
      End;
    End If;
  
    Return v_名称;
  Exception
    When Err_Item Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  End;

  --获取卡类别ID
  Function Get_Cardtypeid
  (
    卡类别_In    Varchar2,
    消费卡_In    Number,
    结算方式_Out In Out 医疗卡类别.结算方式%Type
  ) Return Number As
    n_卡类别id 医疗卡类别.Id%Type;
    v_名称     医疗卡类别.名称%Type;
    n_启用     医疗卡类别.是否启用%Type;
    v_结算方式 医疗卡类别.结算方式%Type;
  
    n_By_Id_Find Number;
    v_Err_Msg    Varchar2(200);
    Err_Item Exception;
  Begin
    If 卡类别_In Is Null Then
      Return 0;
    End If;
  
    Select Decode(Translate(Nvl(卡类别_In, 'abcd'), '#1234567890', '#'), Null, 1, 0) Into n_By_Id_Find From Dual;
  
    --1.按卡类别ID查找医疗卡
    If Nvl(消费卡_In, 0) = 0 And Nvl(n_By_Id_Find, 0) = 1 Then
      Begin
        Select ID, 结算方式, 名称, 是否启用
        Into n_卡类别id, v_名称, v_结算方式, n_启用
        From 医疗卡类别
        Where ID = To_Number(卡类别_In);
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息！';
          Raise Err_Item;
      End;
    End If;
  
    --2.按卡名称查找医疗卡
    If Nvl(消费卡_In, 0) = 0 And Nvl(n_By_Id_Find, 0) = 0 Then
      Begin
        Select ID, 结算方式, 名称, 是否启用
        Into n_卡类别id, v_名称, v_结算方式, n_启用
        From 医疗卡类别
        Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := 卡类别_In || '不存在!';
          Raise Err_Item;
      End;
    End If;
  
    --3.按卡类别ID查找消费卡
    If Nvl(消费卡_In, 0) = 1 And Nvl(n_By_Id_Find, 0) = 1 Then
      Begin
        Select 编号, 结算方式, 名称, 启用
        Into n_卡类别id, v_名称, v_结算方式, n_启用
        From 消费卡类别目录
        Where 编号 = To_Number(卡类别_In);
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息！';
          Raise Err_Item;
      End;
    End If;
  
    --3.按卡名称查找消费卡
    If Nvl(消费卡_In, 0) = 1 And Nvl(n_By_Id_Find, 0) = 0 Then
      Begin
        Select 编号, 结算方式, 名称, 启用
        Into n_卡类别id, v_名称, v_结算方式, n_启用
        From 消费卡类别目录
        Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := 卡类别_In || '不存在!';
          Raise Err_Item;
      End;
    End If;
  
    If Nvl(n_启用, 0) = 0 Then
      v_Err_Msg := v_名称 || '未启用，不允许进行缴费！';
      Raise Err_Item;
    End If;
  
    If 结算方式_Out Is Null Then
      If v_结算方式 Is Null Then
        v_Err_Msg := v_名称 || '未设置结算方式，不允许进行缴费！';
        Raise Err_Item;
      End If;
    
      结算方式_Out := v_结算方式;
    End If;
  
    Return n_卡类别id;
  Exception
    When Err_Item Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  End;

  Procedure Thirdcard_Balance
  (
    病人id_In     病人预交记录.病人id%Type,
    结帐id_In     病人预交记录.结帐id%Type,
    结算方式_In   病人预交记录.结算方式%Type,
    卡类别_In     病人预交记录.卡类别id%Type,
    卡号_In       病人预交记录.卡号%Type,
    支付金额_In   病人预交记录.冲预交%Type,
    交易流水号_In 病人预交记录.交易流水号%Type,
    交易说明_In   病人预交记录.交易说明%Type,
    No_In         病人预交记录.No%Type,
    关联交易id_In 病人预交记录.关联交易id%Type,
    Xmlexpned_In  Xmltype,
    结算模式_In   Number := 0,
    操作类型_In   Number := 0,
    删除原结算_In Number := 0
  ) Is
    --入参：
    --         结算模式_in   0-普通模式，1-异步结算模式
    --        操作类型_in   结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算
    --        删除原结算_in 操作类型_In为1时有效，多个结算方式时调用多次该过程
    v_收费结算 Varchar2(2000);
    n_校对标志 病人预交记录.校对标志%Type;
  Begin
    If Nvl(结算模式_In, 0) = 1 And Nvl(操作类型_In, 0) = 0 Then
      n_校对标志 := 1;
    Else
      n_校对标志 := 2;
    End If;
  
    --结算方式|结算金额|结算号码|结算摘要|单据号|是否普通结算
    v_收费结算 := 结算方式_In || '|' || 支付金额_In || '| | |' || No_In || '|0';
    Zl_门诊收费结算_Modify(4, 病人id_In, 结帐id_In, v_收费结算, 0, 0, 卡类别_In, 卡号_In, 交易流水号_In, 交易说明_In, 0, 0, 0, 0, Null, Null, 0,
                     关联交易id_In, 删除原结算_In, n_校对标志);
  
    If Nvl(结算模式_In, 0) = 1 And Nvl(操作类型_In, 0) = 0 Then
      Return;
    End If;
  
    --保存扩展结算信息
    For c_扩展 In (Select Extractvalue(j.Column_Value, '/EXPEND/JYMC') As Jymc,
                        Extractvalue(j.Column_Value, '/EXPEND/JYLR') As Jylr
                 From Table(Xmlsequence(Extract(Xmlexpned_In, '/EXPENDLIST/EXPEND'))) J) Loop
      Zl_三方结算交易_Insert(卡类别_In, 0, 卡号_In, 结帐id_In, c_扩展.Jymc || '|' || c_扩展.Jylr);
    End Loop;
  End Thirdcard_Balance;

  Procedure Squarecard_Balance
  (
    病人id_In     病人预交记录.病人id%Type,
    结帐id_In     病人预交记录.结帐id%Type,
    卡类别_In     病人预交记录.卡类别id%Type,
    卡号_In       病人预交记录.卡号%Type,
    支付金额_In   病人预交记录.冲预交%Type,
    交易流水号_In 病人预交记录.交易流水号%Type,
    交易说明_In   病人预交记录.交易说明%Type,
    Xmlexpned_In  Xmltype
  ) Is
    v_收费结算 Varchar2(2000);
    n_消费卡id 消费卡信息.Id%Type;
  Begin
    Select ID
    Into n_消费卡id
    From 消费卡信息
    Where 接口编号 = 卡类别_In And 卡号 = 卡号_In And
          序号 = (Select Max(序号) From 消费卡信息 Where 接口编号 = 卡类别_In And 卡号 = 卡号_In);
  
    --结算方式_IN格式为:卡类别ID|卡号|消费卡ID|消费金额||....
    v_收费结算 := 卡类别_In || '|' || 卡号_In || '|' || n_消费卡id || '|' || 支付金额_In;
    Zl_门诊收费结算_Modify(3, 病人id_In, 结帐id_In, v_收费结算, 0, 0, 卡类别_In, 卡号_In, 交易流水号_In, 交易说明_In, 0, 0, 0, 0);
  
    --保存扩展结算信息
    For c_扩展 In (Select Extractvalue(j.Column_Value, '/EXPEND/JYMC') As Jymc,
                        Extractvalue(j.Column_Value, '/EXPEND/JYLR') As Jylr
                 From Table(Xmlsequence(Extract(Xmlexpned_In, '/EXPENDLIST/EXPEND'))) J) Loop
      Zl_三方结算交易_Insert(卡类别_In, 1, 卡号_In, 结帐id_In, c_扩展.Jymc || '|' || c_扩展.Jylr, 0);
    End Loop;
  End Squarecard_Balance;

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/NO'), To_Number(Extractvalue(Value(A), 'IN/BRID')),
         To_Number(Extractvalue(Value(A), 'IN/JE')), To_Number(Extractvalue(Value(A), 'IN/WCJE')),
         To_Number(Extractvalue(Value(A), 'IN/SFGH')), Extractvalue(Value(A), 'IN/ZD'),
         Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM'), Extractvalue(Value(A), 'IN/JSMS'),
         Extractvalue(Value(A), 'IN/CZLX'), Extractvalue(Value(A), 'IN/JZID'), Extractvalue(Value(A), 'IN/ZFBZH'),
         Extractvalue(Value(A), 'IN/ZFBXCY'), Extractvalue(Value(A), 'IN/WXGZHID'), Extractvalue(Value(A), 'IN/WXXCXID')
  Into v_Nos, n_病人id, n_结算金额, n_误差额, n_是否挂号, v_站点, v_身份证号, v_姓名, n_结算模式, n_操作类型, n_结帐id, v_支付宝公众号userid, v_支付宝小程序userid,
       v_微信公众号openid, v_微信小程序openid 
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;

  --0.相关检查
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '不能有效识别病人身份,不允许缴费!';
    Raise Err_Item;
  End If;
  If Not v_支付宝公众号userid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('支付宝公众号UserID'), v_支付宝公众号userid);
  End If;

  If Not v_支付宝小程序userid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('支付宝小程序UserID'), v_支付宝公众号userid);
  End If;

  If Not v_微信公众号openid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('微信公众号OpenID'), v_支付宝公众号userid);
  End If;

  If Not v_微信小程序openid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('微信小程序OpenID'), v_支付宝公众号userid);
  End If;

  If v_Nos Is Null Then
    v_Err_Msg := '没有指定相关的收费单据,不允许缴费!';
    Raise Err_Item;
  End If;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) <> 0 Then
    If Nvl(n_结帐id, 0) = 0 Then
      v_Err_Msg := '没有指定相关的结算数据！';
      Raise Err_Item;
    End If;
  
    Begin
      Select 收款时间
      Into d_收费时间
      From 病人预交记录
      Where 结帐id = n_结帐id And Nvl(校对标志, 0) = 1 And Rownum < 2;
    Exception
      When Others Then
        v_Err_Msg := '没有找到指定的相关结算数据，可能已被处理！';
        Raise Err_Item;
    End;
  End If;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 2 Then
    If Nvl(n_是否挂号, 0) = 0 Then
      --删除结算数据，恢复划价单
      Zl_病人结算记录_Delete(n_结帐id);
      Zl_门诊收费结算_Cancel(n_结帐id);
    Else
      Zl_病人挂号记录_Cancel(n_结帐id);
    End If;
  
    v_Temp := '<CZSJ>' || To_Char(d_收费时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<JZID>' || n_结帐id || '</JZID>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<KPBZ>' || 0 || '</KPBZ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<URL>' || '' || '</URL>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<NETURL>' || '' || '</NETURL>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<FPTT>' || v_姓名 || '</FPTT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<FPH>' || '' || '</FPH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<FPJE>' || '' || '</FPJE>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<KPRQ>' || '' || '</KPRQ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    Xml_Out := x_Templet;
    Return;
  End If;

  --人员id,人员编号,人员姓名
  v_Temp := Zl_Identity(1);
  If Nvl(v_Temp, '0') = '0' Or Nvl(v_Temp, '_') = '_' Then
    v_Err_Msg := '系统不能认别有效的操作员,不允许缴费!';
    Raise Err_Item;
  End If;
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_操作员编码 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_操作员姓名 := v_Temp;

  Begin
    Select b.编码, b.名称, a.姓名, a.性别, a.年龄
    Into v_医疗付款方式编码, v_付款方式, v_姓名, v_性别, v_年龄
    From 病人信息 A, 医疗付款方式 B
    Where a.医疗付款方式 = b.名称(+) And a.病人id = n_病人id;
  Exception
    When Others Then
      v_Err_Msg := '指定的缴费单据中不能有效识别病人,不允许缴费!';
      Raise Err_Item;
  End;

  n_Checkmzlg := To_Number(Nvl(zl_GetSysParameter(323), '0'));
  Select Decode(Nvl(n_是否挂号, 0), 0, 3, 4) Into n_业务类型 From Dual;
  If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
    For c_交易记录 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                          Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                          Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                          Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要,
                          Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡,
                          Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交
                   From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
    
      If Nvl(c_交易记录.是否冲预交, 0) = 0 Then
        If c_交易记录.结算卡类别 Is Null Then
          v_卡类别 := c_交易记录.结算方式;
        Else
          v_卡类别 := Get_Cardname(c_交易记录.结算卡类别, c_交易记录.是否消费卡);
        End If;
      
        If v_卡类别 Is Null Then
          v_Err_Msg := '不支持的结算方式,请检查！';
          Raise Err_Item;
        End If;
      
        --仅第一个结算方式才检查交易锁
        n_Step := Nvl(n_Step, 0) + 1;
        If Zl_Fun_三方交易记录_Locked(v_卡类别, c_交易记录.交易流水号, c_交易记录.结算卡号, c_交易记录.摘要, n_业务类型) = 0 And n_Step = 1 Then
          v_Err_Msg := '交易流水号为:' || c_交易记录.交易流水号 || '的交易正在进行中，不允许再次提交此交易!';
          Raise Err_Special;
        End If;
      Else
        If Nvl(n_Checkmzlg, 0) <> 0 Then
          Select Count(1)
          Into n_Count
          From 病案主页 A, 病人信息 B
          Where a.病人id = n_病人id And a.病人性质 = 1 And a.病人id = b.病人id And a.主页id = b.主页id And Nvl(b.在院, 0) = 1;
          If n_Count <> 0 Then
            v_Err_Msg := '门诊留观病人不能使用门诊预交！';
            Raise Err_Item;
          End If;
        End If;
      End If;
    End Loop;
  End If;

  --费用单据
  If Nvl(n_是否挂号, 0) = 0 Then
    If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
      --1.进行费用收费处理
      --获取发药窗口
      v_发药窗口 := Zl_Getclinicchargepaywins(v_Nos);
    
      Select 病人结帐记录_Id.Nextval, Sysdate Into n_结帐id, d_收费时间 From Dual;
    
      n_结帐金额 := 0;
      For c_缴费单 In (Select /*+ rule */
                     a.No, Max(a.开单部门id) As 开单部门id, Max(a.病人科室id) As 病人科室id, Max(a.病人id) As 病人id, Sum(实收金额) As 实收金额,
                     Max(a.开单人) As 开单人
                    From 门诊费用记录 A, Table(f_Str2List(v_Nos)) J
                    Where a.记录性质 = 1 And a.No = j.Column_Value
                    Group By a.No) Loop
        If Nvl(c_缴费单.病人id, 0) <> n_病人id Then
          v_Err_Msg := '缴费单据:' || c_缴费单.No || '与当前病人身份不符,不允许缴费!';
          Raise Err_Item;
        End If;
      
        n_结帐金额 := n_结帐金额 + Nvl(c_缴费单.实收金额, 0);
        Zl_病人划价收费_Insert(c_缴费单.No, n_病人id, 1, v_医疗付款方式编码, v_姓名, v_性别, v_年龄, c_缴费单.病人科室id, c_缴费单.开单部门id, c_缴费单.开单人,
                         n_结帐id, d_收费时间, v_操作员编码, v_操作员姓名, v_发药窗口, 0, d_收费时间);
      End Loop;
    
      --检查总金额是否正确
      If Nvl(n_误差额, 0) = 0 Then
        n_误差额 := Nvl(n_结帐金额, 0) - Nvl(n_结算金额, 0);
        If Abs(n_误差额) > 1.00 Then
          v_Err_Msg := '单据缴款金额与实际结算的误差太大!';
          Raise Err_Item;
        End If;
      End If;
      If Nvl(n_结帐金额, 0) <> Nvl(n_结算金额, 0) + Nvl(n_误差额, 0) Then
        v_Err_Msg := '指定的缴费单据的总金额不对,请重新选择缴费单据!';
        Raise Err_Item;
      End If;
    End If;
  
    --2.确定支付方式
    n_结算序号   := -1 * n_结帐id;
    n_删除原结算 := 0;
    If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 1 Then
      n_删除原结算 := 1;
    End If;
    For c_结算方式 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                          Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号,
                          Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                          Extractvalue(b.Column_Value, '/JS/JSJE') As 结算金额,
                          Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                          Extractvalue(b.Column_Value, '/JS/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要,
                          Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交,
                          Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡,
                          Extractvalue(b.Column_Value, '/JS/DJH') As 单据号,
                          Extract(b.Column_Value, '/JS/EXPENDLIST') As Expend
                   From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
    
      n_消费卡   := Nvl(c_结算方式.是否消费卡, 0);
      v_结算方式 := c_结算方式.结算方式;
      --1.三方卡结算
      If c_结算方式.结算卡类别 Is Not Null And n_消费卡 = 0 Then
        n_卡类别id := Get_Cardtypeid(c_结算方式.结算卡类别, 0, v_结算方式);
        Select Max(关联交易id)
        Into n_关联交易id
        From 病人预交记录
        Where 结帐id = n_结帐id And 卡类别id = n_卡类别id And Rownum < 2;
        If Nvl(n_关联交易id, 0) = 0 Then
          Select 病人预交记录_Id.Nextval Into n_关联交易id From Dual;
        End If;
      
        Thirdcard_Balance(n_病人id, n_结帐id, v_结算方式, n_卡类别id, c_结算方式.结算卡号, c_结算方式.结算金额, c_结算方式.交易流水号, c_结算方式.交易说明,
                          c_结算方式.单据号, n_关联交易id, c_结算方式.Expend, n_结算模式, n_操作类型, n_删除原结算);
      
        n_删除原结算 := 0;
        If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 1 Then
          If c_结算方式.结算卡类别 Is Null Then
            v_卡类别 := v_结算方式;
          Else
            v_卡类别 := Get_Cardname(c_结算方式.结算卡类别, n_消费卡);
          End If;
          Update 三方交易记录
          Set 业务结算id = n_结算序号
          Where 流水号 = c_结算方式.交易流水号 And 类别 = v_卡类别 And 业务类型 = n_业务类型;
        End If;
      
        --完成结算时才处理非三方卡结算的
      Elsif Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 1 Then
        --2.消费卡结算
        If c_结算方式.结算卡类别 Is Not Null And n_消费卡 = 1 Then
          n_卡类别id := Get_Cardtypeid(c_结算方式.结算卡类别, 1, v_结算方式);
          Squarecard_Balance(n_病人id, n_结帐id, n_卡类别id, c_结算方式.结算卡号, c_结算方式.结算金额, c_结算方式.交易流水号, c_结算方式.交易说明,
                             c_结算方式.Expend);
        
          --3.冲预交款
        Elsif Nvl(c_结算方式.是否冲预交, 0) = 1 Then
          Zl_门诊收费结算_Modify(0, n_病人id, n_结帐id, Null, c_结算方式.结算金额, 0, Null, Null, Null, Null, 0, 0, 0, 0);
        
          --4.普通结算
        Else
          If v_结算方式 Is Null Then
            v_Err_Msg := '未指定支付方式，不允许缴款!';
            Raise Err_Item;
          End If;
        
          --结算方式|结算金额|结算号码|结算摘要||..
          v_收费结算 := v_结算方式 || '|' || c_结算方式.结算金额 || '| | ';
          v_普通结算 := v_普通结算 || '||' || v_收费结算;
        End If;
      
        If c_结算方式.结算卡类别 Is Null Then
          v_卡类别 := v_结算方式;
        Else
          v_卡类别 := Get_Cardname(c_结算方式.结算卡类别, n_消费卡);
        End If;
        Update 三方交易记录
        Set 业务结算id = n_结算序号
        Where 流水号 = c_结算方式.交易流水号 And 类别 = v_卡类别 And 业务类型 = n_业务类型;
      End If;
    End Loop;
  
    If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
      v_Temp := '<CZSJ>' || To_Char(d_收费时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      v_Temp := '<JZID>' || n_结帐id || '</JZID>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      v_Temp := '<KPBZ>' || 0 || '</KPBZ>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

      v_Temp := '<URL>' || '' || '</URL>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

      v_Temp := '<NETURL>' || '' || '</NETURL>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

      v_Temp := '<FPTT>' || v_姓名 || '</FPTT>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

      v_Temp := '<FPH>' || '' || '</FPH>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      v_Temp := '<FPJE>' || '' || '</FPJE>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      v_Temp := '<KPRQ>' || '' || '</KPRQ>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

      Xml_Out := x_Templet;
      Return;
    End If;
  
    --5.普通结算及完成结算
    If v_普通结算 Is Not Null Then
      v_普通结算 := Substr(v_普通结算, 3);
    End If;
    --6.电子票据处理
    n_是否电子票据 := b_Einvoice_Request.Einvoice_Start(1, Null);
    Zl_门诊收费结算_Modify(0, n_病人id, n_结帐id, v_普通结算, Null, 0, Null, Null, Null, Null, 0, 0, n_误差额, 1, Null, Null, 1, Null, 0,
                     0, 0, n_是否电子票据);
     
    If Nvl(n_是否电子票据, 0) = 1 Then
      If b_Einvoice_Request.Einvoice_Create(1, n_结帐id, Null, v_Err_Msg) = 1 Then
        Select Max(1), Max(姓名), Max(号码), Max(To_Char(To_Date(Substr(生成时间, 1, 8), 'yyyymmdd'), 'yyyy-mm-dd')), Max(Url内网), Max(Url外网), Max(票据金额)
        Into n_开票标志, v_患者姓名, v_发票编号, v_开票日期, v_Url, v_Url外网, n_发票金额
        From 电子票据使用记录
        Where 结算id = n_结帐id And 票种 = 1 And 记录状态 = 1;

        If v_患者姓名 Is Not Null Then
          v_姓名 := v_患者姓名;
        End If;
      End If;
    End If;

    --6自动发料
    n_自动发料 := zl_To_Number(zl_GetSysParameter(92));
    If Nvl(n_自动发料, 0) = 1 Then
      For c_记录 In (Select Distinct a.No, a.执行部门id
                   From 门诊费用记录 A, 材料特性 B
                   Where a.记录性质 = 1 And a.收费细目id = b.材料id And a.收费类别 = '4' And b.跟踪在用 = 1 And Nvl(a.执行部门id, 0) <> 0 And
                         a.结帐id = n_结帐id) Loop
        Zl_材料收发记录_处方发料(c_记录.执行部门id, 24, c_记录.No, v_操作员姓名, v_操作员姓名, v_操作员姓名, 1, Sysdate);
      End Loop;
    End If;
  
    v_Temp := '<CZSJ>' || To_Char(d_收费时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<JZID>' || n_结帐id || '</JZID>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<KPBZ>' || Nvl(n_开票标志, 0) || '</KPBZ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<URL>' || htf.escape_sc(Nvl(v_Url, '')) || '</URL>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<NETURL>' || htf.escape_sc(Nvl(v_Url外网, '')) || '</NETURL>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<FPTT>' || v_姓名 || '</FPTT>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    v_Temp := '<FPH>' || v_发票编号 || '</FPH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<FPJE>' || Nvl(n_发票金额, 0) || '</FPJE>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<KPRQ>' || v_开票日期 || '</KPRQ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

    Xml_Out := x_Templet;
    Return;
  End If;

  --=================================================================================
  --挂号单据
  n_结帐金额 := 0;
  v_Para     := zl_GetSysParameter(256);
  n_挂号模式 := Substr(v_Para, 1, 1);
  Begin
    d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
  Exception
    When Others Then
      d_启用时间 := Null;
  End;

  --实名制检查
  n_实名制 := To_Number(Nvl(zl_GetSysParameter(319), '0'));
  If n_实名制 = 1 Then
    Select Count(1) Into n_认证 From 病人实名信息 Where 病人id = n_病人id And Rownum < 2;
    If n_认证 = 0 Then
      v_Err_Msg := '病人未实名认证，不能挂号。';
      Raise Err_Item;
    End If;
  End If;

  Begin
    Select a.执行部门id, a.收费细目id, c.Id, a.执行人, b.号别, b.门诊号, b.发生时间, a.费别, b.号序, b.出诊记录id
    Into n_科室id, n_项目id, n_医生id, v_医生姓名, v_号码, n_门诊号, d_发生时间, v_费别, n_号序, n_出诊记录id
    From 门诊费用记录 A, 病人挂号记录 B, 人员表 C
    Where a.No = v_Nos And a.记录性质 = 4 And a.序号 = 1 And a.No = b.No And a.执行人 = c.姓名(+);
  Exception
    When Others Then
      v_Err_Msg := '没有找到指定的单据数据！';
      Raise Err_Item;
  End;

  --预约接收
  If n_挂号模式 = 1 Then
    If d_启用时间 > d_发生时间 And n_出诊记录id Is Null Then
      n_挂号模式 := 0;
    End If;
  End If;

  If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
    v_Pricegrade := Zl_Get_Pricegrade(v_站点);
    v_普通等级   := Substr(v_Pricegrade, 1, Instr(v_Pricegrade, '|') - 1);
  
    Select 病人结帐记录_Id.Nextval, Sysdate Into n_结帐id, d_收费时间 From Dual;
  
    For c_费用 In (Select 1 As 顺序号, b.No, b.收据费目, b.结帐id, b.执行部门id, b.病人科室id, b.开单人, b.收费类别, b.收入项目id, b.附加标志,
                        To_Char(b.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, b.价格父号, b.从属父号, b.序号, b.收费细目id, b.计算单位,
                        Max(m.名称) As 名称, Max(m.规格) As 规格, Sum(b.标准单价) As 单价, Avg(Nvl(b.付数, 1) * b.数次) As 数量,
                        Sum(b.应收金额) As 应收金额, Sum(b.实收金额) As 实收金额, Max(j.名称) As 开单科室, Max(q.名称) As 执行科室
                 From 门诊费用记录 B, 收费项目目录 M, 部门表 J, 部门表 Q
                 Where b.No = v_Nos And b.记录性质 = 4 And Nvl(b.费用状态, 0) = 0 And b.收费细目id = m.Id And b.开单部门id = j.Id(+) And
                       b.执行部门id = q.Id(+)
                 Group By b.No, b.收据费目, b.结帐id, b.执行部门id, b.病人科室id, b.开单人, b.收入项目id, b.收费类别, b.登记时间, b.价格父号, b.从属父号, b.序号,
                          b.收费细目id, b.计算单位, b.附加标志
                 Order By 序号) Loop
    
      Zl_病人预约挂号记录_Update(c_费用.No, c_费用.序号, c_费用.价格父号, c_费用.从属父号, c_费用.收费类别, c_费用.收费细目id, c_费用.数量, c_费用.单价, c_费用.收入项目id,
                         c_费用.收据费目, c_费用.应收金额, c_费用.实收金额, c_费用.附加标志, Null, Null, Null, Null, c_费用.病人科室id, c_费用.执行部门id);
    
      n_结帐金额   := n_结帐金额 + c_费用.实收金额;
      n_序号       := c_费用.序号;
      n_病人科室id := c_费用.病人科室id;
      n_执行部门id := c_费用.执行部门id;
      v_No         := c_费用.No;
    End Loop;
  
    Begin
      Select Zl_Fun_Customregexpenses(n_病人id, 0, v_号码, v_姓名, v_性别, v_年龄, v_身份证号, v_费别, v_付款方式)
      Into v_附加项目id
      From Dual;
    Exception
      When Others Then
        v_附加项目id := Null;
    End;
    If v_附加项目id Is Not Null Then
      If Instr(v_附加项目id, '|') > 0 Then
        v_附加内容   := v_附加项目id || ','; --以空格分开以|结尾,没有结算号码的
        v_附加项目id := '';
        n_Cursor     := 0;
        While v_附加内容 Is Not Null Loop
          v_附加值         := Substr(v_附加内容, 1, Instr(v_附加内容, ',') - 1);
          Price_Rec.项目id := To_Number(Substr(v_附加值, 1, Instr(v_附加值, '|') - 1));
          v_附加值         := Substr(v_附加值, Instr(v_附加值, '|') + 1);
          Price_Rec.数次   := To_Number(Substr(v_附加值, 1, Instr(v_附加值, '|') - 1));
          v_附加值         := Substr(v_附加值, Instr(v_附加值, '|') + 1);
          Price_Rec.单价   := To_Number(Substr(v_附加值, 1, Instr(v_附加值, '|') - 1));
          v_附加值         := Substr(v_附加值, Instr(v_附加值, '|') + 1);
          Price_Rec.应收   := To_Number(Substr(v_附加值, 1, Instr(v_附加值, '|') - 1));
          v_附加值         := Substr(v_附加值, Instr(v_附加值, '|') + 1);
          Price_Rec.实收   := To_Number(v_附加值);
        
          n_Cursor := n_Cursor + 1;
          Price_Rec_Array(n_Cursor) := Price_Rec;
          v_附加内容 := Substr(v_附加内容, Instr(v_附加内容, ',') + 1);
          v_附加项目id := v_附加项目id || ',' || Price_Rec_Array(n_Cursor).项目id;
        End Loop;
      
        If v_附加项目id Is Not Null Then
          v_附加项目id := Substr(v_附加项目id, 2);
        End If;
      
        For c_附加项目 In (Select /*+cardinality(D,10)*/
                        5 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, c.Id As 收入项目id,
                        c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, -1 As 执行科室类型
                       From 收费项目目录 A, 收费价目 B, 收入项目 C, Table(f_Str2List(v_附加项目id)) D
                       Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.Column_Value And Sysdate Between b.执行日期 And
                             Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                             (b.价格等级 = v_普通等级 Or
                             (b.价格等级 Is Null And Not Exists
                              (Select 1
                                From 收费价目
                                Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And Sysdate Between 执行日期 And
                                      Nvl(终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')))))) Loop
        
          n_序号 := n_序号 + 1;
          For n_Cursor In 1 .. Price_Rec_Array.Count Loop
            If c_附加项目.项目id = Price_Rec_Array(n_Cursor).项目id Then
              Zl_病人预约挂号记录_Update(v_No, n_序号, Null, Null, c_附加项目.类别, c_附加项目.项目id, Price_Rec_Array(n_Cursor).数次,
                                 Price_Rec_Array(n_Cursor).单价, c_附加项目.收入项目id, c_附加项目.收据费目, Price_Rec_Array(n_Cursor).应收,
                                 Price_Rec_Array(n_Cursor).实收, Null, Null, Null, Null, Null, n_病人科室id, n_执行部门id);
            
              n_实收金额 := Price_Rec_Array(n_Cursor).实收;
              n_结帐金额 := n_结帐金额 + n_实收金额;
              Exit;
            End If;
          End Loop;
        End Loop;
      Else
        For c_附加项目 In (Select /*+cardinality(D,10)*/
                        5 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次, c.Id As 收入项目id,
                        c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                       From 收费项目目录 A, 收费价目 B, 收入项目 C, Table(f_Str2List(v_附加项目id)) D
                       Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.Column_Value And Sysdate Between b.执行日期 And
                             Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                             (b.价格等级 = v_普通等级 Or
                             (b.价格等级 Is Null And Not Exists
                              (Select 1
                                From 收费价目
                                Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And Sysdate Between 执行日期 And
                                      Nvl(终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')))))
                       Union All
                       Select /*+cardinality(E,10)*/
                        6 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, d.从项数次 As 数次,
                        c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                       From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费从属项目 D, Table(f_Str2List(v_附加项目id)) E
                       Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.从项id And d.主项id = e.Column_Value And
                             Sysdate Between b.执行日期 And Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')) And
                             (b.价格等级 = v_普通等级 Or
                             (b.价格等级 Is Null And Not Exists
                              (Select 1
                                From 收费价目
                                Where b.收费细目id = 收费细目id And 价格等级 = v_普通等级 And Sysdate Between 执行日期 And
                                      Nvl(终止日期, To_Date('3000-1-1', 'YYYY-MM-DD')))))) Loop
          n_序号 := n_序号 + 1;
          If c_附加项目.性质 = 5 Then
            n_从属父号 := n_序号;
          End If;
        
          v_实收     := Zl_Actualmoney(v_费别, c_附加项目.项目id, c_附加项目.收入项目id, c_附加项目.数次 * c_附加项目.单价);
          n_实收金额 := To_Number(Substr(v_实收, Instr(v_实收, ':') + 1));
        
          If c_附加项目.性质 = 5 Then
            Zl_病人预约挂号记录_Update(v_No, n_序号, Null, Null, c_附加项目.类别, c_附加项目.项目id, c_附加项目.数次, c_附加项目.单价, c_附加项目.收入项目id,
                               c_附加项目.收据费目, c_附加项目.数次 * c_附加项目.单价, n_实收金额, Null, Null, Null, Null, Null, n_病人科室id,
                               n_执行部门id);
          Else
            Zl_病人预约挂号记录_Update(v_No, n_序号, Null, n_从属父号, c_附加项目.类别, c_附加项目.项目id, c_附加项目.数次, c_附加项目.单价, c_附加项目.收入项目id,
                               c_附加项目.收据费目, c_附加项目.数次 * c_附加项目.单价, n_实收金额, Null, Null, Null, Null, Null, n_病人科室id,
                               n_执行部门id);
          End If;
          n_结帐金额 := n_结帐金额 + n_实收金额;
        End Loop;
      End If;
    End If;
  
    --检查总金额是否正确
    If Nvl(n_误差额, 0) = 0 Then
      n_误差额 := Nvl(n_结帐金额, 0) - Nvl(n_结算金额, 0);
      If Abs(n_误差额) > 1.00 Then
        v_Err_Msg := '单据缴款金额与实际结算的误差太大!';
        Raise Err_Item;
      End If;
    End If;
    If Nvl(n_结帐金额, 0) <> Nvl(n_结算金额, 0) + Nvl(n_误差额, 0) Then
      Select Max(操作员姓名) Into v_操作员 From 门诊费用记录 Where 记录性质 = 4 And NO = v_Nos;
      If v_操作员 = v_操作员姓名 Then
        v_Err_Msg := '指定的缴费单据的总金额不对,请重新选择缴费单据!';
        Raise Err_Special;
      Else
        v_Err_Msg := '指定的缴费单据的总金额不对,请重新选择缴费单据!';
        Raise Err_Item;
      End If;
    End If;
  
    n_关联交易id := 0;
    For c_结算方式 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                          Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号,
                          Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                          Extractvalue(b.Column_Value, '/JS/JSJE') As 结算金额,
                          Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                          Extractvalue(b.Column_Value, '/JS/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要,
                          Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交,
                          Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡
                   From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
    
      n_消费卡       := Nvl(c_结算方式.是否消费卡, 0);
      v_临时结算方式 := c_结算方式.结算方式;
    
      If Nvl(c_结算方式.是否冲预交, 0) = 1 Then
        n_预交支付 := c_结算方式.结算金额;
      Else
        n_普通支付 := Nvl(n_普通支付, 0) + c_结算方式.结算金额;
      
        If c_结算方式.结算卡类别 Is Not Null Then
          --三方卡结算方式
          If n_消费卡 = 0 Then
            n_卡类别id := Get_Cardtypeid(c_结算方式.结算卡类别, 0, v_临时结算方式);
          Else
            n_结算卡序号 := Get_Cardtypeid(c_结算方式.结算卡类别, 1, v_临时结算方式);
          End If;
          v_结算卡号   := c_结算方式.结算卡号;
          v_交易流水号 := c_结算方式.交易流水号;
          v_交易说明   := c_结算方式.交易说明;
          v_摘要       := c_结算方式.摘要;
        
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          If Nvl(n_关联交易id, 0) = 0 Then
            n_关联交易id := n_预交id;
          End If;
          v_结算方式 := v_结算方式 || '|' || v_临时结算方式 || ',' || c_结算方式.结算金额 || ',,1' || ',' || n_预交id || ',' || n_关联交易id;
        Else
          Select Nvl(Max(1), 0) Into n_Exists From 结算方式 Where 名称 = Nvl(v_临时结算方式, '-') And 性质 In (3, 4);
        
          If n_Exists = 1 Then
            n_医保支付 := c_结算方式.结算金额;
          Else
            --其他结算方式
            v_结算方式 := v_结算方式 || '|' || v_临时结算方式 || ',' || c_结算方式.结算金额 || ',,0';
          End If;
        End If;
      End If;
    End Loop;
  
    If v_结算方式 Is Not Null Then
      v_结算方式 := Substr(v_结算方式, 2);
    End If;
  
    If n_挂号模式 = 0 Then
      Select Nvl(Max(ID), 0), Nvl(Max(计划id), 0)
      Into n_安排id, n_计划id
      From (Select a.Id, 0 As 计划id
             From 挂号安排 A
             Where a.号码 = v_号码 And Not Exists
              (Select 1
                    From 挂号安排计划
                    Where 安排id = a.Id And (d_发生时间 Between 生效时间 + 0 And 失效时间) And 审核时间 Is Not Null)
             Union All
             Select a.安排id As ID, a.Id As 计划id
             From 挂号安排计划 A
             Where a.号码 = v_号码 And a.审核时间 Is Not Null And (d_发生时间 Between a.生效时间 + 0 And a.失效时间) And
                   a.生效时间 = (Select Max(生效时间)
                             From 挂号安排计划
                             Where 审核时间 Is Not Null And 安排id = a.安排id And
                                   d_发生时间 Between Nvl(生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And 失效时间))
      Where Rownum < 2;
      Zl_预约挂号接收_Insert(v_Nos, Null, Null, n_结帐id, Zl_Get_出诊诊室(v_号码, 0, n_安排id, n_计划id), n_病人id, n_门诊号, v_姓名, v_性别, v_年龄,
                       v_医疗付款方式编码, v_费别, v_结算方式, n_普通支付, n_预交支付, n_医保支付, d_发生时间, v_操作员编码, v_操作员姓名, d_收费时间, n_卡类别id,
                       n_结算卡序号, v_结算卡号, v_交易流水号, v_交易说明, Null, 0, 0, Null, 1);
    Else
      Zl_预约挂号接收_出诊_Insert(v_Nos, Null, Null, n_结帐id, Zl_Get_出诊诊室(v_号码, n_出诊记录id), n_病人id, n_门诊号, v_姓名, v_性别, v_年龄,
                          v_医疗付款方式编码, v_费别, v_结算方式, n_普通支付, n_预交支付, Null, d_发生时间, v_操作员编码, v_操作员姓名, d_收费时间, n_卡类别id,
                          n_结算卡序号, v_结算卡号, v_交易流水号, v_交易说明, Null, 0, 0, Null, 1);
    End If;
  End If;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
    v_Temp := '<CZSJ>' || To_Char(d_收费时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<JZID>' || n_结帐id || '</JZID>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
    Return;
  End If;

  Zl_预约挂号接收_序号更新(v_Nos, n_号序, v_操作员编码, v_操作员姓名, d_发生时间, d_收费时间);
  n_连续更新 := 0;
  For c_结算方式 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                        Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号,
                        Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                        Extractvalue(b.Column_Value, '/JS/JSJE') As 结算金额,
                        Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                        Extractvalue(b.Column_Value, '/JS/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要,
                        Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交,
                        Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡
                 From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
  
    v_结算方式 := c_结算方式.结算方式;
    If c_结算方式.结算卡类别 Is Null Then
      v_卡类别 := v_结算方式;
    Else
      v_卡类别 := Get_Cardname(c_结算方式.结算卡类别, c_结算方式.是否消费卡);
      If Nvl(c_结算方式.是否消费卡, 0) = 0 Then
        n_卡类别id := Get_Cardtypeid(c_结算方式.结算卡类别, 0, v_结算方式);
      
        If Nvl(n_卡类别id, 0) <> 0 Then
          v_结算卡号 := c_结算方式.结算卡号;
        
          Select Max(关联交易id)
          Into n_关联交易id
          From 病人预交记录
          Where 结帐id = n_结帐id And 卡类别id = n_卡类别id And Rownum < 2;
          If Nvl(n_关联交易id, 0) = 0 Then
            Select 病人预交记录_Id.Nextval Into n_关联交易id From Dual;
          End If;
        
          Zl_病人挂号收费_Modify(v_Nos, n_结帐id, v_结算方式 || ',' || c_结算方式.结算金额 || ',,' || c_结算方式.摘要, 1, 0, 0, 1, Null, n_连续更新,
                           n_关联交易id, n_卡类别id, v_结算卡号, c_结算方式.交易流水号, c_结算方式.交易说明);
        
          For c_扩展信息 In (Select Extractvalue(b.Column_Value, '/EXPEND/JYMC') As 交易名称,
                                Extractvalue(b.Column_Value, '/EXPEND/JYLR') As 交易内容
                         From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS/EXPENDLIST/EXPEND'))) B) Loop
            Zl_三方结算交易_Insert(n_卡类别id, 0, v_结算卡号, n_结帐id, c_扩展信息.交易名称 || '|' || c_扩展信息.交易内容, 0);
          End Loop;
        End If;
      End If;
    End If;
    n_连续更新 := 1;
  
    Update 三方交易记录
    Set 业务结算id = n_结帐id
    Where 流水号 = c_结算方式.交易流水号 And 类别 = v_卡类别 And 业务类型 = n_业务类型;
  End Loop;

  --6.电子票据处理
  n_是否电子票据 := b_Einvoice_Request.Einvoice_Start(4, Null);
  Zl_病人挂号收费_Modify(v_Nos, n_结帐id, Null, 0, 1, 0, 1, Null, 0, Null, Null, Null, Null, Null, 0, 2, n_是否电子票据);

  --处理汇总
  Zl_病人挂号汇总_Update(v_医生姓名, n_医生id, n_项目id, n_科室id, d_发生时间, 2, v_号码, 1, n_出诊记录id);

  If Nvl(n_是否电子票据, 0) = 1 Then
    If b_Einvoice_Request.Einvoice_Create(4, n_结帐id, Null, v_Err_Msg) = 1 Then
      Select Max(1), Max(姓名), Max(号码), Max(To_Char(To_Date(Substr(生成时间, 1, 8), 'yyyymmdd'), 'yyyy-mm-dd')), Max(Url内网), Max(Url外网), Max(票据金额)
      Into n_开票标志, v_患者姓名, v_发票编号, v_开票日期, v_Url, v_Url外网, n_发票金额
      From 电子票据使用记录
      Where 结算id = n_结帐id And 票种 = 4 And 记录状态 = 1;

      If v_患者姓名 Is Not Null Then
        v_姓名 := v_患者姓名;
      End If;
    End If;
  End If;
  v_Temp := '<CZSJ>' || To_Char(d_收费时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<JZID>' || n_结帐id || '</JZID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<KPBZ>' || Nvl(n_开票标志, 0) || '</KPBZ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<URL>' || htf.escape_sc(Nvl(v_Url, '')) || '</URL>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<NETURL>' || htf.escape_sc(Nvl(v_Url外网, '')) || '</NETURL>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<FPTT>' || v_姓名 || '</FPTT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<FPH>' || v_发票编号 || '</FPH>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<FPJE>' || Nvl(n_发票金额, 0) || '</FPJE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<KPRQ>' || v_开票日期 || '</KPRQ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Err_Special Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20105, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Payment;
/
CREATE OR REPLACE Procedure Zl_Third_Regist
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:HIS挂号
  --入参:Xml_In:
  --<IN>
  --   <CZFS>3</CZFS>    //操作方式
  --   <CZJLID>1</CZJLID>    //出诊记录ID
  --   <HM>号码</HM>    //号码
  --   <HX>号序</HX>     //号序
  --   <JKFS>0</JKFS>  //缴款方式,0-挂号或预约缴款;1-预约不缴款
  --   <YYSJ>2014-10-21 </YYSJ>    //预约日期 YYYY-MM-DD,分时段非序号控制需要传入时间
  --   <JE>金额</JE>     //金额
  --   <HZDW>合作单位</HZDW>        //合作单位名称
  --   <YYFS>支付宝<YYFS>    //预约方式,如自助机，支付宝
  --   <BRID>病人ID</BRID>     //病人ID
  --   <SFZH>身份证号</SFZH>     //身份证号
  --   <XM>姓名</XM>            //姓名
  --   <BRLX></BRLX>             //医保病人类型
  --   <FB>普通</FB>               //病人费别，可以不传
  --   <JQM>机器名</JQM>            //机器名
  --   <JSMS>1</JSMS>          //结算模式：0-普通模式，1-异步结算模式
  --   <CZLX>0</CZLX>          //操作类型：结算模式为1时传入，0-开始结算，1-完成结算，2-回退结算
  --   <JZID>1</JZID>          //结帐ID，操作类型为1或2时传入
  --   <ZFBZH>支付宝公众号UserID</ZFBZH>
  --   <ZFBXCY>支付宝小程序UserID</ZFBXCY>
  --   <WXGZHID>微信公众号OpenID</WXGZH>
  --   <WXXCXID>微信小程序OpenID</WXXCXID>
  --   <JSLIST>          //结算列表，操作类型为2时可不传入
  --     <JS>            //结算信息，挂号非医保结算目前仅支持一个，结构与收费一致
  --       <JSKLB>结算卡类别</JSKLB>    //结算卡类别
  --       <JSKH>支付宝帐号</JSKH>           //结算卡号(支付宝帐号)
  --       <JYSM>交易说明</JYSM>            //说明，固定传支付宝
  --       <JYLSH>流水号</JYLSH>           //流水号，传订单号
  --       <JSFS>结算方式</JSFS>            //结算方式:现金、支票，如果是三方卡,可以传空
  --       <JSJE>结算金额</JSJE>            //结算金额
  --       <ZY>摘要</ZY>                  //摘要
  --       <SFCYJ></SFCYJ>              //是否冲预交，挂号目前不传
  --       <SFXFK></SFXFK>              //是否消费卡,挂号目前不传
  --       <EXPENDLIST>                 //扩展信息
  --         <EXPEND>
  --           <JYMC>交易名称</JYMC>        //交易名称
  --           <JYLR>交易内容<JYLR>         //交易内容
  --         </EXPEND>
  --         <EXPEND>
  --           ...
  --         </EXPEND>
  --       </EXPENDLIST>
  --     </JS>
  --   </JSLIST>
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  -- <GHDH>挂号单号</GHDH>          //挂号单号
  -- <CZSJ>操作时间</CZSJ>          //HIS的登记时间
  -- <JZID>结帐ID</JZID>          //本次结帐ID
  --  <KPBZ>开票标志</KPBZ> //1-成功开具电子票据;0-未开票成功标志
  --  <URL>H5页面URL</URL>
  --  <NETURL>外网H5页面URL</NETURL>
  --  <FPTT>发票抬头</FPTT>        //病人姓名
  --  <FPH>发票号</FPH>             //发票编号
  --  <FPJE>发票金额</FPJE>        //100.00
  --  <KPRQ>开票日期</KPRQ>   //yyyy-mm-dd
  -- <ERROR><MSG>错误信息</MSG></ERROR>  //出错时返回
  --</ OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_号码     挂号安排.号码%Type;
  n_号序     挂号序号状态.序号%Type;
  d_原始时间 Date;
  n_应收金额 门诊费用记录.应收金额%Type;
  v_预约方式 预约方式.名称%Type;
  v_合作单位 病人挂号记录.合作单位%Type;
  n_病人id   病人信息.病人id%Type;
  v_病人类型 病人信息.病人类型%Type;
  v_费别     门诊费用记录.费别%Type;
  v_机器名   挂号序号状态.机器名%Type;
  n_缴款方式 Number(3);
  n_记录id   临床出诊记录.Id%Type;
  v_身份证号 病人信息.身份证号%Type;
  v_姓名     门诊费用记录.姓名%Type;
  v_性别     病人信息.性别%Type;
  v_年龄     病人信息.年龄%Type;
  n_门诊号   病人信息.门诊号%Type;
  v_付款方式名称 病人信息.医疗付款方式%Type;
  n_结算模式 Number(1); --0-普通模式，1-异步结算模式
  n_操作类型 Number(1); --结算模式为1时传入，0 - 开始结算，1 - 完成结算，2 - 回退结算

  v_Para     Varchar2(2000);
  n_挂号模式 Number(3);
  d_启用时间 Date;
  d_发生时间 Date;
  d_登记时间 Date;

  n_操作方式   Number;
  v_流水号     病人预交记录.交易流水号%Type;
  v_说明       门诊费用记录.摘要%Type;
  v_卡类别名称 医疗卡类别.名称%Type;
  v_结算卡号   病人预交记录.卡号%Type;
  v_No         病人挂号记录.No%Type;
  v_结算方式   医疗卡类别.结算方式%Type;

  n_结帐id   门诊费用记录.结帐id%Type;
  n_卡类别id 医疗卡类别.Id%Type;
  v_排班     挂号安排.周日%Type;
  n_安排id   挂号安排.Id%Type;
  n_计划id   挂号安排计划.Id%Type;
  n_预交id   病人预交记录.Id%Type;
  n_序号控制 挂号安排.序号控制%Type;
  v_星期     挂号安排限制.限制项目%Type;
  v_现金     结算方式.名称%Type;
  n_分时段   Number(3);
  v_结算内容 Varchar2(3000);
  v_保险结算 Varchar2(1000);
  n_Step     Number(2);

  v_卡类别     三方交易记录.类别%Type;
  n_冲预交     病人预交记录.冲预交%Type;
  n_关联交易id 病人预交记录.关联交易id%Type;

  v_Temp    Varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML

  n_Count     Number(3);
  n_Checkmzlg Number(2);
  v_Err_Msg   Varchar2(200);
  Err_Item    Exception;
  Err_Special Exception;
  n_是否电子票据       病人预交记录.是否电子票据%Type;
  v_支付宝公众号userid Varchar2(100);
  v_支付宝小程序userid Varchar2(100);
  v_微信公众号openid   Varchar2(100);
  v_微信小程序openid   Varchar2(100);
  n_开票标志           Number(2);
  v_患者姓名           电子票据使用记录.姓名%Type;
  v_发票编号           电子票据使用记录.号码%Type;
  v_开票日期           Varchar2(20);
  n_发票金额           电子票据使用记录.票据金额%Type;
  v_Url                电子票据使用记录.Url内网%Type;
  v_Url外网            电子票据使用记录.Url外网%Type;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/HM'), Extractvalue(Value(A), 'IN/HX'),
         To_Date(Extractvalue(Value(A), 'IN/YYSJ'), 'YYYY-MM-DD hh24:mi:ss'), Extractvalue(Value(A), 'IN/JE'),
         Extractvalue(Value(A), 'IN/YYFS'), Extractvalue(Value(A), 'IN/HZDW'), Extractvalue(Value(A), 'IN/BRID'),
         Extractvalue(Value(A), 'IN/BRLX'), Extractvalue(Value(A), 'IN/FB'), Extractvalue(Value(A), 'IN/JQM'),
         Extractvalue(Value(A), 'IN/JKFS'), Extractvalue(Value(A), 'IN/CZJLID'), Extractvalue(Value(A), 'IN/SFZH'),
         Extractvalue(Value(A), 'IN/XM'), Extractvalue(Value(A), 'IN/JSMS'), Extractvalue(Value(A), 'IN/CZLX'),
         Extractvalue(Value(A), 'IN/JZID'), Extractvalue(Value(A), 'IN/ZFBZH'), Extractvalue(Value(A), 'IN/ZFBXCY'),
         Extractvalue(Value(A), 'IN/WXGZHID'), Extractvalue(Value(A), 'IN/WXXCXID')
  Into v_号码, n_号序, d_原始时间, n_应收金额, v_预约方式, v_合作单位, n_病人id, v_病人类型, v_费别, v_机器名, n_缴款方式, n_记录id, v_身份证号, v_姓名, n_结算模式,
       n_操作类型, n_结帐id, v_支付宝公众号userid, v_支付宝小程序userid, v_微信公众号openid, v_微信小程序openid
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '无法确定病人信息,请检查!';
    Raise Err_Item;
  End If;

  If Not v_支付宝公众号userid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('支付宝公众号UserID'), v_支付宝公众号userid);
  End If;

  If Not v_支付宝小程序userid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('支付宝小程序UserID'), v_支付宝公众号userid);
  End If;

  If Not v_微信公众号openid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('微信公众号OpenID'), v_支付宝公众号userid);
  End If;

  If Not v_微信小程序openid Is Null Then
    Zl_病人信息从表_Update(n_病人id, Upper('微信小程序OpenID'), v_支付宝公众号userid);
  End If;


  Select 姓名, 性别, 年龄, 门诊号, 医疗付款方式
  Into v_姓名, v_性别, v_年龄, n_门诊号, v_付款方式名称
  From 病人信息
  Where 病人id = n_病人id;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) <> 0 Then
    If Nvl(n_结帐id, 0) = 0 Then
      v_Err_Msg := '没有指定相关的结算数据！';
      Raise Err_Item;
    End If;

    Begin
      Select NO, 发生时间, 登记时间
      Into v_No, d_发生时间, d_登记时间
      From 门诊费用记录
      Where 记录性质 = 4 And Nvl(费用状态, 0) = 1 And 结帐id = n_结帐id And Rownum < 2;
    Exception
      When Others Then
        v_Err_Msg := '没有找到指定的相关数据，可能已被处理！';
        Raise Err_Item;
    End;
  End If;

  If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 2 Then
    Zl_病人挂号记录_Cancel(n_结帐id);

    v_Temp := '<GHDH>' || v_No || '</GHDH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<CZSJ>' || To_Char(d_登记时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<JZID>' || n_结帐id || '</JZID>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    Xml_Out := x_Templet;
    Return;
  End If;

  v_Para     := zl_GetSysParameter(256);
  n_挂号模式 := Substr(v_Para, 1, 1);
  Begin
    d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
  Exception
    When Others Then
      d_启用时间 := Null;
  End;

  If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
    If Sysdate - 10 > Nvl(d_启用时间, Sysdate - 30) Then
      If n_挂号模式 = 1 And Nvl(d_原始时间, Sysdate) > Nvl(d_启用时间, Sysdate - 30) And n_记录id Is Null Then
        v_Err_Msg := '系统当前处于出诊表排班模式，传入的参数无法确定挂号安排，请重试！';
        Raise Err_Item;
      End If;
    Else
      If n_挂号模式 = 1 And Nvl(d_原始时间, Sysdate) > Nvl(d_启用时间, Sysdate - 30) And n_记录id Is Null Then
        Begin
          Select a.Id
          Into n_记录id
          From 临床出诊记录 A, 临床出诊号源 B
          Where a.号源id = b.Id And b.号码 = v_号码 And Nvl(d_原始时间, Sysdate) Between a.开始时间 And a.终止时间;
        Exception
          When Others Then
            v_Err_Msg := '系统当前处于出诊表排班模式，传入的参数无法确定挂号安排，请重试！';
            Raise Err_Item;
        End;
      End If;
    End If;

    n_Checkmzlg := To_Number(Nvl(zl_GetSysParameter(323), '0'));
    For c_交易记录 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                          Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                          Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交,
                          Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                          Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要
                   From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop

      --冲预交不需要三方交易锁
      If Nvl(c_交易记录.是否冲预交, 0) = 0 Then
        If c_交易记录.结算卡类别 Is Null Then
          v_卡类别 := c_交易记录.结算方式;
        Else
          Select Decode(Translate(Nvl(c_交易记录.结算卡类别, 'abcd'), '#1234567890', '#'), Null, 1, 0)
          Into n_Count
          From Dual;
          If Nvl(n_Count, 0) = 1 Then
            Select Max(名称) Into v_卡类别 From 医疗卡类别 Where ID = To_Number(c_交易记录.结算卡类别);
          Else
            Select Max(名称) Into v_卡类别 From 医疗卡类别 Where 名称 = c_交易记录.结算卡类别;
          End If;
        End If;

        If v_卡类别 Is Null Then
          v_Err_Msg := '不支持的结算方式,请检查！';
          Raise Err_Item;
        End If;

        --仅第一个结算方式才检查交易锁
        n_Step := Nvl(n_Step, 0) + 1;
        If Zl_Fun_三方交易记录_Locked(v_卡类别, c_交易记录.交易流水号, c_交易记录.结算卡号, c_交易记录.摘要, 4) = 0 And n_Step = 1 Then
          v_Err_Msg := '交易流水号为:' || c_交易记录.交易流水号 || '的交易正在进行中，不允许再次提交此交易!';
          Raise Err_Special;
        End If;
      Else
        If Nvl(n_Checkmzlg, 0) <> 0 Then
          Select Count(1)
          Into n_Count
          From 病案主页 a, 病人信息 b
          Where a.病人id = n_病人id And a.病人性质 = 1 And a.病人id = b.病人id And a.主页id = b.主页id And Nvl(b.在院, 0) = 1;
          If n_Count <> 0 Then
            v_Err_Msg := '门诊留观病人不能使用门诊预交！';
            Raise Err_Item;
          End if;
        End If;
      End If;
    End Loop;

    If v_病人类型 Is Not Null Then
      Select Count(1) Into n_Count From 病人类型 Where 名称 = v_病人类型;
      If n_Count = 0 Then
        v_Err_Msg := '没有发现为(' || v_病人类型 || ')的病人类型！';
        Raise Err_Item;
      End If;
      Update 病人信息 Set 病人类型 = Nvl(病人类型, v_病人类型) Where 病人id = n_病人id;
    End If;

    d_登记时间 := Sysdate;
    v_No       := Nextno(12);
    Select 病人结帐记录_Id.Nextval Into n_结帐id From Dual;

    If n_记录id Is Null Then
      Select C2
      Into v_星期
      From Table(f_Str2list2('1:周日,2:周一,3:周二,4:周三,5:周四,6:周五,7:周六'))
      Where C1 = To_Char(d_原始时间, 'D');

      Begin
        Select ID
        Into n_计划id
        From (Select ID
               From 挂号安排计划
               Where 号码 = v_号码 And d_原始时间 Between Nvl(生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                     失效时间 And 审核时间 Is Not Null
               Order By 生效时间 Desc)
        Where Rownum < 2;
      Exception
        When Others Then
          Select ID Into n_安排id From 挂号安排 Where 号码 = v_号码;
      End;

      d_发生时间 := d_原始时间;
      If Nvl(n_计划id, 0) <> 0 Then
        --从计划读取信息
        Select Decode(To_Char(d_原始时间, 'D'), '1', a.周日, '2', a.周一, '3', a.周二, '4', a.周三, '5', a.周四, '6', a.周五, '7', a.周六,
                       Null), Nvl(a.序号控制, 0)
        Into v_排班, n_序号控制
        From 挂号安排计划 A
        Where a.Id = n_计划id;
        Select Count(1) Into n_分时段 From 挂号计划时段 Where 星期 = v_星期 And 计划id = n_计划id And Rownum < 2;

        --合作单位检查
        If v_合作单位 Is Not Null Then
          Select Count(1)
          Into n_Count
          From 合作单位计划控制
          Where 计划id = n_计划id And 数量 = 0 And 合作单位 = v_合作单位;
          If n_Count = 1 Then
            v_Err_Msg := '传入的合作单位在此号码上被禁用！';
            Raise Err_Item;
          End If;
        End If;

        If n_分时段 = 1 And n_序号控制 = 0 Then
          Select 序号
          Into n_号序
          From 挂号计划时段
          Where 计划id = n_计划id And 星期 = v_星期 And To_Char(开始时间, 'hh24:mi:ss') = To_Char(d_发生时间, 'hh24:mi:ss');
        Else
          Begin
            Select To_Date(To_Char(d_发生时间, 'yyyy-mm-dd') || '' || To_Char(开始时间, 'hh24:mi:ss'), 'YYYY-MM-DD hh24:mi:ss')
            Into d_发生时间
            From 挂号计划时段
            Where 计划id = n_计划id And 星期 = v_星期 And 序号 = Nvl(n_号序, 0);
          Exception
            When Others Then
              If n_分时段 = 1 And n_序号控制 = 1 Then
                Select To_Date(To_Char(d_发生时间, 'yyyy-mm-dd') || '' || To_Char(Max(结束时间), 'hh24:mi:ss'),
                                'YYYY-MM-DD hh24:mi:ss')
                Into d_发生时间
                From 挂号计划时段
                Where 计划id = n_计划id And 星期 = v_星期;
              Else
                Select To_Date(To_Char(d_发生时间, 'yyyy-mm-dd') || '' || To_Char(开始时间, 'hh24:mi:ss'),
                                'YYYY-MM-DD hh24:mi:ss')
                Into d_发生时间
                From 时间段
                Where 时间段 = v_排班;
              End If;
              If d_发生时间 < d_登记时间 Then
                d_发生时间 := d_登记时间;
              End If;
          End;
        End If;
      Else
        --从安排读取信息
        Select Decode(To_Char(d_原始时间, 'D'), '1', b.周日, '2', b.周一, '3', b.周二, '4', b.周三, '5', b.周四, '6', b.周五, '7', b.周六,
                       Null), Nvl(b.序号控制, 0)
        Into v_排班, n_序号控制
        From 挂号安排 B
        Where b.Id = n_安排id;
        Select Count(1) Into n_分时段 From 挂号安排时段 Where 星期 = v_星期 And 安排id = n_安排id And Rownum < 2;

        --合作单位检查
        If v_合作单位 Is Not Null Then
          Select Count(1)
          Into n_Count
          From 合作单位安排控制
          Where 安排id = n_安排id And 数量 = 0 And 合作单位 = v_合作单位;
          If n_Count = 1 Then
            v_Err_Msg := '传入的合作单位在此号码上被禁用！';
            Raise Err_Item;
          End If;
        End If;

        If n_分时段 = 1 And n_序号控制 = 0 Then
          d_发生时间 := d_原始时间;
          Select 序号
          Into n_号序
          From 挂号安排时段
          Where 安排id = n_安排id And 星期 = v_星期 And To_Char(开始时间, 'hh24:mi:ss') = To_Char(d_发生时间, 'hh24:mi:ss');
        Else
          Begin
            Select To_Date(To_Char(d_发生时间, 'yyyy-mm-dd') || '' || To_Char(开始时间, 'hh24:mi:ss'), 'YYYY-MM-DD hh24:mi:ss')
            Into d_发生时间
            From 挂号安排时段
            Where 安排id = n_安排id And 星期 = v_星期 And 序号 = Nvl(n_号序, 0);
          Exception
            When Others Then
              If n_分时段 = 1 And n_序号控制 = 1 Then
                Select To_Date(To_Char(d_发生时间, 'yyyy-mm-dd') || '' || To_Char(Max(结束时间), 'hh24:mi:ss'),
                                'YYYY-MM-DD hh24:mi:ss')
                Into d_发生时间
                From 挂号安排时段
                Where 安排id = n_安排id And 星期 = v_星期;
              Else
                Select To_Date(To_Char(d_发生时间, 'yyyy-mm-dd') || '' || To_Char(开始时间, 'hh24:mi:ss'),
                                'YYYY-MM-DD hh24:mi:ss')
                Into d_发生时间
                From 时间段
                Where 时间段 = v_排班;
              End If;
              If d_发生时间 < d_登记时间 Then
                d_发生时间 := d_登记时间;
              End If;
          End;
        End If;
      End If;
    Else
      --出诊表排班模式
      Begin
        Select 开始时间 Into d_发生时间 From 临床出诊序号控制 Where 记录id = n_记录id And 序号 = n_号序;
      Exception
        When Others Then
          d_发生时间 := d_原始时间;
      End;
    End If;

    --先产生病人挂号记录和病人费用记录
    If Nvl(n_缴款方式, 0) = 0 Then
      If Trunc(d_发生时间) <> Trunc(Sysdate) Then
        n_操作方式 := 3;
      Else
        n_操作方式 := 1;
      End If;
    Else
      n_操作方式 := 2;
    End If;
    Zl_三方机构挂号_Insert(n_操作方式, n_病人id, v_号码, n_号序, v_No, Null, Null, Null, d_发生时间, d_登记时间, v_合作单位, n_应收金额, Null, Null,
                     Null, Null, v_预约方式, Null, Null, Null, 1, n_结帐id, 0, Null, Null, Null, 1, v_费别, Null, v_机器名, 1, 0,
                     n_记录id, 0, Null, 1, 0);
  End If;

  Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
  For r_结算 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                      Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号,
                      Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交,
                      Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                      Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                      Extractvalue(b.Column_Value, '/JS/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/JS/JSJE') As 结算金额
               From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop

    If Nvl(r_结算.是否冲预交, 0) = 0 Then
      If r_结算.结算方式 Is Null Then
        Begin
          Select b.结算方式, b.Id
          Into v_结算方式, n_卡类别id
          From 医疗卡类别 B
          Where b.名称 = r_结算.结算卡类别 And Rownum < 2;
        Exception
          When Others Then
            v_Err_Msg := '没有发现该结算卡的相关信息';
            Raise Err_Item;
        End;
        v_结算内容 := v_结算内容 || '|' || v_结算方式 || ',' || r_结算.结算金额 || ',,';
      Else
        v_结算方式 := r_结算.结算方式;
        Select Count(1) Into n_Count From 结算方式 Where 名称 = v_结算方式 And 性质 In (3, 4);
        If n_Count = 1 And r_结算.结算卡类别 Is Null Then
          v_保险结算 := v_保险结算 || '||' || v_结算方式 || '|' || r_结算.结算金额;
        Else
          v_结算内容 := v_结算内容 || '|' || v_结算方式 || ',' || r_结算.结算金额 || ',,';
        End If;
      End If;

      If r_结算.结算卡类别 Is Not Null Then
        v_结算内容   := v_结算内容 || '1,';
        v_卡类别名称 := r_结算.结算卡类别;
        v_结算卡号   := r_结算.结算卡号;
        v_流水号     := r_结算.交易流水号;
        v_说明       := r_结算.交易说明;
        If n_卡类别id Is Null Then
          Begin
            Select b.Id Into n_卡类别id From 医疗卡类别 B Where b.名称 = r_结算.结算卡类别 And Rownum < 2;
          Exception
            When Others Then
              v_Err_Msg := '没有发现该结算卡的相关信息';
              Raise Err_Item;
          End;
        End If;

        Select Decode(Translate(Nvl(r_结算.结算卡类别, 'abcd'), '#1234567890', '#'), Null, 1, 0)
        Into n_Count
        From Dual;
        If Nvl(n_Count, 0) = 1 Then
          Select Max(名称) Into v_卡类别 From 医疗卡类别 Where ID = To_Number(r_结算.结算卡类别);
        Else
          Select Max(名称) Into v_卡类别 From 医疗卡类别 Where 名称 = r_结算.结算卡类别;
        End If;

        If Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 0 Then
          Select Max(关联交易id)
          Into n_关联交易id
          From 病人预交记录
          Where 记录性质 Not In (1, 11) And 结帐id = n_结帐id And 卡类别id = n_卡类别id And Rownum < 2;
          If Nvl(n_关联交易id, 0) = 0 Then
            n_关联交易id := n_预交id;
          Else
            Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          End If;

          Insert Into 病人预交记录
            (ID, 记录性质, 记录状态, NO, 病人id, 姓名, 性别, 年龄, 门诊号, 付款方式名称, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明,
             合作单位, 结算性质, 结算号码, 交易时间, 交易人员, 关联交易id, 校对标志)
            Select n_预交id, 4, 1, v_No, 病人id, v_姓名, v_性别, v_年龄, n_门诊号, v_付款方式名称, v_结算方式, r_结算.结算金额, 登记时间, 操作员编号, 操作员姓名, 结帐id, Null, 缴款组id, n_卡类别id, Null,
                   v_结算卡号, v_流水号, v_说明, v_合作单位, 4, '三方接口挂号', 登记时间, 操作员姓名, n_关联交易id, 1
            From 门诊费用记录
            Where 记录性质 = 4 And 结帐id = n_结帐id And Rownum < 2;
        Else
          If Nvl(n_结算模式, 0) = 1 Then
            Delete From 病人预交记录 Where 记录性质 Not In (1, 11) And 结帐id = n_结帐id And n_卡类别id = n_卡类别id;
          End If;
          v_结算内容 := v_结算内容 || n_预交id;
        End If;
      Else
        v_结算内容 := v_结算内容 || '0,';
        v_卡类别   := r_结算.结算方式;
      End If;

      If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 1 Then
        Update 三方交易记录
        Set 业务结算id = n_结帐id
        Where 流水号 = r_结算.交易流水号 And 类别 = v_卡类别 And 业务类型 = 4;
      End If;
    Else
      n_冲预交 := r_结算.结算金额;
    End If;
  End Loop;

  If Nvl(n_结算模式, 0) = 0 Or Nvl(n_结算模式, 0) = 1 And Nvl(n_操作类型, 0) = 1 Then
    If v_结算内容 Is Not Null Then
      v_结算内容 := Substr(v_结算内容, 2);
    Else
      Begin
        Select 名称 Into v_现金 From 结算方式 Where 性质 = 1;
      Exception
        When Others Then
          v_现金 := '现金';
      End;
      v_结算内容 := v_现金 || ',' || 0 || ',,0';
    End If;

    If Nvl(n_缴款方式, 0) = 0 Then
      If Trunc(d_发生时间) <> Trunc(Sysdate) Then
        n_操作方式 := 3;
      Else
        n_操作方式 := 1;
      End If;
    Else
      n_操作方式 := 2;
    End If;
    Zl_三方机构挂号_Insert(n_操作方式, n_病人id, v_号码, n_号序, v_No, Null, v_结算内容, Null, d_发生时间, d_登记时间, v_合作单位, n_应收金额, Null, Null,
                     v_流水号, v_说明, v_预约方式, n_预交id, n_卡类别id, Null, 1, n_结帐id, 0, v_保险结算, n_冲预交, v_结算卡号, 1, v_费别, Null,
                     v_机器名, 1, 0, n_记录id, 0, Null, 1, 1);

    If Nvl(n_卡类别id, 0) <> 0 Then
      For c_扩展信息 In (Select Extractvalue(b.Column_Value, '/EXPEND/JYMC') As 交易名称,
                            Extractvalue(b.Column_Value, '/EXPEND/JYLR') As 交易内容
                     From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS/EXPENDLIST/EXPEND'))) B) Loop
        Zl_三方结算交易_Insert(n_卡类别id, 0, v_结算卡号, n_结帐id, c_扩展信息.交易名称 || '|' || c_扩展信息.交易内容, 0);
      End Loop;
    End If;

    --电子票据处理
    n_是否电子票据 := b_Einvoice_Request.Einvoice_Start(4, Null);
    Update 病人预交记录 Set 是否电子票据 = n_是否电子票据 Where 结帐id = n_结帐id;

    If Nvl(n_是否电子票据, 0) = 1 Then
      --需要开具电子票据
      If b_Einvoice_Request.Einvoice_Create(4, n_结帐id, Null, v_Err_Msg) = 1 Then
        Select Max(1), Max(姓名), Max(号码), Max(To_Char(To_Date(Substr(生成时间, 1, 8), 'yyyymmdd'), 'yyyy-mm-dd')), Max(Url内网), Max(Url外网), Max(票据金额)
        Into n_开票标志, v_患者姓名, v_发票编号, v_开票日期, v_Url, v_Url外网, n_发票金额
        From 电子票据使用记录
        Where 结算id = n_结帐id And 票种 = 4 And 记录状态 = 1;

        If v_患者姓名 Is Not Null Then
          v_姓名 := v_患者姓名;
        End If;
      End If;
    End If;
  End If;

  v_Temp := '<GHDH>' || v_No || '</GHDH>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<CZSJ>' || To_Char(d_登记时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<JZID>' || n_结帐id || '</JZID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<KPBZ>' || Nvl(n_开票标志, 0) || '</KPBZ>';
  --v_Temp := '<KPBZ>' ||1|| '</KPBZ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<URL>' || htf.escape_sc(Nvl(v_Url, '')) || '</URL>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<NETURL>' || htf.escape_sc(Nvl(v_Url外网, '')) || '</NETURL>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<FPTT>' || v_姓名 || '</FPTT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<FPH>' || v_发票编号 || '</FPH>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<FPJE>' || Nvl(n_发票金额, 0) || '</FPJE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<KPRQ>' || v_开票日期 || '</KPRQ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Err_Special Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20105, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Regist;
/
Create Or Replace Procedure Zl_Third_Buildpatiinfo
(
  Xml_In    In Xmltype,
  Expend_In In Xmltype,
  Xml_Out   Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:挂号数据写入
  --入参:Xml_In:
  --  <IN>
  --    <FB>费别</FB>                      //掌上中联后台中设定
  --    <FKFS>医疗付款方式</FKFS>          //掌上中联后台中设定
  --    <XM>姓名</XM>
  --    <XB>性别</XB>
  --    <NL>年龄</NL>
  --    <CSRQ>出生日期</CSRQ>
  --    <SFZ >身份证号</SFZ>              //必须有
  --    <KLB>医疗卡名称</KLB>             //固定为：手机支付
  --    <SJH>手机号</SJH>                //如果手机号为空，则以身份证号创建就诊卡；否则以手机号创建就诊卡
  --  </IN>
  --      Expend_In:扩展信息,暂不用,主要是适应移动产品的参数统一
  --出参:Xml_Out
  --  <OUTPUT>
  --    <BRID>1</BRID>                   //返回创建好的档案，或原来已有的档案
  --                                     //如无下列错误结点则说明正确执行
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_费别         病人信息.费别%Type;
  v_付款方式     病人信息.医疗付款方式%Type;
  v_姓名         病人信息.姓名%Type;
  v_性别         病人信息.性别%Type;
  v_年龄         病人信息.年龄%Type;
  d_出生日期     病人信息.出生日期%Type;
  v_身份证号     病人信息.身份证号%Type;
  v_医疗卡名称   医疗卡类别.名称%Type;
  v_卡号         病人医疗卡信息.卡号%Type;
  v_手机号       病人信息.手机号%Type;
  n_卡类别id     医疗卡类别.Id%Type;
  v_结算方式     医疗卡类别.结算方式%Type;
  v_验证姓名     病人信息.姓名%Type;
  n_病人id       病人信息.病人id%Type;
  n_卡病人id     病人信息.病人id%Type;
  v_医疗卡编码   医疗卡类别.编码%Type;
  n_是否缺省密码 医疗卡类别.是否缺省密码%Type;
  v_密码         病人医疗卡信息.密码%Type;
  n_密码长度     医疗卡类别.密码长度%Type;
  v_Temp         varchar2(32767); --临时XML
  x_Templet      Xmltype; --模板XML
  v_Err_Msg      varchar2(200);
  n_Exists       Number(2);
  v_Para         varchar2(20);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/FB'), Extractvalue(Value(A), 'IN/FKFS'), Extractvalue(Value(A), 'IN/XM'),
         Extractvalue(Value(A), 'IN/SFZ'), Extractvalue(Value(A), 'IN/KLB'), Extractvalue(Value(A), 'IN/SJH'),
         Extractvalue(Value(A), 'IN/XB'), Extractvalue(Value(A), 'IN/NL'), To_Date(Extractvalue(Value(A), 'IN/CSRQ'), 'yyyy-mm-dd hh24:mi:ss'),
         Extractvalue(Value(A), 'IN/YLKID'), Extractvalue(Value(A), 'IN/YLKBM')
  Into v_费别, v_付款方式, v_姓名, v_身份证号, v_医疗卡名称, v_手机号, v_性别, v_年龄, d_出生日期, n_卡类别id, v_医疗卡编码
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  v_卡号 := v_手机号;

  --某些入参节点为空的情况
  If Nvl(v_卡号, '_') = '_' Then
    v_卡号 := v_身份证号;
  End If;

  If Nvl(v_性别, '_') = '_' Then
    If Mod(To_Number(Substr(v_身份证号, -2, 1)), 2) = 1 Then
      v_性别 := '男';
    Else
      v_性别 := '女';
    End If;
  End If;

  If d_出生日期 Is Null Then
    If Length(Trim(v_身份证号)) = 15 Then
      d_出生日期 := To_Date('19' || Substr(v_身份证号, 7, 6), 'yyyy-mm-dd');
    End If;
    If Length(Trim(v_身份证号)) = 18 Then
      d_出生日期 := To_Date(Substr(v_身份证号, 7, 8), 'yyyy-mm-dd');
    End If;
  End If;
  If Nvl(v_年龄, '_') = '_' Then
    v_年龄 := Zl_Age_Calc(0, d_出生日期, Sysdate);
  End If;

  --检查医疗卡名称
  If Nvl(n_卡类别id, 0) = 0 Then
    If Nvl(v_医疗卡编码, '_') <> '_' Then
      v_Err_Msg := Null;
      Begin
        Select ID, 结算方式, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行挂号!')
        Into n_卡类别id, v_结算方式, v_Err_Msg
        From 医疗卡类别
        Where 编码 = v_医疗卡编码;
      Exception
        When Others Then
          v_Err_Msg := '医疗卡编码:' || v_医疗卡编码 || '不存在!';
      End;
      If Not v_Err_Msg Is Null Then
        Raise Err_Item;
      End If;
    Elsif Nvl(v_医疗卡名称, '_') <> '_' Then
    
      v_Err_Msg := Null;
      Begin
        Select ID, 结算方式, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行挂号!')
        Into n_卡类别id, v_结算方式, v_Err_Msg
        From 医疗卡类别
        Where 名称 = v_医疗卡名称;
      Exception
        When Others Then
          v_Err_Msg := v_医疗卡名称 || '不存在!';
      End;
      If Not v_Err_Msg Is Null Then
        Raise Err_Item;
      End If;
    Else
      v_Err_Msg := '系统不能识别有效的医疗卡,不允许挂号!';
      Raise Err_Item;
    End If;
  Else
    v_Err_Msg := Null;
    Begin
      Select ID, 结算方式, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行挂号!')
      Into n_卡类别id, v_结算方式, v_Err_Msg
      From 医疗卡类别
      Where ID = n_卡类别id;
    Exception
      When Others Then
        v_Err_Msg := '系统不能识别指定的医疗卡(' || n_卡类别id || ')!';
    End;
    If Not v_Err_Msg Is Null Then
      Raise Err_Item;
    End If;
  End If;

  --建档操作
  Select zl_GetSysParameter(279) Into v_Para From Dual;
  If v_Para = '1' Then
    If Not v_身份证号 Is Null And Not v_姓名 Is Null Then
      n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
      If Nvl(n_病人id, 0) <> 0 Then
        Begin
          Select 1, 姓名 Into n_Exists, v_验证姓名 From 病人信息 Where 病人id = n_病人id;
        Exception
          When Others Then
            n_Exists := 0;
        End;
      End If;
    Else
      n_Exists := 0;
    End If;
  Else
    n_Exists := 0;
  End If;

  If n_Exists >= 1 Then
    If v_姓名 <> v_验证姓名 Then
      v_Err_Msg := '身份证号码与病人姓名不匹配!';
      Raise Err_Item;
    End If;
  Else
    n_病人id := Nextno(1);
    Zl_挂号病人病案_Insert(1, n_病人id, Null, Null, Null, v_姓名, v_性别, v_年龄, v_费别, v_付款方式, Null, Null, Null, Null, v_身份证号, Null,
                     Null, Null, Null, Null, Null, Null, Sysdate, Null, d_出生日期, Null, Null, Null, Null, Null, Null,
                     Null, Null, Null, Null, Null, Null, v_手机号);
  End If;
  v_Temp := '<BRID>' || n_病人id || '</BRID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
  --发卡操作
  Begin
    Select 1, 病人id Into n_Exists, n_卡病人id From 病人医疗卡信息 Where 卡类别id = n_卡类别id And 卡号 = v_卡号;
  Exception
    When Others Then
      n_Exists := 0;
  End;
  If n_Exists = 0 Then
    Zl_医疗卡变动_Insert(1, n_病人id, n_卡类别id, Null, v_卡号, '手机建档', Null, Null, Sysdate);
  Else
    If n_病人id <> n_卡病人id Then
      v_Err_Msg := '该卡号已经被其他人绑定!';
      Raise Err_Item;
    End If;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Buildpatiinfo;
/
----------------------------------------------------------------------------
--[[15.药品卫材业务]]
----------------------------------------------------------------------------
Create Or Replace Procedure Zl_Third_Getpatientdruglist
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取病人当前住院使用的药品列表
  --1、不返回液体
  --2、不返回中草药
  --3、药品去重返回
  --4、按类别分组。
  --5、药品列表按首次下该药品医嘱的开嘱时间倒序排序
  --6、节点属性中display="true"表示该节点在界面上要显示，display="false"表示不显示。
  --7、扩展字段为渠道自行添加的字段。每一个自定义增加的字段，在界面上增加一行显示该信息。

  --入参：xml_in
  --<IN>
  ----<BRID>病人ID</BRID>
  ----<ZYID>主页ID</ZYID>
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  ----<LBLIST>
  ------<LB>                           //分类。默认分为"三天内"和"三天之前"
  --------<LBMC></LBMC>                 //分类名称，如“三天内”
  --------<YPLIST>
  ----------<YP>
  ------------<DZID display="false"></DZID>          //药品与合理用药的对照ID。例如美康为药品ID，中联药品说明书为本位码。
  ------------<YPMC display="true"></YPMC>           //要显示的药品名称，默认显示通用名。
  ------------<YPGG display="true"></YPGG>           //药品规格。
  ------------<EXPENDLIST>               //扩展字段
  --------------<EXPEND display="false">
  ----------------<MC></MC>                          //名称
  ----------------<NR></NR>                          //内容
  --------------</EXPEND>
  ------------</EXPENDLIST>
  ----------</YP>
  --------</YPLIST>
  ------</LB>
  ----</LBLIST>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  n_病人id  病人医嘱记录.病人id%Type;
  n_主页id  病人医嘱记录.主页id%Type;
  v_Temp    Varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML
Begin
  --读取病人ID和主页ID
  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/ZYID')
  Into n_病人id, n_主页id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --同时查询按规格和按品种下医嘱
  --三天内：指今天，昨天，前天，可以根据实际需要调整
  x_Templet := Xmltype('<LB><LBMC>三天内</LBMC><YPLIST></YPLIST></LB>');
  For r_Drug In (Select 收费细目id As 药品id, 名称 As 通用名, 规格
                 From (Select a.收费细目id, a.开嘱时间, a.Id As 医嘱id,
                               Row_Number() Over(Partition By a.收费细目id Order By a.开嘱时间 Desc, a.Id Desc) Top, d.名称, d.规格

                        From (Select b.收费细目id, b.开嘱时间, b.Id
                               From 病人医嘱记录 B
                               Where b.诊疗类别 In ('5', '6') And b.收费细目id Is Not Null And b.执行标记 <> 2 And b.病人id = n_病人id And
                                     b.主页id = n_主页id And b.开嘱时间 >= Trunc(Sysdate - 2)
                               Union All
                               Select a.收费细目id, b.开嘱时间, b.Id As 医嘱id
                               From 住院费用记录 A, 病人医嘱记录 B
                               Where a.医嘱序号 = b.Id And a.病人id + 0 = b.病人id And a.主页id + 0 = b.主页id And b.诊疗类别 In ('5', '6') And
                                     b.收费细目id Is Null And b.执行标记 <> 2 And b.病人id = n_病人id And b.主页id = n_主页id And
                                     b.开嘱时间 >= Trunc(Sysdate - 2)) A, 药品规格 B, 药品特性 C, 收费项目目录 D
                        Where a.收费细目id = b.药品id And b.药名id = c.药名id And a.收费细目id = d.Id And Nvl(c.溶媒, 0) = 0)
                 Where Top = 1
                 Order By 开嘱时间 Desc, 医嘱id Desc) Loop
    v_Temp := '<YP>' || '<DZID display="false">' || r_Drug.药品id || '</DZID>' || '<YPMC display="true">' || r_Drug.通用名 ||
              '</YPMC>' || '<YPGG display="true">' || r_Drug.规格 || '</YPGG>' || '<EXPENDLIST>' ||
              '<EXPEND display="false">' || '<MC>' || '</MC>' || '<NR>' || '</NR>' || '</EXPEND>' || '</EXPENDLIST>' ||
              '</YP>';
    --循环将药品信息插入/LB/YPLIST下
    Select Appendchildxml(x_Templet, '/LB/YPLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  --将三天内的药品信息插入到/OUTPUT/LBLIS下
  Select Appendchildxml(Xmltype('<OUTPUT><LBLIST></LBLIST></OUTPUT>'), '/OUTPUT/LBLIST', x_Templet)
  Into Xml_Out
  From Dual;

  --三天之前：指前天以前
  x_Templet := Xmltype('<LB><LBMC>三天之前</LBMC><YPLIST></YPLIST></LB>');
  For r_Drug In (Select 收费细目id As 药品id, 名称 As 通用名, 规格
                 From (Select a.收费细目id, a.开嘱时间, a.Id As 医嘱id,
                               Row_Number() Over(Partition By a.收费细目id Order By a.开嘱时间 Desc, a.Id Desc) Top, d.名称, d.规格

                        From (Select b.收费细目id, b.开嘱时间, b.Id
                               From 病人医嘱记录 B
                               Where b.诊疗类别 In ('5', '6') And b.收费细目id Is Not Null And b.执行标记 <> 2 And b.病人id = n_病人id And
                                     b.主页id = n_主页id And b.开嘱时间 < Trunc(Sysdate - 2)
                               Union All
                               Select a.收费细目id, b.开嘱时间, b.Id As 医嘱id
                               From 住院费用记录 A, 病人医嘱记录 B
                               Where a.医嘱序号 = b.Id And a.病人id + 0 = b.病人id And a.主页id + 0 = b.主页id And b.诊疗类别 In ('5', '6') And
                                     b.收费细目id Is Null And b.执行标记 <> 2 And b.病人id = n_病人id And b.主页id = n_主页id And
                                     b.开嘱时间 < Trunc(Sysdate - 2)) A, 药品规格 B, 药品特性 C, 收费项目目录 D
                        Where a.收费细目id = b.药品id And b.药名id = c.药名id And a.收费细目id = d.Id And Nvl(c.溶媒, 0) = 0)
                 Where Top = 1
                 Order By 开嘱时间 Desc, 医嘱id Desc) Loop
    v_Temp := '<YP>' || '<DZID display="false">' || r_Drug.药品id || '</DZID>' || '<YPMC display="true">' || r_Drug.通用名 ||
              '</YPMC>' || '<YPGG display="true">' || r_Drug.规格 || '</YPGG>' || '<EXPENDLIST>' ||
              '<EXPEND display="false">' || '<MC>' || '</MC>' || '<NR>' || '</NR>' || '</EXPEND>' || '</EXPENDLIST>' ||
              '</YP>';
    --循环将药品信息插入/LB/YPLIST下
    Select Appendchildxml(x_Templet, '/LB/YPLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  --将三天前的药品信息插入到/OUTPUT/LBLIS下
  Select Appendchildxml(Xml_Out, '/OUTPUT/LBLIST', x_Templet) Into Xml_Out From Dual;

Exception
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><ERROR><MSG>' || SQLCode || '***' || SQLErrM || '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getpatientdruglist;
/
Create Or Replace Procedure Zl_Third_Druglist_Get
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取药品目录
  --入参：xml_in
  --<IN>
  -- <TYPE>5</TYPE>   --类型：5-西药，6-成药，7-草药，0-所有类型
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  ---- <DRUGLIST>                --药品列表，多组
  --------<DRUG>                 --药品信息
  ------------<TYPE>0</TYPE>            --类型：5-西药，6-成药，7-草药
  ------------<ID>15343</ID>               --ID
  ------------<CODE>100003222</CODE>       --编码
  ------------<NAME>青霉素注射液</NAME>    --通用名
  ------------<SPEC>10ml*5mg</SPEC>        --规格
  ------------<PRODUCER>光大制药</PRODUCER>   --生产商
  --------</DRUG>
  --------<DRUG>
  ------------<TYPE>0</TYPE>
  ------------<ID>4578</ID>
  ------------<CODE>100001270</CODE>
  ------------<NAME>阿莫西林胶囊</NAME>
  ------------<SPEC>10mg*40</SPEC>
  ------------<PRODUCER>诺和制药</PRODUCER>
  --------</DRUG>
  ---- <DRUGLIST>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  v_分类    收费项目目录.类别%Type;
  v_Temp    Varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML
  v_Error   Varchar2(2000);
  Err_Custom Exception;
Begin
  x_Templet := Xmltype('<OUTPUT><DRUGLIST></DRUGLIST></OUTPUT>');

  --读取类型；5-西药，6-成药，7-草药，0-所有类型
  Select Extractvalue(Value(A), 'IN/TYPE') Into v_分类 From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_分类 = '0' Or v_分类 = '5' Or v_分类 = '6' Or v_分类 = '7' Then
    v_Temp := '';
    If v_分类 = '0' Then
      --所有类型
      For r_Drug In (Select 类别 类型, ID, 编码, 名称 通用名, 规格, 产地 生产商
                     From 收费项目目录
                     Where 类别 In ('5', '6', '7') And Sysdate Between 建档时间 And 撤档时间) Loop
        v_Temp := '<DRUG>' || '<TYPE>' || r_Drug.类型 || '</TYPE>' || '<ID>' || r_Drug.Id || '</ID>' || '<CODE>' ||
                  r_Drug.编码 || '</CODE>' || '<NAME>' || r_Drug.通用名 || '</NAME>' || '<SPEC>' || r_Drug.规格 || '</SPEC>' ||
                  '<PRODUCER>' || r_Drug.生产商 || '</PRODUCER>' || '</DRUG>';
        Select Appendchildxml(x_Templet, '/OUTPUT/DRUGLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      End Loop;
    Else
      --指定类型
      For r_Drug In (Select 类别 类型, ID, 编码, 名称 通用名, 规格, 产地 生产商
                     From 收费项目目录
                     Where 类别 = v_分类 And Sysdate Between 建档时间 And 撤档时间) Loop
        v_Temp := '<DRUG>' || '<TYPE>' || r_Drug.类型 || '</TYPE>' || '<ID>' || r_Drug.Id || '</ID>' || '<CODE>' ||
                  r_Drug.编码 || '</CODE>' || '<NAME>' || r_Drug.通用名 || '</NAME>' || '<SPEC>' || r_Drug.规格 || '</SPEC>' ||
                  '<PRODUCER>' || r_Drug.生产商 || '</PRODUCER>' || '</DRUG>';
        Select Appendchildxml(x_Templet, '/OUTPUT/DRUGLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      End Loop;
    End If;
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<RESULT>true</RESULT>')) Into Xml_Out From Dual;
  Else
    v_Error := '入参指定TYPE不符规定，请检查！';
    Raise Err_Custom;
  End If;

Exception
  When Err_Custom Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Druglist_Get;
/
Create Or Replace Procedure Zl_Third_Drugrequest_Fill
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：产生药品申领单(不按批次申领模式)
  --入参：xml_in
  --<IN>
  ----<REQSTORE>142</REQSTORE>                    --申请库房id
  ----<OUTSTORE>48</OUTSTORE>                     --出库库房id
  ----<REQPEOPLE>张三</REQPEOPLE>                 --申请人
  ----<REQDATE>2018-09-19 10:23:25</REQDATE>      --申请日期
  ----<SUMMARY>基层药房申请调拨出库</SUMMARY>     --摘要
  ----<BILLLIST>                                  --单据明细，多组数据
  --------<BILL>                                --单据信息
  ------------<DRUGID>10001234</DRUGID>           --药品ID
  ------------<AMOUNT>20</AMOUNT>                 --申请数量(售价单位数量)
  --------</BILL>
  --------<BILL>                                --单据信息
  ------------<DRUGID>10003428</DRUGID>           --药品ID
  ------------<AMOUNT>30</AMOUNT>                 --申请数量(售价单位数量)
  --------</BILL>
  ----</BILLLIST>
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --   <NO>S0000286</NO>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>
  v_No         药品收发记录.No%Type;
  n_序号       药品收发记录.序号%Type := 1;
  n_库房id     药品收发记录.库房id%Type;
  n_对方库房id 药品收发记录.库房id%Type;
  n_药品id     药品收发记录.药品id%Type;
  n_成本价     药品收发记录.成本价%Type;
  n_成本金额   药品收发记录.成本金额%Type;
  n_零售价     药品收发记录.零售价%Type;
  n_零售金额   药品收发记录.零售金额%Type;
  n_差价       药品收发记录.差价%Type;
  v_填制人     药品收发记录.填制人%Type;
  d_填制日期   药品收发记录.填制日期%Type;
  v_摘要       药品收发记录.摘要%Type;

  n_记录数 Number := 0;
  n_小数   Number;
  v_Error  Varchar2(2000);
  Err_Custom Exception;
Begin
  --获取金额小数位数
  Select Nvl(精度, 2) Into n_小数 From 药品卫材精度 Where 类别 = 2 And 内容 = 4 And 单位 = 5;

  --单据信息
  Select To_Number(Extractvalue(Value(A), 'IN/REQSTORE')), To_Number(Extractvalue(Value(A), 'IN/OUTSTORE')),
         Extractvalue(Value(A), 'IN/REQPEOPLE'), To_Date(Extractvalue(Value(A), 'IN/REQDATE'), 'yyyy-mm-dd hh24:mi:ss'),
         Extractvalue(Value(A), 'IN/SUMMARY')
  Into n_库房id, n_对方库房id, v_填制人, d_填制日期, v_摘要
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --产生NO号
  v_No := Nextno(26, n_对方库房id);

  --分解单据明细，同时产生申领数据
  For r_Bill In (Select Extractvalue(b.Column_Value, '/BILL/DRUGID') As 药品id,
                        To_Number(Extractvalue(b.Column_Value, '/BILL/AMOUNT')) As 数量
                 From Table(Xmlsequence(Extract(Xml_In, '/IN/BILLLIST/BILL'))) B) Loop
  
    --查找是否存在药品id
    Begin
      Select ID Into n_药品id From 收费项目目录 Where 类别 In ('5', '6', '7') And ID = r_Bill.药品id;
    Exception
      When Others Then
        --没找到药品id时抛出异常
        v_Error := '没有找到ID为[' || r_Bill.药品id || ']的药品，请核对药品ID !';
        Raise Err_Custom;
    End;
  
    --取价格，计算金额
    n_成本价   := Zl_Fun_Getoutcost(n_药品id, 0, n_库房id);
    n_零售价   := Zl_Fun_Getoutprice(n_药品id, 0, n_库房id);
    n_成本金额 := Round(n_成本价 * r_Bill.数量, n_小数);
    n_零售金额 := Round(n_零售价 * r_Bill.数量, n_小数);
    n_差价     := Round(n_零售金额 - n_成本金额, n_小数);
  
    --记录当前为第几条明细记录
    n_记录数 := n_记录数 + 1;
    --产生序号
    n_序号 := n_记录数 * 2 - 1;
  
    --产生申领数据
    Zl_药品申领_Insert(v_No, n_序号, n_对方库房id, n_库房id, n_药品id, 0, r_Bill.数量, r_Bill.数量, n_成本价, n_成本金额, n_零售价, n_零售金额, n_差价,
                   v_填制人, Null, Null, Null, v_摘要, d_填制日期, Null, Null, 0, Null, Null, Null, Null);
  
  End Loop;

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT><NO>' || v_No || '</NO></OUTPUT>');
Exception
  When Err_Custom Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Drugrequest_Fill;
/
Create Or Replace Procedure Zl_Third_Drugrequest_Delete
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：删除药品申领单
  --入参：xml_in
  --<IN>
  -- <REQNO>S0002132</REQNO>   --申请单据NO
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  v_No    药品收发记录.No%Type;
  n_Exist Number(1);
  v_Error Varchar2(2000);
  Err_Custom Exception;
Begin
  --读取单据号
  Select Extractvalue(Value(A), 'IN/REQNO') Into v_No From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --判断该单据是否被删除
  Begin
    Select 1 Into n_Exist From 药品收发记录 Where NO = v_No And 单据 = 6 And Rownum < 2;
  Exception
    When Others Then
      v_Error := '申领单【' || v_No || '】不存在或被他人删除！';
      Raise Err_Custom;
  End;
  --判断该单据是否被审核
  Begin
    Select 1
    Into n_Exist
    From 药品收发记录
    Where NO = v_No And 单据 = 6 And 记录状态 = 1 And 审核人 Is Null And Rownum < 2;
  Exception
    When Others Then
      v_Error := '申领单【' || v_No || '】已经被他人审核！';
      Raise Err_Custom;
  End;

  --删除申领单据
  Zl_药品申领_Delete(v_No);

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Custom Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Drugrequest_Delete;
/
Create Or Replace Procedure Zl_Third_Drugtransfer_Strike
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：冲销药品移库单（单据剩余的全冲）
  --入参：xml_in
  --<IN>
  --  <STRIKNO>S0002132</STRIKNO>                    --冲销单据NO
  --  <STRIKEPEOPLE>张三</STRIKEPEOPLE>              --冲销人
  --  <STRIKEDATE>2018-09-19 10:23:44</STRIKEDATE>   --冲销时间
  --  <SUMMARY>基层药房申请调拨出库冲销</SUMMARY>    --摘要
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  n_行次     Integer := 0;
  v_No       药品收发记录.No%Type;
  v_冲销人   药品收发记录.填制人%Type;
  d_冲销日期 药品收发记录.填制日期%Type;
  v_摘要     药品收发记录.摘要%Type := Null;
  n_Exist    Number(1);
  v_Error    Varchar2(2000);
  Err_Custom Exception;
Begin
  --单据信息
  Select Extractvalue(Value(A), 'IN/STRIKNO'), Extractvalue(Value(A), 'IN/STRIKEPEOPLE'),
         To_Date(Extractvalue(Value(A), 'IN/STRIKEDATE'), 'yyyy-mm-dd hh24:mi:ss'), Extractvalue(Value(A), 'IN/SUMMARY')
  Into v_No, v_冲销人, d_冲销日期, v_摘要
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --判断该单据是否存在
  Begin
    Select 1 Into n_Exist From 药品收发记录 Where NO = v_No And 单据 = 6 And Rownum < 2;
  Exception
    When Others Then
      v_Error := '申领单【' || v_No || '】不存在，请检查！';
      Raise Err_Custom;
  End;
  --判断该单据是否被审核
  Begin
    Select 1
    Into n_Exist
    From 药品收发记录
    Where NO = v_No And 单据 = 6 And 记录状态 = 1 And 审核人 Is Null And Rownum < 2;
  Exception
    When Others Then
      n_Exist := 0;
  End;
  --已经审核才能冲销
  If n_Exist = 0 Then
    --冲销申领数据
    For r_Drug In (Select 药品id, Max(记录状态) 原记录状态, 序号, Sum(实际数量) As 冲销数量
                   From 药品收发记录 X
                   Where NO = v_No And 单据 = 6 And 入出系数 = -1
                   Group By 药品id, 序号, 产地, 原产地, 批号, 效期, Nvl(批次, 0), 扣率, 成本价, 零售价, 库房id, 对方部门id, 入出类别id, Nvl(供药单位id, 0),
                            批准文号
                   Having Sum(实际数量) <> 0) Loop
      n_行次 := n_行次 + 1;
      Zl_药品移库_Strike(n_行次, r_Drug.原记录状态, v_No, r_Drug.序号, r_Drug.药品id, r_Drug.冲销数量, v_冲销人, d_冲销日期, v_摘要);
    End Loop;
  
    If n_行次 = 0 Then
      v_Error := '申领单【' || v_No || '】无可冲销药品（已被全冲）！';
      Raise Err_Custom;
    End If;
  Else
    --单据未审核
    v_Error := '申领单【' || v_No || '】未审核，不能冲销！';
    Raise Err_Custom;
  End If;

  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Custom Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Drugtransfer_Strike;
/
----------------------------------------------------------------------------
--[[16.临床医嘱]]
----------------------------------------------------------------------------
CREATE OR REPLACE Procedure Zl_Third_Adviceoperationbat
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：医嘱批量执行登记/取消批量执行登记 /写入
  --1、用于每次医嘱执行时的执行登记，”来源“用于区分是否移动端执行
  --2、对已执行的医嘱取消执行操作
  --入参：xml_in
  --<IN>
  -- <TYPE>1</TYPE>   --操作类型：1、执行登记；0、取消执行登记
  -- <TM>123456789</TM>   --条码号
  -- <YQSJ>2017-12-05 10:00:00</YQSJ>   --要求时间
  -- <CZY></CZY>   --操作员
  -- <CZSJ>2017-12-05 16:26:54</CZSJ>   --操作时间

  --以下节点取消执行时传空
  -- <ZXSM>PDA执行</ZXSM>   --执行摘要
  -- <ZXCS></ZXCS>   --执行次数
  -- <SYTD>左手背</SYTD>
  -- <JLLY>1</JLLY>    --记录来源，0-PC端登记，1-移动临床登记，移动端固定传1
  -- <ZXFS>2</ZXFS>  --执行方式，0-常规(无意义)，1-手工执行，2-扫码执行

  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  n_Type     Number;
  v_条码号   医嘱执行组合.条码%Type;
  d_要求时间 病人医嘱执行.要求时间%Type;
  d_执行时间 病人医嘱执行.执行时间%Type;
  v_执行摘要 病人医嘱执行.执行摘要%Type;
  n_本次数次 病人医嘱执行.本次数次%Type;
  v_输液通道 病人医嘱执行.输液通道%Type;
  n_记录来源 病人医嘱执行.记录来源%Type;
  v_执行人   病人医嘱执行.执行人%Type;
  n_执行方式 病人医嘱执行.执行方式%Type;
Begin
  Select Extractvalue(Value(A), 'IN/TYPE'), Extractvalue(Value(A), 'IN/TM') As 条码,
         To_Date(Extractvalue(Value(A), 'IN/YQSJ'), 'yyyy-mm-dd hh24:mi:ss') As 要求时间,
         Extractvalue(Value(A), 'IN/CZY') As 执行人,
         To_Date(Extractvalue(Value(A), 'IN/CZSJ'), 'yyyy-mm-dd hh24:mi:ss') As 执行时间,
         Extractvalue(Value(A), 'IN/ZXSM') As 执行摘要, Extractvalue(Value(A), 'IN/ZXCS') As 本次数次,
         Extractvalue(Value(A), 'IN/SYTD') As 输液通道, Extractvalue(Value(A), 'IN/JLLY') As 记录来源,
         Extractvalue(Value(A), 'IN/ZXFS') As 执行方式
  Into n_Type, v_条码号, d_要求时间, v_执行人, d_执行时间, v_执行摘要, n_本次数次, v_输液通道, n_记录来源, n_执行方式
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For r_医嘱 In (Select a.要求时间, a.医嘱id, a.发送号 From 医嘱执行组合 A Where a.条码 = v_条码号 Order By a.要求时间) Loop

    If n_Type = 1 Then
      Zl_病人医嘱执行_Insert(r_医嘱.医嘱id, r_医嘱.发送号, d_要求时间, n_本次数次, v_执行摘要, v_执行人, d_执行时间, 0, 0, 1, Null, Null, Null, 0, 0, 0,
                       v_输液通道, n_记录来源, n_执行方式);
    Else
      Zl_病人医嘱执行_Delete(r_医嘱.医嘱id, r_医嘱.发送号, d_执行时间, 0, 0, 0);
    End If;
  End Loop;
  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Adviceoperationbat;
/

Create Or Replace Procedure Zl_Third_Advicegetbat
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --功能：获取条码对应医嘱的信息
  --入参：Xml_In
  --<IN>
  --     <TM>12345678</TM>      --条码号
  --</IN>

  --出参：Xml_Out
  --<OUTPUT>
  --      <PATIID>52917</PATIID>  --病人ID
  --      <PAGEID></PAGEID> --主页ID
  --      <BABY>0</BABY>    --婴儿
  --      <YZLIST> --医嘱列表
  --        <YZ>  
  --             <ZLLB>E</ZLLB>                  --诊疗类别
  --             <ZT>休息！！！！</ZT>           --嘱托
  --             <YZID>1181512</YZID>            --医嘱ID
  --             <FSH>204361</FSH>               --发送号
  --             <YZQX>0</YZQX>                  --医嘱期效
  --             <YF>口服</YF>                   --用法
  --             <PC>QID</PC>                    --频次
  --             <KSZXSJ>2019-01-08 15:31:00</KSZXSJ> --开始执行时间
  --             <KZYS>代翔</KZYS>                    --开嘱医生
  --             <KZSJ>2019-01-08 15:30:00</KZSJ>     --开嘱时间
  --             <BZ>24</BZ>                          --20给药途径(其它);21给药途径(输液);22给药途径(注射);24给药途径(口服);1过敏试验;4中药用(服)法;6采集方法
  --             <SJ>2019-01-24 15:00:00</SJ>         --要求时间
  --             <ITEMLIST>                           --药品列表
  --               <ITEM> 
  --                  <MC>0.9％氯化钠注射液 500ml/瓶(外用)</MC>  --药品名称
  --                  <BM><BM/>                                  --编码
  --                  <ZL><ZL/>                                  --总量
  --                  <DL>8</DL>                                 --单量
  --                  <DW>ml</DW>                                --单位
  --                  <ZLDW>ml</ZLDW>                            --总量单位
  --                  <GW>0</GW>                                 --高危药品
  --               </ITEM> 
  --             </ITEMLIST> 
  --       </YZ> 
  --       <YZ></YZ>.....
  --     </YZLIST> 
  --</OUTPUT> 

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>

  v_条码号 医嘱执行组合.条码%Type;

  v_医生嘱托 Clob;
  v_Itemlist Clob;
  v_Yzinfo   Clob;
  v_Temp     Clob;
  v_Pati     Varchar2(1000);
  v_Bz       Varchar2(2); --20给药途径(其它);21给药途径(输液);22给药途径(注射);24给药途径(口服);1过敏试验;4中药用(服)法;6采集方法;99为其它治疗 
Begin
  Select Extractvalue(Value(A), 'IN/TM') As 条码 Into v_条码号 From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For r_医嘱 In (Select b.Id, b.相关id, b.病人id, b.主页id, b.婴儿, b.诊疗类别, b.医生嘱托, b.医嘱期效, b.医嘱内容, b.执行频次, b.开始执行时间, b.开嘱医生,
                      b.开嘱时间, a.要求时间, a.发送号, c.名称, c.编码, b.总给予量, b.单次用量, c.计算单位 As 单位, Nvl(d.住院单位, c.计算单位) As 总量单位,
                      d.高危药品, c.操作类型, c.执行分类,E.执行人
               From 医嘱执行组合 A, 病人医嘱记录 B, 诊疗项目目录 C, 药品规格 D,病人医嘱执行 E
               Where (a.医嘱id = b.Id Or b.相关id = a.医嘱id) And b.诊疗项目id = c.Id(+) And b.收费细目id = d.药品id(+) AND A.医嘱ID=E.医嘱ID(+) AND A.发送号=E.发送号(+) AND A.要求时间=E.要求时间(+) And a.条码 = v_条码号
               Order By a.要求时间, a.发送号, b.病人id, b.主页id, b.序号) Loop
    If r_医嘱.相关id Is Not Null Then
      v_Itemlist := v_Itemlist || '<ITEM>';
      v_Itemlist := v_Itemlist || '<MC>' || r_医嘱.名称 || '</MC>';
      v_Itemlist := v_Itemlist || '<BM>' || r_医嘱.编码 || '</BM>';
      v_Itemlist := v_Itemlist || '<ZL>' || r_医嘱.总给予量 || '</ZL>';
      v_Itemlist := v_Itemlist || '<DL>' || r_医嘱.单次用量 || '</DL>';
      v_Itemlist := v_Itemlist || '<DW>' || r_医嘱.单位 || '</DW>';
      v_Itemlist := v_Itemlist || '<ZLDW>' || r_医嘱.总量单位 || '</ZLDW>';
      v_Itemlist := v_Itemlist || '<GW>' || r_医嘱.高危药品 || '</GW>';
      v_Itemlist := v_Itemlist || '</ITEM>';
    
      v_医生嘱托 := v_医生嘱托 || r_医嘱.医生嘱托;
    Else
      --计算<BZ>
      v_Bz := '';
      If r_医嘱.诊疗类别 = 'E' Then
        If r_医嘱.操作类型 = '2' Then
          v_Bz := r_医嘱.操作类型 || Nvl(r_医嘱.执行分类, '0');
        Else
          If Instr('1,4,6', r_医嘱.操作类型, 1) <> 0 Then
            v_Bz := r_医嘱.操作类型;
          Else
            v_Bz := 99; --表示其它治疗 
          End If;
        End If;
      End If;
    
      v_Yzinfo := '<YZ>';
      v_Yzinfo := v_Yzinfo || '<ZLLB>' || r_医嘱.诊疗类别 || '</ZLLB>';
      v_Yzinfo := v_Yzinfo || '<ZT>' || v_医生嘱托 || '</ZT>';
      v_Yzinfo := v_Yzinfo || '<YZID>' || r_医嘱.Id || '</YZID>';
      v_Yzinfo := v_Yzinfo || '<FSH>' || r_医嘱.发送号 || '</FSH>';
      v_Yzinfo := v_Yzinfo || '<ZXR>' || r_医嘱.执行人 || '</ZXR>';
      v_Yzinfo := v_Yzinfo || '<YZQX>' || r_医嘱.医嘱期效 || '</YZQX>';
      v_Yzinfo := v_Yzinfo || '<YF>' || r_医嘱.医嘱内容 || '</YF>';
      v_Yzinfo := v_Yzinfo || '<PC>' || r_医嘱.执行频次 || '</PC>';
      v_Yzinfo := v_Yzinfo || '<KSZXSJ>' || To_Char(r_医嘱.开始执行时间, 'yyyy-mm-dd hh24:mi:ss') || '</KSZXSJ>';
      v_Yzinfo := v_Yzinfo || '<KZYS>' || r_医嘱.开嘱医生 || '</KZYS>';
      v_Yzinfo := v_Yzinfo || '<KZSJ>' || To_Char(r_医嘱.开嘱时间, 'yyyy-mm-dd hh24:mi:ss') || '</KZSJ>';
      v_Yzinfo := v_Yzinfo || '<BZ>' || v_Bz || '</BZ>';
      v_Yzinfo := v_Yzinfo || '<SJ>' || To_Char(r_医嘱.要求时间, 'yyyy-mm-dd hh24:mi:ss') || '</SJ>';
      v_Yzinfo := v_Yzinfo || '<ITEMLIST>' || v_Itemlist || '</ITEMLIST>';
      v_Yzinfo := v_Yzinfo || '</YZ>';
    
      --拼接病人信息Xml
      If v_Pati Is Null Then
        v_Pati := v_Pati || '<PATIID>' || r_医嘱.病人id || '</PATIID>';
        v_Pati := v_Pati || '<PAGEID>' || r_医嘱.主页id || '</PAGEID>';
        v_Pati := v_Pati || '<BABY>' || r_医嘱.婴儿 || '</BABY>';
      End If;
    
      --医嘱列表缓存
      v_Temp := v_Temp || v_Yzinfo;
    
      --清空当前缓存
      v_Yzinfo   := Null;
      v_Itemlist := Null;
      v_医生嘱托 := Null;
      v_Bz       := Null;
    End If;
  End Loop;

  Xml_Out := Xmltype('<OUTPUT>' || v_Pati || '<YZLIST>' || v_Temp || '</YZLIST></OUTPUT>');
Exception
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Advicegetbat;
/


CREATE OR REPLACE Procedure Zl_Third_Getpassinfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is

  --功能:获取病人基本信息、病生理情况、诊断、医嘱详情
  --入参:Xml_In:
  --  <IN>
  --      <PATI_ID></PATI_ID>     --病人ID
  --      <VISIT_ID></VISIT_ID>     --主页ID
  --  </IN>
  --出参:Xml_Out
  -- <OUTPUT>
  --  <details_xml>
  --    <patient_info>
  --      <info name="年龄数字" value="28114.45" unit="天"/>
  --     <info name="年龄周期" value="成人"/>
  --      <info name="性别" value="女"/>
  --      <info name="职业" value="运动员"/>
  --      <info name="妊娠" value="1"/>
  --      <info name="哺乳" value="1"/>
  --      <info name="肝功能不全" value="1">
  --      <info name="严重肝功能不全" value="1">
  --      <info name="肾功能不全" value="1">
  --      <info name="严重肾功能不全" value="1">
  --      <info name="诊断" value="J18.000"/> --诊断传编码，多个诊断以逗号分隔
  --    </patient_info>
  --    <medicine_info>
  --      <medicine></medicine>  --没有医嘱记录时,<medicine_info>节点下无<medicine></medicine>节点
  --    </medicine_info>
  --    </details_xml>
  --    <reasons>
  --      <reason><order_id>1,2</order_id><type>配伍禁忌<type/><describ>就是要用</describ><reason> --禁忌用药理由节点,存在多条情况
  --    </reasons>
  --    <RESULT>false</RESULT>                -- 成功 true 失败 false
  --    <ERROR><MSG></MSG></ERROR>       --MSG 返回失败详情
  -- </OUTPUT>

  n_病人id 病案主页.病人id%Type;
  n_主页id 病案主页.主页id%Type;

  n_身高   Number(10, 2); --单位:cm
  n_体重   Number(10, 2); --体重:KG
  n_每日量 Number(16, 5);
  v_诊断编码 Varchar2(1000); 
  v_诊断名称 Varchar2(1000); 
  v_Temp1       Varchar2(32767);

  v_病生理情况 Varchar2(500);
  v_疾病编码   Varchar2(500);
  v_疾病名称   Varchar2(500);
  v_范围       Varchar2(10);
  v_Temp       Varchar2(32767); --临时XML
  x_Templet    Xmltype; --模板XML
  v_Err_Msg    Varchar2(200);
  Err_Item Exception;

  Function Get年龄周期(Age_In In Number) Return Varchar2 Is
    v_年龄周期 Varchar2(100);
  Begin

    --新生儿:<=28天
    --婴儿:>28 天 ;<=365天
    --幼儿:>365 天; <= 6岁
    --儿童:>6岁;<=14岁
    --少年:>14岁 and <=18
    --成人:>18   and  <=60
    --老人:>60岁

    If Age_In <= 28 Then
      v_年龄周期 := '新生儿';
    Elsif Age_In > 28 And Age_In <= 365 Then
      v_年龄周期 := '婴儿';
    Elsif Age_In > 365 And Age_In <= (365 * 6) Then
      v_年龄周期 := '幼儿';
    Elsif Age_In > (365 * 6) And Age_In <= (365 * 14) Then
      v_年龄周期 := '儿童';
    Elsif Age_In > (365 * 14) And Age_In <= (365 * 18) Then
      v_年龄周期 := '少年';
    Elsif Age_In > (365 * 18) And Age_In <= (365 * 60) Then
      v_年龄周期 := '成人';
    Elsif Age_In > (365 * 60) Then
      v_年龄周期 := '老人';
    Else
      v_年龄周期 := '';
    End If;
    Return v_年龄周期;
  End;

  Function Get每日量
  (
    单次量_In   Number,
    间隔单位_In Varchar2,
    频率次数_In Number,
    频率间隔_In Number,
    频率_In     Varchar2
  ) Return Number Is

    v_每日量 Varchar2(50);
  Begin

    --功能:
    --1.每日量=单次量*日频次
    --2.日频次计算：
    --                   b.间隔单位=天 and 频率间隔=1，日频次=频率次数
    --                   c.间隔单位=天 and 频率间隔>1 and 频率次数=1，日频次=1
    --                   d.间隔单位=小时 and 频率间隔<=24,日频次=24/频率间隔*频率次数
    --                  e.间隔单位=小时 and 频率间隔>24 and 频率次数=1，日频次=1
    --                   f.间隔单位=周 and 频率次数=1，日频次=1
    --                 str频率=一次性  日频次=1

    If 间隔单位_In = '天' And 频率间隔_In = 1 Then
      v_每日量 := 单次量_In * 频率次数_In;
    Elsif 间隔单位_In = '天' And 频率间隔_In > 1 And 频率次数_In = 1 Then
      v_每日量 := 单次量_In * 1;
    Elsif 间隔单位_In = '小时' And 频率间隔_In <= 24 Then
      v_每日量 := 单次量_In * (24 / 频率间隔_In * 频率次数_In);
    Elsif 间隔单位_In = '小时' And 频率间隔_In > 24 And 频率次数_In = 1 Then
      v_每日量 := 单次量_In * 1;
    Elsif 间隔单位_In = '周' And 频率次数_In = 1 Then
      v_每日量 := 单次量_In * 1;
    Elsif 频率_In = '一次性' Then
      v_每日量 := 单次量_In * 1;
    End If;
    Return Round(v_每日量, 2);
  End;

  Function Get频率信息_名称
  (
    频率_In     In Varchar2,
    频率范围_In In Varchar2
  ) Return Varchar2 Is
    v_范围 Varchar2(50);
    v_编码 Varchar2(50);
  Begin
    v_范围 := 频率范围_In;
    If 频率_In = '一次性' Then
      v_范围 := '-1';
    Elsif 频率_In = '持续性' Or 频率_In = '不定时' Then
      v_范围 := '-2';
    Elsif 频率_In = '必要时' Then
      v_范围 := '-3';
    Elsif 频率_In = '需要时' Then
      v_范围 := '-5';
    End If;
    Begin
      Select 编码
      Into v_编码
      From 诊疗频率项目
      Where 名称 = 频率_In And Instr(',' || v_范围 || ',', ',' || 适用范围 || ',') > 0;
    Exception
      When Others Then
        v_编码 := '';
    End;
    Return v_编码;
  End;

Begin

  x_Templet := Xmltype('<OUTPUT><details_xml></details_xml></OUTPUT>');

  Select To_Number(Extractvalue(Value(A), 'IN/PATI_ID')), To_Number(Extractvalue(Value(A), 'IN/VISIT_ID'))
  Into n_病人id, n_主页id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If n_病人id = 0 Or n_主页id = 0 Then
    v_Err_Msg := '未传入任何条件,无法完成查询!';
    Raise Err_Item;
  End If;
  v_Temp := '<patient_info>';

  For R In (Select Nvl(b.姓名, a.姓名) 姓名, Nvl(b.性别, a.性别) 性别, Nvl(b.年龄, a.年龄) As 年龄, a.职业,
                   Decode(a.出生日期, Null, '', Round(Sysdate - a.出生日期, 2)) As 年龄数字, b.身高, b.体重
            From 病人信息 A, 病案主页 B
            Where b.病人id = a.病人id And b.病人id = n_病人id And b.主页id = n_主页id) Loop
    v_Temp := v_Temp || '<info name="提交类型" value="1"/> ';
    v_Temp := v_Temp || '<info name="年龄" value="' || r.年龄 || '"/> ';
    v_Temp := v_Temp || '<info name="年龄数字" value="' || r.年龄数字 || '" unit="天"/>';
    v_Temp := v_Temp || '<info name="年龄周期" value="' || Get年龄周期(r.年龄数字) || '"/> ';
    v_Temp := v_Temp || '<info name="性别" value="' || r.性别 || '"/> ';
    v_Temp := v_Temp || '<info name="职业" value="' || r.职业 || '"/> ';
    n_身高 := To_Number(r.身高);
    n_体重 := To_Number(r.体重);
    v_Temp := v_Temp || '<info name="身高" value="' || n_身高 || '"/> ';
    v_Temp := v_Temp || '<info name="体重" value="' || n_体重 || '"/> ';
  End Loop;

  --病生理情况
  Begin
    Select 信息值
    Into v_病生理情况
    From 病案主页从表
    Where 病人id = n_病人id And 主页id = n_主页id And 信息名 = '病生理情况';
  Exception
    When Others Then
      v_病生理情况 := Null;
  End;

  If v_病生理情况 Is Not Null Then
    v_Temp := v_Temp || '<info name="妊娠" value="' || Sign(Instr(',' || v_病生理情况 || ',', ',' || '妊娠' || ',')) || '"/>';
    v_Temp := v_Temp || '<info name="哺乳" value="' || Sign(Instr(',' || v_病生理情况 || ',', ',' || '哺乳' || ',')) || '"/>';
    v_Temp := v_Temp || '<info name="肝功能不全" value="' || Sign(Instr(',' || v_病生理情况 || ',', ',' || '肝功能不全' || ',')) ||
              '"/>';
    v_Temp := v_Temp || '<info name="严重肝功能不全" value="' || Sign(Instr(',' || v_病生理情况 || ',', ',' || '严重肝功能不全' || ',')) ||
              '"/>';
    v_Temp := v_Temp || '<info name="肾功能不全" value="' || Sign(Instr(',' || v_病生理情况 || ',', ',' || '肾功能不全' || ',')) ||
              '"/>';
    v_Temp := v_Temp || '<info name="严重肾功能不全" value="' || Sign(Instr(',' || v_病生理情况 || ',', ',' || '严重肾功能不全' || ',')) ||
              '"/>';
  End If;
  --取诊断
  For R In (Select a.诊断描述
            From 病人诊断记录 A 
            Where a.病人id = n_病人id And 主页id = n_主页id And a.取消时间 Is Null And a.记录来源 In (1, 3) And
                  Instr(',2,12,', ',' || a.诊断类型 || ',') > 0  and nvl(a.录入次序,'01')='01'
            Order By a.记录来源, a.诊断类型, a.诊断次序) Loop
    v_诊断编码 := Null; 
    v_诊断名称 := r.诊断描述; 
    v_Temp1      := r.诊断描述; 
    If Substr(v_Temp1, 1, 1) = '(' Then 
      v_诊断编码 := Substr(v_Temp1, 2, Instr(v_Temp1, ')') - 2); 
      v_诊断名称 := Substr(v_Temp1, Instr(v_Temp1, ')') + 1); 
    End If; 
    
    v_疾病名称 := v_疾病名称 || ',' || v_诊断名称;
    v_疾病编码 := v_疾病编码 || ',' || v_诊断编码;
  End Loop;

  v_Temp := v_Temp || '<info name="诊断名称" value="' || Substr(v_疾病名称, 2) || '"/>';
  v_Temp := v_Temp || '<info name="诊断" value="' || Substr(v_疾病编码, 2) || '"/>';

  --
  v_Temp := v_Temp || '</patient_info>';
  Select Appendchildxml(x_Templet, '/OUTPUT/details_xml', Xmltype(v_Temp)) Into x_Templet From Dual;

  ----药品信息
  v_Temp := '<medicine_info></medicine_info>';
  Select Appendchildxml(x_Templet, '/OUTPUT/details_xml', Xmltype(v_Temp)) Into x_Templet From Dual;
  For R In (Select a.Id As 医嘱id, Nvl(a.相关id, a.Id) As 组id, a.医嘱状态, a.开嘱时间, a.诊疗类别, a.诊疗项目id, a.收费细目id, a.执行频次, a.间隔单位,
                   a.频率次数, a.频率间隔, a.单次用量, b.计算单位 As 单量单位, g.名称 As 用法, c.诊疗项目id As 用法id, f.规格, e.本位码
            From 病人医嘱记录 A, 诊疗项目目录 B, 病人医嘱记录 C, 部门表 D, 药品规格 E, 收费项目目录 F, 诊疗项目目录 G
            Where a.诊疗项目id = b.Id And a.相关id = c.Id(+) And a.开嘱科室id = d.Id(+) And a.收费细目id = e.药品id(+) And
                  a.收费细目id = f.Id(+) And c.诊疗项目id = g.Id(+) And a.病人id = n_病人id And a.主页id = n_主页id And
                  a.诊疗类别 In ('5', '6', '7') And
                  ((a.医嘱期效 = 1 And Trunc(a.开嘱时间) = Trunc(Sysdate) And a.医嘱状态 <> 4) Or
                  (a.医嘱期效 = 0 And (a.医嘱状态 In (8, 9) And a.执行终止时间 >= Sysdate Or a.医嘱状态 In (3, 5, 7))))
            Order By a.序号) Loop
    v_Temp := '<medicine>';
    v_Temp := v_Temp || '<info name="医嘱ID" value="' || r.医嘱id || '"/>';
    v_Temp := v_Temp || '<info name="本位码" value="' || r.本位码 || '" main="46d64420-8319-4768-9a11-f4b0f5e4ce7a"/>';
    v_Temp := v_Temp || '<info name="诊疗项目ID" value="' || r.诊疗项目id || '" main="4e19df1c-c1b9-4a43-a83d-0741a19961ab"/>';
    v_Temp := v_Temp || '<info name="输液组号" value="' || r.组id || '"/>';
    v_Temp := v_Temp || '<info name="计量单位" value="' || r.单量单位 || '"/>';
    v_Temp := v_Temp || '<info name="单次量" value="' || r.单次用量 || '"/>';
    If n_体重 > 0 Then
      v_Temp := v_Temp || '<info name="单次量-按体重" value="' || To_Char(To_Number(r.单次用量) / n_体重, 'FM9999990.09') || '"/>';
    Else
      v_Temp := v_Temp || '<info name="单次量-按体重" value=""/>';
    End If;
    If n_体重 > 0 And n_身高 > 0 Then
      v_Temp := v_Temp || '<info name="单次量-按体表" value="' ||
                To_Char(To_Number(r.单次用量) / (0.0061 * n_身高 + 0.0128 * n_体重 - 0.1529), 'FM9999990.09') || '"/>';
    Else
      v_Temp := v_Temp || '<info name="单次量-按体表" value=""/>';
    End If;
    n_每日量 := Get每日量(r.单次用量, r.间隔单位, r.频率次数, r.频率间隔, r.执行频次);
    v_Temp   := v_Temp || '<info name="每日量" value="' || n_每日量 || '"/>';
    If n_体重 > 0 Then
      v_Temp := v_Temp || '<info name="每日量-按体重" value="' || To_Char(n_每日量 / n_体重, 'FM9999990.09') || '"/>';
    Else
      v_Temp := v_Temp || '<info name="每日量-按体重" value=""/>';

    End If;
    If n_体重 > 0 And n_身高 > 0 Then
      v_Temp := v_Temp || '<info name="每日量-按体表" value="' ||
                To_Char(n_每日量 / (0.0061 * n_身高 + 0.0128 * n_体重 - 0.1529), 'FM9999990.09') || '"/>';
    Else
      v_Temp := v_Temp || '<info name="每日量-按体表" value=""/>';
    End If;
    If Instr('7', r.诊疗类别) > 0 Then
      v_范围 := '2';
    Else
      v_范围 := '1';
    End If;
    v_Temp := v_Temp || '<info name="给药频次" value="' || Get频率信息_名称(r.执行频次, v_范围) || '"/>';
    v_Temp := v_Temp || '<info name="给药频次名称" value="' || r.执行频次 || '"/>';
    v_Temp := v_Temp || '<info name="给药途径" value="' || r.用法id || '"/>';
    v_Temp := v_Temp || '</medicine>';

    Select Appendchildxml(x_Templet, '/OUTPUT/details_xml/medicine_info', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  --药嘱禁忌说明
  v_Temp := '<reasons></reasons>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  For R In (Select Decode(b.医嘱b, Null, b.医嘱a || '', b.医嘱a || ',' || b.医嘱b) As 医嘱ids, b.禁忌类型, b.用药说明
            From 药嘱禁忌说明 B, 病人医嘱记录 A
            Where b.医嘱a = a.Id And a.病人id = n_病人id And a.主页id = n_主页id And a.诊疗类别 In ('5', '6', '7') And
                  ((a.医嘱期效 = 1 And Trunc(a.开嘱时间) = Trunc(Sysdate) And a.医嘱状态 <> 4) Or
                  (a.医嘱期效 = 0 And (a.医嘱状态 In (8, 9) And a.执行终止时间 >= Sysdate Or a.医嘱状态 In (3, 5, 7))))) Loop
    v_Temp := '<reason>';
    v_Temp := v_Temp || '<order_id>' || r.医嘱ids || '</order_id>';
    v_Temp := v_Temp || '<type>' || r.禁忌类型 || '</type>';
    v_Temp := v_Temp || '<describ>' || r.用药说明 || '</describ>';
    v_Temp := v_Temp || '</reason>';
    Select Appendchildxml(x_Templet, '/OUTPUT/reasons', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<RESULT>true</RESULT>')) Into x_Templet From Dual;
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<ERROR><MSG></MSG></ERROR>')) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
End Zl_Third_Getpassinfo;
/

Create Or Replace Procedure Zl_Third_AdviceApply
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:临嘱根据医嘱id获取申请信息
  --入参:Xml_In: 
  --  <IN> 
  --      <YZID></YZID>     --医嘱id
  --  </IN>  
  --出参:Xml_Out 
  -- <OUTPUT>
  --   <APPLYINFO>
  --     <BRLY></BRLY>       --病人来源
  --     <BRID></BRID>       --病人ID
  --     <ZYID></ZYID>       --主页ID
  --     <XM></XM>           --姓名
  --     <XB></XB>           --性别
  --     <NL></NL>           --年龄
  --     <YZID></YZID>       --医嘱ID
  --     <FSH></FSH>         --发送号
  --     <BRKS></BRKS>       --病人科室
  --     <KZSJ></KZSJ>       --开嘱时间 
  --     <KZYS></KZYS>       --开嘱医生 
  --     <MZH></MZH>         --门诊号
  --     <SFZH></SFZH>       --身份证号
  --     <ZY></ZY>           --职业
  --     <MZ></MZ>           --民族
  --     <GJ></GJ>           --国籍
  --     <HY></HY>           --婚姻状况
  --     <JTDZ></JTDZ>       --家庭地址
  --     <DH></DH>           --电话| decode(d.家庭电话,'',decode(d.手机号,'',d.联系人电话,d.手机号),d.家庭电话) 
  --     <ZLXMID></ZLXMID>   --诊疗项目id
  --     <ZLXMMC></ZLXMMC>   --诊疗项目名称
  --   </APPLYINFO>
  -- </OUTPUT>
  -------------------------------------------------------------------------------------------------- 

  n_医嘱id Number(18);

  v_Temp    Varchar2(32767); --临时XML 
  x_Templet Xmltype; --模板XML 

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/YZID')) Into n_医嘱id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  If Nvl(n_医嘱id, 0) = 0 Then
    v_Err_Msg := '未传入有效的医嘱ID,无法完成查询!';
    Raise Err_Item;
  End If;
  
  For r_申请信息 In (Select b.病人来源, b.病人id, b.主页id, b.姓名, b.性别, b.年龄, a.医嘱id, a.发送号 As NO, c.名称 As 病人科室, b.开嘱时间, b.开嘱医生,
                        d.门诊号, d.身份证号, d.职业, d.民族, d.国籍, d.婚姻状况, d.家庭地址,
                        Decode(d.家庭电话, '', Decode(d.手机号, '', d.联系人电话, d.手机号), d.家庭电话) As 电话, b.诊疗项目id, e.名称 As 诊疗项目
                 From 病人医嘱发送 A, 病人医嘱记录 B, 部门表 C, 病人信息 D, 诊疗项目目录 E
                 Where a.医嘱id = b.Id And b.病人科室id = c.Id And b.病人id = d.病人id And b.诊疗项目id = e.Id And a.医嘱id = n_医嘱id) Loop
    v_Temp := '<APPLYINFO>';
    v_Temp := v_Temp || '<BRLY>' || r_申请信息.病人来源 || '</BRLY>';
    v_Temp := v_Temp || '<BRID>' || r_申请信息.病人id || '</BRID>';
    v_Temp := v_Temp || '<ZYID>' || r_申请信息.主页id || '</ZYID>';
    v_Temp := v_Temp || '<XM>' || r_申请信息.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || r_申请信息.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || r_申请信息.年龄 || '</NL>';
    v_Temp := v_Temp || '<YZID>' || r_申请信息.医嘱id || '</YZID>';
    v_Temp := v_Temp || '<FSH>' || r_申请信息.No || '</FSH>';
    v_Temp := v_Temp || '<BRKS>' || r_申请信息.病人科室 || '</BRKS>';
    v_Temp := v_Temp || '<KZSJ>' || To_Char(r_申请信息.开嘱时间, 'yyyy-mm-dd hh24:mi:ss') || '</KZSJ>';
    v_Temp := v_Temp || '<KZYS>' || r_申请信息.开嘱医生 || '</KZYS>';
    v_Temp := v_Temp || '<MZH>' || r_申请信息.门诊号 || '</MZH>';
    v_Temp := v_Temp || '<SFZH>' || r_申请信息.身份证号 || '</SFZH>';
    v_Temp := v_Temp || '<ZY>' || r_申请信息.职业 || '</ZY>';
    v_Temp := v_Temp || '<MZ>' || r_申请信息.民族 || '</MZ>';
    v_Temp := v_Temp || '<GJ>' || r_申请信息.国籍 || '</GJ>';
    v_Temp := v_Temp || '<HY>' || r_申请信息.婚姻状况 || '</HY>';
    v_Temp := v_Temp || '<JTDZ>' || r_申请信息.家庭地址 || '</JTDZ>';
    v_Temp := v_Temp || '<DH>' || r_申请信息.电话 || '</DH>';
    v_Temp := v_Temp || '<ZLXMID>' || r_申请信息.诊疗项目id || '</ZLXMID>';
    v_Temp := v_Temp || '<ZLXMMC>' || r_申请信息.诊疗项目 || '</ZLXMMC>';
    v_Temp := v_Temp || '</APPLYINFO>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_AdviceApply;
/
Create Or Replace Procedure Zl_Third_Advicechkfee
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:检查临嘱是否存在未收费记录
  --入参:Xml_In:
  --  <IN>
  --      <YZID></YZID>     --医嘱id
  --  </IN>
  --出参:Xml_Out
  -- <OUTPUT>
  --      <SFBS></BRID>       --收费标识|1：已收费2：未收费3：已退费
  --      <JCXM></JCXM>       --检查项目
  -- </OUTPUT>
  --------------------------------------------------------------------------------------------------

  n_医嘱id   Number(18);
  n_病人来源 Number(5);
  n_记录性质 Number(5);
  n_门诊记帐 Number(5);
  v_诊疗类别 Varchar2(10);
  v_医嘱内容 Varchar2(1000);
  v_No       Varchar2(20);
  n_发送号   Number(18);
  n_Out      Number(5); --|1：已收费2：未收费

  v_Temp Varchar2(32767); --临时XML

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/YZID')) Into n_医嘱id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_医嘱id, 0) = 0 Then
    v_Err_Msg := '未传入有效的医嘱ID,无法完成查询!';
    Raise Err_Item;
  End If;

  --查询医嘱发送信息
  Select Distinct a.病人来源, a.医嘱内容, b.记录性质, b.门诊记帐, b.No, b.发送号, a.诊疗类别
  Into n_病人来源, v_医嘱内容, n_记录性质, n_门诊记帐, v_No, n_发送号, v_诊疗类别
  From 病人医嘱记录 A, 病人医嘱发送 B
  Where a.Id = b.医嘱id And a.Id = n_医嘱id And a.医嘱状态 = 8;

  If v_No Is Null Or Nvl(n_发送号, 0) = 0 Then
    v_Err_Msg := '未查找到医嘱信息,请检查传入条件!';
    Raise Err_Item;
  End If;

  n_Out := 1;
  If Nvl(n_病人来源, 0) = 2 And Nvl(n_记录性质, 0) = 2 And Nvl(n_门诊记帐, 0) = 0 Then
    --住院费用
    For r_住院费用 In (Select a.记录状态, Nvl(b.相关id, b.Id) As 医嘱id, b.诊疗类别, a.执行状态, Nvl(a.结帐id, 0) As 结帐id, a.No, 0 As 费用状态
                   From 住院费用记录 A, 病人医嘱记录 B
                   Where a.No = v_No And a.记录状态 In (0, 1, 3) And a.医嘱序号 + 0 = b.Id And Mod(a.记录性质, 10) = n_记录性质
                   Union All
                   Select b.记录状态, Nvl(c.相关id, c.Id) As 医嘱id, c.诊疗类别, b.执行状态, Nvl(b.结帐id, 0) As 结帐id, a.No, 0 As 费用状态
                   From 病人医嘱记录 C, 住院费用记录 B, 病人医嘱附费 A
                   Where a.No = b.No And a.记录性质 = Mod(b.记录性质, 10) And a.医嘱id = b.医嘱序号 + 0 And
                         a.医嘱id In (Select ID
                                    From 病人医嘱记录
                                    Where (ID = n_医嘱id Or 相关id = n_医嘱id) And 诊疗类别 = v_诊疗类别) And a.发送号 = n_发送号 And
                         b.记录状态 In (0, 1, 3) And a.医嘱id = c.Id And a.记录性质 = n_记录性质) Loop
    
      If r_住院费用.医嘱id = n_医嘱id And r_住院费用.诊疗类别 = v_诊疗类别 And r_住院费用.费用状态 = 1 And r_住院费用.结帐id <> 0 Then
        n_Out := 2;
        Exit;
      Elsif r_住院费用.医嘱id = n_医嘱id And r_住院费用.诊疗类别 = v_诊疗类别 And r_住院费用.记录状态 = 0 Then
        n_Out := 2;
        Exit;
      End If;
    End Loop;
  
    --当医嘱已收费时判断是否有销账记录
    If n_Out = 1 Then
      For r_住院销账 In (Select Nvl(Max(c.已销数), 0) 最大已销数
                     From (Select -1 * Sum(Nvl(a.付数, 1) * a.数次 / b.数量) As 已销数
                            From 住院费用记录 A, 病人医嘱计价 B
                            Where a.医嘱序号 In
                                  (Select ID
                                   From 病人医嘱记录
                                   Where (ID = n_医嘱id Or 相关id = n_医嘱id) And a.No = v_No And 诊疗类别 = v_诊疗类别) And
                                  b.医嘱id = a.医嘱序号 And b.收费细目id = a.收费细目id And Nvl(b.费用性质, 0) = 0 And
                                  (a.记录状态 = 2 And a.记录性质 In (1, 2) Or a.记录性质 = 11) And a.价格父号 Is Null And
                                  a.收费类别 Not In ('5', '6', '7') And Not Exists
                             (Select 1 From 材料特性 Where 材料id = a.收费细目id And 跟踪在用 = 1)
                            Group By a.医嘱序号, a.收费细目id) C) Loop
        If r_住院销账.最大已销数 > 0 Then
          n_Out := 3;
          Exit;
        End If;
        Exit;
      End Loop;
    End If;
  Else
    --门诊费用
    For r_门诊费用 In (Select a.记录状态, Nvl(b.相关id, b.Id) As 医嘱id, b.诊疗类别, a.执行状态, Nvl(a.结帐id, 0) As 结帐id, a.No,
                          Nvl(a.费用状态, 0) As 费用状态
                   From 门诊费用记录 A, 病人医嘱记录 B
                   Where a.No = v_No And a.记录状态 In (0, 1, 3) And a.医嘱序号 + 0 = b.Id And Mod(a.记录性质, 10) = n_记录性质
                   Union All
                   Select b.记录状态, Nvl(c.相关id, c.Id) As 医嘱id, c.诊疗类别, b.执行状态, Nvl(b.结帐id, 0) As 结帐id, a.No,
                          Nvl(b.费用状态, 0) As 费用状态
                   From 病人医嘱记录 C, 门诊费用记录 B, 病人医嘱附费 A
                   Where a.No = b.No And a.记录性质 = Mod(b.记录性质, 10) And a.医嘱id = b.医嘱序号 + 0 And
                         a.医嘱id In (Select ID
                                    From 病人医嘱记录
                                    Where (ID = n_医嘱id Or 相关id = n_医嘱id) And 诊疗类别 = v_诊疗类别) And a.发送号 = n_发送号 And
                         b.记录状态 In (0, 1, 3) And a.医嘱id = c.Id And a.记录性质 = n_记录性质) Loop
      If r_门诊费用.医嘱id = n_医嘱id And r_门诊费用.诊疗类别 = v_诊疗类别 And r_门诊费用.费用状态 = 1 And r_门诊费用.结帐id <> 0 Then
        n_Out := 2;
        Exit;
      Elsif r_门诊费用.医嘱id = n_医嘱id And r_门诊费用.诊疗类别 = v_诊疗类别 And r_门诊费用.记录状态 = 0 Then
        n_Out := 2;
        Exit;
      End If;
    End Loop;
  
    --当医嘱已收费时判断是否有销账记录
    If n_Out = 1 Then
      For r_门诊销账 In (Select Nvl(Max(c.已销数), 0) 最大已销数
                     From (Select -1 * Sum(Nvl(a.付数, 1) * a.数次 / b.数量) As 已销数
                            From 门诊费用记录 A, 病人医嘱计价 B
                            Where a.医嘱序号 In
                                  (Select ID
                                   From 病人医嘱记录
                                   Where (ID = n_医嘱id Or 相关id = n_医嘱id) And a.No = v_No And 诊疗类别 = v_诊疗类别) And
                                  b.医嘱id = a.医嘱序号 And b.收费细目id = a.收费细目id And Nvl(b.费用性质, 0) = 0 And
                                  (a.记录状态 = 2 And a.记录性质 In (1, 2) Or a.记录性质 = 11) And a.价格父号 Is Null And
                                  a.收费类别 Not In ('5', '6', '7') And Not Exists
                             (Select 1 From 材料特性 Where 材料id = a.收费细目id And 跟踪在用 = 1)
                            Group By a.医嘱序号, a.收费细目id) C) Loop
        If r_门诊销账.最大已销数 > 0 Then
          n_Out := 3;
          Exit;
        End If;
      End Loop;
    End If;
  
  End If;

  v_Temp  := '<OUTPUT><SFBS>' || n_Out || '</SFBS>';
  v_Temp  := v_Temp || '<JCXM>' || v_医嘱内容 || '</JCXM></OUTPUT>';
  Xml_Out := Xmltype(v_Temp);
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Advicechkfee;
/

Create Or Replace Procedure Zl_Third_Advicedelrpt
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:取消审核报告时his删除数据
  --入参:Xml_In:
  --  <IN>
  --      <BGID></BGID>     --报告id
  --      <YZID></YZID>     --医嘱ID
  --      <LYID></LYID>     --来源ID

  --  </IN>
  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_报告id Number(18);
  n_医嘱id Number(18);
  v_来源id Varchar2(200);

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/BGID')), To_Number(Extractvalue(Value(A), 'IN/YZID')),
         Extractvalue(Value(A), 'IN/LYID')
  Into n_报告id, n_医嘱id, v_来源id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If n_医嘱id Is Null Then
    Select Max(a.Id) Into n_医嘱id From 病人医嘱记录 A, 病人医嘱报告 B Where a.Id = b.医嘱id And 报告id = n_报告id;
    If Nvl(n_报告id, 0) = 0 Or Nvl(n_医嘱id, 0) = 0 Then
      v_Err_Msg := '未传入正确的执行条件,请检查传入条件!';
      Raise Err_Item;
    End If;
    Delete 医嘱报告内容 Where ID = n_报告id;
    Delete 病人医嘱报告 Where 报告id = n_报告id And 医嘱id = n_医嘱id;
    Delete 电子病历记录 Where ID In (Select 病历id From 病人医嘱报告 Where 医嘱id = n_医嘱id);
  Else
    Delete 医嘱报告内容
    Where ID In (Select Distinct a.Id
                 From 医嘱报告内容 A, 病人医嘱报告 B
                 Where a.Id = b.报告id And a.来源id = v_来源id And b.医嘱id = n_医嘱id);
    Delete 病人医嘱报告
    Where 报告id In (Select Distinct a.Id
                   From 医嘱报告内容 A, 病人医嘱报告 B
                   Where a.Id = b.报告id And a.来源id = v_来源id And b.医嘱id = n_医嘱id);
    Delete 电子病历记录 Where ID In (Select 病历id From 病人医嘱报告 Where 医嘱id = n_医嘱id);
  End If;
  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Advicedelrpt;
/
CREATE OR REPLACE Procedure Zl_Third_Adviceexcute
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:修改临嘱的医嘱执行状态和状态说明
  --入参:Xml_In:
  --  <IN>
  --      <YZID></YZID>     --医嘱id
  --      <ZTSM></ZTSM>     --状态说明
  --      <FSH></FSH>       --发送号
  --      <ZXZT></ZXZT>     --执行状态|0-未执行;1-完全执行;2-拒绝执行;3-正在执行
  --      <CZYXM></CZYXM> 操作员姓名
  --      <CZYBH></CZYBH> 操作员编号
  --  </IN>
  --出参：Xml_Out
  --<OUTPUT>
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_医嘱id     Number(18);
  v_状态说明   Varchar2(1000);
  n_发送号     Number(18);
  n_执行状态   Number(10);
  n_当前状态   Number(10);
  v_操作员编号 人员表.编号%Type;
  v_操作员姓名 人员表.姓名%Type;

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/YZID')), Extractvalue(Value(A), 'IN/ZTSM'),
         To_Number(Extractvalue(Value(A), 'IN/FSH')), To_Number(Extractvalue(Value(A), 'IN/ZXZT')),
         To_Char(Extractvalue(Value(A), 'IN/CZYBH')), To_Char(Extractvalue(Value(A), 'IN/CZYXM'))
  Into n_医嘱id, v_状态说明, n_发送号, n_执行状态, v_操作员编号, v_操作员姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_发送号, 0) = 0 Then
    Select Max(发送号) Into n_发送号 From 病人医嘱发送 Where 医嘱id = n_医嘱id;
  End If;

  If Nvl(n_医嘱id, 0) = 0 Or Nvl(n_发送号, 0) = 0 Then
    v_Err_Msg := '未传入完整的执行条件,无法完成修改医嘱的执行状态和状态说明!';
    Raise Err_Item;
  End If;

  Select 执行状态 Into n_当前状态 From 病人医嘱发送 Where 医嘱id = n_医嘱id And 发送号 = n_发送号;

  If n_当前状态 <> Nvl(n_执行状态, 0) Then
    If Nvl(n_执行状态, 0) = 0 Then
      --处理未执行
      If n_当前状态 = 1 Then
        Zl_病人医嘱执行_Cancel(n_医嘱id, n_发送号, Null, 0, 0, v_操作员编号, v_操作员姓名);
      End If;
      Update 病人医嘱发送 Set 执行状态 = 0 Where 医嘱id = n_医嘱id And 发送号 = n_发送号;
    Elsif Nvl(n_执行状态, 0) = 1 Then
      --处理已执行
      If n_当前状态 = 2 Then
        --当医嘱当前状态为拒绝执行时,则先取消执行在进行
         Zl_病人医嘱执行_Cancel(n_医嘱id, n_发送号, Null, 0, 0, v_操作员编号, v_操作员姓名);
      End If;
      Zl_病人医嘱执行_Finish(n_医嘱id, n_发送号,null,0, v_操作员编号, v_操作员姓名);
    Elsif Nvl(n_执行状态, 0) = 2 Then
      --处理拒绝执行
      If n_当前状态 = 1 Then
        --当医嘱当前状态为已执行时,则先取消执行在进行拒绝执行
         Zl_病人医嘱执行_Cancel(n_医嘱id, n_发送号, Null, 0, 0, v_操作员编号, v_操作员姓名);
      End If;
      Zl_病人医嘱执行_拒绝执行(n_医嘱id, n_发送号, v_操作员编号, v_操作员姓名);
    Elsif Nvl(n_执行状态, 0) = 3 Then
      If n_当前状态 = 1 Or n_当前状态 = 2 Then
        --当医嘱当前状态为已执行或者拒绝执行时,则先取消执行
         Zl_病人医嘱执行_Cancel(n_医嘱id, n_发送号, Null, 0, 0, v_操作员编号, v_操作员姓名);
      End If;
      Update 病人医嘱发送 Set 执行状态 = 3 Where 医嘱id = n_医嘱id And 发送号 = n_发送号;
    End If;
  End If;
  Update 病人医嘱发送 Set 状态说明 = v_状态说明 Where 医嘱id = n_医嘱id And 发送号 = n_发送号;
  Xml_Out := Xmltype('<OUTPUT><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Adviceexcute;
/

CREATE OR REPLACE Procedure Zl_Third_Advicenewrpt
(
  Xml_In  In Xmltype,
  File_In In Blob,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:审核报告时his插入数据（医嘱报告内容、病人医嘱报告）
  --入参:Xml_In:
  --  <IN>
  --      <YZID></YZID>     --医嘱id
  --      <LYID></LYID>     --来源ID
  --      <LX></LX>         --类型
  --      <BGM></BGM>       --报告名
  --      <SM></SM>         --说明
  --      <CJR></CJR>       --创建人

  --  </IN>
  --出参：Xml_Out
  --<OUTPUT>
  --   <BGID></BGID>        --报告id
  --   <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --   <RESULT>false</RESULT>
  --   <ERROR>
  --     <MSG>详细错误提示</MSG>
  --   </ERROR>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  n_Id       Number(18);
  n_医嘱id   Number(18);
  n_类型     Number(10);
  v_报告名   Varchar2(100);
  v_说明     Varchar2(100);
  v_创建人   Varchar2(20);
  v_人员姓名 Varchar2(20);
  b_报告内容 Blob;

  v_来源id Varchar2(36);

  n_病人id   Number(18);
  n_主页id   Number(18);
  v_挂号单   Varchar2(50);
  v_医嘱内容 Varchar2(4000);
  n_科室id   Number(18);

  n_就诊id   Number(18);
  n_场合     Number(3);
  n_病区id   Number(18);
  v_提醒场合 Varchar2(10);
  v_提醒部门 Varchar2(100);

  v_病人姓名 Varchar2(4000);

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  Select To_Number(Extractvalue(Value(A), 'IN/YZID')), To_Number(Extractvalue(Value(A), 'IN/LX')),
         Extractvalue(Value(A), 'IN/BGM'), Extractvalue(Value(A), 'IN/SM'), Extractvalue(Value(A), 'IN/CJR'),
         Extractvalue(Value(A), 'IN/LYID')
  Into n_医嘱id, n_类型, v_报告名, v_说明, v_创建人, v_来源id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  b_报告内容 := File_In;

  If Nvl(n_医嘱id, 0) = 0 Then
    v_Err_Msg := '未传入完整的执行条件,请检查传入条件!';
    Raise Err_Item;
  End If;

  If v_创建人 Is Null Then
    v_人员姓名 := User;
  Else
    v_人员姓名 := v_创建人;
  End If;

  --原报告记录的报告状态变成"1-失效"
  Update 医嘱报告内容
  Set 报告状态 = 1
  Where ID In (Select Distinct a.Id
               From 医嘱报告内容 A, 病人医嘱报告 B
               Where a.Id = b.报告id And a.来源id = v_来源id And b.医嘱id = n_医嘱id);

  Select 医嘱报告内容_Id.Nextval Into n_Id From Dual;

  Insert Into 医嘱报告内容
    (ID, 类型, 报告名, 报告说明, 内容, 创建人, 创建时间, 报告状态, 来源id)
  Values
    (n_Id, n_类型, v_报告名, v_说明, b_报告内容, v_人员姓名, Sysdate, 0, v_来源id);

  Insert Into 病人医嘱报告 (医嘱id, 报告id) Values (n_医嘱id, n_Id);

  Select Max(病人id), Max(主页id), Max(挂号单), Max(医嘱内容), Max(姓名)
  Into n_病人id, n_主页id, v_挂号单, v_医嘱内容, v_病人姓名
  From 病人医嘱记录
  Where ID = n_医嘱id;

  If n_主页id Is Not Null Then
    Select Max(出院科室id), Max(当前病区id)
    Into n_科室id, n_病区id
    From 病案主页
    Where 病人id = n_病人id And 主页id = n_主页id;
    n_就诊id   := n_主页id;
    n_场合     := 2;
    v_提醒场合 := '0100';
    If n_病区id = n_科室id Then
      v_提醒部门 := n_病区id;
    Else
      v_提醒部门 := n_科室id || ',' || n_病区id;
    End If;
  Else
    Select Max(ID), Max(执行部门id)
    Into n_就诊id, n_科室id
    From 病人挂号记录
    Where NO = v_挂号单 And 记录性质 = 1 And 记录状态 = 1;
    n_场合     := 1;
    v_提醒场合 := '1000';
    v_提醒部门 := n_科室id;
  End If;

  Zl_业务消息清单_Insert(n_病人id, n_就诊id, n_科室id, n_病区id, n_场合, v_医嘱内容 || '医嘱的报告有更新，请注意重新查阅。', v_提醒场合, 'ZLHIS_CIS_037', n_医嘱id,
                   1, 0, Sysdate, v_提醒部门);
  Xml_Out := Xmltype('<OUTPUT> <BGID>' || n_Id || '</BGID><RESULT>true</RESULT></OUTPUT>');
Exception
  When Err_Item Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || v_Err_Msg || '</MSG></ERROR></OUTPUT>');
  When Others Then
    Xml_Out := Xmltype('<OUTPUT><RESULT>false</RESULT><ERROR><MSG>' || SQLCode || '***' || SQLErrM ||
                       '</MSG></ERROR></OUTPUT>');
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Advicenewrpt;
/

CREATE OR REPLACE Procedure Zl_Hip_Getpatilistdanger
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --  获取危重病人列表
  --  <IN>              
  --    <BQID>            病区ID
  --    <KSSJ>            开始时间，yyyy-mm-dd hh24:mi:ss
  --    <JSSJ>            结束时间，yyyy-mm-dd hh24:mi:ss
  --  </IN>              
  --  <OUTPUT>              
  --    <BRLIST>            
  --      <WZLIST>          危重病人列表
  --        <BR>        
  --          <BRID>      病人ID
  --          <ZYID>      主页ID
  --          <YEXH>      婴儿序号
  --          <XM>      姓名
  --          <XB>      性别
  --          <NL>      年龄
  --          <CH>      床号
  --          <HLDJ>      护理等级
  --          <ZDLIST>      入院诊断，可能会有多个
  --            <ZD>    
  --              <XH>  诊断序号
  --              <MC>  诊断名称
  --            </ZD>   
  --          </ZDLIST>     
  --        </BR>       
  --      </WZLIST>         
  --    </BRLIST>           
  --  </OUTPUT>              

  n_病区id  病案主页.当前病区id%Type;
  d_开始    Date;
  d_结束    Date;
  v_Temp    varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML

  Function Getpatidiags
  (
    n_Patiid 病案主页.病人id%Type,
    n_Pageid 病案主页.主页id%Type
  ) Return varchar2 Is
    v_Rs varchar2(6000);
    v_t  varchar2(600);
  Begin
    For c_Diag In (Select a.诊断次序 As 诊断序号, a.诊断描述 As 诊断名称
                   From 病人诊断记录 A
                   Where a.记录来源 = 3 And a.病人id = n_Patiid And a.主页id = n_Pageid And NVL(A.编码序号,1) = 1 and nvl(a.录入次序,'01')='01'
                   Order By a.诊断次序) Loop
      v_t := '<XH>' || c_Diag.诊断序号 || '</XH>';
      v_t := v_t || '<MC>' || c_Diag.诊断名称 || '</MC>';
      If v_Rs Is Null Then
        v_Rs := '<ZD>' || v_t || '</ZD>';
      Else
        v_Rs := v_Rs || '<ZD>' || v_t || '</ZD>';
      End If;
    End Loop;
    If v_Rs Is Not Null Then
      v_Rs := '<ZDLIST jsonArray="true">' || v_Rs || '</ZDLIST>';
    End If;
    Return(v_Rs);
  End Getpatidiags;

Begin
  x_Templet := Xmltype('<OUTPUT><BRLIST><WZLIST jsonArray="true"></WZLIST></BRLIST></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/BQID'), To_Date(Extractvalue(Value(A), 'IN/KSSJ'), 'YYYY-MM-DD HH24:MI:SS'),
         To_Date(Extractvalue(Value(A), 'IN/JSSJ'), 'YYYY-MM-DD HH24:MI:SS')
  Into n_病区id, d_开始, d_结束
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For c_Pati In (Select b.病人id, b.主页id, 0 As 婴儿序号, b.姓名, b.性别, b.年龄, b.出院病床 As 床号, c.名称 As 护理等级
                 From 病人变动记录 A, 病案主页 B, 收费项目目录 C
                 Where a.病人id = b.病人id And a.主页id = b.主页id And a.病区id = n_病区id And a.护理等级id = c.Id(+) And a.开始原因 = 13 And
                       a.病情 In ('重', '危') And a.开始时间 Between d_开始 And d_结束
                 Group By b.病人id, b.主页id, b.姓名, b.性别, b.年龄, b.出院病床, c.名称) Loop
    v_Temp := '<BRID>' || c_Pati.病人id || '</BRID>';
    v_Temp := v_Temp || '<ZYID>' || c_Pati.主页id || '</ZYID>';
    v_Temp := v_Temp || '<YEXH>' || c_Pati.婴儿序号 || '</YEXH>';
    v_Temp := v_Temp || '<XM>' || c_Pati.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || c_Pati.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || c_Pati.年龄 || '</NL>';
    v_Temp := v_Temp || '<CH>' || c_Pati.床号 || '</CH>';
    v_Temp := v_Temp || '<HLDJ>' || c_Pati.床号 || '</HLDJ>';
    v_Temp := v_Temp || '<RYSJ>' || c_Pati.护理等级 || '</RYSJ>';
    v_Temp := v_Temp || Getpatidiags(c_Pati.病人id, c_Pati.主页id);
    v_Temp := '<BR>' || v_Temp || '</BR>';
    Select Appendchildxml(x_Templet, '/OUTPUT/BRLIST/WZLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Hip_Getpatilistdanger;
/

CREATE OR REPLACE Procedure Zl_Hip_Getpatilistoperation
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --  获取手术病人列表（含今日手术和明日手术）
  --  <IN>
  --    <BQID>            病区ID
  --    <KSSJ>            开始时间，yyyy-mm-dd hh24:mi:ss
  --    <JSSJ>            结束时间，yyyy-mm-dd hh24:mi:ss
  --  </IN>
  --  <OUTPUT>
  --    <BRLIST>
  --      <JRSSLIST>          今日手术病人列表，只要当天有手术的病人都要取
  --        <BR>
  --          <BRID>      病人ID
  --          <ZYID>      主页ID
  --          <YEXH>      婴儿序号
  --          <XM>      姓名
  --          <XB>      性别
  --          <NL>      年龄
  --          <CH>      床号
  --          <HLDJ>      护理等级
  --          <ZDLIST>      入院诊断，可能会有多个
  --            <ZD>
  --              <XH>  诊断序号
  --              <MC>  诊断名称
  --            </ZD>
  --          </ZDLIST>
  --          <SSLIST>      手术列表
  --            <SS>
  --              <SSSJ>   手术时间
  --              <ZSJMC>  主手术名称
  --              <FJSS> 附加手术
  --                <MC> 名称
  --              </FJSS>
  --              <MZFS>  麻醉方式
  --            </SS>
  --          </SSLIST>
  --        </BR>
  --      </JRSSLIST>
  --      <MRSSLIST>          明日手术病人列表，只要明天有手术的病人都要取
  --        <...>        同今日手术病人列表
  --      </MRSSLIST>
  --    </BRLIST>
  --  </OUTPUT>

  n_病区id  病案主页.当前病区id%Type;
  v_Tmpdate varchar2(20);
  v_Temp    varchar2(32767);
  v_Tmp2    varchar2(32767);
  x_Templet Xmltype;

  Function Getpatidiags
  (
    n_Patiid 病案主页.病人id%Type,
    n_Pageid 病案主页.主页id%Type
  ) Return varchar2 Is
    v_Rs varchar2(6000);
    v_t  varchar2(600);
  Begin
    For c_Diag In (Select a.诊断次序 As 诊断序号, a.诊断描述 As 诊断名称
                   From 病人诊断记录 A
                   Where a.记录来源 = 3 And a.病人id = n_Patiid And a.主页id = n_Pageid And NVL(A.编码序号,1) = 1 and nvl(a.录入次序,'01')='01'
                   Order By a.诊断次序) Loop
      v_t := '<XH>' || c_Diag.诊断序号 || '</XH>';
      v_t := v_t || '<MC>' || c_Diag.诊断名称 || '</MC>';
      If v_Rs Is Null Then
        v_Rs := '<ZD>' || v_t || '</ZD>';
      Else
        v_Rs := v_Rs || '<ZD>' || v_t || '</ZD>';
      End If;
    End Loop;
    If v_Rs Is Not Null Then
      v_Rs := '<ZDLIST jsonArray="true">' || v_Rs || '</ZDLIST>';
    End If;
    Return(v_Rs);
  End Getpatidiags;

  Function Getpatiopers
  (
    n_Patiid 病案主页.病人id%Type,
    n_Pageid 病案主页.主页id%Type,
    n_Day    Number
  ) Return varchar2 Is
    --n_Day 1-今天，2－明天
    v_Rs   varchar2(6000);
    n_组id 病人医嘱记录.Id%Type;
    n_Have Number;
    v_手术 varchar2(6000);
    v_All  varchar2(6000);
    v_附加 varchar2(6000);
  Begin
    For c_Pati In (Select a.标本部位 As 手术时间, a.Id, a.相关id, d.类别, d.名称
                   From 病人医嘱记录 A, 诊疗项目目录 D
                   Where a.病人id = n_Patiid And a.主页id = n_Pageid And a.诊疗类别 In ('G', 'F') And
                         a.开始执行时间 Between Sysdate - 1 And Sysdate + 1 And a.诊疗项目id = d.Id And
                         To_Date(a.标本部位, 'YYYY-MM-DD HH24:MI:SS') Between Trunc(Sysdate + n_Day - 1) And
                         Trunc(Sysdate) + n_Day - 1 / 24 / 60
                   Order By a.序号) Loop
      n_Have := 1;

      If c_Pati.相关id Is Null And v_手术 Is Not Null Then
        v_All  := v_All || '<SS>' || v_手术 || '</SS>';
        v_手术 := Null;
      End If;

      If c_Pati.相关id Is Null Then
        n_组id := c_Pati.Id;
        v_手术 := '<SSSJ>' || c_Pati.手术时间 || '</SSSJ>';
        v_手术 := v_手术 || '<ZSSMC>' || c_Pati.名称 || '</ZSSMC>';
        v_附加 := Null;
      End If;

      If c_Pati.相关id = n_组id Then
        If c_Pati.类别 = 'F' Then
          v_附加 := v_附加 || '<MC>' || c_Pati.名称 || '</MC>';
        Elsif c_Pati.类别 = 'G' Then
          If v_附加 Is Not Null Then
            v_手术 := v_手术 || '<FJSS jsonArray="true">' || v_附加 || '</FJSS>';
          End If;
          v_手术 := v_手术 || '<MZFS>' || c_Pati.名称 || '</MZFS>';
        End If;
      End If;
    End Loop;
    If n_Have = 1 Then
      v_All := v_All || '<SS>' || v_手术 || '</SS>';
      v_Rs  := '<SSLIST jsonArray="true">' || v_All || '</SSLIST>';
    End If;
    Return(v_Rs);
  End Getpatiopers;

Begin
  x_Templet := Xmltype('<OUTPUT><BRLIST><JRSSLIST jsonArray="true"></JRSSLIST><MRSSLIST jsonArray="true"></MRSSLIST></BRLIST></OUTPUT>');
  v_Tmpdate := To_Char(Sysdate, 'YYYY-MM-DD');
  Select Extractvalue(Value(A), 'IN/BQID') Into n_病区id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --出于对查询性能考虑，默认用 病人医嘱记录.开始执行时间 索引
  For c_Pati In (Select b.病人id, b.主页id, 0 As 婴儿序号, b.姓名, b.性别, b.年龄, b.出院病床 As 床号, c.名称 As 护理等级, Max(a.标本部位) As 最大手术时间,
                        Min(a.标本部位) As 最小手术时间
                 From 病人医嘱记录 A, 病案主页 B, 诊疗项目目录 C
                 Where a.病人id = b.病人id And a.主页id = b.主页id And b.护理等级id = c.Id(+) And b.当前病区id + 0 = n_病区id And
                       a.诊疗类别 = 'F' And a.开始执行时间 Between Sysdate - 1 And Sysdate + 1 And a.相关id Is Null And
                       To_Date(a.标本部位, 'YYYY-MM-DD HH24:MI:SS') Between Trunc(Sysdate) And
                       Trunc(Sysdate) + 2 - 1 / 24 / 60
                 Group By b.病人id, b.主页id, b.姓名, b.性别, b.年龄, b.出院病床, b.出院日期, c.名称) Loop
    v_Temp := '<BRID>' || c_Pati.病人id || '</BRID>';
    v_Temp := v_Temp || '<ZYID>' || c_Pati.主页id || '</ZYID>';
    v_Temp := v_Temp || '<YEXH>' || c_Pati.婴儿序号 || '</YEXH>';
    v_Temp := v_Temp || '<XM>' || c_Pati.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || c_Pati.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || c_Pati.年龄 || '</NL>';
    v_Temp := v_Temp || '<CH>' || c_Pati.床号 || '</CH>';
    v_Temp := v_Temp || '<HLDJ>' || c_Pati.护理等级 || '</HLDJ>';
    v_Temp := v_Temp || Getpatidiags(c_Pati.病人id, c_Pati.主页id);

    If Instr(c_Pati.最大手术时间, v_Tmpdate) > 0 Then
      v_Temp := v_Temp || Getpatiopers(c_Pati.病人id, c_Pati.主页id, 1);
      v_Temp := '<BR>' || v_Temp || '</BR>';
      Select Appendchildxml(x_Templet, '/OUTPUT/BRLIST/JRSSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    Else
      If Instr(c_Pati.最小手术时间, v_Tmpdate) > 0 Then
        --两天均有。
        v_Tmp2 := v_Temp || Getpatiopers(c_Pati.病人id, c_Pati.主页id, 1);
        v_Tmp2 := '<BR>' || v_Tmp2 || '</BR>';
        Select Appendchildxml(x_Templet, '/OUTPUT/BRLIST/JRSSLIST', Xmltype(v_Tmp2)) Into x_Templet From Dual;

        v_Tmp2 := v_Temp || Getpatiopers(c_Pati.病人id, c_Pati.主页id, 2);
        v_Tmp2 := '<BR>' || v_Tmp2 || '</BR>';
        Select Appendchildxml(x_Templet, '/OUTPUT/BRLIST/MRSSLIST', Xmltype(v_Tmp2)) Into x_Templet From Dual;

      Else
        v_Temp := v_Temp || Getpatiopers(c_Pati.病人id, c_Pati.主页id, 2);
        Select Appendchildxml(x_Templet, '/OUTPUT/BRLIST/MRSSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      End If;
    End If;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Hip_Getpatilistoperation;
/
CREATE OR REPLACE Procedure Zl_Hip_Getpatilistinfuse
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --  获取正在输液病人列表
  --  <IN>              
  --    <BQID>            病区ID
  --    <KSSJ>            开始时间，yyyy-mm-dd hh24:mi:ss
  --    <JSSJ>            结束时间，yyyy-mm-dd hh24:mi:ss
  --  </IN>              
  --  <OUTPUT>              
  --    <BRLIST>            
  --      <BR>          
  --        <BRID>        病人ID
  --        <ZYID>        主页ID
  --        <YEXH>        婴儿序号
  --        <XM>        姓名
  --        <XB>        性别
  --        <NL>        年龄
  --        <CH>        床号
  --      </BR>         
  --    </BRLIST>           
  --  </OUTPUT>              

  n_病区id  病案主页.当前病区id%Type;
  d_开始    Date;
  d_结束    Date;
  v_Temp    varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML
Begin
  x_Templet := Xmltype('<OUTPUT><BRLIST jsonArray="true"></BRLIST></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/BQID'), To_Date(Extractvalue(Value(A), 'IN/KSSJ'), 'YYYY-MM-DD HH24:MI:SS'),
         To_Date(Extractvalue(Value(A), 'IN/JSSJ'), 'YYYY-MM-DD HH24:MI:SS')
  Into n_病区id, d_开始, d_结束
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For c_Pati In (Select d.病人id, d.主页id, 0 As 婴儿序号, d.姓名, d.性别, d.年龄, d.出院病床 As 床号
                 From 医嘱执行时间 A, 病人医嘱记录 B, 诊疗项目目录 C, 病案主页 D
                 Where a.医嘱id = b.Id And b.诊疗项目id = c.Id And b.病人id = d.病人id And b.主页id = d.主页id And b.诊疗类别 = 'E' And
                       c.操作类型 = '2' And c.执行分类 = 1 And d.当前病区id + 0 = n_病区id And a.要求时间 Between d_开始 And d_结束

                 Group By d.病人id, d.主页id, d.姓名, d.性别, d.年龄, d.出院病床) Loop
    v_Temp := '<BRID>' || c_Pati.病人id || '</BRID>';
    v_Temp := v_Temp || '<ZYID>' || c_Pati.主页id || '</ZYID>';
    v_Temp := v_Temp || '<YEXH>' || c_Pati.婴儿序号 || '</YEXH>';
    v_Temp := v_Temp || '<XM>' || c_Pati.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || c_Pati.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || c_Pati.年龄 || '</NL>';
    v_Temp := v_Temp || '<CH>' || c_Pati.床号 || '</CH>';
    v_Temp := '<BR>' || v_Temp || '</BR>';
    Select Appendchildxml(x_Templet, '/OUTPUT/BRLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Hip_Getpatilistinfuse;
/
CREATE OR REPLACE Procedure Zl_Hip_Getpatilistouttom
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --  获取明日出院病人列表
  --  <IN>              
  --    <BQID>            病区ID
  --    <CYRQ>            出院日期，即第二天的日期,yyyy-mm-dd
  --  </IN>              
  --  <OUTPUT>              
  --    <BRLIST>            
  --      <BR>          
  --        <BRID>        病人ID
  --        <ZYID>        主页ID
  --        <YEXH>        婴儿序号
  --        <XM>        姓名
  --        <XB>        性别
  --        <NL>        年龄
  --        <CH>        床号
  --        <CYSJ>        出院时间  yyyy-mm-dd hh24:mi:ss
  --      </BR>         
  --    </BRLIST>           
  --  </OUTPUT>              

  n_病区id  病案主页.当前病区id%Type;
  d_开始    Date;
  d_结束    Date;
  v_Temp    varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML
Begin
  x_Templet := Xmltype('<OUTPUT><BRLIST jsonArray="true"></BRLIST></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/BQID'), Extractvalue(Value(A), 'IN/CYRQ')
  Into n_病区id, v_Temp
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  d_开始 := To_Date(v_Temp || ' 00:00:00', 'YYYY-MM-DD HH24:MI:SS');
  d_结束 := To_Date(v_Temp || ' 23:59:59', 'YYYY-MM-DD HH24:MI:SS');

  For c_Pati In (Select b.病人id, b.主页id, 0 As 婴儿序号, b.姓名, b.性别, b.年龄, b.出院病床 As 床号,
                        To_Char(b.出院日期, 'yyyy-mm-dd hh24:mi:ss') As 出院时间
                 From 病人变动记录 A, 病案主页 B
                 Where a.病人id = b.病人id And a.主页id = b.主页id And a.病区id = n_病区id And a.开始原因 = 10 And a.终止时间 Is Null And
                       a.开始时间 Between d_开始 And d_结束) Loop
    v_Temp := '<BRID>' || c_Pati.病人id || '</BRID>';
    v_Temp := v_Temp || '<ZYID>' || c_Pati.主页id || '</ZYID>';
    v_Temp := v_Temp || '<YEXH>' || c_Pati.婴儿序号 || '</YEXH>';
    v_Temp := v_Temp || '<XM>' || c_Pati.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || c_Pati.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || c_Pati.年龄 || '</NL>';
    v_Temp := v_Temp || '<CH>' || c_Pati.床号 || '</CH>';
    v_Temp := v_Temp || '<CYRQ>' || c_Pati.出院时间 || '</CYRQ>';
    v_Temp := '<BR>' || v_Temp || '</BR>';
    Select Appendchildxml(x_Templet, '/OUTPUT/BRLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Hip_Getpatilistouttom;
/

Create Or Replace Procedure Zl_Hip_Getunitsummary
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --获取病区概览
  --  <IN>              
  --    <BQID>            病区ID
  --    <KSSJ>            开始时间，yyyy-mm-dd hh24:mi:ss
  --    <JSSJ>            结束时间，yyyy-mm-dd hh24:mi:ss
  --    <BZWD>            发热温度标准，如超过37.4℃为发热
  --    <CXTS>            发热持续天数，如持续3天发热才确定为发热病人
  --  </IN>            
  --<OUTPUT>              
  --  <BQGK>            
  --    <YYRS>          原有人数
  --    <XYRS>          现有人数
  --    <RYRS>          入院人数
  --    <ZRRS>          转入人数
  --    <CYRS>          出院人数
  --    <ZCRS>          转出人数
  --    <SWRS>          死亡人数
  --    <SSRS>          手术人数
  --    <FMRS>          分娩人数
  --    <BWRS>          病危人数
  --    <FRRS>          发热人数
  --    <TJHL>          特级护理人数
  --    <YJHL>          一级护理人数
  --    <EJHL>          二级护理人数
  --    <SJHL>          三级护理人数
  --  </BQGK>           
  --</OUTPUT>

  n_病区id   病案主页.当前病区id%Type;
  d_开始     Date;
  d_结束     Date;
  n_Cnt      Number;
  n_发热温度 Number;
  n_发热天数 Number;
  b_Key      Boolean;
  n_特级护理 Number;
  n_I级护理  Number;
  n_Ⅱ级护理 Number;
  n_Ⅲ级护理 Number;

  v_Temp    varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML
  v_Err_Msg varchar2(200);
  Err_Item Exception;

  --发热病人判断
  Function Isfeverpatient
  (
    n_Patiid_In     病案主页.病人id%Type,
    n_Pageid_In     病案主页.主页id%Type,
    n_Patibabyid_In 病人新生儿记录.序号%Type,
    d_Endtime_In    Date,
    n_Standard_In   Number, --发热标准
    n_Feverday_In   Number --发热天数
  ) Return Boolean Is
    d_Dateper   Date;
    d_Datefirst Date;
    d_Datelast  Date;
    n_Daynum    Number;
  Begin
    For c_Temp In (Select 病人id, 主页id, 体温, 时间, 婴儿序号
                   From (Select a. 病人id, a.主页id,
                                 Decode(d.记录内容, '不升', Lead(d.记录内容, 1, 0) Over(Order By a.病人id, b.婴儿, c.发生时间), d.记录内容) As 体温,
                                 c.发生时间 As 时间, b.婴儿 As 婴儿序号
                          From 病案主页 A, 病人护理文件 B, 病人护理数据 C, 病人护理明细 D, 病历文件列表 E
                          Where a.病人id = b.病人id And b.Id = c.文件id And c.Id = d.记录id And d.项目序号 = 1 And d.记录类型 = 1 And
                                b.格式id = e.Id And e.种类 = 3 And e.保留 = -1 And a.病人id = n_Patiid_In And a.主页id = n_Pageid_In And
                                b.婴儿 = n_Patibabyid_In And c.发生时间 Between (d_Endtime_In - n_Feverday_In) And d_Endtime_In
                          Order By a.病人id, b.婴儿, c.发生时间)
                   Where Regexp_Like(体温, '(^[+-]?\d{0,}\.?\d{0,}$)') And To_Number(Nvl(体温, 0)) > n_Standard_In) Loop
      If d_Dateper Is Not Null Then
        If c_Temp.时间 - d_Dateper < 2 Then
          d_Datelast := c_Temp.时间;
        Else
          n_Daynum := d_Datelast - d_Datefirst;
          If n_Daynum > n_Feverday_In - 1 Then
            Exit;
          Else
            d_Datefirst := c_Temp.时间;
            d_Datelast  := c_Temp.时间;
          End If;
        End If;
      Else
        d_Datefirst := c_Temp.时间;
        d_Datelast  := c_Temp.时间;
      End If;
      d_Dateper := c_Temp.时间;
    End Loop;
    n_Daynum := d_Datelast - d_Datefirst;
    If n_Daynum > n_Feverday_In - 1 Then
      Return(True);
    Else
      Return(False);
    End If;
  End Isfeverpatient;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/BQID'), To_Date(Extractvalue(Value(A), 'IN/KSSJ'), 'YYYY-MM-DD HH24:MI:SS'),
         To_Date(Extractvalue(Value(A), 'IN/JSSJ'), 'YYYY-MM-DD HH24:MI:SS'),
         To_Number(Extractvalue(Value(A), 'IN/BZWD')), To_Number(Extractvalue(Value(A), 'IN/CXTS'))
  Into n_病区id, d_开始, d_结束, n_发热温度, n_发热天数
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --原有人数 
  Select Count(1)
  Into n_Cnt
  From (Select 1
         From 病人变动记录 A, 病案主页 B
         Where a.病人id = b.病人id And a.主页id = b.主页id And Nvl(b.状态, 0) <> 1 And Nvl(b.病案状态, 0) <> 5 And b.封存时间 Is Null And
               b.当前病区id = n_病区id And a.开始原因 = 1 And a.终止原因 = 2 And a.开始时间 < d_开始
         Group By a.病人id, a.主页id);
  v_Temp := '<YYRS>' || n_Cnt || '</YYRS>';

  --现有人数
  Select Count(1)
  Into n_Cnt
  From (Select 1
         From 病人变动记录 A, 病案主页 B
         Where a.病人id = b.病人id And a.主页id = b.主页id And Nvl(b.状态, 0) <> 1 And Nvl(b.病案状态, 0) <> 5 And b.封存时间 Is Null And
               b.当前病区id = n_病区id And a.开始原因 = 1 And a.终止原因 = 2 And a.开始时间 < d_结束
         Group By a.病人id, a.主页id);
  v_Temp := '<YYRS>' || n_Cnt || '</YYRS>';
  v_Temp := v_Temp || '<XYRS>' || n_Cnt || '</XYRS>';

  --入院人数
  Select Count(1)
  Into n_Cnt
  From (Select 1
         From 病人变动记录 A
         Where a.病区id + 0 = n_病区id And a.开始原因 = 1 And a.终止原因 = 2 And a.开始时间 Between d_开始 And d_结束
         Group By a.病人id, a.主页id);
  v_Temp := v_Temp || '<RYRS>' || n_Cnt || '</RYRS>';

  --转入人数，转病区
  Select Count(1)
  Into n_Cnt
  From (Select 1
         From 病人变动记录 A
         Where a.开始时间 Between d_开始 And d_结束 And a.病区id + 0 = n_病区id And a.开始原因 = 15
         Group By a.病人id, a.主页id);
  v_Temp := v_Temp || '<ZRRS>' || n_Cnt || '</ZRRS>';

  --出院人数：只有下了出院医嘱的病人才会有变动记录，以出院时间为准查询病案主页这张表
  Select Count(1)
  Into n_Cnt
  From (Select 1
         From 病案主页 A
         Where a.出院日期 Between d_开始 And d_结束 And a.当前病区id + 0 = n_病区id
         Group By a.病人id, a.主页id);
  v_Temp := v_Temp || '<CYRS>' || n_Cnt || '</CYRS>';

  --转出人数，转出病区，相同病人不重复计算
  Select Count(1)
  Into n_Cnt
  From (Select 1
         From 病人变动记录 A, 病人变动记录 B
         Where a.病人id = b.病人id And a.主页id = b.主页id And a.开始时间 = b.终止时间 And a.开始原因 = 15 And b.病区id + 0 = n_病区id And
               a.开始时间 Between d_开始 And d_结束
         Group By a.病人id, a.主页id);
  v_Temp := v_Temp || '<ZCRS>' || n_Cnt || '</ZCRS>';

  --死亡人数，只有出院病人才会标记为死亡查询病案主页这张表
  Select Count(1)
  Into n_Cnt
  From (Select 1
         From 病案主页 A
         Where a.出院日期 Between d_开始 And d_结束 And a.当前病区id + 0 = n_病区id And a.出院方式 = '死亡'
         Group By a.病人id, a.主页id);
  v_Temp := v_Temp || '<SWRS>' || n_Cnt || '</SWRS>';

  --手术人数，在院病人手术医嘱时间在指定日期泛围内的病人数
  Select Count(1)
  Into n_Cnt
  From (Select 1
         From 病案主页 A, 病人医嘱记录 B
         Where Nvl(a.状态, 0) <> 1 And Nvl(a.病案状态, 0) <> 5 And a.封存时间 Is Null And a.出院日期 Is Null And a.当前病区id = n_病区id And
               b.诊疗类别 = 'F' And To_Date(b.标本部位, 'YYYY-MM-DD HH24:MI:SS') Between d_开始 And d_结束
         Group By a.病人id, a.主页id);
  v_Temp := v_Temp || '<SSRS>' || n_Cnt || '</SSRS>';

  --分娩人数，在院病人婴儿出生时间在指定日期范围内的病人数
  Select Count(1)
  Into n_Cnt
  From (Select 1
         From 病案主页 A, 病人新生儿记录 B, 在院病人 C
         Where a.病人id = b.病人id And a.主页id = b.主页id And Nvl(a.状态, 0) <> 1 And Nvl(a.病案状态, 0) <> 5 And a.封存时间 Is Null And
               a.当前病区id = c.病区id And c.病区id = n_病区id And b.出生时间 Between d_开始 And d_结束
         Group By a.病人id, a.主页id);
  v_Temp := v_Temp || '<FMRS>' || n_Cnt || '</FMRS>';

  --病危人数，当前病区的在院病人
  Select Count(1)
  Into n_Cnt
  From 病案主页 A, 在院病人 C
  Where Nvl(a.状态, 0) <> 1 And Nvl(a.病案状态, 0) <> 5 And a.封存时间 Is Null And a.当前病区id = c.病区id And c.病区id = n_病区id And
        a.当前病况 = '危';
  v_Temp := v_Temp || '<BWRS>' || n_Cnt || '</BWRS>';

  --发热人数 
  n_Cnt := 0;
  For R In (Select a.病人id, a.主页id
            From 病案主页 A, 在院病人 C
            Where Nvl(a.状态, 0) <> 1 And Nvl(a.病案状态, 0) <> 5 And a.封存时间 Is Null And a.当前病区id = c.病区id And c.病区id = n_病区id) Loop
    b_Key := Isfeverpatient(r.病人id, r.主页id, 0, d_结束, n_发热温度, n_发热天数);
    If b_Key Then
      n_Cnt := n_Cnt + 1;
    End If;
  End Loop;
  v_Temp := v_Temp || '<FRRS>' || n_Cnt || '</FRRS>';

  n_特级护理 := 0;
  n_I级护理  := 0;
  n_Ⅱ级护理 := 0;
  n_Ⅲ级护理 := 0;
  --显示当前病的在院病人，病案未归档，正常入院
  For R In (Select b.Id, b.名称, Count(1) As 人数
            From 收费项目目录 B, 病人信息 C, 病案主页 A, 在院病人 E
            Where b.Id = a.护理等级id And a.出院日期 Is Null And Nvl(a.状态, 0) <> 1 And Nvl(a.病案状态, 0) <> 5 And a.封存时间 Is Null And
                  c.病人id = a.病人id And c.主页id = a.主页id And c.病人id = e.病人id And c.当前病区id = e.病区id And e.病区id = n_病区id
            Group By b.Id, b.名称) Loop
    If r.名称 = '特级护理' Then
      --特级护理人数
      n_特级护理 := r.人数;
    Elsif r.名称 = 'I级护理' Then
      --一级护理人数
      n_I级护理 := r.人数;
    Elsif r.名称 = 'Ⅱ级护理' Then
      --二级护理人数
      n_Ⅱ级护理 := r.人数;
    Elsif r.名称 = 'Ⅲ级护理' Then
      --三级护理人数
      n_Ⅲ级护理 := r.人数;
    End If;
  End Loop;

  v_Temp := v_Temp || '<TJHL>' || n_特级护理 || '</TJHL>';
  v_Temp := v_Temp || '<YJHL>' || n_I级护理 || '</YJHL>';
  v_Temp := v_Temp || '<EJHL>' || n_Ⅱ级护理 || '</EJHL>';
  v_Temp := v_Temp || '<SJHL>' || n_Ⅲ级护理 || '</SJHL>';

  v_Temp := '<BQGK>' || v_Temp || '</BQGK>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Hip_Getunitsummary;
/
CREATE OR REPLACE Procedure Zl_Hip_Getpatilistindept
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --获取入科病人列表（包含入院、转入）

  --<IN>
  --  <BQID>            病区ID
  --  <KSSJ>            开始时间，yyyy-mm-dd hh24:mi:ss
  --  <JSSJ>            结束时间，yyyy-mm-dd hh24:mi:ss
  --</IN>

  --<OUTPUT>
  --  <BRLIST>
  --    <RYLIST>          入院病人列表
  --      <BR>
  --        <BRID>      病人ID
  --        <ZYID>      主页ID
  --        <YEXH>      婴儿序号
  --        <XM>      姓名
  --        <XB>      性别
  --        <NL>      年龄
  --        <CH>      床号
  --        <HLDJ>      护理等级
  --        <RYSJ>      入院时间，yyyy-mm-dd hh24:mi:ss
  --        <ZDLIST>      入院诊断，可能会有多个
  --          <ZD>
  --            <XH>  诊断序号
  --            <MC>  诊断名称
  --          </ZD>
  --        </ZDLIST>
  --      </BR>
  --    </RYLIST>
  --    <ZRLIST>          转入病人列表
  --      <BR>
  --        <BRID>      病人ID
  --        <ZYID>      主页ID
  --        <YEXH>      婴儿序号
  --        <XM>      姓名
  --        <XB>      性别
  --        <NL>      年龄
  --        <CH>      床号
  --        <HLDJ>      护理等级
  --        <ZRSJ>      转入时间，yyyy-mm-dd hh24:mi:ss
  --        <ZDLIST>      入院诊断，可能会有多个
  --          <ZD>
  --            <XH>  诊断序号
  --            <MC>  诊断名称
  --          </ZD>
  --        </ZDLIST>
  --      </BR>
  --    </ZRLIST>
  --  </BRLIST>
  --</OUTPUT>

  n_病区id  病案主页.当前病区id%Type;
  d_开始    Date;
  d_结束    Date;
  v_Temp    varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML

  Function Getpatidiags
  (
    n_Patiid 病案主页.病人id%Type,
    n_Pageid 病案主页.主页id%Type
  ) Return varchar2 Is
    v_Rs varchar2(6000);
    v_t  varchar2(600);
  Begin
    For c_Diag In (Select a.诊断次序 As 诊断序号, a.诊断描述 As 诊断名称
                   From 病人诊断记录 A
                   Where a.记录来源 = 3 And a.病人id = n_Patiid And a.主页id = n_Pageid And NVL(A.编码序号,1) = 1 and nvl(a.录入次序,'01')='01'
                   Order By a.诊断次序) Loop
      v_t := '<XH>' || c_Diag.诊断序号 || '</XH>';
      v_t := v_t || '<MC>' || c_Diag.诊断名称 || '</MC>';
      If v_Rs Is Null Then
        v_Rs := '<ZD>' || v_t || '</ZD>';
      Else
        v_Rs := v_Rs || '<ZD>' || v_t || '</ZD>';
      End If;
    End Loop;
    If v_Rs Is Not Null Then
      v_Rs := '<ZDLIST jsonArray="true">' || v_Rs || '</ZDLIST>';
    End If;
    Return(v_Rs);
  End Getpatidiags;
Begin
  x_Templet := Xmltype('<OUTPUT><BRLIST><RYLIST jsonArray="true"></RYLIST><ZRLIST jsonArray="true"></ZRLIST></BRLIST></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/BQID'), To_Date(Extractvalue(Value(A), 'IN/KSSJ'), 'YYYY-MM-DD HH24:MI:SS'),
         To_Date(Extractvalue(Value(A), 'IN/JSSJ'), 'YYYY-MM-DD HH24:MI:SS')
  Into n_病区id, d_开始, d_结束
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --入院病人列表
  For c_Pati In (Select b.病人id, b.主页id, 0 As 婴儿序号, b.姓名, b.性别, b.年龄, b.出院病床 As 床号, c.名称 As 护理等级,
                        To_Char(Max(a.开始时间), 'yyyy-mm-dd hh24:mi:ss') As 入院时间
                 From 病人变动记录 A, 病案主页 B, 收费项目目录 C
                 Where a.病人id = b.病人id And a.主页id = b.主页id And a.护理等级id = c.Id(+) And a.病区id + 0 = n_病区id And a.开始原因 = 1 And
                       a.终止原因 = 2 And a.开始时间 Between d_开始 And d_结束
                 Group By b.病人id, b.主页id, b.姓名, b.性别, b.年龄, b.出院病床, c.名称) Loop
    v_Temp := '<BRID>' || c_Pati.病人id || '</BRID>';
    v_Temp := v_Temp || '<ZYID>' || c_Pati.主页id || '</ZYID>';
    v_Temp := v_Temp || '<YEXH>' || c_Pati.婴儿序号 || '</YEXH>';
    v_Temp := v_Temp || '<XM>' || c_Pati.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || c_Pati.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || c_Pati.年龄 || '</NL>';
    v_Temp := v_Temp || '<CH>' || c_Pati.床号 || '</CH>';
    v_Temp := v_Temp || '<HLDJ>' || c_Pati.护理等级 || '</HLDJ>';
    v_Temp := v_Temp || '<RYSJ>' || c_Pati.入院时间 || '</RYSJ>';
    v_Temp := v_Temp || Getpatidiags(c_Pati.病人id, c_Pati.主页id);
    v_Temp := '<BR>' || v_Temp || '</BR>';
    Select Appendchildxml(x_Templet, '/OUT/BRLIST/RYLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  --转入病人列表，转入病区
  For c_Pati In (Select d.病人id, d.主页id, 0 As 婴儿序号, d.姓名, d.性别, d.年龄, d.出院病床 As 床号, c.名称 As 护理等级,
                        To_Char(Max(a.开始时间), 'yyyy-mm-dd hh24:mi:ss') As 转入时间
                 From 病人变动记录 A, 病人变动记录 B, 病案主页 D, 收费项目目录 C
                 Where a.病人id = b.病人id And a.主页id = b.主页id And a.病人id = d.病人id And a.主页id = d.主页id And a.开始时间 = b.终止时间 And
                       a.开始原因 = 15 And a.病区id + 0 = n_病区id And a.开始时间 Between d_开始 And d_结束 And a.护理等级id = c.Id(+)
                 Group By d.病人id, d.主页id, d.姓名, d.性别, d.年龄, d.出院病床, c.名称) Loop
    v_Temp := '<BRID>' || c_Pati.病人id || '</BRID>';
    v_Temp := v_Temp || '<ZYID>' || c_Pati.主页id || '</ZYID>';
    v_Temp := v_Temp || '<YEXH>' || c_Pati.婴儿序号 || '</YEXH>';
    v_Temp := v_Temp || '<XM>' || c_Pati.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || c_Pati.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || c_Pati.年龄 || '</NL>';
    v_Temp := v_Temp || '<CH>' || c_Pati.床号 || '</CH>';
    v_Temp := v_Temp || '<HLDJ>' || c_Pati.护理等级 || '</HLDJ>';
    v_Temp := v_Temp || '<RYSJ>' || c_Pati.转入时间 || '</RYSJ>';
    v_Temp := v_Temp || Getpatidiags(c_Pati.病人id, c_Pati.主页id);
    v_Temp := '<BR>' || v_Temp || '</BR>';
    Select Appendchildxml(x_Templet, '/OUTPUT/BRLIST/ZRLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Hip_Getpatilistindept;
/
CREATE OR REPLACE Procedure Zl_Hip_Getpatilistoutdept
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --获取出科病人列表（包含出院、转出、死亡）
  -- <IN>              
  --    <BQID>            病区ID
  --    <KSSJ>            开始时间，yyyy-mm-dd hh24:mi:ss
  --    <JSSJ>            结束时间，yyyy-mm-dd hh24:mi:ss
  --  </IN>             
  --  <OUTPUT>             
  --    <BRLIST>            
  --      <CYLIST>          出院病人列表
  --        <BR>        
  --          <BRID>      病人ID
  --          <ZYID>      主页ID
  --          <YEXH>      婴儿序号
  --          <XM>      姓名
  --          <XB>      性别
  --          <NL>      年龄
  --          <CH>      床号
  --          <HLDJ>      护理等级
  --          <CYSJ>      出院时间，yyyy-mm-dd hh24:mi:ss
  --          <ZDLIST>      出院诊断，可能会有多个
  --            <ZD>    
  --              <XH>  诊断序号
  --              <MC>  诊断名称
  --            </ZD>   
  --          </ZDLIST>     
  --        </BR>       
  --      </CYLIST>         
  --      <ZCLIST>          转出病人列表
  --        <BR>        
  --          <BRID>      病人ID
  --          <ZYID>      主页ID
  --          <YEXH>      婴儿序号
  --          <XM>      姓名
  --          <XB>      性别
  --          <NL>      年龄
  --          <CH>      床号
  --          <HLDJ>      护理等级
  --          <ZCSJ>      转出时间，yyyy-mm-dd hh24:mi:ss
  --          <ZDLIST>      出院诊断，可能会有多个
  --            <ZD>    
  --              <XH>  诊断序号
  --              <MC>  诊断名称
  --            </ZD>   
  --          </ZDLIST>     
  --        </BR>       
  --      </ZCLIST>         
  --      <SWLIST>          死亡病人列表
  --        <BR>        
  --          <BRID>      病人ID
  --          <ZYID>      主页ID
  --          <YEXH>      婴儿序号
  --          <XM>      姓名
  --          <XB>      性别
  --          <NL>      年龄
  --          <CH>      床号
  --          <HLDJ>      护理等级
  --          <SWSJ>      死亡时间，yyyy-mm-dd hh24:mi:ss
  --          <ZDLIST>      出院诊断，可能会有多个
  --            <ZD>    
  --              <XH>  诊断序号
  --              <MC>  诊断名称
  --            </ZD>   
  --          </ZDLIST>     
  --        </BR>       
  --      </SWLIST>         
  --    </BRLIST>           
  --  </OUTPUT>              
  n_病区id  病案主页.当前病区id%Type;
  d_开始    Date;
  d_结束    Date;
  v_Temp    varchar2(32767); --临时XML
  x_Templet Xmltype; --模板XML

  Function Getpatidiags
  (
    n_Patiid 病案主页.病人id%Type,
    n_Pageid 病案主页.主页id%Type
  ) Return varchar2 Is
    v_Rs varchar2(6000);
    v_t  varchar2(600);
  Begin
    For c_Diag In (Select a.诊断次序 As 诊断序号, a.诊断描述 As 诊断名称
                   From 病人诊断记录 A
                   Where a.记录来源 = 3 And a.病人id = n_Patiid And a.主页id = n_Pageid And NVL(A.编码序号,1) = 1 and nvl(a.录入次序,'01')='01'
                   Order By a.诊断次序) Loop
      v_t := '<XH>' || c_Diag.诊断序号 || '</XH>';
      v_t := v_t || '<MC>' || c_Diag.诊断名称 || '</MC>';
      If v_Rs Is Null Then
        v_Rs := '<ZD>' || v_t || '</ZD>';
      Else
        v_Rs := v_Rs || '<ZD>' || v_t || '</ZD>';
      End If;
    End Loop;
    If v_Rs Is Not Null Then
      v_Rs := '<ZDLIST jsonArray="true">' || v_Rs || '</ZDLIST>';
    End If;
    Return(v_Rs);
  End Getpatidiags;

Begin
  x_Templet := Xmltype('<OUTPUT><BRLIST><CYLIST jsonArray="true"></CYLIST><ZCLIST jsonArray="true"></ZCLIST><SWLIST jsonArray="true"></SWLIST></BRLIST></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/BQID'), To_Date(Extractvalue(Value(A), 'IN/KSSJ'), 'YYYY-MM-DD HH24:MI:SS'),
         To_Date(Extractvalue(Value(A), 'IN/JSSJ'), 'YYYY-MM-DD HH24:MI:SS')
  Into n_病区id, d_开始, d_结束
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --死亡病人：出院病人才能包含死亡病人，病人出院时间当作死亡时间
  --出院病人
  For c_Pati In (Select b.病人id, b.主页id, 0 As 婴儿序号, b.姓名, b.性别, b.年龄, b.出院病床 As 床号, c.名称 As 护理等级,
                        To_Char(b.出院日期, 'yyyy-mm-dd hh24:mi:ss') As 出院时间, b.出院方式
                 From 病案主页 B, 收费项目目录 C
                 Where b.当前病区id + 0 = n_病区id And b.护理等级id = c.Id(+) And b.出院日期 Between d_开始 And d_结束) Loop
    v_Temp := '<BRID>' || c_Pati.病人id || '</BRID>';
    v_Temp := v_Temp || '<ZYID>' || c_Pati.主页id || '</ZYID>';
    v_Temp := v_Temp || '<YEXH>' || c_Pati.婴儿序号 || '</YEXH>';
    v_Temp := v_Temp || '<XM>' || c_Pati.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || c_Pati.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || c_Pati.年龄 || '</NL>';
    v_Temp := v_Temp || '<CH>' || c_Pati.床号 || '</CH>';
    v_Temp := v_Temp || '<HLDJ>' || c_Pati.护理等级 || '</HLDJ>';
    v_Temp := v_Temp || '<RYSJ>' || c_Pati.出院时间 || '</RYSJ>';
    v_Temp := v_Temp || Getpatidiags(c_Pati.病人id, c_Pati.主页id);
    v_Temp := '<BR>' || v_Temp || '</BR>';
    Select Appendchildxml(x_Templet, '/OUT/BRLIST/CYLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    --死亡病人
    If c_Pati.出院方式 = '死亡' Then
      Select Appendchildxml(x_Templet, '/OUT/BRLIST/SWLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    End If;
  End Loop;

  --转入病人列表，转入病区
  For c_Pati In (Select d.病人id, d.主页id, 0 As 婴儿序号, d.姓名, d.性别, d.年龄, d.出院病床 As 床号, c.名称 As 护理等级,
                        To_Char(Max(a.开始时间), 'yyyy-mm-dd hh24:mi:ss') As 转入时间
                 From 病人变动记录 A, 病人变动记录 B, 病案主页 D, 收费项目目录 C
                 Where a.病人id = b.病人id And a.主页id = b.主页id And a.病人id = d.病人id And a.主页id = d.主页id And a.开始时间 = b.终止时间 And
                       a.开始原因 = 15 And a.病区id + 0 = n_病区id And a.开始时间 Between d_开始 And d_结束 And a.护理等级id = c.Id(+)
                 Group By d.病人id, d.主页id, d.姓名, d.性别, d.年龄, d.出院病床, c.名称) Loop
    v_Temp := '<BRID>' || c_Pati.病人id || '</BRID>';
    v_Temp := v_Temp || '<ZYID>' || c_Pati.主页id || '</ZYID>';
    v_Temp := v_Temp || '<YEXH>' || c_Pati.婴儿序号 || '</YEXH>';
    v_Temp := v_Temp || '<XM>' || c_Pati.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || c_Pati.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || c_Pati.年龄 || '</NL>';
    v_Temp := v_Temp || '<CH>' || c_Pati.床号 || '</CH>';
    v_Temp := v_Temp || '<HLDJ>' || c_Pati.护理等级 || '</HLDJ>';
    v_Temp := v_Temp || '<RYSJ>' || c_Pati.转入时间 || '</RYSJ>';
    v_Temp := v_Temp || Getpatidiags(c_Pati.病人id, c_Pati.主页id);
    v_Temp := '<BR>' || v_Temp || '</BR>';
    Select Appendchildxml(x_Templet, '/OUTPUT/BRLIST/ZRLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;
  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Hip_Getpatilistoutdept;
/

Create Or Replace Procedure Zl_Hip_Getpatitendinfo
(
  Patiinfo_In  In Xmltype,
  Patiinfo_Out Out Xmltype
) Is
  d_Datestart Date;
  d_Dateend   Date;
  n_病人id    病案主页.病人id%Type;
  n_主页id    病案主页.主页id%Type;
  n_Babyno    病人护理文件.婴儿%Type;
  x_Templet   Xmltype;
  x_Detail    Xmltype;
  v_Temp      Varchar2(4000);

  Function Getnursinginfo
  (
    n_Patiid_In    病案主页.病人id%Type,
    n_Pageid_In    病案主页.主页id%Type,
    n_Babyno_In    病人护理文件.婴儿%Type,
    v_Nursingname  病人护理明细.项目名称%Type,
    d_Begintime_In 病人护理明细.记录时间%Type,
    d_Endtime_In   病人护理明细.记录时间%Type,
    Blnnum_In      Boolean := False
  ) Return Varchar2 Is
  
    v_Rs    Varchar2(2000);
    v_Min   Varchar2(15);
    v_Max   Varchar2(15);
    n_Sum   Number(15);
    n_Issum Number(1);
  
  Begin
    n_Sum   := 0;
    n_Issum := 0;
    v_Rs    := '';
    Begin
      Select 1 Into n_Issum From 护理记录项目 Where 项目名称 = v_Nursingname And 项目表示 = 4;
    Exception
      When Others Then
        n_Issum := 0;
    End;
    If Blnnum_In = True Then
    
      Select Min(To_Number(Nvl(c.记录内容, 0)))
      Into v_Min
      From 病人护理文件 a, 病人护理数据 b, 病人护理明细 c
      Where a.Id = b.文件id And b.Id = c.记录id And a.病人id = n_Patiid_In And a.主页id = n_Pageid_In And a.婴儿 = n_Babyno_In And
            c.项目名称 = v_Nursingname And Regexp_Like(c.记录内容, '(^[+-]?\d{0,}\.?\d{0,}$)') And
            b.发生时间 Between d_Begintime_In And d_Endtime_In
      Order By b.发生时间;
    
      Select Max(To_Number(Nvl(c.记录内容, 0)))
      Into v_Max
      From 病人护理文件 a, 病人护理数据 b, 病人护理明细 c
      Where a.Id = b.文件id And b.Id = c.记录id And a.病人id = n_Patiid_In And a.主页id = n_Pageid_In And a.婴儿 = n_Babyno_In And
            c.项目名称 = v_Nursingname And Regexp_Like(c.记录内容, '(^[+-]?\d{0,}\.?\d{0,}$)') And
            b.发生时间 Between d_Begintime_In And d_Endtime_In
      Order By b.发生时间;
      If v_Min = v_Max Or v_Min Is Null Then
        Return(v_Max);
      Else
        Return(v_Min || '-' || v_Max);
      End If;
    Else
      If n_Issum = 1 Then
        For c_Nursinginfo In (Select To_Number(c.记录内容) As 数值
                              From 病人护理文件 a, 病人护理数据 b, 病人护理明细 c
                              Where a.Id = b.文件id And b.Id = c.记录id And a.病人id = n_Patiid_In And a.主页id = n_Pageid_In And
                                    a.婴儿 = n_Babyno_In And c.项目名称 = v_Nursingname And b.发生时间 Between d_Begintime_In And
                                    d_Endtime_In) Loop
          n_Sum := n_Sum + c_Nursinginfo.数值;
        End Loop;
        Return(n_Sum);
      Else
        Begin
          Select 记录内容
          Into v_Rs
          From (Select c.记录内容
                 From 病人护理文件 a, 病人护理数据 b, 病人护理明细 c
                 Where a.Id = b.文件id And b.Id = c.记录id And a.病人id = n_Patiid_In And a.主页id = n_Pageid_In And
                       a.婴儿 = n_Babyno_In And c.项目名称 = v_Nursingname And b.发生时间 Between d_Begintime_In And d_Endtime_In
                 Order By b.发生时间 Desc)
          Where Rownum < 2;
        Exception
          When Others Then
            v_Rs := '';
        End;
        Return(v_Rs);
      End If;
    
    End If;
  End Getnursinginfo;

  Function Getpatiopers
  (
    n_Patiid       病案主页.病人id%Type,
    n_Pageid       病案主页.主页id%Type,
    d_Begintime_In Date,
    d_Endtime_In   Date
  ) Return Varchar2 Is
    v_Rs   Varchar2(6000);
    n_组id 病人医嘱记录.Id%Type;
    n_Have Number;
    v_手术 Varchar2(6000);
    v_All  Varchar2(6000);
    v_附加 Varchar2(6000);
  Begin
    For c_Pati In (Select a.标本部位 As 手术时间, a.Id, a.相关id, d.类别, d.名称
                   From 病人医嘱记录 a, 诊疗项目目录 d
                   Where a.病人id = n_Patiid And a.主页id = n_Pageid And a.诊疗类别 In ('G', 'F') And
                         a.开始执行时间 Between d_Begintime_In - 1 And d_Endtime_In + 1 And a.诊疗项目id = d.Id And
                         To_Date(a.标本部位, 'YYYY-MM-DD HH24:MI:SS') Between Trunc(d_Begintime_In) And
                         Trunc(d_Endtime_In) + 2 - 1 / 24 / 60
                   Order By a.序号) Loop
      n_Have := 1;
    
      If c_Pati.相关id Is Null And v_手术 Is Not Null Then
        v_All  := v_All || '<SS jsonArray="true">' || v_手术 || '</SS>';
        v_手术 := Null;
      End If;
    
      If c_Pati.相关id Is Null Then
        n_组id := c_Pati.Id;
        v_手术 := '<SSSJ>' || c_Pati.手术时间 || '</SSSJ>';
        v_手术 := v_手术 || '<ZSSMC>' || c_Pati.名称 || '</ZSSMC>';
        v_附加 := Null;
      End If;
    
      If c_Pati.相关id = n_组id Then
        If c_Pati.类别 = 'F' Then
          v_附加 := v_附加 || '<MC>' || c_Pati.名称 || '</MC>';
        Elsif c_Pati.类别 = 'G' Then
          If v_附加 Is Not Null Then
            v_手术 := v_手术 || '<FJSS>' || v_附加 || '</FJSS>';
          End If;
          v_手术 := v_手术 || '<MZFS>' || c_Pati.名称 || '</MZFS>';
        End If;
      End If;
    End Loop;
    If n_Have = 1 Then
      v_All := v_All || '<SS jsonArray="true">' || v_手术 || '</SS>';
      v_Rs  := '<SSLIST>' || v_All || '</SSLIST>';
    Else
      v_Rs := '<SSLIST></SSLIST>';
    End If;
    Return(v_Rs);
  End Getpatiopers;

  Function Getpatigrade
  (
    n_Patiid        病案主页.病人id%Type,
    n_Pageid        病案主页.主页id%Type,
    n_Baby          病人新生儿记录.序号%Type,
    d_Datebegindate Date,
    d_Dateenddate   Date
  ) Return Varchar2 Is
    v_Grade Varchar2(20);
  Begin
    v_Grade := '';
    If n_Baby <> 0 Then
      Begin
        Select 护理等级
        Into v_Grade
        From (Select b.医嘱内容 As 护理等级
               From 病人医嘱记录 b, 收费项目目录 c
               Where b.诊疗项目id + 0 = c.Id And b.医嘱状态 = 8 And Nvl(b.婴儿, 0) <> 0 And b.诊疗类别 = 'H' And c.项目特性 = 1 And
                     b.病人id = n_Patiid And b.主页id = n_Pageid And b.婴儿(+) = n_Baby And d_Datebegindate < b.开始执行时间 And
                     d_Dateenddate > b.开始执行时间
               Order By b.开始执行时间 Desc)
        Where Rownum < 2;
      Exception
        When Others Then
          v_Grade := '';
      End;
    End If;
    If v_Grade Is Null Then
      Begin
        Select Decode(特级, 'Y', '特级护理', Decode(一级, 'Y', '一级护理', Decode(二级, 'Y', '二级护理', '三级护理')))
        Into v_Grade
        From (Select Decode(Sign(Instr(b.名称, '特')), 1, 'Y', Decode(Sign(Instr(b.名称, '重')), 1, 'Y', 'N')) As 特级,
                      Decode(Sign(Instr(b.名称, '一')),
                              1,
                              'Y',
                              Decode(Sign(Instr(b.名称, '1')),
                                     1,
                                     'Y',
                                     Decode(Sign(Instr(b.名称, 'Ⅰ')), 1, 'Y', Decode(Sign(Instr(b.名称, 'I')), 1, 'Y', 'N')))) As 一级,
                      Decode(Sign(Instr(b.名称, '二')),
                              1,
                              'Y',
                              Decode(Sign(Instr(b.名称, '2')),
                                     1,
                                     'Y',
                                     Decode(Sign(Instr(b.名称, 'Ⅱ')),
                                            1,
                                            'Y',
                                            Decode(Sign(Instr(b.名称, 'II')), 1, 'Y', 'N')))) As 二级
               From 病案主页 a, 收费项目目录 b,
                    (Select 病人id, 主页id, 护理等级id, 开始时间
                      From (Select 病人id, 主页id, 护理等级id, 开始时间, Row_Number() Over(Partition By 病人id Order By 开始时间 Desc) As Top
                             From 病人变动记录
                             Where d_Datebegindate < 开始时间 And (终止时间 Is Null Or d_Dateenddate > 终止时间))
                      Where Top = 1) c
               Where a.病人id = c.病人id And a.主页id = c.主页id And a.病人id = n_Patiid And a.主页id = n_Pageid And
                     b.Id = c.护理等级id(+)
               Order By c.开始时间)
        Where Rownum < 2;
      Exception
        When Others Then
          v_Grade := '三级护理';
      End;
    End If;
    Return v_Grade;
  End Getpatigrade;

Begin

  Select To_Number(Extractvalue(Value(a), 'IN/BRID'))
  Into n_病人id
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) a;

  Select To_Number(Extractvalue(Value(a), 'IN/ZYID'))
  Into n_主页id
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) a;

  Select To_Number(Extractvalue(Value(a), 'IN/YEXH'))
  Into n_Babyno
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) a;

  Select To_Date(Extractvalue(Value(a), 'IN/KSSJ'), 'YYYY-MM_DD hh24:mi:ss')
  Into d_Datestart
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) a;

  Select To_Date(Extractvalue(Value(a), 'IN/JSSJ'), 'YYYY-MM-DD hh24:mi:ss')
  Into d_Dateend
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) a;

  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  For c_Patiinfo In (Select a.姓名, a.性别, a.年龄, a.出院病床 As 床号, b.名称, a.出院日期 As 出院时间, 护理等级id As 护理等级
                     From 病案主页 a, 收费项目目录 b
                     Where a.病人id = n_病人id And a.主页id = n_主页id And a.护理等级id = b.Id) Loop
    Select Appendchildxml(x_Templet, 'OUTPUT', Xmltype('<BR></BR>')) Into x_Templet From Dual;
    Select Appendchildxml(x_Templet, 'OUTPUT/BR', Xmltype('<JBXX></JBXX>')) Into x_Templet From Dual;
    v_Temp := '<XM>' || c_Patiinfo.姓名 || '</XM>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/JBXX', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<XB>' || c_Patiinfo.性别 || '</XB>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/JBXX', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<NL>' || c_Patiinfo.年龄 || '</NL>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/JBXX', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<CH>' || c_Patiinfo.床号 || '</CH>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/JBXX', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<HLDJ>' || Getpatigrade(n_病人id, n_主页id, n_Babyno, d_Datestart, d_Dateend) || '</HLDJ>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/JBXX', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<CYSJ>' || c_Patiinfo.出院时间 || '</CYSJ>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/JBXX', Xmltype(v_Temp)) Into x_Templet From Dual;
    Select Appendchildxml(x_Templet, 'OUTPUT/BR', Xmltype('<ZDLIST></ZDLIST>'))
    Into x_Templet
    From Dual;
    For c_Diag In (Select a.诊断次序 As 诊断序号, a.诊断描述 As 诊断名称
                   From 病人诊断记录 a
                   Where a.记录来源 = 3 And a.病人id = n_病人id And a.主页id = n_主页id And a.诊断类型 In (3, 13) and nvl(a.录入次序,'01')='01'
                   Order By a.诊断次序) Loop
      v_Temp := '<ZD jsonArray="true">';
    
      v_Temp := v_Temp || '<XH>' || c_Diag.诊断序号 || '</XH>';
      v_Temp := v_Temp || '<MC>' || c_Diag.诊断名称 || '</MC>';
      v_Temp := v_Temp || '</ZD>';
      Select Appendchildxml(x_Templet, 'OUTPUT/BR/ZDLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
  
    v_Temp := Getpatiopers(n_病人id, n_主页id, d_Datestart, d_Dateend);
    Select Appendchildxml(x_Templet, '/OUTPUT/BR', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    Select Appendchildxml(x_Templet, 'OUTPUT/BR', Xmltype('<HLJL></HLJL>')) Into x_Templet From Dual;
    v_Temp := '<TW>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '体温', d_Datestart, d_Dateend, True) || '</TW>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<HX>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '呼吸', d_Datestart, d_Dateend, True) || '</HX>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<MB>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '脉搏', d_Datestart, d_Dateend, True) || '</MB>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<SZY>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '舒张压', d_Datestart, d_Dateend, True) || '</SZY>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<SSY>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '收缩压', d_Datestart, d_Dateend, True) || '</SSY>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<XT>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '血糖', d_Datestart, d_Dateend, True) || '</XT>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<SZ>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '神志', d_Datestart, d_Dateend, False) || '</SZ>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<TKDXL>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '瞳孔大小(左)', d_Datestart, d_Dateend, False) ||
              '</TKDXL>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<TKDXR>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '瞳孔大小(右)', d_Datestart, d_Dateend, False) ||
              '</TKDXR>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<TKFYL>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '瞳孔反应(左)', d_Datestart, d_Dateend, False) ||
              '</TKFYL>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<TKFYR>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '瞳孔反应(右)', d_Datestart, d_Dateend, False) ||
              '</TKFYR>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<YRW>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '饮入物', d_Datestart, d_Dateend, False) || '</YRW>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<YRL>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '饮入量', d_Datestart, d_Dateend, False) || '</YRL>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<ZRL>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '总入量', d_Datestart, d_Dateend, False) || '</ZRL>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<PCW>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '排出物', d_Datestart, d_Dateend, False) || '</PCW>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<PCL>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '排出量', d_Datestart, d_Dateend, False) || '</PCL>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<YLL>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '引流量', d_Datestart, d_Dateend, False) || '</YLL>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<XBL>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '小便量', d_Datestart, d_Dateend, False) || '</XBL>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<ZCL>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '总出量', d_Datestart, d_Dateend, False) || '</ZCL>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<XBCS>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '小便次数', d_Datestart, d_Dateend, False) || '</XBCS>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<DBCS>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '大便次数', d_Datestart, d_Dateend, False) || '</DBCS>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
    v_Temp := '<BQGC>' || Getnursinginfo(n_病人id, n_主页id, n_Babyno, '病情观察', d_Datestart, d_Dateend, False) || '</BQGC>';
    Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLJL', Xmltype(v_Temp)) Into x_Templet From Dual;
  
    --提取某段时间的护理数据明细
    Select Appendchildxml(x_Templet, 'OUTPUT/BR', Xmltype('<HLMX></HLMX>')) Into x_Templet From Dual;
    For r_Detail In (Select To_Char(发生时间, 'YYYY-MM-DD hh24:mi') 发生时间, Max(体温) 体温, Max(呼吸) 呼吸, Max(脉搏) 脉搏, Max(舒张压) 舒张压,
                            Max(收缩压) 收缩压, Max(血糖) 血糖, Max(神志) 神志, Max(左瞳孔大小) 左瞳孔大小, Max(右瞳孔大小) 右瞳孔大小, Max(左瞳孔反应) 左瞳孔反应,
                            Max(右瞳孔反应) 右瞳孔反应, Max(饮入物) 饮入物, Max(饮入量) 饮入量, Max(总入量) 总入量, Max(排出物) 排出物, Max(排出量) 排出量,
                            Max(引流量) 引流量, Max(小便量) 小便量, Max(总出量) 总出量, Max(小便次数) 小便次数, Max(大便次数) 大便次数, Max(病情观察) 病情观察
                     From (Select Id, 发生时间, Max(体温) 体温, Max(呼吸) 呼吸, Max(脉搏) 脉搏, Max(舒张压) 舒张压, Max(收缩压) 收缩压, Max(血糖) 血糖,
                                   Max(神志) 神志, Max(左瞳孔大小) 左瞳孔大小, Max(右瞳孔大小) 右瞳孔大小, Max(左瞳孔反应) 左瞳孔反应, Max(右瞳孔反应) 右瞳孔反应,
                                   Max(饮入物) 饮入物, Max(饮入量) 饮入量, Max(总入量) 总入量, Max(排出物) 排出物, Max(排出量) 排出量, Max(引流量) 引流量,
                                   Max(小便量) 小便量, Max(总出量) 总出量, Max(小便次数) 小便次数, Max(大便次数) 大便次数,
                                   f_List2str(Cast(Collect('' || 病情观察) As t_Strlist), '') 病情观察
                            From (Select a.Id, To_Date(To_Char(b.发生时间, 'YYYY-MM-DD hh24:mi'), 'YYYY-MM-DD hh24:mi') 发生时间,
                                          Decode(c.项目名称, '体温', c.记录内容, '') 体温, Decode(c.项目名称, '呼吸', c.记录内容, '') 呼吸,
                                          Decode(c.项目名称, '脉搏', c.记录内容, '') 脉搏, Decode(c.项目名称, '舒张压', c.记录内容, '') 舒张压,
                                          Decode(c.项目名称, '收缩压', c.记录内容, '') 收缩压, Decode(c.项目名称, '血糖', c.记录内容, '') 血糖,
                                          Decode(c.项目名称, '神志', c.记录内容, '') 神志,
                                          Decode(c.项目名称, '左瞳孔大小', c.记录内容, '') 左瞳孔大小,
                                          Decode(c.项目名称, '右瞳孔大小', c.记录内容, '') 右瞳孔大小,
                                          Decode(c.项目名称, '左瞳孔反应', c.记录内容, '') 左瞳孔反应,
                                          Decode(c.项目名称, '右瞳孔反应', c.记录内容, '') 右瞳孔反应,
                                          Decode(c.项目名称, '饮入物', c.记录内容, '') 饮入物, Decode(c.项目名称, '饮入量', c.记录内容, '') 饮入量,
                                          Decode(c.项目名称, '总入量', c.记录内容, '') 总入量, Decode(c.项目名称, '排出物', c.记录内容, '') 排出物,
                                          Decode(c.项目名称, '排出量', c.记录内容, '') 排出量, Decode(c.项目名称, '引流量', c.记录内容, '') 引流量,
                                          Decode(c.项目名称, '小便量', c.记录内容, '') 小便量, Decode(c.项目名称, '总出量', c.记录内容, '') 总出量,
                                          Decode(c.项目名称, '小便次数', c.记录内容, '') 小便次数,
                                          Decode(c.项目名称, '大便次数', c.记录内容, '') 大便次数,
                                          Decode(c.项目名称, '病情观察', c.记录内容, '') 病情观察
                                   From 病人护理明细 c, 病人护理数据 b, 病人护理文件 a
                                   Where Mod(c.记录类型, 10) <> 5 And c.终止版本 Is Null And c.记录id = b.Id And
                                         b.发生时间 Between d_Datestart And d_Dateend And b.文件id = a.Id And a.病人id = n_病人id And
                                         a.主页id = n_主页id And Nvl(a.婴儿, 0) = n_Babyno)
                            Group By Id, 发生时间)
                     Where 体温 Is Not Null Or 呼吸 Is Not Null Or 脉搏 Is Not Null Or 舒张压 Is Not Null Or 收缩压 Is Not Null Or
                           血糖 Is Not Null Or 神志 Is Not Null Or 左瞳孔大小 Is Not Null Or 右瞳孔大小 Is Not Null Or
                           左瞳孔反应 Is Not Null Or 右瞳孔反应 Is Not Null Or 饮入物 Is Not Null Or 饮入量 Is Not Null Or
                           总入量 Is Not Null Or 排出物 Is Not Null Or 排出量 Is Not Null Or 引流量 Is Not Null Or 小便量 Is Not Null Or
                           总出量 Is Not Null Or 小便次数 Is Not Null Or 大便次数 Is Not Null Or 病情观察 Is Not Null
                     Group By 发生时间) Loop
      x_Detail := Xmltype('<ITEM jsonArray="true"></ITEM>');
      v_Temp   := '<FSSJ>' || r_Detail.发生时间 || '</FSSJ>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<TW>' || r_Detail.体温 || '</TW>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<HX>' || r_Detail.呼吸 || '</HX>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<MB>' || r_Detail.脉搏 || '</MB>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<SZY>' || r_Detail.舒张压 || '</SZY>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<SSY>' || r_Detail.收缩压 || '</SSY>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<XT>' || r_Detail.血糖 || '</XT>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<SZ>' || r_Detail.神志 || '</SZ>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<TKDXL>' || r_Detail.左瞳孔大小 || '</TKDXL>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<TKDXR>' || r_Detail.右瞳孔大小 || '</TKDXR>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<TKFYL>' || r_Detail.左瞳孔反应 || '</TKFYL>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<TKFYR>' || r_Detail.右瞳孔反应 || '</TKFYR>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<YRW>' || r_Detail.饮入物 || '</YRW>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<YRL>' || r_Detail.饮入量 || '</YRL>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<ZRL>' || r_Detail.总入量 || '</ZRL>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<PCW>' || r_Detail.排出物 || '</PCW>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<PCL>' || r_Detail.排出量 || '</PCL>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<YLL>' || r_Detail.引流量 || '</YLL>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<XBL>' || r_Detail.小便量 || '</XBL>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<ZCL>' || r_Detail.总出量 || '</ZCL>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<XBCS>' || r_Detail.小便次数 || '</XBCS>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<DBCS>' || r_Detail.大便次数 || '</DBCS>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      v_Temp := '<BQGC>' || r_Detail.病情观察 || '</BQGC>';
      Select Appendchildxml(x_Detail, 'ITEM', Xmltype(v_Temp)) Into x_Detail From Dual;
      Select Appendchildxml(x_Templet, 'OUTPUT/BR/HLMX', x_Detail) Into x_Templet From Dual;
    End Loop;
  End Loop;

  Patiinfo_Out := x_Templet;

Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_Hip_Getpatitendinfo;
/

Create Or Replace Procedure Zl_Hip_Getpatilisthot
(
  Patiinfo_In  In Xmltype,
  Patiinfo_Out Out Xmltype
) Is
  Cursor c_Patiinfo
  (
    n_病区id      病案主页.当前病区id%Type,
    d_Dateendtime 病人变动记录.终止时间%Type
  ) Is
    Select a.病人id, a.主页id, b.序号 As 婴儿序号, a.姓名, a.性别, a.年龄, a.出院病床 As 床号, d.名称 As 护理等级
    From 病案主页 A, 病人新生儿记录 B, 病人变动记录 C, 收费项目目录 D
    Where a.当前病区id = n_病区id And a.病人id = c.病人id And a.主页id = c.主页id And a.病人id = b.病人id And a.主页id = b.主页id And
          d.Id = c.护理等级id And d_Dateendtime > c.开始时间 And (c.终止时间 Is Null Or c.终止时间 > d_Dateendtime)
    Union
    Select a.病人id, a.主页id, 0 As 婴儿序号, a.姓名, a.性别, a.年龄, a.出院病床 As 床号, d.名称 As 护理等级
    From 病案主页 A, 病人变动记录 C, 收费项目目录 D
    Where a.当前病区id = n_病区id And a.病人id = c.病人id And a.主页id = c.主页id And d.Id = c.护理等级id And d_Dateendtime > c.开始时间 And
          (c.终止时间 Is Null Or c.终止时间 > d_Dateendtime);

  Type t_Patiinfo Is Table Of c_Patiinfo%RowType; --记录类型变量
  r_Patiinfo t_Patiinfo;

  n_Inpatientareaid Number(18); --病区ID
  d_Datestart       Date;
  d_Dateend         Date;
  d_Datefirst       Date; --第一天时间
  d_Datelast        Date; --最后一天时间
  d_Dateper         Date; --上一段时间
  n_Standard        Number(4); --发热标准
  n_Daynum          Number(2); --发热天数
  x_Templet         Xmltype;
  v_Temp            Varchar2(4000);

  Function Isfeverpatient
  (
    n_Patiid_In     病案主页.病人id%Type,
    n_Pageid_In     病案主页.主页id%Type,
    n_Patibabyid_In 病人新生儿记录.序号%Type,
    d_Endtime_In    Date,
    n_Standard_In   Number, --发热标准
    n_Feverday_In   Number --发热天数
  ) Return Boolean Is
  
    d_Dateper   Date;
    d_Datefirst Date;
    d_Datelast  Date;
    n_Daynum    Number;
  Begin
  
    For c_Temp In (Select 病人id, 主页id, 体温, 时间, 婴儿序号
                   From (Select a. 病人id, a.主页id,
                                 Decode(d.记录内容, '不升', Lead(d.记录内容, 1, 0) Over(Order By a.病人id, b.婴儿, c.发生时间), d.记录内容) As 体温,
                                 c.发生时间 As 时间, b.婴儿 As 婴儿序号
                          From 病案主页 A, 病人护理文件 B, 病人护理数据 C, 病人护理明细 D, 病历文件列表 E
                          Where a.病人id = b.病人id And b.Id = c.文件id And c.Id = d.记录id And d.项目序号 = 1 And d.记录类型 = 1 And
                                b.格式id = e.Id And e.种类 = 3 And e.保留 = -1 And a.病人id = n_Patiid_In And a.主页id = n_Pageid_In And
                                b.婴儿 = n_Patibabyid_In And c.发生时间 Between (d_Endtime_In - n_Feverday_In) And d_Endtime_In
                          Order By a.病人id, b.婴儿, c.发生时间)
                   Where Regexp_Like(体温, '(^[+-]?\d{0,}\.?\d{0,}$)') And To_Number(Nvl(体温, 0)) > n_Standard_In) Loop
      If d_Dateper Is Not Null Then
        If c_Temp.时间 - d_Dateper < 2 Then
          d_Datelast := c_Temp.时间;
        Else
          n_Daynum := d_Datelast - d_Datefirst;
          If n_Daynum > n_Feverday_In - 1 Then
            Exit;
          Else
            d_Datefirst := c_Temp.时间;
            d_Datelast  := c_Temp.时间;
          End If;
        End If;
      Else
        d_Datefirst := c_Temp.时间;
        d_Datelast  := c_Temp.时间;
      End If;
      d_Dateper := c_Temp.时间;
    End Loop;
    n_Daynum := d_Datelast - d_Datefirst;
    If n_Daynum > n_Feverday_In - 1-1/24/60/60 Then
      Return(True);
    Else
      Return(False);
    End If;
  End Isfeverpatient;

  Function Getpatidiags
  (
    n_Patiid 病案主页.病人id%Type,
    n_Pageid 病案主页.主页id%Type
  ) Return Varchar2 Is
    v_Rs Varchar2(6000);
    v_t  Varchar2(600);
  Begin
    For c_Diag In (Select a.诊断次序 As 诊断序号, a.诊断描述 As 诊断名称
                   From 病人诊断记录 A
                   Where a.记录来源 = 3 And a.病人id = n_Patiid And a.主页id = n_Pageid And a.诊断类型 In (2, 12) and nvl(a.录入次序,'01')='01'
                   Order By a.诊断次序) Loop
      v_t := '<XH>' || c_Diag.诊断序号 || '</XH>';
      v_t := v_t || '<MC>' || c_Diag.诊断名称 || '</MC>';
      If v_Rs Is Null Then
        v_Rs := '<ZD>' || v_t || '</ZD>';
      Else
        v_Rs := v_Rs || '<ZD>' || v_t || '</ZD>';
      End If;
    End Loop;
    If v_Rs Is Null Then
      --未找到数据返回一个空模板
      v_Rs := '<ZDLIST></ZDLIST>';
    Else
      v_Rs := '<ZDLIST jsonArray="true">' || v_Rs || '</ZDLIST>';
    End If;
    Return(v_Rs);
  End Getpatidiags;
  
  Function Getpatigrade
  (
    n_Patiid        病案主页.病人id%Type,
    n_Pageid        病案主页.主页id%Type,
    n_Baby          病人新生儿记录.序号%Type,
    d_Datebegindate Date,
    d_Dateenddate   Date
  ) Return Varchar2 Is
    v_Grade Varchar2(20);
  Begin
    v_Grade := '';
    If n_Baby <> 0 Then
      Begin
        Select 护理等级
        Into v_Grade
        From (Select b.医嘱内容 As 护理等级
               From 病人医嘱记录 B, 收费项目目录 C
               Where b.诊疗项目id + 0 = c.Id And b.医嘱状态 = 8 And Nvl(b.婴儿, 0) <> 0 And b.诊疗类别 = 'H' And c.项目特性 = 1 And
                     b.病人id = n_Patiid And b.主页id = n_Pageid And b.婴儿(+) = n_Baby And d_Datebegindate < b.开始执行时间 And
                     d_Dateenddate > b.开始执行时间
               Order By b.开始执行时间 Desc)
        Where Rownum < 2;
      Exception
        When Others Then
          v_Grade := '';
      End;
    End If;
    If v_Grade Is Null Then
      Begin
        Select Decode(特级, 'Y', '特级护理', Decode(一级, 'Y', '一级护理', Decode(二级, 'Y', '二级护理', '三级护理')))
        Into v_Grade
        From (Select Decode(Sign(Instr(b.名称, '特')), 1, 'Y', Decode(Sign(Instr(b.名称, '重')), 1, 'Y', 'N')) As 特级,
                      Decode(Sign(Instr(b.名称, '一')), 1, 'Y',
                              Decode(Sign(Instr(b.名称, '1')), 1, 'Y',
                                      Decode(Sign(Instr(b.名称, 'Ⅰ')), 1, 'Y', Decode(Sign(Instr(b.名称, 'I')), 1, 'Y', 'N')))) As 一级,
                      Decode(Sign(Instr(b.名称, '二')), 1, 'Y',
                              Decode(Sign(Instr(b.名称, '2')), 1, 'Y',
                                      Decode(Sign(Instr(b.名称, 'Ⅱ')), 1, 'Y', Decode(Sign(Instr(b.名称, 'II')), 1, 'Y', 'N')))) As 二级
               From 病案主页 A, 收费项目目录 B,
                    (Select 病人id, 主页id, 护理等级id, 开始时间
                      From (Select 病人id, 主页id, 护理等级id, 开始时间,Row_Number() Over(Partition By 病人id Order By 开始时间 Desc) As Top
                             From 病人变动记录
                             Where d_Datebegindate < 开始时间 And (终止时间 Is Null Or d_Dateenddate > 终止时间))
                      Where Top = 1) C
               Where a.病人id = c.病人id And a.主页id = c.主页id And a.病人id = n_Patiid And a.主页id = n_Pageid And
                     b.Id = c.护理等级id(+)
               Order By c.开始时间)
        Where Rownum < 2;
      Exception
        When Others Then
          v_Grade := '三级护理';
      End;
    End If;
    Return v_Grade;
  End Getpatigrade;

Begin
  --提取
  Select To_Number(Extractvalue(Value(A), 'IN/BQID'))
  Into n_Inpatientareaid
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) A;

  Select To_Date(Extractvalue(Value(A), 'IN/KSSJ'), 'YYYY-MM_DD hh24:mi:ss')
  Into d_Datestart
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) A;

  Select To_Date(Extractvalue(Value(A), 'IN/JSSJ'), 'YYYY-MM-DD hh24:mi:ss')
  Into d_Dateend
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/BZWD'))
  Into n_Standard
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) A;

  Select To_Number(Extractvalue(Value(A), 'IN/CXTS'))
  Into n_Daynum
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) A;

  --提取消息头文件

  x_Templet := Xmltype('<OUTPUT><BRLIST jsonArray="true"><FRLIST jsonArray="true"></FRLIST></BRLIST></OUTPUT>');

  Open c_Patiinfo(n_Inpatientareaid, d_Dateend);
  Fetch c_Patiinfo Bulk Collect
    Into r_Patiinfo;
  Close c_Patiinfo;

  For I In 1 .. r_Patiinfo.Count Loop
  
    If Isfeverpatient(r_Patiinfo(I).病人id, r_Patiinfo(I).主页id, r_Patiinfo(I).婴儿序号, d_Dateend, n_Standard, n_Daynum) Then
      v_Temp := '<BR>';
      v_Temp := v_Temp || '<BRID>' || r_Patiinfo(I).病人id || '</BRID>';
      v_Temp := v_Temp || '<ZYID>' || r_Patiinfo(I).主页id || '</ZYID>';
      v_Temp := v_Temp || '<YEXH>' || r_Patiinfo(I).婴儿序号 || '</YEXH>';
      v_Temp := v_Temp || '<XM>' || r_Patiinfo(I).姓名 || '</XM>';
      v_Temp := v_Temp || '<XB>' || r_Patiinfo(I).性别 || '</XB>';
      v_Temp := v_Temp || '<NL>' || r_Patiinfo(I).年龄 || '</NL>';
      v_Temp := v_Temp || '<CH>' || r_Patiinfo(I).床号 || '</CH>';
      v_Temp := v_Temp || '<HLDJ>' || Getpatigrade(r_Patiinfo(I).病人id,r_Patiinfo(I).主页id, r_Patiinfo(I).婴儿序号, d_Datestart, d_Dateend) || '</HLDJ>';
      v_Temp := v_Temp || Getpatidiags(r_Patiinfo(I).病人id, r_Patiinfo(I).主页id);
      v_Temp := v_Temp || '</BR>';
      Select Appendchildxml(x_Templet, 'OUTPUT/BRLIST/FRLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    End If;
  End Loop;

  Patiinfo_Out := x_Templet;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Hip_Getpatilisthot;
/
Create Or Replace Procedure Zl_Hip_Getpatilisttend
(
  Patiinfo_In  In Xmltype,
  Patiinfo_Out Out Xmltype
) Is
  n_Inpatientareaid Number(18); --病区ID
  d_Datestart       Date;
  d_Dateend         Date;
  x_Templet         Xmltype;
  v_等级            Varchar2(10);
  v_Temp            Varchar2(5000);
  Function Getpatidiags
  (
    n_Patiid 病案主页.病人id%Type,
    n_Pageid 病案主页.主页id%Type
  ) Return Varchar2 Is
    v_Rs Varchar2(6000);
    v_t  Varchar2(600);
  Begin
    For c_Diag In (Select a.诊断次序 As 诊断序号, a.诊断描述 As 诊断名称
                   From 病人诊断记录 A
                   Where a.记录来源 = 3 And a.病人id = n_Patiid And a.主页id = n_Pageid And a.诊断类型 In (2, 12) and nvl(a.录入次序,'01')='01'
                   Order By a.诊断次序) Loop
      v_t := '<XH>' || c_Diag.诊断序号 || '</XH>';
      v_t := v_t || '<MC>' || c_Diag.诊断名称 || '</MC>';
      If v_Rs Is Null Then
        v_Rs := '<ZD>' || v_t || '</ZD>';
      Else
        v_Rs := v_Rs || '<ZD>' || v_t || '</ZD>';
      End If;
    End Loop;
    If v_Rs Is Null Then
      --未找到数据返回一个空模板
      v_Rs := '<ZDLIST></ZDLIST>';
    Else
      v_Rs := '<ZDLIST>' || v_Rs || '</ZDLIST>';
    End If;
    Return(v_Rs);
  End Getpatidiags;

  Function Getpatigrade
  (
    n_Patiid        病案主页.病人id%Type,
    n_Pageid        病案主页.主页id%Type,
    n_Baby          病人新生儿记录.序号%Type,
    d_Datebegindate Date,
    d_Dateenddate   Date
  ) Return Varchar2 Is
    v_Grade Varchar2(20);
  Begin
    v_Grade := '';
    If n_Baby <> 0 Then
      Begin
        Select 护理等级
        Into v_Grade
        From (Select b.医嘱内容 As 护理等级
               From 病人医嘱记录 B, 收费项目目录 C
               Where b.诊疗项目id + 0 = c.Id And b.医嘱状态 = 8 And Nvl(b.婴儿, 0) <> 0 And b.诊疗类别 = 'H' And c.项目特性 = 1 And
                     b.病人id = n_Patiid And b.主页id = n_Pageid And b.婴儿(+) = n_Baby And d_Datebegindate < b.开始执行时间 And
                     d_Dateenddate > b.开始执行时间
               Order By b.开始执行时间 Desc)
        Where Rownum < 2;
      Exception
        When Others Then
          v_Grade := '';
      End;
    End If;
    If v_Grade Is Null Then
      Begin
        Select Decode(特级, 'Y', '特级护理', Decode(一级, 'Y', '一级护理', Decode(二级, 'Y', '二级护理', '三级护理')))
        Into v_Grade
        From (Select Decode(Sign(Instr(b.名称, '特')), 1, 'Y', Decode(Sign(Instr(b.名称, '重')), 1, 'Y', 'N')) As 特级,
                      Decode(Sign(Instr(b.名称, '一')), 1, 'Y',
                              Decode(Sign(Instr(b.名称, '1')), 1, 'Y',
                                      Decode(Sign(Instr(b.名称, 'Ⅰ')), 1, 'Y', Decode(Sign(Instr(b.名称, 'I')), 1, 'Y', 'N')))) As 一级,
                      Decode(Sign(Instr(b.名称, '二')), 1, 'Y',
                              Decode(Sign(Instr(b.名称, '2')), 1, 'Y',
                                      Decode(Sign(Instr(b.名称, 'Ⅱ')), 1, 'Y', Decode(Sign(Instr(b.名称, 'II')), 1, 'Y', 'N')))) As 二级
               From 病案主页 A, 收费项目目录 B,
                    (Select 病人id, 主页id, 护理等级id, 开始时间
                      From (Select 病人id, 主页id, 护理等级id, 开始时间, Row_Number() Over(Partition By 病人id Order By 开始时间 Desc) As Top
                             From 病人变动记录
                             Where d_Datebegindate < 开始时间 And (终止时间 Is Null Or d_Dateenddate > 终止时间))
                      Where Top = 1) C
               Where a.病人id = c.病人id And a.主页id = c.主页id And a.病人id = n_Patiid And a.主页id = n_Pageid And
                     b.Id = c.护理等级id(+)
               Order By c.开始时间)
        Where Rownum < 2;
      Exception
        When Others Then
          v_Grade := '三级护理';
      End;
    End If;
    Return v_Grade;
  End Getpatigrade;

Begin
  --提取
  Select To_Number(Extractvalue(Value(A), 'IN/BQID'))
  Into n_Inpatientareaid
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) A;

  Select To_Date(Extractvalue(Value(A), 'IN/KSSJ'), 'YYYY-MM_DD hh24:mi:ss')
  Into d_Datestart
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) A;

  Select To_Date(Extractvalue(Value(A), 'IN/JSSJ'), 'YYYY-MM-DD hh24:mi:ss')
  Into d_Dateend
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT><BRLIST jsonArray="true"></BRLIST></OUTPUT>');
  Select Appendchildxml(x_Templet, 'OUTPUT/BRLIST', Xmltype('<YJHLLIST jsonArray="true"></YJHLLIST>')) Into x_Templet From Dual;
  Select Appendchildxml(x_Templet, 'OUTPUT/BRLIST', Xmltype('<EJHLLIST jsonArray="true"></EJHLLIST>')) Into x_Templet From Dual;
  Select Appendchildxml(x_Templet, 'OUTPUT/BRLIST', Xmltype('<SJHLLIST jsonArray="true"></SJHLLIST>')) Into x_Templet From Dual;
  Select Appendchildxml(x_Templet, 'OUTPUT/BRLIST', Xmltype('<TJHLLIST jsonArray="true"></TJHLLIST>')) Into x_Templet From Dual;
  For c_Patiinfo In (Select 病人id, 主页id, 婴儿序号, 姓名, 性别, 年龄, 床号
                     From ((Select a.病人id, a.主页id, b.序号 As 婴儿序号, a.姓名, a.性别, a.年龄, LPad(Nvl(a.出院病床, ' '), 1, ' ') As 床号
                             From 病案主页 A, 病人新生儿记录 B,
                                  (Select 病人id, 主页id
                                    From (Select 病人id, 主页id, Row_Number() Over(Partition By 病人id Order By 开始时间 Desc) As Top
                                           From 病人变动记录
                                           Where 病区id = n_Inpatientareaid And d_Datestart < 开始时间 And
                                                 (终止时间 Is Null Or d_Dateend > 终止时间))
                                    Where Top = 1) C
                             Where a.病人id = b.病人id And a.主页id = b.主页id And a.病人id = c.病人id And a.主页id = c.主页id) Union
                            (Select a.病人id, a.主页id, 0 As 婴儿序号, a.姓名, a.性别, a.年龄, LPad(Nvl(a.出院病床, ' '), 1, ' ') As 床号
                             From 病案主页 A,
                                  (Select 病人id, 主页id
                                    From (Select 病人id, 主页id, Row_Number() Over(Partition By 病人id Order By 开始时间 Desc) As Top
                                           From 病人变动记录
                                           Where 病区id = n_Inpatientareaid And d_Datestart < 开始时间 And
                                                 (终止时间 Is Null Or d_Dateend > 终止时间))
                                    Where Top = 1) C
                             Where a.病人id = c.病人id And a.主页id = c.主页id))
                     Order By 床号) Loop
    v_Temp := '<BR>';
    v_Temp := v_Temp || '<BRID>' || c_Patiinfo.病人id || '</BRID>';
    v_Temp := v_Temp || '<ZYID>' || c_Patiinfo.主页id || '</ZYID>';
    v_Temp := v_Temp || '<YEXH>' || c_Patiinfo.婴儿序号 || '</YEXH>';
    v_Temp := v_Temp || '<XM>' || c_Patiinfo.姓名 || '</XM>';
    v_Temp := v_Temp || '<XB>' || c_Patiinfo.性别 || '</XB>';
    v_Temp := v_Temp || '<NL>' || c_Patiinfo.年龄 || '</NL>';
    v_Temp := v_Temp || '<CH>' || c_Patiinfo.床号 || '</CH>';
    v_等级 := Getpatigrade(c_Patiinfo.病人id, c_Patiinfo.主页id, c_Patiinfo.婴儿序号, d_Datestart, d_Dateend);
    v_Temp := v_Temp || '<HLDJ>' || v_等级 || '</HLDJ>';
    v_Temp := v_Temp || Getpatidiags(c_Patiinfo.病人id, c_Patiinfo.主页id);
    v_Temp := v_Temp || '</BR>';
    Case v_等级
      When '特级护理' Then
        Select Appendchildxml(x_Templet, 'OUTPUT/BRLIST/TJHLLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      When '一级护理' Then
        Select Appendchildxml(x_Templet, 'OUTPUT/BRLIST/YJHLLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      When '二级护理' Then
        Select Appendchildxml(x_Templet, 'OUTPUT/BRLIST/EJHLLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      When '三级护理' Then
        Select Appendchildxml(x_Templet, 'OUTPUT/BRLIST/SJHLLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
      Else
        Select Appendchildxml(x_Templet, 'OUTPUT/BRLIST/SJHLLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Case;
  End Loop;
  Patiinfo_Out := x_Templet;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Hip_Getpatilisttend;
/
----------------------------------------------------------------------------
--[[17.临床路径]]
----------------------------------------------------------------------------

----------------------------------------------------------------------------
--[[18.病历业务]]
----------------------------------------------------------------------------

----------------------------------------------------------------------------
--[[19.护理业务]]
----------------------------------------------------------------------------

----------------------------------------------------------------------------
--[[20.检验业务]]
----------------------------------------------------------------------------
Create Or Replace Procedure zl_third_OldPatiReprotList
(
  Json_In  Varchar2,
  Json_Out Out Clob
) As
  ---------------------------------------------------------------------------
  --功能：获取病人检验报告列表
  --入参：Json_In:格式
  --  input            
  --      pati_id                   N  检验医嘱ID
  --      pati_source               N 病人来源，1=门诊，2=住院，4=体检
  --      pati_visit_no             C 就诊号，门诊病人传入挂号单，注意不是挂号ID，住院病人传入主页ID（住院次数），体检病人传入健康号

  --出参: Json_Out,格式如下
  --output            
  --    code                        N 0=获取报告失败，1=获取报告成功
  --    message                     C 获取报告失败时的失败原因，或者报告成功则为“成功”二字
  --    lab_report_list[]              报告列表
  --        lspcm_id                C  报告ID
  --        emg_sign                C  急诊标志，0=非急诊，1=急诊
  --        spcm_type_name          C  标本类型，血液、小便等等
  --        apply_item_name         C 申请项目
  --        sample_no               C 标本序号
  --        lab_rpt_time            C 检验时间
  --        lab_rptor               C 检验人
  --        apply_time              C 申请时间
  --        apply_dr                C 申请人
  --        lab_rpt_audit_time      C 审核时间
  --        lab_rpt_auditor         C 审核人
  --        lab_rptor_type          C 是否是微生物报告，0=不是，1=是
  --        advice_id               C 检验医嘱ID，多个医嘱一份报告，则医嘱ID之间使用英文逗号分割，传入获取报告明细的接口中时，任意传一个即可
  ---------------------------------------------------------------------------
  j_Input PLJson;
  j_Json  PLJson;

  j_Item     Clob;
  v_Temp     Varchar2(32767);
  n_rpt_cont Number := 0;

  n_病人ID   检验标本记录.病人ID%Type;
  n_病人来源 检验标本记录.病人来源%Type;
  v_就诊号   Varchar2(100);

  v_Err Varchar2(500);
  Err_Custom Exception;
Begin
  --解析入参
  j_Input := PLJson(Json_In);
  j_Json  := j_Input.Get_Pljson('input');

  n_病人ID   := j_Json.Get_Number('pati_id');
  n_病人来源 := j_Json.Get_Number('pati_source');
  v_就诊号   := j_Json.Get_String('pati_visit_no');

  For R In (Select a.Id 标本id, a.紧急, a.标本类型, a.检验项目 申请项目, a.标本序号, a.核收时间 检验时间, a.检验人, a.申请时间, a.申请人, a.审核时间, a.审核人,
                   Nvl(a.微生物标本, 0) 微生物, a.医嘱id 申请id
            From 检验标本记录 A
            Where a.病人id = n_病人id And decode(n_病人来源, 1, a.挂号单, a.主页id) = v_就诊号 And a.审核人 Is Not Null
            Order By 审核时间) Loop
  
    n_rpt_cont := n_rpt_cont + 1;
    If n_rpt_cont > 1 Then
      v_Temp := v_Temp || ',{';
    Else
      v_Temp := v_Temp || '{';
    End If;
    v_Temp := v_Temp || '"lspcm_id":"' || r.标本id || '",';
    v_Temp := v_Temp || '"emg_sign":"' || r.紧急 || '",';
    v_Temp := v_Temp || '"spcm_type_name":"' || r.标本类型 || '",';
    v_Temp := v_Temp || '"apply_item_name":"' || r.申请项目 || '",';
    v_Temp := v_Temp || '"sample_no":"' || r.标本序号 || '",';
    v_Temp := v_Temp || '"lab_rpt_time":"' || to_char(r.检验时间, 'yyyy-mm-dd hh24:mi:ss') || '",';
    v_Temp := v_Temp || '"lab_rptor":"' || r.检验人 || '",';
    v_Temp := v_Temp || '"apply_time":"' || To_Char(r.申请时间, 'YYYY-MM-DD hh24:mi:ss') || '",';
    v_Temp := v_Temp || '"apply_dr":"' || r.申请人 || '",';
    v_Temp := v_Temp || '"lab_rpt_audit_time":"' || to_char(r.审核时间, 'yyyy-mm-dd hh24:mi:ss') || '",';
    v_Temp := v_Temp || '"lab_rpt_auditor":"' || r.审核人 || '",';
    v_Temp := v_Temp || '"lab_rptor_type":"' || r.微生物 || '",';
    v_Temp := v_Temp || '"advice_id":"' || r.申请ID || '"';
    v_Temp := v_Temp || '}';
  
    If Length(Nvl(v_Temp, ' ')) > 30000 Then
      j_Item := j_Item || To_Clob(v_Temp);
      v_Temp := Null;
    End If;
  
  End Loop;

  If Not v_Temp Is Null Then
    j_Item := j_Item || To_Clob(v_Temp);
    v_Temp := Null;
  End If;

  If j_Item Is Null Then
    v_Err := '未查询到已出的报告';
    Raise Err_Custom;
  End If;

  Json_Out := To_Clob('{"output":{"code":1,"message":"成功","lab_report_list":[') || j_Item || To_Clob(']}}');

Exception
  When Err_Custom Then
    Json_Out := '{"output":{"code":0,"message":"' || v_Err || '"}}';
  When Others Then
    Json_Out := '{"output":{"code":0,"message":"' || Zltools.Zljsonstr(Sqlcode || Sqlerrm) || '"}}';
End zl_third_OldPatiReprotList;
/

Create Or Replace Procedure zl_third_oldSampleResult_Get
(
  Json_In  Varchar2,
  Json_Out Out Clob
) As
  ---------------------------------------------------------------------------
  --功能：通过检验医嘱ID获取老版检验报告
  --入参：Json_In:格式
  --  input
  --      advice_id            N  检验医嘱ID

  --出参: Json_Out,格式如下
  --普通报告
  --output            
  --code                        N 0=获取报告失败，1=获取报告成功
  --message                     C 获取报告失败时的失败原因，或者报告成功则为“成功”二字
  --lab_report[]                   报告列表
  --  sample_no                 C  标本序号
  --  pati_name                 C  病人姓名
  --  pati_sex                  C  病人性别
  --  pati_age                  C 病人年龄
  --  pati_dept_name            C 病人所在科室
  --  pati_no                   C 病人标识号，门诊号、住院号、健康号等等
  --  spcm_type_name            C 标本类型，血液、尿液等等
  --  spcm_clct_time            C 采样时间
  --  spcm_clctor               C 采样人
  --  lab_rpt_time              C 检验时间
  --  lab_rptor                 C 检验人
  --  lab_rpt_audit_time        C 审核时间
  --  lab_rpt_auditor           C 审核人
  --  lab_rptor_type            C 是否是微生物报告，1=微生物报告
  --  apply_item_name           C 申请项目名称，多个使用逗号分割
  --  lab_rpt_note              C 检验备注
  --  loitem[]                    指标列表
  --    loitem_cname            C 中文名
  --    loitem_ename            C 英文名
  --    loitem_code             C 编码
  --    loitem_result_value     C 检验结果
  --    loitem_result_status    C 结果标志
  --    loitem_result_color     C 结果颜色
  --    loitem_unit             C 单位
  --    loitem_rv               C 参考范围

  --微生物报告
  --output            
  --code                       N 0=获取报告失败，1=获取报告成功
  --message                    C 获取报告失败时的失败原因，或者报告成功则为“成功”二字
  --lab_report[]                  报告列表
  --  sample_no                C  标本序号
  --  pati_name                C  病人姓名
  --  pati_sex                 C  病人性别
  --  pati_age                 C 病人年龄
  --  pati_dept_name           C 病人所在科室
  --  pati_no                  C 病人标识号，门诊号、住院号、健康号等等
  --  spcm_type_name           C 标本类型，血液、尿液等等
  --  spcm_clct_time           C 采样时间
  --  spcm_clctor              C 采样人
  --  lab_rpt_time             C 检验时间
  --  lab_rptor                C 检验人
  --  lab_rpt_audit_time       C 审核时间
  --  lab_rpt_auditor          C 审核人
  --  lab_rptor_type           C 是否是微生物报告，1=微生物报告
  --  apply_item_name          C 申请项目名称，多个使用逗号分割
  --  lab_rpt_note             C 检验备注
  --  loitem[]                    细菌列表
  --    bctrim_cname           C  中文名
  --    bctrim_ename           C  英文名
  --    bctrim_code            C  编码
  --    cltr_desc              C  培养描述
  --    cltr_result            C  培养结果
  --    ast_list[]                药敏列表
  --      ast_cname            C  中文名
  --      ast_ename            C  英文名
  --      ast_code             C  编码
  --      ast_result           C  药敏结果
  --      ast_result_tye       C  结果类型
  --      ast_motod            C  药敏方法
  ---------------------------------------------------------------------------
  j_Input PLJson;
  j_Json  PLJson;

  j_Item Clob;

  n_医嘱ID 检验申请组合.申请ID%Type;

  v_Color      Varchar2(20);
  v_Temp       Varchar2(32767);
  n_Count      Number;
  n_rpt_cont   Number := 0;
  n_item_count Number := 0;
  n_ast_count  Number := 0;

  v_Err Varchar2(500);
  Err_Custom Exception;
Begin
  --解析入参
  j_Input := PLJson(Json_In);
  j_Json  := j_Input.Get_Pljson('input');

  n_医嘱ID := j_Json.Get_Number('advice_id');

  Select Count(1)
  Into n_Count
  From 检验标本记录 A, 病人医嘱记录 B
  Where a.医嘱id = b.Id And a.医嘱id = n_医嘱id And a.审核人 Is Not Null;
  If n_Count < 1 Then
    v_Err := '未查询到已出的报告';
    Raise Err_Custom;
  End If;

  For R In (Select a.Id 标本id, a.姓名, a.性别, a.年龄, a.标本序号, a.病人科室, a.床号, a.标识号 病历号, a.标本类型, a.审核时间, a.审核人, a.微生物标本 微生物,
                   a.检验项目 申请项目, a.采样时间, a.采样人, a.核收时间 检验时间, a.核收人 检验人, a.备注
            From 检验标本记录 A, 病人医嘱记录 B
            Where a.医嘱id = b.Id And a.医嘱id = n_医嘱id And a.审核人 Is Not Null) Loop
  
    --加入基本信息
    n_item_count := 0;
    n_rpt_cont   := n_rpt_cont + 1;
    If n_rpt_cont > 1 Then
      v_Temp := v_Temp || ',{';
    Else
      v_Temp := v_Temp || '{';
    End If;
    v_Temp := v_Temp || '"sample_no":"' || r.标本序号 || '",';
    v_Temp := v_Temp || '"pati_name":"' || r.姓名 || '",';
    v_Temp := v_Temp || '"pati_sex":"' || r.性别 || '",';
    v_Temp := v_Temp || '"pati_age":"' || r.年龄 || '",';
    v_Temp := v_Temp || '"pati_dept_name":"' || r.病人科室 || '",';
    v_Temp := v_Temp || '"pati_no":"' || r.病历号 || '",';
    v_Temp := v_Temp || '"spcm_type_name":"' || r.标本类型 || '",';
    v_Temp := v_Temp || '"spcm_clct_time":"' || to_char(r.采样时间, 'yyyy-mm-dd hh24:mi:ss') || '",';
    v_Temp := v_Temp || '"spcm_clctor":"' || r.采样人 || '",';
    v_Temp := v_Temp || '"lab_rpt_time":"' || to_char(r.检验时间, 'yyyy-mm-dd hh24:mi:ss') || '",';
    v_Temp := v_Temp || '"lab_rptor":"' || r.检验人 || '",';
    v_Temp := v_Temp || '"lab_rpt_audit_time":"' || to_char(r.审核时间, 'yyyy-mm-dd hh24:mi:ss') || '",';
    v_Temp := v_Temp || '"lab_rpt_auditor":"' || r.审核人 || '",';
    v_Temp := v_Temp || '"lab_rptor_type":"' || r.微生物 || '",';
    v_Temp := v_Temp || '"apply_item_name":"' || r.申请项目 || '",';
    v_Temp := v_Temp || '"lab_rpt_note":"' || r.备注 || '",';
  
    If r.微生物 = 0 Or r.微生物 Is Null Then
    
      v_Temp := v_Temp || '"loitem":[';
      For r_Data In (Select /*+ rule */
                     Distinct a.编码 指标代码, a.排列序号, a.中文名, a.英文名,
                              Decode(a.本次结果, '-', '阴性（-）', '+', '阳性（+）', '*', '*.**', a.本次结果) As 本次结果, a.标志, a.单位,
                              a.结果参考 参考
                     From (Select a.Id As 标本id, b.检验项目id As ID,
                                   LPad(Decode(d.排列序号, Null, Nvl(h.编码, c.编码), d.排列序号), 4, '0') As 编码,
                                   Nvl(b.排列序号, 9999) As 排列序号, c.中文名, c.英文名, b.检验结果 As 本次结果,
                                   Decode(b.结果标志, 3, '↑', 2, '↓', 1, '', 4, '异常', 5, '↓↓', 6, '↑↑', '') As 标志, d.单位, b.结果参考,
                                   Nvl(a.仪器id, -1) As 仪器id
                            From 检验标本记录 A, 检验普通结果 B, 诊治所见项目 C, 检验项目 D, 诊疗项目目录 H
                            Where a.Id = b.检验标本id And b.检验项目id = c.Id And c.Id = d.诊治项目id And b.诊疗项目id = h.Id(+) And
                                  b.记录类型 = a.报告结果 And a.Id = r.标本id
                            Union All
                            Select a.Id As 标本id, b.检验项目id As ID,
                                   LPad(Decode(d.排列序号, Null, Nvl(h.编码, c.编码), d.排列序号), 4, '0') As 编码,
                                   Nvl(b.排列序号, 9999) As 排列序号, c.中文名, c.英文名, b.检验结果 As 本次结果,
                                   Decode(b.结果标志, 3, '↑', 2, '↓', 1, '', 4, '异常', 5, '↓↓', 6, '↑↑', '') As 标志, d.单位, b.结果参考,
                                   Nvl(a.仪器id, -1) As 仪器id
                            From 检验标本记录 A, 检验标本记录 E, 检验普通结果 B, 诊治所见项目 C, 检验项目 D, 检验仪器项目 G, 诊疗项目目录 H
                            Where a.Id = b.检验标本id And b.检验项目id = c.Id And c.Id = d.诊治项目id And b.诊疗项目id = h.Id(+) And
                                  b.记录类型 = a.报告结果 And e.Id = a.合并id And e.Id = r.标本id) A, 检验仪器项目 G
                     Where a.仪器id = g.仪器id(+) And a.Id = g.项目id(+)
                     Order By a.编码, a.排列序号) Loop
      
        If r_Data.标志 = '↑↑' Then
          v_Color := '#FF0000';
        Elsif r_Data.标志 = '↓↓' Then
          v_Color := '#FF0000';
        Elsif r_Data.标志 = '异常' Then
          v_Color := '#D94600';
        Elsif r_Data.标志 = '↑' Then
          v_Color := '#FFBB77';
        Elsif r_Data.标志 = '↓' Then
          v_Color := '#FFFF37';
        Else
          v_Color := '#FFFFFF';
        End If;
        n_item_count := n_item_count + 1;
        If n_item_count > 1 Then
          v_Temp := v_Temp || ',{';
        Else
          v_Temp := v_Temp || '{';
        End If;
        v_Temp := v_Temp || '"loitem_cname":"' || zlJsonStr(r_Data.中文名) || '",';
        v_Temp := v_Temp || '"loitem_ename":"' || r_Data.英文名 || '",';
        v_Temp := v_Temp || '"loitem_code":"' || r_Data.指标代码 || '",';
        v_Temp := v_Temp || '"loitem_result_value":"' || r_Data.本次结果 || '",';
        v_Temp := v_Temp || '"loitem_result_status":"' || r_Data.标志 || '",';
        v_Temp := v_Temp || '"loitem_result_color":"' || v_Color || '",';
        v_Temp := v_Temp || '"loitem_unit":"' || r_Data.单位 || '",';
        v_Temp := v_Temp || '"loitem_rv":"' || r_Data.参考 || '"';
        v_Temp := v_Temp || '}';
      
        If Length(Nvl(v_Temp, ' ')) > 30000 Then
          j_Item := j_Item || To_Clob(v_Temp);
          v_Temp := Null;
        End If;
      
      End Loop;
      v_Temp := v_Temp || ']';
    Else
      v_Temp := v_Temp || '"loitem":[';
      --细菌结果
      For r_Main In (Select Distinct b.编码, b.Id, d.报告结果, b.中文名, b.英文名, a.检验结果 As 培养结果, a.培养描述
                     From 检验普通结果 A, 检验细菌 B, 检验标本记录 D
                     Where a.细菌id = b.Id And d.审核人 Is Not Null And d.Id = a.检验标本id And d.Id = r.标本id
                     Order By b.编码) Loop
      
        n_item_count := n_item_count + 1;
        If n_item_count > 1 Then
          v_Temp := v_Temp || ',{';
        Else
          v_Temp := v_Temp || '{';
        End If;
        v_Temp := v_Temp || '"bctrim_cname":"' || r_Main.中文名 || '",';
        v_Temp := v_Temp || '"bctrim_ename":"' || r_Main.英文名 || '",';
        v_Temp := v_Temp || '"bctrim_code":"' || r_Main.编码 || '",';
        v_Temp := v_Temp || '"cltr_desc":"' || r_Main.培养描述 || '",';
        v_Temp := v_Temp || '"cltr_result":"' || r_Main.培养结果 || '",';
        v_Temp := v_Temp || '"ast_list":[';
      
        If Length(Nvl(v_Temp, ' ')) > 30000 Then
          j_Item := j_Item || To_Clob(v_Temp);
          v_Temp := Null;
        End If;
      
        --药敏结果
        n_ast_count := 0;
        For r_Detail In (Select b.中文名, b.英文名, b.编码, a.结果 As 检验结果,
                                Decode(a.结果类型, 'R', 'R-耐药', 'I', 'I-中介', 'S', 'S-敏感', '') As 结果类型,
                                Decode(a.药敏方法, 1, '1-MIC', 2, '2-DISK', 3, '3-K-B', '') As 药敏方法
                         From 检验药敏结果 A, 检验用抗生素 B, 检验普通结果 C
                         Where a.抗生素id = b.Id And c.Id = a.细菌结果id And c.记录类型 = a.记录类型 And c.检验标本id = r.标本id And
                               c.细菌id = r_Main.Id
                         Order By b.编码) Loop
        
          n_ast_count := n_ast_count + 1;
          If n_ast_count > 1 Then
            v_Temp := v_Temp || ',{';
          Else
            v_Temp := v_Temp || '{';
          End If;
          v_Temp := v_Temp || '"ast_cname":"' || r_Detail.中文名 || '",';
          v_Temp := v_Temp || '"ast_ename":"' || r_Detail.英文名 || '",';
          v_Temp := v_Temp || '"ast_code":"' || r_Detail.编码 || '",';
          v_Temp := v_Temp || '"ast_result":"' || r_Detail.检验结果 || '",';
          v_Temp := v_Temp || '"ast_result_tye":"' || r_Detail.结果类型 || '",';
          v_Temp := v_Temp || '"ast_motod":"' || r_Detail.药敏方法 || '"';
          v_Temp := v_Temp || '}';
        
          If Length(Nvl(v_Temp, ' ')) > 30000 Then
            j_Item := j_Item || To_Clob(v_Temp);
            v_Temp := Null;
          End If;
        
        End Loop;
        v_Temp := v_Temp || ']';
        v_Temp := v_Temp || '}';
      End Loop;
      v_Temp := v_Temp || ']';
    End If;
    v_Temp := v_Temp || '}';
  End Loop;

  If Not v_Temp Is Null Then
    j_Item := j_Item || To_Clob(v_Temp);
    v_Temp := Null;
  End If;

  Json_Out := To_Clob('{"output":{"code":1,"message":"成功","lab_report":[') || j_Item || To_Clob(']}}');

Exception
  When Err_Custom Then
    Json_Out := '{"output":{"code":0,"message":"' || v_Err || '"}}';
  When Others Then
    Json_Out := '{"output":{"code":0,"message":"' || Zltools.Zljsonstr(Sqlcode || Sqlerrm) || '"}}';
End zl_third_oldSampleResult_Get;
/

Create Or Replace Function zl_third_provepatient(命令_In In Varchar2) Return Xmltype Is
  v_命令     Varchar2(4000);
  n_病人id   检验标本记录.病人ID%Type;
  v_就诊号   检验标本记录.挂号单%Type;
  v_Temp     Varchar2(32767); --临时XML
  x_Templet  Xmltype; --模板XML
  n_Type     Number; --1=产品中心调用，2=区卫调用
  d_开始时间 Date;
  d_结束时间 Date;
  n_count    Number;
  v_病人来源 Number;
Begin
  v_命令 := 命令_In;
  v_Temp := Substr(v_命令, 1, Instr(v_命令, '|') - 1);
  Begin
    v_Temp := TO_DATE(NVL(v_Temp, 'a'), 'yyyy-mm-dd hh24:mi:ss');
    n_Type := 2;
  Exception
    When Others Then
      n_Type := 1;
  End;
  If n_Type = 1 Then
    --产品中心调用
    n_病人id := to_number(Substr(v_命令, 1, Instr(v_命令, '|') - 1));
    v_命令   := Substr(v_命令, Instr(v_命令, '|') + 1);
    v_就诊号 := Substr(v_命令, 1, Instr(v_命令, '|') - 1);
  
    If length(v_就诊号) > 2 Then
      v_病人来源 := 1;
    Else
      v_病人来源 := 2;
    End If;
  
    --定义XML
    x_Templet := Xmltype('<?xml version="1.0" encoding="UTF-8" ?><ITEMLIST></ITEMLIST>');
  
    For R In (Select a.Id 标本id, a.紧急, a.检验项目, a.标本序号, Nvl(a.微生物标本, 0) 微生物, a.报告结果 检查结果, a.医嘱id, a.检验人, a.审核人,
                     To_Char(a.审核时间, 'YYYY-MM-DD hh24:mi:ss') 审核时间, To_Char(a.申请时间, 'YYYY-MM-DD hh24:mi:ss') 申请时间, a.操作类型 分类, b.诊疗项目id
              From 检验标本记录 A, 病人医嘱记录 B
              Where a.医嘱id = b.Id And a.病人id = n_病人id And decode(v_病人来源, 1, a.挂号单, a.主页id) = v_就诊号 And a.审核人 Is Not Null And
                    a.医嘱ID Is Not Null
              Order By 审核时间 Desc) Loop
      --加入基本信息
      v_Temp := '<ITEM><LX>1</LX>';
      v_Temp := v_Temp || '<ID>' || r.标本id || '</ID>';
      v_Temp := v_Temp || '<JJ>' || r.紧急 || '</JJ>';
      v_Temp := v_Temp || '<JYXM>' || r.检验项目 || '(老版)</JYXM>';
      v_Temp := v_Temp || '<BBXH>' || r.标本序号 || '</BBXH>';
      v_Temp := v_Temp || '<WSW>' || r.微生物 || '</WSW>';
      v_Temp := v_Temp || '<JGCS>' || r.检查结果 || '</JGCS>';
      v_Temp := v_Temp || '<YZID>' || r.医嘱id || '</YZID>';
      v_Temp := v_Temp || '<JYR>' || r.检验人 || '</JYR>';
      v_Temp := v_Temp || '<SHR>' || r.审核人 || '</SHR>';
      v_Temp := v_Temp || '<SHSJ>' || r.审核时间 || '</SHSJ>';
      v_Temp := v_Temp || '<SQSJ>' || r.申请时间 || '</SQSJ>';
      v_Temp := v_Temp || '<CZLX>' || r.分类 || '</CZLX>';
      v_Temp := v_Temp || '<ZLXMID>' || r.诊疗项目id || '</ZLXMID></ITEM>';
      Select Appendchildxml(x_Templet, '/ITEMLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
  Elsif n_Type = 2 Then
    --区卫调用
    d_开始时间 := to_date(Substr(v_命令, 1, Instr(v_命令, '|') - 1), 'yyyy-mm-dd hh24:mi:ss');
    v_命令     := Substr(v_命令, Instr(v_命令, '|') + 1);
    d_结束时间 := to_date(Substr(v_命令, 1, Instr(v_命令, '|') - 1), 'yyyy-mm-dd hh24:mi:ss');
    v_命令     := Substr(v_命令, Instr(v_命令, '|') + 1);
    n_病人id   := To_Number(v_命令);
  
    --定义XML
    x_Templet := Xmltype('<?xml version="1.0" encoding="UTF-8" ?><ITEMLIST></ITEMLIST>');
  
    For R In (Select a.Id 标本id, a.紧急, a.检验项目, a.标本序号, Nvl(a.微生物标本, 0) 微生物, a.报告结果 检查结果, a.医嘱id, a.检验人, a.审核人,
                     To_Char(a.审核时间, 'YYYY-MM-DD hh24:mi:ss') 审核时间, To_Char(a.申请时间, 'YYYY-MM-DD hh24:mi:ss') 申请时间, a.操作类型 分类, b.诊疗项目id, a.采样时间,
                     a.备注
              From 检验标本记录 A, 病人医嘱记录 B
              Where a.医嘱id = b.Id And a.病人id = n_病人id And a.审核人 Is Not Null And a.医嘱ID Is Not Null And
                    a.审核时间 Between d_开始时间 And d_结束时间
              Order By a.审核时间 Desc) Loop
      --加入基本信息
      v_Temp := '<ITEM><LX>1</LX>';
      v_Temp := v_Temp || '<ID>' || r.标本id || '</ID>';
      v_Temp := v_Temp || '<JJ>' || r.紧急 || '</JJ>';
      v_Temp := v_Temp || '<JYXM>' || r.检验项目 || '(老版)</JYXM>';
      v_Temp := v_Temp || '<BBXH>' || r.标本序号 || '</BBXH>';
      v_Temp := v_Temp || '<WSW>' || r.微生物 || '</WSW>';
      v_Temp := v_Temp || '<JGCS>' || r.检查结果 || '</JGCS>';
      v_Temp := v_Temp || '<YZID>' || r.医嘱id || '</YZID>';
      v_Temp := v_Temp || '<JYR>' || r.检验人 || '</JYR>';
      v_Temp := v_Temp || '<SHR>' || r.审核人 || '</SHR>';
      v_Temp := v_Temp || '<SHSJ>' || r.审核时间 || '</SHSJ>';
      v_Temp := v_Temp || '<SQSJ>' || r.申请时间 || '</SQSJ>';
      v_Temp := v_Temp || '<CYSJ>' || r.采样时间 || '</CYSJ>';
      v_Temp := v_Temp || '<JYBZ>' || r.备注 || '</JYBZ>';
      v_Temp := v_Temp || '<CZLX>' || r.分类 || '</CZLX>';
      v_Temp := v_Temp || '<ZLXMID>' || r.诊疗项目id || '</ZLXMID></ITEM>';
      Select Appendchildxml(x_Templet, '/ITEMLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    End Loop;
  End If;

  Return x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(Sqlcode, Sqlerrm);
End zl_third_provepatient;
/

Create Or Replace Function zl_third_provedata(命令_In In Varchar2) Return Xmltype Is
  v_命令   Varchar2(4000);
  n_医嘱id 检验标本记录.医嘱id%Type;
  n_标题   Varchar2(4000);
  v_Jybz   检验标本记录.检验备注%Type;
  v_Cysj   Varchar2(20);
  v_Jyr    检验标本记录.检验人%Type;
  v_Jysj   Varchar2(20);
  v_Shr    检验标本记录.审核人%Type;

  v_Color      Varchar2(20);
  v_Temp       Varchar2(32767); --临时XML
  x_Templet    Xmltype; --模板XML
  n_是否有图像 Number(1);
Begin

  v_命令   := 命令_In;
  n_医嘱id := To_Number(Substr(v_命令, 1, Instr(v_命令, '|') - 1));
  v_命令   := Substr(v_命令, Instr(v_命令, '|') + 1);
  n_标题   := Substr(v_命令, 0, Instr(v_命令, '|') - 1);
  v_命令   := Substr(v_命令, Instr(v_命令, '|') + 1);
  v_Jybz   := Substr(v_命令, 0, Instr(v_命令, '|') - 1);
  v_命令   := Substr(v_命令, Instr(v_命令, '|') + 1);
  v_Cysj   := Substr(v_命令, 0, Instr(v_命令, '|') - 1);
  v_命令   := Substr(v_命令, Instr(v_命令, '|') + 1);
  v_Jyr    := Substr(v_命令, 0, Instr(v_命令, '|') - 1);
  v_命令   := Substr(v_命令, Instr(v_命令, '|') + 1);
  v_Jysj   := Substr(v_命令, 0, Instr(v_命令, '|') - 1);
  v_命令   := Substr(v_命令, Instr(v_命令, '|') + 1);
  v_Shr    := v_命令;

  For R In (Select a.Id 标本id, a.标本序号, a.标本类型, a.住院号, a.姓名, a.性别, a.年龄, a.床号, b.开嘱医生, a.病人科室, a.微生物标本
            From 检验标本记录 A, 病人医嘱记录 B
            Where a.医嘱id = b.Id And a.医嘱id = n_医嘱id) Loop
    Begin
      --定义XML
      x_Templet := Xmltype('<?xml version="1.0" encoding="UTF-8" ?><ZLEPR></ZLEPR>');
    
      --加入基本信息
      Select Appendchildxml(x_Templet, '/ZLEPR', Xmltype('<TITLE>' || n_标题 || '</TITLE>')) Into x_Templet From Dual;
      Select Appendchildxml(x_Templet, '/ZLEPR', Xmltype('<PATI></PATI>')) Into x_Templet From Dual;
      v_Temp := '<ROW><XM>姓  名：' || r.姓名 || '</XM><XB>性  别：' || r.性别 || '</XB></ROW>';
      Select Appendchildxml(x_Templet, '/ZLEPR/PATI', Xmltype(v_Temp)) Into x_Templet From Dual;
      v_Temp := '<ROW><NL>年  龄：' || r.年龄 || '</NL><BB>标本号：' || r.标本序号 || '</BB></ROW>';
      Select Appendchildxml(x_Templet, '/ZLEPR/PATI', Xmltype(v_Temp)) Into x_Templet From Dual;
      v_Temp := '<ROW><KS>科  室：' || r.病人科室 || '</KS><CH>床  号：' || r.床号 || '</CH></ROW>';
      Select Appendchildxml(x_Templet, '/ZLEPR/PATI', Xmltype(v_Temp)) Into x_Templet From Dual;
      v_Temp := '<ROW><BS>标识号：' || r.住院号 || '</BS><LX>类  型：' || r.标本类型 || '</LX></ROW>';
      Select Appendchildxml(x_Templet, '/ZLEPR/PATI', Xmltype(v_Temp)) Into x_Templet From Dual;
    
      If r.微生物标本 = 0 Or r.微生物标本 Is Null Then
        v_Temp := '<TABLE></TABLE>';
        Select Appendchildxml(x_Templet, '/ZLEPR', Xmltype(v_Temp)) Into x_Templet From Dual;
        For r_Data In (Select /*+ rule */
                       Distinct a.标本id, a.诊疗项目id, a.编码, a.排列序号, a.固定项目, a.Id, a.检验项目, a.缩写 As 英文名, a.Cv,
                                Decode(a.本次结果, '-', '阴性（-）', '+', '阳性（+）', '*', '*.**', a.本次结果) As 本次结果, Rownum As 序号,
                                a.标志, a.仪器id, a.标本类别, a.核收时间, a.标本序号, a.标本号显示, a.检验备注, a.姓名, a.性别, a.年龄, a.门诊号, a.住院号,
                                a.当前床号, a.主页id, a.结果范围, Nvl(g.小数位数, 2) As 小数, a.警戒上限, a.警戒下限, a.单位,
                                Trim(Replace(Replace(' ' || Zlgetreference(a.Id, a.标本类型, Decode(a.性别, '男', 1, '女', 2, 0),
                                                                            a.出生日期, a.仪器id, a.年龄), ' .', '0.'), '～.', '～0.')) As 参考,
                                a.Od, a.Cutoff, a.Cov, a.酶标板id, a.变异报警, a.变异警示, a.结果类型, a.结果参考
                       From (Select a.Id As 标本id, b.诊疗项目id,
                                     LPad(Decode(d.排列序号, Null, Nvl(h.编码, c.编码), d.排列序号), 4, '0') As 编码,
                                     Nvl(b.排列序号, 9999) As 排列序号, Decode(b.诊疗项目id, Null, 0, 1) As 固定项目, b.检验项目id As ID,
                                     c.中文名 || Decode(d.缩写, Null, '', '(' || d.缩写 || ')') As 检验项目, d.缩写, b.原始结果, '' As 上次结果,
                                     '' As 上次时间, '' As Cv, b.检验结果 As 本次结果, d.计算公式, d.结果类型,
                                     Decode(b.结果标志, 3, '↑', 2, '↓', 1, '', 4, '异常', 5, '↓↓', 6, '↑↑', '') As 标志,
                                     Nvl(a.仪器id, -1) As 仪器id, Nvl(a.标本类别, 0) As 标本类别, a.核收时间, a.标本序号,
                                     Decode(a.仪器id, Null,
                                             To_Char(Trunc(a.标本序号 / 10000) + 1, '0000') || '-' ||
                                              To_Char(Mod(a.标本序号, 10000), '0000'), a.标本序号) As 标本号显示, a.检验备注, a.姓名, a.性别,
                                     a.年龄, a.标本类型, a.出生日期, a.门诊号, a.住院号, a.床号 As 当前床号, a.主页id, d.结果范围, d.警戒上限, d.警戒下限, d.单位,
                                     b.Od, b.Cutoff, b.Sco As Cov, b.酶标板id, d.变异报警率 As 变异报警, d.变异警示率 As 变异警示, b.结果参考
                              From 检验标本记录 A, 检验普通结果 B, 诊治所见项目 C, 检验项目 D, 诊疗项目目录 H
                              Where a.Id = b.检验标本id And b.检验项目id = c.Id And c.Id = d.诊治项目id And b.诊疗项目id = h.Id(+) And
                                    b.记录类型 = a.报告结果 And a.Id = r.标本id
                              Union All
                              Select a.Id As 标本id, b.诊疗项目id,
                                     LPad(Decode(d.排列序号, Null, Nvl(h.编码, c.编码), d.排列序号), 4, '0') As 编码,
                                     Nvl(b.排列序号, 9999) As 排列序号, Decode(b.诊疗项目id, Null, 0, 1) As 固定项目, b.检验项目id As ID,
                                     c.中文名 || Decode(d.缩写, Null, '', '(' || d.缩写 || ')') As 检验项目, d.缩写, b.原始结果, '' As 上次结果,
                                     '' As 上次时间, '' As Cv, b.检验结果 As 本次结果, d.计算公式, d.结果类型,
                                     Decode(b.结果标志, 3, '↑', 2, '↓', 1, '', 4, '异常', 5, '↓↓', 6, '↑↑', '') As 标志,
                                     Nvl(a.仪器id, -1) As 仪器id, Nvl(a.标本类别, 0) As 标本类别, a.核收时间, a.标本序号,
                                     Decode(a.仪器id, Null,
                                             To_Char(Trunc(a.标本序号 / 10000) + 1, '0000') || '-' ||
                                              To_Char(Mod(a.标本序号, 10000), '0000'), a.标本序号) As 标本号显示, a.检验备注, a.姓名, a.性别,
                                     a.年龄, a.标本类型, a.出生日期, a.门诊号, a.住院号, a.床号 As 当前床号, a.主页id, d.结果范围, d.警戒上限, d.警戒下限, d.单位,
                                     b.Od, b.Cutoff, b.Sco As Cov, b.酶标板id, d.变异报警率 As 变异报警, d.变异警示率 As 变异警示, b.结果参考
                              From 检验标本记录 A, 检验标本记录 E, 检验普通结果 B, 诊治所见项目 C, 检验项目 D, 检验仪器项目 G, 诊疗项目目录 H
                              Where a.Id = b.检验标本id And b.检验项目id = c.Id And c.Id = d.诊治项目id And b.诊疗项目id = h.Id(+) And
                                    b.记录类型 = a.报告结果 And e.Id = a.合并id And e.Id = r.标本id) A, 检验仪器项目 G
                       Where a.仪器id = g.仪器id(+) And a.Id = g.项目id(+)
                       Order By a.编码, a.排列序号) Loop
        
          --检验项目|英文名|本次结果,标志|单位|参考
          If r_Data.标志 = '↑↑' Then
            v_Color := '#FF0000';
          Elsif r_Data.标志 = '↓↓' Then
            v_Color := '#FF0000';
          Elsif r_Data.标志 = '异常' Then
            v_Color := '#D94600';
          Elsif r_Data.标志 = '↑' Then
            v_Color := '#FFBB77';
          Elsif r_Data.标志 = '↓' Then
            v_Color := '#FFFF37';
          Else
            v_Color := '#FFFFFF';
          End If;
        
          If v_Color = '#FFFFFF' Then
            v_Temp := '<ROW><COL>' || r_Data.检验项目 || '</COL>' || '<COL>' || r_Data.英文名 || '</COL>' || '<COL><![CDATA[' ||
                      r_Data.本次结果 || ']]>' || ' ' || r_Data.标志 || '</COL>' || '<COL>' || r_Data.单位 || '</COL>' ||
                      '<COL>' || r_Data.参考 || '</COL></ROW>' || Chr(13) || Chr(10);
          Else
            v_Temp := '<ROW><COL>' || r_Data.检验项目 || '</COL>' || '<COL>' || r_Data.英文名 || '</COL>' || '<COL YS="' ||
                      v_Color || '"><![CDATA[' || r_Data.本次结果 || ']]>' || ' ' || r_Data.标志 || '</COL>' || '<COL>' ||
                      r_Data.单位 || '</COL>' || '<COL>' || r_Data.参考 || '</COL></ROW>' || Chr(13) || Chr(10);
          End If;
          Select Appendchildxml(x_Templet, '/ZLEPR/TABLE', Xmltype(v_Temp)) Into x_Templet From Dual;
        End Loop;
      Else
        v_Temp := '<TABLE></TABLE>';
        Select Appendchildxml(x_Templet, '/ZLEPR', Xmltype(v_Temp)) Into x_Templet From Dual;
        For r_Main In (Select Distinct b.编码, b.Id, d.报告结果, b.中文名 As 检验项目, a.检验结果 As 检验结果, a.培养描述 As 结果描述, '' As 上次结果
                       From 检验普通结果 A, 检验细菌 B, 检验标本记录 D
                       Where a.细菌id = b.Id And d.审核人 Is Not Null And d.Id = a.检验标本id And d.Id = r.标本id
                       Order By b.编码) Loop
        
          v_Temp := '<ROW><COL>' || r_Main.检验项目 || '</COL>' || '<COL><![CDATA[' || r_Main.检验结果 || ']]>' || '</COL>' ||
                    '<COL></COL>' || '<COL></COL>' || '<COL>' || r_Main.结果描述 || '</COL></ROW>';
          Select Appendchildxml(x_Templet, '/ZLEPR/TABLE', Xmltype(v_Temp)) Into x_Templet From Dual;
        
          For r_Detail In (Select c.细菌id As Key, b.Id, b.中文名 As 抗生素名称, a.结果 As 检验结果,
                                  Decode(a.结果类型, 'R', 'R-耐药', 'I', 'I-中介', 'S', 'S-敏感', '') As 结果类型,
                                  Decode(a.药敏方法, 1, '1-MIC', 2, '2-DISK', 3, '3-K-B', '') As 药敏方法
                           From 检验药敏结果 A, 检验用抗生素 B, 检验普通结果 C
                           Where a.抗生素id = b.Id And c.Id = a.细菌结果id And c.记录类型 = a.记录类型 And c.检验标本id = r.标本id And
                                 c.细菌id = r_Main.Id
                           Order By b.编码) Loop
          
            v_Temp := '<ROW><COL>' || r_Detail.抗生素名称 || '</COL>' || '<COL>' || r_Detail.药敏方法 || '</COL>' ||
                      '<COL><![CDATA[' || r_Detail.检验结果 || ']]>' || '</COL>' || '<COL>' || r_Detail.结果类型 || '</COL>' ||
                      '<COL></COL></ROW>';
            Select Appendchildxml(x_Templet, '/ZLEPR/TABLE', Xmltype(v_Temp)) Into x_Templet From Dual;
          End Loop;
        End Loop;
      End If;
    
      --获取是否存在图片
      Select decode(Count(*), 0, 0, 1) Into n_是否有图像 From 检验图像结果 Where 标本ID = r.标本ID;
      Select Appendchildxml(x_Templet, '/ZLEPR', Xmltype('<PIC>' || n_是否有图像 || '</PIC>'))
      Into x_Templet
      From Dual;
    
      --添加表下内容
      Select Appendchildxml(x_Templet, '/ZLEPR', Xmltype('<INFO></INFO>')) Into x_Templet From Dual;
      v_Temp := '<ROW>采样日期：' || v_Cysj || '$$$$$检验日期：' || v_Jysj || '$$$$$检验医师：' || v_Jyr || '$$$$$审核医师：' || v_Shr ||
                '</ROW>';
      Select Appendchildxml(x_Templet, '/ZLEPR/INFO', Xmltype(v_Temp)) Into x_Templet From Dual;
      v_Temp := '<ROW>备注：' || v_Jybz || '</ROW>';
      Select Appendchildxml(x_Templet, '/ZLEPR/INFO', Xmltype(v_Temp)) Into x_Templet From Dual;
      v_Temp := '<ROW>**此结果仅对本标本负责**    您的健康是我们最大的追求，祝您早日康复！</ROW>';
      Select Appendchildxml(x_Templet, '/ZLEPR/INFO', Xmltype(v_Temp)) Into x_Templet From Dual;
    Exception
      When Others Then
        Null;
    End;
  End Loop;

  Return x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(Sqlcode, Sqlerrm);
End zl_third_provedata;
/

----------------------------------------------------------------------------
--[[21.检查业务]]
----------------------------------------------------------------------------
CREATE OR REPLACE Function Zl_Third_Pacs_Geteproutline
(
  报告id_In In 病人医嘱报告.病历id%Type
) Return Varchar2 Is
  v_报告提纲 Varchar2(1000);

  Cursor c_报告提纲 Is
    Select Distinct a.内容文本
    From 电子病历内容 A, 电子病历内容 B, 病人医嘱报告 C
    Where a.对象类型 = 3 And a.Id = b.父id And b.对象类型 = 2 And b.终止版 = 0 And a.文件id = c.病历id And c.病历id = 报告id_In;
Begin
  For Row_Cols In c_报告提纲 Loop
    v_报告提纲 := '[split]' || Row_Cols.内容文本 || v_报告提纲;
  End Loop;

  Return(Substr(v_报告提纲, 8));

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Pacs_Geteproutline;
/

CREATE OR REPLACE Function zl_third_pacs_GetDocOutline
(
  报告id_In In 病人医嘱报告.检查报告ID%Type
) Return Varchar2 Is
  v_报告提纲 Varchar2(1000);
  v_提纲内容 Varchar2(100);

  x_Content xmltype;
  n_NodeNum number(2);
  Xcdom            Xmldom.Domdocument;
  Section_List     Xmldom.Domnodelist;
Begin
    v_报告提纲 := '';

    Select b.报告内容 Into x_Content From 病人医嘱报告 a, 影像报告记录 b Where a.检查报告id=b.id And  a.检查报告id = 报告id_In;

    Xcdom         := Xmldom.Newdomdocument(x_Content);
    Section_List  := Xmldom.Getelementsbytagname(Xcdom, 'section');
    n_NodeNum     := Xmldom.Getlength(Section_List);

    For i in 0..n_NodeNum-1 Loop
      v_提纲内容 := Xmldom.Getattribute(Xmldom.Makeelement(Xmldom.Item(Section_List, i)), 'title');

      If Nvl(v_提纲内容,' ') != ' ' Then
        v_报告提纲 := v_报告提纲 || '[split]' || v_提纲内容;
      End If;
    End Loop;

    Return(Substr(v_报告提纲, 8));
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End zl_third_pacs_GetDocOutline;
/

CREATE OR REPLACE FUNCTION zl_third_pacs_getdoctxt
(
  报告ID_In In varchar2,
  报告提纲_In In 影像报告记录.诊断意见%Type
) Return Varchar2 Is
  x_Content        xmltype;
  Xcdom            Xmldom.Domdocument;
  Section_List     Xmldom.Domnodelist;
  Section_Node     Xmldom.Domnode;
  Node_List        Xmldom.Domnodelist;
  n_Len            Number;
  Element_Node     Xmldom.Domnode;
  p_Node           Xmldom.Domnode;
  Enum_Node        Xmldom.Domnode;
  e_Node           Xmldom.Domnodelist;
  c_Node           Xmldom.Domnode;
  Enumeration_List Xmldom.Domnodelist;
  Enumeration_Node Xmldom.Domnode;
  Item_List        Xmldom.Domnodelist;
  Item_Node        Xmldom.Domnode;
  Item_Node1       Xmldom.Domnode;
  v_Name           Varchar2(100);
  v_Result         Varchar2(4000);
  n_i              Number;
  n_Num            Number;
  n_j              Number;
  n_Enum           Number;
  v_Enum           Varchar2(4000);
  v_Val            Varchar2(20);
  v_Content        Varchar2(4000);
  v_Multisel       Varchar2(10);
Begin
    v_Result := '';

    Select 报告内容 Into x_Content From 影像报告记录 Where id = 报告ID_In;

    --Select Deletexml(x_Content, '//image') Into x_Content From Dual;

    Xcdom := Xmldom.Newdomdocument(x_Content);

    For Myrow In (Select Column_Value Name From Table(f_Str2list(报告提纲_In))) Loop
      n_i := -1;
      --循环提纲名称
      Section_List := Xmldom.Getelementsbytagname(Xcdom, 'section');
      n_Len        := Xmldom.Getlength(Section_List);

      For I In 0 .. n_Len - 1 Loop
        If Xmldom.Getattribute(Xmldom.Makeelement(Xmldom.Item(Section_List, I)), 'title') = Myrow.Name Then
          n_i := I;
          Exit;
        End If;
      End Loop;

      If n_i >= 0 Then
        Section_Node := Xmldom.Item(Section_List, n_i);
        Node_List    := Xmldom.Getelementsbytagname(Xmldom.Makeelement(Section_Node), '*');
        n_Len        := Xmldom.Getlength(Node_List);

        For I In 0 .. n_Len - 1 Loop
          Element_Node := Xmldom.Item(Node_List, I);
          v_Name       := Xmldom.Getnodename(Element_Node);

          If Xmldom.Getattribute(Xmldom.Makeelement(Element_Node), 'isdeleted') = '1' Then
             Null;
          Else

            If v_Name = 'element' Then
              If Xmldom.Getattribute(Xmldom.Makeelement(Element_Node), 'unit') Is Not Null Then
                v_Content := Xmldom.Getnodevalue(Xmldom.Getfirstchild(Element_Node));

                If Instr(v_Content, 'textstyleno') > 0 Then
                  v_Content := '';
                End If;
                --如果有单位
                v_Result := v_Result || v_Content || Xmldom.Getattribute(Xmldom.Makeelement(Element_Node), 'unit');
              Else
                p_Node := Xmldom.Getparentnode(Element_Node);
                If Xmldom.Getnodename(p_Node) <> 'enumvalues' Then
                  v_Result := v_Result || Xmldom.Getnodevalue(Xmldom.Getfirstchild(Element_Node));
                End If;
              End If;
            Elsif v_Name = 'utext' Then
              If nvl(Xmldom.Getattribute(Xmldom.Makeelement(Element_Node), 'br'),'1') <> '0' Then
                v_Result := v_Result || Chr(13) || chr(10);
              End If;

              v_Result := v_Result || LTrim(LTrim(Xmldom.Getnodevalue(Xmldom.Getfirstchild(Element_Node)), ':'), '：');
            Elsif v_Name = 'e_list' Or v_Name = 'e_enum' Or v_Name = 'e_etree' Or v_Name = 'e_utree' Then
              Enumeration_List := Xmldom.Getelementsbytagname(Xmldom.Makeelement(Element_Node), 'enumeration');
              n_Num            := Xmldom.Getlength(Enumeration_List);

              If v_Name = 'e_enum' And n_Num > 0 Then
                For J In 0 .. n_Num - 1 Loop
                  Enumeration_Node := Xmldom.Item(Enumeration_List, J);
                  Item_List        := Xmldom.Getelementsbytagname(Xmldom.Makeelement(Element_Node), 'item');
                  n_j              := Xmldom.Getlength(Item_List);

                  For K In 0 .. n_j - 1 Loop
                    Item_Node := Xmldom.Item(Item_List, K);
                    If Xmldom.Getattribute(Xmldom.Makeelement(Item_Node), 'checked') = '1' Then
                      v_Val := Xmldom.Getattribute(Xmldom.Makeelement(Item_Node), 'val');

                      For Z In 0 .. n_j - 1 Loop
                        Item_Node1 := Xmldom.Item(Item_List, Z);
                        If Xmldom.Getattribute(Xmldom.Makeelement(Item_Node1), 'val') = v_Val And
                           Xmldom.Getattribute(Xmldom.Makeelement(Item_Node1), 'issymbol') = '0' Then
                          v_Result := v_Result || Xmldom.Getnodevalue(Xmldom.Getfirstchild(Item_Node1));
                          Exit;
                        End If;
                      End Loop;
                    End If;
                  End Loop;
                End Loop;
              Else
                --这里处理枚举有无的情况
                v_Enum := Xmldom.getNodeValue(xmldom.getFirstChild(Element_Node));

                if v_Enum Is Null Or Instr(v_Enum, 'rangexml=') <= 0  Then
                  Enumeration_List := xmldom.getChildNodes(Element_Node);
                  n_j := Xmldom.Getlength(Enumeration_List);

                  For j In 0 .. n_j - 1  Loop
                      v_Enum := Xmldom.getNodeValue(Xmldom.Item(Enumeration_List,n_j-j-1));
                      If Instr(v_Enum, 'rangexml=') > 0 Then
                        Exit;
                      End If;
                  End Loop;

                End If;

                v_Enum := Replace(v_Enum, 'rangexml=', '');
                v_Enum := Replace(v_Enum, '''', '');

                Select Extractvalue(XmlType(v_Enum), '/root/multisel') Into v_Multisel From Dual;

                If v_Multisel = 2 And v_Name = 'e_enum' Then
                  --为是否类型的枚举
                  v_Result := v_Result || Xmldom.Getnodevalue(Xmldom.getLastChild(Element_Node));
                Else
                  Enum_Node := Xmldom.Item(Xmldom.Getelementsbytagname(Xmldom.Makeelement(Element_Node), 'enumvalues'), 0);
                  e_Node := Xmldom.Getelementsbytagname(Xmldom.Makeelement(Enum_Node), 'element');
                  n_Enum := Xmldom.Getlength(e_Node);

                  For K In 0 .. n_Enum - 1 Loop
                    c_Node   := Xmldom.Item(e_Node, K);
                    v_Result := v_Result || Xmldom.Getattribute(Xmldom.Makeelement(c_Node), 'showtext');

                    If K <> n_Enum - 1 Then
                      v_Result := v_Result || '、';
                    End If;
                  End Loop;
                End If;
              End If;
            End If;
          End If; --isdelete
        End Loop;
      End If;
    End Loop;

    Xmldom.Freedocument(Xcdom);

    Return  LTrim(RTrim(v_Result, Chr(13) || chr(10)), Chr(13) || Chr(10));
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End zl_third_pacs_getdoctxt;
/

CREATE OR REPLACE Function zl_third_pacs_geteprtxt
(
  报告ID_In   In Number,
  报告来源_In In Number,
  报告提纲_In In Varchar2
) Return Varchar2 Is
  Type t_Str_Table Is Table Of Varchar2(4000);
  a_Return t_Str_Table := t_Str_Table();

  v_Return        Varchar2(4000);
  v_Temp          Varchar2(4000);
  n_Count         Number(2);
  n_病历ID        Number(18);

  v_Sql           Varchar2(1000);
Begin
  n_病历ID := 报告id_In;
  v_Return       := '';

  If 报告来源_In = 2 Then
     v_Sql := 'Select 病历ID From 病人医嘱报告 Where RISID=:1';
     Execute Immediate v_Sql Into n_病历ID Using 报告id_In;
  End If;

  Begin
    Select Decode(是否换行, 1, 内容文本 || Chr(10) || Chr(13), 内容文本) Bulk Collect
    Into a_Return
    From 电子病历内容
    Where 终止版 = 0  And 对象类型 In(2,4) And 文件id = n_病历ID
    and 内容行次 = 1 ---- 添加条件 过滤磁共振传过来 医生签名
    
    Start With  父id = (Select ID From 电子病历内容 Where 文件id = n_病历ID And 内容文本 = 报告提纲_In And 对象类型 = 1)
    Connect By Prior ID=父ID
    Order By 对象序号;

    For n_Count In 1 .. a_Return.Count Loop
      If v_Return Is Null Then
        If n_Count = 1 Then
          v_Temp := a_Return(n_Count);
          If Instr(v_Temp,报告提纲_In) <> 1 Then
            v_Return := v_Temp;
          End If;
        Else
          v_Return := a_Return(n_Count);
        End If;

      Else
        v_Return := v_Return || a_Return(n_Count);
      End If;
    End Loop;

  Exception
    When Others Then
      v_Return := Null;
  End;

  Begin
    If v_Return Is Null Then
      Select Decode(是否换行, 1, 内容文本 || Chr(10) || Chr(13), 内容文本) Bulk Collect
      Into a_Return
      From 电子病历内容
      Where 终止版 = 0  And 对象类型 In(2,4) And 文件id = n_病历ID
      Start With  父id = (Select ID From 电子病历内容 Where 文件id = n_病历ID And 内容文本 = 报告提纲_In And 对象类型 = 3)
      Connect By Prior ID=父ID
      Order By 对象序号;

      For n_Count In 1 .. a_Return.Count Loop
        If v_Return Is Null Then
          v_Return := a_Return(n_Count);
        Else
          v_Return := v_Return || a_Return(n_Count);
        End If;
      End Loop;

    End If;
  Exception
    When Others Then
      v_Return := Null;
  End;

  If v_Return Is Null Then
    Select Decode(是否换行, 1, 内容文本 || Chr(10) || Chr(13), 内容文本) Bulk Collect
    Into a_Return
    From 电子病历内容
    Where 终止版 = 0  And Substr(对象属性,1,1) = '0' And 文件id = n_病历ID
    Start With  父id = (Select ID From 电子病历内容 Where 文件id = n_病历ID And 内容文本 = 报告提纲_In And 对象类型 = 1)
    Connect By Prior ID=父ID
    Order By 对象序号;

    For n_Count In 1 .. a_Return.Count Loop
        If v_Return Is Null Then
          If n_Count = 1 Then
            v_Temp := a_Return(n_Count);
            If Instr(v_Temp,报告提纲_In) <> 1 Then
              v_Return := v_Temp;
            End If;
          Else
            v_Return := a_Return(n_Count);
          End If;

        Else
          v_Return := v_Return || a_Return(n_Count);
        End If;
    End Loop;
  End If;

  Return v_Return;
End zl_third_pacs_geteprtxt;
/


CREATE OR REPLACE Procedure Zl_Third_Pacs_GetRPTContent
(
  Json_In  Varchar2,
  Json_Out Out Varchar2
) As
  --input
  --  advice_id             N    医嘱ID

  --output
  --  code                  C    应答码：0-失败；1-成功
  --  message               C    应答消息
  --  data
  --    advice_id           N    医嘱ID
  --    pati_name           C    病人姓名
  --    pati_sex            C    病人性别
  --    pati_age            C    病人年龄
  --    visit_no            C    就诊号(门诊号/住院号)
  --    apply_dept          C    申请科室
  --    apply_doctor        C    申请医生
  --    exam_item           C    检查项目
  --    exam_no             C    检查号
  --    exam_time           C    检查时间
  --    type                N    报告类型: 0 基本  1 智能报告编辑器  2专业版
  --    rpts[]
  --      id                C    报告ID
  --      name              C    报告名称
  --      doctor            C    报告医生
  --      time              C    报告时间
  --      positive          N    报告阳性
  --      pdf_addr          C    PDF地址
  --      outlines[]
  --         name           C    提纲名称
  --         content        C    提纲内容

  j_Json  PLJson;
  j_Input PLJson;

  v_Pati_Name    Varchar2(100); --病人姓名
  v_Pati_Sex     Varchar2(10); --病人性别
  v_Pati_Age     Varchar2(20); --病人年龄
  v_Visit_No     Varchar2(20); --就诊号(门诊号/住院号)
  v_Apply_Dept   Varchar2(100); --申请科室
  v_Apply_Doctor Varchar2(20); --申请医生

  v_Item_Id    Varchar2(64); --报告ID
  v_Item_Yznr  Varchar2(1024); --检查项目
  v_Exam_No    Varchar2(64); --检查号
  v_Exam_Time  Varchar2(1024); --检查时间
  Dt_Exam_Time Date;

  v_Item_Type Number(1); --报告类型

  v_Item_Bgr     Varchar2(64); --报告医生
  Dt_Item_Bgsj   Date;
  v_Item_Bgsj    Varchar2(64); --报告时间
  n_Item_Bgyx    Number(1); --报告阳性
  v_Item_Ip      Varchar2(128); --IP
  v_Item_Ftp     Varchar2(64); --FTP
  v_Item_Rptname Varchar2(128); --报告名称

  v_Outtline_Name Varchar2(64); --提纲名称
  v_Outtline_Txt  Varchar2(1024); --提纲内容

  v_报告提纲_Tmp Varchar2(1024);

  n_医嘱id Number(18);
  n_病历id Number(18);

  v_Tempaddr    Varchar2(1024);
  v_Temp        Varchar2(32767);
  v_Temprpt     Varchar2(32767);
  v_Tempoutline Varchar2(1024);

  n_Flag_Rpt     Number(1);
  n_Flag_Outline Number(1);

  n_Instr Number(5);

  Type c_Report_List Is Ref Cursor;
  c_Report_Item c_Report_List;
Begin

  j_Input  := PLJson(Json_In);
  j_Json   := j_Input.Get_Pljson('input');
  n_医嘱id := Nvl(j_Json.Get_Number('advice_id'), 0);

  --首先模拟已经获取数据的情况构造json输出  1份报告的情况
  --strtest:='成功读取医嘱ID=' || n_医嘱ID;
  --报告类型=0   n_病历ID := To_Number(V_report_id);
  v_Temprpt  := '';
  v_Temp     := '{"output":{"code":1,"message":"成功","data":[';
  n_Flag_Rpt := 0;

  Open c_Report_Item For
    Select b.病历id || '' As ID, a.医嘱内容 As Yxnr, c.保存人 As Bgr,
           (Case When c.完成时间 is not null Then c.完成时间 Else e.完成时间 End) Bgsj, 
		   Nvl(e.结果阳性, 0) As Bgyx, g.Ip地址, g.Ftp目录, c.病历名称 As Mc, d.检查号, 
		   (case when d.接收日期 is null then e.报到时间 else d.接收日期 end) as 接收日期
    From 病人医嘱记录 A, 病人医嘱报告 B, 电子病历记录 C, 影像检查记录 D, 病人医嘱发送 E, 影像流程参数 F, 影像设备目录 G
    Where f.参数名(+) = 'PDF转换存储设备' And g.设备号(+) = f.参数值 And a.执行科室id = f.科室id(+) And a.Id = b.医嘱id And b.病历id = c.Id And
          a.Id = e.医嘱id And a.诊疗类别 = 'D' And 相关id Is Null And b.Risid Is Null And c.完成时间 Is Not Null And
          a.Id = d.医嘱id(+) And a.医嘱期效 = 1 And a.医嘱状态 In (3, 5, 6, 7, 8) And (e.执行状态 = 1 Or e.执行过程 > 4) And
          a.Id = n_医嘱id;
  Loop
    Fetch c_Report_Item
      Into v_Item_Id, v_Item_Yznr, v_Item_Bgr, Dt_Item_Bgsj, n_Item_Bgyx, v_Item_Ip, v_Item_Ftp, v_Item_Rptname,
           v_Exam_No, Dt_Exam_Time;

    Exit When c_Report_Item%NotFound;
    If n_Flag_Rpt = 1 Then
      v_Temprpt := v_Temprpt || ',';
    End If;
    v_Item_Type := 0;
    n_Flag_Rpt  := 1;
    n_病历id    := To_Number(v_Item_Id);
    Select Zl_Third_Pacs_Geteproutline(n_病历id) Into v_报告提纲_Tmp From Dual;

    If v_报告提纲_Tmp Is Null Then
      --没有报告提纲
      v_Tempoutline := '';
    Else
      n_Instr := Instr(v_报告提纲_Tmp, '[split]');
      If n_Instr > 0 Then
        n_Flag_Outline := 0;
        Loop
          n_Instr := Instr(v_报告提纲_Tmp, '[split]');
          If v_报告提纲_Tmp Is Null Then
            Exit;
          End If;

          If Length(v_报告提纲_Tmp) > Length('[split]') Then
            v_Outtline_Name := Substr(v_报告提纲_Tmp, 1, Instr(v_报告提纲_Tmp, '[split]') - 1);
          Else
            If Length(v_报告提纲_Tmp) > 0 Then
              v_Outtline_Name := v_报告提纲_Tmp;
            Else
              Exit;
            End If;
          End If;
          Select Zl_Third_Pacs_Geteprtxt(n_病历id, 0, v_Outtline_Name) Into v_Outtline_Txt From Dual;

          v_Outtline_Txt := Replace(v_Outtline_Txt, Chr(10), '\r');
          v_Outtline_Txt := Replace(v_Outtline_Txt, Chr(13), '\n');

          v_报告提纲_Tmp := Substr(v_报告提纲_Tmp, n_Instr + 7);

          --处理提纲名称和提纲内容
          If n_Flag_Outline = 1 Then
            v_Tempoutline := v_Tempoutline || ',';
          End If;
          v_Tempoutline  := v_Tempoutline || '{';
          v_Tempoutline  := v_Tempoutline || '"name":"' || v_Outtline_Name;
          v_Tempoutline  := v_Tempoutline || '","content":"' || v_Outtline_Txt;
          v_Tempoutline  := v_Tempoutline || '"}';
          n_Flag_Outline := 1;

        End Loop;
      End If;

      v_Tempoutline := v_Tempoutline || ']';
    End If;

    v_Tempaddr := '';
    If v_Item_Ip Is Not Null Then
      --v_Tempaddr:='ftp://192.168.33.100/ct/1012.PDF';
      If v_Item_Ftp Is Not Null Then
        v_Tempaddr := 'ftp://' || v_Item_Ip || '/' || v_Item_Ftp || '/' || n_病历id || '.PDF';
      Else
        v_Tempaddr := 'ftp://' || v_Item_Ip || '/' || n_病历id || '.PDF';
      End If;
    End If;
    If Dt_Item_Bgsj Is Not Null Then
      v_Item_Bgsj := To_Char(Dt_Item_Bgsj, 'yyyy-mm-dd hh24:mi:ss');
    End If;

    v_Temprpt := v_Temprpt || '{';
    v_Temprpt := v_Temprpt || '"id":"' || v_Item_Id;
    v_Temprpt := v_Temprpt || '","name":"' || v_Item_Rptname;
    v_Temprpt := v_Temprpt || '","doctor":"' || v_Item_Bgr;
    v_Temprpt := v_Temprpt || '","time":"' || v_Item_Bgsj;
    v_Temprpt := v_Temprpt || '","positive":' || n_Item_Bgyx;
    v_Temprpt := v_Temprpt || ',"pdf_addr":"' || v_Tempaddr;
    v_Temprpt := v_Temprpt || '","outlines":[' || v_Tempoutline;
    v_Temprpt := v_Temprpt || '}';

  End Loop;

  Close c_Report_Item;

  --报告类型=1   智能报告编辑器
  Open c_Report_Item For
    Select b.检查报告id || '' As ID, a.医嘱内容 As Yznr, c.最后编辑人 As Bgr, c.最后审核时间 As Bgsj, Nvl(c.结果阳性, 0) As Bgyx, c.文档标题 As Mc,
           d.检查号, d.接收日期
    From 病人医嘱记录 A, 病人医嘱报告 B, 影像报告记录 C, 影像检查记录 D, 病人医嘱发送 E
    Where a.Id = b.医嘱id And b.检查报告id = c.Id And a.Id = e.医嘱id And a.诊疗类别 = 'D' And 相关id Is Null And
          c.最后审核时间 Is Not Null And a.Id = d.医嘱id(+) And a.医嘱期效 = 1 And a.医嘱状态 In (3, 5, 6, 7, 8) And
          (e.执行状态 = 1 Or e.执行状态 > 4) And a.Id = n_医嘱id;
  Loop
    Fetch c_Report_Item
      Into v_Item_Id, v_Item_Yznr, v_Item_Bgr, Dt_Item_Bgsj, n_Item_Bgyx, v_Item_Rptname, v_Exam_No, Dt_Exam_Time;

    Exit When c_Report_Item%NotFound;

    If Dt_Item_Bgsj Is Not Null Then
      v_Item_Bgsj := To_Char(Dt_Item_Bgsj, 'yyyy-mm-dd hh24:mi:ss');
    End If;

    If n_Flag_Rpt = 1 Then
      v_Temprpt := v_Temprpt || ',';
    End If;
    v_Item_Type := 1;
    n_Flag_Rpt  := 1;

    Select Zl_Third_Pacs_Getdocoutline(v_Item_Id) Into v_报告提纲_Tmp From Dual;
    If v_报告提纲_Tmp Is Null Then
      --没有报告提纲
      v_Tempoutline := '';
    Else
      v_报告提纲_Tmp := v_报告提纲_Tmp || '[split]';
      n_Instr        := Instr(v_报告提纲_Tmp, '[split]');
      If n_Instr > 0 Then
        n_Flag_Outline := 0;
        v_Tempoutline  := '';
        Loop
          n_Instr := Instr(v_报告提纲_Tmp, '[split]');
          If v_报告提纲_Tmp Is Null Then
            Exit;
          End If;

          If Length(v_报告提纲_Tmp) > Length('[split]') Then
            v_Outtline_Name := Substr(v_报告提纲_Tmp, 1, Instr(v_报告提纲_Tmp, '[split]') - 1);
          Else
            If Length(v_报告提纲_Tmp) > 0 Then
              v_Outtline_Name := v_报告提纲_Tmp;
            Else
              Exit;
            End If;
          End If;
          Select Zl_Third_Pacs_Getdoctxt(v_Item_Id, v_Outtline_Name) Into v_Outtline_Txt From Dual;

          v_Outtline_Txt := Replace(v_Outtline_Txt, Chr(10), '\r');
          v_Outtline_Txt := Replace(v_Outtline_Txt, Chr(13), '\n');

          v_报告提纲_Tmp := Substr(v_报告提纲_Tmp, n_Instr + 7);

          --处理提纲名称和提纲内容
          If n_Flag_Outline = 1 Then
            v_Tempoutline := v_Tempoutline || ',';
          End If;
          v_Tempoutline  := v_Tempoutline || '{';
          v_Tempoutline  := v_Tempoutline || '"name":"' || v_Outtline_Name;
          v_Tempoutline  := v_Tempoutline || '","content":"' || v_Outtline_Txt;
          v_Tempoutline  := v_Tempoutline || '"}';
          n_Flag_Outline := 1;

        End Loop;
      End If;

      v_Tempoutline := v_Tempoutline || ']';
    End If;

    --智能报告编辑器PDF地址为空;
    v_Tempaddr := '';
    v_Temprpt  := v_Temprpt || '{';
    v_Temprpt  := v_Temprpt || '"id":"' || v_Item_Id;
    v_Temprpt  := v_Temprpt || '","name":"' || v_Item_Rptname;
    v_Temprpt  := v_Temprpt || '","doctor":"' || v_Item_Bgr;
    v_Temprpt  := v_Temprpt || '","time":"' || v_Item_Bgsj;
    v_Temprpt  := v_Temprpt || '","positive":' || n_Item_Bgyx;
    v_Temprpt  := v_Temprpt || ',"pdf_addr":"' || v_Tempaddr;
    v_Temprpt  := v_Temprpt || '","outlines":[' || v_Tempoutline;
    v_Temprpt  := v_Temprpt || '}';

  End Loop;
  Close c_Report_Item;

  --报告类型=2
  Open c_Report_Item For
    Select b.Risid || '' As ID, a.医嘱内容 As Yznr, c.保存人 As Bgr,
           (Case
             When c.完成时间 > e.完成时间 Then
              c.完成时间
             Else
              e.完成时间
           End) Bgsj, Nvl(e.结果阳性, 0) As Bgyx, c.病历名称 As Mc, d.检查号, d.接收日期
    From 病人医嘱记录 A, 病人医嘱报告 B, 电子病历记录 C, 影像检查记录 D, 病人医嘱发送 E
    Where a.Id = b.医嘱id And b.病历id = c.Id And a.Id = e.医嘱id And a.诊疗类别 = 'D' And 相关id Is Null And b.Risid Is Not Null And
          c.完成时间 Is Not Null And a.Id = d.医嘱id(+) And a.医嘱期效 = 1 And a.医嘱状态 In (3, 5, 6, 7, 8) And
          (e.执行状态 = 1 Or e.执行状态 > 4) And a.Id = n_医嘱id;
  Loop
    Fetch c_Report_Item
      Into v_Item_Id, v_Item_Yznr, v_Item_Bgr, Dt_Item_Bgsj, n_Item_Bgyx, v_Item_Rptname, v_Exam_No, Dt_Exam_Time;

    Exit When c_Report_Item%NotFound;

    If Dt_Item_Bgsj Is Not Null Then
      v_Item_Bgsj := To_Char(Dt_Item_Bgsj, 'yyyy-mm-dd hh24:mi:ss');
    End If;

    If n_Flag_Rpt = 1 Then
      v_Temprpt := v_Temprpt || ',';
    End If;
    v_Item_Type := 2;
    n_Flag_Rpt  := 1;
    n_病历id    := To_Number(v_Item_Id);
    Select Zl_Third_Pacs_Geteproutline(n_病历id) Into v_报告提纲_Tmp From Dual;

    If v_报告提纲_Tmp Is Null Then
      --没有报告提纲
      v_Tempoutline := '';
    Else
      n_Instr := Instr(v_报告提纲_Tmp, '[split]');
      If n_Instr > 0 Then
        n_Flag_Outline := 0;
        v_Tempoutline  := '';
        Loop
          n_Instr := Instr(v_报告提纲_Tmp, '[split]');
          If v_报告提纲_Tmp Is Null Then
            Exit;
          End If;

          If Length(v_报告提纲_Tmp) > Length('[split]') Then
            v_Outtline_Name := Substr(v_报告提纲_Tmp, 1, Instr(v_报告提纲_Tmp, '[split]') - 1);
          Else
            If Length(v_报告提纲_Tmp) > 0 Then
              v_Outtline_Name := v_报告提纲_Tmp;
            Else
              Exit;
            End If;
          End If;
          Select Zl_Third_Pacs_Geteprtxt(n_病历id, 0, v_Outtline_Name) Into v_Outtline_Txt From Dual;
          v_Outtline_Txt := Replace(v_Outtline_Txt, Chr(10), '\r');
          v_Outtline_Txt := Replace(v_Outtline_Txt, Chr(13), '\n');

          v_报告提纲_Tmp := Substr(v_报告提纲_Tmp, n_Instr + 7);

          --处理提纲名称和提纲内容
          If n_Flag_Outline = 1 Then
            v_Tempoutline := v_Tempoutline || ',';
          End If;
          v_Tempoutline  := v_Tempoutline || '{';
          v_Tempoutline  := v_Tempoutline || '"name":"' || v_Outtline_Name;
          v_Tempoutline  := v_Tempoutline || '","content":"' || v_Outtline_Txt;
          v_Tempoutline  := v_Tempoutline || '"}';
          n_Flag_Outline := 1;

        End Loop;
      End If;

      v_Tempoutline := v_Tempoutline || ']';
    End If;

    v_Tempaddr := '';

    v_Temprpt := v_Temprpt || '{';
    v_Temprpt := v_Temprpt || '"id":"' || v_Item_Id;
    v_Temprpt := v_Temprpt || '","name":"' || v_Item_Rptname;
    v_Temprpt := v_Temprpt || '","doctor":"' || v_Item_Bgr;
    v_Temprpt := v_Temprpt || '","time":"' || v_Item_Bgsj;
    v_Temprpt := v_Temprpt || '","positive":' || n_Item_Bgyx;
    v_Temprpt := v_Temprpt || ',"pdf_addr":"' || v_Tempaddr;
    v_Temprpt := v_Temprpt || '","outlines":[' || v_Tempoutline;
    v_Temprpt := v_Temprpt || '}';

  End Loop;
  Close c_Report_Item;

  v_Temprpt := v_Temprpt || ']}';
  If v_Item_Yznr Is Null Then
    --todo
    v_Temp := '{"output":{"code":0,"message":"使用医嘱ID[' || n_医嘱id || ']没找到数据"}}';
  Else
    --读取病人申请基本信息
    Select a.姓名, a.性别, a.年龄, Nvl(b.住院号, c.门诊号) As 就诊号, d.名称 As 申请科室, a.开嘱医生 As 申请医生
    Into v_Pati_Name, v_Pati_Sex, v_Pati_Age, v_Visit_No, v_Apply_Dept, v_Apply_Doctor
    From 病人医嘱记录 A, 病案主页 B, 病人挂号记录 C, 部门表 D
    Where a.病人id = b.病人id(+) And a.主页id = b.主页id(+) And a.病人id = c.病人id(+) And a.挂号单 = c.No(+) And a.开嘱科室id = d.Id(+) And
          a.Id = n_医嘱id;

    If Dt_Exam_Time Is Not Null Then
      v_Exam_Time := To_Char(Dt_Exam_Time, 'yyyy-mm-dd hh24:mi:ss');
    End If;

    v_Temp := v_Temp || '{';
    v_Temp := v_Temp || '"advice_id":' || n_医嘱id;
    v_Temp := v_Temp || ',"pati_name":"' || v_Pati_Name;
    v_Temp := v_Temp || '","pati_sex":"' || v_Pati_Sex;
    v_Temp := v_Temp || '","pati_age":"' || v_Pati_Age;
    v_Temp := v_Temp || '","visit_no":"' || v_Visit_No;
    v_Temp := v_Temp || '","apply_dept":"' || v_Apply_Dept;
    v_Temp := v_Temp || '","apply_doctor":"' || v_Apply_Doctor;
    v_Temp := v_Temp || '","exam_item":"' || v_Item_Yznr;
    v_Temp := v_Temp || '","exam_no":"' || v_Exam_No;
    v_Temp := v_Temp || '","exam_time":"' || v_Exam_Time;
    v_Temp := v_Temp || '","type":' || v_Item_Type;
    v_Temp := v_Temp || ',"rpts":[' || v_Temprpt;
    v_Temp := v_Temp || ']}}';
  End If;

  Json_Out := v_Temp;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Pacs_GetRPTContent;
/

CREATE OR REPLACE PROCEDURE Zl_Third_Pacs_Getadvreportlist
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) As
  ---------------------------------------------------------------------------
  --入参数 Xml_In
  --<IN>
  --  <YZID>1162695</YZID>   --医嘱id
  --</IN>

  --出参 Xml_Out
  --成功：
  --<OUTPUT>
  --   <MSG>提示信息,有内容则提示,有内容说明失败</MSG>
  --   <ORDER_LIST>       //如果为空表示没有找到数据
  --     <ID> </ID>
  --     <YZID>1# </YZID>
  --     <YZNR>1# </YZNR>
  --     <MC>1# </MC>
  --     <BGLX>1# </BGLX>
  --     <BGR>1# </BGR>
  --     <BGSJ>1# </BGSJ>
  --     <BGYX>1# </BGYX>
  --   </ORDER_LIST>
  --   <ORDER_LIST>
  --     <ID> </ID>
  --     <YZID>1# </YZID>
  --     <YZNR>1# </YZNR>
  --     <MC>1# </MC>
  --     <BGLX>1# </BGLX>
  --     <BGR>1# </BGR>
  --     <BGSJ>1# </BGSJ>
  --     <BGYX>1# </BGYX>
  --   </ORDER_LIST>
  --</OUTPUT>


  Type c_Report_List Is Ref Cursor;
  c_Report_Item c_Report_List;

  v_TempXML   Varchar2(2000);
  n_order_id NUMBER;

  x_Templet Xmltype; --模板XML

  n_Item_Id   Varchar2(64);
  n_Item_Yzid Number(18);
  v_Item_Yznr Varchar2(1024);
  v_Item_Mc   Varchar2(60);
  n_Item_Bglx Number(18);
  v_Item_Bgr  Varchar2(64);
  v_ITEM_BGSJ     Varchar2(64);
  dt_ITEM_BGSJ    DATE;
  n_Item_Bgyx Number(1);
Begin

  Select Extractvalue(Value(A), 'IN/YZID')
  Into n_order_id
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Open c_Report_Item FOR SELECT b.病历id || '' As ID, a.Id As YZID, a.医嘱内容 As YXNR, c.病历名称 as MC, 0 As BGLX, c.保存人 As BGR,
    (CASE WHEN c.完成时间 >e.完成时间 THEN c.完成时间 ELSE e.完成时间 END) BGSJ ,nvl(E.结果阳性,0) as BGYX
    From 病人医嘱记录 A, 病人医嘱报告 B, 电子病历记录 C, 影像检查记录 D, 病人医嘱发送 E
    Where a.Id = b.医嘱id And b.病历id = c.Id And A.Id=E.医嘱ID And a.诊疗类别 = 'D' And 相关id Is Null And B.RISID Is Null And
    c.完成时间 Is Not Null And a.Id = d.医嘱id(+) And a.医嘱期效 = 1 And a.医嘱状态 In (3, 5, 6, 7, 8) And (E.执行状态 = 1 Or E.执行状态>4) And
    a.ID = n_order_id;
  Loop
    Fetch c_Report_Item
      Into n_Item_Id, n_Item_Yzid, v_Item_Yznr, v_Item_Mc, n_Item_Bglx, v_Item_Bgr, dt_ITEM_BGSJ, n_Item_Bgyx;
    Exit When c_Report_Item%NotFound;
    
    IF dt_ITEM_BGSJ IS NOT NULL THEN
      v_Item_Bgsj:=to_char(dt_ITEM_BGSJ,'yyyy-mm-dd hh24:mi:ss');
    END IF;

    v_TempXML := '<ORDER_LIST>';
    v_TempXML := v_TempXML || '<ID>' || n_Item_Id || '</ID>';
    v_TempXML := v_TempXML || '<YZID>' || n_Item_Yzid || '</YZID>';
    v_TempXML := v_TempXML || '<YZNR>' || v_Item_Yznr || '</YZNR>';
    v_TempXML := v_TempXML || '<MC>' || v_Item_Mc || '</MC>';
    v_TempXML := v_TempXML || '<BGLX>' || n_Item_Bglx || '</BGLX>';
    v_TempXML := v_TempXML || '<BGR>' || v_Item_Bgr || '</BGR>';
    v_TempXML := v_TempXML || '<BGSJ>' || v_Item_Bgsj || '</BGSJ>';
    v_TempXML := v_TempXML || '<BGYX>' || n_Item_Bgyx || '</BGYX>';
    v_TempXML := v_TempXML || '</ORDER_LIST>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_TempXML)) Into x_Templet From Dual;
  End Loop;
  Close c_Report_Item;

  Open c_Report_Item FOR Select b.检查报告id || '' As ID, a.Id As YZID, a.医嘱内容 As YZNR, c.文档标题 As MC, 1 as BGLX, c.最后编辑人 As BGR, c.最后审核时间 As BGSJ,nvl(C.结果阳性,0) as BGYX
      From 病人医嘱记录 A, 病人医嘱报告 B, 影像报告记录 C, 影像检查记录 D, 病人医嘱发送 E
      where a.Id = b.医嘱id And b.检查报告id = c.Id And A.Id=E.医嘱ID And a.诊疗类别 = 'D' And 相关id Is Null And
      c.最后审核时间 Is Not Null And a.Id = d.医嘱id(+) And a.医嘱期效 = 1 And a.医嘱状态 In (3, 5, 6, 7, 8) And (E.执行状态 = 1 Or E.执行状态>4 ) And
      a.id = n_order_id;
  Loop
    Fetch c_Report_Item
      Into n_Item_Id, n_Item_Yzid, v_Item_Yznr, v_Item_Mc, n_Item_Bglx, v_Item_Bgr, dt_ITEM_BGSJ, n_Item_Bgyx;
    Exit When c_Report_Item%NotFound;
    
    IF dt_ITEM_BGSJ IS NOT NULL THEN
      v_Item_Bgsj:=to_char(dt_ITEM_BGSJ,'yyyy-mm-dd hh24:mi:ss');
    END IF;

    v_TempXML := '<ORDER_LIST>';
    v_TempXML := v_TempXML || '<ID>' || n_Item_Id || '</ID>';
    v_TempXML := v_TempXML || '<YZID>' || n_Item_Yzid || '</YZID>';
    v_TempXML := v_TempXML || '<YZNR>' || v_Item_Yznr || '</YZNR>';
    v_TempXML := v_TempXML || '<MC>' || v_Item_Mc || '</MC>';
    v_TempXML := v_TempXML || '<BGLX>' || n_Item_Bglx || '</BGLX>';
    v_TempXML := v_TempXML || '<BGR>' || v_Item_Bgr || '</BGR>';
    v_TempXML := v_TempXML || '<BGSJ>' || v_Item_Bgsj || '</BGSJ>';
    v_TempXML := v_TempXML || '<BGYX>' || n_Item_Bgyx || '</BGYX>';
    v_TempXML := v_TempXML || '</ORDER_LIST>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_TempXML)) Into x_Templet From Dual;
  End Loop;
  Close c_Report_Item;

  Open c_Report_Item FOR Select b.RISID || '' As ID, a.Id As YZID, a.医嘱内容 As YZNR, c.病历名称 As MC, 2 as BGLX, c.保存人 As BGR, (CASE WHEN c.完成时间 >e.完成时间 THEN c.完成时间 ELSE e.完成时间 END) BGSJ,nvl(E.结果阳性,0) as BGYX
      From 病人医嘱记录 A, 病人医嘱报告 B, 电子病历记录 C, 影像检查记录 D, 病人医嘱发送 E
      Where a.Id = b.医嘱id And b.病历ID = c.Id And A.Id=E.医嘱ID And a.诊疗类别 = 'D' And 相关id Is Null And B.RISID Is Not Null And
      c.完成时间 Is Not Null And a.Id = d.医嘱id(+) And a.医嘱期效 = 1 And a.医嘱状态 In (3, 5, 6, 7, 8) And (E.执行状态 = 1 Or E.执行状态>4 ) And
      a.id = n_order_id;
  Loop
    Fetch c_Report_Item
      Into n_Item_Id, n_Item_Yzid, v_Item_Yznr, v_Item_Mc, n_Item_Bglx, v_Item_Bgr, dt_ITEM_BGSJ, n_Item_Bgyx;
    Exit When c_Report_Item%NotFound;

    IF dt_ITEM_BGSJ IS NOT NULL THEN
      v_Item_Bgsj:=to_char(dt_ITEM_BGSJ,'yyyy-mm-dd hh24:mi:ss');
    END IF;
      
    v_TempXML := '<ORDER_LIST>';
    v_TempXML := v_TempXML || '<ID>' || n_Item_Id || '</ID>';
    v_TempXML := v_TempXML || '<YZID>' || n_Item_Yzid || '</YZID>';
    v_TempXML := v_TempXML || '<YZNR>' || v_Item_Yznr || '</YZNR>';
    v_TempXML := v_TempXML || '<MC>' || v_Item_Mc || '</MC>';
    v_TempXML := v_TempXML || '<BGLX>' || n_Item_Bglx || '</BGLX>';
    v_TempXML := v_TempXML || '<BGR>' || v_Item_Bgr || '</BGR>';
    v_TempXML := v_TempXML || '<BGSJ>' || v_Item_Bgsj || '</BGSJ>';
    v_TempXML := v_TempXML || '<BGYX>' || n_Item_Bgyx || '</BGYX>';
    v_TempXML := v_TempXML || '</ORDER_LIST>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_TempXML)) Into x_Templet From Dual;
  End Loop;
  Close c_Report_Item;

  Xml_Out := x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
END Zl_Third_Pacs_Getadvreportlist;
/

CREATE OR REPLACE PROCEDURE zl_third_pacs_getreportoutline
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) AS
  v_报告提纲 Varchar2(2000);
  n_病历ID Number(18);
  v_TempXML   Varchar2(2000);
  x_Templet Xmltype; --模板XML
  v_report_id Varchar2(64);
  n_report_type Number(2);
    --入参数 Xml_In
  --<IN>
  --  <ID>11111</ID>   --报告ID
  --  <BGLX>1</BGLX>   --报告类型
  --</IN>

  --出参 Xml_Out
  --<OUTPUT>
  --   <MSG>提示信息,有内容则提示,有内容说明失败</MSG>
  --   <OUTLINE>提纲</OUTLINE>
  --</OUTPUT>
Begin
  Select Extractvalue(Value(A), 'IN/ID'),Extractvalue(Value(A), 'IN/BGLX')
  Into v_report_id,n_report_type
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  If n_report_type = 1 THEN
    Select Zl_Third_Pacs_Getdocoutline(v_report_id) INTO v_报告提纲 From Dual;
  Else
    n_病历ID := To_Number(V_report_id);

    If n_report_type = 2 THEN
      Select 病历ID INTO n_病历ID From 病人医嘱报告 Where RISID=v_report_id;
    End If;
    
    
    Select Zl_Third_Pacs_Geteproutline(n_病历ID) INTO v_报告提纲  From Dual;
  End If;

  v_TempXML := v_TempXML || '<OUTLINE>' || v_报告提纲 || '</OUTLINE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_TempXML)) Into x_Templet From Dual;
  Xml_Out:=x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End zl_third_pacs_getreportoutline;
/

CREATE OR REPLACE PROCEDURE Zl_Third_Pacs_Getoutlinetxt
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) AS
  v_report_id    VARCHAR2(64);
  n_report_type  NUMBER(5);
  v_report_outline  VARCHAR2(100);
  v_TempXML   Varchar2(2000);
  x_Templet Xmltype; --模板XML
  v_Result        Varchar2(4000);
  v_Singleresult  Varchar2(4000);
  --入参 Xml_In
  --<IN>
  --  <ID>11111</ID>   --报告ID
  --  <BGLX>1</BGLX>   --报告类型
  --  <OUTLINE>检查所见</OUTLINE>   --报告ID
  --</IN>

  --出参 Xml_Out
  --<OUTPUT>
  --   <MSG>提示信息,有内容则提示,有内容说明失败</MSG>
  --   <OUTLINETXT>提纲内容</OUTLINETXT>
  --</OUTPUT>
Begin
  v_Result       := '';
  v_Singleresult := '';

  Select Extractvalue(Value(A), 'IN/ID'),Extractvalue(Value(A), 'IN/BGLX'),Extractvalue(Value(A), 'IN/OUTLINE')
  Into v_report_id,n_report_type,v_report_outline
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If n_report_type = 1 THEN
    Select Zl_Third_Pacs_Getdoctxt(v_report_id,v_report_outline) INTO v_Singleresult From Dual;
  ELSE
    Select Zl_Third_Pacs_Geteprtxt(v_report_id, n_report_type, v_report_outline) INTO v_Singleresult From Dual;
  End If;

  IF Not v_Singleresult Is Null Then
    v_Result := v_Singleresult;
  End If;
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  v_TempXML := v_TempXML || '<OUTLINETXT>' || v_Result || '</OUTLINETXT>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_TempXML)) Into x_Templet From Dual;
  Xml_Out:=x_Templet;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End zl_third_pacs_getOutlinetxt;
/


CREATE OR REPLACE PROCEDURE Zl_Third_Pacs_Getpatirptlist
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) AS

  TYPE C_REPORT_LIST IS REF CURSOR;
  C_REPORT_ITEM C_REPORT_LIST;

  v_Sql    Varchar2(4000);
  v_sqldate Varchar2(4000);
  v_sqlfrom  Varchar2(4000);
  v_TempXML   Varchar2(2000);
  x_Templet Xmltype; --模板XML

  n_ITEM_Id       Varchar2(64);
  n_ITEM_YZID     Number(18);
  v_ITEM_GP       Varchar2(64);
  v_Item_Yznr     Varchar2(1024);
  v_Item_Mc       Varchar2(60);
  n_ITEM_BGLX     Number(18);
  v_ITEM_BGR      Varchar2(64);
  v_ITEM_BGSJ     Varchar2(64);
  dt_ITEM_BGSJ    DATE;

  v_patiid  NUMBER(18);--病人ID
  v_jzid    NUMBER(18);--就诊ID
  v_brlx    NUMBER(1);
  v_Start VARCHAR2(400);
  v_End  VARCHAR2(400);

  --入参 Xml_In
  --<IN>
  --  <BRID>584</BRID>   --病人ID
  --  <JZID>1</JZID>       --就诊ID    住院：主页ID  门诊：挂号单ID
  --  <BRLX>123</BRLX>       --病人来源  1-门诊  2-住院
  --  <KSSJ>2020-1-1</KSSJ>       --开始时间
  --  <JSSJ>2020-2-30</JSSJ>       --结束时间
  --</IN>

  --出参 Xml_Out
  --<OUTPUT>
  --   <MSG>提示信息,有内容则提示,有内容说明失败</MSG>
  --   <ORDER_LIST>       //如果为空表示没有找到数据
  --     <ID></ID>
  --     <YZID></YZID>
  --     <GP>0</GP>
  --     <YZNR></YZNR>
  --     <MC></MC>
  --     <BGLX>1# </BGLX>
  --     <BGR>1# </BGR>
  --     <BGSJ>1# </BGSJ>
  --     <BGYX>1# </BGYX>
  --   </ORDER_LIST>
  --   <ORDER_LIST>
  --     <ID> </ID>
  --     <YZID></YZID>
  --     <GP>0</GP>
  --     <YZNR>1# </YZNR>
  --     <MC>1# </MC>
  --     <BGLX>1# </BGLX>
  --     <BGR>1# </BGR>
  --     <BGSJ>1# </BGSJ>
  --     <BGYX>1# </BGYX>
  --   </ORDER_LIST>
  --</OUTPUT>

Begin

    Select Extractvalue(Value(A), 'IN/BRID'),Extractvalue(Value(A), 'IN/JZID'),Extractvalue(Value(A), 'IN/BRLX'),
    Extractvalue(Value(A), 'IN/KSSJ'),Extractvalue(Value(A), 'IN/JSSJ')
    Into v_patiid,v_jzid,v_brlx,v_Start,v_End
    From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

    --数据检查规则
    --1 必须同时有就诊ID和病人类型
    --2 开始时间和结束时间必须同时出现或者不出现，否则显示错误信息
    v_sqlfrom:='';
    IF v_jzid IS NOT NULL AND v_brlx IS NOT NULL THEN
       IF v_brlx = 1 THEN
         v_sqlfrom :=' And nvl(f.id,0) ='|| v_jzid;
       ELSE
         v_sqlfrom :=' And nvl(a.主页id,0) ='|| v_jzid;
       END IF;
    ELSE
      zl_ErrorCenter(SQLCode, '缺少就诊ID或者病人类型');
    END IF;
    
    
    v_sqldate := '';
    IF v_Start IS NOT NULL AND v_end IS NOT NULL THEN
       v_Start:=v_Start || ' 00:00:00';
       v_end:=v_end || ' 23:59:59';
       v_sqldate:=' And E.完成时间 >= To_Date('''|| v_Start ||''', ''yyyy-mm-dd hh24:mi:ss'') And E.完成时间 <= To_Date('''|| v_end ||''', ''yyyy-mm-dd hh24:mi:ss'')';
    Elsif (v_Start IS NULL  AND v_end IS NOT NULL) OR (v_Start IS NOT NULL  AND v_end IS NULL) then
       zl_ErrorCenter(SQLCode, '请同时传入开始时间和结束时间');
    END IF;

    v_Sql := 'Select b.病历id || '''' As ID, a.Id As YZID, Decode(d.检查uid, Null, 0, 1) As GP,a.医嘱内容 As YXNR, c.病历名称 as MC, 0 As BGLX, c.保存人 As BGR, c.完成时间 As BGSJ
                    From 病人医嘱记录 A, 病人医嘱报告 B, 电子病历记录 C, 影像检查记录 D, 病人医嘱发送 E,病人挂号记录 F
                    Where a.Id = b.医嘱id And b.病历id = c.Id And A.Id=E.医嘱ID And a.诊疗类别 = ''D'' And 相关id Is Null And
                    c.完成时间 Is Not Null And a.Id = d.医嘱id(+) And a.医嘱期效 = 1 And a.医嘱状态 In (3, 5, 6, 7, 8)  And F.NO(+)=A.挂号单 And E.执行状态=1 And
                    a.病人id = '|| v_patiid || v_sqlfrom || v_sqldate ;

    Open C_REPORT_ITEM For v_Sql;

    x_Templet := Xmltype('<OUTPUT></OUTPUT>');

    Loop
      Fetch C_REPORT_ITEM INTO n_ITEM_ID, n_ITEM_YZID, v_ITEM_GP,v_Item_Yznr, v_ITEM_MC, n_ITEM_BGLX, v_ITEM_BGR, dt_ITEM_BGSJ;
      Exit When C_REPORT_ITEM%NotFound;
      
      IF dt_ITEM_BGSJ IS NOT NULL THEN
        v_Item_Bgsj:=to_char(dt_ITEM_BGSJ,'yyyy-mm-dd hh24:mi:ss');
      END IF;

      v_TempXML := '<ORDER_LIST>';
      v_TempXML := v_TempXML || '<ID>' || n_Item_Id || '</ID>';
      v_TempXML := v_TempXML || '<YZID>' || n_Item_Yzid || '</YZID>';
      v_TempXML := v_TempXML || '<GP>' || v_ITEM_GP || '</GP>';
      v_TempXML := v_TempXML || '<YZNR>' || v_Item_Yznr || '</YZNR>';
      v_TempXML := v_TempXML || '<MC>' || v_Item_Mc || '</MC>';
      v_TempXML := v_TempXML || '<BGLX>' || n_Item_Bglx || '</BGLX>';
      v_TempXML := v_TempXML || '<BGR>' || v_Item_Bgr || '</BGR>';
      v_TempXML := v_TempXML || '<BGSJ>' || v_Item_Bgsj || '</BGSJ>';
      v_TempXML := v_TempXML || '</ORDER_LIST>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_TempXML)) Into x_Templet From Dual;

    End Loop;
    Close C_REPORT_ITEM;

    v_Sql := 'Select b.检查报告id || '''' As ID, a.Id As YZID, Decode(d.检查uid, Null, 0, 1) As GP, a.医嘱内容 As YZNR, c.文档标题 As MC, 1 as BGLX, c.最后编辑人 As BGR, c.最后审核时间 As BGSJ
              From 病人医嘱记录 A, 病人医嘱报告 B, 影像报告记录 C, 影像检查记录 D, 病人医嘱发送 E,病人挂号记录 F
              where a.Id = b.医嘱id And b.检查报告id = c.Id And A.Id=E.医嘱ID And a.诊疗类别 = ''D'' And 相关id Is Null And
              c.最后审核时间 Is Not Null And a.Id = d.医嘱id(+) And a.医嘱期效 = 1 And a.医嘱状态 In (3, 5, 6, 7, 8) And F.NO(+)=A.挂号单 And E.执行状态=1 And
              a.病人id ='|| v_patiid || v_sqlfrom || v_sqldate ;
    Open C_REPORT_ITEM For v_Sql;

    Loop
      Fetch C_REPORT_ITEM INTO n_ITEM_ID, n_ITEM_YZID, v_ITEM_GP,v_Item_Yznr, v_ITEM_MC, n_ITEM_BGLX, v_ITEM_BGR, dt_ITEM_BGSJ;
      Exit When C_REPORT_ITEM%NotFound;
                
      IF dt_ITEM_BGSJ IS NOT NULL THEN
        v_Item_Bgsj:=to_char(dt_ITEM_BGSJ,'yyyy-mm-dd hh24:mi:ss');
      END IF;
               
      v_TempXML := '<ORDER_LIST>';
      v_TempXML := v_TempXML || '<ID>' || n_Item_Id || '</ID>';
      v_TempXML := v_TempXML || '<YZID>' || n_Item_Yzid || '</YZID>';
      v_TempXML := v_TempXML || '<GP>' || v_ITEM_GP || '</GP>';
      v_TempXML := v_TempXML || '<YZNR>' || v_Item_Yznr || '</YZNR>';
      v_TempXML := v_TempXML || '<MC>' || v_Item_Mc || '</MC>';
      v_TempXML := v_TempXML || '<BGLX>' || n_Item_Bglx || '</BGLX>';
      v_TempXML := v_TempXML || '<BGR>' || v_Item_Bgr || '</BGR>';
      v_TempXML := v_TempXML || '<BGSJ>' || v_Item_Bgsj || '</BGSJ>';
      v_TempXML := v_TempXML || '</ORDER_LIST>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_TempXML)) Into x_Templet From Dual;

    End Loop;
    Close C_REPORT_ITEM;

    v_Sql := 'Select b.RISID || '''' As ID, a.Id As YZID, 2 As GP,a.医嘱内容 As YXNR, c.病历名称 as MC, 2 as BGLX, c.保存人 As BGR, c.完成时间 As BGSJ
              From 病人医嘱记录 A, 病人医嘱报告 B, 电子病历记录 C, 影像检查记录 D, 病人医嘱发送 E,病人挂号记录 F
              Where a.Id = b.医嘱id And b.病历ID = c.Id And A.Id=E.医嘱ID And a.诊疗类别 = ''D'' And 相关id Is Null And B.RISID Is Not Null And
              c.完成时间 Is Not Null And a.Id = d.医嘱id(+) And a.医嘱期效 = 1 And a.医嘱状态 In (3, 5, 6, 7, 8) And F.NO(+)=A.挂号单 And E.执行状态=1 And
              a.病人id ='|| v_patiid || v_sqlfrom || v_sqldate ;


    Open C_REPORT_ITEM For v_Sql;

    Loop
      Fetch C_REPORT_ITEM INTO n_ITEM_ID, n_ITEM_YZID, v_ITEM_GP,v_Item_Yznr, v_ITEM_MC, n_ITEM_BGLX, v_ITEM_BGR, dt_ITEM_BGSJ;
      Exit When C_REPORT_ITEM%NotFound;
                
      IF dt_ITEM_BGSJ IS NOT NULL THEN
        v_Item_Bgsj:=to_char(dt_ITEM_BGSJ,'yyyy-mm-dd hh24:mi:ss');
      END IF;             

      v_TempXML := '<ORDER_LIST>';
      v_TempXML := v_TempXML || '<ID>' || n_Item_Id || '</ID>';
      v_TempXML := v_TempXML || '<YZID>' || n_Item_Yzid || '</YZID>';
      v_TempXML := v_TempXML || '<GP>' || v_ITEM_GP || '</GP>';
      v_TempXML := v_TempXML || '<YZNR>' || v_Item_Yznr || '</YZNR>';
      v_TempXML := v_TempXML || '<MC>' || v_Item_Mc || '</MC>';
      v_TempXML := v_TempXML || '<BGLX>' || n_Item_Bglx || '</BGLX>';
      v_TempXML := v_TempXML || '<BGR>' || v_Item_Bgr || '</BGR>';
      v_TempXML := v_TempXML || '<BGSJ>' || v_Item_Bgsj || '</BGSJ>';
      v_TempXML := v_TempXML || '</ORDER_LIST>';
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_TempXML)) Into x_Templet From Dual;

    End Loop;
    Close C_REPORT_ITEM;
    Xml_Out := x_Templet;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Pacs_Getpatirptlist;
/

CREATE OR REPLACE Procedure Zl_Third_PACSGetPatSchedule
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取患者的检查预约记录
  --入参:Xml_In:
  --  <IN>
  --  <PATIENTID>病人ID</PATIENTID>
  --  </IN>
  --出参:Xml_Out
  --<OUTPUT>
  --<SCHINFO>
  --<ADVICEID>医嘱ID</ADVICEID>
  --<CHECKID>诊疗项目ID</CHECKID>
  --<ADVICEDOC>医嘱内容</ADVICEDOC>
  --<MACHINENAME>预约设备名称</MACHINENAME>
  --<MACHINEID>预约设备ID</MACHINEID>
  --<ROOMNAME>诊室名称</ROOMNAME>
  --<SEGBEGINTIME>开始时间段</SEGBEGINTIME>
  --<SEGENDTIME>结束时间段</SEGENDTIME>
  --<SCHBEGINTIME>开始时间</SCHBEGINTIME>
  --<SCHENDTIME>结束时间</SCHENDTIME>
  --</SCHINFO>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Error Varchar(255);
  Err_Custom Exception;
  v_Tmp    Varchar2(2000);
  n_病人ID 病人信息.病人ID%Type;
Begin

  Xml_Out := Xmltype('<OUTPUT></OUTPUT>');

  --提取入参
  Select Extractvalue(Value(A), 'IN/PATIENTID') Into n_病人ID From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  For R In (Select b.医嘱id, a.诊疗项目id, a.医嘱内容, b.预约设备名称, b.预约设备id, b.诊室名称, b.预约开始时间段, b.预约结束时间段, b.预约开始时间, b.预约结束时间
            From 病人医嘱记录 A, 影像预约记录 B
            Where a.id = b.医嘱ID And B.是否检查 = 0 And a.相关id Is Null And a.病人id = n_病人ID
            Order By b.预约开始时间) Loop
    v_Tmp := '<SCHINFO>';
    v_Tmp := v_Tmp || '<ADVICEID>' || r.医嘱id || '</ADVICEID>';
    v_Tmp := v_Tmp || '<CHECKID>' || r.诊疗项目id || '</CHECKID>';
    v_Tmp := v_Tmp || '<ADVICEDOC>' || r.医嘱内容 || '</ADVICEDOC>';
    v_Tmp := v_Tmp || '<MACHINENAME>' || r.预约设备名称 || '</MACHINENAME>';
    v_Tmp := v_Tmp || '<MACHINEID>' || r.预约设备id || '</MACHINEID>';
    v_Tmp := v_Tmp || '<ROOMNAME>' || r.诊室名称 || '</ROOMNAME>';
    v_Tmp := v_Tmp || '<SEGBEGINTIME>' || to_char(r.预约开始时间段, 'yyyy-mm-dd hh24:mi:ss') || '</SEGBEGINTIME>';
    v_Tmp := v_Tmp || '<SEGENDTIME>' || to_char(r.预约结束时间段, 'yyyy-mm-dd hh24:mi:ss') || '</SEGENDTIME>';
    v_Tmp := v_Tmp || '<SCHBEGINTIME>' || to_char(r.预约开始时间, 'yyyy-mm-dd hh24:mi:ss') || '</SCHBEGINTIME>';
    v_Tmp := v_Tmp || '<SCHENDTIME>' || to_char(r.预约结束时间, 'yyyy-mm-dd hh24:mi:ss') || '</SCHENDTIME>';
    v_Tmp := v_Tmp || '</SCHINFO>';
    Select Appendchildxml(Xml_Out, '/OUTPUT', Xmltype(v_Tmp)) Into Xml_Out From Dual;
  End Loop;

Exception
  When Err_Custom Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_PACSGetPatSchedule;
/

Create Or Replace Procedure Zl_Third_PACSGetScheduleTimes
(
  Xml_In  In xmltype,
  Xml_Out Out xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取检查可预约的时间表
  --入参:Var_In:
  --  <IN>
  --  <ADVICEID>医嘱ID</ADVICEID>
  --  <BEGINTIME>预约的最早日期,例如2019-02-05</BEGINTIME>
  --  <MACHINEID>可选参数，预约设备ID</MACHINEID>
  --  </IN>
  --出参:Var_Out
  --  <OUTPUT>
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --    <SCHINFO>
  --      <ADVICEID>医嘱ID</ADVICEID>
  --      <CHECKID>诊疗项目ID</CHECKID>
  --      <CHECKNAME>诊疗项目名称</CHECKNAME>
  --      <ADVICEDOC>医嘱内容</ADVICEDOC>
  --      <MACHINENAME>预约设备名称</MACHINENAME>
  --      <MACHINEID>预约设备ID</MACHINEID>
  --      <SCHBEGINTIME>开始时间段</SCHBEGINTIME>
  --      <SCHENDTIME>结束时间段</SCHENDTIME>
  --      <DAYCAPACITY>总容量</DAYCAPACITY>
  --      <SCHEDULEDCOUNT>已预约数量</SCHEDULEDCOUNT>
  --    </SCHINFO>
  --    <SCHTIMES>
  --      <SEGBEGINTIME>开始时间段1</SEGBEGINTIME>
  --      <SEGENDTIME>结束时间段1</SEGENDTIME>
  --      <SEGCAPACITY>时间段的剩余容量</SEGCAPACITY>
  --      <SEGSCHEDULEDCOUNT>时间段内已预约数量</SEGSCHEDULEDCOUNT>
  --    </SCHTIMES>
  --    <SCHTIMES>
  --      <SEGBEGINTIME>开始时间段2</SEGBEGINTIME>
  --      <SEGENDTIME>结束时间段2</SEGENDTIME>
  --      <SEGCAPACITY>时间段的剩余容量</SEGCAPACITY>
  --      <SEGSCHEDULEDCOUNT>时间段内已预约数量</SEGSCHEDULEDCOUNT>
  --    </SCHTIMES>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  var_out Varchar2(4000);
  v_Error Varchar(255);
  Err_Custom Exception;
  v_Tmp Varchar2(2000);
Begin

  zl_影像预约_GetScheduleTimes(Xml_In.getstringval(), var_out);
  xml_out := xmltype(var_out);
Exception
  When Err_Custom Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_PACSGetScheduleTimes;
/

Create Or Replace Procedure Zl_Third_PACSScheduleInsert
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:新增预约记录
  --入参:Xml_In:
  --  <IN>
  --  <ADVICEID>医嘱ID</ADVICEID>
  --  <MACHINEID>预约设备ID</MACHINEID>
  --  <SCHBEGINTIME>开始时间段</SCHBEGINTIME>
  --  <SCHENDTIME>结束时间段</SCHENDTIME>
  --  </IN>
  --出参:Xml_Out
  --成功：
  --<OUTPUT>
  --  <RESULT>true</RESULT>
  --</OUTPUT>

  --失败：
  --<OUTPUT>
  --  <RESULT>false</RESULT>
  --  <ERROR>
  --    <MSG>详细错误提示</MSG>
  --  </ERROR>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  Var_out Varchar2(4000);
  v_Error Varchar(255);
  Err_Custom Exception;
  v_Tmp Varchar2(2000);
Begin

  zl_影像预约_ScheduleInsert(Xml_In.getstringval(), Var_out);
  Xml_Out := xmltype(Var_out);
Exception
  When Err_Custom Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_PACSScheduleInsert;
/

CREATE OR REPLACE Procedure Zl_Third_PACSScheduleDel
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:删除预约记录
  --入参:Xml_In:
  --  <IN>
  --  <ADVICEID>医嘱ID</ADVICEID>
  --  </IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <RESULT>true</RESULT>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Error Varchar(255);
  Err_Custom Exception;
  v_Tmp    Varchar2(2000);
  n_医嘱id 病人医嘱记录.ID%Type;
Begin

  Xml_Out := Xmltype('<OUTPUT></OUTPUT>');

  --提取入参
  Select Extractvalue(Value(A), 'IN/ADVICEID') Into n_医嘱id From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Delete From 影像预约记录 A Where a.医嘱id = n_医嘱id;

  v_Tmp := '<RESULT>true</RESULT>';
  Select Appendchildxml(Xml_Out, '/OUTPUT', Xmltype(v_Tmp)) Into Xml_Out From Dual;

Exception
  When Err_Custom Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>' || v_Error || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
  When Others Then
    v_Tmp   := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(v_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_PACSScheduleDel;
/

CREATE OR REPLACE PACKAGE B_ZLHIS_CISKERNEL Is
  --特殊说明此包为三方过程调用的包
  --目前为 目前护理专用
  --医嘱发送相关的判断和方法
  --医嘱发送相关的判断和方法

  --当前发送的住院医嘱是否可以自动完成
  Function f_Canautoexeitem
  (
    F期效       Number,
    F诊疗类别   Varchar2,
    F操作类型   Varchar2,
    F执行分类   Number,
    F执行科室id Number,
    F病人科室id Number,
    F病人病区id Number,
    F血库       Boolean
  ) Return Boolean;

  --功能：医嘱的暂停时间范围段
  Function f_Getadvicepause(F医嘱id Number) Return Varchar2;

  ----分解时间日期字符串处理
  Function f_Stranal
  (
    Strin   Varchar2,
    Ntype   Number,
    Datss   Date := Null,
    Datsend Date := Null
  ) Return Varchar2;

  --功能：取大于指定数值的最小整数
  Function f_Intex(n_Pin Number) Return Number;

  --功能：取大于指定数值的最小整数
  Function f_Int(n_Pin Number) Return Number;

  --断一个时间是否在暂停的时间段中
  Function f_Timeispause
  (
    v_Time Date,
    v_Sect Varchar2
  ) Return Boolean;

  --求某时间所在周的星期一的日期
  Function f_Getweekbase(v_Time Date) Return Date;

  --功能：根据长嘱的某次执行时间，得到它在该周期内的开始基准时间
  Function f_Calc本周期开始时间
  (
    Dat开始执行时间 Date,
    Dat某次执行时间 Date,
    Int频率间隔     Number,
    Str间隔单位     Varchar2
  ) Return Date;

  --功能：计算按指定频率执行的医嘱在指定时间范围内的执行时间点，以逗号分隔
  Function f_Calc段内分解时间
  (
    开始时间_In     病人医嘱发送.首次时间%Type,
    结束时间_In     病人医嘱发送.末次时间%Type,
    Pause_In        Varchar2,
    执行时间方案_In 病人医嘱记录.执行时间方案%Type,
    频率间隔_In     病人医嘱记录.频率间隔%Type,
    间隔单位_In     病人医嘱记录.间隔单位%Type,
    开始执行时间_In 病人医嘱记录.开始执行时间%Type
  ) Return Varchar2;

  Function f_Calc持续性长嘱次数
  (
    Datbegin        Date,
    Datend          Date,
    Str上次执行时间 Varchar2,
    Str执行终止时间 Varchar2,
    Strpause        Varchar2,
    Str分解时间     Out Varchar2
  ) Return Number;

  Function f_Calc发送药品总量
  (
    Dat开始执行时间 Date,
    Lng次数         Number,
    Str分解时间     Varchar2,
    Dbl单量         Number,
    Dbl剂量系数     Number,
    Dbl包装系数     Number,
    Int分零         Number,
    Dat终止时间     Date,
    Strpause_In     Varchar2,
    Str执行时间     Varchar2,
    Int频率次数     Number,
    Int频率间隔     Number,
    Str间隔单位     Varchar2,
    Blnlimit        Boolean,
    Dbl首次用量     Number,
    Dat上次执行时间 Date,
    Lng次数out      Out Number,
    Str分解时间out  Out Varchar2
  ) Return Number;

  --将医嘱执行的分解时间按次数进行截断
  Function f_Trim分解时间
  (
    次数_In In Number,
    v_分解  Varchar2
  ) Return Varchar2;

  Function f_Getnonesendid
  (
    Lng病人id Number,
    Lng主页id Number
  ) Return Varchar2;

  --输液类医嘱排处理处理，或者获取处理
  Function f_Get输液类医嘱
  (
    F病人id         Number,
    F主页id         Number,
    F病区id         Number,
    Inttype         Number,
    Str输液配置中心 Varchar2
  ) Return Varchar2;

  --通过执行次数来计算分解时间
  Function f_Calc次数分解时间
  (
    次数_In     In 病人医嘱记录.总给予量%Type,
    开始时间_In In Date,
    终止时间_In In Date,
    执行时间_In In 病人医嘱记录.执行时间方案%Type,
    频率间隔_In In 病人医嘱记录.频率间隔%Type,
    间隔单位_In In 病人医嘱记录.间隔单位%Type,
    v_Pause     In Varchar2 := Null
  ) Return Varchar2;

  --根据收费细目ID或收入项目ID(前者优先),应收金额,按费别设置的分段比例打折规则计算实收金额
  Function f_Actualmoney
  (
    费别_In       In Varchar2,
    收入项目id_In In Number,
    应收金额_In   In Number,
    收费细目id_In In Number,
    库房id_In     In Number,
    数量_In       In Number,
    加班加价率_In In Number,
    费别_Out      Out Varchar2,
    医嘱id_In     In Number := Null
  ) Return Number;

  --时价单计算
  Function f_Calcdrugprice
  (
    药品id_In  In Number,
    药房id_In  In Number,
    数量_In    In Number,
    费别_In    In Varchar2 := Null,
    n_Dec      In Number := Null,
    v_动态费别 In Varchar2 := Null
  ) Return Number;

  --住院医嘱读取和主体发送过程
  Procedure f_Advicesendin
  (
    Xml_In  In Xmltype,
    Xml_Out Out Xmltype
  );

End b_Zlhis_Ciskernel;
/

CREATE OR REPLACE PACKAGE BODY B_ZLHIS_CISKERNEL Is

  --当前发送的住院医嘱是否可以自动完成
  Function f_Canautoexeitem
  (
    F期效       Number,
    F诊疗类别   Varchar2,
    F操作类型   Varchar2,
    F执行分类   Number,
    F执行科室id Number,
    F病人科室id Number,
    F病人病区id Number,
    F血库       Boolean
  ) Return Boolean Is
    --F血库 是否启用血库系统
    Mstrautoexe  Varchar2(20);
    Gstr医嘱核对 Varchar2(20);
    Strpar       Varchar2(2000);
    Str医嘱类别  Varchar2(2000);
    Lngresult    Number;
    Blnresult    Boolean := False;
  Begin
    Mstrautoexe := zl_GetSysParameter('本科执行自动完成', 1254) || '00';
    If Substr(Mstrautoexe, F期效 + 1, 1) = '1' And Not (F诊疗类别 = 'Z' And F操作类型 Is Not Null) And
       (F执行科室id = F病人科室id Or F执行科室id = F病人病区id) Then

      Strpar      := zl_GetSysParameter('本科执行自动完成医嘱类别', 1254, 1, F执行科室id);
      Str医嘱类别 := F诊疗类别 || Nvl(F操作类型, '0') || Nvl(F执行分类, 0);

      Case Str医嘱类别
        When 'E21' Then
          Lngresult := 0; --输液
        When 'E22' Then
          Lngresult := 1; --注射
        When 'E24' Then
          Lngresult := 2; --口服
        When 'E60' Then
          Lngresult := 3; --采集
        When 'E13' Then
          Lngresult := 4; --过敏试验
        When 'E15' Then
          Lngresult := 4; --过敏试验
        When 'E00' Then
          Lngresult := 5; --普通治疗
        When 'E50' Then
          Lngresult := 6; --特殊治疗
        When 'E20' Then
          Lngresult := 7; --其他给药途径
        Else
          Lngresult := 8; --其他医嘱
      End Case;

      If Instr(',' || Strpar || ',', ',' || Lngresult || ',') > 0 Or Strpar = '*' Then
        Blnresult := True;
      End If;

      --输血和皮试医嘱执行后需要核对
      Gstr医嘱核对 := zl_GetSysParameter(186) || '00';

      If Blnresult Then
        If (Str医嘱类别 = 'E13' Or Str医嘱类别 = 'E15') And Substr(Gstr医嘱核对, 2, 1) = '1' Then
          Blnresult := False;
        Elsif (F诊疗类别 = 'K' Or F诊疗类别 = 'E' And (F操作类型 = '8' Or F操作类型 = '9')) And (F血库 Or Substr(Gstr医嘱核对, 1, 1) = '1') Then
          --用了血库系统不自动完成
          Blnresult := False;
        End If;
      End If;
    End If;
    Return(Blnresult);
  End f_Canautoexeitem;

  Function f_Getadvicepause(F医嘱id Number) Return Varchar2 Is
    --功能：医嘱的暂停时间范围段
    Ftmp  Varchar2(32760);
    Ftype Number;
  Begin
    For R In (Select 操作类型, 操作时间
              From 病人医嘱状态
              Where 操作类型 In (6, 7) And 医嘱id = F医嘱id
              Order By 操作时间) Loop
      If r.操作类型 = 6 Then
        Ftype := 6;
        Ftmp  := Ftmp || ';' || To_Char(r.操作时间, 'YYYY-MM-DD HH24:MI:SS') || ',';
      Elsif r.操作类型 = 7 Then
        --启用的那一秒不在暂停的范围之内
        Ftmp  := Ftmp  || To_Char((r.操作时间 - 1 / 24 / 60 / 60), 'YYYY-MM-DD HH24:MI:SS') ;
        Ftype := 7;
      End If;
    End Loop;
    If Nvl(Ftype, 0) = 6 Then
      Ftmp := Substr(Ftmp, 2) || '3000-01-01 11:11:11';
    End If;
    Return Ftmp;
  End f_Getadvicepause;

  Function f_Stranal
  (
    Strin   Varchar2,
    Ntype   Number,
    Datss   Date := Null,
    Datsend Date := Null
  ) Return Varchar2 Is
    --功能：按特殊符号分割或者获取相关信息，固定符号 半角的逗号
    --ntype 1--获得按指定符号分割后的元素的个数，
    --      2--第一个元素
    --      3--最后一个元素
    --      4--获取大于datss日期后的值,当N=4时传入 datss 此时 Strin 为日期格式逗号拼串
    --      5--获取指定范围内的串,当N=5时传入 datss和Datsend 此时 Strin 为日期格式逗号拼串
    Fout  Varchar2(32760);
    F1    Varchar2(300);
    F2    Varchar2(300);
    P     Number;
    N     Number := 0;
    Vtp   Varchar2(200);
    v_Str Varchar2(32760);

    Dattmp Date;
  Begin

    If Strin Is Null Then
      Return Null;
    End If;

    v_Str := Strin || ',';
    Loop
      P := Instr(v_Str, ',');
      Exit When(Nvl(P, 0) = 0);
      Vtp := Substr(v_Str, 1, P - 1);

      If Ntype = 4 Then
        If To_Date(Vtp, 'yyyy-mm-dd hh24:mi:ss') > Datss Then
          Fout := Fout || ',' || Vtp;
        End If;
      End If;

      If Ntype = 5 Then
        Dattmp := To_Date(Vtp, 'yyyy-mm-dd hh24:mi:ss');
        If Dattmp >= Datss And Dattmp <= Datsend Then
          Fout := Fout || ',' || Vtp;
        End If;
      End If;
      N := N + 1;
      If N = 1 Then
        F1 := Vtp;
        If Ntype = 2 Then
          Exit;
        End If;
      End If;
      v_Str := Substr(v_Str, P + 1);
    End Loop;
    F2 := Vtp;
    If Ntype = 1 Then
      Fout := N;
    Elsif Ntype = 2 Then
      Fout := F1;
    Elsif Ntype = 3 Then
      Fout := F2;
    Elsif Ntype = 5 Or Ntype = 4 Then
      Fout := Substr(Fout, 2);
    End If;
    Return Fout;
  End f_Stranal;

  Function f_Intex(n_Pin Number) Return Number Is
    --功能：取大于指定数值的最小整数
    Fout Number;
  Begin
    Fout := Round(n_Pin); --四舍五入
    If Fout < n_Pin Then
      Fout := Fout + 1;
    End If;
    Return Fout;
  End f_Intex;

  Function f_Int(n_Pin Number) Return Number Is
    --功能：取大于指定数值的最小整数
    Fout Number;
  Begin
    Fout := Round(n_Pin); --四舍五入
    If Fout > n_Pin Then
      Fout := Fout - 1;
    End If;
    Return Fout;
  End f_Int;

  --断一个时间是否在暂停的时间段中
  Function f_Timeispause
  (
    v_Time Date,
    v_Sect Varchar2
  ) Return Boolean Is
    v_Rest      Varchar2(32760);
    v_Cursect   Varchar2(60);
    v_Begintime Varchar2(30);
    v_Endtime   Varchar2(30);
    b_Tmp       Boolean;
  Begin
    If v_Sect Is Null Then
      Return True;
    End If;
    v_Rest := v_Sect || ';';
    b_Tmp  := False;
    While v_Rest Is Not Null Loop
      v_Cursect   := Substr(v_Rest, 1, Instr(v_Rest, ';') - 1);
      v_Begintime := Substr(v_Cursect, 1, Instr(v_Cursect, ',') - 1);
      v_Endtime   := Substr(v_Cursect, Instr(v_Cursect, ',') + 1);
      If v_Endtime Is Null Then
        v_Endtime := '3000-01-01 00:00:00'; --可能尚未启用或暂停的时候被停止
      End If;
      If To_Char(v_Time, 'YYYY-MM-DD HH24:MI:SS') >= v_Begintime And
         To_Char(v_Time, 'YYYY-MM-DD HH24:MI:SS') <= v_Endtime Then
        b_Tmp := True;
      End If;
      v_Rest := Substr(v_Rest, Instr(v_Rest, ';') + 1);
    End Loop;
    If b_Tmp Then
      Return False;
    Else
      Return True;
    End If;
  End f_Timeispause;

  --求某时间所在周的星期一的日期
  Function f_Getweekbase(v_Time Date) Return Date Is
    v_Week Number(1);
  Begin
    v_Week := To_Number(To_Char(v_Time, 'D'));
    v_Week := v_Week - 1;
    If v_Week = 0 Then
      v_Week := 7;
    End If;
    Return(Trunc(v_Time - (v_Week - 1)));
  End f_Getweekbase;

  Function f_Calc本周期开始时间
  (
    Dat开始执行时间 Date,
    Dat某次执行时间 Date,
    Int频率间隔     Number,
    Str间隔单位     Varchar2
  ) Return Date Is
    --功能：根据长嘱的某次执行时间，得到它在该周期内的开始基准时间
    Datbegin Date;
    Datcurr  Date;
  Begin
    Datcurr  := Dat开始执行时间;
    Datbegin := Datcurr;
    If Str间隔单位 = '周' Then
      Datcurr := f_Getweekbase(Datcurr); --按周执行时在医嘱开始那周的星期一作为基准
    End If;
    If Str间隔单位 Is Null Then
      Return Null;
    End If;
    While Datcurr <= Dat某次执行时间 Loop
      Datbegin := Datcurr;
      If Str间隔单位 = '周' Then
        Datcurr := Datcurr + 7;
      Elsif Str间隔单位 = '天' Then
        Datcurr := Datcurr + Int频率间隔;
      Elsif Str间隔单位 = '小时' Then
        Datcurr := Datcurr + Int频率间隔 / 24;
      Elsif Str间隔单位 = '分钟' Then
        Datcurr := Datcurr + Int频率间隔 / 24 / 60;
      End If;
    End Loop;
    Return Datbegin;
  End f_Calc本周期开始时间;

  Function f_Calc段内分解时间
  (
    开始时间_In     病人医嘱发送.首次时间%Type,
    结束时间_In     病人医嘱发送.末次时间%Type,
    Pause_In        Varchar2,
    执行时间方案_In 病人医嘱记录.执行时间方案%Type,
    频率间隔_In     病人医嘱记录.频率间隔%Type,
    间隔单位_In     病人医嘱记录.间隔单位%Type,
    开始执行时间_In 病人医嘱记录.开始执行时间%Type
  ) Return Varchar2 Is
    --功能：计算按指定频率执行的医嘱在指定时间范围内的执行时间点，以逗号分隔
    v_Pause      Varchar2(32760);
    v_Detailtime Varchar2(32760);
    n_First      Number(1);
    v_First      病人医嘱记录.执行时间方案%Type;
    v_Normal     病人医嘱记录.执行时间方案%Type;
    v_Mtime      Varchar2(100);
    v_Rtime      Varchar2(100);
    v_Curtime    Date;
    v_Tmptime    Date;
  Begin
    v_Pause := Pause_In;
    --执行时间方案基准
    If Nvl(Instr(执行时间方案_In, ','), 0) > 0 Then
      v_First  := Substr(执行时间方案_In, 1, Instr(执行时间方案_In, ',') - 1);
      v_Normal := Substr(执行时间方案_In, Instr(执行时间方案_In, ',') + 1);
    Else
      v_First  := Null;
      v_Normal := 执行时间方案_In;
    End If;
    If 间隔单位_In = '周' Then
      v_Curtime := b_Zlhis_Ciskernel.f_Getweekbase(开始执行时间_In); --按周执行时在医嘱开始那周的星期一作为基准
    Else
      v_Curtime := 开始执行时间_In;
    End If;
    If 间隔单位_In = '周' Then
      If v_First Is Not Null Then
        If v_Curtime = b_Zlhis_Ciskernel.f_Getweekbase(开始时间_In) Then
          n_First := 1;
        End If;
      End If;
      While v_Curtime <= 结束时间_In Loop
        If Nvl(n_First, 0) = 1 Then
          v_Rtime := v_First || '-';
        Else
          v_Rtime := v_Normal || '-';
        End If;
        n_First := 0;
        --1/8:00-3/8:00-5/8:00
        While v_Rtime Is Not Null Loop
          v_Mtime   := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
          v_Tmptime := v_Curtime + To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, '/') - 1)) - 1;
          v_Mtime   := Substr(v_Mtime, Instr(v_Mtime, '/') + 1);
          If Instr(v_Mtime, ':') = 0 Then
            v_Mtime := v_Mtime || ':00';
          End If;
          v_Tmptime := Trunc(v_Tmptime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
          If v_Tmptime >= 开始时间_In And v_Tmptime <= 结束时间_In Then
            If b_Zlhis_Ciskernel.f_Timeispause(v_Tmptime, v_Pause) Then
              v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
            End If;
          Elsif v_Tmptime > 结束时间_In Then
            Exit;
          End If;
          v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
        End Loop;
        v_Curtime := Trunc(v_Curtime + 7);
      End Loop;
    Elsif 间隔单位_In = '天' Then
      If v_First Is Not Null Then
        If Trunc(开始执行时间_In) = Trunc(开始时间_In) Then
          n_First := 1;
        End If;
      End If;
      While v_Curtime <= 结束时间_In Loop
        If Nvl(n_First, 0) = 1 Then
          v_Rtime := v_First || '-';
        Else
          v_Rtime := v_Normal || '-';
        End If;
        n_First := 0;
        If 频率间隔_In = 1 Then
          --8:00-12:00-14:00；8-12-14
          While v_Rtime Is Not Null Loop
            v_Mtime := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
            If Instr(v_Mtime, ':') = 0 Then
              v_Mtime := v_Mtime || ':00';
            End If;
            v_Tmptime := Trunc(v_Curtime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
            If v_Tmptime >= 开始时间_In And v_Tmptime <= 结束时间_In Then
              If b_Zlhis_Ciskernel.f_Timeispause(v_Tmptime, v_Pause) Then
                v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
              End If;
            Elsif v_Tmptime > 结束时间_In Then
              Exit;
            End If;
            v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
          End Loop;
        Else

          --1/8:00-1/15:00-2/9:00
          While v_Rtime Is Not Null Loop
            v_Mtime   := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
            v_Tmptime := v_Curtime + To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, '/') - 1)) - 1;
            v_Mtime   := Substr(v_Mtime, Instr(v_Mtime, '/') + 1);
            If Instr(v_Mtime, ':') = 0 Then
              v_Mtime := v_Mtime || ':00';
            End If;
            v_Tmptime := Trunc(v_Tmptime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
            If v_Tmptime >= 开始时间_In And v_Tmptime <= 结束时间_In Then
              If b_Zlhis_Ciskernel.f_Timeispause(v_Tmptime, v_Pause) Then
                v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
              End If;
            Elsif v_Tmptime > 结束时间_In Then
              Exit;
            End If;
            v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
          End Loop;
        End If;
        v_Curtime := Trunc(v_Curtime + 频率间隔_In); --因为Loop条件注意要取整
      End Loop;
    Elsif 间隔单位_In = '小时' Then
      --10:00-20:00-40:00；10-20-40；02:30
      While v_Curtime <= 结束时间_In Loop
        v_Rtime := 执行时间方案_In || '-';
        While v_Rtime Is Not Null Loop
          v_Mtime := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
          If Instr(v_Mtime, ':') = 0 Then
            v_Tmptime := v_Curtime + (To_Number(v_Mtime) - 1) / 24;
          Else
            v_Tmptime := v_Curtime + (To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, ':') - 1)) - 1) / 24 +
                         To_Number(Substr(v_Mtime, Instr(v_Mtime, ':') + 1)) / 60 / 24;
          End If;

          If v_Tmptime >= 开始时间_In And v_Tmptime <= 结束时间_In Then
            If b_Zlhis_Ciskernel.f_Timeispause(v_Tmptime, v_Pause) Then
              v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
            End If;
          Elsif v_Tmptime > 结束时间_In Then
            Exit;
          End If;
          v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
        End Loop;
        v_Curtime := v_Curtime + 频率间隔_In / 24;
      End Loop;
    Elsif 间隔单位_In = '分钟' Then
      --无执行时间
      While v_Curtime <= 结束时间_In Loop
        v_Tmptime := v_Curtime;
        If v_Tmptime >= 开始时间_In And v_Tmptime <= 结束时间_In Then
          If b_Zlhis_Ciskernel.f_Timeispause(v_Tmptime, v_Pause) Then
            v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
          End If;
        Elsif v_Tmptime > 结束时间_In Then
          Exit;
        End If;
        v_Curtime := v_Curtime + 频率间隔_In / (24 * 60);
      End Loop;
    End If;

    If v_Detailtime Is Not Null Then
      v_Detailtime := Substr(v_Detailtime, 2);
    End If;
    Return(v_Detailtime);
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Calc段内分解时间出错[ZLSOFT]');
  End f_Calc段内分解时间;

  Function f_Calc持续性长嘱次数
  (
    Datbegin        Date,
    Datend          Date,
    Str上次执行时间 Varchar2,
    Str执行终止时间 Varchar2,
    Strpause        Varchar2,
    Str分解时间     Out Varchar2
  ) Return Number Is
    Str首次时间 Varchar2(1000);
    Str末次时间 Varchar2(1000);
    Curdate     Date;
    Lng次数     Number := 0;
    Blnsend     Boolean;
    Fdatend     Date;
    Dattmp      Date;
  Begin
    Str分解时间 := Null;
    Curdate     := Trunc(Datbegin);
    Fdatend     := Trunc(Datend);
    While Curdate <= Fdatend Loop
      --注意f_Timeispause暂停时为空，这个函数是true
      If not b_Zlhis_Ciskernel.f_Timeispause(Curdate, Strpause) Or Strpause Is Null Then
        Blnsend := True;
        If Str上次执行时间 Is Not Null Then
          Dattmp := Trunc(To_Date(Str上次执行时间, 'YYYY-MM-DD HH24:MI:SS'));
          If Curdate <= Dattmp Then
            Blnsend := False; --应大于上次执行时间才执行
          End If;
        End If;
        If Str执行终止时间 Is Not Null Then
          Dattmp := Trunc(To_Date(Str执行终止时间, 'YYYY-MM-DD HH24:MI:SS'));
          If Curdate > Dattmp Then
            Blnsend := False; --应小于等于执行终止时间才执行
          End If;
        End If;
        If Blnsend Then
          Lng次数 := Lng次数 + 1;
          If Lng次数 = 1 Then
            Str首次时间 := To_Char(Curdate, 'yyyy-MM-dd') || ' 00:00:00'; --定为零点执行
            If Str首次时间 < To_Char(Datbegin, 'yyyy-MM-dd HH:mm:ss') Then
              Str首次时间 := To_Char(Datbegin, 'yyyy-MM-dd HH:mm:ss');
            End If;
            Str分解时间 := Str首次时间;
          Else
            Str末次时间 := To_Char(Curdate, 'yyyy-MM-dd') || ' 00:00:00';
            Str分解时间 := Str分解时间 || ',' || Str末次时间;
          End If;
        End If;
      End If;
      Curdate := Curdate + 1;
    End Loop;
    Return Lng次数;
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Calc持续性长嘱次数出错[ZLSOFT]');
  End f_Calc持续性长嘱次数;

  Function f_Calc发送药品总量
  (
    Dat开始执行时间 Date,
    Lng次数         Number,
    Str分解时间     Varchar2,
    Dbl单量         Number,
    Dbl剂量系数     Number,
    Dbl包装系数     Number,
    Int分零         Number,
    Dat终止时间     Date,
    Strpause_In     Varchar2,
    Str执行时间     Varchar2,
    Int频率次数     Number,
    Int频率间隔     Number,
    Str间隔单位     Varchar2,
    Blnlimit        Boolean,
    Dbl首次用量     Number,
    Dat上次执行时间 Date,
    Lng次数out      Out Number,
    Str分解时间out  Out Varchar2
  ) Return Number Is
    --功能：按发送次数及分零特性计算成药总量
    --参数：dat开始执行时间=医嘱的开始执行时间,用于计算下一执行周期开始基准时间
    --      lng次数=本次计划要发送的次数
    --      dbl单量=按剂量单位的一次用量
    --      int分零=0-可分零,1-不分零,2-一次性(即时失效),-N-N天内分零使用有效(按24小时计算)
    --      dbl包装系数=门诊包装或住院包装
    --      blnLimit=是否按时间限制计算给药途径，不管剩余部份
    --下列参数用于不分零药品计算(包括-N型)：
    --      str分解时间=本次发送计划执行的分解时间,与次数对应
    --      strPause=医嘱的暂停时间段
    --      dat终止时间=医嘱的执行终止时间,没有时传入"3000-01-01"
    --返回：1.按门诊/住院单位计算的药品总量
    --      2.lng次数=不分零药品(包括-N型分零药品)计算后的实际执行次数(增加)
    --      3.str分解时间=不分零药品(包括-N型分零药品)计算后的分解时间(增加)
    --说明：药品分零特性是针对门诊或住院包装而言的。

    Dbl总量  Number;
    Dbl剩余  Number;
    v_Tmp    Varchar2(32760);
    Strbegin Varchar2(400);
    v_Tmp1   Varchar2(400);
    Datt1    Date;
    Datt2    Date;
    Dblone   Number; ---1个小单位，ml，数值大
    Dblpkg   Number; ---1个大单位，瓶，数值小， [1瓶=100ml]  100=(Dbl剂量系数 * Dbl包装系数)
    n_I        Number;
    Strpause Varchar2(32760);
    Arrtime  t_Strlist := t_Strlist();

    Procedure P剩余量分解 Is
    Begin
      If Dbl剩余 >= Dbl单量 And Dbl单量 <> 0 Then
        --剩余理论可以执行的次数
        n_I        := b_Zlhis_Ciskernel.f_Int(Dbl剩余 / Dbl单量);
        Strbegin := b_Zlhis_Ciskernel.f_Stranal(Str分解时间, 2);
        v_Tmp    := b_Zlhis_Ciskernel.f_Stranal(Str分解时间, 3);
        Datt2    := To_Date(v_Tmp, 'YYYY-MM-DD HH24:MI:SS');
        --剩余实际可以执行的次数及时间分解(受终止时间限制)
        Datt1 := b_Zlhis_Ciskernel.f_Calc本周期开始时间(Dat开始执行时间, Datt2, Int频率间隔, Str间隔单位);
        If Datt1 <= Datt2 Then
          --在往后扩展时间时,最后一个周期内已执行的时间不再计算,按暂停处理
          Strpause := Strpause_In || ';' || To_Char(Datt1, 'YYYY-MM-DD HH24:MI:SS') || ',' || v_Tmp;
          If Substr(Strpause, 1, 1) = ';' Then
            Strpause := Substr(Strpause, 2);
          End If;
        End If;
        v_Tmp := f_Calc段内分解时间(Datt1, Datt2+30, Strpause, Str执行时间, Int频率间隔, Str间隔单位, Dat开始执行时间);
        If v_Tmp Is Not Null Then
          Lng次数out     := Lng次数;
          Str分解时间out := Str分解时间;
          Datt1          := To_Date(Strbegin, 'YYYY-MM-DD HH24:MI:SS');
          While v_Tmp Is Not Null Loop
            v_Tmp1 := Substr(v_Tmp, 1, 19);
            Datt2  := To_Date(v_Tmp1, 'YYYY-MM-DD HH24:MI:SS');
            If Dbl剩余 < Dbl单量 Or Datt2 - Datt1 >= Abs(Int分零) Then
              Exit;
            End If;
            Lng次数out     := Lng次数out + 1;
            Str分解时间out := Str分解时间out || ',' || v_Tmp1;
            Dbl剩余        := Dbl剩余 - Dbl单量;
          End Loop;
        End If;
      End If;
    End P剩余量分解;

  Begin
    --注：一些地方加Val是因为运算结果的Double在某些地方判断时，内部精度有问题，导致比如0.9<>0.9
    If Int分零 = 0 Then
      Dbl总量 := Dbl单量 * Lng次数 / Dbl剂量系数 / Dbl包装系数;
      If Dat上次执行时间 Is Null And Dbl首次用量 > 0 Then
        Dbl总量 := Dbl总量 + (Dbl首次用量 - Dbl单量) / Dbl剂量系数 / Dbl包装系数;
      End If;
    Elsif Int分零 = 1 Then
      --不分零
      Dbl总量 := Dbl单量 * Lng次数 / Dbl剂量系数 / Dbl包装系数;
      --如果上次执行时间为NULL，说明包含首次
      If Dat上次执行时间 Is Null And Dbl首次用量 > 0 Then
        Dbl总量 := Dbl总量 + (Dbl首次用量 - Dbl单量) / Dbl剂量系数 / Dbl包装系数;
      End If;
      Dbl总量 := b_Zlhis_Ciskernel.f_Intex(Dbl总量);
      --按不分零计算时,多余的尽可能使用,从而使发送次数增加
      If Not Blnlimit Then
        Dbl剩余 := Dbl总量 * Dbl包装系数 * Dbl剂量系数 - Dbl单量 * (Lng次数 - 1);
        If Nvl(Dbl首次用量, 0) > 0 Then
          Dbl剩余 := Dbl剩余 - Dbl首次用量;
        Else
          Dbl剩余 := Dbl剩余 - Dbl单量;
        End If;
        P剩余量分解;
      End If;
    Elsif Int分零 = 2 Then
      --一次性(即时失效)
      Dbl总量 := b_Zlhis_Ciskernel.f_Intex(Dbl单量 / Dbl剂量系数 / Dbl包装系数) * Lng次数;
      --如果上次执行时间为NULL，说明包含首次
      If Dat上次执行时间 Is Null And Dbl首次用量 > 0 Then
        Dbl总量 := Dbl总量 + b_Zlhis_Ciskernel.f_Intex(Dbl首次用量 / Dbl剂量系数 / Dbl包装系数) -
                 b_Zlhis_Ciskernel.f_Intex(Dbl单量 / Dbl剂量系数 / Dbl包装系数);
      End If;
    Elsif Int分零 < 0 Then
      --ABS(int分零)天内分零使用有效(但不分零计算)
      --一次门诊/住院包装的剂量(剂量单位)
      Dblone := b_Zlhis_Ciskernel.f_Intex(Dbl单量 / Dbl剂量系数 / Dbl包装系数) * (Dbl剂量系数 * Dbl包装系数);
      --一次门诊/住院包装的剂量(包装单位)
      Dblpkg := b_Zlhis_Ciskernel.f_Intex(Dbl单量 / Dbl剂量系数 / Dbl包装系数);
      --分配后第一次执行后的乘余量
      Dbl剩余 := Dblone - Dbl单量;

      Dbl总量 := Dblpkg;

      --如果上次执行时间为NULL，说明包含首次
      If Dat上次执行时间 Is Null And Nvl(Dbl首次用量, 0) > 0 Then
        Dbl总量 := b_Zlhis_Ciskernel.f_Intex(Dbl首次用量 / Dbl剂量系数 / Dbl包装系数);
        --分配后第一次执行后的乘余量
        Dbl剩余 := b_Zlhis_Ciskernel.f_Intex(Dbl首次用量 / Dbl剂量系数 / Dbl包装系数) * (Dbl剂量系数 * Dbl包装系数) - Dbl首次用量;
      End If;

      --从第二次执行开始计算，至少有两个执行时间点
      If Instr('--' || Str分解时间, ',') > 0 Then
        v_Tmp := Str分解时间;
        While v_Tmp Is Not Null Loop
          Arrtime.Extend;
          Arrtime(Arrtime.Count) := Substr(v_Tmp, 1, 19);
          v_Tmp := Substr(v_Tmp, 21);
        End Loop;
        Datt1 := To_Date(Arrtime(2), 'YYYY-MM-DD HH24:MI:SS');
        For I In 2 .. Arrtime.Count Loop
          --第一次循环肯定够,所以不进入条件
          Datt2 := To_Date(Arrtime(I), 'YYYY-MM-DD HH24:MI:SS');
          If Dbl剩余 < Dbl单量 Or Datt2 - Datt1 >= Abs(Int分零) Then
            If Datt2 - Datt1 >= Abs(Int分零) Then
              Dbl剩余 := Dblone;
              Dbl总量 := Dbl总量 + Dblpkg;
            Else
              If Dbl剩余 + Dbl剂量系数 * Dbl包装系数 >= Dbl单量 Then
                --只需剩余加一个包装单位即够
                Dbl剩余 := Dbl剩余 + Dbl剂量系数 * Dbl包装系数;
                Dbl总量 := Dbl总量 + 1;
              Else
                --需要剩余加一次包装单位才够
                Dbl剩余 := Dbl剩余 + Dblone;
                Dbl总量 := Dbl总量 + Dblpkg;
              End If;
            End If;
            Datt1 := Datt2;
          End If;
          Dbl剩余 := Dbl剩余 - Dbl单量;
        End Loop;
      End If;
      --剩余部分继续在有效期内按不分零计算,从而使发送次数增加
      If Not Blnlimit Then
        P剩余量分解;
      End If;
    End If;
    Return Dbl总量;
    If Int频率次数 = 0 Then
      Null;
    End If;
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Calc发送药品总量出错[ZLSOFT]');
  End f_Calc发送药品总量;

  --将医嘱执行的分解时间按次数进行截断
  Function f_Trim分解时间
  (
    次数_In In Number,
    v_分解  Varchar2
  ) Return Varchar2 Is
    v_Result Varchar2(32760);
    v_Tmp    Varchar2(32760);
  Begin
    v_Tmp := v_分解;
    For I In 1 .. 次数_In Loop
      v_Result := v_Result || ',' || Substr(v_Tmp, 1, 19);
      v_Tmp    := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
    End Loop;
    v_Result := Substr(v_Result, 2);
    Return(v_Result);
  End f_Trim分解时间;

  Function f_Getnonesendid
  (
    Lng病人id Number,
    Lng主页id Number
  ) Return Varchar2 Is

    --功能：获取因为皮试过敏(阳性(+))或无皮试结果而不发送的医嘱ID
    --参数：lng病人 病人ID
    --      strAdviceDrugIDs  出参数   受限制的药品行的医嘱IDs

    Cursor c_Addrug
    (
      F病人id Number,
      F主页id Number
    ) Is
      Select a.相关id, a.Id, a.用法id, a.诊疗项目id, a.收费细目id, a.开始执行时间, a.过敏时间, 1 As 结果
      From (Select a.相关id, a.Id, b.用法id, a.诊疗项目id, a.收费细目id, a.开始执行时间, a.开始执行时间 As 过敏时间
             From 病人医嘱记录 A, 诊疗用法用量 B
             Where a.诊疗项目id = b.项目id And b.性质 = 0 And a.诊疗类别 In ('5', '6') And a.医嘱状态 <> 4 And a.皮试阳性说明 Is Null And
                   Nvl(a.皮试结果, '空') <> '连续用药' And a.病人id = F病人id And a.主页id = F主页id
             Union All
             Select a.相关id, a.Id, b.用法id, a.诊疗项目id, a.收费细目id, a.开始执行时间, a.开始执行时间 As 过敏时间
             From 病人医嘱记录 A, 药品用法用量 B
             Where a.收费细目id = b.药品id And b.性质 = 0 And a.诊疗类别 In ('5', '6') And a.医嘱状态 <> 4 And a.皮试阳性说明 Is Null And
                   Nvl(a.皮试结果, '空') <> '连续用药' And a.病人id = F病人id And a.主页id = F主页id) A
      Group By a.相关id, a.Id, a.用法id, a.诊疗项目id, a.收费细目id, a.开始执行时间, a.过敏时间
      Order By a.相关id;

    Cursor c_过敏
    (
      F病人id   Number,
      F有效天数 Number
    ) Is
      Select a.药物id, F有效天数 + a.过敏时间 As 过敏时间, Nvl(a.结果, 0) As 结果
      From 病人过敏记录 A
      Where a.记录来源 = 2 And a.病人id = F病人id And
            a.过敏时间 = (Select Max(x.过敏时间)
                      From 病人过敏记录 X
                      Where x.病人id = a.病人id And x.主页id = a.主页id And x.药物id = a.药物id);

    Cursor c_免试
    (
      F病人id Number,
      F主页id Number
    ) Is
      Select a.项目id, a.药品id
      From (Select c.项目id, 0 As 药品id
             From 病人医嘱记录 A, 诊疗项目目录 B, 诊疗用法用量 C
             Where a.诊疗项目id = b.Id And a.诊疗类别 = 'E' And b.操作类型 = '1' And a.医嘱状态 <> 4 And a.诊疗项目id = c.用法id And c.性质 = 0 And
                   a.皮试结果 = '免试' And a.病人id = F病人id And a.主页id = F主页id
             Union All
             Select 0 As 项目id, c.药品id
             From 病人医嘱记录 A, 诊疗项目目录 B, 药品用法用量 C
             Where a.诊疗项目id = b.Id And a.诊疗类别 = 'E' And b.操作类型 = '1' And a.医嘱状态 <> 4 And a.诊疗项目id = c.用法id And c.性质 = 0 And
                   a.皮试结果 = '免试' And a.病人id = F病人id And a.主页id = F主页id) A
      Group By a.项目id, a.药品id;

    Type t_Addrug Is Table Of c_Addrug%RowType;
    r_Addrug t_Addrug; --游标对其赋值后，可以修改数组中的值

    Type t_过敏 Is Table Of c_过敏%RowType;
    r_过敏 t_过敏;

    Type t_免试 Is Table Of c_免试%RowType;
    r_免试 t_免试;

    n_Tmp          Number;
    n_Cnt          Number;
    n_过敏有效天数 Number;
    Bln自动皮试    Boolean;
    v_Rt           Varchar2(32000);
    v_Ids          Varchar2(32000);
    v_Err          Varchar2(500);
    Err_Custom Exception;
  Begin
    Bln自动皮试 := Zl_To_Number(zl_GetSysParameter('医嘱发送皮试限制', 1253)) = 1;
    If Not Bln自动皮试 Then
      Return Null;
    End If;
    --取出需要皮试的药品医嘱
    Open c_Addrug(Lng病人id, Lng主页id);
    Fetch c_Addrug Bulk Collect
      Into r_Addrug;
    Close c_Addrug;

    If r_Addrug.Count > 0 Then
      --根据过敏记录进行排除
      n_过敏有效天数 := Zl_To_Number(Nvl(zl_GetSysParameter(70), '0'));
      Open c_过敏(Lng病人id, n_过敏有效天数);
      Fetch c_过敏 Bulk Collect
        Into r_过敏;
      Close c_过敏;

      If r_过敏.Count > 0 Then
        n_Cnt := r_Addrug.Count;
        For I In 1 .. n_Cnt Loop
          n_Tmp := n_Cnt - I + 1;
          For J In 1 .. r_过敏.Count Loop
            If r_Addrug(n_Tmp).诊疗项目id = r_过敏(J).药物id Then
              r_Addrug(n_Tmp).过敏时间 := r_过敏(J).过敏时间;
              r_Addrug(n_Tmp).结果 := r_过敏(J).结果;
            End If;
          End Loop;

          If Not (r_Addrug(n_Tmp).过敏时间 < r_Addrug(n_Tmp).开始执行时间 Or Nvl(r_Addrug(n_Tmp).结果, 0) = 1) Then
            r_Addrug.Delete(n_Tmp); --将满足条件的药品行删掉
          End If;
        End Loop;
      End If;

      If r_Addrug.Count > 0 Then
        --免试项目排除开
        Open c_免试(Lng病人id, Lng主页id);
        Fetch c_免试 Bulk Collect
          Into r_免试;
        Close c_免试;

        If r_免试.Count > 0 Then
          n_Cnt := r_Addrug.Count;
          For I In 1 .. n_Cnt Loop
            n_Tmp := n_Cnt - I + 1;
            For J In 1 .. r_免试.Count Loop
              If r_Addrug(n_Tmp).收费细目id = r_免试(J).药品id Then
                r_Addrug.Delete(n_Tmp);
              Elsif r_Addrug(n_Tmp).诊疗项目id = r_免试(J).项目id Then
                r_Addrug.Delete(n_Tmp);
              End If;
            End Loop;
          End Loop;
        End If;

        For I In 1 .. r_Addrug.Count Loop
          v_Ids := v_Ids || ',' || r_Addrug(I).相关id;
        End Loop;

        If v_Ids Is Not Null Then
          For R In (Select a.Id
                    From 病人医嘱记录 A
                    Where a.诊疗类别 In ('5', '6', 'E') And Instr(',' || v_Ids || ',', ',' || Nvl(a.相关id, ID) || ',') > 0 And
                          a.病人id = Lng病人id And a.主页id = Lng主页id) Loop
            v_Rt := v_Rt || ',' || r.Id;
          End Loop;
          v_Rt := Substr(v_Rt, 2);
        End If;
      End If;
    End If;
    Return v_Rt;
  Exception
    When Err_Custom Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err || '[ZLSOFT]');
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End f_Getnonesendid;

  --输液类医嘱排处理处理，或者获取处理
  Function f_Get输液类医嘱
  (
    F病人id         Number,
    F主页id         Number,
    F病区id         Number,
    Inttype         Number,
    Str输液配置中心 Varchar2
  ) Return Varchar2 Is
    --功能：输液类医嘱的排除，普通发送医嘱时要排开的输液医嘱id,输液医嘱发送时要排开的医嘱id
    --参数：str输液配置中心  配液中心科室
    --      strinfdepids 可接收的病区
    --      Ftype 调用场合，0 - 一般发送窗口，1 - 输液发送窗口
    --说明：营养、自备药/胰岛素、不取药、离院带药
    --输液自备药清单 这张表是 1035130增加的，可能用不到 输液自备药清单  外连  收费细目id = 药品id(+)
    --返回：需要从发送的医嘱中排除掉的  医嘱
    Strinfdepids Varchar2(4000);
    Lngpar期效   Number;
    Str期效      Varchar2(2000);
    Strpar给药   Varchar2(2000);
    Blnok        Boolean;
    Str性质      Varchar2(2000);
    Strtmpall    Varchar2(4000);
    Str自备      Varchar2(4000);
    Str自备输液  Varchar2(4000);
    Str不取      Varchar2(4000);
    Str离院      Varchar2(4000);
    Str营养      Varchar2(4000);
    --Str常规      Varchar2(4000); --普通的正常输液医嘱
    Strall     Varchar2(4000);
    Strnoinids Varchar2(4000);

    Cursor c_Ads Is
      Select a.Id, a.相关id, a.执行性质 As 药品执行性质, a.执行标记 As 药品执行标记, b.执行性质 As 给药执行性质, c.操作类型 As 给药操作类型, c.执行分类 As 给药执行分类,
             c.执行标记 As 给药执行标记, Nvl(a.执行科室id, 0) As 药品执行科室id, c.Id As 给药项目id, 0 As 输液自备, a.医嘱期效
      From 病人医嘱记录 A, 病人医嘱记录 B, 诊疗项目目录 C
      Where a.相关id = b.Id And b.诊疗项目id = c.Id And a.诊疗类别 In ('5', '6') And a.开始执行时间 Is Not Null And
            Nvl(a.执行标记, 0) <> -1 And a.病人来源 <> 3 And Nvl(a.医嘱状态, 0) <> 4 And a.病人id = F病人id And a.主页id = F主页id;
  Begin
    If Str输液配置中心 Is Not Null Then
      Strinfdepids := zl_GetSysParameter('来源病区', 1345);
      If Strinfdepids Is Null Or Instr(',' || Strinfdepids || ',', ',' || F病区id || ',') > 0 Then
        Lngpar期效 := Zl_To_Number(zl_GetSysParameter('医嘱类型', 1345)) - 1;
        If Lngpar期效 = -1 Then
          Str期效 := ',0,1,';
        Else
          Str期效 := Lngpar期效;
        End If;
        Strpar给药 := zl_GetSysParameter('输液给药途径', 1345);

        --一般发送窗口和输液发送窗口两边过滤医嘱恰好相反，能在静配发的就不在一般发送中显示，在取参数值判断时更据入参intType来
        Blnok := Zl_To_Number(zl_GetSysParameter('自备药允许发往静配中心', 1345)) = Inttype;
        If Blnok Then
          Str性质 := Str性质 || '1';
        Else
          Str性质 := Str性质 || '0';
        End If;
        Blnok := Zl_To_Number(zl_GetSysParameter('不取药允许发往静配中心', 1345)) = Inttype;
        If Blnok Then
          Str性质 := Str性质 || '1';
        Else
          Str性质 := Str性质 || '0';
        End If;
        Blnok := Zl_To_Number(zl_GetSysParameter('离院带药允许发往静配中心', 1345)) = Inttype;
        If Blnok Then
          Str性质 := Str性质 || '1';
        Else
          Str性质 := Str性质 || '0';
        End If;

        For R In c_Ads Loop
          Blnok := True;

          If Blnok Then
            --给药途径输液类
            If Nvl(r.给药操作类型, '*') <> 2 Or Nvl(r.给药执行分类, 0) <> 1 Then
              Blnok := False;
            End If;
          End If;

          If Blnok Then
            --满足给药途径参数
            If Strpar给药 Is Not Null Then
              If Instr(',' || Strpar给药 || ',', ',' || r.给药项目id || ',') = 0 Then
                Blnok := False;
              End If;
            End If;
          End If;

          If Blnok Then
            --满足期效参数
            If Instr(',' || Str期效 || ',', ',' || r.医嘱期效 || ',') = 0 Then
              Blnok := False;
            End If;
          End If;

          If Blnok Then
            --满足科室参数
            If Instr(',' || Str输液配置中心 || ',0,', ',' || r.药品执行科室id || ',') = 0 Then
              Blnok := False;
            End If;
          End If;

          If Blnok Then
            If Inttype = 0 Then
              --一般发送窗口
              --常规的静配医嘱，后续会再处理
              If Nvl(r.药品执行科室id, 0) > 0 Then
                If Instr(',' || Strtmpall || ',', ',' || r.相关id || ',') = 0 Then
                  Strtmpall := Strtmpall || ',' || r.相关id;
                End If;
              End If;
            End If;

            If Nvl(r.给药执行性质, 0) <> 5 And Nvl(r.药品执行性质, 0) = 5 And Nvl(r.药品执行标记, 0) = 2 Then
              --不取药
              If Instr(',' || Strall || ',', ',' || r.相关id || ',') = 0 Then
                Str不取 := Str不取 || ',' || r.相关id;
                Strall  := Strall || ',' || r.相关id;
              End If;
            Elsif Nvl(r.给药执行性质, 0) <> 5 And Nvl(r.药品执行性质, 0) = 5 And Nvl(r.药品执行标记, 0) <> 2 Then
              --自备药--需进一步细分：一般自备药，用静配自备药
              --输液自备
              If Nvl(r.输液自备, 0) = 0 Then
                If Instr(',' || Strall || ',', ',' || r.相关id || ',') = 0 Then
                  Str自备 := Str自备 || ',' || r.相关id;
                  Strall  := Strall || ',' || r.相关id;
                End If;
              Else
                If Instr(',' || Strall || ',', ',' || r.相关id || ',') = 0 Then
                  Str自备输液 := Str自备输液 || ',' || r.相关id;
                  Strall      := Strall || ',' || r.相关id;
                End If;
              End If;
            Elsif Nvl(r.给药执行性质, 0) = 5 And Nvl(r.药品执行性质, 0) <> 5 Then
              --离院带药
              If Instr(',' || Strall || ',', ',' || r.相关id || ',') = 0 Then
                Str离院 := Str离院 || ',' || r.相关id;
                Strall  := Strall || ',' || r.相关id;
              End If;
            Elsif Nvl(r.给药执行标记, 0) = 2 Then
              --营养
              If Instr(',' || Strall || ',', ',' || r.相关id || ',') = 0 Then
                Str营养 := Str营养 || ',' || r.相关id;
                Strall  := Strall || ',' || r.相关id;
              End If;
            End If;
          End If;
        End Loop;
        --营养类固定排除
        --当参数启用不接收自备药时，  str自备输液 类要保留下不进行排除
        --依次为：自备药、不取药、离院带药
        If Str性质 = '000' Then
          If Str自备 Is Not Null Then
            Strnoinids := Strnoinids || Str自备;
          End If;
          If Str不取 Is Not Null Then
            Strnoinids := Strnoinids || Str不取;
          End If;
          If Str离院 Is Not Null Then
            Strnoinids := Strnoinids || Str离院;
          End If;
        Elsif Str性质 = '001' Then
          If Str自备 Is Not Null Then
            Strnoinids := Strnoinids || Str自备;
          End If;
          If Str不取 Is Not Null Then
            Strnoinids := Strnoinids || Str不取;
          End If;
        Elsif Str性质 = '010' Then
          If Str自备 Is Not Null Then
            Strnoinids := Strnoinids || Str自备;
          End If;
          If Str离院 Is Not Null Then
            Strnoinids := Strnoinids || Str离院;
          End If;
        Elsif Str性质 = '011' Then
          If Str自备 Is Not Null Then
            Strnoinids := Strnoinids || Str自备;
          End If;
        Elsif Str性质 = '100' Then
          If Str不取 Is Not Null Then
            Strnoinids := Strnoinids || Str不取;
          End If;
          If Str离院 Is Not Null Then
            Strnoinids := Strnoinids || Str离院;
          End If;
        Elsif Str性质 = '101' Then
          If Str不取 Is Not Null Then
            Strnoinids := Strnoinids || Str不取;
          End If;
        Elsif Str性质 = '110' Then
          If Str离院 Is Not Null Then
            Strnoinids := Strnoinids || Str离院;
          End If;
        Elsif Str性质 = '111' Then
          Null;
        End If;

        --一般发送窗口固定排除  营养 、自备输液【输液自备药清单】、常规
        If Inttype = 0 Then
          If Str营养 Is Not Null Then
            Strnoinids := Strnoinids || Str营养;
          End If;

          If Str自备输液 Is Not Null Then
            Strnoinids := Strnoinids || Str自备输液;
          End If;

          If Strtmpall Is Not Null Then
            Strnoinids := Strnoinids || Strtmpall;
          End If;
        End If;
        Strnoinids := Substr(Strnoinids, 2);
        --去重复的id，其实可以不用去重复
      End If;
    End If;
    Return Strnoinids;
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End f_Get输液类医嘱;

  --通过执行次数来计算分解时间
  Function f_Calc次数分解时间
  (
    次数_In     In 病人医嘱记录.总给予量%Type,
    开始时间_In In Date,
    终止时间_In In Date,
    执行时间_In In 病人医嘱记录.执行时间方案%Type,
    频率间隔_In In 病人医嘱记录.频率间隔%Type,
    间隔单位_In In 病人医嘱记录.间隔单位%Type,
    v_Pause     In Varchar2 := Null
  ) Return Varchar2 Is
    v_Detailtime Varchar2(32760);
    n_First      Number(1);
    v_First      病人医嘱记录.执行时间方案%Type;
    v_Normal     病人医嘱记录.执行时间方案%Type;
    v_Mtime      Varchar(100);
    v_Rtime      Varchar(100);
    v_Curtime    Date;
    v_Tmptime    Date;
    n_Cnt        Number; --计数器
  Begin
    n_Cnt := 0;
    --执行时间方案基准
    If Nvl(Instr(执行时间_In, ','), 0) > 0 Then
      v_First  := Substr(执行时间_In, 1, Instr(执行时间_In, ',') - 1);
      v_Normal := Substr(执行时间_In, Instr(执行时间_In, ',') + 1);
    Else
      v_First  := Null;
      v_Normal := 执行时间_In;
    End If;

    If 间隔单位_In = '周' Then
      v_Curtime := b_Zlhis_Ciskernel.f_Getweekbase(开始时间_In); --按周执行时在医嘱开始那周的星期一作为基准
    Else
      v_Curtime := 开始时间_In;
    End If;
    If 间隔单位_In = '周' Then
      If v_First Is Not Null Then
        If v_Curtime = b_Zlhis_Ciskernel.f_Getweekbase(开始时间_In) Then
          n_First := 1;
        End If;
      End If;
      While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop
        If Nvl(n_First, 0) = 1 Then
          v_Rtime := v_First || '-';
        Else
          v_Rtime := v_Normal || '-';
        End If;
        n_First := 0;
        --1/8:00-3/8:00-5/8:00
        While v_Rtime Is Not Null Loop
          v_Mtime   := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
          v_Tmptime := v_Curtime + To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, '/') - 1)) - 1;
          v_Mtime   := Substr(v_Mtime, Instr(v_Mtime, '/') + 1);
          If Instr(v_Mtime, ':') = 0 Then
            v_Mtime := v_Mtime || ':00';
          End If;
          v_Tmptime := Trunc(v_Tmptime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
          If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In And b_Zlhis_Ciskernel.f_Timeispause(v_Tmptime, v_Pause) Then
            v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
            n_Cnt        := n_Cnt + 1;
            If n_Cnt >= 次数_In Then
              Exit;
            End If;
          Elsif v_Tmptime > 终止时间_In Then
            Exit;
          End If;
          v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
        End Loop;
        v_Curtime := Trunc(v_Curtime + 7);
      End Loop;
    Elsif 间隔单位_In = '天' Then
      If v_First Is Not Null Then
        If Trunc(开始时间_In) = Trunc(开始时间_In) Then
          n_First := 1;
        End If;
      End If;
      While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop
        If Nvl(n_First, 0) = 1 Then
          v_Rtime := v_First || '-';
        Else
          v_Rtime := v_Normal || '-';
        End If;
        n_First := 0;
        If 频率间隔_In = 1 Then
          --8:00-12:00-14:00；8-12-14
          While v_Rtime Is Not Null Loop
            v_Mtime := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
            If Instr(v_Mtime, ':') = 0 Then
              v_Mtime := v_Mtime || ':00';
            End If;
            v_Tmptime := Trunc(v_Curtime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
            If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In And b_Zlhis_Ciskernel.f_Timeispause(v_Tmptime, v_Pause) Then

              v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
              n_Cnt        := n_Cnt + 1;
              If n_Cnt >= 次数_In Then
                Exit;

              End If;
            Elsif v_Tmptime > 终止时间_In Then
              Exit;
            End If;
            v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
          End Loop;
        Else
          --1/8:00-1/15:00-2/9:00
          While v_Rtime Is Not Null Loop
            v_Mtime   := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
            v_Tmptime := v_Curtime + To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, '/') - 1)) - 1;
            v_Mtime   := Substr(v_Mtime, Instr(v_Mtime, '/') + 1);
            If Instr(v_Mtime, ':') = 0 Then
              v_Mtime := v_Mtime || ':00';
            End If;
            v_Tmptime := Trunc(v_Tmptime) + (To_Date(v_Mtime, 'HH24:MI:SS') - Trunc(To_Date(v_Mtime, 'HH24:MI:SS')));
            If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In And b_Zlhis_Ciskernel.f_Timeispause(v_Tmptime, v_Pause) Then

              v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
              n_Cnt        := n_Cnt + 1;
              If n_Cnt >= 次数_In Then
                Exit;

              End If;
            Elsif v_Tmptime > 终止时间_In Then
              Exit;
            End If;
            v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
          End Loop;
        End If;
        v_Curtime := Trunc(v_Curtime + 频率间隔_In); --因为Loop条件注意要取整
      End Loop;
    Elsif 间隔单位_In = '小时' Then
      --10:00-20:00-40:00；10-20-40；02:30
      While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop

        v_Rtime := 执行时间_In || '-';
        While v_Rtime Is Not Null Loop
          v_Mtime := Substr(v_Rtime, 1, Instr(v_Rtime, '-') - 1);
          If Instr(v_Mtime, ':') = 0 Then
            v_Tmptime := v_Curtime + (To_Number(v_Mtime) - 1) / 24;
          Else
            v_Tmptime := v_Curtime + (To_Number(Substr(v_Mtime, 1, Instr(v_Mtime, ':') - 1)) - 1) / 24 +
                         To_Number(Substr(v_Mtime, Instr(v_Mtime, ':') + 1)) / 60 / 24;
          End If;

          If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In And b_Zlhis_Ciskernel.f_Timeispause(v_Tmptime, v_Pause) Then

            v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
            n_Cnt        := n_Cnt + 1;
            If n_Cnt >= 次数_In Then
              Exit;
            End If;

          Elsif v_Tmptime > 终止时间_In Then
            Exit;
          End If;
          v_Rtime := Substr(v_Rtime, Instr(v_Rtime, '-') + 1);
        End Loop;
        v_Curtime := v_Curtime + 频率间隔_In / 24;
      End Loop;
    Elsif 间隔单位_In = '分钟' Then
      --无执行时间
      While v_Curtime <= 终止时间_In And n_Cnt < 次数_In Loop
        v_Tmptime := v_Curtime;
        If v_Tmptime >= 开始时间_In And v_Tmptime <= 终止时间_In And b_Zlhis_Ciskernel.f_Timeispause(v_Tmptime, v_Pause) Then
          v_Detailtime := v_Detailtime || ',' || To_Char(v_Tmptime, 'YYYY-MM-DD HH24:MI:SS');
          n_Cnt        := n_Cnt + 1;
          If n_Cnt >= 次数_In Then
            Exit;
          End If;
        Elsif v_Tmptime > 终止时间_In Then
          Exit;
        End If;
        v_Curtime := v_Curtime + 频率间隔_In / (24 * 60);
      End Loop;
    End If;
    If v_Detailtime Is Not Null Then
      v_Detailtime := Substr(v_Detailtime, 2);
    End If;
    Return(v_Detailtime);
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Calc次数分解时间出错[ZLSOFT]');
  End f_Calc次数分解时间;

  --根据收费细目ID或收入项目ID(前者优先),应收金额,按费别设置的分段比例打折规则计算实收金额
  Function f_Actualmoney
  (
    费别_In       In Varchar2,
    收入项目id_In In Number,
    应收金额_In   In Number,
    收费细目id_In In Number,
    库房id_In     In Number,
    数量_In       In Number,
    加班加价率_In In Number,
    费别_Out      Out Varchar2,
    医嘱id_In     In Number := Null
  ) Return Number Is
    n_金额 病人医嘱计价.单价%Type := 0;
    v_Tmp  Varchar2(80);
  Begin
    Select Zl_Actualmoney(费别_In, 收费细目id_In, 收入项目id_In, (应收金额_In / (1 + 加班加价率_In)), 数量_In, 库房id_In, 医嘱id_In) As Actualmoney
    Into v_Tmp
    From Dual;
    费别_Out := Substr(v_Tmp, 1, Instr(v_Tmp, ':') - 1);
    n_金额   := To_Number(Substr(v_Tmp, Instr(v_Tmp, ':') + 1));
    Return(n_金额);
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Actualmoney出错[ZLSOFT]');
  End f_Actualmoney;

  --时价单计算
  Function f_Calcdrugprice
  (
    药品id_In  In Number,
    药房id_In  In Number,
    数量_In    In Number,
    费别_In    In Varchar2 := Null,
    n_Dec      In Number := Null,
    v_动态费别 In Varchar2 := Null
  ) Return Number Is
    n_时价   收费价目.现价%Type := 0;
    n_总数量 收费价目.现价%Type := 0;
    v_Tmp    Varchar2(80);
    v_费别   Varchar2(800);
  Begin
    Select Zl_Fun_Getprice(药品id_In, 药房id_In, 数量_In, 0, Null) As 结果 Into v_Tmp From Dual;
    If v_Tmp Is Not Null Then
      v_Tmp    := v_Tmp || '|';
      n_时价   := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1));
      v_Tmp    := Substr(v_Tmp, Instr(v_Tmp, '|') + 1);
      n_总数量 := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1));
    End If;
    If n_总数量 = 0 And 费别_In Is Not Null Then
      n_时价 := Round(n_时价 * 数量_In, n_Dec);
      For R In (Select a.屏蔽费别, b.收入项目id
                From 收费项目目录 A, 收费价目 B
                Where a.Id = b.收费细目id And a.Id = 药品id_In And
                      ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null))) Loop
        If Not (Nvl(r.屏蔽费别, 0) = 1) Then
          v_费别 := 费别_In;
          If v_动态费别 Is Not Null Then
            v_费别 := v_费别 || ',' || v_动态费别;
          End If;
          n_时价 := f_Actualmoney(v_费别, r.收入项目id, n_时价, 药品id_In, 药房id_In, 数量_In, 0, v_Tmp);
        End If;
      End Loop;
    End If;
    Return(n_时价);
  End f_Calcdrugprice;

  --住院医嘱读取和主体发送过程
  Procedure f_Advicesendin
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --详细说见邮件中的文档
  --自定义类型----------------------------------------------------------------------------------------------
  --医嘱表格类型
  Type r_Advice Is Record(
    选择         Number,
    婴儿         Varchar2(40), --固定值：病人/婴儿X
    科室         Varchar2(40),
    姓名         Varchar2(400),
    住院号       Varchar2(40),
    床号         Varchar2(40),
    期效         Varchar2(40),
    费别         Varchar2(400),
    紧急         Varchar2(40),
    医嘱内容     Varchar2(4000),
    总量         Number(16, 5),
    总量单位     Varchar2(50),
    单量         Number(16, 5),
    单量单位     Varchar2(50),
    金额         Number(16, 5),
    频率         Varchar2(500),
    用法         Varchar2(500),
    医生嘱托     Varchar2(4000),
    执行时间方案 Varchar2(40),
    执行科室     Varchar2(500),
    执行性质     Varchar2(500),
    附加执行     Varchar2(500),
    医疗付款方式 varchar2(100),
    隐藏行         Number,
    禁止发送       Number,
    禁止原因       Varchar2(4000),
    组id           Number(18),
    组号           Number(18),
    序号           Number(18),
    病人id         Number(18),
    主页id         Number(18),
    年龄           Varchar2(40),
    病人病区id     Number(18),
    病人科室id     Number(18),
    婴儿序号       Number(2), --婴儿序号
    开嘱科室id     Number(18),
    开嘱医生       Varchar2(500),
    执行科室id     Number(18),
    ID             Number(18),
    相关id         Number(18),
    医嘱期效       Number(1),
    计价特性       Number(1),
    检查方法       Varchar2(500),
    诊疗类别       Varchar2(500),
    执行性质id     Number(18),
    操作类型       Varchar2(200),
    执行分类       Number(1),
    试管编码       Varchar2(500),
    标本部位       Varchar2(500),
    紧急标志       Number(1),
    附加执行科室id Number(18), ----检验医嘱的，采集行的执行科室ID,药品医嘱的给途径执行科室ID
    药品执行类别   Number(1), ---1-给药途径，2-中药煎法，3-中药服法
    给药途径项目id Number(18), --给药途径诊疗项目id
    分解时间       Varchar2(32760), --医嘱执行时间点

    收费细目id       Number(18),
    险类             Varchar2(400),
    计算方式         Varchar2(500),
    可否分零         Number(1),
    住院包装         Number(16, 5), --药品特有
    剂量系数         Varchar2(500),
    首次时间         Varchar2(500),
    末次时间         Varchar2(500),
    是否修改执行科室 Number, ----暂时未用
    阳性用药说明     Varchar2(4000),
    执行标记         Number(1),
    诊疗项目         Varchar2(4000),
    频率间隔         Number(3),
    间隔单位         Varchar2(400),
    频率次数         Number(3),
    开始执行时间     Date,
    上次执行时间     Date,
    开嘱时间         Date,
    执行终止时间     Date,
    首次用量         Number(16, 5),
    审核状态         Number(1),
    医嘱状态         Number(1),
    频率标记         Number(1),
    发送号           Number(18),
    口服药           Number(1),

    -----以前为目前用到了的字段------------------------------------------
    摘要       Varchar2(4000), --摘要
    用药理由   Varchar2(300),
    性别       Varchar2(400),
    计算单位   Varchar2(400),
    跟踪在用   Number(1),
    诊疗项目id Number(18),
    库存       Number(16, 5),
    天数       Number(3),
    次数       Varchar2(500),
    前提id     Number(18),
    签名id     Number(18),
    零费记帐   Varchar2(500),
    开始时间   Varchar2(500),
    病人性质   Number,
    执行安排   Varchar2(500),
    毒理分类   Varchar2(500),
    规格       Varchar2(4000),
    入院日期   Date,
    会诊医嘱id Number(18),
    药房分批   Number,
    是否变价   Number,
    住院单位   Varchar2(8));

  --药品规格相关信息
  Type r_Druginfo Is Record(
    药名id   Number(18),
    药品id   Number(18),
    剂量系数 Number(16, 5),
    住院包装 Number(16, 5),
    住院单位 Varchar2(8),
    可否分零 Number(1),
    动态分零 Number(1),
    药房分批 Number(1),
    是否变价 Number(1),
    库存     Number(16, 5),
    编码     Varchar2(60),
    名称     Varchar2(300),
    规格     Varchar2(300),
    产地     Varchar2(300),
    撤档时间 Date,
    服务对象 Varchar2(6),
    是否摆药 Number(1));

  Type r_Moneynow Is Record(
    医嘱id     Number(18),
    诊疗项目id Number(18),
    收费项目id Number(18),
    试管编码   Varchar2(18),
    样本条码   Varchar2(18),
    收费方式   Number(1),
    收费时间   Varchar2(18),
    执行部门id Number(18));

  Type r_Moneyday Is Record(
    诊疗项目id Number(18),
    收费项目id Number(18),
    执行部门id Number(18),
    收费方式   Number(1),
    执行否     Number(18),
    收费时间   Varchar2(30));

  --医嘱发送记录sql
  Type r_医嘱发送_Sql Is Record(
    医嘱id     病人医嘱发送.医嘱id%Type,
    发送号     病人医嘱发送.发送号%Type,
    记录性质   病人医嘱发送.记录性质%Type,
    NO         病人医嘱发送.No%Type,
    记录序号   病人医嘱发送.记录序号%Type,
    发送数次   病人医嘱发送.发送数次%Type,
    首次时间   病人医嘱发送.首次时间%Type,
    末次时间   病人医嘱发送.末次时间%Type,
    发送时间   病人医嘱发送.发送时间%Type,
    执行状态   病人医嘱发送.执行状态%Type,
    执行部门id 病人医嘱发送.执行部门id%Type,
    计费状态   病人医嘱发送.计费状态%Type,
    First      Number := 0,
    样本条码   病人医嘱发送.样本条码%Type := Null,
    操作员编号 人员表.编号%Type := Null,
    操作员姓名 人员表.姓名%Type := Null,
    领药号     未发药品记录.领药号%Type := Null,
    门诊记帐   病人医嘱发送.门诊记帐%Type := Null,
    分解时间   Varchar2(32760),
    原液皮试   Varchar2(4000));

  --医嘱执行计价SQL
  Type r_执行计价_Sql Is Record(
    医嘱id     医嘱执行计价.医嘱id%Type,
    发送号     医嘱执行计价.发送号%Type,
    要求时间   医嘱执行计价.要求时间%Type,
    收费细目id 医嘱执行计价.收费细目id%Type,
    数量       医嘱执行计价.数量%Type,
    费用性质   医嘱执行计价.费用性质%Type);

  --住院记帐_SQL
  Type r_住院记帐_Sql Is Record(
    NO             住院费用记录.No%Type,
    序号           住院费用记录.序号%Type,
    病人id         住院费用记录.病人id%Type,
    主页id         住院费用记录.主页id%Type,
    标识号         住院费用记录.标识号%Type,
    姓名           住院费用记录.姓名%Type,
    性别           住院费用记录.性别%Type,
    年龄           住院费用记录.年龄%Type,
    床号           住院费用记录.床号%Type,
    费别           住院费用记录.费别%Type,
    病区id         住院费用记录.病人病区id%Type,
    科室id         住院费用记录.病人科室id%Type,
    加班标志       住院费用记录.加班标志%Type,
    婴儿费         住院费用记录.婴儿费%Type,
    开单部门id     住院费用记录.开单部门id%Type,
    开单人         住院费用记录.开单人%Type,
    从属父号       住院费用记录.从属父号%Type,
    收费细目id     住院费用记录.收费细目id%Type,
    收费类别       住院费用记录.收费类别%Type,
    计算单位       住院费用记录.计算单位%Type,
    保险项目否     住院费用记录.保险项目否%Type,
    保险大类id     住院费用记录.保险大类id%Type,
    保险编码       住院费用记录.保险编码%Type,
    付数           住院费用记录.付数%Type,
    数次           住院费用记录.数次%Type,
    附加标志       住院费用记录.附加标志%Type,
    执行部门id     住院费用记录.执行部门id%Type,
    价格父号       住院费用记录.价格父号%Type,
    收入项目id     住院费用记录.收入项目id%Type,
    收据费目       住院费用记录.收据费目%Type,
    标准单价       住院费用记录.标准单价%Type,
    应收金额       住院费用记录.应收金额%Type,
    实收金额       住院费用记录.实收金额%Type,
    统筹金额       住院费用记录.统筹金额%Type,
    发生时间       住院费用记录.发生时间%Type,
    登记时间       住院费用记录.登记时间%Type,
    药品摘要       药品收发记录.摘要%Type,
    划价           Number,
    操作员编号     住院费用记录.操作员编号%Type,
    操作员姓名     住院费用记录.操作员姓名%Type,
    多病人单       Number := 0,
    类别id         药品单据性质.类别id%Type := Null,
    记帐单id       住院费用记录.记帐单id%Type := Null,
    费用摘要       住院费用记录.摘要%Type := Null,
    是否急诊       住院费用记录.是否急诊%Type := 0,
    医嘱序号       住院费用记录.医嘱序号%Type := Null,
    频次           药品收发记录.频次%Type := Null,
    单量           药品收发记录.单量%Type := Null,
    用法           药品收发记录.用法%Type := Null, --用法[|煎法]
    期效           药品收发记录.扣率%Type := Null,
    计价特性       药品收发记录.扣率%Type := Null,
    简单记帐       Number := 0,
    费用类型       住院费用记录.费用类型%Type := Null,
    医技补临床费用 Number := 0,
    领药部门id     药品收发记录.对方部门id%Type := Null,
    中药形态       住院费用记录.结论%Type := Null,
    医疗小组id     住院费用记录.医疗小组id%Type := -1,
    备货材料       Number := 0,
    批次           药品收发记录.批次%Type := Null);

  --自动发料可执行SQL
  Type r_处方发料_Sql Is Record(
    Partid   药品收发记录.库房id%Type,
    Bill     药品收发记录.单据%Type,
    NO       药品收发记录.No%Type,
    People   药品收发记录.审核人%Type,
    配药人   药品收发记录.配药人%Type,
    校验人   药品收发记录.填制人%Type,
    发药方式 药品收发记录.发药方式%Type,
    发药时间 药品收发记录.审核日期%Type);

  --项目收费对照
  Type r_Price Is Record(
    组id       Number(18),
    医嘱id     Number(18),
    相关id     Number(18),
    费用性质   Number(18),
    收费方式   Number(18),
    收费类别   Varchar2(500),
    收费细目id Number(18),
    执行科室id Number(18),
    数量       Number(16, 5),
    总量       Number(16, 5),
    单价       Number(16, 5),
    在用       Number(18),
    变价       Number(18),
    从项       Number(18),
    固定       Number(18));

  --管码相关信息
  Type r_Number Is Record(
    管码       Varchar2(30),
    相关id     Number(18),
    样本条码   Varchar2(18),
    执行科室id Number(18),
    诊疗项目id Number(18),
    婴儿       Number(1),
    紧急标志   Number(1),
    标本       Varchar2(18),
    采集科室id Number(18));

  --单据号相关
  Type r_Bill Is Record(
    Key      Varchar2(200),
    NO       Varchar2(30),
    费用序号 Number(18),
    发送序号 Number(18));

  --执行时间相关
  Type r_Exec Is Record(
    医嘱id     Number(18),
    发送号     Number(18),
    收费细目id Number(18),
    要求时间   Date,
    数量       Number(16, 5),
    费用性质   Number(1));
  --动态游标类型
  Type Rs_Recordset Is Ref Cursor;

  --------------------------------------------------------------------------------------------------------------------------------
  --------转换为表类型，二维数组------------------
  Type t_Druginfo Is Table Of r_Druginfo;
  Type t_Advice Is Table Of r_Advice;
  Type t_Number Is Table Of r_Number;
  Type t_Price Is Table Of r_Price;
  Type t_医嘱发送_Sql Is Table Of r_医嘱发送_Sql;
  Type t_执行计价_Sql Is Table Of r_执行计价_Sql;
  Type t_住院记帐_Sql Is Table Of r_住院记帐_Sql;
  Type t_Exec Is Table Of r_Exec;
  Type t_Bill Is Table Of r_Bill;
  Type t_Moneynow Is Table Of r_Moneynow;
  Type t_Moneyday Is Table Of r_Moneyday;
  Type t_处方发料_Sql Is Table Of r_处方发料_Sql;
  ----------------------------------------------------------------------------------------------------------------------------------

  --记录集类型变量[二维数组，类似表类型]--------------------------------------------------------------------------------------------
  Vsadvice    t_Advice; ----全局的医嘱缓存信息
  Rs_Price    t_Price; ----全局记价信息，属于医嘱的次级信息
  Rs_Number   t_Number; --试管编码相关
  r_执行计价  t_执行计价_Sql;
  Rs_Bill     t_Bill; --单据缓存相关
  Rs_Exec     t_Exec;
  Rs_Moneynow t_Moneynow;
  Rs_Moneyday t_Moneyday;
  r_费用      t_住院记帐_Sql;
  r_发料      t_处方发料_Sql;
  r_发送      t_医嘱发送_Sql;
  ----------------------------------------------------------------------------------------------------------------------------------

  --参数相关变量--------------------------------------------------------------------------------------------------------------------
  Gbyt药品名称显示           Number;
  Gbyt住院自动发料           Number;
  Gstr输液配置中心           Varchar2(4000);
  Gb_加班加价                Boolean; --外部传入
  Gn_Dec                     Number;
  Gn_Decprice                Number; --系统参数
  Gb_从项汇总折扣            Boolean;
  Gbyt领药号                 Number;
  Gbln发送生成条形码         Boolean;
  Gstr住院发送划价单         Varchar2(4000);
  Gbln血库系统               Boolean;
  Mblndruguse                Boolean;
  Mbln检查单独产生单据       Boolean;
  Mbln检验单独产生单据       Boolean;
  Mint住院领药部门           Number;
  Mblnlimit                  Boolean; --本次发送给药途径计算是否以结束时间限制，不限制则执行时间点变多
  Mstrendpoint               Varchar2(40);
  Mbln药品长嘱从当天开始发送 Boolean; --外部传入
  ------------------------------------------------------------------------------------------------------------

  --过程级变量，规则 (一个字符 + 下划线 + 名称) ------------------------------------------------------------------------------------------------
  Mn_病人id       病人医嘱记录.病人id%Type;
  Mn_主页id       病人医嘱记录.主页id%Type;
  Mv_截止日期     Varchar2(30);
  Mv_站点         Varchar2(20);
  Md_截止日期     Date;
  Mv_操作员编号   Varchar2(200);
  Mv_操作员姓名   Varchar2(200);
  Mv_领药号       Varchar2(200);
  Mn_病区id       病人医嘱记录.病人id%Type; ----界面上选择的病区
  Mlng卫材类别id  Number;
  Mlng药品类别id  Number;
  Mn_Nosequence   Number;
  Mn_Tmp          Number;
  Mn_功能         Number;
  Mv_Tmp          Varchar2(4000);
  Mn_发送号       病人医嘱发送.发送号%Type;
  Mx_前置条件     Xmltype;
  Mx_医嘱数据     Xmltype;
  Mx_病人         Xmltype;
  Mx_药房         Xmltype;
  Mn_医嘱处理范围 Number(1); --0常规，1-备用
  Mn_病人范围     Number(1); --病人医嘱范围，0-所有，1-病人，2-婴儿
  Mv_备用执行时间 Varchar2(30);
  Md_备用执行时间 Date;
  Mx_Yzids        Xmltype;
  Mn_药房置换     Number(1);
  Mn_Mday         Number(1); --为保证 Rs_Moneyday一个病人只查询一次;
  Mv_给药项目ids  Varchar2(32000); --给药途径诊疗项目id 逗号拼串，外部传入
  Mn_发药药房id   Number(18);
  Mn_执行科室id   Number(18);
  Mv_诊疗类别     Varchar2(30000);
  Mn_药品长嘱     Number(1);
  Mn_药品临嘱     Number(1);
  Mn_非药长嘱     Number(1);
  Mn_非药临嘱     Number(1);
  -----------------------------------------------------------------------------------------------------------------------------------------------

  --一并给的第一个药品的执行科室
  Function f_Getmergedrugstore(Row_In In Number) Return Number Is
    n_药房id 部门表.Id%Type := 0;
    n_Begin  Number := 1;
  Begin
    If Nvl(Vsadvice(Row_In).相关id, 0) <> Nvl(Vsadvice(Row_In - 1).相关id, 0) And Nvl(Vsadvice(Row_In).执行科室id, 0) <> 0 Then
      n_药房id := Nvl(Vsadvice(Row_In).执行科室id, 0);
    Else
      For I In 1 .. Row_In - 1 Loop
        If Nvl(Vsadvice(Row_In).相关id, 0) = Nvl(Vsadvice(I).相关id, 0) Then
          If Nvl(Vsadvice(I).执行科室id, 0) <> 0 Then
            n_药房id := Nvl(Vsadvice(I).执行科室id, 0);
            Exit;
          End If;
        Else
          Exit;
        End If;
      End Loop;
      For I In n_Begin .. Vsadvice.Count Loop
        If Nvl(Vsadvice(Row_In).相关id, 0) <> Nvl(Vsadvice(I).相关id, 0) Then
          n_Begin := I;
          Exit;
        End If;
      End Loop;
    End If;
    Return(n_药房id);
  End f_Getmergedrugstore;

  --获取药品规格信息
  Function f_Getdruginfo
  (
    F诊疗项目id 诊疗项目目录.Id%Type,
    F收费细目id 诊疗项目目录.Id%Type,
    F库房id     诊疗项目目录.Id%Type,
    F开单id     诊疗项目目录.Id%Type,
    Ft_Dg       Out t_Druginfo
  ) Return Number Is
    --特殊说明：

    F名称显示 Number;
    --明确了药品规格的
    Cursor c_规格1 Is
      Select a.药名id, a.药品id, a.剂量系数, a.住院包装, a.住院单位, a.住院可否分零 As 可否分零, a.动态分零, a.药房分批, b.是否变价, c.库存 / a.住院包装 As 库存, b.编码,
             Nvl(d.名称, b.名称) As 名称, b.规格, b.产地, b.撤档时间, b.服务对象, a.是否摆药
      From 药品规格 A, 收费项目目录 B,
           (Select 药品id, Sum(Nvl(可用数量, 0)) As 库存
             From 药品库存
             Where (Nvl(批次, 0) = 0 Or 效期 Is Null Or 效期 > Trunc(Sysdate)) And 性质 = 1 And 库房id = F库房id And 药品id = F收费细目id
             Group By 药品id
             Having Sum(Nvl(可用数量, 0)) <> 0) C, 收费项目别名 D
      Where a.药品id = b.Id And a.药品id = c.药品id(+) And b.Id = d.收费细目id(+) And d.码类(+) = 1 And d.性质(+) = F名称显示 And
            (b.站点 = Mv_站点 Or b.站点 Is Null) And b.服务对象 In (2, 3) And
            (b.撤档时间 Is Null Or b.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And a.药名id = F诊疗项目id And a.药品id = F收费细目id
      --And Exists (select 1 from 收费执行科室 x Where (x.开单科室id =F开单id Or x.开单科室id Is Null) And Nvl(x.病人来源, 2) = 2 And x.执行科室ID =F库房id And x.收费细目id=a.药品id)
      Order By b.编码;

    --按品种下达的
    Cursor c_规格2 Is
      Select a.药名id, a.药品id, a.剂量系数, a.住院包装, a.住院单位, a.住院可否分零 As 可否分零, a.动态分零, a.药房分批, b.是否变价, c.库存 / a.住院包装 As 库存, b.编码,
             Nvl(d.名称, b.名称) As 名称, b.规格, b.产地, b.撤档时间, b.服务对象, a.是否摆药
      From 药品规格 A, 收费项目目录 B,
           (Select 药品id, Sum(Nvl(可用数量, 0)) As 库存
             From 药品库存
             Where (Nvl(批次, 0) = 0 Or 效期 Is Null Or 效期 > Trunc(Sysdate)) And 性质 = 1 And 库房id = F库房id
             Group By 药品id
             Having Sum(Nvl(可用数量, 0)) <> 0) C, 收费项目别名 D
      Where a.药品id = b.Id And a.药品id = c.药品id(+) And b.Id = d.收费细目id(+) And d.码类(+) = 1 And d.性质(+) = F名称显示 And
            (b.站点 = Mv_站点 Or b.站点 Is Null) And b.服务对象 In (2, 3) And
            (b.撤档时间 Is Null Or b.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And a.药名id = F诊疗项目id
      --And Exists (select 1 from 收费执行科室 x Where (x.开单科室id =F开单id Or x.开单科室id Is Null) And Nvl(x.病人来源, 2) = 2 And x.执行科室ID =F库房id And x.收费细目id=a.药品id)
      Order By b.编码;
  Begin
    If Gbyt药品名称显示 = 0 Then
      F名称显示 := 1;
    Else
      F名称显示 := 3;
    End If;
    Ft_Dg := t_Druginfo();
    If Nvl(F收费细目id, 0) = 0 Then
      Open c_规格2;
      Fetch c_规格2 Bulk Collect
        Into Ft_Dg;
      Close c_规格2;
    Else
      Open c_规格1;
      Fetch c_规格1 Bulk Collect
        Into Ft_Dg;
      Close c_规格1;
    End If;
    Return(1);
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Getdruginfo出错[ZLSOFT]');
  End f_Getdruginfo;

  Function f_Calc总量次数时间非药
  (
    Ft_Advice r_Advice,
    F次数     Out Number,
    F分解     Out Varchar2
  ) Return Number Is
    Strpause Varchar2(32760);
    Datbegin Date;
    Datend   Date;
    --功能：非药的长期医嘱计价总量次数时间
  Begin
    F次数 := 0;
    F分解 := Null;
    If Ft_Advice.医嘱状态 <> 1 Then
      Strpause := b_Zlhis_Ciskernel.f_Getadvicepause(Ft_Advice.Id);
    End If;

    --当前医嘱的发送计算时间段
    Datbegin := Ft_Advice.开始执行时间;
    If Ft_Advice.上次执行时间 Is Not Null Then
      If Ft_Advice.执行时间方案 Is Null And
         (Nvl(Ft_Advice.频率次数, 0) = 0 Or Nvl(Ft_Advice.频率间隔, 0) = 0 Or Ft_Advice.间隔单位 Is Null) Then
        Datbegin := Ft_Advice.上次执行时间 + 1 / 24 / 60 / 60; --持继续性项目
      Else
        Datbegin := b_Zlhis_Ciskernel.f_Calc本周期开始时间(Ft_Advice.开始执行时间, Ft_Advice.上次执行时间, Ft_Advice.频率间隔, Ft_Advice.间隔单位);
        If Datbegin <= Ft_Advice.上次执行时间 Then
          Strpause := Strpause || ';' || To_Char(Datbegin, 'yyyy-MM-dd HH24:MI:SS') || ',' ||
                      To_Char(Ft_Advice.上次执行时间, 'yyyy-MM-dd HH24:MI:SS');
          If Substr(Strpause, 1, 1) = ';' Then
            Strpause := Substr(Strpause, 2);
          End If;
        End If;
      End If;
    End If;
    Datend := Md_截止日期;
    If Ft_Advice.执行终止时间 Is Not Null Then
      If Ft_Advice.执行终止时间 < Datend Then
        Datend := Ft_Advice.执行终止时间;
      End If;
    End If;

    --计算分解时间及次数
    If Ft_Advice.执行时间方案 Is Null And
       (Nvl(Ft_Advice.频率次数, 0) = 0 Or Nvl(Ft_Advice.频率间隔, 0) = 0 Or Ft_Advice.间隔单位 Is Null) Then
      F次数 := b_Zlhis_Ciskernel.f_Calc持续性长嘱次数(Datbegin, Datend, To_Char(Ft_Advice.上次执行时间, 'yyyy-MM-dd HH:mm:ss'),
                                             To_Char(Ft_Advice.执行终止时间, 'yyyy-MM-dd HH:mm:ss'), Strpause, F分解);
    Else
      --执行频率为"可选频率"的项目
      F分解 := b_Zlhis_Ciskernel.f_Calc段内分解时间(Datbegin, Datend, Strpause, Ft_Advice.执行时间方案, Ft_Advice.频率间隔, Ft_Advice.间隔单位,
                                            Ft_Advice.开始执行时间);
      F次数 := To_Number(b_Zlhis_Ciskernel.f_Stranal(F分解, 1));
    End If;
    Return 1;
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Calc总量次数时间非药出错[ZLSOFT]');
  End f_Calc总量次数时间非药;

  Function f_Calc总量次数时间
  (
    Ft_Advice r_Advice,
    Ft_Dg     r_Druginfo,
    Fv_End    Varchar2,
    F总量     Out Number,
    F次数     Out Number,
    F分解     Out Varchar2
  ) Return Number Is
    --功能：对长期成药医嘱计算总量,执行次数,执行时间分解
    --F口服 长嘱口服药指定结束时间
    F口服摆药      Number;
    Strpause       Varchar2(32760);
    Datbegin       Date;
    Datend         Date;
    Lng次数out     Number;
    Str分解时间out Varchar2(32760);
    v_Tmp          Varchar2(300);
  Begin
    --当前医嘱的暂停时间段:"暂停时间,开始时间;...."
    If Ft_Advice.医嘱状态 <> 1 Then
      Strpause := b_Zlhis_Ciskernel.f_Getadvicepause(Ft_Advice.Id);
    End If;
    --当前医嘱的发送计算时间段
    Datbegin := Ft_Advice.开始执行时间;

    If Ft_Advice.上次执行时间 Is Not Null Then
      Datbegin := b_Zlhis_Ciskernel.f_Calc本周期开始时间(Ft_Advice.开始执行时间, Ft_Advice.上次执行时间, Ft_Advice.频率间隔, Ft_Advice.间隔单位);

      If Datbegin <= Ft_Advice.上次执行时间 Then
        --在往后扩展时间时,最后一个周期内已执行的时间不再计算,按暂停处理
        Strpause := Strpause || ';' || To_Char(Datbegin, 'YYYY-MM-DD HH24:MI:SS') || ',' ||
                    To_Char(Ft_Advice.上次执行时间, 'YYYY-MM-DD HH24:MI:SS');
        If Substr(Strpause, 1, 1) = ';' Then
          Strpause := Substr(Strpause, 2);
        End If;
      End If;
    End If;

    --长嘱口服药，
    If Nvl(Ft_Advice.口服药, 0) = 1 And Nvl(Ft_Dg.是否摆药, 0) = 1 And Mstrendpoint Is Not Null Then
      Null;

      v_Tmp     := Substr(Fv_End, 1, 10) || Mstrendpoint;
      Datend    := To_Date(v_Tmp, 'YYYY-MM-DD HH24:MI:SS');
      F口服摆药 := 1;
    Else
      Datend := To_Date(Fv_End, 'YYYY-MM-DD HH24:MI:SS');
    End If;

    If Ft_Advice.执行终止时间 Is Not Null Then
      If Ft_Advice.执行终止时间 < Datend Then
        Datend := Ft_Advice.执行终止时间;
      End If;
    End If;

    F分解 := b_Zlhis_Ciskernel.f_Calc段内分解时间(Datbegin, Datend, Strpause, Ft_Advice.执行时间方案, Ft_Advice.频率间隔, Ft_Advice.间隔单位,
                                          Ft_Advice.开始执行时间);
    If F分解 Is Not Null Then
      --药品长嘱从当天开始发送,一旦采取这种方式发送后，以前未发送的将不再被读取
      If Mn_医嘱处理范围 = 0 And Mbln药品长嘱从当天开始发送 And Instr(',5,6,7,', ',' || Ft_Advice.诊疗类别 || ',') > 0 Then
        Datend := Trunc(Sysdate);
        F分解  := b_Zlhis_Ciskernel.f_Stranal(F分解, 4, Datend);
      End If;

      --长嘱抗菌药紧急医嘱，只能发送一天的量
      If Ft_Advice.医嘱期效 = 0 And Nvl(Ft_Advice.紧急标志, 1) = 1 And Nvl(Ft_Advice.审核状态, 0) = 1 Then
        Null;
        Datbegin := Ft_Advice.开始执行时间;
        Datend   := Ft_Advice.开始执行时间 + 1;
        F分解    := b_Zlhis_Ciskernel.f_Stranal(F分解, 5, Datbegin, Datend);
      End If;
    End If;

    F次数 := To_Number(b_Zlhis_Ciskernel.f_Stranal(F分解, 1));

    If Ft_Advice.诊疗类别 = '7' Then
      F总量 := F次数;
    Else
      --西药、中成药：再按药品分零特性计算总量(按住院单位),这时次数和分解时间可能增加
      F总量 := b_Zlhis_Ciskernel.f_Calc发送药品总量(Ft_Advice.开始执行时间, F次数, F分解, Ft_Advice.单量, Ft_Dg.剂量系数, Ft_Dg.住院包装,
                                            Ft_Advice.可否分零, Nvl(Ft_Advice.执行终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')),
                                            Strpause, Ft_Advice.执行时间方案, Ft_Advice.频率次数, Ft_Advice.频率间隔, Ft_Advice.间隔单位,
                                            Mblnlimit, Nvl(Ft_Advice.首次用量, 0), Ft_Advice.上次执行时间, Lng次数out, Str分解时间out);

      If Nvl(Lng次数out, 0) <> 0 And Nvl(F口服摆药, 0) = 0 Then
        F分解 := Str分解时间out;
        F次数 := Lng次数out;
      End If;
    End If;
    Return(1);
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Calc总量次数时间出错[ZLSOFT]');
  End f_Calc总量次数时间;

  --对检验医嘱生成样本条码
  Function f_Getcuvettenumber
  (
    管码_In       In Varchar2,
    医嘱id_In     In Number,
    相关id_In     In Number,
    类别_In       In Varchar2,
    操作类型_In   In 诊疗项目目录.操作类型%Type,
    执行科室id_In In Number,
    婴儿_In       In Number,
    诊疗项目id_In In Number,
    紧急_In       In Number,
    标本_In       In Varchar2,
    采集科室id_In In Number
  ) Return Varchar2 Is
    v_Tmp管码 Varchar2(300);
    v_Tmp条码 Varchar2(300);
    b_无数据  Boolean := False;
    I         Number;
    n_Tmp     Number;
    --检验医嘱才会有条码，采集行和检验行同用一个条码  检验项目--诊疗项目id
  Begin
    If 类别_In = 'C' And 管码_In Is Not Null Then
      --检验项目才有管码
      b_无数据 := True;
      For I In 1 .. Rs_Number.Count Loop
        If Rs_Number(I).相关id = 相关id_In Then
          b_无数据 := False;
          n_Tmp    := I;
          Exit;
        End If;
      End Loop;
      If b_无数据 Then
        For I In 1 .. Rs_Number.Count Loop
          If Rs_Number(I).诊疗项目id = 诊疗项目id_In Then
            b_无数据 := False;
            n_Tmp    := I;
            Exit;
          End If;
        End Loop;

        If b_无数据 Then
          For I In 1 .. Rs_Number.Count Loop
            If Rs_Number(I).管码 = 管码_In And Rs_Number(I).执行科室id = 执行科室id_In And Rs_Number(I).婴儿 = 婴儿_In And Rs_Number(I)
               .紧急标志 = 紧急_In And Rs_Number(I).标本 = 标本_In And Rs_Number(I).采集科室id = 采集科室id_In Then
              b_无数据 := False;
              n_Tmp    := I;
              Exit;
            End If;
          End Loop;

          If b_无数据 Then
            --生成新的条码
            Rs_Number.Extend;
            n_Tmp := Rs_Number.Count;
            Rs_Number(n_Tmp).管码 := 管码_In;
            Rs_Number(n_Tmp).相关id := 相关id_In;
            Rs_Number(n_Tmp).样本条码 := Nextno(125, 医嘱id_In, 诊疗项目id_In, 1);
            Rs_Number(n_Tmp).诊疗项目id := 诊疗项目id_In;
            Rs_Number(n_Tmp).执行科室id := 执行科室id_In;
            Rs_Number(n_Tmp).婴儿 := 婴儿_In;
            Rs_Number(n_Tmp).紧急标志 := 紧急_In;
            Rs_Number(n_Tmp).标本 := 标本_In;
            Rs_Number(n_Tmp).采集科室id := 采集科室id_In;
            v_Tmp条码 := Rs_Number(n_Tmp).样本条码;
          Else
            --相同管码、执行科室、婴儿的检验使用相同的样本条码
            v_Tmp管码 := Rs_Number(n_Tmp).管码;
            v_Tmp条码 := Rs_Number(n_Tmp).样本条码;
            Rs_Number.Extend;
            n_Tmp := Rs_Number.Count;
            Rs_Number(n_Tmp).管码 := v_Tmp管码;
            Rs_Number(n_Tmp).相关id := 相关id_In;
            Rs_Number(n_Tmp).样本条码 := v_Tmp条码;
            Rs_Number(n_Tmp).诊疗项目id := 诊疗项目id_In;
            Rs_Number(n_Tmp).执行科室id := 执行科室id_In;
            Rs_Number(n_Tmp).婴儿 := 婴儿_In;
            Rs_Number(n_Tmp).紧急标志 := 紧急_In;
            Rs_Number(n_Tmp).标本 := 标本_In;
            Rs_Number(n_Tmp).采集科室id := 采集科室id_In;
          End If;
        Else
          --生成新的条码：相同检验的医嘱使用'不同的'条码
          Rs_Number.Extend;
          n_Tmp := Rs_Number.Count;
          Rs_Number(n_Tmp).管码 := 管码_In;
          Rs_Number(n_Tmp).相关id := 相关id_In;
          Rs_Number(n_Tmp).样本条码 := Nextno(125, 医嘱id_In, 诊疗项目id_In, 1);
          Rs_Number(n_Tmp).诊疗项目id := 诊疗项目id_In;
          Rs_Number(n_Tmp).执行科室id := 执行科室id_In;
          Rs_Number(n_Tmp).婴儿 := 婴儿_In;
          Rs_Number(n_Tmp).紧急标志 := 紧急_In;
          Rs_Number(n_Tmp).标本 := 标本_In;
          Rs_Number(n_Tmp).采集科室id := 采集科室id_In;
          v_Tmp条码 := Rs_Number(n_Tmp).样本条码;
        End If;
      Else
        --一并采集的检验项目使用相同的条码
        v_Tmp管码 := Rs_Number(n_Tmp).管码;
        v_Tmp条码 := Rs_Number(n_Tmp).样本条码;
        Rs_Number.Extend;
        n_Tmp := Rs_Number.Count;
        Rs_Number(n_Tmp).管码 := v_Tmp管码;
        Rs_Number(n_Tmp).相关id := 相关id_In;
        Rs_Number(n_Tmp).样本条码 := v_Tmp条码;
        Rs_Number(n_Tmp).诊疗项目id := 诊疗项目id_In;
        Rs_Number(n_Tmp).执行科室id := 执行科室id_In;
        Rs_Number(n_Tmp).婴儿 := 婴儿_In;
        Rs_Number(n_Tmp).紧急标志 := 紧急_In;
        Rs_Number(n_Tmp).标本 := 标本_In;
        Rs_Number(n_Tmp).采集科室id := 采集科室id_In;
      End If;
    Elsif 类别_In = 'E' And 操作类型_In = '6' Then
      --采集方式使用与医嘱相同(最近)的条码
      I := Rs_Number.Count;
      If I > 0 Then
        If Nvl(Rs_Number(I).相关id, 0) = 医嘱id_In Then
          v_Tmp条码 := Rs_Number(I).样本条码;
        End If;
      End If;
    End If;
    Return(v_Tmp条码);
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Getcuvettenumber出错[ZLSOFT]');
  End f_Getcuvettenumber;

  --时价单计算
  Function f_Calcdrugprice
  (
    药品id_In In Number,
    药房id_In In Number,
    数量_In   In Number,
    费别_In   In Varchar2
  ) Return Number Is
    n_时价   收费价目.现价%Type := 0;
    n_总数量 收费价目.现价%Type := 0;
    v_Tmp    Varchar2(80);
    v_费别   Varchar2(800);
  Begin
    Select Zl_Fun_Getprice(药品id_In, 药房id_In, 数量_In, 0, Null) As 结果 Into v_Tmp From Dual;
    If v_Tmp Is Not Null Then
      v_Tmp    := v_Tmp || '|';
      n_时价   := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1));
      v_Tmp    := Substr(v_Tmp, Instr(v_Tmp, '|') + 1);
      n_总数量 := To_Number(Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1));
    End If;
    If n_总数量 = 0 And 费别_In Is Not Null Then
      n_时价 := Round(n_时价 * 数量_In, Gn_Dec);
      For R In (Select a.屏蔽费别, b.收入项目id
                From 收费项目目录 A, 收费价目 B
                Where a.Id = b.收费细目id And a.Id = 药品id_In And
                      ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null))) Loop
        If Not (Nvl(r.屏蔽费别, 0) = 1) Then
          v_费别 := 费别_In;

          n_时价 := b_Zlhis_Ciskernel.f_Actualmoney(v_费别, r.收入项目id, n_时价, 药品id_In, 药房id_In, 数量_In, 0, v_Tmp);
        End If;
      End Loop;
    End If;
    Return(n_时价);
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Calcdrugprice出错[ZLSOFT]');
  End f_Calcdrugprice;

  --获取收费细目的当前售价价格金额
  Function f_Calcprice
  (
    项目id_In     In 收费项目目录.Id%Type,
    费别_In       In Varchar2,
    数量_In       In 诊疗收费关系.收费数量%Type,
    加班加价_In   In Boolean,
    n_执行科室id  In 部门表.Id%Type,
    卫材医嘱id_In In 病人医嘱记录.Id%Type
  ) Return Number Is
    n_单价 病人医嘱计价.单价%Type := 0;
    n_金额 病人医嘱计价.单价%Type := 0;
    v_Tmp  Varchar2(20);
    v_费别 Varchar2(20);
    n_加率 Number;
  Begin
    If 卫材医嘱id_In > 0 Then
      For R In (Select 单价 From 病人医嘱计价 Where 医嘱id = 卫材医嘱id_In And 收费细目id = 项目id_In) Loop
        n_单价 := r.单价;
        Exit;
      End Loop;
    End If;

    If 费别_In Is Null Then
      If (Not 加班加价_In) And Gb_加班加价 Then
        Select Sum(Decode(Nvl(a.是否变价, 0), 1, Decode(n_单价, 0, b.缺省价格, n_单价), b.现价) *
                    Decode(a.加班加价, 1, 1 + Nvl(b.加班加价率, 0) / 100, 1)) As 金额
        Into n_金额
        From 收费项目目录 A, 收费价目 B
        Where a.Id = b.收费细目id And a.Id = 项目id_In And
              ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null));
      Else
        Select Sum(Decode(Nvl(a.是否变价, 0), 1, Decode(n_单价, 0, b.缺省价格, n_单价), b.现价)) As 金额
        Into n_金额
        From 收费项目目录 A, 收费价目 B
        Where a.Id = b.收费细目id And a.Id = 项目id_In And
              ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null));

      End If;
    Else
      If (Not 加班加价_In) And Gb_加班加价 Then
        For R In (Select a.屏蔽费别, a.加班加价, b.加班加价率, b.收入项目id,
                         Decode(Nvl(a.是否变价, 0), 1, Decode(n_单价, 0, b.缺省价格, n_单价), b.现价) *
                          Decode(a.加班加价, 1, 1 + Nvl(b.加班加价率, 0) / 100, 1) As 金额
                  From 收费项目目录 A, 收费价目 B
                  Where a.Id = b.收费细目id And a.Id = 项目id_In And
                        ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null))) Loop
          If Nvl(r.屏蔽费别, 0) = 1 Then
            n_金额 := n_金额 + Round(数量_In * Nvl(r.金额, 0), Gn_Dec);
          Else
            v_费别 := 费别_In;

            n_加率 := 0;
            If (Not 加班加价_In) And Gb_加班加价 And Nvl(r.加班加价, 0) = 1 Then
              n_加率 := Nvl(r.加班加价率, 0) / 100;
              Null;
            End If;
            n_金额 := n_金额 + b_Zlhis_Ciskernel.f_Actualmoney(v_费别, r.收入项目id, 数量_In * Nvl(r.金额, 0), 项目id_In, n_执行科室id,
                                                           数量_In, n_加率, v_Tmp);
          End If;
        End Loop;
      Else
        For R In (Select a.屏蔽费别, a.加班加价, b.加班加价率, b.收入项目id,
                         Decode(Nvl(a.是否变价, 0), 1, Decode(n_单价, 0, b.缺省价格, n_单价), b.现价) As 金额
                  From 收费项目目录 A, 收费价目 B
                  Where a.Id = b.收费细目id And a.Id = 项目id_In And
                        ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null))) Loop
          If Nvl(r.屏蔽费别, 0) = 1 Then
            n_金额 := n_金额 + Round(数量_In * Nvl(r.金额, 0), Gn_Dec);
          Else
            v_费别 := 费别_In;

            n_加率 := 0;
            If (Not 加班加价_In) And Gb_加班加价 And Nvl(r.加班加价, 0) = 1 Then
              n_加率 := Nvl(r.加班加价率, 0) / 100;
              Null;
            End If;
            n_金额 := n_金额 + b_Zlhis_Ciskernel.f_Actualmoney(v_费别, r.收入项目id, 数量_In * Nvl(r.金额, 0), 项目id_In, n_执行科室id,
                                                           数量_In, n_加率, v_Tmp);
          End If;
        End Loop;
      End If;
    End If;
    Return(n_金额);
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Calcprice出错[ZLSOFT]');
  End f_Calcprice;

  --读取指定医嘱缺省发送金额(按费别打折)
  Function f_Loadadviceprice
  (
    Lngrow   In Number,
    Ft_Dg    r_Druginfo,
    金额_Out Out 住院费用记录.实收金额%Type
  ) Return Number Is
    --目前仅支持从已有计价项目中读取金额
    b_附加手术 Boolean := False;
    b_Havesub  Boolean := False;
    b_打折     Boolean := False;

    n_Row        Number := 0;
    n_数量       Number(16, 5) := 0;
    n_金额       Number(16, 5) := 0;
    n_实收       Number(16, 5) := 0;
    n_应收       Number(16, 5) := 0;
    n_加班率     Number(16, 5) := 0;
    n_材料id     人员表.Id%Type;
    v_Sql        Varchar2(30000);
    v_Price      Varchar2(20000);
    n_项目id     人员表.Id%Type := 0;
    n_主收入id   人员表.Id%Type := 0;
    n_执行科室id 人员表.Id%Type := 0;
    v_费别       Varchar2(30);
    v_Tmp        Varchar2(3000);
    n_Par科室id  Number;

    Type r_Recordset_Tmp Is Record(
      类别       Varchar2(30),
      收费项目id Number,
      收费数量   Number,
      固有对照   Number,
      收入项目id Number,
      加班加价   Number,
      加班加价率 Number,
      单价       Number,
      是否变价   Number,
      从项       Number,
      跟踪在用   Number,
      执行科室id Number,
      屏蔽费别   Number,
      费用性质   Number,
      收费方式   Number);
    Type t_Tmp Is Table Of r_Recordset_Tmp;
    Rs_Tmp  t_Tmp := t_Tmp();
    n_Rsrow Number := 0;

    c_Tmp Rs_Recordset;
  Begin
    金额_Out := 0;
    If Instr(',5,6,7,', Vsadvice(Lngrow).诊疗类别) > 0 Then
      --不为院外执行(自备药),药品不可能为叮嘱,且固定正常计价
      If Nvl(Vsadvice(Lngrow).执行性质, 0) <> 5 Then
        Rs_Price.Extend;
        n_Row := Rs_Price.Count;
        Rs_Price(n_Row).组id := Nvl(Vsadvice(Lngrow).相关id, Vsadvice(Lngrow).Id);
        Rs_Price(n_Row).医嘱id := Vsadvice(Lngrow).Id;
        Rs_Price(n_Row).相关id := Vsadvice(Lngrow).相关id;
        Rs_Price(n_Row).费用性质 := 0;
        Rs_Price(n_Row).收费方式 := 0;
        Rs_Price(n_Row).收费类别 := Vsadvice(Lngrow).诊疗类别;
        Rs_Price(n_Row).收费细目id := Ft_Dg.药品id;
        Rs_Price(n_Row).执行科室id := Vsadvice(Lngrow).执行科室id;
        Rs_Price(n_Row).数量 := 1;
        -- Rs_Price(n_Row).在用 := Nvl(跟踪在用_In, 0);
        Rs_Price(n_Row).变价 := Nvl(Ft_Dg.是否变价, 0);
        Rs_Price(n_Row).固定 := 1;
        Rs_Price(n_Row).从项 := 0;

        --发送的零售数量
        If Vsadvice(Lngrow).诊疗类别 = '7' Then
          If Nvl(Vsadvice(Lngrow).可否分零, 0) = 0 Then
            n_数量 := Vsadvice(Lngrow).总量 * Vsadvice(Lngrow).单量 / Nvl(Ft_Dg.剂量系数, 1);
          Else
            n_数量 := Vsadvice(Lngrow)
                    .总量 * b_Zlhis_Ciskernel.f_Intex(Vsadvice(Lngrow).单量 / Nvl(Ft_Dg.剂量系数, 1) / Nvl(Ft_Dg.住院包装, 1)) *
                     Nvl(Ft_Dg.住院包装, 1);
          End If;
        Else
          n_数量 := Vsadvice(Lngrow).总量 * Nvl(Ft_Dg.住院包装, 1);
        End If;
        Rs_Price(n_Row).总量 := n_数量;
        --记录售价单价
        If Nvl(Ft_Dg.是否变价, 0) = 0 Then
          Rs_Price(n_Row).单价 := f_Calcprice(Ft_Dg.药品id, Null, Null, True, 0, 0);
        Else
          --以售价计算药品时价,自备药时无对应药房
          Rs_Price(n_Row).单价 := b_Zlhis_Ciskernel.f_Calcdrugprice(Ft_Dg.药品id, Nvl(Vsadvice(Lngrow).执行科室id, 0), n_数量);
        End If;
        n_金额 := Rs_Price(n_Row).数量 * n_数量 * Rs_Price(n_Row).单价;
      End If;
      金额_Out := n_金额;
    Elsif Vsadvice(Lngrow).诊疗类别 = '4' Then
      --不为院外执行(自备药),药品不可能为叮嘱,且固定正常计价
      If Nvl(Vsadvice(Lngrow).执行性质, 0) <> 5 Then
        Rs_Price.Extend;
        n_Row := Rs_Price.Count;
        Rs_Price(n_Row).组id := Nvl(Vsadvice(Lngrow).相关id, Vsadvice(Lngrow).Id);
        Rs_Price(n_Row).医嘱id := Vsadvice(Lngrow).Id;
        Rs_Price(n_Row).相关id := Vsadvice(Lngrow).相关id;
        Rs_Price(n_Row).费用性质 := 0;
        Rs_Price(n_Row).收费方式 := 0;
        Rs_Price(n_Row).收费类别 := Vsadvice(Lngrow).诊疗类别;
        Rs_Price(n_Row).收费细目id := Vsadvice(Lngrow).收费细目id;
        Rs_Price(n_Row).执行科室id := Vsadvice(Lngrow).执行科室id;
        Rs_Price(n_Row).数量 := 1;
        Rs_Price(n_Row).在用 := Nvl(Vsadvice(Lngrow).跟踪在用, 0);
        Rs_Price(n_Row).变价 := Nvl(Vsadvice(Lngrow).是否变价, 0);
        Rs_Price(n_Row).固定 := 1;
        Rs_Price(n_Row).从项 := 0;
        --发送的零售数量
        n_数量 := Vsadvice(Lngrow).总量;
        Rs_Price(n_Row).总量 := n_数量;
        --记录售价单价
        If Nvl(Ft_Dg.是否变价, 0) = 0 Then
          Rs_Price(n_Row).单价 := f_Calcprice(Vsadvice(Lngrow).收费细目id, Null, Null, True, 0, 0);
        Else
          --以售价计算药品时价,自备药时无对应药房
          Rs_Price(n_Row).单价 := f_Calcdrugprice(Vsadvice(Lngrow).收费细目id, Nvl(Vsadvice(Lngrow).执行科室id, 0), n_数量, Null);
        End If;
        n_金额 := Rs_Price(n_Row).数量 * n_数量 * Rs_Price(n_Row).单价;
      End If;
      金额_Out := n_金额;
    Else
      --从已有的计价中读取费用金额
      --取诊疗收费 关系中的对照(发送时才定计价):正常计价,不为叮嘱、院外执行
      If Nvl(Vsadvice(Lngrow).计价特性, 0) = 0 And Instr(',0,5,', Nvl(Vsadvice(Lngrow).执行性质id, 0)) = 0 Then
        Null;
        n_数量     := Vsadvice(Lngrow).总量;
        b_附加手术 := (Vsadvice(Lngrow).诊疗类别 = 'F' And Nvl(Vsadvice(Lngrow).相关id, 0) <> 0);

        n_Par科室id := Nvl(Vsadvice(Lngrow).执行科室id, 0);
        If n_Par科室id = 0 Then
          n_Par科室id := Mn_病区id;
        End If;

        --几种对应的计价情况
        If Vsadvice(Lngrow).标本部位 Is Not Null And Vsadvice(Lngrow).检查方法 Is Not Null Then
          v_Price := ' And c.检查部位=:3 And c.检查方法=:4 And Nvl(c.费用性质,0)=0';
        Elsif Nvl(Vsadvice(Lngrow).执行标记, 0) = 0 Then
          v_Price := ' And c.检查部位 Is Null And c.检查方法 is Null And Nvl(c.费用性质,0)=0 and (1=1 or c.检查方法=:3 or c.检查方法=:4)';
        Else
          --目前包含床旁或术中加收的情况
          v_Price := ' And c.检查部位 Is Null And c.检查方法 is Null And Nvl(c.费用性质,0) IN(0,1) and (1=1 or c.检查方法=:3 or c.检查方法=:4)';
        End If;

        --新开状态下的计价读取
        If Nvl(Vsadvice(Lngrow).医嘱状态, 0) = 1 Then
          If Vsadvice(Lngrow).试管编码 Is Not Null Then
            Select Max(材料id) Into n_材料id From 采血管类型 Where 编码 = Vsadvice(Lngrow).试管编码;
          End If;
          v_Price := 'Select * From ( Select C.诊疗项目ID,C.收费项目ID,C.检查部位,C.检查方法,C.费用性质,C.收费数量,C.固有对照,C.从属项目,C.收费方式,c.适用科室id' ||
                     ',Max(Nvl(c.适用科室id, 0)) Over(Partition By c.诊疗项目id, c.检查部位, c.检查方法, c.费用性质) As Top' ||
                     ' From 诊疗收费关系 C Where C.诊疗项目ID=:1 And (C.适用科室ID is Null And C.病人来源 = 0 or C.适用科室ID =:2 And C.病人来源 = 2) ' ||
                     v_Price || '  ) Where Nvl(适用科室id, 0) = Top';
          v_Sql   := 'Select C.类别,A.收费项目ID,A.收费数量,A.固有对照,B.收入项目ID,C.加班加价,B.加班加价率,Decode(C.是否变价,1,B.缺省价格,B.现价)';
          If b_附加手术 Then
            v_Sql := v_Sql || '*Nvl(B.附术收费率,100)/100 ';
          End If;
          v_Sql := v_Sql || '  as 单价,C.是否变价,Nvl(A.从属项目,0) as 从项,D.跟踪在用,' || Nvl(Vsadvice(Lngrow).执行科室id, 0) ||
                   ' as 执行科室ID,C.屏蔽费别,Nvl(A.费用性质,0) as 费用性质,' || 'Nvl(A.收费方式,0) as 收费方式 ' || ' From ( ' || v_Price ||
                   ') A,收费价目 B,收费项目目录 C,材料特性 D' || '  Where A.收费项目ID=B.收费细目ID And A.收费项目ID=C.ID And A.收费项目ID=D.材料ID(+)' ||
                   ' and b.价格等级 is Null And C.服务对象 IN(2,3) And (C.撤档时间=To_Date(''3000-01-01'',''YYYY-MM-DD'') Or C.撤档时间 is NULL)' ||
                   ' And (C.站点=''' || Mv_站点 || ''' Or C.站点 is Null)' ||
                   ' And ((Sysdate Between B.执行日期 and B.终止日期) or (Sysdate>=B.执行日期 And B.终止日期 is NULL))' ||
                   ' And (Nvl(A.收费方式,0)=1 And C.类别=''4'' And A.收费项目ID=:5 Or Not(Nvl(A.收费方式,0)=1 And C.类别=''4'' And ';

          If Nvl(n_材料id, 0) <> 0 Then
            v_Sql := v_Sql || ' 1=1 ';
          Else
            v_Sql := v_Sql || ' 0=1 ';
          End If;
          v_Sql := v_Sql || ' )) Order by 费用性质,从项,A.收费项目ID';

          Open c_Tmp For v_Sql
            Using In Nvl(Vsadvice(Lngrow).诊疗项目id, 0), In n_Par科室id, In Vsadvice(Lngrow).标本部位, In Vsadvice(Lngrow).检查方法, In n_材料id;
          Fetch c_Tmp Bulk Collect
            Into Rs_Tmp;
          Close c_Tmp;
        Else
          -- 非新开状态，则读取已有计价
          Null;
          v_Price := 'Select 收费项目ID,固有对照 From ( Select C.诊疗项目ID,C.收费项目ID,C.检查部位,C.检查方法,C.费用性质,C.收费数量,C.固有对照,C.从属项目,C.收费方式,c.适用科室id' ||
                     ',Max(Nvl(c.适用科室id, 0)) Over(Partition By c.诊疗项目id, c.检查部位, c.检查方法, c.费用性质) As Top' ||
                     ' From 诊疗收费关系 C Where C.诊疗项目ID=:1 And (C.适用科室ID is Null And C.病人来源 = 0 or C.适用科室ID =:2 And C.病人来源 = 2) ' ||
                     v_Price || '  ) Where Nvl(适用科室id, 0) = Top';
          v_Sql   := 'Select  C.类别,A.收费细目ID as 收费项目ID,A.数量 as 收费数量,Nvl(E.固有对照,0) as 固有对照,B.收入项目ID,C.加班加价,B.加班加价率,Decode(C.是否变价,1,A.单价,B.现价)';
          If b_附加手术 Then
            v_Sql := v_Sql || '*Nvl(B.附术收费率,100)/100 ';
          End If;

          v_Sql := v_Sql || '  as 单价, C.是否变价,Nvl(A.从项,0) as 从项,D.跟踪在用,Nvl(A.执行科室ID,' || Nvl(Vsadvice(Lngrow).执行科室id, 0) ||
                   ') as 执行科室ID,C.屏蔽费别,' ||
                   'Nvl(A.费用性质,0) as 费用性质,Nvl(A.收费方式,0) as 收费方式 From 病人医嘱计价 A,收费价目 B,收费项目目录 C,材料特性 D,(' || v_Price ||
                   ') E  Where A.医嘱ID=:5 And A.收费细目ID=0+E.收费项目ID(+) and b.价格等级 is Null And A.收费细目ID=B.收费细目ID And A.收费细目ID=C.ID And A.收费细目ID=D.材料ID(+)' ||
                   ' And C.服务对象 IN(2,3) And (C.撤档时间=To_Date(''3000-01-01'',''YYYY-MM-DD'') Or C.撤档时间 is NULL)' ||
                   ' And (C.站点=''' || Mv_站点 || ''' Or C.站点 is Null)' ||
                   ' And ((Sysdate Between B.执行日期 and B.终止日期) or (Sysdate>=B.执行日期 And B.终止日期 is NULL))' ||
                   ' Order by 费用性质,从项,A.收费细目ID';

          Open c_Tmp For v_Sql
            Using In Nvl(Vsadvice(Lngrow).诊疗项目id, 0), In n_Par科室id, In Vsadvice(Lngrow).标本部位, In Vsadvice(Lngrow).检查方法, In Vsadvice(Lngrow).Id;
          Fetch c_Tmp Bulk Collect
            Into Rs_Tmp;
          Close c_Tmp;
        End If;
        --费用性质
        --0-基础费用；1-床旁或术中加收；2-加班加收(下班时间和节假日)；3-紧急加收(该值暂未使用)，只操作出【1-床旁或术中加收】 另外两种是不是已经没用到了？
        --确定计价之中是否包含从项以及主项收入ID
        --一个收费项目可以对多个收入项目，单价是叠加
        --从属项折扣和费别，打折优先
        --计价后单价保存在病人医嘱计价中
        --诊疗项目对照中，一个诊疗项目只能对应一个从属项关系

        If Gb_从项汇总折扣 Then
          For I In 1 .. Rs_Tmp.Count Loop
            If Nvl(Rs_Tmp(I).从项, 0) = 0 Then
              If Nvl(n_主收入id, 0) = 0 Then
                n_主收入id := Rs_Tmp(I).收入项目id;
              Elsif Nvl(Rs_Tmp(I).从项, 0) = 1 Then
                b_Havesub := True;
                Exit;
              End If;
            End If;
          End Loop;
          b_打折 := Nvl(n_主收入id, 0) <> 0 And b_Havesub;
        End If;

        For I In 1 .. Rs_Tmp.Count Loop
          Null;
          If n_项目id <> Rs_Tmp(I).收费项目id Then
            n_Rsrow := I;
            n_实收  := 0;
            Rs_Price.Extend;
            n_Row := Rs_Price.Count;
            Rs_Price(n_Row).组id := Nvl(Vsadvice(Lngrow).相关id, Vsadvice(Lngrow).Id);
            Rs_Price(n_Row).医嘱id := Vsadvice(Lngrow).Id;
            Rs_Price(n_Row).相关id := Vsadvice(Lngrow).相关id;
            Rs_Price(n_Row).费用性质 := Nvl(Rs_Tmp(n_Rsrow).费用性质, 0);
            Rs_Price(n_Row).收费方式 := Nvl(Rs_Tmp(n_Rsrow).收费方式, 0);
            Rs_Price(n_Row).收费类别 := Rs_Tmp(n_Rsrow).类别;
            Rs_Price(n_Row).收费细目id := Rs_Tmp(n_Rsrow).收费项目id;
            Rs_Price(n_Row).执行科室id := Vsadvice(Lngrow).执行科室id;
            Rs_Price(n_Row).数量 := Nvl(Rs_Tmp(n_Rsrow).收费数量, 0);
            Rs_Price(n_Row).在用 := Nvl(Rs_Tmp(n_Rsrow).跟踪在用, 0);
            Rs_Price(n_Row).变价 := Nvl(Rs_Tmp(n_Rsrow).是否变价, 0);
            Rs_Price(n_Row).固定 := Nvl(Rs_Tmp(n_Rsrow).固有对照, 0);
            Rs_Price(n_Row).从项 := Nvl(Rs_Tmp(n_Rsrow).从项, 0);
            Rs_Price(n_Row).总量 := n_数量;
            --原液皮试问题。绑定的药品费用如果没有指定科室则按原来逻辑，暂不处理
            --执行科室:非药嘱药品及跟踪卫材的专门取，暂不处理
            n_执行科室id := Nvl(Rs_Tmp(n_Rsrow).执行科室id, 0);
            If Rs_Tmp(n_Rsrow).类别 = '4' And Nvl(Rs_Tmp(n_Rsrow).跟踪在用, 0) = 1 Or Instr(',5,6,7,', Rs_Tmp(n_Rsrow).类别) > 0 Then

              n_执行科室id := n_执行科室id;
              -- lng执行科室ID = Get收费执行科室ID(mlng病人ID, 0, rsTmp!类别, rsTmp!收费项目ID, 4, NVL(rsSend!病人科室id, 0), 0, 1, lng执行科室ID)
            End If;
            If Nvl(n_执行科室id, 0) <> 0 Then
              Rs_Price(n_Row).执行科室id := n_执行科室id;
            Else
              Rs_Price(n_Row).执行科室id := 0;
            End If;

          End If;
          n_项目id := Rs_Tmp(I).收费项目id;

          --计算单价和实收
          If (Nvl(Rs_Tmp(n_Rsrow).是否变价, 0) = 1 And Instr(',5,6,7,', Rs_Tmp(n_Rsrow).类别) > 0) Or
             (Nvl(Rs_Tmp(n_Rsrow).是否变价, 0) = 1 And Rs_Tmp(n_Rsrow).类别 = '4' And Nvl(Rs_Tmp(n_Rsrow).跟踪在用, 0) = 1) Then

            --非药嘱药品计价按时价计算(仅一个收入),其它变价需要由医生输入
            --跟踪在用的时价卫材和药品一样计算
            Rs_Price(n_Row).单价 := f_Calcdrugprice(Rs_Tmp(n_Rsrow).收费项目id, Rs_Price(n_Row).执行科室id,
                                                  n_数量 * Nvl(Rs_Tmp(n_Rsrow).收费数量, 0), Null);

            n_应收 := Rs_Price(n_Row).数量 * n_数量 * Round(Rs_Price(n_Row).单价, Gn_Decprice);

            --处理加班加价
            If Gb_加班加价 And Nvl(Rs_Tmp(n_Rsrow).加班加价, 0) = 1 Then
              n_应收 := n_应收 * (1 + Nvl(Rs_Tmp(n_Rsrow).加班加价率, 0) / 100);
            End If;
            n_应收 := Round(n_应收, Gn_Dec);

            If Nvl(Rs_Tmp(n_Rsrow).屏蔽费别, 0) = 0 And Vsadvice(Lngrow).费别 Is Not Null And Not b_打折 Then
              v_费别 := Vsadvice(Lngrow).费别;

              If Gb_加班加价 And Nvl(Rs_Tmp(n_Rsrow).加班加价, 0) = 1 Then
                n_加班率 := Nvl(Rs_Tmp(n_Rsrow).加班加价率, 0) / 100;
              Else
                n_加班率 := 0;
              End If;
              n_实收 := n_实收 +
                      Round(b_Zlhis_Ciskernel.f_Actualmoney(v_费别, Rs_Tmp(n_Rsrow).收入项目id, n_应收, Rs_Tmp(n_Rsrow).收费项目id,
                                                            n_执行科室id, (Rs_Price(n_Row).数量 * n_数量), n_加班率, v_Tmp), Gn_Dec);
            Else
              n_实收 := n_实收 + n_应收;
            End If;

          Else
            --固定价格或普通变价(只有一个收入项目)
            Rs_Price(n_Row).单价 := Nvl(Rs_Price(n_Row).单价, 0) + Nvl(Rs_Tmp(n_Rsrow).单价, 0);

            n_应收 := Rs_Price(n_Row).数量 * n_数量 * Round(Rs_Tmp(n_Rsrow).单价, Gn_Decprice);
            --处理加班加价
            If Gb_加班加价 And Nvl(Rs_Tmp(n_Rsrow).加班加价, 0) = 1 Then
              n_应收 := n_应收 * (1 + Nvl(Rs_Tmp(n_Rsrow).加班加价率, 0) / 100);
            End If;
            n_应收 := Round(n_应收, Gn_Dec);
            If Nvl(Rs_Tmp(n_Rsrow).屏蔽费别, 0) = 0 And Vsadvice(Lngrow).费别 Is Not Null And Not b_打折 Then
              v_费别 := Vsadvice(Lngrow).费别;
              If Gb_加班加价 And Nvl(Rs_Tmp(n_Rsrow).加班加价, 0) = 1 Then
                n_加班率 := Nvl(Rs_Tmp(n_Rsrow).加班加价率, 0) / 100;
              Else
                n_加班率 := 0;
              End If;
              n_实收 := n_实收 +
                      Round(b_Zlhis_Ciskernel.f_Actualmoney(v_费别, Rs_Tmp(n_Rsrow).收入项目id, n_应收, Rs_Tmp(n_Rsrow).收费项目id,
                                                            n_执行科室id, (Rs_Price(n_Row).数量 * n_数量), n_加班率, v_Tmp), Gn_Dec);
            Else
              n_实收 := n_实收 + n_应收;
            End If;
          End If;
          --从属项目汇总计算折扣
          If b_打折 Then
            n_实收 := Round(b_Zlhis_Ciskernel.f_Actualmoney(v_费别, Rs_Tmp(n_Rsrow).收入项目id, n_应收, Rs_Tmp(n_Rsrow).收费项目id,
                                                          n_执行科室id, (Rs_Price(n_Row).数量 * n_数量), n_加班率, v_Tmp), Gn_Dec);
          End If;
          金额_Out := 金额_Out + n_实收;
          --exit;
        End Loop;
      End If;
    End If;
    Return(1);
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Loadadviceprice出错[ZLSOFT]');
  End f_Loadadviceprice;

  --药品医嘱缓存
  Function f_Loadadvicedrug Return Number Is
    --医嘱记录集
    Cursor c_Advice
    (
      Nc_病人id_In   病人医嘱记录.病人id%Type,
      Nc_主页id_In   病人医嘱记录.主页id%Type,
      Nd_日期        Date,
      Nv_期效        Varchar2, --期效
      Nv_输液排除    Varchar2, --输液医嘱ids
      Nv_Sids        Varchar2, --要发送的主医嘱id
      Nv_给药项目ids Varchar2, --给药途径项目id
      Nn_范围        Number,
      Nn_备用        Number,
      Nd_备用时间    Date
    ) Is
      Select a.Id, a.相关id, Nvl(a.相关id, a.Id) As 组id, Nvl(x.序号, a.序号) As 组号,b.医疗付款方式, a.序号, a.诊疗类别, a.诊疗项目id, e.名称 As 诊疗项目,
             a.收费细目id, a.婴儿, b.入院日期, a.病人id, a.主页id, b.住院号, b.出院病床 As 床号, d.名称 As 科室, a.姓名, a.性别, a.年龄, b.费别, b.险类,
             a.开始执行时间, a.上次执行时间, a.医嘱内容, a.天数, a.总给予量, a.单次用量, e.计算单位, a.执行终止时间, a.执行频次,
             Decode(a.执行频次, '必要时', 1, a.频率次数) As 频率次数, Decode(a.执行频次, '必要时', 1, a.频率间隔) As 频率间隔,
             Decode(a.执行频次, '必要时', '天', a.间隔单位) As 间隔单位, a.医生嘱托, Decode(a.执行频次, '必要时', Null, a.执行时间方案) As 执行时间方案, b.病人性质,
             a.开嘱时间, e.执行分类, e.操作类型, Null As 病人病区id, a.病人科室id, a.开嘱科室id, a.开嘱医生, a.可否分零, a.计价特性, a.执行性质, a.执行标记,
             a.执行科室id As 执行科室id, Nvl(f.名称, Decode(Nvl(a.执行性质, 0), 5, '-')) As 执行科室, a.摘要, a.医嘱状态, a.医嘱期效, a.首次用量, e.计算方式,
             e.执行安排, g.毒理分类, a.紧急标志, a.审核状态, a.用药理由, Null As 高值材料, a.会诊医嘱id, Null As 撤档时间, Null As 标本部位, Null As 检查方法,
             Null As 服务对象, Null As 剂量系数, y.类别 As 执行类别, y.操作类型 As 执行操作类型, y.执行分类 As 执行执行分类
      From 病人医嘱记录 A, 病案主页 B, 部门表 D, 诊疗项目目录 E, 部门表 F, 药品特性 G, 病人医嘱记录 X, 诊疗项目目录 Y
      Where b.出院科室id = d.Id And a.病人id = b.病人id And a.主页id = b.主页id And a.相关id = x.Id(+) And x.诊疗项目id = y.Id(+) And
            a.诊疗项目id = e.Id And a.执行科室id = f.Id(+) And e.Id = g.药名id(+) And
            (a.诊疗类别 In ('5', '6', '7') Or (a.诊疗类别 = 'E' And e.操作类型 In ('2', '3', '4'))) And Nvl(a.执行标记, 0) <> -1 And
            ((a.开始执行时间 <= Nd_日期 And (a.上次执行时间 < Nd_日期 Or a.上次执行时间 Is Null) And
            (a.执行终止时间 > a.上次执行时间 Or a.执行终止时间 Is Null Or a.上次执行时间 Is Null) And
            (a.执行终止时间 > a.开始执行时间 Or a.执行终止时间 Is Null) And a.医嘱期效 = 0 And Nvl(a.医嘱状态, 0) Not In (-1, 1, 2, 4)) Or
            (Nvl(a.医嘱状态, 0) Not In (-1, 1, 2, 4, 8, 9) And a.医嘱期效 = 1)) And a.病人id = Nc_病人id_In And a.主页id = Nc_主页id_In And
            Instr(Nv_期效, ',' || a.医嘱期效 || ',') > 0 And
            Instr(',' || Nv_输液排除 || ',', ',' || Nvl(a.相关id, a.Id) || ',') = 0 And
            (Instr(',' || Nv_Sids || ',', ',' || Nvl(a.相关id, a.Id) || ',') > 0 Or Nv_Sids Is Null) And
            (Instr(',' || Nv_给药项目ids || ',', ',' || Nvl(x.诊疗项目id, a.诊疗项目id) || ',') > 0 Or Nv_给药项目ids Is Null) And
            (Nn_范围 = 0 Or Nn_范围 = 1 And Nvl(a.婴儿, 0) = 0 Or Nn_范围 = 2 And Nvl(a.婴儿, 0) > 0) And
            (Nn_备用 = 0 And (Nvl(a.执行频次, '无') <> '必要时' And Nvl(a.执行频次, '无') <> '需要时') Or
            Nn_备用 = 1 And (Nvl(a.执行频次, '无') = '必要时' Or Nvl(a.执行频次, '无') = '需要时' And Nd_备用时间 - a.开始执行时间 < 0.5))
      Order By a.医嘱期效, a.婴儿, 组号, 组id, a.序号;

    r_Advice c_Advice%RowType;

    n_Row       Number;
    n_Row规格   Number;
    v_分解      Varchar2(32767);
    n_Del相关id Number(18) := 0;
    n_最小次数  Number := 0;
    n_次数      Number;
    n_总量      Number(16, 5);
    n_金额      Number(16, 5) := 0;
    n_Tmp       Number := 0;
    v_Tmp       Varchar2(1000);
    v_用法      Varchar2(1000);
    Ft_Dg       t_Druginfo;
    v_输液排除  Varchar2(4000);
    Lng倍数     Number;
    v_期效      Varchar2(10);
    c_Tmp       Rs_Recordset;
    v_Sql       Varchar2(32767);
    Str药房置换 Varchar2(4000);

  Begin
    If Mn_药品长嘱 = 0 And Mn_药品临嘱 = 0 Then
      Return 0;
    End If;

    If Mn_药品长嘱 = 1 Then
      v_期效 := ',0,';
    End If;

    If Mn_药品临嘱 = 1 Then
      v_期效 := v_期效 || ',1,';
    End If;

    --和 c_Advice 游标格式差不多
    v_Sql := 'Select a.Id, a.相关id, Nvl(a.相关id, a.Id) As 组id, Nvl(x.序号, a.序号) As 组号,b.医疗付款方式, a.序号, a.诊疗类别, a.诊疗项目id, e.名称 As 诊疗项目,' ||
             'a.收费细目id, a.婴儿, b.入院日期, a.病人id, a.主页id, b.住院号, b.出院病床 As 床号, d.名称 As 科室, a.姓名, a.性别, a.年龄, b.费别, b.险类,';
    --1 , 2 号参数  md_备用执行时间,md_备用执行时间,
    If Mn_医嘱处理范围 = 0 Then
      v_Sql := v_Sql || 'decode(1,1,a.开始执行时间,2,:1,3,:2,null) as 开始执行时间,';
    Else
      v_Sql := v_Sql || 'Decode(Sign(A.开始执行时间-:1),-1,:2,A.开始执行时间) as 开始执行时间,';
    End If;
    --3 号参数  substr(mv_备用执行时间,12)
    --4 号参数  mn_病区id
    --5 6 7 8 9 10 号参数  Md_截止日期,Md_截止日期, Mn_病人id, Mn_主页id,mv_期效,v_输液排除
    v_Sql := v_Sql || ' a.上次执行时间, a.医嘱内容, a.天数, a.总给予量, a.单次用量, e.计算单位, a.执行终止时间, a.执行频次,' || Chr(10) ||
             'Decode(a.执行频次, ''必要时'', 1, a.频率次数) As 频率次数, Decode(a.执行频次, ''必要时'', 1, a.频率间隔) As 频率间隔,' || Chr(10) ||
             'Decode(a.执行频次, ''必要时'', ''天'', a.间隔单位) As 间隔单位, a.医生嘱托, Decode(a.执行频次, ''必要时'', :3, a.执行时间方案) As 执行时间方案,' ||
             Chr(10) ||
             'b.病人性质, a.开嘱时间, e.执行分类, e.操作类型, :4 As 病人病区id, a.病人科室id, a.开嘱科室id, a.开嘱医生, a.可否分零, a.计价特性, a.执行性质, a.执行标记,';

    If Mn_药房置换 = 1 Then
      For X In (Select b.原id, b.新id
                From Xmltable('$a/ZHYF/ITEM' Passing Mx_药房 As "a" Columns 原id Number(18) Path 'YYFID',
                               新id Number(18) Path 'ZHHYFID') B) Loop
        Str药房置换 := Str药房置换 || ',' || x.原id || ',' || x.新id;
      End Loop;
    End If;
    If Str药房置换 Is Null Then
      Str药房置换 := 'a.执行科室id';
    Else
      Str药房置换 := 'Decode(A.执行科室ID' || Str药房置换 || ',A.执行科室ID)';
    End If;

    v_Sql := v_Sql || Str药房置换;
    v_Sql := v_Sql || ' As 执行科室id, Nvl(f.名称, Decode(Nvl(a.执行性质, 0), 5, ''-'')) As 执行科室, a.摘要, a.医嘱状态, a.医嘱期效, a.首次用量,' ||
             Chr(10) || 'e.计算方式, e.执行安排, g.毒理分类, a.紧急标志, a.审核状态, a.用药理由, Null As 高值材料, a.会诊医嘱id,Null As 撤档时间,' ||
             'Null As 标本部位, Null As 检查方法, Null As 服务对象, Null As 剂量系数, y.类别 As 执行类别, y.操作类型 As 执行操作类型, y.执行分类 As 执行执行分类' ||
             Chr(10) || 'From 病人医嘱记录 A, 病案主页 B, 部门表 D, 诊疗项目目录 E, 部门表 F, 药品特性 G,病人医嘱记录 X, 诊疗项目目录 Y' || Chr(10) ||
             'Where b.出院科室id = d.Id And a.病人id = b.病人id And a.主页id = b.主页id And a.相关id = x.Id(+) And x.诊疗项目id = y.Id(+) And' ||
             Chr(10) || 'a.诊疗项目id = e.Id And ' || Str药房置换 || ' = f.Id(+) And e.Id = g.药名id(+) And' || Chr(10) ||
             '(a.诊疗类别 In (''5'', ''6'', ''7'') Or (a.诊疗类别 = ''E'' And e.操作类型 In (''2'', ''3'', ''4''))) And Nvl(a.执行标记, 0) <> -1 And' ||
             Chr(10) || '((a.开始执行时间 <= :5 And (a.上次执行时间 < :6 Or a.上次执行时间 Is Null) And' || Chr(10) ||
             '(a.执行终止时间 > a.上次执行时间 Or a.执行终止时间 Is Null Or a.上次执行时间 Is Null) And' || Chr(10) ||
             '(a.执行终止时间 > a.开始执行时间 Or a.执行终止时间 Is Null) And a.医嘱期效 = 0 And Nvl(a.医嘱状态, 0) Not In (-1, 1, 2, 4)) Or' ||
             Chr(10) || '(Nvl(a.医嘱状态, 0) Not In (-1, 1, 2, 4, 8, 9) And a.医嘱期效 = 1)) And a.病人id = :7 And' || Chr(10) ||
             'a.主页id = :8 and instr(:9,'',''||a.医嘱期效||'','')>0 and instr(:10,'',''||nvl(a.相关id,a.id)||'','')=0 ';
    If Mx_Yzids Is Null Then
      --11,12 ,13,14,号参数,Mv_医嘱ids,Mv_医嘱ids,Mv_给药项目ids,Mv_给药项目ids
      v_Sql := v_Sql ||
               'and (:11 is null or :12 is null) and (instr('',''||:13 ||'','','',''||nvl(x.诊疗项目id,a.诊疗项目id)||'','')>0 or :14 is null)';
    Else
      --11,12 ,13,14,号参数,Mx_Yzids,Mv_医嘱ids,Mv_给药项目ids,Mv_给药项目ids
      v_Sql := v_Sql ||
               ' and nvl(a.相关id,a.id) in (Select b.医嘱id From Xmltable(''$a/XYZIDS/ITEM'' Passing :11 As "a" Columns 医嘱id Number(18) Path ''YZID'' ) B)';
      v_Sql := v_Sql ||
               ' and :12 is null  and (instr('',''||:13 ||'','','',''||nvl(x.诊疗项目id,a.诊疗项目id)||'','')>0 or :14 is null)';
    End If;
    --15,16,17,号参数,mn_病人范围,mn_病人范围,mn_病人范围
    v_Sql := v_Sql || ' and (:15=0 or :16=1 and nvl(a.婴儿,0)=0 or :17=2 and nvl(a.婴儿,0)>0) ';
    --18,19,20 号参数, mn_医嘱处理范围,mn_医嘱处理范围,md_备用执行时间
    v_Sql := v_Sql || ' And ( :18=0 and (Nvl(a.执行频次, ''无'') <> ''必要时'' And Nvl(a.执行频次, ''无'') <> ''需要时'')' || Chr(10) ||
             ' or :19=1  And (NVL(a.执行频次,''无'')=''必要时'' Or NVL(a.执行频次,''无'')=''需要时'' And :20 - a.开始执行时间<0.5)) ';
    --21,22,23 号参数, mn_发药药房id, Mn_病人id, Mn_主页id
    If Mn_发药药房id = 0 Then
      v_Sql := v_Sql || ' and (1=1 or 0=:21+:22+:23)';
    Else
      v_Sql := v_Sql ||
               ' And Exists(Select ID From 病人医嘱记录 X Where 诊疗类别 IN(''5'',''6'',''7'') And (X.相关ID=A.相关ID Or X.相关ID=A.ID) And x.执行科室ID+0=:21 And x.病人ID=:22 and x.主页id=:23)';
    End If;

    v_Sql := v_Sql || ' Order By a.医嘱期效, a.婴儿, 组号, 组id, a.序号';

    --排开 过敏药物没有阴性结果的医嘱，暂不处理
    v_输液排除 := b_Zlhis_Ciskernel.f_Get输液类医嘱(Mn_病人id, Mn_主页id, Mn_病区id, 0, Gstr输液配置中心);
    Mv_Tmp     := Null;
    Open c_Tmp For v_Sql
      Using In Md_备用执行时间, In Md_备用执行时间, In Substr(Mv_备用执行时间, 12), In Mn_病区id, In Md_截止日期, In Md_截止日期, In Mn_病人id, In Mn_主页id, In v_期效, In ',' || v_输液排除 || ',', In Mx_Yzids, In Mv_Tmp, In Mv_给药项目ids, In Mv_给药项目ids, In Mn_病人范围, In Mn_病人范围, In Mn_病人范围, In Mn_医嘱处理范围, In Mn_医嘱处理范围, In Md_备用执行时间, In Mn_发药药房id, In Mn_病人id, In Mn_主页id;
    Loop
      Fetch c_Tmp
        Into r_Advice;
      Exit When c_Tmp%NotFound;
      If c_Tmp%RowCount > 0 Then
        Vsadvice.Extend;
        n_Row := Vsadvice.Count; --当前行
        Vsadvice(n_Row).选择 := 1;
        Vsadvice(n_Row).禁止发送 := 0;
        --一组医嘱中有一行被标记为删除则整组都为删除
        If n_Row > 1 Then
          If r_Advice.相关id Is Null Then
            If r_Advice.Id = Vsadvice(n_Row - 1).相关id Then
              Vsadvice(n_Row).禁止发送 := Vsadvice(n_Row - 1).禁止发送;
            End If;
          Else
            If r_Advice.相关id = Vsadvice(n_Row - 1).相关id Then
              Vsadvice(n_Row).禁止发送 := Vsadvice(n_Row - 1).禁止发送;
            End If;
          End If;
        Elsif n_Row > 2 Then
          --如果上一行的删除被标记，前之前一组医嘱行也一起标记
          If Vsadvice(n_Row - 1).禁止发送 = 1 Then
            n_Del相关id := Nvl(Vsadvice(n_Row - 1).相关id, Vsadvice(n_Row - 1).Id);
            n_Tmp       := n_Row - 2;
            For J In 1 .. n_Tmp Loop
              If Vsadvice(n_Row + J - 1).相关id = n_Del相关id Then
                Null;
                Vsadvice(n_Row + J - 1).禁止发送 := 1;
              Else
                Exit;
              End If;
            End Loop;
          End If;
        End If;

        --口服药判断
        If  Instr(',5,6,7,', ',' || r_Advice.诊疗类别 || ',') > 0 And Instr(',4,2,', ',' || r_Advice.执行操作类型 || ',') > 0 And Nvl(r_Advice.执行执行分类, 0) = 4 Then
          Vsadvice(n_Row).口服药 := 1;
        Else
          Vsadvice(n_Row).口服药 := 0;
        End If;

        --常规字段赋值
        Vsadvice(n_Row).婴儿序号 := r_Advice.婴儿; --文本显示未处理
        If Nvl(r_Advice.婴儿, 0) = 0 Then
          Vsadvice(n_Row).婴儿 := '病人';
        Else
          Vsadvice(n_Row).婴儿 := '婴儿' || r_Advice.婴儿;
        End If;
        Vsadvice(n_Row).科室 := r_Advice.科室; --出院科室
        Vsadvice(n_Row).病人id := r_Advice.病人id;
        Vsadvice(n_Row).主页id := r_Advice.主页id;
        Vsadvice(n_Row).姓名 := r_Advice.姓名;
        Vsadvice(n_Row).性别 := r_Advice.性别;
        Vsadvice(n_Row).年龄 := r_Advice.年龄;
        Vsadvice(n_Row).险类 := r_Advice.险类;
        Vsadvice(n_Row).费别 := r_Advice.费别;
        Vsadvice(n_Row).住院号 := r_Advice.住院号;
        Vsadvice(n_Row).床号 := r_Advice.床号;
        Vsadvice(n_Row).序号 := r_Advice.序号;
        Vsadvice(n_Row).组号 := r_Advice.组号;
        Vsadvice(n_Row).医疗付款方式 := r_Advice.医疗付款方式;
        Vsadvice(n_Row).组id := r_Advice.组id;

        Vsadvice(n_Row).Id := r_Advice.Id;
        Vsadvice(n_Row).相关id := r_Advice.相关id;
        Vsadvice(n_Row).诊疗类别 := r_Advice.诊疗类别;
        Vsadvice(n_Row).诊疗项目id := r_Advice.诊疗项目id;
        Vsadvice(n_Row).医嘱期效 := r_Advice.医嘱期效;
        If Nvl(r_Advice.医嘱期效, 0) = 0 Then
          Vsadvice(n_Row).期效 := '长嘱';
        Else
          Vsadvice(n_Row).期效 := '临嘱';
        End If;

        Vsadvice(n_Row).紧急标志 := r_Advice.紧急标志;
        If Nvl(r_Advice.紧急标志, 0) = 1 Then
          Vsadvice(n_Row).紧急 := '急';
        Else
          Vsadvice(n_Row).紧急 := Null;
        End If;
        Vsadvice(n_Row).执行性质 := r_Advice.执行性质;
        Vsadvice(n_Row).审核状态 := r_Advice.审核状态;
        Vsadvice(n_Row).医嘱内容 := r_Advice.医嘱内容;
        Vsadvice(n_Row).诊疗项目 := r_Advice.诊疗项目;
        Vsadvice(n_Row).医生嘱托 := r_Advice.医生嘱托;
        Vsadvice(n_Row).摘要 := r_Advice.摘要;
        Vsadvice(n_Row).频率 := r_Advice.执行频次;
        Vsadvice(n_Row).病人病区id := r_Advice.病人病区id;
        Vsadvice(n_Row).病人科室id := r_Advice.病人科室id;
        Vsadvice(n_Row).开嘱科室id := r_Advice.开嘱科室id;
        Vsadvice(n_Row).开嘱医生 := r_Advice.开嘱医生;
        Vsadvice(n_Row).计价特性 := r_Advice.计价特性;
        Vsadvice(n_Row).执行性质id := r_Advice.执行性质;
        Vsadvice(n_Row).执行标记 := r_Advice.执行标记;
        Vsadvice(n_Row).执行分类 := r_Advice.执行分类;
        Vsadvice(n_Row).操作类型 := r_Advice.操作类型;
        Vsadvice(n_Row).用药理由 := r_Advice.用药理由;
        Vsadvice(n_Row).会诊医嘱id := r_Advice.会诊医嘱id;
        Vsadvice(n_Row).医嘱状态 := r_Advice.医嘱状态;
        Vsadvice(n_Row).执行科室id := r_Advice.执行科室id;
        Vsadvice(n_Row).执行科室 := r_Advice.执行科室;
        Vsadvice(n_Row).执行终止时间 := r_Advice.执行终止时间;
        Vsadvice(n_Row).执行时间方案 := r_Advice.执行时间方案;
        Vsadvice(n_Row).频率间隔 := r_Advice.频率间隔;
        Vsadvice(n_Row).间隔单位 := r_Advice.间隔单位;
        Vsadvice(n_Row).频率次数 := r_Advice.频率次数;
        Vsadvice(n_Row).毒理分类 := r_Advice.毒理分类;

        --显示附加执行科室
        If r_Advice.诊疗类别 = 'E' And r_Advice.相关id Is Null Then
          If Vsadvice(n_Row - 1).诊疗类别 = 'E' Or Vsadvice(n_Row - 1).诊疗类别 = '7' Then
            --中药用法
            Vsadvice(n_Row - 1).附加执行 := r_Advice.执行科室;

          Elsif Vsadvice(n_Row - 1).诊疗类别 = '5' Or Vsadvice(n_Row - 1).诊疗类别 = '6' Then
            --给药途径
            For I In 1 .. n_Row Loop
              If Nvl(Vsadvice(n_Row - I).相关id, 0) = r_Advice.Id Then
                Vsadvice(n_Row - I).附加执行 := r_Advice.执行科室;
              Else
                Exit;
              End If;
            End Loop;
          End If;
        End If;

        --发送前自动校对的情况，暂不处理
        ------------------------------------------------------------------------------
        If Instr(',4,5,6,7,', ',' || r_Advice.诊疗类别 || ',') = 0 Then
          Vsadvice(n_Row).计算方式 := r_Advice.计算方式;
        Else
          Vsadvice(n_Row).计算方式 := '0';
        End If;
        Vsadvice(n_Row).执行安排 := r_Advice.执行安排;
        Vsadvice(n_Row).病人性质 := r_Advice.病人性质;
        Vsadvice(n_Row).开嘱时间 := r_Advice.开嘱时间;
        Vsadvice(n_Row).开始时间 := To_Char(r_Advice.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
        Vsadvice(n_Row).开始执行时间 := r_Advice.开始执行时间;
        Vsadvice(n_Row).上次执行时间 := r_Advice.上次执行时间;
        Vsadvice(n_Row).单量 := r_Advice.单次用量;
        Vsadvice(n_Row).首次用量 := r_Advice.首次用量;

        If r_Advice.诊疗类别 = 'E' Then
          If r_Advice.相关id Is Not Null Then
            Vsadvice(n_Row).药品执行类别 := 2; --中药煎法;
            Vsadvice(n_Row).隐藏行 := 1;
          Elsif Instr(',5,6,', ',' || Vsadvice(n_Row - 1).诊疗类别 || ',') > 0 Then
            Vsadvice(n_Row).药品执行类别 := 1; --给药途径;
            Vsadvice(n_Row).隐藏行 := 1;
          Else
            Vsadvice(n_Row).药品执行类别 := 3; --中药用法;
          End If;
        End If;
        If r_Advice.诊疗类别 = '7' Then
          Vsadvice(n_Row).隐藏行 := 1;
        End If;

        --标记为删后不用执行后面的语句
        If Vsadvice(n_Row).禁止发送 = 0 Then
          --读取药品相关信息

          If Instr(',5,6,7,', ',' || r_Advice.诊疗类别 || ',') > 0 Then
            --毒理分类判断功能，暂时不实现，暂不处理

            --对Ft_Dg记录集赋值;f_Getdruginfo获取的规格已经排除了，撤档，服务对象，开单科室的判断
            Mn_Tmp := f_Getdruginfo(r_Advice.诊疗项目id, r_Advice.收费细目id, r_Advice.执行科室id, r_Advice.开嘱科室id, Ft_Dg);

            n_Row规格 := 1; --默认用第一个
            If Ft_Dg.Count = 0 Then
              Vsadvice(n_Row).禁止发送 := 1;
              Vsadvice(n_Row).禁止原因 := r_Advice.医嘱内容 || '  没有发现有效的药品规格信息，该药品可能已经被停用或不能用于住院病人。';
            Elsif Ft_Dg.Count > 1 Then
              --寻找一个可用的规格，暂不处理返回其它可用的规格 寻找剂量单位为单量的最小倍数的规格
              Lng倍数 := 0;
              For I In 1 .. Ft_Dg.Count Loop
                If Ft_Dg(I).剂量系数 / r_Advice.单次用量 = b_Zlhis_Ciskernel.f_Int(Ft_Dg(I).剂量系数 / r_Advice.单次用量) Then
                  If Ft_Dg(I).剂量系数 / r_Advice.单次用量 < Lng倍数 Or Lng倍数 = 0 Then
                    n_Row规格 := I;
                    Lng倍数   := Ft_Dg(I).剂量系数 / r_Advice.单次用量;
                  End If;
                End If;
              End Loop;
            End If;
            If Nvl(Vsadvice(n_Row).禁止发送, 0) = 0 Then
              Mv_Tmp := Ft_Dg(n_Row规格).名称;
              If Ft_Dg(n_Row规格).产地 Is Not Null Then
                Mv_Tmp := Mv_Tmp || '(' || Ft_Dg(n_Row规格).产地 || ')';
              End If;
              If Ft_Dg(n_Row规格).规格 Is Not Null Then
                Mv_Tmp := Mv_Tmp || ' ' || Ft_Dg(n_Row规格).规格;
              End If;
              Vsadvice(n_Row).规格 := Mv_Tmp;
              Vsadvice(n_Row).收费细目id := Ft_Dg(n_Row规格).药品id;
              Vsadvice(n_Row).库存 := Nvl(Ft_Dg(n_Row规格).库存, 0); --未处理四舍五入   Vsadvice(n_Row).库存:=  Format(NVL(Ft_Dg(n_Row规格).库存, 0), "0.00000") --按住院包装
              Vsadvice(n_Row).剂量系数 := Nvl(Ft_Dg(n_Row规格).剂量系数, 1);
              Vsadvice(n_Row).住院包装 := Nvl(Ft_Dg(n_Row规格).住院包装, 1);
              Vsadvice(n_Row).住院单位 := Ft_Dg(n_Row规格).住院单位;
              Vsadvice(n_Row).可否分零 := Nvl(r_Advice.可否分零, Nvl(Ft_Dg(n_Row规格).可否分零, 0));
              Vsadvice(n_Row).药房分批 := Nvl(Ft_Dg(n_Row规格).药房分批, 0);
              Vsadvice(n_Row).是否变价 := Nvl(Ft_Dg(n_Row规格).是否变价, 0);
            End If;
          End If;
        End If;

        --标记为删后不用执行后面的语句
        If Vsadvice(n_Row).禁止发送 = 0 Then
          ----计算发送次数，执行的分解时间，总量
          If Vsadvice(n_Row).医嘱期效 = 0 Then
            --长嘱
            If Vsadvice(n_Row).诊疗类别 = '7' Then
              --当前医嘱的发送计算时间段
              Mn_Tmp := f_Calc总量次数时间(Vsadvice(n_Row), Ft_Dg(n_Row规格), Mv_截止日期, n_总量, n_次数, v_分解);
              Vsadvice(n_Row).次数 := n_次数;
              Vsadvice(n_Row).分解时间 := v_分解;

              If Vsadvice(n_Row).分解时间 Is Not Null Then
                Vsadvice(n_Row).首次时间 := b_Zlhis_Ciskernel.f_Stranal(v_分解, 2);
                Vsadvice(n_Row).末次时间 := b_Zlhis_Ciskernel.f_Stranal(v_分解, 3);
              Else
                Vsadvice(n_Row).禁止发送 := 1;
                Vsadvice(n_Row).禁止原因 := r_Advice.医嘱内容 || '  无可以执行的时间点。';
              End If;
              If Vsadvice(n_Row).禁止发送 = 0 Then
                Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
                Vsadvice(n_Row).总量 := n_次数 * Nvl(r_Advice.总给予量, 1); --总付数
                Vsadvice(n_Row).总量单位 := '付';
              End If;
              --撤档或不服务于病人的药品暂不处理
            Elsif Instr(',5,6,', ',' || Vsadvice(n_Row).诊疗类别 || ',') > 0 Then
              --当前医嘱的发送计算时间段,dbl总量, lng次数, str分解时间
              Mn_Tmp := f_Calc总量次数时间(Vsadvice(n_Row), Ft_Dg(n_Row规格), Mv_截止日期, n_总量, n_次数, v_分解);
              Vsadvice(n_Row).次数 := n_次数;
              Vsadvice(n_Row).分解时间 := v_分解;
              If Vsadvice(n_Row).分解时间 Is Not Null Then
                Vsadvice(n_Row).首次时间 := b_Zlhis_Ciskernel.f_Stranal(v_分解, 2);
                Vsadvice(n_Row).末次时间 := b_Zlhis_Ciskernel.f_Stranal(v_分解, 3);
              Else
                Vsadvice(n_Row).禁止发送 := 1;
                Vsadvice(n_Row).禁止原因 := r_Advice.医嘱内容 || '  无可以执行的时间点。';
              End If;
              If Vsadvice(n_Row).禁止发送 = 0 Then
                Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
                Vsadvice(n_Row).总量 := n_总量;
                Vsadvice(n_Row).总量单位 := Ft_Dg(n_Row规格).住院单位;

                If n_次数 < n_最小次数 Or n_最小次数 = 0 Then
                  n_最小次数 := n_次数;
                End If;
              End If;
              --当有多个规格可选择时，根据库存是否足够再次定位规格,暂时不处理
              --被撤档或不服务于病人的药品暂时不处理
            Else
              If Vsadvice(n_Row - 1).禁止发送 = 0 Then
                --一并给药的按最小次数发送(影响给药途径计费及上次执行时间)(不分零的可能浪费)
                If Vsadvice(n_Row).药品执行类别 = 1 Then
                  --给药途径
                  For I In 2 .. n_Row Loop
                    If Nvl(Vsadvice(n_Row - I + 1).相关id, 0) = r_Advice.Id Then
                      Vsadvice(n_Row - I + 1).附加执行 := r_Advice.执行科室;

                      If Vsadvice(n_Row - I + 1).次数 > n_最小次数 Then
                        Vsadvice(n_Row - I + 1).次数 := n_最小次数;
                        v_分解 := b_Zlhis_Ciskernel.f_Trim分解时间(n_最小次数, Vsadvice(n_Row - I + 1).分解时间);
                        Vsadvice(n_Row - I + 1).分解时间 := v_分解;
                        Vsadvice(n_Row - I + 1).首次时间 := Substr(v_分解, 1, 16);
                        Vsadvice(n_Row - I + 1).末次时间 := Substr(v_分解, 1, 16);
                      End If;
                    Else
                      Exit;
                    End If;
                  End Loop;
                  n_最小次数 := 0;
                End If;
                If Instr(',2,3,', Vsadvice(n_Row).药品执行类别) > 0 Then
                  --中药煎法、用法为付数
                  Vsadvice(n_Row).总量 := Vsadvice(n_Row - 1).总量;
                Else
                  Vsadvice(n_Row).总量 := Vsadvice(n_Row - 1).次数;
                End If;
                Vsadvice(n_Row).次数 := Vsadvice(n_Row - 1).次数;
                If Vsadvice(n_Row).药品执行类别 = 3 Then
                  --中药用法
                  Vsadvice(n_Row).总量单位 := '付';
                End If;
                Vsadvice(n_Row).分解时间 := Vsadvice(n_Row - 1).分解时间;
                Vsadvice(n_Row).首次时间 := Vsadvice(n_Row - 1).首次时间;
                Vsadvice(n_Row).末次时间 := Vsadvice(n_Row - 1).末次时间;
                --备用医嘱mlngRefModld
                If Mn_医嘱处理范围 = 1 Then
                  If (Md_备用执行时间 >= r_Advice.执行终止时间 Or Md_备用执行时间 <= r_Advice.上次执行时间) Then
                    --备用医嘱删除范围外的备用医嘱
                    Vsadvice(n_Row).禁止发送 := 1;
                    Vsadvice(n_Row).禁止原因 := r_Advice.医嘱内容 || '  备用医嘱已发送排除。';
                  End If;
                End If;
              End If;
            End If;
          End If;
          --临时医嘱
          If Vsadvice(n_Row).医嘱期效 = 1 Then
            If r_Advice.诊疗类别 = '7' Then
              Vsadvice(n_Row).次数 := r_Advice.总给予量;
              If r_Advice.执行时间方案 Is Not Null Or Nvl(r_Advice.间隔单位, '*') = '分钟' Then
                v_分解 := b_Zlhis_Ciskernel.f_Calc次数分解时间(r_Advice.总给予量, r_Advice.开始执行时间,
                                                       To_Date('3000-01-01', 'yyyy-mm-dd'), r_Advice.执行时间方案,
                                                       r_Advice.频率间隔, r_Advice.间隔单位);

                If v_分解 Is Not Null Then
                  Vsadvice(n_Row).分解时间 := v_分解;
                  Vsadvice(n_Row).首次时间 := Substr(v_分解, 1, 16);
                  Vsadvice(n_Row).末次时间 := Substr(v_分解, Instr(v_分解, ',', -1) + 1, 16);
                End If;
              Else
                --无分解时间(临嘱可能未输入执行时间而无法分解)
                --记录费用发生时间(以医嘱开始执行时间)
                Vsadvice(n_Row).分解时间 := To_Char(r_Advice.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
              End If;

              Vsadvice(n_Row).单量 := r_Advice.单次用量;
              Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
              Vsadvice(n_Row).总量 := r_Advice.总给予量;
              Vsadvice(n_Row).总量单位 := '付';
            Elsif Instr(',5,6,', ',' || r_Advice.诊疗类别 || ',') > 0 Then
              --计算临嘱用药次数
              If Nvl(r_Advice.频率次数, 0) = 0 Or Nvl(r_Advice.频率间隔, 0) = 0 Then
                n_次数 := 1; --设置为一次性的临嘱药品
              Elsif Nvl(r_Advice.天数, 0) <> 0 And r_Advice.执行频次 Is Not Null Then
                --一个频率周期的次数
                If r_Advice.间隔单位 = '周' Then
                  n_次数 := b_Zlhis_Ciskernel.f_Intex(r_Advice.天数 * (r_Advice.频率次数 / 7));
                Elsif r_Advice.间隔单位 = '天' Then
                  n_次数 := b_Zlhis_Ciskernel.f_Intex(r_Advice.天数 * (r_Advice.频率次数 / r_Advice.频率间隔));
                Elsif r_Advice.间隔单位 = '小时' Then
                  n_次数 := b_Zlhis_Ciskernel.f_Intex(r_Advice.天数 * (r_Advice.频率次数 / r_Advice.频率间隔) * 24);
                Elsif r_Advice.间隔单位 = '分钟' Then
                  n_次数 := b_Zlhis_Ciskernel.f_Intex(r_Advice.天数 * (r_Advice.频率次数 / r_Advice.频率间隔) * (24 * 60));
                End If;
              Else
 --可分零药品时,按总量对单量的倍数计算给药途径的次数,不可分零与一次性使用药品时，按总量对（单量与剂量系数比值取整）的倍数计算给药途径的次数
                --否则按一个频率周期的次数计算
                --If Nvl(r_Advice.可否分零, 0) = 0 And Nvl(r_Advice.单次用量, 0) <> 0 Then
                If Nvl(Vsadvice(n_Row).可否分零, 0) = 0 And Nvl(r_Advice.单次用量, 0) <> 0 Then
                  n_次数 := b_Zlhis_Ciskernel.f_Intex(r_Advice.总给予量 * Vsadvice(n_Row).剂量系数 / r_Advice.单次用量);
                --Elsif (Nvl(r_Advice.可否分零, 0) = 1 Or Nvl(r_Advice.可否分零, 0) = 2) And Nvl(r_Advice.单次用量, 0) <> 0 Then
                Elsif (Nvl(Vsadvice(n_Row).可否分零, 0) = 1 Or Nvl(Vsadvice(n_Row).可否分零, 0) = 2) And Nvl(r_Advice.单次用量, 0) <> 0 Then
                  n_次数 := b_Zlhis_Ciskernel.f_Intex(r_Advice.总给予量 /
                                                    b_Zlhis_Ciskernel.f_Intex(r_Advice.单次用量 / Vsadvice(n_Row).剂量系数));
                Else
                  n_次数 := Nvl(r_Advice.频率次数, 0);
                End If;
              End If;

              If r_Advice.执行时间方案 Is Not Null Or Nvl(r_Advice.间隔单位, '*') = '分钟' Then
                v_分解 := b_Zlhis_Ciskernel.f_Calc次数分解时间(n_次数, r_Advice.开始执行时间, To_Date('3000-01-01', 'yyyy-mm-dd'),
                                                       r_Advice.执行时间方案, r_Advice.频率间隔, r_Advice.间隔单位);
                If v_分解 Is Not Null Then
                  Vsadvice(n_Row).分解时间 := v_分解;
                  Vsadvice(n_Row).首次时间 := Substr(v_分解, 1, 16);
                  Vsadvice(n_Row).末次时间 := Substr(v_分解, Instr(v_分解, ',', -1) + 1, 16);
                End If;
              Else
                --无分解时间(临嘱可能未输入执行时间而无法分解)
                --记录费用发生时间(以医嘱开始执行时间)
                Vsadvice(n_Row).分解时间 := To_Char(r_Advice.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
                Vsadvice(n_Row).首次时间 := Vsadvice(n_Row).分解时间;
                Vsadvice(n_Row).末次时间 := Vsadvice(n_Row).分解时间;
              End If;
              Vsadvice(n_Row).次数 := n_次数;
              Vsadvice(n_Row).单量 := r_Advice.单次用量;
              Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
              Vsadvice(n_Row).总量 := Round(r_Advice.总给予量 / Nvl(Ft_Dg(n_Row规格).住院包装, 1), 5);
              Vsadvice(n_Row).总量单位 := Ft_Dg(n_Row规格).住院单位;
              If n_次数 < n_最小次数 Or n_最小次数 = 0 Then
                n_最小次数 := n_次数;
              End If;
            Else
              --给药途径,中药煎法,中药用法,采集方法,输血途径
              --一并给药的按最小次数发送(影响给药途径计费)
              If Vsadvice(n_Row).药品执行类别 = 1 Then
                --给药途径
                For J In 2 .. n_Row Loop
                  If Vsadvice(n_Row - J + 1).相关id = r_Advice.Id Then
                    If Vsadvice(n_Row - J + 1).次数 > n_最小次数 Then
                      Vsadvice(n_Row - J + 1).次数 := n_最小次数;
                      If Vsadvice(n_Row - J + 1).分解时间 Is Not Null Then
                        v_分解 := b_Zlhis_Ciskernel.f_Trim分解时间(n_最小次数, Vsadvice(n_Row - J + 1).分解时间);
                        Vsadvice(n_Row - J + 1).分解时间 := v_分解;
                        Vsadvice(n_Row - J + 1).首次时间 := Substr(v_分解, 1, 16);
                        Vsadvice(n_Row - J + 1).末次时间 := Substr(v_分解, Instr(v_分解, ',', -1) + 1, 16);
                      End If;
                    End If;
                  Else
                    Exit;
                  End If;
                End Loop;
                n_最小次数 := 0;
              End If;
              --忽略指定了给药执行次数情况
              Vsadvice(n_Row).总量 := Vsadvice(n_Row - 1).次数; --付数或次数
              Vsadvice(n_Row).次数 := Vsadvice(n_Row - 1).次数;
              Vsadvice(n_Row).分解时间 := Vsadvice(n_Row - 1).分解时间;
              Vsadvice(n_Row).首次时间 := Vsadvice(n_Row - 1).首次时间;
              Vsadvice(n_Row).末次时间 := Vsadvice(n_Row - 1).末次时间;
              If Vsadvice(n_Row).药品执行类别 = '3' Then
                --中药用法
                Vsadvice(n_Row).总量单位 := '付';
              End If;
            End If;
          End If;
          if Ft_Dg is null then
            Ft_Dg:= t_Druginfo();
            Ft_Dg.extend;
            n_Row规格:=1;
          end if;
          --计算项目的金额，记帐报警暂不处理
          Mn_Tmp := f_Loadadviceprice(n_Row, Ft_Dg(n_Row规格), n_金额);

          Vsadvice(n_Row).金额 := Round(n_金额, Gn_Dec);

          --相关行时的一些处理：累计显示金额,给药途径,用法,执行科室,执行性质
          If r_Advice.诊疗类别 = 'E' And Instr(',1,3,', ',' || Vsadvice(n_Row).药品执行类别 || ',') > 0 Then
            n_金额 := 0;
            n_Tmp  := 0; --药品首行
            For I In 0 .. n_Row Loop
              If Nvl(Vsadvice(n_Row - I - 1).相关id, 0) = r_Advice.Id Then
                n_Tmp := n_Row - I - 1;
              Else
                Exit;
              End If;
            End Loop;
            If Vsadvice(n_Row).药品执行类别 = 1 Then
              --将给药途径的金额叠加到药品首行上面
              Vsadvice(n_Tmp).金额 := Nvl(Vsadvice(n_Tmp).金额, 0) + Nvl(Vsadvice(n_Row).金额, 0);
              For I In n_Tmp .. n_Row - 1 Loop
                v_Tmp := Null;
                If Vsadvice(I).执行性质id = 5 And Nvl(Vsadvice(n_Row).执行性质id, 0) <> 5 Then
                  v_Tmp := '自备药';
                Elsif Nvl(Vsadvice(I).执行性质id, 0) <> 5 And Vsadvice(n_Row).执行性质id = 5 Then
                  v_Tmp := '离院带药';
                End If;
                Vsadvice(I).执行性质 := v_Tmp;
                Vsadvice(I).用法 := r_Advice.诊疗项目;
                Vsadvice(I).给药途径项目id := r_Advice.诊疗项目id; --给药途径诊目id
                Vsadvice(I).附加执行科室id := Vsadvice(n_Row).执行科室id; --给药途径执行科室id.
              End Loop;
            Else
              v_Tmp := Null;
              If Vsadvice(n_Tmp).执行性质id = 5 And Nvl(Vsadvice(n_Row).执行性质id, 0) <> 5 Then
                v_Tmp := '自备药';
              Elsif Nvl(Vsadvice(n_Tmp).执行性质id, 0) <> 5 And Vsadvice(n_Row).执行性质id = 5 Then
                v_Tmp := '离院带药';
              End If;
              Vsadvice(n_Row).执行性质 := v_Tmp;
              Vsadvice(n_Row).执行科室 := Vsadvice(n_Tmp).执行科室;
              v_用法 := Null;
              If Vsadvice(n_Row - 1).药品执行类别 = 2 Then
                --煎法
                Select Max(名称) Into v_用法 From 诊疗项目目录 Where ID = Vsadvice(n_Row - 1).诊疗项目id;
              End If;
              If v_用法 Is Null Then
                v_用法 := r_Advice.诊疗项目;
              Else
                v_用法 := r_Advice.诊疗项目 || '|' || v_用法;
              End If;
              n_金额 := 0;
              For I In n_Tmp .. n_Row - 1 Loop
                n_金额 := n_金额 + Nvl(Vsadvice(I).金额, 0);
                Vsadvice(I).用法 := v_用法;
                Vsadvice(I).给药途径项目id := r_Advice.诊疗项目id; --中药服法项目id
                Vsadvice(I).执行性质 := Vsadvice(n_Row).执行性质;
                Vsadvice(I).附加执行科室id := Vsadvice(n_Row).执行科室id; --中药服法项目 执行科室id
              End Loop;
              --中药的金额处理，汇总后显示到中药的用法行上
              Vsadvice(n_Row).金额 := Nvl(Vsadvice(n_Row).金额, 0) + Nvl(n_金额, 0);
            End If;
          End If;
          --药品库存检查:自备药不检查，暂时不处理
        End If;
      End If;
    End Loop;
    Return(1);
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
      Return(0);
  End f_Loadadvicedrug;

  --非药品医嘱缓存
  Function f_Loadadviceother Return Number Is
    --医嘱记录集
    Cursor c_Advice
    (
      Nc_病人id_In 病人医嘱记录.病人id%Type,
      Nc_主页id_In 病人医嘱记录.主页id%Type,
      Nd_日期      Date,
      Nv_期效      Varchar2, --期效
      Nv_Sids      Varchar2,
      Nn_范围      Number,
      Nn_备用      Number,
      Nd_备用时间  Date
    ) Is
      Select a.Id, a.相关id, Nvl(a.相关id, a.Id) As 组id, Nvl(x.序号, a.序号) As 组号,b.医疗付款方式, a.序号, a.诊疗类别, g.名称 As 类别名称, a.诊疗项目id,
             e.名称 As 诊疗项目, a.收费细目id, b.入院日期, a.婴儿, a.病人id, a.主页id, b.住院号, b.出院病床 As 床号, d.名称 As 科室, a.姓名, a.性别, a.年龄,
             b.费别, b.险类, a.开始执行时间, a.上次执行时间, a.医嘱内容, a.总给予量, a.单次用量, e.计算规则, Decode(a.诊疗类别, '4', h.计算单位, e.计算单位) As 计算单位,
             a.执行终止时间, b.病人性质, a.开嘱时间, a.申请序号, e.执行分类, a.执行频次, Decode(a.执行频次, '必要时', 1, a.频率次数) As 频率次数,
             Decode(a.执行频次, '必要时', 1, a.频率间隔) As 频率间隔, Decode(a.执行频次, '必要时', '天', a.间隔单位) As 间隔单位, a.医生嘱托,
             Decode(a.执行频次, '必要时', Null, a.执行时间方案) As 执行时间方案, Null As 病人病区id, a.病人科室id, a.开嘱科室id, a.开嘱医生, a.摘要, a.标本部位,
             a.检查方法, a.执行标记, a.计价特性, e.操作类型, e.试管编码, e.执行频率, a.执行性质, a.执行科室id,
             Nvl(f.名称, Decode(Nvl(a.执行性质, 0), 5, '-')) As 执行科室, h.是否变价, i.跟踪在用, a.紧急标志, a.医嘱状态, a.医嘱期效, h.撤档时间, a.首次用量,
             e.计算方式, e.执行安排, a.用药理由, i.高值材料, a.会诊医嘱id, Null As 天数, Null As 可否分零, Null As 剂量系数, a.审核状态
      From 病人医嘱记录 A, 病案主页 B, 病人信息 C, 部门表 D, 诊疗项目目录 E, 部门表 F, 诊疗项目类别 G, 收费项目目录 H, 材料特性 I, 病人医嘱记录 X
      Where a.病人id = c.病人id And b.出院科室id = d.Id And a.收费细目id = h.Id(+) And a.收费细目id = i.材料id(+) And a.病人id = b.病人id And
            a.主页id = b.主页id And b.主页id = c.主页id And a.相关id = x.Id(+) And a.诊疗项目id = e.Id(+) And e.类别 = g.编码(+) And
            a.执行科室id = f.Id(+) And Not (a.诊疗类别 = 'E' And a.相关id Is Not Null And e.操作类型 = '3') And Not Exists
       (Select ID
             From 病人医嘱记录 X
             Where 诊疗类别 In ('5', '6', '7') And x.相关id = a.Id And x.病人id = Nc_病人id_In And x.主页id = Nc_主页id_In) And
            a.诊疗类别 Is Not Null And (Nvl(a.执行性质, 0) <> 0 Or a.诊疗类别 = 'E' And e.操作类型 In ('6', '8')) And
            Nvl(a.诊疗类别, '自由') Not In ('5', '6', '7') And a.开始执行时间 Is Not Null And Nvl(a.执行标记, 0) <> -1 And a.病人来源 <> 3 And
            a.前提id Is Null And
            ((a.开始执行时间 <= Nd_日期 And (a.上次执行时间 < Nd_日期 Or a.上次执行时间 Is Null) And
            (a.执行终止时间 > a.上次执行时间 Or a.执行终止时间 Is Null Or a.上次执行时间 Is Null) And
            (a.执行终止时间 > a.开始执行时间 Or a.执行终止时间 Is Null) And a.医嘱期效 = 0 And
            Not (Nvl(a.诊疗类别, '自由') = 'H' And e.操作类型 = '1' And e.执行频率 = 2) And
            Not (Nvl(a.诊疗类别, '自由') = 'Z' And e.操作类型 In ('4', '14', '9', '10', '12')) And
            Nvl(a.医嘱状态, 0) Not In (-1, 1, 2, 4)) Or (Nvl(a.医嘱状态, 0) Not In (-1, 1, 2, 4, 8, 9) And a.医嘱期效 = 1)) And
            (Nn_备用 = 0 And (Nvl(a.执行频次, '无') <> '必要时' And Nvl(a.执行频次, '无') <> '需要时') Or
            Nn_备用 = 1 And (Nvl(a.执行频次, '无') = '必要时' Or Nvl(a.执行频次, '无') = '需要时' And Nd_备用时间 - a.开始执行时间 < 0.5)) And
            a.病人id = Nc_病人id_In And a.主页id = Nc_主页id_In And Instr(Nv_期效, ',' || a.医嘱期效 || ',') > 0 And
            (Instr(',' || Nv_Sids || ',', ',' || Nvl(a.相关id, a.Id) || ',') > 0 Or Nv_Sids Is Null) And
            (Nn_范围 = 0 Or Nn_范围 = 1 And Nvl(a.婴儿, 0) = 0 Or Nn_范围 = 2 And Nvl(a.婴儿, 0) > 0)
      Order By a.医嘱期效, a.婴儿, 组号, 组id, a.序号;
    r_Advice c_Advice%RowType;

    n_Row       Number;
    v_分解      Varchar2(32767);
    n_次数      Number;
    Bln采集方法 Boolean;
    n_总量      Number(16, 5);
    n_金额      Number(16, 5) := 0;
    Row_Dg      r_Druginfo;
    v_期效      Varchar2(10);
    c_Tmp       Rs_Recordset;
    v_Sql       Varchar2(32767);

  Begin
    If Mn_非药长嘱 = 0 And Mn_非药临嘱 = 0 Then
      Return 0;
    End If;

    If Mn_非药长嘱 = 1 Then
      v_期效 := ',0,';
    End If;

    If Mn_非药临嘱 = 1 Then
      v_期效 := v_期效 || ',1,';
    End If;

    v_Sql := 'Select a.Id, a.相关id, Nvl(a.相关id, a.Id) As 组id, Nvl(x.序号, a.序号) As 组号,b.医疗付款方式, a.序号, a.诊疗类别, g.名称 As 类别名称, a.诊疗项目id,' ||
             'e.名称 As 诊疗项目, a.收费细目id, b.入院日期, a.婴儿, a.病人id, a.主页id, b.住院号, b.出院病床 As 床号, d.名称 As 科室, a.姓名, a.性别, a.年龄,' ||
             Chr(10) || 'b.费别, b.险类,';
    --1 , 2 号参数  md_备用执行时间,md_备用执行时间,
    If Mn_医嘱处理范围 = 0 Then
      v_Sql := v_Sql || 'decode(1,1,a.开始执行时间,2,:1,3,:2,null) as 开始执行时间,';
    Else
      v_Sql := v_Sql || 'Decode(Sign(A.开始执行时间-:1),-1,:2,A.开始执行时间) as 开始执行时间,';
    End If;
    --3 号参数  substr(mv_备用执行时间,12)
    --4 号参数  mn_病区id
    --5 6 7 8 9   号参数  Md_截止日期,Md_截止日期, Mn_病人id, Mn_主页id,mv_期效
    v_Sql := v_Sql || 'a.上次执行时间, a.医嘱内容, a.总给予量, a.单次用量, e.计算规则,' || Chr(10) ||
             'Decode(a.诊疗类别, ''4'', h.计算单位, e.计算单位) As 计算单位, a.执行终止时间, b.病人性质, a.开嘱时间, a.申请序号, e.执行分类, a.执行频次,' ||
             Chr(10) || 'Decode(a.执行频次, ''必要时'', 1, a.频率次数) As 频率次数, Decode(a.执行频次, ''必要时'', 1, a.频率间隔) As 频率间隔,' ||
             'Decode(a.执行频次, ''必要时'', ''天'', a.间隔单位) As 间隔单位, a.医生嘱托, Decode(a.执行频次, ''必要时'', :3, a.执行时间方案) As 执行时间方案,' ||
             ':4 As 病人病区id, a.病人科室id, a.开嘱科室id, a.开嘱医生, a.摘要, a.标本部位, a.检查方法, a.执行标记, a.计价特性, e.操作类型, e.试管编码, e.执行频率,' ||
             'a.执行性质, a.执行科室id, Nvl(f.名称, Decode(Nvl(a.执行性质, 0), 5, ''-'')) As 执行科室, h.是否变价, i.跟踪在用, a.紧急标志, a.医嘱状态,' ||
             'a.医嘱期效, h.撤档时间, a.首次用量, e.计算方式, e.执行安排, a.用药理由, i.高值材料, a.会诊医嘱id, Null As 天数, Null As 可否分零, Null As 剂量系数,' ||
             Chr(10) || 'a.审核状态' || Chr(10) ||
             'From 病人医嘱记录 A, 病案主页 B, 病人信息 C, 部门表 D, 诊疗项目目录 E, 部门表 F, 诊疗项目类别 G, 收费项目目录 H, 材料特性 I, 病人医嘱记录 X' || Chr(10) ||
             ' Where a.病人id = c.病人id And b.出院科室id = d.Id And a.收费细目id = h.Id(+) And a.收费细目id = i.材料id(+) And a.病人id = b.病人id And' ||
             ' a.主页id = b.主页id And b.主页id = c.主页id And a.相关id = x.Id(+) And a.诊疗项目id = e.Id(+) And e.类别 = g.编码(+) And' ||
             Chr(10) || ' a.执行科室id = f.Id(+) And Not (a.诊疗类别 = ''E'' And a.相关id Is Not Null And e.操作类型 = ''3'') And' ||
             ' a.诊疗类别 Is Not Null And (Nvl(a.执行性质, 0) <> 0 Or a.诊疗类别 = ''E'' And e.操作类型 In (''6'', ''8'')) And' ||
             ' Nvl(a.诊疗类别, ''自由'') Not In (''5'', ''6'', ''7'') And a.开始执行时间 Is Not Null And Nvl(a.执行标记, 0) <> -1 And' ||
             Chr(10) || ' a.病人来源 <> 3 And a.前提id Is Null And' || Chr(10) ||
             ' ((a.开始执行时间 <= :5 And (a.上次执行时间 < :6 Or a.上次执行时间 Is Null) And' || Chr(10) ||
             ' (a.执行终止时间 > a.上次执行时间 Or a.执行终止时间 Is Null Or a.上次执行时间 Is Null) And' || Chr(10) ||
             ' (a.执行终止时间 > a.开始执行时间 Or a.执行终止时间 Is Null) And a.医嘱期效 = 0 And' || Chr(10) ||
             ' Not (Nvl(a.诊疗类别, ''自由'') = ''H'' And e.操作类型 = ''1'' And e.执行频率 = 2) And' || Chr(10) ||
             ' Not (Nvl(a.诊疗类别, ''自由'') = ''Z'' And e.操作类型 In (''4'', ''14'', ''9'', ''10'', ''12'')) And' || Chr(10) ||
             ' Nvl(a.医嘱状态, 0) Not In (-1, 1, 2, 4)) Or (Nvl(a.医嘱状态, 0) Not In (-1, 1, 2, 4, 8, 9) And a.医嘱期效 = 1))';
    v_Sql := v_Sql || ' And a.病人id = :7 And a.主页id = :8 and instr(:9,'',''||a.医嘱期效||'','')>0  ';

    If Mx_Yzids Is Null Then
      --10 11号参数，Mv_医嘱ids,Mv_医嘱ids
      v_Sql := v_Sql || ' and (:10 is null and  :11 is null) ';
    Else
      --10 11号参数，Mx_Yzids,Mv_医嘱ids
      v_Sql := v_Sql ||
               ' and nvl(a.相关id,a.id) in (Select b.医嘱id From Xmltable(''$a/XYZIDS/ITEM'' Passing :10 As "a" Columns 医嘱id Number(18) Path ''YZID'' ) B)   and  :11 is null';
    End If;

    --12,13,14,号参数,mn_病人范围,mn_病人范围,mn_病人范围
    v_Sql := v_Sql || ' and (:12=0 or :13=1 and nvl(a.婴儿,0)=0 or :14=2 and nvl(a.婴儿,0)>0) ';

    --15,16 号参数, Mn_病人id, Mn_主页id
    v_Sql := v_Sql ||
             ' And Not Exists  (Select ID From 病人医嘱记录 X Where 诊疗类别 In (''5'', ''6'', ''7'') And x.相关id = a.Id And x.病人id = :15 And x.主页id = :16) ';

    --17,18,19  号参数, in mn_医嘱处理范围,in mn_医嘱处理范围,in md_备用执行时间
    v_Sql := v_Sql || ' And (     :17=0 and (Nvl(a.执行频次, ''无'') <> ''必要时'' And Nvl(a.执行频次, ''无'') <> ''需要时'')' ||
             Chr(10) ||
             ' or :18=1  And (NVL(a.执行频次,''无'')=''必要时'' Or NVL(a.执行频次,''无'')=''需要时'' And :19 - a.开始执行时间<0.5)) ';

    --20,21,22,23,24,25 号参数 , In Mn_病人id, In Mn_主页id, in mn_执行科室id , In Mn_病人id, In Mn_主页id, in mn_执行科室id
    If Mn_执行科室id = 0 Then
      v_Sql := v_Sql || ' and (1=1 or 0= :20+:21+:22+:23+:24+:25 ) ';
    Else
      v_Sql := v_Sql ||
               ' And Exists( Select ID From 病人医嘱记录 X Where 相关ID is Null And (X.ID=A.ID Or X.ID=A.相关ID) And x.病人ID=:20 and x.主页id=:21 And x.执行科室ID+0=:22' ||
               Chr(10) || 'Union ALL  Select ID From 病人医嘱记录 X Where' || Chr(10) ||
               'x.相关ID is Not Null And x.诊疗类别=''C'' And (X.相关ID=A.相关ID Or X.相关ID=A.ID) And x.病人ID=:23 and x.主页id=:24 And x.执行科室ID+0=:25) ';
    End If;
    --26,27,28,29 号参数  , In Mn_病人id, In Mn_主页id  , In Mn_病人id, In Mn_主页id
    If Mv_诊疗类别 Is Not Null Then
      v_Sql := v_Sql ||
               ' And Exists( Select ID From 病人医嘱记录 X Where x.相关ID is Null And (X.ID=A.ID Or X.ID=A.相关ID) And x.病人ID=:26 and x.主页id=:27 And instr('''||Mv_诊疗类别 ||''',x.诊疗类别)>0 Union ALL' || Chr(10) ||
               ' Select ID From 病人医嘱记录 X Where x.相关ID is Not Null And x.诊疗类别=''C'' And (X.相关ID=A.相关ID Or X.相关ID=A.ID) And x.病人ID=:28 and x.主页id=:29 And instr('''||Mv_诊疗类别 ||''',x.诊疗类别)>0 )';
    Else
      v_Sql := v_Sql || ' and (1=1 or 0= :26+:27+:28+:29  ) ';
    End If;

    v_Sql := v_Sql || ' Order By a.医嘱期效, a.婴儿, 组号, 组id, a.序号';

    Mv_Tmp := Null;
    Open c_Tmp For v_Sql
      Using In Md_备用执行时间, In Md_备用执行时间, In Substr(Mv_备用执行时间, 12), In Mn_病区id, In Md_截止日期, In Md_截止日期, In Mn_病人id, In Mn_主页id, In v_期效, In Mx_Yzids, In Mv_Tmp, In Mn_病人范围, In Mn_病人范围, In Mn_病人范围, In Mn_病人id, In Mn_主页id, In Mn_医嘱处理范围, In Mn_医嘱处理范围, In Md_备用执行时间, In Mn_病人id, In Mn_主页id, In Mn_执行科室id, In Mn_病人id, In Mn_主页id, In Mn_执行科室id, In Mn_病人id, In Mn_主页id, In Mn_病人id, In Mn_主页id;
    Loop
      Fetch c_Tmp
        Into r_Advice;
      Exit When c_Tmp%NotFound;
      If c_Tmp%RowCount > 0 Then
        Vsadvice.Extend;
        n_Row := Vsadvice.Count; --当前行
        Vsadvice(n_Row).选择 := 1;
        Vsadvice(n_Row).禁止发送 := 0;
        Vsadvice(n_Row).婴儿序号 := r_Advice.婴儿;
        If Nvl(r_Advice.婴儿, 0) = 0 Then
          Vsadvice(n_Row).婴儿 := '病人';
        Else
          Vsadvice(n_Row).婴儿 := '婴儿' || r_Advice.婴儿;
        End If;
        Vsadvice(n_Row).科室 := r_Advice.科室; --出院科室
        Vsadvice(n_Row).病人id := r_Advice.病人id;
        Vsadvice(n_Row).主页id := r_Advice.主页id;
        Vsadvice(n_Row).姓名 := r_Advice.姓名;
        Vsadvice(n_Row).性别 := r_Advice.性别;
        Vsadvice(n_Row).年龄 := r_Advice.年龄;
        Vsadvice(n_Row).险类 := r_Advice.险类;
        Vsadvice(n_Row).住院号 := r_Advice.住院号;
        Vsadvice(n_Row).床号 := r_Advice.床号;
        Vsadvice(n_Row).序号 := r_Advice.序号;
        Vsadvice(n_Row).组号 := r_Advice.组号;
        Vsadvice(n_Row).医疗付款方式 := r_Advice.医疗付款方式;
        Vsadvice(n_Row).组id := r_Advice.组id;
        Vsadvice(n_Row).费别 := r_Advice.费别;
        Vsadvice(n_Row).Id := r_Advice.Id;
        Vsadvice(n_Row).相关id := r_Advice.相关id;
        Vsadvice(n_Row).诊疗类别 := r_Advice.诊疗类别;
        Vsadvice(n_Row).诊疗项目id := r_Advice.诊疗项目id;
        Vsadvice(n_Row).诊疗项目 := r_Advice.诊疗项目;
        Vsadvice(n_Row).执行终止时间 := r_Advice.执行终止时间;
        If Nvl(r_Advice.医嘱期效, 0) = 0 Then
          Vsadvice(n_Row).期效 := '长嘱';
        Else
          Vsadvice(n_Row).期效 := '临嘱';
        End If;
        Vsadvice(n_Row).医嘱期效 := r_Advice.医嘱期效;

        Vsadvice(n_Row).紧急标志 := r_Advice.紧急标志;
        Vsadvice(n_Row).医嘱期效 := r_Advice.医嘱期效;
        If Nvl(r_Advice.医嘱期效, 0) = 0 Then
          Vsadvice(n_Row).期效 := '长嘱';
        Else
          Vsadvice(n_Row).期效 := '临嘱';
        End If;

        Vsadvice(n_Row).紧急标志 := r_Advice.紧急标志;
        If Nvl(r_Advice.紧急标志, 0) = 1 Then
          Vsadvice(n_Row).紧急 := '急';
        Else
          Vsadvice(n_Row).紧急 := Null;
        End If;
        Vsadvice(n_Row).审核状态 := r_Advice.审核状态;
        Vsadvice(n_Row).标本部位 := r_Advice.标本部位;
        Vsadvice(n_Row).检查方法 := r_Advice.检查方法;
        Vsadvice(n_Row).执行标记 := r_Advice.执行标记;
        Vsadvice(n_Row).医嘱内容 := r_Advice.医嘱内容;
        Vsadvice(n_Row).诊疗项目 := r_Advice.诊疗项目;
        Vsadvice(n_Row).医生嘱托 := r_Advice.医生嘱托;
        Vsadvice(n_Row).摘要 := r_Advice.摘要;
        Vsadvice(n_Row).频率 := r_Advice.执行频次;
        Vsadvice(n_Row).病人病区id := r_Advice.病人病区id;
        Vsadvice(n_Row).病人科室id := r_Advice.病人科室id;
        Vsadvice(n_Row).开嘱科室id := r_Advice.开嘱科室id;
        Vsadvice(n_Row).开嘱医生 := r_Advice.开嘱医生;
        Vsadvice(n_Row).计价特性 := r_Advice.计价特性;
        Vsadvice(n_Row).执行性质id := r_Advice.执行性质;
        Vsadvice(n_Row).执行标记 := r_Advice.执行标记;
        Vsadvice(n_Row).执行分类 := r_Advice.执行分类;
        Vsadvice(n_Row).操作类型 := r_Advice.操作类型;
        Vsadvice(n_Row).用药理由 := r_Advice.用药理由;
        Vsadvice(n_Row).会诊医嘱id := r_Advice.会诊医嘱id;
        Vsadvice(n_Row).医嘱状态 := r_Advice.医嘱状态;
        Vsadvice(n_Row).执行科室 := r_Advice.执行科室;
        Vsadvice(n_Row).频率间隔 := r_Advice.频率间隔;
        Vsadvice(n_Row).间隔单位 := r_Advice.间隔单位;
        Vsadvice(n_Row).执行科室id := r_Advice.执行科室id;

        Bln采集方法 := False;
        --采集方式的管码与一并的第一个检验相同
        Vsadvice(n_Row).试管编码 := r_Advice.试管编码;
        If r_Advice.诊疗类别 = 'E' And r_Advice.相关id Is Null Then
          If n_Row - 1 > 0 Then
            If Vsadvice(n_Row - 1).诊疗类别 = 'C' Then
              For J In 0 .. n_Row Loop
                If Vsadvice(n_Row - J - 1).相关id = r_Advice.Id Then
                  Mn_Tmp := n_Row - J - 1; --找到第检验的第一行
                Else
                  Exit;
                End If;
              End Loop;
              Vsadvice(n_Row).试管编码 := Vsadvice(Mn_Tmp).试管编码;
              --采集方法显示附加执行科室为检验项目的执行科室
              Vsadvice(n_Row).附加执行 := Vsadvice(Mn_Tmp).执行科室;
              Vsadvice(n_Row).附加执行科室id := Vsadvice(Mn_Tmp).执行科室id;
              Bln采集方法 := True;
              Vsadvice(n_Row).药品执行类别 := 4;
            End If;
          End If;
        End If;

        --隐藏:附加手术,手术麻醉,检查部位方法,检验项目,输血途径
        If r_Advice.诊疗类别 = 'C' Or r_Advice.诊疗类别 = 'G' Or
           ((r_Advice.诊疗类别 = 'F' Or r_Advice.诊疗类别 = 'D') And r_Advice.相关id Is Not Null) Then
          Vsadvice(n_Row).隐藏行 := 1;
        Elsif r_Advice.相关id Is Not Null And r_Advice.诊疗类别 = 'E' And (r_Advice.操作类型 = '8' Or r_Advice.操作类型 = '9') Then
          --输血途径
          Vsadvice(n_Row).隐藏行 := 1;
          Vsadvice(n_Row).药品执行类别 := 5;
        End If;

        --gbln高值材料流程不能通过医嘱发送，暂时不处理

        --附加项目执行科室显示 麻醉 执行显示到主手术行上
        If r_Advice.诊疗类别 = 'G' And r_Advice.相关id Is Not Null Then
          If n_Row - 1 > 0 Then
            If Vsadvice(n_Row - 1).诊疗类别 = 'F' Then
              For J In 0 .. n_Row Loop
                If Vsadvice(n_Row - J - 1).相关id = r_Advice.Id Then
                  Mn_Tmp := n_Row - J - 1; --找到第一行主手术
                Else
                  Exit;
                End If;
              End Loop;
              Vsadvice(Mn_Tmp).附加执行 := Vsadvice(n_Row).执行科室;
            End If;
          End If;
        End If;

        Vsadvice(n_Row).执行安排 := r_Advice.执行安排;
        Vsadvice(n_Row).病人性质 := r_Advice.病人性质;
        Vsadvice(n_Row).开嘱时间 := r_Advice.开嘱时间;
        Vsadvice(n_Row).开始时间 := To_Char(r_Advice.开始执行时间, 'YYYY-MM-DD HH24:MI:SS');
        Vsadvice(n_Row).开始执行时间 := r_Advice.开始执行时间;
        Vsadvice(n_Row).上次执行时间 := r_Advice.上次执行时间;
        Vsadvice(n_Row).单量 := r_Advice.单次用量;
        Vsadvice(n_Row).首次用量 := r_Advice.首次用量;
        Vsadvice(n_Row).收费细目id := r_Advice.收费细目id;
        Vsadvice(n_Row).是否变价 := r_Advice.是否变价;
        Vsadvice(n_Row).跟踪在用 := r_Advice.跟踪在用;
        Vsadvice(n_Row).执行时间方案 := r_Advice.执行时间方案;
        Vsadvice(n_Row).频率间隔 := r_Advice.频率间隔;
        Vsadvice(n_Row).间隔单位 := r_Advice.间隔单位;
        Vsadvice(n_Row).频率次数 := r_Advice.频率次数;

        --计算发送次数，执行的分解时间，总量
        --长期医嘱
        If Vsadvice(n_Row).医嘱期效 = 0 Then
          If r_Advice.相关id Is Null Then

            Mn_Tmp := f_Calc总量次数时间非药(Vsadvice(n_Row), n_次数, v_分解);

            If Vsadvice(n_Row).执行时间方案 Is Null And (Nvl(Vsadvice(n_Row).频率次数, 0) = 0 Or Nvl(Vsadvice(n_Row).频率间隔, 0) = 0 Or Vsadvice(n_Row)
                                    .间隔单位 Is Null) Then
              --持续长医嘱标记
              Vsadvice(n_Row).频率标记 := 2;
            End If;

            If Nvl(r_Advice.计算规则, 0) = 1 Then
              --取整计算,持续性长嘱无单量
              n_总量 := b_Zlhis_Ciskernel.f_Intex(Nvl(r_Advice.单次用量, 1)) * n_次数;
            Else
              n_总量 := Nvl(r_Advice.单次用量, 1) * n_次数;
            End If;
            If v_分解 Is Null Then
              Vsadvice(n_Row).禁止发送 := 1;
              Vsadvice(n_Row).禁止原因 := r_Advice.医嘱内容 || '  无可以执行的时间点。';
            End If;
            Vsadvice(n_Row).次数 := n_次数;
            Vsadvice(n_Row).分解时间 := v_分解;
            If v_分解 Is Not Null Then
              Vsadvice(n_Row).首次时间 := Substr(v_分解, 1, 16);
              Vsadvice(n_Row).末次时间 := Substr(v_分解, Instr(v_分解, ',', -1) + 1, 16);
            End If;
            If r_Advice.单次用量 Is Not Null Then
              Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
            End If;
            Vsadvice(n_Row).总量 := n_总量;
            Vsadvice(n_Row).总量单位 := r_Advice.计算单位;
               Elsif r_Advice.相关id Is Not Null And r_Advice.诊疗类别 = 'E' And (r_Advice.操作类型 = '8' Or r_Advice.操作类型 = '9') Then
            --输血途径的执行次数
            Vsadvice(n_Row).次数 := Vsadvice(n_Row - 1).次数;
            Vsadvice(n_Row).总量 := Vsadvice(n_Row - 1).总量;
            Vsadvice(n_Row).总量单位 := r_Advice.计算单位;
            Vsadvice(n_Row).分解时间 := Vsadvice(n_Row - 1).分解时间;
            Vsadvice(n_Row).首次时间 := Vsadvice(n_Row - 1).首次时间;
            Vsadvice(n_Row).末次时间 := Vsadvice(n_Row - 1).末次时间;

          Elsif r_Advice.相关id Is Not Null Or Bln采集方法 Then
            --附加医嘱或标本采集方法
            If r_Advice.单次用量 Is Not Null Then
              Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
            End If;
            Vsadvice(n_Row).总量单位 := r_Advice.计算单位;

            Vsadvice(n_Row).次数 := Vsadvice(n_Row - 1).次数;
            Vsadvice(n_Row).总量 := Vsadvice(n_Row - 1).总量;
            Vsadvice(n_Row).总量单位 := r_Advice.计算单位;
            Vsadvice(n_Row).分解时间 := Vsadvice(n_Row - 1).分解时间;
            Vsadvice(n_Row).首次时间 := Vsadvice(n_Row - 1).首次时间;
            Vsadvice(n_Row).末次时间 := Vsadvice(n_Row - 1).末次时间;
          End If;

          --备用医嘱删除范围外的备用医嘱
          If Mn_医嘱处理范围 = 1 Then
            If (Md_备用执行时间 >= r_Advice.执行终止时间 Or Md_备用执行时间 <= r_Advice.上次执行时间) Then
              --备用医嘱删除范围外的备用医嘱
              Vsadvice(n_Row).禁止发送 := 1;
              Vsadvice(n_Row).禁止原因 := r_Advice.医嘱内容 || '  备用医嘱已发送排除。';
            End If;
          End If;
        End If;

        --临时医嘱
        If Vsadvice(n_Row).医嘱期效 = 1 Then
          --主要医嘱或一并采集的检验项目
          If r_Advice.相关id Is Null And Not Bln采集方法 Or r_Advice.相关id Is Not Null And r_Advice.诊疗类别 = 'C' Then
            If r_Advice.诊疗类别 = 'K' Then
              n_总量 := Nvl(r_Advice.总给予量, 0);

              --输血途径的执行次数
              If Vsadvice(n_Row)
               .执行时间方案 Is Null And
                  (Nvl(Vsadvice(n_Row).频率次数, 0) = 0 Or Nvl(Vsadvice(n_Row).频率间隔, 0) = 0 Or Vsadvice(n_Row).间隔单位 Is Null) Then
                n_次数 := 1; --执行频率为"一次性"的项目
              Else
                n_次数 := Nvl(Vsadvice(n_Row).频率次数, 0); --执行频率为"可选频率"的项目
              End If;
            Else
              n_总量 := Nvl(r_Advice.总给予量, 1);
              n_次数 := b_Zlhis_Ciskernel.f_Intex(n_总量 / Nvl(r_Advice.单次用量, 1));
            End If;
            v_分解 := Null;
            If Vsadvice(n_Row).执行时间方案 Is Null And (Nvl(Vsadvice(n_Row).频率次数, 0) = 0 Or Nvl(Vsadvice(n_Row).频率间隔, 0) = 0 Or Vsadvice(n_Row)
                                    .间隔单位 Is Null) Then
              --执行频率为"一次性"的项目,不需要分解时间
              Vsadvice(n_Row).频率标记 := 1;
            Else
              --执行频率为"可选频率"的项目
              If Vsadvice(n_Row).执行时间方案 Is Not Null Or Nvl(Vsadvice(n_Row).间隔单位, '*') = '分钟' Then
                v_分解 := b_Zlhis_Ciskernel.f_Calc次数分解时间(n_次数, r_Advice.开始执行时间, To_Date('3000-01-01', 'yyyy-mm-dd'),
                                                       r_Advice.执行时间方案, r_Advice.频率间隔, r_Advice.间隔单位);

              End If;
            End If;
            --临嘱无执行时间点指定为开始时间
            If v_分解 Is Null Then
              v_分解 := Vsadvice(n_Row).开始时间;
            End If;
            Vsadvice(n_Row).次数 := n_次数;
            Vsadvice(n_Row).分解时间 := v_分解;
            If v_分解 Is Not Null Then
              Vsadvice(n_Row).首次时间 := Substr(v_分解, 1, 16);
              Vsadvice(n_Row).末次时间 := Substr(v_分解, Instr(v_分解, ',', -1) + 1, 16);
            Else
              Vsadvice(n_Row).分解时间 := Vsadvice(n_Row).开始时间;
            End If;
            If r_Advice.单次用量 Is Not Null Then
              Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
            End If;
            Vsadvice(n_Row).总量 := n_总量;
            Vsadvice(n_Row).总量单位 := r_Advice.计算单位;
          Elsif r_Advice.相关id Is Not Null And r_Advice.诊疗类别 = 'E' And (r_Advice.操作类型 = '8' Or r_Advice.操作类型 = '9') Then
            --输血途径的执行次数
            Vsadvice(n_Row).次数 := Vsadvice(n_Row - 1).次数;
            Vsadvice(n_Row).总量 := Vsadvice(n_Row - 1).总量;
            Vsadvice(n_Row).总量单位 := r_Advice.计算单位;
            Vsadvice(n_Row).分解时间 := Vsadvice(n_Row - 1).分解时间;
            Vsadvice(n_Row).首次时间 := Vsadvice(n_Row - 1).首次时间;
            Vsadvice(n_Row).末次时间 := Vsadvice(n_Row - 1).末次时间;

          Elsif r_Advice.相关id Is Not Null Or Bln采集方法 Then
            --附加医嘱或标本采集方法
            If r_Advice.单次用量 Is Not Null Then
              Vsadvice(n_Row).单量单位 := r_Advice.计算单位;
            End If;
            Vsadvice(n_Row).总量单位 := r_Advice.计算单位;

            Vsadvice(n_Row).次数 := Vsadvice(n_Row - 1).次数;
            Vsadvice(n_Row).总量 := Vsadvice(n_Row - 1).总量;
            Vsadvice(n_Row).总量单位 := r_Advice.计算单位;
            Vsadvice(n_Row).分解时间 := Vsadvice(n_Row - 1).分解时间;
            Vsadvice(n_Row).首次时间 := Vsadvice(n_Row - 1).首次时间;
            Vsadvice(n_Row).末次时间 := Vsadvice(n_Row - 1).末次时间;
          End If;
        End If;

        If Vsadvice(n_Row).禁止发送 = 0 Then
          --计算项目的金额，记帐报警暂不处理
          Mn_Tmp := f_Loadadviceprice(n_Row, Row_Dg, n_金额);
          Vsadvice(n_Row).金额 := Round(n_金额, Gn_Dec);
          --相关行时的一些处理：累计显示一组医嘱的金额
          ---------------------------------------------------------------
          If 0 <> Nvl(Vsadvice(n_Row).相关id, 0) And Vsadvice(n_Row).诊疗类别 <> 'C' Then
            For J In 2 .. n_Row Loop
              If Vsadvice(n_Row).相关id = Vsadvice(n_Row - J + 1).Id Then
                Vsadvice(n_Row - J + 1).金额 := Nvl(Vsadvice(n_Row - J + 1).金额, 0) + Nvl(Vsadvice(n_Row).金额, 0);
                Exit;
              End If;
            End Loop;
          End If;

          If Bln采集方法 Then
            For J In 2 .. n_Row Loop
              If Vsadvice(n_Row).Id = Nvl(Vsadvice(n_Row - J + 1).相关id, 0) Then
                Vsadvice(n_Row).金额 := Nvl(Vsadvice(n_Row - J + 1).金额, 0) + Nvl(Vsadvice(n_Row).金额, 0);
              Else
                Exit;
              End If;
            End Loop;
          End If;
        End If;
      End If;
    End Loop;
    Return(1);
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End f_Loadadviceother;

  --判断指定的医嘱费用是否应该产生
  Function f_Advicemoneymake
  (
    病人id_In     In Number,
    主页id_In     In Number,
    医嘱id_In     In Number,
    诊疗项目id_In In Number,
    收费项目id_In In Number,
    执行部门id_In In Number,
    试管编码_In   In Varchar2,
    收费类别_In   In Varchar2,
    收费方式_In   In Number,
    分解时间_In   In Varchar2,
    总量_In       In Number,
    当前医嘱id_In In Number,
    发送号_In     In Number,
    计价数量_In   In Number,
    计算方式_In   In Number,
    频率_In       In Varchar2,
    单量_In       In Number,
    期效_In       In Number,
    费用性质_In   In Number,
    诊疗类别_In   In Varchar2,
    样本条码_In   In Varchar2,
    费用次数_Out  Out Number
  ) Return Number Is

    Type r_Days Is Record(
      收费时间 Varchar2(30),
      存在     Number(1));
    Type t_Days Is Table Of r_Days;
    Rsdays t_Days := t_Days();

    Arrtmp      t_Strlist := t_Strlist();
    n_Rtn       Number;
    n_Tmp       Number;
    b_Makemoney Boolean;
    n_材料id    Number;
    n_Cnt存在   Number;
    v_Tmp       Varchar2(30000);
    v_Tmp1      Varchar2(30000);

    n_数量    Number := 0;
    v_Date    Varchar2(30);
    n_总量tmp Number := 0;
    n_单量tmp Number := 0;
    b_Tmp     Boolean;

    --获取指定病人某天(dat收费时间)之后医嘱产生的费用项目明细，住院病人特有
    --这个游标相当于替代了 f_Getpatidaymoneydetail 函数
    Cursor c_Detail
    (
      F病人id   Number,
      F主页id   Number,
      F收费时间 Date
    ) Is
      Select a.诊疗项目id, a.收费项目id, a.执行部门id, a.收费方式, a.执行否, a.收费时间
      From (Select a.诊疗项目id, a.收费项目id, a.执行部门id, a.收费方式, a.执行否, To_Char(b.要求时间, 'yyyy-mm-dd') As 收费时间
             From (Select b.发送号, a.诊疗项目id, c.收费细目id As 收费项目id, c.执行部门id, Decode(Nvl(c.执行状态, 0), 0, 0, 1) As 执行否,
                           To_Char(b.首次时间, 'yyyy-mm-dd') As 首次时间,
                           Decode(b.首次时间, Null, 1, Trunc(b.末次时间) - Trunc(b.首次时间) + 1) As 天数, 0 As 收费方式,
                           To_Char(b.末次时间, 'yyyy-mm-dd') As 末次时间, a.频率间隔, a.间隔单位, a.医嘱期效, a.Id, Nvl(a.相关id, 0) As 相关id
                    From 病人医嘱记录 A, 病人医嘱发送 B, 住院费用记录 C
                    Where a.病人id = F病人id And a.主页id = F主页id And a.Id = b.医嘱id And b.记录性质 = c.记录性质 And b.No = c.No And
                          b.医嘱id = c.医嘱序号 And c.记录状态 In (0, 1) And b.末次时间 >= F收费时间
                    Union
                    Select b.发送号, a.诊疗项目id, d.收费细目id, d.执行科室id As 执行部门id, 0 As 执行否, To_Char(b.首次时间, 'yyyy-mm-dd') As 首次时间,
                           Decode(a.医嘱期效, 0, Trunc(b.末次时间) - Trunc(b.首次时间) + 1, 1) As 天数, -1 As 收费方式,
                           To_Char(b.末次时间, 'yyyy-mm-dd') As 末次时间, a.频率间隔, a.间隔单位, a.医嘱期效, a.Id, Nvl(a.相关id, 0) As 相关id
                    From 病人医嘱记录 A, 病人医嘱发送 B, 病人医嘱计价 D
                    Where a.病人id = F病人id And a.主页id = F主页id And a.Id = b.医嘱id And b.末次时间 >= F收费时间 And a.Id = d.医嘱id And
                          d.收费方式 = 7 And Not Exists
                     (Select 1
                           From 住院费用记录 C
                           Where c.收费细目id = d.收费细目id And b.记录性质 = c.记录性质 And b.No = c.No And a.Id = c.医嘱序号)) A, 医嘱执行时间 B
             Where a.Id = b.医嘱id And a.发送号 = b.发送号 And b.要求时间 > F收费时间) A
      Group By a.诊疗项目id, a.收费项目id, a.执行部门id, a.收费方式, a.执行否, a.收费时间;

  Begin
    b_Makemoney  := True;
    费用次数_Out := 1;
    n_Rtn        := 1;

    If 收费方式_In = 9 Then
      --自定义
      Null;
    End If;

    If 收费方式_In = 0 Then
      --正常收费的，检查在本次发送中、本医嘱中是否被排斥
      For I In 1 .. Rs_Moneynow.Count Loop
        If Rs_Moneynow(I).医嘱id = 医嘱id_In And Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And
            (Rs_Moneynow(I).收费方式 = 5 Or Rs_Moneynow(I).收费方式 = 6) Then
          b_Makemoney := False;
          Exit;
        End If;
      End Loop;
    Elsif 收费方式_In = 1 Then
      --检验试管费用(一次发送只收取一次)
      If 试管编码_In Is Not Null Then
        For I In 1 .. Rs_Moneynow.Count Loop
          If Rs_Moneynow(I).试管编码 = 试管编码_In And Rs_Moneynow(I).样本条码 = 样本条码_In And Rs_Moneynow(I).收费项目id = 收费项目id_In And
              Nvl(Rs_Moneynow(I).收费方式, 0) <> -1 Then
            b_Makemoney := False;
            Exit;
          End If;
        End Loop;
        --只收取试管对应的卫材费用
        If b_Makemoney And 收费类别_In = '4' Then
          If 试管编码_In Is Not Null Then
            Select Max(材料id) Into n_材料id From 采血管类型 Where 编码 = 试管编码_In;
          End If;
          If Nvl(n_材料id, 0) <> 0 And 收费项目id_In <> Nvl(n_材料id, 0) Then
            b_Makemoney := False;
          End If;
        End If;
      End If;
    Elsif 收费方式_In = 2 Then
      --一次发送只收取一次

      For I In 1 .. Rs_Moneynow.Count Loop
        If Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And Rs_Moneynow(I).收费项目id = 收费项目id_In And Nvl(Rs_Moneynow(I).收费方式, 0) <> -1 Then
          b_Makemoney := False;
          Exit;
        End If;
      End Loop;
    Elsif Instr(',3,4,5,6,7,', 收费方式_In) > 0 Then
      --3-当天只收取一次；4-当天未执行收取一次；5-当天只收取一次，排斥其他项目；6-当天未执行收取一次，排斥其他项目
      --正常收费的，检查在本次发送中、本医嘱中是否被排斥
      If 收费方式_In = 7 Then
        For I In 1 .. Rs_Moneynow.Count Loop
          If Rs_Moneynow(I).医嘱id = 医嘱id_In And Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And
              (Rs_Moneynow(I).收费方式 = 5 Or Rs_Moneynow(I).收费方式 = 6) Then
            b_Makemoney := False;
            Exit;
          End If;
        End Loop;
      End If;

      If b_Makemoney Then
        v_Tmp := 分解时间_In;
        While v_Tmp Is Not Null Loop
          If Instr(',' || v_Tmp1 || ',', ',' || Substr(v_Tmp, 1, 10) || ',') = 0 Then
            v_Tmp1 := v_Tmp1 || ',' || Substr(v_Tmp, 1, 10);
            Rsdays.Extend;
            Rsdays(Rsdays.Count).收费时间 := Substr(v_Tmp, 1, 10);
            Rsdays(Rsdays.Count).存在 := 0;
          End If;
          v_Tmp := Substr(v_Tmp, 21);
        End Loop;

        --先从本次发送中的找(频率为一天一次且没有收的，判断时当成已收取,以便后续的其他医嘱'首次不收'时不再认为有首次)
        For J In 1 .. Rsdays.Count Loop
          For I In 1 .. Rs_Moneynow.Count Loop
            If Rs_Moneynow(I)
             .收费时间 = Rsdays(J).收费时间 And Rs_Moneynow(I).诊疗项目id = 诊疗项目id_In And Rs_Moneynow(I).收费项目id = 收费项目id_In Then

              If 收费方式_In = 7 Then
                Rsdays(J).存在 := 1;
                Exit;
              Elsif (收费方式_In = 4 Or 收费方式_In = 6) And Nvl(执行部门id_In, 0) <> 0 And Rs_Moneynow(I).执行部门id = 执行部门id_In Then
                Rsdays(J).存在 := 1;
                Exit;
              Elsif Nvl(Rs_Moneynow(I).收费方式, 0) <> -1 Then
                Rsdays(J).存在 := 1;
                Exit;
              End If;
            End If;
          End Loop;
        End Loop;

        --再从已发送中的找(当天及将来执行的)
        n_Cnt存在 := 0;
        For J In 1 .. Rsdays.Count Loop
          If Rsdays(J).存在 = 0 Then
            n_Cnt存在 := n_Cnt存在 + 1;
            If Nvl(Mn_Mday, 0) = 0 Then
              Mn_Mday     := 1;
              Rs_Moneyday := t_Moneyday();
              --从已发送的数据中找
              Open c_Detail(病人id_In, 主页id_In, To_Date(Rsdays(J).收费时间, 'YYYY-MM-DD'));
              Fetch c_Detail Bulk Collect
                Into Rs_Moneyday;
              Close c_Detail;
            End If;
            For J In 1 .. Rsdays.Count Loop
              For I In 1 .. Rs_Moneyday.Count Loop
                If Rs_Moneyday(I)
                 .收费时间 = Rsdays(J).收费时间 And Rs_Moneyday(I).诊疗项目id = 诊疗项目id_In And Rs_Moneyday(I).收费项目id = 收费项目id_In Then

                  If 收费方式_In = 7 And Nvl(Rs_Moneyday(I).收费方式, 0) <> -1 Then
                    Rsdays(J).存在 := 1;
                    n_Cnt存在 := n_Cnt存在 - 1;
                    Exit;
                  Elsif (收费方式_In = 4 Or 收费方式_In = 6) And Nvl(执行部门id_In, 0) <> 0 And Nvl(Rs_Moneyday(I).执行否, 0) = 0 And Rs_Moneyday(I)
                       .执行部门id = 执行部门id_In Then
                    Rsdays(J).存在 := 1;
                    n_Cnt存在 := n_Cnt存在 - 1;
                    Exit;
                  Else
                    Rsdays(J).存在 := 1;
                    n_Cnt存在 := n_Cnt存在 - 1;
                    Exit;
                  End If;
                End If;
              End Loop;
            End Loop;
          End If;
        End Loop;
      End If;
    End If;
    --记录到本次发送明细项目记录中
    If Instr(',3,4,5,6,7,', 收费方式_In) > 0 Then
      If 收费方式_In = 7 Then
        If b_Makemoney Then
          --rsDays.Filter = '存在=0' n_Cnt存在 代替   --没收过的那些天(频率为一天一次但未收的当成收过了)，首次不收
          费用次数_Out := 总量_In - n_Cnt存在;
          If 费用次数_Out > 0 Then
            b_Makemoney := True;
          Else
            b_Makemoney := False;
          End If;
        End If;
      Else
        -- rsDays.Filter = '存在=0'
        -- B_makemoney = rsDays.RecordCount > 0
        -- lng费用次数 = rsDays.RecordCount    --一天一次，有多少天要收就有多少次
        费用次数_Out := n_Cnt存在;
        If n_Cnt存在 > 0 Then
          b_Makemoney := True;
        Else
          b_Makemoney := False;
        End If;
        Null;
      End If;
      If b_Makemoney Or 收费方式_In = 7 And 费用次数_Out = 0 Then
        For I In 1 .. Rsdays.Count Loop
          If Rsdays(I).存在 = 0 Then
            Rs_Moneynow.Extend;
            n_Tmp := Rs_Moneynow.Count;
            Rs_Moneynow(n_Tmp).医嘱id := 医嘱id_In;
            Rs_Moneynow(n_Tmp).诊疗项目id := 诊疗项目id_In;
            Rs_Moneynow(n_Tmp).收费项目id := 收费项目id_In;
            Rs_Moneynow(n_Tmp).试管编码 := 试管编码_In;
            Rs_Moneynow(n_Tmp).样本条码 := 样本条码_In;

            --首次不收时，如果频率为一天一次，则计算后的费用次数为0,为了让本次后续发送的其他医嘱正确计算首是否收取，需要产生记录，但收费方式特殊记录为-1
            If 收费方式_In = 7 And 费用次数_Out = 0 Then
              Rs_Moneynow(n_Tmp).收费方式 := -1;
            Else
              Rs_Moneynow(n_Tmp).收费方式 := 收费方式_In;
            End If;
            Rs_Moneynow(n_Tmp).收费时间 := Rsdays(I).收费时间;
            Rs_Moneynow(n_Tmp).执行部门id := 执行部门id_In;
          End If;
        End Loop;
      End If;
    Elsif b_Makemoney Then
      Rs_Moneynow.Extend;
      n_Tmp := Rs_Moneynow.Count;
      Rs_Moneynow(n_Tmp).医嘱id := 医嘱id_In;
      Rs_Moneynow(n_Tmp).诊疗项目id := 诊疗项目id_In;
      Rs_Moneynow(n_Tmp).收费项目id := 收费项目id_In;
      Rs_Moneynow(n_Tmp).试管编码 := 试管编码_In;
      Rs_Moneynow(n_Tmp).样本条码 := 样本条码_In;
      Rs_Moneynow(n_Tmp).收费方式 := 收费方式_In;
      If 分解时间_In Is Not Null Then
        Rs_Moneynow(n_Tmp).收费时间 := Substr(分解时间_In, 1, 10); --yyyy-MM-dd
      Else
        Rs_Moneynow(n_Tmp).收费时间 := Null;
      End If;
      Rs_Moneynow(n_Tmp).执行部门id := 执行部门id_In;
    End If;

    --读取医嘱执行计价(除药品卫材医嘱外的才存储)
    If Instr(',5,6,7,', ',' || 诊疗类别_In || ',') = 0 Then
      If 分解时间_In Is Not Null Then
        -- arrTmp = Split(分解时间_In, ',');
        v_Tmp := 分解时间_In;
        While v_Tmp Is Not Null Loop
          Arrtmp.Extend;
          Arrtmp(Arrtmp.Count) := Substr(v_Tmp, 1, 19);
          v_Tmp := Substr(v_Tmp, 21);
        End Loop;
        n_总量tmp := 总量_In * 计价数量_In;
        n_单量tmp := 单量_In;
        If Nvl(单量_In, 0) = 0 Then
          n_单量tmp := 1;
        End If;
        For I In 1 .. Arrtmp.Count Loop
          Rs_Exec.Extend;
          n_Tmp := Rs_Exec.Count;
          Rs_Exec(n_Tmp).医嘱id := 当前医嘱id_In;
          Rs_Exec(n_Tmp).发送号 := 发送号_In;
          Rs_Exec(n_Tmp).要求时间 := To_Date(Arrtmp(I), 'YYYY-MM-DD HH24:MI:SS');
          Rs_Exec(n_Tmp).收费细目id := 收费项目id_In;
          Rs_Exec(n_Tmp).费用性质 := 费用性质_In;
          If b_Makemoney Then
            --卫材也可以输入单量总量
            If 频率_In Is Not Null And
               ((计算方式_In = 0 Or 计算方式_In = 3) And 总量_In > 0 Or 计算方式_In = 1 Or 计算方式_In = 2 Or 诊疗类别_In = '4') Then
              --计量和计时的需要乘以数次
              If 期效_In = 0 Then
                --1、长嘱可选频率、持续性、必要时和不定时以单量作为数次。
                n_数量 := 计价数量_In * n_单量tmp;
              Else
                --3、临嘱可选频率取单量作为数次，最后一次剩余的数量，例如红外照射治疗，总量80、单量25，每天4次，那么执行登记时，供执行四次，前三次本次数次为25，第四次为80除以25取模=5。
                --门诊有可能没有录入执行时间,分解时间就只有一个，按总量作为次数
                If Arrtmp.Count = 1 Then
                  n_数量 := 计价数量_In * 总量_In;
                Else
                  If I = Arrtmp.Count Then
                    n_数量 := n_总量tmp;
                  Else
                    If n_总量tmp >= n_单量tmp Then
                      n_数量 := 计价数量_In * n_单量tmp;
                    Else
                      n_数量 := n_总量tmp;
                    End If;
                    n_总量tmp := n_总量tmp - n_数量;
                  End If;
                End If;
              End If;
            Else
              n_数量 := 计价数量_In;
            End If;
            If I <> 1 Then
              v_Date := Substr(Arrtmp(I - 1), 1, 10);
            End If;
            --一次发送收取一次，则只有第一次收取
            If Instr(',1,2,', 收费方式_In) > 0 Then
              If I <> 1 Then
                n_数量 := 0;
              End If;
            Elsif Instr(',3,4,5,6,', 收费方式_In) > 0 Then
              --3456当天只收取一次的，存在=0的收取，默认第一次有数量
              b_Tmp := False;
              For J In 1 .. Rsdays.Count Loop
                If Rsdays(J).存在 = 0 And Rsdays(J).收费时间 = Substr(Arrtmp(I), 1, 10) Then
                  b_Tmp := True;
                End If;
              End Loop;
              If Not (b_Tmp And Substr(Arrtmp(I), 1, 10) <> v_Date) Then
                n_数量 := 0;
              End If;
            Elsif 收费方式_In = 7 Then
              --当天首次不收取的，存在=1就收取，存在=0的为首次
              b_Tmp := False;
              For J In 1 .. Rsdays.Count Loop
                If Rsdays(J).存在 = 1 And Rsdays(J).收费时间 = Substr(Arrtmp(I), 1, 10) Then
                  b_Tmp := True;
                End If;
              End Loop;
              If Not b_Tmp And Substr(Arrtmp(I), 1, 10) <> v_Date Then
                n_数量 := 0;
              End If;
            End If;
          Else
            --如果不收取，则设置为0
            n_数量 := 0;
          End If;
          Rs_Exec(n_Tmp).数量 := n_数量;
        End Loop;
      End If;
    End If;
    If b_Makemoney Then
      n_Rtn := 1;
    Else
      n_Rtn := 0;
    End If;
    Return(n_Rtn);
  Exception
    When Others Then
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_Advicemoneymake出错[ZLSOFT]');
  End f_Advicemoneymake;

  --生成真正的NO
  Procedure p_Replacetrueno Is

    Type r_No Is Record(
      No_False Varchar2(200),
      No_True  Varchar2(200));

    Type t_No Is Table Of r_No;
    Rsno t_No := t_No();

    v_Curno Varchar2(200);
    v_No    Varchar2(200);
    I       Number;
    J       Number;
  Begin
    --发送记录
    For I In 1 .. r_发送.Count Loop
      v_Curno := r_发送(I).No;
      v_No    := Null;
      For J In 1 .. Rsno.Count Loop
        If Rsno(J).No_False = v_Curno Then
          v_No := Rsno(J).No_True;
          Exit;
        End If;
      End Loop;
      If v_No Is Null Then
        Select Nextno(14, Null, Null, 1) Into v_No From Dual;
        Rsno.Extend;
        Rsno(Rsno.Count).No_False := v_Curno;
        Rsno(Rsno.Count).No_True := v_No;
      End If;
      r_发送(I).No := v_No;
    End Loop;

    --费用记录
    For I In 1 .. r_费用.Count Loop
      v_Curno := r_费用(I).No;
      v_No    := Null;
      For J In 1 .. Rsno.Count Loop
        If Rsno(J).No_False = v_Curno Then
          v_No := Rsno(J).No_True;
          Exit;
        End If;
      End Loop;
      If v_No Is Null Then
        If Substr(v_Curno, 1, 2) = '13' Then
          Select Nextno(13, Null, Null, 1) Into v_No From Dual;
        Else
          Select Nextno(14, Null, Null, 1) Into v_No From Dual;
        End If;
        Rsno.Extend;
        Rsno(Rsno.Count).No_False := v_Curno;
        Rsno(Rsno.Count).No_True := v_No;
      End If;
      r_费用(I).No := v_No;
    End Loop;

    --发料
    For I In 1 .. r_发料.Count Loop
      v_Curno := r_发料(I).No;
      v_No    := Null;
      For J In 1 .. Rsno.Count Loop
        If Rsno(J).No_False = v_Curno Then
          v_No := Rsno(J).No_True;
          Exit;
        End If;
      End Loop;
      If v_No Is Null Then
        If Substr(v_Curno, 1, 2) = '13' Then
          Select Nextno(13, Null, Null, 1) Into v_No From Dual;
        Else
          Select Nextno(14, Null, Null, 1) Into v_No From Dual;
        End If;
        Rsno.Extend;
        Rsno(Rsno.Count).No_False := v_Curno;
        Rsno(Rsno.Count).No_True := v_No;
      End If;
      r_发料(I).No := v_No;
    End Loop;
  End p_Replacetrueno;

  --获取当前费用单据的NO及序号
  Procedure p_Getcurbillset
  (
    Key_In       In Varchar2,
    费用序号_In  In Number,
    发送序号_In  In Number,
    No_Out       Out Varchar2,
    费用序号_Out Out Number,
    发送序号_Out Out Number
  ) Is
    b_Have Boolean;
    n_Tmp  Number;
  Begin

    b_Have := False;
    For I In 1 .. Rs_Bill.Count Loop
      If Rs_Bill(I).Key = Key_In Then
        n_Tmp  := I;
        b_Have := True;
        Exit;
      End If;
    End Loop;

    If Not b_Have Then
      Rs_Bill.Extend;
      n_Tmp := Rs_Bill.Count;
      Rs_Bill(n_Tmp).Key := Key_In;
      --取单据号
      Mn_Nosequence := Mn_Nosequence + 1;

      Rs_Bill(n_Tmp).No := 'T' || LPad(Mn_Nosequence, 5, '0');
      If 费用序号_In = -1 Then
        Rs_Bill(n_Tmp).费用序号 := 0;
      Else
        Rs_Bill(n_Tmp).费用序号 := 1;
      End If;
      If 发送序号_In = -1 Then
        Rs_Bill(n_Tmp).发送序号 := 0;
      Else
        Rs_Bill(n_Tmp).发送序号 := 1;
      End If;
    Else
      If 费用序号_In <> -1 Then
        Rs_Bill(n_Tmp).费用序号 := Rs_Bill(n_Tmp).费用序号 + 1;
      End If;
      If 发送序号_In <> -1 Then
        Rs_Bill(n_Tmp).发送序号 := Rs_Bill(n_Tmp).发送序号 + 1;
      End If;
    End If;

    No_Out := Rs_Bill(n_Tmp).No;
    If 费用序号_In <> -1 Then
      费用序号_Out := Rs_Bill(n_Tmp).费用序号;
    End If;
    If 发送序号_In <> -1 Then
      发送序号_Out := Rs_Bill(n_Tmp).发送序号;
    End If;
  End p_Getcurbillset;

  --执行过程SQL
  Procedure p_Completepatisend Is
    v_Err_Msg Varchar(2000);
    Err_Item Exception;
    V分解时间 Varchar2(32760);
    Vtmp分解  Varchar2(4000);
  Begin
    If 1 = 1 Then
      p_Replacetrueno;
      For I In 1 .. r_费用.Count Loop
        Zl_住院记帐记录_Insert(r_费用(I).No, r_费用(I).序号, r_费用(I).病人id, r_费用(I).主页id, r_费用(I).标识号, r_费用(I).姓名, r_费用(I).性别,
                         r_费用(I).年龄, r_费用(I).床号, r_费用(I).费别, r_费用(I).病区id, r_费用(I).科室id, r_费用(I).加班标志, r_费用(I).婴儿费,
                         r_费用(I).开单部门id, r_费用(I).开单人, r_费用(I).从属父号, r_费用(I).收费细目id, r_费用(I).收费类别, r_费用(I).计算单位,
                         r_费用(I).保险项目否, r_费用(I).保险大类id, r_费用(I).保险编码, r_费用(I).付数, r_费用(I).数次, r_费用(I).附加标志,
                         r_费用(I).执行部门id, r_费用(I).价格父号, r_费用(I).收入项目id, r_费用(I).收据费目, r_费用(I).标准单价, r_费用(I).应收金额,
                         r_费用(I).实收金额, r_费用(I).统筹金额, r_费用(I).发生时间, r_费用(I).登记时间, r_费用(I).药品摘要, r_费用(I).划价, r_费用(I).操作员编号,
                         r_费用(I).操作员姓名, r_费用(I).多病人单, r_费用(I).类别id, r_费用(I).记帐单id, r_费用(I).费用摘要, r_费用(I).是否急诊,
                         r_费用(I).医嘱序号, r_费用(I).频次, r_费用(I).单量, r_费用(I).用法, r_费用(I).期效, r_费用(I).计价特性, r_费用(I).简单记帐,
                         r_费用(I).费用类型, r_费用(I).医技补临床费用, r_费用(I).领药部门id, r_费用(I).中药形态, r_费用(I).医疗小组id, r_费用(I).备货材料,
                         r_费用(I).批次);

      End Loop;
      For I In 1 .. r_发送.Count Loop
        V分解时间 := r_发送(I).分解时间;
        If Length(V分解时间) < 4000 Then
          Zl_病人医嘱发送_Insert(r_发送(I).医嘱id, r_发送(I).发送号, r_发送(I).记录性质, r_发送(I).No, r_发送(I).记录序号, r_发送(I).发送数次,
                           r_发送(I).首次时间, r_发送(I).末次时间, r_发送(I).发送时间, r_发送(I).执行状态, r_发送(I).执行部门id, r_发送(I).计费状态,
                           r_发送(I).First, r_发送(I).样本条码, r_发送(I).操作员编号, r_发送(I).操作员姓名, r_发送(I).领药号, r_发送(I).门诊记帐, V分解时间,
                           r_发送(I).原液皮试);
        Else
          --将v分解时间 拆成几段
          Vtmp分解 := Substr(V分解时间, 0, 3999);
          Zl_病人医嘱发送_Insert(r_发送(I).医嘱id, r_发送(I).发送号, r_发送(I).记录性质, r_发送(I).No, r_发送(I).记录序号, r_发送(I).发送数次,
                           r_发送(I).首次时间, r_发送(I).末次时间, r_发送(I).发送时间, r_发送(I).执行状态, r_发送(I).执行部门id, r_发送(I).计费状态,
                           r_发送(I).First, r_发送(I).样本条码, r_发送(I).操作员编号, r_发送(I).操作员姓名, r_发送(I).领药号, r_发送(I).门诊记帐, Vtmp分解,
                           r_发送(I).原液皮试);

          V分解时间 := Substr(V分解时间, 4001);
          While V分解时间 Is Not Null Loop
            Vtmp分解  := Substr(V分解时间, 0, 3999);
            V分解时间 := Substr(V分解时间, 4001);
            If Vtmp分解 Is Not Null Then
              Zl_医嘱执行时间_Insert(r_发送(I).医嘱id, r_发送(I).发送号, Vtmp分解);
            End If;
          End Loop;
        End If;
      End Loop;

      For I In 1 .. r_执行计价.Count Loop
        Zl_医嘱执行计价_Insert(r_执行计价(I).医嘱id, r_执行计价(I).发送号, r_执行计价(I).要求时间, r_执行计价(I).收费细目id, r_执行计价(I).数量, r_执行计价(I).费用性质);

      End Loop;
      For I In 1 .. r_发料.Count Loop
        Zl_材料收发记录_处方发料(r_发料(I).Partid, r_发料(I).Bill, r_发料(I).No, r_发料(I).People, r_发料(I).配药人, r_发料(I).校验人, r_发料(I).发药方式,
                       r_发料(I).发药时间);
      End Loop;
    End If;
  Exception
    When Err_Item Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
      Raise_Application_Error(-20101, '[ZLSOFT]执行p_Completepatisend出错[ZLSOFT]');
  End p_Completepatisend;

  --发送医嘱过程
  Function f_Sendadvice Return Number Is
    Type Rs_Rsdays Is Record(
      收费时间 Varchar2(30),
      数量     Number,
      实收金额 Number,
      应收金额 Number,
      Str实收  Varchar2(30),
      发生时间 Date,
      NO       Varchar2(30));

    Type Rs_Rssenddays Is Record(
      医嘱id   Number,
      发送号   Number,
      计算时间 Date,
      首次时间 Date,
      末次时间 Date,
      分解时间 Varchar2(32760),
      发送数次 Number,
      NO       Varchar2(30));

    Type r_Money Is Record(
      ID         Number(18),
      类别       Varchar2(1),
      类别名称   Varchar2(10),
      名称       Varchar2(80),
      计算单位   Varchar2(20),
      收入项目id Number(18),
      收据费目   Varchar2(20),
      住院单位   Varchar2(8),
      住院包装   Number(16, 5),
      剂量系数   Number(16, 5),
      数量       Number,
      单价       Number(16, 7),
      加班加价   Number(1),
      加班加价率 Number(16, 5),
      附术收费率 Number(16, 5),
      是否变价   Number(1),
      分批       Number(1),
      跟踪在用   Number,
      从项       Number,
      执行科室id Number,
      屏蔽费别   Number(1),
      费用确认   Number(1),
      费用性质   Number,
      收费方式   Number,
      要求审批   Number(1));
    Type t_Money Is Table Of r_Money;

    Type t_Rsdays Is Table Of Rs_Rsdays;
    Type t_Rssenddays Is Table Of Rs_Rssenddays;
    Rssenddays t_Rssenddays;
    Rsdays     t_Rsdays;

    r_Send r_医嘱发送_Sql;

    Strsql           Varchar2(4000);
    Str收费项目      Varchar2(4000);
    v_Nokey          Varchar2(4000);
    v_No             Varchar2(4000);
    v_自动发料       Varchar2(4000);
    n_费用序号       Number := 0;
    n_费用父号       Number;
    Strhavesub       Varchar2(5000);
    Strnonesub       Varchar2(5000);
    Int父序号        Number;
    Lng父项目id      Number;
    Int配方数        Number;
    Int药品性质      Number;
    Int付数          Number;
    Dbl数量          Number;
    Dbl单价          Number;
    Cur应收          Number;
    Cur实收          Number;
    Cur合计          Number;
    I                Number;
    Int划价          Number;
    Int领药部门id    Number;
    Lngtmp           Number;
    n_Tmp            Number;
    n_发送序号       Number := 0;
    Lgr              Number;
    Int执行状态      Number;
    b_First          Boolean;
    Bln附加手术      Boolean;
    Strcuvettenumber Varchar2(300);
    D发生时间        Date;
    D登记时间        Date;
    Str领药号        Varchar2(300);
    Rsprice          t_Money;
    Rsclone          t_Money;
    n_费用次数       Number;
    Dblother数量     Number;
    Blntmp           Boolean;
    n_病人id         Number;
    Blnbreak         Boolean;

    Cursor c_药品计价
    (
      C药品id Number,
      C科室id Number,
      C险类   Number
    ) Is
      Select a.Id, a.类别, d.名称 As 类别名称, a.名称, a.计算单位, b.收入项目id, c.收据费目, y.住院单位, y.住院包装, y.剂量系数, 1 As 数量, b.现价 As 单价,
             a.加班加价, b.加班加价率, b.附术收费率, a.是否变价, y.药房分批 As 分批, 0 As 跟踪在用, 0 As 从项, C科室id As 执行科室id, a.屏蔽费别, a.费用确认,
             0 As 费用性质, 0 As 收费方式, i.要求审批
      From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费项目类别 D, 药品规格 Y, 保险支付项目 I
      Where a.Id = b.收费细目id And b.收入项目id = c.Id And a.类别 = d.编码 And b.价格等级 Is Null And a.Id = y.药品id(+) And
            a.Id = C药品id And a.Id = i.收费细目id(+) And i.险类(+) = C险类 And
            ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null))
      Order By a.编码;

    Cursor c_非药计价
    (
      C医嘱id Number,
      C科室id Number,
      C险类   Number
    ) Is
      Select a.Id, a.类别, d.名称 As 类别名称, a.名称, a.计算单位, b.收入项目id, c.收据费目, y.住院单位, y.住院包装, y.剂量系数, x.数量,
             Decode(a.是否变价, 1, x.单价, b.现价) As 单价, a.加班加价, b.加班加价率, b.附术收费率, a.是否变价,
             Decode(a.类别, '4', e.在用分批, y.药房分批) As 分批, e.跟踪在用, x.从项, x.执行科室id, a.屏蔽费别, a.费用确认, x.费用性质, x.收费方式, i.要求审批
      From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费项目类别 D, 材料特性 E,
           (Select a.医嘱id, a.收费细目id, Nvl(a.执行科室id, C科室id) As 执行科室id, a.数量, a.单价, a.从项, a.费用性质, a.收费方式
             From 病人医嘱计价 A
             Where a.医嘱id = C医嘱id) X, 药品规格 Y, 保险支付项目 I
      Where a.Id = b.收费细目id And b.收入项目id = c.Id And a.Id = e.材料id(+) And b.价格等级 Is Null And a.类别 = d.编码 And
            x.收费细目id = a.Id And a.Id = y.药品id(+) And
            ((Sysdate Between b.执行日期 And b.终止日期) Or (Sysdate >= b.执行日期 And b.终止日期 Is Null)) And a.Id = i.收费细目id(+) And
            i.险类(+) = C险类
      Order By x.费用性质, x.从项, x.收费方式 Desc, a.Id;
  Begin
    --更改医嘱的执行科室,暂不处理
    --发送时可以修改计价项目，暂不处理
    --修改计价项目执行科室，附加执行科室，暂不处理
    --调用血库接口，暂不处理
    --调用检验接口，暂不处理
    Mn_Nosequence := 0; --单据号序列重新初始
    Mv_领药号     := Null;
    Int配方数     := 1;
    Rs_Bill       := t_Bill();
    Rs_Exec       := t_Exec();
    r_发送        := t_医嘱发送_Sql();
    r_执行计价    := t_执行计价_Sql();
    Rs_Moneynow   := t_Moneynow();
    Rs_Moneyday   := t_Moneyday();
    Mn_Mday       := 0;
    r_费用        := t_住院记帐_Sql();
    r_发料        := t_处方发料_Sql();
    Rsdays        := t_Rsdays();
    Rssenddays    := t_Rssenddays();
    n_病人id      := 0;
    Rs_Number     := t_Number();

    r_Send.发送号 := Nextno(10, Null, Null, 1);
    Select Sysdate Into r_Send.发送时间 From Dual;
    Mn_发送号 := r_Send.发送号;
    For I In 1 .. Vsadvice.Count Loop
      If Vsadvice(I).选择 = 1 And Nvl(Vsadvice(I).禁止发送, 0) = 0 Then
        If n_病人id <> Vsadvice(I).病人id Then

          If n_病人id <> 0 Then
            ----提交前一个病人的数据
            --医嘱执行计价
            For J In 1 .. Rs_Exec.Count Loop
              r_执行计价.Extend;
              n_Tmp := r_执行计价.Count;
              r_执行计价(n_Tmp).医嘱id := Rs_Exec(J).医嘱id;
              r_执行计价(n_Tmp).发送号 := Rs_Exec(J).发送号;
              r_执行计价(n_Tmp).要求时间 := Rs_Exec(J).要求时间;
              r_执行计价(n_Tmp).收费细目id := Rs_Exec(J).收费细目id;
              r_执行计价(n_Tmp).数量 := Rs_Exec(J).数量;
              r_执行计价(n_Tmp).费用性质 := 0;
            End Loop;
            p_Completepatisend;
            ----中间缓存数据全部清空一次
            Rs_Bill     := t_Bill();
            Rs_Exec     := t_Exec();
            r_发送      := t_医嘱发送_Sql();
            r_执行计价  := t_执行计价_Sql();
            Rs_Moneynow := t_Moneynow();
            Rs_Moneyday := t_Moneyday();
            Mn_Mday     := 0;
            r_费用      := t_住院记帐_Sql();
            r_发料      := t_处方发料_Sql();
            Rsdays      := t_Rsdays();
            Rssenddays  := t_Rssenddays();
            Rs_Number   := t_Number();
          End If;
          n_病人id := Vsadvice(I).病人id;
        End If;
        --产生医嘱记帐费用:以最新价格计算
        -----------------------------------------------------------------------------------------
        Strsql      := Null;
        Str收费项目 := Null;
        If Instr(',5,6,7,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
          --药品缺省固定为正常计价,但下医嘱时指定了为自备药(院外执行)的不读取;药品不可能为叮嘱，院外药房功能暂不支持
          If Nvl(Vsadvice(I).执行性质id, 0) <> 5 Then
            Strsql := '药品行';
          End If;
        Else
          --不计价,手工计价；叮嘱,院外执行的医嘱不读取
          If Nvl(Vsadvice(I).计价特性, 0) = 0 And Instr(',0,5,', Vsadvice(I).执行性质id) = 0 Then
            --通过病人医嘱计价表进行获取计价数据，执行科室id 字段可能需要获取新的值
            Strsql := '非药品行';
            --通过医嘱下达的卫材医嘱都是跟踪在用的，可按药品规则处理
            If Vsadvice(I).诊疗类别 = '4' Then
              Strsql := '药品行';
            End If;
          End If;
        End If;

        Int父序号   := 0;
        Lng父项目id := 0;
        Strhavesub  := Null;
        Strnonesub  := Null;

        --提前生成样本条码(参数"医嘱发送生成条形码"没有启用时也产生一个虚拟的条码，用于判断是否收采血管费用)
        Strcuvettenumber := Null;
        If Nvl(Vsadvice(I).执行性质id, 0) = 0 Then
          Strcuvettenumber := f_Getcuvettenumber(Vsadvice(I).试管编码, Vsadvice(I).Id, Vsadvice(I).相关id, Vsadvice(I).诊疗类别,
                                                 Vsadvice(I).操作类型, Vsadvice(I).执行科室id, Vsadvice(I).婴儿序号,
                                                 Vsadvice(I).诊疗项目id, Vsadvice(I).紧急标志, Vsadvice(I).标本部位,
                                                 Vsadvice(I).附加执行科室id); --采集行的执行科室id
        End If;
        If Nvl(Vsadvice(I).计价特性, 0) = 1 Then
          r_Send.计费状态 := -1;
        Else
          r_Send.计费状态 := 0;
        End If;

        --产生单据号分配关键字
        -----------------------------------------------------------------------------------------
        If Instr(',5,6,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
          --启用参数：特殊药品分开发送 时，特殊药品医嘱的药品行单独生成单据号，一组医嘱分配一个号，
          --特殊药分开发送暂不处理
          --中西成药按"病人(病人ID,主页ID)_病人科室ID_开嘱科室ID_开嘱医生_执行科室ID"分号。
          --一并给药的，发送到一起：包括自备药和不同药房的情况
          v_Nokey := '中西成药_' || Vsadvice(I).病人id || '_' || Vsadvice(I).主页id || '_' || Vsadvice(I).医嘱期效 || '_' || Vsadvice(I)
                    .病人科室id || '_' || Vsadvice(I).开嘱科室id || '_' || Vsadvice(I).开嘱医生 || '_' || f_Getmergedrugstore(I);
          --按要打印的诊疗单据分号
          Select Max(病历文件id)
          Into Mn_Tmp
          From 病历单据应用
          Where 诊疗项目id = Vsadvice(I).诊疗项目id And 应用场合 = 2;
          v_Nokey := v_Nokey || '_' || Nvl(Mn_Tmp, 0);
          --给药执行科室不相同，则分配不同的NO号
          For J In I + 1 .. Vsadvice.Count Loop
            If Vsadvice(J).相关id Is Null Then
              v_Nokey := v_Nokey || '_' || Nvl(Vsadvice(J).执行科室id, 0);
              Exit;
            End If;
          End Loop;
        Elsif Vsadvice(I).诊疗类别 = '7' Then
          --一个配方中的所有草药分配一个独立单据号
          v_Nokey := '中药配方_' || Vsadvice(I).病人id || '_' || Vsadvice(I).主页id || '_' || Vsadvice(I).医嘱期效 || '_' || Int配方数;
        Elsif Instr(',4,M,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
          --材料按"病人(病人ID,主页ID)_病人科室ID_开嘱科室ID_开嘱医生_执行科室ID"分号。
          v_Nokey := '材料医嘱_' || Vsadvice(I).病人id || '_' || Vsadvice(I).主页id || '_' || Vsadvice(I).医嘱期效 || '_' || Vsadvice(I)
                    .病人科室id || '_' || Vsadvice(I).开嘱科室id || '_' || Vsadvice(I).开嘱医生 || '_' ||
                     Nvl(Vsadvice(I).执行科室id, 0);
          --再按要打印的诊疗单据分号
          Select Max(病历文件id)
          Into Mn_Tmp
          From 病历单据应用
          Where 诊疗项目id = Vsadvice(I).诊疗项目id And 应用场合 = 2;
          v_Nokey := v_Nokey || '_' || Nvl(Mn_Tmp, 0);
        Elsif Vsadvice(I).诊疗类别 = 'D' And Mbln检查单独产生单据 Then
          --检查按"病人(病人ID,主页ID)_病人科室ID_开嘱科室ID_开嘱医生_执行科室ID"分号。
          v_Nokey := '非药医嘱_' || Vsadvice(I).病人id || '_' || Vsadvice(I).主页id || '_' || Vsadvice(I).医嘱期效 || '_' || Vsadvice(I)
                    .病人科室id || '_' || Vsadvice(I).开嘱科室id || '_' || Vsadvice(I).开嘱医生 || '_' ||
                     Nvl(Vsadvice(I).执行科室id, 0);
        Elsif Nvl(Vsadvice(I).相关id, 0) <> 0 And Vsadvice(I).诊疗类别 = 'C' Then
          --一并采集的检验组合分配相同的单据号，标本采集方法分配单独的单据号
          --同一个类检验型，同一个检验执行科室，同一采集管，同一个采集方式，同一个采集执行科室的检验分配相同的单据号
          If Mbln检验单独产生单据 Then
            v_Nokey := '一并采集_' || Vsadvice(I).相关id;
          Else
            v_Nokey := '一并采集_' || Vsadvice(I).病人id || '_' || Vsadvice(I).主页id || '_' || Vsadvice(I).标本部位 || '_' ||
                       Nvl(Vsadvice(I).执行科室id, 0) || '_' || Vsadvice(I).操作类型 || '_' || Vsadvice(I).试管编码;
            Mn_Tmp  := -1;
            --查找主医嘱项目的执行科室和项目id
            For J In I + 1 .. Vsadvice.Count Loop
              If Vsadvice(I).相关id = Vsadvice(J).Id Then
                Mn_Tmp := J;
              Else
                Exit;
              End If;
            End Loop;
            if Mn_Tmp<>-1
              then
            v_Nokey := v_Nokey || '_' || Vsadvice(Mn_Tmp).诊疗项目id || '_' || Vsadvice(Mn_Tmp).执行科室id;
            end if;
          End If;
        Elsif Nvl(Vsadvice(I).相关id, 0) <> 0 And Instr(',F,D,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
          --检查部位和附加手术与主要医嘱分配相同单据号，手术麻醉分配单独的单据号。
          v_Nokey := '非药医嘱_' || Nvl(Vsadvice(I).相关id, 0);
        Else
          --其它非药医嘱每条医嘱一个独立单据号(包括给药途径，配方煎法、用法，采集方式，麻醉方式，输血医嘱/输血途径)
          v_Nokey := '非药医嘱_' || Vsadvice(I).Id;
        End If;

        --不同的给药方式分开产生单据号，参数：按给药方式产生单据号 参数：按给药方式产生单据号
        If Nvl(Vsadvice(I).药品执行类别, 0) = 1 And Mblndruguse Then
          v_Nokey := v_Nokey || '_' || Vsadvice(I).给药途径项目id;
        End If;

        --分解时间
        r_Send.分解时间 := Vsadvice(I).分解时间;

        --检查类项目按部位方法自定义收费，暂时不处理

        --产生记帐费用
        ------------------------------------------------------
        If Strsql Is Not Null Then
          Int药品性质 := 0;
          If Instr(',5,6,7,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
            If Vsadvice(I).执行性质 = '离院带药' Then
              Int药品性质 := 3;
            Elsif Vsadvice(I).执行性质 = '自取药' Then
              Int药品性质 := 4;
            Else
              Int药品性质 := 0;
            End If;
          End If;
          If Strsql = '药品行' Then
            Open c_药品计价(Nvl(Vsadvice(I).收费细目id, 0), Nvl(Vsadvice(I).执行科室id, 0), Nvl(Vsadvice(I).险类, 0));
            Fetch c_药品计价 Bulk Collect
              Into Rsprice;
            Close c_药品计价;
          Else
            Open c_非药计价(Vsadvice(I).Id, Nvl(Vsadvice(I).执行科室id, 0), Nvl(Vsadvice(I).险类, 0));
            Fetch c_非药计价 Bulk Collect
              Into Rsprice;
            Close c_非药计价;
          End If;
          Mn_Tmp := Rsprice.Count;
          If Rsprice.Count > 0 Then
            r_Send.计费状态 := 1;
            --直接产生一份新的考贝可独立使用
            Rsclone := Rsprice;
          End If;
          --处理收入项目级的费用明细；暂不处理
          For J In 1 .. Rsprice.Count Loop
            Blnbreak := True;
            --执行科室id
            r_Send.执行部门id := Nvl(Rsprice(J).执行科室id, 0);
            --在原值基础上取有效的非药嘱药品及跟踪卫材的执行科室。暂不处理
            ----------------------------------------
            ----------------------------------------
            --根据收费方式，确定当前收费项目是否应收费
            If Rsprice(J).费用性质 || '_' || Rsprice(J).Id <> Nvl(Str收费项目, 'NULL') Then

              Mn_Tmp := f_Advicemoneymake(Vsadvice(I).病人id, Vsadvice(I).主页id, Vsadvice(I).Id, Vsadvice(I).诊疗项目id,
                                          Rsprice(J).Id, Nvl(Rsprice(J).执行科室id, 0), Vsadvice(I).试管编码, Rsprice(J).类别,
                                          Rsprice(J).收费方式, Vsadvice(I).分解时间, Vsadvice(I).总量, Vsadvice(I).Id, r_Send.发送号,
                                          Rsprice(J).数量, Vsadvice(I).计算方式, Vsadvice(I).频率, Vsadvice(I).单量, 0, 2,
                                          Vsadvice(I).诊疗类别, Strcuvettenumber, n_费用次数);

              If Mn_Tmp = 0 Then
                --跳过当前收费项目(多个收入项目)
                Str收费项目 := Rsprice(J).费用性质 || '_' || Rsprice(J).Id;
                Blnbreak    := False;
              End If;
            End If;
            If Blnbreak Then
              ----------------------------------------
              ----------------------------------------
              --检查是否需要和已经审批，暂时不处理

              --计算，付数，总量，单价
              Int付数 := 1; --中草医嘱付数有处理
              Dbl单价 := Nvl(Rsprice(J).单价, 0); --如果是变价该值会更新
              Dbl数量 := Nvl(Vsadvice(I).总量, 0) * Nvl(Rsprice(J).数量, 0); --药品和特殊收费方式会有变化
              If Instr(',5,6,7,', ',' || Rsprice(J).类别 || ',') > 0 Or
                 (Rsprice(J).类别 = '4' And Nvl(Rsprice(J).跟踪在用, 0) = 1) Then
                If Instr(',5,6,7,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
                  If Vsadvice(I).诊疗类别 = '7' Then
                    Int付数 := Nvl(Vsadvice(I).总量, 0);

                    --中药药房单位按不可分零处理:每付
                    If Nvl(Vsadvice(I).可否分零, 0) = 0 Then

                      Dbl数量 := Vsadvice(I).单量 / Nvl(Rsprice(J).剂量系数, 1);
                    Else
                      Dbl数量 := b_Zlhis_Ciskernel.f_Intex(Vsadvice(I)
                                                         .单量 / Nvl(Rsprice(J).剂量系数, 1) / Nvl(Rsprice(J).住院包装, 1)) *
                               Nvl(Rsprice(J).住院包装, 1);
                    End If;
                    --针对药品单位换算除不尽的进行取整，只有长嘱才会出现 VB代码才有的情况，暂不处理
                  Else
                    Dbl数量 := Nvl(Vsadvice(I).总量, 0) * Nvl(Rsprice(J).住院包装, 1);
                    --Get原液皮试 进行减总量计算，源液皮试问题，暂不处理
                  End If;
                Else
                  --特殊收费方式的影响
                  --Dblother数量 自定义收费方式时， 值应该通过  f_Advicemoneymake 方法计算后返回，这里可以暂不处理，
                  If Instr(',1,2,3,4,5,6,7,9,', Nvl(Rsprice(J).收费方式, 0)) > 0 Then
                    If Nvl(Dblother数量, 0) > 0 Then
                      Dbl数量 := Dblother数量;
                    Else
                      Dbl数量 := Nvl(n_费用次数, 0) * Nvl(Rsprice(J).数量, 0);
                    End If;
                  End If;
                End If;
                --如果是变价，计算时价项目的单价，重新计算对Dbl单价 赋值，
                If Nvl(Rsprice(J).是否变价, 0) = 1 Then
                  Dbl单价 := b_Zlhis_Ciskernel.f_Calcdrugprice(Rsprice(J).Id, Nvl(Rsprice(J).执行科室id, 0), Int付数 * Dbl数量,
                                                             Null, Gn_Dec, Null);

                End If;
              End If;

              --非药嘱药品及跟踪卫材的库存检查，暂时不处理
              --这个地方一定要处理，目前暂时未想到好的解决方式
              --办法：在这里遍历后面的所有医嘱和计价，然后将不足的拼接到出参里面然后个错让外面来接收这个错误信息
              If Nvl(Rsprice(J).类别, '*') = '4' And Nvl(Rsprice(J).跟踪在用, 0) = 1 Or
                 Instr(',5,6,7', Rsprice(J).类别) > 0 And Instr(',5,6,7', Vsadvice(I).诊疗类别) = 0 Then
                Null;
                --对xml_out赋值
                --return -1;
              End If;

              --发送金额
              Cur应收 := Round(Int付数 * Dbl数量 * Dbl单价, Gn_Dec);

              --附加手术，暂时不处理
              If Vsadvice(I).诊疗类别 = 'F' And Nvl(Vsadvice(I).相关id, 0) <> 0 Then
                Bln附加手术 := True;
                Cur应收     := Cur应收 * Nvl(Rsprice(J).附术收费率, 100) / 100;
              Else
                Bln附加手术 := False;
              End If;

              --处理加班加价
              If Gb_加班加价 And Nvl(Rsprice(J).加班加价, 0) = 1 Then
                Cur应收 := Cur应收 * (1 + Nvl(Rsprice(J).加班加价率, 0) / 100);
              End If;

              --NO,序号---------------------------------------------------------------------
              p_Getcurbillset(v_Nokey, n_费用序号, -1, v_No, n_费用序号, Mn_Tmp);

              If Rsprice(J).费用性质 || '_' || Rsprice(J).Id <> Nvl(Str收费项目, 'NULL') Then
                n_费用父号 := n_费用序号;
                If Nvl(Rsprice(J).从项, 0) = 0 Then
                  --记录主项信息，主项肯定在从项前
                  --即使不汇总折扣，也要记录主从项关系  Null;
                  If Instr(Strhavesub || ',', ',' || Rsprice(J).费用性质 || ',') = 0 And
                     Instr(Strnonesub || ',', ',' || Rsprice(J).费用性质 || ',') = 0 Then
                    Blntmp := False;
                    For K In 1 .. Rsclone.Count Loop
                      If Rsprice(K).费用性质 = Rsprice(J).费用性质 And Nvl(Rsprice(K).从项, 0) = 1 Then
                        Null;
                        Int父序号   := n_费用序号;
                        Lng父项目id := Rsprice(J).Id;
                        Blntmp      := True;
                        Exit;
                      End If;
                    End Loop;
                    If Blntmp Then
                      Strhavesub := Strhavesub || ',' || Rsprice(J).费用性质;
                    Else
                      Strnonesub := Strnonesub || ',' || Rsprice(J).费用性质;
                    End If;
                  End If;
                End If;
              End If;

              Cur实收 := Cur应收;

              --cur实收的影响有下3点
              --1.从项折扣计算，暂不处理

              --2.计算汇总折扣合计，暂不处理，累计医嘱合计来计算折扣

              --3.费别打折相关，屏蔽费别
              If Nvl(Rsprice(J).屏蔽费别, 0) = 0 Then
                If Gb_加班加价 And Nvl(Rsprice(J).加班加价, 0) = 1 Then
                  Mn_Tmp := (1 + Nvl(Rsprice(J).加班加价率, 0) / 100);
                Else
                  Mn_Tmp := 0;
                End If;
                Cur实收 := b_Zlhis_Ciskernel.f_Actualmoney(Vsadvice(I).费别, Rsprice(J).收入项目id, Cur应收, Rsprice(J).Id,
                                                         Nvl(Rsprice(J).执行科室id, 0), Int付数 * Dbl数量, Mn_Tmp, Mv_Tmp,
                                                         Vsadvice(I).Id);
              End If;

              --医保相关字段暂不处理
              --收集记帐报警类别，不收集，暂不处理
              --收集记帐报警类别，汇总一个合计金额，目前暂时未用到起
              Cur合计 := Nvl(Cur合计, 0) + Nvl(Cur实收, 0);

              --是否是计帐划价单
              --mint住院领药部门特殊指定
              Int划价       := 0;
              Int领药部门id := Mn_病区id;
              If Instr(',5,6,7,', ',' || Vsadvice(I).诊疗类别 || ',') > 0 Then
                If Instr(',' || Gstr住院发送划价单, '5') > 0 Then
                  Int划价 := 1;
                End If;
                If Nvl(Mint住院领药部门, 0) = 0 Then
                  If Nvl(Vsadvice(I).附加执行科室id, 0) <> 0 Then
                    Int领药部门id := Vsadvice(I).附加执行科室id;
                  End If;
                End If;
              Else
                If Instr(',' || Gstr住院发送划价单, Vsadvice(I).诊疗类别) > 0 Then
                  Int划价 := 1;
                End If;
              End If;
              If Int划价 = 0 Then
                If Nvl(Rsprice(J).费用确认, 0) = 1 Then
                  Int划价 := 1;
                End If;
              End If;

              --发生时间，离院带药特殊要求
              If Int药品性质 = 3 Then
                D发生时间 := r_Send.发送时间; --当前时间sysdate
              Else
                D发生时间 := To_Date(b_Zlhis_Ciskernel.f_Stranal(r_Send.分解时间, 2), 'YYYY-MM-DD HH24:MI:SS');
              End If;

              --登记时间
              If Int划价 = 1 Then
                --与非划价的时间上区分开
                D登记时间 := r_Send.发送时间 + 1 / 24 / 60 / 60;
              Else
                D登记时间 := r_Send.发送时间;
              End If;
              --长嘱非药按天拆分费用，暂时不处理
              --长嘱膳食、输氧、治疗、特殊治疗可拆分，发送时自动拆分，暂不处理
              If Rsdays.Count = 0 Then
                Rsdays.Extend;
                Lngtmp := Rsdays.Count;
                Rsdays(Lngtmp).数量 := Dbl数量;
                Rsdays(Lngtmp).实收金额 := Cur实收;
                --汇总折扣时，对主项的实收金额作特殊处理，暂不处理
                Rsdays(Lngtmp).应收金额 := Cur应收;
                Rsdays(Lngtmp).发生时间 := D发生时间;
                Rsdays(Lngtmp).No := v_No;
              Elsif Rsdays.Count = 1 Then
                Lngtmp := 1;
                Rsdays(Lngtmp).数量 := Dbl数量;
                Rsdays(Lngtmp).实收金额 := Cur实收;
                --汇总折扣时，对主项的实收金额作特殊处理，暂不处理
                Rsdays(Lngtmp).应收金额 := Cur应收;
                Rsdays(Lngtmp).发生时间 := D发生时间;
                Rsdays(Lngtmp).No := v_No;
              End If;

              --因为现在不计价的医嘱不产生费用,所以传入的计价特性都为(0-正常计价)
              For Lngtmp In 1 .. Rsdays.Count Loop
                --收集医保上传单据号:mrsBill中的不一定产生了费用，暂不处理
                r_费用.Extend;
                Lgr := r_费用.Count;
                r_费用(Lgr).No := Rsdays(Lngtmp).No;
                r_费用(Lgr).序号 := n_费用序号;
                r_费用(Lgr).病人id := Vsadvice(I).病人id;
                r_费用(Lgr).主页id := Vsadvice(I).主页id;
                r_费用(Lgr).标识号 := Vsadvice(I).住院号;
                r_费用(Lgr).姓名 := Vsadvice(I).姓名;
                r_费用(Lgr).性别 := Vsadvice(I).性别;
                r_费用(Lgr).年龄 := Vsadvice(I).年龄;
                r_费用(Lgr).床号 := Vsadvice(I).床号;
                r_费用(Lgr).费别 := Vsadvice(I).费别;
                r_费用(Lgr).病区id := Vsadvice(I).病人病区id;
                r_费用(Lgr).科室id := Vsadvice(I).病人科室id;
                r_费用(Lgr).加班标志 := 0;
                r_费用(Lgr).婴儿费 := Vsadvice(I).婴儿序号;
                r_费用(Lgr).开单部门id := Vsadvice(I).开嘱科室id;
                r_费用(Lgr).开单人 := Vsadvice(I).开嘱医生;
                If Nvl(Rsprice(J).从项, 0) = 1 And Nvl(Int父序号, 0) <> 0 Then
                  r_费用(Lgr).从属父号 := Int父序号;
                Else
                  r_费用(Lgr).从属父号 := Null;
                End If;
                r_费用(Lgr).收费细目id := Rsprice(J).Id;
                r_费用(Lgr).收费类别 := Rsprice(J).类别;
                r_费用(Lgr).计算单位 := Rsprice(J).计算单位;
                --保险相关暂不处理
                r_费用(Lgr).保险项目否 := 0; --医保接口相关
                -- r_费用(Lgr).保险大类id := null;
                -- r_费用(Lgr).保险编码 := null;
                r_费用(Lgr).付数 := Int付数;
                r_费用(Lgr).数次 := Rsdays(Lngtmp).数量;
                If Bln附加手术 Then
                  r_费用(Lgr).附加标志 := 1;
                Else
                  r_费用(Lgr).附加标志 := 0;
                End If;
                r_费用(Lgr).执行部门id := r_Send.执行部门id;
                --r_费用(Lgr).价格父号 := null;--IIF(lng费用父号 = lng费用序号, "NULL", lng费用父号) 暂不处理
                r_费用(Lgr).收入项目id := Rsprice(J).收入项目id;
                r_费用(Lgr).收据费目 := Rsprice(J).收据费目;
                r_费用(Lgr).标准单价 := Dbl单价;
                r_费用(Lgr).应收金额 := Rsdays(Lngtmp).应收金额;
                r_费用(Lgr).实收金额 := Rsdays(Lngtmp).实收金额;
                r_费用(Lgr).统筹金额 := 0; --医保接口相关
                r_费用(Lgr).发生时间 := Rsdays(Lngtmp).发生时间;
                r_费用(Lgr).登记时间 := D登记时间;
                r_费用(Lgr).药品摘要 := '医嘱发送';
                r_费用(Lgr).划价 := Int划价;
                r_费用(Lgr).操作员编号 := Mv_操作员编号;
                r_费用(Lgr).操作员姓名 := Mv_操作员姓名;
                r_费用(Lgr).多病人单 := 0;

                If Rsprice(J).类别 = '4' Then
                  r_费用(Lgr).类别id := Mlng卫材类别id;
                Else
                  r_费用(Lgr).类别id := Mlng药品类别id;
                End If;
                r_费用(Lgr).记帐单id := Null;
                r_费用(Lgr).费用摘要 := Vsadvice(I).医嘱内容;
                r_费用(Lgr).是否急诊 := Null;
                r_费用(Lgr).医嘱序号 := Vsadvice(I).Id;
                r_费用(Lgr).频次 := Vsadvice(I).频率;
                r_费用(Lgr).单量 := Vsadvice(I).单量;
                r_费用(Lgr).用法 := Vsadvice(I).用法;
                r_费用(Lgr).期效 := Vsadvice(I).医嘱期效;

                If Nvl(Int药品性质, 0) <> 0 Then
                  r_费用(Lgr).计价特性 := Int药品性质;
                Else
                  r_费用(Lgr).计价特性 := Vsadvice(I).计价特性;
                End If;
                r_费用(Lgr).简单记帐 := Null;
                r_费用(Lgr).费用类型 := Null; --来源于医保，赋值为空
                r_费用(Lgr).医技补临床费用 := Null;
                r_费用(Lgr).领药部门id := Int领药部门id;
                r_费用(Lgr).中药形态 := Null;
                r_费用(Lgr).医疗小组id := -1;
                r_费用(Lgr).备货材料 := 0;
                r_费用(Lgr).批次 := Zl_To_Number(Nvl(Vsadvice(I).检查方法, 0));
                If r_费用(Lgr).批次 = 0 Then
                  r_费用(Lgr).批次 := Null;
                End If;

                --记录自动发料的SQL
                If (Gbyt住院自动发料 = 1 Or Gbyt住院自动发料 = 2 And Nvl(r_Send.执行部门id, 0) = Vsadvice(I).开嘱科室id) And Int划价 = 0 And
                   Nvl(r_Send.执行部门id, 0) <> 0 And Rsprice(J).类别 = '4' And Nvl(Rsprice(J).跟踪在用, 0) = 1 Then
                  If Instr(v_自动发料 || ';', ';' || v_No || ',' || r_Send.执行部门id || ';') = 0 Then
                    r_发料.Extend;
                    n_Tmp := r_发料.Count;
                    r_发料(n_Tmp).Partid := r_Send.执行部门id;
                    r_发料(n_Tmp).Bill := 25;
                    r_发料(n_Tmp).No := v_No;
                    r_发料(n_Tmp).People := Mv_操作员姓名;
                    r_发料(n_Tmp).配药人 := Mv_操作员姓名;
                    r_发料(n_Tmp).校验人 := Mv_操作员姓名;
                    r_发料(n_Tmp).发药方式 := 1;
                    r_发料(n_Tmp).发药时间 := Sysdate;
                    v_自动发料 := v_自动发料 || ';' || v_No || ',' || r_Send.执行部门id;
                  End If;
                End If;
                --(忽略)医保管控实时监测：生成费用项目记录集,以收费细目汇总
                Null;
              End Loop;
            End If;
          End Loop;

        End If;

        --对医嘱金额进行汇总折扣处理暂不处理
        --产生医嘱发送记录
        -----------------------------------------------------------------------------------------
        If Nvl(Vsadvice(I).执行性质id, 0) <> 0 Then
          --叮嘱不发送(给药途径，配方煎法、用法、采集方法可能为)
          p_Getcurbillset(v_Nokey, -1, n_发送序号, v_No, Mn_Tmp, n_发送序号);
          --是否一组医嘱的第一医嘱行:药疗的第一药品行为第一医嘱行
          b_First := False;
          If Instr(',5,6,7,', Vsadvice(I).诊疗类别) > 0 Then
            If Nvl(Vsadvice(I).相关id, 0) <> Nvl(Vsadvice(I - 1).相关id, 0) Then
              b_First := True;
            End If;
          Elsif Vsadvice(I).诊疗类别 = 'C' And Nvl(Vsadvice(I).相关id, 0) <> 0 Then
            If Nvl(Vsadvice(I).相关id, 0) <> Nvl(Vsadvice(I - 1).相关id, 0) Then
              b_First := True; --检验组合中的第一检验行
            End If;
          Elsif Instr(',1,2,3,4,5,', ',' || Vsadvice(I).药品执行类别 || ',') = 0 Then
            --排开给药途径、中药煎法、中药用法、采集方法、输血途径
            If Nvl(Vsadvice(I).相关id, 0) = 0 Then
              b_First := True;
            End If;
          End If;

          --本科执行的自动执行：特殊医嘱不自动完成
          Int执行状态 := 0;
          If b_Zlhis_Ciskernel.f_Canautoexeitem(Vsadvice(I).医嘱期效, Vsadvice(I).诊疗类别, Vsadvice(I).操作类型, Vsadvice(I).执行分类,
                                                Vsadvice(I).执行科室id, Vsadvice(I).病人科室id, Vsadvice(I).病人病区id, Gbln血库系统) Then
            Int执行状态 := 1;
          End If;

          r_Send.执行部门id := Vsadvice(I).执行科室id;

          --发送数次:药品为剂量单位的总量,其它为次数
          If Vsadvice(I).诊疗类别 = '7' Then
            r_Send.发送数次 := Vsadvice(I).总量 * Vsadvice(I).单量;
          Elsif Instr(',5,6,', Vsadvice(I).诊疗类别) > 0 Then
            r_Send.发送数次 := Vsadvice(I).总量 * Vsadvice(I).住院包装 * Vsadvice(I).剂量系数;
          Else
            r_Send.发送数次 := Vsadvice(I).总量;
          End If;

          --每次发送生成一个新的领药号
          Str领药号 := Null;
          If Gbyt领药号 = 1 And Instr(',5,6,7,', Vsadvice(I).诊疗类别) > 0 Then
            If Mv_领药号 Is Null Then
              Mv_领药号 := Nextno(122, Mn_病区id, Null, 1);
            End If;
            Str领药号 := Mv_领药号;
          End If;

          --普通发送页面都不产生配药记录
          --检验条码生成
          If Not Gbln发送生成条形码 Then
            Strcuvettenumber := Null;
          End If;

          --首末次时间
          r_Send.首次时间 := To_Date(Vsadvice(I).首次时间, 'YYYY-MM-DD HH24:MI:SS');
          r_Send.末次时间 := To_Date(Vsadvice(I).末次时间, 'YYYY-MM-DD HH24:MI:SS');

          --长嘱非药按天拆分发送记录,结构预置，方便后续处理，暂不处理
          If Rssenddays.Count = 0 Then
            Rssenddays.Extend;
            n_Tmp := Rssenddays.Count;
            Rssenddays(n_Tmp).医嘱id := Vsadvice(I).Id;
            Rssenddays(n_Tmp).发送号 := r_Send.发送号;
            Rssenddays(n_Tmp).No := v_No;
            Rssenddays(n_Tmp).首次时间 := r_Send.首次时间;
            Rssenddays(n_Tmp).末次时间 := r_Send.末次时间;
            Rssenddays(n_Tmp).分解时间 := r_Send.分解时间;
            Rssenddays(n_Tmp).发送数次 := r_Send.发送数次;
            Vsadvice(I).发送号 := r_Send.发送号;
          Elsif Rssenddays.Count = 1 Then
            n_Tmp := 1;
            Rssenddays(n_Tmp).医嘱id := Vsadvice(I).Id;
            Rssenddays(n_Tmp).发送号 := r_Send.发送号;
            Rssenddays(n_Tmp).No := v_No;
            Rssenddays(n_Tmp).首次时间 := r_Send.首次时间;
            Rssenddays(n_Tmp).末次时间 := r_Send.末次时间;
            Rssenddays(n_Tmp).分解时间 := r_Send.分解时间;
            Rssenddays(n_Tmp).发送数次 := r_Send.发送数次;
            Vsadvice(I).发送号 := r_Send.发送号;
          End If;

          --处理分解时间超过4000字符的问题,暂不处理
          For J In 1 .. Rssenddays.Count Loop
            r_发送.Extend;
            n_Tmp := r_发送.Count;
            r_发送(n_Tmp).医嘱id := Rssenddays(J).医嘱id;
            r_发送(n_Tmp).发送号 := Rssenddays(J).发送号;
            r_发送(n_Tmp).记录性质 := 2;
            r_发送(n_Tmp).No := Rssenddays(J).No;
            r_发送(n_Tmp).记录序号 := n_发送序号;
            r_发送(n_Tmp).发送数次 := Rssenddays(J).发送数次;
            r_发送(n_Tmp).首次时间 := Rssenddays(J).首次时间;
            r_发送(n_Tmp).末次时间 := Rssenddays(J).末次时间;
            r_发送(n_Tmp).发送时间 := r_Send.发送时间;
            r_发送(n_Tmp).执行状态 := Int执行状态;
            r_发送(n_Tmp).执行部门id := r_Send.执行部门id;
            r_发送(n_Tmp).计费状态 := r_Send.计费状态;
            If b_First Then
              r_发送(n_Tmp).First := 1;
            Else
              r_发送(n_Tmp).First := 0;
            End If;
            r_发送(n_Tmp).样本条码 := Strcuvettenumber;
            r_发送(n_Tmp).操作员编号 := Mv_操作员编号;
            r_发送(n_Tmp).操作员姓名 := Mv_操作员姓名;
            r_发送(n_Tmp).领药号 := Str领药号;
            --r_发送(n_Tmp).门诊记帐 := null;--门诊留观病人，暂不处理
            r_发送(n_Tmp).分解时间 := r_Send.分解时间;
            --r_发送(n_Tmp).原液皮试 := null;--阳性用药说明，暂不处理
          End Loop;
        End If;
        --计算中药配方数
        If Nvl(Vsadvice(I).药品执行类别, 0) = 3 Then
          Int配方数 := Int配方数 + 1;
        End If;
      End If;

    End Loop;
    --医嘱执行计价
    For J In 1 .. Rs_Exec.Count Loop
      r_执行计价.Extend;
      n_Tmp := r_执行计价.Count;
      r_执行计价(n_Tmp).医嘱id := Rs_Exec(J).医嘱id;
      r_执行计价(n_Tmp).发送号 := Rs_Exec(J).发送号;
      r_执行计价(n_Tmp).要求时间 := Rs_Exec(J).要求时间;
      r_执行计价(n_Tmp).收费细目id := Rs_Exec(J).收费细目id;
      r_执行计价(n_Tmp).数量 := Rs_Exec(J).数量;
      r_执行计价(n_Tmp).费用性质 := 0;
    End Loop;
    If n_病人id <> 0 Then
      p_Completepatisend;
    End If;
    Return 0;
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
      Raise_Application_Error(-20101, '[ZLSOFT]执行f_SendAdvice出错[ZLSOFT]');
  End f_Sendadvice;

  --对一些参数赋值和入参解析
  Procedure p_初始化 Is
    Vct    Varchar2(4000);
    v_Temp Varchar2(4000);
  Begin
    Select Nvl(Max(参数值), 2) Into Gbyt药品名称显示 From zlParameters Where 参数名 = '药品名称显示';
    Select Nvl(Max(参数值), 0) Into Gbyt住院自动发料 From zlParameters Where 参数名 = '住院卫材自动发料';
    --Select Nvl(Max(参数值), 0) Into Gbyt领药号 From zlParameters Where 参数名 = '住院药嘱发送产生领药号';
    Gbyt领药号 := 1; --固定都产生领药号不判断参数
    Select Nvl(Max(参数值), 0) Into Vct From zlParameters Where 参数名 = '医嘱发送生成条形码';
    Gbln发送生成条形码 := (Vct = '1');
    Select Max(参数值) Into Gstr住院发送划价单 From zlParameters Where 参数名 = '住院发送为划价单诊疗类别';
    Select Nvl(Max(参数值), 0) Into Mint住院领药部门 From zlParameters Where 参数名 = '住院领药部门';
    Mbln检查单独产生单据 := Zl_To_Number(zl_GetSysParameter('检查医嘱产生一个单据', 1254)) = 1;
    Mbln检验单独产生单据 := Zl_To_Number(zl_GetSysParameter('检验医嘱单独产生单据', 1254)) = 1;
    Mblnlimit            := Zl_To_Number(zl_GetSysParameter('药嘱发送限制结束时间', 1254)) = 1;
    Mblndruguse          := Zl_To_Number(zl_GetSysParameter('按给药方式产生单据号', 1254)) = 1;
    Mstrendpoint:=zl_GetSysParameter('长嘱口服药发送结束时间', 1254);
    If Substr(Mstrendpoint, 1, 1) = '1' Then
      Mstrendpoint := Substr(Mstrendpoint, 3);
    else
      Mstrendpoint:=null;
    End If;

    Select f_List2str(Cast(Collect(To_Char(部门id)) As t_Strlist)) As 部门ids
    Into Gstr输液配置中心
    From 部门性质说明
    Where 工作性质 = '配制中心'
    Order By 部门id;
    Gstr输液配置中心 := ',' || Gstr输液配置中心 || ',';

    If Zl_To_Number(Nvl(zl_GetSysParameter(236), '0')) = 1 Then
      Select Count(1) Into Mn_Tmp From zlSystems Where 编号 = 2200;
    End If;
    Gbln血库系统    := Nvl(Mn_Tmp, 0) = 1;
    Gb_从项汇总折扣 := False;
    --金额小数位数
    Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')), Zl_To_Number(Nvl(zl_GetSysParameter(157), '5'))
    Into Gn_Dec, Gn_Decprice
    From Dual;
    Mlng卫材类别id := 0;
    Mlng药品类别id := 0;
    For R In (Select 类别id, 单据 From 药品单据性质 Where 单据 In (41, 9) And Nvl(类别id, 0) <> 0) Loop
      If r.单据 = 41 Then
        Mlng卫材类别id := r.类别id;
      End If;
      If r.单据 = 9 Then
        Mlng药品类别id := r.类别id;
      End If;
    End Loop;

    --传入参数
    For X In (Select b.前置条件, b.医嘱数据, b.病人信息, b.药房, b.医嘱ids
              From Xmltable('$a/IN' Passing Xml_In As "a" Columns 前置条件 Xmltype Path 'QZTJ', 医嘱数据 Xmltype Path 'YZSJ',
                             医嘱ids Xmltype Path 'QZTJ/XYZIDS', 病人信息 Xmltype Path 'QZTJ/BRXX', 药房 Xmltype Path 'QZTJ/ZHYF') B) Loop
      Mx_前置条件 := x.前置条件;
      Mx_医嘱数据 := x.医嘱数据;
      Mx_病人     := x.病人信息;
      Mx_药房     := x.药房;
      Mx_Yzids    := x.医嘱ids;
    End Loop;

    For R In (Select Extractvalue(Value(A), 'QZTJ/JZRQ') As 发送截止日期, Extractvalue(Value(A), 'QZTJ/GNCZ') As 功能,
                     Extractvalue(Value(A), 'QZTJ/ZD') As 站点, Extractvalue(Value(A), 'QZTJ/BQID') As 病区id,
                     Extractvalue(Value(A), 'QZTJ/YZCLFW') As 医嘱处理范围, Extractvalue(Value(A), 'QZTJ/BYZXSJ') As 备用执行时间,
                     Extractvalue(Value(A), 'QZTJ/FSYZZT') As 医嘱状态, Extractvalue(Value(A), 'QZTJ/YPDTFS') As 从当天发,
                     Extractvalue(Value(A), 'QZTJ/JBJJ') As 加班加价, Extractvalue(Value(A), 'QZTJ/CZYBH') As 操作编号,
                     Extractvalue(Value(A), 'QZTJ/CZYXM') As 操作员姓名, Extractvalue(Value(A), 'QZTJ/YZFL') As 药嘱分类,
                     Extractvalue(Value(A), 'QZTJ/QYYFZH') As 药房置换, Extractvalue(Value(A), 'QZTJ/YZIDS') As 医嘱ids,
                     Extractvalue(Value(A), 'QZTJ/GYTJ') As 给药项目ids, Extractvalue(Value(A), 'QZTJ/BRYZFW') As 病人医嘱范围,
                     Extractvalue(Value(A), 'QZTJ/FYYFID') As 发药药房id, Extractvalue(Value(A), 'QZTJ/ZXKSID') As 执行科室id,
                     Extractvalue(Value(A), 'QZTJ/ZLLB') As 诊疗类别, Extractvalue(Value(A), 'QZTJ/YPCZ') As 药品长嘱,
                     Extractvalue(Value(A), 'QZTJ/YPLZ') As 药品临嘱, Extractvalue(Value(A), 'QZTJ/FYCZ') As 非药长嘱,
                     Extractvalue(Value(A), 'QZTJ/FYLZ') As 非药临嘱
              From Table(Xmlsequence(Extract(Mx_前置条件, 'QZTJ'))) A) Loop
      Null;
      Mn_功能                    := Nvl(r.功能, 0);
      Mn_药品长嘱                := Nvl(r.药品长嘱, 0); --0-不显示药品长嘱，1-要显示药品长嘱
      Mn_药品临嘱                := Nvl(r.药品临嘱, 0); --0-不显示药品临嘱，1-要显示药品临嘱
      Mn_非药长嘱                := Nvl(r.非药长嘱, 0); --0-不显示非药品长嘱，1-要显示非药品长嘱
      Mn_非药临嘱                := Nvl(r.非药临嘱, 0); --0-不显示非药品临嘱，1-要显示非药品临嘱
      Mbln药品长嘱从当天开始发送 := Nvl(r.从当天发, '0') = '1'; --从当天开始发送
      Mv_截止日期                := Nvl(r.发送截止日期, '');
      Md_截止日期                := To_Date(Mv_截止日期, 'YYYY-MM-DD HH24:MI:SS'); --医嘱发送截止日期
      Mv_站点                    := Nvl(r.站点, '-');
      Mn_病区id                  := Nvl(r.病区id, 0);
      Mn_医嘱处理范围            := Nvl(r.医嘱处理范围, 0); --0常规医嘱，1=备用医嘱
      Mv_备用执行时间            := Nvl(r.备用执行时间, '');
      Md_备用执行时间            := To_Date(Mv_备用执行时间, 'yyyy-mm-dd hh24:mi');
      Gb_加班加价                := Nvl(r.加班加价, '0') = '1';
      Mv_操作员编号              := Nvl(r.操作编号, '');
      Mv_操作员姓名              := Nvl(r.操作员姓名, '');
      Mn_药房置换                := Nvl(r.药房置换, 0);
      Mv_给药项目ids             := Nvl(r.给药项目ids, '');
      Mn_病人范围                := Nvl(r.病人医嘱范围, 0);
      Mn_发药药房id              := Nvl(r.发药药房id, 0);
      Mn_执行科室id              := Nvl(r.执行科室id, 0);
      Mv_诊疗类别                := Nvl(r.诊疗类别, '');
    End Loop;

    If Mv_操作员编号 Is Null Or Mv_操作员姓名 Is Null Then
      v_Temp := Zl_Identity(1);
      If Not (Nvl(v_Temp, '0') = '0' Or Nvl(v_Temp, '_') = '_') Then
        v_Temp        := Substr(v_Temp, Instr(v_Temp, ';') + 1);
        v_Temp        := Substr(v_Temp, Instr(v_Temp, ',') + 1);
        Mv_操作员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
        v_Temp        := Substr(v_Temp, Instr(v_Temp, ',') + 1);
        Mv_操作员姓名 := v_Temp;
      End If;
    End If;

    --下标从1开始的
    Vsadvice := t_Advice();
    Vsadvice.Extend; --扩展一个空行
    Rs_Price := t_Price();
  End p_初始化;

  Procedure p_Interface(P功能 Number) Is
    v_Tmp  Clob;
    x_Tmp  Xmltype;
    x_计价 Xmltype;
    Blndo  Boolean;
  Begin
    If P功能 = 1 Then
      Xml_Out := Xmltype('<OUT></OUT>');
      --返回医嘱信息
      x_Tmp := Xmltype('<ADVICES></ADVICES>');
      For I In 2 .. Vsadvice.Count Loop
        --隐藏行和禁止发送行不返回
        If Nvl(Vsadvice(I).隐藏行, 0) = 0 And Nvl(Vsadvice(I).禁止发送, 0) = 0 Then
          Blndo := True;
        Else
          Blndo := False;
        End If;
        If Blndo Then
          v_Tmp := '<ITEM>
            <BABY>' || Vsadvice(I).婴儿 || '</BABY>
            <DEPT>' || Vsadvice(I).科室 || '</DEPT>
            <NAME>' || Vsadvice(I).姓名 || '</NAME>
            <INNO>' || Vsadvice(I).住院号 || '</INNO>
            <BEDNO>' || Vsadvice(I).床号 || '</BEDNO>
            <QX>' || Vsadvice(I).期效 || '</QX>
            <BRID>' || Vsadvice(I).病人id || '</BRID>
             <ZID>' || Vsadvice(I).组id || '</ZID>
            <FEET>' || Vsadvice(I).费别 || '</FEET>
            <YPZXLB>' || Vsadvice(I).药品执行类别 || '</YPZXLB>
            <YZZT>' || Vsadvice(I).医嘱状态 || '</YZZT>
            <ZLLB>' || Vsadvice(I).诊疗类别 || '</ZLLB>
            <YZQX>' || Vsadvice(I).医嘱期效 || '</YZQX>
            <XH>' || Vsadvice(I).序号 || '</XH>
            <ZYID>' || Vsadvice(I).主页id || '</ZYID>
            <JJYZ>' || Vsadvice(I).紧急 || '</JJYZ>
            <YLFKFS>' || Vsadvice(I).医疗付款方式 || '</YLFKFS>
            <YZNR>' || Vsadvice(I).医嘱内容 || '</YZNR>
            <ZL>' || Vsadvice(I).总量 || '</ZL>
            <ZLDW>' || Vsadvice(I).总量单位 || '</ZLDW>
            <DL>' || Vsadvice(I).单量 || '</DL>
            <DLDW>' || Vsadvice(I).单量单位 || '</DLDW>
            <JE>' || Vsadvice(I).金额 || '</JE>
            <PL>' || Vsadvice(I).频率 || '</PL>
            <YF>' || Vsadvice(I).用法 || '</YF>
            <DLFL>' || Vsadvice(I).毒理分类 || '</DLFL>
            <YSZT>' || Vsadvice(I).医生嘱托 || '</YSZT>
            <ZXSJFA>' || Vsadvice(I).执行时间方案 || '</ZXSJFA>
            <ZXKS>' || Vsadvice(I).执行科室 || '</ZXKS>
            <FJZX>' || Vsadvice(I).附加执行 || '</FJZX>
            <KC>' || Vsadvice(I).库存 || '</KC>
            <ZXXZ>' || Vsadvice(I).执行性质 || '</ZXXZ>
            <CZLX>' || Vsadvice(I).操作类型 || '</CZLX>
            <YZID>' || Vsadvice(I).Id || '</YZID>
            <KZKSID>' || Vsadvice(I).开嘱科室id || '</KZKSID>
            <BRKSID>' || Vsadvice(I).病人科室id || '</BRKSID>
            <XGID>' || Vsadvice(I).相关id || '</XGID>
            <ZXBMID>' || Vsadvice(I).执行科室id || '</ZXBMID>
            <SCZXSJ>' || to_char(Vsadvice(I).上次执行时间,'yyyy-MM-dd hh24:mi:ss') || '</SCZXSJ>
            </ITEM>';
          Select Appendchildxml(x_Tmp, '/ADVICES', Xmltype(v_Tmp)) Into x_Tmp From Dual;
        End If;
      End Loop;
      --添加医嘱数据
      Mx_医嘱数据 := Xmltype('<YZSJ></YZSJ>');
      Select Appendchildxml(Mx_医嘱数据, '/YZSJ', x_Tmp) Into Mx_医嘱数据 From Dual;
      Select Appendchildxml(Xml_Out, '/OUT', Mx_医嘱数据) Into Xml_Out From Dual;

      If 1 = 1 Then
        --返回计价信息
        x_Tmp := Xmltype('<PRICES></PRICES>');
        For I In 1 .. Rs_Price.Count Loop
          v_Tmp :=  '<ITEM>
              <ZID>' || Rs_Price(I).组id || '</ZID>
              <YZID>' || Rs_Price(I).医嘱id || '</YZID>
              <XGID>' || Rs_Price(I).相关id || '</XGID>
              <FYXZ>' || Rs_Price(I).费用性质 || '</FYXZ>
              <SFFS>' || Rs_Price(I).收费方式 || '</SFFS>
              <SFLB>' || Rs_Price(I).收费类别 || '</SFLB>
              <SFXMID>' || Rs_Price(I).收费细目id || '</SFXMID>
              <ZXKSID>' || Rs_Price(I).执行科室id || '</ZXKSID>
              <SL>' || Rs_Price(I).数量 || '</SL>
              <ZL>' || Rs_Price(I).总量 || '</ZL>
              <DJ>' || Rs_Price(I).单价 || '</DJ>
              <ZY>' || Rs_Price(I).在用 || '</ZY>
              <BJ>' || Rs_Price(I).变价 || '</BJ>
              <CX>' || Rs_Price(I).从项 || '</CX>
              <GD>' || Rs_Price(I).固定 || '</GD>
              </ITEM>';
          Select Appendchildxml(x_Tmp, '/PRICES', Xmltype(v_Tmp)) Into x_Tmp From Dual;
        End Loop;
        x_计价 := Xmltype('<JJSJ></JJSJ>');
        Select Appendchildxml(x_计价, '/JJSJ', x_Tmp) Into x_计价 From Dual;
        Select Appendchildxml(Xml_Out, '/OUT', x_计价) Into Xml_Out From Dual;
      End If;
    End If;
  End p_Interface;

  --------------------------------------------------------------------------------------------------------------
  ----正试代码--------------------------------------------------------------------------------------------------
Begin

  p_初始化;
  --提取医嘱
  If Mn_功能 = 1 Then
    For X In (Select b.病人id, b.主页id
              From Xmltable('$a/BRXX/ITEM' Passing Mx_病人 As "a" Columns 病人id Number(18) Path 'BRID',
                             主页id Number(18) Path 'ZYID') B) Loop
      Mn_病人id := x.病人id;
      Mn_主页id := x.主页id;
      Mn_Tmp    := f_Loadadvicedrug;
      Mn_Tmp    := f_Loadadviceother;
    End Loop;
    p_Interface(1);
  End If;

  If Mn_功能 = 2 Then
    For X In (Select b.病人id, b.主页id
              From Xmltable('$a/BRXX/ITEM' Passing Mx_病人 As "a" Columns 病人id Number(18) Path 'BRID',
                             主页id Number(18) Path 'ZYID') B) Loop
      Mn_病人id := x.病人id;
      Mn_主页id := x.主页id;
      Mn_Tmp    := f_Loadadvicedrug;
      Mn_Tmp    := f_Loadadviceother;
    End Loop;
    Mn_Tmp  := f_Sendadvice;
    Xml_Out := Xmltype('<OUT><FSH>' || Mn_发送号 || '</FSH><LYH>' || Mv_领药号 || '</LYH></OUT>');
  End If;

  --功能3，内部调试用的
  If Mn_功能 = 3 Then
    For X In (Select b.病人id, b.主页id
              From Xmltable('$a/BRXX/ITEM' Passing Mx_病人 As "a" Columns 病人id Number(18) Path 'BRID',
                             主页id Number(18) Path 'ZYID') B) Loop
      Mn_病人id := x.病人id;
      Mn_主页id := x.主页id;
      Mn_Tmp    := f_Loadadvicedrug;
      Mn_Tmp    := f_Loadadviceother;
    End Loop;
    Mn_Tmp := f_Sendadvice;
  End If;
Exception
  When Others Then
    Mv_Tmp  := '<OUTPUT><ERROR><MSG>错误信息：' || SQLErrM || '</MSG></ERROR></OUTPUT>';
    Xml_Out := Xmltype(Mv_Tmp);
    zl_ErrorCenter(SQLCode, SQLErrM);
  End f_Advicesendin;
End b_Zlhis_Ciskernel;
/
Create Or Replace Procedure Zl_Third_Boundcard
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) As
  ---------------------------------------------------------------------------
  --功能:绑卡操作
  --入参：Xml_In
  --  <IN>                                                   是否必传
  --    <KLBID>卡类别ID/KLBID>     //卡类别ID                   1
  --    <JZKH>就诊卡号</JZKH>      //就诊卡号                   1
  --    <XM>姓名</XM>              //病人姓名                   1
  --    <XB>性别</XB>              //病人性别.国标代码          1
  --    <CSRQ>出生日期</CSRQ>      //病人出生日期               0
  --    <DZ>地址</DZ>              //病人地址                   0
  --    <ZJLX>证件类型</ZJLX>      //证件类型.编码              0
  --    <ZJHM>证件号码</ZJHM>      //证件号码                   0
  --    <SFZH>身份证号</SFZH>      //病人身份证号               1 
  --    <SJH>手机号</SJH>          //病人手机号                 0  
  --    <CZYXM>操作员姓名</CZYXM>  //操作员姓名                 0
  --    <CZYID>操作员ID</CZYID>    //操作员ID                   0
  --    <CZSJ>操作时间</CZSJ>      //操作时间                   0
  --  </IN>
  --出参：Xml_Out
  --  <OUTPUT>
  --     <YDM>应答码</YDM>          //应答码：0-失败；1-成功
  --    <ERROR>                     //失败时返回该节点
  --      <MSG>错误信息</MSG>       
  --    </ERROR>
  --  </OUTPUT>
  ---------------------------------------------------------------------------
  v_就诊卡号     病人信息.就诊卡号%Type;
  v_病人姓名     病人信息.姓名%Type;
  v_病人姓名_Old 病人信息.姓名%Type;
  n_病人性别     Number(2);
  v_病人性别     病人信息.性别%Type;
  v_病人年龄     病人信息.年龄%Type;
  d_出生日期     Date;
  v_证件类型     证件类型.编码%Type;
  v_证件号码     病人医疗卡信息.卡号%Type;
  v_证件名称     证件类型.名称%Type;
  v_身份证号     病人信息.身份证号%Type;
  v_手机号       病人信息.手机号%Type;
  v_地址         病人信息.家庭地址%Type;
  v_操作员姓名   Varchar2(20);
  n_操作员id     人员表.Id%Type;
  v_操作员编号   人员表.编号%Type;
  d_操作时间     Date;
  n_卡类别id     医疗卡类别.Id%Type;
  v_费别         病人信息.费别%Type;
  v_医疗付款方式 病人信息.医疗付款方式%Type;
  n_病人id       病人信息.病人id%Type;
  n_门诊号       病人信息.门诊号%Type;
  n_自动门诊号   Number(2);
  n_Count        Number(2);
  v_Temp         Varchar2(3000);
Begin
  --解析入参
  --    <KLBID>卡类别ID/KLBID>     //卡类别ID
  --    <JZKH>就诊卡号</JZKH>      //就诊卡号
  --    <XM>姓名</XM>              //病人姓名
  --    <XB>性别</XB>              //病人性别.国标代码
  --    <CSRQ>出生日期</CSRQ>      //病人出生日期
  --    <DZ>地址</DZ>              //病人地址
  --    <ZJLX>证件类型</ZJLX>      //证件类型.编码 
  --    <ZJHM>证件号码</ZJHM>      //证件号码
  --    <SFZH>身份证号</SFZH>      //病人身份证号
  --    <SJH>手机号</SJH>          //病人手机号
  --    <CZYXM>操作员姓名</CZYXM>  //操作员姓名
  --    <CZYID>操作员ID</CZYID>    //操作员ID
  --    <CZSJ>操作时间</CZSJ>      //操作时间

  Select Extractvalue(Value(A), 'IN/KLBID'), Extractvalue(Value(A), 'IN/JZKH'), Extractvalue(Value(A), 'IN/XM'),
         To_Number(Extractvalue(Value(A), 'IN/XB')), Extractvalue(Value(A), 'IN/DZ'),
         To_Date(Extractvalue(Value(A), 'IN/CSRQ'), 'yyyy-mm-dd hh24:mi:ss'), Extractvalue(Value(A), 'IN/ZJLX'),
         Extractvalue(Value(A), 'IN/ZJHM'), Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/SJH'),
         Extractvalue(Value(A), 'IN/CZYXM'), Extractvalue(Value(A), 'IN/CZYID'),
         To_Date(Extractvalue(Value(A), 'IN/CZSJ'), 'yyyy-mm-dd hh24:mi:ss')
  Into n_卡类别id, v_就诊卡号, v_病人姓名, n_病人性别, v_地址, d_出生日期, v_证件类型, v_证件号码, v_身份证号, v_手机号, v_操作员姓名, n_操作员id, d_操作时间
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If d_操作时间 Is Null Then
    d_操作时间 := Sysdate;
  End If;

  If Nvl(n_卡类别id, 0) = 0 Or Nvl(v_就诊卡号, '-') = '-' Then
    v_Temp  := '<YDM>0</YDM>';
    v_Temp  := v_Temp || '<ERROR><MSG>' || '失败，未传入就诊卡类别或就诊卡号，无法进行绑卡操作' || '</MSG></ERROR>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
    Return;
  End If;

  If v_病人姓名 Is Null Or n_病人性别 Is Null Then
    v_Temp  := '<YDM>0</YDM>';
    v_Temp  := v_Temp || '<ERROR><MSG>' || '失败，未传入病人姓名或性别，无法确定病人' || '</MSG></ERROR>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
    Return;
  End If;

  If v_身份证号 Is Null Then
    v_Temp  := '<YDM>0</YDM>';
    v_Temp  := v_Temp || '<ERROR><MSG>' || '失败，未传入身份证号，无法确定病人' || '</MSG></ERROR>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
    Return;
  End If;

  --检查卡号是否被他人使用
  Select Count(1)
  Into n_Count
  From 病人医疗卡信息 A
  Where a.卡类别id = n_卡类别id And a.卡号 = v_就诊卡号 And a.病人id <> n_病人id;
  If n_Count <> 0 Then
    v_Temp  := '<YDM>0</YDM>';
    v_Temp  := v_Temp || '<ERROR><MSG>' || v_证件名称 || ':' || v_证件号码 || '正在被他人使用,请检查！' || '</MSG></ERROR>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
    Return;
  End If;

  If n_操作员id Is Null Then
    Select 人员id Into n_操作员id From 上机人员表 Where 用户名 = User;
  End If;

  If v_操作员姓名 Is Null Then
    Select Max(姓名) Into v_操作员姓名 From 人员表 Where ID = n_操作员id;
  End If;

  Select Max(名称) Into v_病人性别 From 性别 Where 国标代码 = n_病人性别;
  Select Max(编号) Into v_操作员编号 From 人员表 Where ID = n_操作员id;

  n_Count := 0;
  Begin
    If Nvl(v_身份证号, '-') <> '-' Then
      Select Max(a.病人id), Max(姓名), Count(1)
      Into n_病人id, v_病人姓名_Old, n_Count
      From 病人信息 A, 性别 B
      Where a.姓名 = v_病人姓名 And a.性别 = b.名称(+) And b.国标代码(+) = n_病人性别 And a.身份证号 = v_身份证号
      Group By a.病人id, a.性别;
      --传入姓名与数据库中姓名不一样的时候，禁止绑卡
      If Nvl(v_病人姓名_Old, '-') <> Nvl(v_病人姓名, '-') Then
        v_Temp  := '<YDM>0</YDM>';
        v_Temp  := v_Temp || '<ERROR><MSG>' || '失败，传入身份证号已绑定其他病人' || '</MSG></ERROR>';
        Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
        Return;
      End If;
    End If;
  Exception
    When Others Then
      n_Count := 0;
  End;

  If n_Count = 1 Then
    --只有一条病人信息时，先更新下年龄，再绑定证件
    If Not d_出生日期 Is Null Then
      Select Zl_Age_Calc(n_病人id, d_出生日期, Null) Into v_病人年龄 From Dual;
      Update 病人信息 Set 年龄 = v_病人年龄 Where 病人id = n_病人id;
    End If;
  Else
    --先给病人建档，再绑定证件
    Select 病人信息_Id.Nextval Into n_病人id From Dual;
    n_自动门诊号 := Nvl(zl_GetSysParameter('自动门诊号', 1107), 0);
    If n_自动门诊号 = 1 Then
      Select Nextno(3) Into n_门诊号 From Dual;
    End If;
    If Not d_出生日期 Is Null Then
      Select Zl_Age_Calc(Null, d_出生日期, Null) Into v_病人年龄 From Dual;
    End If;
    Select Max(名称)
    Into v_费别
    From 费别
    Where 属性 = 1 And Nvl(仅限初诊, 0) = 0 And Nvl(服务对象, 3) In (1, 3) And Sysdate Between Nvl(有效开始, Sysdate - 1) And
          Nvl(有效结束, Sysdate + 1) And 缺省标志 = 1 And Rownum < 2;
    Select Max(名称) Into v_医疗付款方式 From 医疗付款方式 Where Nvl(是否停用, 0) = 0 And 缺省标志 = 1 And Rownum < 2;
  
    Zl_病人信息_Insert(n_病人id, n_门诊号, v_费别, v_医疗付款方式, v_病人姓名, v_病人性别, v_病人年龄, d_出生日期, Null, v_身份证号, Null, Null, Null, Null,
                   Null, Null, v_地址, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null, Null,
                   Null, d_操作时间, Null, Null, v_操作员编号, v_操作员姓名, Null, v_证件号码, Null, Null, Null, Null, Null, Null, v_手机号);
  End If;

  --新增病人卡信息
  If v_就诊卡号 Is Not Null Then
    Zl_医疗卡变动_Insert(11, n_病人id, n_卡类别id, Null, v_就诊卡号, '', Null, v_操作员姓名, d_操作时间);
    Update 病人信息 Set 就诊卡号 = v_就诊卡号 Where 病人id = n_病人id And 就诊卡号 Is Null;
  End If;

  Xml_Out := Xmltype('<OUTPUT><YDM>1</YDM></OUTPUT>');
Exception
  When Others Then
    v_Temp  := '<YDM>0</YDM>';
    v_Temp  := v_Temp || '<ERROR><MSG>' || SQLCode || SQLErrM || '</MSG></ERROR>';
    Xml_Out := Xmltype('<OUTPUT>' || v_Temp || '</OUTPUT>');
End Zl_Third_Boundcard;
/