--[连续升级]1
--[管理工具版本号]10.35.50
--本脚本支持从ZLHIS+ v10.35.40 升级到 v10.35.50
--请以系统所有者登录PLSQL并执行下列脚本
--脚本执行后，请手工升级导出报表
Define n_System=100;
-------------------------------------------------------------------------------
--结构修正部份
-------------------------------------------------------------------------------
--105165:张德婷,2017-04-20,处方发药可以添加该叫号窗口的所有处方
alter table 发药窗口 add 叫号窗口 varchar2(10);

--107559:冉俊明,2017-04-17,增加终止停诊安排功能
Alter Table 临床出诊停诊记录 Add 失效时间 Date;

--103383:刘尔旋,2017-04-17,常用退号原因
Create Table 常用退号原因
(
  编码   VARCHAR2(4),
  名称   VARCHAR2(50),
  简码   VARCHAR2(25),
  缺省标志 NUMBER(1))
Tablespace ZL9BASEITEM;

Alter Table 常用退号原因 Add Constraint 常用退号原因_PK Primary Key (编码) Using Index Tablespace ZL9INDEXHIS;
Alter Table 常用退号原因 Add Constraint 常用退号原因_UQ_名称 Unique (名称) Using Index Tablespace ZL9INDEXHIS;

--102751:刘尔旋,2017-04-11,病人挂号记录对应收费单
Alter Table 病人挂号记录 Add 收费单 Varchar2(20);

--107651:梁唐彬,2017-04-10,病人自动计算费用的变动数据产生
Create Table 病人自动计算(
    Id Number(18),
    病人ID number(18) Not Null,
    主页ID number(5) Not Null,
    性质 Number(2),    
    开始时间 Date,
    开始原因 number(2),
    附加床位 number(1),
    科室ID  Number(18),
    病区ID  number(18),
    护理等级id number(18),
    床位等级id number(18),
    床号 VARCHAR2(10),
    终止人员 varchar2(20),
    终止原因 number(2),
    终止时间 Date,
    操作员编号 varchar2(6),
    操作员姓名 varchar2(20),
    上次计算时间 Date)
    TABLESPACE zl9Patient
    initrans 20;

Create Sequence 病人自动计算_Id Start With 1  Cache 100;

Alter Table 病人自动计算 Add Constraint 病人自动计算_PK Primary Key (ID) Using Index Pctfree 5 Tablespace zl9Indexhis;

Create Index 病人自动计算_IX_病人ID On 病人自动计算(病人ID,主页ID) Pctfree 5 Tablespace zl9Indexhis;


--104000:蒋廷中,2017-04-10,增加邮编信息
alter table 区域 add 邮编 varchar2(10);

--105791:冉俊明,2017-04-05,法定假日表字段名调整
Alter Table 法定假日表 Rename Column 允许预约 To 允许预约日期;
Alter Table 法定假日表 Rename Column 允许挂号 To 允许挂号日期;

--105420:陈刘,2017-04-01,体温单打印可视化修改

CREATE TABLE 体温单打印
(
文件ID number(18),
开始时间 date,
打印页号 number(5),
打印人 varchar2(20),
打印时间 date
) TABLESPACE ZL9EPRDAT;

Alter Table 体温单打印 Add Constraint 体温单打印_PK Primary Key (文件ID,开始时间,打印页号) Using Index Tablespace zl9Indexcis;

--105176:张德婷,2017-03-30,静配中心审核医嘱添加审核人
alter table 病人医嘱记录 add 审核药师 varchar2(20);

--104259:陈刘,2017-03-30,体温单新增体温部位额温
Alter Table 体温记录项目 Modify 记录符 Varchar2(20);

--87258:刘尔旋,2017-03-27,多类别扎帐
Alter Table 人员收缴记录 Add(
      是否挂号 Number(1),
      是否就诊卡 Number(1),
      是否消费卡 Number(1),
      是否收费 Number(1),
      预交类别 Number(2),
      是否结帐 Number(1));

--问题简述:同时选择多类别扎帐的需求更改
--使用范围:10.34版本之后,使用了分类别扎帐的情况下,需要修正历史数据
--修正内容及方法:根据人员收缴记录的类别保存值分开保存到对应的各个字段中
--修正的数据范围:所有人员收缴记录
Begin
  --历史数据升级
  For r_收缴 In (Select ID, Nvl(类别, 0) As 类别 From 人员收缴记录 Where 记录性质 = 1) Loop
    Case r_收缴.类别
      When 0 Then
        --所有类别
        Update 人员收缴记录
        Set 是否挂号 = 1, 是否就诊卡 = 1, 是否消费卡 = 1, 是否收费 = 1, 预交类别 = 1, 是否结帐 = 1
        Where ID = r_收缴.Id;
      When 1 Then
        --收费
        Update 人员收缴记录
        Set 是否挂号 = 0, 是否就诊卡 = 0, 是否消费卡 = 0, 是否收费 = 1, 预交类别 = 0, 是否结帐 = 0
        Where ID = r_收缴.Id;
      When 2 Then
        --预交
        Update 人员收缴记录
        Set 是否挂号 = 0, 是否就诊卡 = 0, 是否消费卡 = 0, 是否收费 = 0, 预交类别 = 1, 是否结帐 = 0
        Where ID = r_收缴.Id;
      When 21 Then
        --预交(仅门诊)
        Update 人员收缴记录
        Set 是否挂号 = 0, 是否就诊卡 = 0, 是否消费卡 = 0, 是否收费 = 0, 预交类别 = 2, 是否结帐 = 0
        Where ID = r_收缴.Id;
      When 22 Then
        --预交(仅住院)
        Update 人员收缴记录
        Set 是否挂号 = 0, 是否就诊卡 = 0, 是否消费卡 = 0, 是否收费 = 0, 预交类别 = 3, 是否结帐 = 0
        Where ID = r_收缴.Id;
      When 3 Then
        --结帐
        Update 人员收缴记录
        Set 是否挂号 = 0, 是否就诊卡 = 0, 是否消费卡 = 0, 是否收费 = 0, 预交类别 = 0, 是否结帐 = 1
        Where ID = r_收缴.Id;
      When 4 Then
        --挂号
        Update 人员收缴记录
        Set 是否挂号 = 1, 是否就诊卡 = 0, 是否消费卡 = 0, 是否收费 = 0, 预交类别 = 0, 是否结帐 = 0
        Where ID = r_收缴.Id;
      When 5 Then
        --就诊卡
        Update 人员收缴记录
        Set 是否挂号 = 0, 是否就诊卡 = 1, 是否消费卡 = 0, 是否收费 = 0, 预交类别 = 0, 是否结帐 = 0
        Where ID = r_收缴.Id;
      When 6 Then
        --消费卡
        Update 人员收缴记录
        Set 是否挂号 = 0, 是否就诊卡 = 0, 是否消费卡 = 1, 是否收费 = 0, 预交类别 = 0, 是否结帐 = 0
        Where ID = r_收缴.Id;
    End Case;
  End Loop;
End;
/

Alter Table 人员收缴记录 Drop Column 类别;

--106771:胡俊勇,2017-03-23,RIS预约消息提醒
Create Index RIS检查预约_IX_预约开始时间 On RIS检查预约(预约开始时间) Tablespace zl9Indexcis;

--105593:冉俊明,2017-03-20,医疗付款方式缺省结算方式设置。
Alter Table 结算方式应用 Add 付款方式 Varchar2(20);

Alter Table 结算方式应用 Drop Constraint 结算方式应用_Pk Cascade Drop Index;

Alter Table 结算方式应用 Add Constraint 结算方式应用_Uq_结算方式 Unique (结算方式, 应用场合, 付款方式) Using Index Tablespace Zl9indexhis;

Alter Table 结算方式应用 Modify 结算方式 Constraint 结算方式应用_NN_结算方式 Not Null;

--106960:胡俊勇,2017-03-15,三方LIS报告
Create Table 医嘱报告内容(
    ID Number(18),
    类型 Number(2), 
    报告名 Varchar2(100),  
    报告说明 Varchar2(100),
    内容 BLOB,
    创建人 VARCHAR2(20),
    创建时间 DATE,
    待转出 Number(3))
  LOB(内容) Store as (Cache)
  Tablespace zl9CISRec
  PCTFREE 5;

Create Sequence 医嘱报告内容_ID Start With 1;  
Alter Table 医嘱报告内容 Add Constraint 医嘱报告内容_PK Primary Key (ID) Using Index Tablespace zl9Indexhis;  
Create Index 医嘱报告内容_IX_待转出 On 医嘱报告内容(待转出) Tablespace zl9Indexcis;

Alter Table 病人医嘱报告 Add 报告ID Number(18);
Create Index 病人医嘱报告_IX_报告ID On 病人医嘱报告(报告ID) Tablespace zl9Indexcis Nologging;
Alter Table 病人医嘱报告 Add Constraint 病人医嘱报告_FK_报告id Foreign Key (报告ID) References 医嘱报告内容(ID) On Delete Cascade enable novalidate;

--107765:胡俊勇,2017-03-29,病人医嘱报告结构修正
Alter table 病人医嘱报告 Drop Constraint 病人医嘱报告_UQ_医嘱ID Cascade Drop Index;
Create Unique Index 病人医嘱报告_UQ_医嘱ID On 病人医嘱报告(医嘱ID,病历ID,检查报告ID,RISID,报告ID) Pctfree 5 Tablespace zl9Indexcis nologging;
Alter Table 病人医嘱报告 Add Constraint 病人医嘱报告_UQ_医嘱ID Unique (医嘱ID,病历ID,检查报告ID,RISID,报告ID) enable novalidate; 

Alter Table 报告查阅记录 Add RISID Number(18);
Alter Table 报告查阅记录 Add 报告ID Number(18);
Alter Table 报告查阅记录 Drop Constraint 报告查阅记录_FK_病历ID;
Alter Table 报告查阅记录 Add Constraint 报告查阅记录_FK_病历ID Foreign Key (医嘱ID,病历ID,检查报告ID,RISID,报告ID) References 病人医嘱报告(医嘱ID,病历ID,检查报告ID,RISID,报告ID) On Delete Cascade enable novalidate;

Alter table 报告查阅记录 Drop Constraint 报告查阅记录_UQ_医嘱ID Cascade Drop Index;
Create Unique Index 报告查阅记录_UQ_医嘱ID On 报告查阅记录(医嘱ID,病历ID,检查报告ID,RISID,报告ID,查阅人,查阅时间) Pctfree 5 Tablespace zl9Indexcis nologging;
Alter Table 报告查阅记录 Add Constraint 报告查阅记录_UQ_医嘱ID Unique(医嘱ID,病历ID,检查报告ID,RISID,报告ID,查阅人,查阅时间) enable novalidate; 

Alter Table 影像报告驳回 Add RISID Number(18);
Alter Table 影像报告驳回 Add 报告ID Number(18);
Alter Table 影像报告驳回 Drop Constraint 影像报告驳回_FK_医嘱ID;
Alter Table 影像报告驳回 Add Constraint 影像报告驳回_FK_医嘱ID Foreign Key (医嘱ID,病历ID,检查报告ID,RISID,报告ID) References 病人医嘱报告(医嘱ID,病历ID,检查报告ID,RISID,报告ID) On Delete Cascade enable novalidate;

Drop Index 影像报告驳回_IX_医嘱ID;
Create Index 影像报告驳回_IX_医嘱ID On 影像报告驳回(医嘱ID,病历ID,检查报告ID,RISID,报告ID) Tablespace ZL9INDEXCIS;

--105894:胡俊勇,2017-03-09,门诊医嘱下达项目排序
 Create Index 医生常用医嘱_IX_人员ID On 医生常用医嘱(人员ID) Tablespace zl9Indexcis;

--106126:余伟节,2017-03-10,分娩信息维护
Create Table 病人分娩信息(
	病人ID number(18),
	主页ID number(5),
	胎儿次序 number(5),
	分娩方式 varchar2(20) not Null,
	出生胎位 varchar2(10) not Null,
	分娩情况 varchar2(10) not Null,
	出生缺陷 number(1) not Null,
	婴儿性别 varchar2(10) not Null,
	婴儿体重 varchar2(10),
	Apgar评分 varchar2(10))
	TABLESPACE zl9CisRec PCTFREE 5 ;

Create Table 新生儿诊断记录(
	病人ID number(18),
	主页ID number(5),
	胎儿次序 number(5),
	诊断次序 number(5),
	疾病ID number(5),
	描述信息 varchar2(100))
	TABLESPACE zl9CisRec PCTFREE 5 ;
Alter Table 病人分娩信息 Drop Constraint 病人分娩信息_PK_胎儿次序 Cascade Drop Index;
Alter Table 新生儿诊断记录 Drop Constraint 新生儿诊断记录_PK_诊断次序 Cascade Drop Index;
ALTER TABLE 病人分娩信息 ADD CONSTRAINT 病人分娩信息_PK PRIMARY KEY (病人ID,主页ID,胎儿次序) USING INDEX  TABLESPACE zl9Indexcis;
ALTER TABLE 病人分娩信息 ADD CONSTRAINT 病人分娩信息_FK_主页ID FOREIGN KEY (病人ID,主页ID) REFERENCES 病案主页(病人ID,主页ID) ON DELETE CASCADE;
ALTER TABLE 新生儿诊断记录 ADD CONSTRAINT 新生儿诊断记录_PK PRIMARY KEY (病人ID,主页ID,胎儿次序,诊断次序) USING INDEX  TABLESPACE zl9Indexcis;
ALTER TABLE 新生儿诊断记录 ADD CONSTRAINT 新生儿诊断记录_FK_胎儿次序 FOREIGN KEY (病人ID,主页ID,胎儿次序) REFERENCES 病人分娩信息(病人ID,主页ID,胎儿次序) ON DELETE CASCADE;

--105593:冉俊明,2017-03-20,医疗付款方式缺省结算方式设置。
Alter Table 结算方式应用 Add Constraint 结算方式应用_Fk_付款方式 Foreign Key(付款方式) References 医疗付款方式(名称) On Delete Cascade;

--103022:李业庆,2017-3-22,供应商照片
Create Table 供应商照片(
    供应商ID NUMBER(18),
    许可证号照片 BLOB,
    执照号照片 BLOB,
    授权号照片 Blob)
    TABLESPACE zl9BaseItem;

Alter Table 供应商照片 Add Constraint 供应商照片_PK Primary Key(供应商ID) Using Index Tablespace zl9Indexhis;
Alter Table 供应商照片 Add Constraint 供应商照片_FK_供应商ID Foreign Key(供应商ID) References 供应商(ID) On Delete Cascade;

-------------------------------------------------------------------------------
--数据修正部份
-------------------------------------------------------------------------------

--106248:蒋廷中,2017-4-25,病理诊断检查ICD附码检查
Update zlParameters
Set 影响控制说明 = '住院首页填写时，用于控制病理诊断的填写检查方式。', 参数值含义 = '0-不检查，1-必须填写（诊断编码不是诊断在C00到D48的则禁止填写），2-提示是否填写。'
Where 参数名 = '病理诊断检查' And 模块 = 1261 And 系统 = &n_System;
Update zlParameters
Set 影响控制说明 = '控制住院医生站中首页的主要出院诊断在C00到D48时，主要出院诊断是否需要填写ICD附码。',参数值含义 = '主要出院诊断编码在C00到D48的，主要出院诊断的ICD附码：1-必须填写，2-提示是否填写，0-不检查。'
Where 参数名 = 'ICD附码检查' And 模块 = 1261 And 系统 = &n_System;

--104726:李南春,2017-04-20,发卡使用门诊收据
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1107, 0, 0, 0, 0, 0, 0, 22, '卡费使用门诊收费医疗收据', '0', '0',
         '如果本参数设置1-使用门诊医疗收据，则在发卡时，卡费将使用门诊医疗发票的规则进行发票管理和打印，否则不按门诊医疗收据打印发票。','1-使用门诊医疗收据,0-不使用门诊医疗收据',
         '1.需要结合参数"票号严格控制"中收费是否严格控制来进行控制:' || chr(13) || 'a.如果严格控制,则打印的门诊医疗收据必须先进行领用,然后才能正常打印.' || chr(13) ||
         'b.如果为不严格控制,则在收费时,必须输入一个票号才能正常打印' || chr(13) || '2.需要结合参数"医疗卡收据格式"来控制票据的打印格式' || chr(13) || '3.调用报表:ZL1_BILL_1107',
         '适用于需要在发卡完成后,要打印卡费的发票',NULL
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1107, 0, 0, 0, 0, 0, 0, 23, '医疗卡收据格式', '0|0', '0|0',
         '1)在医疗卡发放管理中进行发卡或绑定时，确定发卡或绑定卡应该打印的票据格式' || chr(13) ||  '2如果需要打印医疗卡收据,则调用报表:ZL1_BILL_1107','格式:绑定卡打印格式|发卡打印格式' || chr(13) ||
         '绑定卡打印格式或发卡打印格式:0或NULL:使用本地缺省格式,' || chr(13) || '>0:票据格式序号',
         '需要结合费用参数设置中所设置的收费票据项中的"是否严格控制"属性控制,如果为严格控制且操作员无自用票据,则按本参数设置来读取该使用的发票的批次',
         '适用于多人在同一工作站使用同一批次收据的业务模式。',NULL
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1107, 0, 1, 0, 0, 0, 0, 24, '共用门诊收据批次', '', '',
         '1.需要满足条件:门诊医疗票据严格控制且操作员没有自用医疗票据时本参数设置才有效。' || chr(13) || '2.在医疗卡发放管理中进行发卡时,在满足上面条件下,根据本参数来检查当前发卡卡费的医疗收据。',
         '格式:领用ID',
         '需要结合费用参数设置中所设置的收费票据项中的"是否严格控制"属性控制,如果为严格控制且操作员无自用票据,则按本参数设置来读取该使用的发票的批次',
         '适用于多人在同一工作站使用同一批次收据的业务模式。',NULL
  From Dual;

--106366:刘尔旋,2017-04-18,传统风格结帐界面
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1137, 0, 0, 0, 0, 0, 0, 60, '结帐界面风格', '1', '1', '决定结帐界面布局风格。',
         '0-传统风格;1-结帐缴款风格', Null, '传统风格主要针对已经习惯了传统结帐界面操作的用户，结帐缴款风格主要适用于某些用户先选择缴款方式，然后输入结款金额的方式', Null
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1137, 0, 0, 0, 0, 0, 0, 61, '病人多次结帐弹出结帐条件窗体', Null, '0', '病人存在多次入院或者留观结帐的情况下，确定是否自动弹出结帐条件窗体。',
         '0-不弹出条件窗体，1-弹出条件窗体', Null, '只适用于传统风格结帐界面', Null
  From Dual;

--103383:刘尔旋,2017-04-17,常用退号原因
Insert Into zlBaseCode
  (系统, 表名, 固定, 说明, 分类)
Values
  (&n_System, '常用退号原因', 0, '常用退号原因', '经济工作');

--106148:刘尔旋,2017-04-17,新版提前挂号颜色处理
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1111, 0, 0, 0, 0, 0, 0, 72, '提前挂号颜色', Null, '0', '新版挂号时，提前挂号安排的字体颜色显示。',
         '颜色代码', Null, '适用于医院采用提前挂号的情况', Null
  From Dual;

--89759:李南春,2017-04-14,消费卡刷卡是否定位到密码框
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, -Null, -Null, -Null, -Null, -Null, 0, 0, 276, '消费卡刷卡消费须定位到密码框', '1', '1',
         '消费卡刷卡消费的时候，如果没有密码，光标也定位到密码文本框。','0-不定位;1-定位到密码框，等待确认','控制程序在消费卡刷卡支付时，如果没有密码，在是否要等待确认刷卡信息',
         '如果要节省支付时间，加快就医流程，且病人不要求查看卡余额，则可以取消此参数',NULL
  From Dual;

--108220:胡俊勇,2017-04-14,医嘱单打印修改
Update zlParameters
Set 影响控制说明 = '打印医嘱单时，对西药、成药用法否是单独打印一行的设置。1.不打印(都不单独打印一行)；2.打印(都要单独打印一行)；3.一并给药打印(只有一并给药医嘱用法行才单独打印一行)。',
    参数值含义 = '0-不打印(都不单独打印一行)，1-打印(都要单独打印一行)，2-一并给药打印(只有一并给药医嘱用法行才单独打印一行)。'
Where 参数名 = '药品用法单独打印一行' And 模块 = 1254 And 系统 = &n_System;

--107651:梁唐彬,2017-04-12,病人自动计算费用所需数据修正，脚本检查时请注意：此过程需要放在数据修正之前执行。
Create Or Replace Procedure Zl_病人自动计算_修正(
   --功能：针对未产生病人自动计算记录的病人根据现有的病人变动记录进行数据修正
  病人id_In 病人自动计算.病人id%Type,
  主页id_In 病人自动计算.主页id%Type) Is
  Cursor c_Curlog Is
    Select Id,病人ID,主页ID,开始时间,开始原因,附加床位,病区id,科室id,医疗小组id,护理等级id,床位等级id,床号,责任护士,经治医师,主治医师,主任医师,病情,终止人员,终止时间,终止原因,操作员编号,操作员姓名,上次计算时间
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Not Null
    Order By 开始时间, 终止时间, 附加床位;
  r_Curlogrow c_Curlog%Rowtype;

  n_Hlid 病人自动计算.Id%Type;
  n_Cwid 病人自动计算.Id%Type;
  n_Qtid 病人自动计算.Id%Type;

  v_Hlids Varchar2(4000);
  v_Cwids Varchar2(4000);
  v_Qtids Varchar2(4000);

  v_终止时间     病人自动计算.终止时间%Type;
  v_终止人员     病人自动计算.终止人员%Type;
  v_终止原因     病人自动计算.终止原因%Type;
  v_上次计算时间 病人自动计算.上次计算时间%Type;

  n_Count Number;
  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  Select Count(1) Into n_Count From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In;
  --只对没有数据的进行修正一次；
  If n_Count = 0 Then
    Open c_Curlog;
    Fetch c_Curlog
      Into r_Curlogrow;
    While c_Curlog%Found Loop
      If r_Curlogrow.开始原因 In (1, 2, 3, 6, 15) And r_Curlogrow.附加床位 = 0 Then
        --护理等级
        If v_Hlids Is Not Null And r_Curlogrow.附加床位 = 0 Then
          Update 病人自动计算
          Set 终止时间 = r_Curlogrow.开始时间, 终止原因 = r_Curlogrow.开始原因, 终止人员 = r_Curlogrow.操作员姓名, 上次计算时间 = r_Curlogrow.上次计算时间
          Where ID In (Select /*+cardinality(A,10)*/
                        Column_Value
                       From Table(f_Str2list(v_Hlids)) A);
          v_Hlids := '';
        End If;
        Select 病人自动计算_Id.Nextval Into n_Hlid From Dual;
        If v_Hlids Is Null Then
          v_Hlids := n_Hlid;
        Else
          v_Hlids := v_Hlids || ',' || n_Hlid;
        End If;
        Insert Into 病人自动计算
          (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 病区id, 科室id, 护理等级id, 操作员编号, 操作员姓名)
        Values
          (n_Hlid, r_Curlogrow.病人id, r_Curlogrow.主页id, r_Curlogrow.开始时间, r_Curlogrow.开始原因, 1, r_Curlogrow.病区id,
           r_Curlogrow.科室id, r_Curlogrow.护理等级id, r_Curlogrow.操作员编号, r_Curlogrow.操作员姓名);
      End If;
      If r_Curlogrow.开始原因 In (1, 2, 3, 4, 5, 15) Then
        --床位
        If v_Cwids Is Not Null And r_Curlogrow.附加床位 = 0 Then
          Update 病人自动计算
          Set 终止时间 = r_Curlogrow.开始时间, 终止原因 = r_Curlogrow.开始原因, 终止人员 = r_Curlogrow.操作员姓名, 上次计算时间 = r_Curlogrow.上次计算时间
          Where ID In (Select /*+cardinality(A,10)*/
                        Column_Value
                       From Table(f_Str2list(v_Cwids)) A);
          v_Cwids := '';
        End If;
        Select 病人自动计算_Id.Nextval Into n_Cwid From Dual;
        If v_Cwids Is Null Then
          v_Cwids := n_Cwid;
        Else
          v_Cwids := v_Cwids || ',' || n_Cwid;
        End If;
        Insert Into 病人自动计算
          (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号, 操作员姓名)
        Values
          (n_Cwid, r_Curlogrow.病人id, r_Curlogrow.主页id, r_Curlogrow.开始时间, r_Curlogrow.开始原因, 2, r_Curlogrow.附加床位,
           r_Curlogrow.病区id, r_Curlogrow.科室id, r_Curlogrow.床位等级id, r_Curlogrow.床号, r_Curlogrow.操作员编号, r_Curlogrow.操作员姓名);
        --其他
        If v_Qtids Is Not Null And r_Curlogrow.附加床位 = 0 Then
          Update 病人自动计算
          Set 终止时间 = r_Curlogrow.开始时间, 终止原因 = r_Curlogrow.开始原因, 终止人员 = r_Curlogrow.操作员姓名, 上次计算时间 = r_Curlogrow.上次计算时间
          Where ID In (Select /*+cardinality(A,10)*/
                        Column_Value
                       From Table(f_Str2list(v_Qtids)) A);
          v_Qtids := '';
        End If;
        Select 病人自动计算_Id.Nextval Into n_Qtid From Dual;
        If v_Qtids Is Null Then
          v_Qtids := n_Qtid;
        Else
          v_Qtids := v_Qtids || ',' || n_Qtid;
        End If;
        Insert Into 病人自动计算
          (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号, 操作员姓名)
        Values
          (n_Qtid, r_Curlogrow.病人id, r_Curlogrow.主页id, r_Curlogrow.开始时间, r_Curlogrow.开始原因, 3, r_Curlogrow.附加床位,
           r_Curlogrow.病区id, r_Curlogrow.科室id, r_Curlogrow.床位等级id, r_Curlogrow.床号, r_Curlogrow.操作员编号, r_Curlogrow.操作员姓名);
      End If;
      If r_Curlogrow.终止原因 = 1 And r_Curlogrow.附加床位 = 0 Then
        v_终止时间     := r_Curlogrow.终止时间;
        v_终止原因     := r_Curlogrow.终止原因;
        v_终止人员     := r_Curlogrow.终止人员;
        v_上次计算时间 := r_Curlogrow.上次计算时间;
      End If;
      Fetch c_Curlog
        Into r_Curlogrow;
    End Loop;
    If v_终止时间 Is Not Null And v_终止原因 = 1 Then
      If v_Hlids Is Not Null Or v_Cwids Is Not Null Or v_Qtids Is Not Null Then
        Update 病人自动计算
        Set 终止时间 = v_终止时间, 终止原因 = v_终止原因, 终止人员 = v_终止人员, 上次计算时间 = v_上次计算时间
        Where ID In (Select /*+cardinality(A,10)*/
                      Column_Value
                     From Table(f_Str2list(v_Hlids || ',' || v_Cwids || ',' || v_Qtids)) A);
      End If;
    End If;
    Close c_Curlog;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病人自动计算_修正;
/
--107651:梁唐彬,2017-04-12,病人自动计算费用所需数据修正（使用大医二院的数据进行测试，共修正1W名病人，耗时22秒）
Begin
  For r_Pati In (Select 病人id, 主页id
                 From 在院病人
                 Union All
                 Select 病人id, 主页id From 病案主页 Where 出院日期 >= Sysdate - 30) Loop
    Zl_病人自动计算_修正(r_Pati.病人id, r_Pati.主页id);
  End Loop;
End;
/
--由于数据修正，为了性能考虑，把索引和约束创建放在修正数据之后
Alter Table 病人自动计算 Add Constraint 病人自动计算_FK_主页ID Foreign Key (病人ID,主页ID) References 病案主页(病人ID,主页ID) On Delete Cascade Novalidate;
Alter Table 病人自动计算 Add Constraint 病人自动计算_FK_病区id Foreign Key (病区id) References 部门表(ID) Novalidate;
Alter Table 病人自动计算 Add Constraint 病人自动计算_FK_科室id Foreign Key (科室id) References 部门表(ID) Novalidate;
Alter Table 病人自动计算 Add Constraint 病人自动计算_FK_床位等级id Foreign Key (床位等级id) References 收费项目目录(ID) Novalidate;
Alter Table 病人自动计算 Add Constraint 病人自动计算_FK_护理等级id Foreign Key (护理等级id) References 收费项目目录(ID) Novalidate;
Create Index 病人自动计算_IX_开始时间 On 病人自动计算(开始时间) Pctfree 5 Tablespace zl9Indexhis nologging;
Create Index 病人自动计算_IX_终止时间 On 病人自动计算(终止时间) Pctfree 5 Tablespace zl9Indexhis nologging;


--102751:刘尔旋,2017-04-11,病人挂号记录对应收费单
--耗时说明:该数据修正脚本在10分钟内执行完成，测试环境如下:
--1.硬件环境
--     HP980,2个4核CPU,64G内存 
--     IBM V7000,Raid1+0,SAS10K
--2.软件环境
--     Red Hat Enterprise Linux Server release 5.8(Tikanga), Oracle Release 10.2.0.4.0
--     日志文件500M/个,Log Buffer设置为500M,PGA为8G,SGA为自动管理
--3.数据环境
--     德阳市人民医院截止2016年的在线数据
--     门诊费用记录1500万条,病人挂号记录190万条
Declare
  v_No    Varchar2(20);
Begin
  For r_划价 In (Select Distinct NO, 摘要 From 门诊费用记录 Where 记录性质 = 4 And 摘要 Like '划价:%') Loop
    v_No := Substr(r_划价.摘要, Instr(r_划价.摘要, ':') + 1);
    Update 病人挂号记录 Set 收费单 = v_No Where NO = r_划价.No;
  End Loop;
End;
/

--106362:刘尔旋,2017-04-10,禁止输入年龄控制
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1111, 0, 0, 0, 0, 0, 0, 71, '禁止输入年龄', '0', '0', '在门诊挂号时是否禁止操作员输入年龄。',
         '0-不禁止输入;1-禁止输入', '与挂号输入项目年龄的参数关联生效', '主要适用于个别医院只要求输入出生日期,不输入年龄的业务。', Null
  From Dual;


--90335:李南春,2017-04-06,控制自助缴费读取划价单的时间范围
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1805, 0, 0, 0, 0, 0, 0, 24, '显示N天内的划价单', '0', '0', '控制自助缴费读取划价单的时间范围。',
         'N=0提取所有划价单,N>0提取N天内的划价单', Null, '适用于自助缴费限制费用的日期范围', Null
  From Dual;

--105443:刘尔旋,2017-04-06,预约有效时间规则变更
Update zlParameters
Set 影响控制说明 = '当参数设置不为0时，判断病人失约的依据，即：指预约单在预约时间加减本参数设置的分钟数未接收的为失约:' || Chr(13) || '
a)在挂号接收时，失约的将会禁止接收' || Chr(13) || '
b) 在挂号且参数“失约用于挂号”有效的情况下,失约的号源，可以应用于挂号' || Chr(13) || '
c)作为黑名单判断的依据。',参数值含义='以分钟为单位,0表示不限制,>0表示提前接收的限制分钟数,<0表示延后接收的限制分钟数'
Where 系统 = &n_System And 模块 = 1111 And 参数名 = '预约有效时间';

--104983:冉俊明,2017-04-05,体检病人按单据分别打印
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1121, 0, 0, 0, 0, 0, 0, 113, '体检病人分单据打印', Null, '0',
         '在病人收费管理中，如果票据是按“根据实际打印分配票号”，且设置了“门诊收费每张单据分别打印”时，体检病人是否也按每张单据分别打印。',
         '1-体检病人按每张单据分别打印，0或NULL-体检病人不按每张单据分别打印', '需要设置“票据分配规则”为“根据实际打印分配票号”，同时设置了“门诊收费每张单据分别打印”该参数才有效。',
         '用于控制票据按“根据实际打印分配票号”，且设置了“门诊收费每张单据分别打印”时体检病人是否也按每张单据分别打印。', Null
  From Dual;

--103643:刘尔旋,2017-04-05,允许在院病人余额退款
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1103, 0, 0, 0, 0, 0, 0, 23, '允许在院病人余额退款', '1', '1',
         '如果启用了本参数,则允许在院病人针对住院预交款进行余额退款,否则不允许', '1或Null-允许,0-不允许', Null, '主要是适用于用户针对在院病人退住院预交余额', Null
  From Dual;

--106571:廖思奇,2017-04-05,自定义取材信息显示数据
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1294, 0, 0, 0, 0, 0, 0, 112, '取材内容设置', '1,1,1,1,1,1,1,1,1,1', '1,1,1,1,1,1,1,1,1,1',
         '影响病理历史报告查看巨检描述类型中，需要显示出来的数据', '逗号分隔从第零个到第九个，依次是：标本名称,取材位置,形状,蜡块数,制片数,主取医师,取材时间,性质,颜色,标本量', 
		 Null, '病理历史报告中自定义需要显示的取材信息', Null
  From Dual;

--107129:张德婷,2017-04-01,发药时审核医嘱的功能添加参数控制
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1342, 0, 0, 0, 0, 0, 0, 27, '发药时审核医嘱', '', '0', '发药则表示该医嘱审核通过',
         '0:发药不审核医嘱;1:发药完成医嘱审核操作', Null,'当发药需要审核医嘱时，启用该参数，如果部门发药不需要审核医嘱，则不适用', Null
  From Dual;

--107799:胡俊勇,2017-03-31,医嘱清单过滤条件个性化参数记录
Update zlParameters
Set 参数名 = '医嘱过滤方式', 缺省值 = 0, 影响控制说明 = '门诊医嘱清单页签选择记录:0-医嘱,3-报告', 参数值含义 = '0-医嘱,3-报告'
Where 参数名 ='医嘱状态过滤' And 模块 = 1252 And Nvl(系统, 0) = &n_System;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1252, 1, 1, 0, 1, 0, 1, 59, '报告查看类型', Null, '0',
         '门诊医嘱清单选择报告页签时的过滤条件记录:0-全部,1-检查,2-检验,3-其他', '0-全部,1-检查,2-检验,3-其他', Null, '窗体控件状态参数', Null
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1252, 1, 1, 0, 1, 0, 1, 60, '过滤条件自动隐藏', Null, '0',
         '门诊医嘱清单中的过滤条件工具栏是否自动隐藏:0-不隐藏,1-隐藏', '0-不隐藏,1-隐藏', Null, '窗体控件状态参数', Null
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1252, 1, 1, 0, 1, 0, 1, 61, '医嘱显示作废', Null, '1',
         '门诊医嘱清单中的过滤条件:0-不显示作废的医嘱,1-显示作废医嘱', '0-不显示作废的医嘱,1-显示作废医嘱', Null, '窗体控件状态参数', Null
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1252, 1, 1, 0, 1, 0, 1, 62, '医嘱显示处方', Null, '0',
         '门诊医嘱清单选择报告页签时的过滤条件记录:0-全部,1-处方，2-其它', '0-全部,1-处方，2-其它', Null, '窗体控件状态参数', Null
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1253, 1, 1, 0, 1, 0, 1, 59, '报告查看类型', Null, '0',
         '住院医嘱清单选择报告页签时的过滤条件记录:0-全部,1-检查,2-检验,3-其他', '0-全部,1-检查,2-检验,3-其他', Null, '窗体控件状态参数', Null
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1253, 1, 1, 0, 1, 0, 1, 60, '过滤条件自动隐藏', Null, '0',
         '住院医嘱嘱清单中的过滤条件工具栏是否自动隐藏:0-不隐藏,1-隐藏', '0-不隐藏,1-隐藏', Null, '窗体控件状态参数', Null
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1253, 1, 1, 0, 1, 0, 1, 61, '医嘱显示在用', Null, '0',
         '住院医嘱清单中的过滤条件:0-在用医嘱,1-所有医嘱', '0-在用医嘱,1-所有医嘱', Null, '窗体控件状态参数', Null
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1253, 1, 1, 0, 1, 0, 1, 62, '医嘱显示在用未到终止时间', Null, '0',
         '住院医嘱清单未到终止时间过滤条件记录:0-未勾选,1-勾选', '0-未勾选,1-勾选', Null, '窗体控件状态参数', Null
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1253, 1, 1, 0, 1, 0, 1, 63, '医嘱显示报告需要', Null, '0',
         '住院医嘱清单是否需要报告过滤条件记录:0-所有,1-需要报告,2-不需要报告', '0-所有(两者一起勾选),1-需要报告,2-不需要报告', Null, '窗体控件状态参数', Null
  From Dual;

--107566:黄捷,2017-03-30,图像四角信息增加医嘱ID
Insert Into 影像图像信息表
  (Id, 开始地址, 结束地址, 英文名称, 中文名称, 中文简称, 英文简称, 常用, 被选用, 位置, 角内序号, 使用计算)
Values
  (影像图像信息表_Id.Nextval, 3, 3, 'cal', 'DB医嘱ID', '[医嘱ID]', '[OrderID]', -1, 0, 0, 0, 0);

--106132:张德婷,2017-03-29,发药核查人相关修改
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1341, 0, 1, 1, 0, 0, 0, 64, '允许核查人和配药人相同', Null, null,
         '发药时，核查人是否允许和配药人相同', '1-允许；0-不允许', Null, '适用需要区分核查人和配药人的场合', Null From Dual;

--104015:张德婷,2017-03-28,自动打印配药单时可打印所有格式
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1341, 0, 1, 1, 0, 0, 0, 63, '打印票据的所有格式', Null, Null,
         '自动打印配药单时打印票据的所有格式', '0-打印第二个配药单格式；1-打印所有格式', '只有在自动打印配药单的时候才会打印所有票据', '适用于配药单有多个格式需要同时打印的情况', Null From Dual;

--106132:张德婷,2017-03-28,核查人由参数设置为默认选择人
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1341, 0, 1, 1, 0, 0, 0, 62, '核查人', Null, Null,
         '设置核查人', '设置核查人', Null, '适用于核查人跟发药人不是同一个人的场合', Null From Dual;

--107420:李南春,2017-03-27,自助费用查询缺省查询天数
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1806, 0, 1, 0, 0, 0, 0, 10, '按缺省天数查询费用', Null, '0|1',
         '控制在自助费用查询管理中，病人是否先要选择查询费用的日期范围才能看到费用明细。','格式：启用缺省查询|查询天数，启用缺省查询：0-病人先选日期才能查看费用明细，1-显示查询天数内的费用明细，如果病人要查看日期范围外的费用，可以返回到日期选择页面',
         NULL,'适用于医院减少自助操作流程。',NULL
  From Dual;

--107422:李南春,2017-03-24,身份识别后是否显示身份信息
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1801, 0, 1, 0, 0, 0, 0, 20, '显示病人信息页面', Null, '1',
         '控制在自助发卡及签约管理中，病人在通过身份识别后，是否需要显示身份信息确认页面，以展示当前的病人信息。','0-表示不显示病人信息确认页面，1-表示显示病人信息确认页面',NULL,
         '适用于医院减少自助操作流程。',NULL
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1804, 0, 1, 0, 0, 0, 0, 18, '显示病人信息页面', Null, '1',
         '控制在自助充值管理中，病人在通过身份识别后，是否需要显示身份信息确认页面，以展示当前的病人信息。','0-表示不显示病人信息确认页面，1-表示显示病人信息确认页面',NULL,
         '适用于医院减少自助操作流程。',NULL
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1805, 0, 1, 0, 0, 0, 0, 23, '显示病人信息页面', Null, '1',
         '控制在自助缴费管理中，病人在通过身份识别后，是否需要显示身份信息确认页面，以展示当前的病人信息。','0-表示不显示病人信息确认页面，1-表示显示病人信息确认页面',NULL,
         '适用于医院减少自助操作流程。',NULL
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1806, 0, 1, 0, 0, 0, 0, 9, '显示病人信息页面', Null, '1',
         '控制在自助费用查询管理中，病人在通过身份识别后，是否需要显示身份信息确认页面，以展示当前的病人信息。','0-表示不显示病人信息确认页面，1-表示显示病人信息确认页面',NULL,
         '适用于医院减少自助操作流程。',NULL
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1807, 0, 1, 0, 0, 0, 0, 10, '显示病人信息页面', Null, '1',
         '控制在自助发票打印管理中，病人在通过身份识别后，是否需要显示身份信息确认页面，以展示当前的病人信息。','0-表示不显示病人信息确认页面，1-表示显示病人信息确认页面',NULL,
         '适用于医院减少自助操作流程。',NULL
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1808, 0, 1, 0, 0, 0, 0, 7, '显示病人信息页面', Null, '1',
         '控制在自助凭条打印管理中，病人在通过身份识别后，是否需要显示身份信息确认页面，以展示当前的病人信息。','0-表示不显示病人信息确认页面，1-表示显示病人信息确认页面',NULL,
         '适用于医院减少自助操作流程。',NULL
  From Dual;

--106771:胡俊勇,2017-03-23,RIS预约消息提醒
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1262, 1, 1, 0, 0, 0, 0, 27, 'RIS预约消息语音配置', Null, '1<sTab>0<sTab>iif([床号]<>"",[床号],"家庭床")+"预约"+[项目内容]+"检查。"<sTab>2',
         '住院护士站RIS预约消息语音配置信息。', '固定格式：状态<sTab>提示方式<sTab>内容<sTab>播放次数。状态0/1是否启用，提示方式0/1 0读文本，1wav音频,内容－文本或音频文件，播放次数',
          Null, '适用于住院护士站RIS预约消息。', Null
  From Dual;

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1262, 1, 1, 0, 0, 0, 0, 28, 'RIS预约准备消息语音配置', Null, '1<sTab>0<sTab>iif([床号]<>"",[床号],"家庭床")+"请准备做"+[项目内容]+"检查。"<sTab>2',
         '住院护士站RIS预约准备消息语音配置信息。', '固定格式：状态<sTab>提示方式<sTab>内容<sTab>播放次数。状态0/1是否启用，提示方式0/1 0读文本，1wav音频,内容－文本或音频文件，播放次数',
          Null, '适用于住院护士站RIS预约准备消息。', Null
  From Dual;
  
update zlparameters 
set 参数值含义='按位分别表示：1新开、2新停、3新废、4安排、5危急值、6输液拒绝、7销帐申请、8RIS预约、9RIS预约准备'
where  参数名 = '自动刷新医嘱类型' And 模块=1262 And Nvl(系统, 0) = &n_System;

Insert Into 业务消息类型(编码,名称,说明,保留天数) 
Select 'ZLHIS_PACS_006','RIS预约消息','启用新版RIS预约模式时，预约后RIS向临床发送的一个消息。',7  From Dual Union All
Select 'ZLHIS_PACS_007','RIS预约准备消息','临床RIS预约成功能，在去预约的前半小时产生的一个检查准备消息。',7 From Dual;


--104259:陈刘,2017-03-20,体温单新增体温部位额温
Insert Into 体温部位 (项目序号, 部位, 缺省项, 固定项) Values (1, '耳温', 0, 1);
Insert Into 体温部位 (项目序号, 部位, 缺省项, 固定项) Values (1, '额温', 0, 1);

Update 体温记录项目 Set 记录符 = ',×,○,△,★' Where 项目序号 = 1;

--106964:刘尔旋,2017-03-15,备货卫材只能输内部条码
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1257, 0, 0, 0, 0, 0, 0, 17, '备货卫材只能输内部条码', '0', '0', '如果参数值=1时，则只能通过扫描或手工输入内部条码进行查询备货卫生材料。否则可以输入简码，编码，条码，名称等进行查询备货卫材。',
         '1-只能输入内部条码,0-可以输入简码，编码，名称等进行查询', Null,'参数=1只能输入内部条码时，只适用于某些用户要求严格按条码进行管理的用户', Null
  From Dual;

--106968:李南春,2017-03-15,预约限制天数适用范围调整
Update zlparameters set 关联说明 = '只有当挂号排班模式是计划排班时，本参数才有效。',适用说明 = '适用于控制自助机上病人可以预约的时间范围。'
Where 参数名 = '预约限制天数' And 模块 = 1803 And 系统 = &n_System;

--107129:张德婷,2017-03-15,发药时审核医嘱添加参数控制
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1342, 0, 0, 0, 0, 0, 0, 27, '发药时审核医嘱', '', '0', '发药则表示该医嘱审核通过',
         '0:发药不审核医嘱;1:发药完成医嘱审核操作', Null,'当发药需要审核医嘱时，启用该参数，如果部门发药不需要审核医嘱，则不适用', Null
  From Dual;

--106960:胡俊勇,2017-03-15,三方LIS报告
Insert Into zlBakTables(系统,组号,表名,序号,直接转出,停用触发器)
Select &n_System,8,A.* From (
Select 表名,序号,直接转出,停用触发器 From zlBakTables Where 1 = 0 Union All
Select '医嘱报告内容',23,1,-NULL From Dual Union All
Select 表名,序号,直接转出,停用触发器 From zlBakTables Where 1 = 0) A;

Insert Into zlBakTableindex(系统,表名,索引名)
Select &n_System,A.* From (
Select 表名,索引名 From zlBakTableindex Where 1 = 0 Union All
Select '医嘱报告内容','医嘱报告内容_PK' From Dual Union All
Select 表名,索引名 From zlBakTableindex Where 1 = 0) A;

--106516:李小东,2017-03-14,采集工作站，生成或绑定条码后跳转到已绑定页
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1211, 0, 1, 0, 0, 0, 0, 17, '跳转到已绑定页', Null, '0', '生成或绑定条码后是否跳转页面到已绑定页',
         '0-生成或绑定条码后不跳转页;1-生成或绑定条码后跳转到已绑定页', Null, '适用于检验采集工作站生成或绑定条码', Null
  From Dual;

--105525:梁经伙,2017-02-17,对病理诊断的录入控制增加参数
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1261, 0, 0, 0, 0, 0, 0, 52, '病理诊断只允许录入肿瘤形态学编码', Null, Null, '勾选参数过后，按ICD-10录入时，病理诊断只允许录入M打头的肿瘤形态学编码，需要录入其他诊断时，只能通过自由录入的方式。',
         '1-启用;0-不启用', Null, '需要控制病理录入时的范围可启用', Null
  From Dual;


--106781:冉俊明,2017-03-13,在制定启用序号不分时段的安排时，保存的序号时段信息的开始时间和终止时间不正确
Declare
  --说明：修正启用序号，不启用分时段的临床出诊号源缺省安排的序号时段没有正确填写开始时间及终止时间
  --1.[临床出诊号源时段]数据修正
  Cursor c_时段 Is
    Select ID, Max(开始时间 + 序号) As 开始时间, Max(终止时间 + 序号) As 终止时间
    From (Select b.号码, a.Id, m.开始时间, m.终止时间,
                  Case
                    When c.站点 = m.站点 And b.号类 = m.号类 Then
                     3
                    When c.站点 = m.站点 And m.号类 Is Null Then
                     2
                    When b.号类 = m.号类 And m.站点 Is Null Then
                     1
                    When m.站点 Is Null And m.号类 Is Null Then
                     0
                    Else
                     -1
                  End As 序号
           From 临床出诊号源限制 A, 临床出诊号源 B, 部门表 C,
                (Select 时间段, 站点, 号类, To_Date('3000-01-01 ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                         To_Date('3000-01-01 ' || To_Char(终止时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 终止时间
                  From 时间段) M
           Where a.号源id = b.Id And a.上班时段 = m.时间段 And b.科室id = c.Id And Nvl(a.是否序号控制, 0) = 1 And Nvl(a.是否分时段, 0) = 0)
    Group By ID;

  Type t_限制id Is Table Of 临床出诊记录.Id%Type;
  Type t_开始时间 Is Table Of 临床出诊记录.开始时间%Type;
  Type t_终止时间 Is Table Of 临床出诊记录.终止时间%Type;

  c_限制id   t_限制id := t_限制id();
  c_开始时间 t_开始时间 := t_开始时间();
  c_终止时间 t_终止时间 := t_终止时间();

  n_Array_Size Number := 10000; --每批一万,多了可能PGA不够
  I            Number(8) := 0; --每修正10万条记录提交一次,多了可能Undo不够,少了提交过于频繁
  J            Number(16) := 0;
  v_内容       Zlupgradeconfig.内容%Type;
Begin
  Begin
    Select 内容 Into v_内容 From Zlupgradeconfig Where 项目 = User || '_临床出诊号源时段修正_20170307';
  Exception
    When Others Then
      v_内容 := Null;
  End;
  If Nvl(v_内容, 'RJM') = '成功' Then
    --数据已修正成功
    Return;
  End If;

  Update Zlupgradeconfig Set 内容 = Null Where 项目 = User || '_临床出诊号源时段修正_20170307';
  If Sql%NotFound Then
    Insert Into Zlupgradeconfig (项目, 内容) Values (User || '_临床出诊号源时段修正_20170307', Null);
  End If;

  Open c_时段();
  Loop
    Fetch c_时段 Bulk Collect
      Into c_限制id, c_开始时间, c_终止时间 Limit n_Array_Size;
    Exit When c_限制id.Count = 0;
  
    Forall I In 1 .. c_限制id.Count
      Update 临床出诊号源时段
      Set 开始时间 = To_Date('3000-01-01 ' || To_Char(c_开始时间(I), 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'),
          终止时间 = To_Date('3000-01-01 ' || To_Char(c_终止时间(I), 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') + Case
                    When c_终止时间(I) <= c_开始时间(I) Then
                     1
                    Else
                     0
                  End
      Where 限制id = c_限制id(I);
  
    J := J + c_限制id.Count;
    If I = 10 Then
      Update Zlupgradeconfig Set 内容 = '已处理' || J || '条记录' Where 项目 = User || '_临床出诊号源时段修正_20170307';
      Commit;
      I := 0;
    Else
      I := I + 1;
    End If;
  End Loop;
  Close c_时段;

  Update Zlupgradeconfig Set 内容 = '成功' Where 项目 = User || '_临床出诊号源时段修正_20170307';
  Commit;
End;
/

Declare
  --说明：修正启用序号，不启用分时段的临床出诊号源模板、固定安排的序号时段没有正确填写开始时间及终止时间
  --2.[临床出诊时段]数据修正
  Cursor c_时段 Is
    Select ID, Max(开始时间 + 序号) As 开始时间, Max(终止时间 + 序号) As 终止时间
    From (Select b.号码, a.Id, m.开始时间, m.终止时间,
                  Case
                    When c.站点 = m.站点 And b.号类 = m.号类 Then
                     3
                    When c.站点 = m.站点 And m.号类 Is Null Then
                     2
                    When b.号类 = m.号类 And m.站点 Is Null Then
                     1
                    When m.站点 Is Null And m.号类 Is Null Then
                     0
                    Else
                     -1
                  End As 序号
           From 临床出诊限制 A, 临床出诊安排 D, 临床出诊号源 B, 部门表 C,
                (Select 时间段, 站点, 号类, To_Date('3000-01-01 ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                         To_Date('3000-01-01 ' || To_Char(终止时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 终止时间
                  From 时间段) M
           Where a.安排id = d.Id And d.号源id = b.Id And a.上班时段 = m.时间段 And b.科室id = c.Id And Nvl(a.是否序号控制, 0) = 1 And
                 Nvl(a.是否分时段, 0) = 0)
    Group By ID;

  Type t_限制id Is Table Of 临床出诊记录.Id%Type;
  Type t_开始时间 Is Table Of 临床出诊记录.开始时间%Type;
  Type t_终止时间 Is Table Of 临床出诊记录.终止时间%Type;

  c_限制id   t_限制id := t_限制id();
  c_开始时间 t_开始时间 := t_开始时间();
  c_终止时间 t_终止时间 := t_终止时间();

  n_Array_Size Number := 10000; --每批一万,多了可能PGA不够
  I            Number(8) := 0; --每修正10万条记录提交一次,多了可能Undo不够,少了提交过于频繁
  J            Number(16) := 0;
  v_内容       Zlupgradeconfig.内容%Type;
Begin
  Begin
    Select 内容 Into v_内容 From Zlupgradeconfig Where 项目 = User || '_临床出诊时段修正_20170307';
  Exception
    When Others Then
      v_内容 := Null;
  End;
  If Nvl(v_内容, 'RJM') = '成功' Then
    --数据已修正成功
    Return;
  End If;

  Update Zlupgradeconfig Set 内容 = Null Where 项目 = User || '_临床出诊时段修正_20170307';
  If Sql%NotFound Then
    Insert Into Zlupgradeconfig (项目, 内容) Values (User || '_临床出诊时段修正_20170307', Null);
  End If;

  Open c_时段();
  Loop
    Fetch c_时段 Bulk Collect
      Into c_限制id, c_开始时间, c_终止时间 Limit n_Array_Size;
    Exit When c_限制id.Count = 0;
  
    Forall I In 1 .. c_限制id.Count
      Update 临床出诊时段
      Set 开始时间 = To_Date(To_Char(Sysdate, 'yyyy-mm-dd') || ' ' || To_Char(c_开始时间(I), 'hh24:mi:ss'),
                          'yyyy-mm-dd hh24:mi:ss'),
          终止时间 = To_Date(To_Char(Sysdate, 'yyyy-mm-dd') || ' ' || To_Char(c_终止时间(I), 'hh24:mi:ss'),
                          'yyyy-mm-dd hh24:mi:ss') + Case
                    When c_终止时间(I) <= c_开始时间(I) Then
                     1
                    Else
                     0
                  End
      Where 限制id = c_限制id(I);
  
    J := J + c_限制id.Count;
    If I = 10 Then
      Update Zlupgradeconfig Set 内容 = '已处理' || J || '条记录' Where 项目 = User || '_临床出诊时段修正_20170307';
      Commit;
      I := 0;
    Else
      I := I + 1;
    End If;
  End Loop;
  Close c_时段;

  Update Zlupgradeconfig Set 内容 = '成功' Where 项目 = User || '_临床出诊时段修正_20170307';
  Commit;
End;
/

Declare
  --3.[临床出诊序号控制]数据修正
  --说明：修正启用序号，不启用分时段的临床出诊记录序号时段没有正确填写开始时间及终止时间
  --  临床出诊记录是业务增长数据，可能数据比较多需要分批提交
  Cursor c_时段 Is
    Select a.Rowid, b.开始时间, b.终止时间
    From 临床出诊序号控制 A, 临床出诊记录 B
    Where a.记录id = b.Id And Nvl(b.是否序号控制, 0) = 1 And Nvl(b.是否分时段, 0) = 0 And
          (a.开始时间 <> b.开始时间 Or a.终止时间 <> b.终止时间 Or a.开始时间 Is Null Or a.终止时间 Is Null);

  Type t_开始时间 Is Table Of 临床出诊记录.开始时间%Type;
  Type t_终止时间 Is Table Of 临床出诊记录.终止时间%Type;
  c_开始时间 t_开始时间 := t_开始时间();
  c_终止时间 t_终止时间 := t_终止时间();

  c_Rowid      t_Strlist := t_Strlist();
  n_Array_Size Number := 10000; --每批一万,多了可能PGA不够
  I            Number(8) := 0; --每修正10万条记录提交一次,多了可能Undo不够,少了提交过于频繁
  J            Number(16) := 0;
  v_内容       Zlupgradeconfig.内容%Type;
Begin
  Begin
    Select 内容 Into v_内容 From Zlupgradeconfig Where 项目 = User || '_临床出诊序号控制修正_20170307';
  Exception
    When Others Then
      v_内容 := Null;
  End;
  If Nvl(v_内容, 'RJM') = '成功' Then
    --数据已修正成功
    Return;
  End If;

  Update Zlupgradeconfig Set 内容 = Null Where 项目 = User || '_临床出诊序号控制修正_20170307';
  If Sql%NotFound Then
    Insert Into Zlupgradeconfig (项目, 内容) Values (User || '_临床出诊序号控制修正_20170307', Null);
  End If;

  Open c_时段();
  Loop
    Fetch c_时段 Bulk Collect
      Into c_Rowid, c_开始时间, c_终止时间 Limit n_Array_Size;
    Exit When c_Rowid.Count = 0;
  
    Forall I In 1 .. c_Rowid.Count
      Update 临床出诊序号控制 Set 开始时间 = c_开始时间(I), 终止时间 = c_终止时间(I) Where Rowid = c_Rowid(I);
  
    J := J + c_Rowid.Count;
    If I = 10 Then
      Update Zlupgradeconfig
      Set 内容 = '已处理' || J || '条记录'
      Where 项目 = User || '_临床出诊序号控制修正_20170307';
      Commit;
      I := 0;
    Else
      I := I + 1;
    End If;
  End Loop;
  Close c_时段;

  Update Zlupgradeconfig Set 内容 = '成功' Where 项目 = User || '_临床出诊序号控制修正_20170307';
  Commit;
End;
/

Declare
  --4.[临床出诊序号控制]数据修正
  --说明：修正由于使用模板生成出诊表，或者固定安排生成出诊记录时跨天的时间段的序号时段没有正确填写开始时间及终止时间
  --  临床出诊记录是业务增长数据，可能数据比较多需要分批提交
  Cursor c_时段 Is
    Select a.Rowid, b.开始时间
    From 临床出诊序号控制 A,
         (Select 记录id, Max(开始时间) As 开始时间
           From (Select a.记录id, Decode(a.序号, Min(a.序号) Over(Partition By a.记录id), a.开始时间, Null) As 开始时间,
                         Decode(a.序号, Max(a.序号) Over(Partition By a.记录id), a.终止时间, Null) As 终止时间
                  From 临床出诊序号控制 A, 临床出诊记录 B
                  Where a.记录id = b.Id And (Nvl(b.是否分时段, 0) = 1))
           Group By 记录id
           Having Max(开始时间) > Max(终止时间)) B
    Where a.记录id = b.记录id
    Order By a.记录id, a.序号;

  Type t_开始时间 Is Table Of 临床出诊记录.开始时间%Type;
  c_开始时间 t_开始时间 := t_开始时间();

  c_Rowid      t_Strlist := t_Strlist();
  n_Array_Size Number := 10000; --每批一万,多了可能PGA不够
  I            Number(8) := 0; --每修正10万条记录提交一次,多了可能Undo不够,少了提交过于频繁
  J            Number(16) := 0;
  v_内容       Zlupgradeconfig.内容%Type;
Begin
  Begin
    Select 内容 Into v_内容 From Zlupgradeconfig Where 项目 = User || '_临床出诊序号控制修正_20170307_1';
  Exception
    When Others Then
      v_内容 := Null;
  End;
  If Nvl(v_内容, 'RJM') = '成功' Then
    --数据已修正成功
    Return;
  End If;

  Update Zlupgradeconfig Set 内容 = Null Where 项目 = User || '_临床出诊序号控制修正_20170307_1';
  If Sql%NotFound Then
    Insert Into Zlupgradeconfig (项目, 内容) Values (User || '_临床出诊序号控制修正_20170307_1', Null);
  End If;

  Open c_时段();
  Loop
    Fetch c_时段 Bulk Collect
      Into c_Rowid, c_开始时间 Limit n_Array_Size;
    Exit When c_Rowid.Count = 0;
  
    Forall I In 1 .. c_Rowid.Count
      Update 临床出诊序号控制
      Set 开始时间 = 开始时间 + Case
                    When 开始时间 < c_开始时间(I) Then
                     1
                    Else
                     0
                  End,
          终止时间 = 终止时间 + Case
                    When 终止时间 < c_开始时间(I) Then
                     1
                    Else
                     0
                  End
      Where Rowid = c_Rowid(I);
  
    J := J + c_Rowid.Count;
    If I = 10 Then
      Update Zlupgradeconfig
      Set 内容 = '已处理' || J || '条记录'
      Where 项目 = User || '_临床出诊序号控制修正_20170307_1';
      Commit;
      I := 0;
    Else
      I := I + 1;
    End If;
  End Loop;
  Close c_时段;

  Update Zlupgradeconfig Set 内容 = '成功' Where 项目 = User || '_临床出诊序号控制修正_20170307_1';
  Commit;
End;
/

--104266:冉俊明,2017-03-10,自定义临床出诊号源开放时间。
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明, 参数值含义, 关联说明, 适用说明, 警告说明)
  Select Zlparameters_Id.Nextval, &n_System, Null, 0, 0, 0, 0, 0, 0, 277, '号源开放时间', Null, '00:00:00',
         '设置该参数后，将会影响临床出诊号源的放号时间。',
         '如果设置的开放时间在12:00:00-23:59:59之间且当前时间大于等于设置的开放时间，则预约天数将会多开放一天号源，否则按预约天数进行开放。' ||
          '比如：号源的预约天数为3天，号源的开放时间设置为20:00:00，当前时间为2017-3-10  20:00:00至23:59:59，将允许预约到第4天(即2017-3-14)，否则只能预约到第3天(即2017-3-13)。',
         Null, '适用于新版挂号安排，自定义临床出诊号源开放时间。', Null
  From Dual
  Where Not Exists (Select 1 From zlParameters Where 系统 = &n_System And 模块 Is Null And 参数号 = 277);

--104686:廖思奇,2017-03-09,1291模块增加参数 呼叫后锁定采集
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 部门, 性质, 参数号, 参数名, 参数值, 缺省值, 影响控制说明,参数值含义,关联说明,适用说明,警告说明)
  Select Zlparameters_Id.Nextval, &n_System, 1291, 0, 1, 0, 0, 0, 0, 56, '呼叫后锁定采集', '0', '0',
         '排队叫号呼叫后对图像采集进行锁定','排队叫号呼叫后对图像采集进行锁定',Null,'影像采集工作站中，同时使用检查锁定和排队叫号功能的用户',NULL
  From Dual;


--107215:李业庆,2017-03-17,修正药品库存表零售价字段
Declare
  Cursor c_药品库存 Is
    Select a.库房id, a.药品id, a.批次, Nvl(a.实际金额, 0) As 实际金额, Nvl(a.实际数量, 0) As 实际数量, d.现价, Nvl(b.上次售价, 0) As 上次售价
    From 药品库存 A, 药品规格 B, 收费项目目录 C, 收费价目 D
    Where a.性质 = 1 And a.药品id = b.药品id And a.药品id = c.Id And a.药品id = d.收费细目id And c.是否变价 = 1 And a.零售价 Is Null And
          (Sysdate Between d.执行日期 And d.终止日期)
    Order By a.库房id, a.药品id;

  n_零售价 药品库存.零售价%Type;
Begin
  For r_药品库存 In c_药品库存 Loop
    If r_药品库存.实际数量 <> 0 Then
      --数量不为0
      n_零售价 := r_药品库存.实际金额 / r_药品库存.实际数量;
    
    End If;
  
    If r_药品库存.实际数量 = 0 Or n_零售价 < 0 Then
      --数量为0，或数量不为0但计算出的价格为负数时
      If r_药品库存.上次售价 <> 0 Then
        n_零售价 := r_药品库存.上次售价;
      Else
        n_零售价 := r_药品库存.现价;
      End If;
    End If;
  
    Update 药品库存
    Set 零售价 = n_零售价
    Where 性质 = 1 And 库房id = r_药品库存.库房id And 药品id = r_药品库存.药品id And Nvl(批次, 0) = Nvl(r_药品库存.批次, 0);
  
  End Loop;
  Commit;
End;
/

-------------------------------------------------------------------------------
--权限修正部份
-------------------------------------------------------------------------------
--108825:李南春,2017-05-05,自助票据打印授权
Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1802, '基本', User, 'Zl_病人挂号票据_Insert', 'EXECUTE'
  From Dual;

Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1803, '基本', User, 'Zl_病人挂号票据_Insert', 'EXECUTE'
  From Dual;

--98580张德婷,2017-05-04,成套方案根据权限判断能否修改
Insert Into zlProgFuncs(系统,序号,功能,排列,说明,缺省值)
Select &n_System,1054,A.* From (
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0 Union All 
    Select '修改个人成套方案',10,'有该权限时，操作员可以修改个人的成套方案。',1 From Dual Union All 
    Select '修改科室成套方案',11,'有该权限时，操作员可以修改科室的成套方案。',1 From Dual Union All
    Select '修改全院成套方案',12,'有该权限时，操作员可以修改全院的成套方案。',1 From Dual Union All
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0) A;


Insert Into zlProgFuncs(系统,序号,功能,排列,说明,缺省值)
Select &n_System,1009,A.* From (
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0 Union All 
    Select '修改个人成套方案',16,'有该权限时，操作员可以修改个人的成套方案。',1 From Dual Union All 
    Select '修改科室成套方案',17,'有该权限时，操作员可以修改科室的成套方案。',1 From Dual Union All
    Select '修改全院成套方案',18,'有该权限时，操作员可以修改全院的成套方案。',1 From Dual Union All
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0) A;

--104726:李南春,2017-04-24,发卡使用门诊收据
Insert Into zlProgPrivs(系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1107, '换卡', User, 'Zl_病人发卡票据_Print', 'EXECUTE'
  From Dual;

Insert Into zlProgPrivs(系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1107, '补卡', User, 'Zl_病人发卡票据_Print', 'EXECUTE'
  From Dual;

--104726:李南春,2017-04-20,发卡使用门诊收据
Insert Into zlProgFuncs(系统, 序号, 功能, 排列, 说明, 缺省值)
Select &n_System, 1107, a.* From (
Select 功能, 排列, 说明, 缺省值 From zlProgFuncs Where 1 = 0 Union All
 Select '重打发票', 17, '发卡使用收费票据时，对票据进行重打。', 1 From Dual Union All
 Select '补打发票', 18, '发卡使用收费票据时，对票据进行补打。', 1 From Dual Union All
 Select '重打发卡凭条', 19, '有权限时允许重打发卡及绑定卡凭条。', 1 From Dual Union All
 Select '修改票据号', 20, '有权限时允许修改发卡、补卡、换卡时使用的收费票据号。', 1 From Dual Union All
Select 功能, 排列, 说明, 缺省值 From zlProgFuncs Where 1 = 0) A;

Insert Into zlProgPrivs(系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1107, '发卡', User, 'Zl_病人发卡票据_Print', 'EXECUTE'
  From Dual;

Insert Into zlProgPrivs(系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1107, '退卡', User, 'Zl_病人发卡票据_Print', 'EXECUTE'
  From Dual;

Insert Into zlProgPrivs(系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1107, '重打发票', User, 'Zl_病人发卡票据_Print', 'EXECUTE'
  From Dual;

Insert Into zlProgPrivs(系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1107, '补打发票', User, 'Zl_病人发卡票据_Print', 'EXECUTE'
  From Dual;

--95796:余伟节,2017-04-17,病人预出院权限拆分成办理预出院和撤销预出院
Delete From zlProgFuncs Where 系统 = &n_System And 序号 = 1132 And 功能 = '病人预出院';

Insert Into zlProgFuncs(系统,序号,功能,排列,说明,缺省值)
Select &n_System,1132,A.* From (
Select 功能, 排列, 说明, 缺省值 From zlProgFuncs Where 1 = 0 Union All
Select '办理预出院', 7, '病人预出院的操作权限。有该权限时，允许对病人办理预出院', 1 From Dual Union All
Select '撤销预出院', 25, '病人预出院的操作权限。有该权限时，允许对病人撤销预出院', 1 From Dual Union All
Select 功能, 排列, 说明, 缺省值 From zlProgFuncs Where 1 = 0) A;

Insert Into zlProgPrivs (系统, 序号, 功能, 所有者, 对象, 权限)
Select &n_System,1132,'办理预出院',User,A.* From (
Select 对象, 权限 From zlProgPrivs Where 1 = 0 Union All
Select 'ZL_病人变动记录_PreOut', 'EXECUTE' From Dual Union All
Select 对象, 权限 From zlProgPrivs Where 1 = 0) A;

--107559:冉俊明,2017-04-17,增加终止停诊安排功能
Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1114, '停诊审批', User, 'Zl_临床出诊停诊_Stop', 'EXECUTE'
  From Dual;

--103383:刘尔旋,2017-04-17,常用退号原因
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,9000,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select '常用退号原因','SELECT' From Dual Union All 
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--103383:刘尔旋,2017-04-17,常用退号原因
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1111,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select '常用退号原因','SELECT' From Dual Union All 
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--107114:刘尔旋,2017-04-12,销账申请权限补充
Insert Into zlProgPrivs(系统, 序号, 功能, 所有者, 对象, 权限)
Select &n_System, 1150, '基本', User, a.* From (
Select 对象, 权限 From zlProgPrivs Where 1 = 0 Union All
 Select '停嘱原因', 'SELECT' From Dual Union All
Select 对象, 权限 From zlProgPrivs Where 1 = 0) A;

--106261:李南春,2017-04-10,删除不再使用的过程
Delete from zlprogprivs where Upper(对象) = Upper('Zl_病人挂号记录_删除病历费');

--106708:冉俊明,2017-04-07,违反规范，调整
Delete From zlProgPrivs
Where 系统 = &n_System And 序号 = 1114 And 功能 = '出诊安排' And Upper(对象) = Upper('Zl_Buildregisterfixedrule');

Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1114, '出诊安排', User, 'Zl_临床出诊表_Addbyfixedrule', 'EXECUTE'
  From Dual;

Delete From zlProgPrivs
Where 系统 = &n_System And 序号 = 1114 And 功能 = '出诊安排' And Upper(对象) = Upper('Zl_Buildregisterplanbyrecord');

Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1114, '出诊安排', User, 'Zl_临床出诊表_Addbyrecord', 'EXECUTE'
  From Dual;

Delete From zlProgPrivs
Where 系统 = &n_System And 序号 = 1114 And 功能 = '出诊安排' And Upper(对象) = Upper('Zl_Buildregisterplanbytemplet');

Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1114, '出诊安排', User, 'Zl_临床出诊表_Addbytemplet', 'EXECUTE'
  From Dual;

--90953:梁经伙,2016-04-21,增加 取消他人执行完成 的权限
Insert Into zlProgFuncs
  (系统, 序号, 功能, 排列, 说明, 缺省值)
  Select &n_System, 1254, '取消他人执行完成', 31, '取消他人执行完成的操作权限。有该权限时，允许取消其他人已经执行完成的项目', 0
  From Dual;

--102816:余伟节,2017-04-05,住院一览权限脚步
Insert Into zlProgFuncs(系统,序号,功能,排列,说明,缺省值)
Select &n_System,1261,A.* From (
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0 Union All 
    Select '住院一览',15,'有该权限时，住院医生站才显示住院一览页签。',1 From Dual Union All 
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0) A;

Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1261,'住院一览',user,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select '病人医嘱报告','SELECT' From Dual Union All 
    Select '电子病历格式','SELECT' From Dual Union All 
    Select '病人护理文件','SELECT' From Dual Union All 
    Select '病历文件列表','SELECT' From Dual Union All 
    Select '病人护理数据','SELECT' From Dual Union All 
    Select '病人护理明细','SELECT' From Dual Union All 
    Select '体温记录项目','SELECT' From Dual Union All
    Select '护理汇总项目','SELECT' From Dual Union All
    Select '护理波动项目','SELECT' From Dual Union All
    Select '护理项目频次','SELECT' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--105420:陈刘,2017-04-01,体温单打印可视化修改
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1255,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All
Select 'Zl_体温单数据_Printer','EXECUTE' From Dual Union All
Select '体温单打印','SELECT' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1259,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All
Select 'Zl_体温单数据_Printer','EXECUTE' From Dual Union All
Select '体温单打印','SELECT' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1560,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All
Select 'Zl_体温单数据_Printer','EXECUTE' From Dual Union All
Select '体温单打印','SELECT' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1561,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All
Select 'Zl_体温单数据_Printer','EXECUTE' From Dual Union All
Select '体温单打印','SELECT' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--106910:刘尔旋,2017-03-30,预约天数自定义
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select  &n_System,1111,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select 'Zl_Fun_Getappointmentdays','EXECUTE' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select  &n_System,1115,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select 'Zl_Fun_Getappointmentdays','EXECUTE' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select  &n_System,9000,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select 'Zl_Fun_Getappointmentdays','EXECUTE' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--107370:李小东,2017-03-27,新版护士站-浏览检验结果，过滤该病区所有病人
Insert Into zlProgFuncs(系统,序号,功能,排列,说明,缺省值)
Select &n_System,1265,A.* From (
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0 Union All
Select '本科病人',9,'拥有该权限时浏览检验结果可过滤出该病区所有病人，无该权限时只能过滤出单个病人',1 From Dual Union All
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0) A;

--105824:廖思奇,2017-03-23,在1290 1291 中增加 报告发放 功能包括Zl_影像报告发放 执行权限 
Insert Into zlProgFuncs(系统,序号,功能,排列,说明,缺省值)
Select &n_System,1290,A.* From (
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0 Union All 
Select '报告发放',39,'诊断报告的发放',1 From Dual Union All 
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0) A;

Insert Into zlProgFuncs(系统,序号,功能,排列,说明,缺省值)
Select &n_System,1291,A.* From (
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0 Union All 
Select '报告发放',36,'诊断报告的发放',1 From Dual Union All 
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0) A;

Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select  &n_System,1290,'报告发放',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
Select 'Zl_影像报告发放','EXECUTE' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select  &n_System,1291,'报告发放',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
Select 'Zl_影像报告发放','EXECUTE' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;


--106960:胡俊勇,2017-03-20,三方LIS报告
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select  &n_System,1259,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select '医嘱报告内容','SELECT' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--91978:李小东,2017-03-17,添加设置条码打印格式权限
Insert Into zlProgFuncs
  (系统, 序号, 功能, 排列, 说明, 缺省值)
Values
  (&n_System, 1211, '设置条码打印格式', 6, '有该权限时允许用户设置条码打印格式', 0);

--106960:胡俊勇,2017-03-15,三方LIS报告
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select  &n_System,1252,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select '医嘱报告内容','SELECT' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select  &n_System,1253,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select '医嘱报告内容','SELECT' From Dual Union All 
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--104997:刘尔旋,2017-03-15,三方退款强制退现
Insert Into zlProgFuncs(系统,序号,功能,排列,说明,缺省值)
Select &n_System,1151,A.* From (
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0 Union All 
Select '三方退款强制退现',4,'主要针对三方帐户不允许退现时需要强制退成现金，如果有此权限，则允许退现，否则退款必须返回三方帐户。',0 From Dual Union All 
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0) A;

--106681:李南春,2017-03-10,调整消费卡权限
Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1503, '基本', User, '收费项目类别', 'SELECT'
  From Dual;

Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1503, '回退充值', User, 'Zl_消费卡充值记录_Cancel', 'EXECUTE'
  From Dual;

Delete From zlProgPrivs Where 系统 = &n_System And 序号 = 1503 And 功能 = '充值' And Upper(对象) = Upper('Zl_消费卡充值记录_Cancel');

--104266:冉俊明,2017-03-10,自定义临床出诊号源开放时间。
Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1114, '基本', User, 'Zl_Fun_Getappointmentdays', 'EXECUTE'
  From Dual;


--106126:余伟节,2017-03-10,分娩信息维护
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1132,'新生儿登记',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select 'Zl_分娩信息_Delete','EXECUTE' From Dual Union All 
    Select 'ZL_病人分娩信息_Insert','EXECUTE' From Dual Union All 
    Select 'ZL_新生儿诊断记录_Insert','EXECUTE' From Dual Union All  
    Select '新生儿诊断记录','SELECT' From Dual Union All 
    Select '病人分娩信息','SELECT' From Dual Union All  
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;


--103022:李业庆,2017-3-22,供应商照片
Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1025, '基本', User, 'Zl_供应商照片_Delete', 'EXECUTE'
  From Dual;

--107370:李小东,2017-03-27,新版护士站-浏览检验结果，过滤该病区所有病人
Insert Into zlRoleGrant
  (系统, 序号, 角色, 功能)
  Select Distinct 系统, 序号, 角色, '本科病人' 功能
  From zlRoleGrant A
  Where 系统 = &n_System And 序号 = 1265 And 功能 = '基本' And Not Exists
   (Select 1
         From zlRoleGrant B
         Where 系统 = &n_System And 序号 = 1265 And 功能 = '本科病人' And b.角色 = a.角色);

-------------------------------------------------------------------------------
--报表修正部份
-------------------------------------------------------------------------------






-------------------------------------------------------------------------------
--过程修正部份
-------------------------------------------------------------------------------
--107651:梁唐彬,2017-04-28,病人自动计算费用
Create Or Replace Procedure Zl_病人变动记录_Preout
(
  病人id_In   病案主页.病人id%Type,
  主页id_In   病案主页.主页id%Type,
  发生时间_In 病人变动记录.开始时间%Type
) As
  -----------------------------------------------------------
  --功能：将病人标为预出院状态，并产生一条变动
  -----------------------------------------------------------
  Cursor c_Oldinfo Is
    Select b.*
    From (Select c.*
           From 病人变动记录 C
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人变动记录
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 发生时间_In)) A, 病人变动记录 B
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位
    Union
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 发生时间_In;

  Cursor c_OldAutoinfo Is
    Select b.*
    From (Select c.*
           From 病人自动计算 C
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And C.性质 = 2 And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人自动计算
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 发生时间_In And 性质 = 2)) A, 病人自动计算 B
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位 And B.性质 = 2
    Union
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 发生时间_In And 性质 = 2;
  
  Cursor c_OldAutoHLinfo Is
    Select b.*
    From (Select c.*
           From 病人自动计算 C
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And C.性质 = 1 And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人自动计算
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 发生时间_In And 性质 = 1)) A, 病人自动计算 B
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位 And B.性质 = 1
    Union
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 发生时间_In And 性质 = 1;
  
  Cursor c_Endinfo Is
    Select * From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
  r_Oldinfo  c_Oldinfo%RowType;
  r_Endinfo  c_Endinfo%RowType;
  r_OldAutoinfo      c_OldAutoinfo%Rowtype;
  r_OldAutoHLinfo      c_OldAutoHLinfo%Rowtype;
  v_终止原因 病人变动记录.终止原因%Type;
  v_终止时间 病人变动记录.终止时间%Type;
  v_终止人员 病人变动记录.终止人员%Type;
  v_Auto变动终止原因 病人变动记录.终止原因%Type;
  v_Auto变动终止时间 病人变动记录.终止时间%Type;
  v_Auto变动终止人员 病人变动记录.终止人员%Type;
  v_AutoHL变动终止原因 病人变动记录.终止原因%Type;
  v_AutoHL变动终止时间 病人变动记录.终止时间%Type;
  v_AutoHL变动终止人员 病人变动记录.终止人员%Type;

  v_Temp     Varchar2(255);
  v_人员编号 住院费用记录.操作员编号%Type;
  v_人员姓名 住院费用记录.操作员姓名%Type;
  v_姓名     病人信息.姓名%Type;

  v_Count Number;
  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  --并发操作检查
  Select Nvl(状态, 0) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
  If v_Count <> 0 Then
    v_Error := '该病人当前正在转科或尚未入科，不能执行预出院。';
    Raise Err_Custom;
  End If;

  v_Count := Nvl(zl_GetSysParameter('特殊医嘱发送前检查未生效医嘱', 1254), 0);
  If v_Count = 1 Then
    v_姓名 := Null;
    Select Max(姓名)
    Into v_姓名
    From 病人医嘱记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 医嘱状态 = 1 And Nvl(婴儿, 0) = 0 And Rownum = 1;
    If v_姓名 Is Not Null Then
      v_Error := v_姓名 || '存在未校对的医嘱，请删除或校对后再继续。';
      Raise Err_Custom;
    End If;
  
    v_姓名 := Null;
    Select Max(姓名)
    Into v_姓名
    From 病人医嘱记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 医嘱期效 = 1 And 医嘱状态 In (2, 3) And Nvl(执行标记, 0) <> -1 And Nvl(婴儿, 0) = 0 And
          Nvl(执行性质, 0) <> 0 And Rownum = 1;
    If v_姓名 Is Not Null Then
      v_Error := v_姓名 || '存在校对后未发送的临嘱，请发送或作废后再继续。';
      Raise Err_Custom;
    End If;
  End If;

  --操作员信息
  v_Temp     := Zl_Identity;
  v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_人员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
  v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);

  Open c_Oldinfo; --必须在处理之前先打开
  Fetch c_Oldinfo
    Into r_Oldinfo;
  Open c_OldAutoinfo; --必须先打开
    Fetch c_OldAutoinfo
      Into r_OldAutoinfo;
    Open c_OldAutoHLinfo; --必须先打开
    Fetch c_OldAutoHLinfo
      Into r_OldAutoHLinfo;
  Open c_Endinfo;
  Fetch c_Endinfo
    Into r_Endinfo;
  If c_Endinfo%RowCount = 0 Then
    Close c_Endinfo;
    v_Error := '未发现该病人当前有效的变动记录！';
    Raise Err_Custom;
  End If;

  --取消上次变动
  If r_Oldinfo.终止时间 Is Not Null Then
    v_终止时间 := r_Oldinfo.终止时间;
    v_终止原因 := r_Oldinfo.终止原因;
    v_终止人员 := r_Oldinfo.终止人员;
    --取消上次变动
    Update 病人变动记录
    Set 终止时间 = 发生时间_In, 终止原因 = 10, 终止人员 = v_人员姓名, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因 = v_终止原因;
  Else
    Update 病人变动记录
    Set 终止时间 = 发生时间_In, 终止原因 = 10, 终止人员 = v_人员姓名, 上次计算时间 = Decode(Sign(Nvl(上次计算时间, 发生时间_In) - 发生时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
  End If;
  --更新将来的记录如果有停止到将来的则删除上次计算时间
  Update 病人变动记录
  Set 上次计算时间 = Null
  Where 病人id = 病人id_In And 主页id = 主页id_In And (开始时间 > 发生时间_In Or Trunc(上次计算时间) = Trunc(发生时间_In));
  
  --床位自动计算
  If r_OldAutoinfo.终止时间 Is Not Null Then
    v_Auto变动终止时间 := r_OldAutoinfo.终止时间;
    v_Auto变动终止原因 := r_OldAutoinfo.终止原因;
    v_Auto变动终止人员 := r_OldAutoinfo.终止人员;
    --取消上次变动
    Update 病人自动计算
    Set 终止时间 = 发生时间_In, 终止原因 = 10, 终止人员 = v_人员姓名, 上次计算时间 = Null 
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_Auto变动终止时间 And 终止原因 = v_Auto变动终止原因 and 性质 IN(2,3);
  Else
    Update 病人自动计算
    Set 终止时间 = 发生时间_In, 终止原因 = 10, 终止人员 = v_人员姓名, 上次计算时间 = Decode(Sign(Nvl(上次计算时间, 发生时间_In) - 发生时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null and 性质 IN(2,3);
  End If;
  --更新将来的记录如果有停止到将来的则删除上次计算时间
  Update 病人自动计算
  Set 上次计算时间 = Null
  Where 病人id = 病人id_In And 主页id = 主页id_In And (开始时间 > 发生时间_In Or Trunc(上次计算时间) = Trunc(发生时间_In)) and 性质 IN(2,3);
  
  --护理自动计算
  If r_OldAutoHLinfo.终止时间 Is Not Null Then
    v_AutoHL变动终止时间 := r_OldAutoHLinfo.终止时间;
    v_AutoHL变动终止原因 := r_OldAutoHLinfo.终止原因;
    v_AutoHL变动终止人员 := r_OldAutoHLinfo.终止人员;
    --取消上次变动
    Update 病人自动计算
    Set 终止时间 = 发生时间_In, 终止原因 = 10, 终止人员 = v_人员姓名, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_AutoHL变动终止时间 And 终止原因 = v_AutoHL变动终止原因 and 性质 = 1;
  Else
    Update 病人自动计算
    Set 终止时间 = 发生时间_In, 终止原因 = 10, 终止人员 = v_人员姓名, 上次计算时间 = Decode(Sign(Nvl(上次计算时间, 发生时间_In) - 发生时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null and 性质 = 1;
  End If;
  --更新将来的记录如果有停止到将来的则删除上次计算时间
  Update 病人自动计算
  Set 上次计算时间 = Null
  Where 病人id = 病人id_In And 主页id = 主页id_In And (开始时间 > 发生时间_In Or Trunc(上次计算时间) = Trunc(发生时间_In)) and 性质 = 1;
  
  
  --产生新变动
  While c_Oldinfo%Found Loop
    Insert Into 病人变动记录
      (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 发生时间_In, 10, r_Oldinfo.附加床位, r_Oldinfo.病区id, r_Oldinfo.科室id,
       r_Oldinfo.医疗小组id, r_Oldinfo.护理等级id, r_Oldinfo.床位等级id, r_Oldinfo.床号, r_Oldinfo.责任护士, r_Oldinfo.经治医师,
       r_Oldinfo.主治医师, r_Oldinfo.主任医师, r_Oldinfo.病情, v_人员编号, v_人员姓名, v_终止时间, v_终止原因, v_终止人员);
    If Nvl(r_Oldinfo.附加床位, 0) = 0 Then
      --产生病历书写时机
      Zl_电子病历时机_Insert(病人id_In, 主页id_In, 2, '出院', r_Oldinfo.科室id, r_Oldinfo.经治医师, 发生时间_In, 发生时间_In);
    End If;
    Fetch c_Oldinfo
      Into r_Oldinfo;
  End Loop;   
  
  --产生床位其他自动计算
  While c_OldAutoinfo%Found Loop
    Insert Into 病人自动计算
      (ID, 病人id, 主页id, 开始时间, 开始原因,性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 发生时间_In, 10, 2, r_OldAutoinfo.附加床位, r_OldAutoinfo.病区id, r_OldAutoinfo.科室id,
       r_OldAutoinfo.床位等级id, r_OldAutoinfo.床号, v_人员编号, v_人员姓名, v_Auto变动终止时间, v_Auto变动终止原因, v_Auto变动终止人员);
    
    Insert Into 病人自动计算
      (ID, 病人id, 主页id, 开始时间, 开始原因,性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 发生时间_In, 10, 3, r_OldAutoinfo.附加床位, r_OldAutoinfo.病区id, r_OldAutoinfo.科室id,
       r_OldAutoinfo.床位等级id, r_OldAutoinfo.床号, v_人员编号, v_人员姓名, v_Auto变动终止时间, v_Auto变动终止原因, v_Auto变动终止人员);
    
    Fetch c_OldAutoinfo
      Into r_OldAutoinfo;
  End Loop;  
  
  --产生护理自动计算
  While c_OldAutoHLinfo%Found Loop
    Insert Into 病人自动计算
      (ID, 病人id, 主页id, 开始时间, 开始原因,性质, 病区id, 科室id, 护理等级id, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 发生时间_In, 10, 1, r_OldAutoHLinfo.病区id, r_OldAutoHLinfo.科室id,
       r_OldAutoHLinfo.护理等级id, v_人员编号, v_人员姓名, v_AutoHL变动终止时间, v_AutoHL变动终止原因, v_AutoHL变动终止人员);
    Fetch c_OldAutoHLinfo
      Into r_OldAutoHLinfo;
  End Loop;                    

  Close c_Oldinfo;
  Close c_OldAutoinfo;
  Close c_OldAutoHLinfo;
  Close c_Endinfo;

  Update 病案主页 Set 状态 = 3 Where 病人id = 病人id_In And 主页id = 主页id_In;

  --并发操作检查
  Select Count(*)
  Into v_Count
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(附加床位, 0) = 0 And 开始时间 Is Not Null And 终止时间 Is Null;
  If v_Count > 1 Then
    v_Error := '发现病人存在非法的变动记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 出院日期 Is Null;
  If v_Count = 0 Then
    v_Error := '操作失败,该病人已出院,不能进行当前操作.' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态！';
    Raise Err_Custom;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人变动记录_Preout;
/

--108251:刘尔旋,2017-04-27,产生划价单的挂号单退号处理
Create Or Replace Procedure Zl_Third_Registdelcheck
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:HIS退号检查
  --入参:Xml_In:
  --<IN>
  --  <GHDH>A000001</GHDH>    //挂号单号
  --  <JSKLB>支付宝</JSKLB>      //结算卡类别
  --  <JCFP>1</JCFP>            //检查发票
  --  <GHJE>20</GHJE>            //挂号金额
  --  <LSH>34563</LSH>           //交易流水号
  --  <JKFS>0</JKFS>             //缴款方式,0-挂号或预约缴款;1-预约不缴款
  --  <YYFS></YYFS>              //缴款方式=1时传入，预约的预约方式
  --  <XL></XL>                  //险类
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  -- <ERROR><MSG></MSG></ERROR> //为空表示检查成功
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_卡类别     Varchar2(100);
  v_No         病人挂号记录.No%Type;
  n_挂号金额   门诊费用记录.实收金额%Type;
  v_操作员编号 门诊费用记录.操作员编号%Type;
  v_操作员姓名 门诊费用记录.操作员姓名%Type;
  v_结算方式   医疗卡类别.结算方式%Type;
  n_实收金额   门诊费用记录.实收金额%Type;
  v_交易流水号 病人预交记录.交易流水号%Type;
  n_存在       Number(3);
  v_Type       Varchar2(50);
  v_Temp       Varchar2(32767); --临时XML
  x_Templet    Xmltype; --模板XML
  v_Err_Msg    Varchar2(200);
  n_已开医嘱   Number(2);
  n_检查发票   Number(3);
  n_是否打印   Number(3);
  n_缴款方式   Number(3);
  n_险类       病人信息.险类%Type;
  v_预约方式   病人挂号记录.预约方式%Type;
  v_收费单     门诊费用记录.No%Type;
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/GHDH'), Extractvalue(Value(A), 'IN/JSKLB'), Extractvalue(Value(A), 'IN/GHJE'),
         Extractvalue(Value(A), 'IN/LSH'), To_Number(Extractvalue(Value(A), 'IN/JCFP')),
         To_Number(Extractvalue(Value(A), 'IN/JKFS')), Extractvalue(Value(A), 'IN/YYFS'),
         To_Number(Extractvalue(Value(A), 'IN/XL'))
  Into v_No, v_卡类别, n_挂号金额, v_交易流水号, n_检查发票, n_缴款方式, v_预约方式, n_险类
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Max(收费单) Into v_收费单 From 病人挂号记录 Where NO = v_No;

  n_缴款方式 := Nvl(n_缴款方式, 0);

  If v_卡类别 Is Not Null And n_缴款方式 = 0 Then
    Select Nvl2(Translate(v_卡类别, '\1234567890', '\'), 'Char', 'Num') Into v_Type From Dual;
    If v_Type = 'Num' Then
      --传入的是卡类别ID
      Select 结算方式 Into v_结算方式 From 医疗卡类别 Where ID = To_Number(v_卡类别);
    Else
      --传入的是卡类别名称
      Select 结算方式 Into v_结算方式 From 医疗卡类别 Where 名称 = v_卡类别;
    End If;
    If Nvl(n_缴款方式, 0) = 0 Then
      If Nvl(n_险类, 0) = 0 Then
        Select Nvl(Max(1), 0)
        Into n_存在
        From 病人预交记录 A,
             (Select Distinct 结帐id
               From 门诊费用记录
               Where NO = v_No And 记录性质 = 4
               Union
               Select Distinct 结帐id
               From 住院费用记录
               Where NO = v_No And 记录性质 = 5
               Union
               Select Distinct 结帐id
               From 门诊费用记录
               Where NO = v_收费单 And 记录性质 = 1) B
        Where a.结帐id = b.结帐id And 结算方式 <> v_结算方式 And Mod(记录性质, 10) <> 1 And Rownum < 2;
      Else
        Select Nvl(Max(1), 0)
        Into n_存在
        From 病人预交记录 A,
             (Select Distinct 结帐id
               From 门诊费用记录
               Where NO = v_No And 记录性质 = 4
               Union
               Select Distinct 结帐id
               From 住院费用记录
               Where NO = v_No And 记录性质 = 5
               Union
               Select Distinct 结帐id
               From 门诊费用记录
               Where NO = v_收费单 And 记录性质 = 1) B, 结算方式 C
        Where a.结帐id = b.结帐id And 结算方式 <> v_结算方式 And Mod(记录性质, 10) <> 1 And a.结算方式 = c.名称 And c.性质 Not In (3, 4) And
              Rownum < 2;
        If n_存在 = 0 Then
          Select Nvl(Max(1), 0)
          Into n_存在
          From 保险结算记录 A,
               (Select Distinct 结帐id
                 From 门诊费用记录
                 Where NO = v_No And 记录性质 = 4
                 Union
                 Select Distinct 结帐id
                 From 住院费用记录
                 Where NO = v_No And 记录性质 = 5
                 Union
                 Select Distinct 结帐id
                 From 门诊费用记录
                 Where NO = v_收费单 And 记录性质 = 1) B
          Where a.记录id = b.结帐id And 险类 <> n_险类 And Rownum < 2;
        End If;
      End If;
      If n_存在 = 1 Then
        v_Err_Msg := '传入的挂号单据包含' || v_结算方式 || '以外的结算方式,无法退号!';
        Raise Err_Item;
      End If;
    Else
      Begin
        Select 1 Into n_存在 From 病人挂号记录 A Where a.No = v_No And a.预约方式 = v_预约方式 And Rownum < 2;
      Exception
        When Others Then
          n_存在 := 0;
      End;
      If n_存在 = 0 Then
        v_Err_Msg := '传入的挂号单据不是' || v_预约方式 || '预约的,无法退号!';
        Raise Err_Item;
      End If;
    End If;
  End If;

  If n_缴款方式 = 0 Then
    If v_收费单 Is Null Then
      Select Sum(实收金额) Into n_实收金额 From 门诊费用记录 Where NO = v_No And 记录性质 = 4;
    Else
      Select Sum(实收金额) Into n_实收金额 From 门诊费用记录 Where NO = v_收费单 And 记录性质 = 1;
    End If;
    If n_实收金额 <> n_挂号金额 Then
      v_Err_Msg := '传入的退款金额与实际挂号金额不符，请检查!';
      Raise Err_Item;
    End If;
  End If;

  --补充结算检查，已存在补结算数据的，不能退号
  Begin
    Select 1
    Into n_存在
    From 费用补充记录 A,
         (Select Distinct 结帐id
           From 门诊费用记录
           Where NO = v_No And 记录性质 = 4
           Union
           Select Distinct 结帐id
           From 住院费用记录
           Where NO = v_No And 记录性质 = 5
           Union
           Select Distinct 结帐id
           From 门诊费用记录
           Where NO = v_收费单 And 记录性质 = 1) B
    Where a.收费结帐id = b.结帐id And a.记录性质 = 1 And a.附加标志 = 1 And Nvl(a.费用状态, 0) <> 2 And Rownum < 2;
  Exception
    When Others Then
      n_存在 := 0;
  End;
  If n_存在 = 1 Then
    v_Err_Msg := '传入的挂号单据已经进行了二次结算,无法退号!';
    Raise Err_Item;
  End If;
  --医嘱检查，已经开过医嘱的，不能退号
  Begin
    Select Distinct 1 Into n_已开医嘱 From 病人医嘱记录 Where 挂号单 = v_No;
  Exception
    When Others Then
      n_已开医嘱 := 0;
  End;
  If n_已开医嘱 = 1 Then
    v_Err_Msg := '传入的挂号单据已经开过医嘱,无法退号!';
    Raise Err_Item;
  End If;
  If Nvl(n_检查发票, 0) = 1 Then
    Select Max(Decode(a.实际票号, Null, 0, 1)) Into n_是否打印 From 门诊费用记录 A Where NO = v_No And 记录性质 = 4;
    If Nvl(n_是否打印, 0) = 1 Then
      v_Err_Msg := '本次退号的单据已开发票,不能退费!';
      Raise Err_Item;
    End If;
    Select Max(Decode(a.实际票号, Null, 0, 1))
    Into n_是否打印
    From 门诊费用记录 A
    Where NO = v_收费单 And 记录性质 = 1;
    If Nvl(n_是否打印, 0) = 1 Then
      v_Err_Msg := '本次退号的单据已开发票,不能退费!';
      Raise Err_Item;
    End If;
  End If;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Registdelcheck;
/

--108251:刘尔旋,2017-04-27,产生划价单的挂号单处理
Create Or Replace Procedure Zl_Third_Registdel
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:HIS退号
  --入参:Xml_In:
  --<IN>
  --  <GHDH>A000001</GHDH>    //挂号单号
  --  <JSKLB>支付宝</JSKLB>      //结算卡类别
  --  <JCFP>1</JCFP>            //检查发票
  --  <GHJE>20</GHJE>            //挂号金额
  --  <LSH>34563</LSH>           //交易流水号
  --  <JKFS>0</JKFS>             //缴款方式,0-挂号或预约缴款;1-预约不缴款
  --  <YYFS></YYFS>              //缴款方式=1时传入，预约的预约方式
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  -- <CZSJ>操作时间</CZSJ>          //HIS的登记时间
  -- <YJZID>原结帐ID</YJZID>
  -- <CXID>冲销ID</CXID>
  -- <ERROR><MSG></MSG></ERROR> //为空表示取消挂号成功
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_卡类别     Varchar2(100);
  v_No         病人挂号记录.No%Type;
  n_挂号金额   门诊费用记录.实收金额%Type;
  v_操作员编号 门诊费用记录.操作员编号%Type;
  v_操作员姓名 门诊费用记录.操作员姓名%Type;
  v_结算方式   医疗卡类别.结算方式%Type;
  n_实收金额   门诊费用记录.实收金额%Type;
  v_交易流水号 病人预交记录.交易流水号%Type;
  n_存在       Number(3);
  v_Type       Varchar2(50);
  v_Temp       Varchar2(32767); --临时XML
  x_Templet    Xmltype; --模板XML
  v_Err_Msg    Varchar2(200);
  n_已开医嘱   Number(2);
  n_检查发票   Number(3);
  n_是否打印   Number(3);
  n_缴款方式   Number(3);
  n_结帐id     门诊费用记录.结帐id%Type;
  n_冲销id     门诊费用记录.结帐id%Type;
  d_登记时间   Date;
  v_预约方式   病人挂号记录.预约方式%Type;
  v_收费单     门诊费用记录.No%Type;
  n_记录状态   门诊费用记录.记录状态%Type;
  n_病人id     门诊费用记录.病人id%Type;
  n_卡类别id   医疗卡类别.Id%Type;
  v_退费结算   Varchar2(1000);
  Err_Item Exception;

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/GHDH'), Extractvalue(Value(A), 'IN/JSKLB'), Extractvalue(Value(A), 'IN/GHJE'),
         Extractvalue(Value(A), 'IN/LSH'), To_Number(Extractvalue(Value(A), 'IN/JCFP')),
         To_Number(Extractvalue(Value(A), 'IN/JKFS')), Extractvalue(Value(A), 'IN/YYFS')
  Into v_No, v_卡类别, n_挂号金额, v_交易流水号, n_检查发票, n_缴款方式, v_预约方式
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  Select Max(收费单) Into v_收费单 From 病人挂号记录 Where NO = v_No;

  n_缴款方式 := Nvl(n_缴款方式, 0);

  If n_缴款方式 = 1 Then
    Begin
      Select 1 Into n_存在 From 门诊费用记录 Where NO = v_No And 记录性质 = 4 And 结帐id Is Not Null And Rownum < 2;
      Select 1
      Into n_存在
      From 门诊费用记录
      Where NO = v_收费单 And 记录性质 = 1 And 结帐id Is Not Null And Rownum < 2;
    Exception
      When Others Then
        n_存在 := 0;
    End;
    If n_存在 = 1 Then
      v_Err_Msg := '传入的挂号单据不是预约挂号单,无法取消预约!';
      Raise Err_Item;
    End If;
    Begin
      Select 1 Into n_存在 From 病人挂号记录 A Where a.No = v_No And a.预约方式 = v_预约方式 And Rownum < 2;
    Exception
      When Others Then
        n_存在 := 0;
    End;
    If n_存在 = 0 Then
      v_Err_Msg := '传入的挂号单据不是' || v_预约方式 || '预约的,无法取消预约!';
      Raise Err_Item;
    End If;
  End If;

  If v_卡类别 Is Not Null And n_缴款方式 = 0 Then
    Select Nvl2(Translate(v_卡类别, '\1234567890', '\'), 'Char', 'Num') Into v_Type From Dual;
    If v_Type = 'Num' Then
      --传入的是卡类别ID
      Select 结算方式, ID Into v_结算方式, n_卡类别id From 医疗卡类别 Where ID = To_Number(v_卡类别);
    Else
      --传入的是卡类别名称
      Select 结算方式, ID Into v_结算方式, n_卡类别id From 医疗卡类别 Where 名称 = v_卡类别;
    End If;
  
    Select Sum(实收金额) Into n_实收金额 From 门诊费用记录 Where NO = v_No And 记录性质 = 4;
  
    If Nvl(n_缴款方式, 0) = 0 Then
      --要退的单据不是以该结算卡结算的，则禁止退号
      Begin
        Select 1
        Into n_存在
        From 病人预交记录 A,
             (Select Distinct 结帐id
               From 门诊费用记录
               Where NO = v_No And 记录性质 = 4
               Union
               Select Distinct 结帐id
               From 住院费用记录
               Where NO = v_No And 记录性质 = 5
               Union
               Select Distinct 结帐id
               From 门诊费用记录
               Where NO = v_收费单 And 记录性质 = 1) B
        Where a.结帐id = b.结帐id And 结算方式 = v_结算方式 And Rownum < 2;
      Exception
        When Others Then
          n_存在 := 0;
      End;
      If n_存在 = 0 Then
        v_Err_Msg := '传入的挂号单据不是' || v_结算方式 || '结算的,无法退号!';
        Raise Err_Item;
      End If;
    End If;
  End If;

  --补充结算检查，已存在补结算数据的，不能退号
  Begin
    Select 1
    Into n_存在
    From 费用补充记录 A,
         (Select Distinct 结帐id
           From 门诊费用记录
           Where NO = v_No And 记录性质 = 4
           Union
           Select Distinct 结帐id
           From 住院费用记录
           Where NO = v_No And 记录性质 = 5
           Union
           Select Distinct 结帐id
           From 门诊费用记录
           Where NO = v_收费单 And 记录性质 = 1) B
    Where a.收费结帐id = b.结帐id And a.记录性质 = 1 And a.附加标志 = 1 And Nvl(a.费用状态, 0) <> 2 And Rownum < 2;
  Exception
    When Others Then
      n_存在 := 0;
  End;
  If n_存在 = 1 Then
    v_Err_Msg := '传入的挂号单据已经进行了二次结算,无法退号!';
    Raise Err_Item;
  End If;
  --医嘱检查，已经开过医嘱的，不能退号
  Begin
    Select Distinct 1 Into n_已开医嘱 From 病人医嘱记录 Where 挂号单 = v_No;
  Exception
    When Others Then
      n_已开医嘱 := 0;
  End;
  If n_已开医嘱 = 1 Then
    v_Err_Msg := '传入的挂号单据已经开过医嘱,无法退号!';
    Raise Err_Item;
  End If;
  If Nvl(n_检查发票, 0) = 1 Then
    Select Max(Decode(a.实际票号, Null, 0, 1)) Into n_是否打印 From 门诊费用记录 A Where NO = v_No And 记录性质 = 4;
    If Nvl(n_是否打印, 0) = 1 Then
      v_Err_Msg := '本次退号的单据已开发票,不能退费!';
      Raise Err_Item;
    End If;
    Select Max(Decode(a.实际票号, Null, 0, 1))
    Into n_是否打印
    From 门诊费用记录 A
    Where NO = v_收费单 And 记录性质 = 1;
    If Nvl(n_是否打印, 0) = 1 Then
      v_Err_Msg := '本次退号的单据已开发票,不能退费!';
      Raise Err_Item;
    End If;
  End If;
  --获取操作员信息
  v_Temp := Zl_Identity(1);
  Select Substr(v_Temp, Instr(v_Temp, ',') + 1) Into v_Temp From Dual;
  Select Substr(v_Temp, 0, Instr(v_Temp, ',') - 1) Into v_操作员编号 From Dual;
  Select Substr(v_Temp, Instr(v_Temp, ',') + 1) Into v_操作员姓名 From Dual;
  d_登记时间 := Sysdate;

  Zl_三方机构挂号_Delete(v_No, v_交易流水号, '移动平台退号', d_登记时间);

  --同步处理划价单
  If v_收费单 Is Not Null Then
    Select Max(记录状态), Max(病人id) Into n_记录状态, n_病人id From 门诊费用记录 Where NO = v_收费单 And 记录性质 = 1;
    If n_记录状态 = 0 Then
      Zl_门诊划价记录_Delete(v_收费单);
    End If;
    If n_记录状态 = 1 Then
      If v_结算方式 Is Null Then
        v_Err_Msg := '本次挂号单据退款失败,请检查!';
        Raise Err_Item;
      End If;
      Select 病人结帐记录_Id.Nextval Into n_冲销id From Dual;
      Zl_门诊收费记录_销帐(v_收费单, v_操作员编号, v_操作员姓名, Null, d_登记时间, Null, n_冲销id);
    
      v_退费结算 := v_结算方式 || '|' || -1 * n_挂号金额 || '|' || ' |' || ' ';
      Zl_门诊退费结算_Modify(2, n_病人id, n_冲销id, v_退费结算, 0, n_卡类别id, Null, v_交易流水号, Null, 0, 0, 0, 2);
    End If;
  End If;

  If v_收费单 Is Null Then
    Select Max(结帐id) Into n_结帐id From 门诊费用记录 Where NO = v_No And 记录性质 = 4 And 记录状态 = 3;
    Select Max(结帐id) Into n_冲销id From 门诊费用记录 Where NO = v_No And 记录性质 = 4 And 记录状态 = 2;
  Else
    Select Max(结帐id) Into n_结帐id From 门诊费用记录 Where NO = v_收费单 And 记录性质 = 1 And 记录状态 = 3;
    Select Max(结帐id) Into n_冲销id From 门诊费用记录 Where NO = v_收费单 And 记录性质 = 1 And 记录状态 = 2;
  End If;

  v_Temp := '<CZSJ>' || To_Char(d_登记时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<YJZID>' || n_结帐id || '</YJZID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<CXID>' || n_冲销id || '</CXID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Registdel;
/

--108594:刘尔旋,2017-04-25,门诊转住院单张单据退费问题
Create Or Replace Procedure Zl_门诊转住院_收费转出
(
  No_In         住院费用记录.No%Type,
  操作员编号_In 住院费用记录.操作员编号%Type,
  操作员姓名_In 住院费用记录.操作员姓名%Type,
  退费时间_In   住院费用记录.发生时间%Type,
  门诊退费_In   Number := 0,
  入院科室id_In 住院费用记录.开单部门id%Type := Null,
  主页id_In     住院费用记录.主页id%Type := Null,
  结算方式_In   病人预交记录.结算方式%Type := Null,
  结帐id_In     病人预交记录.结帐id%Type := Null,
  原结帐id_In   病人预交记录.结帐id%Type := Null,
  误差费_In     病人预交记录.冲预交%Type := Null
) As
  --门诊退费_In:0-门诊转住院立即销帐;1-门诊退费模式
  -- 门诊退费_In为1时:入院科室id_In和主页ID_IN可以不传入
  n_Count      Number(5);
  n_原结帐id   住院费用记录.结帐id%Type;
  n_实收金额   门诊费用记录.实收金额%Type;
  n_预交使用额 病人预交记录.冲预交%Type;
  n_实际冲销   病人预交记录.冲预交%Type;
  n_组id       财务缴款分组.Id%Type;
  n_病人id     病人信息.病人id%Type;
  v_预交no     病人预交记录.No%Type;
  n_预交金额   病人预交记录.冲预交%Type;
  n_打印id     票据使用明细.打印id%Type;
  n_开单部门id 住院费用记录.开单部门id%Type;
  v_开单人     门诊费用记录.开单人%Type;
  n_结帐id     门诊费用记录.结帐id%Type;
  n_误差费     病人预交记录.冲预交%Type;
  v_误差费     结算方式.名称%Type;
  n_返回值     病人余额.费用余额%Type;
  v_结算方式   结算方式.名称%Type;
  v_Nos        Varchar2(3000);
  v_结帐ids    Varchar2(3000);
  v_原结帐ids  Varchar2(3000);
  n_Tempid     病人预交记录.Id%Type;
  n_预交id     病人预交记录.Id%Type;
  n_医保       Number;
  n_存在       Number;
  n_退现       Number;
  n_部分退费   Number;
  n_退费条数   Number;
  n_异常标志   Number;
  n_计算误差   Number;
  n_费用状态   门诊费用记录.费用状态%Type;

  Err_Item Exception;
  v_Err_Msg Varchar2(200);

  Procedure Zl_Square_Update
  (
    结帐ids_In    Varchar2,
    现结帐id_In   病人预交记录.结帐id%Type,
    缴款组id_In   病人预交记录.缴款组id%Type,
    退款时间_In   病人预交记录.收款时间%Type,
    结算序号_In   病人预交记录.结算序号%Type,
    结算内容_In   Varchar2 := Null,
    退费金额_In   病人预交记录.冲预交%Type := Null,
    结算卡序号_In 病人预交记录.结算卡序号%Type := Null
  ) As
    n_记录状态 病人卡结算记录.记录状态%Type;
    n_预交id   病人预交记录.Id%Type;
    v_卡号     病人卡结算记录.卡号%Type;
    n_存在卡片 Number;
    d_停用日期 消费卡目录.停用日期%Type;
    n_最大序号 病人卡结算记录.序号%Type;
    n_序号     病人卡结算记录.序号%Type;
    n_余额     消费卡目录.余额%Type;
    n_接口编号 病人卡结算记录.接口编号%Type;
    d_回收时间 消费卡目录.回收时间%Type;
    n_Id       病人预交记录.Id%Type;
  Begin
    n_预交id := 0;
  
    --处理消费卡,结算卡在上面就已经处理了
    For v_校对 In (Select Min(a.Id) As 预交id, c.消费卡id, Sum(c.结算金额) As 结算金额, c.接口编号, c.卡号, Max(c.序号) As 序号, Max(c.Id) As ID
                 From 病人预交记录 A, 病人卡结算对照 B, 病人卡结算记录 C
                 Where a.Id = b.预交id And a.结算卡序号 = 结算卡序号_In And b.卡结算id = c.Id And a.记录性质 = 3 And
                       Instr(Nvl(结算内容_In, '_LXH'), ',' || a.结算方式 || ',') = 0 And
                       a.结帐id In (Select Column_Value From Table(f_Str2list(结帐ids_In)))
                 Group By c.消费卡id, c.接口编号, c.卡号) Loop
    
      If Nvl(v_校对.消费卡id, 0) <> 0 Then
        Select Max(记录状态)
        Into n_记录状态
        From 病人卡结算记录
        Where 接口编号 = v_校对.接口编号 And 消费卡id = Nvl(v_校对.消费卡id, 0) And 卡号 = v_校对.卡号 And Nvl(序号, 0) = Nvl(v_校对.序号, 0);
      Else
        Select Max(记录状态)
        Into n_记录状态
        From 病人卡结算记录
        Where 接口编号 = v_校对.接口编号 And 消费卡id Is Null And 卡号 = v_校对.卡号 And Nvl(序号, 0) = Nvl(v_校对.序号, 0);
      End If;
    
      If n_记录状态 = 1 Then
        n_记录状态 := 2;
      Else
        n_记录状态 := n_记录状态 + 2;
      End If;
      --多条时,只更新一条
      If n_预交id = 0 Then
        Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id,
           预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质)
          Select n_预交id, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, 退款时间_In, 缴款单位, 单位开户行, 单位帐号, 操作员编号_In, 操作员姓名_In,
                 -1 * 退费金额_In, 现结帐id_In, 缴款组id_In, 预交类别, 卡类别id, Nvl(结算卡序号, v_校对.接口编号), 卡号, 交易流水号, 交易说明, 合作单位, 2, 结算序号_In,
                 结算性质
          From 病人预交记录 A
          Where ID = v_校对.预交id;
      End If;
    
      If Nvl(v_校对.消费卡id, 0) <> 0 Then
        --消费卡,直接退回卡数据中
        Begin
          Select 卡号, 1, 停用日期, (Select Max(序号) From 消费卡目录 B Where a.卡号 = b.卡号 And a.接口编号 = b.接口编号), 序号, 余额, 接口编号, 回收时间
          Into v_卡号, n_存在卡片, d_停用日期, n_最大序号, n_序号, n_余额, n_接口编号, d_回收时间
          From 消费卡目录 A
          Where ID = v_校对.消费卡id;
        Exception
          When Others Then
            n_存在卡片 := 0;
        End;
      
        --取消停用
        If n_存在卡片 = 0 Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡被他人删除，不能再启用该卡片,请检查！';
          Raise Err_Item;
        End If;
        If Nvl(n_序号, 0) < Nvl(n_最大序号, 0) Then
          v_Err_Msg := '不能启用历史发卡记录(卡号为"' || v_卡号 || '"),请检查！';
          Raise Err_Item;
        End If;
        If Nvl(d_停用日期, To_Date('3000-01-01', 'yyyy-mm-dd')) < To_Date('3000-01-01', 'yyyy-mm-dd') Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡已经被他人停用，不能再进行退费,请检查！';
          Raise Err_Item;
        End If;
      
        If d_回收时间 < To_Date('3000-01-01', 'yyyy-mm-dd') Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡已经回收，不能退费,请检查！';
          Raise Err_Item;
        End If;
        Update 消费卡目录 Set 余额 = Nvl(余额, 0) + 退费金额_In Where ID = Nvl(v_校对.消费卡id, 0);
      End If;
    
      Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
      Insert Into 病人卡结算记录
        (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
        Select n_Id, 接口编号, 消费卡id, 序号, n_记录状态, 结算方式, -1 * 退费金额_In, 卡号, 交易流水号, 交易时间, 备注,
               Decode(消费卡id, Null, 0, 0, 0, 1) As 标志
        From 病人卡结算记录
        Where ID = v_校对.Id;
      Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
    
      If n_记录状态 <> 2 And n_记录状态 <> 1 Then
        Update 病人卡结算记录 Set 记录状态 = 3 Where ID = v_校对.Id;
      End If;
    End Loop;
  End;
Begin
  n_组id := Zl_Get组id(操作员姓名_In);
  --误差费
  Begin
    Select 名称 Into v_误差费 From 结算方式 Where 性质 = 9 And Rownum < 2;
  Exception
    When Others Then
      v_Err_Msg := '没有发现误差结算方式，请检查是否正确设置！';
      Raise Err_Item;
  End;

  If 原结帐id_In Is Null Then
  
    Select Count(NO), Sum(实收金额) Into n_Count, n_实收金额 From 门诊费用记录 Where NO = No_In And Mod(记录性质,10) = 1;
    If n_Count = 0 Or n_实收金额 = 0 Then
      v_Err_Msg := '单据' || No_In || '不是收费单据或因并发原因他人操作了该单据,不能转为住院费用.';
      Raise Err_Item;
    End If;
  
    Select 结帐id, 病人id, 开单部门id, 开单人
    Into n_原结帐id, n_病人id, n_开单部门id, v_开单人
    From 门诊费用记录
    Where NO = No_In And Mod(记录性质,10) = 1 And 记录状态 In (1, 3) And Rownum < 2;
  
    --1.1作废费用记录
    If 结帐id_In Is Null Then
      Select 病人结帐记录_Id.Nextval Into n_结帐id From Dual;
    Else
      n_结帐id := 结帐id_In;
    End If;
  
    Insert Into 门诊费用记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 姓名, 性别, 年龄, 标识号, 付款方式, 费别, 病人科室id, 收费类别, 收费细目id,
       计算单位, 付数, 发药窗口, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人, 执行状态, 执行时间,
       操作员编号, 操作员姓名, 发生时间, 登记时间, 结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 缴款组id, 费用状态)
      Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 姓名, 性别, 年龄, 标识号, 付款方式, 费别, 病人科室id,
             收费类别, 收费细目id, 计算单位, 付数, 发药窗口, -1 * 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价, -1 * 应收金额, -1 * 实收金额, 开单部门id,
             开单人, 执行部门id, 划价人, 执行人, -1, 执行时间, 操作员编号_In, 操作员姓名_In, 发生时间, 退费时间_In, n_结帐id, -1 * 结帐金额, 保险项目否, 保险大类id, 统筹金额,
             摘要, Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, n_组id, 0
      From 门诊费用记录
      Where NO = No_In And Mod(记录性质,10) = 1 And 记录状态 = 1;
  
    --Update 门诊费用记录 Set 记录状态 = 3 Where NO = No_In And 记录性质 = 1 And 记录状态 = 1;
  
    --1.2作废预交记录
    --作废冲预交部分
    For r_结账id In (Select Distinct 结帐id
                   From 门诊费用记录
                   Where NO In (Select Distinct NO
                                From 门诊费用记录
                                Where 结帐id In (Select 结帐id
                                               From 病人预交记录
                                               Where 结算序号 In (Select b.结算序号
                                                              From 门诊费用记录 A, 病人预交记录 B
                                                              Where a.No = No_In And b.结算序号 < 0 And Mod(a.记录性质, 10) = 1 And
                                                                    a.记录状态 <> 0 And a.结帐id = b.结帐id))) And
                         Mod(记录性质, 10) = 1 And 记录状态 <> 0
                   Union
                   Select Distinct 结帐id
                   From 门诊费用记录
                   Where NO In (Select Distinct NO
                                From 门诊费用记录
                                Where 结帐id In (Select a.结帐id
                                               From 门诊费用记录 A, 病人预交记录 B
                                               Where a.No = No_In And b.结算序号 > 0 And Mod(a.记录性质, 10) = 1 And a.记录状态 <> 0 And
                                                     a.结帐id = b.结帐id)) And Mod(记录性质, 10) = 1 And 记录状态 <> 0) Loop
      v_原结帐ids := v_原结帐ids || ',' || r_结账id.结帐id;
    End Loop;
    v_原结帐ids := Substr(v_原结帐ids, 2);
  
    Begin
      Select 1
      Into n_医保
      From 保险结算记录
      Where 记录id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And Rownum < 2;
    Exception
      When Others Then
        n_医保 := 0;
    End;
  
    If n_医保 = 1 Then
      Begin
        Select 1
        Into n_存在
        From 医保结算明细
        Where NO = No_In And 结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And Rownum < 2;
      Exception
        When Others Then
          v_Err_Msg := '当前单据' || No_In || '不存在医保结算明细,无法进行门诊转住院!';
          Raise Err_Item;
      End;
    End If;
  
    --医保退款
    For r_医保 In (Select 结帐id, NO, 结算方式, 金额, 备注
                 From 医保结算明细
                 Where NO = No_In And 结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids)))) Loop
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) - r_医保.金额
      Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_医保.结算方式
      Returning 余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (操作员姓名_In, r_医保.结算方式, 1, -1 * r_医保.金额);
        n_返回值 := r_医保.金额;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 人员缴款余额
        Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_医保.结算方式 And Nvl(余额, 0) = 0;
      End If;
    
      Update 病人预交记录
      Set 冲预交 = 冲预交 + (-1 * r_医保.金额)
      Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 = r_医保.结算方式;
      If Sql%RowCount = 0 Then
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要,
           缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 校对标志, 结算性质)
        Values
          (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * r_医保.金额, r_医保.结算方式, Null, 退费时间_In,
           Null, Null, Null, 操作员编号_In, 操作员姓名_In, r_医保.备注, n_组id, Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id,
           0, 3);
      End If;
    
      Update 病人预交记录
      Set 记录状态 = 3
      Where 记录性质 = 3 And 记录状态 = 1 And 结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And
            结算方式 = r_医保.结算方式;
    
      Update 医保结算明细
      Set 金额 = 金额 + (-1 * r_医保.金额)
      Where NO = No_In And 结帐id = n_结帐id And 结算方式 = r_医保.结算方式;
      If Sql%RowCount = 0 Then
        Insert Into 医保结算明细
          (结帐id, NO, 结算方式, 金额)
        Values
          (n_结帐id, No_In, r_医保.结算方式, -1 * r_医保.金额);
      End If;
      n_实收金额 := n_实收金额 - r_医保.金额;
    End Loop;
  
    Begin
      Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And 名称 Like '%现金%' And Rownum < 2;
    Exception
      When Others Then
        Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And Rownum < 2;
    End;
  
    If n_实收金额 <> 0 Then
      For r_Prepay In (Select NO, 实际票号, 病人id, 主页id, 科室id, 结算方式, 结算号码, 缴款单位, 单位开户行, 单位帐号, Sum(冲预交) As 冲预交, 卡类别id, 结算卡序号,
                              卡号, 交易流水号, 交易说明, 合作单位
                       From 病人预交记录 A
                       Where 记录性质 In (1, 11) And a.结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids)))
                       Group By n_Tempid, NO, 实际票号, 病人id, 主页id, 科室id, 结算方式, 结算号码, 缴款单位, 单位开户行, 单位帐号, 卡类别id, 结算卡序号, 卡号,
                                交易流水号, 交易说明, 合作单位) Loop
        If n_实收金额 <> 0 Then
          If r_Prepay.冲预交 >= n_实收金额 Then
            Select 病人预交记录_Id.Nextval Into n_Tempid From Dual;
            Insert Into 病人预交记录
              (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号,
               冲预交, 结帐id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 预交类别, 结算序号, 缴款组id)
              Select n_Tempid, r_Prepay.No, r_Prepay.实际票号, 11, 1, r_Prepay.病人id, r_Prepay.主页id, r_Prepay.科室id, Null,
                     r_Prepay.结算方式, r_Prepay.结算号码, Null, r_Prepay.缴款单位, r_Prepay.单位开户行, r_Prepay.单位帐号, 退费时间_In, 操作员姓名_In,
                     操作员编号_In, -1 * n_实收金额, n_结帐id, r_Prepay.卡类别id, r_Prepay.结算卡序号, r_Prepay.卡号, r_Prepay.交易流水号,
                     r_Prepay.交易说明, r_Prepay.合作单位, 1, -1 * n_结帐id, n_组id
              From Dual;
            Update 病人余额
            Set 预交余额 = Nvl(预交余额, 0) + Nvl(n_实收金额, 0)
            Where 病人id = n_病人id And 类型 = 1 And 性质 = 1
            Returning 预交余额 Into n_返回值;
            If Sql%RowCount = 0 Then
              Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (n_病人id, 1, n_实收金额, 1);
              n_返回值 := n_实收金额;
            End If;
            If Nvl(n_返回值, 0) = 0 Then
              Delete From 病人余额
              Where 病人id = n_病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
            End If;
            n_实收金额 := 0;
          Else
            Select 病人预交记录_Id.Nextval Into n_Tempid From Dual;
            Insert Into 病人预交记录
              (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号,
               冲预交, 结帐id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 预交类别, 结算序号, 缴款组id)
              Select n_Tempid, r_Prepay.No, r_Prepay.实际票号, 11, 1, r_Prepay.病人id, r_Prepay.主页id, r_Prepay.科室id, Null,
                     r_Prepay.结算方式, r_Prepay.结算号码, Null, r_Prepay.缴款单位, r_Prepay.单位开户行, r_Prepay.单位帐号, 退费时间_In, 操作员姓名_In,
                     操作员编号_In, -1 * r_Prepay.冲预交, n_结帐id, r_Prepay.卡类别id, r_Prepay.结算卡序号, r_Prepay.卡号, r_Prepay.交易流水号,
                     r_Prepay.交易说明, r_Prepay.合作单位, 1, -1 * n_结帐id, n_组id
              From Dual;
            Update 病人余额
            Set 预交余额 = Nvl(预交余额, 0) + Nvl(r_Prepay.冲预交, 0)
            Where 病人id = n_病人id And 类型 = 1 And 性质 = 1
            Returning 预交余额 Into n_返回值;
            If Sql%RowCount = 0 Then
              Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (n_病人id, 1, r_Prepay.冲预交, 1);
              n_返回值 := r_Prepay.冲预交;
            End If;
            If Nvl(n_返回值, 0) = 0 Then
              Delete From 病人余额
              Where 病人id = n_病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
            End If;
            n_实收金额 := n_实收金额 - r_Prepay.冲预交;
          End If;
        End If;
      End Loop;
    End If;
    --2.票据收回
    --可能以前没有打印,无收回
    Select Nvl(Max(ID), 0)
    Into n_打印id
    From (Select b.Id
           From 票据使用明细 A, 票据打印内容 B
           Where a.打印id = b.Id And a.性质 = 1 And a.原因 In (1, 3) And b.数据性质 = 1 And b.No = No_In
           Order By a.使用时间 Desc)
    Where Rownum < 2;
    If n_打印id > 0 Then
      --多张单据循环调用时只能收回一次
      Select Count(打印id) Into n_Count From 票据使用明细 Where 票种 = 1 And 性质 = 2 And 打印id = n_打印id;
      If n_Count = 0 Then
        Insert Into 票据使用明细
          (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
          Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, 退费时间_In, 操作员姓名_In
          From 票据使用明细
          Where 打印id = n_打印id And 票种 = 1 And 性质 = 1;
      End If;
    End If;
  
    --3.缴款数据处理(
    --   现有两种情况:
    --    1. 转出过程直接销帐的,则缴款数据不增加;
    --    2. 先转出,再到门诊退款退票,则需要进行缴款数据处理
    If Nvl(门诊退费_In, 0) = 1 Then
      For c_预交 In (Select a.结算方式, Sum(a.冲预交) As 冲预交, 2 As 预交类别, a.卡类别id, a.结算卡序号, a.卡号, Min(a.交易流水号) As 交易流水号,
                          Min(a.交易说明) As 交易说明, Min(a.合作单位) As 合作单位, b.性质
                   From 病人预交记录 A, 结算方式 B
                   Where a.记录性质 = 3 And a.结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And
                         a.结算方式 = b.名称 And b.性质 In (1, 2, 7, 8) And a.结算方式 Is Not Null
                   Group By a.结算方式, 预交类别, a.卡类别id, a.结算卡序号, a.卡号, b.性质
                   Having Sum(a.冲预交) <> 0
                   Order By a.卡类别id, 性质 Desc) Loop
        If n_实收金额 <> 0 Then
          Begin
            Select 是否退现 Into n_退现 From 医疗卡类别 Where ID = c_预交.卡类别id;
          Exception
            When Others Then
              n_退现 := 0;
          End;
          If (c_预交.性质 = 7 Or (c_预交.性质 = 8 And c_预交.卡类别id Is Not Null)) And n_退现 = 0 Then
            If c_预交.冲预交 > n_实收金额 Then
              Update 病人预交记录
              Set 冲预交 = 冲预交 + (-1 * n_实收金额), 摘要 = 摘要 || '1' || ',' || c_预交.卡类别id || ',' || -1 * n_实收金额 || '|'
              Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
              If Sql%RowCount = 0 Then
                Insert Into 病人预交记录
                  (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                   摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
                Values
                  (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * n_实收金额, Null, Null, 退费时间_In,
                   Null, Null, Null, 操作员编号_In, 操作员姓名_In, '1' || ',' || c_预交.卡类别id || ',' || -1 * n_实收金额 || '|', n_组id,
                   Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 3, 1);
              End If;
              Update 病人预交记录
              Set 记录状态 = 3
              Where 记录性质 = 3 And 记录状态 = 1 And 结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And
                    结算方式 = c_预交.结算方式;
              n_费用状态 := 1;
              n_实收金额 := 0;
            Else
              Update 病人预交记录
              Set 冲预交 = 冲预交 + (-1 * c_预交.冲预交), 摘要 = 摘要 || '1' || ',' || c_预交.卡类别id || ',' || -1 * c_预交.冲预交 || '|'
              Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
              If Sql%RowCount = 0 Then
                Insert Into 病人预交记录
                  (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                   摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
                Values
                  (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * c_预交.冲预交, Null, Null, 退费时间_In,
                   Null, Null, Null, 操作员编号_In, 操作员姓名_In, '1' || ',' || c_预交.卡类别id || ',' || -1 * c_预交.冲预交 || '|', n_组id,
                   Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 3, 1);
              End If;
            
              Update 病人预交记录
              Set 记录状态 = 3
              Where 记录性质 = 3 And 记录状态 = 1 And 结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And
                    结算方式 = c_预交.结算方式;
              n_费用状态 := 1;
              n_实收金额 := n_实收金额 - c_预交.冲预交;
            End If;
          Else
            n_实际冲销 := 0;
            If c_预交.性质 In (3, 4) Or (c_预交.性质 = 8 And c_预交.结算卡序号 Is Not Null) Then
              v_结算方式 := c_预交.结算方式;
            Else
              If 结算方式_In Is Null Then
                Begin
                  Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And 名称 Like '%现金%' And Rownum < 2;
                Exception
                  When Others Then
                    Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And Rownum < 2;
                End;
              Else
                v_结算方式 := 结算方式_In;
              End If;
            End If;
          
            If c_预交.性质 = 8 And c_预交.结算卡序号 Is Not Null Then
              If n_实收金额 >= c_预交.冲预交 Then
                --Zl_Square_Update(v_原结帐ids, n_结帐id, n_组id, 退费时间_In, -1 * n_结帐id, Null, c_预交.冲预交, c_预交.结算卡序号);
                Update 病人预交记录
                Set 冲预交 = 冲预交 + (-1 * c_预交.冲预交), 摘要 = 摘要 || '0' || ',' || c_预交.结算卡序号 || ',' || -1 * c_预交.冲预交 || '|'
                Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
                If Sql%RowCount = 0 Then
                  Insert Into 病人预交记录
                    (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                     摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
                  Values
                    (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * c_预交.冲预交, Null, Null,
                     退费时间_In, Null, Null, Null, 操作员编号_In, 操作员姓名_In,
                     '0' || ',' || c_预交.结算卡序号 || ',' || -1 * c_预交.冲预交 || '|', n_组id, Null, Null, Null, Null, Null, Null,
                     n_结帐id, -1 * n_结帐id, 3, 1);
                End If;
                n_费用状态 := 1;
                n_实际冲销 := c_预交.冲预交;
              Else
                --Zl_Square_Update(v_原结帐ids, n_结帐id, n_组id, 退费时间_In, -1 * n_结帐id, Null, n_实收金额, c_预交.结算卡序号);
                Update 病人预交记录
                Set 冲预交 = 冲预交 + (-1 * n_实收金额), 摘要 = 摘要 || '0' || ',' || c_预交.结算卡序号 || ',' || -1 * n_实收金额 || '|'
                Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
                If Sql%RowCount = 0 Then
                  Insert Into 病人预交记录
                    (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                     摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
                  Values
                    (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * n_实收金额, Null, Null, 退费时间_In,
                     Null, Null, Null, 操作员编号_In, 操作员姓名_In, '0' || ',' || c_预交.结算卡序号 || ',' || -1 * n_实收金额 || '|', n_组id,
                     Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 3, 1);
                End If;
                n_费用状态 := 1;
                n_实际冲销 := n_实收金额;
              End If;
            Else
              If c_预交.冲预交 > n_实收金额 Then
                n_实际冲销 := n_实收金额;
              Else
                n_实际冲销 := c_预交.冲预交;
              End If;
            End If;
          
            If c_预交.结算卡序号 Is Null Then
              Update 人员缴款余额
              Set 余额 = Nvl(余额, 0) - n_实际冲销
              Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_结算方式
              Returning 余额 Into n_返回值;
              If Sql%RowCount = 0 Then
                Insert Into 人员缴款余额
                  (收款员, 结算方式, 性质, 余额)
                Values
                  (操作员姓名_In, v_结算方式, 1, -1 * n_实际冲销);
                n_返回值 := n_实际冲销;
              End If;
              If Nvl(n_返回值, 0) = 0 Then
                Delete From 人员缴款余额
                Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_结算方式 And Nvl(余额, 0) = 0;
              End If;
            
              --退原预交记录
              Update 病人预交记录
              Set 冲预交 = 冲预交 + (-1 * n_实际冲销)
              Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 = v_结算方式;
              If Sql%RowCount = 0 Then
                Insert Into 病人预交记录
                  (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                   摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 校对标志, 结算性质)
                Values
                  (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * n_实际冲销, v_结算方式, Null, 退费时间_In,
                   Null, Null, Null, 操作员编号_In, 操作员姓名_In, '', n_组id, Null, Null, Null, Null, Null, c_预交.合作单位, n_结帐id,
                   -1 * n_结帐id, 0, 3);
              End If;
            End If;
            Update 病人预交记录
            Set 记录状态 = 3
            Where 记录性质 = 3 And 记录状态 = 1 And 结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And
                  结算方式 = c_预交.结算方式;
            n_实收金额 := n_实收金额 - n_实际冲销;
          End If;
        End If;
      End Loop;
    
      --更新费用审核记录
      Update 费用审核记录
      Set 记录状态 = 2
      Where 费用id In (Select ID From 门诊费用记录 Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3)) And 性质 = 1;
      --作废门诊记录
      Update 门诊费用记录 Set 记录状态 = 3 Where NO = No_In And Mod(记录性质,10) = 1 And 记录状态 = 1;
      For r_Clinic In (Select 序号, 从属父号, 价格父号, 病人id, 姓名, 性别, 年龄, 病人科室id, 费别, 收费类别, 收费细目id, 计算单位, 保险项目否, 保险大类id, 保险编码, 费用类型,
                              发药窗口, 付数, Sum(数次) As 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 标准单价, Sum(应收金额) As 应收金额,
                              Sum(实收金额) As 实收金额, Sum(统筹金额) As 统筹金额, 开单部门id, 开单人, 执行部门id, 划价人, Max(记帐单id) As 记帐单id, 发生时间,
                              实际票号
                       From 门诊费用记录
                       Where NO = No_In And Mod(记录性质,10) = 1 And 记录状态 In (2, 3) And Nvl(附加标志, 0) Not In (8, 9)
                       Group By 序号, 从属父号, 价格父号, 病人id, 姓名, 性别, 年龄, 病人科室id, 费别, 收费类别, 收费细目id, 计算单位, 保险项目否, 保险大类id, 保险编码,
                                费用类型, 发药窗口, 付数, 加班标志, 附加标志, 收入项目id, 收据费目, 标准单价, 开单部门id, 开单人, 执行部门id, 划价人, 发生时间, 实际票号
                       Having Sum(数次) <> 0) Loop
        Insert Into 门诊费用记录
          (ID, 记录性质, NO, 实际票号, 记录状态, 序号, 从属父号, 价格父号, 门诊标志, 病人id, 标识号, 姓名, 性别, 年龄, 病人科室id, 费别, 收费类别, 收费细目id, 计算单位, 保险项目否,
           保险大类id, 保险编码, 费用类型, 发药窗口, 付数, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 标准单价, 应收金额, 实收金额, 统筹金额, 记帐费用, 开单部门id, 开单人, 发生时间,
           登记时间, 执行部门id, 划价人, 操作员编号, 操作员姓名, 记帐单id, 摘要, 缴款组id, 结帐id, 结帐金额, 费用状态)
        Values
          (病人费用记录_Id.Nextval, 1, No_In, r_Clinic.实际票号, 2, r_Clinic.序号, r_Clinic.从属父号, r_Clinic.价格父号, 1, r_Clinic.病人id,
           '', r_Clinic.姓名, r_Clinic.性别, r_Clinic.年龄, r_Clinic.病人科室id, r_Clinic.费别, r_Clinic.收费类别, r_Clinic.收费细目id,
           r_Clinic.计算单位, r_Clinic.保险项目否, r_Clinic.保险大类id, r_Clinic.保险编码, r_Clinic.费用类型, r_Clinic.发药窗口, r_Clinic.付数,
           -1 * r_Clinic.数次, r_Clinic.加班标志, r_Clinic.附加标志, r_Clinic.收入项目id, r_Clinic.收据费目, r_Clinic.标准单价,
           -1 * r_Clinic.应收金额, -1 * r_Clinic.实收金额, -1 * r_Clinic.统筹金额, 0, r_Clinic.开单部门id, r_Clinic.开单人, r_Clinic.发生时间,
           退费时间_In, r_Clinic.执行部门id, r_Clinic.划价人, 操作员编号_In, 操作员姓名_In, r_Clinic.记帐单id, '', n_组id, n_结帐id,
           -1 * r_Clinic.实收金额, 0);
      End Loop;
    Else
      --4.退款转预交(不产生票据,由操作员通过重打进行)
      For r_Pay In (Select Min(a.Id) As 预交id, a.结算方式, Sum(a.冲预交) As 冲预交, 2 As 预交类别, a.卡类别id, a.结算卡序号, a.卡号, a.交易流水号,
                           a.交易说明, a.合作单位, b.性质
                    From 病人预交记录 A, 结算方式 B
                    Where a.记录性质 = 3 And a.结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And
                          a.结算方式 = b.名称 And (b.性质 In (1, 2, 7, 8)) And a.结算方式 Is Not Null
                    Group By a.结算方式, 预交类别, a.卡类别id, a.结算卡序号, a.卡号, b.性质, a.交易流水号, a.交易说明, a.合作单位


                    
                    Having Sum(a.冲预交) <> 0
                    Order By a.卡类别id, 性质 Desc) Loop
        --4.1产生预交款单据 (不存在部分退费的情况)
        --所有单据,按规则生成预交款单据
        --因为收款后立即缴款,所以人员缴款余额无变化
        If n_实收金额 <> 0 Then
          If r_Pay.性质 = 7 Or (r_Pay.性质 = 8 And r_Pay.卡类别id Is Not Null) Then
            If r_Pay.冲预交 > n_实收金额 Then
              Update 病人预交记录
              Set 冲预交 = 冲预交 + (-1 * n_实收金额), 摘要 = 摘要 || '1' || ',' || r_Pay.卡类别id || ',' || -1 * n_实收金额 || '|'
              Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
              If Sql%RowCount = 0 Then
                Insert Into 病人预交记录
                  (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                   摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
                Values
                  (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * n_实收金额, Null, Null, 退费时间_In,
                   Null, Null, Null, 操作员编号_In, 操作员姓名_In, '1' || ',' || r_Pay.卡类别id || ',' || -1 * n_实收金额 || '|', n_组id,
                   Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 3, 1);
              End If;
            
              Update 病人预交记录
              Set 记录状态 = 3
              Where 记录性质 = 3 And 记录状态 = 1 And 结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And
                    结算方式 = r_Pay.结算方式;
              n_费用状态 := 1;
              n_实收金额 := 0;
            Else
              Update 病人预交记录
              Set 冲预交 = 冲预交 + (-1 * r_Pay.冲预交), 摘要 = 摘要 || '1' || ',' || r_Pay.卡类别id || ',' || -1 * r_Pay.冲预交 || '|'
              Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
              If Sql%RowCount = 0 Then
                Insert Into 病人预交记录
                  (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                   摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
                Values
                  (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * r_Pay.冲预交, Null, Null, 退费时间_In,
                   Null, Null, Null, 操作员编号_In, 操作员姓名_In, '1' || ',' || r_Pay.卡类别id || ',' || -1 * r_Pay.冲预交 || '|',
                   n_组id, Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 3, 1);
              End If;
            
              Update 病人预交记录
              Set 记录状态 = 3
              Where 记录性质 = 3 And 记录状态 = 1 And 结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And
                    结算方式 = r_Pay.结算方式;
              n_费用状态 := 1;
              n_实收金额 := n_实收金额 - r_Pay.冲预交;
            End If;
          Else
            n_实际冲销 := 0;
            If r_Pay.性质 In (3, 4) Or (r_Pay.性质 = 8 And r_Pay.结算卡序号 Is Not Null) Then
              v_结算方式 := r_Pay.结算方式;
            Else
              If 结算方式_In Is Null Then
                Begin
                  Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And 名称 Like '%现金%' And Rownum < 2;
                Exception
                  When Others Then
                    Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And Rownum < 2;
                End;
              Else
                v_结算方式 := 结算方式_In;
              End If;
            End If;
          
            If r_Pay.性质 = 8 And r_Pay.结算卡序号 Is Not Null Then
              If n_实收金额 >= r_Pay.冲预交 Then
                --Zl_Square_Update(v_原结帐ids, n_结帐id, n_组id, 退费时间_In, -1 * n_结帐id, Null, r_Pay.冲预交, r_Pay.结算卡序号);
                Update 病人预交记录
                Set 冲预交 = 冲预交 + (-1 * r_Pay.冲预交), 摘要 = 摘要 || '0' || ',' || r_Pay.结算卡序号 || ',' || -1 * r_Pay.冲预交 || '|'
                Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
                If Sql%RowCount = 0 Then
                  Insert Into 病人预交记录
                    (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                     摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
                  Values
                    (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * r_Pay.冲预交, Null, Null,
                     退费时间_In, Null, Null, Null, 操作员编号_In, 操作员姓名_In,
                     '0' || ',' || r_Pay.结算卡序号 || ',' || -1 * r_Pay.冲预交 || '|', n_组id, Null, Null, Null, Null, Null,
                     Null, n_结帐id, -1 * n_结帐id, 3, 1);
                End If;
                n_费用状态 := 1;
                n_实际冲销 := r_Pay.冲预交;
              Else
                --Zl_Square_Update(v_原结帐ids, n_结帐id, n_组id, 退费时间_In, -1 * n_结帐id, Null, n_实收金额, r_Pay.结算卡序号);
                Update 病人预交记录
                Set 冲预交 = 冲预交 + (-1 * n_实收金额), 摘要 = 摘要 || '0' || ',' || r_Pay.结算卡序号 || ',' || -1 * n_实收金额 || '|'
                Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
                If Sql%RowCount = 0 Then
                  Insert Into 病人预交记录
                    (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                     摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
                  Values
                    (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * n_实收金额, Null, Null, 退费时间_In,
                     Null, Null, Null, 操作员编号_In, 操作员姓名_In, '0' || ',' || r_Pay.结算卡序号 || ',' || -1 * n_实收金额 || '|', n_组id,
                     Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 3, 1);
                End If;
                n_费用状态 := 1;
                n_实际冲销 := n_实收金额;
              End If;
            Else
              If r_Pay.冲预交 > n_实收金额 Then
                n_实际冲销 := n_实收金额;
              Else
                n_实际冲销 := r_Pay.冲预交;
              End If;
            End If;
          
            If r_Pay.性质 Not In (3, 4, 7, 8) Then
              Update 病人预交记录
              Set 金额 = 金额 + n_实际冲销
              Where 记录性质 = 1 And 记录状态 = 1 And 收款时间 = 退费时间_In And 病人id + 0 = n_病人id And 结算方式 = v_结算方式;
              If Sql%RowCount = 0 Then
                v_预交no := Nextno(11);
                Insert Into 病人预交记录
                  (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                   摘要, 缴款组id, 预交类别)
                Values
                  (病人预交记录_Id.Nextval, v_预交no, Null, 1, 1, n_病人id, 主页id_In, 入院科室id_In, n_实际冲销, v_结算方式, Null, 退费时间_In,
                   Null, Null, Null, 操作员编号_In, 操作员姓名_In, '门诊转住院预交', n_组id, r_Pay.预交类别);
              End If;
            
              --病人余额
              Update 病人余额
              Set 预交余额 = Nvl(预交余额, 0) + n_实际冲销
              Where 性质 = 1 And 病人id = n_病人id And 类型 = 2
              Returning 预交余额 Into n_返回值;
              If Sql%RowCount = 0 Then
                Insert Into 病人余额 (病人id, 性质, 类型, 预交余额, 费用余额) Values (n_病人id, 1, 2, n_实际冲销, 0);
                n_返回值 := n_实际冲销;
              End If;
              If Nvl(n_返回值, 0) = 0 Then
                Delete From 病人余额
                Where 病人id = n_病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
              End If;
            End If;
            --4.2缴款数据处理
            --   因为没有实际收病人的钱,所以不处理
            --部分退费情况，退原预交记录
            If r_Pay.性质 In (3, 4) Then
              Update 人员缴款余额
              Set 余额 = Nvl(余额, 0) - n_实际冲销
              Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_Pay.结算方式
              Returning 余额 Into n_返回值;
              If Sql%RowCount = 0 Then
                Insert Into 人员缴款余额
                  (收款员, 结算方式, 性质, 余额)
                Values
                  (操作员姓名_In, r_Pay.结算方式, 1, -1 * n_实际冲销);
                n_返回值 := n_实际冲销;
              End If;
              If Nvl(n_返回值, 0) = 0 Then
                Delete From 人员缴款余额
                Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_Pay.结算方式 And Nvl(余额, 0) = 0;
              End If;
            End If;
          
            If r_Pay.性质 <> 8 Then
              Update 病人预交记录
              Set 冲预交 = 冲预交 + (-1 * n_实际冲销)
              Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 = v_结算方式;
              If Sql%RowCount = 0 Then
                Insert Into 病人预交记录
                  (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名,
                   摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 校对标志, 结算性质)
                Values
                  (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * n_实际冲销, v_结算方式, Null, 退费时间_In,
                   Null, Null, Null, 操作员编号_In, 操作员姓名_In, '', n_组id, r_Pay.卡类别id, r_Pay.结算卡序号, r_Pay.卡号, r_Pay.交易流水号,
                   r_Pay.交易说明, r_Pay.合作单位, n_结帐id, -1 * n_结帐id, 0, 3);
              End If;
            End If;
          
            Update 病人预交记录
            Set 记录状态 = 3
            Where 记录性质 = 3 And 记录状态 = 1 And 结帐id In (Select Column_Value From Table(f_Str2list(v_原结帐ids))) And
                  结算方式 = r_Pay.结算方式;
            n_实收金额 := n_实收金额 - n_实际冲销;
          
          End If;
        End If;
      End Loop;
    End If;
  
    If 误差费_In Is Not Null Then
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要, 缴款组id,
         卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 校对标志, 结算性质)
      Values
        (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, 误差费_In, v_误差费, Null, 退费时间_In, Null, Null,
         Null, 操作员编号_In, 操作员姓名_In, '', n_组id, Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 0, 3);
    End If;
    Delete From 病人预交记录
    Where 结帐id = n_结帐id And 记录性质 = 3 And 记录状态 = 2 And 冲预交 = 0 And 结算方式 Is Not Null;
    Delete From 病人预交记录 Where 结帐id = n_原结帐id And 摘要 = '预交临时记录' And 记录性质 = 3;
    Update 门诊费用记录 Set 费用状态 = Nvl(n_费用状态, 0) Where NO = No_In And Mod(记录性质, 10) = 1 And 记录状态 = 2;
  Else
    --医保按结算转出
    For r_Nos In (Select Distinct a.No
                  From 门诊费用记录 A
                  Where Mod(a.记录性质, 10) = 1 And a.记录状态 In (1, 3) And a.结帐id = 原结帐id_In) Loop
      v_Nos := v_Nos || ',' || r_Nos.No;
    End Loop;
    v_Nos := Substr(v_Nos, 2);
  
    For r_结帐ids In (Select Distinct a.结帐id
                    From 门诊费用记录 A
                    Where a.No In (Select Column_Value From Table(f_Str2list(v_Nos))) And Mod(a.记录性质, 10) = 1 And
                          a.记录状态 <> 0) Loop
      v_结帐ids := v_结帐ids || ',' || r_结帐ids.结帐id;
    End Loop;
    v_结帐ids := Substr(v_结帐ids, 2);
    Select Count(a.No), Sum(a.实收金额)
    Into n_Count, n_实收金额
    From 门诊费用记录 A
    Where a.No In (Select Column_Value From Table(f_Str2list(v_Nos))) And Mod(a.记录性质, 10) = 1;
    If n_Count = 0 Or n_实收金额 = 0 Then
      v_Err_Msg := '本次结算不是收费或因并发原因他人操作了该结算,不能转为住院费用.';
      Raise Err_Item;
    End If;
  
    Select 结帐id, 病人id, 开单部门id, 开单人
    Into n_原结帐id, n_病人id, n_开单部门id, v_开单人
    From 门诊费用记录
    Where 结帐id = 原结帐id_In And Mod(记录性质, 10) = 1 And 记录状态 In (1, 3) And Rownum < 2;
  
    Begin
      Select 1
      Into n_部分退费
      From 门诊费用记录 A
      Where Mod(a.记录性质, 10) = 1 And a.记录状态 = 2 And a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids))) And
            Rownum < 2;
    Exception
      When Others Then
        n_部分退费 := 0;
    End;
  
    Begin
      Select 0
      Into n_部分退费
      From 门诊费用记录 A
      Where 记录性质 = 11 And a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids))) And Rownum < 2;
    Exception
      When Others Then
        Null;
    End;
    Begin
      Select Count(Avg(1))
      Into n_退费条数
      From 病人预交记录 A
      Where a.记录性质 = 3 And a.记录状态 <> 0 And 结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids)))
      Group By a.结算方式;
    Exception
      When Others Then
        n_退费条数 := 0;
    End;
    --1.1作废费用记录
    If 结帐id_In Is Null Then
      Select 病人结帐记录_Id.Nextval Into n_结帐id From Dual;
    Else
      n_结帐id := 结帐id_In;
    End If;
    Insert Into 门诊费用记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 姓名, 性别, 年龄, 标识号, 付款方式, 费别, 病人科室id, 收费类别, 收费细目id,
       计算单位, 付数, 发药窗口, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人, 执行状态, 执行时间,
       操作员编号, 操作员姓名, 发生时间, 登记时间, 结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 缴款组id, 费用状态)
      Select 病人费用记录_Id.Nextval, a.No, a.实际票号, a.记录性质, 2, a.序号, a.从属父号, a.价格父号, a.病人id, a.医嘱序号, a.门诊标志, a.姓名, a.性别, a.年龄,
             a.标识号, a.付款方式, a.费别, a.病人科室id, a.收费类别, a.收费细目id, a.计算单位, a.付数, a.发药窗口, -1 * a.数次, a.加班标志, a.附加标志, a.收入项目id,
             a.收据费目, a.记帐费用, a.标准单价, -1 * a.应收金额, -1 * a.实收金额, a.开单部门id, a.开单人, a.执行部门id, a.划价人, a.执行人, -1, a.执行时间,
             操作员编号_In, 操作员姓名_In, a.发生时间, 退费时间_In, n_结帐id, -1 * a.结帐金额, a.保险项目否, a.保险大类id, a.统筹金额, a.摘要,
             Decode(Nvl(a.附加标志, 0), 9, 1, 0), a.保险编码, a.费用类型, n_组id, 0
      From 门诊费用记录 A
      Where a.No In (Select Column_Value From Table(f_Str2list(v_Nos))) And Mod(a.记录性质, 10) = 1 And a.记录状态 = 1;
  
    --作废医保
    For r_医保 In (Select 结帐id, NO, 结算方式, 金额, 备注
                 From 医保结算明细
                 Where NO In (Select Column_Value From Table(f_Str2list(v_Nos))) And
                       结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids)))) Loop
      Update 医保结算明细
      Set 金额 = 金额 + (-1 * r_医保.金额)
      Where NO = r_医保.No And 结帐id = r_医保.结帐id And 结算方式 = r_医保.结算方式;
      If Sql%RowCount = 0 Then
        Insert Into 医保结算明细
          (结帐id, NO, 结算方式, 金额)
        Values
          (r_医保.结帐id, r_医保.No, r_医保.结算方式, -1 * r_医保.金额);
      End If;
    End Loop;
  
    --Update 门诊费用记录 Set 记录状态 = 3 Where NO = No_In And 记录性质 = 1 And 记录状态 = 1;
    --1.2作废预交记录
    --作废冲预交部分
    If n_部分退费 = 0 And Nvl(门诊退费_In, 0) = 0 Then
      For r_Prepay In (Select NO, 实际票号, 病人id, 主页id, 科室id, 结算方式, 结算号码, 缴款单位, 单位开户行, 单位帐号, 收款时间, -1 * Sum(冲预交) As 冲预交,
                              卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质
                       From 病人预交记录 A
                       Where 记录性质 In (1, 11) And a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids))) And
                             Nvl(冲预交, 0) <> 0
                       Group By n_Tempid, NO, 实际票号, 病人id, 主页id, 科室id, 结算方式, 结算号码, 缴款单位, 单位开户行, 单位帐号, 收款时间, 卡类别id, 结算卡序号,
                                卡号, 交易流水号, 交易说明, 合作单位, 结算性质) Loop
        Select 病人预交记录_Id.Nextval Into n_Tempid From Dual;
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
           结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 预交类别, 结算性质)
          Select n_Tempid, r_Prepay.No, r_Prepay.实际票号, 11, 1, r_Prepay.病人id, r_Prepay.主页id, r_Prepay.科室id, Null,
                 r_Prepay.结算方式, r_Prepay.结算号码, Null, r_Prepay.缴款单位, r_Prepay.单位开户行, r_Prepay.单位帐号, 退费时间_In, 操作员姓名_In,
                 操作员编号_In, r_Prepay.冲预交, n_结帐id, n_组id, r_Prepay.卡类别id, r_Prepay.结算卡序号, r_Prepay.卡号, r_Prepay.交易流水号,
                 r_Prepay.交易说明, r_Prepay.合作单位, -1 * n_结帐id, 1, r_Prepay.结算性质
          From Dual;
      End Loop;
    
      For v_预交 In (Select 病人id, Nvl(预交类别, 2) As 预交类别, Nvl(Sum(Nvl(冲预交, 0)), 0) As 预交金额
                   From 病人预交记录 A
                   Where 记录性质 In (1, 11) And a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids))) And
                         a.结帐id <> n_结帐id
                   Group By 病人id, Nvl(预交类别, 2)
                   Having Sum(Nvl(冲预交, 0)) <> 0) Loop
      
        Update 病人余额
        Set 预交余额 = Nvl(预交余额, 0) + Nvl(v_预交.预交金额, 0)
        Where 病人id = v_预交.病人id And 类型 = Nvl(v_预交.预交类别, 2) And 性质 = 1
        Returning 预交余额 Into n_返回值;
        If Sql%RowCount = 0 Then
          Insert Into 病人余额
            (病人id, 类型, 预交余额, 性质)
          Values
            (v_预交.病人id, Nvl(v_预交.预交类别, 2), v_预交.预交金额, 1);
          n_返回值 := v_预交.预交金额;
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 病人余额
          Where 病人id = v_预交.病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
        End If;
      End Loop;
    Else
      If n_退费条数 = 0 And Nvl(门诊退费_In, 0) = 0 Then
        --只使用了预交，原样退回预交
        For r_Prepay In (Select NO, 实际票号, 病人id, 主页id, 科室id, Max(结算方式) As 结算方式, 结算号码, 缴款单位, 单位开户行, 单位帐号, 收款时间,
                                -1 * Sum(冲预交) As 冲预交, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质
                         From 病人预交记录 A
                         Where 记录性质 In (1, 11) And a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids))) And
                               Nvl(冲预交, 0) <> 0
                         Group By n_Tempid, NO, 实际票号, 病人id, 主页id, 科室id, 结算号码, 缴款单位, 单位开户行, 单位帐号, 收款时间, 卡类别id, 结算卡序号, 卡号,
                                  交易流水号, 交易说明, 合作单位, 结算性质) Loop
          Select 病人预交记录_Id.Nextval Into n_Tempid From Dual;
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
             结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 预交类别, 结算性质)
            Select n_Tempid, r_Prepay.No, r_Prepay.实际票号, 11, 1, r_Prepay.病人id, r_Prepay.主页id, r_Prepay.科室id, Null,
                   r_Prepay.结算方式, r_Prepay.结算号码, Null, r_Prepay.缴款单位, r_Prepay.单位开户行, r_Prepay.单位帐号, 退费时间_In, 操作员姓名_In,
                   操作员编号_In, r_Prepay.冲预交, n_结帐id, n_组id, r_Prepay.卡类别id, r_Prepay.结算卡序号, r_Prepay.卡号, r_Prepay.交易流水号,
                   r_Prepay.交易说明, r_Prepay.合作单位, -1 * n_结帐id, 1, r_Prepay.结算性质
            From Dual;
          Select -1 * 冲预交 Into n_预交金额 From 病人预交记录 Where ID = n_Tempid;
          Update 病人余额
          Set 预交余额 = Nvl(预交余额, 0) + Nvl(n_预交金额, 0)
          Where 病人id = r_Prepay.病人id And 类型 = 1 And 性质 = 1
          Returning 预交余额 Into n_返回值;
          If Sql%RowCount = 0 Then
            Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (n_病人id, 1, n_预交金额, 1);
            n_返回值 := n_预交金额;
          End If;
          If Nvl(n_返回值, 0) = 0 Then
            Delete From 病人余额
            Where 病人id = r_Prepay.病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
          End If;
        End Loop;
      Else
        Begin
          Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And 名称 Like '%现金%' And Rownum < 2;
        Exception
          When Others Then
            Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And Rownum < 2;
        End;
        Select 病人预交记录_Id.Nextval Into n_Tempid From Dual;
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
           结帐id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质)
          Select n_Tempid, Max(NO), Max(实际票号), 3, 3, 病人id, 主页id, 科室id, Null, v_结算方式, Max(结算号码), '预交临时记录', Null, Null,
                 Null, Max(收款时间), 操作员姓名_In, 操作员编号_In, Sum(冲预交), n_原结帐id, Null, Null, Null, Null, Null, Null,
                 -1 * n_原结帐id, 3
          From 病人预交记录 A
          Where 记录性质 In (1, 11) And a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids))) And
                Nvl(冲预交, 0) <> 0
          Group By n_Tempid, 3, 3, 病人id, 主页id, 科室id, Null, v_结算方式, '预交临时记录', 操作员姓名_In, 操作员编号_In, n_原结帐id;
      End If;
    End If;
  
    --作废门诊缴费及医保部分
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别,
       卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质)
      Select 病人预交记录_Id.Nextval, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, 退费时间_In, 缴款单位, 单位开户行, 单位帐号, 操作员编号_In, 操作员姓名_In,
             0, n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, -1 * n_结帐id, 结算性质
      From 病人预交记录 A, 结算方式 B
      Where a.记录性质 = 3 And a.记录状态 = 1 And a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids))) And
            a.结算方式 = b.名称 And b.性质 Not In (7, 8);
  
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别,
       卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质, 校对标志)
      Select 病人预交记录_Id.Nextval, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, 退费时间_In, 缴款单位, 单位开户行, 单位帐号, 操作员编号_In, 操作员姓名_In,
             0, n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, -1 * n_结帐id, 结算性质, 1
      From 病人预交记录 A, 结算方式 B
      Where a.记录性质 = 3 And a.记录状态 = 1 And a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids))) And
            a.结算方式 = b.名称 And b.性质 = 7;
    If Sql%RowCount <> 0 Then
      n_费用状态 := 1;
    End If;
  
    Update 病人预交记录
    Set 记录状态 = 3
    Where 记录性质 = 3 And 记录状态 = 1 And 结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids)));
  
    --2.票据收回
    --可能以前没有打印,无收回
    For r_Nos In (Select Distinct a.No
                  From 门诊费用记录 A
                  Where Mod(a.记录性质, 10) = 1 And a.记录状态 In (1, 3) And
                        a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids)))) Loop
    
      Select Nvl(Max(ID), 0)
      Into n_打印id
      From (Select b.Id
             From 票据使用明细 A, 票据打印内容 B
             Where a.打印id = b.Id And a.性质 = 1 And a.原因 In (1, 3) And b.数据性质 = 1 And b.No = r_Nos.No
             Order By a.使用时间 Desc)
      Where Rownum < 2;
      If n_打印id > 0 Then
        --多张单据循环调用时只能收回一次
        Select Count(打印id) Into n_Count From 票据使用明细 Where 票种 = 1 And 性质 = 2 And 打印id = n_打印id;
        If n_Count = 0 Then
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
            Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, 退费时间_In, 操作员姓名_In
            From 票据使用明细
            Where 打印id = n_打印id And 票种 = 1 And 性质 = 1;
        End If;
      End If;
    End Loop;
  
    --3.缴款数据处理(
    --   现有两种情况:
    --    1. 转出过程直接销帐的,则缴款数据不增加;
    --    2. 先转出,再到门诊退款退票,则需要进行缴款数据处理
    If Nvl(门诊退费_In, 0) = 1 Then
      For c_预交 In (Select a.结算方式, Sum(a.冲预交) As 冲预交, 2 As 预交类别, a.卡类别id, a.结算卡序号, a.卡号, Min(a.交易流水号) As 交易流水号,
                          Min(a.交易说明) As 交易说明, Min(a.合作单位) As 合作单位, b.性质
                   From 病人预交记录 A, 结算方式 B
                   Where a.记录性质 = 3 And a.记录状态 In (2, 3) And
                         a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids))) And a.结算方式 = b.名称 And
                         b.性质 In (1, 2, 3, 4, 7, 8) And a.结算方式 Is Not Null
                   Group By a.结算方式, 预交类别, a.卡类别id, a.结算卡序号, a.卡号, b.性质
                   Having Sum(a.冲预交) <> 0) Loop
        Begin
          Select 是否退现 Into n_退现 From 医疗卡类别 Where ID = c_预交.卡类别id;
        Exception
          When Others Then
            n_退现 := 0;
        End;
        If (c_预交.性质 = 7 Or (c_预交.性质 = 8 And c_预交.卡类别id Is Not Null)) And n_退现 = 0 Then
          Update 病人预交记录
          Set 冲预交 = 冲预交 + (-1 * c_预交.冲预交), 摘要 = 摘要 || '1' || ',' || c_预交.卡类别id || ',' || -1 * c_预交.冲预交 || '|'
          Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
          If Sql%RowCount = 0 Then
            Insert Into 病人预交记录
              (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要,
               缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
            Values
              (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * c_预交.冲预交, Null, Null, 退费时间_In,
               Null, Null, Null, 操作员编号_In, 操作员姓名_In, '1' || ',' || c_预交.卡类别id || ',' || -1 * c_预交.冲预交 || '|', n_组id,
               Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 3, 1);
          End If;
          n_费用状态 := 1;
        Else
          If c_预交.性质 In (3, 4) Or (c_预交.性质 = 8 And c_预交.结算卡序号 Is Not Null) Then
            v_结算方式 := c_预交.结算方式;
          Else
            If 结算方式_In Is Null Then
              Begin
                Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And 名称 Like '%现金%' And Rownum < 2;
              Exception
                When Others Then
                  Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And Rownum < 2;
              End;
            Else
              v_结算方式 := 结算方式_In;
            End If;
          End If;
        
          If c_预交.性质 = 8 And c_预交.结算卡序号 Is Not Null Then
            --Zl_Square_Update(v_结帐ids, n_结帐id, n_组id, 退费时间_In, -1 * n_结帐id, Null, c_预交.冲预交, c_预交.结算卡序号);
            Update 病人预交记录
            Set 冲预交 = 冲预交 + (-1 * c_预交.冲预交), 摘要 = 摘要 || '0' || ',' || c_预交.结算卡序号 || ',' || -1 * c_预交.冲预交 || '|'
            Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
            If Sql%RowCount = 0 Then
              Insert Into 病人预交记录
                (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要,
                 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
              Values
                (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * c_预交.冲预交, Null, Null, 退费时间_In,
                 Null, Null, Null, 操作员编号_In, 操作员姓名_In, '0' || ',' || c_预交.结算卡序号 || ',' || -1 * c_预交.冲预交 || '|', n_组id,
                 Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 3, 1);
            End If;
            n_费用状态 := 1;
          End If;
          If c_预交.结算卡序号 Is Null Then
            Update 人员缴款余额
            Set 余额 = Nvl(余额, 0) - c_预交.冲预交
            Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_结算方式
            Returning 余额 Into n_返回值;
            If Sql%RowCount = 0 Then
              Insert Into 人员缴款余额
                (收款员, 结算方式, 性质, 余额)
              Values
                (操作员姓名_In, v_结算方式, 1, -1 * c_预交.冲预交);
              n_返回值 := c_预交.冲预交;
            End If;
            If Nvl(n_返回值, 0) = 0 Then
              Delete From 人员缴款余额
              Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_结算方式 And Nvl(余额, 0) = 0;
            End If;
            --部分退费情况，退原预交记录
            Update 病人预交记录
            Set 冲预交 = 冲预交 + (-1 * c_预交.冲预交)
            Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 = v_结算方式;
            If Sql%RowCount = 0 Then
              Insert Into 病人预交记录
                (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要,
                 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 校对标志, 结算性质)
              Values
                (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * c_预交.冲预交, v_结算方式, Null, 退费时间_In,
                 Null, Null, Null, 操作员编号_In, 操作员姓名_In, '', n_组id, Null, Null, Null, Null, Null, c_预交.合作单位, n_结帐id,
                 -1 * n_结帐id, 0, 3);
            End If;
          End If;
        End If;
      End Loop;
    
      --更新费用审核记录
      Update 费用审核记录
      Set 记录状态 = 2
      Where 费用id In (Select a.Id
                     From 门诊费用记录 A
                     Where a.No In (Select Column_Value From Table(f_Str2list(v_Nos))) And Mod(a.记录性质, 10) = 1 And
                           a.记录状态 In (1, 3)) And 性质 = 1;
      --作废门诊记录
      For r_Nos In (Select Distinct NO
                    From 门诊费用记录
                    Where Mod(记录性质, 10) = 1 And 记录状态 In (1, 3) And
                          结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids)))) Loop
        Update 门诊费用记录 Set 记录状态 = 3 Where NO = r_Nos.No And Mod(记录性质, 10) = 1 And 记录状态 = 1;
      End Loop;
      For r_Clinic In (Select Min(a.记录性质) As 记录性质, a.No, a.序号, a.从属父号, a.价格父号, a.病人id, a.姓名, a.性别, a.年龄, a.病人科室id, a.费别,
                              a.收费类别, a.收费细目id, a.计算单位, a.保险项目否, a.保险大类id, a.保险编码, a.费用类型, a.发药窗口, a.付数, Sum(a.数次) As 数次,
                              a.加班标志, a.附加标志, a.收入项目id, a.收据费目, a.标准单价, Sum(a.应收金额) As 应收金额, Sum(a.实收金额) As 实收金额,
                              Sum(a.统筹金额) As 统筹金额, a.开单部门id, a.开单人, a.执行部门id, a.划价人, Max(a.记帐单id) As 记帐单id,
                              Max(a.是否急诊) As 是否急诊, a.发生时间, Min(a.实际票号) As 实际票号
                       From 门诊费用记录 A
                       Where a.No In (Select Column_Value From Table(f_Str2list(v_Nos))) And Mod(a.记录性质, 10) = 1 And
                             a.记录状态 In (2, 3) And Nvl(a.附加标志, 0) Not In (8, 9)
                       Group By a.No, a.序号, a.从属父号, a.价格父号, a.病人id, a.姓名, a.性别, a.年龄, a.病人科室id, a.费别, a.收费类别, a.收费细目id,
                                a.计算单位, a.保险项目否, a.保险大类id, a.保险编码, a.费用类型, a.发药窗口, a.付数, a.加班标志, a.附加标志, a.收入项目id, a.收据费目,
                                a.标准单价, a.开单部门id, a.开单人, a.执行部门id, a.划价人, a.发生时间
                       Having Sum(a.数次) <> 0) Loop
        Insert Into 门诊费用记录
          (ID, 记录性质, NO, 实际票号, 记录状态, 序号, 从属父号, 价格父号, 门诊标志, 病人id, 标识号, 姓名, 性别, 年龄, 病人科室id, 费别, 收费类别, 收费细目id, 计算单位, 保险项目否,
           保险大类id, 保险编码, 费用类型, 发药窗口, 付数, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 标准单价, 应收金额, 实收金额, 统筹金额, 记帐费用, 开单部门id, 开单人, 发生时间,
           登记时间, 执行部门id, 划价人, 操作员编号, 操作员姓名, 记帐单id, 摘要, 是否急诊, 缴款组id, 结帐id, 结帐金额, 执行状态, 费用状态)
        Values
          (病人费用记录_Id.Nextval, r_Clinic.记录性质, r_Clinic.No, r_Clinic.实际票号, 2, r_Clinic.序号, r_Clinic.从属父号, r_Clinic.价格父号,
           1, r_Clinic.病人id, '', r_Clinic.姓名, r_Clinic.性别, r_Clinic.年龄, r_Clinic.病人科室id, r_Clinic.费别, r_Clinic.收费类别,
           r_Clinic.收费细目id, r_Clinic.计算单位, r_Clinic.保险项目否, r_Clinic.保险大类id, r_Clinic.保险编码, r_Clinic.费用类型, r_Clinic.发药窗口,
           r_Clinic.付数, -1 * r_Clinic.数次, r_Clinic.加班标志, r_Clinic.附加标志, r_Clinic.收入项目id, r_Clinic.收据费目, r_Clinic.标准单价,
           -1 * r_Clinic.应收金额, -1 * r_Clinic.实收金额, -1 * r_Clinic.统筹金额, 0, r_Clinic.开单部门id, r_Clinic.开单人, r_Clinic.发生时间,
           退费时间_In, r_Clinic.执行部门id, r_Clinic.划价人, 操作员编号_In, 操作员姓名_In, r_Clinic.记帐单id, '', r_Clinic.是否急诊, n_组id, n_结帐id,
           -1 * r_Clinic.实收金额, -1, 0);
      End Loop;
    Else
      --4.退款转预交(不产生票据,由操作员通过重打进行)
    
      For r_Pay In (Select Min(a.Id) As 预交id, a.结算方式, Sum(a.冲预交) As 冲预交, 2 As 预交类别, a.卡类别id, a.结算卡序号, a.卡号, a.交易流水号,
                           a.交易说明, a.合作单位, b.性质
                    From 病人预交记录 A, 结算方式 B
                    Where a.记录性质 = 3 And a.记录状态 In (2, 3) And
                          a.结帐id In (Select Column_Value From Table(f_Str2list(v_结帐ids))) And a.结算方式 = b.名称 And
                          b.性质 In (1, 2, 3, 4, 7, 8) And a.结算方式 Is Not Null
                    Group By a.结算方式, 预交类别, a.卡类别id, a.结算卡序号, a.卡号, b.性质, a.交易流水号, a.交易说明, a.合作单位


                    
                    Having Sum(a.冲预交) <> 0) Loop
        --4.1产生预交款单据 (不存在部分退费的情况)
        --所有单据,按规则生成预交款单据
        --因为收款后立即缴款,所以人员缴款余额无变化
        If r_Pay.性质 = 7 Or (r_Pay.性质 = 8 And r_Pay.卡类别id Is Not Null) Then
          Update 病人预交记录
          Set 冲预交 = 冲预交 + (-1 * r_Pay.冲预交), 摘要 = 摘要 || '1' || ',' || r_Pay.卡类别id || ',' || -1 * r_Pay.冲预交 || '|'
          Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
          If Sql%RowCount = 0 Then
            Insert Into 病人预交记录
              (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要,
               缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
            Values
              (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * r_Pay.冲预交, Null, Null, 退费时间_In,
               Null, Null, Null, 操作员编号_In, 操作员姓名_In, '1' || ',' || r_Pay.卡类别id || ',' || -1 * r_Pay.冲预交 || '|', n_组id,
               Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 3, 1);
          End If;
          n_费用状态 := 1;
        Else
          If r_Pay.性质 In (3, 4) Or (r_Pay.性质 = 8 And r_Pay.结算卡序号 Is Not Null) Then
            v_结算方式 := r_Pay.结算方式;
          Else
            Begin
              Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And 名称 Like '%现金%' And Rownum < 2;
            Exception
              When Others Then
                Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And Rownum < 2;
            End;
          End If;
        
          If r_Pay.性质 = 8 Then
            --Zl_Square_Update(v_结帐ids, n_结帐id, n_组id, 退费时间_In, -1 * n_结帐id, Null, r_Pay.冲预交, r_Pay.结算卡序号);
            Update 病人预交记录
            Set 冲预交 = 冲预交 + (-1 * r_Pay.冲预交), 摘要 = 摘要 || '0' || ',' || r_Pay.结算卡序号 || ',' || -1 * r_Pay.冲预交 || '|'
            Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 Is Null;
            If Sql%RowCount = 0 Then
              Insert Into 病人预交记录
                (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要,
                 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 结算性质, 校对标志)
              Values
                (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * r_Pay.冲预交, Null, Null, 退费时间_In,
                 Null, Null, Null, 操作员编号_In, 操作员姓名_In, '0' || ',' || r_Pay.结算卡序号 || ',' || -1 * r_Pay.冲预交 || '|', n_组id,
                 Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 3, 1);
            End If;
            n_费用状态 := 1;
          End If;
          If r_Pay.性质 Not In (3, 4, 7, 8) Then
            Update 病人预交记录
            Set 金额 = 金额 + r_Pay.冲预交
            Where 记录性质 = 1 And 记录状态 = 1 And 收款时间 = 退费时间_In And 病人id + 0 = n_病人id And 结算方式 = v_结算方式;
            If Sql%RowCount = 0 Then
              v_预交no := Nextno(11);
              Insert Into 病人预交记录
                (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要,
                 缴款组id, 预交类别)
              Values
                (病人预交记录_Id.Nextval, v_预交no, Null, 1, 1, n_病人id, 主页id_In, 入院科室id_In, r_Pay.冲预交, v_结算方式, Null, 退费时间_In,
                 Null, Null, Null, 操作员编号_In, 操作员姓名_In, '门诊转住院预交', n_组id, r_Pay.预交类别);
            End If;
          
            --病人余额
            Update 病人余额
            Set 预交余额 = Nvl(预交余额, 0) + r_Pay.冲预交
            Where 性质 = 1 And 病人id = n_病人id And 类型 = 2
            Returning 预交余额 Into n_返回值;
            If Sql%RowCount = 0 Then
              Insert Into 病人余额 (病人id, 性质, 类型, 预交余额, 费用余额) Values (n_病人id, 1, 2, r_Pay.冲预交, 0);
              n_返回值 := r_Pay.冲预交;
            End If;
            If Nvl(n_返回值, 0) = 0 Then
              Delete From 病人余额
              Where 病人id = n_病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
            End If;
          End If;
          --4.2缴款数据处理
          --   因为没有实际收病人的钱,所以不处理
          --部分退费情况，退原预交记录
          If r_Pay.性质 In (3, 4) Then
            Update 人员缴款余额
            Set 余额 = Nvl(余额, 0) - r_Pay.冲预交
            Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_Pay.结算方式
            Returning 余额 Into n_返回值;
            If Sql%RowCount = 0 Then
              Insert Into 人员缴款余额
                (收款员, 结算方式, 性质, 余额)
              Values
                (操作员姓名_In, r_Pay.结算方式, 1, -1 * r_Pay.冲预交);
              n_返回值 := r_Pay.冲预交;
            End If;
            If Nvl(n_返回值, 0) = 0 Then
              Delete From 人员缴款余额
              Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_Pay.结算方式 And Nvl(余额, 0) = 0;
            End If;
          End If;
        
          If r_Pay.结算卡序号 Is Null Then
            Update 病人预交记录
            Set 冲预交 = 冲预交 + (-1 * r_Pay.冲预交)
            Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 = v_结算方式;
            If Sql%RowCount = 0 Then
              Insert Into 病人预交记录
                (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要,
                 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 校对标志, 结算性质)
              Values
                (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, -1 * r_Pay.冲预交, v_结算方式, Null, 退费时间_In,
                 Null, Null, Null, 操作员编号_In, 操作员姓名_In, '', n_组id, r_Pay.卡类别id, r_Pay.结算卡序号, r_Pay.卡号, r_Pay.交易流水号,
                 r_Pay.交易说明, r_Pay.合作单位, n_结帐id, -1 * n_结帐id, 0, 3);
            End If;
          End If;
        End If;
      End Loop;
    End If;
    If 误差费_In Is Not Null Then
      Begin
        Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And 名称 Like '%现金%' And Rownum < 2;
      Exception
        When Others Then
          Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And Rownum < 2;
      End;
      Update 病人预交记录
      Set 冲预交 = 冲预交 - 误差费_In
      Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 = v_结算方式;
      Update 病人预交记录
      Set 冲预交 = 冲预交 + 误差费_In
      Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = n_结帐id And 结算方式 = v_误差费;
      If Sql%RowCount = 0 Then
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 冲预交, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要,
           缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 结算序号, 校对标志, 结算性质)
        Values
          (病人预交记录_Id.Nextval, Null, Null, 3, 2, n_病人id, 主页id_In, 入院科室id_In, 误差费_In, v_误差费, Null, 退费时间_In, Null, Null,
           Null, 操作员编号_In, 操作员姓名_In, '', n_组id, Null, Null, Null, Null, Null, Null, n_结帐id, -1 * n_结帐id, 0, 3);
      End If;
    End If;
    Delete From 病人预交记录 Where 结帐id = n_原结帐id And 摘要 = '预交临时记录' And 记录性质 = 3;
    Delete From 病人预交记录
    Where 结帐id = n_结帐id And 记录性质 = 3 And 记录状态 = 2 And 冲预交 = 0 And 结算方式 Is Not Null;
    Update 门诊费用记录
    Set 费用状态 = Nvl(n_费用状态, 0)
    Where NO In (Select Column_Value From Table(f_Str2list(v_Nos))) And Mod(记录性质, 10) = 1 And 记录状态 = 2;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊转住院_收费转出;
/

--104726:李南春,2017-04-20,发卡使用门诊收据
Create Or Replace Procedure Zl_病人发卡票据_Print
(
  No_In           Varchar2,
  票据号_In       票据使用明细.号码%Type,
  领用id_In       票据使用明细.领用id%Type,
  使用人_In       票据使用明细.使用人%Type,
  使用时间_In     票据使用明细.使用时间%Type,
  操作类型_In     Number,
  票据张数_In     Number := 1
) As
  --功能：处理医疗卡使用门诊票据
  --参数：
  --      NO_IN       =     发卡收费的单据号。格式为：A0000001
  --      票据号_IN   =     要使用的开始票据号。该票据号应该不为空，为空时不处理数据,退卡时传入原始票据号
  --      领用ID_IN   =     严格控制票据时，为使用票据的领用批次。非严格控制时，为NULL。
  --      票据张数_In =     实际所需的票据打印张数
  --      操作类型_In =     1-发卡；2-退卡；3-重打；4-补打；5-换卡
  --该游标用于票据范围判断
  Cursor c_Fact Is
    Select * From 票据领用记录 Where ID = Nvl(领用id_In, 0);
  r_Factrow c_Fact%RowType;

  v_收回id   票据打印内容.Id%Type;
  v_票据号     票据使用明细.号码%Type;
  v_当前票据号 票据使用明细.号码%Type;
  n_打印id     票据打印内容.Id%Type;

  v_当前号 门诊费用记录.No%Type;
  v_单据号 Varchar2(1000);

  v_Error Varchar2(255);
  Err_Custom Exception;
Begin

  --无票据号时,不用处理票据
  If 票据号_In Is Null Then
    Return;
  End If;

  --退卡
  IF 操作类型_In = 2 then
    Begin
      --从最后一次打印的内容中取
      --81907
      Select ID
      Into v_收回id
      From (Select b.Id
             From 票据使用明细 A, 票据打印内容 B
             Where a.打印id = b.Id And a.性质 = 1 And a.原因 In (1, 3) And A.票种 = 1 And b.数据性质 = 5 And b.No = No_In
             Order By a.使用时间 Desc)
      Where Rownum < 2;
    Exception
      When Others Then
        Null;
    End;
    
    If v_收回id Is Not Null Then
      Insert Into 票据使用明细
        (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
      Select 票据使用明细_Id.Nextval, 1, 票据号_In, 2, 2, 领用id, 打印id, 使用时间_In, 使用人_In
      From   票据使用明细
      Where  打印id = v_收回id And 票种 = 1 And 性质 = 1;
    End if;
    Return;
  End If;

  --重打收回原始票据
  IF 操作类型_In = 3 or 操作类型_In = 5 then
    Begin
      --从最后一次打印的内容中取
      --81907
      Select ID
      Into v_收回id
      From (Select b.Id
             From 票据使用明细 A, 票据打印内容 B
             Where a.打印id = b.Id And a.性质 = 1 And a.原因 In (1, 3) And A.票种 = 1 And b.数据性质 = 5 And b.No = No_In
             Order By a.使用时间 Desc)
      Where Rownum < 2;
    Exception
      When Others Then
        Null;
    End;
    
    If v_收回id Is Not Null Then
      Begin
        Insert Into 票据使用明细
          (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
          Select 票据使用明细_Id.Nextval, 票种, 号码, 2, Decode(操作类型_In, 5, 2, 4), 领用id, 打印id, 使用时间_In, 使用人_In
          From 票据使用明细
          Where 打印id = v_收回id And 票种 = 1 And 性质 = 1;
      Exception
        When Others Then
          Null;
      End;
     End if;
  End If;
  
  Select 票据打印内容_Id.Nextval Into n_打印id From Dual;

  --生成单据的票据打印内容
  Insert Into 票据打印内容 (ID, 数据性质, NO) Values (n_打印id, 5, No_In);

  --并发出票据
  v_票据号 := 票据号_In;
  If Nvl(领用id_In, 0) <> 0 Then
    Open c_Fact;
    Fetch c_Fact
      Into r_Factrow;
    If c_Fact%RowCount = 0 Then
      v_Error := '无效的票据领用批次，无法完成挂号票据分配操作。';
      Close c_Fact;
      Raise Err_Custom;
    Elsif Nvl(r_Factrow.剩余数量, 0) < 票据张数_In Then
      v_Error := '当前批次的剩余数量不足' || 票据张数_In || '张，无法完成挂号票据分配操作。';
      Close c_Fact;
      Raise Err_Custom;
    End If;
  End If;
  For I In 1 .. 票据张数_In Loop
    --检查票据范围是否正确
    If Nvl(领用id_In, 0) <> 0 Then
      If Not (Upper(v_票据号) >= Upper(r_Factrow.开始号码) And Upper(v_票据号) <= Upper(r_Factrow.终止号码) And
          Length(v_票据号) = Length(r_Factrow.终止号码)) Then
        v_Error := '该单据需要打印多张票据,但票据号"' || v_票据号 || '"超出票据领用的号码范围！';
        Close c_Fact;
        Raise Err_Custom;
      End If;
    End If;
  
    --发出票据
    Insert Into 票据使用明细
      (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
    Values
      (票据使用明细_Id.Nextval, 1, v_票据号, 1, Decode(操作类型_In,3,3,1), 领用id_In, n_打印id, 使用时间_In, 使用人_In);
  
    v_当前票据号 := v_票据号;
    --下一个票据号
    v_票据号 := Zl_Incstr(v_票据号);
  End Loop;
  
  If Nvl(领用id_In, 0) <> 0 Then
    Update 票据领用记录
    Set 使用时间 = 使用时间_In, 当前号码 = v_当前票据号, 剩余数量 = Nvl(剩余数量, 0) - 票据张数_In
    Where ID = 领用id_In;
    Close c_Fact;
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人发卡票据_Print;
/

--105165:张德婷,2017-04-20,处方发药可以添加该叫号窗口的所有处方
CREATE OR REPLACE Procedure zl_发药窗口_Insert (
    编码_IN IN 发药窗口.编码%Type, 
    名称_IN IN 发药窗口.名称%Type, 
    上班_IN IN 发药窗口.上班否%Type, 
    药房ID_IN IN 发药窗口.药房ID%Type, 
    专家_IN IN 发药窗口.专家%Type,
    叫号窗口_IN In 发药窗口.叫号窗口%type

) 
IS 
    Msg VARCHAR2 (30); 
Begin 
    Insert INTO 发药窗口 
                    (编码, 名称, 上班否, 药房ID, 专家,叫号窗口) 
          VALUES (编码_IN, 名称_IN, 上班_IN, 药房ID_IN, 专家_IN,叫号窗口_IN); 
Exception 
    When Others Then 
        Zl_ErrorCenter (SQLCODE, SQLERRM); 
End zl_发药窗口_Insert;
/

--105165:张德婷,2017-04-20,处方发药可以添加该叫号窗口的所有处方
CREATE OR REPLACE Procedure zl_发药窗口_UPDATE (
    编码_IN IN 发药窗口.编码%Type,
    名称_IN IN 发药窗口.名称%Type,
    药房ID_IN IN 发药窗口.药房ID%Type,
    专家_IN IN 发药窗口.专家%Type,
    Old编码_IN IN 发药窗口.编码%Type,
    Old药房ID_IN IN 发药窗口.药房ID%Type,
    叫号窗口_IN In 发药窗口.叫号窗口%type
)
IS
    Msg VARCHAR2 (30);
Begin
    UPDATE 发药窗口
        SET 编码 = 编码_IN,
             名称 = 名称_IN,
             药房ID = 药房ID_IN,
             专家 = 专家_IN,
             叫号窗口=叫号窗口_IN
     WHERE 编码 = Old编码_IN
        AND 药房ID = Old药房ID_IN;
Exception
    When Others Then
        Zl_ErrorCenter (SQLCODE, SQLERRM);
End zl_发药窗口_UPDATE;
/

--105165:张德婷,2017-04-20,处方发药可以添加该叫号窗口的所有处方
CREATE OR REPLACE Procedure Zl_未发药品记录_呼叫
(
  No_In       药品收发记录.NO%Type,
  单据_In     药品收发记录.单据%Type,
  药房id_In   药品收发记录.库房id%Type,
  发药窗口_In 药品收发记录.发药窗口%Type,
  呼叫内容_In 未发药品记录.呼叫内容%Type := Null
) Is
Begin
  If 呼叫内容_In Is Null Then
    --呼叫内容为空时，将当前的呼叫状态的单据的呼叫内容清空
    Update 未发药品记录
    Set 呼叫内容 = Null
    Where 库房id = 药房id_In And 单据 = 单据_In and (发药窗口 = 发药窗口_In or 发药窗口 in(select 名称 from 发药窗口 where 叫号窗口=发药窗口_In)) And NO = No_In  And 排队状态 = 3 and 填制日期 between sysdate-3 and sysdate;
  Else
    --呼叫内容不为空时，先将以前的呼叫状态中的单据设置为已呼叫，再将当前单据设置为呼叫状态，并填写呼叫内容和呼叫时间
    --可以满足同一单据反复呼叫的情况
    Update 未发药品记录
    Set 排队状态 = 4, 呼叫内容 = Null
    Where 库房id = 药房id_In And (发药窗口 = 发药窗口_In or 发药窗口 in(select 名称 from 发药窗口 where 叫号窗口=发药窗口_In)) And 排队状态 = 3 and 填制日期 between sysdate-3 and sysdate;

    Update 未发药品记录
    Set 排队状态 = 3, 呼叫内容 = 呼叫内容_In, 呼叫时间 = Sysdate
    Where 库房id = 药房id_In And 单据 = 单据_In And NO = No_In and 填制日期 between sysdate-3 and sysdate;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_未发药品记录_呼叫;
/

--108439:余伟节,2017-04-19,住院病人下达医嘱时取病人年龄时从病案主页中提取
CREATE OR REPLACE Procedure Zl_病人医嘱记录_Insert
(
  Id_In           病人医嘱记录.Id%Type,
  相关id_In       病人医嘱记录.相关id%Type,
  序号_In         病人医嘱记录.序号%Type,
  病人来源_In     病人医嘱记录.病人来源%Type,
  病人id_In       病人医嘱记录.病人id%Type,
  主页id_In       病人医嘱记录.主页id%Type,
  婴儿_In         病人医嘱记录.婴儿%Type,
  医嘱状态_In     病人医嘱记录.医嘱状态%Type,
  医嘱期效_In     病人医嘱记录.医嘱期效%Type,
  诊疗类别_In     病人医嘱记录.诊疗类别%Type,
  诊疗项目id_In   病人医嘱记录.诊疗项目id%Type,
  收费细目id_In   病人医嘱记录.收费细目id%Type,
  天数_In         病人医嘱记录.天数%Type,
  单次用量_In     病人医嘱记录.单次用量%Type,
  总给予量_In     病人医嘱记录.总给予量%Type,
  医嘱内容_In     病人医嘱记录.医嘱内容%Type,
  医生嘱托_In     病人医嘱记录.医生嘱托%Type,
  标本部位_In     病人医嘱记录.标本部位%Type,
  执行频次_In     病人医嘱记录.执行频次%Type,
  频率次数_In     病人医嘱记录.频率次数%Type,
  频率间隔_In     病人医嘱记录.频率间隔%Type,
  间隔单位_In     病人医嘱记录.间隔单位%Type,
  执行时间方案_In 病人医嘱记录.执行时间方案%Type,
  计价特性_In     病人医嘱记录.计价特性%Type,
  执行科室id_In   病人医嘱记录.执行科室id%Type,
  执行性质_In     病人医嘱记录.执行性质%Type,
  紧急标志_In     病人医嘱记录.紧急标志%Type,
  开始执行时间_In 病人医嘱记录.开始执行时间%Type,
  执行终止时间_In 病人医嘱记录.执行终止时间%Type,
  病人科室id_In   病人医嘱记录.病人科室id%Type,
  开嘱科室id_In   病人医嘱记录.开嘱科室id%Type,
  开嘱医生_In     病人医嘱记录.开嘱医生%Type,
  开嘱时间_In     病人医嘱记录.开嘱时间%Type,
  挂号单_In       病人医嘱记录.挂号单%Type := Null,
  前提id_In       病人医嘱记录.前提id%Type := Null,
  检查方法_In     病人医嘱记录.检查方法%Type := Null,
  执行标记_In     病人医嘱记录.执行标记%Type := Null,
  可否分零_In     病人医嘱记录.可否分零%Type := Null,
  摘要_In         病人医嘱记录.摘要%Type := Null,
  操作员姓名_In   病人医嘱状态.操作人员%Type := Null,
  零费记帐_In     病人医嘱记录.零费记帐%Type := Null,
  用药目的_In     病人医嘱记录.用药目的%Type := Null,
  用药理由_In     病人医嘱记录.用药理由%Type := Null,
  审核状态_In     病人医嘱记录.审核状态%Type := Null,
  申请序号_In     病人医嘱记录.申请序号%Type := Null,
  超量说明_In     病人医嘱记录.超量说明%Type := Null,
  首次用量_In     病人医嘱记录.首次用量%Type := Null,
  配方id_In       病人医嘱记录.配方id%Type := Null,
  手术情况_In     病人医嘱记录.手术情况%Type := Null,
  组合项目id_In   病人医嘱记录.组合项目id%Type := Null,
  皮试结果_In     病人医嘱记录.皮试结果%Type := Null
  --功能：医生或护士新开,补录医嘱时新产生的医嘱记录。可用于门诊或住院。
) Is
  v_Temp     Varchar2(255);
  v_人员姓名 病人医嘱状态.操作人员%Type;

  v_姓名 病人信息.姓名%Type;
  v_性别 病人信息.性别%Type;
  v_年龄 病人信息.年龄%Type;

  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  --当前操作人员
  If 操作员姓名_In Is Not Null Then
    v_人员姓名 := 操作员姓名_In;
  Else
    v_Temp     := Zl_Identity;
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
    v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  End If;

  If Nvl(主页id_In, 0) <> 0 Then
    Select 姓名, 性别, 年龄 Into v_姓名, v_性别, v_年龄 From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
  Else
    Select 姓名, 性别, 年龄 Into v_姓名, v_性别, v_年龄 From 病人信息 Where 病人id = 病人id_In;
  End If;

  --病人医嘱记录
  Insert Into 病人医嘱记录
    (ID, 相关id, 序号, 病人来源, 病人id, 主页id, 姓名, 性别, 年龄, 婴儿, 医嘱状态, 医嘱期效, 诊疗类别, 诊疗项目id, 收费细目id, 天数, 单次用量, 总给予量, 医嘱内容, 医生嘱托, 标本部位,
     检查方法, 执行标记, 执行频次, 频率次数, 频率间隔, 间隔单位, 执行时间方案, 计价特性, 执行科室id, 执行性质, 紧急标志, 可否分零, 开始执行时间, 执行终止时间, 病人科室id, 开嘱科室id, 开嘱医生,
     开嘱时间, 挂号单, 前提id, 摘要, 零费记帐, 手术时间, 用药目的, 用药理由, 审核状态, 申请序号, 超量说明, 首次用量, 配方id, 手术情况, 组合项目id, 皮试结果)
  Values
    (Id_In, 相关id_In, 序号_In, 病人来源_In, 病人id_In, 主页id_In, v_姓名, v_性别, v_年龄, 婴儿_In, 医嘱状态_In, 医嘱期效_In, 诊疗类别_In, 诊疗项目id_In,
     收费细目id_In, 天数_In, 单次用量_In, 总给予量_In, 医嘱内容_In, 医生嘱托_In, 标本部位_In, 检查方法_In, 执行标记_In, 执行频次_In, 频率次数_In, 频率间隔_In, 间隔单位_In,
     执行时间方案_In, 计价特性_In, 执行科室id_In, 执行性质_In, 紧急标志_In, 可否分零_In, 开始执行时间_In, 执行终止时间_In, 病人科室id_In, 开嘱科室id_In, 开嘱医生_In,
     开嘱时间_In, 挂号单_In, 前提id_In, 摘要_In, 零费记帐_In,
     Decode(诊疗类别_In, 'F', To_Date(标本部位_In, 'yyyy-mm-dd hh24:mi:ss'), 'K', To_Date(标本部位_In, 'yyyy-mm-dd hh24:mi:ss'),
             Null), 用药目的_In, 用药理由_In, 审核状态_In, 申请序号_In, 超量说明_In, 首次用量_In, 配方id_In, 手术情况_In, 组合项目id_In, 皮试结果_In);

  --病人医嘱状态
  If 医嘱状态_In <> -1 Then
    Delete From 病人医嘱状态 Where 医嘱id = Id_In And 操作类型 = 1;
    If Sql%RowCount <> 0 Then
      v_Error := '相同ID的新开医嘱已经存在。';
      Raise Err_Custom;
    End If;
    --因为可能同时：新开->自动校对(住院医生发送)->互斥自动停止(住院医生发送临嘱停止),因此分别-2,-1秒
    Insert Into 病人医嘱状态
      (医嘱id, 操作类型, 操作人员, 操作时间)
    Values
      (Id_In, 1, v_人员姓名, Sysdate - 2 / 60 / 60 / 24);
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人医嘱记录_Insert;
/

--108340:蔡青松,2017-04-18,执行相关操作之前先判断是否收费
Create Or Replace Procedure Zl_检验报告单_Insert
(
  Id_In   In 病人医嘱记录.Id%Type,
  Type_In In Number -- 0=新增 1=删除
) Is
  --HIS和其他LIS接口使用
  v_主页id     病人医嘱记录.主页id%Type;
  v_医嘱id     病人医嘱记录.Id%Type;
  v_开嘱科室id 病人医嘱记录.开嘱科室id%Type;
  v_病人来源   检验标本记录.病人来源%Type;
  v_病人id     检验标本记录.病人id%Type;
  v_婴儿       检验标本记录.婴儿%Type;
  v_病历文件id 病历单据应用.病历文件id%Type;
  v_病历文件名 病历文件列表.名称%Type;
  v_文件id     电子病历内容.文件id%Type;
  v_Temp       Varchar2(255);
  v_人员部门id 部门人员.部门id%Type;
  v_人员编号   人员表.编号%Type;
  v_人员姓名   人员表.姓名%Type;
  v_No         病人医嘱发送.No%Type;
  v_性质       病人医嘱发送.记录性质%Type;
  v_序号       Varchar2(1000);
  v_查阅       Number;
  v_Error      Varchar2(255);
  Err_Custom Exception;
  n_Par Number;
  --查找当前标本的相关申请
  Cursor c_Samplequest Is
    Select Distinct ID As 医嘱id From 病人医嘱记录 Where Id_In In (ID, 相关id);

  --未审核的费用行(不包含药品)
  Cursor c_Verify(v_医嘱id In Number) Is
    Select Distinct 记录性质, NO, 序号, 记录状态, 门诊标志
    From 住院费用记录
    Where 收费类别 Not In ('5', '6', '7') And 医嘱序号 + 0 In (Select ID From 病人医嘱记录 Where v_医嘱id In (ID, 相关id)) And 记帐费用 = 1 And
          记录状态 = 0 And 价格父号 Is Null And
          (记录性质, NO) In (Select 记录性质, NO
                         From 病人医嘱附费
                         Where 医嘱id = v_医嘱id
                         Union All
                         Select 记录性质, NO
                         From 病人医嘱发送
                         Where 医嘱id In (Select ID From 病人医嘱记录 Where v_医嘱id In (ID, 相关id)))
    Order By 记录性质, NO, 序号;

Begin
  --操作员信息:部门ID,部门名称;人员ID,人员编号,人员姓名
  v_Temp       := Zl_Identity;
  v_人员部门id := To_Number(Substr(v_Temp, 1, Instr(v_Temp, ',') - 1));

  v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_人员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
  v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);

  Select Distinct Nvl(b.主页id, 0), Nvl(b.相关id, 0), Decode(b.病人来源, 2, 2, 4, 4, 1), Nvl(b.病人id, 0), Nvl(b.开嘱科室id, 0),
                  Nvl(b.婴儿, 0)
  Into v_主页id, v_医嘱id, v_病人来源, v_病人id, v_开嘱科室id, v_婴儿
  From 病人医嘱记录 B
  Where b.相关id = Id_In;
  If v_病人来源 = 1 Then
    --主页ID： 门诊病人填挂号ID
    Select Nvl(Max(b.Id), 0)
    Into v_主页id
    From 病人挂号记录 B, 病人医嘱记录 A
    Where a.挂号单 = b.No(+) And a.Id = Id_In;
  End If;
  Begin
    Select 病历文件id, c.名称
    Into v_病历文件id, v_病历文件名
    From 病人医嘱记录 A, 病历单据应用 B, 病历文件列表 C
    Where a.诊疗项目id = b.诊疗项目id And b.病历文件id = c.Id And a.相关id = v_医嘱id And b.应用场合 = v_病人来源 And Rownum <= 1;
  Exception
    When Others Then
      Return;
  End;

  If Type_In = 0 Then
    --检查是否收费
    n_Par := Zl_To_Number(Nvl(zl_GetSysParameter(163), '0'));
    If n_Par = 1 Then
      For r_Samplequest In c_Samplequest Loop
        For r_Verify In c_Verify(r_Samplequest.医嘱id) Loop
          If r_Verify.记录状态 = 0 Then
            If r_Verify.门诊标志 = 1 Then
              v_Error := '标本未收费，不允许执行，请联系管理员！';
              Raise Err_Custom;
            Elsif r_Verify.门诊标志 = 2 Then
              v_Error := '标本未记账，不允许执行，请联系管理员！';
              Raise Err_Custom;
            End If;
          End If;
        End Loop;
      End Loop;
    End If;
  
    --新增
    --删除以前的报告记录
    Begin
      Select Nvl(病历id, 0) Into v_文件id From 病人医嘱报告 Where 医嘱id = v_医嘱id And Rownum <= 1;
      If v_文件id > 0 Then
        Delete 电子病历记录 Where ID = v_文件id;
        Delete 电子病历内容 Where 文件id = v_文件id;
      End If;
    Exception
      When Others Then
        Select 电子病历记录_Id.Nextval Into v_文件id From Dual;
        --Insert Into 病人医嘱报告 (医嘱id, 病历id) Values (v_医嘱id, v_文件id);
    End;
  
    Insert Into 电子病历记录
      (ID, 病人来源, 病人id, 主页id, 婴儿, 科室id, 病历种类, 文件id, 病历名称, 创建人, 创建时间, 保存人, 保存时间, 最后版本, 签名级别)
    Values
      (v_文件id, v_病人来源, v_病人id, v_主页id, v_婴儿, v_开嘱科室id, 7, v_病历文件id, v_病历文件名, Null, Sysdate, Null, Sysdate, 1, 0);
  
    Insert Into 病人医嘱报告 (医嘱id, 病历id) Values (v_医嘱id, v_文件id);
  
    Insert Into 电子病历内容
      (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
    Values
      (电子病历内容_Id.Nextval, v_文件id, 1, 1, Null, 1, 2, Null, Null, 0, 0, 0, 0);
  
    Update 病人医嘱发送 Set 执行状态 = 1 Where 医嘱id In (Select ID From 病人医嘱记录 Where v_医嘱id In (ID, 相关id));
  
    --2.检查当前标本相关的申请的相关标本是否完成审核
    For r_Samplequest In c_Samplequest Loop
    
      --r_SampleQuest.医嘱id申请已经完成,处理后续环节
    
      --2.费用执行处理
      If v_性质 = 1 Then
        Update 门诊费用记录
        Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = v_人员姓名
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, NO) In
              (Select 医嘱id, 记录性质, NO
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, NO
               From 病人医嘱发送
               Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID, 相关id)));
      Else
        Update 住院费用记录
        Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = v_人员姓名
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, NO) In
              (Select 医嘱id, 记录性质, NO
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, NO
               From 病人医嘱发送
               Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID, 相关id)));
      End If;
      --3.自动审核记帐
      For r_Verify In c_Verify(r_Samplequest.医嘱id) Loop
        If r_Verify.No || ',' || r_Verify.记录性质 <> v_No || ',' || v_性质 Then
          If v_序号 Is Not Null Then
            If v_性质 = 1 Then
              Zl_门诊记帐记录_Verify(v_No, v_人员编号, v_人员姓名, Substr(v_序号, 2));
            Elsif v_性质 = 2 Then
              Zl_住院记帐记录_Verify(v_No, v_人员编号, v_人员姓名, Substr(v_序号, 2));
            End If;
          End If;
          v_序号 := Null;
        End If;
        v_No   := r_Verify.No;
        v_性质 := r_Verify.记录性质;
        v_序号 := v_序号 || ',' || r_Verify.序号;
      End Loop;
      If v_序号 Is Not Null Then
        If v_性质 = 1 Then
          Zl_门诊记帐记录_Verify(v_No, v_人员编号, v_人员姓名, Substr(v_序号, 2));
        Elsif v_性质 = 2 Then
          Zl_住院记帐记录_Verify(v_No, v_人员编号, v_人员姓名, Substr(v_序号, 2));
        End If;
      End If;
    
    End Loop;
  Else
    --删除
  
    v_查阅 := 0;
    Select Nvl(查阅状态, 0) Into v_查阅 From 病人医嘱报告 Where 医嘱id = v_医嘱id;
    If v_查阅 = 0 Then
      Select 病历id Into v_文件id From 病人医嘱报告 Where 医嘱id = v_医嘱id And Rownum <= 1;
      Delete 病人医嘱报告 Where 医嘱id = v_医嘱id;
      Delete 电子病历记录 Where ID = v_文件id;
      Delete 电子病历内容 Where 文件id = v_文件id;
      Update 病人医嘱发送
      Set 执行状态 = 0
      Where 医嘱id In (Select ID From 病人医嘱记录 Where v_医嘱id In (ID, 相关id));
      For r_Samplequest In c_Samplequest Loop
        --2.费用执行处理
        If v_性质 = 1 Then
          Update 门诊费用记录
          Set 执行状态 = 0, 执行时间 = Null, 执行人 = Null
          Where 收费类别 Not In ('5', '6', '7') And
                (医嘱序号, 记录性质, NO) In
                (Select 医嘱id, 记录性质, NO
                 From 病人医嘱附费
                 Where 医嘱id = r_Samplequest.医嘱id
                 Union All
                 Select 医嘱id, 记录性质, NO
                 From 病人医嘱发送
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID, 相关id)));
        Else
          Update 住院费用记录
          Set 执行状态 = 0, 执行时间 = Null, 执行人 = Null
          Where 收费类别 Not In ('5', '6', '7') And
                (医嘱序号, 记录性质, NO) In
                (Select 医嘱id, 记录性质, NO
                 From 病人医嘱附费
                 Where 医嘱id = r_Samplequest.医嘱id
                 Union All
                 Select 医嘱id, 记录性质, NO
                 From 病人医嘱发送
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID, 相关id)));
        End If;
      End Loop;
    Else
      v_Error := '该报告已经被医生查阅，不能取消，请联系医生。';
      Raise Err_Custom;
    End If;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_检验报告单_Insert;
/

--108340:蔡青松,2017-04-18,执行相关操作之前先判断是否收费
Create Or Replace Procedure Zl_检验预置条码_采集完成
(
  医嘱内容_In Varchar2, --内容包括多个医嘱ID使用","分隔 
  人员编号_In 人员表.编号%Type := Null,
  人员姓名_In 人员表.姓名%Type := Null --Null=取消，不为空时完成采集 
) Is
  --查找当前标本的相关申请 
  Cursor c_Samplequest(v_医嘱id In Varchar2) Is
    Select /*+ rule */
    Distinct ID As 医嘱id, 病人来源
    From 病人医嘱记录 A, 病人医嘱发送 B
    Where a.Id = b.医嘱id And b.接收人 Is Null And 相关id Is Null And
          a.Id In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist)));

  --未审核的费用行(不包含药品) 
  Cursor c_Verify(v_医嘱id In Varchar2) Is
    Select /*+ rule */
    Distinct 记录性质, NO, 序号, 记录状态,门诊标志
    From 住院费用记录
    Where 收费类别 Not In ('5', '6', '7') And
          医嘱序号 + 0 In
          (Select ID
           From 病人医嘱记录
           Where ID In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist))) And 相关id Is Null) And
          记帐费用 = 1 And 记录状态 = 0 And 价格父号 Is Null And
          (记录性质, NO) In (Select 记录性质, NO
                         From 病人医嘱附费
                         Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist)))
                         Union All
                         Select 记录性质, NO
                         From 病人医嘱发送
                         Where 医嘱id In (Select ID
                                        From 病人医嘱记录
                                        Where ID In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist))) And
                                              相关id Is Null) And 接收人 Is Null)
    Union All
    Select /*+ rule */
    Distinct 记录性质, NO, 序号, 记录状态,门诊标志
    From 门诊费用记录
    Where 收费类别 Not In ('5', '6', '7') And
          医嘱序号 + 0 In
          (Select ID
           From 病人医嘱记录
           Where ID In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist))) And 相关id Is Null) And
          记帐费用 = 1 And 记录状态 = 0 And 价格父号 Is Null And
          (记录性质, NO) In (Select 记录性质, NO
                         From 病人医嘱附费
                         Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist)))
                         Union All
                         Select 记录性质, NO
                         From 病人医嘱发送
                         Where 医嘱id In (Select ID
                                        From 病人医嘱记录
                                        Where ID In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist))) And
                                              相关id Is Null) And 接收人 Is Null)
    Order By 记录性质, NO, 序号;

  v_检验标本记录 Number(18);
  v_执行状态     Number(1);
  v_接收人       Varchar2(50);
  v_Error        Varchar2(100);
  v_No           病人医嘱发送.No%Type;
  v_性质         病人医嘱发送.记录性质%Type;
  v_序号         Varchar2(1000);
  Err_Custom Exception;
  n_Par Number;
Begin

  If 人员姓名_In Is Not Null Then
    --检查标本是否被核收或接收 
    Begin
      Select /*+ rule */
       Nvl(c.Id, 0), b.执行状态, b.接收人
      Into v_检验标本记录, v_执行状态, v_接收人
      From 病人医嘱记录 A, 病人医嘱发送 B, 检验标本记录 C
      Where a.Id = b.医嘱id And a.相关id = c.医嘱id(+) And
            a.Id In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist)));
    Exception
      When Others Then
        v_检验标本记录 := 0;
    End;
  
    If v_检验标本记录 <> 0 Then
      v_Error := '标本已被检验科核收不能完成采集!';
      Raise Err_Custom;
    End If;
  
    If v_执行状态 <> 2 And v_接收人 Is Not Null Then
      v_Error := '标本已被检验科签收不能完成采集!';
      Raise Err_Custom;
    End If;
  
    --检查医嘱是否收费
    n_Par := Zl_To_Number(Nvl(zl_GetSysParameter(163), '0'));
    If n_Par = 1 Then
      For r_Verify In c_Verify(医嘱内容_In) Loop
        If r_Verify.记录状态 = 0 Then
          If r_Verify.门诊标志 = 1 Then
            v_Error := '标本未收费，不允许执行，请联系管理员！';
            Raise Err_Custom;
          Elsif r_Verify.门诊标志 = 2 Then
            v_Error := '标本未记账，不允许执行，请联系管理员！';
            Raise Err_Custom;
          End If;
        End If;
      End Loop;
    End If;
  
    Update /*+ rule */ 检验拒收记录
    Set 重采人 = 人员姓名_In, 重采时间 = Sysdate
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist)));
  
    --更新采集信息(检验和采集） 
    Update /*+ rule */ 病人医嘱发送
    Set 采样人 = 人员姓名_In, 采样时间 = Sysdate, 执行状态 = Decode(执行状态, 2, 0, 执行状态),
        重采标本 = Decode(Nvl(重采标本, 0), 0, Decode(执行状态, 2, 1, 0), 重采标本), 执行说明 = Null
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist)));
  
    --更新医嘱和费用记录 
    For r_Samplequest In c_Samplequest(医嘱内容_In) Loop
      If r_Samplequest.病人来源 = 2 Then
        --2.费用执行处理 
        Update 住院费用记录
        Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, NO) In (Select 医嘱id, 记录性质, NO
                                   From 病人医嘱附费
                                   Where 医嘱id = r_Samplequest.医嘱id
                                   Union All
                                   Select 医嘱id, 记录性质, NO
                                   From 病人医嘱发送
                                   Where 医嘱id In (Select ID
                                                  From 病人医嘱记录 A, 病人医嘱发送 B
                                                  Where a.Id = b.医嘱id And r_Samplequest.医嘱id In (a.Id) And a.相关id Is Null And
                                                        b.执行状态 In (0, 2) And b.接收人 Is Null));
      Else
        --2.费用执行处理 
        Update 门诊费用记录
        Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, NO) In (Select 医嘱id, 记录性质, NO
                                   From 病人医嘱附费
                                   Where 医嘱id = r_Samplequest.医嘱id
                                   Union All
                                   Select 医嘱id, 记录性质, NO
                                   From 病人医嘱发送
                                   Where 医嘱id In (Select ID
                                                  From 病人医嘱记录 A, 病人医嘱发送 B
                                                  Where a.Id = b.医嘱id And r_Samplequest.医嘱id In (a.Id) And a.相关id Is Null And
                                                        b.执行状态 In (0, 2) And b.接收人 Is Null));
      End If;
    End Loop;
  
    --更新执行状态(只更新采集） 
    Update /*+ rule */ 病人医嘱发送
    Set 执行状态 = 1, 完成人 = 人员姓名_In, 完成时间 = Sysdate
    Where 医嘱id In
          (Select ID
           From 病人医嘱记录
           Where ID In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist))) And 相关id Is Null);
  
    --3.自动审核记帐 
    For r_Verify In c_Verify(医嘱内容_In) Loop
      If r_Verify.No || ',' || r_Verify.记录性质 <> v_No || ',' || v_性质 Then
        If v_序号 Is Not Null Then
          If v_性质 = 1 Then
            Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
          Elsif v_性质 = 2 Then
            Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
          End If;
        End If;
        v_序号 := Null;
      End If;
      v_No   := r_Verify.No;
      v_性质 := r_Verify.记录性质;
      v_序号 := v_序号 || ',' || r_Verify.序号;
    End Loop;
    If v_序号 Is Not Null Then
      If v_性质 = 1 Then
        Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
      Elsif v_性质 = 2 Then
        Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
      End If;
    End If;
  
  Else
    --检查标本是否被核收或接收 
    Begin
      Select /*+ rule */
       Nvl(c.Id, 0), b.执行状态, b.接收人
      Into v_检验标本记录, v_执行状态, v_接收人
      From 病人医嘱记录 A, 病人医嘱发送 B, 检验标本记录 C
      Where a.Id = b.医嘱id And a.相关id = c.医嘱id(+) And
            a.Id In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist)));
    Exception
      When Others Then
        v_检验标本记录 := 0;
    End;
  
    If v_检验标本记录 <> 0 Then
      v_Error := '标本已被检验科核收不能取消完成采集!';
      Raise Err_Custom;
    End If;
  
    If v_执行状态 <> 2 And v_接收人 Is Not Null Then
      v_Error := '标本已被检验科签收不能取消完成采集!';
      Raise Err_Custom;
    End If;
  
    Update /*+ rule */ 病人医嘱发送
    Set 采样人 = Null, 采样时间 = Null, 执行状态 = 0, 执行说明 = Null, 完成人 = Null, 完成时间 = Null
    Where 医嘱id In (Select ID
                   From 病人医嘱记录
                   Where ID In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist))));
  
    For r_Samplequest In c_Samplequest(医嘱内容_In) Loop
    
      If r_Samplequest.病人来源 = 2 Then
        --2.费用执行处理 
        Update 住院费用记录
        Set 执行状态 = 0, 执行时间 = Null, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, NO) In
              (Select 医嘱id, 记录性质, NO
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, NO
               From 病人医嘱发送
               Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID) And 相关id Is Null) And
                     执行状态 In (0, 2) And 接收人 Is Null);
      Else
        Update 门诊费用记录
        Set 执行状态 = 0, 执行时间 = Null, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, NO) In
              (Select 医嘱id, 记录性质, NO
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, NO
               From 病人医嘱发送
               Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID) And 相关id Is Null) And
                     执行状态 In (0, 2) And 接收人 Is Null);
      End If;
    End Loop;
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_检验预置条码_采集完成;
/

--108340:蔡青松,2017-04-18,执行相关操作之前先判断是否收费
Create Or Replace Procedure Zl_检验标本记录_报告审核
(
  Id_In       检验标本记录.Id%Type,
  审核人_In   检验标本记录.审核人%Type := Null,
  人员编号_In 人员表.编号%Type := Null,
  人员姓名_In 人员表.姓名%Type := Null
) Is

  --未审核的费用行(不包含药品) 
  Cursor c_Verify(v_医嘱id In Number) Is
    Select Distinct 2 As 记录性质, NO, 序号, 记录状态, 门诊标志
    From 住院费用记录
    Where 收费类别 Not In ('5', '6', '7') And 记帐费用 = 1 And 价格父号 Is Null And
          (记录性质, NO) In (Select 记录性质, NO
                         From 病人医嘱附费
                         Where 医嘱id = v_医嘱id
                         Union All
                         Select 记录性质, NO
                         From 病人医嘱发送
                         Where 医嘱id In (Select ID From 病人医嘱记录 Where v_医嘱id In (ID, 相关id))) And 医嘱序号 = v_医嘱id
    Union All
    Select Distinct 1 As 记录性质, NO, 序号, 记录状态,门诊标志
    From 门诊费用记录
    Where 收费类别 Not In ('5', '6', '7') And 记帐费用 = 1 And 价格父号 Is Null And
          (记录性质, NO) In (Select 记录性质, NO
                         From 病人医嘱附费
                         Where 医嘱id = v_医嘱id
                         Union All
                         Select 记录性质, NO
                         From 病人医嘱发送
                         Where 医嘱id In (Select ID From 病人医嘱记录 Where v_医嘱id In (ID, 相关id))) And 医嘱序号 = v_医嘱id
    Order By 记录性质, NO, 序号;

  --查找当前标本的相关申请 
  Cursor c_Samplequest(v_微生物 In Number) Is
    Select Distinct 医嘱id, 病人来源
    From (Select a.医嘱id, b.病人来源
           From 检验项目分布 A, 检验标本记录 B
           Where 0 = v_微生物 And a.标本id = Id_In And a.医嘱id Is Not Null And a.标本id = b.Id
           Union
           Select a.医嘱id, b.病人来源
           From 检验项目分布 A, 检验标本记录 B
           Where 1 = v_微生物 And a.标本id = Id_In And a.医嘱id Is Not Null And a.标本id = b.Id
           Union
           Select b.Id As 医嘱id, a.病人来源
           From 检验标本记录 A, 病人医嘱记录 B
           Where a.Id = Id_In And a.医嘱id = b.相关id);

  Cursor c_Stuff
  (
    v_No     Varchar2,
    v_主页id Number
  ) Is
    Select NO, 单据, 库房id
    From 未发药品记录
    Where NO = v_No And 单据 In (24, 25, 26) And 库房id Is Not Null And Not Exists
     (Select 1 From Dual Where zl_GetSysParameter(Decode(v_主页id, Null, 92, 63)) = '1') And Exists
     (Select a.序号
           From 住院费用记录 A, 材料特性 B
           Where a.记录性质 = 2 And a.记录状态 = 1 And a.No = v_No And a.收费细目id = b.材料id And b.跟踪在用 = 1
           Union All
           Select a.序号
           From 门诊费用记录 A, 材料特性 B
           Where a.记录性质 = 2 And a.记录状态 = 1 And a.No = v_No And a.收费细目id = b.材料id And b.跟踪在用 = 1)
    Order By 库房id;

  v_执行  Number(1);
  v_No    病人医嘱发送.No%Type;
  v_Nonew 病人医嘱发送.No%Type;
  v_性质  病人医嘱发送.记录性质%Type;
  v_序号  Varchar2(1000);

  v_Count      Number(18);
  v_Counts     Number(18);
  v_微生物标本 Number(1) := 0;
  v_主页id     Number(18);
  v_婴儿       Number(1);
  v_年龄       Varchar2(100);
  v_仪器       Number(18);
  v_Intloop    Number;
  Err_Custom Exception;
  v_Error Varchar2(100);

  n_Par Number;
Begin
  Select Nvl(婴儿, 0), 年龄 Into v_婴儿, v_年龄 From 检验标本记录 Where ID = Id_In;

  --执行后自动审核对应的记帐划价单(不包含药品) 
  v_执行 := 1;

  v_微生物标本 := 0;
  Begin
    Select 1 Into v_微生物标本 From 检验标本记录 Where 微生物标本 = 1 And ID = Id_In;
  Exception
    When Others Then
      v_微生物标本 := 0;
  End;

  --先判断医嘱是否收费
  n_Par := Zl_To_Number(Nvl(zl_GetSysParameter(163), '0'));
  If n_Par = 1 Then
    For r_Samplequest In c_Samplequest(v_微生物标本) Loop
      For r_相关医嘱 In (Select ID As 医嘱id From 病人医嘱记录 Where 相关id = r_Samplequest.医嘱id) Loop
        For r_Verify In c_Verify(r_相关医嘱.医嘱id) Loop
          If r_Verify.记录状态 = 0 Then
            If r_Verify.门诊标志 = 1 Then
              v_Error := '标本未收费，不允许执行，请联系管理员！';
              Raise Err_Custom;
            Elsif r_Verify.门诊标志 = 2 Then
              v_Error := '标本未记账，不允许执行，请联系管理员！';
              Raise Err_Custom;
            End If;
          End If;
        End Loop;
      End Loop;
    End Loop;
  End If;

  --1.置本标本的状态及审核人和时间 
  Update 检验标本记录
  Set 审核人 = Decode(审核人_In, Null, 人员姓名_In, 审核人_In), 审核时间 = Sysdate, 样本状态 = 2
  Where ID = Id_In;

  --记录审核过程 
  Insert Into 检验操作记录
    (ID, 标本id, 操作类型, 操作员, 操作时间)
  Values
    (检验操作记录_Id.Nextval, Id_In, 0, Decode(审核人_In, Null, 人员姓名_In, 审核人_In), Sysdate);

  --2.检查当前标本相关的申请的相关标本是否完成审核 
  For r_Samplequest In c_Samplequest(v_微生物标本) Loop
  
    v_Count := 0;
  
    If v_微生物标本 = 0 Then
      Begin
        Select Nvl(Count(1), 0)
        Into v_Count
        From 检验标本记录
        Where 样本状态 < 2 And ID In (Select 标本id From 检验项目分布 Where 医嘱id = r_Samplequest.医嘱id);
      Exception
        When Others Then
          v_Count := 0;
      End;
    End If;
  
    --r_SampleQuest.医嘱id申请已经完成,处理后续环节 
    If v_Count = 0 Then
    
      --1.置申请单的执行状态 
      Update 病人医嘱发送
      Set 执行状态 = 1, 完成人 = 人员姓名_In, 完成时间 = Sysdate
      Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID, 相关id));
    
      Update 病人医嘱发送
      Set 执行状态 = 1, 完成人 = 人员姓名_In, 完成时间 = Sysdate
      Where 医嘱id In (Select 相关id
                     From 病人医嘱记录
                     Where ID In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID, 相关id)));
    
      If r_Samplequest.病人来源 = 2 Then
        --2.费用执行处理 
        Update 住院费用记录
        Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, NO) In
              (Select 医嘱id, 记录性质, NO
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, NO
               From 病人医嘱发送
               Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID, 相关id)));
      Else
        Update 门诊费用记录
        Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, NO) In
              (Select 医嘱id, 记录性质, NO
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, NO
               From 病人医嘱发送
               Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID, 相关id)));
      End If;
    
      --3.自动审核记帐 
      If v_执行 = 1 Then
        Select Count(*) Into v_Counts From 病人医嘱记录 Where 相关id = r_Samplequest.医嘱id;
        If v_Counts > 0 Then
          For r_相关医嘱 In (Select ID As 医嘱id From 病人医嘱记录 Where 相关id = r_Samplequest.医嘱id) Loop
            For r_Verify In c_Verify(r_相关医嘱.医嘱id) Loop
              If r_Verify.No || ',' || r_Verify.记录性质 <> v_No || ',' || v_性质 Then
                If v_序号 Is Not Null Then
                  If v_性质 = 1 Then
                    Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
                  Elsif v_性质 = 2 Then
                    Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
                  End If;
                End If;
                v_序号 := Null;
              End If;
              v_No   := r_Verify.No;
              v_性质 := r_Verify.记录性质;
              v_序号 := v_序号 || ',' || r_Verify.序号;
            End Loop;
          End Loop;
        Else
          For r_Verify In c_Verify(r_Samplequest.医嘱id) Loop
            If r_Verify.No || ',' || r_Verify.记录性质 <> v_No || ',' || v_性质 Then
              If v_序号 Is Not Null Then
                If v_性质 = 1 Then
                  Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
                Elsif v_性质 = 2 Then
                  Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
                End If;
              End If;
              v_序号 := Null;
            End If;
            v_No   := r_Verify.No;
            v_性质 := r_Verify.记录性质;
            v_序号 := v_序号 || ',' || r_Verify.序号;
          End Loop;
        End If;
        If v_序号 Is Not Null Then
          If v_性质 = 1 Then
            Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
          Elsif v_性质 = 2 Then
            Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
          End If;
          v_序号 := Null;
          --  v_性质 := null; 
        End If;
      End If;
    
      --审核试剂消耗单 
      v_Intloop := 1;
    
      Select 仪器id Into v_仪器 From 检验标本记录 Where ID = Id_In;
      For r_检验试剂 In (Select c.材料id, c.数量
                     From 病人医嘱记录 A, 检验报告项目 B, 检验试剂关系 C
                     Where a.相关id = r_Samplequest.医嘱id And a.诊疗项目id = b.诊疗项目id And b.报告项目id = c.项目id And c.仪器id = v_仪器) Loop
        Zl_检验试剂记录_Insert(r_Samplequest.医嘱id, v_Intloop, r_检验试剂.材料id, r_检验试剂.数量);
        v_Intloop := v_Intloop + 1;
      End Loop;
      Select Count(*) Into v_Intloop From 检验试剂记录 Where 医嘱id = r_Samplequest.医嘱id And NO Is Null;
      If v_Intloop > 1 Then
        v_Nonew := Nextno(14);
        Update 检验试剂记录 Set NO = v_Nonew Where 医嘱id = r_Samplequest.医嘱id;
      End If;
      If v_Nonew Is Not Null Then
      
        Zl_检验试剂记录_Bill(r_Samplequest.医嘱id, v_Nonew);
      
        v_主页id := Null;
        Select 主页id Into v_主页id From 病人医嘱记录 A Where ID = r_Samplequest.医嘱id;
      
        If v_主页id Is Null Then
          Zl_门诊记帐记录_Verify(v_Nonew, 人员编号_In, 人员姓名_In);
        Else
          Zl_住院记帐记录_Verify(v_Nonew, 人员编号_In, 人员姓名_In);
        End If;
      
        --如果记帐没有自动发料,则自动发料,否则不处理 
        For r_Stuff In c_Stuff(v_Nonew, v_主页id) Loop
          Zl_材料收发记录_处方发料(r_Stuff.库房id, 25, v_Nonew, 人员姓名_In, 人员姓名_In, 人员姓名_In, 1, Sysdate);
        End Loop;
      End If;
    End If;
  End Loop;
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 9, 0 || ',' || Id_In;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_检验标本记录_报告审核;
/

--108340:蔡青松,2017-04-18,执行相关操作之前先判断是否收费
Create Or Replace Procedure Zl_检验标本记录_标本核收
(
  Id_In         In 检验标本记录.Id%Type,
  医嘱id_In     In 检验标本记录.医嘱id%Type,
  多个医嘱_In   In Varchar2, --用于更新多个医嘱的执行状态 
  复盖标本id_In In 检验标本记录.Id%Type := 0, --补填时指向另一个标本时复盖指向的标本 
  标本序号_In   In 检验标本记录.标本序号%Type,
  采样时间_In   In 检验标本记录.采样时间%Type,
  采样人_In     In 检验标本记录.采样人%Type,
  仪器id_In     In 检验标本记录.仪器id%Type,
  核收时间_In   In 检验标本记录.核收时间%Type,
  标本形态_In   In 检验标本记录.标本形态%Type,
  检验人_In     In 检验标本记录.检验人%Type := Null,
  检验时间_In   In 检验标本记录.检验时间%Type := Null,
  微生物标本_In In 检验标本记录.微生物标本%Type := Null,
  标本类别_In   In 检验标本记录.标本类别%Type := 0,
  检验备注_In   In 检验标本记录.检验备注%Type := Null,
  姓名_In       In 检验标本记录.姓名%Type := Null,
  性别_In       In 检验标本记录.性别%Type := Null,
  年龄_In       In 检验标本记录.年龄%Type := Null,
  No_In         In 检验标本记录.No%Type := Null,
  标本类型_In   In 检验标本记录.标本类型%Type := Null,
  申请科室id_In In 检验标本记录.申请科室id%Type := Null,
  申请人_In     In 检验标本记录.申请人%Type := Null,
  标识号_In     In 检验标本记录.标识号%Type := Null,
  床号_In       In 检验标本记录.床号%Type := Null,
  病人科室_In   In 检验标本记录.病人科室%Type := Null,
  检验项目_In   In 检验标本记录.检验项目%Type := Null,
  申请类型_In   In 检验标本记录.申请类型%Type := Null,
  病人id_In     In 检验标本记录.病人id%Type := Null,
  执行科室_In   In 检验标本记录.执行科室id%Type := Null,
  人员编号_In   In 人员表.编号%Type := Null,
  人员姓名_In   In 人员表.姓名%Type := Null
) Is

  Cursor v_Advice Is
    Select /*+ Rule */
    Distinct a.Id, a.开嘱时间, a.标本部位, f.样本条码, a.执行科室id, a.诊疗项目id, a.开嘱科室id, a.开嘱医生, a.病人id, a.病人来源, a.婴儿, a.紧急标志 As 紧急,
             b.门诊号, b.住院号, b.出生日期, a.挂号单, Decode(c.主页id, 0, Null, c.主页id) As 主页id, d.操作类型, f.接收人, f.接收时间
    From 病人医嘱记录 A, 病人医嘱发送 F, 病人信息 B, 病案主页 C, 诊疗项目目录 D
    Where a.相关id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist))) And a.Id = f.医嘱id And
          a.病人id = b.病人id And a.病人id = c.病人id(+) And a.主页id = c.主页id(+) And a.诊疗项目id = d.Id(+);

  Cursor v_Advice_1 Is
    Select /*+ Rule */
    Distinct b.No As 单据号, a.相关id
    From 病人医嘱记录 A, 病人医嘱发送 B
    Where a.Id = b.医嘱id And a.相关id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)))
    Union All
    Select /*+ Rule */
    Distinct b.No As 单据号, a.相关id
    From 病人医嘱记录 A, 病人医嘱发送 B
    Where a.Id = b.医嘱id And a.Id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)));

  Cursor v_Patient Is
    Select 病人id, 住院号, 门诊号, 出生日期 From 病人信息 Where 病人id = 病人id_In;

  --未审核的费用行(不包含药品) 
  Cursor c_Verify(v_医嘱id In Number) Is
    Select /*+ Rule */
    Distinct a.记录性质, a.No, a.序号, a.医嘱序号, a.门诊标志, a.记录状态
    From 住院费用记录 A, 病人医嘱发送 B,
         (Select ID
           From 病人医嘱记录
           Where ID In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)))
           Union All
           Select ID
           From 病人医嘱记录
           Where 相关id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)))) C
    Where a.收费类别 Not In ('5', '6', '7') And a.医嘱序号 = c.Id And a.记录状态 = 0 And 价格父号 Is Null And a.医嘱序号 = b.医嘱id And
          a.记录性质 = b.记录性质 And a.No = b.No And a.记帐费用 = 1
    Union All
    Select /*+ Rule */
    Distinct a.记录性质, a.No, a.序号, a.医嘱序号, a.门诊标志, a.记录状态
    From 住院费用记录 A, 病人医嘱附费 B,
         (Select ID
           From 病人医嘱记录
           Where ID In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)))
           Union All
           Select ID
           From 病人医嘱记录
           Where 相关id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)))) C
    Where a.收费类别 Not In ('5', '6', '7') And a.医嘱序号 = c.Id And a.记录状态 = 0 And 价格父号 Is Null And a.医嘱序号 = b.医嘱id And
          a.记录性质 = b.记录性质 And a.No = b.No And a.记帐费用 = 1
    Union All
    Select /*+ Rule */
    Distinct a.记录性质, a.No, a.序号, a.医嘱序号, a.门诊标志, a.记录状态
    From 门诊费用记录 A, 病人医嘱发送 B,
         (Select ID
           From 病人医嘱记录
           Where ID In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)))
           Union All
           Select ID
           From 病人医嘱记录
           Where 相关id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)))) C
    Where a.收费类别 Not In ('5', '6', '7') And a.医嘱序号 = c.Id And a.记录状态 = 0 And 价格父号 Is Null And a.医嘱序号 = b.医嘱id And
          a.记录性质 = b.记录性质 And a.No = b.No And a.记帐费用 = 1
    Union All
    Select /*+ Rule */
    Distinct a.记录性质, a.No, a.序号, a.医嘱序号, a.门诊标志, a.记录状态
    From 门诊费用记录 A, 病人医嘱附费 B,
         (Select ID
           From 病人医嘱记录
           Where ID In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)))
           Union All
           Select ID
           From 病人医嘱记录
           Where 相关id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)))) C
    Where a.收费类别 Not In ('5', '6', '7') And a.医嘱序号 = c.Id And a.记录状态 = 0 And 价格父号 Is Null And a.医嘱序号 = b.医嘱id And
          a.记录性质 = b.记录性质 And a.No = b.No And a.记帐费用 = 1
    Order By 记录性质, NO, 序号;

  --查找当前标本的相关申请 
  Cursor c_Samplequest(v_微生物 In Number) Is
    Select Distinct 医嘱id, 病人来源
    From (Select Decode(a.医嘱id, Null, b.医嘱id, a.医嘱id) As 医嘱id, b.病人来源
           From 检验项目分布 A, 检验标本记录 B
           Where Nvl(v_微生物, 0) = 0 And a.标本id = b.Id And b.医嘱id In (Select 医嘱id From 检验标本记录 Where ID = Id_In) And
                 a.医嘱id Is Not Null
           Union
           Select Decode(a.医嘱id, Null, b.医嘱id, a.医嘱id) As 医嘱id, b.病人来源
           From 检验项目分布 A, 检验标本记录 B
           Where 1 = v_微生物 And b.Id = a.标本id And b.Id = Id_In
           Union
           Select b.Id As 医嘱id, b.病人来源
           From 检验标本记录 A, 病人医嘱记录 B
           Where a.Id = Id_In And a.医嘱id In (b.Id, b.相关id));

  Cursor c_Stuff
  (
    v_No     Varchar2,
    v_主页id Number
  ) Is
    Select NO As 单据号, 单据, 库房id
    From 未发药品记录
    Where NO = v_No And 单据 In (24, 25, 26) And 库房id Is Not Null And Not Exists
     (Select 1 From Dual Where zl_GetSysParameter(Decode(v_主页id, Null, 92, 63)) = '1') And Exists
     (Select a.序号
           From 住院费用记录 A, 材料特性 B
           Where a.记录性质 = 2 And a.No = v_No And a.收费细目id = b.材料id And b.跟踪在用 = 1
           Union All
           Select a.序号
           From 门诊费用记录 A, 材料特性 B
           Where a.记录性质 = 2 And a.No = v_No And a.收费细目id = b.材料id And b.跟踪在用 = 1)
    Order By 库房id;

  r_Advice   v_Advice%RowType;
  r_Advice_1 v_Advice_1%RowType;
  r_Patient  v_Patient%RowType;

  Err_Custom Exception;
  v_Error Varchar2(1000);
  v_Flag  Number(18);

  v_Temp      Varchar2(255);
  v_Seq       Number;
  v_Union     Number;
  v_Patientid Number;
  v_Itemid    Number;
  v_Count     Number;
  v_No        病人医嘱发送.No%Type;
  v_性质      病人医嘱发送.记录性质%Type;
  v_序号      Varchar2(1000);
  v_主页id    Number(18);
  v_门诊标志  住院费用记录.门诊标志%Type;
  n_Count     Number;
  v_姓名      病人医嘱记录.姓名%Type;
  v_性别      病人医嘱记录.性别%Type;
  v_年龄      病人医嘱记录.年龄%Type;
  v_病人来源  病人医嘱记录.病人来源%Type;
  v_婴儿      病人医嘱记录.婴儿%Type;
  v_婴儿姓名  病人医嘱记录.姓名%Type;
  v_婴儿性别  病人医嘱记录.性别%Type;

  n_Par Number;
Begin

  If Nvl(复盖标本id_In, 0) > 0 Then
    Begin
      Select 姓名 Into v_Temp From 检验标本记录 Where ID = 复盖标本id_In And 姓名 Is Null;
    Exception
      When Others Then
        v_Error := '指定复盖的标本已被核收或已删除，请重新指定！';
        Raise Err_Custom;
    End;
  End If;

  If Nvl(医嘱id_In, 0) > 0 Then
    Select 姓名, 性别, 年龄, 病人来源, 婴儿
    Into v_姓名, v_性别, v_年龄, v_病人来源, v_婴儿
    From 病人医嘱记录
    Where ID = 医嘱id_In;
  
    If v_病人来源 <> 3 Then
      If Nvl(v_婴儿, 0) = 0 Then
        If v_姓名 <> 姓名_In Or v_性别 <> 性别_In Then
          v_Error := '病人姓名、性别、年龄和医嘱不符不能保存，请检查或修改病人信息后再进行保存！';
          Raise Err_Custom;
        End If;
      Else
        Select b.婴儿姓名, b.婴儿性别
        Into v_婴儿姓名, v_婴儿性别
        From 病人医嘱记录 A, 病人新生儿记录 B
        Where a.病人id = b.病人id And a.主页id = b.主页id And a.婴儿 = b.序号 And
              a.相关id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist))) And Rownum = 1;
      
        If v_婴儿姓名 <> 姓名_In Or v_婴儿性别 <> 性别_In Then
          v_Error := '病人姓名、性别、年龄和医嘱不符不能保存，请检查或修改病人信息后再进行保存！';
          Raise Err_Custom;
        End If;
      End If;
    End If;
  
    Select Count(ID) Into v_Flag From 检验标本记录 Where 医嘱id = 医嘱id_In And ID <> Id_In;
    If v_Flag > 0 Then
      Select Count(Distinct b.报告项目id)
      Into v_Flag
      From 病人医嘱记录 A, 检验报告项目 B
      Where a.诊疗项目id = b.诊疗项目id And a.相关id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)));
    
      Select Count(a.项目id)
      Into n_Count
      From 检验项目分布 A
      Where a.医嘱id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist))) And a.标本id <> Id_In;
      If (v_Flag - n_Count) <= 0 Then
        v_Error := '当前医嘱已被核收，不能重复核收！';
        Raise Err_Custom;
      End If;
    End If;
  End If;

  --判断医嘱是否收费
  n_Par := Zl_To_Number(Nvl(zl_GetSysParameter(163), '0'));
  If n_Par = 1 Then
    For r_Advice_1 In v_Advice_1 Loop
      For r_Verify In c_Verify(r_Advice_1.相关id) Loop
        If r_Verify.记录状态 = 0 Then
          If r_Verify.门诊标志 = 1 Then
            v_Error := '标本未收费，不允许执行，请联系管理员！';
            Raise Err_Custom;
          Elsif r_Verify.门诊标志 = 2 Then
            v_Error := '标本未记账，不允许执行，请联系管理员！';
            Raise Err_Custom;
          End If;
        End If;
      End Loop;
    End Loop;
  End If;

  If 医嘱id_In = 0 Then
    Open v_Patient;
    Fetch v_Patient
      Into r_Patient;
  
    If v_Patient%Found Then
      Zl_病人信息_锁定检查(r_Patient.病人id);
    End If;
  
    Update 检验标本记录
    Set 采样时间 = Decode(采样时间_In, Null, 采样时间, 采样时间_In), 采样人 = Decode(采样人_In, Null, 采样人, 采样人_In), 标本类型 = Nvl(标本类型_In, 标本类型),
        检验时间 = 检验时间_In, 姓名 = Decode(姓名_In, Null, 姓名, 姓名_In), 性别 = Decode(性别_In, Null, 性别, 性别_In),
        年龄 = Decode(年龄_In, Null, 年龄, 年龄_In), 年龄数字 = Decode(年龄_In, Null, Null, Zl_Val(年龄_In)),
        年龄单位 = Decode(年龄_In, Null, 年龄单位,
                       Decode(年龄_In, Null, Null, '成人', '成人', '婴儿', '婴儿',
                               Decode(Sign(Instr(年龄_In, '岁')), 1, '岁',
                                       Decode(Sign(Instr(年龄_In, '月')), 1, '月',
                                               Decode(Sign(Instr(年龄_In, '天')), 1, '天',
                                                       Decode(Sign(Instr(年龄_In, '小时')), 1, '小时', Null)))))),
        申请科室id = Decode(申请科室id_In, Null, 申请科室id, 申请科室id_In), 申请人 = Decode(申请人_In, Null, 申请人, 申请人_In),
        标本形态 = Decode(标本形态_In, Null, 标本形态, 标本形态_In), 标识号 = Decode(标识号_In, Null, 标识号, 标识号_In),
        床号 = Decode(床号_In, Null, 床号, 床号_In), 病人科室 = Decode(病人科室_In, Null, 病人科室, 病人科室_In),
        检验项目 = Decode(检验项目_In, Null, 检验项目, 检验项目_In), 病人id = Decode(病人id_In, Null, 病人id, 病人id_In),
        医嘱id = Decode(医嘱id_In, Null, 医嘱id, 0, 医嘱id, 医嘱id_In)
    Where ID = Id_In;
    If Sql%NotFound Then
      Insert Into 检验标本记录
        (ID, 医嘱id, 标本序号, 采样时间, 采样人, 标本类型, 核收人, 核收时间, 样本状态, 申请类型, 仪器id, 样本条码, 申请时间, 标本形态, 报告结果, 执行科室id, 检验人, 检验时间, 微生物标本,
         标本类别, 检验备注, 申请科室id, 申请人, 姓名, 性别, 年龄, 年龄数字, 年龄单位, 病人id, 病人来源, 婴儿, NO, 合并id, 标识号, 床号, 病人科室, 紧急, 门诊号, 住院号, 出生日期,
         挂号单, 主页id, 检验项目, 操作类型, 接收人, 接收时间)
      Values
        (Id_In, Decode(医嘱id_In, 0, Null, 医嘱id_In), 标本序号_In, 采样时间_In, 采样人_In, 标本类型_In, 人员姓名_In, 核收时间_In, 1, 申请类型_In,
         Decode(仪器id_In, 0, Null, 仪器id_In), Null, Null, 标本形态_In, 0, 执行科室_In, 检验人_In, 检验时间_In, 微生物标本_In, 标本类别_In, 检验备注_In,
         申请科室id_In, 申请人_In, 姓名_In, 性别_In, 年龄_In, Zl_Val(年龄_In),
         Decode(年龄_In, Null, Null, '成人', '成人', '婴儿', '婴儿',
                 Decode(Sign(Instr(年龄_In, '岁')), 1, '岁',
                         Decode(Sign(Instr(年龄_In, '月')), 1, '月',
                                 Decode(Sign(Instr(年龄_In, '天')), 1, '天', Decode(Sign(Instr(年龄_In, '小时')), 1, '小时', Null))))),
         病人id_In, Decode(r_Patient.住院号, Null, Decode(r_Patient.门诊号, Null, 3, 1), 2), 0, Null, Null, 标识号_In, 床号_In,
         病人科室_In, 标本类别_In, r_Patient.门诊号, r_Patient.住院号, r_Patient.出生日期, Null, Null, 检验项目_In, Null, Null, Null);
    End If;
    If Nvl(复盖标本id_In, 0) > 0 Then
      Zl_检验标本记录_Union(Id_In, 复盖标本id_In);
    End If;
    --记录核收和补填操作 
    Insert Into 检验操作记录
      (ID, 标本id, 操作类型, 操作员, 操作时间)
    Values
      (检验操作记录_Id.Nextval, Id_In, 2, 人员姓名_In, Sysdate);
    Close v_Patient;
  Else
    Open v_Advice;
    Fetch v_Advice
      Into r_Advice;
  
    If v_Advice%Found Then
      Zl_病人信息_锁定检查(r_Advice.病人id);
    End If;
  
    Update 检验标本记录
    Set 医嘱id = Decode(医嘱id_In, Null, 医嘱id, 0, 医嘱id, 医嘱id_In), 采样时间 = Decode(采样时间_In, Null, 采样时间, 采样时间_In),
        采样人 = Decode(采样人_In, Null, 采样人, 采样人_In), 标本序号 = Decode(标本序号_In, Null, 标本序号, 标本序号_In),
        标本类型 = Decode(标本类型_In, Null, Decode(标本类型, Null, r_Advice.标本部位, 标本类型), 标本类型_In),
        申请时间 = Decode(r_Advice.开嘱时间, Null, 申请时间, r_Advice.开嘱时间), 核收人 = Decode(核收人, Null, 人员姓名_In, 核收人),
        样本条码 = Decode(r_Advice.样本条码, Null, 样本条码, r_Advice.样本条码), 申请类型 = Decode(申请类型_In, Null, 申请类型, 申请类型_In),
        执行科室id = Decode(执行科室_In, Null, 执行科室id, 执行科室_In), 检验人 = Decode(检验人_In, Null, 检验人, 检验人_In),
        检验时间 = Decode(检验时间_In, Null, 检验时间, 检验时间_In), 检验备注 = Decode(检验备注_In, Null, 检验备注, 检验备注_In),
        申请科室id = Decode(申请科室id_In, Null, 申请科室id, 申请科室id_In), 申请人 = Decode(申请人_In, Null, 申请人, 申请人_In),
        姓名 = Decode(姓名_In, Null, 姓名, 姓名_In), 性别 = Decode(性别_In, Null, 性别, 性别_In), 年龄 = Decode(年龄_In, Null, 年龄, 年龄_In),
        年龄数字 = Decode(年龄_In, Null, 年龄数字, Zl_Val(年龄_In)),
        年龄单位 = Decode(年龄_In, Null, 年龄单位,
                       Decode(年龄_In, Null, Null, '成人', '成人', '婴儿', '婴儿',
                               Decode(Sign(Instr(年龄_In, '岁')), 1, '岁',
                                       Decode(Sign(Instr(年龄_In, '月')), 1, '月',
                                               Decode(Sign(Instr(年龄_In, '天')), 1, '天',
                                                       Decode(Sign(Instr(年龄_In, '小时')), 1, '小时', Null)))))),
        病人id = Decode(r_Advice.病人id, Null, 病人id, r_Advice.病人id), 病人来源 = Decode(r_Advice.病人来源, Null, 病人来源, r_Advice.病人来源),
        婴儿 = Decode(r_Advice.婴儿, 婴儿, r_Advice.婴儿), NO = Decode(No_In, Null, NO, No_In), 合并id = v_Union,
        标本形态 = Decode(标本形态_In, Null, 标本形态, 标本形态_In), 标识号 = Decode(标识号_In, Null, 标识号, 标识号_In),
        床号 = Decode(床号_In, Null, 床号, 床号_In), 病人科室 = Decode(病人科室_In, Null, 病人科室, 病人科室_In), 标本类别 = 标本类别_In,
        门诊号 = r_Advice.门诊号, 住院号 = r_Advice.住院号, 出生日期 = r_Advice.出生日期, 挂号单 = r_Advice.挂号单, 主页id = r_Advice.主页id,
        检验项目 = Decode(检验项目_In, Null, 检验项目, 检验项目_In), 操作类型 = r_Advice.操作类型, 接收人 = r_Advice.接收人, 接收时间 = r_Advice.接收时间
    Where ID = Id_In;
  
    If Sql%NotFound Then
      Insert Into 检验标本记录
        (ID, 医嘱id, 标本序号, 采样时间, 采样人, 标本类型, 核收人, 核收时间, 样本状态, 申请类型, 仪器id, 样本条码, 申请时间, 标本形态, 报告结果, 执行科室id, 检验人, 检验时间, 微生物标本,
         标本类别, 检验备注, 申请科室id, 申请人, 姓名, 性别, 年龄, 年龄数字, 年龄单位, 病人id, 病人来源, 婴儿, NO, 合并id, 标识号, 床号, 病人科室, 紧急, 门诊号, 住院号, 出生日期,
         挂号单, 主页id, 检验项目, 操作类型, 接收人, 接收时间)
      Values
        (Id_In, Decode(医嘱id_In, 0, Null, 医嘱id_In), 标本序号_In, 采样时间_In, 采样人_In, Nvl(标本类型_In, r_Advice.标本部位), 人员姓名_In,
         核收时间_In, 1, 申请类型_In, Decode(仪器id_In, 0, Null, 仪器id_In), r_Advice.样本条码, r_Advice.开嘱时间, 标本形态_In, 0, 执行科室_In,
         检验人_In, 检验时间_In, 微生物标本_In, 标本类别_In, 检验备注_In, 申请科室id_In, 申请人_In, 姓名_In, 性别_In, 年龄_In, Zl_Val(年龄_In),
         Decode(年龄_In, Null, Null, '成人', '成人', '婴儿', '婴儿',
                 Decode(Sign(Instr(年龄_In, '岁')), 1, '岁',
                         Decode(Sign(Instr(年龄_In, '月')), 1, '月',
                                 Decode(Sign(Instr(年龄_In, '天')), 1, '天', Decode(Sign(Instr(年龄_In, '小时')), 1, '小时', Null))))),
         r_Advice.病人id, r_Advice.病人来源, r_Advice.婴儿, No_In, v_Union, 标识号_In, 床号_In, 病人科室_In, r_Advice.紧急, r_Advice.门诊号,
         r_Advice.住院号, r_Advice.出生日期, r_Advice.挂号单, r_Advice.主页id, 检验项目_In, r_Advice.操作类型, r_Advice.接收人, r_Advice.接收时间);
    End If;
    If Nvl(复盖标本id_In, 0) > 0 Then
      Zl_检验标本记录_Union(Id_In, 复盖标本id_In);
    End If;
    Insert Into 检验操作记录
      (ID, 标本id, 操作类型, 操作员, 操作时间)
    Values
      (检验操作记录_Id.Nextval, Id_In, 2, 人员姓名_In, Sysdate);
  
    --查找主项目有时填写合并ID 
    Begin
      Select a.Id
      Into v_Union
      From 检验标本记录 A, 检验标本记录 B, 病人医嘱记录 C, 检验合并规则 D, 病人医嘱记录 E
      Where a.病人id = b.病人id And b.Id = Id_In And a.样本状态 = 1 And Nvl(a.病人id, 0) <> 0 And a.医嘱id = c.相关id And
            d.主项目id = c.诊疗项目id And d.合并项目id = e.诊疗项目id And e.Id = r_Advice.Id And Rownum = 1
      Order By a.核收时间 Desc;
    Exception
      When Others Then
        v_Union := Null;
    End;
    If Nvl(v_Union, 0) <> 0 Then
      Update 检验标本记录 Set 合并id = v_Union Where (ID = Id_In Or 医嘱id = r_Advice.Id);
    End If;
    --查找有了主项目时填写合并项目 
    Begin
      Select a.Id, a.病人id, c.主项目id
      Into v_Union, v_Patientid, v_Itemid
      From 检验标本记录 A, 病人医嘱记录 B, 检验合并规则 C
      Where a.医嘱id = b.相关id And b.诊疗项目id = c.主项目id And a.Id = Id_In And Rownum = 1;
    Exception
      When Others Then
        v_Union := Null;
    End;
    If Nvl(v_Union, 0) <> 0 Then
      Update 检验标本记录
      Set 合并id = v_Union
      Where ID In (Select a.Id
                   From 检验标本记录 A, 病人医嘱记录 B, 检验合并规则 C
                   Where a.医嘱id = b.相关id And b.诊疗项目id = c.合并项目id And c.主项目id = v_Itemid And a.病人id = v_Patientid And
                         a.样本状态 = 1);
    End If;
  
    v_Seq := 1;
    Close v_Advice;
    v_Flag := 0;
    Begin
      Select Nvl(Max(1), 0) Into v_Flag From 检验申请项目 Where 标本id = Id_In;
    Exception
      When Others Then
        v_Flag := 0;
    End;
    If v_Flag = 0 Then
      For r_Advice In v_Advice Loop
        Update 检验申请项目
        Set 标本id = Id_In, 诊疗项目id = r_Advice.诊疗项目id
        Where 标本id = Id_In And 诊疗项目id = r_Advice.诊疗项目id;
        If Sql%RowCount = 0 Then
          Insert Into 检验申请项目 (标本id, 诊疗项目id, 序号) Values (Id_In, r_Advice.诊疗项目id, v_Seq);
        End If;
        v_Seq := v_Seq + 1;
      End Loop;
    End If;
  
  End If;

  --根据参数来判断是否发料 
  For r_Advice_1 In v_Advice_1 Loop
    --如果记帐没有自动发料,则自动发料,否则不处理 
    For r_Stuff In c_Stuff(r_Advice_1.单据号, v_主页id) Loop
    
      Zl_材料收发记录_处方发料(r_Stuff.库房id, r_Stuff.单据, r_Stuff.单据号, 人员姓名_In, 人员姓名_In, 人员姓名_In, 1, Sysdate);
    End Loop;
  End Loop;

  Update /*+ Rule */ 病人医嘱发送
  Set 执行状态 = 3
  Where 执行状态 = 0 And
        医嘱id In (Select ID
                 From 病人医嘱记录
                 Where ID In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist)))
                 Union All
                 Select ID
                 From 病人医嘱记录
                 Where 相关id In (Select * From Table(Cast(f_Num2list(多个医嘱_In) As Zltools.t_Numlist))));

  --2.检查当前标本相关的申请的相关标本是否完成审核 
  For r_Samplequest In c_Samplequest(微生物标本_In) Loop
  
    v_Count := 0;
  
    --r_SampleQuest.医嘱id申请已经完成,处理后续环节 
    If v_Count = 0 Then
    
      If r_Samplequest.病人来源 = 2 Then
        Update 住院费用记录
        Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, NO) In
              (Select 医嘱id, 记录性质, NO
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, NO
               From 病人医嘱发送
               Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID, 相关id)));
      Else
        Update 门诊费用记录
        Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, NO) In
              (Select 医嘱id, 记录性质, NO
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, NO
               From 病人医嘱发送
               Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Samplequest.医嘱id In (ID, 相关id)));
      End If;
      --3.自动审核记帐 
      For r_Verify In c_Verify(r_Samplequest.医嘱id) Loop
        If r_Verify.No || ',' || r_Verify.记录性质 <> v_No || ',' || v_性质 Then
          If v_序号 Is Not Null Then
            If r_Verify.门诊标志 = 1 Then
              Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
            Elsif r_Verify.门诊标志 = 2 Then
              Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
            End If;
          End If;
          v_序号 := Null;
        End If;
        v_门诊标志 := r_Verify.门诊标志;
        v_No       := r_Verify.No;
        v_性质     := r_Verify.记录性质;
        v_序号     := v_序号 || ',' || r_Verify.序号;
      End Loop;
      If v_序号 Is Not Null Then
        If v_门诊标志 = 1 Then
          Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
        Elsif v_门诊标志 = 2 Then
          Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
        End If;
      End If;
    
    End If;
  End Loop;

  If Nvl(申请类型_In, 0) = 1 Then
    Zl_病人医嘱记录_屏蔽打印(医嘱id_In, 1);
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_检验标本记录_标本核收;
/


--95807:陈刘,2017-04-18,在记录单中录入未记说明,并同步到体温单

CREATE OR REPLACE Procedure Zl_病人护理数据_Update
(
  文件id_In   In 病人护理数据.文件id%Type,
  发生时间_In In 病人护理数据.发生时间%Type,
  记录类型_In In 病人护理明细.记录类型%Type, --护理项目=1，签名记录=5，审签记录=15
  项目序号_In In 病人护理明细.项目序号%Type, --护理项目的序号，非护理项目固定为0
  记录内容_In In 病人护理明细.记录内容%Type := Null, --记录内容，如果内容为空，即清除以前的内容；37或38/37
  体温部位_In In 病人护理明细.体温部位%Type := Null,
  他人记录_In In Number := 1,
  数据来源_In In 病人护理明细.数据来源%Type := 0,
  审签_In     In Number := 0,
  操作员_In   In 病人护理数据.保存人%Type := Null,
  记录组号_In In 病人护理明细.记录组号%Type := Null, --适用分类汇总(一条数据对应多条相同项目的明细)
  相关序号_In In 病人护理明细.相关序号%Type := Null, --适用分类汇总(记录汇总项目关联的名称项目序号)
  未记说明_In In 病人护理明细.未记说明%Type := Null --入量导入存储医嘱ID:发送号
) Is
  Intins      Number(18);
  Int共用     Number(1);
  n_Newid     病人护理数据.Id%Type;
  n_Oldid     病人护理数据.Id%Type;
  n_行数      病人护理打印.行数%Type;
  n_Mutilbill Number(1);
  n_Synchro   Number(1);
  n_未记说明  Number(1);
  n_曲线      Number(1);
  n_Num       Number(18);

  n_汇总类别     病人护理数据.汇总类别%Type;
  v_科室id       部门表.Id%Type;
  v_保存人       人员表.姓名%Type;
  v_记录人       人员表.姓名%Type;
  n_文件id       病人护理数据.文件id%Type;
  n_记录id       病人护理数据.Id%Type;
  n_明细id       病人护理明细.Id%Type;
  n_来源id       病人护理明细.来源id%Type;
  v_数据来源     病人护理明细.数据来源%Type;
  n_最高版本     病人护理明细.开始版本%Type;
  n_项目性质     护理记录项目.项目性质%Type;
  n_病人id       病人护理文件.病人id%Type;
  n_主页id       病人护理文件.主页id%Type;
  n_婴儿         病人护理文件.婴儿%Type;
  d_婴儿出院时间 病人医嘱记录.开始执行时间%Type;
  d_文件开始时间 病人护理文件.开始时间%Type;
  --提取该病人当前科室所有未结束的护理文件，且文件开始时间小于等于记录发生时间的文件列表供同步数据使用
  Cursor Cur_Fileformats Is
    Select a.Id As 格式id, b.Id As 文件id, a.保留, a.子类, b.婴儿
    From 病历文件列表 A, 病人护理文件 B, 病人护理文件 C, 病人护理数据 D
    Where a.种类 = 3 And a.保留 <> 1 And a.Id = b.格式id And b.Id <> c.Id And b.结束时间 Is Null And b.开始时间 <= d.发生时间 And
          (a.通用 = 1 Or (a.通用 = 2 And b.科室id = c.科室id)) And c.病人id = b.病人id And c.主页id = b.主页id And c.婴儿 = b.婴儿 And
          c.Id = d.文件id And d.Id = n_记录id And c.Id = 文件id_In
    Order By a.编号;

  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  --取记录ID
  Int共用     := 0;
  n_记录id    := 0;
  n_Mutilbill := 0;
  n_未记说明  := 0;
  n_曲线      := 0;
  If 操作员_In Is Null Then
    v_保存人 := Zl_Username;
  Else
    v_保存人 := 操作员_In;
  End If;

  --如果是对应多份护理文件值为1，表示需同步其它护理文件；否则不处理文件同步
  n_Mutilbill := Zl_To_Number(zl_GetSysParameter('对应多份护理文件', 1255));

  Begin
    Select ID, 汇总类别
    Into n_记录id, n_汇总类别
    From 病人护理数据
    Where 文件id = 文件id_In And 发生时间 = 发生时间_In;
  Exception
    When Others Then
      n_记录id := 0;
  End;

  --检查是不是本人的记录
  ---------------------------------------------------------------------------------------------------------------------
  If 他人记录_In = 0 And n_记录id > 0 And 审签_In = 0 Then
    v_记录人 := '';
    Begin
      Select 记录人
      Into v_记录人
      From 病人护理明细
      Where 记录id = n_记录id And 项目序号 = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
            Nvl(记录组号, 0) = Nvl(记录组号_In, 0) And 终止版本 Is Null;
    Exception
      When Others Then
        v_记录人 := '';
    End;
    If v_记录人 Is Not Null And v_记录人 <> v_保存人 Then
      v_Error := '你无权修改他人登记的护理数据！';
      Raise Err_Custom;
    End If;
  End If;

  --检查是否入科
  Select 病人id, 主页id, Nvl(婴儿, 0), 开始时间
  Into n_病人id, n_主页id, n_婴儿, d_文件开始时间
  From 病人护理文件
  Where ID = 文件id_In;
  d_婴儿出院时间 := Null;
  If n_婴儿 <> 0 Then
    Begin
      Select 开始执行时间
      Into d_婴儿出院时间
      From 病人医嘱记录 B, 诊疗项目目录 C
      Where b.诊疗项目id + 0 = c.Id And b.医嘱状态 = 8 And Nvl(b.婴儿, 0) <> 0 And c.类别 = 'Z' And
            Instr(',3,5,11,', ',' || c.操作类型 || ',', 1) > 0 And b.病人id = n_病人id And b.主页id = n_主页id And b.婴儿 = n_婴儿;
    Exception
      When Others Then
        d_婴儿出院时间 := Null;
    End;
  End If;
  If d_婴儿出院时间 Is Null Then
    v_科室id := 0;
    Begin
      Select a.科室id
      Into v_科室id
      From 病人变动记录 A, 病人护理文件 B
      Where a.科室id Is Not Null And a.病人id = b.病人id And a.主页id = b.主页id And b.Id = 文件id_In And
            (To_Date(To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI') || '59', 'YYYY-MM-DD HH24:MI:SS') >= a.开始时间 And
            (To_Date(To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI') || '00', 'YYYY-MM-DD HH24:MI:SS') < = Nvl(a.终止时间, Sysdate) Or
            a.终止时间 Is Null)) And Rownum < 2;
    Exception
      When Others Then
        v_科室id := 0;
    End;
    If v_科室id = 0 Then
      v_Error := '数据发生时间 ' || To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI:SS') || ' 不在病人有效变动时间范围内，不能操作！';
      Raise Err_Custom;
    End If;
  Else
    If 发生时间_In < d_文件开始时间 Or 发生时间_In > d_婴儿出院时间 Then
      v_Error := '数据发生时间 ' || To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI:SS') || ' 不在病人有效变动时间范围内，不能操作！';
      Raise Err_Custom;
    End If;
  End If;

  --如果数据来源<>0则退出
  n_来源id := 0;
  If n_记录id > 0 Then
    Begin
      Select 数据来源, Nvl(来源id, 0)
      Into v_数据来源, n_来源id
      From 病人护理明细
      Where 记录id = n_记录id And Nvl(项目序号, 0) = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
            Nvl(记录组号, 0) = Nvl(记录组号_In, 0);
    Exception
      When Others Then
        v_数据来源 := 0;
    End;
    If v_数据来源 > 0 And n_来源id > 0 Then
      Return;
    End If;
  End If;

  --取最高版本
  Select Nvl(Max(Nvl(a.开始版本, 1)), 0) + 1, Count(b.Id)
  Into n_最高版本, Intins
  From 病人护理明细 A, 病人护理数据 B
  Where b.Id = n_记录id And a.记录id = b.Id And Mod(a.记录类型, 10) = 5;

  --目前已经签名的数据不能修改，只有在审签模式下进行修改，即审签_In=1
  If 审签_In <> 1 And Intins > 0 Then
    v_Error := '发生时间 ' || To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI:SS') || ' 所对应的数据已经签名或审签，不能继续操作！' || Chr(13) || Chr(10) ||
               '这可能是由于网络并发操作引起的，请刷新后再试！';
    Raise Err_Custom;
  End If;
  Intins := 0;

  --无内容时,要清除数据（审签回退时会自动清除审签过程中修改的数据，所以此处只需考虑普签即可）
  If 记录内容_In Is Null Then
    Begin
      Select ID
      Into n_明细id
      From 病人护理明细
      Where 记录id = n_记录id And Nvl(项目序号, 0) = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
            Nvl(记录组号, 0) = Nvl(记录组号_In, 0) And 终止版本 Is Null;
    Exception
      --无数据退出
      When Others Then
        Return;
    End;

    --查找除了本条要删除的数据，是否还存其他有效的数据，如果存在只删除本条数据，否则删除此发生时间对应的所有数据。
    Select Count(ID)
    Into Intins
    From 病人护理明细
    Where 记录id = n_记录id And Mod(记录类型, 10) <> 5 And 终止版本 Is Null And ID <> n_明细id;
    If Intins = 0 Then
      Delete From 病人护理明细 Where 记录id = n_记录id;
    Else
      Delete From 病人护理明细 Where ID = n_明细id;
    End If;

    Delete From 病人护理数据 A
    Where a.Id = n_记录id And Not Exists (Select 1 From 病人护理明细 B Where b.记录id = a.Id);

    --如果是删除签名后修改产生的最后一条数据,则应将签名记录的终止版本清为空
    Begin
      Select 1
      Into Intins
      From 病人护理明细
      Where 开始版本 = n_最高版本 And 终止版本 Is Null And 记录类型 = 1 And 记录id = n_记录id;
    Exception
      When Others Then
        Intins := 0;
    End;
    If Intins = 0 Then
      Update 病人护理明细 Set 终止版本 = Null Where 记录类型 = 5 And 开始版本 = n_最高版本 - 1 And 记录id = n_记录id;
    End If;
    If Nvl(n_汇总类别, 0) <> 0 Then
      Return;
    End If;

    --############
    --清除共用数据
    --############
    For Rsdel In (Select Distinct 记录id From 病人护理明细 Where 来源id = n_明细id) Loop

      Delete 病人护理明细 Where 来源id = n_明细id And 记录id = Rsdel.记录id;
      --删除对应的打印数据
      Begin
        Select Count(*) Into Intins From 病人护理明细 Where 记录id = Rsdel.记录id;
      Exception
        When Others Then
          Intins := 0;
      End;
      If Intins = 0 Then
        --提取清除数据对应的文件ID
        Begin
          Select b.Id, a.保留
          Into n_文件id, Intins
          From 病历文件列表 A, 病人护理文件 B, 病人护理数据 C
          Where a.Id = b.格式id And b.Id = c.文件id And c.Id = Rsdel.记录id;
        Exception
          When Others Then
            n_文件id := 0;
        End;
        Delete 病人护理数据 Where ID = Rsdel.记录id;
        If Intins <> -1 Then
          Zl_病人护理打印_Update(n_文件id, 发生时间_In, 1, 1);
        End If;
      End If;
    End Loop;
  Else
    --检查录入的项目是否属于该记录单
    Begin
      Select 1
      Into Intins
      From (Select b.项目序号
             From 病历文件结构 A, 护理记录项目 B
             Where a.要素名称 = b.项目名称 And b.项目序号 = 项目序号_In And
                   父id = (Select b.Id
                          From 病人护理文件 A, 病历文件结构 B
                          Where a.Id = 文件id_In And a.格式id = b.文件id And b.父id Is Null And b.对象序号 = 4)
             Union
             Select 项目序号
             From 护理记录项目
             Where 项目性质 = 2 And 项目序号 = 项目序号_In);
    Exception
      When Others Then
        Intins := 0;
    End;
    If Intins = 0 Then
      Return;
    End If;
    If n_记录id = 0 Then
      Select 病人护理数据_Id.Nextval Into n_记录id From Dual;

      Insert Into 病人护理数据
        (ID, 文件id, 发生时间, 最后版本, 保存人, 保存时间)
      Values
        (n_记录id, 文件id_In, 发生时间_In, n_最高版本, v_保存人, Sysdate);
    End If;

    --插入本次登记的病人护理明细
    Update 病人护理明细
    Set 记录内容 = 记录内容_In, 数据来源 = 数据来源_In, 未记说明 = 未记说明_In, 记录人 = v_保存人, 记录时间 = Sysdate
    Where 记录id = n_记录id And 项目序号 = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
          Nvl(记录组号, 0) = Nvl(记录组号_In, 0) And 开始版本 = n_最高版本 And 终止版本 Is Null;
    If Sql%RowCount = 0 Then
      Select 病人护理明细_Id.Nextval Into n_明细id From Dual;
      Insert Into 病人护理明细
        (ID, 记录id, 记录类型, 项目分组, 项目id, 相关序号, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 记录组号, 体温部位, 数据来源, 共用, 未记说明, 开始版本, 终止版本,
         记录人, 记录时间)
        Select n_明细id, n_记录id, 记录类型_In, a.分组名, a.项目id, 相关序号_In, a.项目序号, Upper(a.项目名称), a.项目类型, 记录内容_In, a.项目单位, 0,
               记录组号_In, 体温部位_In, 数据来源_In, Nvl(b.共用, 0), 未记说明_In, n_最高版本, Null, v_保存人, Sysdate
        From 护理记录项目 A, 病人护理明细 B
        Where a.项目序号 = b.项目序号(+) And b.终止版本(+) Is Null And b.记录id(+) = n_记录id And a.项目序号 = 项目序号_In And Rownum < 2;
    End If;
    Select ID
    Into n_明细id
    From 病人护理明细
    Where 记录id = n_记录id And 项目序号 = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
          Nvl(记录组号, 0) = Nvl(记录组号_In, 0) And 开始版本 = n_最高版本 And 终止版本 Is Null;
    --填写历史数据及签名记录的终止版本
    Update 病人护理明细
    Set 终止版本 = n_最高版本
    Where 记录id = n_记录id And ((Mod(记录类型, 10) <> 5 And 项目序号 = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
          Nvl(记录组号, 0) = Nvl(记录组号_In, 0)) Or 记录类型 = Decode(审签_In, 1, 15, 5)) And 开始版本 <= n_最高版本 - 1 And 终止版本 Is Null;

    --如果是未签名数据，最后修改操作员做为该记录的保存人更新
    If n_最高版本 = 1 Then
      Update 病人护理数据 Set 保存人 = v_保存人, 保存时间 = Sysdate Where ID = n_记录id;
    End If;

    If Nvl(n_汇总类别, 0) <> 0 Then
      Return;
    End If;

    --############
    --同步共用数据
    --############
    --1\先处理体温单（一个病人始终只存在一份有效的体温单文件）
    --如果体温表存在相同发生时间的数据，使用它的ID
    --CL,2015-12-30,记录单同步文字项目到体温单
    For Row_Format In Cur_Fileformats Loop
      If Row_Format.保留 = -1 Then
        If Row_Format.子类 = '1' Then
          Begin
            Select 1, h.项目性质
            Into Intins, n_项目性质
            From (Select To_Char(f.项目序号) As 序号, g.项目性质
                   From 体温记录项目 F, 护理记录项目 G
                   Where f.项目序号 = g.项目序号 And g.项目性质 = 2 And
                         (g.适用科室 = 1 Or
                         (g.适用科室 = 2 And Exists
                          (Select 1 From 护理适用科室 D Where g.项目序号 = d.项目序号 And d.科室id = v_科室id))) And Nvl(g.应用方式, 0) <> 0 And
                         (Nvl(g.适用病人, 0) = 0 Or Nvl(g.适用病人, 0) = Decode(Nvl(Row_Format.婴儿, 0), 0, 1, 2))
                   Union All
                   Select b.内容文本 As 序号, 1 As 项目性质
                   From 病历文件结构 A, 病历文件结构 B
                   Where a.文件id = Row_Format.格式id And a.父id Is Null And a.对象序号 In (2, 3) And b.父id = a.Id) H
            Where Instr(',' || h.序号 || ',', ',' || 项目序号_In || ',', 1) > 0;
          Exception
            When Others Then
              Intins := 0;
          End;
        Else
          Begin
            Select 1, g.项目性质
            Into Intins, n_项目性质
            From 体温记录项目 F, 护理记录项目 G
            Where f.项目序号 = g.项目序号 And Nvl(g.应用方式, 0) <> 0 And g.护理等级 >= 0 And
                  (Nvl(g.适用病人, 0) = 0 Or Nvl(g.适用病人, 0) = Decode(Nvl(Row_Format.婴儿, 0), 0, 1, 2)) And f.项目序号 = 项目序号_In And
                  (g.适用科室 = 1 Or (g.适用科室 = 2 And Exists
                   (Select 1 From 护理适用科室 D Where g.项目序号 = d.项目序号 And d.科室id = v_科室id)));
          Exception
            When Others Then
              Intins := 0;
          End;
        End If;

        If Intins > 0 Then
          --LPF,2013-01-23,检查此项目是否需要进行同步(对于以前已经同步过的数据，为了保证记录单和体温单数据一直将不根据此函数判断。)
          n_Synchro := Zl_Temperatureprogram(文件id_In, v_科室id, 项目序号_In, 发生时间_In);
          Begin
            Select b.Id
            Into n_Newid
            From 病人护理文件 A, 病人护理数据 B
            Where a.Id = Row_Format.文件id And b.文件id = a.Id And b.发生时间 = 发生时间_In;
          Exception
            When Others Then
              n_Newid := 0;
          End;
          n_Oldid := n_Newid;
          If n_Newid = 0 And n_Synchro = 1 Then
            Select 病人护理数据_Id.Nextval Into n_Newid From Dual;
            --产生体温单主记录
            Insert Into 病人护理数据
              (ID, 文件id, 保存人, 保存时间, 发生时间, 最后版本)
            Values
              (n_Newid, Row_Format.文件id, v_保存人, Sysdate, 发生时间_In, 1);
          End If;

          Begin
            Select To_Number(记录内容_In) Into n_Num From Dual;
          Exception
            When Invalid_Number Then
              Begin
                Select 1 Into n_曲线 From 体温记录项目 Where 项目序号 = 项目序号_In And 记录法 = 1;
              Exception
                When Others Then
                  n_曲线 := 0;
              End;
              Begin
                Select 1 Into n_未记说明 From 常用体温说明 Where 名称 = 记录内容_In;
              Exception
                When Others Then
                  n_未记说明 := 0;
              End;
          End;

          If n_Newid > 0 Then
            --插入未同步的体温单数据(仍然要联接多表查询)
            Select Count(*)
            Into v_数据来源
            From 病人护理明细
            Where 记录id = n_Newid And 项目序号 = 项目序号_In And
                  Decode(n_项目性质, 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无')) = Nvl(体温部位_In, '无');
            If v_数据来源 = 0 Then
              --说明在同步开始已经进行过检查
              If n_Synchro = 1 Then
                --没有检查此项目是否需要同步
                If n_曲线 = 1 And n_未记说明 = 1 Then
                  Insert Into 病人护理明细
                    (ID, 记录id, 记录类型, 项目分组, 项目id, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 体温部位, 数据来源, 来源id, 未记说明, 开始版本, 终止版本,
                     记录人, 记录时间, 记录组号)
                    Select 病人护理明细_Id.Nextval, n_Newid, b.记录类型, b.项目分组, b.项目id, b.项目序号, b.项目名称, b.项目类型, Null, b.项目单位,
                           b.记录标记, b.体温部位, 1, b.Id, b.记录内容, 1, Null, b.记录人, Sysdate, 1
                    From (Select 项目序号_In As 项目序号, Nvl(体温部位_In, '无') As 体温部位
                           From Dual
                           Minus
                           Select f.项目序号, Decode(Nvl(f.项目性质, 1), 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无'))
                           From 病人护理明细 E, 护理记录项目 F
                           Where e.记录id = n_Newid And e.项目序号 = f.项目序号) A, 病人护理明细 B
                    Where a.项目序号 = b.项目序号 And b.记录id = n_记录id And b.Id = n_明细id;
                  If Sql%RowCount > 0 Then
                    Int共用 := 1;
                  End If;
                Else
                  Insert Into 病人护理明细
                    (ID, 记录id, 记录类型, 项目分组, 项目id, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 体温部位, 数据来源, 来源id, 开始版本, 终止版本, 记录人,
                     记录时间, 记录组号)
                    Select 病人护理明细_Id.Nextval, n_Newid, b.记录类型, b.项目分组, b.项目id, b.项目序号, b.项目名称, b.项目类型, b.记录内容, b.项目单位,
                           b.记录标记, b.体温部位, 1, b.Id, 1, Null, b.记录人, Sysdate, 1
                    From (Select 项目序号_In As 项目序号, Nvl(体温部位_In, '无') As 体温部位
                           From Dual
                           Minus
                           Select f.项目序号, Decode(Nvl(f.项目性质, 1), 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无'))
                           From 病人护理明细 E, 护理记录项目 F
                           Where e.记录id = n_Newid And e.项目序号 = f.项目序号) A, 病人护理明细 B
                    Where a.项目序号 = b.项目序号 And b.记录id = n_记录id And b.Id = n_明细id;
                  If Sql%RowCount > 0 Then
                    Int共用 := 1;
                  End If;
                End If;
              End If;
            Else
              If n_曲线 = 1 And n_未记说明 = 1 Then
                Update 病人护理明细
                Set 未记说明 = 记录内容_In, 来源id = n_明细id, 记录内容 = Null
                Where 记录id = n_Newid And 项目序号 = 项目序号_In And
                      Decode(n_项目性质, 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无')) = Nvl(体温部位_In, '无') And 数据来源 > 0;
                If Sql%RowCount > 0 Then
                  Int共用 := 1;
                End If;
              Else
                Update 病人护理明细
                Set 记录内容 = 记录内容_In, 来源id = n_明细id
                Where 记录id = n_Newid And 项目序号 = 项目序号_In And
                      Decode(n_项目性质, 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无')) = Nvl(体温部位_In, '无') And 数据来源 > 0;
                If Sql%RowCount > 0 Then
                  Int共用 := 1;
                End If;
              End If;
            End If;
          End If;
        End If;
        --2\再循环处理记录单
      Else
        If n_Mutilbill = 1 Then
          --提取记录单与当前记录单存在重叠的且有数据的固定项目
          Select Count(*)
          Into Intins
          From (Select b.项目序号
                 From 病历文件结构 A, 护理记录项目 B
                 Where a.要素名称 = b.项目名称 And b.项目表示 In (0, 4, 5) And
                       父id =
                       (Select ID From 病历文件结构 Where 文件id = Row_Format.格式id And 父id Is Null And 对象序号 = 4)
                 Intersect
                 Select b.项目序号
                 From 病历文件结构 A, 护理记录项目 B, 病人护理文件 C, 病人护理数据 D, 病人护理明细 G
                 Where c.Id = d.文件id And a.文件id = c.格式id And d.Id = g.记录id And d.Id = n_记录id And g.Id = n_明细id And
                       b.项目序号 = g.项目序号 And b.项目表示 In (0, 4, 5) And g.记录类型 = 1 And a.要素名称 = b.项目名称 And
                       a.父id = (Select ID From 病历文件结构 E Where e.文件id = c.格式id And 父id Is Null And 对象序号 = 4));

          If Intins > 0 Then
            n_Newid := 0;
            --可能指定文件已经存在相同发生时间的数据，直接用它的ID即可
            Begin
              Select c.Id
              Into n_Newid
              From 病人护理数据 C
              Where c.文件id = Row_Format.文件id And c.发生时间 = 发生时间_In;
            Exception
              When Others Then
                n_Newid := 0;
            End;

            If n_Newid = 0 Then
              --产生记录单主记录
              Select 病人护理数据_Id.Nextval Into n_Newid From Dual;

              Insert Into 病人护理数据
                (ID, 文件id, 保存人, 保存时间, 发生时间, 最后版本)
                Select n_Newid, Row_Format.文件id, c.保存人, c.保存时间, c.发生时间, 1
                From 病人护理数据 C
                Where c.Id = n_记录id;
            End If;

            If n_Newid > 0 Then
              --插入未同步的记录单数据
              Select Count(*) Into v_数据来源 From 病人护理明细 Where 记录id = n_Newid And 项目序号 = 项目序号_In;
              If v_数据来源 = 0 Then
                Insert Into 病人护理明细
                  (ID, 记录id, 记录类型, 项目分组, 项目id, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 体温部位, 数据来源, 来源id, 未记说明, 开始版本, 终止版本,
                   记录人, 记录时间)
                  Select 病人护理明细_Id.Nextval, n_Newid, b.记录类型, b.项目分组, b.项目id, b.项目序号, b.项目名称, b.项目类型, b.记录内容, b.项目单位,
                         b.记录标记, b.体温部位, 1, b.Id, b.未记说明, 1, Null, b.记录人, Sysdate
                  From (Select b.项目序号
                         From 病历文件结构 A, 护理记录项目 B
                         Where a.要素名称 = b.项目名称 And b.项目表示 In (0, 4, 5) And
                               父id = (Select ID
                                      From 病历文件结构
                                      Where 文件id = Row_Format.格式id And 父id Is Null And 对象序号 = 4)
                         Intersect
                         Select b.项目序号
                         From 病历文件结构 A, 护理记录项目 B, 病人护理文件 C, 病人护理数据 D, 病人护理明细 G
                         Where c.Id = d.文件id And a.文件id = c.格式id And d.Id = g.记录id And d.Id = n_记录id And g.Id = n_明细id And
                               b.项目序号 = g.项目序号 And b.项目表示 In (0, 4, 5) And g.记录类型 = 1 And a.要素名称 = b.项目名称 And
                               a.父id =
                               (Select ID From 病历文件结构 E Where e.文件id = c.格式id And 父id Is Null And 对象序号 = 4)) A, 病人护理明细 B
                  Where a.项目序号 = b.项目序号 And b.记录id = n_记录id And b.Id = n_明细id;
                If Sql%RowCount > 0 Then
                  Int共用 := 1;
                  --原行数不要动
                  Begin
                    Select 行数 Into n_行数 From 病人护理打印 Where 文件id = Row_Format.文件id And 记录id = n_Newid;
                  Exception
                    When Others Then
                      n_行数 := 1;
                  End;
                  Zl_病人护理打印_Update(Row_Format.文件id, 发生时间_In, n_行数, 0);
                End If;
              Else
                Update 病人护理明细
                Set 记录内容 = 记录内容_In, 未记说明 = 未记说明_In, 来源id = n_明细id
                Where 记录id = n_Newid And 项目序号 = 项目序号_In And 数据来源 > 0;
                If Sql%RowCount > 0 Then
                  Int共用 := 1;
                End If;
              End If;
            End If;
          End If;
        End If;
      End If;
    End Loop;

    If Int共用 = 1 Then
      Update 病人护理明细 Set 共用 = 1 Where ID = n_明细id;
      --将历史数据的共用标志设置为NULL
      Update 病人护理明细 Set 共用 = Null Where 记录id = n_记录id And 项目序号 = 项目序号_In And ID <> n_明细id;
    End If;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人护理数据_Update;
/

--107559:冉俊明,2017-04-17,增加终止停诊安排功能
Create Or Replace Procedure Zl_临床出诊停诊_Apply
(
  操作类型_In Number,
  Id_In       临床出诊停诊记录.Id%Type,
  开始时间_In 临床出诊停诊记录.开始时间%Type := Null,
  终止时间_In 临床出诊停诊记录.终止时间%Type := Null,
  停诊原因_In 临床出诊停诊记录.停诊原因%Type := Null,
  申请人_In   临床出诊停诊记录.申请人%Type := Null,
  申请时间_In 临床出诊停诊记录.申请时间%Type := Null,
  登记人_In   临床出诊停诊记录.登记人%Type := Null
) As
  --功能：退费申请以及取消申请
  --参数：
  --        操作类型_In：0-申请，else-取消申请
  --说明：
  n_Count Number;

  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  If 操作类型_In = 0 Then
    --申请
    If 开始时间_In <= Sysdate Then
      v_Error := '停诊时间的开始时间必须大于当前时间！';
      Raise Err_Custom;
    End If;
  
    If 开始时间_In >= 终止时间_In Then
      v_Error := '停诊时间的结束时间必须大于开始时间！';
      Raise Err_Custom;
    End If;
  
    Select Count(1)
    Into n_Count
    From 临床出诊停诊记录
    Where 记录id Is Null And Not (开始时间 > 终止时间_In Or Nvl(失效时间, 终止时间) < 开始时间_In) And 申请人 = 申请人_In And Rownum < 2;
    If n_Count <> 0 Then
      v_Error := '医生 ' || 申请人_In || ' 在当前停诊时间范围内已存在停诊安排，不能重复申请！';
      Raise Err_Custom;
    End If;
  
    Insert Into 临床出诊停诊记录
      (ID, 开始时间, 终止时间, 停诊原因, 申请人, 申请时间, 登记人)
    Values
      (临床出诊停诊记录_Id.Nextval, 开始时间_In, 终止时间_In, 停诊原因_In, 申请人_In, 申请时间_In, 登记人_In);
  
    Return;
  End If;

  --取消申请
  Select Count(1) Into n_Count From 临床出诊停诊记录 Where ID = Id_In And 审批人 Is Not Null;
  If n_Count <> 0 Then
    v_Error := '该申请已被审批，不能取消申请。';
    Raise Err_Custom;
  End If;

  Delete 临床出诊停诊记录 Where ID = Id_In;
  If Sql%NotFound Then
    v_Error := '该申请可能已被他人取消申请，请刷新后查看...';
    Raise Err_Custom;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊停诊_Apply;
/

--107559:冉俊明,2017-04-17,增加终止停诊安排功能
Create Or Replace Procedure Zl_临床出诊停诊_Stop
(
  Id_In       临床出诊停诊记录.Id%Type,
  终止人_In   临床出诊停诊记录.取消人%Type,
  终止时间_In 临床出诊停诊记录.失效时间%Type := Null
) As
  --功能：终止停诊安排
  --参数：
  --       终止时间_In：Null-立即终止，其它-具体的终止时间
  v_Error Varchar2(255);
  Err_Custom Exception;

  n_Count Number;
Begin
  If 终止时间_In Is Not Null Then
    If 终止时间_In < Sysdate Then
      v_Error := '终止时间必须大于当前时间！';
      Raise Err_Custom;
    End If;
  End If;

  Select Count(1) Into n_Count From 临床出诊停诊记录 Where ID = Id_In And 终止时间 < Sysdate;
  If n_Count <> 0 Then
    v_Error := '该停诊安排已失效，不能终止！';
    Raise Err_Custom;
  End If;

  Select Count(1) Into n_Count From 临床出诊停诊记录 Where ID = Id_In And 失效时间 Is Not Null;
  If n_Count <> 0 Then
    v_Error := '该停诊安排已被终止，不能再终止！';
    Raise Err_Custom;
  End If;

  Update 临床出诊停诊记录
  Set 失效时间 = Nvl(终止时间_In, Sysdate), 取消人 = 终止人_In, 取消时间 = Sysdate
  Where ID = Id_In And 审批人 Is Not Null;
  If Sql%NotFound Then
    v_Error := '该停诊安排还未审批，不能终止！';
    Raise Err_Custom;
  End If;

  For c_记录 In (Select a.Id, c.号码, a.停诊终止时间, a.是否序号控制, a.是否分时段
               From 临床出诊记录 A, 临床出诊停诊记录 B, 临床出诊号源 C
               Where ((a.替诊医生姓名 Is Null And a.医生id Is Not Null And a.医生姓名 = b.申请人) Or
                     (a.替诊医生姓名 Is Not Null And a.替诊医生id Is Not Null And a.替诊医生姓名 = b.申请人)) And a.号源id = c.Id And
                     b.Id = Id_In And (a.开始时间 Between b.开始时间 And b.终止时间 Or a.终止时间 Between b.开始时间 And b.终止时间) And
                     Nvl(a.是否发布, 0) = 1 And a.停诊终止时间 > Nvl(终止时间_In, Sysdate)) Loop
  
    Update 临床出诊记录
    Set 停诊开始时间 = Case
                   When 停诊开始时间 >= Nvl(终止时间_In, Sysdate) Then
                    Null
                   Else
                    停诊开始时间
                 End,
        停诊终止时间 = Case
                   When 停诊开始时间 >= Nvl(终止时间_In, Sysdate) Then
                    Null
                   Else
                    Nvl(终止时间_In, Sysdate)
                 End
    Where ID = c_记录.Id;
  
    --调整"临床出诊序号控制.是否停诊"为0
    Update 临床出诊序号控制
    Set 是否停诊 = 0
    Where 记录id = c_记录.Id And Nvl(是否停诊, 0) = 1 And 开始时间 Between Nvl(终止时间_In, Sysdate) And c_记录.停诊终止时间 And
          Nvl(c_记录.是否序号控制, 0) = 1 And Nvl(c_记录.是否分时段, 0) = 1;
  
    --消息推送
    -- 停诊类型(1-停诊,2-取消停诊),出诊记录ID,停诊号码
    Begin
      Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
        Using 17, 2 || ',' || c_记录.Id || ',' || c_记录.号码;
    Exception
      When Others Then
        Null;
    End;
  End Loop;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊停诊_Stop;
/

--104997:刘尔旋,2017-04-17,三方卡强制退现处理
Create Or Replace Procedure Zl_结帐缴款记录_Insert
(
  No_In         病人结帐记录.No%Type,
  病人id_In     病人预交记录.病人id%Type,
  主页id_In     病人预交记录.主页id%Type,
  科室id_In     病人预交记录.科室id%Type,
  结算方式_In   病人预交记录.结算方式%Type,
  结算号码_In   病人预交记录.结算号码%Type,
  金额_In       病人预交记录.冲预交%Type,
  结帐id_In     病人预交记录.结帐id%Type,
  操作员编号_In 病人预交记录.操作员编号%Type,
  操作员姓名_In 病人预交记录.操作员姓名%Type,
  收费时间_In   病人预交记录.收款时间%Type,
  保险类别_In   保险帐户.险类%Type,
  保险帐号_In   保险帐户.医保号%Type,
  保险密码_In   保险帐户.密码%Type,
  缴款_In       病人预交记录.缴款%Type := Null,
  找补_In       病人预交记录.找补%Type := Null,
  卡类别id_In   病人预交记录.卡类别id%Type := Null,
  卡号_In       病人预交记录.卡号%Type := Null,
  交易流水号_In 病人预交记录.交易流水号%Type := Null,
  交易说明_In   病人预交记录.交易说明%Type := Null,
  消费卡结算_In Varchar2 := Null,
  退支票额_In   病人预交记录.冲预交%Type := Null,
  摘要_In       病人预交记录.摘要%Type := Null
) As
  -----------------------------------------------------------
  --功能：处理一行病人结帐时的缴款记录
  --参数：
  --  NO_IN=结帐单相同的NO
  --  消费卡结算_in:允许一次刷多张卡,格式为:卡类别ID|卡号|消费卡ID|消费金额||.
  --  退支票额_In- 退支票额(结算方式_IN不为空时,有效)
  -----------------------------------------------------------
  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  v_退支票   病人预交记录.结算方式%Type;
  v_结算内容 Varchar2(500);
  v_当前结算 Varchar2(50);
  v_卡号     病人医疗卡信息.卡号%Type;
  v_名称     Varchar2(100);
  v_结算方式 病人预交记录.结算方式%Type;

  n_消费卡id 消费卡目录.Id%Type;
  n_卡类别id 病人预交记录.结算卡序号%Type;
  n_自制卡   卡消费接口目录.自制卡%Type;
  n_序号     病人卡结算记录.序号%Type;
  n_Id       病人卡结算记录.Id%Type;
  n_预交id   病人预交记录.Id%Type;
  n_结算金额 病人预交记录.冲预交%Type;
  n_返回值   人员缴款余额.余额%Type;
  n_组id     财务缴款分组.Id%Type;
  n_校对标志 病人预交记录.校对标志%Type;

Begin
  n_组id     := Zl_Get组id(操作员姓名_In);
  n_校对标志 := 0;
  If Nvl(卡类别id_In, 0) <> 0 Then
    n_校对标志 := 1;
  End If;

  If Not 结算方式_In Is Null Then
    Insert Into 病人预交记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id,
       缴款, 找补, 缴款组id, 卡类别id, 卡号, 交易流水号, 交易说明, 校对标志, 结算性质)
    Values
      (病人预交记录_Id.Nextval, No_In, Null, 2, 1, 病人id_In, Decode(主页id_In, 0, Null, 主页id_In),
       Decode(科室id_In, 0, Null, 科室id_In), Null, 结算方式_In, 结算号码_In, Nvl(摘要_In, '结帐缴款'), Decode(保险类别_In, 0, Null, 保险类别_In),
       保险密码_In, 保险帐号_In, 收费时间_In, 操作员编号_In, 操作员姓名_In, 金额_In, 结帐id_In, 缴款_In, 找补_In, n_组id, 卡类别id_In, 卡号_In, 交易流水号_In,
       交易说明_In, n_校对标志, 2);
  
    --处理人员缴款余额
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + 金额_In
    Where 收款员 = 操作员姓名_In And 结算方式 = 结算方式_In And 性质 = 1
    Returning 余额 Into n_返回值;
  
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额 (收款员, 结算方式, 性质, 余额) Values (操作员姓名_In, 结算方式_In, 1, 金额_In);
      n_返回值 := 金额_In;
    End If;
    If Nvl(n_返回值, 0) = 0 Then
      Delete From 人员缴款余额
      Where 收款员 = 操作员姓名_In And 结算方式 = 结算方式_In And 性质 = 1 And Nvl(余额, 0) = 0;
    End If;
  
    If Nvl(退支票额_In, 0) <> 0 Then
      Begin
        Select b.名称
        Into v_退支票
        From 结算方式应用 A, 结算方式 B
        Where a.应用场合 = '结帐' And b.名称 = a.结算方式 And Nvl(b.应付款, 0) = 1 And Rownum < 2;
      Exception
        When Others Then
          v_退支票 := '无';
      End;
      If v_退支票 = '无' Then
        v_Err_Msg := '在结算场合中,不存在结算性质为应付款的结算方式,请在[结算方式]中设置！';
        Raise Err_Item;
      End If;
    
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 校对标志, 卡类别id, 结算卡序号, 卡号, 交易流水号,
         交易说明, 结算号码, 结算性质)
      Values
        (病人预交记录_Id.Nextval, 2, No_In, 1, 病人id_In, 主页id_In, Null, v_退支票, 收费时间_In, 操作员编号_In, 操作员姓名_In, 退支票额_In, 结帐id_In,
         n_组id, 0, Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 2);
    
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) + 退支票额_In
      Where 收款员 = 操作员姓名_In And 结算方式 = v_退支票 And 性质 = 1
      Returning 余额 Into n_返回值;
    
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额 (收款员, 结算方式, 性质, 余额) Values (操作员姓名_In, v_退支票, 1, 退支票额_In);
        n_返回值 := 退支票额_In;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 人员缴款余额
        Where 收款员 = 操作员姓名_In And 结算方式 = v_退支票 And 性质 = 1 And Nvl(余额, 0) = 0;
      End If;
    
    End If;
  
  End If;

  --4-消费卡批量结算
  If 消费卡结算_In Is Not Null Then
    v_结算内容 := 消费卡结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      --卡类别ID|卡号|消费卡ID|消费金额
      n_卡类别id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_卡号     := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_消费卡id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(v_当前结算);
      Begin
        Select 名称, 自制卡, 结算方式 Into v_名称, n_自制卡, v_结算方式 From 卡消费接口目录 Where 编号 = n_卡类别id;
      Exception
        When Others Then
          v_名称 := Null;
      End;
      If v_名称 Is Null Then
        v_Err_Msg := '未找到对应的结算卡接口,本次刷卡消费失败!';
        Raise Err_Item;
      End If;
      If v_结算方式 Is Null Then
        v_Err_Msg := v_名称 || '未设置对应的结算方式,本次刷卡消费失败!';
        Raise Err_Item;
      End If;
      If Nvl(n_消费卡id, 0) = 0 Then
        --未传入消费卡ID时,以卡号为准进行查找(卡号的合法性,在程序中有判断)
        Begin
          Select ID
          Into n_消费卡id
          From 消费卡目录
          Where 接口编号 = n_卡类别id And 卡号 = v_卡号 And
                序号 = (Select Max(序号) From 消费卡目录 Where 接口编号 = n_卡类别id And 卡号 = v_卡号);
        Exception
          When Others Then
            n_消费卡id := 0;
        End;
        If Nvl(n_消费卡id, 0) = 0 Then
          v_Err_Msg := '未找到卡号为:' || v_卡号 || '的' || v_名称 || '.,本次刷卡消费失败!';
          Raise Err_Item;
        End If;
      End If;
    
      If Nvl(n_结算金额, 0) <> 0 Then
      
        Update 病人预交记录
        Set 冲预交 = Nvl(冲预交, 0) + n_结算金额
        Where 结帐id = 结帐id_In And 结算方式 = v_结算方式 And 结算卡序号 = n_卡类别id
        Returning ID Into n_预交id;
      
        If Sql%NotFound Then
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算卡序号, 校对标志, 结算性质)
          Values
            (n_预交id, 2, No_In, 1, 病人id_In, 主页id_In, Null, v_结算方式, 收费时间_In, 操作员编号_In, 操作员姓名_In, n_结算金额, 结帐id_In, n_组id,
             n_卡类别id, 0, 2);
        End If;
      
        --插入卡结算记录
        Begin
          Select Nvl(Max(Nvl(序号, 0)), 0) + 1
          Into n_序号
          From 病人卡结算记录
          Where 接口编号 = n_卡类别id And Nvl(消费卡id, 0) = Nvl(n_消费卡id, 0) And 卡号 = v_卡号;
        Exception
          When Others Then
            n_序号 := 1;
        End;
      
        Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
      
        Insert Into 病人卡结算记录
          (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
        Values
          (n_Id, n_卡类别id, n_消费卡id, n_序号, 1, v_结算方式, n_结算金额, v_卡号, Null, 收费时间_In, Null, 0);
      
        --如果消费卡,需同时更改其余额
        If Nvl(n_消费卡id, 0) <> 0 Then
          Update 消费卡目录 Set 余额 = 余额 - n_结算金额 Where ID = n_消费卡id;
          If Sql%NotFound Then
            v_Err_Msg := '卡号为' || v_卡号 || '的' || v_名称 || '未找到!';
            Raise Err_Item;
          End If;
        End If;
        Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
      
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + n_结算金额
        Where 收款员 = 操作员姓名_In And 结算方式 = v_结算方式 And 性质 = 1
        Returning 余额 Into n_返回值;
      
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额 (收款员, 结算方式, 性质, 余额) Values (操作员姓名_In, v_结算方式, 1, n_结算金额);
          n_返回值 := n_结算金额;
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 人员缴款余额
          Where 收款员 = 操作员姓名_In And 结算方式 = v_结算方式 And 性质 = 1 And Nvl(余额, 0) = 0;
        End If;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_结帐缴款记录_Insert;
/

--107321:冉俊明,2017-04-14,修改无“所有科室”权限时的功能控制问题
Create Or Replace Procedure Zl_临床出诊表_Delete
(
  Id_In     临床出诊表.Id%Type,
  人员id_In 人员表.Id%Type := Null,
  站点_In   部门表.站点%Type
) As
  --功能：删除临床出诊表 
  --参数： 
  --        人员id_In 除固定安排外有效，不为0或null表示临床科室人员在删除 
  n_Count    Number;
  n_排班方式 临床出诊表.排班方式%Type;
  n_出诊id   临床出诊表.Id%Type;

  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  l_记录id t_Numlist := t_Numlist();
  l_限制id t_Numlist := t_Numlist();
Begin
  Begin
    Select 1 Into n_Count From 临床出诊表 Where 排班方式 <> 3 And 发布人 Is Not Null And ID = Id_In;
  Exception
    When Others Then
      n_Count := 0;
  End;
  If n_Count <> 0 Then
    v_Err_Msg := '当前出诊表已发布，不能删除！';
    Raise Err_Item;
  End If;

  Begin
    Select 排班方式 Into n_排班方式 From 临床出诊表 Where ID = Id_In;
  Exception
    When Others Then
      v_Err_Msg := '出诊表信息未找到！';
      Raise Err_Item;
  End;

  --按天排班的月模板数据保存在出诊记录中的 
  If Nvl(n_排班方式, 0) In (0, 3) Then
    --固定安排/模板 
    --删除临床出诊限制 
    Select b.Id Bulk Collect
    Into l_限制id
    From 临床出诊安排 A, 临床出诊限制 B
    Where a.Id = b.安排id And a.出诊id = Id_In;
  
    Forall I In 1 .. l_限制id.Count
      Delete From 临床出诊时段 Where 限制id = l_限制id(I);
  
    Forall I In 1 .. l_限制id.Count
      Delete From 临床出诊诊室 Where 限制id = l_限制id(I);
  
    Forall I In 1 .. l_限制id.Count
      Delete From 临床出诊挂号控制 Where 限制id = l_限制id(I);
  
    Forall I In 1 .. l_限制id.Count
      Delete From 临床出诊限制 Where ID = l_限制id(I);
  
    --删除临床出诊安排 
    Delete From 临床出诊安排 Where 出诊id = Id_In;
  
    --删除临床出诊表 
    Delete 临床出诊表 Where ID = Id_In;
  
    Return;
  End If;

  --======================================================================================================== 
  --月出诊表/周出诊表 
  --月出诊表/周出诊表只能从最后一个开始删除 
  Begin
    Select ID
    Into n_出诊id
    From (Select a.Id
           From 临床出诊表 A, 临床出诊安排 B, 临床出诊号源 C, 部门表 D
           Where a.排班方式 = n_排班方式 And a.Id = b.出诊id(+) And b.号源id = c.Id(+) And c.科室id = d.Id(+)
                --当前人员可操作的号源 
                 And (Nvl(人员id_In, 0) = 0 Or (Nvl(c.是否临床排班, 0) = 1 And Exists
                  (Select 1 From 部门人员 Where 部门id = c.科室id And 人员id = 人员id_In)))
                --站点 
                 And (d.站点 Is Null Or d.站点 = 站点_In)
           Order By a.年份 Desc, a.月份 Desc, a.周数 Desc)
    Where Rownum < 2;
  Exception
    When Others Then
      n_出诊id := 0;
  End;
  If Nvl(n_出诊id, 0) <> 0 And Nvl(n_出诊id, 0) <> Id_In Then
    v_Err_Msg := '必须从最后一个出诊表开始删除！';
    Raise Err_Item;
  End If;

  If Nvl(人员id_In, 0) <> 0 Then
    --没有"所有科室"权限
    Select Count(1)
    Into n_Count
    From 临床出诊安排 A, 临床出诊号源 B
    Where a.号源id = b.Id And a.出诊id = Id_In And
          Not (Nvl(b.是否临床排班, 0) = 1 And Exists (Select 1 From 部门人员 Where 部门id = b.科室id And 人员id = 人员id_In)) And
          Rownum < 2;
    If n_Count <> 0 Then
      v_Err_Msg := '当前出诊表中含有其它人员已经制定的安排，不能删除！';
      Raise Err_Item;
    End If;
  End If;

  --删除临床出诊记录 
  Select a.Id Bulk Collect
  Into l_记录id
  From 临床出诊记录 A, 临床出诊安排 B, 临床出诊号源 C, 部门表 D
  Where a.安排id = b.Id And a.号源id = c.Id And c.科室id = d.Id And b.出诊id = Id_In
       --当前人员可操作的号源 
        And (Nvl(人员id_In, 0) = 0 Or
        (Nvl(c.是否临床排班, 0) = 1 And Exists (Select 1 From 部门人员 Where c.科室id = 部门id And 人员id = 人员id_In)))
       --站点 
        And (d.站点 Is Null Or d.站点 = 站点_In);

  Zl_临床出诊记录_Batchdelete(l_记录id);

  --删除临床出诊安排 
  Delete From 临床出诊安排 A
  Where a.出诊id = Id_In And Exists
   (Select 1
         From 临床出诊号源 B, 部门表 D
         Where a.号源id = b.Id And b.科室id = d.Id
              --当前人员可操作的号源 
               And (Nvl(人员id_In, 0) = 0 Or (Nvl(b.是否临床排班, 0) = 1 And Exists
                (Select 1 From 部门人员 Where b.科室id = 部门id And 人员id = 人员id_In)))
              --站点 
               And (d.站点 Is Null Or d.站点 = 站点_In));

  --删除临床出诊表 
  Delete 临床出诊表 A
  Where a.Id = Id_In And Not Exists (Select 1 From 临床出诊安排 Where 出诊id = a.Id And 号源id Is Not Null);
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊表_Delete;
/

--107321:冉俊明,2017-04-14,修改无“所有科室”权限时的功能控制问题
Create Or Replace Procedure Zl_临床出诊安排_序号控制
(
  出诊id_In   临床出诊表.Id%Type,
  序号控制_In 临床出诊限制.是否序号控制%Type,
  站点_In     部门表.站点%Type := Null,
  人员id_In   人员表.Id%Type := 0
) As
  --全部启用序号控制或者全部取消序号控制 
  --参数： 
  --      人员id_In 不等于0则修改人员所在科室的所有号源安排，否则修改所有号源的安排 
  n_Count    Number(2);
  n_出诊记录 Number(2);

  Err_Item Exception;
  v_Err_Msg Varchar2(255);

  l_安排id t_Numlist := t_Numlist();

  --该游标用于读取所有临床出诊安排的ID 
  Cursor c_安排
  (
    出诊id_In 临床出诊表.Id%Type,
    人员id_In 人员表.Id%Type := 0
  ) Is
    Select b.Id
    From 临床出诊安排 B, 临床出诊号源 C
    Where b.号源id = c.Id And b.出诊id = 出诊id_In And
          (Nvl(人员id_In, 0) = 0 Or (Nvl(人员id_In, 0) <> 0 And Nvl(c.是否临床排班, 0) = 1 And Exists
           (Select 1 From 部门人员 Where 部门id = c.科室id And 人员id = 人员id_In))) And Exists
     (Select 1 From 部门表 Where ID = c.科室id And (站点_In Is Null Or (站点 Is Null Or 站点 = 站点_In)));
Begin
  Select Count(1)
  Into n_Count
  From 临床出诊表 A
  Where a.Id = 出诊id_In And a.发布人 Is Not Null And a.排班方式 <> 3 And Rownum < 2;
  If n_Count <> 0 Then
    v_Err_Msg := '当前出诊表已发布，不允许修改！';
    Raise Err_Item;
  End If;

  Select Count(1) Into n_Count From 临床出诊表 A Where a.Id = 出诊id_In And a.排班方式 In (1, 2) And Rownum < 2;
  If n_Count <> 0 Then
    n_出诊记录 := 1;
  End If;

  Open c_安排(出诊id_In, 人员id_In);
  Fetch c_安排 Bulk Collect
    Into l_安排id;
  Close c_安排;

  If Nvl(n_出诊记录, 0) = 0 Then
    --临床出诊限制或模板 
    Forall I In 1 .. l_安排id.Count
      Update 临床出诊限制
      Set 是否序号控制 = 序号控制_In
      Where (限号数 Is Not Null Or 限约数 Is Not Null) And 安排id = l_安排id(I);
  
  Else
    --临床出诊记录 
    Forall I In 1 .. l_安排id.Count
      Update 临床出诊记录
      Set 是否序号控制 = 序号控制_In
      Where (限号数 Is Not Null Or 限约数 Is Not Null) And 安排id = l_安排id(I);
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊安排_序号控制;
/

--107321:冉俊明,2017-04-14,修改无“所有科室”权限时的功能控制问题
Create Or Replace Procedure Zl_临床出诊安排_Batchdelete
(
  出诊id_In   临床出诊表.Id%Type,
  人员id_In   人员表.Id%Type := 0,
  站点_In     部门表.站点%Type := Null,
  号源id_In   临床出诊安排.号源id%Type := 0,
  安排id_In   临床出诊安排.Id%Type := 0,
  临时安排_In 临床出诊安排.是否临时安排%Type := 0
) As
  --功能：批量删除临床出诊安排 
  --参数： 
  --      人员id_In 不等于0则删除人员所在科室的所有号源安排 
  --      号源id_In 不等于0则删除该号源的所有安排 
  --      安排ID_in 不等于0则删除该号源的当前安排(一般是临时安排) 
  --说明：如果人员id_In=0且号源id_In=0 则删除该出诊表的所有号源的所有安排 
  n_Count    Number(8);
  n_出诊记录 Number(1);

  Err_Item Exception;
  v_Err_Msg Varchar2(255);

  l_限制id t_Numlist := t_Numlist();
  l_记录id t_Numlist := t_Numlist();
Begin
  If Nvl(临时安排_In, 0) = 0 Then
    Begin
      Select 1
      Into n_Count
      From 临床出诊表 A
      Where a.Id = 出诊id_In And a.发布人 Is Not Null And a.排班方式 <> 3 And Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If n_Count <> 0 Then
      v_Err_Msg := '当前出诊表已发布，不允许修改安排！';
      Raise Err_Item;
    End If;
  End If;

  Begin
    Select 1 Into n_出诊记录 From 临床出诊表 A Where a.Id = 出诊id_In And a.排班方式 In (1, 2) And Rownum < 2;
  Exception
    When Others Then
      n_出诊记录 := 0;
  End;

  If Nvl(n_出诊记录, 0) = 0 Then
    --删除临床出诊规则/模板 
    Select a.Id Bulk Collect
    Into l_限制id
    From 临床出诊限制 A, 临床出诊安排 B, 临床出诊号源 C, 部门表 D
    Where a.安排id = b.Id And b.号源id = c.Id And c.科室id = d.Id And b.出诊id = 出诊id_In And
          (
          --删除该出诊表的所有号源的所有安排 
           (Nvl(号源id_In, 0) = 0 And Nvl(人员id_In, 0) = 0)
          --删除该号源的所有安排 
           Or (Nvl(号源id_In, 0) <> 0 And b.号源id = 号源id_In And Nvl(安排id_In, 0) = 0)
          --删除该号源的选择安排 
           Or (Nvl(安排id_In, 0) <> 0 And b.Id = 安排id_In)
          --删除人员所在科室的所有号源安排 
           Or (Nvl(人员id_In, 0) <> 0 And Nvl(c.是否临床排班, 0) = 1 And Exists
            (Select 1 From 部门人员 Where 部门id = c.科室id And 人员id = 人员id_In)))
         --站点 
          And (d.站点 Is Null Or d.站点 = 站点_In);
  
    Forall I In 1 .. l_限制id.Count
      Delete From 临床出诊挂号控制 Where 限制id = l_限制id(I);
  
    Forall I In 1 .. l_限制id.Count
      Delete From 临床出诊时段 Where 限制id = l_限制id(I);
  
    Forall I In 1 .. l_限制id.Count
      Delete From 临床出诊诊室 Where 限制id = l_限制id(I);
  
    Forall I In 1 .. l_限制id.Count
      Delete From 临床出诊限制 Where ID = l_限制id(I);
  
    --删除临床出诊安排 
    For c_安排 In (Select b.Id
                 From 临床出诊安排 B, 临床出诊号源 C, 部门表 D
                 Where b.号源id = c.Id And c.科室id = d.Id And b.出诊id = 出诊id_In And
                       (
                       --删除该出诊表的所有号源的所有安排 
                        (Nvl(号源id_In, 0) = 0 And Nvl(人员id_In, 0) = 0)
                       --删除该号源的所有安排 
                        Or (Nvl(号源id_In, 0) <> 0 And b.号源id = 号源id_In And Nvl(安排id_In, 0) = 0)
                       --删除该号源的选择安排 
                        Or (Nvl(安排id_In, 0) <> 0 And b.Id = 安排id_In)
                       --删除人员所在科室的所有号源安排 
                        Or (Nvl(人员id_In, 0) <> 0 And Nvl(c.是否临床排班, 0) = 1 And Exists
                         (Select 1 From 部门人员 Where 部门id = c.科室id And 人员id = 人员id_In)))
                      --站点 
                       And (d.站点 Is Null Or d.站点 = 站点_In) And Not Exists
                  (Select 1 From 临床出诊限制 Where 安排id = b.Id)) Loop
      Zl_临床出诊安排_Delete(c_安排.Id);
    End Loop;
  Else
    --删除临床出诊记录 
    Select a.Id Bulk Collect
    Into l_记录id
    From 临床出诊记录 A, 临床出诊安排 B, 临床出诊号源 C, 部门表 D
    Where a.安排id = b.Id And b.号源id = c.Id And c.科室id = d.Id And b.出诊id = 出诊id_In And
          (
          --删除该出诊表的所有号源的所有安排 
           (Nvl(号源id_In, 0) = 0 And Nvl(人员id_In, 0) = 0)
          --删除该号源的所有安排 
           Or (Nvl(号源id_In, 0) <> 0 And b.号源id = 号源id_In And Nvl(安排id_In, 0) = 0)
          --删除该号源的选择安排 
           Or (Nvl(安排id_In, 0) <> 0 And b.Id = 安排id_In)
          --删除人员所在科室的所有号源安排 
           Or (Nvl(人员id_In, 0) <> 0 And Nvl(c.是否临床排班, 0) = 1 And Exists
            (Select 1 From 部门人员 Where 部门id = c.科室id And 人员id = 人员id_In)))
         --站点 
          And (d.站点 Is Null Or d.站点 = 站点_In);
  
    Zl_临床出诊记录_Batchdelete(l_记录id);
  
    --删除临床出诊安排 
    For c_安排 In (Select b.Id
                 From 临床出诊安排 B, 临床出诊号源 C, 部门表 D
                 Where b.号源id = c.Id And c.科室id = d.Id And b.出诊id = 出诊id_In And
                       (
                       --删除该出诊表的所有号源的所有安排 
                        (Nvl(号源id_In, 0) = 0 And Nvl(人员id_In, 0) = 0)
                       --删除该号源的所有安排 
                        Or (Nvl(号源id_In, 0) <> 0 And b.号源id = 号源id_In And Nvl(安排id_In, 0) = 0)
                       --删除该号源的选择安排 
                        Or (Nvl(安排id_In, 0) <> 0 And b.Id = 安排id_In)
                       --删除人员所在科室的所有号源安排 
                        Or (Nvl(人员id_In, 0) <> 0 And Nvl(c.是否临床排班, 0) = 1 And Exists
                         (Select 1 From 部门人员 Where 部门id = c.科室id And 人员id = 人员id_In)))
                      --站点 
                       And (d.站点 Is Null Or d.站点 = 站点_In) And Not Exists
                  (Select 1 From 临床出诊记录 Where 安排id = b.Id)) Loop
      Zl_临床出诊安排_Delete(c_安排.Id);
    End Loop;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊安排_Batchdelete;
/

--108192:蒋廷中,2017-04-14,解决icd附码删除错误的问题
Create Or Replace Procedure Zl_病人诊断记录_Delete
(
  --功能：删除病人诊断记录 
  --参数：诊断类型_IN=为空时表示所有类型,否则为字符串,如'1,2,3...' 
  --      诊断s_In=需要删除的诊断ID串 ,格式为 'ID1,ID2,ID3...'  
  病人id_In   病人诊断记录.病人id%Type,
  主页id_In   病人诊断记录.主页id%Type,
  记录来源_In 病人诊断记录.记录来源%Type := Null,
  病历id_In   病人诊断记录.病历id%Type := Null,
  诊断类型_In Varchar2 := Null,
  诊断ids_In  Varchar2 := Null
) Is
  V_类型串 Varchar2(255);
  V_类型   病人诊断记录.诊断类型%Type;
Begin
  If 诊断类型_In Is Null Then
    If Not 诊断ids_In Is Null Then
      For Rdiag In (Select /*+ Rule*/
                     ID, 记录来源, 诊断类型, 诊断次序
                    From 病人诊断记录
                    Where ID In (Select Column_Value From Table(F_Str2list(诊断ids_In)))
                    Order By 记录来源, 诊断类型, 诊断次序) Loop
        If Rdiag.记录来源 = 3 And Rdiag.诊断类型 = 2 And Rdiag.诊断次序 = 1 Then
          Update 病案主页 Set 单病种 = Null Where 病人id = 病人id_In And 主页id = Nvl(主页id_In, 0);
        End If;
        --如果诊断类型是当前传入的诊断类型，则删除诊断
        If Rdiag.记录来源 = 记录来源_In Or 记录来源_In Is Null Then
          Delete From 病人诊断医嘱 Where 诊断id = Rdiag.Id;
          Delete From 病人诊断记录
          Where 病人id = 病人id_In And 主页id = 主页id_In And 记录来源 = Rdiag.记录来源 And 诊断类型 = Rdiag.诊断类型 And 诊断次序 = Rdiag.诊断次序 And
                Nvl(编码序号, 1) = 2;
          Delete From 病人诊断记录 Where ID = Rdiag.Id;
        End If;
      End Loop;
    Else
      Delete From 病人诊断医嘱
      Where 诊断id In (Select ID
                     From 病人诊断记录
                     Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0) And (记录来源 = 记录来源_In Or 记录来源_In Is Null) And
                           (病历id = 病历id_In Or 病历id_In Is Null));
    
      Delete From 病人诊断记录
      Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0) And (记录来源 = 记录来源_In Or 记录来源_In Is Null) And
            (病历id = 病历id_In Or 病历id_In Is Null);
      --删除单病种标识 
      If 记录来源_In = 3 Then
        Update 病案主页 Set 单病种 = Null Where 病人id = 病人id_In And 主页id = Nvl(主页id_In, 0);
      End If;
    End If;
  Else
    V_类型串 := 诊断类型_In || ',';
    While V_类型串 Is Not Null Loop
      V_类型 := To_Number(Substr(V_类型串, 1, Instr(V_类型串, ',') - 1));
    
      Delete From 病人诊断医嘱
      Where 诊断id In (Select ID
                     From 病人诊断记录
                     Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0) And (记录来源 = 记录来源_In Or 记录来源_In Is Null) And
                           (病历id = 病历id_In Or 病历id_In Is Null) And 诊断类型 = V_类型);
    
      Delete From 病人诊断记录
      Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0) And (记录来源 = 记录来源_In Or 记录来源_In Is Null) And
            (病历id = 病历id_In Or 病历id_In Is Null) And 诊断类型 = V_类型;
    
      V_类型串 := Substr(V_类型串, Instr(V_类型串, ',') + 1);
    
      --如果是入院诊断则删除单病种标识 
      If V_类型 = 2 And 记录来源_In = 3 Then
        Update 病案主页 Set 单病种 = Null Where 病人id = 病人id_In And 主页id = Nvl(主页id_In, 0);
      End If;
    End Loop;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人诊断记录_Delete;
/

--108220:胡俊勇,2017-04-14,医嘱单打印修改
Create Or Replace Procedure Zl_病人医嘱打印_Insert
(
  病人id_In 病人医嘱记录.病人id%Type,
  主页id_In 病人医嘱记录.主页id%Type,
  婴儿_In   病人医嘱记录.婴儿%Type,
  期效_In   病人医嘱记录.医嘱期效%Type,
  行数_In   Number
  --功能：将病人没有打印过的医嘱插入 病人医嘱打印
  --参数：行数_In：报表医嘱单一页可以打多少行
  --      行数_In医嘱单报表的行数，通常是28行。
) Is
  n_序号       病人医嘱记录.序号%Type;
  n_医嘱id     病人医嘱记录.Id%Type;
  n_重整标记   Number;
  v_Max_Date   Date;
  d_重整       Date;
  d_Pdate      Date;
  n_换页打     Number;
  n_打重开     Number;
  n_转科       Number;
  n_页号       Number;
  n_行号       Number;
  n_位置       Number;
  n_打印模式   Number;
  n_打给药方式 Number;
  n_Lzzkhy     Number;
  v_Tmp        Varchar2(200);

  --c_Advice 取出待打印的医嘱，在打印临嘱时转科医嘱都会读取出来，后面要判断是不是要生成打印记录
  Cursor c_Advice Is
    Select 医嘱id, 顺序, 打印标记, 特殊医嘱, 换页
    From (With Printtable As (Select a.Id As 医嘱id, a.序号 As 顺序, 0 As 打印标记, Null As 特殊医嘱,
                                     Decode(a.诊疗类别, 'Z', Decode(b.操作类型, '3', 3, '4', 4, 0), 0) As 换页, a.诊疗项目id, a.相关id,
                                     b.操作类型, a.诊疗类别
                              From 病人医嘱记录 A, 诊疗项目目录 B
                              Where a.病人id = 病人id_In And a.主页id = 主页id_In And Nvl(a.婴儿, 0) = 婴儿_In And a.诊疗项目id = b.Id(+) And
                                    (期效_In = 0 And (a.医嘱期效 = 0 Or n_位置 In (-1, 0, 2) And a.医嘱期效 = 1 And a.诊疗类别 = 'Z' And
                                    b.操作类型 In ('5', '3', '11')) Or
                                    期效_In = 1 And a.医嘱期效 = 1 And
                                    Not (n_位置 = 0 And Nvl(a.诊疗类别, 'X') = 'Z' And Nvl(b.操作类型, 'X') In ('5', '3', '11')) Or
                                    期效_In = 1 And a.医嘱期效 = 1 And n_位置 = 0 And a.诊疗类别 = 'Z' And b.操作类型 = '3') And
                                    a.医嘱状态 Not In (-1, 2) And (n_打印模式 = 1 And a.医嘱状态 = 1 Or a.医嘱状态 <> 1) And
                                    Nvl(a.屏蔽打印, 0) = 0 And Not Exists
                               (Select 1 From 病人医嘱记录 W Where w.诊疗类别 = 'F' And w.Id = a.前提id) And a.序号 > n_序号 And
                                    a.病人来源 = 2)
           Select p.医嘱id, p.顺序, p.打印标记, p.特殊医嘱, p.换页
           From 病人医嘱记录 L, 诊疗项目目录 I, Printtable P
           Where l.Id = p.医嘱id And l.诊疗项目id = i.Id And
                 (l.诊疗类别 Not In ('5', '6', '7', 'E') Or l.诊疗类别 = 'E' And Nvl(i.操作类型, '0') Not In ('2', '3') Or
                 i.Id Is Null) And l.相关id Is Null
           Union All
           Select p.医嘱id, p.顺序, p.打印标记, p.特殊医嘱, p.换页
           From 病人医嘱记录 L, Printtable P
           Where l.Id = p.医嘱id And l.诊疗类别 In ('5', '6')
           Union All
           Select p.医嘱id, p.顺序, p.打印标记, p.特殊医嘱, p.换页
           From Printtable P
           Where p.诊疗类别 = 'E' And p.操作类型 = '2' And p.相关id Is Null And
                 (n_打给药方式 = 1 Or n_打给药方式 = 2 And Exists
                  (Select 1 From 病人医嘱记录 L Where l.相关id = p.医嘱id Having Count(1) > 1))
           Union All
           Select p.医嘱id, p.顺序, p.打印标记, p.特殊医嘱, p.换页
           From Printtable P
           Where p.诊疗项目id Is Null
           Order By 顺序);


  Cursor c_Advice_Redo Is
    Select 医嘱id, 顺序, 打印标记, 特殊医嘱, 换页
    From (With Printtable As (Select a.Id As 医嘱id, a.序号 As 顺序, 0 As 打印标记, Null As 特殊医嘱,
                                     Decode(a.诊疗类别, 'Z', Decode(b.操作类型, '3', 3, '4', 4, 0), 0) As 换页, a.诊疗项目id, a.相关id,
                                     b.操作类型, a.诊疗类别
                              From 病人医嘱记录 A, 诊疗项目目录 B
                              Where a.病人id = 病人id_In And a.主页id = 主页id_In And Nvl(a.婴儿, 0) = 婴儿_In And a.诊疗项目id = b.Id(+) And
                                    (期效_In = 0 And (a.医嘱期效 = 0 Or n_位置 In (-1, 0, 2) And a.医嘱期效 = 1 And a.诊疗类别 = 'Z' And
                                    b.操作类型 In ('5', '3', '11')) Or
                                    期效_In = 1 And a.医嘱期效 = 1 And
                                    Not (n_位置 = 0 And Nvl(a.诊疗类别, 'X') = 'Z' And Nvl(b.操作类型, 'X') In ('5', '3', '11'))) And
                                    a.医嘱状态 Not In (-1, 2) And (n_打印模式 = 1 And a.医嘱状态 = 1 Or a.医嘱状态 <> 1) And
                                    Nvl(a.屏蔽打印, 0) = 0 And Not Exists
                               (Select 1 From 病人医嘱记录 Where 诊疗类别 = 'F' And ID = a.前提id) And a.序号 > n_序号 And Exists
                               (Select 1 From 病人医嘱状态 C Where a.Id = c.医嘱id And c.操作时间 >= v_Max_Date) And a.病人来源 = 2)
           Select p.医嘱id, p.顺序, p.打印标记, p.特殊医嘱, p.换页
           From 病人医嘱记录 L, 诊疗项目目录 I, Printtable P
           Where l.Id = p.医嘱id And l.诊疗项目id = i.Id And
                 (l.诊疗类别 Not In ('5', '6', '7', 'E') Or l.诊疗类别 = 'E' And Nvl(i.操作类型, '0') Not In ('2', '3') Or
                 i.Id Is Null) And l.相关id Is Null
           Union All
           Select p.医嘱id, p.顺序, p.打印标记, p.特殊医嘱, p.换页
           From 病人医嘱记录 L, Printtable P
           Where l.Id = p.医嘱id And l.诊疗类别 In ('5', '6')
           Union All
           Select p.医嘱id, p.顺序, p.打印标记, p.特殊医嘱, p.换页
           From Printtable P
           Where p.诊疗类别 = 'E' And p.操作类型 = '2' And p.相关id Is Null And
                 (n_打给药方式 = 1 Or n_打给药方式 = 2 And Exists
                  (Select 1 From 病人医嘱记录 L Where l.相关id = p.医嘱id Having Count(1) > 1))
           Union All
           Select p.医嘱id, p.顺序, p.打印标记, p.特殊医嘱, p.换页
           From Printtable P
           Where p.诊疗项目id Is Null
           Order By 顺序);


  --获取下一个或用的行号和页号
  Function Getnextpos
  (
    v_页号 病人医嘱打印.页号%Type,
    v_行号 病人医嘱打印.行号%Type,
    v_行数 Number
  ) Return Varchar2 Is
    n_p Number;
    n_r Number;
  Begin
    If v_行号 = 0 Then
      n_p := 1;
      n_r := 1;
    Elsif v_行号 = v_行数 Then
      n_p := v_页号 + 1;
      n_r := 1;
    Else
      n_p := v_页号;
      n_r := v_行号 + 1;
    End If;
    Return(n_p || ',' || n_r);
  End;

Begin
  n_位置       := Zl_To_Number(Nvl(zl_GetSysParameter('转科和出院打印', 1254), 0));
  n_打印模式   := Zl_To_Number(Nvl(zl_GetSysParameter('医嘱单打印模式', 1253), 0));
  n_打给药方式 := Zl_To_Number(Nvl(zl_GetSysParameter('药品用法单独打印一行', 1254), 0));
  n_Lzzkhy     := Zl_To_Number(Nvl(zl_GetSysParameter('临嘱单转科换页', 1254), 0));

  If 期效_In = 1 Then
    d_重整 := To_Date('1900-01-01', 'YYYY-MM-DD');
  Else
    Select 医嘱重整时间 Into d_重整 From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
    If d_重整 Is Null Then
      d_重整 := To_Date('1900-01-01', 'YYYY-MM-DD');
    End If;
  End If;
  v_Max_Date := d_重整;
  Begin
    Select 医嘱id, 打印时间, 页号, 行号
    Into n_医嘱id, d_Pdate, n_页号, n_行号
    From (Select 医嘱id, 打印时间, 页号, 行号
           From 病人医嘱打印
           Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(婴儿, 0) = 婴儿_In And 期效 = 期效_In And 医嘱id Is Not Null
           Order By 页号 Desc, 行号 Desc)
    Where Rownum < 2;
  
    Select Nvl(Max(序号), 0)
    Into n_序号
    From 病人医嘱记录
    Where ID = (Select Nvl(a.相关id, a.Id) From 病人医嘱记录 A Where a.Id = n_医嘱id);
  
    If 期效_In = 0 Then
      If d_Pdate Is Not Null Then
        If d_Pdate < d_重整 And d_重整 <> To_Date('1900-01-01', 'YYYY-MM-DD') Then
          n_重整标记 := 1;
          n_序号     := 0;
        End If;
      End If;
    End If;
  Exception
    When Others Then
      n_页号 := 0;
      n_行号 := 0;
      n_序号 := 0;
  End;

  If 期效_In = 0 Then
    n_换页打 := Zl_To_Number(Nvl(zl_GetSysParameter('重整和术后医嘱换页打印', 1254), 0));
    n_打重开 := Zl_To_Number(Nvl(zl_GetSysParameter('转科换页后在首行打印重开医嘱', 1254), 0));
    If n_医嘱id Is Not Null And n_打重开 = 1 Then
      Select Count(1)
      Into n_转科
      From 病人医嘱记录 A, 诊疗项目目录 B
      Where a.诊疗项目id = b.Id(+) And a.Id = n_医嘱id And a.诊疗类别 = 'Z' And b.操作类型 = '3';
    End If;
  End If;

  v_Tmp  := Getnextpos(n_页号, n_行号, 行数_In);
  n_页号 := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
  n_行号 := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);

  --插入重整医嘱，只插入一条
  If n_重整标记 = 1 Then
    If n_换页打 = 1 Then
      If n_行号 <> 1 Then
        n_行号 := 1;
        n_页号 := n_页号 + 1;
      End If;
    End If;
    Insert Into 病人医嘱打印
      (医嘱id, 页号, 行号, 行数, 病人id, 主页id, 婴儿, 期效, 打印标记, 特殊医嘱)
    Values
      (-1 * Null, n_页号, n_行号, 1, 病人id_In, 主页id_In, 婴儿_In, 期效_In, 0, Null);
    v_Tmp  := Getnextpos(n_页号, n_行号, 行数_In);
    n_页号 := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
    n_行号 := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
  End If;

  --转科医嘱换页打医嘱重开字样
  If n_换页打 = 1 And n_转科 = 1 And 期效_In = 0 Then
    If n_重整标记 = 1 Then
      --前面打了重整就不换页了
      If n_打重开 = 1 Then
        Insert Into 病人医嘱打印
          (医嘱id, 页号, 行号, 行数, 病人id, 主页id, 婴儿, 期效, 打印标记, 特殊医嘱)
        Values
          (-1 * Null, n_页号, n_行号, 1, 病人id_In, 主页id_In, 婴儿_In, 期效_In, 0, 1);
        v_Tmp  := Getnextpos(n_页号, n_行号, 行数_In);
        n_页号 := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
        n_行号 := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
      End If;
    Else
      If n_打重开 = 1 Then
        --打重开字样
        If n_行号 <> 1 Then
          n_行号 := 1;
          n_页号 := n_页号 + 1;
        End If;
        Insert Into 病人医嘱打印
          (医嘱id, 页号, 行号, 行数, 病人id, 主页id, 婴儿, 期效, 打印标记, 特殊医嘱)
        Values
          (-1 * Null, n_页号, n_行号, 1, 病人id_In, 主页id_In, 婴儿_In, 期效_In, 0, 1);
        v_Tmp  := Getnextpos(n_页号, n_行号, 行数_In);
        n_页号 := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
        n_行号 := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
      End If;
    End If;
  End If;
  n_转科 := 0;

  --最近次重整后,需要打印的医嘱，考虑换页打印情况转科术后
  ---r_Print.换页 对特殊医嘱标记，4－术后，3－转科
  If v_Max_Date = To_Date('1900-01-01', 'YYYY-MM-DD') Then
    For r_Print In c_Advice Loop
      ----换页或者打医嘱重开字样
      If n_换页打 = 1 And n_转科 = 1 And 期效_In = 0 Then
        If n_打重开 = 1 Then
          --打重开字样
          If n_行号 <> 1 Then
            n_行号 := 1;
            n_页号 := n_页号 + 1;
          End If;
          Insert Into 病人医嘱打印
            (医嘱id, 页号, 行号, 行数, 病人id, 主页id, 婴儿, 期效, 打印标记, 特殊医嘱)
          Values
            (-1 * Null, n_页号, n_行号, 1, 病人id_In, 主页id_In, 婴儿_In, 期效_In, 0, 1);
          v_Tmp  := Getnextpos(n_页号, n_行号, 行数_In);
          n_页号 := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
          n_行号 := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
        Else
          --只是单纯换一页
          If n_行号 <> 1 Then
            n_行号 := 1;
            n_页号 := n_页号 + 1;
          End If;
        End If;
        n_转科 := 0;
      End If;
    
      If 期效_In = 1 And n_转科 = 1 And n_Lzzkhy = 1 Then
        If n_行号 <> 1 Then
          n_行号 := 1;
          n_页号 := n_页号 + 1;
        End If;
        n_转科 := 0;
      End If;
    
      If r_Print.换页 = 4 And n_换页打 = 1 Then
        --术后医嘱换页
        --如果行号为1说明已经是新的一页的第一行,否则换页
        If n_行号 <> 1 Then
          n_行号 := 1;
          n_页号 := n_页号 + 1;
        End If;
      End If;
    
      If 期效_In = 0 Or 期效_In = 1 And (n_位置 = 2 Or n_位置 = 1 Or r_Print.换页 <> 3) Then
        Insert Into 病人医嘱打印
          (医嘱id, 页号, 行号, 行数, 病人id, 主页id, 婴儿, 期效, 打印标记, 特殊医嘱)
        Values
          (r_Print.医嘱id, n_页号, n_行号, 1, 病人id_In, 主页id_In, 婴儿_In, 期效_In, r_Print.打印标记, r_Print.特殊医嘱);
        v_Tmp  := Getnextpos(n_页号, n_行号, 行数_In);
        n_页号 := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
        n_行号 := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
      End If;
      --启用了转科换页打重开字样，则插入一重开医嘱标记，此处一定换页，因为转科换页前要先打出转科医嘱，
      --这里不插入数据，只进行标记，再下一次循时才插入。如果转科医嘱是最后一条是不用打印新开字样的。
      If r_Print.换页 = 3 Then
        n_转科 := 1;
      End If;
    End Loop;
  Else
    For r_Print In c_Advice_Redo Loop
      ----换页或者打医嘱重开字样
      If n_换页打 = 1 And n_转科 = 1 And 期效_In = 0 Then
        If n_打重开 = 1 Then
          --打重开字样
          If n_行号 <> 1 Then
            n_行号 := 1;
            n_页号 := n_页号 + 1;
          End If;
          Insert Into 病人医嘱打印
            (医嘱id, 页号, 行号, 行数, 病人id, 主页id, 婴儿, 期效, 打印标记, 特殊医嘱)
          Values
            (-1 * Null, n_页号, n_行号, 1, 病人id_In, 主页id_In, 婴儿_In, 期效_In, 0, 1);
          v_Tmp  := Getnextpos(n_页号, n_行号, 行数_In);
          n_页号 := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
          n_行号 := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
        Else
          --只是单纯换一页
          If n_行号 <> 1 Then
            n_行号 := 1;
            n_页号 := n_页号 + 1;
          End If;
        End If;
        n_转科 := 0;
      End If;
    
      If r_Print.换页 = 4 And n_换页打 = 1 Then
        --术后医嘱换页
        --如果行号为1说明已经是新的一页的第一行,否则换页
        If n_行号 <> 1 Then
          n_行号 := 1;
          n_页号 := n_页号 + 1;
        End If;
      End If;
      Insert Into 病人医嘱打印
        (医嘱id, 页号, 行号, 行数, 病人id, 主页id, 婴儿, 期效, 打印标记, 特殊医嘱)
      Values
        (r_Print.医嘱id, n_页号, n_行号, 1, 病人id_In, 主页id_In, 婴儿_In, 期效_In, r_Print.打印标记, r_Print.特殊医嘱);
      v_Tmp  := Getnextpos(n_页号, n_行号, 行数_In);
      n_页号 := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
      n_行号 := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
      --启用了转科换页打重开字样，则插入一重开医嘱标记，此处一定换页，因为转科换页前要先打出转科医嘱
      --这里不插入数据，只进行标记，再下一次循时才插入。如果转科医嘱是最后一条是不用打印新开字样的。
    
      If r_Print.换页 = 3 And 期效_In = 0 Then
        n_转科 := 1;
      End If;
    End Loop;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人医嘱打印_Insert;
/

--106872:刘尔旋,2017-04-12,预约接收保存摘要
Create Or Replace Procedure Zl_预约挂号接收_Insert
(
  No_In            门诊费用记录.No%Type,
  票据号_In        门诊费用记录.实际票号%Type,
  领用id_In        票据使用明细.领用id%Type,
  结帐id_In        门诊费用记录.结帐id%Type,
  诊室_In          门诊费用记录.发药窗口%Type,
  病人id_In        门诊费用记录.病人id%Type,
  门诊号_In        门诊费用记录.标识号%Type,
  姓名_In          门诊费用记录.姓名%Type,
  性别_In          门诊费用记录.性别%Type,
  年龄_In          门诊费用记录.年龄%Type,
  付款方式_In      门诊费用记录.付款方式%Type, --用于存放病人的医疗付款方式编号
  费别_In          门诊费用记录.费别%Type,
  结算方式_In      病人预交记录.结算方式%Type, --现金的结算名称
  现金支付_In      病人预交记录.冲预交%Type, --挂号时现金支付部份金额
  预交支付_In      病人预交记录.冲预交%Type, --挂号时使用的预交金额
  个帐支付_In      病人预交记录.冲预交%Type, --挂号时个人帐户支付金额
  发生时间_In      门诊费用记录.发生时间%Type,
  号序_In          挂号序号状态.序号%Type,
  操作员编号_In    门诊费用记录.操作员编号%Type,
  操作员姓名_In    门诊费用记录.操作员姓名%Type,
  生成队列_In      Number := 0,
  登记时间_In      门诊费用记录.登记时间%Type := Null,
  卡类别id_In      病人预交记录.卡类别id%Type := Null,
  结算卡序号_In    病人预交记录.结算卡序号%Type := Null,
  卡号_In          病人预交记录.卡号%Type := Null,
  交易流水号_In    病人预交记录.交易流水号%Type := Null,
  交易说明_In      病人预交记录.交易说明%Type := Null,
  险类_In          病人挂号记录.险类%Type := Null,
  结算模式_In      Number := 0,
  记帐费用_In      Number := 0,
  冲预交病人ids_In Varchar2 := Null,
  三方调用_In      Number := 0,
  更新交款余额_In  Number := 0, --是否更新人员交款余额，主要是处理统一操作员登录多台自助机的情况
  摘要_In          病人挂号记录.摘要%Type := Null
) As
  --该游标用于收费冲预交的可用预交列表
  --以ID排序，优先冲上次未冲完的。
  Cursor c_Deposit
  (
    v_病人id        病人信息.病人id%Type,
    v_冲预交病人ids Varchar2
  ) Is
    Select 病人id, NO, Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) As 金额, Min(记录状态) As 记录状态, Nvl(Max(结帐id), 0) As 结帐id,
           Max(Decode(记录性质, 1, ID, 0) * Decode(记录状态, 2, 0, 1)) As 原预交id
    From 病人预交记录
    Where 记录性质 In (1, 11) And 病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And Nvl(预交类别, 2) = 1
     Having Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) <> 0
    Group By NO, 病人id
    Order By Decode(病人id, Nvl(v_病人id, 0), 0, 1), 结帐id, NO;

  v_Err_Msg Varchar2(255);
  Err_Item    Exception;
  Err_Special Exception;

  v_现金     结算方式.名称%Type;
  v_个人帐户 结算方式.名称%Type;
  v_队列名称 排队叫号队列.队列名称%Type;
  v_号别     门诊费用记录.计算单位%Type;
  v_号序     门诊费用记录.发药窗口%Type;
  v_排队号码 排队叫号队列.排队号码 %Type;
  v_预约方式 病人挂号记录.预约方式 %Type;

  n_打印id        票据打印内容.Id%Type;
  n_预交金额      病人预交记录.金额%Type;
  n_返回值        病人预交记录.金额%Type;
  v_冲预交病人ids Varchar2(4000);

  n_挂号id         病人挂号记录.Id%Type;
  n_分诊台签到排队 Number;
  n_组id           财务缴款分组.Id%Type;
  n_Count          Number(18);
  n_排队           Number;
  n_当天排队       Number;
  n_当前金额       病人预交记录.金额%Type;
  n_预交id         病人预交记录.Id%Type;
  n_消费卡id       消费卡目录.Id%Type;
  n_自制卡         Number;

  d_Date       Date;
  d_预约时间   门诊费用记录.发生时间%Type;
  d_发生时间   Date;
  d_排队时间   Date;
  n_时段       Number := 0;
  n_存在       Number := 0;
  v_排队序号   排队叫号队列.排队序号%Type;
  n_结算模式   病人信息.结算模式%Type;
  n_票种       票据使用明细.票种%Type;
  v_付款方式   病人挂号记录.医疗付款方式%Type;
  v_操作员姓名 病人挂号记录.接收人%Type;
  n_接收模式   Number := 0;
Begin
  n_组id          := Zl_Get组id(操作员姓名_In);
  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);
  n_接收模式      := Nvl(zl_GetSysParameter('预约接收模式', 1111), 0);

  --获取结算方式名称
  Begin
    Select 名称 Into v_现金 From 结算方式 Where 性质 = 1;
  Exception
    When Others Then
      v_现金 := '现金';
  End;
  Begin
    Select 名称 Into v_个人帐户 From 结算方式 Where 性质 = 3;
  Exception
    When Others Then
      v_个人帐户 := '个人帐户';
  End;
  If 登记时间_In Is Null Then
    Select Sysdate Into d_Date From Dual;
  Else
    d_Date := 登记时间_In;
  End If;

  --更新挂号序号状态
  Begin
    Select 号别, 号序, Trunc(发生时间), 发生时间, 预约方式
    Into v_号别, v_号序, d_预约时间, d_发生时间, v_预约方式
    From 病人挂号记录
    Where 记录性质 = 2 And 记录状态 = 1 And Rownum = 1 And NO = No_In;
  Exception
    When Others Then
      Select Max(接收人) Into v_操作员姓名 From 病人挂号记录 Where 记录性质 = 2 And 记录状态 In (1, 3) And NO = No_In;
      If v_操作员姓名 Is Null Then
        v_Err_Msg := '当前预约挂号单已被取消';
        Raise Err_Item;
      Else
        If v_操作员姓名 = 操作员姓名_In Then
          v_Err_Msg := '当前预约挂号单已被接收';
          Raise Err_Special;
        Else
          v_Err_Msg := '当前预约挂号单已被其它人接收';
          Raise Err_Item;
        End If;
      End If;
  End;

  --判断是否分时段
  Begin
    Select 1
    Into n_时段
    From Dual
    Where Exists (Select 1
           From 挂号安排时段 A, 挂号安排 B
           Where a.安排id = b.Id And b.号码 = v_号别 And Rownum < 2
           Union All
           Select 1
           From 挂号计划时段 C, 挂号安排计划 D 　
           Where c.计划id = d.Id And d.号码 = v_号别 And d.生效时间 > Sysdate And Rownum < 2);
  Exception
    When Others Then
      n_时段 := 0;
  End;

  If n_时段 = 0 And 三方调用_In = 0 Then
    If n_接收模式 = 0 Then
      If Trunc(发生时间_In) = Trunc(Sysdate) Then
        d_发生时间 := 发生时间_In;
      Else
        d_发生时间 := Sysdate;
      End If;
    Else
      d_发生时间 := 发生时间_In;
    End If;
  Else
    If Not 发生时间_In Is Null Then
      d_发生时间 := 发生时间_In;
    End If;
  End If;
  If Not v_号序 Is Null Then
    If 号序_In Is Null Then
      Delete 挂号序号状态 Where 号码 = v_号别 And Trunc(日期) = Trunc(d_预约时间) And 序号 = v_号序;
    Else
      If Trunc(d_预约时间) <> Trunc(Sysdate) And n_接收模式 = 0 Then
      
        If n_时段 = 0 And 三方调用_In = 0 Then
          --提前接收或延迟接收
          Delete 挂号序号状态 Where 号码 = v_号别 And Trunc(日期) = Trunc(d_预约时间) And 序号 = v_号序;
          Begin
            Select 1 Into n_存在 From 挂号序号状态 Where 号码 = v_号别 And 日期 = Trunc(Sysdate) And 序号 = v_号序;
          Exception
            When Others Then
              n_存在 := 0;
          End;
          If n_存在 = 0 Then
            Insert Into 挂号序号状态
              (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
            Values
              (v_号别, Trunc(Sysdate), v_号序, 1, 操作员姓名_In, Sysdate);
          Else
            --号码已被使用的情况
            Begin
              v_号序 := 1;
              Insert Into 挂号序号状态
                (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
              Values
                (v_号别, Trunc(Sysdate), v_号序, 1, 操作员姓名_In, Sysdate);
            Exception
              When Others Then
                Select Min(序号 + 1)
                Into v_号序
                From 挂号序号状态 A
                Where 号码 = v_号别 And 日期 = Trunc(Sysdate) And Not Exists
                 (Select 1 From 挂号序号状态 Where 号码 = a.号码 And 日期 = a.日期 And 序号 = a.序号 + 1);
                Insert Into 挂号序号状态
                  (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
                Values
                  (v_号别, Trunc(Sysdate), v_号序, 1, 操作员姓名_In, Sysdate);
            End;
          End If;
        Else
          Update 挂号序号状态
          Set 状态 = 1, 登记时间 = Sysdate
          Where Trunc(日期) = Trunc(d_预约时间) And 序号 = v_号序 And 号码 = v_号别 And 状态 = 2;
          If Sql% NotFound Then
            Begin
              Insert Into 挂号序号状态
                (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
              Values
                (v_号别, Trunc(Sysdate), v_号序, 1, 操作员姓名_In, Sysdate);
            Exception
              When Others Then
                v_Err_Msg := '序号' || v_号序 || '已被其它人使用,请重新选择一个序号.';
                Raise Err_Item;
            End;
          End If;
        
        End If;
      
      Else
        Update 挂号序号状态
        Set 序号 = 号序_In, 状态 = 1, 登记时间 = Sysdate
        Where 号码 = v_号别 And Trunc(日期) = Trunc(d_预约时间) And 序号 = v_号序;
        If Sql%RowCount = 0 Then
          Begin
            Insert Into 挂号序号状态
              (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
            Values
              (v_号别, Trunc(d_发生时间), v_号序, 1, 操作员姓名_In, Sysdate);
          Exception
            When Others Then
              v_Err_Msg := '序号' || v_号序 || '已被其它人使用,请重新选择一个序号.';
              Raise Err_Item;
          End;
        End If;
      End If;
    End If;
  Else
    If Not 号序_In Is Null Then
      Begin
        Insert Into 挂号序号状态
          (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
        Values
          (v_号别, Trunc(Sysdate), 号序_In, 1, 操作员姓名_In, Sysdate);
      Exception
        When Others Then
          v_Err_Msg := '序号' || 号序_In || '已被其它人使用,请重新选择一个序号.';
          Raise Err_Item;
      End;
      v_号序 := 号序_In;
    Else
      v_号序 := Null;
    End If;
  End If;

  --更新门诊费用记录
  Update 门诊费用记录
  Set 记录状态 = 1, 实际票号 = Decode(Nvl(记帐费用_In, 0), 1, Null, 票据号_In), 结帐id = Decode(Nvl(记帐费用_In, 0), 1, Null, 结帐id_In),
      结帐金额 = Decode(Nvl(记帐费用_In, 0), 1, Null, 实收金额), 发药窗口 = 诊室_In, 病人id = 病人id_In, 标识号 = 门诊号_In, 姓名 = 姓名_In, 年龄 = 年龄_In,
      性别 = 性别_In, 付款方式 = 付款方式_In, 费别 = 费别_In, 发生时间 = d_发生时间, 登记时间 = d_Date, 操作员编号 = 操作员编号_In, 操作员姓名 = 操作员姓名_In,
      缴款组id = n_组id, 记帐费用 = Decode(Nvl(记帐费用_In, 0), 1, 1, 0), 摘要 = Nvl(摘要_In, 摘要)
  Where 记录性质 = 4 And 记录状态 = 0 And NO = No_In;

  --病人挂号记录
  Update 病人挂号记录
  Set 接收人 = 操作员姓名_In, 接收时间 = d_Date, 记录性质 = 1, 病人id = 病人id_In, 门诊号 = 门诊号_In, 发生时间 = d_发生时间, 姓名 = 姓名_In, 性别 = 性别_In,
      年龄 = 年龄_In, 操作员编号 = 操作员编号_In, 操作员姓名 = 操作员姓名_In, 险类 = Decode(Nvl(险类_In, 0), 0, Null, 险类_In), 号序 = v_号序, 诊室 = 诊室_In,
      摘要 = Nvl(摘要_In, 摘要)
  Where 记录状态 = 1 And NO = No_In And 记录性质 = 2
  Returning ID Into n_挂号id;
  If Sql%NotFound Then
    Begin
      Select 病人挂号记录_Id.Nextval Into n_挂号id From Dual;
      Begin
        Select 名称 Into v_付款方式 From 医疗付款方式 Where 编码 = 付款方式_In And Rownum < 2;
      Exception
        When Others Then
          v_付款方式 := Null;
      End;
      Insert Into 病人挂号记录
        (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 操作员编号, 操作员姓名,
         摘要, 号序, 预约, 预约方式, 接收人, 接收时间, 预约时间, 险类, 医疗付款方式)
        Select n_挂号id, No_In, 1, 1, 病人id_In, 门诊号_In, 姓名_In, 性别_In, 年龄_In, 计算单位, 加班标志, 诊室_In, Null, 执行部门id, 执行人, 0, Null,
               登记时间, 发生时间, 操作员编号, 操作员姓名, Nvl(摘要_In, 摘要), v_号序, 1, Substr(结论, 1, 10) As 预约方式, 操作员姓名_In,
               Nvl(登记时间_In, Sysdate), 发生时间, Decode(Nvl(险类_In, 0), 0, Null, 险类_In), v_付款方式
        From 门诊费用记录
        Where 记录性质 = 4 And 记录状态 = 1 And Rownum = 1 And NO = No_In;
    Exception
      When Others Then
        v_Err_Msg := '由于并发原因,单据号为【' || No_In || '】的病人' || 姓名_In || '已经被接收';
        Raise Err_Item;
    End;
  End If;

  --0-不产生队列;1-按医生或分诊台排队;2-先分诊,后医生站
  If Nvl(生成队列_In, 0) <> 0 Then
    n_分诊台签到排队 := Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113));
    If Nvl(n_分诊台签到排队, 0) = 0 Then
      For v_挂号 In (Select ID, 姓名, 诊室, 执行人, 执行部门id, 发生时间, 号别, 号序 From 病人挂号记录 Where NO = No_In) Loop
      
        Begin
          Select 1,
                 Case
                   When 排队时间 < Trunc(Sysdate) Then
                    1
                   Else
                    0
                 End
          Into n_排队, n_当天排队
          From 排队叫号队列
          Where 业务类型 = 0 And 业务id = v_挂号.Id And Rownum <= 1;
        Exception
          When Others Then
            n_排队 := 0;
        End;
        If n_排队 = 0 Then
          --产生队列
          --按”执行部门”产生队列
          n_挂号id   := v_挂号.Id;
          v_队列名称 := v_挂号.执行部门id;
          v_排队号码 := Zlgetnextqueue(v_挂号.执行部门id, n_挂号id, v_挂号.号别 || '|' || v_挂号.号序);
          v_排队序号 := Zlgetsequencenum(0, n_挂号id, 0);
        
          --挂号id_In,号码_In,号序_In,缺省日期_In,扩展_In(暂无用)
          d_排队时间 := Zl_Get_Queuedate(n_挂号id, v_挂号.号别, v_挂号.号序, v_挂号.发生时间);
          --   队列名称_In , 业务类型_In, 业务id_In,科室id_In,排队号码_In,排队标记_In,患者姓名_In,病人ID_IN, 诊室_In, 医生姓名_In,
          Zl_排队叫号队列_Insert(v_队列名称, 0, n_挂号id, v_挂号.执行部门id, v_排队号码, Null, 姓名_In, 病人id_In, v_挂号.诊室, v_挂号.执行人, d_排队时间,
                           v_预约方式, Null, v_排队序号);
        Elsif Nvl(n_当天排队, 0) = 1 Then
          --更新队列号
          v_排队号码 := Zlgetnextqueue(v_挂号.执行部门id, v_挂号.Id, v_挂号.号别 || '|' || Nvl(v_挂号.号序, 0));
          v_排队序号 := Zlgetsequencenum(0, v_挂号.Id, 1);
          --新队列名称_IN, 业务类型_In, 业务id_In , 科室id_In , 患者姓名_In , 诊室_In, 医生姓名_In ,排队号码_In
          Zl_排队叫号队列_Update(v_挂号.执行部门id, 0, v_挂号.Id, v_挂号.执行部门id, v_挂号.姓名, v_挂号.诊室, v_挂号.执行人, v_排队号码, v_排队序号);
        
        Else
          --新队列名称_IN, 业务类型_In, 业务id_In , 科室id_In , 患者姓名_In , 诊室_In, 医生姓名_In ,排队号码_In
          Zl_排队叫号队列_Update(v_挂号.执行部门id, 0, v_挂号.Id, v_挂号.执行部门id, v_挂号.姓名, v_挂号.诊室, v_挂号.执行人);
        End If;
        --预约接收时，改变记录标志
        Update 病人挂号记录 Set 记录标志 = 1 Where ID = n_挂号id;
      End Loop;
    End If;
  End If;

  --汇总结算到病人预交记录
  If (Nvl(现金支付_In, 0) <> 0 Or (Nvl(现金支付_In, 0) = 0 And Nvl(个帐支付_In, 0) = 0 And Nvl(预交支付_In, 0) = 0)) And
     Nvl(记帐费用_In, 0) = 0 Then
    Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
    Insert Into 病人预交记录
      (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 结算序号,
       结算性质)
    Values
      (n_预交id, 4, 1, No_In, 病人id_In, Nvl(结算方式_In, v_现金), Nvl(现金支付_In, 0), d_Date, 操作员编号_In, 操作员姓名_In, 结帐id_In, '挂号收费',
       n_组id, 卡类别id_In, 结算卡序号_In, 卡号_In, 交易流水号_In, 交易说明_In, 结帐id_In, 4);
  
    If Nvl(结算卡序号_In, 0) <> 0 And Nvl(现金支付_In, 0) <> 0 Then
    
      n_消费卡id := Null;
      Begin
        Select Nvl(自制卡, 0), 1 Into n_自制卡, n_Count From 卡消费接口目录 Where 编号 = 结算卡序号_In;
      Exception
        When Others Then
          n_Count := 0;
      End;
      If n_Count = 0 Then
        v_Err_Msg := '[ZLSOFT]没有发现原结算卡的相应类别,不能继续操作！[ZLSOFT]';
        Raise Err_Item;
      End If;
      If n_自制卡 = 1 Then
        Select ID
        Into n_消费卡id
        From 消费卡目录
        Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In And
              序号 = (Select Max(序号) From 消费卡目录 Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In);
      End If;
      Zl_病人卡结算记录_Insert(结算卡序号_In, n_消费卡id, 结算方式_In, 现金支付_In, 卡号_In, Null, 登记时间_In, Null, 结帐id_In, n_预交id);
    End If;
  
  End If;

  --对于就诊卡通过预交金挂号
  If Nvl(预交支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 Then
    n_预交金额 := 预交支付_In;
    For r_Deposit In c_Deposit(病人id_In, v_冲预交病人ids) Loop
      n_当前金额 := Case
                  When r_Deposit.金额 - n_预交金额 < 0 Then
                   r_Deposit.金额
                  Else
                   n_预交金额
                End;
      If r_Deposit.结帐id = 0 Then
        --第一次冲预交(填上结帐ID,金额为0)
        Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 4 Where ID = r_Deposit.原预交id;
      End If;
      --冲上次剩余额
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
         结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 预交类别, 结算序号, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 登记时间_In,
               操作员姓名_In, 操作员编号_In, n_当前金额, 结帐id_In, n_组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 预交类别, 结帐id_In, 4
        From 病人预交记录
        Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
    
      --更新病人预交余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_当前金额
      Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = Nvl(1, 2)
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (r_Deposit.病人id, Nvl(1, 2), -1 * n_当前金额, 1);
        n_返回值 := -1 * n_当前金额;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Deposit.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      --检查是否已经处理完
      If r_Deposit.金额 < n_预交金额 Then
        n_预交金额 := n_预交金额 - r_Deposit.金额;
      Else
        n_预交金额 := 0;
      End If;
    
      If n_预交金额 = 0 Then
        Exit;
      End If;
    End Loop;
  End If;

  --对于医保挂号
  If Nvl(个帐支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 Then
    Insert Into 病人预交记录
      (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
       预交类别, 结算序号, 结算性质)
    Values
      (病人预交记录_Id.Nextval, 4, 1, No_In, 病人id_In, v_个人帐户, 个帐支付_In, d_Date, 操作员编号_In, 操作员姓名_In, 结帐id_In, '医保挂号', n_组id,
       Null, Null, Null, Null, Null, Null, Null, 结帐id_In, 4);
  End If;

  --相关汇总表的处理
  --人员缴款余额
  If Nvl(现金支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 And Nvl(更新交款余额_In, 0) = 0 Then
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + 现金支付_In
    Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = Nvl(结算方式_In, v_现金)
    Returning 余额 Into n_返回值;
  
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额
        (收款员, 结算方式, 性质, 余额)
      Values
        (操作员姓名_In, Nvl(结算方式_In, v_现金), 1, 现金支付_In);
      n_返回值 := 现金支付_In;
    
    End If;
    If Nvl(n_返回值, 0) = 0 Then
      Delete From 人员缴款余额
      Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = Nvl(结算方式_In, v_现金) And Nvl(余额, 0) = 0;
    End If;
  End If;

  If Nvl(个帐支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 And Nvl(更新交款余额_In, 0) = 0 Then
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + 个帐支付_In
    Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = v_个人帐户
    Returning 余额 Into n_返回值;
  
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额 (收款员, 结算方式, 性质, 余额) Values (操作员姓名_In, v_个人帐户, 1, 个帐支付_In);
      n_返回值 := 个帐支付_In;
    End If;
    If Nvl(n_返回值, 0) = 0 Then
      Delete From 人员缴款余额 Where 收款员 = 操作员姓名_In And 性质 = 1 And Nvl(余额, 0) = 0;
    End If;
  End If;

  --处理票据使用情况
  If 票据号_In Is Not Null And Nvl(记帐费用_In, 0) = 0 Then
    Select 票据打印内容_Id.Nextval Into n_打印id From Dual;
  
    --当前票据的票种
    Select 票种 Into n_票种 From 票据领用记录 Where ID = Nvl(领用id_In, 0);
    --发出票据
    Insert Into 票据打印内容 (ID, 数据性质, NO) Values (n_打印id, 4, No_In);
  
    Insert Into 票据使用明细
      (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
    Values
      (票据使用明细_Id.Nextval, n_票种, 票据号_In, 1, 1, 领用id_In, n_打印id, d_Date, 操作员姓名_In);
  
    --状态改动
    Update 票据领用记录
    Set 当前号码 = 票据号_In, 剩余数量 = Decode(Sign(剩余数量 - 1), -1, 0, 剩余数量 - 1), 使用时间 = d_Date
    Where ID = Nvl(领用id_In, 0);
  End If;

  If Nvl(记帐费用_In, 0) = 1 Then
    --记帐
    If Nvl(病人id_In, 0) = 0 Then
      v_Err_Msg := '要针对病人的挂号费进行记帐，必须是建档病人才能记帐挂号。';
      Raise Err_Item;
    End If;
    For c_费用 In (Select 实收金额, 病人科室id, 开单部门id, 执行部门id, 收入项目id
                 From 门诊费用记录
                 Where 记录性质 = 4 And 记录状态 = 1 And NO = No_In And Nvl(记帐费用, 0) = 1) Loop
      --病人余额
      Update 病人余额
      Set 费用余额 = Nvl(费用余额, 0) + Nvl(c_费用.实收金额, 0)
      Where 病人id = Nvl(病人id_In, 0) And 性质 = 1 And 类型 = 1;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 性质, 类型, 费用余额, 预交余额)
        Values
          (病人id_In, 1, 1, Nvl(c_费用.实收金额, 0), 0);
      End If;
    
      --病人未结费用
      Update 病人未结费用
      Set 金额 = Nvl(金额, 0) + Nvl(c_费用.实收金额, 0)
      Where 病人id = 病人id_In And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And Nvl(病人科室id, 0) = Nvl(c_费用.病人科室id, 0) And
            Nvl(开单部门id, 0) = Nvl(c_费用.开单部门id, 0) And Nvl(执行部门id, 0) = Nvl(c_费用.执行部门id, 0) And 收入项目id + 0 = c_费用.收入项目id And
            来源途径 + 0 = 1;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人未结费用
          (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
        Values
          (病人id_In, Null, Null, c_费用.病人科室id, c_费用.开单部门id, c_费用.执行部门id, c_费用.收入项目id, 1, Nvl(c_费用.实收金额, 0));
      End If;
    End Loop;
  End If;
  If Nvl(病人id_In, 0) <> 0 Then
    n_结算模式 := 0;
    Update 病人信息
    Set 就诊时间 = d_发生时间, 就诊状态 = 1, 就诊诊室 = 诊室_In
    Where 病人id = 病人id_In
    Returning Nvl(结算模式, 0) Into n_结算模式;
    --取参数:
    If Nvl(n_结算模式, 0) <> Nvl(结算模式_In, 0) Then
      --结算模式的确定
      If n_结算模式 = 1 And Nvl(结算模式_In, 0) = 0 Then
        --病人已经是"先诊疗后结算的",本次是"先结算后诊疗的",则检查是否存在未结数据
        Select Count(1)
        Into n_Count
        From 病人未结费用
        Where 病人id = 病人id_In And (来源途径 In (1, 4) Or 来源途径 = 3 And Nvl(主页id, 0) = 0) And Nvl(金额, 0) <> 0 And Rownum < 2;
        If Nvl(n_Count, 0) <> 0 Then
          --存在未结算数据，必须先结算后才允许执行
          v_Err_Msg := '当前病人的就诊模式为先诊疗后结算且存在未结费用，不允许调整该病人的就诊模式,你可以先对未结费用结帐后再挂号或不调整病人的就诊模式!';
          Raise Err_Item;
        End If;
        --检查
        --未发生医嘱业务的（即当时就挂号的,需要保证同一次的就诊模式是一至的(程序已经检查，不用再处理)
      End If;
      Update 病人信息 Set 结算模式 = 结算模式_In Where 病人id = 病人id_In;
    End If;
  End If;

  --病人担保信息
  If 病人id_In Is Not Null Then
    Update 病人信息
    Set 担保人 = Null, 担保额 = Null, 担保性质 = Null
    Where 病人id = 病人id_In And Nvl(在院, 0) = 0 And Exists
     (Select 1
           From 病人担保记录
           Where 病人id = 病人id_In And 主页id Is Not Null And
                 登记时间 = (Select Max(登记时间) From 病人担保记录 Where 病人id = 病人id_In));
    If Sql%RowCount > 0 Then
      Update 病人担保记录
      Set 到期时间 = d_Date
      Where 病人id = 病人id_In And 主页id Is Not Null And Nvl(到期时间, d_Date) >= d_Date;
    End If;
  End If;
  --消息推送
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 1, n_挂号id;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Err_Special Then
    Raise_Application_Error(-20105, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_预约挂号接收_Insert;
/

--106872:刘尔旋,2017-04-12,预约接收保存摘要
Create Or Replace Procedure Zl_预约挂号接收_出诊_Insert
(
  No_In            门诊费用记录.No%Type,
  票据号_In        门诊费用记录.实际票号%Type,
  领用id_In        票据使用明细.领用id%Type,
  结帐id_In        门诊费用记录.结帐id%Type,
  诊室_In          门诊费用记录.发药窗口%Type,
  病人id_In        门诊费用记录.病人id%Type,
  门诊号_In        门诊费用记录.标识号%Type,
  姓名_In          门诊费用记录.姓名%Type,
  性别_In          门诊费用记录.性别%Type,
  年龄_In          门诊费用记录.年龄%Type,
  付款方式_In      门诊费用记录.付款方式%Type, --用于存放病人的医疗付款方式编号
  费别_In          门诊费用记录.费别%Type,
  结算方式_In      Varchar2, --现金的结算名称
  现金支付_In      病人预交记录.冲预交%Type, --挂号时现金支付部份金额
  预交支付_In      病人预交记录.冲预交%Type, --挂号时使用的预交金额
  个帐支付_In      病人预交记录.冲预交%Type, --挂号时个人帐户支付金额
  发生时间_In      门诊费用记录.发生时间%Type,
  号序_In          挂号序号状态.序号%Type,
  操作员编号_In    门诊费用记录.操作员编号%Type,
  操作员姓名_In    门诊费用记录.操作员姓名%Type,
  生成队列_In      Number := 0,
  登记时间_In      门诊费用记录.登记时间%Type := Null,
  卡类别id_In      病人预交记录.卡类别id%Type := Null,
  结算卡序号_In    病人预交记录.结算卡序号%Type := Null,
  卡号_In          病人预交记录.卡号%Type := Null,
  交易流水号_In    病人预交记录.交易流水号%Type := Null,
  交易说明_In      病人预交记录.交易说明%Type := Null,
  险类_In          病人挂号记录.险类%Type := Null,
  结算模式_In      Number := 0,
  记帐费用_In      Number := 0,
  冲预交病人ids_In Varchar2 := Null,
  三方调用_In      Number := 0,
  更新交款余额_In  Number := 0, --是否更新人员交款余额，主要是处理统一操作员登录多台自助机的情况
  摘要_In          病人挂号记录.摘要%Type := Null
) As
  --该游标用于收费冲预交的可用预交列表
  --以ID排序，优先冲上次未冲完的。
  Cursor c_Deposit
  (
    v_病人id        病人信息.病人id%Type,
    v_冲预交病人ids Varchar2
  ) Is
    Select 病人id, NO, Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) As 金额, Min(记录状态) As 记录状态, Nvl(Max(结帐id), 0) As 结帐id,
           Max(Decode(记录性质, 1, ID, 0) * Decode(记录状态, 2, 0, 1)) As 原预交id
    From 病人预交记录
    Where 记录性质 In (1, 11) And 病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And Nvl(预交类别, 2) = 1
     Having Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) <> 0
    Group By NO, 病人id
    Order By Decode(病人id, Nvl(v_病人id, 0), 0, 1), 结帐id, NO;

  v_Err_Msg Varchar2(255);
  Err_Item    Exception;
  Err_Special Exception;
  v_操作员姓名 病人挂号记录.接收人%Type;
  v_现金       结算方式.名称%Type;
  v_个人帐户   结算方式.名称%Type;
  v_队列名称   排队叫号队列.队列名称%Type;
  v_号别       门诊费用记录.计算单位%Type;
  v_号序       门诊费用记录.发药窗口%Type;
  v_排队号码   排队叫号队列.排队号码 %Type;
  v_预约方式   病人挂号记录.预约方式 %Type;

  n_打印id        票据打印内容.Id%Type;
  n_预交金额      病人预交记录.金额%Type;
  n_返回值        病人预交记录.金额%Type;
  v_冲预交病人ids Varchar2(4000);

  n_挂号id         病人挂号记录.Id%Type;
  n_分诊台签到排队 Number;
  n_组id           财务缴款分组.Id%Type;
  n_Count          Number(18);
  n_排队           Number;
  n_当天排队       Number;
  n_当前金额       病人预交记录.金额%Type;
  n_预交id         病人预交记录.Id%Type;
  n_消费卡id       消费卡目录.Id%Type;
  n_自制卡         Number;

  d_Date         Date;
  d_预约时间     门诊费用记录.发生时间%Type;
  d_发生时间     Date;
  d_排队时间     Date;
  n_时段         Number := 0;
  n_存在         Number := 0;
  v_结算内容     Varchar2(2000);
  v_当前结算     Varchar2(500);
  n_结算金额     病人预交记录.冲预交%Type;
  v_结算号码     病人预交记录.结算号码%Type;
  v_结算方式     病人预交记录.结算方式%Type;
  n_三方卡标志   Number(3);
  v_排队序号     排队叫号队列.排队序号%Type;
  n_结算模式     病人信息.结算模式%Type;
  n_票种         票据使用明细.票种%Type;
  v_付款方式     病人挂号记录.医疗付款方式%Type;
  n_接收模式     Number := 0;
  n_出诊记录id   病人挂号记录.出诊记录id%Type;
  n_新出诊记录id 病人挂号记录.出诊记录id%Type;
  n_号源id       临床出诊记录.号源id%Type;
  n_预约顺序号   临床出诊序号控制.预约顺序号%Type;
  n_旧分时段     临床出诊记录.是否分时段%Type;
  n_旧序号控制   临床出诊记录.是否序号控制%Type;
  n_旧科室id     临床出诊记录.科室id%Type;
  n_旧项目id     临床出诊记录.项目id%Type;
  n_旧医生id     临床出诊记录.医生id%Type;
  n_挂号模式     Number(3);
  d_启用时间     Date;
  v_Paratemp     Varchar2(500);
  v_Registtemp   Varchar2(500);
  n_检查         Number(3);
  n_序号控制     临床出诊记录.是否序号控制%Type;
  v_旧上班时段   临床出诊记录.上班时段%Type;
Begin
  n_组id          := Zl_Get组id(操作员姓名_In);
  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);
  v_Paratemp      := Nvl(zl_GetSysParameter('挂号排班模式'), 0);
  n_接收模式      := Nvl(zl_GetSysParameter('预约接收模式', 1111), 0);
  n_挂号模式      := To_Number(Substr(v_Paratemp, 1, 1));
  If n_挂号模式 = 1 Then
    Begin
      d_启用时间 := To_Date(Substr(v_Paratemp, 3), 'yyyy-mm-dd hh24:mi:ss');
    Exception
      When Others Then
        d_启用时间 := Null;
    End;
  End If;

  --获取结算方式名称
  Begin
    Select 名称 Into v_现金 From 结算方式 Where 性质 = 1;
  Exception
    When Others Then
      v_现金 := '现金';
  End;
  Begin
    Select 名称 Into v_个人帐户 From 结算方式 Where 性质 = 3;
  Exception
    When Others Then
      v_个人帐户 := '个人帐户';
  End;
  If 登记时间_In Is Null Then
    Select Sysdate Into d_Date From Dual;
  Else
    d_Date := 登记时间_In;
  End If;

  --更新挂号序号状态
  Begin
    Select 号别, 号序, Trunc(发生时间), 发生时间, 预约方式, 出诊记录id
    Into v_号别, v_号序, d_预约时间, d_发生时间, v_预约方式, n_出诊记录id
    From 病人挂号记录
    Where 记录性质 = 2 And 记录状态 = 1 And Rownum = 1 And NO = No_In;
  Exception
    When Others Then
      Select Max(接收人) Into v_操作员姓名 From 病人挂号记录 Where 记录性质 = 2 And 记录状态 In (1, 3) And NO = No_In;
      If v_操作员姓名 Is Null Then
        v_Err_Msg := '当前预约挂号单已被取消';
        Raise Err_Item;
      Else
        If v_操作员姓名 = 操作员姓名_In Then
          v_Err_Msg := '当前预约挂号单已被接收';
          Raise Err_Special;
        Else
          v_Err_Msg := '当前预约挂号单已被其它人接收';
          Raise Err_Item;
        End If;
      End If;
  End;

  --判断是否分时段
  Select Nvl(是否分时段, 0), 号源id, Nvl(是否序号控制, 0)
  Into n_时段, n_号源id, n_序号控制
  From 临床出诊记录
  Where ID = n_出诊记录id;

  If n_时段 = 1 And 三方调用_In = 0 And n_接收模式 = 0 Then
    If Trunc(发生时间_In) <> Trunc(Sysdate) Then
      v_Err_Msg := '分时段的预约挂号单只能当天接收！';
      Raise Err_Item;
    End If;
  End If;

  If n_时段 = 0 And 三方调用_In = 0 Then
    If n_接收模式 = 0 Then
      If Trunc(发生时间_In) = Trunc(Sysdate) Then
        d_发生时间 := 发生时间_In;
      Else
        d_发生时间 := Sysdate;
      End If;
    Else
      d_发生时间 := 发生时间_In;
    End If;
  Else
    If Not 发生时间_In Is Null Then
      d_发生时间 := 发生时间_In;
    End If;
  End If;

  If d_启用时间 Is Not Null Then
    If d_发生时间 < d_启用时间 Then
      v_Err_Msg := '当前预约挂号单属于出诊表排班模式安排，不能在' || To_Char(d_启用时间, 'yyyy-mm-dd hh24:mi:ss') || '之前接收!';
      Raise Err_Item;
    End If;
  End If;

  If Not v_号序 Is Null Then
    If 号序_In Is Null Then
      Update 临床出诊序号控制 Set 挂号状态 = 0 Where (序号 = v_号序 Or 备注 = v_号序) And 记录id = n_出诊记录id;
    Else
      If Trunc(d_预约时间) <> Trunc(Sysdate) And n_接收模式 = 0 Then
        If n_时段 = 0 And 三方调用_In = 0 Then
          --提前接收或延迟接收
          Update 临床出诊序号控制 Set 挂号状态 = 0 Where 序号 = v_号序 And 记录id = n_出诊记录id;
        
          Select 是否分时段, 是否序号控制, 科室id, 医生id, 项目id, 上班时段
          Into n_旧分时段, n_旧序号控制, n_旧科室id, n_旧医生id, n_旧项目id, v_旧上班时段
          From 临床出诊记录
          Where ID = n_出诊记录id;
          Begin
            Select ID
            Into n_新出诊记录id
            From 临床出诊记录
            Where 号源id = n_号源id And 是否分时段 = n_旧分时段 And 是否序号控制 = n_旧序号控制 And 科室id = n_旧科室id And
                  Nvl(医生id, 0) = Nvl(n_旧医生id, 0) And 上班时段 = v_旧上班时段 And Nvl(是否发布, 0) = 1 And 出诊日期 = Trunc(Sysdate) And
                  Rownum < 2;
          Exception
            When Others Then
              v_Err_Msg := '接收当天没有对应的出诊安排,无法接收!';
              Raise Err_Item;
          End;
        
          Begin
            Select 1
            Into n_存在
            From 临床出诊序号控制
            Where 记录id = n_新出诊记录id And 序号 = v_号序 And Nvl(挂号状态, 0) = 0;
          Exception
            When Others Then
              n_存在 := 0;
          End;
        
          If n_存在 = 1 Then
            Update 临床出诊序号控制
            Set 挂号状态 = 1, 操作员姓名 = 操作员姓名_In
            Where 记录id = n_新出诊记录id And 序号 = v_号序 And Nvl(挂号状态, 0) = 0;
          Else
            --号码已被使用的情况
            Select Min(序号) Into v_号序 From 临床出诊序号控制 Where 记录id = n_新出诊记录id And Nvl(挂号状态, 0) = 0;
            If v_号序 Is Null Then
              v_Err_Msg := '接收当天没有可用序号,无法接收!';
              Raise Err_Item;
            End If;
            Update 临床出诊序号控制
            Set 挂号状态 = 1, 操作员姓名 = 操作员姓名_In
            Where 记录id = n_新出诊记录id And 序号 = v_号序 And Nvl(挂号状态, 0) = 0;
          End If;
        Else
          Select 是否分时段, 是否序号控制, 科室id, 医生id, 项目id, 上班时段
          Into n_旧分时段, n_旧序号控制, n_旧科室id, n_旧医生id, n_旧项目id, v_旧上班时段
          From 临床出诊记录
          Where ID = n_出诊记录id;
          Begin
            Select ID
            Into n_新出诊记录id
            From 临床出诊记录
            Where 号源id = n_号源id And 是否分时段 = n_旧分时段 And 是否序号控制 = n_旧序号控制 And 科室id = n_旧科室id And
                  Nvl(医生id, 0) = Nvl(n_旧医生id, 0) And 上班时段 = v_旧上班时段 And Nvl(是否发布, 0) = 1 And 出诊日期 = Trunc(Sysdate) And
                  Rownum < 2;
          Exception
            When Others Then
              v_Err_Msg := '接收当天没有对应的出诊安排,无法接收!';
              Raise Err_Item;
          End;
          Update 临床出诊序号控制
          Set 挂号状态 = 0, 操作员姓名 = 操作员姓名_In
          Where (序号 = v_号序 Or 备注 = v_号序) And 记录id = n_出诊记录id And Nvl(挂号状态, 0) = 2
          Returning 预约顺序号 Into n_预约顺序号;
        
          Update 临床出诊序号控制
          Set 挂号状态 = 1, 操作员姓名 = 操作员姓名_In, 预约顺序号 = n_预约顺序号
          Where 序号 = v_号序 And 记录id = n_新出诊记录id And Nvl(挂号状态, 0) = 0;
          If Sql% RowCount = 0 Then
            v_Err_Msg := '接收当天序号' || v_号序 || '已被其它人使用,无法接收.';
            Raise Err_Item;
          End If;
        End If;
      Else
        Update 临床出诊序号控制
        Set 挂号状态 = 1, 操作员姓名 = 操作员姓名_In
        Where (序号 = v_号序 Or 备注 = v_号序) And 记录id = n_出诊记录id;
        If Sql%RowCount = 0 Then
          v_Err_Msg := '序号' || v_号序 || '已被其它人使用,请重新选择一个序号.';
          Raise Err_Item;
        End If;
      End If;
    End If;
  Else
    If Not 号序_In Is Null Then
      If Trunc(d_预约时间) <> Trunc(Sysdate) And n_接收模式 = 0 Then
        Select 是否分时段, 是否序号控制, 科室id, 医生id, 项目id, 上班时段
        Into n_旧分时段, n_旧序号控制, n_旧科室id, n_旧医生id, n_旧项目id, v_旧上班时段
        From 临床出诊记录
        Where ID = n_出诊记录id;
        Begin
          Select ID
          Into n_新出诊记录id
          From 临床出诊记录
          Where 号源id = n_号源id And 是否分时段 = n_旧分时段 And 是否序号控制 = n_旧序号控制 And 科室id = n_旧科室id And
                Nvl(医生id, 0) = Nvl(n_旧医生id, 0) And 上班时段 = v_旧上班时段 And Nvl(是否发布, 0) = 1 And 出诊日期 = Trunc(Sysdate) And
                Rownum < 2;
        Exception
          When Others Then
            v_Err_Msg := '接收当天没有对应的出诊安排,无法接收!';
            Raise Err_Item;
        End;
        Update 临床出诊序号控制
        Set 挂号状态 = 0, 操作员姓名 = 操作员姓名_In
        Where (序号 = 号序_In Or 备注 = 号序_In) And 记录id = n_出诊记录id And Nvl(挂号状态, 0) = 2
        Returning 预约顺序号 Into n_预约顺序号;
        Update 临床出诊序号控制
        Set 挂号状态 = 1, 操作员姓名 = 操作员姓名_In, 预约顺序号 = n_预约顺序号
        Where 序号 = 号序_In And 记录id = n_新出诊记录id And Nvl(挂号状态, 0) = 0;
        If Sql%RowCount = 0 Then
          v_Err_Msg := '接收当天序号' || 号序_In || '已被其它人使用,无法接收.';
          Raise Err_Item;
        End If;
      Else
        Update 临床出诊序号控制
        Set 挂号状态 = 1, 操作员姓名 = 操作员姓名_In
        Where (序号 = 号序_In Or 备注 = 号序_In) And 记录id = n_出诊记录id;
      
      End If;
      v_号序 := 号序_In;
    Else
      v_号序 := Null;
    End If;
  End If;

  --更新门诊费用记录
  Update 门诊费用记录
  Set 记录状态 = 1, 实际票号 = Decode(Nvl(记帐费用_In, 0), 1, Null, 票据号_In), 结帐id = Decode(Nvl(记帐费用_In, 0), 1, Null, 结帐id_In),
      结帐金额 = Decode(Nvl(记帐费用_In, 0), 1, Null, 实收金额), 发药窗口 = 诊室_In, 病人id = 病人id_In, 标识号 = 门诊号_In, 姓名 = 姓名_In, 年龄 = 年龄_In,
      性别 = 性别_In, 付款方式 = 付款方式_In, 费别 = 费别_In, 发生时间 = d_发生时间, 登记时间 = d_Date, 操作员编号 = 操作员编号_In, 操作员姓名 = 操作员姓名_In,
      缴款组id = n_组id, 记帐费用 = Decode(Nvl(记帐费用_In, 0), 1, 1, 0), 摘要 = Nvl(摘要_In, 摘要)
  Where 记录性质 = 4 And 记录状态 = 0 And NO = No_In;

  v_Registtemp := zl_GetSysParameter('挂号排班模式');
  If Substr(v_Registtemp, 1, 1) = 1 Then
    Begin
      If To_Date(Substr(v_Registtemp, 3), 'yyyy-mm-dd hh24:mi:ss') > d_发生时间 Then
        v_Err_Msg := '接收时间' || To_Char(d_发生时间, 'yyyy-mm-dd hh24:mi:ss') || '未启用出诊表排班模式,目前无法接收!';
        Raise Err_Item;
      End If;
    Exception
      When Others Then
        Null;
    End;
    Begin
      Select 1
      Into n_检查
      From 临床出诊记录
      Where ID = Nvl(n_新出诊记录id, n_出诊记录id) And d_发生时间 Between 停诊开始时间 And 停诊终止时间;
    Exception
      When Others Then
        n_检查 := 0;
    End;
    If n_检查 = 1 And Not (n_时段 = 1 And n_序号控制 = 1) Then
      v_Err_Msg := '接收时间' || To_Char(d_发生时间, 'yyyy-mm-dd hh24:mi:ss') || '的安排已经被停诊,无法接收!';
      Raise Err_Item;
    End If;
  End If;

  --病人挂号记录
  Update 病人挂号记录
  Set 接收人 = 操作员姓名_In, 接收时间 = d_Date, 记录性质 = 1, 病人id = 病人id_In, 门诊号 = 门诊号_In, 发生时间 = d_发生时间, 姓名 = 姓名_In, 性别 = 性别_In,
      年龄 = 年龄_In, 操作员编号 = 操作员编号_In, 操作员姓名 = 操作员姓名_In, 险类 = Decode(Nvl(险类_In, 0), 0, Null, 险类_In), 号序 = v_号序, 诊室 = 诊室_In,
      出诊记录id = Nvl(n_新出诊记录id, n_出诊记录id), 摘要 = Nvl(摘要_In, 摘要)
  Where 记录状态 = 1 And NO = No_In And 记录性质 = 2
  Returning ID Into n_挂号id;
  If Sql%NotFound Then
    Begin
      Select 病人挂号记录_Id.Nextval Into n_挂号id From Dual;
      Begin
        Select 名称 Into v_付款方式 From 医疗付款方式 Where 编码 = 付款方式_In And Rownum < 2;
      Exception
        When Others Then
          v_付款方式 := Null;
      End;
      Insert Into 病人挂号记录
        (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 操作员编号, 操作员姓名,
         摘要, 号序, 预约, 预约方式, 接收人, 接收时间, 预约时间, 险类, 医疗付款方式, 出诊记录id)
        Select n_挂号id, No_In, 1, 1, 病人id_In, 门诊号_In, 姓名_In, 性别_In, 年龄_In, 计算单位, 加班标志, 诊室_In, Null, 执行部门id, 执行人, 0, Null,
               登记时间, 发生时间, 操作员编号, 操作员姓名, Nvl(摘要_In, 摘要), v_号序, 1, Substr(结论, 1, 10) As 预约方式, 操作员姓名_In,
               Nvl(登记时间_In, Sysdate), 发生时间, Decode(Nvl(险类_In, 0), 0, Null, 险类_In), v_付款方式, Nvl(n_新出诊记录id, n_出诊记录id)
        From 门诊费用记录
        Where 记录性质 = 4 And 记录状态 = 1 And Rownum = 1 And NO = No_In;
    Exception
      When Others Then
        v_Err_Msg := '由于并发原因,单据号为【' || No_In || '】的病人' || 姓名_In || '已经被接收';
        Raise Err_Item;
    End;
  End If;

  --0-不产生队列;1-按医生或分诊台排队;2-先分诊,后医生站
  If Nvl(生成队列_In, 0) <> 0 Then
    n_分诊台签到排队 := Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113));
    If Nvl(n_分诊台签到排队, 0) = 0 Then
      For v_挂号 In (Select ID, 姓名, 诊室, 执行人, 执行部门id, 发生时间, 号别, 号序 From 病人挂号记录 Where NO = No_In) Loop
      
        Begin
          Select 1,
                 Case
                   When 排队时间 < Trunc(Sysdate) Then
                    1
                   Else
                    0
                 End
          Into n_排队, n_当天排队
          From 排队叫号队列
          Where 业务类型 = 0 And 业务id = v_挂号.Id And Rownum <= 1;
        Exception
          When Others Then
            n_排队 := 0;
        End;
        If n_排队 = 0 Then
          --产生队列
          --按”执行部门”产生队列
          n_挂号id   := v_挂号.Id;
          v_队列名称 := v_挂号.执行部门id;
          v_排队号码 := Zlgetnextqueue(v_挂号.执行部门id, n_挂号id, v_挂号.号别 || '|' || v_挂号.号序);
          v_排队序号 := Zlgetsequencenum(0, n_挂号id, 0);
        
          --挂号id_In,号码_In,号序_In,缺省日期_In,扩展_In(暂无用)
          d_排队时间 := Zl_Get_Queuedate(n_挂号id, v_挂号.号别, v_挂号.号序, v_挂号.发生时间);
          --   队列名称_In , 业务类型_In, 业务id_In,科室id_In,排队号码_In,排队标记_In,患者姓名_In,病人ID_IN, 诊室_In, 医生姓名_In,
          Zl_排队叫号队列_Insert(v_队列名称, 0, n_挂号id, v_挂号.执行部门id, v_排队号码, Null, 姓名_In, 病人id_In, v_挂号.诊室, v_挂号.执行人, d_排队时间,
                           v_预约方式, Null, v_排队序号);
        Elsif Nvl(n_当天排队, 0) = 1 Then
          --更新队列号
          v_排队号码 := Zlgetnextqueue(v_挂号.执行部门id, v_挂号.Id, v_挂号.号别 || '|' || Nvl(v_挂号.号序, 0));
          v_排队序号 := Zlgetsequencenum(0, v_挂号.Id, 1);
          --新队列名称_IN, 业务类型_In, 业务id_In , 科室id_In , 患者姓名_In , 诊室_In, 医生姓名_In ,排队号码_In
          Zl_排队叫号队列_Update(v_挂号.执行部门id, 0, v_挂号.Id, v_挂号.执行部门id, v_挂号.姓名, v_挂号.诊室, v_挂号.执行人, v_排队号码, v_排队序号);
        
        Else
          --新队列名称_IN, 业务类型_In, 业务id_In , 科室id_In , 患者姓名_In , 诊室_In, 医生姓名_In ,排队号码_In
          Zl_排队叫号队列_Update(v_挂号.执行部门id, 0, v_挂号.Id, v_挂号.执行部门id, v_挂号.姓名, v_挂号.诊室, v_挂号.执行人);
        End If;
      End Loop;
    End If;
  End If;

  --汇总结算到病人预交记录
  If Nvl(记帐费用_In, 0) = 0 Then
    If Nvl(现金支付_In, 0) = 0 And Nvl(个帐支付_In, 0) = 0 And Nvl(预交支付_In, 0) = 0 Then
      Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
      Insert Into 病人预交记录
        (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
         结算性质)
      Values
        (n_预交id, 4, 1, No_In, Decode(病人id_In, 0, Null, 病人id_In), v_现金, 0, 登记时间_In, 操作员编号_In, 操作员姓名_In, 结帐id_In, '挂号收费',
         n_组id, 卡类别id_In, 结算卡序号_In, 卡号_In, 交易流水号_In, 交易说明_In, Null, 4);
    End If;
    If Nvl(现金支付_In, 0) <> 0 Then
      v_结算内容 := 结算方式_In || '|'; --以空格分开以|结尾,没有结算号码的
      While v_结算内容 Is Not Null Loop
        v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '|') - 1);
        v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1);
      
        v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
        n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1));
      
        v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
        v_结算号码 := Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1);
      
        v_当前结算   := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
        n_三方卡标志 := To_Number(v_当前结算);
      
        If n_三方卡标志 = 0 Then
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          Insert Into 病人预交记录
            (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明,
             合作单位, 结算性质, 结算号码)
          Values
            (n_预交id, 4, 1, No_In, Decode(病人id_In, 0, Null, 病人id_In), Nvl(v_结算方式, v_现金), Nvl(n_结算金额, 0), 登记时间_In,
             操作员编号_In, 操作员姓名_In, 结帐id_In, '挂号收费', n_组id, Null, Null, Null, Null, Null, Null, 4, v_结算号码);
        Else
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          Insert Into 病人预交记录
            (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明,
             合作单位, 结算性质, 结算号码)
          Values
            (n_预交id, 4, 1, No_In, Decode(病人id_In, 0, Null, 病人id_In), Nvl(v_结算方式, v_现金), Nvl(n_结算金额, 0), 登记时间_In,
             操作员编号_In, 操作员姓名_In, 结帐id_In, '挂号收费', n_组id, 卡类别id_In, 结算卡序号_In, 卡号_In, 交易流水号_In, 交易说明_In, Null, 4, v_结算号码);
          If Nvl(结算卡序号_In, 0) <> 0 Then
            n_消费卡id := Null;
            Begin
              Select Nvl(自制卡, 0), 1 Into n_自制卡, n_Count From 卡消费接口目录 Where 编号 = 结算卡序号_In;
            Exception
              When Others Then
                n_Count := 0;
            End;
            If n_Count = 0 Then
              v_Err_Msg := '没有发现原结算卡的相应类别,不能继续操作！';
              Raise Err_Item;
            End If;
            If n_自制卡 = 1 Then
              Select ID
              Into n_消费卡id
              From 消费卡目录
              Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In And
                    序号 = (Select Max(序号) From 消费卡目录 Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In);
            End If;
            Zl_病人卡结算记录_Insert(结算卡序号_In, n_消费卡id, v_结算方式, n_结算金额, 卡号_In, Null, 登记时间_In, Null, 结帐id_In, n_预交id);
          End If;
        End If;
      
        If Nvl(更新交款余额_In, 0) = 0 Then
          Update 人员缴款余额
          Set 余额 = Nvl(余额, 0) + n_结算金额
          Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = Nvl(v_结算方式, v_现金)
          Returning 余额 Into n_返回值;
        
          If Sql%RowCount = 0 Then
            Insert Into 人员缴款余额
              (收款员, 结算方式, 性质, 余额)
            Values
              (操作员姓名_In, Nvl(v_结算方式, v_现金), 1, n_结算金额);
            n_返回值 := n_结算金额;
          End If;
          If Nvl(n_返回值, 0) = 0 Then
            Delete From 人员缴款余额
            Where 收款员 = 操作员姓名_In And 结算方式 = Nvl(v_结算方式, v_现金) And 性质 = 1 And Nvl(余额, 0) = 0;
          End If;
        End If;
      
        v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '|') + 1);
      End Loop;
    End If;
  End If;

  --对于就诊卡通过预交金挂号
  If Nvl(预交支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 Then
    n_预交金额 := 预交支付_In;
    For r_Deposit In c_Deposit(病人id_In, v_冲预交病人ids) Loop
      n_当前金额 := Case
                  When r_Deposit.金额 - n_预交金额 < 0 Then
                   r_Deposit.金额
                  Else
                   n_预交金额
                End;
      If r_Deposit.结帐id = 0 Then
        --第一次冲预交(填上结帐ID,金额为0)
        Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 4 Where ID = r_Deposit.原预交id;
      End If;
      --冲上次剩余额
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
         结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 预交类别, 结算序号, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 登记时间_In,
               操作员姓名_In, 操作员编号_In, n_当前金额, 结帐id_In, n_组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 预交类别, 结帐id_In, 4
        From 病人预交记录
        Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
    
      --更新病人预交余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_当前金额
      Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = Nvl(1, 2)
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (r_Deposit.病人id, Nvl(1, 2), -1 * n_当前金额, 1);
        n_返回值 := -1 * n_当前金额;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Deposit.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      --检查是否已经处理完
      If r_Deposit.金额 < n_预交金额 Then
        n_预交金额 := n_预交金额 - r_Deposit.金额;
      Else
        n_预交金额 := 0;
      End If;
    
      If n_预交金额 = 0 Then
        Exit;
      End If;
    End Loop;
  End If;

  --对于医保挂号
  If Nvl(个帐支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 Then
    Insert Into 病人预交记录
      (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
       预交类别, 结算序号, 结算性质)
    Values
      (病人预交记录_Id.Nextval, 4, 1, No_In, 病人id_In, v_个人帐户, 个帐支付_In, d_Date, 操作员编号_In, 操作员姓名_In, 结帐id_In, '医保挂号', n_组id,
       Null, Null, Null, Null, Null, Null, Null, 结帐id_In, 4);
  End If;

  --相关汇总表的处理
  --人员缴款余额
  If Nvl(个帐支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 And Nvl(更新交款余额_In, 0) = 0 Then
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + 个帐支付_In
    Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = v_个人帐户
    Returning 余额 Into n_返回值;
  
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额 (收款员, 结算方式, 性质, 余额) Values (操作员姓名_In, v_个人帐户, 1, 个帐支付_In);
      n_返回值 := 个帐支付_In;
    End If;
    If Nvl(n_返回值, 0) = 0 Then
      Delete From 人员缴款余额 Where 收款员 = 操作员姓名_In And 性质 = 1 And Nvl(余额, 0) = 0;
    End If;
  End If;

  --处理票据使用情况
  If 票据号_In Is Not Null And Nvl(记帐费用_In, 0) = 0 Then
    Select 票据打印内容_Id.Nextval Into n_打印id From Dual;
  
    --当前票据的票种
    Select 票种 Into n_票种 From 票据领用记录 Where ID = Nvl(领用id_In, 0);
    --发出票据
    Insert Into 票据打印内容 (ID, 数据性质, NO) Values (n_打印id, 4, No_In);
  
    Insert Into 票据使用明细
      (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
    Values
      (票据使用明细_Id.Nextval, n_票种, 票据号_In, 1, 1, 领用id_In, n_打印id, d_Date, 操作员姓名_In);
  
    --状态改动
    Update 票据领用记录
    Set 当前号码 = 票据号_In, 剩余数量 = Decode(Sign(剩余数量 - 1), -1, 0, 剩余数量 - 1), 使用时间 = d_Date
    Where ID = Nvl(领用id_In, 0);
  End If;

  If Nvl(记帐费用_In, 0) = 1 Then
    --记帐
    If Nvl(病人id_In, 0) = 0 Then
      v_Err_Msg := '要针对病人的挂号费进行记帐，必须是建档病人才能记帐挂号。';
      Raise Err_Item;
    End If;
    For c_费用 In (Select 实收金额, 病人科室id, 开单部门id, 执行部门id, 收入项目id
                 From 门诊费用记录
                 Where 记录性质 = 4 And 记录状态 = 1 And NO = No_In And Nvl(记帐费用, 0) = 1) Loop
      --病人余额
      Update 病人余额
      Set 费用余额 = Nvl(费用余额, 0) + Nvl(c_费用.实收金额, 0)
      Where 病人id = Nvl(病人id_In, 0) And 性质 = 1 And 类型 = 1;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 性质, 类型, 费用余额, 预交余额)
        Values
          (病人id_In, 1, 1, Nvl(c_费用.实收金额, 0), 0);
      End If;
    
      --病人未结费用
      Update 病人未结费用
      Set 金额 = Nvl(金额, 0) + Nvl(c_费用.实收金额, 0)
      Where 病人id = 病人id_In And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And Nvl(病人科室id, 0) = Nvl(c_费用.病人科室id, 0) And
            Nvl(开单部门id, 0) = Nvl(c_费用.开单部门id, 0) And Nvl(执行部门id, 0) = Nvl(c_费用.执行部门id, 0) And 收入项目id + 0 = c_费用.收入项目id And
            来源途径 + 0 = 1;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人未结费用
          (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
        Values
          (病人id_In, Null, Null, c_费用.病人科室id, c_费用.开单部门id, c_费用.执行部门id, c_费用.收入项目id, 1, Nvl(c_费用.实收金额, 0));
      End If;
    End Loop;
  End If;
  If Nvl(病人id_In, 0) <> 0 Then
    n_结算模式 := 0;
    Update 病人信息
    Set 就诊时间 = d_发生时间, 就诊状态 = 1, 就诊诊室 = 诊室_In
    Where 病人id = 病人id_In
    Returning Nvl(结算模式, 0) Into n_结算模式;
    --取参数:
    If Nvl(n_结算模式, 0) <> Nvl(结算模式_In, 0) Then
      --结算模式的确定
      If n_结算模式 = 1 And Nvl(结算模式_In, 0) = 0 Then
        --病人已经是"先诊疗后结算的",本次是"先结算后诊疗的",则检查是否存在未结数据
        Select Count(1)
        Into n_Count
        From 病人未结费用
        Where 病人id = 病人id_In And (来源途径 In (1, 4) Or 来源途径 = 3 And Nvl(主页id, 0) = 0) And Nvl(金额, 0) <> 0 And Rownum < 2;
        If Nvl(n_Count, 0) <> 0 Then
          --存在未结算数据，必须先结算后才允许执行
          v_Err_Msg := '当前病人的就诊模式为先诊疗后结算且存在未结费用，不允许调整该病人的就诊模式,你可以先对未结费用结帐后再挂号或不调整病人的就诊模式!';
          Raise Err_Item;
        End If;
        --检查
        --未发生医嘱业务的（即当时就挂号的,需要保证同一次的就诊模式是一至的(程序已经检查，不用再处理)
      End If;
      Update 病人信息 Set 结算模式 = 结算模式_In Where 病人id = 病人id_In;
    End If;
  End If;

  --病人担保信息
  If 病人id_In Is Not Null Then
    Update 病人信息
    Set 担保人 = Null, 担保额 = Null, 担保性质 = Null
    Where 病人id = 病人id_In And Nvl(在院, 0) = 0 And Exists
     (Select 1
           From 病人担保记录
           Where 病人id = 病人id_In And 主页id Is Not Null And
                 登记时间 = (Select Max(登记时间) From 病人担保记录 Where 病人id = 病人id_In));
    If Sql%RowCount > 0 Then
      Update 病人担保记录
      Set 到期时间 = d_Date
      Where 病人id = 病人id_In And 主页id Is Not Null And Nvl(到期时间, d_Date) >= d_Date;
    End If;
  End If;
  --消息推送
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 1, n_挂号id;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Err_Special Then
    Raise_Application_Error(-20105, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_预约挂号接收_出诊_Insert;
/

--108159:梁唐彬,2017-04-12,医嘱执行修改登记报错
CREATE OR REPLACE Procedure Zl_病人医嘱执行_Update
( 
  原执行时间_In 病人医嘱执行.执行时间%Type, 
  医嘱id_In     病人医嘱执行.医嘱id%Type, 
  发送号_In     病人医嘱执行.发送号%Type, 
  要求时间_In   病人医嘱执行.要求时间%Type, 
  本次数次_In   病人医嘱执行.本次数次%Type, 
  执行摘要_In   病人医嘱执行.执行摘要%Type, 
  执行人_In     病人医嘱执行.执行人%Type, 
  执行时间_In   病人医嘱执行.执行时间%Type, 
  执行结果_In   病人医嘱执行.执行结果%Type := 1, 
  未执行原因_In 病人医嘱执行.说明%Type := Null, 
  单独执行_In   Number := 0, 
  操作员编号_In 人员表.编号%Type := Null, 
  操作员姓名_In 人员表.姓名%Type := Null, 
  执行部门id_In 门诊费用记录.执行部门id%Type := 0 
  --参数：医嘱ID_IN=单独执行的医嘱ID，检验组合为显示的检验项目的ID。 
  --执行部门id_In=仅处理指定执行部门的费用，不传或传入0时不限制执行部门 
) Is 
  --除了要执行的主记录,还包含了附加手术,检查部位的记录 
  --手术麻醉,中药煎法,采集方法单独控制,检验组合只填写在第一个项目上，但执行状态相同 
  V_Temp     Varchar2(255); 
  V_人员编号 人员表.编号%Type; 
  V_人员姓名 人员表.姓名%Type; 
 
  V_组id        病人医嘱记录.Id%Type; 
  V_诊疗类别    病人医嘱记录.诊疗类别%Type; 
  V_执行结果old 病人医嘱执行.执行结果%Type; 
  N_本次数次old 病人医嘱执行.本次数次%Type; 
 
  V_病人来源 病人医嘱记录.病人来源%Type; 
  V_费用性质 病人医嘱发送.记录性质%Type; 
 
  N_执行次数 Number; 
  N_剩余次数 Number; 
  N_执行状态 Number; 
  n_发送数次 Number;
  n_单次数次 Number;
  v_Count    Number;
  n_登记数次 Number;
  d_要求时间 date;
  
  D_登记时间 病人医嘱执行.登记时间%Type; 
  N_取消执行 Number; 
  N_Diffday  Number(18, 3); 
 
  V_Date  Date; 
  V_Error Varchar2(255); 
  Err_Custom Exception; 
Begin 
  --当前操作人员 
  If 操作员编号_In Is Not Null And 操作员姓名_In Is Not Null Then 
    V_人员编号 := 操作员编号_In; 
    V_人员姓名 := 操作员姓名_In; 
  Else 
    V_Temp     := Zl_Identity; 
    V_Temp     := Substr(V_Temp, Instr(V_Temp, ';') + 1); 
    V_Temp     := Substr(V_Temp, Instr(V_Temp, ',') + 1); 
    V_人员编号 := Substr(V_Temp, 1, Instr(V_Temp, ',') - 1); 
    V_人员姓名 := Substr(V_Temp, Instr(V_Temp, ',') + 1); 
  End If; 
 
  Select Sysdate Into V_Date From Dual; 
  Select Nvl(执行结果, 1), Nvl(本次数次, 0), 登记时间 
  Into V_执行结果old, N_本次数次old, D_登记时间 
  From 病人医嘱执行 
  Where 医嘱id = 医嘱id_In And 发送号 = 发送号_In And 执行时间 = 原执行时间_In; 
  -----取消执行有效天数限制 
  Select Zl_To_Number(Nvl(zl_GetSysParameter(220), '999')) Into N_取消执行 From Dual; 
  Select V_Date - D_登记时间 Into N_Diffday From Dual; 
  --登记时间超过取消执行天数的记录，不允许修改医嘱执行情况 
  If N_Diffday > N_取消执行 Then 
    V_Error := '医嘱执行登记时间超过了取消执行有效天数，不能修改医嘱执行情况！'; 
    Raise Err_Custom; 
  End If; 
  --病人医嘱执行 
  Update 病人医嘱执行 
  Set 要求时间 = 要求时间_In, 本次数次 = 本次数次_In, 执行摘要 = 执行摘要_In, 执行人 = 执行人_In, 执行时间 = 执行时间_In, 登记时间 = V_Date, 登记人 = V_人员姓名, 
      执行结果 = 执行结果_In, 说明 = 未执行原因_In 
  Where 医嘱id = 医嘱id_In And 发送号 = 发送号_In And 执行时间 = 原执行时间_In; 
  --本次执行次数或这执行结果修改后需要更新单据的执行状态 
  If V_执行结果old <> 执行结果_In Or N_本次数次old <> 本次数次_In Then 
    Select 病人来源, Nvl(相关id, ID), 诊疗类别 
    Into V_病人来源, V_组id, V_诊疗类别 
    From 病人医嘱记录 
    Where ID = 医嘱id_In; 
 
    If v_病人来源 = 2 Then 
      Select Decode(记录性质, 1, 1, Decode(门诊记帐, 1, 1, 2)) 
      Into v_费用性质 
      From 病人医嘱发送 
      Where 发送号 = 发送号_In And 医嘱id = 医嘱id_In; 
    Else 
      v_费用性质 := 1; 
    End If; 
   
    Select Decode(a.执行状态, 1, a.发送数次, c.登记次数), Decode(a.执行状态, 1, 0, a.发送数次 - c.登记次数) ,A.发送数次,C.登记次数
    Into n_执行次数, n_剩余次数 ,n_发送数次,n_登记数次
    From 病人医嘱发送 A, 
         (Select 医嘱id_In 医嘱id, 发送号_In 发送号, Nvl(Sum(b.本次数次), 0) As 登记次数 
           From 病人医嘱执行 B 
           Where b.医嘱id = 医嘱id_In And b.发送号 = 发送号_In And Nvl(b.执行结果, 1) <> 0) C 
    Where a.医嘱id = c.医嘱id And a.发送号 = c.发送号 And a.医嘱id = 医嘱id_In And a.发送号 = 发送号_In; 
   
    --如果全部执行则状态为1，未执行状态为0，部分执行状态为2 
    Select Decode(N_剩余次数, 0, 1, Decode(N_执行次数, 0, 0, 2)) Into N_执行状态 From Dual; 
    
    --更新医嘱执行计价.执行状态
    If n_发送数次 > 0 Then
      Select Count(distinct 要求时间) Into v_Count From 医嘱执行计价 Where 医嘱ID = 医嘱ID_IN And 发送号 = 发送号_IN;
      If v_Count > 0 Then
        n_单次数次 := n_发送数次 / v_Count;
        --已执行数量+本次数次 总共能够执行多少个时间点,取最大整数
        v_Count := ceil((n_登记数次 ) / n_单次数次);
		If n_登记数次 = 0 Then
			Update 医嘱执行计价 Set 执行状态 = 0 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN And NVL(执行状态,0) <> 2;
		Else
	        --获取执行截至要求时间 
	        Select 要求时间 Into d_要求时间
	        From (Select 要求时间, Rownum As 次数
	               From (Select Distinct 要求时间 From 医嘱执行计价 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN Order By 要求时间))
	        Where 次数 = v_Count;
	        
	        If Not d_要求时间 Is Null Then
	          --先检查是否已经退费
	          Select Max(NVL(执行状态,0)) Into v_Count From 医嘱执行计价 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN And 要求时间 <= d_要求时间;
	          If v_Count = 2 Then
	            v_Error := '您指定的执行时间段的医嘱费用已经被退费，不允许再执行。'; 
	            Raise Err_Custom; 
	          End If;
	          --更新截至要求时间之前(含)的记录执行状态；
	          Update 医嘱执行计价 Set 执行状态 = 1 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN And 要求时间 <= d_要求时间 And NVL(执行状态,0) <> 2;
	          Update 医嘱执行计价 Set 执行状态 = 0 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN And 要求时间 > d_要求时间 And NVL(执行状态,0) <> 2;
	        End If;
		End If;
      End If;
    End If;
 
    --执行次数不为0就标记为正在执行 
    If Nvl(单独执行_In, 0) = 1 Then 
      Update 病人医嘱发送 
      Set 执行状态 = Decode(N_执行次数, 0, 0, 3), 完成人 = Null, 完成时间 = Null 
      Where 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In; 
    Else 
      Update 病人医嘱发送 
      Set 执行状态 = Decode(N_执行次数, 0, 0, 3), 完成人 = Null, 完成时间 = Null 
      Where 执行状态 In (0, 3) And 发送号 + 0 = 发送号_In And 
            医嘱id In (Select ID From 病人医嘱记录 Where (ID = V_组id Or 相关id = V_组id) And 诊疗类别 = V_诊疗类别); 
    End If; 
 
    If V_费用性质 = 2 Then 
      If Nvl(单独执行_In, 0) = 1 Then 
        Update 住院费用记录 A 
        Set 执行状态 = N_执行状态, 执行人 = Decode(N_执行状态, 0, Null, 执行人_In), 执行时间 = Decode(N_执行状态, 0, Null, 执行时间_In) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or A.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = A.收费细目id And 跟踪在用 = 1) And A.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(N_执行次数, 0, 0, 3) And 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In); 
      Else 
        Update 住院费用记录 A 
        Set 执行状态 = N_执行状态, 执行人 = Decode(N_执行状态, 0, Null, 执行人_In), 执行时间 = Decode(N_执行状态, 0, Null, 执行时间_In) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or A.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = A.收费细目id And 跟踪在用 = 1) And A.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(N_执行次数, 0, 0, 3) And 发送号 + 0 = 发送号_In And 
                     医嘱id In 
                     (Select ID From 病人医嘱记录 Where (ID = V_组id Or 相关id = V_组id) And 诊疗类别 = V_诊疗类别)); 
      End If; 
    Else 
      If Nvl(单独执行_In, 0) = 1 Then 
        Update 门诊费用记录 A 
        Set 执行状态 = N_执行状态, 执行人 = Decode(N_执行状态, 0, Null, 执行人_In), 执行时间 = Decode(N_执行状态, 0, Null, 执行时间_In) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or A.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = A.收费细目id And 跟踪在用 = 1) And A.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(N_执行次数, 0, 0, 3) And 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In); 
      Else 
        Update 门诊费用记录 A 
        Set 执行状态 = N_执行状态, 执行人 = Decode(N_执行状态, 0, Null, 执行人_In), 执行时间 = Decode(N_执行状态, 0, Null, 执行时间_In) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or A.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = A.收费细目id And 跟踪在用 = 1) And A.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(N_执行次数, 0, 0, 3) And 发送号 + 0 = 发送号_In And 
                     医嘱id In 
                     (Select ID From 病人医嘱记录 Where (ID = V_组id Or 相关id = V_组id) And 诊疗类别 = V_诊疗类别)); 
      End If; 
    End If; 
  End If; 
Exception 
  When Err_Custom Then 
    Raise_Application_Error(-20101, '[ZLSOFT]' || V_Error || '[ZLSOFT]'); 
  When Others Then 
    zl_ErrorCenter(SQLCode, SQLErrM); 
End Zl_病人医嘱执行_Update;
/

--107651:梁唐彬,2017-04-12,病人自动计算
Create Or Replace Procedure Zl_入院病案主页_Insert
(
  登记模式_In       Number,
  病人性质_In       病案主页.病人性质%Type,
  病人id_In         病人信息.病人id%Type,
  住院号_In         病人信息.住院号%Type,
  医保号_In         保险帐户.医保号%Type,
  姓名_In           病人信息.姓名%Type,
  性别_In           病人信息.性别%Type,
  年龄_In           病人信息.年龄%Type,
  费别_In           病人信息.费别%Type,
  出生日期_In       病人信息.出生日期%Type,
  国籍_In           病人信息.国籍%Type,
  民族_In           病人信息.民族%Type,
  学历_In           病人信息.学历%Type,
  婚姻状况_In       病人信息.婚姻状况%Type,
  职业_In           病人信息.职业%Type,
  身份_In           病人信息.身份%Type,
  身份证号_In       病人信息.身份证号%Type,
  出生地点_In       病人信息.出生地点%Type,
  家庭地址_In       病人信息.家庭地址%Type,
  家庭地址邮编_In   病人信息.家庭地址邮编%Type,
  家庭电话_In       病人信息.家庭电话%Type,
  户口地址_In       病人信息.户口地址%Type,
  户口地址邮编_In   病人信息.户口地址邮编%Type,
  联系人姓名_In     病人信息.联系人姓名%Type,
  联系人关系_In     病人信息.联系人关系%Type,
  联系人地址_In     病人信息.联系人地址%Type,
  联系人电话_In     病人信息.联系人电话%Type,
  工作单位_In       病人信息.工作单位%Type,
  合同单位id_In     病人信息.合同单位id%Type,
  单位电话_In       病人信息.单位电话%Type,
  单位邮编_In       病人信息.单位邮编%Type,
  单位开户行_In     病人信息.单位开户行%Type,
  单位帐号_In       病人信息.单位帐号%Type,
  担保人_In         病人信息.担保人%Type,
  担保额_In         病人信息.担保额%Type,
  担保性质_In       病人信息.担保性质%Type,
  入院科室id_In     病案主页.入院科室id%Type,
  护理等级id_In     病案主页.护理等级id%Type,
  入院病况_In       病案主页.入院病况%Type,
  入院方式_In       病案主页.入院方式%Type,
  住院目的_In       病案主页.住院目的%Type,
  二级院转入_In     病案主页.二级院转入%Type,
  门诊医师_In       病案主页.门诊医师%Type,
  籍贯_In           病人信息.籍贯%Type,
  区域_In           病案主页.区域%Type,
  入院时间_In       病案主页.入院日期%Type,
  是否陪伴_In       病案主页.是否陪伴%Type,
  床号_In           病案主页.入院病床%Type,
  付款方式_In       病案主页.医疗付款方式%Type,
  疾病id_In         病人诊断记录.疾病id%Type,
  诊断id_In         病人诊断记录.诊断id%Type,
  门诊诊断_In       病人诊断记录.诊断描述%Type,
  中医疾病id_In     病人诊断记录.疾病id%Type,
  中医诊断id_In     病人诊断记录.诊断id%Type,
  中医诊断_In       病人诊断记录.诊断描述%Type,
  险类_In           病案主页.险类%Type,
  操作员编号_In     病案主页.编目员编号%Type,
  操作员姓名_In     病案主页.编目员姓名%Type,
  新病人_In         Number := 1,
  备注_In           病案主页.备注%Type,
  入院病区id_In     病案主页.入院病区id%Type,
  再入院_In         病案主页.再入院%Type,
  入院属性_In       病案主页.入院属性%Type := Null,
  主页id_In         病案主页.主页id%Type := Null,
  住院次数_In       病人信息.住院次数%Type := Null,
  其他证件_In       病人信息.其他证件%Type := Null,
  病人类型_In       病案主页.病人类型%Type := Null,
  联系人身份证号_In 病人信息.联系人身份证号%Type := Null,
  手机号_In         病人信息.手机号%Type := Null
) As
  -----------------------------------------------------------
  --功能：对入院病人新增一张病案主页，同时可能处理入科。
  --参数：
  --      登记模式_IN=0-正常登记,1-预约登记,2-接收预约(新病人_IN=0)
  --      病人性质_IN=对应"病案主页.病人性质"
  --      床号_IN=Null:不同时入科;'家庭病床':分配家庭病床,填为空;其他:分配具体床位。
  --      新病人_IN=如果是已有档案的病人入院,则该参数为0；缺省为新病人
  --      入院病区ID_IN=只有当使用[病区管理病床]模式(参数号99)时,并且入院同时入科分床时,才有值
  --      住院号_In = 登记门诊留观病人时 住院号_In 为病人门诊号
  -----------------------------------------------------------
  v_主页id   病案主页.主页id%Type;
  v_等级id   床位状况记录.等级id%Type;
  n_住院次数 病人信息.住院次数%Type;

  v_费别  病案主页.费别%Type;
  v_Count Number;
  v_Date  Date;
  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  --判断病人是否锁定
  Select Count(病人id) Into v_Count From 病人信息 Where 病人id = 病人id_In;
  If v_Count <> 0 Then
    Zl_病人信息_锁定检查(病人id_In);
  End If;

  Select Sysdate Into v_Date From Dual;
  Zl_病区标记记录_Clear(病人id_In);
  --病人基本信息
  If 病人性质_In = 1 Then
    If 新病人_In = 1 Then
      Insert Into 病人信息
        (病人id, 门诊号, 住院号, 姓名, 性别, 年龄, 费别, 医疗付款方式, 出生日期, 国籍, 民族, 籍贯, 区域, 学历, 婚姻状况, 职业, 身份, 身份证号, 出生地点, 家庭地址, 家庭地址邮编, 家庭电话,
         户口地址, 户口地址邮编, 联系人姓名, 联系人关系, 联系人地址, 联系人电话, 工作单位, 合同单位id, 单位电话, 单位邮编, 单位开户行, 单位帐号, 担保人, 担保额, 担保性质, 险类, 登记时间, 其他证件,
         联系人身份证号, 手机号)
      Values
        (病人id_In, 住院号_In, Null, 姓名_In, 性别_In, 年龄_In, 费别_In, 付款方式_In, 出生日期_In, 国籍_In, 民族_In, 籍贯_In, 区域_In, 学历_In,
         婚姻状况_In, 职业_In, 身份_In, 身份证号_In, 出生地点_In, 家庭地址_In, 家庭地址邮编_In, 家庭电话_In, 户口地址_In, 户口地址邮编_In, 联系人姓名_In, 联系人关系_In,
         联系人地址_In, 联系人电话_In, 工作单位_In, Decode(合同单位id_In, 0, Null, 合同单位id_In), 单位电话_In, 单位邮编_In, 单位开户行_In, 单位帐号_In, 担保人_In,
         Decode(担保额_In, 0, Null, 担保额_In), 担保性质_In, 险类_In, v_Date, 其他证件_In, 联系人身份证号_In, 手机号_In);
    Else
      --老病人的门诊费别不变,除非是门诊留观病人
      Update 病人信息
      Set 门诊号 = 住院号_In, 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = 年龄_In, 费别 = Decode(病人性质_In, 1, 费别_In, 费别), 医疗付款方式 = 付款方式_In,
          出生日期 = 出生日期_In, 国籍 = 国籍_In, 民族 = 民族_In, 籍贯 = 籍贯_In, 区域 = 区域_In, 学历 = 学历_In, 婚姻状况 = 婚姻状况_In, 职业 = 职业_In,
          身份 = 身份_In, 身份证号 = 身份证号_In, 出生地点 = 出生地点_In, 家庭地址 = 家庭地址_In, 家庭地址邮编 = 家庭地址邮编_In, 家庭电话 = 家庭电话_In, 户口地址 = 户口地址_In,
          户口地址邮编 = 户口地址邮编_In, 联系人姓名 = 联系人姓名_In, 联系人关系 = 联系人关系_In, 联系人地址 = 联系人地址_In, 联系人电话 = 联系人电话_In, 工作单位 = 工作单位_In,
          合同单位id = Decode(合同单位id_In, 0, Null, 合同单位id_In), 单位电话 = 单位电话_In, 单位邮编 = 单位邮编_In, 单位开户行 = 单位开户行_In,
          单位帐号 = 单位帐号_In, 担保人 = 担保人_In, 担保额 = Decode(担保额_In, 0, Null, 担保额_In), 担保性质 = 担保性质_In, 险类 = 险类_In,
          其他证件 = 其他证件_In, 联系人身份证号 = 联系人身份证号_In, 手机号 = NVL(手机号_In,手机号)
      Where 病人id = 病人id_In;
    End If;
  Else
    If 新病人_In = 1 Then
      Insert Into 病人信息
        (病人id, 住院号, 姓名, 性别, 年龄, 费别, 医疗付款方式, 出生日期, 国籍, 民族, 籍贯, 区域, 学历, 婚姻状况, 职业, 身份, 身份证号, 出生地点, 家庭地址, 家庭地址邮编, 家庭电话,
         户口地址, 户口地址邮编, 联系人姓名, 联系人关系, 联系人地址, 联系人电话, 工作单位, 合同单位id, 单位电话, 单位邮编, 单位开户行, 单位帐号, 担保人, 担保额, 担保性质, 险类, 登记时间, 其他证件,
         联系人身份证号, 手机号)
      Values
        (病人id_In, Decode(病人性质_In, 2, Null, 住院号_In), 姓名_In, 性别_In, 年龄_In, 费别_In, 付款方式_In, 出生日期_In, 国籍_In, 民族_In, 籍贯_In,
         区域_In, 学历_In, 婚姻状况_In, 职业_In, 身份_In, 身份证号_In, 出生地点_In, 家庭地址_In, 家庭地址邮编_In, 家庭电话_In, 户口地址_In, 户口地址邮编_In,
         联系人姓名_In, 联系人关系_In, 联系人地址_In, 联系人电话_In, 工作单位_In, Decode(合同单位id_In, 0, Null, 合同单位id_In), 单位电话_In, 单位邮编_In,
         单位开户行_In, 单位帐号_In, 担保人_In, Decode(担保额_In, 0, Null, 担保额_In), 担保性质_In, 险类_In, v_Date, 其他证件_In, 联系人身份证号_In, 手机号_In);
    Else
      --老病人的门诊费别不变,除非是门诊留观病人
      Update 病人信息
      Set 住院号 = Decode(病人性质_In, 2, 住院号, Decode(住院号_In, Null, 住院号, 住院号_In)), 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = 年龄_In,
          费别 = Decode(病人性质_In, 1, 费别_In, 费别), 医疗付款方式 = 付款方式_In, 出生日期 = 出生日期_In, 国籍 = 国籍_In, 民族 = 民族_In, 籍贯 = 籍贯_In,
          区域 = 区域_In, 学历 = 学历_In, 婚姻状况 = 婚姻状况_In, 职业 = 职业_In, 身份 = 身份_In, 身份证号 = 身份证号_In, 出生地点 = 出生地点_In, 家庭地址 = 家庭地址_In,
          家庭地址邮编 = 家庭地址邮编_In, 家庭电话 = 家庭电话_In, 户口地址 = 户口地址_In, 户口地址邮编 = 户口地址邮编_In, 联系人姓名 = 联系人姓名_In, 联系人关系 = 联系人关系_In,
          联系人地址 = 联系人地址_In, 联系人电话 = 联系人电话_In, 工作单位 = 工作单位_In, 合同单位id = Decode(合同单位id_In, 0, Null, 合同单位id_In),
          单位电话 = 单位电话_In, 单位邮编 = 单位邮编_In, 单位开户行 = 单位开户行_In, 单位帐号 = 单位帐号_In, 担保人 = 担保人_In,
          担保额 = Decode(担保额_In, 0, Null, 担保额_In), 担保性质 = 担保性质_In, 险类 = 险类_In, 其他证件 = 其他证件_In, 联系人身份证号 = 联系人身份证号_In,
          手机号 = NVL(手机号_In,手机号)
      Where 病人id = 病人id_In;
    End If;
  End If;

  --病案信息
  Begin
    If 登记模式_In = 1 Then
      v_主页id := 0; --预约登记记录的主页ID=0
    Else
      If 主页id_In Is Null Then
        Select Nvl(Max(主页id), 0) + 1 Into v_主页id From 病案主页 Where 病人id = 病人id_In And Nvl(主页id, 0) <> 0;
      Else
        v_主页id := 主页id_In;
      End If;
    End If;
  Exception
    When Others Then
      Null;
  End;

  If 登记模式_In <> 1 Then
    Update 病人信息
    Set 主页id = v_主页id, 当前病区id = 入院病区id_In, 当前科室id = 入院科室id_In, 当前床号 = Decode(床号_In, '家庭病床', Null, 床号_In), 入院时间 = 入院时间_In,
        出院时间 = Null, 在院 = 1
    Where 病人id = 病人id_In;
  End If;

  --更新住院次数
  If 登记模式_In <> 1 And 病人性质_In = 0 Then
    If Nvl(住院次数_In, 0) = 0 Then
      Select Nvl(住院次数, 0) + 1 Into n_住院次数 From 病人信息 Where 病人id = 病人id_In;
    Else
      n_住院次数 := 住院次数_In;
    End If;
    Update 病人信息 Set 住院次数 = n_住院次数 Where 病人id = 病人id_In;
  End If;

  --状态：0-正常在院,1-等待入科,2-等待转科
  If 登记模式_In = 2 Then
    --处理病案主页从表
    Delete From 病案主页从表 Where 病人id = 病人id_In And Nvl(主页id, 0) = 0;
    --接收预约
    Update 病案主页
    Set 主页id = v_主页id, 病人性质 = 病人性质_In, 住院号 = Decode(病人性质_In, 1, Null, 2, Null, 住院号_In),
        留观号 = Decode(病人性质_In, 2, 住院号_In, Null),
        --主页ID变更,病人性质可能变更
        费别 = 费别_In, 入院病区id = 入院病区id_In, 入院科室id = 入院科室id_In, 入院日期 = 入院时间_In, 入院病况 = 入院病况_In, 入院方式 = 入院方式_In,
        入院属性 = 入院属性_In, 二级院转入 = 二级院转入_In, 住院目的 = 住院目的_In, 入院病床 = Decode(床号_In, '家庭病床', Null, 床号_In), 是否陪伴 = 是否陪伴_In,
        当前病况 = 入院病况_In, 当前病区id = 入院病区id_In, 护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In), 出院科室id = 入院科室id_In,
        出院病床 = Decode(床号_In, '家庭病床', Null, 床号_In), 门诊医师 = 门诊医师_In, 编目员编号 = 操作员编号_In, 编目员姓名 = 操作员姓名_In, 姓名 = 姓名_In,
        性别 = 性别_In, 年龄 = 年龄_In, 婚姻状况 = 婚姻状况_In, 职业 = 职业_In, 国籍 = 国籍_In, 学历 = 学历_In, 单位电话 = 单位电话_In, 单位邮编 = 单位邮编_In,
        单位地址 = 工作单位_In, 区域 = 区域_In, 家庭地址 = 家庭地址_In, 家庭电话 = 家庭电话_In, 家庭地址邮编 = 家庭地址邮编_In, 户口地址 = 户口地址_In,
        户口地址邮编 = 户口地址邮编_In, 联系人姓名 = 联系人姓名_In, 联系人关系 = 联系人关系_In, 联系人地址 = 联系人地址_In, 联系人身份证号 = 联系人身份证号_In, 联系人电话 = 联系人电话_In,
        医疗付款方式 = 付款方式_In, 备注 = 备注_In, 险类 = 险类_In, 状态 = Decode(床号_In, Null, 1, 0), 登记人 = 操作员姓名_In, 登记时间 = v_Date,
        再入院 = 再入院_In, 病人类型 = 病人类型_In
    Where 病人id = 病人id_In And Nvl(主页id, 0) = 0;
    Update 病人预交记录
    Set 主页id = 主页id_In
    Where 病人id = 病人id_In And 主页id Is Null And 科室id = 入院科室id_In And 预交类别 = 2 And 冲预交 Is Null And
          Trunc(收款时间) = Trunc(Sysdate);
  Else
    --入院登记或预约登记
    Insert Into 病案主页
      (病人性质, 病人id, 主页id, 住院号, 留观号, 费别, 入院病区id, 入院科室id, 入院日期, 入院病况, 入院方式, 入院属性, 二级院转入, 住院目的, 入院病床, 是否陪伴, 当前病况, 当前病区id,
       护理等级id, 出院科室id, 出院病床, 门诊医师, 编目员编号, 编目员姓名, 状态, 姓名, 性别, 年龄, 婚姻状况, 职业, 国籍, 学历, 单位电话, 单位邮编, 单位地址, 区域, 家庭地址, 家庭电话,
       家庭地址邮编, 户口地址, 户口地址邮编, 联系人姓名, 联系人关系, 联系人地址, 联系人电话, 联系人身份证号, 医疗付款方式, 险类, 备注, 登记人, 登记时间, 再入院, 病人类型)
    Values
      (病人性质_In, 病人id_In, v_主页id, Decode(病人性质_In, 1, Null, 2, Null, 住院号_In), Decode(病人性质_In, 2, 住院号_In, Null), 费别_In,
       入院病区id_In, 入院科室id_In, 入院时间_In, 入院病况_In, 入院方式_In, 入院属性_In, 二级院转入_In, 住院目的_In, Decode(床号_In, '家庭病床', Null, 床号_In),
       是否陪伴_In, 入院病况_In, 入院病区id_In, Decode(护理等级id_In, 0, Null, 护理等级id_In), 入院科室id_In, Decode(床号_In, '家庭病床', Null, 床号_In),
       门诊医师_In, 操作员编号_In, 操作员姓名_In, Decode(床号_In, Null, 1, 0), 姓名_In, 性别_In, 年龄_In, 婚姻状况_In, 职业_In, 国籍_In, 学历_In,
       单位电话_In, 单位邮编_In, 工作单位_In, 区域_In, 家庭地址_In, 家庭电话_In, 家庭地址邮编_In, 户口地址_In, 户口地址邮编_In, 联系人姓名_In, 联系人关系_In, 联系人地址_In,
       联系人电话_In, 联系人身份证号_In, 付款方式_In, 险类_In, 备注_In, 操作员姓名_In, v_Date, 再入院_In, 病人类型_In);
  End If;

  Begin
    If 登记模式_In <> 1 Then
      Update 在院病人 Set 病区id = Nvl(入院病区id_In, 0), 科室id = 入院科室id_In Where 病人id = 病人id_In;
      If Sql%RowCount = 0 Then
        Insert Into 在院病人
          (病人id, 科室id, 病区id, 主页id)
        Values
          (病人id_In, 入院科室id_In, Nvl(入院病区id_In, 0), Nvl(v_主页id, 0));
      End If;
    End If;
  Exception
    When Others Then
      Null;
  End;

  Select 费别 Into v_费别 From 病人信息 Where 病人id = 病人id_In;
  If v_费别 Is Null Then
    Update 病人信息
    Set 费别 =
         (Select 费别 From 病案主页 Where 病人id = 病人id_In And 主页id = v_主页id)
    Where 病人id = 病人id_In;
  End If;

  --医保号
  If 登记模式_In <> 1 Then
    Select Zl_住院日报_Count(入院科室id_In, Trunc(入院时间_In)) Into v_Count From Dual;
    If v_Count > 0 Then
      v_Error := '已产生业务时间内的住院日报,不能办理该业务!';
      Raise Err_Custom;
    End If;
  
    If 医保号_In Is Not Null Then
      Insert Into 病案主页从表 (病人id, 主页id, 信息名, 信息值) Values (病人id_In, v_主页id, '医保号', 医保号_In);
    End If;
  
    --病人变动记录
    --同时入科且非家庭病床时有等级
    If 床号_In Is Not Null And 床号_In <> '家庭病床' Then
      Select 等级id Into v_等级id From 床位状况记录 Where 病区id = 入院病区id_In And 床号 = 床号_In;
    End If;
  
    --如果同时入科,则入院和入科填写到一条入院变动
    Insert Into 病人变动记录
      (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 护理等级id, 床位等级id, 床号, 病情, 操作员编号, 操作员姓名)
    Values
      (病人变动记录_Id.Nextval, 病人id_In, v_主页id, 入院时间_In, 1, 0, 入院病区id_In, 入院科室id_In, Decode(护理等级id_In, 0, Null, 护理等级id_In),
       v_等级id, Decode(床号_In, '家庭病床', Null, 床号_In), 入院病况_In, 操作员编号_In, 操作员姓名_In);
    
    Insert Into 病人自动计算
      (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 病区id, 科室id, 护理等级id, 操作员编号, 操作员姓名)
    Values
      (病人自动计算_Id.Nextval, 病人id_In, v_主页id, 入院时间_In, 1, 1, 入院病区id_In, 入院科室id_In, Decode(护理等级id_In, 0, Null, 护理等级id_In),
       操作员编号_In, 操作员姓名_In);
    Insert Into 病人自动计算
      (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号, 操作员姓名)
    Values
      (病人自动计算_Id.Nextval, 病人id_In, v_主页id, 入院时间_In, 1, 2, 0, 入院病区id_In, 入院科室id_In,
       v_等级id, Decode(床号_In, '家庭病床', Null, 床号_In), 操作员编号_In, 操作员姓名_In);
    Insert Into 病人自动计算
      (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号, 操作员姓名)
    Values
      (病人自动计算_Id.Nextval, 病人id_In, v_主页id, 入院时间_In, 1, 3, 0, 入院病区id_In, 入院科室id_In,
       v_等级id, Decode(床号_In, '家庭病床', Null, 床号_In), 操作员编号_In, 操作员姓名_In);
       
    --同时入科且非家庭病床时床位被占用
    If 床号_In Is Not Null And 床号_In <> '家庭病床' Then
      Select Count(*) Into v_Count From 床位状况记录 Where 病区id = 入院病区id_In And 床号 = 床号_In And 状态 = '空床';
    
      If v_Count = 0 Then
        v_Error := '操作失败,床位 ' || 床号_In || ' 不是空床！';
        Raise Err_Custom;
      End If;
    
      Update 床位状况记录
      Set 状态 = '占用', 病人id = 病人id_In, 科室id = Decode(共用, 1, 入院科室id_In, 科室id)
      Where 病区id = 入院病区id_In And 床号 = 床号_In;
    End If;
  
    --病人诊断记录
    If 门诊诊断_In Is Not Null Or 疾病id_In Is Not Null Then
      Insert Into 病人诊断记录
        (ID, 病人id, 主页id, 记录来源, 诊断类型, 诊断次序, 疾病id, 诊断id, 诊断描述, 记录日期, 记录人)
      Values
        (病人诊断记录_Id.Nextval, 病人id_In, v_主页id, 2, 1, 1, 疾病id_In, 诊断id_In, 门诊诊断_In, Sysdate, 操作员姓名_In);
    End If;
    If 中医诊断_In Is Not Null Or 中医疾病id_In Is Not Null Then
      Insert Into 病人诊断记录
        (ID, 病人id, 主页id, 记录来源, 诊断类型, 诊断次序, 疾病id, 诊断id, 诊断描述, 记录日期, 记录人)
      Values
        (病人诊断记录_Id.Nextval, 病人id_In, v_主页id, 2, 11, 1, 中医疾病id_In, 中医诊断id_In, 中医诊断_In, Sysdate, 操作员姓名_In);
    End If;
    --病人担保记录
    Update 病人担保记录
    Set 到期时间 = Sysdate
    Where 病人id = 病人id_In And 到期时间 Is Not Null And 到期时间 > Sysdate;
  
    --病人费用审批项目
    If 登记模式_In <> 1 Then
      Delete From 病人审批项目 Where 病人id = 病人id_In;
    End If;
  
    If 登记模式_In = 0 And ((门诊诊断_In Is Not Null Or 疾病id_In Is Not Null) Or (中医诊断_In Is Not Null Or 中医疾病id_In Is Not Null)) Then
      --产生病历书写时机
      Zl_电子病历时机_Insert(病人id_In, 主页id_In, 2, '诊断', 入院科室id_In, Null, Sysdate, Sysdate);
    End If;
  
    If 登记模式_In = 0 And 床号_In Is Not Null Then
      If 再入院_In = 0 Then
        Zl_电子病历时机_Insert(病人id_In, 主页id_In, 2, '入院', 入院科室id_In, Null, 入院时间_In, 入院时间_In);
      Else
        Zl_电子病历时机_Insert(病人id_In, 主页id_In, 2, '再次入院', 入院科室id_In, Null, 入院时间_In, 入院时间_In);
      End If;
    End If;
  
    If 床号_In Is Not Null Then
      --添加首份体温单
      Zl_病人体温单_Newfirst(病人id_In, 主页id_In, 入院病区id_In);
    End If;
  
    --并发操作检查
    Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 出院日期 Is Null;
    If v_Count > 1 Then
      v_Error := '发现病人存在非法的病案记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
      Raise Err_Custom;
    End If;
  
    Select Count(*)
    Into v_Count
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = v_主页id And Nvl(附加床位, 0) = 0 And 开始时间 Is Not Null And 终止时间 Is Null;
    If v_Count > 1 Then
      v_Error := '发现病人存在非法的变动记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
      Raise Err_Custom;
    End If;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_入院病案主页_Insert;
/
--98488:余伟节,2017-04-15,入院时未指定病区则撤销入住时要清空病区
--107651:梁唐彬,2017-04-28,病人自动计算
Create Or Replace Procedure Zl_病人变动记录_Undo
(
  病人id_In     病案主页.病人id%Type,
  主页id_In     病案主页.主页id%Type,
  操作员编号_In 病人变动记录.操作员编号%Type,
  操作员姓名_In 病人变动记录.操作员姓名%Type,
  数据_In       Varchar2 := Null, --a.转为住院时,清除住院号,b-检查自动记帐费用是否已结帐
  床号_In       Varchar2 := Null, --传入时表示撤销出院时安排到新的床号，原床位被占用在程序中判断
  主床位_In     Varchar2 := Null, --传入时表示撤销出院时安排到新的主床位，原床位被占用在程序中判断
  撤销方式_In   Varchar2 := Null --指明具体撤销操作，如撤销出院、转科等必须输入
) As
  -----------------------------------------------------------
  --说明：1.撤消病人最近一次的变动
  --        2.前提：当病人包床时,对其中一张床位作变动,则所有床位相应产生变动
  -----------------------------------------------------------
  --要撤消的变动记录(如果包床,可能多条)
  Cursor c_Curlog Is
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And (终止时间 Is Null Or 终止原因 = 1)
    Order By 终止时间 Desc, 开始时间 Desc;
  r_Curlogrow c_Curlog%RowType;

  Cursor c_Curautolog Is
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And (终止时间 Is Null Or 终止原因 = 1) And 性质 = 2
    Order By 终止时间 Desc, 开始时间 Desc;
  r_Curautologrow c_Curautolog%RowType;

  Cursor c_Curautohllog Is
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And (终止时间 Is Null Or 终止原因 = 1) And 性质 = 1
    Order By 终止时间 Desc, 开始时间 Desc;
  r_Curautohllogrow c_Curautohllog%RowType;

  --撤消后要恢复的变动记录(如果包床,可能多条)
  Cursor c_Prelog
  (
    v_终止时间 病人变动记录.终止时间%Type,
    v_终止原因 病人变动记录.终止原因%Type
  ) Is
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因 = v_终止原因
    Order By 终止时间 Desc, 开始时间 Desc;
  r_Prelogrow c_Prelog%RowType;

  --获取病人原床位所住病人信息
  Cursor c_Prebed
  (
    v_病人id 病案主页.病人id%Type,
    v_主页id 病案主页.主页id%Type
  ) Is
    Select a.床号, c.出院病床, c.出院科室id, c.当前病区id
    From 病人变动记录 A, 床位状况记录 B, 病案主页 C
    Where a.病人id = 病人id_In And a.主页id = 主页id_In And 终止原因 = 4 And a.病区id = b.病区id And a.病人id = c.病人id And
          a.主页id = c.主页id And a.床号 = b.床号
    Order By 终止时间 Desc, 开始时间 Desc;
  r_Prebedrow c_Prebed%RowType;

  Cursor c_Prebedpati
  (
    v_出院科室id 病人变动记录.科室id%Type,
    v_病区id     病人变动记录.病区id%Type,
    v_原床号     病人变动记录.床号%Type
  ) Is
    Select a.病人id, c.主页id, a.床号, c.出院病床
    From 病人变动记录 A, 病案主页 C,
         (Select 病人id
           From 床位状况记录
           Where (科室id Is Null Or 科室id = v_出院科室id Or 共用 = 1) And 病区id = v_病区id And 床号 = v_原床号) D
    Where a.病人id = d.病人id And a.主页id = (Select 主页id From 病人信息 Where 病人id = d.病人id) And a.终止原因 = 4 And a.病人id = c.病人id And
          a.主页id = c.主页id
    Order By 终止时间 Desc, 开始时间 Desc;
  r_Prebedpati c_Prebedpati%RowType;

  v_开始时间       病人变动记录.开始时间%Type;
  v_开始原因       病人变动记录.开始原因%Type;
  v_终止人员       病人变动记录.终止人员%Type;
  v_Auto开始时间   病人变动记录.开始时间%Type;
  v_Autohl开始时间 病人变动记录.开始时间%Type;

  v_Count       Number;
  v_Countcurlog Number;
  v_Countprelog Number;

  Err_Custom Exception;
  v_Error Varchar2(255);

  v_撤销方式     Varchar2(100);
  v_共享号       Zlsystems.共享号%Type;
  v_病案状态     Number(3);
  v_床号串       Varchar2(255);
  v_床号         病人变动记录.床号%Type;
  v_病人id       病人变动记录.病人id%Type;
  v_主页id       病人变动记录.主页id%Type;
  v_病区id       病人变动记录.病区id%Type;
  v_原床号1      病人变动记录.床号%Type;
  v_原床号2      病人变动记录.床号%Type;
  v_当前床号1    病人变动记录.床号%Type;
  v_当前床号2    病人变动记录.床号%Type;
  v_出院科室id   病人变动记录.科室id%Type;
  v_床位等级id   病人变动记录.床位等级id%Type;
  v_险类         病案主页.险类%Type;
  v_姓名         病人信息.姓名%Type;
  n_原科室id     病案主页.出院科室id%Type;
  n_原病区id     病案主页.当前病区id%Type;
  v_母婴转科标志 病案主页.母婴转科标志%Type;
  v_Tmp          Varchar2(100);
  d_开始时间     Date;

  Function Checkpatiadvice
  (
    病人id_In   病案主页.病人id%Type,
    主页id_In   病案主页.主页id%Type,
    撤销方式_In Varchar2 := Null
  ) Return Varchar2 Is
    --本次住院所有医嘱记录都已作废
    v_Err Varchar2(255);
  Begin
    v_Err := Null;
  
    For r_Row In (Select 开嘱医生, Decode(医嘱状态, -1, '暂存', 1, '新开', 2, '校对疑问', '未作废') As 状态, 医嘱内容
                  From 病人医嘱记录
                  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(医嘱状态, 0) <> 4 And Rownum < 2) Loop
      v_Err := '[ZLSOFT]【' || r_Row.开嘱医生 || '】医生有' || r_Row.状态 || '的医嘱没有处理,不允许撤销' || 撤销方式_In || '！[ZLSOFT]';
    End Loop;
    Return v_Err;
  End Checkpatiadvice;
Begin
  If 撤销方式_In Is Null Then
    v_Error := '[ZLSOFT]没有指明具体的撤销操作！[ZLSOFT]';
    Raise Err_Custom;
  Else
    v_撤销方式 := 撤销方式_In;
  End If;

  Open c_Curlog;
  Fetch c_Curlog
    Into r_Curlogrow;
  --撤销出院之前，先检查是否恢复病人自动计算数据；
  If r_Curlogrow.终止时间 Is Not Null And r_Curlogrow.终止原因 = 1 And v_撤销方式 = '出院' Then
    Zl_病人自动计算_修正(病人id_In, 主页id_In);
  End If;
  Open c_Curautolog;
  Fetch c_Curautolog
    Into r_Curautologrow;
  Open c_Curautohllog;
  Fetch c_Curautohllog
    Into r_Curautohllogrow;
  If c_Curlog%RowCount = 0 Then
    v_Error := '[ZLSOFT]病人当前没有可以撤消的操作！[ZLSOFT]';
    Close c_Curlog;
    Raise Err_Custom;
  End If;

  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id > 主页id_In;
  If v_Count > 0 Then
    v_Error := '[ZLSOFT]您只能对病人的最后一次住院进行撤销操作,本次撤销操作终止![ZLSOFT]';
    Raise Err_Custom;
  End If;

  Select Count(ID)
  Into v_Countcurlog
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And (终止时间 Is Null Or 终止原因 = 1)
  Order By 终止时间 Desc, 开始时间 Desc;

  Select Count(a.床号)
  Into v_Countprelog
  From 病人变动记录 A, 床位状况记录 B, 病案主页 C
  Where a.病人id = 病人id_In And a.主页id = 主页id_In And 终止原因 = 4 And a.病区id = b.病区id And a.病人id = c.病人id And a.主页id = c.主页id And
        a.床号 = b.床号
  Order By 终止时间 Desc, 开始时间 Desc;

  --判断是否撤消床位对换
  If v_撤销方式 = '换床' And v_Countcurlog <= 1 And v_Countprelog <= 1 Then
    Open c_Prebed(病人id_In, 主页id_In);
    Fetch c_Prebed
      Into r_Prebedrow;
  
    v_出院科室id := r_Prebedrow.出院科室id;
    v_病区id     := r_Prebedrow.当前病区id;
    v_原床号1    := r_Prebedrow.床号;
    v_当前床号1  := r_Prebedrow.出院病床;
  
    For r_Prebedpati In c_Prebedpati(v_出院科室id, v_病区id, v_原床号1) Loop
      v_病人id    := r_Prebedpati.病人id;
      v_主页id    := r_Prebedpati.主页id;
      v_原床号2   := r_Prebedpati.床号;
      v_当前床号2 := r_Prebedpati.出院病床;
    
      If v_病人id <> 0 And v_主页id <> 0 And v_原床号1 = v_当前床号2 And v_原床号2 = v_当前床号1 Then
        v_撤销方式 := '床位对换';
        Select 险类 Into v_险类 From 病案主页 Where 病人id = v_病人id And 主页id = v_主页id;
        If v_险类 Is Null Then
          Zl_病人变动记录_Undo(v_病人id, v_主页id, 操作员编号_In, 操作员姓名_In, Null, 床号_In, 主床位_In, v_撤销方式);
        Else
          Zl_病人变动记录_Undo(v_病人id, v_主页id, 操作员编号_In, 操作员姓名_In, '1', 床号_In, 主床位_In, v_撤销方式);
        End If;
      End If;
    
      --只对最近一次床位是对方床位的记录进行处理
      Exit;
    End Loop;
  End If;

  If r_Curlogrow.终止时间 Is Null And r_Curlogrow.开始时间 Is Null And r_Curlogrow.开始原因 = 3 And v_撤销方式 = '转科' Then
    --撤消转科(标志)
    Delete From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Null And 终止时间 Is Null And 开始原因 = 3;
  
    Update 病案主页 Set 状态 = 0 Where 病人id = 病人id_In And 主页id = 主页id_In;
  
    Close c_Curlog;
  Elsif r_Curlogrow.终止时间 Is Null And r_Curlogrow.开始时间 Is Null And r_Curlogrow.开始原因 = 15 And v_撤销方式 = '转病区' Then
    --撤消转科(标志)
    Delete From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Null And 终止时间 Is Null And 开始原因 = 15;
  
    Update 病案主页 Set 状态 = 0 Where 病人id = 病人id_In And 主页id = 主页id_In;
  
    Close c_Curlog;
  Elsif r_Curlogrow.终止时间 Is Not Null And r_Curlogrow.终止原因 = 1 And v_撤销方式 = '出院' Then
    --撤消出院
    v_开始时间     := r_Curlogrow.终止时间; --新增的变动记录的开始时间
    v_Auto开始时间 := r_Curautologrow.终止时间;
    Select Zl_住院日报_Count(r_Curlogrow.科室id, r_Curlogrow.终止时间) Into v_Count From Dual;
    If v_Count > 0 Then
      v_Error := '[ZLSOFT]已产生业务时间内的住院日报,不能办理该业务![ZLSOFT]';
      Raise Err_Custom;
    End If;
    --是否进行过电子病案审查
    Select Nvl(病案状态, 0) Into v_病案状态 From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
    If v_病案状态 Not In (0, 2) Then
      v_Error := '[ZLSOFT]病人的电子病案已提交审查，不能再撤消出院。[ZLSOFT]';
      Close c_Curlog;
      Raise Err_Custom;
    End If;
  
    --删除病历书写时机
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '出院', r_Curlogrow.科室id);
  
    --恢复入院
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Not Null And 终止原因 = 1;
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Not Null And 终止原因 = 1;
  
    Select 开始原因
    Into v_开始原因
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And Nvl(附加床位, 0) = 0;
  
    Update 病案主页
    Set 状态 = Decode(v_开始原因, 10, 3, 状态), 出院日期 = Null, 出院方式 = Null, 随诊标志 = Null, 随诊期限 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In;
    --处理床位
    If 床号_In Is Null Then
      --原床位没有被占用,家庭病床也不会被占用(程序中已判断被占用情况,占用会传入床号_In)
      Close c_Curlog;
      For r_Curlogrow In c_Curlog Loop
        If r_Curlogrow.床号 Is Not Null Then
          --检查床位
          Select Count(*)
          Into v_Count
          From 床位状况记录
          Where 病区id = r_Curlogrow.病区id And 床号 = r_Curlogrow.床号 And 状态 = '空床';
          If v_Count = 0 Then
            v_Error := '[ZLSOFT]操作失败,床位 ' || r_Curlogrow.床号 || ' 不是空床！[ZLSOFT]';
            Raise Err_Custom;
          End If;
          --重新占用床位
          Update 床位状况记录
          Set 状态 = '占用', 病人id = 病人id_In, 等级id = r_Curlogrow.床位等级id, 科室id = r_Curlogrow.科室id --强行恢复以前的科室,共用床也不用处理了。
          Where 病区id = r_Curlogrow.病区id And 床号 = r_Curlogrow.床号;
        End If;
      
        If Nvl(r_Curlogrow.附加床位, 0) = 0 Then
          Update 病人信息
          Set 出院时间 = Null, 当前病区id = r_Curlogrow.病区id, 当前科室id = r_Curlogrow.科室id, 当前床号 = r_Curlogrow.床号, 在院 = 1
          Where 病人id = 病人id_In;
        
          --更新在院病人
          Begin
            Update 在院病人
            Set 病区id = Nvl(r_Curlogrow.病区id, 0), 科室id = r_Curlogrow.科室id
            Where 病人id = 病人id_In;
            If Sql%RowCount = 0 Then
              Insert Into 在院病人
                (病人id, 科室id, 病区id, 主页id)
              Values
                (病人id_In, r_Curlogrow.科室id, Nvl(r_Curlogrow.病区id, 0), Nvl(主页id_In, 0));
            End If;
          Exception
            When Others Then
              Null;
          End;
        
        End If;
      End Loop;
    Else
      --原床位被占用，传入新安排的床位,入住一张或多张病床病床
      v_床号串 := 床号_In || ',';
      --如果病人出院前状态为预出院，则撤消预出院
      If v_开始原因 = 10 Then
        --撤消预出院
        Update 病案主页 Set 状态 = 0 Where 病人id = 病人id_In And 主页id = 主页id_In;
        --恢复变动
        Delete From 病人变动记录
        Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 10 And 终止时间 Is Null;
      
        Update 病人变动记录
        Set 终止时间 = v_开始时间, 终止原因 = 4, 终止人员 = 操作员姓名_In,
            上次计算时间 = Decode(Sign(Nvl(上次计算时间, v_开始时间) - v_开始时间), 1, Null, 上次计算时间)
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 10 And 终止时间 = r_Curlogrow.开始时间;
      Else
        Update 病人变动记录
        Set 终止时间 = v_开始时间, 终止原因 = 4, 终止人员 = 操作员姓名_In,
            上次计算时间 = Decode(Sign(Nvl(上次计算时间, v_开始时间) - v_开始时间), 1, Null, 上次计算时间)
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
      End If;
    
      Update 病人自动计算
      Set 终止时间 = v_Auto开始时间, 终止原因 = 4, 终止人员 = 操作员姓名_In,
          上次计算时间 = Decode(Sign(Nvl(上次计算时间, v_开始时间) - v_开始时间), 1, Null, 上次计算时间)
      Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 性质 In (2, 3);
    
      While v_床号串 Is Not Null Loop
        v_床号 := Substr(v_床号串, 1, Instr(v_床号串, ',') - 1);
        --原始床位等级与新床位等级及数量在程序中判断
        --检查床位
        Select Count(*)
        Into v_Count
        From 床位状况记录
        Where 病区id = r_Curlogrow.病区id And 床号 = v_床号 And 状态 = '空床';
        If v_Count = 0 Then
          v_Error := '操作失败,床位 ' || v_床号 || ' 不是空床！';
          Close c_Curlog;
          Raise Err_Custom;
        End If;
        --更新床位状况记录
        Update 床位状况记录
        Set 状态 = '占用', 病人id = 病人id_In, 科室id = r_Curlogrow.科室id
        Where 病区id = r_Curlogrow.病区id And 床号 = v_床号;
      
        Select 等级id Into v_床位等级id From 床位状况记录 Where 病区id = r_Curlogrow.病区id And 床号 = v_床号;
        ----新增原因为4
        Insert Into 病人变动记录
          (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
           操作员姓名)
        Values
          (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, v_开始时间, 4, Decode(主床位_In, v_床号, 0, 1), r_Curlogrow.病区id,
           r_Curlogrow.科室id, r_Curlogrow.医疗小组id, r_Curlogrow.护理等级id, v_床位等级id, v_床号, r_Curlogrow.责任护士, r_Curlogrow.经治医师,
           r_Curlogrow.主治医师, r_Curlogrow.主任医师, r_Curlogrow.病情, 操作员编号_In, 操作员姓名_In);
        Insert Into 病人自动计算
          (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号, 操作员姓名)
        Values
          (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, v_Auto开始时间, 4, 2, Decode(主床位_In, v_床号, 0, 1), r_Curautologrow.病区id,
           r_Curautologrow.科室id, v_床位等级id, v_床号, 操作员编号_In, 操作员姓名_In);
        Insert Into 病人自动计算
          (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号, 操作员姓名)
        Values
          (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, v_Auto开始时间, 4, 3, Decode(主床位_In, v_床号, 0, 1), r_Curautologrow.病区id,
           r_Curautologrow.科室id, v_床位等级id, v_床号, 操作员编号_In, 操作员姓名_In);
      
        v_床号串 := Substr(v_床号串, Instr(v_床号串, ',') + 1);
      End Loop;
      --更新病人信息
      Update 病人信息
      Set 出院时间 = Null, 当前病区id = r_Curlogrow.病区id, 当前科室id = r_Curlogrow.科室id, 当前床号 = 主床位_In, 在院 = 1
      Where 病人id = 病人id_In;
    
      --更新在院病人
      Begin
        Update 在院病人 Set 病区id = Nvl(r_Curlogrow.病区id, 0), 科室id = r_Curlogrow.科室id Where 病人id = 病人id_In;
        If Sql%RowCount = 0 Then
          Insert Into 在院病人
            (病人id, 科室id, 病区id, 主页id)
          Values
            (病人id_In, r_Curlogrow.科室id, Nvl(r_Curlogrow.病区id, 0), Nvl(主页id_In, 0));
        End If;
      Exception
        When Others Then
          Null;
      End;
    
      --更新病案主页出院病床
      Update 病案主页 Set 出院病床 = 主床位_In Where 病人id = 病人id_In And 主页id = 主页id_In;
      Close c_Curlog;
    End If;
    --删除出院诊断 保留该诊断信息
    --Delete From 病人诊断记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 in (3,13) And 记录来源 = 2;
  
    Begin
      Select 共享号 Into v_共享号 From zlSystems Where Floor(编号 / 100) = 3;
    Exception
      When Others Then
        Null;
    End;
    --删除该病人的随诊记录
    If v_共享号 = 100 Then
      Execute Immediate 'Delete From 随诊记录 Where 病人id =:1 And 主页id =:2'
        Using 病人id_In, 主页id_In;
    End If;
  Elsif r_Curlogrow.开始原因 = 1 And v_撤销方式 = '入院入住' Then
    v_Error := Checkpatiadvice(病人id_In, 主页id_In, 撤销方式_In);
    If v_Error Is Not Null Then
      Raise Err_Custom;
    End If;
    --撤消入科(入院同时入科)
    v_开始时间 := r_Curlogrow.开始时间;
    Select Zl_住院日报_Count(r_Curlogrow.科室id, v_开始时间) Into v_Count From Dual;
    If v_Count > 0 Then
      v_Error := '[ZLSOFT]已产生业务时间内的住院日报,不能办理该业务![ZLSOFT]';
      Raise Err_Custom;
    End If;
  
    Select Count(1)
    Into v_Count
    From 病人护理文件 A, 病人护理数据 B
    Where a.Id = b.文件id And 病人id = 病人id_In And 主页id = 主页id_In And 科室id = r_Curlogrow.科室id And Rownum < 2;
    If v_Count > 0 Then
      v_Error := '[ZLSOFT]病人已产生有数据的护理文件，不能办理该业务！[ZLSOFT]';
      Raise Err_Custom;
    End If;
    Delete From 病人护理文件 Where 病人id = 病人id_In And 主页id = 主页id_In And 科室id = r_Curlogrow.科室id;
  
    Close c_Curlog;
  
    If 数据_In = '1' Then
      For r_Fee In (Select NO
                    From 住院费用记录
                    Where 病人id = 病人id_In And 主页id = 主页id_In And Mod(记录性质, 10) = 3 And 登记时间 >= v_开始时间
                    Group By NO, 序号, Mod(记录性质, 10)
                    Having Sum(结帐金额) <> 0) Loop
        v_Error := '[ZLSOFT]该病人的自动记帐费用已结帐,不能进行撤销操作！[ZLSOFT]';
        Raise Err_Custom;
      End Loop;
    End If;
    --退除当前床位
    For r_Curlogrow In c_Curlog Loop
      If r_Curlogrow.床号 Is Not Null Then
        Update 床位状况记录
        Set 状态 = '空床', 病人id = Null, 科室id = Decode(共用, 1, Null, 科室id)
        Where 病区id = r_Curlogrow.病区id And 床号 = r_Curlogrow.床号;
      End If;
    End Loop;
    --相关信息还原
    Update 病案主页 Set 入院病床 = Null, 出院病床 = Null, 状态 = 1 Where 病人id = 病人id_In And 主页id = 主页id_In;
  
    Update 病人信息 Set 当前床号 = Null Where 病人id = 病人id_In;
  
    --恢复变动(入院同时入科不会有包床)
    --因为是同一条记录中的撤消,所以不处理人员
    Update 病人变动记录
    Set 床位等级id = Null, 床号 = Null, 责任护士 = Null, 经治医师 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 1 And 终止时间 Is Null;
  
    Update 病人自动计算
    Set 床位等级id = Null, 床号 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 1 And 终止时间 Is Null;
  Elsif r_Curlogrow.开始原因 = 2 And v_撤销方式 = '入住' Then
    v_Error := Checkpatiadvice(病人id_In, 主页id_In, 撤销方式_In);
    If v_Error Is Not Null Then
      Raise Err_Custom;
    End If;
    --撤消入院入科
    v_开始时间       := r_Curlogrow.开始时间;
    v_Auto开始时间   := r_Curautologrow.开始时间;
    v_Autohl开始时间 := r_Curautohllogrow.开始时间;
    Select Zl_住院日报_Count(r_Curlogrow.科室id, v_开始时间) Into v_Count From Dual;
    If v_Count > 0 Then
      v_Error := '[ZLSOFT]已产生业务时间内的住院日报,不能办理该业务![ZLSOFT]';
      Raise Err_Custom;
    End If;
  
    Select Count(1)
    Into v_Count
    From 病人护理文件 A, 病人护理数据 B
    Where a.Id = b.文件id And 病人id = 病人id_In And 主页id = 主页id_In And 科室id = r_Curlogrow.科室id And Rownum < 2;
    If v_Count > 0 Then
      v_Error := '[ZLSOFT]病人已产生有数据的护理文件，不能办理该业务！[ZLSOFT]';
      Raise Err_Custom;
    End If;
    Delete From 病人护理文件 Where 病人id = 病人id_In And 主页id = 主页id_In And 科室id = r_Curlogrow.科室id;
  
    If 数据_In = '1' Then
      For r_Fee In (Select NO
                    From 住院费用记录
                    Where 病人id = 病人id_In And 主页id = 主页id_In And Mod(记录性质, 10) = 3 And 登记时间 >= v_开始时间
                    Group By NO, 序号, Mod(记录性质, 10)
                    Having Sum(结帐金额) <> 0) Loop
        v_Error := '[ZLSOFT]该病人的自动记帐费用已结帐,不能进行撤销操作！[ZLSOFT]';
        Raise Err_Custom;
      End Loop;
    End If;
    --删除病历书写时机
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '入院', r_Curlogrow.科室id);
    Close c_Curlog;
    --退除当前床位
    For r_Curlogrow In c_Curlog Loop
      If r_Curlogrow.床号 Is Not Null Then
        Update 床位状况记录
        Set 状态 = '空床', 病人id = Null, 科室id = Decode(共用, 1, Null, 科室id)
        Where 病区id = r_Curlogrow.病区id And 床号 = r_Curlogrow.床号;
      End If;
    End Loop;
    --相关信息还原
    Open c_Prelog(v_开始时间, 2);
    Fetch c_Prelog
      Into r_Prelogrow;
    Update 病案主页
    Set 入院病床 = Null, 出院病床 = Null, 状态 = 1, 当前病况 = r_Prelogrow.病情, 入院病况 = r_Prelogrow.病情, 医疗小组id = r_Prelogrow.医疗小组id,
        护理等级id = r_Prelogrow.护理等级id
    Where 病人id = 病人id_In And 主页id = 主页id_In;
    Close c_Prelog;
  
    Update 病人信息 Set 当前床号 = Null Where 病人id = 病人id_In;
    Delete 病案主页从表
    Where 病人id = 病人id_In And 主页id = 主页id_In And (信息名 = '主治医师' Or 信息名 = '主任医师');
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 2 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 2 And 终止时间 = v_开始时间
    Returning 病区id Into v_病区id;
    --入院时未指定病区,撤销入住时将病区清空
    If Nvl(v_病区id, 0) = 0 Then
      Update 病人信息 Set 当前病区id = Null Where 病人id = 病人id_In;
      Update 病案主页 Set 当前病区id = Null, 入院病区id = Null Where 病人id = 病人id_In And 主页id = 主页id_In;
      Update 在院病人 Set 病区id = 0 Where 病人id = 病人id_In;
    End If;
  
    Delete From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 2 And 终止时间 Is Null;
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 2 And 终止时间 = v_Auto开始时间 And 性质 In (2, 3);
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 2 And 终止时间 = v_Autohl开始时间 And 性质 = 1;
  Elsif r_Curlogrow.开始原因 = 3 And v_撤销方式 = '转科入住' Then
    --撤消转科入科
    v_开始时间       := r_Curlogrow.开始时间;
    v_Auto开始时间   := r_Curautologrow.开始时间;
    v_Autohl开始时间 := r_Curautohllogrow.开始时间;
    Select Zl_住院日报_Count(r_Curlogrow.科室id, v_开始时间) Into v_Count From Dual;
    If v_Count > 0 Then
      v_Error := '[ZLSOFT]已产生业务时间内的住院日报,不能办理该业务![ZLSOFT]';
      Raise Err_Custom;
    End If;
  
    Select Count(1)
    Into v_Count
    From 病人护理文件
    Where 病人id = 病人id_In And 主页id = 主页id_In And 科室id = r_Curlogrow.科室id And 创建时间 >= r_Curlogrow.开始时间;
    If v_Count > 0 Then
      v_Error := '[ZLSOFT]病人已产生护理文件，不能办理该业务！[ZLSOFT]';
      Raise Err_Custom;
    End If;
  
    If 数据_In = '1' Then
      For r_Fee In (Select NO
                    From 住院费用记录
                    Where 病人id = 病人id_In And 主页id = 主页id_In And Mod(记录性质, 10) = 3 And 登记时间 >= v_开始时间
                    Group By NO, 序号, Mod(记录性质, 10)
                    Having Sum(结帐金额) <> 0) Loop
        v_Error := '[ZLSOFT]该病人的自动记帐费用已结帐,不能进行撤销操作！[ZLSOFT]';
        Raise Err_Custom;
      End Loop;
    End If;
  
    --删除病历书写时机
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '转科', r_Curlogrow.科室id);
    Close c_Curlog;
    --退除当前床位
    For r_Curlogrow In c_Curlog Loop
      If r_Curlogrow.床号 Is Not Null Then
        Update 床位状况记录
        Set 状态 = '空床', 病人id = Null, 科室id = Decode(共用, 1, Null, 科室id)
        Where 病区id = r_Curlogrow.病区id And 床号 = r_Curlogrow.床号;
      End If;
    End Loop;
    --检查及还原原床位
    For r_Prelogrow In c_Prelog(v_开始时间, 3) Loop
      d_开始时间 := r_Prelogrow.开始时间;
      If r_Prelogrow.床号 Is Not Null Then
        Select Count(*)
        Into v_Count
        From 床位状况记录
        Where 病区id = r_Prelogrow.病区id And 床号 = r_Prelogrow.床号 And 状态 = '空床';
        If v_Count = 0 Then
          v_Error := '[ZLSOFT]病人转入该科室前的床位 ' || r_Prelogrow.床号 || ' 当前非空床或已经撤消！[ZLSOFT]';
          Raise Err_Custom;
        End If;
      
        Update 床位状况记录
        Set 状态 = '占用', 病人id = 病人id_In, 等级id = r_Prelogrow.床位等级id, 科室id = r_Prelogrow.科室id --强行恢复以前的科室,共用床也不用处理了。
        Where 病区id = r_Prelogrow.病区id And 床号 = r_Prelogrow.床号;
      End If;
      --相关信息还原
      If Nvl(r_Prelogrow.附加床位, 0) = 0 Then
        --判断是否有婴儿
        Select Count(1) Into v_Count From 病人新生儿记录 Where 病人id = 病人id_In And 主页id = 主页id_In;
        If v_Count > 0 Then
          Select 母婴转科标志 Into v_母婴转科标志 From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
          If v_母婴转科标志 Is Not Null Then
            If Substr(v_母婴转科标志, Length(v_母婴转科标志)) = '1' Then
              --如果是1表示母亲和婴儿未分开，则清空“病案主页.婴儿科室ID”和”病案主页.婴儿病区ID”；
              Update 病案主页 Set 婴儿科室id = Null, 婴儿病区id = Null Where 病人id = 病人id_In And 主页id = 主页id_In;
              If Length(v_母婴转科标志) > 1 Then
                v_母婴转科标志 := Substr(v_母婴转科标志, 1, Length(v_母婴转科标志) - 1);
              Else
                v_母婴转科标志 := '';
              End If;
            Else
              --如果是0，表示是上次转科是母亲单独转走的，则重新将原产科科室和病区填写到“病案主页.婴儿科室ID”和”病案主页.婴儿病区ID”（从病人变动记录中取），并清除最后一位标识
              If Length(v_母婴转科标志) > 1 Then
                v_母婴转科标志 := Substr(v_母婴转科标志, 1, Length(v_母婴转科标志) - 1);
                --查看上一次转科的标识
                If Substr(v_母婴转科标志, Length(v_母婴转科标志)) = '1' Then
                  Update 病案主页
                  Set 婴儿科室id = Null, 婴儿病区id = Null
                  Where 病人id = 病人id_In And 主页id = 主页id_In;
                Else
                  --取出转科前的婴儿科室病区ID
                  v_Tmp   := v_母婴转科标志;
                  v_Count := 1;
                  While v_Tmp Is Not Null Loop
                    v_Count := v_Count + 1;
                    If Substr(v_Tmp, Length(v_Tmp)) = '1' Then
                      Select Max(a.科室id) As 科室id, Max(a.病区id) As 科室id
                      Into n_原科室id, n_原病区id
                      From (Select 科室id, 病区id, Rownum As 序号
                             From (Select 科室id, 病区id
                                    From 病人变动记录
                                    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 3 And 附加床位 = 0
                                    Order By 开始时间 Desc)) A
                      Where 序号 = v_Count;
                    End If;
                    If Length(v_Tmp) = 1 Then
                      v_Tmp := '';
                    Else
                      v_Tmp := Substr(v_Tmp, 1, Length(v_Tmp) - 1);
                    End If;
                  End Loop;
                  If Nvl(n_原科室id, 0) = 0 Then
                    --如果没有找到，则取入院科室
                    Select Max(b.科室id), Max(b.病区id)
                    Into n_原科室id, n_原病区id
                    From 病人变动记录 B
                    Where b.病人id = 病人id_In And b.主页id = 主页id_In And b.科室id Is Not Null And b.病区id Is Not Null And
                          b.开始时间 = (Select Min(a.开始时间)
                                    From 病人变动记录 A
                                    Where a.病人id = b.病人id And a.主页id = b.主页id And a.科室id Is Not Null And
                                          a.病区id Is Not Null And a.附加床位 = 0);
                  End If;
                
                  If Nvl(n_原科室id, 0) <> 0 Then
                    Update 病案主页
                    Set 婴儿科室id = n_原科室id, 婴儿病区id = n_原病区id
                    Where 病人id = 病人id_In And 主页id = 主页id_In;
                  Else
                    --之前没有转科记录,清空婴儿科室ID和婴儿病区ID
                    Update 病案主页
                    Set 婴儿科室id = Null, 婴儿病区id = Null
                    Where 病人id = 病人id_In And 主页id = 主页id_In;
                  End If;
                End If;
              Else
                --只有这一次转科,回退后清空婴儿科室病区ID
                v_母婴转科标志 := '';
                Update 病案主页
                Set 婴儿科室id = Null, 婴儿病区id = Null
                Where 病人id = 病人id_In And 主页id = 主页id_In;
              End If;
            End If;
            --去除最后一位标识
            Update 病案主页 Set 母婴转科标志 = v_母婴转科标志 Where 病人id = 病人id_In And 主页id = 主页id_In;
          End If;
        
        End If;
      
        Update 病案主页
        Set 状态 = 2, 当前病区id = r_Prelogrow.病区id, 出院科室id = r_Prelogrow.科室id, 医疗小组id = r_Prelogrow.医疗小组id,
            出院病床 = r_Prelogrow.床号, 护理等级id = r_Prelogrow.护理等级id, 责任护士 = r_Prelogrow.责任护士, 住院医师 = r_Prelogrow.经治医师,
            当前病况 = r_Curlogrow.病情
        Where 病人id = 病人id_In And 主页id = 主页id_In;
      
        Update 病案主页从表
        Set 信息值 = r_Prelogrow.主治医师
        Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主治医师';
        Update 病案主页从表
        Set 信息值 = r_Prelogrow.主任医师
        Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主任医师';
      
        Update 病人信息
        Set 当前病区id = r_Prelogrow.病区id, 当前科室id = r_Prelogrow.科室id, 当前床号 = r_Prelogrow.床号
        Where 病人id = 病人id_In;
      
        --更新在院病人
        Update 在院病人 Set 病区id = Nvl(r_Prelogrow.病区id, 0), 科室id = r_Prelogrow.科室id Where 病人id = 病人id_In;
      
      End If;
    End Loop;
    --恢复变动(恢复到临时转科标记状态)
    Delete From 病人变动记录
    Where 附加床位 = 1 And 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 3 And 终止时间 Is Null;
  
    Delete From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 3 And 终止时间 Is Null;
  
    Select 终止人员
    Into v_终止人员
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 3 And 终止时间 = v_开始时间 And Nvl(附加床位, 0) = 0;
    --临时记录的操作员信息记录的是终止人员,因为没有记录终止人员编号,就不恢复
    Update 病人变动记录
    Set 开始时间 = Null, 医疗小组id = Null, 护理等级id = Null, 床位等级id = Null, 床号 = Null, 责任护士 = Null, 经治医师 = Null, 操作员编号 = Null,
        操作员姓名 = v_终止人员, 上次计算时间 = Null, 病区id = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 3 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 3 And 终止时间 = v_开始时间 And 开始时间 = d_开始时间;
  
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 3 And 终止时间 = v_Auto开始时间 And 性质 In (2, 3);
  
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 3 And 终止时间 = v_Autohl开始时间 And 性质 = 1;
  
  Elsif r_Curlogrow.开始原因 = 4 And v_撤销方式 = '换床' Then
    --撤消换床
    v_开始时间     := r_Curlogrow.开始时间;
    v_Auto开始时间 := r_Curautologrow.开始时间;
    Close c_Curlog;
    If 数据_In = '1' Then
      For r_Fee In (Select NO
                    From 住院费用记录
                    Where 病人id = 病人id_In And 主页id = 主页id_In And Mod(记录性质, 10) = 3 And 登记时间 >= v_开始时间
                    Group By NO, 序号, Mod(记录性质, 10)
                    Having Sum(结帐金额) <> 0) Loop
        v_Error := '[ZLSOFT]该病人的自动记帐费用已结帐,不能进行撤销操作！[ZLSOFT]';
        Raise Err_Custom;
      End Loop;
    End If;
    --退除当前床位
    For r_Curlogrow In c_Curlog Loop
      If r_Curlogrow.床号 Is Not Null Then
        Update 床位状况记录
        Set 状态 = '空床', 病人id = Null, 科室id = Decode(共用, 1, Null, 科室id)
        Where 病区id = r_Curlogrow.病区id And 床号 = r_Curlogrow.床号;
      End If;
    End Loop;
    --检查及还原原床位
    For r_Prelogrow In c_Prelog(v_开始时间, 4) Loop
      d_开始时间 := r_Prelogrow.开始时间;
      If r_Prelogrow.床号 Is Not Null Then
        Select Count(*)
        Into v_Count
        From 床位状况记录
        Where 病区id = r_Prelogrow.病区id And 床号 = r_Prelogrow.床号 And 状态 = '空床';
        If v_Count = 0 Then
          v_Error := '[ZLSOFT]病人最近一次换床前所入住的床位 ' || r_Prelogrow.床号 || ' 当前非空床或已经撤消！[ZLSOFT]';
          Raise Err_Custom;
        End If;
      
        Update 床位状况记录
        Set 状态 = '占用', 病人id = 病人id_In, 等级id = r_Prelogrow.床位等级id, 科室id = Decode(共用, 1, r_Prelogrow.科室id, 科室id)
        Where 病区id = r_Prelogrow.病区id And 床号 = r_Prelogrow.床号;
      End If;
      --病人信息、病案主页,仅当病区与科室独立时,换床才可以换病区,此处为简化判断,统一还原病区
      If Nvl(r_Prelogrow.附加床位, 0) = 0 Then
        Update 病案主页
        Set 出院病床 = r_Prelogrow.床号, 当前病区id = r_Prelogrow.病区id
        Where 病人id = 病人id_In And 主页id = 主页id_In;
      
        Update 病人信息 Set 当前床号 = r_Prelogrow.床号, 当前病区id = r_Prelogrow.病区id Where 病人id = 病人id_In;
        --更新在院病人
        Update 在院病人 Set 病区id = Nvl(r_Prelogrow.病区id, 0) Where 病人id = 病人id_In;
      End If;
    End Loop;
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 4 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 4 And 终止时间 = v_开始时间 And 开始时间 = d_开始时间;
  
    Delete From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 4 And 终止时间 Is Null And 性质 In (2, 3);
  
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 4 And 终止时间 = v_Auto开始时间 And 性质 In (2, 3);
  Elsif r_Curlogrow.开始原因 = 4 And v_撤销方式 = '床位对换' Then
    --撤消床位对换
    v_开始时间     := r_Curlogrow.开始时间;
    v_Auto开始时间 := r_Curautologrow.开始时间;
    Select 姓名 Into v_姓名 From 病人信息 Where 病人id = 病人id_In;
    Close c_Curlog;
    If 数据_In = '1' Then
      For r_Fee In (Select NO
                    From 住院费用记录
                    Where 病人id = 病人id_In And 主页id = 主页id_In And Mod(记录性质, 10) = 3 And 登记时间 >= v_开始时间
                    Group By NO, 序号, Mod(记录性质, 10)
                    Having Sum(结帐金额) <> 0) Loop
        v_Error := '[ZLSOFT]病人 ' || v_姓名 || ' 的自动记帐费用已结帐,不能进行撤销操作！[ZLSOFT]';
        Raise Err_Custom;
      End Loop;
    End If;
    --退除当前床位
    --检查及还原原床位
    For r_Prelogrow In c_Prelog(v_开始时间, 4) Loop
      d_开始时间 := r_Prelogrow.开始时间;
      If r_Prelogrow.床号 Is Not Null Then
        Update 床位状况记录
        Set 状态 = '占用', 病人id = 病人id_In, 等级id = r_Prelogrow.床位等级id, 科室id = Decode(共用, 1, r_Prelogrow.科室id, 科室id)
        Where 病区id = r_Prelogrow.病区id And 床号 = r_Prelogrow.床号;
      End If;
      --病人信息、病案主页,仅当病区与科室独立时,换床才可以换病区,此处为简化判断,统一还原病区
      If Nvl(r_Prelogrow.附加床位, 0) = 0 Then
        Update 病案主页
        Set 出院病床 = r_Prelogrow.床号, 当前病区id = r_Prelogrow.病区id
        Where 病人id = 病人id_In And 主页id = 主页id_In;
      
        Update 病人信息 Set 当前床号 = r_Prelogrow.床号, 当前病区id = r_Prelogrow.病区id Where 病人id = 病人id_In;
        --更新在院病人
        Update 在院病人 Set 病区id = Nvl(r_Prelogrow.病区id, 0) Where 病人id = 病人id_In;
      End If;
    End Loop;
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 4 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 4 And 终止时间 = v_开始时间 And 开始时间 = d_开始时间;
  
    Delete From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 4 And 终止时间 Is Null And 性质 In (2, 3);
  
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 4 And 终止时间 = v_Auto开始时间 And 性质 In (2, 3);
  Elsif r_Curlogrow.开始原因 = 5 And v_撤销方式 = '床位等级变动' Then
    --撤消床位等级变动
    If 数据_In = '1' Then
      For r_Fee In (Select NO
                    From 住院费用记录
                    Where 病人id = 病人id_In And 主页id = 主页id_In And Mod(记录性质, 10) = 3 And 收费细目id = r_Curlogrow.床位等级id And
                          登记时间 >= r_Curlogrow.开始时间
                    Group By NO, 序号, Mod(记录性质, 10)
                    Having Sum(结帐金额) <> 0) Loop
        Close c_Curlog;
        v_Error := '[ZLSOFT]该病人的自动记帐费用已结帐,不能进行撤销操作！[ZLSOFT]';
        Raise Err_Custom;
      End Loop;
    End If;
    --还原原床位的等级
    For r_Prelogrow In c_Prelog(r_Curlogrow.开始时间, 5) Loop
      d_开始时间 := r_Prelogrow.开始时间;
      If r_Prelogrow.床号 Is Not Null Then
        Update 床位状况记录
        Set 等级id = r_Prelogrow.床位等级id
        Where 病区id = r_Prelogrow.病区id And 床号 = r_Prelogrow.床号;
      End If;
    End Loop;
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 5 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 5 And 终止时间 = r_Curlogrow.开始时间 And 开始时间 = d_开始时间;
  
    Delete From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 5 And 终止时间 Is Null And 性质 In (2, 3);
  
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 5 And 终止时间 = r_Curautologrow.开始时间 And 性质 In (2, 3);
  
    Close c_Curlog;
  Elsif r_Curlogrow.开始原因 = 6 And v_撤销方式 = '护理等级变动' Then
    --撤消护理等级变动
    If 数据_In = '1' Then
      For r_Fee In (Select NO
                    From 住院费用记录
                    Where 病人id = 病人id_In And 主页id = 主页id_In And Mod(记录性质, 10) = 3 And 收费细目id = r_Curlogrow.护理等级id And
                          登记时间 >= r_Curlogrow.开始时间
                    Group By NO, 序号, Mod(记录性质, 10)
                    Having Sum(结帐金额) <> 0) Loop
        Close c_Curlog;
        v_Error := '[ZLSOFT]该病人的自动记帐费用已结帐,不能进行撤销操作！[ZLSOFT]';
        Raise Err_Custom;
      End Loop;
    End If;
  
    Open c_Prelog(r_Curlogrow.开始时间, 6);
    Fetch c_Prelog
      Into r_Prelogrow;
    --恢复原护理等级
    Update 病案主页 Set 护理等级id = r_Prelogrow.护理等级id Where 病人id = 病人id_In And 主页id = 主页id_In;
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 6 And 终止时间 Is Null;
    Delete From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 6 And 终止时间 Is Null And 性质 = 1;
  
    --医嘱产生的护理等级变动没有记录秒，可能前一等级的停止时间与当前等级的开始时间是同一分钟，所以要取max(id)
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 6 And 终止时间 = r_Curlogrow.开始时间 And 开始时间 = r_Prelogrow.开始时间;
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 6 And 终止时间 = r_Curautohllogrow.开始时间 And 性质 = 1;
  
    Close c_Prelog;
    Close c_Curlog;
  Elsif r_Curlogrow.开始原因 = 7 And v_撤销方式 = '经治医师改变' Then
    --删除病历书写时机
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '交班', r_Curlogrow.科室id);
    --撤消经治医师改变
    Open c_Prelog(r_Curlogrow.开始时间, 7);
    Fetch c_Prelog
      Into r_Prelogrow;
    --恢复原医师
    Update 病案主页 Set 住院医师 = r_Prelogrow.经治医师 Where 病人id = 病人id_In And 主页id = 主页id_In;
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 7 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 7 And 终止时间 = r_Curlogrow.开始时间 And 开始时间 = r_Prelogrow.开始时间;
  
    Close c_Prelog;
    Close c_Curlog;
  Elsif r_Curlogrow.开始原因 = 8 And v_撤销方式 = '责任护士改变' Then
    --撤消责任护士改变
    Open c_Prelog(r_Curlogrow.开始时间, 8);
    Fetch c_Prelog
      Into r_Prelogrow;
    --恢复原责任护士
    Update 病案主页 Set 责任护士 = r_Prelogrow.责任护士 Where 病人id = 病人id_In And 主页id = 主页id_In;
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 8 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 8 And 终止时间 = r_Curlogrow.开始时间 And 开始时间 = r_Prelogrow.开始时间;
  
    Close c_Prelog;
    Close c_Curlog;
  Elsif r_Curlogrow.开始原因 = 9 And v_撤销方式 = '转为住院病人' Then
    --撤消转为住院病人
    --删除病历书写时机
    Open c_Prelog(r_Curlogrow.开始时间, 9);
    Fetch c_Prelog
      Into r_Prelogrow;
  
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '入院', r_Curlogrow.科室id);
    Update 病案主页 Set 病人性质 = 2 Where 病人id = 病人id_In And 主页id = 主页id_In;
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 9 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 9 And 终止时间 = r_Curlogrow.开始时间 And 开始时间 = r_Prelogrow.开始时间;
  
    If 主页id_In = 1 And Nvl(数据_In, '0') = '1' Then
      Update 病人信息 Set 住院号 = Null Where 病人id = 病人id_In;
      Update 病案主页 Set 住院号 = Null Where 病人id = 病人id_In;
    End If;
  
    Close c_Curlog;
    Close c_Prelog;
  Elsif r_Curlogrow.开始原因 = 10 And v_撤销方式 = '预出院' Then
    --撤消预出院
    --删除病历书写时机
    Open c_Prelog(r_Curlogrow.开始时间, 10);
    Fetch c_Prelog
      Into r_Prelogrow;
  
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '出院', r_Curlogrow.科室id);
    --恢复住院状态
    Update 病案主页 Set 状态 = 0 Where 病人id = 病人id_In And 主页id = 主页id_In;
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 10 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 上次计算时间 = Null, 终止人员 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 10 And 终止时间 = r_Curlogrow.开始时间 And 开始时间 = r_Prelogrow.开始时间;
    
    --恢复变动
    Delete From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 10 And 终止时间 Is Null;
  
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 上次计算时间 = Null, 终止人员 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 10 And 终止时间 = r_CurAutologrow.开始时间 And 性质 In (2, 3);
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 上次计算时间 = Null, 终止人员 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 10 And 终止时间 = r_CurAutohllogrow.开始时间 And 性质 = 1;
  
    Close c_Curlog;
    Close c_Prelog;
  Elsif r_Curlogrow.开始原因 = 11 And v_撤销方式 = '主治医师变动' Then
    --撤消主治医师改变
    Open c_Prelog(r_Curlogrow.开始时间, 11);
    Fetch c_Prelog
      Into r_Prelogrow;
    --恢复原主治医师
    Update 病案主页从表
    Set 信息值 = r_Prelogrow.主治医师
    Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主治医师';
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 11 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 11 And 终止时间 = r_Curlogrow.开始时间 And 开始时间 = r_Prelogrow.开始时间;
  
    Close c_Prelog;
    Close c_Curlog;
  Elsif r_Curlogrow.开始原因 = 12 And v_撤销方式 = '主任医师变动' Then
    --撤消主任医师改变
    Open c_Prelog(r_Curlogrow.开始时间, 12);
    Fetch c_Prelog
      Into r_Prelogrow;
    --恢复原主任医师
    Update 病案主页从表
    Set 信息值 = r_Prelogrow.主任医师
    Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主任医师';
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 12 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 12 And 终止时间 = r_Curlogrow.开始时间 And 开始时间 = r_Prelogrow.开始时间;
  
    Close c_Prelog;
    Close c_Curlog;
  Elsif r_Curlogrow.开始原因 = 13 And v_撤销方式 = '病况变动' Then
    --撤消病情改变
    Open c_Prelog(r_Curlogrow.开始时间, 13);
    Fetch c_Prelog
      Into r_Prelogrow;
    --恢复原病情
    Update 病案主页 Set 当前病况 = r_Prelogrow.病情 Where 病人id = 病人id_In And 主页id = 主页id_In;
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 13 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 13 And 终止时间 = r_Curlogrow.开始时间 And 开始时间 = r_Prelogrow.开始时间;
  
    Close c_Prelog;
    Close c_Curlog;
  
  Elsif r_Curlogrow.开始原因 = 14 And v_撤销方式 = '转医疗小组' Then
    --删除病历书写时机
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '交班', r_Curlogrow.科室id);
  
    --撤消医疗小组改变
    Open c_Prelog(r_Curlogrow.开始时间, 14);
    Fetch c_Prelog
      Into r_Prelogrow;
    --恢复原医疗小组
    Update 病案主页
    Set 医疗小组id = r_Prelogrow.医疗小组id, 住院医师 = r_Prelogrow.经治医师
    Where 病人id = 病人id_In And 主页id = 主页id_In;
    --恢复原主治医师
    Update 病案主页从表
    Set 信息值 = r_Prelogrow.主治医师
    Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主治医师';
  
    --恢复变动
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 14 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 14 And 终止时间 = r_Curlogrow.开始时间 And 开始时间 = r_Prelogrow.开始时间;
  
    Close c_Prelog;
    Close c_Curlog;
  Elsif r_Curlogrow.开始原因 = 15 And v_撤销方式 = '转病区入住' Then
    --撤消入病区
    v_开始时间       := r_Curlogrow.开始时间;
    v_Auto开始时间   := r_Curautologrow.开始时间;
    v_Autohl开始时间 := r_Curautohllogrow.开始时间;
    If 数据_In = '1' Then
      For r_Fee In (Select NO
                    From 住院费用记录
                    Where 病人id = 病人id_In And 主页id = 主页id_In And Mod(记录性质, 10) = 3 And 登记时间 >= v_开始时间
                    Group By NO, 序号, Mod(记录性质, 10)
                    Having Sum(结帐金额) <> 0) Loop
        v_Error := '[ZLSOFT]该病人的自动记帐费用已结帐,不能进行撤销操作！[ZLSOFT]';
        Raise Err_Custom;
      End Loop;
    End If;
  
    Open c_Prelog(v_开始时间, 15);
    Fetch c_Prelog
      Into r_Prelogrow;
  
    d_开始时间 := r_Prelogrow.开始时间;
    --对有效的医嘱(未停止、作废的长嘱，未发送的临嘱)，为原病区执行的，将执行科室自动更换为新的病区
    Update 病人医嘱记录
    Set 执行科室id = r_Prelogrow.病区id
    Where 病人id = 病人id_In And 主页id = 主页id_In And 执行科室id = r_Curlogrow.病区id And 医嘱状态 Not In (4, 8, 9) And 开嘱时间 < v_开始时间;
    --对未审核的记帐划价单，为原病区执行的，将执行科室自动更换为新的病区
    Update 住院费用记录
    Set 执行部门id = r_Prelogrow.病区id
    Where 病人id = 病人id_In And 主页id = 主页id_In And 执行部门id = r_Curlogrow.病区id And 记录状态 = 0;
    Close c_Prelog;
    Close c_Curlog;
  
    --退除当前床位
    For r_Curlogrow In c_Curlog Loop
      If r_Curlogrow.床号 Is Not Null Then
        Update 床位状况记录
        Set 状态 = '空床', 病人id = Null, 科室id = Decode(共用, 1, Null, 科室id)
        Where 病区id = r_Curlogrow.病区id And 床号 = r_Curlogrow.床号;
      End If;
    End Loop;
    --检查及还原原床位
    For r_Prelogrow In c_Prelog(v_开始时间, 15) Loop
      If r_Prelogrow.床号 Is Not Null Then
        Select Count(*)
        Into v_Count
        From 床位状况记录
        Where 病区id = r_Prelogrow.病区id And 床号 = r_Prelogrow.床号 And 状态 = '空床';
        If v_Count = 0 Then
          v_Error := '[ZLSOFT]病人转入该病区前的床位 ' || r_Prelogrow.床号 || ' 当前非空床或已经撤消！[ZLSOFT]';
          Raise Err_Custom;
        End If;
      
        Update 床位状况记录
        Set 状态 = '占用', 病人id = 病人id_In, 等级id = r_Prelogrow.床位等级id, 科室id = r_Prelogrow.科室id --强行恢复以前的科室,共用床也不用处理了。
        Where 病区id = r_Prelogrow.病区id And 床号 = r_Prelogrow.床号;
      End If;
      --相关信息还原
      If Nvl(r_Prelogrow.附加床位, 0) = 0 Then
        Update 病案主页
        Set 状态 = 2, 当前病区id = r_Prelogrow.病区id, 出院科室id = r_Prelogrow.科室id, 医疗小组id = r_Prelogrow.医疗小组id,
            出院病床 = r_Prelogrow.床号, 护理等级id = r_Prelogrow.护理等级id, 责任护士 = r_Prelogrow.责任护士, 住院医师 = r_Prelogrow.经治医师,
            当前病况 = r_Curlogrow.病情
        Where 病人id = 病人id_In And 主页id = 主页id_In;
      
        Update 病人信息 Set 当前病区id = r_Prelogrow.病区id, 当前床号 = r_Prelogrow.床号 Where 病人id = 病人id_In;
      
        --更新在院病人
        Update 在院病人 Set 病区id = Nvl(r_Prelogrow.病区id, 0) Where 病人id = 病人id_In;
      
      End If;
    End Loop;
  
    --恢复变动(恢复到临时转科标记状态)
    Delete From 病人变动记录
    Where 附加床位 = 1 And 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 15 And 终止时间 Is Null;
  
    Delete From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 15 And 终止时间 Is Null;
  
    Select 终止人员
    Into v_终止人员
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 15 And 终止时间 = v_开始时间 And Nvl(附加床位, 0) = 0;
    --临时记录的操作员信息记录的是终止人员,因为没有记录终止人员编号,就不恢复
    Update 病人变动记录
    Set 开始时间 = Null, 医疗小组id = Null, 护理等级id = Null, 床位等级id = Null, 床号 = Null, 责任护士 = Null, 经治医师 = Null, 操作员编号 = Null,
        操作员姓名 = v_终止人员, 上次计算时间 = Null, 附加床位 = Null, 主治医师 = Null, 病情 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 15 And 终止时间 Is Null;
  
    Update 病人变动记录
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 15 And 终止时间 = v_开始时间 And 开始时间 = d_开始时间;
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 15 And 终止时间 = v_Auto开始时间 And 性质 In (2, 3);
    Update 病人自动计算
    Set 终止时间 = Null, 终止原因 = Null, 终止人员 = Null, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止原因 = 15 And 终止时间 = v_Autohl开始时间 And 性质 = 1;
  
  Else
    Close c_Curlog;
    v_Error := '[ZLSOFT]你执行的撤销' || v_撤销方式 || '操作已经被其他人执行,请刷新界面！[ZLSOFT]';
    Raise Err_Custom;
  End If;
  Close c_Curautolog;
  Close c_Curautohllog;
  --并发操作检查
  Select Count(*)
  Into v_Count
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(附加床位, 0) = 0 And 开始时间 Is Not Null And 终止时间 Is Null;
  If v_Count > 1 Then
    v_Error := '发现病人存在非法的变动记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 出院日期 Is Null;
  If v_Count = 0 Then
    v_Error := '操作失败,该病人已出院,不能进行当前操作' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态！';
    Raise Err_Custom;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, v_Error);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人变动记录_Undo;
/

--107651:梁唐彬,2017-04-11,病人自动计算
Create Or Replace Procedure Zl_病人变动记录_Inunit
(
  病人id_In     病案主页.病人id%Type,
  主页id_In     病案主页.主页id%Type,
  床号_In       Varchar2,
  病区id_In     病案主页.当前病区id%Type,
  护理等级id_In 病案主页.护理等级id%Type,
  当前病况_In   病案主页.当前病况%Type,
  是否陪伴_In   病案主页.是否陪伴%Type,
  责任护士_In   病案主页.责任护士%Type,
  入病区时间_In 病人变动记录.开始时间%Type,
  操作员编号_In 人员表.编号%Type,
  操作员姓名_In 人员表.姓名%Type,
  主床位_In     病案主页.出院病床%Type
) As
  -----------------------------------------------------------
  --说明：完成病人入病区处理
  --参数：
  --       床号_IN:为空表示家庭病床,否则为"床号1,床号2,...床号n",多个床号时,表示包房。
  -----------------------------------------------------------
  Cursor c_Oldinfo Is
    Select b.*
    From (Select c.*
           From 病人变动记录 c
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人变动记录
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In)) a, 病人变动记录 b
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位
    Union
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 入病区时间_In;
  Cursor c_Endinfo Is
    Select * From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
  Cursor c_Futureinfo Is
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 0 And 开始时间 > 入病区时间_In;
  
  Cursor c_OldAutoHLinfo Is 
        Select b.* 
    From (Select c.* 
           From 病人自动计算 C 
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And C.性质 = 1 And 
                 c.开始时间 = (Select Min(开始时间) From 病人自动计算
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In  And 性质 = 1) And
                 NVL(c.终止时间|| '','空') = (Select  NVL(Min(终止时间)|| '','空')
                           From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In And 性质 = 1 And 开始时间 > 入病区时间_In)) A, 病人自动计算 B 
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And B.性质 = 1 
    Union 
    Select * From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 入病区时间_In And 性质 = 1;   
  Cursor c_OldAutoinfo Is
    Select b.*
    From (Select c.*
           From 病人自动计算 c
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And C.性质 = 2 And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人自动计算
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In And 性质 = 2)) a, 病人自动计算 b
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位 And B.性质 = 2
    Union
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 入病区时间_In And 性质 = 2;
  Cursor c_FutureAutoinfo Is
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 0 And 开始时间 > 入病区时间_In And 性质 = 2;
    
  r_Futureinfo   c_Futureinfo %Rowtype;
  r_FutureAutoinfo   c_FutureAutoinfo %Rowtype;
  b_Isdel        Boolean;
  b_IsAutodel        Boolean;
  r_Endinfo      c_Endinfo%Rowtype;
  r_Oldinfo      c_Oldinfo%Rowtype;
  r_OldAutoinfo      c_OldAutoinfo%Rowtype;
  r_OldAutoHLinfo      c_OldAutoHLinfo%Rowtype;
  v_变动终止原因 病人变动记录.终止原因%Type;
  v_变动终止时间 病人变动记录.终止时间%Type;
  v_变动终止人员 病人变动记录.终止人员%Type;
  v_Auto变动终止原因 病人变动记录.终止原因%Type;
  v_Auto变动终止时间 病人变动记录.终止时间%Type;
  v_Auto变动终止人员 病人变动记录.终止人员%Type;
  v_AutoHL变动终止原因 病人变动记录.终止原因%Type;
  v_AutoHL变动终止时间 病人变动记录.终止时间%Type;
  v_AutoHL变动终止人员 病人变动记录.终止人员%Type;
  
  Cursor c_Bedinfo Is
    Select 病区id, 床号 From 床位状况记录 Where 病人id = 病人id_In;
  v_床号     Varchar2(255);
  v_当前床号 床位状况记录.床号%Type;
  v_等级id   床位状况记录.等级id%Type;
  v_病区id   病案主页.当前病区id%Type;
  v_科室id   病案主页.出院科室id%Type;
  v_终止人员 病人变动记录.终止人员%Type;
  v_Count    Number;
  Err_Custom Exception;
  v_Error Varchar2(255);
Begin
  Open c_Oldinfo; --必须先打开
  Open c_OldAutoinfo; --必须先打开
  Open c_OldAutoHLinfo; --必须先打开
  --入病区
  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 状态 = 2;

  If v_Count = 0 Then
    v_Error := '病人当前不处于转病区状态,可能已经撤转病区，操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

  Begin
    Select 病区id, 操作员姓名
    Into v_病区id, v_终止人员
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 15 And 开始时间 Is Null And 终止时间 Is Null;
  Exception
    When Others Then
      v_病区id := 0;
  End;
  --v_病区id=0说明病人可能是转科状态
  If v_病区id = 0 Then
    v_Error := '病人当前不处于转病区状态，而是处于转科状态，操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;
  If v_病区id <> 病区id_In Then
    v_Error := '当前该病人即将入住的病区和变动记录中实际要入住病区不符,操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

  --产生新变动
  Fetch c_Oldinfo
    Into r_Oldinfo;
  Fetch c_OldAutoinfo
    Into r_OldAutoinfo;
  Fetch c_OldAutoHLinfo
    Into r_OldAutoHLinfo;
  Open c_Endinfo;
  Fetch c_Endinfo
    Into r_Endinfo;
  If c_Endinfo%Rowcount = 0 Then
    Close c_Endinfo;
    v_Error := '未发现该病人当前有效的变动记录！';
    Raise Err_Custom;
  End If;

  --病案主页
  Update 病案主页
  Set 状态 = 0, 出院病床 = Decode(床号_In, Null, Null, 主床位_In), 当前病区id = 病区id_In,
      护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In), 当前病况 = 当前病况_In, 责任护士 = 责任护士_In, 是否陪伴 = 是否陪伴_In
  Where 病人id = 病人id_In And 主页id = 主页id_In;

  --更新病人信息
  Update 病人信息
  Set 当前病区id = 病区id_In, 当前床号 = Decode(床号_In, Null, Null, 主床位_In)
  Where 病人id = 病人id_In;

  --更新在院病人
  v_科室id := 0;
  Begin
    Update 在院病人 Set 病区id = Nvl(病区id_In, 0) Where 病人id = 病人id_In;
    If Sql%Rowcount = 0 Then
      Select 出院科室id Into v_科室id From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
    End If;
  Exception
    When Others Then
      v_科室id := 0;
  End;
  If v_科室id > 0 Then
    Insert Into 在院病人 (病人id, 科室id, 病区id,主页ID) Values (病人id_In, v_科室id, Nvl(病区id_In, 0),nvl(主页ID_In,0));
  End If;

  --退除病人当前床位
  For r_Bedrow In c_Bedinfo Loop
    Update 床位状况记录
    Set 状态 = '空床', 病人id = Null, 科室id = Decode(共用, 1, Null, 科室id)
    Where 病区id = r_Bedrow.病区id And 床号 = r_Bedrow.床号;
  End Loop;

  --记录上一步的终止操作人员
  If r_Oldinfo.终止时间 Is Not Null Then
    v_变动终止时间 := r_Oldinfo.终止时间;
    v_变动终止原因 := r_Oldinfo.终止原因;
    v_变动终止人员 := r_Oldinfo.终止人员;
    --取消上次变动
    Update 病人变动记录
    Set 终止时间 = 入病区时间_In, 终止原因 = 15, 终止人员 = v_终止人员, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_变动终止时间 And 终止原因 = v_变动终止原因;
    --更新将来的记录如果有停止到将来的则删除上次计算时间
    Update 病人变动记录
    Set 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In;
  Else
    Update 病人变动记录
    Set 终止时间 = 入病区时间_In, 终止原因 = 15, 终止人员 = v_终止人员,
        上次计算时间 = Decode(Sign(Nvl(上次计算时间, 入病区时间_In) - 入病区时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Not Null And 终止时间 Is Null;
  End If;

  Delete From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 15 And 开始时间 Is Null And 终止时间 Is Null;
  
  If r_OldAutoinfo.终止时间 Is Not Null Then
    v_Auto变动终止时间 := r_OldAutoinfo.终止时间;
    v_Auto变动终止原因 := r_OldAutoinfo.终止原因;
    v_Auto变动终止人员 := r_OldAutoinfo.终止人员;
    --取消上次变动
    Update 病人自动计算
    Set 终止时间 = 入病区时间_In, 终止原因 = 15, 终止人员 = v_终止人员, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_Auto变动终止时间 And 终止原因 = v_Auto变动终止原因 and 性质 IN(2,3);
    --更新将来的记录如果有停止到将来的则删除上次计算时间
    Update 病人自动计算
    Set 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In  and 性质 IN(2,3);
  Else
    Update 病人自动计算
    Set 终止时间 = 入病区时间_In, 终止原因 = 15, 终止人员 = v_终止人员,
        上次计算时间 = Decode(Sign(Nvl(上次计算时间, 入病区时间_In) - 入病区时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Not Null And 终止时间 Is Null  and 性质 IN(2,3);
  End If;
    
  If r_OldAutoHLinfo.终止时间 Is Not Null Then
    v_AutoHL变动终止时间 := r_OldAutoHLinfo.终止时间;
    v_AutoHL变动终止原因 := r_OldAutoHLinfo.终止原因;
    v_AutoHL变动终止人员 := r_OldAutoHLinfo.终止人员;
    --取消上次变动
    Update 病人自动计算
    Set 终止时间 = 入病区时间_In, 终止原因 = 15, 终止人员 = v_终止人员, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_AutoHL变动终止时间 And 终止原因 = v_AutoHL变动终止原因  and 性质 = 1;
    --更新将来的记录如果有停止到将来的则删除上次计算时间
    Update 病人自动计算
    Set 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In  and 性质 = 1;
  Else
    Update 病人自动计算
    Set 终止时间 = 入病区时间_In, 终止原因 = 15, 终止人员 = v_终止人员,
        上次计算时间 = Decode(Sign(Nvl(上次计算时间, 入病区时间_In) - 入病区时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Not Null And 终止时间 Is Null  and 性质 = 1;
  End If;
  --护理等级变动
  Insert Into 病人自动计算
    (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 病区id, 科室id, 护理等级id, 操作员编号,
     操作员姓名, 终止时间, 终止原因, 终止人员)
  Values
    (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入病区时间_In, 15, 1, 病区id_In, r_OldAutoHLinfo.科室ID,
     Decode(护理等级id_In, 0, Null, 护理等级id_In), 操作员编号_In,操作员姓名_In, v_AutoHL变动终止时间, v_AutoHL变动终止原因, v_AutoHL变动终止人员);
      
  --新的床位记录
  If 床号_In Is Null Then
    --仅家庭病床
    Insert Into 病人变动记录
      (Id, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 入病区时间_In, 15, 0, 病区id_In, r_Oldinfo.科室id, r_Oldinfo.医疗小组id,
       Decode(护理等级id_In, 0, Null, 护理等级id_In), Null, Null, 责任护士_In, r_Oldinfo.经治医师, r_Oldinfo.主治医师, r_Oldinfo.主任医师,
       当前病况_In, 操作员编号_In, 操作员姓名_In, v_变动终止时间, v_变动终止原因, v_变动终止人员);
    --如果修改了床位，则必须修改停止到将来的变动数
    If c_Oldinfo%Rowcount <> 1 Then
      --删除所有将来的附加床位的变动
      Delete From 病人变动记录
      Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 入病区时间_In;
    End If;
    --如果有停到将来的情况，将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)
    Update 病人变动记录
    Set 床位等级id = Null, 床号 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In;
    
    Insert Into 病人自动计算
      (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入病区时间_In, 15, 2, 0, 病区id_In, r_OldAutoinfo.科室ID, 
       Null, Null, 操作员编号_In,操作员姓名_In, v_Auto变动终止时间, v_Auto变动终止原因, v_Auto变动终止人员);
    Insert Into 病人自动计算
      (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入病区时间_In, 15, 3, 0, 病区id_In, r_OldAutoinfo.科室ID, 
       Null, Null, 操作员编号_In,操作员姓名_In, v_Auto变动终止时间, v_Auto变动终止原因, v_Auto变动终止人员);
         
    --如果修改了床位，则必须修改停止到将来的变动数
    If c_OldAutoinfo%Rowcount <> 1 Then
      --删除所有将来的附加床位的变动
      Delete From 病人自动计算
      Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 入病区时间_In And 性质 In(2,3);
    End If;
      
    --如果有停到将来的情况，将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)
    Update 病人自动计算
    Set 床位等级id = Null, 床号 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In And 性质 In(2,3);
  Else
    v_床号  := 床号_In || ',';
    v_Count := 0;
    While v_床号 Is Not Null Loop
      v_Count := v_Count + 1;
      v_床号  := Substr(v_床号, Instr(v_床号, ',') + 1);
    End Loop;
    --如果修改了床位，则必须修改停止到将来的变动数
    b_Isdel := False;
    If c_Oldinfo%Rowcount <> v_Count Then
      --删除所有将来的附加床位的变动
      Delete From 病人变动记录
      Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 入病区时间_In;
      b_Isdel := True;
    End If;
    
    b_IsAutodel := False;
    If c_OldAutoinfo%Rowcount <> v_Count Then
      --删除所有将来的附加床位的变动
      Delete From 病人自动计算
      Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 入病区时间_In And 性质 In(2,3);
      b_IsAutodel := True;
    End If;
      
    v_Count := 0;
    v_床号  := 床号_In || ',';
  
    While v_床号 Is Not Null Loop
      v_当前床号 := Substr(v_床号, 1, Instr(v_床号, ',') - 1);
      Select 等级id Into v_等级id From 床位状况记录 Where 病区id = 病区id_In And 床号 = v_当前床号;
    
      Insert Into 病人变动记录
        (Id, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 入病区时间_In, 15, Decode(主床位_In, v_当前床号, 0, 1), 病区id_In, r_Oldinfo.科室id,
         r_Oldinfo.医疗小组id, Decode(护理等级id_In, 0, Null, 护理等级id_In), v_等级id, v_当前床号, 责任护士_In, r_Oldinfo.经治医师,
         r_Oldinfo.主治医师, r_Oldinfo.主任医师, 当前病况_In, 操作员编号_In, 操作员姓名_In, v_变动终止时间, v_变动终止原因, v_变动终止人员);
      Insert Into 病人自动计算
        (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入病区时间_In, 15, 2, Decode(主床位_In, v_当前床号, 0, 1), 病区id_In, r_OldAutoinfo.科室ID,
         v_等级id, v_当前床号, 操作员编号_In, 操作员姓名_In, v_Auto变动终止时间, v_Auto变动终止原因, v_Auto变动终止人员);
      Insert Into 病人自动计算
        (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入病区时间_In, 15, 3, Decode(主床位_In, v_当前床号, 0, 1), 病区id_In, r_OldAutoinfo.科室ID,
         v_等级id, v_当前床号, 操作员编号_In, 操作员姓名_In, v_Auto变动终止时间, v_Auto变动终止原因, v_Auto变动终止人员);
           
      Select Count(*) Into v_Count From 床位状况记录 Where 病区id = 病区id_In And 床号 = v_当前床号 And 状态 = '空床';
    
      If v_Count = 0 Then
        v_Error := '操作失败,床位 ' || v_当前床号 || ' 不是空床！';
        Raise Err_Custom;
      End If;
    
      Update 床位状况记录
      Set 状态 = '占用', 病人id = 病人id_In, 科室id = Decode(共用, 1, r_Oldinfo.科室id, 科室id)
      Where 病区id = 病区id_In And 床号 = v_当前床号;
    
      If b_Isdel = True Then
        --如果有停到将来的情况且有床位数变动,将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)和插入附加床位数据。
        If 主床位_In = v_当前床号 Then
          --如果是主床位则修改将来的主记录信息，如果不是主床位，就新插入数据
          Update 病人变动记录
          Set 床位等级id = v_等级id, 床号 = v_当前床号
          Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In And 附加床位 = 0;
        Else
          Open c_Futureinfo; --必须先打开
          Fetch c_Futureinfo
            Into r_Futureinfo;
          --循环停到将来的数据，进行附加床位插入
          While c_Futureinfo%Found Loop
            Insert Into 病人变动记录
              (Id, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 科室id, 医疗小组id, 床位等级id, 床号, 经治医师, 主治医师, 主任医师, 操作员编号, 操作员姓名, 终止时间, 终止原因,
               终止人员)
            Values
              (病人变动记录_Id.Nextval, r_Futureinfo.病人id, r_Futureinfo.主页id, r_Futureinfo.开始时间, r_Futureinfo.开始原因, 1,
               r_Futureinfo.科室id, r_Futureinfo.医疗小组id, v_等级id, v_当前床号, r_Futureinfo.经治医师, r_Futureinfo.主治医师,
               r_Futureinfo.主任医师, r_Futureinfo.操作员编号, r_Futureinfo.操作员姓名, r_Futureinfo.终止时间, r_Futureinfo.终止原因,
               r_Futureinfo.终止人员);
            Fetch c_Futureinfo
              Into r_Futureinfo;
          End Loop;
          Close c_Futureinfo;
        End If;
      End If;
      --病人自动计算所需数据
      If b_IsAutodel = True Then
        --如果有停到将来的情况且有床位数变动,将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)和插入附加床位数据。
        If 主床位_In = v_当前床号 Then
          --如果是主床位则修改将来的主记录信息，如果不是主床位，就新插入数据
          Update 病人自动计算
          Set 床位等级id = v_等级id, 床号 = v_当前床号
          Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In And 附加床位 = 0 And 性质 In(2,3);
        Else
          Open c_FutureAutoinfo; --必须先打开
          Fetch c_FutureAutoinfo
            Into r_FutureAutoinfo;
          --循环停到将来的数据，进行附加床位插入
          While c_FutureAutoinfo%Found Loop
            Insert Into 病人自动计算
              (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 床位等级id, 床号, 操作员编号, 操作员姓名, 终止时间, 终止原因, 终止人员)
            Values
              (病人自动计算_Id.Nextval, r_FutureAutoinfo.病人id, r_FutureAutoinfo.主页id, r_FutureAutoinfo.开始时间, r_FutureAutoinfo.开始原因, 2, 1,
               v_等级id, v_当前床号, r_FutureAutoinfo.操作员编号, r_FutureAutoinfo.操作员姓名, r_FutureAutoinfo.终止时间, r_FutureAutoinfo.终止原因,
               r_FutureAutoinfo.终止人员);
            Insert Into 病人自动计算
              (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 床位等级id, 床号, 操作员编号, 操作员姓名, 终止时间, 终止原因, 终止人员)
            Values
              (病人自动计算_Id.Nextval, r_FutureAutoinfo.病人id, r_FutureAutoinfo.主页id, r_FutureAutoinfo.开始时间, r_FutureAutoinfo.开始原因, 3, 1,
               v_等级id, v_当前床号, r_FutureAutoinfo.操作员编号, r_FutureAutoinfo.操作员姓名, r_FutureAutoinfo.终止时间, r_FutureAutoinfo.终止原因,
               r_FutureAutoinfo.终止人员);
            Fetch c_FutureAutoinfo
              Into r_FutureAutoinfo;
          End Loop;
          Close c_FutureAutoinfo;
        End If;
      End If;
    
      v_床号  := Substr(v_床号, Instr(v_床号, ',') + 1);
      v_Count := v_Count + 1;
    End Loop;
  End If;
  --如果有停到将来的情况，将将来的变动信息同步更新（附加床位的记录和主记录相同的字段）
  Update 病人变动记录
  Set 病区id = 病区id_In, 责任护士 = 责任护士_In, 护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In), 病情 = 当前病况_In
  Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In;
  Update 病人自动计算
  Set 病区id = 病区id_In, 护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In)
  Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In;
  Close c_Oldinfo;
  Close c_OldAutoinfo;
  Close c_OldAutoHLinfo;
  Close c_Endinfo;
  --对有效的医嘱(未停止、作废的长嘱，未发送的临嘱)，为原病区执行的，将执行科室自动更换为新的病区
  Update 病人医嘱记录
  Set 执行科室id = 病区id_In
  Where 病人id = 病人id_In And 主页id = 主页id_In And 执行科室id = r_Oldinfo.病区id And 医嘱状态 Not In (4, 8, 9);
  --对未审核的记帐划价单，为原病区执行的，将执行科室自动更换为新的病区
  Update 住院费用记录
  Set 执行部门id = 病区id_In
  Where 病人id = 病人id_In And 主页id = 主页id_In And 执行部门id = r_Oldinfo.病区id And 记录状态 = 0;
  --已发送且未执行且未记帐审核或未收费的医嘱发送记录，如果执行科室是原病区的，应更新为当前病区
  Update 病人医嘱发送 a
  Set a.执行部门id = 病区id_In
  Where a.执行部门id = r_Oldinfo.病区id And a.执行状态 = 0 And Exists
   (Select 1
         From 住院费用记录 b
         Where a.No = b.No And a.记录性质 = b.记录性质 And b.记录状态 = 0 And 病人id = 病人id_In And 主页id = 主页id_In);

  --并发操作检查
  Select Count(*)
  Into v_Count
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(附加床位, 0) = 0 And 开始时间 Is Not Null And 终止时间 Is Null;

  If v_Count > 1 Then
    v_Error := '发现病人存在非法的变动记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病人变动记录_Inunit;
/

--107651:梁唐彬,2017-04-11,病人自动计算
Create Or Replace Procedure Zl_病人变动记录_Indept
(
  病人id_In       病案主页.病人id%Type,
  主页id_In       病案主页.主页id%Type,
  床号_In         Varchar2,
  病区id_In       病案主页.当前病区id%Type,
  科室id_In       病案主页.出院科室id%Type,
  医疗小组id_In   病案主页.医疗小组id%Type,
  护理等级id_In   病案主页.护理等级id%Type,
  当前病况_In     病案主页.当前病况%Type,
  责任护士_In     病案主页.责任护士%Type,
  门诊医师_In     病案主页.门诊医师%Type,
  住院医师_In     病案主页.住院医师%Type,
  是否陪伴_In     病案主页.是否陪伴%Type,
  入院时间_In     病案主页.入院日期%Type,
  入科时间_In     病人变动记录.开始时间%Type,
  操作员编号_In   人员表.编号%Type,
  操作员姓名_In   人员表.姓名%Type,
  入院_In         Number,
  主治医师_In     病案主页.住院医师%Type := Null,
  主任医师_In     病案主页.住院医师%Type := Null,
  主床位_In       病案主页.出院病床%Type := Null,
  母婴转科标志_In 病案主页.母婴转科标志%Type := '1'
) As
  -----------------------------------------------------------
  --说明：完成病人入院或转科入科处理。
  --参数：
  --       入院_IN:病人是入院还是转科入科。
  --       床号_IN:为空表示家庭病床,否则为"床号1,床号2,...床号n",多个床号时,表示包房。
  -----------------------------------------------------------
  Cursor c_Bedinfo Is
    Select 病区id, 床号 From 床位状况记录 Where 病人id = 病人id_In;

  Cursor c_Oldinfo Is
    Select b.*
    From (Select c.*
           From 病人变动记录 C
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人变动记录
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In)) A, 病人变动记录 B
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位
    Union
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 入科时间_In;
  Cursor c_OldAutoinfo Is
    Select b.*
    From (Select c.*
           From 病人自动计算 C
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And C.性质 = 2 And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人自动计算
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In And 性质 = 2)) A, 病人自动计算 B
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位 And B.性质 = 2
    Union
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 入科时间_In And 性质 = 2;
    
  Cursor c_OldAutoHLinfo Is 
        Select b.* 
    From (Select c.* 
           From 病人自动计算 C 
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And C.性质 = 1 And 
                 c.开始时间 = (Select Min(开始时间) From 病人自动计算
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In  And 性质 = 1) And
                 NVL(c.终止时间|| '','空') = (Select  NVL(Min(终止时间)|| '','空')
                           From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In And 性质 = 1 And 开始时间 > 入科时间_In)) A, 病人自动计算 B 
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And B.性质 = 1 
    Union 
    Select * From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 入科时间_In And 性质 = 1; 
 
  Cursor c_Futureinfo Is
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 0 And 开始时间 > 入科时间_In;
  Cursor c_FutureAutoinfo Is
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 0 And 开始时间 > 入科时间_In And 性质 = 2;
    
  r_Futureinfo   c_Futureinfo %Rowtype;
  r_FutureAutoinfo   c_FutureAutoinfo %Rowtype;
  b_Isdel        Boolean;
  b_IsAutodel        Boolean;
  r_Oldinfo      c_Oldinfo%Rowtype;
  r_OldAutoinfo      c_OldAutoinfo%Rowtype;
  r_OldAutoHLinfo      c_OldAutoHLinfo%Rowtype;
  v_变动终止原因 病人变动记录.终止原因%Type;
  v_变动终止时间 病人变动记录.终止时间%Type;
  v_变动终止人员 病人变动记录.终止人员%Type;
  v_Auto变动终止原因 病人变动记录.终止原因%Type;
  v_Auto变动终止时间 病人变动记录.终止时间%Type;
  v_Auto变动终止人员 病人变动记录.终止人员%Type;
  v_AutoHL变动终止原因 病人变动记录.终止原因%Type;
  v_AutoHL变动终止时间 病人变动记录.终止时间%Type;
  v_AutoHL变动终止人员 病人变动记录.终止人员%Type;
  
  v_床号         Varchar2(255);
  v_当前床号     床位状况记录.床号%Type;
  v_等级id       床位状况记录.等级id%Type;
  v_病区id       病案主页.当前病区id%Type;
  n_原科室id     病案主页.出院科室id%Type;
  n_原病区id     病案主页.当前病区id%Type;
  v_再入院       病案主页.再入院%Type;
  v_终止人员     病人变动记录.终止人员%Type;
  v_母婴转科标志 病案主页.母婴转科标志%Type;
  v_Count        Number;
  Err_Custom Exception;
  v_Error Varchar2(255);
Begin
  Select Zl_住院日报_Count(科室id_In, 入科时间_In) Into v_Count From Dual;
  If v_Count > 0 Then
    v_Error := '已产生业务时间内的住院日报,不能办理该业务!';
    Raise Err_Custom;
  End If;
  --都要更新病人信息
  Update 病人信息
  Set 当前病区id = 病区id_In, 当前科室id = 科室id_In, 当前床号 = Decode(床号_In, Null, Null, 主床位_In), 入院时间 = 入院时间_In
  Where 病人id = 病人id_In;
  --更新在院病人
  Begin
    Update 在院病人 Set 病区id = Nvl(病区id_In, 0), 科室id = 科室id_In Where 病人id = 病人id_In;
    If Sql%Rowcount = 0 Then
      Insert Into 在院病人 (病人id, 科室id, 病区id,主页ID) Values (病人id_In, 科室id_In, Nvl(病区id_In, 0),NVL(主页ID_In,0));
    End If;
  Exception
    When Others Then
      Null;
  End;

  If 入院_In = 1 Then
    --入院入科
    Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 状态 = 1;
  
    If v_Count = 0 Then
      v_Error := '病人当前不处于入院状态,可能已经撤入院，操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人状态后再试！';
      Raise Err_Custom;
    End If;
  
    Select 入院病区id, 再入院 Into v_病区id, v_再入院 From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
  
    If v_病区id <> 病区id_In Then
      v_Error := '当前入住病区与病人登记病区不一致,病人状态已经更改,操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人状态后再试！';
      Raise Err_Custom;
    End If;
  
    --病案主页
    --同时更改了入院登记时的科室,病区,病况
    Update 病案主页
    Set 入院科室id = 科室id_In, 入院病区id = 病区id_In, 入院病况 = 当前病况_In, 状态 = 0, 入院病床 = Decode(床号_In, Null, Null, 主床位_In),
        出院病床 = Decode(床号_In, Null, Null, 主床位_In), 当前病区id = 病区id_In, 出院科室id = 科室id_In,
        医疗小组id = Decode(医疗小组id_In, 0, Null, 医疗小组id_In), 护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In), 当前病况 = 当前病况_In,
        责任护士 = 责任护士_In, 门诊医师 = 门诊医师_In, 住院医师 = 住院医师_In, 是否陪伴 = 是否陪伴_In, 入院日期 = 入院时间_In
    Where 病人id = 病人id_In And 主页id = 主页id_In;
  
    Update 病案主页从表
    Set 信息值 = 主治医师_In
    Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主治医师';
    If Sql%Rowcount = 0 Then
      Insert Into 病案主页从表 (病人id, 主页id, 信息名, 信息值) Values (病人id_In, 主页id_In, '主治医师', 主治医师_In);
    End If;
    Update 病案主页从表
    Set 信息值 = 主任医师_In
    Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主任医师';
    If Sql%Rowcount = 0 Then
      Insert Into 病案主页从表 (病人id, 主页id, 信息名, 信息值) Values (病人id_In, 主页id_In, '主任医师', 主任医师_In);
    End If;
  
    --记录上一步的终止操作人员
    Update 病人变动记录
    Set 终止时间 = 入科时间_In, 终止原因 = 2, 终止人员 = 操作员姓名_In,
          上次计算时间 = Decode(Sign(Nvl(上次计算时间, 入科时间_In) - 入科时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Not Null And 终止时间 Is Null;
    
    Update 病人自动计算
    Set 终止时间 = 入科时间_In, 终止原因 = 2, 终止人员 = 操作员姓名_In,
          上次计算时间 = Decode(Sign(Nvl(上次计算时间, 入科时间_In) - 入科时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Not Null And 终止时间 Is Null;
    
    Insert Into 病人自动计算
      (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 病区id, 科室id, 护理等级id, 操作员编号,
       操作员姓名)
    Values
      (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 2, 1, 病区id_In, 科室id_In,
       Decode(护理等级id_In, 0, Null, 护理等级id_In), 操作员编号_In, 操作员姓名_In);
          
    If 床号_In Is Null Then
      --仅家庭病床
      Insert Into 病人变动记录
        (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
         操作员姓名)
      Values
        (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 2, 0, 病区id_In, 科室id_In, Decode(医疗小组id_In, 0, Null, 医疗小组id_In),
         Decode(护理等级id_In, 0, Null, 护理等级id_In), Null, Null, 责任护士_In, 住院医师_In, 主治医师_In, 主任医师_In, 当前病况_In, 操作员编号_In,
         操作员姓名_In);
      Insert Into 病人自动计算
        (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 2, 2, 0, 病区id_In, 科室id_In,
         Null, Null, 操作员编号_In,操作员姓名_In);
      Insert Into 病人自动计算
        (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 2, 3, 0, 病区id_In, 科室id_In,
         Null, Null, 操作员编号_In,操作员姓名_In);
    Else
      --多张床位
      v_床号 := 床号_In || ',';
      
      While v_床号 Is Not Null Loop
        v_当前床号 := Substr(v_床号, 1, Instr(v_床号, ',') - 1);
        Select 等级id Into v_等级id From 床位状况记录 Where 病区id = 病区id_In And 床号 = v_当前床号;
      
        Insert Into 病人变动记录
          (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
           操作员姓名)
        Values
          (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 2, Decode(主床位_In, v_当前床号, 0, 1), 病区id_In, 科室id_In,
           Decode(医疗小组id_In, 0, Null, 医疗小组id_In), Decode(护理等级id_In, 0, Null, 护理等级id_In), v_等级id, v_当前床号, 责任护士_In,
           住院医师_In, 主治医师_In, 主任医师_In, 当前病况_In, 操作员编号_In, 操作员姓名_In);
        Insert Into 病人自动计算
          (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
           操作员姓名)
        Values
          (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 2, 2, Decode(主床位_In, v_当前床号, 0, 1), 病区id_In, 科室id_In,
           v_等级id, v_当前床号, 操作员编号_In, 操作员姓名_In);
        Insert Into 病人自动计算
          (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
           操作员姓名)
        Values
          (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 2, 3, Decode(主床位_In, v_当前床号, 0, 1), 病区id_In, 科室id_In,
           v_等级id, v_当前床号, 操作员编号_In, 操作员姓名_In);
              
        Select Count(*)
        Into v_Count
        From 床位状况记录
        Where 病区id = 病区id_In And 床号 = v_当前床号 And 状态 = '空床';
      
        If v_Count = 0 Then
          v_Error := '操作失败,床位 ' || v_当前床号 || ' 不是空床！';
          Raise Err_Custom;
        End If;
      
        Update 床位状况记录
        Set 状态 = '占用', 病人id = 病人id_In, 科室id = Decode(共用, 1, 科室id_In, 科室id)
        Where 病区id = 病区id_In And 床号 = v_当前床号;
      
        v_床号 := Substr(v_床号, Instr(v_床号, ',') + 1);
      End Loop;
    End If;
    --产生病历书写时机
    If v_再入院 = 0 Then
      Zl_电子病历时机_Insert(病人id_In, 主页id_In, 2, '入院', 科室id_In, 住院医师_In, 入科时间_In, 入科时间_In);
    Else
      Zl_电子病历时机_Insert(病人id_In, 主页id_In, 2, '再次入院', 科室id_In, 住院医师_In, 入科时间_In, 入科时间_In);
    End If;

    --添加首份体温单
    Zl_病人体温单_NewFirst(病人id_In,主页id_In,病区id_In);

    -- 修改入院时间
    If 入院时间_In Is Not Null Then
      Update 病人变动记录
      Set 开始时间 = 入院时间_In
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 1 And 开始时间 <> 入院时间_In;
      Update 病人自动计算
      Set 开始时间 = 入院时间_In
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 1 And 开始时间 <> 入院时间_In;
    End If;
  Else
    --转科入科
    Open c_Oldinfo; --必须先打开
    Fetch c_Oldinfo
      Into r_Oldinfo;
    Open c_OldAutoinfo; --必须先打开
    Fetch c_OldAutoinfo
      Into r_OldAutoinfo;
    Open c_OldAutoHLinfo; --必须先打开
    Fetch c_OldAutoHLinfo
      Into r_OldAutoHLinfo;
    Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 状态 = 2;
  
    If v_Count = 0 Then
      v_Error := '病人当前不处于转科状态,可能已经撤转科，操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人状态后再试！';
      Raise Err_Custom;
    End If;
  
    Select 病区id, 操作员姓名
    Into v_病区id, v_终止人员
    From 病人变动记录 --病区与科室独立时,临时记录里没有填,为Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Null And 终止时间 Is Null;
  
    If v_病区id <> 病区id_In Then
      --病区与科室独立时,由于是Null判断,所以不会提示
      v_Error := '当前入住病区与病人登记病区不一致,病人状态已经更改,操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人状态后再试！';
      Raise Err_Custom;
    End If;
    Select Count(1) Into v_Count From 病人新生儿记录 Where 病人id = 病人id_In And 主页id = 主页id_In;
    If v_Count > 0 Then
      --有婴儿才处理
      v_母婴转科标志 := 母婴转科标志_In;
      --取出婴儿科室病区ID
      Select 婴儿科室id, 婴儿病区id
      Into n_原科室id, n_原病区id
      From 病案主页
      Where 病人id = 病人id_In And 主页id = 主页id_In;
    
      If Nvl(n_原科室id, 0) <> 0 Then
        --母婴转科标志_In=0表示只转母亲，婴儿科室ID不为Null表示已经分离了，已经分离了默认只转母亲
        v_母婴转科标志 := '0';
        --如果相等，则表示母亲转回婴儿科室,清空婴儿科室ID
        If n_原科室id = 科室id_In Then
          Update 病案主页 Set 婴儿科室id = Null, 婴儿病区id = Null Where 病人id = 病人id_In And 主页id = 主页id_In;
        End If;
      Else
        --为null表示母婴未分离
        Select 出院科室id, 当前病区id
        Into n_原科室id, n_原病区id
        From 病案主页
        Where 病人id = 病人id_In And 主页id = 主页id_In;
        If Nvl(n_原科室id, 0) <> 0 Then
          --只转母亲
          If v_母婴转科标志 = 0 Then
            Update 病案主页
            Set 婴儿科室id = n_原科室id, 婴儿病区id = n_原病区id
            Where 病人id = 病人id_In And 主页id = 主页id_In;
          Else
            Update 病案主页 Set 婴儿科室id = Null, 婴儿病区id = Null Where 病人id = 病人id_In And 主页id = 主页id_In;
          End If;
        End If;
      End If;
      Update 病案主页 Set 母婴转科标志 = 母婴转科标志 || v_母婴转科标志 where 病人id = 病人id_In And 主页id = 主页id_In;
    End If;
    --病案主页
    Update 病案主页
    Set 状态 = 0, 出院病床 = Decode(床号_In, Null, Null, 主床位_In), 当前病区id = 病区id_In, 出院科室id = 科室id_In,
        医疗小组id = Decode(医疗小组id_In, 0, Null, 医疗小组id_In), 护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In), 当前病况 = 当前病况_In,
        责任护士 = 责任护士_In, 门诊医师 = 门诊医师_In, 住院医师 = 住院医师_In, 是否陪伴 = 是否陪伴_In
    Where 病人id = 病人id_In And 主页id = 主页id_In;
  
    Update 病案主页从表
    Set 信息值 = 主治医师_In
    Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主治医师';
    If Sql%Rowcount = 0 Then
      Insert Into 病案主页从表 (病人id, 主页id, 信息名, 信息值) Values (病人id_In, 主页id_In, '主治医师', 主治医师_In);
    End If;
    Update 病案主页从表
    Set 信息值 = 主任医师_In
    Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主任医师';
    If Sql%Rowcount = 0 Then
      Insert Into 病案主页从表 (病人id, 主页id, 信息名, 信息值) Values (病人id_In, 主页id_In, '主任医师', 主任医师_In);
    End If;
  
    --退除病人当前床位
    For r_Bedrow In c_Bedinfo Loop
      Update 床位状况记录
      Set 状态 = '空床', 病人id = Null, 科室id = Decode(共用, 1, Null, 科室id)
      Where 病区id = r_Bedrow.病区id And 床号 = r_Bedrow.床号;
    End Loop;
  
    --记录上一步的终止操作人员等
    If r_Oldinfo.终止时间 Is Not Null Then
      v_变动终止时间 := r_Oldinfo.终止时间;
      v_变动终止原因 := r_Oldinfo.终止原因;
      v_变动终止人员 := r_Oldinfo.终止人员;
      --取消上次变动
      Update 病人变动记录
      Set 终止时间 = 入科时间_In, 终止原因 = 3, 终止人员 = v_终止人员, 上次计算时间 = Null
      Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_变动终止时间 And 终止原因 = v_变动终止原因;
      --更新将来的记录如果有停止到将来的则删除上次计算时间
      Update 病人变动记录
      Set 上次计算时间 = Null
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In;
    Else
      Update 病人变动记录
      Set 终止时间 = 入科时间_In, 终止原因 = 3, 终止人员 = v_终止人员,
          上次计算时间 = Decode(Sign(Nvl(上次计算时间, 入科时间_In) - 入科时间_In), 1, Null, 上次计算时间)
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Not Null And 终止时间 Is Null;
    End If;
  
    Delete From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 3 And 开始时间 Is Null And 终止时间 Is Null;
    
    If r_OldAutoinfo.终止时间 Is Not Null Then
      v_Auto变动终止时间 := r_OldAutoinfo.终止时间;
      v_Auto变动终止原因 := r_OldAutoinfo.终止原因;
      v_Auto变动终止人员 := r_OldAutoinfo.终止人员;
      --取消上次变动
      Update 病人自动计算
      Set 终止时间 = 入科时间_In, 终止原因 = 3, 终止人员 = v_终止人员, 上次计算时间 = Null
      Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_Auto变动终止时间 And 终止原因 = v_Auto变动终止原因 and 性质 IN(2,3);
      --更新将来的记录如果有停止到将来的则删除上次计算时间
      Update 病人自动计算
      Set 上次计算时间 = Null
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In  and 性质 IN(2,3);
    Else
      Update 病人自动计算
      Set 终止时间 = 入科时间_In, 终止原因 = 3, 终止人员 = v_终止人员,
          上次计算时间 = Decode(Sign(Nvl(上次计算时间, 入科时间_In) - 入科时间_In), 1, Null, 上次计算时间)
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Not Null And 终止时间 Is Null  and 性质 IN(2,3);
    End If;
    
    If r_OldAutoHLinfo.终止时间 Is Not Null Then
      v_AutoHL变动终止时间 := r_OldAutoHLinfo.终止时间;
      v_AutoHL变动终止原因 := r_OldAutoHLinfo.终止原因;
      v_AutoHL变动终止人员 := r_OldAutoHLinfo.终止人员;
      --取消上次变动
      Update 病人自动计算
      Set 终止时间 = 入科时间_In, 终止原因 = 3, 终止人员 = v_终止人员, 上次计算时间 = Null
      Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_AutoHL变动终止时间 And 终止原因 = v_AutoHL变动终止原因  and 性质 = 1;
      --更新将来的记录如果有停止到将来的则删除上次计算时间
      Update 病人自动计算
      Set 上次计算时间 = Null
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In  and 性质 = 1;
    Else
      Update 病人自动计算
      Set 终止时间 = 入科时间_In, 终止原因 = 3, 终止人员 = v_终止人员,
          上次计算时间 = Decode(Sign(Nvl(上次计算时间, 入科时间_In) - 入科时间_In), 1, Null, 上次计算时间)
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Not Null And 终止时间 Is Null  and 性质 = 1;
    End If;
    --护理等级变动
    Insert Into 病人自动计算
      (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 病区id, 科室id, 护理等级id, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 3, 1, 病区id_In, 科室id_In,
       Decode(护理等级id_In, 0, Null, 护理等级id_In), 操作员编号_In,操作员姓名_In, v_AutoHL变动终止时间, v_AutoHL变动终止原因, v_AutoHL变动终止人员);
      
    --新的床位记录
    If 床号_In Is Null Then
      --仅家庭病床
      Insert Into 病人变动记录
        (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 3, 0, 病区id_In, 科室id_In, Decode(医疗小组id_In, 0, Null, 医疗小组id_In),
         Decode(护理等级id_In, 0, Null, 护理等级id_In), Null, Null, 责任护士_In, 住院医师_In, 主治医师_In, 主任医师_In, 当前病况_In, 操作员编号_In,
         操作员姓名_In, v_变动终止时间, v_变动终止原因, v_变动终止人员);
      --如果修改了床位，则必须修改停止到将来的变动数
      If c_Oldinfo%Rowcount <> 1 Then
        --删除所有将来的附加床位的变动
        Delete From 病人变动记录
        Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 入科时间_In;
      End If;
      --如果有停到将来的情况，将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)
      Update 病人变动记录
      Set 床位等级id = Null, 床号 = Null
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In;
      
      Insert Into 病人自动计算
        (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 3, 2, 0, 病区id_In, 科室id_In, 
         Null, Null, 操作员编号_In,操作员姓名_In, v_Auto变动终止时间, v_Auto变动终止原因, v_Auto变动终止人员);
      Insert Into 病人自动计算
        (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 3, 3, 0, 病区id_In, 科室id_In, 
         Null, Null, 操作员编号_In,操作员姓名_In, v_Auto变动终止时间, v_Auto变动终止原因, v_Auto变动终止人员);
         
      --如果修改了床位，则必须修改停止到将来的变动数
      If c_OldAutoinfo%Rowcount <> 1 Then
        --删除所有将来的附加床位的变动
        Delete From 病人自动计算
        Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 入科时间_In And 性质 In(2,3);
      End If;
      
      --如果有停到将来的情况，将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)
      Update 病人自动计算
      Set 床位等级id = Null, 床号 = Null
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In And 性质 In(2,3);
    Else
      v_床号  := 床号_In || ',';
      v_Count := 0;
      While v_床号 Is Not Null Loop
        v_Count := v_Count + 1;
        v_床号  := Substr(v_床号, Instr(v_床号, ',') + 1);
      End Loop;
      --如果修改了床位，则必须修改停止到将来的变动数
      b_Isdel := False;
      If c_Oldinfo%Rowcount <> v_Count Then
        --删除所有将来的附加床位的变动
        Delete From 病人变动记录
        Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 入科时间_In;
        b_Isdel := True;
      End If;
      b_IsAutodel := False;
      If c_OldAutoinfo%Rowcount <> v_Count Then
        --删除所有将来的附加床位的变动
        Delete From 病人自动计算
        Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 入科时间_In And 性质 In(2,3);
        b_IsAutodel := True;
      End If;
      
      v_床号 := 床号_In || ',';
      While v_床号 Is Not Null Loop
        v_当前床号 := Substr(v_床号, 1, Instr(v_床号, ',') - 1);
        Select 等级id Into v_等级id From 床位状况记录 Where 病区id = 病区id_In And 床号 = v_当前床号;
      
        Insert Into 病人变动记录
          (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
           操作员姓名, 终止时间, 终止原因, 终止人员)
        Values
          (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 3, Decode(主床位_In, v_当前床号, 0, 1), 病区id_In, 科室id_In,
           Decode(医疗小组id_In, 0, Null, 医疗小组id_In), Decode(护理等级id_In, 0, Null, 护理等级id_In), v_等级id, v_当前床号, 责任护士_In,
           住院医师_In, 主治医师_In, 主任医师_In, 当前病况_In, 操作员编号_In, 操作员姓名_In, v_变动终止时间, v_变动终止原因, v_变动终止人员);
        
        Insert Into 病人自动计算
          (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
           操作员姓名, 终止时间, 终止原因, 终止人员)
        Values
          (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 3, 2, Decode(主床位_In, v_当前床号, 0, 1), 病区id_In, 科室id_In,
           v_等级id, v_当前床号, 操作员编号_In, 操作员姓名_In, v_Auto变动终止时间, v_Auto变动终止原因, v_Auto变动终止人员);
        Insert Into 病人自动计算
          (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
           操作员姓名, 终止时间, 终止原因, 终止人员)
        Values
          (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 入科时间_In, 3, 3, Decode(主床位_In, v_当前床号, 0, 1), 病区id_In, 科室id_In,
           v_等级id, v_当前床号, 操作员编号_In, 操作员姓名_In, v_Auto变动终止时间, v_Auto变动终止原因, v_Auto变动终止人员);
        
        Select Count(*)
        Into v_Count
        From 床位状况记录
        Where 病区id = 病区id_In And 床号 = v_当前床号 And 状态 = '空床';
      
        If v_Count = 0 Then
          v_Error := '操作失败,床位 ' || v_当前床号 || ' 不是空床！';
          Raise Err_Custom;
        End If;
      
        Update 床位状况记录
        Set 状态 = '占用', 病人id = 病人id_In, 科室id = Decode(共用, 1, 科室id_In, 科室id)
        Where 病区id = 病区id_In And 床号 = v_当前床号;
      
        If b_Isdel = True Then
          --如果有停到将来的情况且有床位数变动,将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)和插入附加床位数据。
          If 主床位_In = v_当前床号 Then
            --如果是主床位则修改将来的主记录信息，如果不是主床位，就新插入数据
            Update 病人变动记录
            Set 床位等级id = v_等级id, 床号 = v_当前床号
            Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In And 附加床位 = 0;
          Else
            Open c_Futureinfo; --必须先打开
            Fetch c_Futureinfo
              Into r_Futureinfo;
            --循环停到将来的数据，进行附加床位插入
            While c_Futureinfo%Found Loop
              Insert Into 病人变动记录
                (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 床位等级id, 床号, 操作员编号, 操作员姓名, 终止时间, 终止原因, 终止人员)
              Values
                (病人变动记录_Id.Nextval, r_Futureinfo.病人id, r_Futureinfo.主页id, r_Futureinfo.开始时间, r_Futureinfo.开始原因, 1,
                 v_等级id, v_当前床号, r_Futureinfo.操作员编号, r_Futureinfo.操作员姓名, r_Futureinfo.终止时间, r_Futureinfo.终止原因,
                 r_Futureinfo.终止人员);
              Fetch c_Futureinfo
                Into r_Futureinfo;
            End Loop;
            Close c_Futureinfo;
          End If;
        End If;
        --病人自动计算所需数据
        If b_IsAutodel = True Then
          --如果有停到将来的情况且有床位数变动,将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)和插入附加床位数据。
          If 主床位_In = v_当前床号 Then
            --如果是主床位则修改将来的主记录信息，如果不是主床位，就新插入数据
            Update 病人自动计算
            Set 床位等级id = v_等级id, 床号 = v_当前床号
            Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In And 附加床位 = 0 And 性质 In(2,3);
          Else
            Open c_FutureAutoinfo; --必须先打开
            Fetch c_FutureAutoinfo
              Into r_FutureAutoinfo;
            --循环停到将来的数据，进行附加床位插入
            While c_FutureAutoinfo%Found Loop
              Insert Into 病人自动计算
                (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 床位等级id, 床号, 操作员编号, 操作员姓名, 终止时间, 终止原因, 终止人员)
              Values
                (病人自动计算_Id.Nextval, r_FutureAutoinfo.病人id, r_FutureAutoinfo.主页id, r_FutureAutoinfo.开始时间, r_FutureAutoinfo.开始原因, 2, 1,
                 v_等级id, v_当前床号, r_FutureAutoinfo.操作员编号, r_FutureAutoinfo.操作员姓名, r_FutureAutoinfo.终止时间, r_FutureAutoinfo.终止原因,
                 r_FutureAutoinfo.终止人员);
              Insert Into 病人自动计算
                (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 床位等级id, 床号, 操作员编号, 操作员姓名, 终止时间, 终止原因, 终止人员)
              Values
                (病人自动计算_Id.Nextval, r_FutureAutoinfo.病人id, r_FutureAutoinfo.主页id, r_FutureAutoinfo.开始时间, r_FutureAutoinfo.开始原因, 3, 1,
                 v_等级id, v_当前床号, r_FutureAutoinfo.操作员编号, r_FutureAutoinfo.操作员姓名, r_FutureAutoinfo.终止时间, r_FutureAutoinfo.终止原因,
                 r_FutureAutoinfo.终止人员);
              Fetch c_FutureAutoinfo
                Into r_FutureAutoinfo;
            End Loop;
            Close c_FutureAutoinfo;
          End If;
        End If;
        
        v_床号 := Substr(v_床号, Instr(v_床号, ',') + 1);
      End Loop;
    End If;
    --如果有停到将来的情况，将将来的变动信息同步更新（附加床位的记录和主记录相同的字段）
    Update 病人变动记录
    Set 病区id = 病区id_In, 科室id = 科室id_In, 医疗小组id = Decode(医疗小组id_In, 0, Null, 医疗小组id_In),
        护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In), 责任护士 = 责任护士_In, 经治医师 = 住院医师_In, 主治医师 = 主治医师_In, 主任医师 = 主任医师_In,
        病情 = 当前病况_In
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In;
    
    Update 病人自动计算
    Set 病区id = 病区id_In, 科室id = 科室id_In,
        护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入科时间_In;
    Close c_Oldinfo;
    Close c_OldAutoinfo;
    Close c_OldAutoHLinfo;
    --产生病历书写时机
    Zl_电子病历时机_Insert(病人id_In, 主页id_In, 2, '转科', 科室id_In, 住院医师_In, 入科时间_In, 入科时间_In);
  End If;

  --并发操作检查
  Select Count(*)
  Into v_Count
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(附加床位, 0) = 0 And 开始时间 Is Not Null And 终止时间 Is Null;

  If v_Count > 1 Then
    v_Error := '发现病人存在非法的变动记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病人变动记录_Indept;
/

--107651:梁唐彬,2017-04-11,病人自动计算
Create Or Replace Procedure Zl_病人变动记录_Modifout
(
  病人id_In     病案主页.病人id%Type,
  主页id_In     病案主页.主页id%Type,
  出院时间_In   病案主页.出院日期%Type,
  操作员编号_In 病人变动记录.操作员编号%Type,
  操作员姓名_In 病人变动记录.操作员姓名%Type
) As
  -----------------------------------------------------------
  --说明：修改病人出院的出院时间
  -----------------------------------------------------------
  v_Count Number;
  Err_Custom Exception;
  v_Error    Varchar2(255);
  v_随诊期限 Date;
  v_应发时间 Date;
  v_共享号   Zlsystems.共享号%Type;
  v_年龄     病人信息.年龄%Type;
  n_随诊标志 病案主页.随诊标志%Type;
  n_随诊期限 病案主页.随诊期限%Type;
  v_Sql      Varchar2(1000);
  v_出院科室 Number;
Begin
  --首先判断该病人是否出院病人
  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 出院日期 Is Not Null;
  If v_Count = 0 Then
    v_Error := '操作失败,该病人可能不是出院病人！';
    Raise Err_Custom;
  End If;
  --首先判断该病人是否处于出院
  Select Count(*)
  Into v_Count
  From 病案主页
  Where 病人id = 病人id_In And 主页id = 主页id_In And 出院日期 Is Not Null And Nvl(状态, 0) In (0, 3);
  If v_Count = 0 Then
    v_Error := '操作失败,该病人正处于转科状态或尚未入科,不能修改出院时间！';
    Raise Err_Custom;
  End If;

  --判断是否产生住院日报
  Select Nvl(出院科室id, 入院科室id), Nvl(随诊标志, 0), Nvl(n_随诊期限, 0)
  Into v_出院科室, n_随诊标志, n_随诊期限
  From 病案主页
  Where 病人id = 病人id_In And 主页id = 主页id_In;

  Select Zl_住院日报_Count(v_出院科室, 出院时间_In) Into v_Count From Dual;
  If v_Count > 0 Then
    v_Error := '已产生业务时间内的住院日报,不能办理该业务!';
    Raise Err_Custom;
  End If;

  --判断是否与病案系统共享
  Begin
    Select 共享号 Into v_共享号 From Zlsystems Where Floor(编号 / 100) = 3;
  Exception
    When Others Then
      Null;
  End;
  --出院变动
  Update 病人变动记录
  Set 终止时间 = 出院时间_In, 终止原因 = 1, 终止人员 = 操作员姓名_In, 上次计算时间 = Null
  Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Not Null And 终止原因 = 1;
  
  Update 病人自动计算
  Set 终止时间 = 出院时间_In, 终止原因 = 1, 终止人员 = 操作员姓名_In, 上次计算时间 = Null
  Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Not Null And 终止原因 = 1;

  --病案主页
  Update 病案主页
  Set 状态 = 0, 出院日期 = 出院时间_In,
      住院天数 = Decode(Trunc(出院时间_In) - Trunc(入院日期), 0, 1, Trunc(出院时间_In) - Trunc(入院日期))
  Where 病人id = 病人id_In And 主页id = 主页id_In;

  --修改随诊记录
  If v_共享号 = 100 Then
    If Nvl(n_随诊期限, 0) <> 0 Then
      If n_随诊标志 = 1 Then
        v_随诊期限 := Add_Months(出院时间_In, n_随诊期限);
      Elsif n_随诊标志 = 2 Then
        v_随诊期限 := Add_Months(出院时间_In, 12 * n_随诊期限);
      Elsif n_随诊标志 = 3 Then
        v_随诊期限 := 出院时间_In + 7 * n_随诊期限;
      Elsif n_随诊标志 = 4 Then
        v_随诊期限 := 出院时间_In + n_随诊期限;
      End If;
    Else
      v_随诊期限 := To_Date('3000-1-1', 'YYYY-MM-DD');
    End If;
  
    If n_随诊标志 = 1 Or n_随诊标志 = 2 Or n_随诊标志 = 3 Or n_随诊标志 = 4 Then
      If v_随诊期限 > Add_Months(出院时间_In, 3) Then
        v_应发时间 := Trunc(Add_Months(出院时间_In, 3));
      Else
        v_应发时间 := v_随诊期限;
      End If;
      v_Sql := 'UPDATE  随诊记录 SET 应发时间 =:1,随诊期限 =:2 WHERE 病人id =:3 AND 主页id =:4';
      Execute Immediate v_Sql
        Using To_Date(To_Char(v_应发时间, 'YYYY-MM-DD'), 'YYYY-MM-DD'), To_Date(To_Char(v_随诊期限, 'YYYY-MM-DD'), 'YYYY-MM-DD'), 病人id_In, 主页id_In;
    End If;
  End If;
  --病人信息
  v_年龄 := Zl_Age_Calc(病人id_In);
  Update 病人信息
  Set 当前科室id = Null, 当前病区id = Null, 当前床号 = Null, 出院时间 = 出院时间_In, 年龄 = v_年龄, 在院 = Null
  Where 病人id = 病人id_In;
  --在院病人
  Delete From 在院病人 Where 病人id = 病人id_In;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病人变动记录_Modifout;
/

--107651:梁唐彬,2017-04-11,病人自动计算
Create Or Replace Procedure Zl_病人变动记录_Out
(
  病人id_In       病案主页.病人id%Type,
  主页id_In       病案主页.主页id%Type,
  疾病id_In       病人诊断记录.疾病id%Type,
  诊断id_In       病人诊断记录.诊断id%Type,
  出院诊断_In     病人诊断记录.诊断描述%Type,
  出院情况_In     病人诊断记录.出院情况%Type,
  中医疾病id_In   病人诊断记录.疾病id%Type,
  中医诊断id_In   病人诊断记录.诊断id%Type,
  中医诊断_In     病人诊断记录.诊断描述%Type,
  中医出院情况_In 病人诊断记录.出院情况%Type,
  是否疑诊_In     病案主页.是否确诊%Type, --同时作为西医的是否疑诊
  出院方式_In     病案主页.出院方式%Type,
  出院时间_In     病案主页.出院日期%Type,
  随诊标志_In     病案主页.随诊标志%Type, --0/NULL-不随诊，1-月，2-年，3-周，4-天，9-终身
  随诊期限_In     病案主页.随诊期限%Type,
  尸检标志_In     病案主页.尸检标志%Type,
  操作员编号_In   病人变动记录.操作员编号%Type,
  操作员姓名_In   病人变动记录.操作员姓名%Type,
  确诊日期_In     病案主页.确诊日期%Type := Null
) As
  -----------------------------------------------------------
  --说明：病人出院
  -----------------------------------------------------------
  Cursor c_Bedinfo Is
    Select 病区id, 床号 From 床位状况记录 Where 病人id = 病人id_In;

  v_Count Number;
  Err_Custom Exception;
  v_Error      Varchar2(255);
  v_随诊期限   Date;
  v_应发时间   Date;
  v_共享号     Zlsystems.共享号%Type;
  v_年龄       病人信息.年龄%Type;
  v_Sql        Varchar2(1000);
  v_住院医师   Varchar2(20);
  v_出院科室   Number;
  v_姓名       病人信息.姓名%Type;
  n_婴儿科室id 病案主页.婴儿科室id%Type;
Begin
  --首先判断该病人是否已出院
  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 出院日期 Is Null;

  If v_Count = 0 Then
    v_Error := '操作失败,该病人可能已经出院！';
    Raise Err_Custom;
  End If;

  --首先判断该病人是否处于等待转科或入科状态
  Select Count(*)
  Into v_Count
  From 病案主页
  Where 病人id = 病人id_In And 主页id = 主页id_In And 出院日期 Is Null And Nvl(状态, 0) In (0, 3);
  If v_Count = 0 Then
    v_Error := '操作失败,该病人正处于转科状态或尚未入科,不能出院！';
    Raise Err_Custom;
  End If;

  --临床路径正在执行时不允许出院
  Select Max(b.状态)
  Into v_Count
  From 病案主页 A, 病人临床路径 B
  Where a.病人id = 病人id_In And a.主页id = 主页id_In And a.病人id = b.病人id And a.主页id = b.主页id And a.出院科室id = b.科室id;
  If v_Count = 1 Then
    v_Error := '该病人的临床路径正在执行中,不能出院。';
    Raise Err_Custom;
  End If;

  --母婴分离婴儿未出院则母亲不能出院
  Select 婴儿科室id Into n_婴儿科室id From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
  If n_婴儿科室id Is Not Null Then
    Select Count(*)
    Into v_Count
    From 病人医嘱记录 A, 诊疗项目目录 B
    Where a.病人id = 病人id_In And a.主页id = 主页id_In And a.诊疗项目id = b.Id And b.操作类型 = '5' And b.类别 = 'Z' And
          Nvl(a.婴儿, 0) <> 0 And a.医嘱状态 <> 4;
    If v_Count = 0 Then
      v_Error := '该病人的婴儿还在其他科室，并未下达出院医嘱,请先给婴儿下达出院医嘱后再出院。';
      Raise Err_Custom;
    End If;
  End If;

  v_Count := Nvl(zl_GetSysParameter('特殊医嘱发送前检查未生效医嘱', 1254), 0);
  If v_Count = 1 Then
    v_姓名 := Null;
    Select Max(姓名)
    Into v_姓名
    From 病人医嘱记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 医嘱状态 = 1 And Rownum = 1;
    If v_姓名 Is Not Null Then
      v_Error := v_姓名 || '存在未校对的医嘱，请删除或校对后再继续。';
      Raise Err_Custom;
    End If;
  
    v_姓名 := Null;
    Select Max(姓名)
    Into v_姓名
    From 病人医嘱记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 医嘱期效 = 1 And 医嘱状态 In (2, 3) And Nvl(执行标记, 0) <> -1 And
          Nvl(执行性质, 0) <> 0 And Rownum = 1;
    If v_姓名 Is Not Null Then
      v_Error := v_姓名 || '存在校对后未发送的临嘱，请发送或作废后再继续。';
      Raise Err_Custom;
    End If;
  End If;

  --判断是否产生住院日报
  Select Nvl(出院科室id, 入院科室id), 住院医师
  Into v_出院科室, v_住院医师
  From 病案主页
  Where 病人id = 病人id_In And 主页id = 主页id_In;
  Select Zl_住院日报_Count(v_出院科室, 出院时间_In) Into v_Count From Dual;
  If v_Count > 0 Then
    v_Error := '已产生业务时间内的住院日报,不能办理该业务!';
    Raise Err_Custom;
  End If;

  --判断是否与病案系统共享
  Begin
    Select 共享号 Into v_共享号 From zlSystems Where Floor(编号 / 100) = 3;
  Exception
    When Others Then
      Null;
  End;
  --出院变动
  Update 病人变动记录
  Set 终止时间 = 出院时间_In, 终止原因 = 1, 终止人员 = 操作员姓名_In, 上次计算时间 = Decode(Sign(Nvl(上次计算时间, 出院时间_In) - 出院时间_In), 1, Null, 上次计算时间)
  Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
  
  Update 病人自动计算
  Set 终止时间 = 出院时间_In, 终止原因 = 1, 终止人员 = 操作员姓名_In, 上次计算时间 = Decode(Sign(Nvl(上次计算时间, 出院时间_In) - 出院时间_In), 1, Null, 上次计算时间)
  Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
  
  --床位记录
  For r_Bedrow In c_Bedinfo Loop
    Update 床位状况记录
    Set 状态 = '空床', 病人id = Null, 科室id = Decode(共用, 1, Null, 科室id)
    Where 病区id = r_Bedrow.病区id And 床号 = r_Bedrow.床号;
  End Loop;

  --病案主页
  Update 病案主页
  Set 状态 = 0, 出院日期 = 出院时间_In, 出院方式 = 出院方式_In,
      住院天数 = Decode(Trunc(出院时间_In) - Trunc(入院日期), 0, 1, Trunc(出院时间_In) - Trunc(入院日期)), 随诊标志 = 随诊标志_In,
      随诊期限 = Decode(随诊期限_In, 0, Null, 随诊期限_In), 尸检标志 = 尸检标志_In, 是否确诊 = Decode(Nvl(是否疑诊_In, 0), 0, 0, 1), 确诊日期 = 确诊日期_In
  Where 病人id = 病人id_In And 主页id = 主页id_In;

  --产生病历书写时机
  Zl_电子病历时机_Insert(病人id_In, 主页id_In, 2, '出院', v_出院科室, v_住院医师, 出院时间_In, 出院时间_In);
  --增加随诊记录
  If v_共享号 = 100 Then
    If Nvl(随诊期限_In, 0) <> 0 Then
      If 随诊标志_In = 1 Then
        v_随诊期限 := Add_Months(出院时间_In, 随诊期限_In);
      Elsif 随诊标志_In = 2 Then
        v_随诊期限 := Add_Months(出院时间_In, 12 * 随诊期限_In);
      Elsif 随诊标志_In = 3 Then
        v_随诊期限 := 出院时间_In + 7 * 随诊期限_In;
      Elsif 随诊标志_In = 4 Then
        v_随诊期限 := 出院时间_In + 随诊期限_In;
      End If;
    Else
      v_随诊期限 := To_Date('3000-1-1', 'YYYY-MM-DD');
    End If;
  
    If 随诊标志_In = 1 Or 随诊标志_In = 2 Or 随诊标志_In = 3 Or 随诊标志_In = 4 Then
      If v_随诊期限 > Add_Months(出院时间_In, 3) Then
        v_应发时间 := Trunc(Add_Months(出院时间_In, 3));
      Else
        v_应发时间 := v_随诊期限;
      End If;
      v_Sql := 'Insert Into 随诊记录 (ID, 病人id, 主页id, 随诊期限, 应发时间) Values (随诊记录_Id.Nextval,:1,:2,:3,:4)';
      Execute Immediate v_Sql
        Using 病人id_In, 主页id_In, To_Date(To_Char(v_随诊期限, 'YYYY-MM-DD'), 'YYYY-MM-DD'), To_Date(To_Char(v_应发时间, 'YYYY-MM-DD'), 'YYYY-MM-DD');
    End If;
  End If;
  --病人信息
  v_年龄 := Zl_Age_Calc(病人id_In);
  Update 病人信息
  Set 当前科室id = Null, 当前病区id = Null, 当前床号 = Null, 出院时间 = 出院时间_In, 年龄 = v_年龄, 在院 = Null
  Where 病人id = 病人id_In;
  --在院病人
  Delete From 在院病人 Where 病人id = 病人id_In;
  --出院诊断
  If 出院诊断_In Is Not Null Or 疾病id_In Is Not Null Or 诊断id_In Is Not Null Then
    Delete From 病人诊断记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 = 3 And 诊断次序 = 1 And 记录来源 = 2;
    Insert Into 病人诊断记录
      (ID, 病人id, 主页id, 记录来源, 诊断类型, 诊断次序, 疾病id, 诊断id, 诊断描述, 是否疑诊, 出院情况, 记录日期, 记录人)
    Values
      (病人诊断记录_Id.Nextval, 病人id_In, 主页id_In, 2, 3, 1, 疾病id_In, 诊断id_In, 出院诊断_In, Decode(Nvl(是否疑诊_In, 0), 0, 1, 0),
       出院情况_In, Sysdate, 操作员姓名_In);
  End If;

  --中医出院诊断
  If 中医诊断_In Is Not Null Or 中医疾病id_In Is Not Null Or 中医诊断id_In Is Not Null Then
    Delete From 病人诊断记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 = 13 And 诊断次序 = 1 And 记录来源 = 2;
    Insert Into 病人诊断记录
      (ID, 病人id, 主页id, 记录来源, 诊断类型, 诊断次序, 疾病id, 诊断id, 诊断描述, 是否疑诊, 出院情况, 记录日期, 记录人)
    Values
      (病人诊断记录_Id.Nextval, 病人id_In, 主页id_In, 2, 13, 1, 中医疾病id_In, 中医诊断id_In, 中医诊断_In, Null, 中医出院情况_In, Sysdate, 操作员姓名_In);
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人变动记录_Out;
/

--107651:梁唐彬,2017-04-11,病人自动计算
Create Or Replace Procedure Zl_病人变动记录_Move
(
  病人id_In     病案主页.病人id%Type,
  主页id_In     病案主页.主页id%Type,
  换床时间_In   病人变动记录.开始时间%Type,
  床号_In       Varchar2,
  操作员编号_In 病人变动记录.操作员编号%Type,
  操作员姓名_In 病人变动记录.操作员姓名%Type,
  病区id_In     病人变动记录.病区id%Type,
  主床位_In     病人信息.当前床号%Type,
  对换病人id_In 病案主页.病人id%Type := Null
) As
  -----------------------------------------------------------
  --说明：病人换床
  --参数：
  --       床号=Null:家庭病床;"床号1,床号2,....床号n"
  --       对换病人ID_IN 床位对换必须传入病人ID
  -----------------------------------------------------------
  Cursor c_Bedinfo Is
    Select 病区id, 床号 From 床位状况记录 Where 病人id = 病人id_In;

  Cursor c_Oldinfo Is
    Select b.*
    From (Select c.*
           From 病人变动记录 c
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人变动记录
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 换床时间_In)) a, 病人变动记录 b
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位
    Union
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 换床时间_In;
    
  Cursor c_OldAutoinfo Is
    Select b.*
    From (Select c.*
           From 病人自动计算 c
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And C.性质 = 2 And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人自动计算
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 性质 = 2 And 开始时间 > 换床时间_In)) a, 病人自动计算 b
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.附加床位 = b.附加床位 And B.性质 = 2
    Union
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 换床时间_In And 性质 = 2;
    
  Cursor c_Futureinfo Is
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 0 And 开始时间 > 换床时间_In;
    
  Cursor c_FutureAutoinfo Is
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 0 And 开始时间 > 换床时间_In And 性质 = 2;
    
  r_Futureinfo c_Futureinfo %Rowtype;
  r_FutureAutoinfo c_FutureAutoinfo %Rowtype;
  b_Isdel      Boolean;
  b_IsAutodel      Boolean;
  r_Oldinfo    c_Oldinfo%Rowtype;
  r_OldAutoinfo    c_OldAutoinfo%Rowtype;
  v_终止原因   病人变动记录.终止原因%Type;
  v_终止时间   病人变动记录.终止时间%Type;
  v_终止人员   病人变动记录.终止人员%Type;
  v_Auto终止原因   病人变动记录.终止原因%Type;
  v_Auto终止时间   病人变动记录.终止时间%Type;
  v_Auto终止人员   病人变动记录.终止人员%Type;
  
  v_床号串 Varchar2(255);
  v_床号   Varchar2(255);
  v_等级id 床位状况记录.等级id%Type;
  v_年龄   病人信息.年龄%Type;
  n_病人id 病案主页.病人id%Type;
  n_病区id 病案主页.当前病区id%Type;

  v_Count Number;
  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  --并发操作检查
  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(状态, 0) = 0;

  If v_Count = 0 Then
    v_Error := '病人当前不处于正常住院状态,可能尚未入科,操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

  Select 当前病区id Into n_病区id From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;

  If n_病区id <> 病区id_In Then
    v_Error := '当前操作病区与病人实际病区不一致,病人病区已经更改,操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人后再试！';
    Raise Err_Custom;
  End If;

  --退除病人原床位
  v_Count := 0;
  For r_Bedrow In c_Bedinfo Loop
    v_Count := v_Count + 1;
    Update 床位状况记录
    Set 状态 = '空床', 病人id = Null, 科室id = Decode(共用, 1, Null, 科室id)
    Where 病区id = r_Bedrow.病区id And 床号 = r_Bedrow.床号;
  End Loop;
  If 对换病人id_In Is Not Null And v_Count > 1 Then
    v_Error := '操作失败,床位为' || v_床号 || '的病人为包床病人，不允许进行床位对换！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新后再试！';
    Raise Err_Custom;
  End If;

  Open c_Oldinfo; --必须先打开
  Fetch c_Oldinfo
    Into r_Oldinfo;
  Open c_OldAutoinfo; --必须先打开
  Fetch c_OldAutoinfo
    Into r_OldAutoinfo;
  Select Count(*)
  Into v_Count
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Null And 终止时间 Is Null;
  If v_Count > 0 Then
    v_Error := '该病人正在转科或转病区，不能进行其他变动！';
    Raise Err_Custom;
  End If;

  For r_Fee In (Select No
                From 住院费用记录
                Where 病人id = 病人id_In And 主页id = 主页id_In And Mod(记录性质, 10) = 3 And 登记时间 >= 换床时间_In And 收费类别 = 'J'
                Group By No, 序号, Mod(记录性质, 10)
                Having Sum(结帐金额) <> 0) Loop
    v_Error := '变动时间之后已有已结帐的自动记帐费用,不能进行换床操作！';
    Raise Err_Custom;
  End Loop;

  --取消上批变动记录
  If r_Oldinfo.终止时间 Is Not Null Then
    v_终止时间 := r_Oldinfo.终止时间;
    v_终止原因 := r_Oldinfo.终止原因;
    v_终止人员 := r_Oldinfo.终止人员;
    --取消上次变动
    Update 病人变动记录
    Set 终止时间 = 换床时间_In, 终止原因 = 4, 终止人员 = 操作员姓名_In, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因 = v_终止原因;
    --更新将来的记录如果有停止到将来的则删除上次计算时间
    Update 病人变动记录
    Set 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 换床时间_In;
  Else
    Update 病人变动记录
    Set 终止时间 = 换床时间_In, 终止原因 = 4, 终止人员 = 操作员姓名_In,
        上次计算时间 = Decode(Sign(Nvl(上次计算时间, 换床时间_In) - 换床时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
  End If;
  
  --病人自动计算费用所需数据
  If r_OldAutoinfo.终止时间 Is Not Null Then
    v_Auto终止时间 := r_OldAutoinfo.终止时间;
    v_Auto终止原因 := r_OldAutoinfo.终止原因;
    v_Auto终止人员 := r_OldAutoinfo.终止人员;
    --取消上次变动
    Update 病人自动计算
    Set 终止时间 = 换床时间_In, 终止原因 = 4, 终止人员 = 操作员姓名_In, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_Auto终止时间 And 终止原因 = v_Auto终止原因 And 性质 In(2,3);
    --更新将来的记录如果有停止到将来的则删除上次计算时间
    Update 病人自动计算
    Set 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 换床时间_In And 性质 In(2,3);
  Else
    Update 病人自动计算
    Set 终止时间 = 换床时间_In, 终止原因 = 4, 终止人员 = 操作员姓名_In,
        上次计算时间 = Decode(Sign(Nvl(上次计算时间, 换床时间_In) - 换床时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 性质 In(2,3);
  End If;

  --新增病人床位
  If 床号_In Is Null Then
    --家庭病床
    Insert Into 病人变动记录
      (Id, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 换床时间_In, 4, 0, 病区id_In, r_Oldinfo.科室id, r_Oldinfo.医疗小组id, r_Oldinfo.护理等级id,
       Null, Null, r_Oldinfo.责任护士, r_Oldinfo.经治医师, r_Oldinfo.主治医师, r_Oldinfo.主任医师, r_Oldinfo.病情, 操作员编号_In, 操作员姓名_In,
       v_终止时间, v_终止原因, v_终止人员);
    --如果修改了床位，则必须修改停止到将来的变动数
    If c_Oldinfo%Rowcount <> 1 Then
      --删除所有将来的附加床位的变动
      Delete From 病人变动记录
      Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 换床时间_In;
    End If;
    --如果有停到将来的情况，将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)
    Update 病人变动记录
    Set 床位等级id = Null, 床号 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 换床时间_In;
    
    --家庭病床
    Insert Into 病人自动计算
      (Id, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 换床时间_In, 4, 2, 0, 病区id_In, r_OldAutoinfo.科室id, 
       Null, Null, 操作员编号_In, 操作员姓名_In,v_Auto终止时间, v_Auto终止原因, v_Auto终止人员);
    Insert Into 病人自动计算
      (Id, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 换床时间_In, 4, 3, 0, 病区id_In, r_OldAutoinfo.科室id, 
       Null, Null, 操作员编号_In, 操作员姓名_In,v_Auto终止时间, v_Auto终止原因, v_Auto终止人员);
    --如果修改了床位，则必须修改停止到将来的变动数
    If c_OldAutoinfo%Rowcount <> 1 Then
      --删除所有将来的附加床位的变动
      Delete From 病人自动计算
      Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 换床时间_In And 性质 In(2,3);
    End If;
    --如果有停到将来的情况，将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)
    Update 病人自动计算
    Set 床位等级id = Null, 床号 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 换床时间_In And 性质 In(2,3);
  Else
    v_床号  := 床号_In || ',';
    v_Count := 0;
    While v_床号 Is Not Null Loop
      v_Count := v_Count + 1;
      v_床号  := Substr(v_床号, Instr(v_床号, ',') + 1);
    End Loop;
    If v_Count > 1 And 对换病人id_In Is Not Null Then
      v_Error := '操作失败,床位对换不允许包床！' || Chr(13) || Chr(10) || '这可能是调用过程传参错误,请与开发商联系！';
      Raise Err_Custom;
    End If;
    --如果修改了床位，则必须修改停止到将来的变动数
    b_Isdel := False;
    If c_Oldinfo%Rowcount <> v_Count Then
      --删除所有将来的附加床位的变动
      Delete From 病人变动记录
      Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 换床时间_In;
      b_Isdel := True;
    End If;
    
    --如果修改了床位，则必须修改停止到将来的变动数
    b_IsAutodel := False;
    If c_OldAutoinfo%Rowcount <> v_Count Then
      --删除所有将来的附加床位的变动
      Delete From 病人自动计算
      Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 换床时间_In And 性质 In(2,3);
      b_IsAutodel := True;
    End If;
  
    --入住一张或多张病床病床
    v_床号串 := 床号_In || ',';
  
    While v_床号串 Is Not Null Loop
      v_床号 := Substr(v_床号串, 1, Instr(v_床号串, ',') - 1);
    
      Select 等级id Into v_等级id From 床位状况记录 Where 病区id = 病区id_In And 床号 = v_床号;
    
      Insert Into 病人变动记录
        (Id, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 换床时间_In, 4, Decode(主床位_In, v_床号, 0, 1), 病区id_In, r_Oldinfo.科室id,
         r_Oldinfo.医疗小组id, r_Oldinfo.护理等级id, v_等级id, v_床号, r_Oldinfo.责任护士, r_Oldinfo.经治医师, r_Oldinfo.主治医师,
         r_Oldinfo.主任医师, r_Oldinfo.病情, 操作员编号_In, 操作员姓名_In, v_终止时间, v_终止原因, v_终止人员);
      
      Insert Into 病人自动计算
        (Id, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 换床时间_In, 4, 2, Decode(主床位_In, v_床号, 0, 1), 病区id_In, r_OldAutoinfo.科室id,
         v_等级id, v_床号,  操作员编号_In, 操作员姓名_In, v_Auto终止时间, v_Auto终止原因, v_Auto终止人员);
      
      Insert Into 病人自动计算
        (Id, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 换床时间_In, 4, 3, Decode(主床位_In, v_床号, 0, 1), 病区id_In, r_OldAutoinfo.科室id,
         v_等级id, v_床号,  操作员编号_In, 操作员姓名_In, v_Auto终止时间, v_Auto终止原因, v_Auto终止人员);
        
      --换床检查床位是否为空：床位对换如果目标床位不为空，则检查是否是床位对换的病人
      Select Count(*) Into v_Count From 床位状况记录 Where 病区id = 病区id_In And 床号 = v_床号 And 状态 = '空床';
      If 对换病人id_In Is Null Then
        If v_Count = 0 Then
          v_Error := '操作失败,床位 ' || v_床号 || ' 不是空床！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新后再试！';
          Raise Err_Custom;
        End If;
      Else
        If v_Count = 0 Then
          Select Max(病人id) Into n_病人id From 床位状况记录 Where 病区id = 病区id_In And 床号 = v_床号;
          If n_病人id Is Null Then
            v_Error := '操作失败,床位 ' || v_床号 || ' 不是有效的床位！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新后再试！';
            Raise Err_Custom;
          End If;
          If n_病人id <> 对换病人id_In Then
            v_Error := '操作失败,床位 ' || v_床号 || ' 不是空床,且对换床位的病人发生了变化！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新后再试！';
            Raise Err_Custom;
          End If;
        End If;
      End If;
    
      Update 床位状况记录
      Set 状态 = '占用', 病人id = 病人id_In, 科室id = Decode(共用, 1, r_Oldinfo.科室id, 科室id)
      Where 病区id = 病区id_In And 床号 = v_床号;
    
      If b_Isdel = True Then
        --如果有停到将来的情况且有床位数变动,将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)和插入附加床位数据。
        If 主床位_In = v_床号 Then
          --如果是主床位则修改将来的主记录信息，如果不是主床位，就新插入数据
          Update 病人变动记录
          Set 床位等级id = v_等级id, 床号 = v_床号, 病区id = 病区id_In
          Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 换床时间_In And 附加床位 = 0;
        Else
          Open c_Futureinfo; --必须先打开
          Fetch c_Futureinfo
            Into r_Futureinfo;
          --循环停到将来的数据，进行附加床位插入
          While c_Futureinfo%Found Loop
            Insert Into 病人变动记录
              (Id, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情,
               操作员编号, 操作员姓名, 终止时间, 终止原因, 终止人员)
            Values
              (病人变动记录_Id.Nextval, r_Futureinfo.病人id, r_Futureinfo.主页id, r_Futureinfo.开始时间, r_Futureinfo.开始原因, 1,
               病区id_In, r_Futureinfo.科室id, r_Futureinfo.医疗小组id, r_Futureinfo.护理等级id, v_等级id, v_床号, r_Futureinfo.责任护士,
               r_Futureinfo.经治医师, r_Futureinfo.主治医师, r_Futureinfo.主任医师, r_Futureinfo.病情, r_Futureinfo.操作员编号,
               r_Futureinfo.操作员姓名, r_Futureinfo.终止时间, r_Futureinfo.终止原因, r_Futureinfo.终止人员);
            Fetch c_Futureinfo
              Into r_Futureinfo;
          End Loop;
          Close c_Futureinfo;
        End If;
      End If;
      
      If b_IsAutodel = True Then
        --如果有停到将来的情况且有床位数变动,将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)和插入附加床位数据。
        If 主床位_In = v_床号 Then
          --如果是主床位则修改将来的主记录信息，如果不是主床位，就新插入数据
          Update 病人自动计算
          Set 床位等级id = v_等级id, 床号 = v_床号, 病区id = 病区id_In
          Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 换床时间_In And 附加床位 = 0 And 性质 In(2,3);
        Else
          Open c_FutureAutoinfo; --必须先打开
          Fetch c_FutureAutoinfo
            Into r_FutureAutoinfo;
          --循环停到将来的数据，进行附加床位插入
          While c_FutureAutoinfo%Found Loop
            Insert Into 病人自动计算
              (Id, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id,  床位等级id, 床号,
               操作员编号, 操作员姓名, 终止时间, 终止原因, 终止人员)
            Values
              (病人自动计算_Id.Nextval, r_FutureAutoinfo.病人id, r_FutureAutoinfo.主页id, r_FutureAutoinfo.开始时间, r_FutureAutoinfo.开始原因, 2, 1,
               病区id_In, r_FutureAutoinfo.科室id, v_等级id, v_床号, r_FutureAutoinfo.操作员编号,
               r_FutureAutoinfo.操作员姓名, r_FutureAutoinfo.终止时间, r_FutureAutoinfo.终止原因, r_FutureAutoinfo.终止人员);
            Insert Into 病人自动计算
              (Id, 病人id, 主页id, 开始时间, 开始原因, 性质, 附加床位, 病区id, 科室id,  床位等级id, 床号,
               操作员编号, 操作员姓名, 终止时间, 终止原因, 终止人员)
            Values
              (病人自动计算_Id.Nextval, r_FutureAutoinfo.病人id, r_FutureAutoinfo.主页id, r_FutureAutoinfo.开始时间, r_FutureAutoinfo.开始原因, 3, 1,
               病区id_In, r_FutureAutoinfo.科室id, v_等级id, v_床号, r_FutureAutoinfo.操作员编号,
               r_FutureAutoinfo.操作员姓名, r_FutureAutoinfo.终止时间, r_FutureAutoinfo.终止原因, r_FutureAutoinfo.终止人员);
			Fetch c_FutureAutoinfo
              Into r_FutureAutoinfo;
          End Loop;
          Close c_FutureAutoinfo;
        End If;
      End If;
    
      v_床号串 := Substr(v_床号串, Instr(v_床号串, ',') + 1);
    End Loop;
  End If;
  Close c_Oldinfo;
  Close c_OldAutoinfo;

  --病人信息、病案主页

  Update 病案主页
  Set 出院病床 = Decode(床号_In, Null, Null, 主床位_In), 当前病区id = 病区id_In
  Where 病人id = 病人id_In And 主页id = 主页id_In;

  v_年龄 := Zl_Age_Calc(病人id_In);
  Update 病人信息
  Set 当前床号 = Decode(床号_In, Null, Null, 主床位_In), 当前病区id = 病区id_In, 年龄 = v_年龄
  Where 病人id = 病人id_In;

  --在院病人
  Update 在院病人 Set 病区id = 病区id_In Where 病人id = 病人id_In;

  --并发操作检查
  Select Count(*)
  Into v_Count
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(附加床位, 0) = 0 And 开始时间 Is Not Null And 终止时间 Is Null;

  If v_Count > 1 Then
    v_Error := '发现病人存在非法的变动记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 出院日期 Is Null;
  If v_Count = 0 Then
    v_Error := '操作失败,该病人已出院,不能进行当前操作.' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态！';
    Raise Err_Custom;
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病人变动记录_Move;
/

--102751:刘尔旋,2017-04-11,病人挂号记录对应收费单
Create Or Replace Procedure Zl_Third_Reghistory
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取历史挂号数据
  --入参:Xml_In:
  --<IN>
  --   <BRID>88393</BRID>    //卡号
  --   <JLS>5</JLS >       //记录条数，按日期由近到远
  --   <JSKLB></JSKLB>     //结算卡类别
  --   <ZD></ZD>           //站点
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --   <GHLIST>       //如果为空表示没有找到数据
  --    <GH>
  --     <GHDH>N001</GHDH>   //挂号单号
  --     <KS>门诊外科</KS>     //挂号科室
  --     <KSID>42</KSID>    //科室id
  --     <DJSJ>2014-10-21 14:12:44</DJSJ>    //登记时间
  --     <YYSJ>2014-10-21 14:10</YYSJ>    //预约时间
  --     <ZXZT>1</ZXZT>     //状态(预约中等待付款、已挂号、候诊等)
  --     <DDFK>1</DDFK>     //是否付款
  --     <GHFS>支付宝</GHFS>    //挂号方式(支付宝、自助机、窗口)
  --     <YSXM>LEX</YSXM>    //医生姓名
  --    </GH>
  --   </GHLIST>
  --   <ERROR><MSG>错误信息</MSG></ERROR>     //如果有错误返回
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_费别         病人信息.费别%Type;
  v_付款方式     病人信息.医疗付款方式%Type;
  v_姓名         病人信息.姓名%Type;
  v_性别         病人信息.性别%Type;
  v_年龄         病人信息.年龄%Type;
  d_出生日期     病人信息.出生日期%Type;
  v_身份证号     病人信息.身份证号%Type;
  v_卡类别       医疗卡类别.名称%Type;
  v_卡号         病人医疗卡信息.卡号%Type;
  n_卡类别id     医疗卡类别.Id%Type;
  v_结算方式     医疗卡类别.结算方式%Type;
  v_验证姓名     病人信息.姓名%Type;
  n_病人id       病人信息.病人id%Type;
  n_卡病人id     病人信息.病人id%Type;
  v_医疗卡编码   医疗卡类别.编码%Type;
  n_是否缺省密码 医疗卡类别.是否缺省密码%Type;
  v_密码         病人医疗卡信息.密码%Type;
  n_密码长度     医疗卡类别.密码长度%Type;
  n_记录数       Number(4);
  v_结算卡类别   Varchar2(100);
  n_是否付款     Number(3);
  v_Temp         Varchar2(32767); --临时XML
  x_Templet      Xmltype; --模板XML
  v_Err_Msg      Varchar2(200);
  n_Exists       Number(2);
  v_状态         Varchar2(100);
  n_站点         Number(1);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT><GHLIST></GHLIST></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/JLS'), Extractvalue(Value(A), 'IN/JSKLB'),
         Extractvalue(Value(A), 'IN/ZD')
  Into n_病人id, n_记录数, v_结算卡类别, n_站点
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_结算卡类别 Is Not Null Then
    Begin
      n_卡类别id := To_Number(v_结算卡类别);
    Exception
      When Others Then
        n_卡类别id := 0;
    End;
    If n_卡类别id = 0 Then
      Begin
        Select ID Into n_卡类别id From 医疗卡类别 Where 名称 = v_结算卡类别;
      Exception
        When Others Then
          v_Err_Msg := '无法确认传入的结算卡！';
          Raise Err_Item;
      End;
    End If;
  Else
    n_卡类别id := 0;
  End If;

  n_记录数 := Nvl(n_记录数, 0);

  If Nvl(n_卡类别id, 0) = 0 Then
    For r_Reg In (Select Distinct a.No, a.执行部门id As 科室id, b.名称 As 科室, a.登记时间 As 创建时间, a.发生时间 As 预约时间,
                                  Decode(a.记录性质, 2, '预约中',
                                          Decode(a.执行状态, -1, '不就诊', 0, '等待就诊', 1, '完成就诊', 2, '正在就诊', '已挂号')) As 状态,
                                  Decode(c.记录状态, 0, 0, 1) As 是否付款, a.预约方式 As 挂号方式, a.执行人 As 医生姓名, a.收费单


                  From 病人挂号记录 A, 部门表 B, 门诊费用记录 C
                  Where a.病人id = n_病人id And a.执行部门id = b.Id And c.No = a.No And c.序号 = 1 And c.记录性质 = 4 And a.记录状态 = 1 And
                        (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null)
                  Order By a.登记时间 Desc) Loop
      If n_记录数 <> 0 Then
        Begin
          Select Decode(记录状态, 0, 0, 1)
          Into n_是否付款
          From 门诊费用记录
          Where 记录性质 = 1 And 病人id = n_病人id And NO = r_Reg.收费单 And Rownum < 2;
        Exception
          When Others Then
            n_是否付款 := r_Reg.是否付款;
        End;
        If n_是否付款 = 0 And r_Reg.状态 = '预约中' And Sysdate > r_Reg.预约时间 Then
          v_状态 := '已失效';
        Else
          v_状态 := r_Reg.状态;
        End If;
        v_Temp := '<GH>' || '<GHDH>' || r_Reg.No || '</GHDH>' || '<KS>' || r_Reg.科室 || '</KS>' || '<KSID>' ||
                  r_Reg.科室id || '</KSID>' || '<DJSJ>' || To_Char(r_Reg.创建时间, 'YYYY-MM-DD hh24:mi:ss') || '</DJSJ>' ||
                  '<YYSJ>' || To_Char(r_Reg.预约时间, 'YYYY-MM-DD hh24:mi:ss') || '</YYSJ>' || '<ZXZT>' || v_状态 ||
                  '</ZXZT>' || '<DDFK>' || n_是否付款 || '</DDFK>' || '<GHFS>' || r_Reg.挂号方式 || '</GHFS>' || '<YSXM>' ||
                  r_Reg.医生姓名 || '</YSXM>' || '</GH>';
        Select Appendchildxml(x_Templet, '/OUTPUT/GHLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        n_记录数 := n_记录数 - 1;
      End If;
    End Loop;
  Else
    For r_Reg In (Select Distinct a.No, a.执行部门id As 科室id, b.名称 As 科室, a.登记时间 As 创建时间, a.发生时间 As 预约时间,
                                  Decode(a.记录性质, 2, '预约中',
                                          Decode(a.执行状态, -1, '不就诊', 0, '等待就诊', 1, '完成就诊', 2, '正在就诊', '已挂号')) As 状态,
                                  Decode(c.记录状态, 0, 0, 1) As 是否付款, a.预约方式 As 挂号方式, a.执行人 As 医生姓名, a.收费单


                  From 病人挂号记录 A, 部门表 B, 门诊费用记录 C, 病人预交记录 D
                  Where a.病人id = n_病人id And a.执行部门id = b.Id And c.No = a.No And c.序号 = 1 And c.记录性质 = 4 And a.记录状态 = 1 And
                        c.结帐id = d.结帐id And (d.卡类别id = n_卡类别id Or d.卡类别id Is Null) And Not Exists
                   (Select 1
                         From 病人预交记录
                         Where 结帐id = c.结帐id And Nvl(卡类别id, 0) <> 0 And Nvl(卡类别id, 0) <> n_卡类别id) And
                        (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null)
                  Order By a.登记时间 Desc) Loop
      If n_记录数 <> 0 Then
        Begin
          Select Decode(记录状态, 0, 0, 1)
          Into n_是否付款
          From 门诊费用记录
          Where 记录性质 = 1 And 病人id = n_病人id And NO = r_Reg.收费单 And Rownum < 2;
        Exception
          When Others Then
            n_是否付款 := r_Reg.是否付款;
        End;
        If n_是否付款 = 0 And r_Reg.状态 = '预约中' And Sysdate > r_Reg.预约时间 Then
          v_状态 := '已失效';
        Else
          v_状态 := r_Reg.状态;
        End If;
        v_Temp := '<GH>' || '<GHDH>' || r_Reg.No || '</GHDH>' || '<KS>' || r_Reg.科室 || '</KS>' || '<KSID>' ||
                  r_Reg.科室id || '</KSID>' || '<DJSJ>' || To_Char(r_Reg.创建时间, 'YYYY-MM-DD hh24:mi:ss') || '</DJSJ>' ||
                  '<YYSJ>' || To_Char(r_Reg.预约时间, 'YYYY-MM-DD hh24:mi:ss') || '</YYSJ>' || '<ZXZT>' || v_状态 ||
                  '</ZXZT>' || '<DDFK>' || n_是否付款 || '</DDFK>' || '<GHFS>' || r_Reg.挂号方式 || '</GHFS>' || '<YSXM>' ||
                  r_Reg.医生姓名 || '</YSXM>' || '</GH>';
        Select Appendchildxml(x_Templet, '/OUTPUT/GHLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        n_记录数 := n_记录数 - 1;
      End If;
    End Loop;
  End If;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Reghistory;
/

--102751:刘尔旋,2017-04-11,病人挂号记录对应收费单
Create Or Replace Procedure Zl_Third_Waitingpay
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:获取待付款收费单(即付款单据)
  --入参:Xml_In: 
  --<IN>
  --    <GHDH>挂号单号</GHDH>
  --</IN>
  --出参:Xml_Out 
  --<OUTPUT>
  --        <FYLIST> 如果为空表示未找到数据
  --            <FY>
  --                <NO>单据号</NO>                           
  --                <KDSJ>开单时间</SJ>                           
  --                <KDKS>开单科室</KDKS>                     
  --                <YS></YS>                           //医生
  --                <SFGH></SFGH>                       //是否挂号单,0-收费单,1-挂号单
  --                <FMLIST>
  --                    <FM>
  --                        <MC></MC>                           //费目名称
  --                        <MXLIST>
  --                            <MX>
  --                                <XMMC></XMMC>           //项目名称
  --                                <GG></GG>                   //规格
  --                                <DW></DW>               //单位
  --                                <SL></SL>                   //数量
  --                                <DJ></DJ>                   //单价
  --                                <YSJE></YSJE>               //应收金额
  --                                <SSJE></SSJE>               //实收金额
  --                            </MX>
  --                        </MXLIST>
  --                    </FM>
  --                </FMLIST>
  --            </FY>
  --        </FYLIST>
  --        <ERROR><MSG></MSG></ERROR>                  //如果有错误返回
  --</OUTPUT>

  -------------------------------------------------------------------------------------------------- 
  v_Err_Msg Varchar2(200);
  Err_Item Exception;
  x_Templet Xmltype; --模板XML 

  v_挂号单     Varchar2(10);
  n_预约挂号单 Number(3);
  n_Count      Number(18);

  v_Temp Varchar2(32767); --临时XML 
  v_No   Varchar2(50);
  v_费目 Varchar2(50);

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/GHDH') Into v_挂号单 From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_挂号单 Is Null Then
    v_Err_Msg := '不能找到指定的挂号单号(当前挂号单号为空)';
    Raise Err_Item;
  End If;

  --1.检查是否有挂号单
  Select Count(*) Into n_Count From 病人挂号记录 A Where NO = v_挂号单;
  If Nvl(n_Count, 0) = 0 Then
    v_Err_Msg := '未找到指定的挂号单据:' || v_挂号单 || '!';
    Raise Err_Item;
  End If;

  If Nvl(n_Count, 0) > 1 Then
    v_Err_Msg := '单据号:' || v_挂号单 || '已经被退号!';
    Raise Err_Item;
  End If;

  Begin
    Select 1 Into n_预约挂号单 From 病人挂号记录 Where NO = v_挂号单 And 记录性质 = 2;
  Exception
    When Others Then
      n_预约挂号单 := 0;
  End;
  --2.费用汇总
  v_No   := '-_';
  v_费目 := '-_';
  If n_预约挂号单 = 0 Then
    --正常挂号
    For c_费用 In (Select 1 As 顺序号, b.No, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人,
                        To_Char(b.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, Nvl(b.价格父号, b.序号) As 序号, b.收费细目id, b.计算单位,
                        Max(m.名称) As 名称, Max(m.规格) As 规格, Sum(b.标准单价) As 单价, Avg(Nvl(b.付数, 1) * b.数次) As 数量,
                        Sum(b.实收金额) As 实收金额, Max(j.名称) As 开单科室, Max(q.名称) As 执行科室
                 From 门诊费用记录 B, 收费项目目录 M, 部门表 J, 部门表 Q
                 Where b.No In (Select 收费单 From 病人挂号记录 Where NO = v_挂号单) And Mod(b.记录性质, 10) = 1 And Nvl(b.费用状态, 0) = 0 And
                       b.记录状态 = 0 And b.收费细目id = m.Id And b.开单部门id = j.Id(+) And b.执行部门id = q.Id(+)
                 Group By b.No, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人, b.登记时间, Nvl(b.价格父号, b.序号), b.收费细目id, b.计算单位
                 Union All
                 
                 Select 1 As 顺序号, b.No, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人,
                        To_Char(b.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, Nvl(b.价格父号, b.序号) As 序号, b.收费细目id, b.计算单位,
                        Max(m.名称) As 名称, Max(m.规格) As 规格, Sum(b.标准单价) As 单价, Avg(Nvl(b.付数, 1) * b.数次) As 数量,
                        Sum(b.实收金额) As 实收金额, Max(j.名称) As 开单科室, Max(q.名称) As 执行科室
                 From 病人医嘱记录 A1, 门诊费用记录 B, 收费项目目录 M, 部门表 J, 部门表 Q
                 Where A1.挂号单 = v_挂号单 And Mod(b.记录性质, 10) = 1 And A1.Id = b.医嘱序号 And Nvl(b.费用状态, 0) = 0 And b.记录状态 = 0 And
                       b.收费细目id = m.Id And b.开单部门id = j.Id(+) And b.执行部门id = q.Id(+)
                 Group By b.No, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人, b.登记时间, Nvl(b.价格父号, b.序号), b.收费细目id, b.计算单位
                 Order By 顺序号, NO, 收据费目, 序号) Loop
      If v_No <> c_费用.No Then
        v_Temp := '<NO>' || c_费用.No || '</NO>';
        v_Temp := v_Temp || '<KDSJ>' || c_费用.登记时间 || '</KDSJ>';
        v_Temp := v_Temp || '<KDKS>' || c_费用.开单科室 || '</KDKS>';
        v_Temp := v_Temp || '<YS>' || c_费用.开单人 || '</YS>';
        v_Temp := v_Temp || '<SFGH>' || n_预约挂号单 || '</SFGH>';
        v_Temp := '<FYLIST NO="' || c_费用.No || '"><FY>' || v_Temp || '<FMLIST></FMLIST></FY></FYLIST>';
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
        v_No   := c_费用.No;
        v_费目 := '-_';
      End If;
    
      If v_费目 <> c_费用.收据费目 Then
      
        v_费目 := c_费用.收据费目;
      
        v_Temp := '<MC>' || v_费目 || '</MC>';
        v_Temp := '<FM SJFM="' || v_费目 || '">' || v_Temp || '<MXLIST></MXLIST></FM>';
        Select Appendchildxml(x_Templet, '/OUTPUT/FYLIST[@NO="' || v_No || '"]/FY/FMLIST', Xmltype(v_Temp))
        Into x_Templet
        From Dual;
      End If;
    
      v_Temp := '<XMMC>' || c_费用.名称 || '</XMMC>';
      v_Temp := v_Temp || '<GG>' || c_费用.规格 || '</GG>';
      v_Temp := v_Temp || '<SL>' || c_费用.数量 || '</SL>';
      v_Temp := v_Temp || '<DW>' || c_费用.计算单位 || '</DW>';
      v_Temp := v_Temp || '<SL>' || c_费用.数量 || '</SL>';
      v_Temp := v_Temp || '<DJ>' || c_费用.单价 || '</DJ>';
      v_Temp := v_Temp || '<YSJE>' || c_费用.实收金额 || '</YSJE>';
      v_Temp := v_Temp || '<SSJE>' || c_费用.实收金额 || '</SSJE>';
    
      v_Temp := '<MX>' || v_Temp || '</MX>';
    
      Select Appendchildxml(x_Templet,
                             '/OUTPUT/FYLIST[@NO="' || v_No || '"]/FY/FMLIST/FM[@SJFM="' || v_费目 || '"]/MXLIST',
                             Xmltype(v_Temp))
      
      Into x_Templet
      From Dual;
    End Loop;
  Else
    --预约挂号
    For c_费用 In (Select 1 As 顺序号, b.No, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人,
                        To_Char(b.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, Nvl(b.价格父号, b.序号) As 序号, b.收费细目id, b.计算单位,
                        Max(m.名称) As 名称, Max(m.规格) As 规格, Sum(b.标准单价) As 单价, Avg(Nvl(b.付数, 1) * b.数次) As 数量,
                        Sum(b.实收金额) As 实收金额, Max(j.名称) As 开单科室, Max(q.名称) As 执行科室
                 From 门诊费用记录 B, 收费项目目录 M, 部门表 J, 部门表 Q
                 Where b.No = v_挂号单 And b.记录性质 = 4 And
                       b.收费细目id Not In (Select 收费细目id From 收费特定项目 Where 特定项目 = '病历费') And Nvl(b.费用状态, 0) = 0 And
                       b.记录状态 = 0 And b.收费细目id = m.Id And b.开单部门id = j.Id(+) And b.执行部门id = q.Id(+)
                 Group By b.No, b.收据费目, b.结帐id, b.执行部门id, b.开单部门id, b.开单人, b.登记时间, Nvl(b.价格父号, b.序号), b.收费细目id, b.计算单位) Loop
      If v_No <> c_费用.No Then
        v_Temp := '<NO>' || c_费用.No || '</NO>';
        v_Temp := v_Temp || '<KDSJ>' || c_费用.登记时间 || '</KDSJ>';
        v_Temp := v_Temp || '<KDKS>' || c_费用.开单科室 || '</KDKS>';
        v_Temp := v_Temp || '<YS>' || c_费用.开单人 || '</YS>';
        v_Temp := v_Temp || '<SFGH>' || n_预约挂号单 || '</SFGH>';
        v_Temp := '<FYLIST NO="' || c_费用.No || '"><FY>' || v_Temp || '<FMLIST></FMLIST></FY></FYLIST>';
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
        v_No   := c_费用.No;
        v_费目 := '-_';
      End If;
    
      If v_费目 <> c_费用.收据费目 Then
      
        v_费目 := c_费用.收据费目;
      
        v_Temp := '<MC>' || v_费目 || '</MC>';
        v_Temp := '<FM SJFM="' || v_费目 || '">' || v_Temp || '<MXLIST></MXLIST></FM>';
        Select Appendchildxml(x_Templet, '/OUTPUT/FYLIST[@NO="' || v_No || '"]/FY/FMLIST', Xmltype(v_Temp))
        Into x_Templet
        From Dual;
      End If;
    
      v_Temp := '<XMMC>' || c_费用.名称 || '</XMMC>';
      v_Temp := v_Temp || '<GG>' || c_费用.规格 || '</GG>';
      v_Temp := v_Temp || '<SL>' || c_费用.数量 || '</SL>';
      v_Temp := v_Temp || '<DW>' || c_费用.计算单位 || '</DW>';
      v_Temp := v_Temp || '<SL>' || c_费用.数量 || '</SL>';
      v_Temp := v_Temp || '<DJ>' || c_费用.单价 || '</DJ>';
      v_Temp := v_Temp || '<YSJE>' || c_费用.实收金额 || '</YSJE>';
      v_Temp := v_Temp || '<SSJE>' || c_费用.实收金额 || '</SSJE>';
    
      v_Temp := '<MX>' || v_Temp || '</MX>';
    
      Select Appendchildxml(x_Templet,
                             '/OUTPUT/FYLIST[@NO="' || v_No || '"]/FY/FMLIST/FM[@SJFM="' || v_费目 || '"]/MXLIST',
                             Xmltype(v_Temp))
      Into x_Templet
      From Dual;
    End Loop;
  End If;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Waitingpay;
/

--102751:刘尔旋,2017-04-11,病人挂号记录对应收费单
Create Or Replace Procedure Zl_Third_Charge_Del
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is

  -------------------------------------------------------------------------------------------------- 
  --功能:三方退费交易 
  --入参:Xml_In: 
  --<IN>
  --    <BRID>病人ID</BRID>
  --    <JE></JE> //退款总金额
  --    <JSKLB></JSKLB>     //结算卡类别
  --    <TFZY>退费摘要</TFZY>
  --    <JCFP>1</JCFP>      //检查发票
  --    <FYLIST>
  --        <FY>
  --           <DJH>退款单据号</DJH>
  --           <XH>退款序号(格式:1,2,3..为空代表退剩余数量)</DJH>
  --        <FY>
  --    </FYLIST>
  --    <TKLIST>
  --        <TK>
  --            <TKKLB>退款卡类别</TKKLB>
  --            <TKKH>退款卡号</TKKH>
  --            <TKFS>退款方式</TKFS> //退款方式:现金;支票,如果是三方卡,可以传空
  --            <TKJE>支付金额</TKJE>
  --            <JYLSH>交易流水号</JYLSH>
  --            <TKZY>摘要</TKZY>
  --            <TYJK>退回预交款</TYJK> //允冲预交时,只填JSJE节点:1-冲预交
  --            <SFXFK>是否消费卡</SFXFK>   //(1-是消费卡),消费卡时,传入结算卡类别,结算卡号,结算金额等接点
  --            <EXPENDLIST>  //扩展交易信息
  --                <EXPEND>
  --                    <JYMC>交易名称</JYMC>
  --                    <JYLR>交易内容</JYLR>
  --                </EXPEND>
  --            </EXPENDLIST>
  --        </TK>
  --    </TKLIST>
  --</IN>

  --出参:Xml_Out 
  --  <OUT> 
  --    <CZSJ>操作时间</CZSJ>          //HIS的登记时间
  --    <YJZID>原结帐ID</YJZID>       //原结帐ID
  --    <CXID>冲销ID</CXID>          //冲销ID
  --    DD如无下列错误结点则说明正确执行 
  --    <ERROR> 
  --      <MSG>错误信息</MSG> 
  --    </ERROR> 
  --  </OUT> 
  -------------------------------------------------------------------------------------------------- 
  n_退款总额 门诊费用记录.实收金额%Type;
  n_卡类别id 医疗卡类别.Id%Type;
  v_结算方式 Varchar2(2000);

  n_病人id     门诊费用记录.病人id%Type;
  n_单据病人id 门诊费用记录.病人id%Type;
  v_操作员编码 门诊费用记录.操作员编号%Type;
  v_操作员姓名 门诊费用记录.操作员姓名%Type;
  n_冲销id     门诊费用记录.结帐id%Type;
  n_结帐id     门诊费用记录.结帐id%Type;
  n_结帐金额   门诊费用记录.结帐金额%Type;
  n_误差额     病人预交记录.冲预交%Type;
  n_原结算序号 病人预交记录.结算序号%Type;
  l_挂号单     t_Strlist := t_Strlist();
  v_挂号单     门诊费用记录.No%Type;
  n_检查发票   Number(3);
  n_是否打印   Number(3);
  v_结算卡类别 Varchar2(100);
  v_结帐ids    Varchar2(1000);

  n_消费卡id 消费卡目录.Id%Type;
  v_摘要     门诊费用记录.摘要%Type;
  n_Count    Number(18);

  d_退费时间 病人预交记录.收款时间%Type;

  v_退费结算 Varchar2(2000);
  v_普通结算 Varchar2(4000);
  n_Temp     Number(18);

  v_Temp    Varchar2(32767); --临时XML 
  x_Templet Xmltype; --模板XML 

  v_Err_Msg Varchar2(200);
  Err_Item Exception;
  Procedure Third_Cardbalance_Modfiy
  (
    冲销id_In     病人预交记录.结帐id%Type,
    卡类别_In     Varchar2,
    卡号_In       病人预交记录.卡号%Type,
    退款金额_In   病人预交记录.冲预交%Type,
    交易流水号_In 病人预交记录.交易流水号%Type,
    交易说明_In   病人预交记录.交易说明%Type,
    摘要_In       病人预交记录.摘要%Type,
    Xmlexpned_In  Xmltype
  ) Is
    n_卡类别id 医疗卡类别.Id%Type;
    v_结算方式 病人预交记录.结算方式%Type;
  
  Begin
    v_Err_Msg := Null;
    Begin
      n_卡类别id := To_Number(卡类别_In);
    Exception
      When Others Then
        n_卡类别id := 0;
    End;
    If n_卡类别id = 0 Then
      Begin
        Select ID, 结算方式, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!')
        Into n_卡类别id, v_结算方式, v_Err_Msg
        From 医疗卡类别
        Where 名称 = 卡类别_In;
      Exception
        When Others Then
          n_卡类别id := -1;
          v_Err_Msg  := 卡类别_In || '不存在!';
      End;
    Else
      Begin
        Select ID, 结算方式, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!')
        Into n_卡类别id, v_结算方式, v_Err_Msg
        From 医疗卡类别
        Where ID = n_卡类别id;
      Exception
        When Others Then
          n_卡类别id := -1;
          v_Err_Msg  := '未找到指定的结算支付信息!';
      End;
    End If;
    If Not v_Err_Msg Is Null Then
      Raise Err_Item;
    End If;
  
    v_退费结算 := v_结算方式 || '|' || 退款金额_In || '|' || ' |' || Nvl(摘要_In, ' ');
    --   2.三方卡退费结算:
    --     ①结算方式_IN:只能传入一个结算方式,但允许包含一些辅助信息,格式为:结算方式|结算金额|结算号码|结算摘要
    --     ②卡类别ID_IN,卡号_IN,交易流水号_IN,交易说明_In:需要传入
    --结算方式|结算金额|结算号码|结算摘要 
    Zl_门诊退费结算_Modify(2, n_病人id, 冲销id_In, v_退费结算, 0, n_卡类别id, 卡号_In, 交易流水号_In, 交易说明_In, 0, 0, 0, 0);
  
    --保存扩展结算信息
    For c_扩展 In (Select Extractvalue(j.Column_Value, '/EXPEND/JYMC') As Jymc,
                        Extractvalue(j.Column_Value, '/EXPEND/JYLR') As Jylr
                 From Table(Xmlsequence(Extract(Xmlexpned_In, '/EXPENDLIST/EXPEND'))) J) Loop
      Zl_三方结算交易_Insert(n_卡类别id, 0, 卡号_In, 冲销id_In, c_扩展.Jymc || '|' || c_扩展.Jylr, 0);
    End Loop;
  End Third_Cardbalance_Modfiy;

  Procedure Square_Cardbalance_Modfiy
  (
    冲销id_In     病人预交记录.结帐id%Type,
    卡类别_In     Varchar2,
    卡号_In       病人预交记录.卡号%Type,
    退款金额_In   病人预交记录.冲预交%Type,
    交易流水号_In 病人预交记录.交易流水号%Type,
    交易说明_In   病人预交记录.交易说明%Type,
    摘要_In       病人预交记录.摘要%Type,
    
    Xmlexpned_In Xmltype
  ) Is
    n_卡类别id 医疗卡类别.Id%Type;
    v_结算方式 病人预交记录.结算方式%Type;
  
  Begin
    v_Err_Msg := Null;
    Begin
      n_卡类别id := To_Number(卡类别_In);
    Exception
      When Others Then
        n_卡类别id := 0;
    End;
  
    If n_卡类别id = 0 Then
      Begin
        Select 编号, 结算方式, Decode(Nvl(启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!')
        Into n_卡类别id, v_结算方式, v_Err_Msg
        From 卡消费接口目录
        Where 名称 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := '消费:' || 卡类别_In || '不存在!';
      End;
    
    Else
    
      Begin
        Select 编号, 结算方式, Decode(Nvl(启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!')
        Into n_卡类别id, v_结算方式, v_Err_Msg
        From 卡消费接口目录
        Where 编号 = 卡类别_In;
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息!';
      End;
    
    End If;
    If Not v_Err_Msg Is Null Then
      Raise Err_Item;
    End If;
  
    v_退费结算 := v_结算方式 || '|' || 退款金额_In || '|' || ' |' || Nvl(摘要_In, ' ');
    --   4-消费卡结算:
    --     ①结算方式_IN:允许一次刷多张卡,格式为:卡类别ID|卡号|消费卡ID|消费金额||
    --     ②退支票额_In:传入零
    Select ID
    Into n_消费卡id
    From 消费卡目录
    Where 接口编号 = n_卡类别id And 卡号 = 卡号_In And
          序号 = (Select Max(序号) From 消费卡目录 Where 接口编号 = n_卡类别id And 卡号 = 卡号_In);
  
    --卡类别ID|卡号|消费卡ID|消费金额||.
    v_退费结算 := n_卡类别id || '|' || 卡号_In || '|' || n_消费卡id || '|' || 退款金额_In;
    Zl_门诊退费结算_Modify(4, n_病人id, 冲销id_In, v_退费结算, 0, Null, 卡号_In, 交易流水号_In, 交易说明_In, 0, 0, 0, 0);
  
    --保存扩展结算信息
    For c_扩展 In (Select Extractvalue(j.Column_Value, '/EXPEND/JYMC') As Jymc,
                        Extractvalue(j.Column_Value, '/EXPEND/JYLR') As Jylr
                 From Table(Xmlsequence(Extract(Xmlexpned_In, '/EXPENDLIST/EXPEND'))) J) Loop
      Zl_三方结算交易_Insert(n_卡类别id, 1, 卡号_In, 冲销id_In, c_扩展.Jymc || '|' || c_扩展.Jylr, 0);
    End Loop;
  End Square_Cardbalance_Modfiy;

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  --0.获取入参中的病人ID等信息
  Select To_Number(Extractvalue(Value(A), 'IN/BRID')), To_Number(Extractvalue(Value(A), 'IN/JE')),
         Extractvalue(Value(A), 'IN/TFZY'), To_Number(Extractvalue(Value(A), 'IN/JCFP')),
         Extractvalue(Value(A), 'IN/JSKLB')
  Into n_病人id, n_退款总额, v_摘要, n_检查发票, v_结算卡类别
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  --人员id,人员编号,人员姓名 
  v_Temp       := Zl_Identity(1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_操作员编码 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_操作员姓名 := v_Temp;
  v_Err_Msg    := Null;
  v_结帐ids    := Null;

  If v_结算卡类别 Is Not Null Then
    Begin
      n_卡类别id := To_Number(v_结算卡类别);
    Exception
      When Others Then
        n_卡类别id := 0;
    End;
    If n_卡类别id = 0 Then
      Begin
        Select ID Into n_卡类别id From 医疗卡类别 Where 名称 = v_结算卡类别;
      Exception
        When Others Then
          v_Err_Msg := '无法确认传入的结算卡！';
          Raise Err_Item;
      End;
    End If;
  Else
    n_卡类别id := 0;
  End If;

  If Nvl(n_卡类别id, 0) <> 0 Then
    Select 结算方式 Into v_结算方式 From 医疗卡类别 Where ID = n_卡类别id;
  End If;

  --1.先进行退费

  Select 病人结帐记录_Id.Nextval, Sysdate Into n_冲销id, d_退费时间 From Dual;

  n_Count      := 0;
  n_原结算序号 := 0;
  For c_费用 In (Select Extractvalue(b.Column_Value, '/FY/DJH') As 单据号, Extractvalue(b.Column_Value, '/FY/XH') As 退款序号
               From Table(Xmlsequence(Extract(Xml_In, '/IN/FYLIST/FY'))) B) Loop
    Begin
      Select 结算序号, 结帐id, 病人id
      Into n_Temp, n_结帐id, n_单据病人id
      From 病人预交记录
      Where 结帐id In (Select 结帐id
                     From 门诊费用记录
                     Where NO = c_费用.单据号 And 记录性质 = 1 And Nvl(费用状态, 0) = 0 And 记录状态 In (1, 3) And Rownum < 2) And
            Rownum < 2;
    Exception
      When Others Then
        n_Temp := Null;
    End;
    If Instr(',' || v_结帐ids || ',', ',' || n_结帐id || ',') = 0 Then
      v_结帐ids := v_结帐ids || ',' || n_结帐id;
    End If;
  
    If n_Temp Is Null Then
      v_Err_Msg := '指定的单据号:' || c_费用.单据号 || '未找到,不能退费!';
      Raise Err_Item;
    End If;
    Begin
      Select b.No
      Into v_挂号单
      From 门诊费用记录 A, 病人挂号记录 B
      Where a.No = c_费用.单据号 And a.记录性质 = 1 And Nvl(费用状态, 0) = 0 And a.记录状态 In (1, 3) And a.挂号id = b.Id And Rownum < 2;
    Exception
      When Others Then
        v_挂号单 := Null;
    End;
    If Not v_挂号单 Is Null Then
      l_挂号单.Extend;
      l_挂号单(l_挂号单.Count) := v_挂号单;
    End If;
  
    If Nvl(n_单据病人id, 0) = 0 Then
      Begin
        Select 病人id
        Into n_单据病人id
        From 门诊费用记录
        Where NO = c_费用.单据号 And 记录性质 = 1 And Nvl(费用状态, 0) = 0 And 记录状态 In (1, 3) And Rownum < 2;
      Exception
        When Others Then
          n_单据病人id := 0;
      End;
    End If;
  
    If Nvl(n_病人id, 0) <> Nvl(n_单据病人id, 0) Then
      v_Err_Msg := '本次退费的收费单:' || c_费用.单据号 || '不是当前病人的收费单,不能退费!';
      Raise Err_Item;
    End If;
  
    If n_原结算序号 <> 0 And n_原结算序号 <> n_Temp Then
      v_Err_Msg := '本次退费的单据号不是一次收费结算,不能退费!';
      Raise Err_Item;
    End If;
    n_原结算序号 := n_Temp;
  
    Select Count(*) Into n_Temp From 费用补充记录 Where 收费结帐id = n_结帐id;
    If Nvl(n_Temp, 0) <> 0 Then
      v_Err_Msg := '本次退费的单据号已经进行了保险补充结算,不能退费!';
      Raise Err_Item;
    End If;
  
    If v_结算卡类别 Is Not Null Then
      Select Count(*) Into n_Temp From 病人预交记录 Where 结帐id = n_结帐id And 结算方式 = v_结算方式;
      If Nvl(n_Temp, 0) = 0 Then
        v_Err_Msg := '本次退费的单据不是' || v_结算方式 || '结算的,不能退费!';
        Raise Err_Item;
      End If;
    End If;
  
    If Nvl(n_检查发票, 0) = 1 Then
      Select Max(Decode(a.实际票号, Null, 0, 1))
      Into n_是否打印
      From 门诊费用记录 A
      Where NO = c_费用.单据号 And 记录性质 = 1;
      If Nvl(n_是否打印, 0) = 1 Then
        v_Err_Msg := '本次退费的单据号已开发票,不能退费!';
        Raise Err_Item;
      End If;
    End If;
  
    Zl_门诊收费记录_销帐(c_费用.单据号, v_操作员编码, v_操作员姓名, c_费用.退款序号, d_退费时间, v_摘要, n_冲销id);
    n_Count := n_Count + 1;
  End Loop;
  If n_Count = 0 Then
    v_Err_Msg := '未确定本次需要退费的单据,不能退费!';
    Raise Err_Item;
  End If;

  --2.处理退费的结算信息

  n_结帐金额 := 0;

  --检查总金额是否正确 
  Select Sum(结帐金额) Into n_结帐金额 From 门诊费用记录 Where 结帐id = n_冲销id;

  n_误差额 := -1 * Nvl(n_结帐金额, 0) - Nvl(n_退款总额, 0);
  If Abs(n_误差额) > 1.00 Then
    v_Err_Msg := '单据缴款金额与实际结算的误差太大!';
    Raise Err_Item;
  End If;

  --2.确定支付方式
  n_Count := 0;
  For c_结算方式 In (Select Extractvalue(b.Column_Value, '/TK/TKKLB') As 卡类别, Extractvalue(b.Column_Value, '/TK/TKKH') As 卡号,
                        Extractvalue(b.Column_Value, '/TK/TKFS') As 结算方式,
                        -1 * To_Number(Extractvalue(b.Column_Value, '/TK/TKJE')) As 退款金额,
                        Extractvalue(b.Column_Value, '/TK/JYLSH') As 交易流水号,
                        Extractvalue(b.Column_Value, '/TK/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/TK/TKZY') As 摘要,
                        Extractvalue(b.Column_Value, '/TK/TYJK') As 是否退预交,
                        Extractvalue(b.Column_Value, '/TK/SFXFK') As 是否消费卡,
                        Extract(b.Column_Value, '/TK/EXPENDLIST') As Expend
                 From Table(Xmlsequence(Extract(Xml_In, '/IN/TKLIST/TK'))) B) Loop
  
    --1.退回三方卡
    If c_结算方式.卡类别 Is Not Null And Nvl(c_结算方式.是否消费卡, 0) = 0 Then
      --1.三方卡结算
      Third_Cardbalance_Modfiy(n_冲销id, c_结算方式.卡类别, c_结算方式.卡号, c_结算方式.退款金额, c_结算方式.交易流水号, c_结算方式.交易说明, c_结算方式.摘要,
                               c_结算方式.Expend);
    Elsif c_结算方式.卡类别 Is Not Null And Nvl(c_结算方式.是否消费卡, 0) = 1 Then
      --2.消费卡结算
      Square_Cardbalance_Modfiy(n_冲销id, c_结算方式.卡类别, c_结算方式.卡号, c_结算方式.退款金额, c_结算方式.交易流水号, c_结算方式.交易说明, c_结算方式.摘要,
                                c_结算方式.Expend);
    Elsif Nvl(c_结算方式.是否退预交, 0) = 1 Then
      --3.退预交款
      Zl_门诊退费结算_Modify(4, n_病人id, n_冲销id, Null, c_结算方式.退款金额, Null, Null, Null, Null, 0, 0, 0, 0);
    Else
      --4.普通结算
      If c_结算方式.结算方式 Is Null Then
        v_Err_Msg := '未指定指付方式，不允缴款!';
        Raise Err_Item;
      End If;
      --结算方式|结算金额|结算号码|结算摘要||..
      v_退费结算 := c_结算方式.结算方式 || '|' || c_结算方式.退款金额 || '| |' || Nvl(c_结算方式.摘要, '  ');
      v_普通结算 := Nvl(v_普通结算, '') || '||' || v_退费结算;
    End If;
    n_Count := n_Count + 1;
  End Loop;

  --   0-原样退
  --      原样结算一起全退,所有校对标志都为1,医保调用成功后,调整为2,完成后变成0
  --   1-普通退费方式:
  --     ①结算方式_IN:允许传入多个,格式为:"结算方式|结算金额|结算号码|结算摘要||.." ;也允许传入空.
  --   3-医保结算(如果存在医保的结算,则要先删除原医保结算,后按新传入的更新)
  --     ①结算方式_IN:允许传入多个,格式为:结算方式|结算金额||..
  --     ②退支票额_In:传入零
  If n_Count = 0 Then
    v_Err_Msg := '不能有效确认当前的支付方式!';
    Raise Err_Item;
  End If;

  --5.普通结算及完成结
  If v_普通结算 Is Not Null Then
    v_普通结算 := Substr(v_普通结算, 3);
  End If;
  Zl_门诊退费结算_Modify(1, n_病人id, n_冲销id, v_普通结算, 0, Null, Null, Null, Null, 0, 0, n_误差额, 2);

  If v_结帐ids Is Not Null Then
    v_结帐ids := Substr(v_结帐ids, 2);
  End If;

  If l_挂号单.Count <> 0 Then
    For I In 0 .. l_挂号单.Count Loop
      x_Templet := Xmltype('<IN></IN>');
      v_Temp    := '<GHDH>' || l_挂号单(I) || '</GHDH>';
      Select Appendchildxml(x_Templet, '/IN', Xmltype(v_Temp)) Into x_Templet From Dual;
      Zl_Third_Registdel(x_Templet, Xml_Out);
      v_Temp := '<JSKLB>' || 4 || '</JSKLB>';
      Select Appendchildxml(x_Templet, '/IN', Xmltype(v_Temp)) Into x_Templet From Dual;
      Zl_Third_Registdel(x_Templet, Xml_Out);
      v_Temp := '<GHJE>' || 0 || '</GHJE>';
      Select Appendchildxml(x_Templet, '/IN', Xmltype(v_Temp)) Into x_Templet From Dual;
      Zl_Third_Registdel(x_Templet, Xml_Out);
    End Loop;
  End If;
  v_Temp := '<CZSJ>' || To_Char(d_退费时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<YJZID>' || v_结帐ids || '</YJZID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<CXID>' || n_冲销id || '</CXID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Charge_Del;
/

--102751:刘尔旋,2017-04-11,病人挂号记录对应收费单
Create Or Replace Procedure Zl_Third_Paymentinfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------------------------- 
  --功能:获取指定单据交易信息 
  --入参:Xml_In: 
  --<IN>
  --    <DJ>单据号,性质|....</DJ> //可以传入多个单据
  --    <JSKLB>结算卡类别</JSKLB>
  --    <XL>险类</XL>          //为空代表普通病人
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --<DJ>  //如果为空表示没有找到数据
  --    <DJH>单据号</DJH>
  --    <JLXZ>记录性质</JLXZ>   
  --    <YSJE>应收金额</YSJE>
  --    <SSJE>实收金额</SSJE>
  --    <FYMC>收据费目</FYMC> //(多个用逗号分离 )
  --    <JSKZF>结算卡支付</JSKZF> //:0-不是结算卡支付;1-结算卡支付(入参中:JSKLB判断,存在该类别支付的,返回1,否则返回0)
  --    <FKSJ>付款时间</FKSJ>
  --    <JYLSH>交易流水号</JYLSH> //(非结算卡支付的，不返回)
  --    <YXTK>是否允许退款</YXTK>            //0不允许1允许
  --    <YBJS>医保是否结算</YBJS>   //1-已结算;0-未结算
  --    <KP>是否开票</KP>  1是0否
  --    <SQZT>退费申请状态</SQZT>                  //退费申请状态,0-未申请,1-申请中,2-审核通过,3-审核未通过
  --    <JZTFSM>禁止退款说明</JZTFSM>
  --    <YJZID>结帐ID</YJZID>                  //已收费单据的结帐ID
  --</DJ>
  --<ERROR><MSG></MSG></ERROR>          //错误情况返回
  --</OUTPUT>
  -------------------------------------------------------------------------------------------------- 
  v_Err_Msg Varchar2(200);
  Err_Item Exception;

  x_Templet      Xmltype; --模板XML 
  v_No           Varchar2(4000);
  v_结算卡类别   Varchar2(100);
  n_结算卡类别id 医疗卡类别.Id%Type;

  n_Temp       Number(18);
  n_Mark       Number(5);
  v_Temp       Varchar2(32767); --临时XML 
  v_交易流水号 病人预交记录.交易流水号%Type;
  n_医保结算   Number(2);
  n_允许退款   Number(2);
  n_退费状态   病人退费申请.状态%Type;
  v_审核原因   病人退费申请.审核原因%Type;
  v_说明       Varchar2(100);
  n_补结算     Number(18);
  v_结算方式   结算方式.名称%Type;
  n_已开医嘱   Number(2);
  n_险类       病人信息.险类%Type;

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/DJ'), Extractvalue(Value(A), 'IN/JSKLB'), To_Number(Extractvalue(Value(A), 'IN/XL'))
  Into v_No, v_结算卡类别, n_险类
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_No Is Null Then
    v_Err_Msg := '不能找到指定的收费单据(当前单据为空)';
    Raise Err_Item;
  End If;
  If v_结算卡类别 Is Not Null Then
    v_Err_Msg := Null;
    Begin
      n_结算卡类别id := To_Number(v_结算卡类别);
    Exception
      When Others Then
        n_结算卡类别id := 0;
    End;
    If Nvl(n_结算卡类别id, 0) = 0 Then
      Begin
        Select ID, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!'), 结算方式
        Into n_结算卡类别id, v_Err_Msg, v_结算方式
        From 医疗卡类别
        Where 名称 = v_结算卡类别;
      Exception
        When Others Then
          n_结算卡类别id := 0;
          v_Err_Msg      := v_结算卡类别 || '不存在!';
      End;
    Else
      Begin
        Select ID, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!'), 结算方式
        Into n_结算卡类别id, v_Err_Msg, v_结算方式
        From 医疗卡类别
        Where ID = n_结算卡类别id;
      Exception
        When Others Then
          n_结算卡类别id := 0;
          v_Err_Msg      := '未找到指定的结算支付信息!';
      End;
    End If;
    If Not v_Err_Msg Is Null Then
      Raise Err_Item;
    End If;
  End If;

  For c_收费单 In (Select /*+ rule*/
                 记录性质, NO, Sum(应收金额) As 应收金额, Sum(实收金额) As 实收金额, Max(收款时间) As 收款时间, Max(结帐id) As 结帐id, Max(是否退款) As 是否退款,
                 Max(是否打印) As 是否打印, Max(记录状态) As 记录状态, f_List2str(Cast(Collect(收据费目) As t_Strlist)) As 收据费目,
                 Max(挂号单) As 挂号单
                
                From (Select a.记录性质, a.No, 收据费目, Sum(应收金额) As 应收金额, Sum(实收金额) As 实收金额,
                              To_Char(Max(a.登记时间), 'yyyy-mm-dd hh24:mi:ss') As 收款时间, Max(结帐id) As 结帐id,
                              Max(Decode(Nvl(a.执行状态, 0), 1, 0, 1)) As 是否退款, Max(Decode(a.实际票号, Null, 0, 1)) 是否打印,
                              Max(a.记录状态) As 记录状态, Max(c.No) As 挂号单
                       From 门诊费用记录 A, Table(f_Str2list2(v_No, '|', ',')) B, 病人挂号记录 C
                       Where a.No = b.C1 And a.记录性质 = b.C2 And a.记录状态 In (1, 3) And a.挂号id = c.Id
                       Group By a.记录性质, a.No, 收据费目
                       Order By 记录性质, NO, 收据费目)
                Group By 记录性质, NO) Loop
    n_Temp := 0;
    If n_结算卡类别id <> 0 Then
      Begin
        Select 交易流水号, 1
        Into v_交易流水号, n_Temp
        From 病人预交记录
        Where 卡类别id = n_结算卡类别id And 结帐id = Nvl(c_收费单.结帐id, 0);
      Exception
        When Others Then
          n_Temp := 0;
      End;
    
    End If;
    Begin
      Select Count(*) Into n_补结算 From 费用补充记录 Where 收费结帐id = Nvl(c_收费单.结帐id, 0) And Rownum < 2;
    Exception
      When Others Then
        n_补结算 := 0;
    End;
  
    Select Decode(Nvl(Count(*), 0), 0, 0, 1)
    Into n_医保结算
    From 保险结算记录
    Where 性质 = 1 And 记录id = Nvl(c_收费单.结帐id, 0);
  
    n_允许退款 := Nvl(c_收费单.是否退款, 0);
    n_已开医嘱 := 0;
  
    If c_收费单.挂号单 Is Not Null Then
      Begin
        Select 1 Into n_已开医嘱 From 病人医嘱记录 Where 挂号单 = c_收费单.挂号单;
      Exception
        When Others Then
          n_已开医嘱 := 0;
      End;
      If Nvl(n_已开医嘱, 0) = 1 Then
        n_允许退款 := 0;
      End If;
    End If;
    If Nvl(n_已开医嘱, 0) = 1 Then
      v_说明 := '挂号单已开医嘱';
    Elsif Nvl(n_允许退款, 0) = 0 Then
      v_说明 := '单据已经执行';
    End If;
  
    If n_险类 Is Null Then
      Select Nvl(Max(1), 0)
      Into n_Mark
      From 病人预交记录 A
      Where a.结帐id = c_收费单.结帐id And a.结算方式 <> v_结算方式;
    
      If Nvl(n_医保结算, 0) = 1 Then
        v_说明     := '单据已经医保结算';
        n_允许退款 := 0;
      End If;
    Else
      Select Nvl(Max(1), 0)
      Into n_Mark
      From 病人预交记录 A, 结算方式 B
      Where a.结帐id = c_收费单.结帐id And a.结算方式 <> v_结算方式 And a.结算方式 = b.名称 And b.性质 Not In (3, 4);
      If n_Mark = 0 Then
        Select Nvl(Max(1), 0) Into n_Mark From 保险结算记录 A Where a.记录id = c_收费单.结帐id And 险类 <> n_险类;
      End If;
    End If;
    If Nvl(n_Mark, 0) = 1 Then
      v_说明     := '该单据包含不能退费的结算方式';
      n_允许退款 := 0;
    End If;
  
    If Nvl(n_补结算, 0) <> 0 Then
      v_说明     := '单据已经补充结算';
      n_允许退款 := 0;
      n_医保结算 := 1;
    End If;
  
    If Nvl(n_允许退款, 0) = 1 Then
      --检查是否有可退数量
      Select Decode(Nvl(Count(*), 0), 0, 0, 1)
      Into n_允许退款
      From (Select 序号, Sum(Nvl(付数, 0) * 数次) As 数量
             From 门诊费用记录 A
             Where NO = c_收费单.No And Mod(记录性质, 10) = c_收费单.记录性质 And 价格父号 Is Null Having Sum(Nvl(付数, 0) * 数次) <> 0
             Group By 序号);
      If Nvl(c_收费单.记录状态, 0) = 3 And n_允许退款 = 0 Then
        v_说明     := '单据已全退';
        n_允许退款 := 0;
      Elsif Nvl(c_收费单.记录状态, 0) = 3 Then
        v_说明     := '单据已部分退费';
        n_允许退款 := 0;
      End If;
    End If;
  
    If Nvl(n_允许退款, 0) = 1 And Nvl(c_收费单.是否打印, 0) = 1 Then
      v_说明     := '单据已开发票';
      n_允许退款 := 0;
    End If;
  
    Begin
      Select 状态, 审核原因
      Into n_退费状态, v_审核原因
      From 病人退费申请
      Where NO = c_收费单.No And Mod(记录性质, 10) = Mod(c_收费单.记录性质, 10);
    Exception
      When Others Then
        n_退费状态 := -1;
        v_审核原因 := '';
    End;
    n_退费状态 := n_退费状态 + 1;
    If n_退费状态 = 3 Then
      v_说明     := v_审核原因;
      n_允许退款 := 0;
    End If;
  
    v_Temp := '<DJH>' || c_收费单.No || '</DJH>';
    v_Temp := v_Temp || '<JLXZ>' || c_收费单.记录性质 || '</JLXZ>';
    v_Temp := v_Temp || '<YSJE>' || c_收费单.应收金额 || '</YSJE>';
    v_Temp := v_Temp || '<SSJE>' || c_收费单.实收金额 || '</SSJE>';
    v_Temp := v_Temp || '<FYMC>' || c_收费单.收据费目 || '</FYMC>';
    v_Temp := v_Temp || '<FKSJ>' || c_收费单.收款时间 || '</FKSJ>';
    v_Temp := v_Temp || '<JSKZF>' || n_Temp || '</JSKZF>';
    v_Temp := v_Temp || '<JYLSH>' || Nvl(v_交易流水号, '') || '</JYLSH>';
    v_Temp := v_Temp || '<YXTK>' || Nvl(n_允许退款, 0) || '</YXTK>';
    v_Temp := v_Temp || '<YBJS>' || n_医保结算 || '</YBJS>';
    v_Temp := v_Temp || '<KP>' || Nvl(c_收费单.是否打印, 0) || '</KP>';
    v_Temp := v_Temp || '<SQZT>' || n_退费状态 || '</SQZT>';
    v_Temp := v_Temp || '<JZTFSM>' || v_说明 || '</JZTFSM>';
    v_Temp := v_Temp || '<YJZID>' || c_收费单.结帐id || '</YJZID>';
    v_Temp := '<DJ>' || v_Temp || '</DJ>';
  
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End Loop;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Paymentinfo;
/

--102751:刘尔旋,2017-04-11,病人挂号记录对应收费单
Create Or Replace Procedure Zl_病人挂号记录_状态
(
  No_In       病人挂号记录.No%Type,
  执行状态_In 病人挂号记录.执行状态%Type := 0 --0:标记为待诊.-1:标记为不就诊 
) As
  v_划价no Varchar2(20);
  v_Error  Varchar2(255);
  Err_Custom Exception;
Begin
  Update 病人挂号记录
  Set 执行状态 = 执行状态_In, 记录标志 = 0
  Where NO = No_In And 记录性质 = 1 And 记录状态 = 1 And 执行状态 = Decode(执行状态_In, 0, -1, 0);
  If Sql%RowCount = 0 Then
    v_Error := '由于并发操作,当前挂号单已被处理,请刷新信息!';
    Raise Err_Custom;
  End If;
  --删除挂号划价单 
  If 执行状态_In = -1 Then
    Select Max(b.收费单) Into v_划价no From 病人挂号记录 B Where b.No = No_In And b.记录状态 = 1 And Rownum < 2;
    If Not v_划价no Is Null Then
      If Instr(v_划价no, '划价:') <> 0 Then
        v_划价no := Substr(v_划价no, Length('划价:') + 1);
        Delete From 门诊费用记录 Where NO = v_划价no And 记录性质 = 1 And 记录状态 = 0;
      End If;
    End If;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人挂号记录_状态;
/

--102751:刘尔旋,2017-04-11,病人挂号记录对应收费单
Create Or Replace Procedure Zl_病人挂号记录_出诊_Insert
(
  出诊记录id_In    临床出诊记录.Id%Type,
  病人id_In        门诊费用记录.病人id%Type,
  门诊号_In        门诊费用记录.标识号%Type,
  姓名_In          门诊费用记录.姓名%Type,
  性别_In          门诊费用记录.性别%Type,
  年龄_In          门诊费用记录.年龄%Type,
  付款方式_In      门诊费用记录.付款方式%Type, --用于存放病人的医疗付款方式编号
  费别_In          门诊费用记录.费别%Type,
  单据号_In        门诊费用记录.No%Type,
  票据号_In        门诊费用记录.实际票号%Type,
  序号_In          门诊费用记录.序号%Type,
  价格父号_In      门诊费用记录.价格父号%Type,
  从属父号_In      门诊费用记录.从属父号%Type,
  收费类别_In      门诊费用记录.收费类别%Type,
  收费细目id_In    门诊费用记录.收费细目id%Type,
  数次_In          门诊费用记录.数次%Type,
  标准单价_In      门诊费用记录.标准单价%Type,
  收入项目id_In    门诊费用记录.收入项目id%Type,
  收据费目_In      门诊费用记录.收据费目%Type,
  结算方式_In      Varchar2,
  应收金额_In      门诊费用记录.应收金额%Type,
  实收金额_In      门诊费用记录.实收金额%Type,
  病人科室id_In    门诊费用记录.病人科室id%Type,
  开单部门id_In    门诊费用记录.开单部门id%Type,
  执行部门id_In    门诊费用记录.执行部门id%Type,
  操作员编号_In    门诊费用记录.操作员编号%Type,
  操作员姓名_In    门诊费用记录.操作员姓名%Type,
  发生时间_In      门诊费用记录.发生时间%Type,
  登记时间_In      门诊费用记录.登记时间%Type,
  医生姓名_In      挂号安排.医生姓名%Type,
  医生id_In        挂号安排.医生id%Type,
  病历费_In        Number, --该条记录是否病历工本费
  急诊_In          Number,
  号别_In          挂号安排.号码%Type,
  诊室_In          门诊费用记录.发药窗口%Type,
  结帐id_In        门诊费用记录.结帐id%Type,
  领用id_In        票据使用明细.领用id%Type,
  预交支付_In      病人预交记录.冲预交%Type, --刷卡挂号时使用的预交金额,序号为1传入.
  现金支付_In      病人预交记录.冲预交%Type, --挂号时现金支付部份金额,序号为1传入.
  个帐支付_In      病人预交记录.冲预交%Type, --挂号时个人帐户支付金额,,序号为1传入.
  保险大类id_In    门诊费用记录.保险大类id%Type,
  保险项目否_In    门诊费用记录.保险项目否%Type,
  统筹金额_In      门诊费用记录.统筹金额%Type,
  摘要_In          门诊费用记录.摘要%Type, --预约挂号摘要信息
  预约挂号_In      Number := 0, --预约挂号时用(记录状态=0,发生时间为预约时间),此时不需要传入结算相关参数
  收费票据_In      Number := 0, --挂号是否使用收费票据
  保险编码_In      门诊费用记录.保险编码%Type,
  复诊_In          病人挂号记录.复诊%Type := 0,
  号序_In          挂号序号状态.序号%Type := Null, --预约时填入费用记录的发药窗口字段,挂号时填入挂号记录
  社区_In          病人挂号记录.社区%Type := Null,
  预约接收_In      Number := 0,
  预约方式_In      预约方式.名称%Type := Null,
  生成队列_In      Number := 0,
  卡类别id_In      病人预交记录.卡类别id%Type := Null,
  结算卡序号_In    病人预交记录.结算卡序号%Type := Null,
  卡号_In          病人预交记录.卡号%Type := Null,
  交易流水号_In    病人预交记录.交易流水号%Type := Null,
  交易说明_In      病人预交记录.交易说明%Type := Null,
  合作单位_In      病人预交记录.合作单位%Type := Null,
  操作类型_In      Number := 0,
  险类_In          病人挂号记录.险类%Type := Null,
  结算模式_In      Number := 0,
  记帐费用_In      Number := 0,
  退号重用_In      Number := 1,
  冲预交病人ids_In Varchar2 := Null,
  修正病人费别_In  Number := 0,
  预约顺序号_In    临床出诊序号控制.预约顺序号%Type := Null,
  修正病人年龄_In  Number := 0,
  收费单_In        病人挂号记录.收费单%Type := Null
) As
  ---------------------------------------------------------------------------
  --
  --参数:
  --     操作类型_in:0-正常挂号或者预约 1-操作员拥有加号权限加号
  --     修正病人费别_In:0-不修改病人费别 1-修改病人费别
  ----------------------------------------------------------------------------
  --该游标用于收费冲预交的可用预交列表
  --以ID排序，优先冲上次未冲完的。
  Cursor c_Deposit
  (
    v_病人id        病人信息.病人id%Type,
    v_冲预交病人ids Varchar2
  ) Is
    Select 病人id, NO, Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) As 金额, Min(记录状态) As 记录状态, Nvl(Max(结帐id), 0) As 结帐id,
           Max(Decode(记录性质, 1, ID, 0) * Decode(记录状态, 2, 0, 1)) As 原预交id
    From 病人预交记录
    Where 记录性质 In (1, 11) And 病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And Nvl(预交类别, 2) = 1
     Having Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) <> 0
    Group By NO, 病人id
    Order By Decode(病人id, Nvl(v_病人id, 0), 0, 1), 结帐id, NO;
  --功能：新增一行病人挂号费用，并将结算汇总到病人预交记录
  --       同时汇总相关的汇总表(病人挂号汇总、费用汇总)
  --       第一行费用处理票据使用情况(领用ID_IN>0)

  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  v_排队号码 排队叫号队列.排队号码%Type;
  v_现金     结算方式.名称%Type;
  v_个人帐户 结算方式.名称%Type;
  v_队列名称 排队叫号队列.队列名称%Type;

  n_分时段       Number;
  n_原始分时段   Number;
  n_时段限号     Number;
  n_时段限约     Number;
  d_时段时间     Date;
  d_最大序号时间 Date;
  n_追加号       Number := 0; --处理时段过期 追加挂号的情况
  n_已约数       病人挂号汇总.已约数%Type;
  n_已接收       病人挂号汇总.其中已接收%Type;
  n_预约有效时间 Number;
  n_失效数       Number;
  n_失约挂号     Number := 0;
  n_已用数量     Number;
  n_锁定         Number := 0;

  n_打印id        票据打印内容.Id%Type;
  n_费用id        门诊费用记录.Id%Type;
  n_预交金额      病人预交记录.金额%Type;
  n_当前金额      病人预交记录.金额%Type;
  n_返回值        病人预交记录.金额%Type;
  n_预交id        病人预交记录.Id%Type;
  n_消费卡id      消费卡目录.Id%Type;
  n_挂号id        病人挂号记录.Id%Type;
  v_冲预交病人ids Varchar2(4000);

  n_组id           财务缴款分组.Id%Type;
  n_门诊号         病人信息.门诊号%Type;
  n_序号           挂号序号状态.序号%Type;
  n_已用序号       挂号序号状态.序号%Type;
  n_序号控制       挂号安排.序号控制%Type;
  n_分诊台签到排队 Number;
  n_Count          Number;
  n_限号数         Number(18);
  n_自制卡         Number;
  d_排队时间       Date;
  v_结算方式记录   Varchar2(1000);
  d_序号时间       Date;
  v_费别           费别.名称%Type;
  n_时段序号       Number := -1;
  n_预约生成队列   Number;
  v_结算方式       结算方式.名称%Type;
  v_结算内容       Varchar2(1000);
  v_当前结算       Varchar2(200);
  v_结算号码       病人预交记录.结算号码%Type;
  n_结算金额       病人预交记录.冲预交%Type;
  n_三方卡标志     Number(2);
  n_安排id         挂号安排.Id%Type;
  n_预约顺序号     临床出诊序号控制.预约顺序号%Type;
  n_计划id         挂号安排计划.Id%Type := 0;
  v_星期           挂号安排限制.限制项目%Type;
  n_限约数         Number(18);
  n_已挂数         Number(4) := 0;
  n_Exists         Number;
  n_挂出的最大序号 Number(4) := 0;
  n_分时点显示     Number(3);
  n_结算模式       病人信息.结算模式%Type;
  v_排队序号       排队叫号队列.排队序号%Type;
  v_机器名         挂号序号状态.机器名%Type;
  v_序号操作员     挂号序号状态.操作员姓名%Type;
  v_序号机器名     挂号序号状态.机器名%Type;
  v_付款方式       病人挂号记录.医疗付款方式%Type;
  n_状态           临床出诊序号控制.挂号状态%Type;
Begin
  --记录锁定判断
  If 出诊记录id_In Is Not Null Then
    Begin
      Select 1
      Into n_Exists
      From 临床出诊记录
      Where ID = 出诊记录id_In And Nvl(是否发布, 0) = 1 And Nvl(是否锁定, 0) = 0;
    Exception
      When Others Then
        v_Err_Msg := '无法确定出诊记录，请检查出诊记录是否存在或被锁定！';
        Raise Err_Item;
    End;
  End If;

  --获取当前机器名称
  Select Terminal Into v_机器名 From V$session Where Audsid = Userenv('sessionid');
  n_组id          := Zl_Get组id(操作员姓名_In);
  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);

  If 费别_In Is Null Then
    Begin
      Select 名称 Into v_费别 From 费别 Where 缺省标志 = 1 And Rownum < 2;
      Update 病人信息 Set 费别 = v_费别 Where 病人id = 病人id_In;
    Exception
      When Others Then
        v_Err_Msg := '无法确定病人费别，请检查缺省费别是否正确设置！';
        Raise Err_Item;
    End;
  Else
    v_费别 := 费别_In;
    If Nvl(修正病人费别_In, 0) = 1 Then
      Begin
        Update 病人信息 Set 费别 = v_费别 Where 病人id = 病人id_In;
      Exception
        When Others Then
          v_Err_Msg := '没有找到对应的病人！';
          Raise Err_Item;
      End;
    End If;
  End If;

  If Nvl(修正病人年龄_In, 0) = 1 Then
    Begin
      Update 病人信息 Set 年龄 = 年龄_In Where 病人id = 病人id_In;
    Exception
      When Others Then
        v_Err_Msg := '没有找到对应的病人！';
        Raise Err_Item;
    End;
  End If;

  If 门诊号_In Is Not Null Then
    Begin
      Select Nvl(门诊号, 0) Into n_门诊号 From 病人信息 Where 病人id = 病人id_In;
    Exception
      When Others Then
        n_门诊号 := 0;
    End;
    If n_门诊号 = 0 Then
      Update 病人信息 Set 门诊号 = 门诊号_In Where 病人id = 病人id_In;
    End If;
  End If;

  Begin
    Update 临床出诊序号控制
    Set 挂号状态 = 0
    Where 记录id = 出诊记录id_In And 序号 = 号序_In And Nvl(挂号状态, 0) = 3 And 操作员姓名 = 操作员姓名_In;
  Exception
    When Others Then
      Null;
  End;

  If Nvl(预约挂号_In, 0) = 0 Then
    --挂号或者预约接收
    --因为现在有按日编单据号规则,日挂号量不能超过10000次,所以要检查唯一约束。
    Select Count(*)
    Into n_Count
    From 门诊费用记录
    Where 记录性质 = 4 And 记录状态 In (1, 3) And 序号 = 序号_In And NO = 单据号_In;
    If n_Count <> 0 Then
      v_Err_Msg := '挂号单据号重复,不能保存！' || Chr(13) || '如果使用了按日顺序编号,当日挂号量不能超过10000人次。';
      Raise Err_Item;
    End If;
  
    --获取结算方式名称
    Begin
      Select 名称 Into v_现金 From 结算方式 Where 性质 = 1;
    Exception
      When Others Then
        v_现金 := '现金';
    End;
    Begin
      Select 名称 Into v_个人帐户 From 结算方式 Where 性质 = 3;
    Exception
      When Others Then
        v_个人帐户 := '个人帐户';
    End;
  End If;

  n_序号 := 号序_In;

  --获取是否分时段
  Begin
    Select Nvl(是否分时段, 0), Nvl(是否序号控制, 0), 限号数, 限约数
    Into n_分时段, n_序号控制, n_限号数, n_限约数
    From 临床出诊记录
    Where ID = 出诊记录id_In;
    n_原始分时段 := n_分时段;
  Exception
    When Others Then
      n_分时段     := 0;
      n_原始分时段 := n_分时段;
      n_序号控制   := 0;
      n_限号数     := Null;
      n_限约数     := Null;
  End;

  If n_序号 Is Null And n_分时段 = 1 And n_序号控制 = 0 Then
    Begin
      Select 序号
      Into n_序号
      From 临床出诊序号控制
      Where 记录id = 出诊记录id_In And 开始时间 = 发生时间_In And Rownum < 2;
    Exception
      When Others Then
        n_序号 := Null;
    End;
  End If;

  --分时段挂号时判断是否是过期挂号 也就是追加号的情况 目前只针对专家号分时段进行处理
  If Nvl(预约挂号_In, 0) = 0 And n_分时段 > 0 And Nvl(n_序号控制, 0) = 1 And 号序_In Is Null And Nvl(操作类型_In, 0) = 0 Then
    Begin
      Select Max(To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'))
      Into d_最大序号时间
      From 临床出诊序号控制
      Where 记录id = 出诊记录id_In And Nvl(数量, 0) <> 0;
    
      n_追加号 := Case Sign(发生时间_In - d_最大序号时间)
                 When -1 Then
                  0
                 Else
                  1
               End;
    Exception
      When Others Then
        n_追加号 := 0;
    End;
  End If;
  d_时段时间 := 发生时间_In;

  If 序号_In = 1 And n_分时段 > 0 Then
    If Nvl(n_序号控制, 0) = 1 Then
      Begin
        Select Nvl(序号, 0),
               To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'),
               数量, Decode(Nvl(是否预约, 0), 0, 0, 数量)
        Into n_时段序号, d_时段时间, n_时段限号, n_时段限约
        From 临床出诊序号控制
        Where 记录id = 出诊记录id_In And 序号 = n_序号;
      Exception
        When Others Then
          n_时段序号 := -1;
          n_分时段   := 0;
          d_时段时间 := 发生时间_In;
          n_时段限号 := 0;
          n_时段限约 := 0;
      End;
    Else
      --挂号时检查 是否分了时段,分了时段,把时段的限制条件给取出来
      Begin
        Select Nvl(序号, 0),
               To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'),
               数量, Decode(Nvl(是否预约, 0), 0, 0, 数量)
        Into n_时段序号, d_时段时间, n_时段限号, n_时段限约
        From 临床出诊序号控制
        Where 记录id = 出诊记录id_In And 序号 = n_序号 And 预约顺序号 Is Null;
      Exception
        When Others Then
          n_时段序号 := -1;
          n_分时段   := 0;
          d_时段时间 := 发生时间_In;
          n_时段限号 := 0;
          n_时段限约 := 0;
      End;
    End If;
  End If;

  If 序号_In = 1 Then
    --获取当前未使用的序号
    If Nvl(n_序号控制, 0) = 1 And n_分时段 = 0 Then
      --<序号控制 未设置时段 获取可用的最大序号,以及已经使用的数量>
      Begin
        --最大序号
        Select Count(1) Into n_已用数量 From 病人挂号记录 Where 出诊记录id = 出诊记录id_In And 记录状态 = 1;
        Select Max(序号) Into n_已用序号 From 临床出诊序号控制 Where 记录id = 出诊记录id_In;
      Exception
        When Others Then
          n_已用序号 := 0;
          n_已用数量 := 0;
      End;
      Begin
        --最大序号
        Select Sum(Nvl(数量, 0))
        
        Into n_已约数
        From 临床出诊序号控制
        Where 记录id = 出诊记录id_In And Nvl(挂号状态, 0) = 2;
      Exception
        When Others Then
          n_已约数 := 0;
      End;
    
      If n_原始分时段 = 0 Then
        Begin
          Select Min(序号) Into n_已用序号 From 临床出诊序号控制 Where 记录id = 出诊记录id_In And Nvl(挂号状态, 0) = 0;
          If n_序号 Is Null Then
            n_序号 := Nvl(n_已用序号, 0);
          End If;
        Exception
          When Others Then
            Select Max(序号)
            Into n_已用序号
            From 临床出诊序号控制
            Where 记录id = 出诊记录id_In And Nvl(挂号状态, 0) <> 0;
            If n_序号 Is Null Then
              n_序号 := Nvl(n_已用序号, 0) + 1;
            End If;
        End;
      Else
        Select Max(序号) Into n_已用序号 From 临床出诊序号控制 Where 记录id = 出诊记录id_In;
        If n_序号 Is Null Then
          n_序号 := Nvl(n_已用序号, 0) + 1;
        End If;
      End If;
      --<序号控制 未设置时段 获取可用的最大序号 以及已经使用的数量 --end>
    
      --非加号的情况需要检查是否超过了限制
      If 操作类型_In = 0 Then
        If Nvl(预约挂号_In, 0) = 0 Then
          --挂号时检查
          --启用序号控制未分时段 达到了限制
          If n_限号数 <= n_已用数量 And n_限号数 > 0 Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(Trunc(发生时间_In), 'yyyy-mm-dd ') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
        
        Else
          --预约时检查
          If n_限约数 = 0 Then
            n_限约数 := n_限号数;
          End If;
        
          If n_限约数 <= n_已约数 And n_限约数 > 0 Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(Trunc(发生时间_In), 'yyyy-mm-dd') || '已达到最大限约数！';
            Raise Err_Item;
          End If;
        End If;
      
      Else
        Null;
        --启用序号控制,未分时段 加号情况   不处理,如果以后有限制条件以后补充
      End If;
    
    Elsif Nvl(n_分时段, 0) > 0 And Nvl(n_序号控制, 0) = 0 Then
      --<--普通号分时段 这里只有预约一种情况-->
      If 操作类型_In = 0 Then
        --<正常预约挂号-->
        Begin
          Select Count(0) As 已挂数, Nvl(Sum(Decode(Nvl(Sign(a.开始时间 - d_时段时间), 0), 0, 1, 0)), 0) As 已约数
          Into n_已挂数, n_已约数
          From 临床出诊序号控制 A
          Where 记录id = 出诊记录id_In And 挂号状态 Not In (0, 4, 5);
        Exception
          When Others Then
            n_已挂数 := 0;
            n_已约数 := 0;
        End;
      
        n_时段限约 := n_时段限号; --普通号分时段的情况,29中n_时段限约始终是0 这里特殊处理
        --检查限制数量
        If n_限约数 = 0 Then
          n_限约数 := n_限号数;
        End If;
        If n_时段限约 <= n_已约数 Or n_限约数 <= n_已约数 Then
          v_Err_Msg := '号别' || 号别_In || '在时段' || To_Char(d_时段时间, 'hh24:mi') || '已达到最大限约数！';
          Raise Err_Item;
        End If;
        If n_限号数 <= n_已挂数 Then
          v_Err_Msg := '号别' || 号别_In || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！';
          Raise Err_Item;
        End If;
      End If;
    
      --没有达到时段的限号数 号码在当前时段往后追加
    
      --获取当天挂出的最大号序
      Select Nvl(Max(序号), 0)
      Into n_挂出的最大序号
      From 临床出诊序号控制 A
      Where 记录id = 出诊记录id_In And 预约顺序号 Is Null And 挂号状态 Not In (0, 5);
      If 预约顺序号_In Is Not Null Then
        n_预约顺序号 := 预约顺序号_In;
      Else
        Begin
          Select Nvl(Max(预约顺序号), 0) + 1
          Into n_预约顺序号
          From 临床出诊序号控制
          Where 记录id = 出诊记录id_In And 序号 = n_时段序号 And 预约顺序号 Is Not Null;
        Exception
          When Others Then
            n_预约顺序号 := Null;
        End;
      End If;
      --设置序号
      n_序号 := RPad(Nvl(n_时段序号, 0), Length(n_限号数) + Length(Nvl(n_时段序号, 0)), 0) + n_预约顺序号;
      If n_预约顺序号 Is Null Then
        n_序号 := Nvl(n_挂出的最大序号, 0) + 1;
      End If;
    
      --<--普通号分时段--End>
    Elsif Nvl(n_分时段, 0) > 0 And Nvl(n_序号控制, 0) = 1 Then
      --<启用序号控制 设置时段
      --专家号分时段
      Begin
        Select Max(序号), Sum(Decode(序号, Nvl(号序_In, 0), 0, 1)), Sum(Decode(Sign(开始时间 - d_时段时间), 0, 1, 0))
        Into n_已用序号, n_已挂数, n_已用数量
        From 临床出诊序号控制
        Where 记录id = 出诊记录id_In And 挂号状态 Not In (0, 4, 5);
      Exception
        When Others Then
          n_已用序号 := 0;
          n_已用数量 := 0;
          n_已挂数   := 0;
      End;
    
      n_失效数 := 0;
      If Nvl(预约挂号_In, 0) = 0 Then
        n_预约有效时间 := Zl_To_Number(zl_GetSysParameter('预约有效时间', 1111));
        n_失约挂号     := Zl_To_Number(zl_GetSysParameter('失约用于挂号', 1111));
        If Nvl(n_预约有效时间, 0) <> 0 And Nvl(n_失约挂号, 0) > 0 Then
          Begin
            Select Sum(Decode(Sign((Sysdate - n_预约有效时间 / 24 / 60) - 开始时间), 1, 1, 0))
            Into n_失效数
            From 临床出诊序号控制
            Where 记录id = 出诊记录id_In And 开始时间 Between Trunc(Sysdate) And Sysdate And Nvl(挂号状态, 0) = 2;
          Exception
            When Others Then
              n_失效数 := 0;
          End;
        End If;
      End If;
    
      If 操作类型_In = 0 Then
        If Nvl(预约挂号_In, 0) = 0 Then
        
          --挂号 追加号码时不检查时段限号数
          If n_时段限号 <= n_已用数量 And Nvl(n_追加号, 0) = 0 Then
            v_Err_Msg := '号别' || 号别_In || '在时段' || To_Char(d_时段时间, 'hh24:mi') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
          If n_限号数 <= n_已挂数 - n_失效数 Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
        
        Else
          --挂号
          If n_限约数 = 0 Then
            n_限约数 := n_限号数;
          End If;
          If n_限约数 <= n_已用数量 Then
            v_Err_Msg := '号别' || 号别_In || '在时段' || To_Char(d_时段时间, 'hh24:mi') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
          If n_限号数 <= n_已挂数 Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
        End If;
      End If;
      If n_序号 Is Null Then
        --设置序号
        If Nvl(n_已用序号, 0) < Nvl(n_时段序号, 0) Then
          n_已用序号 := Nvl(n_时段序号, 0);
        End If;
        n_序号 := Nvl(n_已用序号, 0) + 1;
      End If;
    Elsif Nvl(n_分时段, 0) = 0 And Nvl(n_序号控制, 0) = 0 And Nvl(病历费_In, 0) = 0 And Nvl(号别_In, 0) > 0 Then
      ---<--普通号  -->
      Begin
        Select 已挂数, 已约数 Into n_已用数量, n_已约数 From 临床出诊记录 Where ID = 出诊记录id_In;
      Exception
        When Others Then
          n_已用数量 := 0;
          n_已约数   := 0;
      End;
      If Nvl(操作类型_In, 0) = 0 Then
        If Nvl(预约挂号_In, 0) = 0 Then
          --挂号
          If Nvl(n_已用数量, 0) >= Nvl(n_限号数, 0) And Nvl(n_限号数, 0) > 0 Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
        Else
          --预约
          If (Nvl(n_限约数, 0) > 0 And Nvl(n_已约数, 0) >= Nvl(n_限约数, 0)) Or
             (Nvl(n_已用数量, 0) >= Nvl(n_限号数, 0) And Nvl(n_限号数, 0) > 0) Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
        End If;
      End If;
      ---<--普通号  -->
    End If;
  End If;

  --更新挂号序号状态
  If 序号_In = 1 And Not n_序号 Is Null Then
    If n_分时段 = 1 Then
      d_序号时间 := 发生时间_In;
    Else
      d_序号时间 := Trunc(发生时间_In);
    End If;
    --锁定序号的处理
    Begin
      If n_预约顺序号 Is Null Then
        Select 操作员姓名, 工作站名称
        Into v_序号操作员, v_序号机器名
        From 临床出诊序号控制
        Where Nvl(挂号状态, 0) = 5 And 记录id = 出诊记录id_In And 序号 = n_序号;
      Else
        Select 操作员姓名, 工作站名称
        Into v_序号操作员, v_序号机器名
        From 临床出诊序号控制
        Where Nvl(挂号状态, 0) = 5 And 记录id = 出诊记录id_In And 序号 = n_时段序号 And 预约顺序号 = n_预约顺序号;
      End If;
      n_锁定 := 1;
    Exception
      When Others Then
        v_序号操作员 := Null;
        v_序号机器名 := Null;
        n_锁定       := 0;
    End;
    If n_锁定 = 0 Then
      If n_预约顺序号 Is Null Then
        Update 临床出诊序号控制
        Set 挂号状态 = Decode(预约挂号_In, 1, 2, 1)
        Where 记录id = 出诊记录id_In And 序号 = n_序号 And Nvl(挂号状态, 0) = 3 And 操作员姓名 = 操作员姓名_In;
      Else
        Update 临床出诊序号控制
        Set 挂号状态 = Decode(预约挂号_In, 1, 2, 1)
        Where 记录id = 出诊记录id_In And 序号 = n_序号 And 预约顺序号 = n_预约顺序号 And Nvl(挂号状态, 0) = 3 And 操作员姓名 = 操作员姓名_In;
      End If;
      If Sql%RowCount = 0 Then
        Begin
          If Nvl(n_分时段, 0) > 0 Then
            If Nvl(n_序号控制, 0) = 1 Then
              --分时段后专家号 失约的预约号允许挂号
              Update 临床出诊序号控制
              Set 挂号状态 = Decode(预约挂号_In, 1, 2, 1), 操作员姓名 = 操作员姓名_In
              Where 记录id = 出诊记录id_In And 序号 = n_序号 And Nvl(挂号状态, 0) In (0, 2);
              If Sql%NotFound Then
                Begin
                  Select 挂号状态 Into n_状态 From 临床出诊序号控制 Where 记录id = 出诊记录id_In And 序号 = n_序号;
                  v_Err_Msg := '序号' || n_序号 || '已被使用,请重新选择一个序号.';
                  Raise Err_Item;
                Exception
                  When Others Then
                    Insert Into 临床出诊序号控制
                      (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 类型, 名称, 操作员姓名, 备注)
                      Select 出诊记录id_In, n_序号, d_序号时间, d_序号时间, 1, Decode(预约挂号_In, 1, 1, 0), Decode(预约挂号_In, 1, 2, 1),
                             Null, Null, Null, 操作员姓名_In, '追加号'
                      From Dual;
                End;
              End If;
            Else
              If Nvl(预约接收_In, 0) = 1 Then
                Insert Into 临床出诊序号控制
                  (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 类型, 名称, 操作员姓名, 备注, 预约顺序号)
                  Select 记录id, 序号, 开始时间, 终止时间, 1, 1, Decode(预约挂号_In, 1, 2, 1), Null, Null, Null, 操作员姓名_In, n_序号, n_预约顺序号
                  From 临床出诊序号控制
                  Where 记录id = 出诊记录id_In And 序号 = n_时段序号 And 预约顺序号 Is Null;
              End If;
            End If;
          Else
            If Nvl(n_序号控制, 0) = 1 Then
              Update 临床出诊序号控制
              Set 挂号状态 = Decode(预约挂号_In, 1, 2, 1), 操作员姓名 = 操作员姓名_In
              Where 记录id = 出诊记录id_In And 序号 = n_序号 And Nvl(挂号状态, 0) = 0;
            
              If Sql%RowCount = 0 Then
                Insert Into 临床出诊序号控制
                  (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 类型, 名称, 操作员姓名, 备注)
                  Select 出诊记录id_In, n_序号, 发生时间_In, 发生时间_In, 1, Decode(预约挂号_In, 1, 1, 0), Decode(预约挂号_In, 1, 2, 1), Null,
                         Null, Null, 操作员姓名_In, '追加号'
                  From Dual;
              End If;
            End If;
          End If;
        Exception
          When Others Then
            v_Err_Msg := '序号' || n_序号 || '已被使用,请重新选择一个序号.';
            Raise Err_Item;
        End;
      End If;
    Else
      If 操作员姓名_In <> v_序号操作员 Or v_机器名 <> v_序号机器名 Then
        v_Err_Msg := '序号' || n_序号 || '已被自助机' || v_机器名 || '锁定,请重新选择一个序号.';
        Raise Err_Item;
      Else
        If n_预约顺序号 Is Null Then
          Update 临床出诊序号控制
          Set 挂号状态 = Decode(预约挂号_In, 1, 2, 1)
          Where 记录id = 出诊记录id_In And 序号 = n_序号 And Nvl(挂号状态, 0) = 5 And 操作员姓名 = 操作员姓名_In And 工作站名称 = v_机器名;
        Else
          Update 临床出诊序号控制
          Set 挂号状态 = Decode(预约挂号_In, 1, 2, 1)
          Where 记录id = 出诊记录id_In And 序号 = n_时段序号 And 预约顺序号 = n_预约顺序号 And Nvl(挂号状态, 0) = 5 And 操作员姓名 = 操作员姓名_In And
                工作站名称 = v_机器名;
        End If;
      End If;
    End If;
  End If;

  --产生病人挂号费用(可能单独是或包括病历费用)
  Select 病人费用记录_Id.Nextval Into n_费用id From Dual; --应该通过程序得到

  Insert Into 门诊费用记录
    (ID, 记录性质, 记录状态, 序号, 价格父号, 从属父号, NO, 实际票号, 门诊标志, 加班标志, 附加标志, 发药窗口, 病人id, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 病人科室id, 收费类别,
     计算单位, 收费细目id, 收入项目id, 收据费目, 付数, 数次, 标准单价, 应收金额, 实收金额, 结帐金额, 结帐id, 记帐费用, 开单部门id, 开单人, 划价人, 执行部门id, 执行人, 操作员编号, 操作员姓名,
     发生时间, 登记时间, 保险大类id, 保险项目否, 保险编码, 统筹金额, 摘要, 结论, 缴款组id)
  Values
    (n_费用id, 4, Decode(预约挂号_In, 1, 0, 1), 序号_In, Decode(价格父号_In, 0, Null, 价格父号_In), 从属父号_In, 单据号_In, 票据号_In, 1, 急诊_In,
     病历费_In, Decode(预约挂号_In, 1, To_Char(n_序号), 诊室_In), Decode(病人id_In, 0, Null, 病人id_In),
     Decode(门诊号_In, 0, Null, 门诊号_In), 付款方式_In, 姓名_In, Decode(姓名_In, Null, Null, 性别_In), Decode(姓名_In, Null, Null, 年龄_In),
     v_费别, 病人科室id_In, 收费类别_In, 号别_In, 收费细目id_In, 收入项目id_In, 收据费目_In, 1, 数次_In, 标准单价_In, 应收金额_In, 实收金额_In,
     Decode(预约挂号_In, 1, Null, Decode(Nvl(记帐费用_In, 0), 1, Null, 实收金额_In)),
     Decode(预约挂号_In, 1, Null, Decode(Nvl(记帐费用_In, 0), 1, Null, 结帐id_In)), Decode(Nvl(记帐费用_In, 0), 1, 1, 0), 开单部门id_In,
     操作员姓名_In, Decode(预约挂号_In, 1, 操作员姓名_In, Null), 执行部门id_In, 医生姓名_In, 操作员编号_In, 操作员姓名_In, 发生时间_In, 登记时间_In, 保险大类id_In,
     保险项目否_In, 保险编码_In, 统筹金额_In, 摘要_In, 预约方式_In, Decode(预约挂号_In, 1, Null, n_组id));

  --汇总结算到病人预交记录
  If Nvl(预约挂号_In, 0) = 0 And Nvl(记帐费用_In, 0) = 0 Then
    If Nvl(现金支付_In, 0) = 0 And Nvl(个帐支付_In, 0) = 0 And Nvl(预交支付_In, 0) = 0 And 序号_In = 1 Then
      Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
      Insert Into 病人预交记录
        (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
         结算性质)
      Values
        (n_预交id, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), v_现金, 0, 登记时间_In, 操作员编号_In, 操作员姓名_In, 结帐id_In, '挂号收费',
         n_组id, 卡类别id_In, 结算卡序号_In, 卡号_In, 交易流水号_In, 交易说明_In, 合作单位_In, 4);
    End If;
    If Nvl(现金支付_In, 0) <> 0 And 序号_In = 1 Then
      v_结算内容     := 结算方式_In || '|'; --以空格分开以|结尾,没有结算号码的
      v_结算方式记录 := '';
      While v_结算内容 Is Not Null Loop
        v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '|') - 1);
        v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1);
      
        v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
        n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1));
      
        v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
        v_结算号码 := Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1);
      
        v_当前结算   := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
        n_三方卡标志 := To_Number(v_当前结算);
      
        If Instr('|' || v_结算方式记录 || '|', '|' || Nvl(v_结算方式, v_现金) || '|') <> 0 Then
          v_Err_Msg := '使用了重复的结算方式,请检查!';
          Raise Err_Item;
        Else
          v_结算方式记录 := v_结算方式记录 || '|' || Nvl(v_结算方式, v_现金);
        End If;
      
        If n_三方卡标志 = 0 Then
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          Insert Into 病人预交记录
            (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明,
             合作单位, 结算性质, 结算号码)
          Values
            (n_预交id, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), Nvl(v_结算方式, v_现金), Nvl(n_结算金额, 0), 登记时间_In,
             操作员编号_In, 操作员姓名_In, 结帐id_In, '挂号收费', n_组id, Null, Null, Null, Null, Null, 合作单位_In, 4, v_结算号码);
        Else
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          Insert Into 病人预交记录
            (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明,
             合作单位, 结算性质, 结算号码)
          Values
            (n_预交id, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), Nvl(v_结算方式, v_现金), Nvl(n_结算金额, 0), 登记时间_In,
             操作员编号_In, 操作员姓名_In, 结帐id_In, '挂号收费', n_组id, 卡类别id_In, 结算卡序号_In, 卡号_In, 交易流水号_In, 交易说明_In, 合作单位_In, 4,
             v_结算号码);
          If Nvl(结算卡序号_In, 0) <> 0 And Nvl(现金支付_In, 0) <> 0 Then
            n_消费卡id := Null;
            Begin
              Select Nvl(自制卡, 0), 1 Into n_自制卡, n_Count From 卡消费接口目录 Where 编号 = 结算卡序号_In;
            Exception
              When Others Then
                n_Count := 0;
            End;
            If n_Count = 0 Then
              v_Err_Msg := '没有发现原结算卡的相应类别,不能继续操作！';
              Raise Err_Item;
            End If;
            If n_自制卡 = 1 Then
              Select ID
              Into n_消费卡id
              From 消费卡目录
              Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In And
                    序号 = (Select Max(序号) From 消费卡目录 Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In);
            End If;
            Zl_病人卡结算记录_Insert(结算卡序号_In, n_消费卡id, Nvl(v_结算方式, v_现金), Nvl(n_结算金额, 0), 卡号_In, Null, 登记时间_In, Null, 结帐id_In,
                              n_预交id);
          End If;
        End If;
      
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + n_结算金额
        Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = Nvl(v_结算方式, v_现金)
        Returning 余额 Into n_返回值;
      
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额
            (收款员, 结算方式, 性质, 余额)
          Values
            (操作员姓名_In, Nvl(v_结算方式, v_现金), 1, n_结算金额);
          n_返回值 := n_结算金额;
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 人员缴款余额
          Where 收款员 = 操作员姓名_In And 结算方式 = Nvl(v_结算方式, v_现金) And 性质 = 1 And Nvl(余额, 0) = 0;
        End If;
      
        v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '|') + 1);
      End Loop;
    End If;
  
    --对于医保挂号
    If Nvl(个帐支付_In, 0) <> 0 And 序号_In = 1 Then
      Insert Into 病人预交记录
        (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 结算性质)
      Values
        (病人预交记录_Id.Nextval, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), v_个人帐户, 个帐支付_In, 登记时间_In, 操作员编号_In,
         操作员姓名_In, 结帐id_In, '医保挂号', n_组id, 4);
    End If;
  
    --对于就诊卡通过预交金挂号
    If Nvl(预交支付_In, 0) <> 0 And 序号_In = 1 Then
      n_预交金额 := 预交支付_In;
      For r_Deposit In c_Deposit(病人id_In, v_冲预交病人ids) Loop
        n_当前金额 := Case
                    When r_Deposit.金额 - n_预交金额 < 0 Then
                     r_Deposit.金额
                    Else
                     n_预交金额
                  End;
      
        If r_Deposit.结帐id = 0 Then
          --第一次冲预交(填上结帐ID,金额为0)
          Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 4 Where ID = r_Deposit.原预交id;
        
        End If;
        --冲上次剩余额
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 预交类别, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号,
           冲预交, 结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 预交类别, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
                 登记时间_In, 操作员姓名_In, 操作员编号_In, n_当前金额, 结帐id_In, n_组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
          From 病人预交记录
          Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
      
        --更新病人预交余额
        Update 病人余额
        Set 预交余额 = Nvl(预交余额, 0) - n_当前金额
        Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = Nvl(1, 2);
        --检查是否已经处理完
        If r_Deposit.金额 < n_预交金额 Then
          n_预交金额 := n_预交金额 - r_Deposit.金额;
        Else
          n_预交金额 := 0;
        End If;
      
        If n_预交金额 = 0 Then
          Exit;
        End If;
      End Loop;
      If n_预交金额 > 0 Then
        v_Err_Msg := '预交余不够支付本次支付金额,不能继续操作！';
        Raise Err_Item;
      
      End If;
      Delete From 病人余额 Where 病人id = 病人id_In And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
    End If;
  
    --相关汇总表的处理
    --人员缴款余额
    If 序号_In = 1 Then
      If Nvl(个帐支付_In, 0) <> 0 Then
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + 个帐支付_In
        Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = v_个人帐户
        Returning 余额 Into n_返回值;
      
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额 (收款员, 结算方式, 性质, 余额) Values (操作员姓名_In, v_个人帐户, 1, 个帐支付_In);
          n_返回值 := 个帐支付_In;
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 人员缴款余额
          Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_个人帐户 And Nvl(余额, 0) = 0;
        End If;
      End If;
    End If;
  End If;

  --病人挂号汇总(只处理一次,且单独收取病历费不处理)
  If Nvl(预约挂号_In, 0) = 0 Then
    If Nvl(记帐费用_In, 0) = 0 Then
      --处理票据使用情况
      If 序号_In = 1 And 票据号_In Is Not Null Then
        Select 票据打印内容_Id.Nextval Into n_打印id From Dual;
      
        --发出票据
        Insert Into 票据打印内容 (ID, 数据性质, NO) Values (n_打印id, 4, 单据号_In);
      
        Insert Into 票据使用明细
          (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
        Values
          (票据使用明细_Id.Nextval, Decode(收费票据_In, 1, 1, 4), 票据号_In, 1, 1, 领用id_In, n_打印id, 登记时间_In, 操作员姓名_In);
      
        --状态改动
        Update 票据领用记录
        Set 当前号码 = 票据号_In, 剩余数量 = Decode(Sign(剩余数量 - 1), -1, 0, 剩余数量 - 1), 使用时间 = Sysdate
        Where ID = Nvl(领用id_In, 0);
      End If;
    End If;
    --病人本次就诊(以发生时间为准)
    If Nvl(病人id_In, 0) <> 0 And 序号_In = 1 Then
      Update 病人信息 Set 就诊时间 = 发生时间_In, 就诊状态 = 1, 就诊诊室 = 诊室_In Where 病人id = 病人id_In;
    End If;
  End If;

  If Nvl(预约挂号_In, 0) = 0 And Nvl(记帐费用_In, 0) = 1 Then
    --记帐
    If Nvl(病人id_In, 0) = 0 Then
      v_Err_Msg := '要针对病人的挂号费进行记帐，必须是建档病人才能记帐挂号。';
      Raise Err_Item;
    End If;
  
    --病人余额
    Update 病人余额
    Set 费用余额 = Nvl(费用余额, 0) + Nvl(实收金额_In, 0)
    Where 病人id = Nvl(病人id_In, 0) And 性质 = 1 And 类型 = 1;
  
    If Sql%RowCount = 0 Then
      Insert Into 病人余额 (病人id, 性质, 类型, 费用余额, 预交余额) Values (病人id_In, 1, 1, Nvl(实收金额_In, 0), 0);
    End If;
  
    --病人未结费用
    Update 病人未结费用
    Set 金额 = Nvl(金额, 0) + Nvl(实收金额_In, 0)
    Where 病人id = 病人id_In And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And Nvl(病人科室id, 0) = Nvl(病人科室id_In, 0) And
          Nvl(开单部门id, 0) = Nvl(开单部门id_In, 0) And Nvl(执行部门id, 0) = Nvl(执行部门id_In, 0) And 收入项目id + 0 = 收入项目id_In And
          来源途径 + 0 = 1;
  
    If Sql%RowCount = 0 Then
      Insert Into 病人未结费用
        (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
      Values
        (病人id_In, Null, Null, 病人科室id_In, 开单部门id_In, 执行部门id_In, 收入项目id_In, 1, Nvl(实收金额_In, 0));
    End If;
  End If;

  --病人挂号记录
  If 号别_In Is Not Null And 序号_In = 1 Then
    --And Nvl(预约挂号_In, 0) = 0
    Select 病人挂号记录_Id.Nextval Into n_挂号id From Dual;
    Begin
      Select 名称 Into v_付款方式 From 医疗付款方式 Where 编码 = 付款方式_In And Rownum < 2;
    Exception
      When Others Then
        v_付款方式 := Null;
    End;
    Insert Into 病人挂号记录
      (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 预约时间, 操作员编号,
       操作员姓名, 复诊, 号序, 社区, 预约, 预约方式, 摘要, 交易流水号, 交易说明, 合作单位, 接收时间, 接收人, 预约操作员, 预约操作员编号, 险类, 医疗付款方式, 出诊记录id, 收费单)
    Values
      (n_挂号id, 单据号_In, Decode(Nvl(预约挂号_In, 0), 1, 2, 1), 1, 病人id_In, 门诊号_In, 姓名_In, 性别_In, 年龄_In, 号别_In, 急诊_In, 诊室_In,
       Null, 执行部门id_In, 医生姓名_In, 0, Null, 登记时间_In, 发生时间_In, Decode(Nvl(预约挂号_In, 0), 1, 发生时间_In, Null), 操作员编号_In,
       操作员姓名_In, 复诊_In, n_序号, 社区_In, Decode(预约接收_In, 1, 1, 0), 预约方式_In, 摘要_In, 交易流水号_In, 交易说明_In, 合作单位_In,
       Decode(Nvl(预约挂号_In, 0), 0, 登记时间_In, Null), Decode(Nvl(预约挂号_In, 0), 0, 操作员姓名_In, Null),
       Decode(Nvl(预约挂号_In, 0), 1, 操作员姓名_In, Null), Decode(Nvl(预约挂号_In, 0), 1, 操作员编号_In, Null),
       Decode(Nvl(险类_In, 0), 0, Null, 险类_In), v_付款方式, 出诊记录id_In, 收费单_In);
  
    If Nvl(预约挂号_In, 0) = 0 And 预约方式_In Is Not Null Then
      Update 病人挂号记录
      Set 预约 = 1, 预约时间 = 发生时间_In, 预约操作员 = 操作员姓名_In, 预约操作员编号 = 操作员编号_In
      Where ID = n_挂号id;
    End If;
  
    n_预约生成队列 := 0;
    If Nvl(预约挂号_In, 0) = 1 Then
      n_预约生成队列 := Zl_To_Number(zl_GetSysParameter('预约生成队列', 1113));
    End If;
  
    --0-不产生队列;1-按医生或分诊台排队;2-先分诊,后医生站
    If Nvl(生成队列_In, 0) <> 0 And Nvl(预约挂号_In, 0) = 0 Or n_预约生成队列 = 1 Then
      n_分诊台签到排队 := Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113));
      If Nvl(n_分诊台签到排队, 0) = 0 Or n_预约生成队列 = 1 Then
        n_分时点显示 := Nvl(Zl_To_Number(zl_GetSysParameter(270)), 0);
        If Nvl(预约挂号_In, 0) = 1 And n_分时点显示 = 1 And n_分时段 = 1 Then
          n_分时点显示 := 1;
        Else
          n_分时点显示 := Null;
        End If;
        --产生队列
        --.按”执行部门” 的方式生成队列
        v_队列名称 := 执行部门id_In;
        v_排队号码 := Zlgetnextqueue(执行部门id_In, n_挂号id, 号别_In || '|' || n_序号);
        v_排队序号 := Zlgetsequencenum(0, n_挂号id, 0);
        d_排队时间 := Zl_Get_Queuedate(n_挂号id, 号别_In, n_序号, 发生时间_In);
        --  队列名称_In , 业务类型_In, 业务id_In,科室id_In,排队号码_In,排队标记_In,患者姓名_In,病人ID_IN, 诊室_In, 医生姓名_In, 排队时间_In
        Zl_排队叫号队列_Insert(v_队列名称, 0, n_挂号id, 执行部门id_In, v_排队号码, Null, 姓名_In, 病人id_In, 诊室_In, 医生姓名_In, d_排队时间, 预约方式_In,
                         n_分时点显示, v_排队序号);
      
        --挂号立即排队
        If Nvl(n_分诊台签到排队, 0) = 0 Then
          Update 病人挂号记录 Set 记录标志 = 1 Where ID = n_挂号id;
        End If;
      End If;
    End If;
  End If;
  --病人担保信息
  If 病人id_In Is Not Null And 序号_In = 1 Then
    --取参数:
    If Nvl(n_结算模式, 0) <> Nvl(结算模式_In, 0) Then
      --结算模式的确定
    
      v_Err_Msg := Null;
      Begin
        Select Nvl(结算模式, 0) Into n_结算模式 From 病人信息 Where 病人id = 病人id_In;
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的病人信息,不允许挂号';
      End;
    
      If v_Err_Msg Is Not Null Then
        Raise Err_Item;
      End If;
      If n_结算模式 = 1 And Nvl(结算模式_In, 0) = 0 Then
        --病人已经是"先诊疗后结算的",本次是"先结算后诊疗的",则检查是否存在未结数据
        Select Count(1)
        Into n_Count
        From 病人未结费用
        Where 病人id = 病人id_In And (来源途径 In (1, 4) Or 来源途径 = 3 And Nvl(主页id, 0) = 0) And Nvl(金额, 0) <> 0 And Rownum < 2;
        If Nvl(n_Count, 0) <> 0 Then
          --存在未结算数据，必须先结算后才允许执行
          v_Err_Msg := '当前病人的就诊模式为先诊疗后结算且存在未结费用，不允许调整该病人的就诊模式,你可以先对未结费用结帐后再挂号或不调整病人的就诊模式!';
          Raise Err_Item;
        End If;
        --检查
        --未发生医嘱业务的（即当时就挂号的,需要保证同一次的就诊模式是一至的(程序已经检查，不用再处理)
      End If;
      Update 病人信息 Set 结算模式 = 结算模式_In Where 病人id = 病人id_In;
    End If;
  
    Update 病人信息
    Set 担保人 = Null, 担保额 = Null, 担保性质 = Null
    Where 病人id = 病人id_In And Exists (Select 1
           From 病人担保记录
           Where 病人id = 病人id_In And 主页id Is Not Null And
                 登记时间 = (Select Max(登记时间) From 病人担保记录 Where 病人id = 病人id_In));
  
    If Sql%RowCount > 0 Then
      Update 病人担保记录
      Set 到期时间 = Sysdate
      Where 病人id = 病人id_In And 主页id Is Not Null And Nvl(到期时间, Sysdate) > Sysdate;
    End If;
  End If;
  If 序号_In = 1 Then
    --消息推送
    Begin
      Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
        Using 1, n_挂号id;
    Exception
      When Others Then
        Null;
    End;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人挂号记录_出诊_Insert;
/


--102751:刘尔旋,2017-04-11,病人挂号记录对应收费单
CREATE OR REPLACE Procedure Zl_病人挂号记录_Insert
(
  病人id_In        门诊费用记录.病人id%Type,
  门诊号_In        门诊费用记录.标识号%Type,
  姓名_In          门诊费用记录.姓名%Type,
  性别_In          门诊费用记录.性别%Type,
  年龄_In          门诊费用记录.年龄%Type,
  付款方式_In      门诊费用记录.付款方式%Type, --用于存放病人的医疗付款方式编号
  费别_In          门诊费用记录.费别%Type,
  单据号_In        门诊费用记录.No%Type,
  票据号_In        门诊费用记录.实际票号%Type,
  序号_In          门诊费用记录.序号%Type,
  价格父号_In      门诊费用记录.价格父号%Type,
  从属父号_In      门诊费用记录.从属父号%Type,
  收费类别_In      门诊费用记录.收费类别%Type,
  收费细目id_In    门诊费用记录.收费细目id%Type,
  数次_In          门诊费用记录.数次%Type,
  标准单价_In      门诊费用记录.标准单价%Type,
  收入项目id_In    门诊费用记录.收入项目id%Type,
  收据费目_In      门诊费用记录.收据费目%Type,
  结算方式_In      病人预交记录.结算方式%Type, --现金的结算名称
  应收金额_In      门诊费用记录.应收金额%Type,
  实收金额_In      门诊费用记录.实收金额%Type,
  病人科室id_In    门诊费用记录.病人科室id%Type,
  开单部门id_In    门诊费用记录.开单部门id%Type,
  执行部门id_In    门诊费用记录.执行部门id%Type,
  操作员编号_In    门诊费用记录.操作员编号%Type,
  操作员姓名_In    门诊费用记录.操作员姓名%Type,
  发生时间_In      门诊费用记录.发生时间%Type,
  登记时间_In      门诊费用记录.登记时间%Type,
  医生姓名_In      挂号安排.医生姓名%Type,
  医生id_In        挂号安排.医生id%Type,
  病历费_In        Number, --该条记录是否病历工本费
  急诊_In          Number,
  号别_In          挂号安排.号码%Type,
  诊室_In          门诊费用记录.发药窗口%Type,
  结帐id_In        门诊费用记录.结帐id%Type,
  领用id_In        票据使用明细.领用id%Type,
  预交支付_In      病人预交记录.冲预交%Type, --刷卡挂号时使用的预交金额,序号为1传入.
  现金支付_In      病人预交记录.冲预交%Type, --挂号时现金支付部份金额,序号为1传入.
  个帐支付_In      病人预交记录.冲预交%Type, --挂号时个人帐户支付金额,,序号为1传入.
  保险大类id_In    门诊费用记录.保险大类id%Type,
  保险项目否_In    门诊费用记录.保险项目否%Type,
  统筹金额_In      门诊费用记录.统筹金额%Type,
  摘要_In          门诊费用记录.摘要%Type, --预约挂号摘要信息
  预约挂号_In      Number := 0, --预约挂号时用(记录状态=0,发生时间为预约时间),此时不需要传入结算相关参数
  收费票据_In      Number := 0, --挂号是否使用收费票据
  保险编码_In      门诊费用记录.保险编码%Type,
  复诊_In          病人挂号记录.复诊%Type := 0,
  号序_In          挂号序号状态.序号%Type := Null, --预约时填入费用记录的发药窗口字段,挂号时填入挂号记录
  社区_In          病人挂号记录.社区%Type := Null,
  预约接收_In      Number := 0,
  预约方式_In      预约方式.名称%Type := Null,
  生成队列_In      Number := 0,
  卡类别id_In      病人预交记录.卡类别id%Type := Null,
  结算卡序号_In    病人预交记录.结算卡序号%Type := Null,
  卡号_In          病人预交记录.卡号%Type := Null,
  交易流水号_In    病人预交记录.交易流水号%Type := Null,
  交易说明_In      病人预交记录.交易说明%Type := Null,
  合作单位_In      病人预交记录.合作单位%Type := Null,
  操作类型_In      Number := 0,
  险类_In          病人挂号记录.险类%Type := Null,
  结算模式_In      Number := 0,
  记帐费用_In      Number := 0,
  退号重用_In      Number := 1,
  冲预交病人ids_In Varchar2 := Null,
  修正病人费别_In  Number := 0,
  修正病人年龄_In  Number := 0,
  收费单_In        病人挂号记录.收费单%Type := Null
) As
  ---------------------------------------------------------------------------
  --
  --参数:
  --     操作类型_in:0-正常挂号或者预约 1-操作员拥有加号权限加号
  --     修正病人费别_In:0-不修改病人费别 1-修改病人费别
  ----------------------------------------------------------------------------
  --该游标用于收费冲预交的可用预交列表
  --以ID排序，优先冲上次未冲完的。
  Cursor c_Deposit
  (
    v_病人id        病人信息.病人id%Type,
    v_冲预交病人ids Varchar2
  ) Is
    Select 病人id, NO, Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) As 金额, Min(记录状态) As 记录状态, Nvl(Max(结帐id), 0) As 结帐id,
           Max(Decode(记录性质, 1, ID, 0) * Decode(记录状态, 2, 0, 1)) As 原预交id
    From 病人预交记录
    Where 记录性质 In (1, 11) And 病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And Nvl(预交类别, 2) = 1
     Having Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) <> 0
    Group By NO, 病人id
    Order By Decode(病人id, Nvl(v_病人id, 0), 0, 1), 结帐id, NO;
  --功能：新增一行病人挂号费用，并将结算汇总到病人预交记录
  --       同时汇总相关的汇总表(病人挂号汇总、费用汇总)
  --       第一行费用处理票据使用情况(领用ID_IN>0)

  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  v_排队号码 排队叫号队列.排队号码%Type;
  v_现金     结算方式.名称%Type;
  v_个人帐户 结算方式.名称%Type;
  v_队列名称 排队叫号队列.队列名称%Type;

  n_分时段       Number;
  n_时段限号     Number;
  n_时段限约     Number;
  d_时段时间     Date;
  d_最大序号时间 Date;
  n_追加号       Number := 0; --处理时段过期 追加挂号的情况
  n_已约数       病人挂号汇总.已约数%Type;
  n_已接收       病人挂号汇总.其中已接收%Type;
  n_预约有效时间 Number;
  n_失效数       Number;
  n_失约挂号     Number := 0;
  n_已用数量     Number;
  n_锁定         Number := 0;

  n_打印id        票据打印内容.Id%Type;
  n_费用id        门诊费用记录.Id%Type;
  n_预交金额      病人预交记录.金额%Type;
  n_当前金额      病人预交记录.金额%Type;
  n_返回值        病人预交记录.金额%Type;
  n_预交id        病人预交记录.Id%Type;
  n_消费卡id      消费卡目录.Id%Type;
  n_挂号id        病人挂号记录.Id%Type;
  v_冲预交病人ids Varchar2(4000);

  n_组id           财务缴款分组.Id%Type;
  n_门诊号         病人信息.门诊号%Type;
  n_序号           挂号序号状态.序号%Type;
  n_已用序号       挂号序号状态.序号%Type;
  n_序号控制       挂号安排.序号控制%Type;
  n_分诊台签到排队 Number;
  n_Count          Number;
  n_限号数         Number(18);
  n_自制卡         Number;
  d_排队时间       Date;
  d_序号时间       Date;
  v_费别           费别.名称%Type;
  n_时段序号       Number := -1;
  n_预约生成队列   Number;
  n_安排id         挂号安排.Id%Type;
  n_计划id         挂号安排计划.Id%Type := 0;
  v_星期           挂号安排限制.限制项目%Type;
  n_限约数         Number(18);
  n_已挂数         Number(4) := 0;

  n_挂出的最大序号 Number(4) := 0;
  n_结算模式       病人信息.结算模式%Type;
  v_排队序号       排队叫号队列.排队序号%Type;
  v_机器名         挂号序号状态.机器名%Type;
  v_序号操作员     挂号序号状态.操作员姓名%Type;
  v_序号机器名     挂号序号状态.机器名%Type;
  v_付款方式       病人挂号记录.医疗付款方式%Type;
  v_Temp           Varchar2(3000);
  v_时间段         时间段.时间段%Type;
  d_检查开始时间   时间段.开始时间%Type;
  d_检查结束时间   时间段.终止时间%Type;
  n_出诊记录id     临床出诊记录.Id%Type;
  n_分时点显示     Number(3);
  d_启用时间       Date;
Begin
  --获取当前机器名称
  Select Terminal Into v_机器名 From V$session Where Audsid = Userenv('sessionid');
  n_组id          := Zl_Get组id(操作员姓名_In);
  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);

  If 费别_In Is Null Then
    Begin
      Select 名称 Into v_费别 From 费别 Where 缺省标志 = 1 And Rownum < 2;
      Update 病人信息 Set 费别 = v_费别 Where 病人id = 病人id_In;
    Exception
      When Others Then
        v_Err_Msg := '无法确定病人费别，请检查缺省费别是否正确设置！';
        Raise Err_Item;
    End;
  Else
    v_费别 := 费别_In;
    If Nvl(修正病人费别_In, 0) = 1 Then
      Begin
        Update 病人信息 Set 费别 = v_费别 Where 病人id = 病人id_In;
      Exception
        When Others Then
          v_Err_Msg := '没有找到对应的病人！';
          Raise Err_Item;
      End;
    End If;
  End If;

  If Nvl(修正病人年龄_In, 0) = 1 Then
    Begin
      Update 病人信息 Set 年龄 = 年龄_In Where 病人id = 病人id_In;
    Exception
      When Others Then
        v_Err_Msg := '没有找到对应的病人！';
        Raise Err_Item;
    End;
  End If;

  If 门诊号_In Is Not Null Then
    Begin
      Select Nvl(门诊号, 0) Into n_门诊号 From 病人信息 Where 病人id = 病人id_In;
    Exception
      When Others Then
        n_门诊号 := 0;
    End;
    If n_门诊号 = 0 Then
      Update 病人信息 Set 门诊号 = 门诊号_In Where 病人id = 病人id_In;
    End If;
  End If;

  Begin
    Delete From 挂号序号状态
    Where 号码 = 号别_In And 日期 = 发生时间_In And 序号 = 号序_In And 状态 = 3 And 操作员姓名 = 操作员姓名_In;
  Exception
    When Others Then
      Null;
  End;
  v_Temp := zl_GetSysParameter(256);
  If v_Temp Is Null Or Substr(v_Temp, 1, 1) = '0' Then
    Null;
  Else
    Begin
      d_启用时间 := To_Date(Substr(v_Temp, 3), 'YYYY-MM-DD hh24:mi:ss');
    Exception
      When Others Then
        d_启用时间 := Null;
    End;
    If d_启用时间 Is Not Null Then
      If 发生时间_In > d_启用时间 Then
        v_Err_Msg := '当前挂号的发生时间' || To_Char(发生时间_In, 'yyyy-mm-dd hh24:mi:ss') || '已经启用了出诊表排班模式,不能再使用计划排班模式挂号!';
        Raise Err_Item;
      End If;
    End If;
  End If;

  If Nvl(预约挂号_In, 0) = 0 Then
    --挂号或者预约接收
    --因为现在有按日编单据号规则,日挂号量不能超过10000次,所以要检查唯一约束。
    Select Count(*)
    Into n_Count
    From 门诊费用记录
    Where 记录性质 = 4 And 记录状态 In (1, 3) And 序号 = 序号_In And NO = 单据号_In;
    If n_Count <> 0 Then
      v_Err_Msg := '挂号单据号重复,不能保存！' || Chr(13) || '如果使用了按日顺序编号,当日挂号量不能超过10000人次。';
      Raise Err_Item;
    End If;

    --获取结算方式名称
    Begin
      Select 名称 Into v_现金 From 结算方式 Where 性质 = 1;
    Exception
      When Others Then
        v_现金 := '现金';
    End;
    Begin
      Select 名称 Into v_个人帐户 From 结算方式 Where 性质 = 3;
    Exception
      When Others Then
        v_个人帐户 := '个人帐户';
    End;
  End If;

  n_序号 := 号序_In;
  Select Decode(To_Char(发生时间_In, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7', '周六', Null)
  Into v_星期
  From Dual;

  --挂号获取安排
  Begin
    Select a.Id, a.序号控制, Nvl(b.限号数, 0), Nvl(b.限约数, 0)
    Into n_安排id, n_序号控制, n_限号数, n_限约数
    From 挂号安排 A, 挂号安排限制 B
    Where a.Id = b.安排id(+) And b.限制项目(+) = v_星期 And a.号码 = 号别_In;

  Exception
    When Others Then
      n_安排id := -1;
  End;

  --如果是病历费或者号别为空时不检查
  If Nvl(病历费_In, 0) = 0 Or 号别_In Is Not Null Then
    If n_安排id = -1 Then
      v_Err_Msg := '不存相应的挂号安排数据,请检查';
      Raise Err_Item;
    End If;
  End If;

  If Nvl(预约挂号_In, 0) = 1 Then
    --首先获取计划
    Begin
      Select ID
      Into n_计划id
      From 挂号安排计划
      Where 安排id = n_安排id And 审核时间 Is Not Null And
            Nvl(生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) =
            (Select Max(a.生效时间) As 生效
             From 挂号安排计划 A
             Where a.审核时间 Is Not Null And 发生时间_In Between Nvl(a.生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) And
                   Nvl(a.失效时间, To_Date('3000-01-01', 'yyyy-mm-dd')) And a.安排id = n_安排id) And
            发生时间_In Between Nvl(生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) And
            Nvl(失效时间, To_Date('3000-01-01', 'yyyy-mm-dd'));

    Exception
      When Others Then
        n_计划id := 0;
    End;
    If Nvl(n_计划id, 0) <> 0 Then
      Begin
        --获取计划的限制
        Select a.Id, a.序号控制, Nvl(b.限号数, 0) As 限号数, Nvl(b.限约数, 0) As 限约数
        Into n_计划id, n_序号控制, n_限号数, n_限约数
        From 挂号安排计划 A, 挂号计划限制 B
        Where a.号码 = 号别_In And a.Id = n_计划id And a.审核时间 Is Not Null And a.Id = b.计划id(+) And b.限制项目(+) = v_星期;
      Exception
        When Others Then
          v_Err_Msg := '不存相应的挂号安排或计划数据,请检查';
          Raise Err_Item;
      End;
    End If;
  End If;

  --获取是否分时段
  Begin
    If Nvl(n_计划id, 0) = 0 Then
      Select Count(Rownum) Into n_分时段 From 挂号安排时段 Where 星期 = v_星期 And 安排id = n_安排id And Rownum <= 1;
      Select Decode(To_Char(发生时间_In, 'D'), '1', 周日, '2', 周一, '3', 周二, '4', 周三, '5', 周四, '6', 周五, '7', 周六, Null)
      Into v_时间段
      From 挂号安排
      Where ID = n_安排id;
    Else
      Select Count(Rownum) Into n_分时段 From 挂号计划时段 Where 星期 = v_星期 And 计划id = n_计划id And Rownum <= 1;
      Select Decode(To_Char(发生时间_In, 'D'), '1', 周日, '2', 周一, '3', 周二, '4', 周三, '5', 周四, '6', 周五, '7', 周六, Null)
      Into v_时间段
      From 挂号安排计划
      Where ID = n_计划id;
    End If;
  Exception
    When Others Then
      v_时间段 := Null;
  End;

  If v_时间段 Is Not Null And d_启用时间 Is Not Null And 序号_In = 1 Then
    --检查是否跨模式挂号安排
    Select To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'),
           To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(终止时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
    Into d_检查开始时间, d_检查结束时间
    From 时间段
    Where 时间段 = v_时间段 And 站点 Is Null And 号类 Is Null;
    If d_检查开始时间 > d_检查结束时间 Then
      d_检查结束时间 := d_检查结束时间 + 1;
    End If;
    If d_检查开始时间 < d_启用时间 And d_检查结束时间 > d_启用时间 Then
      --获取出诊记录id
      Begin
        Select a.Id
        Into n_出诊记录id
        From 临床出诊记录 A, 临床出诊号源 B
        Where a.号源id = b.Id And b.号码 = 号别_In And 上班时段 = v_时间段 And 发生时间_In Between 开始时间 And 终止时间;
      Exception
        When Others Then
          n_出诊记录id := Null;
      End;
    End If;
  End If;

  --分时段挂号时判断是否是过期挂号 也就是追加号的情况 目前只针对专家号分时段进行处理
  If Nvl(预约挂号_In, 0) = 0 And n_分时段 > 0 And Nvl(n_序号控制, 0) = 1 And 号序_In Is Null And Nvl(操作类型_In, 0) = 0 Then
    --发生时间_in>Sysdate 发生时间>最大的时段时间--号序_in is null
    Begin
      Select Max(To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'))
      Into d_最大序号时间
      From 挂号安排时段
      Where 安排id = n_安排id And 星期 = v_星期 And Nvl(限制数量, 0) <> 0;
      n_追加号 := Case Sign(发生时间_In - d_最大序号时间)
                 When -1 Then
                  0
                 Else
                  1
               End;
    Exception
      When Others Then
        n_追加号 := 0;
    End;
  End If;
  d_时段时间 := 发生时间_In;

  If 序号_In = 1 And Nvl(预约挂号_In, 0) = 0 And n_分时段 > 0 Then
    --挂号时检查 是否分了时段,分了时段,把时段的限制条件给取出来
    Begin
      Select Nvl(序号, 0),
             To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'),
             限制数量, Decode(Nvl(是否预约, 0), 0, 0, 限制数量)
      Into n_时段序号, d_时段时间, n_时段限号, n_时段限约
      From 挂号安排时段
      Where 安排id = n_安排id And 星期 = v_星期 And
            (序号, 安排id, 星期) In (Select Nvl(Max(序号), -1), 安排id, 星期
                               From 挂号安排时段
                               Where 安排id = n_安排id And 星期 = v_星期 And
                                     Decode(操作类型_In + n_追加号, 0, To_Char(发生时间_In, 'hh24:mi'),
                                            To_Char(Nvl(开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi')) =
                                     To_Char(Nvl(开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi')
                               Group By 安排id, 星期);
    Exception
      When Others Then
        n_时段序号 := -1;
        n_分时段   := 0;
        d_时段时间 := 发生时间_In;
        n_时段限号 := 0;
        n_时段限约 := 0;
    End;
  End If;

  If 序号_In = 1 And Nvl(预约挂号_In, 0) = 1 And n_分时段 > 0 Then
    --预约号,取计划
    Begin
      If Nvl(n_计划id, 0) = 0 Then
        --没计划生效,取安排的数据
        Select Nvl(序号, 0),
               To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(c.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 时段时间,
               限制数量, Decode(Nvl(是否预约, 0), 0, 0, 限制数量)
        Into n_时段序号, d_时段时间, n_时段限号, n_时段限约
        From 挂号安排时段 C
        Where 安排id = n_安排id And 星期 = v_星期 And
              (序号, 安排id, 星期) In
              (Select Nvl(Max(c.序号), -1), 安排id, 星期
               From 挂号安排时段 C
               Where 安排id = n_安排id And c.星期 = v_星期 And
                     Decode(操作类型_In, 1, To_Char(Nvl(c.开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi'),
                            To_Char(发生时间_In, 'hh24:mi')) =
                     To_Char(Nvl(c.开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi')
               Group By 安排id, 星期);
      Else
        --有计划生效取计划
        --没生效，代表是从挂号计划时段查询
        Select Nvl(序号, -1),
               To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(c.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 时段时间,
               限制数量, Decode(Nvl(是否预约, 0), 0, 0, 限制数量)
        Into n_时段序号, d_时段时间, n_时段限号, n_时段限约
        From 挂号计划时段 C
        Where 计划id = n_计划id And 星期 = v_星期 And
              (序号, 计划id, 星期) In
              (Select Nvl(Max(c.序号), -1), 计划id, 星期
               From 挂号计划时段 C
               Where 计划id = n_计划id And c.星期 = v_星期 And
                     Decode(操作类型_In, 1, To_Char(Nvl(c.开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi'),
                            To_Char(发生时间_In, 'hh24:mi')) =
                     To_Char(Nvl(c.开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi')
               Group By 计划id, 星期);
      End If;
    Exception
      When Others Then
        n_时段序号 := -1;
        n_分时段   := 0;
        d_时段时间 := 发生时间_In;
        n_时段限号 := 0;
        n_时段限约 := 0;
    End;
  End If;

  If 序号_In = 1 Then

    --获取当前未使用的序号
    If Nvl(n_序号控制, 0) = 1 And n_分时段 = 0 Then
      --<序号控制 未设置时段 获取可用的最大序号,以及已经使用的数量>
      Begin
        --最大序号
        If 退号重用_In = 1 Then
          Select Max(Nvl(序号, 0)), Sum(Decode(序号, Nvl(号序_In, 0), 0, 1)), Sum(Nvl(预约, 0))
          Into n_已用序号, n_已用数量, n_已约数
          From 挂号序号状态
          Where 号码 = 号别_In And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 状态 Not In (4, 5);
        Else
          Select Max(Nvl(序号, 0)), Sum(Decode(序号, Nvl(号序_In, 0), 0, 1)), Sum(Nvl(预约, 0))
          Into n_已用序号, n_已用数量, n_已约数
          From 挂号序号状态
          Where 号码 = 号别_In And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 状态 <> 5;
        End If;
      Exception
        When Others Then
          n_已用序号 := 0;
          n_已用数量 := 0;
      End;
      If n_序号 Is Null Then
        n_序号 := Nvl(n_已用序号, 0) + 1;
      End If;
      --<序号控制 未设置时段 获取可用的最大序号 以及已经使用的数量 --end>

      --非加号的情况需要检查是否超过了限制
      If 操作类型_In = 0 Then
        If Nvl(预约挂号_In, 0) = 0 Then
          --挂号时检查
          --启用序号控制未分时段 达到了限制
          If n_限号数 <= n_已用数量 And n_限号数 > 0 Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(Trunc(发生时间_In), 'yyyy-mm-dd ') || '已达到最大限制数！';
            Raise Err_Item;
          End If;

        Else
          --预约时检查
          If n_限约数 = 0 Then
            n_限约数 := n_限号数;
          End If;

          If n_限约数 <= n_已约数 And n_限约数 > 0 Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(Trunc(发生时间_In), 'yyyy-mm-dd') || '已达到最大限约数！';
            Raise Err_Item;
          End If;
        End If;

      Else
        Null;
        --启用序号控制,未分时段 加号情况   不处理,如果以后有限制条件以后补充
      End If;

    Elsif Nvl(n_分时段, 0) > 0 And Nvl(n_序号控制, 0) = 0 Then
      --<--普通号分时段 这里只有预约一种情况-->
      If 操作类型_In = 0 Then
        --<正常预约挂号-->
        Begin
          Select Count(0) As 已挂数, Nvl(Sum(Decode(Nvl(Sign(a.日期 - d_时段时间), 0), 0, 1, 0)), 0) As 已约数
          Into n_已挂数, n_已约数
          From 挂号序号状态 A
          Where a.号码 = 号别_In And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And
                状态 Not In (4, 5);
        Exception
          When Others Then
            n_已挂数 := 0;
            n_已约数 := 0;
        End;

        n_时段限约 := n_时段限号; --普通号分时段的情况,29中n_时段限约始终是0 这里特殊处理
        --检查限制数量
        If n_限约数 = 0 Then
          n_限约数 := n_限号数;
        End If;
        If n_时段限约 <= n_已约数 Or n_限约数 <= n_已约数 Then
          v_Err_Msg := '号别' || 号别_In || '在时段' || To_Char(d_时段时间, 'hh24:mi') || '已达到最大限约数！';
          Raise Err_Item;
        End If;
        If n_限号数 <= n_已挂数 Then
          v_Err_Msg := '号别' || 号别_In || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！';
          Raise Err_Item;
        End If;
      End If;

      --没有达到时段的限号数 号码在当前时段往后追加

      --获取当天挂出的最大号序
      If 退号重用_In = 1 Then
        Select Nvl(Max(序号), 0)
        Into n_挂出的最大序号
        From 挂号序号状态 A
        Where a.日期 = d_时段时间 And 号码 = 号别_In And 状态 Not In (4, 5);
      Else
        Select Nvl(Max(序号), 0)
        Into n_挂出的最大序号
        From 挂号序号状态 A
        Where a.日期 = d_时段时间 And 号码 = 号别_In And 状态 <> 5;
      End If;

      --设置序号
      n_序号 := RPad(Nvl(n_时段序号, 0), Length(n_限号数) + Length(Nvl(n_时段序号, 0)), 0) + n_已约数 + 1;
      If n_序号 <= Nvl(n_挂出的最大序号, 0) Then
        n_序号 := Nvl(n_挂出的最大序号, 0) + 1;
      End If;

      --<--普通号分时段--End>
    Elsif Nvl(n_分时段, 0) > 0 And Nvl(n_序号控制, 0) = 1 Then
      --<启用序号控制 设置时段
      --专家号分时段
      Begin
        If 退号重用_In = 1 Then
          Select Max(序号), Sum(Decode(序号, Nvl(号序_In, 0), 0, 1)), Sum(Decode(Sign(日期 - d_时段时间), 0, 1, 0))
          Into n_已用序号, n_已挂数, n_已用数量
          From 挂号序号状态
          Where 号码 = 号别_In And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 状态 Not In (4, 5);
        Else
          Select Max(序号), Sum(Decode(序号, Nvl(号序_In, 0), 0, 1)), Sum(Decode(Sign(日期 - d_时段时间), 0, 1, 0))
          Into n_已用序号, n_已挂数, n_已用数量
          From 挂号序号状态
          Where 号码 = 号别_In And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 状态 <> 5;
        End If;
      Exception
        When Others Then
          n_已用序号 := 0;
          n_已用数量 := 0;
          n_已挂数   := 0;
      End;

      n_失效数 := 0;
      If Nvl(预约挂号_In, 0) = 0 Then
        n_预约有效时间 := Zl_To_Number(zl_GetSysParameter('预约有效时间', 1111));
        n_失约挂号     := Zl_To_Number(zl_GetSysParameter('失约用于挂号', 1111));
        If Nvl(n_预约有效时间, 0) <> 0 And Nvl(n_失约挂号, 0) > 0 Then
          Begin
            Select Sum(Decode(Sign((Sysdate - n_预约有效时间 / 24 / 60) - 日期), 1, 1, 0))
            Into n_失效数
            From 挂号序号状态
            Where 号码 = 号别_In And 日期 Between Trunc(Sysdate) And Sysdate And Nvl(预约, 0) = 1 And 状态 = 2;
          Exception
            When Others Then
              n_失效数 := 0;
          End;
        End If;
      End If;

      If 操作类型_In = 0 Then
        If Nvl(预约挂号_In, 0) = 0 Then

          --挂号 追加号码时不检查时段限号数
          If n_时段限号 <= n_已用数量 And Nvl(n_追加号, 0) = 0 Then
            v_Err_Msg := '号别' || 号别_In || '在时段' || To_Char(d_时段时间, 'hh24:mi') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
          If n_限号数 <= n_已挂数 - n_失效数 Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！';
            Raise Err_Item;
          End If;

        Else
          --挂号
          If n_限约数 = 0 Then
            n_限约数 := n_限号数;
          End If;
          If n_限约数 <= n_已用数量 Then
            v_Err_Msg := '号别' || 号别_In || '在时段' || To_Char(d_时段时间, 'hh24:mi') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
          If n_限号数 <= n_已挂数 Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
        End If;
      End If;
      If n_序号 Is Null Then
        --设置序号
        If Nvl(n_已用序号, 0) < Nvl(n_时段序号, 0) Then
          n_已用序号 := Nvl(n_时段序号, 0);
        End If;
        n_序号 := Nvl(n_已用序号, 0) + 1;
      End If;
    Elsif Nvl(n_分时段, 0) = 0 And Nvl(n_序号控制, 0) = 0 And Nvl(病历费_In, 0) = 0 And Nvl(号别_In, 0) > 0 Then
      ---<--普通号  -->
      Begin
        Select 已挂数, 已约数
        Into n_已用数量, n_已约数
        From 病人挂号汇总
        Where 日期 = Trunc(发生时间_In) And 号码 = 号别_In;
      Exception
        When Others Then
          n_已用数量 := 0;
          n_已约数   := 0;
      End;
      If Nvl(操作类型_In, 0) = 0 Then
        If Nvl(预约挂号_In, 0) = 0 Then
          --挂号
          If Nvl(n_已用数量, 0) >= Nvl(n_限号数, 0) And Nvl(n_限号数, 0) > 0 Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
        Else
          --预约
          If (Nvl(n_限约数, 0) > 0 And Nvl(n_已约数, 0) >= Nvl(n_限约数, 0)) Or
             (Nvl(n_已用数量, 0) >= Nvl(n_限号数, 0) And Nvl(n_限号数, 0) > 0) Then
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！';
            Raise Err_Item;
          End If;
        End If;
      End If;
      ---<--普通号  -->
    End If;
  End If;

  --更新挂号序号状态
  If 序号_In = 1 And Not n_序号 Is Null Then
    If n_分时段 = 1 Then
      d_序号时间 := 发生时间_In;
    Else
      d_序号时间 := Trunc(发生时间_In);
    End If;
    --锁定序号的处理
    Begin
      Select 操作员姓名, 机器名
      Into v_序号操作员, v_序号机器名
      From 挂号序号状态
      Where 状态 = 5 And 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号;
      n_锁定 := 1;
    Exception
      When Others Then
        v_序号操作员 := Null;
        v_序号机器名 := Null;
        n_锁定       := 0;
    End;
    If n_锁定 = 0 Then
      Update 挂号序号状态
      Set 状态 = Decode(预约挂号_In, 1, 2, 1), 预约 = Decode(预约接收_In, 1, 1, 0), 登记时间 = Sysdate
      Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号 And 状态 = 3 And 操作员姓名 = 操作员姓名_In;
      If Sql%RowCount = 0 Then
        Begin
          If Nvl(n_分时段, 0) = 0 Or Nvl(预约挂号_In, 0) = 1 Or (Nvl(n_序号控制, 0) = 0 And Nvl(号序_In, 0) = 0) Then
            Insert Into 挂号序号状态
              (号码, 日期, 序号, 状态, 操作员姓名, 预约, 登记时间)
            Values
              (号别_In, d_序号时间, n_序号, Decode(预约挂号_In, 1, 2, 1), 操作员姓名_In, Decode(预约接收_In, 1, 1, 0), Sysdate);
            If Nvl(预约挂号_In, 0) = 0 And 预约方式_In Is Not Null Then
              Update 挂号序号状态 Set 预约 = 1 Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号;
            End If;
          Elsif Nvl(n_分时段, 0) > 0 Then
            --分时段后专家号 失约的预约号允许挂号
            Update 挂号序号状态
            Set 状态 = Decode(预约挂号_In, 1, 2, 1), 操作员姓名 = 操作员姓名_In, 预约 = Decode(预约接收_In, 1, 1, 0), 登记时间 = Sysdate
            Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号 And 状态 = 2;
            If Sql%NotFound Then
              Insert Into 挂号序号状态
                (号码, 日期, 序号, 状态, 操作员姓名, 预约, 登记时间)
              Values
                (号别_In, d_序号时间, n_序号, Decode(预约挂号_In, 1, 2, 1), 操作员姓名_In, Decode(预约接收_In, 1, 1, 0), Sysdate);
            End If;
            If Nvl(预约挂号_In, 0) = 0 And 预约方式_In Is Not Null Then
              Update 挂号序号状态 Set 预约 = 1 Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号;
            End If;
          End If;
        Exception
          When Others Then
            v_Err_Msg := '序号' || n_序号 || '已被使用,请重新选择一个序号.';
            Raise Err_Item;
        End;
      End If;
    Else
      If 操作员姓名_In <> v_序号操作员 Or v_机器名 <> v_序号机器名 Then
        v_Err_Msg := '序号' || n_序号 || '已被自助机' || v_机器名 || '锁定,请重新选择一个序号.';
        Raise Err_Item;
      Else
        Update 挂号序号状态
        Set 状态 = Decode(预约挂号_In, 1, 2, 1), 预约 = Decode(预约接收_In, 1, 1, 0), 登记时间 = Sysdate
        Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号 And 状态 = 5 And 操作员姓名 = 操作员姓名_In And 机器名 = v_机器名;
        If Nvl(预约挂号_In, 0) = 0 And 预约方式_In Is Not Null Then
          Update 挂号序号状态 Set 预约 = 1 Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号;
        End If;
      End If;
    End If;
  End If;

  If n_出诊记录id Is Not Null Then
    Update 临床出诊序号控制
    Set 挂号状态 = Decode(预约挂号_In, 1, 2, 1), 操作员姓名 = 操作员姓名_In
    Where 记录id = n_出诊记录id And 序号 = n_序号;
    If 预约挂号_In = 1 Then
      Update 临床出诊记录 Set 已约数 = 已约数 + 1 Where ID = n_出诊记录id;
    Else
      If 预约接收_In = 1 Then
        Update 临床出诊记录
        Set 已约数 = 已约数 + 1, 已挂数 = 已挂数 + 1, 其中已接收 = 其中已接收 + 1
        Where ID = n_出诊记录id;
      Else
        Update 临床出诊记录 Set 已挂数 = 已挂数 + 1 Where ID = n_出诊记录id;
      End If;
    End If;
  End If;

  --产生病人挂号费用(可能单独是或包括病历费用)
  Select 病人费用记录_Id.Nextval Into n_费用id From Dual; --应该通过程序得到

  Insert Into 门诊费用记录
    (ID, 记录性质, 记录状态, 序号, 价格父号, 从属父号, NO, 实际票号, 门诊标志, 加班标志, 附加标志, 发药窗口, 病人id, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 病人科室id, 收费类别,
     计算单位, 收费细目id, 收入项目id, 收据费目, 付数, 数次, 标准单价, 应收金额, 实收金额, 结帐金额, 结帐id, 记帐费用, 开单部门id, 开单人, 划价人, 执行部门id, 执行人, 操作员编号, 操作员姓名,
     发生时间, 登记时间, 保险大类id, 保险项目否, 保险编码, 统筹金额, 摘要, 结论, 缴款组id)
  Values
    (n_费用id, 4, Decode(预约挂号_In, 1, 0, 1), 序号_In, Decode(价格父号_In, 0, Null, 价格父号_In), 从属父号_In, 单据号_In, 票据号_In, 1, 急诊_In,
     病历费_In, Decode(预约挂号_In, 1, To_Char(n_序号), 诊室_In), Decode(病人id_In, 0, Null, 病人id_In),
     Decode(门诊号_In, 0, Null, 门诊号_In), 付款方式_In, 姓名_In, Decode(姓名_In, Null, Null, 性别_In), Decode(姓名_In, Null, Null, 年龄_In),
     v_费别, 病人科室id_In, 收费类别_In, 号别_In, 收费细目id_In, 收入项目id_In, 收据费目_In, 1, 数次_In, 标准单价_In, 应收金额_In, 实收金额_In,
     Decode(预约挂号_In, 1, Null, Decode(Nvl(记帐费用_In, 0), 1, Null, 实收金额_In)),
     Decode(预约挂号_In, 1, Null, Decode(Nvl(记帐费用_In, 0), 1, Null, 结帐id_In)), Decode(Nvl(记帐费用_In, 0), 1, 1, 0), 开单部门id_In,
     操作员姓名_In, Decode(预约挂号_In, 1, 操作员姓名_In, Null), 执行部门id_In, 医生姓名_In, 操作员编号_In, 操作员姓名_In, 发生时间_In, 登记时间_In, 保险大类id_In,
     保险项目否_In, 保险编码_In, 统筹金额_In, 摘要_In, 预约方式_In, Decode(预约挂号_In, 1, Null, n_组id));

  --汇总结算到病人预交记录
  If Nvl(预约挂号_In, 0) = 0 And Nvl(记帐费用_In, 0) = 0 Then

    If (Nvl(现金支付_In, 0) <> 0 Or (Nvl(现金支付_In, 0) = 0 And Nvl(个帐支付_In, 0) = 0 And Nvl(预交支付_In, 0) = 0)) And 序号_In = 1 Then
      Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
      Insert Into 病人预交记录
        (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
         结算性质)
      Values
        (n_预交id, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), Nvl(结算方式_In, v_现金), Nvl(现金支付_In, 0), 登记时间_In,
         操作员编号_In, 操作员姓名_In, 结帐id_In, '挂号收费', n_组id, 卡类别id_In, 结算卡序号_In, 卡号_In, 交易流水号_In, 交易说明_In, 合作单位_In, 4);

      If Nvl(结算卡序号_In, 0) <> 0 And Nvl(现金支付_In, 0) <> 0 Then

        n_消费卡id := Null;
        Begin
          Select Nvl(自制卡, 0), 1 Into n_自制卡, n_Count From 卡消费接口目录 Where 编号 = 结算卡序号_In;
        Exception
          When Others Then
            n_Count := 0;
        End;
        If n_Count = 0 Then
          v_Err_Msg := '没有发现原结算卡的相应类别,不能继续操作！';
          Raise Err_Item;
        End If;
        If n_自制卡 = 1 Then
          Select ID
          Into n_消费卡id
          From 消费卡目录
          Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In And
                序号 = (Select Max(序号) From 消费卡目录 Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In);
        End If;
        Zl_病人卡结算记录_Insert(结算卡序号_In, n_消费卡id, 结算方式_In, 现金支付_In, 卡号_In, Null, 登记时间_In, Null, 结帐id_In, n_预交id);
      End If;

    End If;

    --对于医保挂号
    If Nvl(个帐支付_In, 0) <> 0 And 序号_In = 1 Then
      Insert Into 病人预交记录
        (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 结算性质)
      Values
        (病人预交记录_Id.Nextval, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), v_个人帐户, 个帐支付_In, 登记时间_In, 操作员编号_In,
         操作员姓名_In, 结帐id_In, '医保挂号', n_组id, 4);
    End If;

    --对于就诊卡通过预交金挂号
    If Nvl(预交支付_In, 0) <> 0 And 序号_In = 1 Then
      n_预交金额 := 预交支付_In;
      For r_Deposit In c_Deposit(病人id_In, v_冲预交病人ids) Loop
        n_当前金额 := Case
                    When r_Deposit.金额 - n_预交金额 < 0 Then
                     r_Deposit.金额
                    Else
                     n_预交金额
                  End;

        If r_Deposit.结帐id = 0 Then
          --第一次冲预交(填上结帐ID,金额为0)
          Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 4 Where ID = r_Deposit.原预交id;

        End If;
        --冲上次剩余额
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 预交类别, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号,
           冲预交, 结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 预交类别, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
                 登记时间_In, 操作员姓名_In, 操作员编号_In, n_当前金额, 结帐id_In, n_组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
          From 病人预交记录
          Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;

        --更新病人预交余额
        Update 病人余额
        Set 预交余额 = Nvl(预交余额, 0) - n_当前金额
        Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = Nvl(1, 2);
        --检查是否已经处理完
        If r_Deposit.金额 < n_预交金额 Then
          n_预交金额 := n_预交金额 - r_Deposit.金额;
        Else
          n_预交金额 := 0;
        End If;

        If n_预交金额 = 0 Then
          Exit;
        End If;
      End Loop;
      If n_预交金额 > 0 Then
        v_Err_Msg := '预交余不够支付本次支付金额,不能继续操作！';
        Raise Err_Item;

      End If;
      Delete From 病人余额 Where 病人id = 病人id_In And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
    End If;

    --相关汇总表的处理
    --人员缴款余额
    If 序号_In = 1 Then
      If Nvl(现金支付_In, 0) <> 0 Then
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + 现金支付_In
        Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = Nvl(结算方式_In, v_现金)
        Returning 余额 Into n_返回值;

        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额
            (收款员, 结算方式, 性质, 余额)
          Values
            (操作员姓名_In, Nvl(结算方式_In, v_现金), 1, 现金支付_In);
          n_返回值 := 现金支付_In;
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 人员缴款余额
          Where 收款员 = 操作员姓名_In And 结算方式 = Nvl(结算方式_In, v_现金) And 性质 = 1 And Nvl(余额, 0) = 0;
        End If;
      End If;

      If Nvl(个帐支付_In, 0) <> 0 Then
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + 个帐支付_In
        Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = v_个人帐户
        Returning 余额 Into n_返回值;

        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额 (收款员, 结算方式, 性质, 余额) Values (操作员姓名_In, v_个人帐户, 1, 个帐支付_In);
          n_返回值 := 个帐支付_In;
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 人员缴款余额
          Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_个人帐户 And Nvl(余额, 0) = 0;
        End If;
      End If;
    End If;
  End If;

  --病人挂号汇总(只处理一次,且单独收取病历费不处理)
  If Nvl(预约挂号_In, 0) = 0 Then
    If Nvl(记帐费用_In, 0) = 0 Then
      --处理票据使用情况
      If 序号_In = 1 And 票据号_In Is Not Null Then
        Select 票据打印内容_Id.Nextval Into n_打印id From Dual;

        --发出票据
        Insert Into 票据打印内容 (ID, 数据性质, NO) Values (n_打印id, 4, 单据号_In);

        Insert Into 票据使用明细
          (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
        Values
          (票据使用明细_Id.Nextval, Decode(收费票据_In, 1, 1, 4), 票据号_In, 1, 1, 领用id_In, n_打印id, 登记时间_In, 操作员姓名_In);

        --状态改动
        Update 票据领用记录
        Set 当前号码 = 票据号_In, 剩余数量 = Decode(Sign(剩余数量 - 1), -1, 0, 剩余数量 - 1), 使用时间 = Sysdate
        Where ID = Nvl(领用id_In, 0);
      End If;
    End If;
    --病人本次就诊(以发生时间为准)
    If Nvl(病人id_In, 0) <> 0 And 序号_In = 1 Then
      Update 病人信息 Set 就诊时间 = 发生时间_In, 就诊状态 = 1, 就诊诊室 = 诊室_In Where 病人id = 病人id_In;
    End If;
  End If;

  If Nvl(预约挂号_In, 0) = 0 And Nvl(记帐费用_In, 0) = 1 Then
    --记帐
    If Nvl(病人id_In, 0) = 0 Then
      v_Err_Msg := '要针对病人的挂号费进行记帐，必须是建档病人才能记帐挂号。';
      Raise Err_Item;
    End If;

    --病人余额
    Update 病人余额
    Set 费用余额 = Nvl(费用余额, 0) + Nvl(实收金额_In, 0)
    Where 病人id = Nvl(病人id_In, 0) And 性质 = 1 And 类型 = 1;

    If Sql%RowCount = 0 Then
      Insert Into 病人余额 (病人id, 性质, 类型, 费用余额, 预交余额) Values (病人id_In, 1, 1, Nvl(实收金额_In, 0), 0);
    End If;

    --病人未结费用
    Update 病人未结费用
    Set 金额 = Nvl(金额, 0) + Nvl(实收金额_In, 0)
    Where 病人id = 病人id_In And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And Nvl(病人科室id, 0) = Nvl(病人科室id_In, 0) And
          Nvl(开单部门id, 0) = Nvl(开单部门id_In, 0) And Nvl(执行部门id, 0) = Nvl(执行部门id_In, 0) And 收入项目id + 0 = 收入项目id_In And
          来源途径 + 0 = 1;

    If Sql%RowCount = 0 Then
      Insert Into 病人未结费用
        (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
      Values
        (病人id_In, Null, Null, 病人科室id_In, 开单部门id_In, 执行部门id_In, 收入项目id_In, 1, Nvl(实收金额_In, 0));
    End If;
  End If;

  --病人挂号记录
  If 号别_In Is Not Null And 序号_In = 1 Then
    --And Nvl(预约挂号_In, 0) = 0
    Select 病人挂号记录_Id.Nextval Into n_挂号id From Dual;
    Begin
      Select 名称 Into v_付款方式 From 医疗付款方式 Where 编码 = 付款方式_In And Rownum < 2;
    Exception
      When Others Then
        v_付款方式 := Null;
    End;
    Insert Into 病人挂号记录
      (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 预约时间, 操作员编号,
       操作员姓名, 复诊, 号序, 社区, 预约, 预约方式, 摘要, 交易流水号, 交易说明, 合作单位, 接收时间, 接收人, 预约操作员, 预约操作员编号, 险类, 医疗付款方式, 收费单)
    Values
      (n_挂号id, 单据号_In, Decode(Nvl(预约挂号_In, 0), 1, 2, 1), 1, 病人id_In, 门诊号_In, 姓名_In, 性别_In, 年龄_In, 号别_In, 急诊_In, 诊室_In,
       Null, 执行部门id_In, 医生姓名_In, 0, Null, 登记时间_In, 发生时间_In, Decode(Nvl(预约挂号_In, 0), 1, 发生时间_In, Null), 操作员编号_In,
       操作员姓名_In, 复诊_In, n_序号, 社区_In, Decode(预约接收_In, 1, 1, 0), 预约方式_In, 摘要_In, 交易流水号_In, 交易说明_In, 合作单位_In,
       Decode(Nvl(预约挂号_In, 0), 0, 登记时间_In, Null), Decode(Nvl(预约挂号_In, 0), 0, 操作员姓名_In, Null),
       Decode(Nvl(预约挂号_In, 0), 1, 操作员姓名_In, Null), Decode(Nvl(预约挂号_In, 0), 1, 操作员编号_In, Null),
       Decode(Nvl(险类_In, 0), 0, Null, 险类_In), v_付款方式, 收费单_In);
    If Nvl(预约挂号_In, 0) = 0 And 预约方式_In Is Not Null Then
      Update 病人挂号记录
      Set 预约 = 1, 预约时间 = 发生时间_In, 预约操作员 = 操作员姓名_In, 预约操作员编号 = 操作员编号_In
      Where ID = n_挂号id;
    End If;
    n_预约生成队列 := 0;
    If Nvl(预约挂号_In, 0) = 1 Then
      n_预约生成队列 := Zl_To_Number(zl_GetSysParameter('预约生成队列', 1113));
    End If;

    --0-不产生队列;1-按医生或分诊台排队;2-先分诊,后医生站
    If Nvl(生成队列_In, 0) <> 0 And Nvl(预约挂号_In, 0) = 0 Or n_预约生成队列 = 1 Then
      n_分诊台签到排队 := Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113));
      If Nvl(n_分诊台签到排队, 0) = 0 Or n_预约生成队列 = 1 Then
      n_分时点显示 := Nvl(Zl_To_Number(zl_GetSysParameter(270)), 0);
      If Nvl(预约挂号_In, 0) = 1 And n_分时点显示 = 1 And n_分时段 = 1 Then
        n_分时点显示 := 1;
      Else
        n_分时点显示 := Null;
      End If;

        --产生队列
        --.按”执行部门” 的方式生成队列
        v_队列名称 := 执行部门id_In;
        v_排队号码 := Zlgetnextqueue(执行部门id_In, n_挂号id, 号别_In || '|' || n_序号);
        v_排队序号 := Zlgetsequencenum(0, n_挂号id, 0);
        d_排队时间 := Zl_Get_Queuedate(n_挂号id, 号别_In, n_序号, 发生时间_In);
        --  队列名称_In , 业务类型_In, 业务id_In,科室id_In,排队号码_In,排队标记_In,患者姓名_In,病人ID_IN, 诊室_In, 医生姓名_In, 排队时间_In
        Zl_排队叫号队列_Insert(v_队列名称, 0, n_挂号id, 执行部门id_In, v_排队号码, Null, 姓名_In, 病人id_In, 诊室_In, 医生姓名_In, d_排队时间, 预约方式_In,
                         n_分时点显示, v_排队序号);

        --挂号立即排队
        If Nvl(n_分诊台签到排队, 0) = 0 Then
          Update 病人挂号记录 Set 记录标志 = 1 Where ID = n_挂号id;
        End If;
      End If;
    End If;
  End If;
  --病人担保信息
  If 病人id_In Is Not Null And 序号_In = 1 Then
    --取参数:
    If Nvl(n_结算模式, 0) <> Nvl(结算模式_In, 0) Then
      --结算模式的确定

      v_Err_Msg := Null;
      Begin
        Select Nvl(结算模式, 0) Into n_结算模式 From 病人信息 Where 病人id = 病人id_In;
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的病人信息,不允许挂号';
      End;

      If v_Err_Msg Is Not Null Then
        Raise Err_Item;
      End If;
      If n_结算模式 = 1 And Nvl(结算模式_In, 0) = 0 Then
        --病人已经是"先诊疗后结算的",本次是"先结算后诊疗的",则检查是否存在未结数据
        Select Count(1)
        Into n_Count
        From 病人未结费用
        Where 病人id = 病人id_In And (来源途径 In (1, 4) Or 来源途径 = 3 And Nvl(主页id, 0) = 0) And Nvl(金额, 0) <> 0 And Rownum < 2;
        If Nvl(n_Count, 0) <> 0 Then
          --存在未结算数据，必须先结算后才允许执行
          v_Err_Msg := '当前病人的就诊模式为先诊疗后结算且存在未结费用，不允许调整该病人的就诊模式,你可以先对未结费用结帐后再挂号或不调整病人的就诊模式!';
          Raise Err_Item;
        End If;
        --检查
        --未发生医嘱业务的（即当时就挂号的,需要保证同一次的就诊模式是一至的(程序已经检查，不用再处理)
      End If;
      Update 病人信息 Set 结算模式 = 结算模式_In Where 病人id = 病人id_In;
    End If;

    Update 病人信息
    Set 担保人 = Null, 担保额 = Null, 担保性质 = Null
    Where 病人id = 病人id_In And Nvl(在院, 0) = 0 And Exists
     (Select 1
           From 病人担保记录
           Where 病人id = 病人id_In And 主页id Is Not Null And
                 登记时间 = (Select Max(登记时间) From 病人担保记录 Where 病人id = 病人id_In));

    If Sql%RowCount > 0 Then
      Update 病人担保记录
      Set 到期时间 = Sysdate
      Where 病人id = 病人id_In And 主页id Is Not Null And Nvl(到期时间, Sysdate) >= Sysdate;
    End If;
  End If;
  If 序号_In = 1 Then
    --消息推送
    Begin
      Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
        Using 1, n_挂号id;
    Exception
      When Others Then
        Null;
    End;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人挂号记录_Insert;
/

--107651:梁唐彬,2017-04-11,病人自动计算
Create Or Replace Procedure Zl_病人变动记录_Bedlevel
(
  病人id_In     病案主页.病人id%Type,
  主页id_In     病案主页.主页id%Type,
  床号_In       病人变动记录.床号%Type,
  等级id_In     病人变动记录.床位等级id%Type,
  生效时间_In   病人变动记录.开始时间%Type,
  操作员编号_In 病人变动记录.操作员编号%Type,
  操作员姓名_In 病人变动记录.操作员姓名%Type
) As
  -----------------------------------------------------------
  --说明：更改床位等级
  -----------------------------------------------------------
  Cursor c_Oldinfo Is
    Select b.*
    From (Select c.*
           From 病人变动记录 c
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人变动记录
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 生效时间_In)) a, 病人变动记录 b
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位
    Union
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 生效时间_In;
  
  Cursor c_OldAutoinfo Is
    Select b.*
    From (Select c.*
           From 病人自动计算 c
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And C.性质 = 2 And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人自动计算
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 生效时间_In And 性质 = 2)) a, 病人自动计算 b
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And b.性质 = 2 And a.附加床位 = b.附加床位
    Union
    Select *
    From 病人自动计算
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 生效时间_In And 性质 = 2;

  Cursor c_Endinfo Is
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(附加床位, 0) = 0 And 终止时间 Is Null;
  r_Oldinfo  c_Oldinfo%Rowtype;
  r_OldAutoinfo  c_OldAutoinfo%Rowtype;
  r_Endinfo  c_Endinfo%Rowtype;
  v_终止原因 病人变动记录.终止原因%Type;
  v_终止时间 病人变动记录.终止时间%Type;
  v_终止人员 病人变动记录.终止人员%Type;

  v_Count Number;
  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  Open c_Oldinfo; --必须先打开
  Fetch c_Oldinfo
    Into r_Oldinfo;
  Open c_OldAutoinfo; 
  Fetch c_OldAutoinfo
    Into r_OldAutoinfo;
  Open c_Endinfo;
  Fetch c_Endinfo
    Into r_Endinfo;
  If c_Endinfo%Rowcount = 0 Then
    Close c_Endinfo;
    v_Error := '未发现该病人当前有效的变动记录！';
    Raise Err_Custom;
  End If;
  Select Count(*)
  Into v_Count
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Null And 终止时间 Is Null;
  If v_Count > 0 Then
    v_Error := '该病人正在转科或转病区，不能进行其他变动！';
    Raise Err_Custom;
  End If;

  If Nvl(r_Endinfo.床号, '') <> 床号_In Then
    v_Error := '发现病人的床号已经发生变化,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;
  If r_Endinfo.床位等级id = 等级id_In Then
    v_Error := '操作失败,当前该病人的床位等级和即将调整的床位等级相同,不能进行当前操作.' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态！';
    Raise Err_Custom;
  End If;

  --取消上次变动
  If r_Oldinfo.终止时间 Is Not Null Then
    v_终止时间 := r_Oldinfo.终止时间;
    v_终止原因 := r_Oldinfo.终止原因;
    v_终止人员 := r_Oldinfo.终止人员;
    --取消上次变动
    Update 病人变动记录
    Set 终止时间 = 生效时间_In, 终止原因 = 5, 终止人员 = 操作员姓名_In, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因 = v_终止原因;
    --更新将来的记录如果有停止到将来的则删除上次计算时间
    Update 病人变动记录
    Set 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 生效时间_In;
  Else
    Update 病人变动记录
    Set 终止时间 = 生效时间_In, 终止原因 = 5, 终止人员 = 操作员姓名_In,
        上次计算时间 = Decode(Sign(Nvl(上次计算时间, 生效时间_In) - 生效时间_In), 1, Null, 上次计算时间) 
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
  End If;

  --产生新变动
  While c_Oldinfo%Found Loop
    If r_Oldinfo.床号 = 床号_In Then
      Update 床位状况记录 Set 等级id = 等级id_In Where 病区id = r_Oldinfo.病区id And 床号 = 床号_In;
    
      Insert Into 病人变动记录
        (Id, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 生效时间_In, 5, r_Oldinfo.附加床位, r_Oldinfo.病区id, r_Oldinfo.科室id,
         r_Oldinfo.医疗小组id, r_Oldinfo.护理等级id, 等级id_In, 床号_In, r_Oldinfo.责任护士, r_Oldinfo.经治医师, r_Oldinfo.主治医师,
         r_Oldinfo.主任医师, r_Oldinfo.病情, 操作员编号_In, 操作员姓名_In, v_终止时间, v_终止原因, v_终止人员);
      --更新将来的记录
      Update 病人变动记录
      Set 床位等级id = 等级id_In
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 生效时间_In;
    Else
      Insert Into 病人变动记录
        (Id, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 生效时间_In, 5, r_Oldinfo.附加床位, r_Oldinfo.病区id, r_Oldinfo.科室id,
         r_Oldinfo.医疗小组id, r_Oldinfo.护理等级id, r_Oldinfo.床位等级id, r_Oldinfo.床号, r_Oldinfo.责任护士, r_Oldinfo.经治医师,
         r_Oldinfo.主治医师, r_Oldinfo.主任医师, r_Oldinfo.病情, 操作员编号_In, 操作员姓名_In, v_终止时间, v_终止原因, v_终止人员);
    End If;
  
    Fetch c_Oldinfo
      Into r_Oldinfo;
  End Loop;
  
  v_终止时间 := NULL;
  v_终止人员 := NULL;
  v_终止原因 := NULL;
  --病人自动计算费用所需数据
  If r_OldAutoinfo.终止时间 Is Not Null Then
    v_终止时间 := r_OldAutoinfo.终止时间;
    v_终止人员 := r_OldAutoinfo.终止人员;
    v_终止原因 := r_OldAutoinfo.终止原因;
    --取消上次变动
    Update 病人自动计算
    Set 终止时间 = 生效时间_In, 终止原因 = 5, 终止人员 = 操作员姓名_In, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因 = v_终止原因 And 性质 In (2,3);
    --更新将来的记录如果有停止到将来的则删除上次计算时间
    Update 病人自动计算
    Set 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 生效时间_In And 性质 In (2,3);
  Else
    Update 病人自动计算
    Set 终止时间 = 生效时间_In, 终止原因 = 5, 终止人员 = 操作员姓名_In,
        上次计算时间 = Decode(Sign(Nvl(上次计算时间, 生效时间_In) - 生效时间_In), 1, Null, 上次计算时间) 
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 性质 In (2,3);
  End If;

  --产生新变动
  While c_OldAutoinfo%Found Loop
    If r_OldAutoinfo.床号 = 床号_In Then

      Insert Into 病人自动计算
        (Id, 病人id, 主页id, 开始时间, 开始原因, 性质,  附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 生效时间_In, 5, 2, r_OldAutoinfo.附加床位, r_OldAutoinfo.病区id, r_OldAutoinfo.科室id,
         等级id_In, 床号_In, 操作员编号_In, 操作员姓名_In, v_终止时间, v_终止原因, v_终止人员);
         
      Insert Into 病人自动计算
        (Id, 病人id, 主页id, 开始时间, 开始原因, 性质,  附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 生效时间_In, 5, 3, r_OldAutoinfo.附加床位, r_OldAutoinfo.病区id, r_OldAutoinfo.科室id,
         等级id_In, 床号_In, 操作员编号_In, 操作员姓名_In, v_终止时间, v_终止原因, v_终止人员);   
      --更新将来的记录
      Update 病人自动计算
      Set 床位等级id = 等级id_In
      Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 生效时间_In And 性质 In (2,3);
    Else
      Insert Into 病人自动计算
        (Id, 病人id, 主页id, 开始时间, 开始原因, 性质,  附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 生效时间_In, 5, 2, r_OldAutoinfo.附加床位, r_OldAutoinfo.病区id, r_OldAutoinfo.科室id,
         r_OldAutoinfo.床位等级id, r_OldAutoinfo.床号, 操作员编号_In, 操作员姓名_In, v_终止时间, v_终止原因, v_终止人员);
      
      Insert Into 病人自动计算
        (Id, 病人id, 主页id, 开始时间, 开始原因, 性质,  附加床位, 病区id, 科室id, 床位等级id, 床号, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 生效时间_In, 5, 3, r_OldAutoinfo.附加床位, r_OldAutoinfo.病区id, r_OldAutoinfo.科室id,
         r_OldAutoinfo.床位等级id, r_OldAutoinfo.床号, 操作员编号_In, 操作员姓名_In, v_终止时间, v_终止原因, v_终止人员);
    End If;
  
    Fetch c_OldAutoinfo
      Into r_OldAutoinfo;
  End Loop;

  Close c_Oldinfo;
  Close c_Endinfo;
  Close c_OldAutoinfo;
  --并发操作检查
  Select Count(*)
  Into v_Count
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(附加床位, 0) = 0 And 开始时间 Is Not Null And 终止时间 Is Null;
  If v_Count > 1 Then
    v_Error := '发现病人存在非法的变动记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 出院日期 Is Null;
  If v_Count = 0 Then
    v_Error := '操作失败,该病人已出院,不能进行当前操作.' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态！';
    Raise Err_Custom;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病人变动记录_Bedlevel;
/

--107651:梁唐彬,2017-04-11,病人自动计算
CREATE OR REPLACE Procedure Zl_病人变动记录_Nurse
( 
  病人id_In     病案主页.病人id%Type, 
  主页id_In     病案主页.主页id%Type, 
  护理id_In     病人变动记录.护理等级id%Type, 
  生效时间_In   病人变动记录.开始时间%Type, 
  操作员编号_In 病人变动记录.操作员编号%Type, 
  操作员姓名_In 病人变动记录.操作员姓名%Type 
) As 
  ----------------------------------------------------------- 
  --说明：更改病人护理等级 
  ----------------------------------------------------------- 
  Cursor c_Oldinfo Is 
        Select b.* 
    From (Select c.* 
           From 病人变动记录 C 
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And
                 c.开始时间 = (Select Min(开始时间) From 病人变动记录
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 生效时间_In) And
                 NVL(c.终止时间|| '','空') = (Select  NVL(Min(终止时间)|| '','空')
                           From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 生效时间_In)) A, 病人变动记录 B 
 
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位 
    Union 
    Select * From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 生效时间_In; 
  
  Cursor c_OldAutoinfo Is 
        Select b.* 
    From (Select c.* 
           From 病人自动计算 C 
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And C.性质 = 1 And 
                 c.开始时间 = (Select Min(开始时间) From 病人自动计算
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 生效时间_In  And 性质 = 1) And
                 NVL(c.终止时间|| '','空') = (Select  NVL(Min(终止时间)|| '','空')
                           From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In And 性质 = 1 And 开始时间 > 生效时间_In)) A, 病人自动计算 B 
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And B.性质 = 1 
    Union 
    Select * From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 生效时间_In And 性质 = 1; 
 
  Cursor c_Endinfo Is 
    Select * From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null; 
  r_Oldinfo c_Oldinfo%RowType; 
  r_Endinfo c_Endinfo%RowType; 
  r_OldAutoinfo c_OldAutoinfo%RowType;
 
  v_终止原因 病人变动记录.终止原因%Type; 
  v_终止时间 病人变动记录.终止时间%Type; 
  v_终止人员 病人变动记录.终止人员%Type; 
  
  v_Count   Number; 
  v_Date Date; 
  v_Error   Varchar2(255); 
  Err_Custom Exception; 
Begin 
  Open c_Oldinfo; --必须先打开 
  Fetch c_Oldinfo 
    Into r_Oldinfo; 
  Open c_OldAutoinfo; 
  Fetch c_OldAutoinfo 
    Into r_OldAutoinfo; 
  Open c_Endinfo; 
  Fetch c_Endinfo 
    Into r_Endinfo; 
  
  If c_Endinfo%RowCount = 0 Then 
    Close c_Endinfo; 
    v_Error := '未发现该病人当前有效的变动记录！'; 
    Raise Err_Custom; 
  End If; 
  Select Count(*) Into v_count From 病人变动记录 Where 病人ID=病人ID_in And 主页ID=主页id_In And 开始时间 Is null And 终止时间 Is Null; 
  If v_count > 0 Then 
    v_Error := '该病人正在转科或转病区，不能进行其他变动！'; 
    Raise Err_Custom; 
  End If; 
  
  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 护理等级id = 护理id_In;
  If v_Count > 0 Then
    v_Error := '操作失败,当前该病人的护理等级和即将调整的护理等级相同,不能进行当前操作.' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态！';
    Raise Err_Custom;
  End If;
 
  For r_Fee In (Select No 
                From 住院费用记录 
                Where 病人id = 病人id_In And 主页id = 主页id_In And Mod(记录性质, 10) = 3 And 登记时间 >= 生效时间_In And 收费类别 = 'H' 
                Group By NO, 序号, Mod(记录性质, 10) 
                Having Sum(结帐金额) <> 0) Loop 
    v_Error := '变动时间之后已有已结帐的自动记帐费用,不能更改护理等级！'; 
    Raise Err_Custom; 
  End Loop; 
 
  --取消上次变动 
  If r_Oldinfo.终止时间 Is not NULL then 
    --如果将来已经有了护理记录变动，则不允许再产生护理变动。需要回退将来的变动的解决。 
    Select Max(开始时间) Into v_Date From 病人变动记录 Where 病人ID=病人ID_in And 主页ID=主页id_In And 开始时间>生效时间_In And 开始原因=6; 
    If v_Date Is Not Null Then 
      v_Error := '本次护理等级变动时间必须大于最后一次护理等级变动的生效时间:' || To_char(v_Date,'yyyy-mm-dd hh24:mi:ss') || '。'; 
      Raise Err_Custom; 
    End If; 
    v_终止时间:=r_Oldinfo.终止时间; 
    v_终止原因:=r_Oldinfo.终止原因; 
    v_终止人员:=r_Oldinfo.终止人员; 
    --取消上次变动 
    Update 病人变动记录 
    Set 终止时间 = 生效时间_In, 终止原因 = 6, 终止人员 = 操作员姓名_In ,上次计算时间 = Null 
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因=v_终止原因; 
    --更新将来的记录如果有停止到将来的则删除上次计算时间 
    Update 病人变动记录 Set 护理等级id=护理id_In,上次计算时间 = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间>生效时间_In; 
  Else 
    Update 病人变动记录 
    Set 终止时间 = 生效时间_In, 终止原因 = 6, 终止人员 = 操作员姓名_In,
        上次计算时间 = Decode(Sign(Nvl(上次计算时间, 生效时间_In) - 生效时间_In), 1, Null, 上次计算时间) 
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null; 
  End If; 
  --产生新变动 
  While c_Oldinfo%Found Loop 
    Insert Into 病人变动记录 
      (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号, 操作员姓名,终止时间,终止原因,终止人员) 
    Values 
      (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 生效时间_In, 6, r_Oldinfo.附加床位, r_Oldinfo.病区id, r_Oldinfo.科室id, r_Oldinfo.医疗小组id, 护理id_In, 
       r_Oldinfo.床位等级id, r_Oldinfo.床号, r_Oldinfo.责任护士, r_Oldinfo.经治医师, r_Oldinfo.主治医师, r_Oldinfo.主任医师, r_Oldinfo.病情, 
       操作员编号_In, 操作员姓名_In,v_终止时间,v_终止原因,v_终止人员); 
    Fetch c_Oldinfo 
      Into r_Oldinfo; 
  End Loop; 
  
  --病人自动计算费用所需数据
  v_终止时间 := NULL;
  v_终止人员 := NULL;
  v_终止原因 := NULL; 
  If r_OldAutoinfo.终止时间 Is not NULL then  
    v_终止时间:=r_OldAutoinfo.终止时间; 
    v_终止人员:=r_OldAutoinfo.终止人员; 
    v_终止原因:=r_OldAutoinfo.终止原因; 
    --取消上次变动 
    Update 病人自动计算 
    Set 终止时间 = 生效时间_In, 终止原因 = 6, 终止人员 = 操作员姓名_In ,上次计算时间 = Null 
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因 = v_终止原因 And 性质 = 1; 
    --更新将来的记录如果有停止到将来的则删除上次计算时间 
    Update 病人自动计算 Set 护理等级id=护理id_In,上次计算时间 = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间>生效时间_In And 性质 = 1; 
  Else 
    Update 病人自动计算 
    Set 终止时间 = 生效时间_In, 终止原因 = 6, 终止人员 = 操作员姓名_In,
        上次计算时间 = Decode(Sign(Nvl(上次计算时间, 生效时间_In) - 生效时间_In), 1, Null, 上次计算时间) 
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 性质 = 1; 
  End If; 
  --产生新变动 
  While c_OldAutoinfo%Found Loop 
    Insert Into 病人自动计算 
      (ID, 病人id, 主页id, 开始时间, 开始原因, 性质, 病区id, 科室id, 护理等级id, 操作员编号, 操作员姓名,终止时间,终止原因,终止人员) 
    Values 
      (病人自动计算_Id.Nextval, 病人id_In, 主页id_In, 生效时间_In, 6, 1,  r_OldAutoinfo.病区id, r_OldAutoinfo.科室id, 护理id_In, 
       操作员编号_In, 操作员姓名_In,v_终止时间, v_终止原因,v_终止人员); 
    Fetch c_OldAutoinfo 
      Into r_OldAutoinfo; 
  End Loop; 
 
  Close c_Oldinfo; 
  Close c_Endinfo; 
  Close c_OldAutoinfo;
 
  Update 病案主页 Set 护理等级id = 护理id_In Where 病人id = 病人id_In And 主页id = 主页id_In And 出院日期 Is Null; 
 
  --并发操作检查 
  Select Count(*) 
  Into v_Count 
  From 病人变动记录 
  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(附加床位, 0) = 0 And 开始时间 Is Not Null And 终止时间 Is Null; 
  If v_Count > 1 Then 
    v_Error := '发现病人存在非法的变动记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！'; 
    Raise Err_Custom; 
  End If; 
 
  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 出院日期 Is Null; 
  If v_Count = 0 Then 
    v_Error := '操作失败,该病人已出院,不能进行当前操作.' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态！'; 
    Raise Err_Custom; 
  End If; 
 
Exception 
  When Err_Custom Then 
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]'); 
  When Others Then 
    zl_ErrorCenter(SQLCode, SQLErrM); 
End Zl_病人变动记录_Nurse;
/

--106261:李南春,2017-04-10,删除不再使用的过程
Drop Procedure Zl_病人挂号记录_删除病历费;

--107651:梁唐彬,2017-04-10,病人自动计算
Create Or Replace Procedure Zl_病人信息_Merge
(
  A病人id_In    病人信息.病人id%Type, --要合并的病人信息
  B病人id_In    病人信息.病人id%Type, --要保留的病人信息
  合并原因_In   病人合并记录.合并原因%Type,
  操作员姓名_In 人员表.姓名%Type,
  强制保留_In   Number := 0
  --标准版
  ----------------------------------------------------------------------------
  --病人信息,病案主页,病案主页从表,病人变动记录,特殊病人
  --门诊病案记录,住院病案记录,床位状况记录
  --医保病人档案,保险模拟结算,保险结算记录,帐户年度信息
  --病人余额,病人未结费用,住院费用记录,门诊费用记录,病人预交记录,病人结帐记录,未发药品记录
  --病人挂号记录,病人过敏药物,病人过敏记录,病人诊断记录,诊断情况
  --病人医嘱记录,病人手麻记录
  --病人社区信息
  
  --后备表：
  --H病人结帐记录,H病人预交记录,H住院费用记录,H门诊费用记录
  --H病人医嘱记录,H病人诊断记录,H病人过敏记录
  --H病人病历记录,H病人手麻记录
  
  --病案系统
  ----------------------------------------------------------------------------
  --病人费用,随诊记录,借阅记录
  --新生儿诊断记录,病人分娩信息
  --诊断符合情况,病案评分结果
  
) As
  --病人相关表
  Cursor c_Patitable Is
    Select a.Table_Name, Max(Decode(b.Column_Name, '病人ID', 1, 0)) As 病人id,
           Max(Decode(b.Column_Name, '主页ID', 1, 0)) As 主页id
    From User_Tables A, User_Tab_Columns B
    Where a.Table_Name = b.Table_Name And b.Column_Name In ('病人ID', '主页ID') And
          a.Table_Name Not In
          ('病人信息', '病案主页', '病案主页从表', '病人变动记录','病人自动计算', '特殊病人', '门诊病案记录', '住院病案记录', '床位状况记录', '医保病人档案', '医保病人关联表', '保险模拟结算',
           '帐户年度信息', '病人余额', '病人未结费用', '住院费用记录', '门诊费用记录', '病人预交记录', '病人结帐记录', '未发药品记录', '病人挂号记录', '病人过敏药物', '病人过敏记录',
           '病人诊断记录', '诊断情况', '病人医嘱记录', '病人手麻记录', '病人费用', '随诊记录', '借阅记录', '病人分娩信息', '诊断符合情况', '病案评分结果', '病人担保记录', '病人社区信息',
           '病人免疫记录', '病人信息从表', '病人医疗卡属性') Having Max(Decode(b.Column_Name, '病人ID', 1, 0)) <> 0
    Group By a.Table_Name;

  --数组定义
  Type Array_Patitable Is Table Of Varchar2(100) Index By Binary_Integer;
  Arronbase Array_Patitable;
  Arronpage Array_Patitable;
  v_Loop    Number;
  n_Have    Number;

  -------------------------------------------------------
  --被合并的病人(住院号可能每次新产生,多次住院取最近一次)
  Cursor c_Infoa Is
    Select a.病人id, a.门诊号, a.住院号, a.就诊卡号, a.卡验证码, a.费别, a.医疗付款方式, a.姓名, a.性别, a.年龄, a.出生日期, a.出生地点, a.身份证号, a.其他证件, a.身份,
           a.职业, a.民族, a.国籍, a.籍贯, a.区域, a.学历, a.婚姻状况, a.家庭地址, a.家庭电话, a.家庭地址邮编, a.监护人, a.联系人姓名, a.联系人关系, a.联系人地址,
           a.联系人电话, a.户口地址, a.户口地址邮编, a.Email, a.Qq, a.合同单位id, a.工作单位, a.单位电话, a.单位邮编, a.单位开户行, a.单位帐号, a.担保人, a.担保额,
           a.担保性质, a.就诊时间, a.就诊状态, a.就诊诊室, a.住院次数, a.当前科室id, a.当前病区id, a.当前床号, a.入院时间, a.出院时间, a.在院, a.Ic卡号, a.健康号,
           a.医保号, a.险类, a.查询密码, a.登记时间, a.停用时间, a.锁定, a.联系人身份证号, b.主页id, b.入院日期, b.出院日期
    From 病人信息 A, 病案主页 B
    Where a.病人id = b.病人id(+) And a.病人id = A病人id_In
    Order By 出院日期 Desc, 主页id Desc;
  r_Infoa c_Infoa%RowType;

  --要保留的病人(住院号可能每次新产生,多次住院取最近一次)
  Cursor c_Infob Is
    Select a.病人id, a.门诊号, a.住院号, a.就诊卡号, a.卡验证码, a.费别, a.医疗付款方式, a.姓名, a.性别, a.年龄, a.出生日期, a.出生地点, a.身份证号, a.其他证件, a.身份,
           a.职业, a.民族, a.国籍, a.籍贯, a.区域, a.学历, a.婚姻状况, a.家庭地址, a.家庭电话, a.家庭地址邮编, a.监护人, a.联系人姓名, a.联系人关系, a.联系人地址,
           a.联系人电话, a.户口地址, a.户口地址邮编, a.Email, a.Qq, a.合同单位id, a.工作单位, a.单位电话, a.单位邮编, a.单位开户行, a.单位帐号, a.担保人, a.担保额,
           a.担保性质, a.就诊时间, a.就诊状态, a.就诊诊室, a.住院次数, a.当前科室id, a.当前病区id, a.当前床号, a.入院时间, a.出院时间, a.在院, a.Ic卡号, a.健康号,
           a.医保号, a.险类, a.查询密码, a.登记时间, a.停用时间, a.锁定, a.联系人身份证号, b.主页id, b.入院日期, b.出院日期
    From 病人信息 A, 病案主页 B
    Where a.病人id = b.病人id(+) And a.病人id = B病人id_In
    Order By 出院日期 Desc, 主页id Desc;
  r_Infob c_Infob%RowType;

  --合并后的信息
  Cursor c_Info(v_病人id 病人信息.病人id%Type) Is
    Select 病人id, 主页id, (Select Nvl(Max(主页id), 0) From 病案主页 Where 病人id = v_病人id) 最大主页id, 住院号, 病人性质, 医疗付款方式, 费别, 再入院,
           入院病区id, 入院科室id, 医疗小组id, 入院日期, 入院病况, 入院方式, 入院属性, 二级院转入, 住院目的, 入院病床, 是否陪伴, 当前病况, 当前病区id, 护理等级id, 出院科室id, 出院病床,
           出院日期, 住院天数, 出院方式, 是否确诊, 确诊日期, 新发肿瘤, 血型, 抢救次数, 成功次数, 随诊标志, 随诊期限, 尸检标志, 门诊医师, 责任护士, 住院医师, 病案号, 编目员编号, 编目员姓名,
           编目日期, 状态, 费用和, 年龄, 身高, 体重, 婚姻状况, 职业, 国籍, 学历, 单位电话, 单位邮编, 单位地址, 区域, 家庭地址, 家庭电话, 家庭地址邮编, 联系人姓名, 联系人关系, 联系人地址,
           联系人电话, 联系人身份证号, 户口地址, 户口地址邮编, 中医治疗类别, 险类, 社区, 审核标志, 审核人, 审核日期, 是否上传, 数据转出, 登记人, 登记时间, 备注, 病案状态, 病人类型
    From 病案主页
    Where 主页id = (Select Nvl(Max(主页id), 0)
                  From 病案主页
                  Where 病人id = v_病人id And Not Exists (Select 主页id From 病案主页 Where 病人id = v_病人id And 主页id = 0)) And
          病人id = v_病人id;
  r_Info c_Info%RowType;

  --合并两个住院病人
  Cursor c_Mergepati Is
    Select a.姓名, a.门诊号, a.住院号 当前住院号, b.病人id, b.主页id, b.住院号, b.留观号, b.病人性质, b.医疗付款方式, b.费别, b.再入院, b.入院病区id, b.入院科室id,
           b.医疗小组id, b.入院日期, b.入院病况, b.入院方式, b.入院属性, b.二级院转入, b.住院目的, b.入院病床, b.是否陪伴, b.当前病况, b.当前病区id, b.护理等级id,
           b.出院科室id, b.出院病床, b.出院日期, b.住院天数, b.出院方式, b.是否确诊, b.确诊日期, b.新发肿瘤, b.血型, b.抢救次数, b.成功次数, b.随诊标志, b.随诊期限,
           b.尸检标志, b.门诊医师, b.责任护士, b.住院医师, b.病案号, b.编目员编号, b.编目员姓名, b.编目日期, b.状态, b.费用和, b.性别, b.年龄, b.身高, b.体重, b.婚姻状况,
           b.职业, b.国籍, b.学历, b.单位电话, b.单位邮编, b.单位地址, b.区域, b.家庭地址, b.家庭电话, b.家庭地址邮编, b.联系人姓名, b.联系人关系, b.联系人地址, b.联系人电话,
           b.联系人身份证号, b.户口地址, b.户口地址邮编, b.中医治疗类别, b.险类, b.社区, b.审核标志, b.审核人, b.审核日期, b.是否上传, b.数据转出, b.登记人, b.登记时间, b.备注,
           b.病案状态, b.病人类型, b.封存时间, b.路径状态, b.单病种, b.婴儿科室id, b.婴儿病区id, b.母婴转科标志, b.医嘱重整时间
    From 病人信息 A, 病案主页 B
    Where a.病人id = b.病人id And a.病人id In (A病人id_In, B病人id_In)
    Order By b.入院日期 Desc, Nvl(b.出院日期, Sysdate) Desc;

  v_保留id 病人信息.病人id%Type;
  v_合并id 病人信息.病人id%Type;
  v_门诊号 病人信息.门诊号%Type;
  v_住院号 病人信息.住院号%Type;
  --病人未结费用(门诊部份)
  Cursor c_Owe(v_病人id 病人信息.病人id%Type) Is
    Select 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, Sum(金额) As 金额
    From 病人未结费用
    Where 主页id Is Null And 病人id = v_病人id
    Group By 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径;

  --病人余额
  Cursor c_Spare(v_病人id 病人信息.病人id%Type) Is
    Select 性质, 类型, 预交余额, 费用余额 From 病人余额 Where 病人id = v_病人id;

  --医保病人档案
  Cursor c_Insure(v_病人id 病人信息.病人id%Type) Is
    Select * From 保险帐户 Where 病人id = v_病人id Order By 险类;

  --要保留的医保病人档案
  Cursor c_Keepinsure
  (
    v_病人id 病人信息.病人id%Type,
    v_险类   医保病人档案.险类%Type
  ) Is
    Select * From 保险帐户 Where 病人id = v_病人id And 险类 = v_险类;
  r_Keepinsure c_Keepinsure%RowType;

  Cursor c_Year
  (
    v_病人id 病人信息.病人id%Type,
    v_险类   医保病人档案.险类%Type
  ) Is
    Select * From 帐户年度信息 Where 病人id = v_病人id And 险类 = v_险类;

  v_原信息   病人合并记录.原信息%Type;
  v_Count    Number;
  n_Readonly Number;
  v_Sql      Varchar2(1000);

  n_主页id       病人信息.主页id%Type;
  v_Error        Varchar2(255);
  n_担保额       病人担保记录.担保额%Type;
  v_担保人       病人信息.担保人%Type;
  n_担保性质     病人担保记录.担保性质%Type;
  n_Row          Number;
  n_独立病案     Number;
  n_每次新住院号 Number;
  n_Max主页id    Number;
  n_Cnt主页id    Number;
  n_Cur主页id    Number;
  n_Cnt住院次数  Number;
  n_Cur住院次数  Number;
  n_Max住院次数  Number;
  n_Loop主页id   病人信息.主页id%Type;

  n_Lengthb Number;
  Err_Custom Exception;
Begin
  Begin
    Select 只读 Into n_Readonly From zlBakSpaces Where 当前 = 1;
  Exception
    When Others Then
      Null;
  End;
  If n_Readonly = 1 Then
    n_Readonly := 0;
    For r_Bak In (Select a.表名 Table_Name
                  From Zltools.Zlbaktables A, User_Constraints B
                  Where a.表名 = b.Table_Name And b.r_Constraint_Name = '病人信息_PK' And b.Constraint_Type = 'R') Loop
      v_Sql := 'Select Count(病人Id) From ' || r_Bak.Table_Name || ' Where 病人Id In(:1,:2)';
      Execute Immediate v_Sql
        Into n_Readonly
        Using A病人id_In, B病人id_In;
      If n_Readonly > 0 Then
        v_Error := '病人在只读的当前转储空间存在数据,不能进行合并!';
        Raise Err_Custom;
      End If;
    End Loop;
  End If;

  --程序中已检查：
  --1.选择了同一个病人
  --2.两个住院病人先入院的却在院(包括两个都在院)。
  --3.两个住院病人的住院期间存在交叉的情况
  --4.医保病人存在未结费用

  --先锁定病人不允许进行其他业务
  Zl_病人信息_锁定(A病人id_In, 1);
  Zl_病人信息_锁定(B病人id_In, 1);

  Open c_Infoa;
  Fetch c_Infoa
    Into r_Infoa;
  If c_Infoa%RowCount = 0 Then
    Close c_Infoa;
    v_Error := '没有发现被合并的病人信息！';
    Raise Err_Custom;
  End If;

  Open c_Infob;
  Fetch c_Infob
    Into r_Infob;
  If c_Infob%RowCount = 0 Then
    Close c_Infob;
    v_Error := '没有发现要保留的病人信息！';
    Raise Err_Custom;
  End If;

  --读取其它相关病人表到数组
  For r_Patitable In c_Patitable Loop
    If r_Patitable.主页id = 0 Then
      Arronbase(Arronbase.Count + 1) := r_Patitable.Table_Name;
    Else
      Arronpage(Arronpage.Count + 1) := r_Patitable.Table_Name;
    End If;
  End Loop;

  --以先住院或先登记的病人ID作为实际上要保留的病人ID
  If Nvl(强制保留_In, 0) = 1 Then
    v_保留id := B病人id_In;
  Else
    Select 病人id
    Into v_保留id
    From (Select /*+ CHOOSE */
            a.病人id
           From 病人信息 A, 病案主页 B
           Where a.病人id = b.病人id(+) And a.病人id In (A病人id_In, B病人id_In)
           Order By Nvl(b.入院日期, To_Date('3000-01-01', 'YYYY-MM-DD')), Nvl(b.出院日期, To_Date('3000-01-01', 'YYYY-MM-DD')),
                    a.登记时间, a.病人id --住院病人优先
           )
    Where Rownum = 1;
  End If;

  --先确定病案号的模式
  Select Zl_To_Number(Nvl(zl_GetSysParameter(39), '0')) Into n_独立病案 From Dual;
  --住院号模式
  Select Zl_To_Number(Nvl(zl_GetSysParameter(145), '0')) Into n_每次新住院号 From Dual;

  --另外一个就是实际最后要删除的病人ID
  If v_保留id = A病人id_In Then
    v_合并id := B病人id_In;
    --问题27445 保留指定病人的门诊号、住院号、医保号
    v_门诊号 := Nvl(r_Infob.门诊号, r_Infoa.门诊号);
    v_住院号 := Nvl(r_Infob.住院号, r_Infoa.住院号);
  Else
    v_合并id := A病人id_In;
    v_门诊号 := Nvl(r_Infob.门诊号, r_Infoa.门诊号);
    v_住院号 := Nvl(r_Infob.住院号, r_Infoa.住院号);
  End If;

  ---记录合并操作,在后面会根据r_PatiTable把合并病人的合并记录更新为保留病人的
  v_原信息 := v_合并id || ',' || r_Infoa.门诊号 || ',' || r_Infoa.住院号 || ',' || r_Infoa.就诊卡号 || ',' || r_Infoa.姓名 || ',' ||
           r_Infoa.性别 || ',' || r_Infoa.年龄 || ',' || To_Char(r_Infoa.出生日期, 'yyyy-mm-dd') || ',' || r_Infoa.身份证号 || ',' ||
           r_Infoa.婚姻状况 || ',' || r_Infoa.职业 || ',' || r_Infoa.家庭地址;
  Insert Into 病人合并记录
    (病人id, 原信息, 合并原因, 操作员姓名, 合并时间)
  Values
    (v_保留id, v_原信息, 合并原因_In, 操作员姓名_In, Sysdate);

  --开始合并
  --84398修改将住院次数计算放在外面，因需要考虑门诊和住院病人合并
  --10.34开始,住院次数不包含留关病人,合并后的住院次数=保留病人住院次数+合并病人正常入院的次数
  Select Nvl(住院次数, 0) Into n_Cur住院次数 From 病人信息 Where 病人id = v_保留id;
  Select Count(*) Into n_Cnt住院次数 From 病案主页 Where 病人id = v_合并id And 主页id <> 0 And 病人性质 = 0;
  n_Max住院次数 := n_Cur住院次数 + n_Cnt住院次数;
  --处理病案主页部份(涉及病人ID,主页ID字段的表)
  If (r_Infoa.主页id Is Not Null And r_Infob.主页id Is Not Null) Or (强制保留_In = 1 And r_Infoa.主页id Is Not Null) Then
    If r_Infoa.主页id = 0 And r_Infob.主页id = 0 Then
      Close c_Infoa;
      Close c_Infob;
      v_Error := '两个预约病人不能进行病人合并操作！';
      Raise Err_Custom;
    Elsif r_Infoa.主页id = 0 Then
      If r_Infob.入院日期 Is Not Null And r_Infob.出院日期 Is Null Then
        Close c_Infoa;
        Close c_Infob;
        v_Error := '预约病人和在院病人不能进行病人合并操作！';
        Raise Err_Custom;
      End If;
    Elsif r_Infob.主页id = 0 Then
      If r_Infoa.入院日期 Is Not Null And r_Infoa.出院日期 Is Null Then
        Close c_Infoa;
        Close c_Infob;
        v_Error := '预约病人和在院病人不能进行病人合并操作！';
        Raise Err_Custom;
      End If;
    End If;
    --求两个病人总共的住院就诊次数
    Select Count(*) Into v_Count From 病案主页 Where 病人id In (A病人id_In, B病人id_In) And 主页id <> 0;
    --因为10.19开始，入院时允许修改主页id，所以最大主页ID可能大于总的住院就诊次数
    Select Max(主页id) Into n_Max主页id From 病案主页 Where 病人id = v_保留id And 主页id <> 0;
    Select Count(*) Into n_Cnt主页id From 病案主页 Where 病人id = v_合并id And 主页id <> 0;
    If n_Max主页id + n_Cnt主页id > v_Count Then
      v_Count := n_Max主页id + n_Cnt主页id;
    End If;
    --求实际要更新的主页截至值,以前用v_Count >= n_Max主页id判断存在一个问题（对于两个病人多次交叉入院，可能导致A,B病人部分就诊次数没有更新）
    Select Nvl(Max(主页id), 0)
    Into n_Loop主页id
    From 病案主页 A, (Select Min(入院日期) 入院日期 From 病案主页 Where 病人id = v_合并id) B
    Where a.病人id = v_保留id And a.入院日期 < b.入院日期;
  
    For r_Merge In c_Mergepati Loop
      If Not (r_Merge.病人id = v_保留id And r_Merge.主页id = v_Count) And v_Count <> 0 Then
        --该病案主页要删除时,不能是已编目了的。
        If r_Merge.编目日期 Is Not Null Then
          Close c_Infoa;
          Close c_Infob;
          If r_Merge.当前住院号 Is Null Then
            v_Error := '病人' || r_Merge.姓名 || '(病人ID=' || r_Merge.病人id || ')存在已编目的病案,不允许合并该病人。';
          Else
            v_Error := '病人' || r_Merge.姓名 || '(病人ID=' || r_Merge.病人id || ',住院号=' || r_Merge.当前住院号 ||
                       ')存在已编目的病案,不允许合并该病人。';
          End If;
          Raise Err_Custom;
        End If;
        If v_Count >= Nvl(n_Loop主页id, 0) Then
          If r_Merge.主页id = 0 Then
            n_Cur主页id := 0;
            Update 病案主页
            Set 病人性质 = r_Merge.病人性质, 医疗付款方式 = r_Merge.医疗付款方式, 费别 = r_Merge.费别, 再入院 = r_Merge.再入院,
                入院病区id = r_Merge.入院病区id, 入院科室id = r_Merge.入院科室id, 入院日期 = r_Merge.入院日期, 入院病况 = r_Merge.入院病况,
                入院方式 = r_Merge.入院方式, 二级院转入 = r_Merge.二级院转入, 住院目的 = r_Merge.住院目的, 入院病床 = r_Merge.入院病床,
                是否陪伴 = r_Merge.是否陪伴, 当前病况 = r_Merge.当前病况, 当前病区id = r_Merge.当前病区id, 护理等级id = r_Merge.护理等级id,
                出院科室id = r_Merge.出院科室id, 出院病床 = r_Merge.出院病床, 出院日期 = r_Merge.出院日期, 住院天数 = r_Merge.住院天数,
                出院方式 = r_Merge.出院方式, 是否确诊 = r_Merge.是否确诊, 确诊日期 = r_Merge.确诊日期, 新发肿瘤 = r_Merge.新发肿瘤, 血型 = r_Merge.血型,
                抢救次数 = r_Merge.抢救次数, 成功次数 = r_Merge.成功次数, 随诊标志 = r_Merge.随诊标志, 随诊期限 = r_Merge.随诊期限, 尸检标志 = r_Merge.尸检标志,
                门诊医师 = r_Merge.门诊医师, 责任护士 = r_Merge.责任护士, 住院医师 = r_Merge.住院医师, 编目员编号 = r_Merge.编目员编号,
                编目员姓名 = r_Merge.编目员姓名, 编目日期 = r_Merge.编目日期, 状态 = r_Merge.状态, 费用和 = r_Merge.费用和, 姓名 = r_Merge.姓名,
                性别 = r_Merge.性别, 年龄 = r_Merge.年龄, 婚姻状况 = r_Merge.婚姻状况, 职业 = r_Merge.职业, 国籍 = r_Merge.国籍, 学历 = r_Merge.学历,
                单位电话 = r_Merge.单位电话, 单位邮编 = r_Merge.单位邮编, 单位地址 = r_Merge.单位地址, 区域 = r_Merge.区域, 家庭地址 = r_Merge.家庭地址,
                家庭电话 = r_Merge.家庭电话, 家庭地址邮编 = r_Merge.家庭地址邮编, 户口地址 = r_Merge.户口地址, 户口地址邮编 = r_Merge.户口地址邮编,
                联系人姓名 = r_Merge.联系人姓名, 联系人关系 = r_Merge.联系人关系, 联系人地址 = r_Merge.联系人地址, 联系人电话 = r_Merge.联系人电话,
                中医治疗类别 = r_Merge.中医治疗类别, 登记人 = r_Merge.登记人, 登记时间 = r_Merge.登记时间, 险类 = r_Merge.险类, 审核标志 = r_Merge.审核标志,
                是否上传 = r_Merge.是否上传, 备注 = r_Merge.备注, 数据转出 = r_Merge.数据转出, 病案号 = r_Merge.病案号,
                住院号 = Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号), 留观号 = r_Merge.留观号, 病人类型 = r_Merge.病人类型,
                封存时间 = r_Merge.封存时间, 路径状态 = r_Merge.路径状态, 单病种 = r_Merge.单病种, 婴儿科室id = r_Merge.婴儿科室id,
                婴儿病区id = r_Merge.婴儿病区id, 母婴转科标志 = r_Merge.母婴转科标志, 医嘱重整时间 = r_Merge.医嘱重整时间
            Where 病人id = v_保留id And 主页id = n_Cur主页id;
            If Sql%RowCount = 0 Then
              Insert Into 病案主页
                (病人id, 主页id, 病人性质, 医疗付款方式, 费别, 再入院, 入院病区id, 入院科室id, 入院日期, 入院病况, 入院方式, 二级院转入, 住院目的, 入院病床, 是否陪伴, 当前病况,
                 当前病区id, 护理等级id, 出院科室id, 出院病床, 出院日期, 住院天数, 出院方式, 是否确诊, 确诊日期, 新发肿瘤, 血型, 抢救次数, 成功次数, 随诊标志, 随诊期限, 尸检标志,
                 门诊医师, 责任护士, 住院医师, 编目员编号, 编目员姓名, 编目日期, 状态, 费用和, 姓名, 性别, 年龄, 婚姻状况, 职业, 国籍, 学历, 单位电话, 单位邮编, 单位地址, 区域, 家庭地址,
                 家庭电话, 家庭地址邮编, 户口地址, 户口地址邮编, 联系人姓名, 联系人关系, 联系人地址, 联系人电话, 中医治疗类别, 登记人, 登记时间, 险类, 审核标志, 是否上传, 备注, 数据转出,
                 病案号, 住院号, 留观号, 病人类型, 封存时间, 路径状态, 单病种, 婴儿科室id, 婴儿病区id, 母婴转科标志, 医嘱重整时间)
              Values
                (v_保留id, n_Cur主页id, r_Merge.病人性质, r_Merge.医疗付款方式, r_Merge.费别, r_Merge.再入院, r_Merge.入院病区id,
                 r_Merge.入院科室id, r_Merge.入院日期, r_Merge.入院病况, r_Merge.入院方式, r_Merge.二级院转入, r_Merge.住院目的, r_Merge.入院病床,
                 r_Merge.是否陪伴, r_Merge.当前病况, r_Merge.当前病区id, r_Merge.护理等级id, r_Merge.出院科室id, r_Merge.出院病床, r_Merge.出院日期,
                 r_Merge.住院天数, r_Merge.出院方式, r_Merge.是否确诊, r_Merge.确诊日期, r_Merge.新发肿瘤, r_Merge.血型, r_Merge.抢救次数,
                 r_Merge.成功次数, r_Merge.随诊标志, r_Merge.随诊期限, r_Merge.尸检标志, r_Merge.门诊医师, r_Merge.责任护士, r_Merge.住院医师,
                 r_Merge.编目员编号, r_Merge.编目员姓名, r_Merge.编目日期, r_Merge.状态, r_Merge.费用和, r_Merge.姓名, r_Merge.性别, r_Merge.年龄,
                 r_Merge.婚姻状况, r_Merge.职业, r_Merge.国籍, r_Merge.学历, r_Merge.单位电话, r_Merge.单位邮编, r_Merge.单位地址, r_Merge.区域,
                 r_Merge.家庭地址, r_Merge.家庭电话, r_Merge.家庭地址邮编, r_Merge.户口地址, r_Merge.户口地址邮编, r_Merge.联系人姓名, r_Merge.联系人关系,
                 r_Merge.联系人地址, r_Merge.联系人电话, r_Merge.中医治疗类别, r_Merge.登记人, r_Merge.登记时间, r_Merge.险类, r_Merge.审核标志,
                 r_Merge.是否上传, r_Merge.备注, r_Merge.数据转出, r_Merge.病案号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号),
                 r_Merge.留观号, r_Merge.病人类型, r_Merge.封存时间, r_Merge.路径状态, r_Merge.单病种, r_Merge.婴儿科室id, r_Merge.婴儿病区id,
                 r_Merge.母婴转科标志, r_Merge.医嘱重整时间);
            End If;
          Else
            n_Cur主页id := v_Count;
            Insert Into 病案主页
              (病人id, 主页id, 病人性质, 医疗付款方式, 费别, 再入院, 入院病区id, 入院科室id, 入院日期, 入院病况, 入院方式, 二级院转入, 住院目的, 入院病床, 是否陪伴, 当前病况,
               当前病区id, 护理等级id, 出院科室id, 出院病床, 出院日期, 住院天数, 出院方式, 是否确诊, 确诊日期, 新发肿瘤, 血型, 抢救次数, 成功次数, 随诊标志, 随诊期限, 尸检标志, 门诊医师,
               责任护士, 住院医师, 编目员编号, 编目员姓名, 编目日期, 状态, 费用和, 姓名, 性别, 年龄, 婚姻状况, 职业, 国籍, 学历, 单位电话, 单位邮编, 单位地址, 区域, 家庭地址, 家庭电话,
               家庭地址邮编, 户口地址, 户口地址邮编, 联系人姓名, 联系人关系, 联系人地址, 联系人电话, 中医治疗类别, 登记人, 登记时间, 险类, 审核标志, 是否上传, 备注, 数据转出, 病案号, 住院号,
               留观号, 病人类型, 封存时间, 路径状态, 单病种, 婴儿科室id, 婴儿病区id, 母婴转科标志, 医嘱重整时间)
            Values
              (v_保留id, n_Cur主页id, r_Merge.病人性质, r_Merge.医疗付款方式, r_Merge.费别, r_Merge.再入院, r_Merge.入院病区id, r_Merge.入院科室id,
               r_Merge.入院日期, r_Merge.入院病况, r_Merge.入院方式, r_Merge.二级院转入, r_Merge.住院目的, r_Merge.入院病床, r_Merge.是否陪伴,
               r_Merge.当前病况, r_Merge.当前病区id, r_Merge.护理等级id, r_Merge.出院科室id, r_Merge.出院病床, r_Merge.出院日期, r_Merge.住院天数,
               r_Merge.出院方式, r_Merge.是否确诊, r_Merge.确诊日期, r_Merge.新发肿瘤, r_Merge.血型, r_Merge.抢救次数, r_Merge.成功次数,
               r_Merge.随诊标志, r_Merge.随诊期限, r_Merge.尸检标志, r_Merge.门诊医师, r_Merge.责任护士, r_Merge.住院医师, r_Merge.编目员编号,
               r_Merge.编目员姓名, r_Merge.编目日期, r_Merge.状态, r_Merge.费用和, r_Merge.姓名, r_Merge.性别, r_Merge.年龄, r_Merge.婚姻状况,
               r_Merge.职业, r_Merge.国籍, r_Merge.学历, r_Merge.单位电话, r_Merge.单位邮编, r_Merge.单位地址, r_Merge.区域, r_Merge.家庭地址,
               r_Merge.家庭电话, r_Merge.家庭地址邮编, r_Merge.户口地址, r_Merge.户口地址邮编, r_Merge.联系人姓名, r_Merge.联系人关系, r_Merge.联系人地址,
               r_Merge.联系人电话, r_Merge.中医治疗类别, r_Merge.登记人, r_Merge.登记时间, r_Merge.险类, r_Merge.审核标志, r_Merge.是否上传,
               r_Merge.备注, r_Merge.数据转出, r_Merge.病案号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号), r_Merge.留观号, r_Merge.病人类型,
               r_Merge.封存时间, r_Merge.路径状态, r_Merge.单病种, r_Merge.婴儿科室id, r_Merge.婴儿病区id, r_Merge.母婴转科标志, r_Merge.医嘱重整时间);
          End If;
        Else
          Exit;
        End If;
      
        --更新病人相关表的病人指向
        ---------------------------------------------------------------
        --病人变动记录
        Update 病人变动记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        
        --病人自动计算
        Update 病人自动计算
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        
        --病案主页从表
        Update 病案主页从表
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --住院费用记录
        Update 住院费用记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id,
            标识号 = Nvl(Decode(门诊标志, 1, v_门诊号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号)), 标识号)
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H住院费用记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id,
            标识号 = Nvl(Decode(门诊标志, 1, v_门诊号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号)), 标识号)
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        --门诊费用记录
        --Update 门诊费用记录
        --Set 病人id = v_保留id,
        --    标识号 = Nvl(Decode(门诊标志, 1, v_门诊号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号)), 标识号)
        --Where 病人id = r_Merge.病人id;
        --Update H门诊费用记录
        --Set 病人id = v_保留id,
        --    标识号 = Nvl(Decode(门诊标志, 1, v_门诊号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号)), 标识号)
        --Where 病人id = r_Merge.病人id;
      
        --病人预交记录
        Update 病人预交记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H病人预交记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人未结费用
        Update 病人未结费用
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --未发药品记录
        Update 未发药品记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --诊断情况
        Update 诊断情况
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --保险结算记录(病人ID和非住院病人一起在后面处理)
        Update 保险结算记录 Set 主页id = n_Cur主页id Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --保险模拟结算
        Update 保险模拟结算
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人医嘱记录(ZLHIS+)
        Update 病人医嘱记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H病人医嘱记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人过敏记录(ZLHIS+)
        Update 病人过敏记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H病人过敏记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人诊断记录(ZLHIS+)
        Update 病人诊断记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H病人诊断记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人手麻记录(ZLHIS+)
        Update 病人手麻记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H病人手麻记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人担保记录(zlhis+)
        Update 病人担保记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病案系统的表
        Begin
          v_Sql := 'Update 病人费用 Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Update 随诊记录 Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Update 诊断符合情况 Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Update 病案评分结果 Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Insert Into 病人分娩信息(病人ID,主页ID,胎儿次序,分娩方式,出生胎位,分娩情况,出生缺陷,婴儿性别,婴儿体重,Apgar评分) ' ||
                   'Select :1,:2,胎儿次序,分娩方式,出生胎位,分娩情况,出生缺陷,婴儿性别,婴儿体重,Apgar评分 From 病人分娩信息 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Delete From 病人分娩信息 Where 病人ID=:1 And 主页ID=:2';
          Execute Immediate v_Sql
            Using r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Update 借阅记录 Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        --其它病案主页相关表
        For v_Loop In 1 .. Arronpage.Count Loop
          v_Sql := 'Update ' || Arronpage(v_Loop) || ' Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        End Loop;
      
        --删除已调整后的病案主页
        Delete From 病案主页 Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      End If;
      If r_Merge.主页id <> 0 Then
        v_Count := v_Count - 1;
      End If;
    End Loop;
  End If;

  --不涉及主页ID部份的更改(无主页ID或主页ID可能为空)
  ---------------------------------------------------------------
  --住院费用记录
  Update 住院费用记录
  Set 病人id = v_保留id, 标识号 = Nvl(Decode(门诊标志, 2, v_住院号, v_门诊号), 标识号)
  Where 病人id = v_合并id;
  Update H住院费用记录
  Set 病人id = v_保留id, 标识号 = Nvl(Decode(门诊标志, 2, v_住院号, v_门诊号), 标识号)
  Where 病人id = v_合并id;
  --门诊费用记录
  Update 门诊费用记录
  Set 病人id = v_保留id, 标识号 = Nvl(Decode(门诊标志, 2, v_住院号, v_门诊号), 标识号)
  Where 病人id = v_合并id;
  Update H门诊费用记录
  Set 病人id = v_保留id, 标识号 = Nvl(Decode(门诊标志, 2, v_住院号, v_门诊号), 标识号)
  Where 病人id = v_合并id;

  --病人预交记录
  Update 病人预交记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;
  Update H病人预交记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;

  --未发药品记录
  Update 未发药品记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;

  --诊断情况
  Update 诊断情况 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;

  --病人医嘱记录(ZLHIS+)
  Update 病人医嘱记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;
  Update H病人医嘱记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;

  --病人过敏记录(ZLHIS+):主页ID可能是挂号ID
  Update 病人过敏记录 Set 病人id = v_保留id Where 病人id = v_合并id;
  Update H病人过敏记录 Set 病人id = v_保留id Where 病人id = v_合并id;

  --病人诊断记录(ZLHIS+):主页ID可能是挂号ID
  Update 病人诊断记录 Set 病人id = v_保留id Where 病人id = v_合并id;
  Update H病人诊断记录 Set 病人id = v_保留id Where 病人id = v_合并id;

  --病人手麻记录(ZLHIS+)
  Update 病人手麻记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;
  Update H病人手麻记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;

  --病人挂号记录(ZLHIS+)
  Update 病人挂号记录 Set 病人id = v_保留id, 门诊号 = Nvl(v_门诊号, 门诊号) Where 病人id = v_合并id;

  --病人结帐记录
  Update 病人结帐记录 Set 病人id = v_保留id Where 病人id = v_合并id;
  Update H病人结帐记录 Set 病人id = v_保留id Where 病人id = v_合并id;

  --床位状况记录
  Update 床位状况记录 Set 病人id = v_保留id Where 病人id = v_合并id;

  --病人担保记录
  Update 病人担保记录 Set 病人id = v_保留id Where 病人id = v_合并id;
  --特殊病人
  Select Count(*) Into v_Count From 特殊病人 Where 病人id = v_保留id;
  If v_Count = 0 Then
    Update 特殊病人 Set 病人id = v_保留id Where 病人id = v_合并id;
  Else
    Delete From 特殊病人 Where 病人id = v_合并id;
  End If;

  --病人未结费用
  For r_Owe In c_Owe(v_合并id) Loop
    Update 病人未结费用
    Set 金额 = Nvl(金额, 0) + Nvl(r_Owe.金额, 0)
    Where 主页id Is Null And 病人id = v_保留id And Nvl(病人病区id, 0) = Nvl(r_Owe.病人病区id, 0) And
          Nvl(病人科室id, 0) = Nvl(r_Owe.病人科室id, 0) And Nvl(开单部门id, 0) = Nvl(r_Owe.开单部门id, 0) And
          Nvl(执行部门id, 0) = Nvl(r_Owe.执行部门id, 0) And Nvl(收入项目id, 0) = Nvl(r_Owe.收入项目id, 0) And
          Nvl(来源途径, 0) = Nvl(r_Owe.来源途径, 0);
    If Sql%RowCount = 0 Then
      Insert Into 病人未结费用
        (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
      Values
        (v_保留id, Null, r_Owe.病人病区id, r_Owe.病人科室id, r_Owe.开单部门id, r_Owe.执行部门id, r_Owe.收入项目id, r_Owe.来源途径, r_Owe.金额);
    End If;
  End Loop;
  Delete From 病人未结费用 Where 病人id = v_合并id;
  Delete From 病人未结费用 Where 病人id = v_保留id And Nvl(金额, 0) = 0;

  --病人余额
  For r_Spare In c_Spare(v_合并id) Loop
    Update 病人余额
    Set 预交余额 = Nvl(预交余额, 0) + Nvl(r_Spare.预交余额, 0), 费用余额 = Nvl(费用余额, 0) + Nvl(r_Spare.费用余额, 0)
    Where Nvl(性质, 0) = Nvl(r_Spare.性质, 0) And 病人id = v_保留id And 类型 = Nvl(r_Spare.类型, 2);
    If Sql%RowCount = 0 Then
      Insert Into 病人余额
        (病人id, 性质, 类型, 预交余额, 费用余额)
      Values
        (v_保留id, r_Spare.性质, Nvl(r_Spare.类型, 2), r_Spare.预交余额, r_Spare.费用余额);
    End If;
  End Loop;
  Delete From 病人余额 Where 病人id = v_合并id;
  Delete From 病人余额 Where 病人id = v_保留id And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0 And 性质 = 1;

  --病人过敏药物
  Insert Into 病人过敏药物
    (病人id, 过敏药物id, 过敏药物)
    Select v_保留id, 过敏药物id, 过敏药物
    From 病人过敏药物
    Where 病人id = v_合并id And 过敏药物id Not In (Select 过敏药物id From 病人过敏药物 Where 病人id = v_保留id);
  Delete From 病人过敏药物 Where 病人id = v_合并id;

  --病人社区信息
  Insert Into 病人社区信息
    (病人id, 社区, 社区号, 标志, 就诊类型, 就诊时间)
    Select v_保留id, 社区, 社区号, 标志, 就诊类型, 就诊时间
    From 病人社区信息
    Where 病人id = v_合并id And 社区 Not In (Select 社区 From 病人社区信息 Where 病人id = v_保留id);
  Delete From 病人社区信息 Where 病人id = v_合并id;

  --病人免疫记录
  Insert Into 病人免疫记录
    (病人id, 接种时间, 接种名称)
    Select v_保留id, a.接种时间, a.接种名称
    From 病人免疫记录 A
    Where a.病人id = v_合并id And Not Exists (Select 1 From 病人免疫记录 Where 病人id = v_保留id And 接种时间 = a.接种时间);
  Delete From 病人免疫记录 Where 病人id = v_合并id;

  --病人信息从表
  Insert Into 病人信息从表
    (病人id, 信息名, 信息值, 就诊id)
    Select v_保留id, a.信息名, a.信息值, a.就诊id
    From 病人信息从表 A
    Where a.病人id = v_合并id And Not Exists (Select 1
           From 病人信息从表
           Where 病人id = v_保留id And 信息名 = a.信息名 And Nvl(就诊id, 0) = Nvl(a.就诊id, 0));
  Delete From 病人信息从表 Where 病人id = v_合并id;

  --病人医疗卡属性
  Insert Into 病人医疗卡属性
    (病人id, 卡类别id, 卡号, 信息名, 信息值)
    Select v_保留id, a.卡类别id, a.卡号, a.信息名, a.信息值
    From 病人医疗卡属性 A
    Where a.病人id = v_合并id And Not Exists (Select 1
           From 病人医疗卡属性
           Where 病人id = v_保留id And 卡类别id = a.卡类别id And 卡号 = a.卡号 And 信息名 = a.信息名);
  Delete From 病人医疗卡属性 Where 病人id = v_合并id;

  --门诊病案记录
  Select Count(*) Into v_Count From 门诊病案记录 Where 病人id = v_保留id;
  If v_Count = 0 Then
    Select Count(*) Into v_Count From 门诊病案记录 Where 病人id = v_合并id;
    If v_Count > 0 Then
      Update 门诊病案记录 Set 病人id = v_保留id Where 病人id = v_合并id;
    End If;
  Else
    Delete From 门诊病案记录 Where 病人id = v_合并id;
  End If;

  --住院病案记录
  Select Count(*) Into v_Count From 住院病案记录 Where 病人id = v_保留id;

  If v_Count = 0 Then
    Select Count(*) Into v_Count From 住院病案记录 Where 病人id = v_合并id;
    If v_Count > 0 Then
      Update 住院病案记录 Set 病人id = v_保留id Where 病人id = v_合并id;
    End If;
  Else
    Begin
      v_Sql := 'Delete From 借阅记录 Where 病人ID=:1';
      Execute Immediate v_Sql
        Using v_合并id;
    Exception
      When Others Then
        Null;
    End;
  
    Delete From 住院病案记录 Where 病人id = v_合并id;
  End If;

  --医保病人相关处理
  --即使合病或保留的病人当前不是医保帐户,只要曾是医保帐户,险类不同也不能合并
  Select Count(Distinct 险类) Into v_Count From 医保病人关联表 Where 病人id In (v_合并id, v_保留id);
  If v_Count = 2 Then
    Close c_Infoa;
    Close c_Infob;
    v_Error := '两个病人分别属于不同的保险类别，不允许合并。';
    Raise Err_Custom;
  End If;

  Select Count(*) Into v_Count From 医保病人关联表 Where 病人id = v_合并id And 标志 = 0;
  --a.合并的病人以前是医保帐户,现在不是
  If v_Count > 0 Then
    Select Count(*) Into v_Count From 医保病人关联表 Where 病人id = v_保留id;
    --a.1保留的病人现在是医保帐户
    --a.2.1保留的病人现在不是医保帐户,以前是,与a.1相同处理
    If v_Count > 0 Then
      Delete From 帐户年度信息 Where 病人id = v_合并id;
    
      Select Count(Distinct 医保号) Into v_Count From 医保病人关联表 Where 病人id In (v_合并id, v_保留id);
      If v_Count <> 2 Then
        --两个病人医保号相同时,不用处理医保病人档案
        For r_Insure In c_Insure(v_合并id) Loop
          --被合并的病人可能关联了多个医保病人,改为关联到保留的病人上
          --问题27445 保留指定病人的门诊号、住院号、医保号
          If v_合并id = B病人id_In Then
            Update 医保病人关联表
            Set 医保号 =
                 (Select 医保号 From 医保病人关联表 Where 病人id = v_合并id), 标志 = 0
            Where 险类 = r_Insure.险类 And 中心 = r_Insure.中心 And 医保号 = r_Insure.医保号 And 病人id <> v_合并id;
          Else
            Update 医保病人关联表
            Set 医保号 =
                 (Select 医保号 From 医保病人关联表 Where 病人id = v_保留id), 标志 = 0
            Where 险类 = r_Insure.险类 And 中心 = r_Insure.中心 And 医保号 = r_Insure.医保号 And 病人id <> v_合并id;
          End If;
          --合并的病人现在不是医保,即使是用户指定要保留该病人,也不保留它的帐户信息
          Delete From 医保病人档案 Where 险类 = r_Insure.险类 And 医保号 = r_Insure.医保号;
        End Loop;
      End If;
      Delete From 医保病人关联表 Where 病人id = v_合并id;
    Else
      --a.2.2保留的病人现在和以前都不是医保帐户
      Update 帐户年度信息 Set 病人id = v_保留id Where 病人id = v_合并id;
      Update 医保病人关联表 Set 病人id = v_保留id Where 病人id = v_合并id;
      --医保病人档案表不用处理,因为通过医保号关联<医保病人关联表>
    End If;
  Else
    Select Count(*) Into v_Count From 医保病人关联表 Where 病人id = v_合并id And 标志 = 1;
    --b.合并的病人现在是医保帐户
    If v_Count > 0 Then
      Select Count(*) Into v_Count From 医保病人关联表 Where 病人id = v_保留id;
      --b.1保留的病人现在也是医保帐户
      --b.2.1保留的病人现在不是医保帐户,以前是,与b.1相同处理
      If v_Count > 0 Then
        For r_Insure In c_Insure(v_合并id) Loop
          --转移帐户年度信息
          For r_Year In c_Year(v_合并id, r_Insure.险类) Loop
            Update 帐户年度信息
            Set 帐户增加累计 = Nvl(帐户增加累计, 0) + Nvl(r_Year.帐户增加累计, 0), 帐户支出累计 = Nvl(帐户支出累计, 0) + Nvl(r_Year.帐户支出累计, 0),
                进入统筹累计 = Nvl(进入统筹累计, 0) + Nvl(r_Year.进入统筹累计, 0), 统筹报销累计 = Nvl(统筹报销累计, 0) + Nvl(r_Year.统筹报销累计, 0),
                住院次数累计 = Nvl(住院次数累计, 0) + Nvl(r_Year.住院次数累计, 0), 大额统筹累计 = Nvl(大额统筹累计, 0) + Nvl(r_Year.大额统筹累计, 0),
                起付线累计 = Nvl(起付线累计, 0) + Nvl(r_Year.起付线累计, 0), 本次起付线 = Nvl(本次起付线, r_Year.本次起付线),
                基本统筹限额 = Nvl(基本统筹限额, r_Year.基本统筹限额), 大额统筹限额 = Nvl(大额统筹限额, r_Year.大额统筹限额), 封销信息 = Nvl(封销信息, r_Year.封销信息)
            Where 病人id = v_保留id And 险类 = r_Insure.险类 And 年度 = r_Year.年度;
            If Sql%RowCount = 0 Then
              Insert Into 帐户年度信息
                (病人id, 险类, 年度, 帐户增加累计, 帐户支出累计, 进入统筹累计, 统筹报销累计, 住院次数累计, 本次起付线, 基本统筹限额, 大额统筹限额, 起付线累计, 大额统筹累计, 封销信息)
              Values
                (v_保留id, r_Insure.险类, r_Year.年度, r_Year.帐户增加累计, r_Year.帐户支出累计, r_Year.进入统筹累计, r_Year.统筹报销累计,
                 r_Year.住院次数累计, r_Year.本次起付线, r_Year.基本统筹限额, r_Year.大额统筹限额, r_Year.起付线累计, r_Year.大额统筹累计, r_Year.封销信息);
            End If;
          End Loop;
          Delete From 帐户年度信息 Where 病人id = v_合并id;
        
          Select Count(Distinct 医保号) Into v_Count From 医保病人关联表 Where 病人id In (v_合并id, v_保留id);
          If v_Count <> 2 Then
            --两个病人医保号相同时,不用处理医保病人档案
            If v_合并id = B病人id_In Then
              Update 医保病人关联表
              Set 标志 = 0
              Where (险类, 中心, 医保号) In (Select 险类, 中心, 医保号 From 医保病人关联表 Where 病人id = v_保留id);
              Update 医保病人关联表 Set 标志 = 1 Where 病人id = v_保留id;
            End If;
            Delete From 医保病人关联表 Where 病人id = v_合并id;
          Else
            --被合并的病人可能关联了多个医保病人,改为关联到保留的病人上
            --问题27445 保留指定病人的门诊号、住院号、医保号
            If v_合并id = B病人id_In Then
              Update 医保病人关联表
              Set 医保号 =
                   (Select 医保号 From 医保病人关联表 Where 病人id = v_合并id), 标志 = 0
              Where 险类 = r_Insure.险类 And 中心 = r_Insure.中心 And 医保号 = r_Insure.医保号 And 病人id <> v_合并id;
            Else
              Update 医保病人关联表
              Set 医保号 =
                   (Select 医保号 From 医保病人关联表 Where 病人id = v_保留id), 标志 = 0
              Where 险类 = r_Insure.险类 And 中心 = r_Insure.中心 And 医保号 = r_Insure.医保号 And 病人id <> v_合并id;
            End If;
            --暂存用户指定要保留病人的帐户信息
            If v_合并id = B病人id_In Then
              Open c_Keepinsure(B病人id_In, r_Insure.险类);
              Fetch c_Keepinsure
                Into r_Keepinsure;
            End If;
          
            Delete From 医保病人关联表 Where 病人id = v_合并id;
            Delete From 医保病人档案 Where 险类 = r_Insure.险类 And 医保号 = r_Insure.医保号;
          
            --保留用户指定要保留病人的帐户信息
            If v_合并id = B病人id_In Then
              If c_Keepinsure%RowCount > 0 Then
                Update 医保病人档案
                Set 卡号 = r_Keepinsure.卡号, 医保号 = r_Keepinsure.医保号, 密码 = r_Keepinsure.密码, 人员身份 = r_Keepinsure.人员身份,
                    单位编码 = r_Keepinsure.单位编码, 顺序号 = r_Keepinsure.顺序号, 退休证号 = r_Keepinsure.退休证号, 帐户余额 = r_Keepinsure.帐户余额,
                    当前状态 = r_Keepinsure.当前状态, 病种id = r_Keepinsure.病种id, 在职 = r_Keepinsure.在职, 年龄段 = r_Keepinsure.年龄段,
                    灰度级 = r_Keepinsure.灰度级, 就诊时间 = r_Keepinsure.就诊时间
                Where (险类, 中心, 医保号) In (Select 险类, 中心, 医保号 From 医保病人关联表 Where 病人id = v_保留id);
                --保留病人可能关联了多个医保病人,都要更改医保号
                Update 医保病人关联表
                Set 医保号 = r_Keepinsure.医保号, 标志 = 0
                Where (险类, 中心, 医保号) In (Select 险类, 中心, 医保号 From 医保病人关联表 Where 病人id = v_保留id);
                Update 医保病人关联表 Set 标志 = 1 Where 病人id = v_保留id;
              End If;
              Close c_Keepinsure;
            End If;
          End If;
        End Loop;
      Else
        --b.2.2保留的病人现在和以前都不是医保帐户
        Update 帐户年度信息 Set 病人id = v_保留id Where 病人id = v_合并id;
        Update 医保病人关联表 Set 病人id = v_保留id Where 病人id = v_合并id;
        --医保病人档案表不用处理,因为通过医保号关联<医保病人关联表>
      End If;
    Else
      --c.合并的病人以前和现在都不是医保帐户,不作任何处理
      Null;
    End If;
  End If;

  --处理体检子系统的病人合并
  n_Have := 0;
  Begin
    Select 1 Into n_Have From zlSystems Where Floor(编号 / 100) = 21;
  Exception
    When Others Then
      Null;
  End;
  If n_Have = 1 Then
    v_Sql := 'Begin zl21_病人信息_Merge(:1,:2); End;';
    Execute Immediate v_Sql
      Using v_合并id, v_保留id;
  End If;

  --其它病人,病案主页相关表
  For v_Loop In 1 .. Arronpage.Count Loop
    --Executesql('Update ' || Arronpage(v_Loop) || ' Set 病人ID=' || v_保留id || ' Where 病人ID=' || v_合并id || ' And Nvl(主页ID,0) = 0');
    --"主页=0，主页ID is NULL，主页ID=挂号ID"都有可能，前面部分与主页ID关联都没处理到，因此不加条件
    v_Sql := 'Update ' || Arronpage(v_Loop) || ' Set 病人ID=:1 Where 病人ID=:2';
    Execute Immediate v_Sql
      Using v_保留id, v_合并id;
  End Loop;
  For v_Loop In 1 .. Arronbase.Count Loop
    If Arronbase(v_Loop) = '病人照片' Then
      Select Count(1) Into n_Have From 病人照片 Where 病人id = v_保留id;
      If n_Have = 1 Then
        Delete From 病人照片 Where 病人id = v_合并id;
      End If;
    End If;
    v_Sql := 'Update ' || Arronbase(v_Loop) || ' Set 病人ID=:1 Where 病人ID=:2';
    Execute Immediate v_Sql
      Using v_保留id, v_合并id;
  End Loop;

  --删除实际不保留的病人信息
  Delete From 病人信息 Where 病人id = v_合并id;

  --根据界面选择保留病人信息
  Update 病人信息
  Set 姓名 = Nvl(r_Infob.姓名, r_Infoa.姓名), 性别 = Nvl(r_Infob.性别, r_Infoa.性别), 年龄 = Nvl(r_Infob.年龄, r_Infoa.年龄), 门诊号 = v_门诊号,
      住院号 = v_住院号, 就诊卡号 = Nvl(r_Infob.就诊卡号, r_Infoa.就诊卡号), 卡验证码 = Decode(r_Infob.就诊卡号, Null, r_Infoa.卡验证码, r_Infob.卡验证码),
      费别 = Nvl(r_Infob.费别, r_Infoa.费别), 医疗付款方式 = Nvl(r_Infob.医疗付款方式, r_Infoa.医疗付款方式),
      出生日期 = Nvl(r_Infob.出生日期, r_Infoa.出生日期), 出生地点 = Nvl(r_Infob.出生地点, r_Infoa.出生地点),
      身份证号 = Nvl(r_Infob.身份证号, r_Infoa.身份证号), 身份 = Nvl(r_Infob.身份, r_Infoa.身份), 职业 = Nvl(r_Infob.职业, r_Infoa.职业),
      民族 = Nvl(r_Infob.民族, r_Infoa.民族), 国籍 = Nvl(r_Infob.国籍, r_Infoa.国籍), 学历 = Nvl(r_Infob.学历, r_Infoa.学历),
      籍贯 = Nvl(r_Infob.籍贯, r_Infoa.籍贯), 区域 = Nvl(r_Infob.区域, r_Infoa.区域), 婚姻状况 = Nvl(r_Infob.婚姻状况, r_Infoa.婚姻状况),
      家庭地址 = Nvl(r_Infob.家庭地址, r_Infoa.家庭地址), 家庭电话 = Nvl(r_Infob.家庭电话, r_Infoa.家庭电话),
      家庭地址邮编 = Nvl(r_Infob.家庭地址邮编, r_Infoa.家庭地址邮编), 户口地址 = Nvl(r_Infob.户口地址, r_Infoa.户口地址),
      户口地址邮编 = Nvl(r_Infob.户口地址邮编, r_Infoa.户口地址邮编), 联系人姓名 = Nvl(r_Infob.联系人姓名, r_Infoa.联系人姓名),
      联系人关系 = Nvl(r_Infob.联系人关系, r_Infoa.联系人关系), 联系人地址 = Nvl(r_Infob.联系人地址, r_Infoa.联系人地址),
      联系人电话 = Nvl(r_Infob.联系人电话, r_Infoa.联系人电话), 合同单位id = Nvl(r_Infob.合同单位id, r_Infoa.合同单位id),
      工作单位 = Nvl(r_Infob.工作单位, r_Infoa.工作单位), 单位电话 = Nvl(r_Infob.单位电话, r_Infoa.单位电话),
      单位邮编 = Nvl(r_Infob.单位邮编, r_Infoa.单位邮编), 单位开户行 = Nvl(r_Infob.单位开户行, r_Infoa.单位开户行),
      单位帐号 = Nvl(r_Infob.单位帐号, r_Infoa.单位帐号), 就诊时间 = Nvl(r_Infob.就诊时间, r_Infoa.就诊时间),
      就诊状态 = Nvl(r_Infob.就诊状态, r_Infoa.就诊状态), 就诊诊室 = Nvl(r_Infob.就诊诊室, r_Infoa.就诊诊室), 险类 = Nvl(r_Infob.险类, r_Infoa.险类),
      登记时间 = Nvl(r_Infob.登记时间, r_Infoa.登记时间), 住院次数 = Null, 主页id = Null, 当前床号 = Null, 当前科室id = Null, 当前病区id = Null,
      入院时间 = Null, 出院时间 = Null, 在院 = Decode(Nvl(r_Infob.在院, 0), 1, 1, Null)
  Where 病人id = v_保留id;

  Open c_Info(v_保留id);
  Fetch c_Info
    Into r_Info;
  If c_Info%RowCount > 0 Then
    --最后一次为预约病人,只需要更改住院次数和入院时间
    If r_Info.主页id = 0 Then
      Update 病人信息
      Set 主页id = Decode(r_Info.最大主页id, 0, Null, r_Info.最大主页id), 住院次数 = Decode(n_Max住院次数, 0, Null, n_Max住院次数)
      Where 病人id = v_保留id;
    Else
      Update 病人信息
      Set 主页id = Decode(r_Info.最大主页id, 0, Null, r_Info.最大主页id), 住院次数 = Decode(n_Max住院次数, 0, Null, n_Max住院次数),
          当前床号 = Decode(r_Info.出院日期, Null, r_Info.出院病床, Null), 当前病区id = Decode(r_Info.出院日期, Null, r_Info.当前病区id, Null),
          当前科室id = Decode(r_Info.出院日期, Null, r_Info.出院科室id, Null), 入院时间 = r_Info.入院日期, 出院时间 = r_Info.出院日期



      
      Where 病人id = v_保留id;
    End If;
    --处理担保信息
    Select Nvl(主页id, -1) Into n_主页id From 病人信息 Where 病人id = v_保留id;
    --提取当前有效的正常担保记录,确保正常担保与临时担保不并存
    Select Nvl(Sum(担保额), 0), Count(病人id)
    Into n_担保额, n_Row
    From 病人担保记录
    Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And (到期时间 Is Null Or 到期时间 > Sysdate) And 担保性质 = 0 And 删除标志 = 1;
    If n_Row = 0 Then
      --保留最后一条临时担保记录,其余到期
      Update 病人担保记录
      Set 到期时间 = Sysdate - 1 / 24 / 60 / 60
      Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And 担保性质 = 1 And (到期时间 Is Null Or 到期时间 > Sysdate) And 删除标志 = 1 And
            登记时间 <> (Select Max(登记时间)
                     From 病人担保记录
                     Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And 担保性质 = 1 And (到期时间 Is Null Or 到期时间 > Sysdate) And
                           删除标志 = 1);
    Else
      --有正常担保就让临时担保失效
      Update 病人担保记录
      Set 到期时间 = Sysdate - 1 / 24 / 60 / 60
      Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And 担保性质 = 1 And (到期时间 Is Null Or 到期时间 > Sysdate) And 删除标志 = 1;
    End If;
  
    --提取当前有效担保额及有效担保记录数
    n_Row    := 0;
    n_担保额 := 0;
    v_担保人 := '';
    For r_提保信息 In (Select 担保人, 担保额
                   From 病人担保记录
                   Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And (到期时间 Is Null Or 到期时间 > Sysdate) And 删除标志 = 1) Loop
      n_Row     := n_Row + 1;
      n_担保额  := n_担保额 + r_提保信息.担保额;
      v_担保人  := v_担保人 || ',' || r_提保信息.担保人;
      n_Lengthb := Lengthb(v_担保人);
      If n_Lengthb >= 101 Then
        v_Error := '不能合并担保记录，在病人信息保存时超过担保人字段长度！';
        Raise Err_Custom;
      End If;
    End Loop;
    v_担保人 := Substr(v_担保人, 2, 100);
  
    If n_Row = 0 Then
      Update 病人信息 Set 担保人 = Null, 担保额 = Null, 担保性质 = Null Where 病人id = v_保留id;
    Else
      --提取最后一条有效担保人和担保性质
      Select 担保性质
      Into n_担保性质
      From 病人担保记录
      Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And 删除标志 = 1 And
            登记时间 =
            (Select Max(登记时间)
             From 病人担保记录
             Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And (到期时间 Is Null Or 到期时间 > Sysdate) And 删除标志 = 1);
    
      Update 病人信息 Set 担保人 = v_担保人, 担保额 = n_担保额, 担保性质 = n_担保性质 Where 病人id = v_保留id;
    End If;
  End If;

  Close c_Info;
  Close c_Infoa;
  Close c_Infob;

  --对病人进行解锁
  Update 病人信息 Set 锁定 = 0 Where 病人id In (A病人id_In, B病人id_In);
Exception
  When Err_Custom Then
    Begin
      Rollback; --不然会死锁
      Zl_病人信息_锁定(A病人id_In, 0);
      Zl_病人信息_锁定(B病人id_In, 0);
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
    End;
  When Others Then
    Begin
      Rollback; --不然会死锁
      Zl_病人信息_锁定(A病人id_In, 0);
      Zl_病人信息_锁定(B病人id_In, 0);
      zl_ErrorCenter(SQLCode, SQLErrM);
    End;
End Zl_病人信息_Merge;
/
--97423:余伟节,2017-04-15,处理再入院病人取消登记时找不到数据的问题
--107651:梁唐彬,2017-04-10,病人自动计算
Create Or Replace Procedure Zl_入院病案主页_Delete
(
  病人id_In     病案主页.病人id%Type,
  主页id_In     病案主页.主页id%Type,
  转留观_In     Number := 0,
  清除住院号_In Number := 0
  --功能：取消病人入院/预约登记
  --     主页ID_IN:为0时表示取消预约登记
  --     转留观_IN:将正常入院登记病人转为住院留观病人
  --     清除住院号_In:第一次住院的病人转留观时是否清除住院号
) As
  v_入院时间   病案主页.入院日期%Type;
  v_入院科室   病案主页.入院科室id%Type;
  v_出院时间   病案主页.出院日期%Type;
  v_住院号     病案主页.住院号%Type;
  v_再入院     病案主页.再入院%Type;
  v_出院科室id 病案主页.出院科室id%Type;
  n_病人性质   病案主页.病人性质%Type;
  n_主页id     病案主页.主页id%Type;

  v_Count Number;
  v_Error Varchar2(255);
  Err_Custom Exception;

  Function Checkpatiadvice
  (
    病人id_In 病案主页.病人id%Type,
    主页id_In 病案主页.主页id%Type
  ) Return Varchar2 Is
    --本次住院所有医嘱记录都已作废
    v_Err Varchar2(255);
  Begin
    v_Err := Null;
  
    For r_Row In (Select 开嘱医生, Decode(医嘱状态, -1, '暂存', 1, '新开', 2, '校对疑问', '未作废') As 状态, 医嘱内容
                  From 病人医嘱记录
                  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(医嘱状态, 0) <> 4 And Rownum < 2) Loop
      v_Err := '【' || r_Row.开嘱医生 || '】医生有' || r_Row.状态 || '的医嘱没有处理,不允许取消登记！';
    End Loop;
    Return v_Err;
  End Checkpatiadvice;
Begin
  Select Nvl(状态, 0), Nvl(病人性质, 0)
  Into v_Count, n_病人性质
  From 病案主页
  Where 病人id = 病人id_In And 主页id = 主页id_In;
  If v_Count <> 1 Then
    v_Error := '该病人已经入科,请先将病人撤消至入院状态。';
    Raise Err_Custom;
  End If;

  --删除电子病历时机
  Select 出院科室id, 再入院 Into v_出院科室id, v_再入院 From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
  If v_再入院 = 0 Then
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '入院', v_出院科室id);
  Else
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '再次入院', v_出院科室id);
  End If;

  --提取最近一次不为空的住院号
  Begin
    If 主页id_In = 0 Then
      Select 住院号
      Into v_住院号
      From 病案主页
      Where 病人id = 病人id_In And
            主页id =
            (Select Max(主页id) From 病案主页 Where 病人id = 病人id_In And Nvl(主页id, 0) <> 0 And Nvl(住院号, 0) <> 0);
    Else
      Select 住院号
      Into v_住院号
      From 病案主页
      Where 病人id = 病人id_In And
            主页id =
            (Select Max(主页id) From 病案主页 Where 病人id = 病人id_In And 主页id < 主页id_In And Nvl(住院号, 0) <> 0);
    End If;
  Exception
    When Others Then
      Null;
  End;

  If 转留观_In = 1 And Nvl(主页id_In, 0) <> 0 Then
    Update 病案主页
    Set 病人性质 = 2, 住院号 = Decode(清除住院号_In, 1, Null, 住院号)
    Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(病人性质, 0) = 0;
  
    --调整住院次数
    Update 病人信息 Set 住院次数 = Decode(Sign(住院次数 - 1), 1, 住院次数 - 1, Null) Where 病人id = 病人id_In;
    If 清除住院号_In = 1 Then
      Update 病人信息 Set 住院号 = v_住院号 Where 病人id = 病人id_In;
    End If;
  Else
    Begin
      Select b.入院日期, b.出院日期, b.入院科室id
      Into v_入院时间, v_出院时间, v_入院科室
      From 病人信息 A, 病案主页 B
      Where a.病人id = 病人id_In And a.病人id = b.病人id And a.主页id = b.主页id And Nvl(b.主页id, 0) <> 0;
    Exception
      When Others Then
        Null;
    End;
    --撤消预约登记病人不检查住院日报
    If Nvl(主页id_In, 0) <> 0 Then
      Select Zl_住院日报_Count(v_入院科室, v_入院时间) Into v_Count From Dual;
      If v_Count > 0 Then
        v_Error := '已产生业务时间内的住院日报,不能办理该业务!';
        Raise Err_Custom;
      End If;
    End If;
    --门诊留观病人下达入院通知后存在两条有效的病案主页记录（36549）
    Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 入院日期 Is Not Null And 出院日期 Is Null;
    If Not v_Count > 1 Then
      v_Count := 0;
      If Nvl(主页id_In, 0) <> 0 And Nvl(n_病人性质, 0) = 0 Then
        v_Count := 1;
      End If;
      --再入院病人,取消入院登记时,病人信息的入院时间和出院时间应该回退到上一次入院日期和出院日期
      If v_再入院 = 1 Then
        Begin
          Select 入院日期, 出院日期
          Into v_入院时间, v_出院时间
          From 病案主页
          Where 病人id = 病人id_In And
                主页id = (Select Max(主页id)
                        From 病案主页
                        Where 病人id = 病人id_In And 主页id < 主页id_In And Nvl(住院号, 0) <> 0);
        Exception
          When Others Then
            --异常处理是为了屏蔽取不到数据的异常情况
            Null;
        End;
      End If;
    
      Update 病人信息
      Set 住院号 = v_住院号, 住院次数 = Decode(v_Count, 0, 住院次数, Decode(Sign(住院次数 - 1), 1, 住院次数 - 1, Null)), 当前科室id = Null,
          当前病区id = Null, 当前床号 = Null, 入院时间 = v_入院时间, 出院时间 = v_出院时间, 担保人 = Null, 担保额 = Null, 担保性质 = Null, 在院 = Null
      Where 病人id = 病人id_In;
      Delete From 在院病人 Where 病人id = 病人id_In;
    End If;
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In;
    Delete From 病人自动计算 Where 病人id = 病人id_In And 主页id = 主页id_In;
    Delete From 病人诊断记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 记录来源 = 2;
  
    --本次住院如果交了预交款,改为当作门诊交的
    Update 病人预交记录 Set 主页id = Null Where 病人id = 病人id_In And 主页id = 主页id_In;
  
    --本次发卡的,改变门诊发卡
    Update 住院费用记录 Set 主页id = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 5;
  
    --本次住院的所有费用记录无结算且已全部冲销，则将对应费用记录中的"主页ID"清除。
    v_Count := 0;
    Select Nvl(Count(*), 0)
    Into v_Count
    From 住院费用记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 记帐费用 = 1 And 结帐id Is Not Null;
  
    If v_Count = 0 Then
      Begin
        Select Nvl(Count(*), 0)
        Into v_Count
        From 住院费用记录
        Where 病人id = 病人id_In And 主页id = 主页id_In And 记帐费用 = 1
        Group By NO, 记录性质, 序号
        Having Nvl(Sum(实收金额), 0) <> 0;
      Exception
        When Others Then
          v_Count := 0;
      End;
    
      If v_Count = 0 Then
        Delete 病人未结费用 Where 病人id = 病人id_In And 主页id = 主页id_In And 金额 = 0;
        Update 住院费用记录 Set 主页id = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 记帐费用 = 1;
      End If;
    End If;
  
    --本次住院所有医嘱记录都已作废
    v_Count := 0;
    Select Nvl(Count(*), 0)
    Into v_Count
    From 病人医嘱记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(医嘱状态, 0) <> 4;
    If v_Count = 0 Then
      Delete From 病人医嘱记录 Where 病人id = 病人id_In And 主页id = 主页id_In;
    Else
      v_Error := Checkpatiadvice(病人id_In, 主页id_In);
      If v_Error Is Not Null Then
        Raise Err_Custom;
      End If;
    End If;
  
    --以下表,没有建病案主页(病人ID,主页ID)的外键,因为其主页ID可能是挂号ID
    Delete From 病人过敏记录 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    Delete From 病人诊断记录 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    Delete From 病人新生儿记录 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    Delete From 电子病历记录 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    Delete From 电子病历打印 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    --如果入院发放了就诊卡,则删除会失败(病人费用记录主页ID有外键约束)
    Delete From 病案主页 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    --修改病人信息的主页ID和住院次数
    Select Max(主页id) Into n_主页id From 病案主页 Where 病人id = 病人id_In And Nvl(主页id, 0) <> 0;
    Update 病人信息 Set 主页id = n_主页id Where 病人id = 病人id_In;
    If n_主页id Is Null Then
      Update 病人信息 Set 住院次数 = Null Where 病人id = 病人id_In;
    End If;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_入院病案主页_Delete;
/

--107651:梁唐彬,2017-04-10,病人自动计算
Create Or Replace Procedure Zl_入院病案主页_Update
(
  登记模式_In       Number,
  病人id_In         病人信息.病人id%Type,
  住院号_In         病人信息.住院号%Type,
  医保号_In         保险帐户.医保号%Type,
  姓名_In           病人信息.姓名%Type,
  性别_In           病人信息.性别%Type,
  年龄_In           病人信息.年龄%Type,
  费别_In           病人信息.费别%Type,
  出生日期_In       病人信息.出生日期%Type,
  国籍_In           病人信息.国籍%Type,
  民族_In           病人信息.民族%Type,
  学历_In           病人信息.学历%Type,
  婚姻状况_In       病人信息.婚姻状况%Type,
  职业_In           病人信息.职业%Type,
  身份_In           病人信息.身份%Type,
  身份证号_In       病人信息.身份证号%Type,
  出生地点_In       病人信息.出生地点%Type,
  家庭地址_In       病人信息.家庭地址%Type,
  家庭地址邮编_In   病人信息.家庭地址邮编%Type,
  家庭电话_In       病人信息.家庭电话%Type,
  户口地址_In       病人信息.户口地址%Type,
  户口地址邮编_In   病人信息.户口地址邮编%Type,
  联系人姓名_In     病人信息.联系人姓名%Type,
  联系人关系_In     病人信息.联系人关系%Type,
  联系人地址_In     病人信息.联系人地址%Type,
  联系人电话_In     病人信息.联系人电话%Type,
  工作单位_In       病人信息.工作单位%Type,
  合同单位id_In     病人信息.合同单位id%Type,
  单位电话_In       病人信息.单位电话%Type,
  单位邮编_In       病人信息.单位邮编%Type,
  单位开户行_In     病人信息.单位开户行%Type,
  单位帐号_In       病人信息.单位帐号%Type,
  担保人_In         病人信息.担保人%Type,
  担保额_In         病人信息.担保额%Type,
  担保性质_In       病人信息.担保性质%Type,
  主页id_In         病案主页.主页id%Type,
  入院科室id_In     病案主页.入院科室id%Type,
  护理等级id_In     病案主页.护理等级id%Type,
  入院病况_In       病案主页.入院病况%Type,
  入院方式_In       病案主页.入院方式%Type,
  住院目的_In       病案主页.住院目的%Type,
  二级院转入_In     病案主页.二级院转入%Type,
  门诊医师_In       病案主页.门诊医师%Type,
  籍贯_In           病人信息.籍贯%Type,
  区域_In           病案主页.区域%Type,
  入院时间_In       病案主页.入院日期%Type,
  付款方式_In       病案主页.医疗付款方式%Type,
  疾病id_In         病人诊断记录.疾病id%Type,
  诊断id_In         病人诊断记录.诊断id%Type,
  门诊诊断_In       病人诊断记录.诊断描述%Type,
  中医疾病id_In     病人诊断记录.疾病id%Type,
  中医诊断id_In     病人诊断记录.诊断id%Type,
  中医诊断_In       病人诊断记录.诊断描述%Type,
  操作员编号_In     病案主页.编目员编号%Type,
  操作员姓名_In     病案主页.编目员姓名%Type,
  备注_In           病案主页.备注%Type,
  病区id_In         病案主页.入院病区id%Type,
  再入院_In         病案主页.再入院%Type,
  入院属性_In       病案主页.入院属性%Type := Null,
  其他证件_In       病人信息.其他证件%Type := Null,
  病人类型_In       病案主页.病人类型%Type := Null,
  联系人身份证号_In 病人信息.联系人身份证号%Type := Null,
  手机号_In         病人信息.手机号%Type := Null
) As
  -----------------------------------------------------------
  --说明：本函数仅用于入院未入科登记病人信息的修改
  --      登记模式_IN=0-正常登记,1-预约登记
  --      病区ID_IN=只有当病区管理病床模式下,入院时入科时,才会有值
  --      住院号_IN = 病人性质为 门诊留观时 住院号_In 为病人门诊号
  -----------------------------------------------------------
  v_病人性质 病案主页.病人性质%Type;
  v_Count    Number;
  v_Date     Date;
  v_Error    Varchar2(255);
  Err_Custom Exception;
Begin
  --判断病人是否锁定
  Select Count(病人id) Into v_Count From 病人信息 Where 病人id = 病人id_In;
  If v_Count <> 0 Then
    Zl_病人信息_锁定检查(病人id_In);
  End If;
  --判断病人是否未入院
  Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In And 状态 = 1;
  If v_Count = 0 Then
    v_Error := '病人当前不处于等待入科状态，操作不能继续！' || Chr(13) || Chr(10) || '可能该病人已经被其它操作员取消登记或分配床位。';
    Raise Err_Custom;
  End If;

  Select Sysdate Into v_Date From Dual;
  Select 病人性质 Into v_病人性质 From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;

  --病人基本信息
  --非第一次入院时,门诊费别保持不变,除非是门诊留观病人

  Update 病人信息
  Set 住院号 = Decode(v_病人性质, 1, 住院号, 2, 住院号, 住院号_In), 门诊号 = Decode(v_病人性质, 1, 住院号_In, 门诊号), 姓名 = 姓名_In, 性别 = 性别_In,
      年龄 = 年龄_In, 医疗付款方式 = 付款方式_In, 费别 = Decode(v_病人性质, 1, 费别_In, 费别), 出生日期 = 出生日期_In, 国籍 = 国籍_In, 民族 = 民族_In,
      籍贯 = 籍贯_In, 区域 = 区域_In, 学历 = 学历_In, 婚姻状况 = 婚姻状况_In, 职业 = 职业_In, 身份 = 身份_In, 身份证号 = 身份证号_In, 出生地点 = 出生地点_In,
      家庭地址 = 家庭地址_In, 家庭地址邮编 = 家庭地址邮编_In, 家庭电话 = 家庭电话_In, 户口地址 = 户口地址_In, 户口地址邮编 = 户口地址邮编_In, 联系人姓名 = 联系人姓名_In,
      联系人关系 = 联系人关系_In, 联系人地址 = 联系人地址_In, 联系人电话 = 联系人电话_In, 联系人身份证号 = 联系人身份证号_In, 工作单位 = 工作单位_In,
      合同单位id = Decode(合同单位id_In, 0, Null, 合同单位id_In), 单位电话 = 单位电话_In, 单位邮编 = 单位邮编_In, 单位开户行 = 单位开户行_In, 单位帐号 = 单位帐号_In,
      担保人 = 担保人_In, 担保额 = Decode(担保额_In, 0, Null, 担保额_In), 担保性质 = 担保性质_In, 其他证件 = 其他证件_In, 手机号 = 手机号_In
  Where 病人id = 病人id_In;

  If 登记模式_In = 0 Then
    --病案信息
    Update 病人信息
    Set 当前病区id = 病区id_In, 当前科室id = 入院科室id_In, 入院时间 = 入院时间_In, 出院时间 = Null
    Where 病人id = 病人id_In;
  End If;

  Begin
    --在院病人  
    If 登记模式_In = 0 Then
      Update 在院病人 Set 病区id = Nvl(病区id_In, 0), 科室id = 入院科室id_In Where 病人id = 病人id_In;
      If Sql%RowCount = 0 Then
        Insert Into 在院病人
          (病人id, 科室id, 病区id, 主页id)
        Values
          (病人id_In, 入院科室id_In, Nvl(病区id_In, 0), Nvl(主页id_In, 0));
      End If;
    End If;
  Exception
    When Others Then
      Null;
  End;

  --修改病案主页
  Update 病案主页
  Set 住院号 = Decode(v_病人性质, 1, Null, 2, Null, 住院号_In), 留观号 = Decode(v_病人性质, 2, 住院号_In, Null), 费别 = 费别_In,
      入院病区id = 病区id_In, 入院科室id = 入院科室id_In, 入院日期 = 入院时间_In, 入院病况 = 入院病况_In, 入院方式 = 入院方式_In, 入院属性 = 入院属性_In,
      二级院转入 = 二级院转入_In, 住院目的 = 住院目的_In, 当前病况 = 入院病况_In, 当前病区id = 病区id_In, 护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In),
      出院科室id = 入院科室id_In, 门诊医师 = 门诊医师_In, 编目员编号 = 操作员编号_In, 编目员姓名 = 操作员姓名_In, 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = 年龄_In,
      婚姻状况 = 婚姻状况_In, 职业 = 职业_In, 国籍 = 国籍_In, 学历 = 学历_In, 单位电话 = 单位电话_In, 单位邮编 = 单位邮编_In, 单位地址 = 工作单位_In, 区域 = 区域_In,
      家庭地址 = 家庭地址_In, 家庭电话 = 家庭电话_In, 家庭地址邮编 = 家庭地址邮编_In, 户口地址 = 户口地址_In, 户口地址邮编 = 户口地址邮编_In, 联系人姓名 = 联系人姓名_In,
      联系人关系 = 联系人关系_In, 联系人地址 = 联系人地址_In, 联系人电话 = 联系人电话_In, 联系人身份证号 = 联系人身份证号_In, 医疗付款方式 = 付款方式_In, 备注 = 备注_In,
      登记人 = 操作员姓名_In, 登记时间 = v_Date, 再入院 = 再入院_In, 病人类型 = 病人类型_In
  Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);

  If 登记模式_In = 0 Then
    --医保号
    If 医保号_In Is Not Null Then
      Update 病案主页从表 Set 信息值 = 医保号_In Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '医保号';
      If Sql%RowCount = 0 Then
        Insert Into 病案主页从表 (病人id, 主页id, 信息名, 信息值) Values (病人id_In, 主页id_In, '医保号', 医保号_In);
      End If;
    Else
      Delete From 病案主页从表 Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '医保号';
    End If;
  
    --修改病人变动记录(肯定为入院变动;单独入科的不准修改,入院同时入科的病人界面程序禁止修改)
    Update 病人变动记录
    Set 开始时间 = 入院时间_In, 病区id = 病区id_In, 科室id = 入院科室id_In, 护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In), 病情 = 入院病况_In,
        操作员编号 = 操作员编号_In, 操作员姓名 = 操作员姓名_In, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始原因 = 1;
  
    --同步处理病人自动计算
    Update 病人自动计算 
    Set 开始时间 = 入院时间_In, 病区id = 病区id_In, 科室id = 入院科室id_In, 护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In), 
        操作员编号 = 操作员编号_In, 操作员姓名 = 操作员姓名_In, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始原因 = 1;
    
    --处理门诊诊断
    If 门诊诊断_In Is Null And 疾病id_In Is Null Then
      Delete From 病人诊断记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 = 1 And 记录来源 = 2;
    Else
      Update 病人诊断记录
      Set 疾病id = 疾病id_In, 诊断id = 诊断id_In, 诊断描述 = 门诊诊断_In, 记录日期 = Sysdate, 记录人 = 操作员姓名_In
      Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 = 1 And 记录来源 = 2;
      If Sql%RowCount = 0 Then
        Insert Into 病人诊断记录
          (ID, 病人id, 主页id, 记录来源, 诊断类型, 诊断次序, 疾病id, 诊断id, 诊断描述, 记录日期, 记录人)
        Values
          (病人诊断记录_Id.Nextval, 病人id_In, 主页id_In, 2, 1, 1, 疾病id_In, 诊断id_In, 门诊诊断_In, Sysdate, 操作员姓名_In);
      End If;
    End If;
  
    --处理中医诊断
    If 中医诊断_In Is Null And 中医疾病id_In Is Null Then
      Delete From 病人诊断记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 = 11 And 记录来源 = 2;
    Else
      Update 病人诊断记录
      Set 疾病id = 中医疾病id_In, 诊断id = 中医诊断id_In, 诊断描述 = 中医诊断_In, 记录日期 = Sysdate, 记录人 = 操作员姓名_In
      Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 = 11 And 记录来源 = 2;
      If Sql%RowCount = 0 Then
        Insert Into 病人诊断记录
          (ID, 病人id, 主页id, 记录来源, 诊断类型, 诊断次序, 疾病id, 诊断id, 诊断描述, 记录日期, 记录人)
        Values
          (病人诊断记录_Id.Nextval, 病人id_In, 主页id_In, 2, 11, 1, 中医疾病id_In, 中医诊断id_In, 中医诊断_In, Sysdate, 操作员姓名_In);
      End If;
    End If;
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_入院病案主页_Update;
/

--105919:廖思奇,2017-04-10,105919,195929一起处理，调整制片回退的处理
Create Or Replace Procedure Zl_病理制片_退回
(
  Id_In         病理制片信息.Id%Type,
  病理医嘱id_In 病理检查信息.病理医嘱id%Type,
  回退类型_In   Number,
  新制片状态_In Number
) Is
  --回退类型_In: 0  对已接受的回退        1： 对已完成的回退
  --新制片状态_In: 1制片状态应该设置为1   2制片状态应设置为2
  n_Count Number(18); --一个申请信息可能对应多个制片信息，只有同一个申请ID的当前状态一致，才修改申请信息.申请状态
  n_Rid   病理申请信息.申请id%Type;
Begin

  Select Max(申请id) Into n_Rid From 病理制片信息 Where ID = Id_In;
  --更新病理制片状态（0-已申请，1-已接受，2-已完成）
  If 回退类型_In = 0 Then
    --已接受回退到未处理
    Update 病理制片信息 Set 当前状态 = 0, 制片时间 = Null, 制片人 = Null Where ID = Id_In;
  
    If n_Rid > 0 Then
      Select Count(*) Into n_Count From 病理制片信息 Where 申请id = n_Rid And 当前状态 <> 0;
      If n_Count <= 0 Then
        Update 病理申请信息 Set 申请状态 = 0 Where 申请id = n_Rid;
      End If;
    End If;
  
  Else
    --已完成回退到已接受
    Update 病理制片信息 Set 当前状态 = 1, 制片时间 = Null Where ID = Id_In;
  
    If n_Rid > 0 Then
      Update 病理申请信息 Set 申请状态 = 1 Where 申请id = n_Rid;
    End If;
  End If;

  Update 病理检查信息 Set 制片过程 = 新制片状态_In Where 病理医嘱id = 病理医嘱id_In;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病理制片_退回;
/

--105919:廖思奇,2017-04-10,105919,195929一起处理，调整取材回退的处理
Create Or Replace Procedure Zl_病理取材_退回
(
  材块id_In 病理取材信息.材块id%Type
) Is
  n_Count Number(18);
  n_Rid   Number(18);
Begin

  Update 病理取材信息 Set 确认状态 = 0 Where 材块id = 材块id_In;

  Select Max(申请id) Into n_Rid From 病理取材信息 Where 材块id = 材块id_In;
  If n_Rid > 0 Then
    Select Count(*) Into n_Count From 病理取材信息 Where 申请id = n_Rid And 确认状态 <> 0;
    If n_Count <= 0 Then
      Update 病理申请信息 Set 申请状态 = 0 Where 申请id = n_Rid;
    End If;
  End If;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病理取材_退回;
/


--107950:涂建华,2017-04-10,病历格式报告的病人基本信息调整提示
CREATE OR REPLACE Procedure Zl_病人信息_基本信息调整_PACS
( 
  病人id_In 病人信息变动.病人id%Type, 
  就诊id_In Varchar2, --门诊病人为挂号ID;住院病人为主页ID;体检病人为体检单号 
  姓名_In   病人信息.姓名%Type, 
  性别_In   病人信息.性别%Type, 
  年龄_In   病人信息.年龄%Type, 
  场合_In   Number,--1-门诊;2-住院;3-体检 
  说明_Out  Out 病人信息变动.说明%type --出参 
) As 
  Cursor c_AdviceID1 is select a.id as 医嘱id from 病人医嘱记录 a, 影像检查记录 b 
                      where a.id=b.医嘱id and a.挂号单=(select NO from 病人挂号记录 where id=to_number(就诊id_In)) and a.相关id is null; --门诊 
  Cursor c_AdviceID2 is Select a.id as 医嘱id from 病人医嘱记录 a, 影像检查记录 b 
                      where a.id=b.医嘱id and a.病人id=病人id_In and a.主页id=to_number(就诊id_In) and a.相关id is null;     --住院 
  Cursor c_AdviceID3 is Select a.id as 医嘱id from 病人医嘱记录 a where a.挂号单=就诊id_In and a.病人id=病人id_In and a.病人来源=4;    --体检 
  Err_Custom Exception; 
  V_Error Varchar2(2000); 
  v_执行科室 部门表.名称%type;  --当前医嘱的执行科室 
  v_所有执行科室组合 Varchar2(2000);--多条医嘱时，所有的执行科室 
  v_项目名称 诊疗项目目录.名称%type;  --当前医嘱对应的项目名称 
  v_执行项目名称组合 Varchar2(2000);--多条医嘱是，所有的项目名称 
  n_Type Number(1);        --签名类型：1，数字签名、2，电子签名 
Begin 
  --当有电子签名时，所有记录不能修改 
  if 场合_In= 1 then  --门诊 
    For Row_Cols1 In c_AdviceID1 Loop 
      begin 
        select 签名类型 into n_Type 
        from(Select substr(对象属性,1,1) as 签名类型 From 电子病历内容 Where 对象类型= 8 And 文件ID=(Select 病历ID From 病人医嘱报告 Where 医嘱ID= Row_Cols1.医嘱id) order by 签名类型 desc) 
        where rownum=1; 
 
        select 名称 into v_项目名称 from 诊疗项目目录 where id=(select 诊疗项目id from 病人医嘱记录 where id=Row_Cols1.医嘱id); 
      Exception 
      When Others Then 
        null; 
      end; 
 
      if n_Type is not null then 
        if n_Type=1 then 
          v_执行项目名称组合:=v_执行项目名称组合||'、'||v_项目名称; 
        elsif n_Type=2 then 
          V_Error:='病人【'||姓名_In||'】的 '||v_项目名称||' 项目已进行过电子签名，不能进行病人信息修改操作！'; 
          Raise Err_Custom; 
        End if; 
      end if; 
    end loop; 
  elsif 场合_In=2 then  --住院 
    For Row_Cols2 In c_AdviceID2 Loop 
      begin 
        select 签名类型 into n_Type 
        from(Select substr(对象属性,1,1) as 签名类型 From 电子病历内容 Where 对象类型= 8 And 文件ID=(Select 病历ID From 病人医嘱报告 Where 医嘱ID= Row_Cols2.医嘱id) order by 签名类型 desc) 
        where rownum=1; 
 
        select 名称 into v_项目名称 from 诊疗项目目录 where id=(select 诊疗项目id from 病人医嘱记录 where id=Row_Cols2.医嘱id); 
      Exception 
      When Others Then 
        null; 
      end; 
 
      if n_Type is not null then 
        if n_Type=1 then 
          v_执行项目名称组合:=v_执行项目名称组合||'、'||v_项目名称; 
        elsif n_Type=2 then 
          V_Error:='病人【'||姓名_In||'】的 '||v_项目名称||' 项目已进行过电子签名，不能进行病人信息修改操作！'; 
          Raise Err_Custom; 
        End if; 
      end if; 
    end loop; 
  elsif 场合_In=3 then  --体检 
    For Row_Cols3 In c_AdviceID3 Loop 
      begin 
        select 签名类型 into n_Type 
        from(Select substr(对象属性,1,1) as 签名类型 From 电子病历内容 Where 对象类型= 8 And 文件ID=(Select 病历ID From 病人医嘱报告 Where 医嘱ID= Row_Cols3.医嘱id) order by 签名类型 desc) 
        where rownum=1; 
 
        select 名称 into v_项目名称 from 诊疗项目目录 where id=(select 诊疗项目id from 病人医嘱记录 where id=Row_Cols3.医嘱id); 
      Exception 
      When Others Then 
        null; 
      end; 
 
      if n_Type is not null then 
        if n_Type=1 then 
          v_执行项目名称组合:=v_执行项目名称组合||'、'||v_项目名称; 
        elsif n_Type=2 then 
          V_Error:='病人【'||姓名_In||'】的 '||v_项目名称||' 项目已进行过电子签名，不能进行病人信息修改操作！'; 
          Raise Err_Custom; 
        End if; 
      end if; 
    end loop; 
  end if; 
 
  --修改信息 
  if 场合_In= 1 then  --门诊 
    For Row_Cols1 In c_AdviceID1 Loop 
       Begin
         Update 影像检查记录 Set 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = Decode(年龄_In, Null, 年龄, 年龄_In) Where 医嘱id=Row_Cols1.医嘱id; 
 
         Select 名称 Into v_执行科室 from 部门表 where id=(select 执行科室id from 影像检查记录 where 医嘱id=Row_Cols1.医嘱id); 
       Exception 
         When Others Then 
           null; 
       End;

       if nvl(instr(v_所有执行科室组合,v_执行科室),0)<=0 then 
         v_所有执行科室组合:=v_所有执行科室组合||','||v_执行科室; 
       end if; 
    end loop; 
  elsif 场合_In=2 then  --住院 
    For Row_Cols2 In c_AdviceID2 Loop 
      Begin
        Update 影像检查记录 Set 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = Decode(年龄_In, Null, 年龄, 年龄_In) Where 医嘱id=Row_Cols2.医嘱id; 
 
        Select 名称 Into v_执行科室 from 部门表 where id=(select 执行科室id from 影像检查记录 where 医嘱id=Row_Cols2.医嘱id); 
      Exception 
        When Others Then 
          null; 
      End;

      if nvl(instr(v_所有执行科室组合,v_执行科室),0)<=0 then 
        v_所有执行科室组合:=v_所有执行科室组合||','||v_执行科室; 
      end if; 
    end loop; 
  elsif 场合_In=3 then --体检 
    For Row_Cols3 In c_AdviceID3 Loop 
      Begin
         Update 影像检查记录 Set 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = Decode(年龄_In, Null, 年龄, 年龄_In) Where 医嘱id=Row_Cols3.医嘱id; 
 
         Select 名称 Into v_执行科室 from 部门表 where id=(select 执行科室id from 影像检查记录 where 医嘱id=Row_Cols3.医嘱id); 
      Exception 
         When Others Then 
            null; 
      End;
      
      if nvl(instr(v_所有执行科室组合,v_执行科室),0)<=0 then 
        v_所有执行科室组合:=v_所有执行科室组合||','||v_执行科室; 
      end if; 
    end loop; 
  end if; 
 
  if nvl(v_执行项目名称组合,' ')<>' ' then 
     说明_Out:=substr(v_所有执行科室组合,2)||':【'||姓名_In||'】的【'|| substr(v_执行项目名称组合,2) ||'】对应检查报告已签名，需要手工调整！'; 
  else
     说明_Out:=substr(v_所有执行科室组合,2)||':【'||姓名_In||'】的基本信息已修改！'; 
  end if;
Exception 
  When Err_Custom Then 
    Raise_Application_Error(-20101, '[ZLSOFT]' || V_Error || '[ZLSOFT]'); 
  When Others Then 
    Zl_Errorcenter(Sqlcode, Sqlerrm); 
End Zl_病人信息_基本信息调整_PACS;
/

--106122:陈刘,2017-04-10,专科体温单时间计算以第一个体温单开始时间记数

CREATE OR REPLACE Function Zl_Calcindaysnew
(
  文件id_In   In 病人护理文件.Id%Type,
  病人id_In   In 病案主页.病人id%Type,
  主页id_In   In 病案主页.主页id%Type,
  住院日期_In In Date := Sysdate --指定某一具体日期时的住院天数
) Return Number As

  d_入院时间 病案主页.入院日期%Type;
  d_出院时间 病案主页.出院日期%Type;
  d_开始时间 病人护理文件.开始时间%Type;
  n_Days     Number(18);
  n_Bady     Number(18);
  n_Badybill Number(18);
  n_Addday   Number(18);
Begin

  n_Days     := 0;
  n_Bady     := 0;
  n_Badybill := 0;
  n_Addday   := 1;
  d_入院时间 := Null;
  d_出院时间 := Null;
  d_开始时间 := Null;
  --提取体温单开始时间
  Begin
    Select 婴儿 Into n_Bady From 病人护理文件 Where ID = 文件id_In;
  Exception
    When Others Then
      n_Bady := 0;
  End;
  --提取第一个体温单的开始时间,106122-CL-2017-04-10
  Begin
    Select 开始时间
    Into d_开始时间
    From (Select 开始时间 From 病人护理文件 Where 病人id = 病人id_In And 主页id = 主页id_In Order By 开始时间)
    Where Rownum < 2;
  Exception
    When Others Then
      d_开始时间 := Null;
  End;

  --如果是婴儿开始时间以出生时间为准
  If n_Bady <> 0 Then
    Begin
      Select a.出生时间
      Into d_入院时间
      From 病人新生儿记录 A
      Where a.病人id = 病人id_In And a.主页id = 主页id_In And a.序号 = n_Bady;
    Exception
      When Others Then
        d_入院时间 := d_开始时间;
    End;
    n_Badybill := Nvl(zl_GetSysParameter('婴儿体温单首日天数显示0', 1255), 0);
  End If;

  If d_入院时间 Is Null Then
    d_入院时间 := d_开始时间;
  End If;

  --提取体温单的实际结束时间
  Begin
    Select Decode(Sign(a.出院时间 - b.发生时间), 1, a.出院时间, b.发生时间)
    Into d_出院时间
    From (Select Max(Nvl(终止时间, Sysdate)) As 出院时间, Max(病人id) 病人id, Max(主页id) 主页id
           From 病人变动记录
           Where 开始时间 Is Not Null And 病人id = 病人id_In And 主页id = 主页id_In) A,
         (Select Nvl(发生时间, Sysdate) 发生时间, 病人id, 主页id
           From (Select Max(发生时间) 发生时间, Max(a.病人id) 病人id, Max(a.主页id) 主页id
                  From 病人护理文件 A, 病人护理数据 B
                  Where a.Id = b.文件id And a.Id = 文件id_In)) B
    Where a.病人id = b.病人id And a.主页id = b.主页id;

  Exception
    When Others Then
      d_出院时间 := Sysdate;
  End;

  If n_Badybill = 1 Then
    n_Addday := 0;
  Else
    n_Addday := 1;
  End If;

  If d_入院时间 Is Not Null Then
    If Trunc(住院日期_In) > Trunc(d_出院时间) Then
      Select Trunc(d_出院时间) - Trunc(d_入院时间) + n_Addday Into n_Days From Dual;
    Else
      Select Trunc(住院日期_In) - Trunc(d_入院时间) + n_Addday Into n_Days From Dual;
    End If;
  End If;

  Return(n_Days);
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Calcindaysnew;
/

--106708:冉俊明,2017-04-07,违反规范，调整
Drop Procedure Zl_Buildregisterfixedrule;

--106708:冉俊明,2017-04-07,违反规范，调整
Create Or Replace Procedure Zl_临床出诊表_Addbyfixedrule
(
  Id_In         临床出诊表.Id%Type,
  Newid_In      临床出诊表.Id%Type,
  出诊表名_In   临床出诊表.出诊表名%Type,
  开始时间_In   临床出诊安排.开始时间%Type,
  终止时间_In   临床出诊安排.终止时间%Type,
  操作员姓名_In 临床出诊安排.操作员姓名%Type := Null,
  登记时间_In   临床出诊安排.登记时间%Type := Null,
  站点_In       部门表.站点%Type
) As
  -------------------------------------------------------------------------
  --功能：根据现有固定出诊表规则生成成新的固定出诊表
  -------------------------------------------------------------------------
  n_Count Number;

  n_出诊id 临床出诊表.Id%Type;

  v_操作员   临床出诊安排.操作员姓名%Type;
  d_登记时间 Date;
  v_Err_Msg  Varchar2(255);
  Err_Item Exception;
Begin
  Begin
    Select 1 Into n_Count From 临床出诊表 Where ID = Id_In;
  Exception
    When Others Then
      n_Count := 0;
  End;
  If n_Count = 0 Then
    v_Err_Msg := '未发现原出诊表信息！';
    Raise Err_Item;
  End If;

  --检查是否有有效号源
  Begin
    Select 1
    Into n_Count
    From 临床出诊号源 A, 部门表 B, 人员表 C, 收费项目目录 D
    Where a.科室id = b.Id And a.医生id = c.Id(+) And a.项目id = d.Id And a.排班方式 = 0 And Nvl(a.是否删除, 0) = 0 And
          (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
          Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd')
         --站点
          And (b.站点 Is Null Or b.站点 = 站点_In) And Rownum < 2;
  Exception
    When Others Then
      n_Count := 0;
  End;
  If Nvl(n_Count, 0) = 0 Then
    v_Err_Msg := '当前出诊表中已无可按固定排班的号源，不能生成新的固定安排！';
    Raise Err_Item;
  End If;

  n_出诊id := Newid_In;
  If Nvl(n_出诊id, 0) = 0 Then
    Select 临床出诊表_Id.Nextval Into n_出诊id From Dual;
  End If;

  Insert Into 临床出诊表
    (ID, 排班方式, 出诊表名, 年份)
  Values
    (n_出诊id, 0, 出诊表名_In, To_Number(To_Char(开始时间_In, 'yyyy')));

  d_登记时间 := Nvl(登记时间_In, Sysdate);
  v_操作员   := Nvl(操作员姓名_In, Zl_Username);

  For c_号源 In (Select 临床出诊安排_Id.Nextval As 安排id, n_出诊id As 出诊id, 原安排id, 号源id, 项目id, 医生id, 医生姓名
               From (Select b.Id As 原安排id, b.号源id, c.项目id, c.医生id, c.医生姓名,
                             Row_Number() Over(Partition By c.Id Order By b.开始时间 Desc) As 组号
                      From 临床出诊安排 B, 临床出诊号源 C, 部门表 D, 人员表 E, 收费项目目录 F
                      Where b.号源id = c.Id And c.科室id = d.Id And c.医生id = e.Id(+) And c.项目id = f.Id And b.出诊id = Id_In
                           --号源限制
                            And c.排班方式 = 0 And Nvl(c.是否删除, 0) = 0 And
                            (c.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd') Or c.撤档时间 Is Null) And
                            Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                            Nvl(e.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                            Nvl(f.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd')
                           --站点
                            And (d.站点 Is Null Or d.站点 = 站点_In)) M
               Where 组号 = 1) Loop
  
    Insert Into 临床出诊安排
      (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 开始时间, 终止时间, 操作员姓名, 登记时间)
    Values
      (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 开始时间_In, 终止时间_In, v_操作员, d_登记时间);
  
    --出诊限制
    For c_限制 In (Select ID, 安排id, 限制项目, 上班时段, 限号数, 限约数, 是否序号控制, 是否分时段, 预约控制, 分诊方式, 诊室id, 是否独占
                 From 临床出诊限制
                 Where 安排id = c_号源.原安排id) Loop
    
      Zl_临床出诊限制_Copy(c_限制.Id, c_号源.安排id);
    End Loop;
  End Loop;

  --加入没有的出诊安排的号源
  For c_号源 In (Select 临床出诊安排_Id.Nextval As 安排id, n_出诊id As 出诊id, a.Id As 号源id, a.项目id, a.医生id, a.医生姓名
               From 临床出诊号源 A, 部门表 D, 人员表 B, 收费项目目录 C
               Where a.科室id = d.Id And a.医生id = b.Id(+) And a.项目id = c.Id And a.排班方式 = 0 And Nvl(a.是否删除, 0) = 0 And
                     (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
                     Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd')
                    --站点
                     And (d.站点 Is Null Or d.站点 = 站点_In)
                    
                     And Not Exists (Select 1 From 临床出诊安排 Where 出诊id = n_出诊id And 号源id = a.Id)) Loop
  
    Insert Into 临床出诊安排
      (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 开始时间, 终止时间, 操作员姓名, 登记时间)
    Values
      (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 开始时间_In, 终止时间_In, v_操作员, d_登记时间);
  End Loop;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊表_Addbyfixedrule;
/

--106708:冉俊明,2017-04-07,违反规范，调整
Drop Procedure Zl_Buildregisterplanbyrecord;

--106708:冉俊明,2017-04-07,违反规范，调整
Create Or Replace Procedure Zl_临床出诊表_Addbyrecord
(
  原出诊id_In   临床出诊表.Id%Type,
  新出诊id_In   临床出诊表.Id%Type,
  排班方式_In   临床出诊表.排班方式%Type,
  出诊表名_In   临床出诊表.出诊表名%Type,
  年份_In       临床出诊表.年份%Type,
  月份_In       临床出诊表.月份%Type,
  周数_In       临床出诊表.周数%Type,
  开始时间_In   临床出诊安排.开始时间%Type,
  终止时间_In   临床出诊安排.终止时间%Type,
  操作员姓名_In 临床出诊安排.操作员姓名%Type,
  登记时间_In   临床出诊安排.登记时间%Type,
  站点_In       部门表.站点%Type,
  人员id_In     人员表.Id%Type := Null,
  删除安排_In   Number := 0
) As
  -------------------------------------------------------------------------
  --功能：根据出诊记录生成新的出诊记录（月安排/周安排）
  --参数：
  --        人员id_In 除固定安排外有效，不为0或null表示临床科室人员在添加
  --        删除安排_In 固定排班转为月排班/周排班时，在制定月排班/周排班时是否删除新出诊表时间内未使用的出诊记录
  --说明：
  -------------------------------------------------------------------------
  n_Count Number;

  l_记录id t_Numlist := t_Numlist();
  n_安排id 临床出诊安排.Id%Type;

  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  n_跨月周出诊id 临床出诊表.Id%Type;

  Function Get跨月周出诊id(出诊id_In 临床出诊表.Id%Type) Return 临床出诊表.Id%Type Is
    ----------------------------------------
    --如果原周出诊表不是整周(不足7天)，则需要查找到另一个出诊表构成整周
    ----------------------------------------
    n_出诊id 临床出诊表.Id%Type;
    n_年份   临床出诊表.年份%Type;
    n_月份   临床出诊表.月份%Type;
    n_周数   临床出诊表.周数%Type;
  
    d_开始时间 临床出诊安排.开始时间%Type;
    d_结束时间 临床出诊安排.终止时间%Type;
  
    --根据日期计算当月的周数，以及每一周的时间范围
    Cursor c_Weekrange(Date_In Date) Is
      Select Rownum As 周数, 开始日期, 结束日期
      From (With Month_Range As (Select Trunc(Date_In) As First_Day, Last_Day(Trunc(Date_In)) As Last_Day From Dual)
             Select Decode(To_Char(First_Day, 'day'), '星期日', First_Day, Null) As 开始日期,
                    Decode(To_Char(First_Day, 'day'), '星期日', First_Day, Null) As 结束日期
             From Month_Range
             Union All
             Select Decode(Sign(Trunc(First_Day + 7 * Week, 'day') + 1 - First_Day), 1,
                            Trunc(First_Day + 7 * Week, 'day') + 1, First_Day) As 开始日期,
                    Decode(Sign(Trunc(First_Day + 7 * Week, 'day') + 7 - Last_Day), 1, Last_Day,
                            Trunc(First_Day + 7 * Week, 'day') + 7) As 结束日期
             From Month_Range A, (Select Level - 1 As Week From Dual Connect By Level <= 6) B)
             Where 开始日期 <= 结束日期;
  
  
  Begin
    Begin
      Select 年份, 月份, 周数 Into n_年份, n_月份, n_周数 From 临床出诊表 Where ID = 出诊id_In;
    Exception
      When Others Then
        Return 0;
    End;
  
    If n_年份 Is Null Or n_月份 Is Null Or n_周数 Is Null Then
      Return 0;
    End If;
  
    For r_Weekrange In c_Weekrange(To_Date(n_年份 || '-' || n_月份 || '-01', 'yyyy-mm-dd')) Loop
      If r_Weekrange.周数 = n_周数 Then
        d_开始时间 := r_Weekrange.开始日期;
        d_结束时间 := r_Weekrange.结束日期;
        Exit;
      End If;
    End Loop;
  
    If d_开始时间 Is Null Or d_结束时间 Is Null Then
      Return 0;
    End If;
    If Trunc(d_结束时间) - Trunc(d_开始时间) >= 6 Then
      Return 0;
    End If;
  
    --存在跨月的，查找另一个出诊表的年月周
    n_年份 := Null;
    n_月份 := Null;
    n_周数 := Null;
    If Trunc(d_开始时间 - 1, 'month') <> Trunc(d_开始时间, 'month') Then
      --当前是第一周,获取另一个出诊表的年月
      n_年份 := To_Number(To_Char(d_开始时间 - 1, 'yyyy'));
      n_月份 := To_Number(To_Char(d_开始时间 - 1, 'mm'));
    Elsif Trunc(d_结束时间 + 1, 'month') <> Trunc(d_结束时间, 'month') Then
      --当前是最后一周,获取另一个出诊表的年月
      n_年份 := To_Number(To_Char(d_结束时间 + 1, 'yyyy'));
      n_月份 := To_Number(To_Char(d_结束时间 + 1, 'mm'));
      n_周数 := 1;
    Else
      Return 0;
    End If;
  
    --获取跨月的另一个出诊表的ID
    Begin
      Select ID
      Into n_出诊id
      From (Select Rownum As 行号, ID
             From 临床出诊表
             Where Nvl(排班方式, 0) = 2 And 年份 = n_年份 And 月份 = n_月份 And (n_周数 Is Null Or 周数 = n_周数)
             Order By 周数 Desc)
      Where 行号 < 2;
    Exception
      When Others Then
        Return 0;
    End;
  
    Return n_出诊id;
  End;
Begin
  Begin
    Select 1
    Into n_Count
    From 临床出诊号源 A, 部门表 B, 人员表 C, 收费项目目录 D
    Where a.科室id = b.Id And a.医生id = c.Id(+) And a.项目id = d.Id
         --有效号源
          And Nvl(a.是否删除, 0) = 0 And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
          Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          (
          --月排班
           Nvl(排班方式_In, 0) = 1 And a.排班方式 = 1
          --周排班
           Or Nvl(排班方式_In, 0) = 2 And
           (
           --当前出诊表所在时间范围内不能有月排班
            a.排班方式 = 2 And Not Exists
            (Select 1
                From 临床出诊安排 P, 临床出诊表 Q
                Where p.出诊id = q.Id And p.号源id = a.Id And
                      Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 1)
           --当前已调整为了月排班,但是本月又用了周排班，则本月剩下的部分将继续按周进行排班
            Or a.排班方式 = 1 And Exists
            (Select 1
                From 临床出诊安排 P, 临床出诊表 Q
                Where p.出诊id = q.Id And p.号源id = a.Id And
                      Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 2)))
         --号源在该出诊表时间范围内无出诊记录
          And Not Exists
     (Select 1
           From 临床出诊记录 O, 临床出诊安排 P, 临床出诊表 Q
           Where o.安排id = p.Id And p.出诊id = q.Id And p.号源id = a.Id And o.出诊日期 Between 开始时间_In And 终止时间_In And
                 (q.排班方式 In (1, 2)
                 --原来为固定出诊安排
                 Or q.排班方式 = 0 And (Nvl(删除安排_In, 0) = 0 Or Nvl(删除安排_In, 0) = 1 And Exists
                  (Select 1 From 病人挂号记录 Where 出诊记录id = a.Id))))
         --当前人员可操作的号源
          And (Nvl(人员id_In, 0) = 0 Or
          (Nvl(a.是否临床排班, 0) = 1 And Exists (Select 1 From 部门人员 Where 部门id = a.科室id And 人员id = 人员id_In)))
         --站点
          And (b.站点 Is Null Or b.站点 = 站点_In) And Rownum < 2;
  Exception
    When Others Then
      n_Count := 0;
  End;
  If n_Count = 0 Then
    If Nvl(排班方式_In, 0) = 1 Then
      v_Err_Msg := '当前出诊表中已无可按月排班的号源，不能生成新的出诊表！';
    Else
      v_Err_Msg := '当前出诊表中已无可按周排班的号源，不能生成新的出诊表！';
    End If;
    Raise Err_Item;
  End If;

  --检查出诊表是否存在
  Begin
    Select 1 Into n_Count From 临床出诊表 Where ID = 新出诊id_In;
  Exception
    When Others Then
      n_Count := 0;
  End;
  If Nvl(n_Count, 0) = 0 Then
    Insert Into 临床出诊表
      (ID, 排班方式, 出诊表名, 年份, 月份, 周数)
    Values
      (新出诊id_In, 排班方式_In, 出诊表名_In, 年份_In, 月份_In, 周数_In);
  End If;

  --如果当前出诊表时间范围内无挂号且无预约的出诊记录(固定安排)，则删除这部分出诊记录(在删除出诊表时可恢复)，
  --并修改固定安排的终止时间，程序中已询问
  If Nvl(删除安排_In, 0) = 1 Then
    For c_安排 In (Select b.Id As 安排id
                 From 临床出诊安排 B, 临床出诊表 C, 临床出诊号源 D
                 Where b.出诊id = c.Id And b.号源id = d.Id
                      --号源
                       And Nvl(d.是否删除, 0) = 0 And (d.撤档时间 Is Null Or d.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
                       Nvl(d.排班方式, 0) = 排班方式_In
                      --安排有被使用了的出诊记录
                       And c.排班方式 = 0 And b.终止时间 >= 开始时间_In And Not Exists
                  (Select 1
                        From 临床出诊记录 M, 病人挂号记录 N
                        Where m.安排id = b.Id And m.Id = n.出诊记录id And m.出诊日期 >= 开始时间_In)
                      --当前人员可操作的号源
                       And (Nvl(人员id_In, 0) = 0 Or (Nvl(d.是否临床排班, 0) = 1 And Exists
                        (Select 1 From 部门人员 Where 部门id = d.科室id And 人员id = 人员id_In)))) Loop
    
      For c_记录 In (Select ID As 记录id From 临床出诊记录 Where 安排id = c_安排.安排id And 出诊日期 >= 开始时间_In) Loop
        l_记录id.Extend();
        l_记录id(l_记录id.Count) := c_记录.记录id;
      End Loop;
    End Loop;
  
    Zl_临床出诊记录_Batchdelete(l_记录id);
  
  End If;

  --如果原周出诊表不是整周(不足7天)，则需要查找到另一个出诊表构成整周
  If Nvl(排班方式_In, 0) = 2 Then
    n_跨月周出诊id := Get跨月周出诊id(原出诊id_In);
  End If;

  For c_号源 In (Select 新出诊id_In As 出诊id, b.Id As 原安排id, b.号源id, c.项目id, c.医生id, c.医生姓名
               From 临床出诊安排 B, 临床出诊号源 C, 部门表 D, 人员表 E, 收费项目目录 F
               Where b.号源id = c.Id And c.科室id = d.Id And b.医生id = e.Id(+) And c.项目id = f.Id And
                     (b.出诊id = 原出诊id_In Or b.出诊id = n_跨月周出诊id)
                    --有效号源
                     And Nvl(c.是否删除, 0) = 0 And (c.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd') Or c.撤档时间 Is Null) And
                     Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(e.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(f.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     (
                     --月排班
                      Nvl(排班方式_In, 0) = 1 And c.排班方式 = 1
                     -- 周排班
                      Or Nvl(排班方式_In, 0) = 2 And
                      (
                      --当前出诊表所在时间范围内不能有月排班
                       c.排班方式 = 2 And Not Exists
                       (Select 1
                           From 临床出诊安排 P, 临床出诊表 Q
                           Where p.出诊id = q.Id And p.号源id = c.Id And
                                 Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 1)
                      --当前已调整为了月排班,但是本月又用了周排班，则本月剩下的部分将继续按周进行排班
                       Or c.排班方式 = 1 And Exists
                       (Select 1
                           From 临床出诊安排 P, 临床出诊表 Q
                           Where p.出诊id = q.Id And p.号源id = c.Id And
                                 Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 2)))
                    --号源在该出诊表时间范围内无出诊记录
                     And Not Exists
                (Select 1
                      From 临床出诊记录 P
                      Where p.号源id = c.Id And p.出诊日期 Between 开始时间_In And 终止时间_In)
                    --当前人员可操作的号源
                     And (Nvl(人员id_In, 0) = 0 Or (Nvl(c.是否临床排班, 0) = 1 And Exists
                      (Select 1 From 部门人员 Where 部门id = c.科室id And 人员id = 人员id_In)))
                    --站点
                     And (d.站点 Is Null Or d.站点 = 站点_In)) Loop
  
    Begin
      Select ID Into n_安排id From 临床出诊安排 Where 出诊id = c_号源.出诊id And 号源id = c_号源.号源id;
    Exception
      When Others Then
        n_安排id := Null;
    End;
  
    If Nvl(n_安排id, 0) = 0 Then
      Select 临床出诊安排_Id.Nextval Into n_安排id From Dual;
    
      Insert Into 临床出诊安排
        (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 开始时间, 终止时间, 操作员姓名, 登记时间)
      Values
        (n_安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 开始时间_In, 终止时间_In, 操作员姓名_In, 登记时间_In);
    End If;
  
    --出诊记录
    For c_记录 In (Select Decode(b.Id, Null, a.Id, b.Id) As ID, c.日期
                 From 临床出诊记录 A, 临床出诊记录 B,
                      (Select Trunc(开始时间_In) + Level - 1 As 日期
                        From Dual
                        Connect By Level <= Trunc(终止时间_In) - Trunc(开始时间_In) + 1) C
                 Where a.Id = b.相关id(+) And a.安排id = c_号源.原安排id And a.相关id Is Null And Nvl(a.是否临时出诊, 0) = 0
                      --月排班
                       And (Nvl(排班方式_In, 0) = 1 And To_Char(a.出诊日期, 'dd') = To_Char(c.日期, 'dd')
                       --周排班
                       Or Nvl(排班方式_In, 0) = 2 And To_Char(a.出诊日期, 'D') = To_Char(c.日期, 'D'))) Loop
      Zl_临床出诊记录_Copy(c_记录.Id, n_安排id, c_记录.日期, 操作员姓名_In, 登记时间_In);
    End Loop;
  End Loop;

  --加入没有的出诊安排的号源
  For c_号源 In (Select 临床出诊安排_Id.Nextval As 安排id, 新出诊id_In As 出诊id, a.Id As 号源id, a.项目id, a.医生id, a.医生姓名
               From 临床出诊号源 A, 部门表 D, 人员表 E, 收费项目目录 F
               Where a.科室id = d.Id And a.医生id = e.Id(+) And a.项目id = f.Id
                    --有效号源
                     And Nvl(a.是否删除, 0) = 0 And (a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd') Or a.撤档时间 Is Null) And
                     Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(e.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(f.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     (
                     --月排班
                      Nvl(排班方式_In, 0) = 1 And a.排班方式 = 1
                     -- 周排班
                      Or Nvl(排班方式_In, 0) = 2 And
                      (
                      --当前出诊表所在时间范围内不能有月排班
                       a.排班方式 = 2 And Not Exists
                       (Select 1
                           From 临床出诊安排 P, 临床出诊表 Q
                           Where p.出诊id = q.Id And p.号源id = a.Id And
                                 Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 1)
                      --当前已调整为了月排班,但是本月又用了周排班，则本月剩下的部分将继续按周进行排班
                       Or a.排班方式 = 1 And Exists
                       (Select 1
                           From 临床出诊安排 P, 临床出诊表 Q
                           Where p.出诊id = q.Id And p.号源id = a.Id And
                                 Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 2)))
                    --号源在该出诊表时间范围内无出诊记录
                     And Not Exists
                (Select 1
                      From 临床出诊记录 P
                      Where p.号源id = a.Id And p.出诊日期 Between 开始时间_In And 终止时间_In)
                    --当前人员可操作的号源
                     And (Nvl(人员id_In, 0) = 0 Or (Nvl(a.是否临床排班, 0) = 1 And Exists
                      (Select 1 From 部门人员 Where 部门id = a.科室id And 人员id = 人员id_In)))
                    --站点
                     And (d.站点 Is Null Or d.站点 = 站点_In)
                    
                     And Not Exists (Select 1 From 临床出诊安排 Where 出诊id = 新出诊id_In And 号源id = a.Id)) Loop
  
    Insert Into 临床出诊安排
      (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 开始时间, 终止时间, 操作员姓名, 登记时间)
    Values
      (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 开始时间_In, 终止时间_In, 操作员姓名_In, 登记时间_In);
  End Loop;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊表_Addbyrecord;
/

--106708:冉俊明,2017-04-07,违反规范，调整
Drop Procedure Zl_Buildregisterplanbytemplet;

--106708:冉俊明,2017-04-07,违反规范，调整
Create Or Replace Procedure Zl_临床出诊表_Addbytemplet
(
  模板id_In   临床出诊表.Id%Type,
  人员id_In   人员表.Id%Type,
  出诊id_In   临床出诊表.Id%Type,
  排班方式_In 临床出诊表.排班方式%Type,
  出诊表名_In 临床出诊表.出诊表名%Type,
  年份_In     临床出诊表.年份%Type,
  月份_In     临床出诊表.月份%Type,
  周数_In     临床出诊表.周数%Type,
  开始时间_In 临床出诊安排.开始时间%Type,
  终止时间_In 临床出诊安排.终止时间%Type,
  操作员_In   临床出诊安排.操作员姓名%Type,
  登记时间_In 临床出诊安排.登记时间%Type,
  站点_In     部门表.站点%Type,
  删除安排_In Number := 0
) As
  -------------------------------------------------------------------------
  --功能说明：根据模板自动生成临床出诊记录
  --参数：
  --        人员id_In 除固定安排外有效，不为0或null表示临床科室人员在添加
  --        删除安排_In 固定排班转为月排班/周排班时，在制定月排班/周排班时是否删除新出诊表时间内未使用的出诊记录
  --说明：
  -------------------------------------------------------------------------
  Err_Item Exception;
  v_Err_Msg Varchar2(200);
  n_Count   Number(18);

  d_轮询日期 Date;
  n_轮询天数 Number;
  v_限制项目 临床出诊限制.限制项目%Type;

  n_是否出诊 Number(2);
  d_开始时间 临床出诊记录.开始时间%Type;

  l_记录id t_Numlist := t_Numlist();

  Procedure Isvisit
  (
    安排id_In       临床出诊安排.Id%Type,
    排班规则_In     临床出诊安排.排班规则%Type,
    出诊日期_In     临床出诊记录.出诊日期%Type,
    轮询开始时间_In 临床出诊安排.开始时间%Type,
    限制项目_In     Out 临床出诊限制.限制项目%Type,
    是否出诊_In     Out Number
  ) As
    --判断是否出诊，并获取出诊项目
    d_轮询日期 Date;
    n_轮询天数 Number;
  Begin
    是否出诊_In := 1;
    --检查这天是否出诊
    If 排班规则_In = 1 Then
      --星期排班
      Select Decode(To_Char(出诊日期_In, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7', '周六',
                     Null)
      Into 限制项目_In
      From Dual;
      Select Count(1) Into n_Count From 临床出诊限制 Where 安排id = 安排id_In And 限制项目 = 限制项目_In;
      If Nvl(n_Count, 0) = 0 Then
        是否出诊_In := 0;
      End If;
    Elsif 排班规则_In = 2 Then
      --单日排班
      限制项目_In := '单日';
      If Mod(To_Number(To_Char(出诊日期_In, 'dd')), 2) <> 1 Then
        是否出诊_In := 0;
      End If;
    Elsif 排班规则_In = 3 Then
      --双日排班
      限制项目_In := '双日';
      If Mod(To_Number(To_Char(出诊日期_In, 'dd')), 2) <> 0 Then
        是否出诊_In := 0;
      End If;
    Elsif 排班规则_In = 4 Or 排班规则_In = 5 Then
      --4-月内轮循,5-轮循不限制
      If 排班规则_In = 4 Then
        d_轮询日期 := To_Date(To_Char(出诊日期_In, 'yyyy-mm') || To_Char(轮询开始时间_In, '-dd'), 'yyyy-mm-dd');
      Else
        d_轮询日期 := 轮询开始时间_In;
      End If;
      Begin
        Select To_Number(Substr(限制项目, 1, Instr(限制项目, '天') - 1))
        Into n_轮询天数
        From 临床出诊限制
        Where 安排id = 安排id_In And Rownum < 2;
      Exception
        When Others Then
          n_轮询天数 := 0;
      End;
      If Nvl(n_轮询天数, 0) > 0 Then
        限制项目_In := n_轮询天数 || '天';
        If Mod(Trunc(出诊日期_In) - Trunc(d_轮询日期), n_轮询天数 + 1) <> 0 Then
          是否出诊_In := 0;
        End If;
      End If;
    Elsif 排班规则_In = 6 Then
      --特定日期
      限制项目_In := To_Number(To_Char(出诊日期_In, 'dd')) || '日';
      Select Count(1) Into n_Count From 临床出诊限制 Where 安排id = 安排id_In And 限制项目 = 限制项目_In;
      If Nvl(n_Count, 0) = 0 Then
        是否出诊_In := 0;
      End If;
    End If;
  End;
Begin
  Begin
    Select 1
    Into n_Count
    From 临床出诊号源 A, 部门表 B, 人员表 C, 收费项目目录 D
    Where a.科室id = b.Id And a.医生id = c.Id(+) And a.项目id = d.Id
         --有效号源
          And Nvl(a.是否删除, 0) = 0 And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
          Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          (
          --月排班
           Nvl(排班方式_In, 0) = 1 And a.排班方式 = 1
          --周排班
           Or Nvl(排班方式_In, 0) = 2 And
           (
           --当前出诊表所在时间范围内不能有月排班
            a.排班方式 = 2 And Not Exists
            (Select 1
                From 临床出诊安排 P, 临床出诊表 Q
                Where p.出诊id = q.Id And p.号源id = a.Id And
                      Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 1)
           --当前已调整为了月排班,但是本月又用了周排班，则本月剩下的部分将继续按周进行排班
            Or a.排班方式 = 1 And Exists
            (Select 1
                From 临床出诊安排 P, 临床出诊表 Q
                Where p.出诊id = q.Id And p.号源id = a.Id And
                      Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 2)))
         --号源在该出诊表时间范围内无出诊记录
          And Not Exists
     (Select 1
           From 临床出诊记录 O, 临床出诊安排 P, 临床出诊表 Q
           Where o.安排id = p.Id And p.出诊id = q.Id And p.号源id = a.Id And o.出诊日期 Between 开始时间_In And 终止时间_In And
                 (q.排班方式 In (1, 2)
                 --原来为固定出诊安排
                 Or q.排班方式 = 0 And (Nvl(删除安排_In, 0) = 0 Or Nvl(删除安排_In, 0) = 1 And Exists
                  (Select 1 From 病人挂号记录 Where 出诊记录id = a.Id))))
         --当前人员可操作的号源
          And (Nvl(人员id_In, 0) = 0 Or
          (Nvl(a.是否临床排班, 0) = 1 And Exists (Select 1 From 部门人员 Where 部门id = a.科室id And 人员id = 人员id_In)))
         --站点
          And (b.站点 Is Null Or b.站点 = 站点_In) And Rownum < 2;
  Exception
    When Others Then
      n_Count := 0;
  End;
  If n_Count = 0 Then
    If Nvl(排班方式_In, 0) = 1 Then
      v_Err_Msg := '当前出诊表中已无可按月排班的号源，不能生成新的出诊表！';
    Else
      v_Err_Msg := '当前出诊表中已无可按周排班的号源，不能生成新的出诊表！';
    End If;
    Raise Err_Item;
  End If;

  --检查出诊表是否存在
  Begin
    Select 1 Into n_Count From 临床出诊表 Where ID = 出诊id_In;
  Exception
    When Others Then
      n_Count := 0;
  End;
  If Nvl(n_Count, 0) = 0 Then
    Insert Into 临床出诊表
      (ID, 排班方式, 出诊表名, 年份, 月份, 周数)
    Values
      (出诊id_In, 排班方式_In, 出诊表名_In, 年份_In, 月份_In, 周数_In);
  End If;

  --如果当前出诊表时间范围内无挂号且无预约的出诊记录(固定安排)，则删除这部分出诊记录(在删除出诊表时可恢复)，
  --并修改固定安排的终止时间，程序中已询问
  If Nvl(删除安排_In, 0) = 1 Then
    For c_安排 In (Select b.Id As 安排id
                 From 临床出诊安排 B, 临床出诊表 C, 临床出诊号源 D
                 Where b.出诊id = c.Id And b.号源id = d.Id
                      --号源
                       And Nvl(d.是否删除, 0) = 0 And (d.撤档时间 Is Null Or d.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
                       Nvl(d.排班方式, 0) = 排班方式_In
                      --安排有被使用了的出诊记录
                       And c.排班方式 = 0 And b.终止时间 >= 开始时间_In And Not Exists
                  (Select 1
                        From 临床出诊记录 M, 病人挂号记录 N
                        Where m.安排id = b.Id And m.Id = n.出诊记录id And m.出诊日期 >= 开始时间_In)
                      --当前人员可操作的号源
                       And (Nvl(人员id_In, 0) = 0 Or (Nvl(d.是否临床排班, 0) = 1 And Exists
                        (Select 1 From 部门人员 Where 部门id = d.科室id And 人员id = 人员id_In)))) Loop
    
      For c_记录 In (Select ID As 记录id From 临床出诊记录 Where 安排id = c_安排.安排id And 出诊日期 >= 开始时间_In) Loop
        l_记录id.Extend();
        l_记录id(l_记录id.Count) := c_记录.记录id;
      End Loop;
    End Loop;
  
    Zl_临床出诊记录_Batchdelete(l_记录id);
  End If;

  For c_号源 In (Select 临床出诊安排_Id.Nextval As 安排id, 出诊id_In As 出诊id, b.Id As 原安排id, b.号源id, c.科室id, c.项目id, c.医生id, c.医生姓名,
                      b.排班规则, b.是否周六出诊, b.是否周日出诊, b.开始时间, c.号类, Nvl(d.站点, '-') As 站点
               From 临床出诊安排 B, 临床出诊号源 C, 部门表 D, 人员表 E, 收费项目目录 F
               Where b.号源id = c.Id And c.科室id = d.Id And c.医生id = e.Id(+) And c.项目id = f.Id And b.出诊id = 模板id_In
                    --有效号源
                     And Nvl(c.是否删除, 0) = 0 And (c.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd') Or c.撤档时间 Is Null) And
                     Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(e.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(f.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     (
                     --月排班
                      Nvl(排班方式_In, 0) = 1 And c.排班方式 = 1
                     -- 周排班
                      Or Nvl(排班方式_In, 0) = 2 And
                      (
                      --当前出诊表所在时间范围内不能有月排班
                       c.排班方式 = 2 And Not Exists
                       (Select 1
                           From 临床出诊安排 P, 临床出诊表 Q
                           Where p.出诊id = q.Id And p.号源id = c.Id And
                                 Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 1)
                      --当前已调整为了月排班,但是本月又用了周排班，则本月剩下的部分将继续按周进行排班
                       Or c.排班方式 = 1 And Exists
                       (Select 1
                           From 临床出诊安排 P, 临床出诊表 Q
                           Where p.出诊id = q.Id And p.号源id = c.Id And
                                 Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 2)))
                    --号源在该出诊表时间范围内无出诊记录
                     And Not Exists
                (Select 1
                      From 临床出诊记录 P
                      Where p.号源id = c.Id And p.出诊日期 Between 开始时间_In And 终止时间_In)
                    --当前人员可操作的号源
                     And (Nvl(人员id_In, 0) = 0 Or (Nvl(c.是否临床排班, 0) = 1 And Exists
                      (Select 1 From 部门人员 Where 部门id = c.科室id And 人员id = 人员id_In)))
                    --站点
                     And (d.站点 Is Null Or d.站点 = 站点_In)) Loop
  
    Insert Into 临床出诊安排
      (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 开始时间, 终止时间, 操作员姓名, 登记时间)
    Values
      (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 开始时间_In, 终止时间_In, 操作员_In, 登记时间_In);
  
    --临床出诊记录
    For c_日期 In (Select Trunc(开始时间_In) + Level - 1 As 日期,
                        Decode(To_Char(Trunc(开始时间_In) + Level - 1, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                '周四', '6', '周五', '7', '周六', Null) As 星期
                 From Dual
                 Connect By Level <= Trunc(终止时间_In) - Trunc(开始时间_In) + 1) Loop
    
      Isvisit(c_号源.原安排id, c_号源.排班规则, c_日期.日期, c_号源.开始时间, v_限制项目, n_是否出诊);
    
      --是否周六、周日不出诊
      --排班规则:1-星期排班;2-单日排班;3-双日排班;4-月内轮循;5-轮循不限制;6-特定日期
      If Instr(',2,3,4,5,', c_号源.排班规则) > 0 And
         (Nvl(c_号源.是否周六出诊, 0) = 0 And c_日期.星期 = '周六' Or Nvl(c_号源.是否周日出诊, 0) = 0 And c_日期.星期 = '周日') Then
        n_是否出诊 := 0;
      End If;
    
      If Nvl(n_是否出诊, 0) = 1 Then
        For c_记录 In (With c_时间段 As
                        (Select 时间段, 开始时间, 终止时间, 号类, 站点, 缺省时间, 提前时间
                        From (Select 时间段, 开始时间, 终止时间, 号类, 站点, 缺省时间, 提前时间,
                                      Row_Number() Over(Partition By 时间段 Order By 时间段, 站点 Asc, 号类 Asc) As 组号
                               From 时间段
                               Where Nvl(站点, c_号源.站点) = c_号源.站点 And Nvl(号类, c_号源.号类) = c_号源.号类)
                        Where 组号 = 1)
                       Select 临床出诊记录_Id.Nextval As 记录id, m.Id As 限制id, m.上班时段,
                              To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(j.开始时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                              To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(j.终止时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') + Case
                                 When j.终止时间 <= j.开始时间 Then
                                  1
                                 Else
                                  0
                               End As 终止时间,
                              To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(Nvl(j.缺省时间, j.开始时间), 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') + Case
                                 When j.缺省时间 < j.开始时间 Then
                                  1
                                 Else
                                  0
                               End As 缺省预约时间,
                              To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(Nvl(j.提前时间, j.开始时间), 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') + Case
                                 When j.开始时间 < j.提前时间 Then
                                  -1
                                 Else
                                  0
                               End As 提前挂号时间, m.限号数, m.限约数, m.是否序号控制, m.是否分时段, m.预约控制, a.项目id, a.医生id, a.医生姓名, m.分诊方式,
                              m.诊室id, m.是否独占
                       From 临床出诊安排 A, 临床出诊限制 M, c_时间段 J
                       Where a.Id = m.安排id And m.上班时段 = j.时间段 And a.Id = c_号源.原安排id And m.限制项目 = v_限制项目) Loop
        
          Insert Into 临床出诊记录
            (ID, 安排id, 号源id, 出诊日期, 上班时段, 开始时间, 终止时间, 缺省预约时间, 提前挂号时间, 限号数, 限约数, 是否序号控制, 是否分时段, 预约控制, 项目id, 科室id, 医生id,
             医生姓名, 分诊方式, 诊室id, 登记人, 登记时间, 是否独占)
          Values
            (c_记录.记录id, c_号源.安排id, c_号源.号源id, c_日期.日期, c_记录.上班时段, c_记录.开始时间, c_记录.终止时间, c_记录.缺省预约时间, c_记录.提前挂号时间,
             c_记录.限号数, c_记录.限约数, c_记录.是否序号控制, c_记录.是否分时段, c_记录.预约控制, c_记录.项目id, c_号源.科室id, c_记录.医生id, c_记录.医生姓名,
             c_记录.分诊方式, c_记录.诊室id, 操作员_In, 登记时间_In, c_记录.是否独占);
        
          Begin
            Select 开始时间 Into d_开始时间 From 临床出诊时段 Where 限制id = c_记录.限制id And 序号 = 1;
          Exception
            When Others Then
              d_开始时间 := Null;
          End;
          --插入临床出诊序号控制
          If Nvl(c_记录.是否分时段, 0) = 1 And Nvl(c_记录.是否序号控制, 0) = 1 Then
            --分时段且启用序号控制，使用"预约顺序号"记录"是否预约"
            Insert Into 临床出诊序号控制
              (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 预约顺序号)
              Select c_记录.记录id, 序号,
                     To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') + Case
                        When Trunc(开始时间) > Trunc(d_开始时间) Then
                         1
                        Else
                         0
                      End,
                     To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(终止时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') + Case
                        When Trunc(终止时间) > Trunc(d_开始时间) Then
                         1
                        Else
                         0
                      End, 限制数量, 是否预约, 是否预约
              From 临床出诊时段
              Where 限制id = c_记录.限制id;
          Else
            Insert Into 临床出诊序号控制
              (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约)
              Select c_记录.记录id, 序号,
                     To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') + Case
                       When Trunc(开始时间) > Trunc(d_开始时间) Then
                        1
                       Else
                        0
                     End,
                     To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(终止时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') + Case
                       When Trunc(终止时间) > Trunc(d_开始时间) Then
                        1
                       Else
                        0
                     End, 限制数量, 是否预约
              From 临床出诊时段
              Where 限制id = c_记录.限制id;
          End If;
        
          --插入合作单位挂号控制记录
          Insert Into 临床出诊挂号控制记录
            (类型, 性质, 名称, 记录id, 序号, 控制方式, 数量)
            Select 类型, 性质, 名称, c_记录.记录id, 序号, 控制方式, 数量
            From 临床出诊挂号控制
            Where 限制id = c_记录.限制id;
        
          --插入临床出诊诊室记录
          Insert Into 临床出诊诊室记录
            (记录id, 诊室id)
            Select c_记录.记录id, 诊室id From 临床出诊诊室 Where 限制id = c_记录.限制id;
        End Loop;
      End If;
    End Loop;
  End Loop;

  --加入没有的出诊安排的号源
  For c_号源 In (Select 临床出诊安排_Id.Nextval As 安排id, 出诊id_In As 出诊id, a.Id As 号源id, a.项目id, a.医生id, a.医生姓名
               From 临床出诊号源 A, 部门表 D, 人员表 E, 收费项目目录 F
               Where a.科室id = d.Id And a.医生id = e.Id(+) And a.项目id = f.Id
                    --有效号源
                     And Nvl(a.是否删除, 0) = 0 And (a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd') Or a.撤档时间 Is Null) And
                     Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(e.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(f.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     (
                     --月排班
                      Nvl(排班方式_In, 0) = 1 And a.排班方式 = 1
                     -- 周排班
                      Or Nvl(排班方式_In, 0) = 2 And
                      (
                      --当前出诊表所在时间范围内不能有月排班
                       a.排班方式 = 2 And Not Exists
                       (Select 1
                           From 临床出诊安排 P, 临床出诊表 Q
                           Where p.出诊id = q.Id And p.号源id = a.Id And
                                 Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 1)
                      --当前已调整为了月排班,但是本月又用了周排班，则本月剩下的部分将继续按周进行排班
                       Or a.排班方式 = 1 And Exists
                       (Select 1
                           From 临床出诊安排 P, 临床出诊表 Q
                           Where p.出诊id = q.Id And p.号源id = a.Id And
                                 Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 2)))
                    --号源在该出诊表时间范围内无出诊记录
                     And Not Exists
                (Select 1
                      From 临床出诊记录 P
                      Where p.号源id = a.Id And p.出诊日期 Between 开始时间_In And 终止时间_In)
                    --当前人员可操作的号源
                     And (Nvl(人员id_In, 0) = 0 Or (Nvl(a.是否临床排班, 0) = 1 And Exists
                      (Select 1 From 部门人员 Where 部门id = a.科室id And 人员id = 人员id_In)))
                    --站点
                     And (d.站点 Is Null Or d.站点 = 站点_In)
                    
                     And Not Exists (Select 1 From 临床出诊安排 Where 出诊id = 出诊id_In And 号源id = a.Id)) Loop
  
    Insert Into 临床出诊安排
      (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 开始时间, 终止时间, 操作员姓名, 登记时间)
    Values
      (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 开始时间_In, 终止时间_In, 操作员_In, 登记时间_In);
  End Loop;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊表_Addbytemplet;
/

--106708:冉俊明,2017-04-07,违反规范，调整
Create Or Replace Procedure Zl_临床出诊记录_Stopvisit
(
  记录id_In     临床出诊停诊记录.记录id%Type,
  开始时间_In   临床出诊停诊记录.开始时间%Type := Null,
  终止时间_In   临床出诊停诊记录.终止时间%Type := Null,
  停诊原因_In   临床出诊停诊记录.停诊原因%Type := Null,
  操作员_In     临床出诊停诊记录.申请人%Type := Null,
  操作时间_In   临床出诊停诊记录.申请时间%Type := Null,
  取消停诊_In   Number := 0,
  是否不检查_In Number := 0
) As
  --功能：停诊或者取消停诊
  --入参：
  --       是否不检查_in 主要用于停用/启用号源时使用
  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  n_Count Number;
  d_Cur   Date;

  v_号码 临床出诊号源.号码%Type;
Begin
  If Nvl(取消停诊_In, 0) = 0 Then
    --停诊
    If Nvl(是否不检查_In, 0) = 0 Then
      Select Count(1) Into n_Count From 临床出诊记录 A Where ID = 记录id_In And 停诊开始时间 Is Not Null;
      If Nvl(n_Count, 0) <> 0 Then
        v_Err_Msg := '当前安排已被他人进行了停诊，请刷新数据后查看！';
        Raise Err_Item;
      End If;
    
      If 开始时间_In <= Sysdate Then
        v_Err_Msg := '停诊时间的开始时间小于了当前时间，不能进行停诊操作！';
        Raise Err_Item;
      End If;
    End If;
  
    Insert Into 临床出诊停诊记录
      (ID, 记录id, 开始时间, 终止时间, 停诊原因, 申请人, 申请时间, 审批人, 审批时间, 登记人)
      Select 临床出诊停诊记录_Id.Nextval, 记录id_In, 开始时间_In, 终止时间_In, 停诊原因_In, Nvl(a.医生姓名, 操作员_In), 操作时间_In, 操作员_In, 操作时间_In,
             操作员_In
      From 临床出诊记录 A
      Where ID = 记录id_In;
  
    --保存原始临床出诊记录
    Select Count(1) Into n_Count From 临床出诊记录 Where 相关id = 记录id_In;
    If Nvl(n_Count, 0) = 0 Then
      For c_记录 In (Select ID, 安排id, To_Date('1900-01-01', 'yyyy-mm-dd') As 出诊日期, 登记人, 登记时间, 是否发布
                   From 临床出诊记录
                   Where ID = 记录id_In) Loop
        Zl_临床出诊记录_Copy(c_记录.Id, c_记录.安排id, c_记录.出诊日期, c_记录.登记人, c_记录.登记时间, c_记录.是否发布, c_记录.Id);
      End Loop;
    End If;
  
    Update 临床出诊记录
    Set 停诊开始时间 = 开始时间_In, 停诊终止时间 = 终止时间_In, 停诊原因 = 停诊原因_In
    Where ID = 记录id_In;
  
    --调整"临床出诊序号控制.是否停诊"为1
    Update 临床出诊序号控制 A
    Set 是否停诊 = 1
    Where 记录id = 记录id_In And 开始时间 Between 开始时间_In And 终止时间_In And Exists
     (Select 1 From 临床出诊记录 Where ID = a.记录id And Nvl(是否序号控制, 0) = 1 And Nvl(是否分时段, 0) = 1);
  
    Insert Into 病人服务信息记录
      (ID, 通知类型, 记录id, 挂号id, 号源id, 号码, 科室id, 项目id, 医生id, 医生姓名, 病人id, 登记人, 登记时间, 通知原因)
      Select 病人服务信息记录_Id.Nextval, 1, 记录id_In, 挂号id, 号源id, 号码, 科室id, 项目id, 医生id, 医生姓名, 病人id, 操作员_In, 操作时间_In,
             '医生' || 停诊原因_In || '，已停诊'
      From (Select b.Id As 挂号id, c.Id As 号源id, c.号码, c.科室id, a.项目id, a.医生id, a.医生姓名, b.病人id
             From 临床出诊记录 A, 病人挂号记录 B, 临床出诊号源 C
             Where a.Id = b.出诊记录id And a.号源id = c.Id And b.记录状态 = 1 And a.Id = 记录id_In And
                   (b.记录性质 = 1 And b.发生时间 Between a.停诊开始时间 And a.停诊终止时间 Or
                   b.记录性质 = 2 And b.预约时间 Between a.停诊开始时间 And a.停诊终止时间));
  
    --消息推送
    -- 停诊类型(1-停诊,2-取消停诊),出诊记录ID,停诊号码
    Begin
      Select b.号码 Into v_号码 From 临床出诊记录 A, 临床出诊号源 B Where a.号源id = b.Id And a.Id = 记录id_In;
      Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
        Using 17, 1 || ',' || 记录id_In || ',' || v_号码;
    Exception
      When Others Then
        Null;
    End;
  Else
    --取消停诊
    --数据检查
    Select Count(1) Into n_Count From 临床出诊记录 A Where ID = 记录id_In And 停诊开始时间 Is Null;
    If Nvl(n_Count, 0) <> 0 Then
      If Nvl(是否不检查_In, 0) = 1 Then
        Return;
      End If;
      v_Err_Msg := '当前安排已被他人取消停诊，请刷新数据后查看！';
      Raise Err_Item;
    End If;
  
    If Nvl(是否不检查_In, 0) = 0 Then
      Select 停诊终止时间 Into d_Cur From 临床出诊记录 Where ID = 记录id_In And 停诊开始时间 Is Not Null;
      If d_Cur <= Sysdate Then
        v_Err_Msg := '停诊时间的终止时间小于了当前时间，不能进行取消停诊操作！';
        Raise Err_Item;
      End If;
      Select Count(1)
      Into n_Count
      From 病人服务信息记录
      Where 记录id = 记录id_In And 通知类型 = 1 And 处理人 Is Not Null;
      If n_Count <> 0 Then
        v_Err_Msg := '该出诊记录存在病人服务信息记录，且已被处理，不允许取消停诊操作！';
        Raise Err_Item;
      End If;
    End If;
  
    Select Count(1)
    Into n_Count
    From (Select 开始时间, 停诊开始时间 As 终止时间
           From (Select a.开始时间, a.终止时间, a.停诊开始时间, a.停诊终止时间
                  From 临床出诊记录 A, 临床出诊记录 B
                  Where a.号源id = b.号源id And a.出诊日期 = b.出诊日期 And b.Id = 记录id_In And a.Id <> b.Id)
           Where 开始时间 < 停诊开始时间 And 终止时间 = 停诊终止时间
           Union All
           Select 停诊终止时间 As 开始时间, 终止时间
           From (Select a.开始时间, a.终止时间, a.停诊开始时间, a.停诊终止时间
                  From 临床出诊记录 A, 临床出诊记录 B
                  Where a.号源id = b.号源id And a.出诊日期 = b.出诊日期 And b.Id = 记录id_In And a.Id <> b.Id)
           Where 开始时间 = 停诊开始时间 And 终止时间 > 停诊终止时间
           Union All
           Select 开始时间, 停诊开始时间 As 终止时间
           From (Select a.开始时间, a.终止时间, a.停诊开始时间, a.停诊终止时间
                  From 临床出诊记录 A, 临床出诊记录 B
                  Where a.号源id = b.号源id And a.出诊日期 = b.出诊日期 And b.Id = 记录id_In And a.Id <> b.Id)
           Where 开始时间 < 停诊开始时间 And 终止时间 > 停诊终止时间
           Union All
           Select 停诊终止时间 As 开始时间, 终止时间
           From (Select a.开始时间, a.终止时间, a.停诊开始时间, a.停诊终止时间
                  From 临床出诊记录 A, 临床出诊记录 B
                  Where a.号源id = b.号源id And a.出诊日期 = b.出诊日期 And b.Id = 记录id_In And a.Id <> b.Id)
           Where 开始时间 < 停诊开始时间 And 终止时间 > 停诊终止时间) M, 临床出诊记录 N
    Where m.开始时间 < n.终止时间 And m.终止时间 > n.开始时间 And n.Id = 记录id_In And Rownum < 2;
    If n_Count <> 0 Then
      If Nvl(是否不检查_In, 0) = 1 Then
        Return;
      End If;
      v_Err_Msg := '当前上班时段的时间范围与该号源今日目前有效的上班时段的时间范围有交叉，你不能取消停诊！';
      Raise Err_Item;
    End If;
  
    Update 临床出诊停诊记录
    Set 取消人 = 操作员_In, 取消时间 = 操作时间_In
    Where 记录id = 记录id_In And 替诊医生姓名 Is Null And 取消人 Is Null;
  
    Update 临床出诊记录
    Set 停诊开始时间 = Null, 停诊终止时间 = Null, 停诊原因 = Null
    Where ID = 记录id_In And 停诊开始时间 Is Not Null;
  
    --调整"临床出诊序号控制.是否停诊"为0
    Update 临床出诊序号控制 Set 是否停诊 = 0 Where 记录id = 记录id_In And Nvl(是否停诊, 0) = 1;
  
    Delete 病人服务信息记录 Where 记录id = 记录id_In And 通知类型 = 1 And 处理人 Is Null;
  
    --消息推送
    -- 停诊类型(1-停诊,2-取消停诊),出诊记录ID,停诊号码
    Begin
      Select b.号码 Into v_号码 From 临床出诊记录 A, 临床出诊号源 B Where a.号源id = b.Id And a.Id = 记录id_In;
      Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
        Using 17, 2 || ',' || 记录id_In || ',' || v_号码;
    Exception
      When Others Then
        Null;
    End;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊记录_Stopvisit;
/

--107559:冉俊明,2017-04-17,增加终止停诊安排功能
--106712:冉俊明,2017-04-07,SQL语句优化
Create Or Replace Procedure Zl_临床出诊停诊_Audit
(
  操作类型_In Number,
  Id_In       临床出诊停诊记录.Id%Type,
  审批人_In   临床出诊停诊记录.审批人%Type := Null,
  审批时间_In 临床出诊停诊记录.审批时间%Type := Null
) As
  --功能：审批停诊安排
  --参数：
  --       状态_In：1-审批，2-取消审批
  n_Count Number;

  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  If Nvl(操作类型_In, 0) = 1 Then
    --审批
    Select Count(1) Into n_Count From 临床出诊停诊记录 Where ID = Id_In And 审批人 Is Not Null;
    If n_Count <> 0 Then
      v_Error := '该申请已被审批，不能再次审批！';
      Raise Err_Custom;
    End If;
  
    Update 临床出诊停诊记录 Set 审批人 = 审批人_In, 审批时间 = 审批时间_In Where ID = Id_In;
    If Sql%NotFound Then
      v_Error := '该申请可能已被取消申请，请刷新后查看...';
      Raise Err_Custom;
    End If;
  
    --对出诊记录进行停诊标记
    For c_记录 In (Select a.Id, Greatest(a.开始时间, b.开始时间) As 停诊开始时间, Least(a.终止时间, b.终止时间) As 停诊终止时间, b.停诊原因, c.号码, a.是否序号控制,
                        a.是否分时段
                 From 临床出诊记录 A, 临床出诊停诊记录 B, 临床出诊号源 C
                 Where ((a.替诊医生姓名 Is Null And a.医生id Is Not Null And a.医生姓名 = b.申请人) Or
                       (a.替诊医生姓名 Is Not Null And a.替诊医生id Is Not Null And a.替诊医生姓名 = b.申请人)) And a.号源id = c.Id And
                       b.Id = Id_In And Not (a.开始时间 > b.终止时间 Or a.终止时间 < b.开始时间)
                      --只处理已发布了的
                       And Nvl(a.是否发布, 0) = 1) Loop
    
      Update 临床出诊记录
      Set 停诊开始时间 = c_记录.停诊开始时间, 停诊终止时间 = c_记录.停诊终止时间, 停诊原因 = c_记录.停诊原因
      Where ID = c_记录.Id;
    
      --调整"临床出诊序号控制.是否停诊"为1
      Update 临床出诊序号控制 A
      Set 是否停诊 = 1
      Where 记录id = c_记录.Id And 开始时间 Between c_记录.停诊开始时间 And c_记录.停诊终止时间 And Nvl(c_记录.是否序号控制, 0) = 1 And
            Nvl(c_记录.是否分时段, 0) = 1;
    
      Insert Into 病人服务信息记录
        (ID, 通知类型, 记录id, 挂号id, 号源id, 号码, 科室id, 项目id, 医生id, 医生姓名, 病人id, 登记人, 登记时间)
        Select 病人服务信息记录_Id.Nextval, 1, a.Id, b.Id, c.Id, c.号码, c.科室id, a.项目id, a.医生id, a.医生姓名, b.病人id, 审批人_In, 审批时间_In
        From 临床出诊记录 A, 病人挂号记录 B, 临床出诊号源 C
        Where a.Id = b.出诊记录id And a.号源id = c.Id And b.记录状态 = 1 And a.Id = c_记录.Id And
              (b.记录性质 = 1 And b.发生时间 Between a.停诊开始时间 And a.停诊终止时间 Or
              b.记录性质 = 2 And b.预约时间 Between a.停诊开始时间 And a.停诊终止时间);
    
      --消息推送
      -- 停诊类型(1-停诊,2-取消停诊),出诊记录ID,停诊号码
      Begin
        Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
          Using 17, 1 || ',' || c_记录.Id || ',' || c_记录.号码;
      Exception
        When Others Then
          Null;
      End;
    End Loop;
    Return;
  End If;

  --取消审批
  Select Count(1) Into n_Count From 临床出诊停诊记录 Where ID = Id_In And 终止时间 < Sysdate;
  If n_Count <> 0 Then
    v_Error := '该停诊安排已失效，不能取消审批！';
    Raise Err_Custom;
  End If;

  Select Count(1) Into n_Count From 临床出诊停诊记录 Where ID = Id_In And 失效时间 Is Not Null;
  If n_Count <> 0 Then
    v_Error := '该停诊安排已被终止，不能取消审批！';
    Raise Err_Custom;
  End If;

  Select Count(1)
  Into n_Count
  From 临床出诊记录 A, 临床出诊停诊记录 B, 病人服务信息记录 C
  Where Nvl(a.替诊医生姓名, a.医生姓名) = b.申请人 And Nvl(a.替诊医生id, a.医生id) Is Not Null And a.Id = c.记录id And
        (a.开始时间 Between b.开始时间 And b.终止时间 Or a.终止时间 Between b.开始时间 And b.终止时间) And c.处理人 Is Not Null And b.Id = Id_In;
  If Nvl(n_Count, 0) <> 0 Then
    v_Error := '该停诊安排的部分停诊信息已被处理，不能取消审批！';
    Raise Err_Custom;
  End If;

  Update 临床出诊停诊记录 Set 审批人 = Null, 审批时间 = Null Where ID = Id_In And 审批时间 Is Not Null;
  If Sql%NotFound Then
    v_Error := '该安排可能已被他人取消审批，请刷新后查看...';
    Raise Err_Custom;
  End If;

  For c_记录 In (Select a.Id, c.号码
               From 临床出诊记录 A, 临床出诊停诊记录 B, 临床出诊号源 C
               Where ((a.替诊医生姓名 Is Null And a.医生id Is Not Null And a.医生姓名 = b.申请人) Or
                     (a.替诊医生姓名 Is Not Null And a.替诊医生id Is Not Null And a.替诊医生姓名 = b.申请人)) And a.号源id = c.Id And
                     b.Id = Id_In And (a.开始时间 Between b.开始时间 And b.终止时间 Or a.终止时间 Between b.开始时间 And b.终止时间) And
                     Nvl(a.是否发布, 0) = 1) Loop
  
    Update 临床出诊记录 Set 停诊开始时间 = Null, 停诊终止时间 = Null, 停诊原因 = Null Where ID = c_记录.Id;
  
    --调整"临床出诊序号控制.是否停诊"为0
    Update 临床出诊序号控制 Set 是否停诊 = 0 Where 记录id = c_记录.Id And Nvl(是否停诊, 0) = 1;
  
    Delete 病人服务信息记录 Where 记录id = c_记录.Id And 通知类型 = 1 And 处理人 Is Null;
  
    --消息推送
    -- 停诊类型(1-停诊,2-取消停诊),出诊记录ID,停诊号码
    Begin
      Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
        Using 17, 2 || ',' || c_记录.Id || ',' || c_记录.号码;
    Exception
      When Others Then
        Null;
    End;
  End Loop;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊停诊_Audit;
/

--106556:涂建华,2017-04-06,将组句内容的参数类型调整为xml的处理方式
--影像报告组句管理(---定义部分---)***************************************************
CREATE OR REPLACE Package b_PACS_RptCombo Is
  --Create By Hwei;
  --2014/11/25
  Type t_Refcur Is Ref Cursor;

  --1.功  能：获得影像报告组句列表
  Procedure p_GetComboList(
    Val Out t_Refcur
	);
  --2.功  能：添加影像报告组句信息
  Procedure p_AddComboInfo(
    ID_In     In 影像报告组句清单.ID%Type,
    编码_In   In 影像报告组句清单.编码%Type,
    名称_In   In 影像报告组句清单.名称%Type,
    说明_In   In 影像报告组句清单.说明%Type,
    分组_In   In 影像报告组句清单.分组%Type,
    多组_In   In 影像报告组句清单.多组%Type,
    组成_In   In 影像报告组句清单.组成%Type,
    编辑人_In In 影像报告组句清单.编辑人%Type
	);
  --3.功  能;修改影像报告组句信息
  Procedure p_EditComboInfo(
    ID_In     In 影像报告组句清单.ID%Type,
    编码_In   In 影像报告组句清单.编码%Type,
    名称_In   In 影像报告组句清单.名称%Type,
    说明_In   In 影像报告组句清单.说明%Type,
    分组_In   In 影像报告组句清单.分组%Type,
    多组_In   In 影像报告组句清单.多组%Type,
    组成_In   In 影像报告组句清单.组成%Type,
    编辑人_In In 影像报告组句清单.编辑人%Type
	);
  --4.功  能：通过ID删除影像报告组句信息
  Procedure p_DelComboInfo(
    ID_In In 影像报告组句清单.ID%Type
	);
  --5.功  能：根据ID获得影像报告组句信息
  Procedure p_GetComboInfoByID(
	Val           Out t_Refcur,
	ID_In In 影像报告组句清单.ID%Type
	);
  --6.功  能：获得影像报告组句的所有分组信息
  Procedure p_GetComboAllGroup(
    Val Out t_Refcur
	);
  --7.功  能：获得ID对应的影像报告组句的短语信息
  Procedure p_GetComboContent(
	Val           Out t_Refcur,
	ID_In In 影像报告组句清单.ID%Type
	);
  --8.功  能：更新ID对应的影像报告组句的短语信息
  Procedure p_EditComboContent(
	ID_In   In 影像报告组句清单.ID%Type,
	组成_In  In 影像报告组句清单.组成%Type
	);
  --9.功 能：获取编辑人对应的最后修改影像报告组句信息
  Procedure p_GetComboInfoByEditor(
	Val           Out t_Refcur,
	编辑人_In In 影像报告组句清单.编辑人%Type
	);
  --10.功  能：新增片段到组合句
  Procedure p_Append_Fragment_Tocombo(
    Text_In In XmlType,
    Id_In   In 影像报告组句清单.ID%Type
	);

  --11.功  能：修改片段到组合句
  Procedure p_Update_Combo_Fragment(
    Text_In In XmlType,
    Id_In   In 影像报告组句清单.ID%Type,
    Pid_In  In Varchar2
	);
  --12.功  能：根据分类ID查询词句
  Procedure p_Get_Fragment_By_Typeid(
	Val           Out t_Refcur,
	Id_In In 影像报告组句清单.ID%Type
	);
  --13.功  能：获取下一个编码
  Procedure p_Get_ComboNextCode(
    Val Out t_Refcur
	);
end b_PACS_RptCombo;
/

--影像报告组句管理(---实现部分---)***************************************************
CREATE OR REPLACE Package Body b_PACS_RptCombo Is
  --Create By Hwei;
  --2014/11/25

  --1.功  能：获得影像报告组句列表
  Procedure p_GetComboList(
    Val Out t_Refcur
	) As
  Begin
    Open Val For
      Select RawToHex(ID) ID,
             编码,
             名称,
             说明,
             分组,
             多组,
             (Nvl(t.组成, XmlType('<NULL/>'))).GetClobVal() As 组成,
             编辑人,
             最后编辑时间
        From 影像报告组句清单 t;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_GetComboList;

  --2.功  能：添加影像报告组句信息
  Procedure p_AddComboInfo(
    ID_In     In 影像报告组句清单.ID%Type,
    编码_In   In 影像报告组句清单.编码%Type,
    名称_In   In 影像报告组句清单.名称%Type,
    说明_In   In 影像报告组句清单.说明%Type,
    分组_In   In 影像报告组句清单.分组%Type,
    多组_In   In 影像报告组句清单.多组%Type,
    组成_In   In 影像报告组句清单.组成%Type,
    编辑人_In In 影像报告组句清单.编辑人%Type
	) As
  Begin
    Insert Into 影像报告组句清单
      (ID, 编码, 名称, 说明, 分组, 多组, 组成, 编辑人, 最后编辑时间)
    Values
      (ID_In, 编码_In, 名称_In, 说明_In, 分组_In, 多组_In, 组成_In, 编辑人_In, Sysdate);
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_AddComboInfo;

  --3.功  能;修改影像报告组句信息
  Procedure p_EditComboInfo(
    ID_In     In 影像报告组句清单.ID%Type,
    编码_In   In 影像报告组句清单.编码%Type,
    名称_In   In 影像报告组句清单.名称%Type,
    说明_In   In 影像报告组句清单.说明%Type,
    分组_In   In 影像报告组句清单.分组%Type,
    多组_In   In 影像报告组句清单.多组%Type,
    组成_In   In 影像报告组句清单.组成%Type,
    编辑人_In In 影像报告组句清单.编辑人%Type
	) As
  Begin
    Update 影像报告组句清单
       set 编码         = 编码_In,
           名称         = 名称_In,
           说明         = 说明_In,
           分组         = 分组_In,
           多组         = 多组_In,
           组成         = 组成_In,
           编辑人       = 编辑人_In,
           最后编辑时间 = SysDate
     Where ID = ID_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_EditComboInfo;

  --4.功  能：通过ID删除影像报告组句信息
  Procedure p_DelComboInfo(
    ID_In In 影像报告组句清单.ID%Type
	) As
  Begin
    Delete From 影像报告组句清单 Where ID = ID_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_DelComboInfo;

  --5.功  能：根据ID获得影像报告组句信息
  Procedure p_GetComboInfoByID(
	Val           Out t_Refcur,
	ID_In In 影像报告组句清单.ID%Type
	) As
  Begin
    Open Val For
      Select RawToHex(ID) ID,
             编码,
             名称,
             说明,
             分组,
             多组,
             (Nvl(t.组成, XmlType('<NULL/>'))).GetClobVal() As 组成,
             编辑人,
             最后编辑时间
        From 影像报告组句清单 t
       Where ID = ID_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_GetComboInfoByID;

  --6.功  能：获得影像报告组句的所有分组信息
  Procedure p_GetComboAllGroup(
    Val Out t_Refcur
	) As
  Begin
    Open Val For
      Select Distinct 分组 From 影像报告组句清单;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_GetComboAllGroup;

  --7.功  能：获得ID对应的影像报告组句的短语信息
  Procedure p_GetComboContent(
	Val           Out t_Refcur,
	ID_In In 影像报告组句清单.ID%Type
	) As
  Begin
    Open Val For
      Select (Nvl(t.组成, XmlType('<NULL/>'))).GetClobVal() As 组成
        From 影像报告组句清单 t
       Where ID = ID_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_GetComboContent;

  --8.功  能：更新ID对应的影像报告组句的短语信息
  Procedure p_EditComboContent(
    ID_In   In 影像报告组句清单.ID%Type,
    组成_In In 影像报告组句清单.组成%Type
	) As
  Begin
    Update 影像报告组句清单 Set 组成 = 组成_In Where ID = ID_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_EditComboContent;

  --9.功 能：获取编辑人对应的最后修改影像报告组句信息
  Procedure p_GetComboInfoByEditor(
	Val           Out t_Refcur,
	编辑人_In In 影像报告组句清单.编辑人%Type
	) AS
  Begin
    Open Val For
      Select RawToHex(ID) ID, 编辑人, 最后编辑时间
        From 影像报告组句清单 t1
       Where Not Exists (Select 1
                From 影像报告组句清单
               Where 最后编辑时间 > t1.最后编辑时间)
         And 编辑人 = 编辑人_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_GetComboInfoByEditor;

  --10.功  能：新增片段到组合句
  Procedure p_Append_Fragment_Tocombo(
    Text_In In XmlType,
	Id_In   In 影像报告组句清单.ID%Type
	) As
  Begin
    Update 影像报告组句清单 A
       Set a.组成 = Appendchildxml(a.组成, '/root', Text_In)
     Where a.ID = ID_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Append_Fragment_Tocombo;

  --11.功  能：修改片段到组合句
  Procedure p_Update_Combo_Fragment(
    Text_In In XmlType,
    Id_In   In 影像报告组句清单.ID%Type,
    Pid_In  In Varchar2
	) As
  Begin
    Update 影像报告组句清单 A
       Set a.组成 = Updatexml(a.组成,
                            '/root/sentence[@sid="' || Pid_In || '"]',
                            Text_In)
     Where a.ID = Id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Update_Combo_Fragment;

  --12.功  能：根据分类ID查询词句
  Procedure p_Get_Fragment_By_Typeid(
	Val           Out t_Refcur,
	Id_In In 影像报告组句清单.ID%Type
	) As
  Begin
    Open Val For
      Select RawToHex(ID) ID,
             上级id,
             编码,
             名称,
             说明,
             节点类型,
             (Nvl(a.组成, XmlType('<NULL/>'))).GetClobVal() As 组成,
             学科,
             标签,
             是否私有,
             作者,
			 (Nvl(a.适应条件, XmlType('<NULL/>'))).GetClobVal() As 适应条件, 
             最后编辑时间
        From 影像报告片段清单 A
       Where a.上级id = Id_In
         And a.节点类型 <> 0;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Fragment_By_Typeid;

  --13.功  能：获取下一个编码
  Procedure p_Get_ComboNextCode(
    Val Out t_Refcur
	) As
  Begin
    Open Val For
      Select b_pacs_rptpublic.f_Get_Nextcode('影像报告组句清单') As 编码
        From dual;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_ComboNextCode;
End b_PACS_RptCombo;
/

--107584:冉俊明,2017-04-06,修正跨天的上班时段序号分配时日期规则错误
Create Or Replace Procedure Zl_临床出诊号源限制_Modify
(
  Id_In           临床出诊号源限制.Id%Type,
  号源id_In       临床出诊号源限制.号源id%Type,
  上班时段_In     临床出诊号源限制.上班时段%Type,
  限号数_In       临床出诊号源限制.限号数%Type,
  限约数_In       临床出诊号源限制.限约数%Type,
  是否序号控制_In 临床出诊号源限制.是否序号控制%Type,
  是否分时段_In   临床出诊号源限制.是否分时段%Type,
  预约控制_In     临床出诊号源限制.预约控制%Type,
  是否独占_In     临床出诊号源限制.是否独占%Type,
  分诊方式_In     临床出诊号源限制.分诊方式%Type,
  诊室id_In       临床出诊号源限制.诊室id%Type,
  号源诊室_In     Varchar2 := Null,
  号源时段_In     Varchar2 := Null,
  号源控制_In     Varchar2 := Null,
  删除号源限制_In Integer := 0
) As
  --号源时段_IN:序号,开始时间(HH:MM:SS),终止时(HH:MM:SS)间,数量,是否预约|...
  --号源诊室_IN:诊室id1,诊室id2,....
  --号源控制_IN:类型,性质,名称,控制方式,序号,数量|
  --删除号源限制_in:1-插入数据前，先删除号源限制,0-不删除数据，直接插入,-1-仅删除号源限制,不插入数据
  v_Err_Msg Varchar2(255);
  Err_Item Exception;
  l_限制id t_Numlist := t_Numlist();
  n_Count  Number;

  n_序号     临床出诊号源时段.序号%Type;
  d_开始时间 临床出诊号源时段.开始时间%Type;
  d_终止时间 临床出诊号源时段.终止时间%Type;
  n_数量     临床出诊号源时段.限制数量%Type;
  n_是否预约 临床出诊号源时段.是否预约%Type;

  n_类型     临床出诊号源控制.类型%Type;
  n_性质     临床出诊号源控制.性质%Type;
  v_名称     临床出诊号源控制.名称%Type;
  n_控制方式 临床出诊号源控制.控制方式%Type;
  n_限制数量 临床出诊号源控制.数量%Type;
Begin
  If Nvl(删除号源限制_In, 0) = 1 Or Nvl(删除号源限制_In, 0) = -1 Then
    Select ID Bulk Collect Into l_限制id From 临床出诊号源限制 Where 号源id = 号源id_In;
    Forall I In 1 .. l_限制id.Count
      Delete 临床出诊号源时段 Where 限制id = l_限制id(I);
  
    Forall I In 1 .. l_限制id.Count
      Delete 临床出诊号源控制 Where 限制id = l_限制id(I);
  
    Forall I In 1 .. l_限制id.Count
      Delete 临床出诊号源诊室 Where 限制id = l_限制id(I);
  
    Delete 临床出诊号源限制 Where 号源id = 号源id_In;
    Delete From 临床出诊号源限制 Where 号源id = 号源id_In;
  
    If Nvl(删除号源限制_In, 0) = -1 Then
      Return;
    End If;
  End If;

  Select Count(1) Into n_Count From 临床出诊号源限制 Where ID = Id_In;
  If n_Count = 0 Then
    Insert Into 临床出诊号源限制
      (ID, 号源id, 上班时段, 限号数, 限约数, 是否序号控制, 是否分时段, 预约控制, 是否独占, 分诊方式, 诊室id)
    Values
      (Id_In, 号源id_In, 上班时段_In, 限号数_In, 限约数_In, 是否序号控制_In, 是否分时段_In, 预约控制_In, 是否独占_In, 分诊方式_In, 诊室id_In);
  
  End If;

  If 号源时段_In Is Not Null Then
    --插入号源缺省时间段
    For c_时间段集 In (Select Rownum As 序号, Column_Value As 值 From Table(f_Str2list(号源时段_In, '|'))) Loop
      n_序号     := Null;
      n_数量     := Null;
      n_是否预约 := Null;
      For c_时间段 In (Select Rownum As 序号, Column_Value As 值 From Table(f_Str2list(c_时间段集.值)) Order By 序号) Loop
        If c_时间段.序号 = 1 Then
          n_序号 := To_Number(c_时间段.值);
        End If;
      
        If c_时间段.序号 = 2 Then
          d_开始时间 := To_Date(c_时间段.值, 'yyyy-mm-dd hh24:mi:ss');
        End If;
      
        If c_时间段.序号 = 3 Then
          d_终止时间 := To_Date(c_时间段.值, 'yyyy-mm-dd hh24:mi:ss');
        End If;
      
        If c_时间段.序号 = 4 Then
          n_数量 := To_Number(c_时间段.值);
        End If;
      
        If c_时间段.序号 = 5 Then
          n_是否预约 := To_Number(c_时间段.值);
        End If;
      
      End Loop;
    
      If Nvl(n_序号, 0) <> 0 Then
        Insert Into 临床出诊号源时段
          (限制id, 序号, 开始时间, 终止时间, 限制数量, 是否预约)
        Values
          (Id_In, n_序号, d_开始时间, d_终止时间, n_数量, n_是否预约);
      End If;
    End Loop;
  
  End If;

  --插入号源的缺省控制
  --号源控制_IN:类型,性质,名称,控制方式,序号,数量|
  If 号源控制_In Is Not Null Then
    For c_时间段集 In (Select Rownum As 序号, Column_Value As 值 From Table(f_Str2list(号源控制_In, '|'))) Loop
      n_类型     := Null;
      n_性质     := Null;
      v_名称     := Null;
      n_序号     := Null;
      n_控制方式 := Null;
      n_限制数量 := Null;
    
      --类型,性质,名称,控制方式,序号,数量|
      For c_时间段 In (Select Rownum As 序号, Column_Value As 值 From Table(f_Str2list(c_时间段集.值)) Order By 序号) Loop
        If c_时间段.序号 = 1 Then
          n_类型 := To_Number(c_时间段.值);
        End If;
      
        If c_时间段.序号 = 2 Then
          n_性质 := To_Number(c_时间段.值);
        End If;
      
        If c_时间段.序号 = 3 Then
          v_名称 := c_时间段.值;
        End If;
      
        If c_时间段.序号 = 4 Then
          n_控制方式 := To_Number(c_时间段.值);
        End If;
      
        If c_时间段.序号 = 5 Then
          n_序号 := To_Number(c_时间段.值);
        End If;
      
        If c_时间段.序号 = 6 Then
          n_限制数量 := To_Number(c_时间段.值);
        End If;
      
      End Loop;
    
      If v_名称 Is Not Null Then
        Insert Into 临床出诊号源控制
          (限制id, 类型, 性质, 名称, 序号, 控制方式, 数量)
        Values
          (Id_In, n_类型, n_性质, v_名称, n_序号, n_控制方式, n_限制数量);
      
      End If;
    End Loop;
  End If;
  --插入号源诊室
  If 号源诊室_In Is Not Null Then
    Insert Into 临床出诊号源诊室
      (限制id, 诊室id)
      Select Id_In As 限制id, Column_Value As 科室id From Table(f_Num2list(号源诊室_In));
  End If;

Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊号源限制_Modify;
/

--107173:余伟节,2017-04-06,身份证反算年龄时允许指定计算日期
Create Or Replace Function Zl_Fun_Checkidcard
(
  Idcard_In   In Varchar2,
  Calcdate_In In Date := Null
) Return Varchar2 Is
  -------------------------------------------------------------------------------
  --功能：身份证号码合法性校验,并返回身份证号的出生日期、性别、年龄
  --参数说明:
  -- 入参 IDcard_In:身份证号码
  --    Calcdate_In:计算日期,缺省时按系统时间
  -- 返回值：固定格式XML串
  --<OUTPUT>
  --       <BIRTHDAY></BIRTHDAY>                //出生日期
  --       <SEX></SEX>                  //性别
  --       <AGE></AGE>                //年龄
  --     <MSG></MSG>         //空串-身份证号有效(可从身份证号中获取出生日期和性别)，非空串-返回错误信息
  --</OUTPUT>
  -------------------------------------------------------------------------------
  n_Count     Number(5);
  n_Sum       Number(5);
  v_校验位    Varchar2(50);
  v_Pattern   Varchar2(500);
  v_Err_Msg   Varchar2(2000);
  v_性别      Varchar2(100);
  v_年龄      Varchar2(100);
  d_Curr_Time Date;
  d_出生日期  Date;

Begin
  Select Sysdate Into d_Curr_Time From Dual;

  If Idcard_In Is Null Then
    v_Err_Msg := '传人身份证号为空!';
    Return '<OUTPUT><BIRTHDAY></BIRTHDAY><SEX></SEX><AGE></AGE><MSG>' || v_Err_Msg || '</MSG></OUTPUT>';
  Else
    --身份证合法验证
    v_Pattern := '11,12,13,14,15,21,22,23,31,32,33,34,35,36,37,41,42,43,44,45,46,50,51,52,53,54,61,62,63,64,65,71,81,82,91';
    --地区检验
    If Instr(v_Pattern, Substr(Idcard_In, 1, 2)) = 0 Then
      v_Err_Msg := '身份证前两位地区码不正确!';
      Return '<OUTPUT><BIRTHDAY></BIRTHDAY><SEX></SEX><AGE></AGE><MSG>' || v_Err_Msg || '</MSG></OUTPUT>';
    End If;
    --身份证长度检查
    If Length(Idcard_In) = 15 Then
      --检查身份证号:15位身份证号要求全部为数字
      v_Pattern := '^\d{15}$';
      Select Count(1) Into n_Count From Dual Where Regexp_Like(Idcard_In, v_Pattern);
      If n_Count = 0 Then
        v_Err_Msg := '身份证中包含非法字符，请检查!';
        Return '<OUTPUT><BIRTHDAY></BIRTHDAY><SEX></SEX><AGE></AGE><MSG>' || v_Err_Msg || '</MSG></OUTPUT>';
      End If;
      --获取性别
      If Mod(To_Number(Substr(Idcard_In, 15, 1)), 2) = 1 Then
        v_性别 := '男';
      Else
        v_性别 := '女';
      End If;
      --出生日期的合法性检查
      v_Pattern := '^19[0-9]{2}((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))$';
      Select Count(1) Into n_Count From Dual Where Regexp_Like('19' || Substr(Idcard_In, 7, 6), v_Pattern);
      If n_Count = 0 Then
        v_Err_Msg := '身份证中的出生日期无效，请检查!';
        Return '<OUTPUT><BIRTHDAY></BIRTHDAY><SEX></SEX><AGE></AGE><MSG>' || v_Err_Msg || '</MSG></OUTPUT>';
      Else
        d_出生日期 := To_Date('19' || Substr(Idcard_In, 7, 6), 'yyyy-mm-dd');
        If d_出生日期 > To_Date(To_Char(d_Curr_Time, 'YYYY-MM-DD'), 'YYYY-MM-dd') Then
          v_Err_Msg := '身份证中的出生日期无效，请检查!';
          Return '<OUTPUT><BIRTHDAY></BIRTHDAY><SEX></SEX><AGE></AGE><MSG>' || v_Err_Msg || '</MSG></OUTPUT>';
        End If;
      End If;
    Elsif Length(Idcard_In) = 18 Then
      -- 18 位身份证号前17 位全部为数字，最后1位可为数字或x
      v_Pattern := '^\d{17}[0-9Xx]$';
      Select Count(1) Into n_Count From Dual Where Regexp_Like(Idcard_In, v_Pattern);
      If n_Count = 0 Then
        v_Err_Msg := '身份证中包含非法字符!';
        Return '<OUTPUT><BIRTHDAY></BIRTHDAY><SEX></SEX><AGE></AGE><MSG>' || v_Err_Msg || '</MSG></OUTPUT>';
      End If;
      --获取性别
      If Mod(To_Number(Substr(Idcard_In, 17, 1)), 2) = 1 Then
        v_性别 := '男';
      Else
        v_性别 := '女';
      End If;
      --出生日期的合法性检查
      v_Pattern := '^(1[6-9]|[2-9][0-9])[0-9]{2}((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))$';
      Select Count(1) Into n_Count From Dual Where Regexp_Like(Substr(Idcard_In, 7, 8), v_Pattern);
      If n_Count = 0 Then
        v_Err_Msg := '身份证中的出生日期无效，请检查!';
        Return '<OUTPUT><BIRTHDAY></BIRTHDAY><SEX></SEX><AGE></AGE><MSG>' || v_Err_Msg || '</MSG></OUTPUT>';
      Else
        d_出生日期 := To_Date(Substr(Idcard_In, 7, 8), 'yyyy-mm-dd');
        If d_出生日期 > To_Date(To_Char(d_Curr_Time, 'YYYY-MM-DD'), 'YYYY-MM-dd') Then
          v_Err_Msg := '身份证中的出生日期无效，请检查!';
          Return '<OUTPUT><BIRTHDAY></BIRTHDAY><SEX></SEX><AGE></AGE><MSG>' || v_Err_Msg || '</MSG></OUTPUT>';
        End If;
        --计算校验位
        n_Sum     := (To_Number(Substr(Idcard_In, 1, 1)) + To_Number(Substr(Idcard_In, 11, 1))) * 7 +
                     (To_Number(Substr(Idcard_In, 2, 1)) + To_Number(Substr(Idcard_In, 12, 1))) * 9 +
                     (To_Number(Substr(Idcard_In, 3, 1)) + To_Number(Substr(Idcard_In, 13, 1))) * 10 +
                     (To_Number(Substr(Idcard_In, 4, 1)) + To_Number(Substr(Idcard_In, 14, 1))) * 5 +
                     (To_Number(Substr(Idcard_In, 5, 1)) + To_Number(Substr(Idcard_In, 15, 1))) * 8 +
                     (To_Number(Substr(Idcard_In, 6, 1)) + To_Number(Substr(Idcard_In, 16, 1))) * 4 +
                     (To_Number(Substr(Idcard_In, 7, 1)) + To_Number(Substr(Idcard_In, 17, 1))) * 2 +
                     To_Number(Substr(Idcard_In, 8, 1)) * 1 + To_Number(Substr(Idcard_In, 9, 1)) * 6 +
                     To_Number(Substr(Idcard_In, 10, 1)) * 3;
        n_Count   := Mod(n_Sum, 11);
        v_Pattern := '10X98765432';
        v_校验位  := Substr(v_Pattern, n_Count + 1, 1);
        If v_校验位 <> Upper(Substr(Idcard_In, 18, 1)) Then
          v_Err_Msg := '身份证号码不正确，请检查。';
          Return '<OUTPUT><BIRTHDAY></BIRTHDAY><SEX></SEX><AGE></AGE><MSG>' || v_Err_Msg || '</MSG></OUTPUT>';
        End If;
      End If;
    Else
      v_Err_Msg := '身份证长度不对,请检查。';
      Return '<OUTPUT><BIRTHDAY></BIRTHDAY><SEX></SEX><AGE></AGE><MSG>' || v_Err_Msg || '</MSG></OUTPUT>';
    End If;
    v_年龄 := Zl_Age_Calc(0, d_出生日期, Calcdate_In);
  End If;

  Return '<OUTPUT><BIRTHDAY>' || To_Char(d_出生日期, 'YYYY-MM-DD') || '</BIRTHDAY><SEX>' || v_性别 || '</SEX><AGE>' || v_年龄 || '</AGE><MSG></MSG></OUTPUT>';
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Fun_Checkidcard;
/

--105791:冉俊明,2017-04-19,法定假日表字段名调整
Create Or Replace Procedure Zl_法定假日表_Modify
(
  操作类型_In     Number,
  年份_In         法定假日表.年份%Type,
  节日名称_In     法定假日表.节日名称%Type,
  开始日期_In     法定假日表.开始日期%Type,
  终止日期_In     法定假日表.终止日期%Type,
  备注_In         法定假日表.备注%Type,
  换休情况_In     Varchar2 := Null,
  允许预约日期_In 法定假日表.允许预约日期%Type,
  允许挂号日期_In 法定假日表.允许挂号日期%Type
) As
  --新增、修改法定节假日
  --      操作类型_In 0-新增，1-修改
  --      换休情况_In 格式：调休时间1~ 原上班时间1;调休时间2~ 原上班时间2;
  --      允许预约日期_In 允许预约的日期,格式：yyyy-mm-dd;yyyy-mm-dd;...
  --      允许挂号日期_In 允许挂号的日期,格式：yyyy-mm-dd;yyyy-mm-dd;...
  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  n_Count Number;

  v_换休情况 Varchar2(4000);
  v_当前项目 Varchar2(4000);
  d_开始日期 Date;
  d_终止日期 Date;
Begin
  If 操作类型_In = 0 Then
    --新增
    Begin
      Select 1
      Into n_Count
      From 法定假日表
      Where 性质 = 0 And 年份 = 年份_In And 节日名称 = 节日名称_In And Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If n_Count > 0 Then
      v_Err_Msg := 年份_In || '年已存在“' || 节日名称_In || '”！';
      Raise Err_Item;
    End If;
  
    Begin
      Select 1
      Into n_Count
      From 临床出诊记录 A
      Where a.出诊日期 >= 开始日期_In And a.上班时段 Is Not Null And Nvl(a.是否发布, 0) = 1 And Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If Nvl(n_Count, 0) <> 0 Then
      v_Err_Msg := '当前节假日开始时间之后已有有效的出诊安排，不能再新增！';
      Raise Err_Item;
    End If;
  
    Begin
      Select 1
      Into n_Count
      From 临床出诊记录
      Where 出诊日期 Between 开始日期_In And 终止日期_In And Nvl(是否发布, 0) = 1 And (Nvl(已约数, 0) <> 0 Or Nvl(已挂数, 0) <> 0) And
            Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If n_Count > 0 Then
      v_Err_Msg := '当前节假日的时间范围内已有预约挂号病人，不能设置！';
      Raise Err_Item;
    End If;
  
    Begin
      Select 1
      Into n_Count
      From 法定假日表
      Where 性质 = 0 And 终止日期_In > 开始日期 And 开始日期_In < 终止日期 And Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If n_Count > 0 Then
      v_Err_Msg := '当前节假日的时间范围内已存在其它节假日！';
      Raise Err_Item;
    End If;
  
    Insert Into 法定假日表
      (年份, 节日名称, 性质, 开始日期, 终止日期, 备注, 允许预约日期, 允许挂号日期)
    Values
      (年份_In, 节日名称_In, 0, 开始日期_In, 终止日期_In, 备注_In, 允许预约日期_In, 允许挂号日期_In);
  
    If 换休情况_In Is Not Null Then
      v_换休情况 := 换休情况_In || ';';
    End If;
    While v_换休情况 Is Not Null Loop
      v_当前项目 := Substr(v_换休情况, 0, Instr(v_换休情况, ';') - 1);
      d_开始日期 := To_Date(Substr(v_当前项目, 0, Instr(v_当前项目, '~') - 1), 'yyyy-mm-dd');
      d_终止日期 := To_Date(Substr(v_当前项目, Instr(v_当前项目, '~') + 1), 'yyyy-mm-dd');
    
      Insert Into 法定假日表
        (年份, 节日名称, 性质, 开始日期, 终止日期, 备注)
      Values
        (年份_In, 节日名称_In, 1, d_开始日期, d_终止日期, Null);
    
      v_换休情况 := Substr(v_换休情况, Instr(v_换休情况, ';') + 1);
    End Loop;
  
  Elsif 操作类型_In = 1 Then
    --修改
    Begin
      Select 开始日期
      Into d_开始日期
      From 法定假日表
      Where 性质 = 0 And 年份 = 年份_In And 节日名称 = 节日名称_In And Rownum < 2;
    Exception
      When Others Then
        d_开始日期 := Null;
    End;
    If d_开始日期 Is Null Then
      v_Err_Msg := 年份_In || '年不存在“' || 节日名称_In || '”！';
      Raise Err_Item;
    End If;
  
    Begin
      Select 1
      Into n_Count
      From 临床出诊记录 A
      Where a.出诊日期 >= d_开始日期 And a.上班时段 Is Not Null And Nvl(a.是否发布, 0) = 1 And Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If Nvl(n_Count, 0) <> 0 Then
      v_Err_Msg := '当前节假日开始时间之后已有有效的出诊安排，不能修改！';
      Raise Err_Item;
    End If;
  
    Begin
      Select 1
      Into n_Count
      From 临床出诊记录
      Where 出诊日期 Between 开始日期_In And 终止日期_In And Nvl(是否发布, 0) = 1 And (Nvl(已约数, 0) <> 0 Or Nvl(已挂数, 0) <> 0) And
            Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If n_Count > 0 Then
      v_Err_Msg := '当前节假日的时间范围内已有预约挂号病人，不能修改！';
      Raise Err_Item;
    End If;
  
    Begin
      Select 1
      Into n_Count
      From 法定假日表
      Where 性质 = 0 And 终止日期_In > 开始日期 And 开始日期_In < 终止日期 And Not (年份 = 年份_In And 节日名称 = 节日名称_In) And Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If n_Count > 0 Then
      v_Err_Msg := '当前节假日的时间范围内已存在其它节假日！';
      Raise Err_Item;
    End If;
  
    Update 法定假日表
    Set 开始日期 = 开始日期_In, 终止日期 = 终止日期_In, 备注 = 备注_In, 允许预约日期 = 允许预约日期_In, 允许挂号日期 = 允许挂号日期_In
    Where 年份 = 年份_In And Nvl(性质, 0) = 0 And 节日名称 = 节日名称_In;
  
    --先删除换休数据
    Delete From 法定假日表 Where 年份 = 年份_In And Nvl(性质, 0) = 1 And 节日名称 = 节日名称_In;
    If 换休情况_In Is Not Null Then
      v_换休情况 := 换休情况_In || ';';
    End If;
    While v_换休情况 Is Not Null Loop
      v_当前项目 := Substr(v_换休情况, 0, Instr(v_换休情况, ';') - 1);
      d_开始日期 := To_Date(Substr(v_当前项目, 0, Instr(v_当前项目, '~') - 1), 'yyyy-mm-dd');
      d_终止日期 := To_Date(Substr(v_当前项目, Instr(v_当前项目, '~') + 1), 'yyyy-mm-dd');
    
      Insert Into 法定假日表
        (年份, 节日名称, 性质, 开始日期, 终止日期, 备注)
      Values
        (年份_In, 节日名称_In, 1, d_开始日期, d_终止日期, Null);
    
      v_换休情况 := Substr(v_换休情况, Instr(v_换休情况, ';') + 1);
    End Loop;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_法定假日表_Modify;
/

--107559:冉俊明,2017-04-18,增加终止停诊安排功能
--105791:冉俊明,2017-04-19,法定假日表字段名调整
Create Or Replace Procedure Zl_Clinicvisitmodify
(
  号源id_In     In 临床出诊记录.号源id%Type,
  安排id_In     In 临床出诊记录.号源id%Type,
  出诊日期_In   In 临床出诊记录.出诊日期%Type,
  登记人_In     In 临床出诊记录.登记人%Type,
  登记时间_In   In 临床出诊记录.登记时间%Type,
  是否已换休_In In Number := 0
) As
  --功能：根据停诊安排和法定节假日调整出诊记录的出诊/预约情况
  --入参：
  --     是否已换休_In 主要用于换休后进行停诊处理
  --说明：
  --     临床出诊号源.假日控制状态：0-不上班;1-上班且开放预约;2-上班但不开放预约;3-受节假日设置控制
  --     1-停诊，在停诊安排时间范围内
  --     2-停诊，在法定节假日内
  --       2.1临床出诊号源.假日控制状态=0
  --       2.2临床出诊号源.假日控制状态=3，且设置了允许预约/允许挂号，但该上班时段不在设置的允许预约/允许挂号的时间范围内
  --     3-禁止预约，在法定节假日内，
  --       3.1临床出诊号源.假日控制状态=2
  --       3.3临床出诊号源.假日控制状态=3，设置了允许预约/允许挂号，且该上班时段在设置的允许挂号的时间范围内，但不在设置的允许预约时间范围内
  --     else-正常出诊

  n_假日控制状态 临床出诊号源.假日控制状态%Type;
  n_是否假日换休 临床出诊号源.是否假日换休%Type;

  d_原上班日期 临床出诊记录.出诊日期%Type;
  d_调休日期   临床出诊记录.出诊日期%Type;

  d_停诊开始时间 临床出诊记录.停诊开始时间%Type;
  d_停诊终止时间 临床出诊记录.停诊终止时间%Type;
  v_停诊原因     临床出诊记录.停诊原因%Type;

  d_假日开始日期 法定假日表.开始日期%Type;
  d_假日终止日期 法定假日表.终止日期%Type;
  v_允许预约     法定假日表.允许预约日期%Type;
  v_允许挂号     法定假日表.允许挂号日期%Type;

  d_停止预约开始时间 临床出诊记录.停诊开始时间%Type;
  d_停止预约终止时间 临床出诊记录.停诊终止时间%Type;

  n_Count    Number(2);
  n_允许预约 Number(2);
  n_允许挂号 Number(2);

  Procedure Stopbespeak
  (
    记录id_In   In 临床出诊记录.Id%Type,
    开始时间_In In 临床出诊记录.开始时间%Type,
    终止时间_In In 临床出诊记录.终止时间%Type
  ) As
    --功能：禁止预约
    --说明：
    --      分时段且序号控制的，修改"临床出诊序号控制.是否预约"等于1的为0；取消发布时根据"预约顺序号"恢复
    --      分时段且不序号控制的，修改"临床出诊序号控制.是否预约"为0；取消发布时根据恢复为1
    --      不分时段的，提供公共函数在挂号预约时检查预约时间是否在不允许预约的时间范围内
  Begin
    Update 临床出诊序号控制 Set 是否预约 = 0 Where 记录id = 记录id_In And 开始时间 Between 开始时间_In And 终止时间_In;
  End Stopbespeak;

  Procedure Stopvisit
  (
    记录id_In       In 临床出诊记录.Id%Type,
    停诊开始时间_In In 临床出诊记录.停诊开始时间%Type,
    停诊终止时间_In In 临床出诊记录.停诊终止时间%Type,
    停诊原因_In     In 临床出诊记录.停诊原因%Type
  ) As
    --功能：停诊
    --说明：
    --     同一条出诊记录可以存在多条停诊记录，临床出诊记录的停诊开始时间为多条停诊记录的最小开始时间，停诊终止时间为多条停诊记录的最大终止时间

  
    d_停诊开始时间 临床出诊记录.停诊开始时间%Type;
    d_停诊终止时间 临床出诊记录.停诊终止时间%Type;
    v_停诊原因     临床出诊记录.停诊原因%Type;
  Begin
    If 停诊开始时间_In >= 停诊终止时间_In Then
      Return;
    End If;
  
    --产生停诊记录
    Insert Into 临床出诊停诊记录
      (ID, 记录id, 开始时间, 终止时间, 停诊原因, 申请人, 申请时间, 审批人, 审批时间, 登记人)
      Select 临床出诊停诊记录_Id.Nextval, ID, 停诊开始时间_In, 停诊终止时间_In, 停诊原因_In, Nvl(医生姓名, 登记人_In), 登记时间_In, 登记人_In, 登记时间_In, 登记人_In
      From 临床出诊记录
      Where ID = 记录id_In;
  
    Begin
      Select Min(a.开始时间), Max(a.终止时间), Max(a.停诊原因)
      Into d_停诊开始时间, d_停诊终止时间, v_停诊原因
      From 临床出诊停诊记录 A
      Where a.记录id = 记录id_In And a.取消时间 Is Null;
    Exception
      When Others Then
        d_停诊开始时间 := Null;
        d_停诊终止时间 := Null;
        v_停诊原因     := Null;
    End;
  
    Update 临床出诊记录
    Set 停诊开始时间 = d_停诊开始时间, 停诊终止时间 = d_停诊终止时间, 停诊原因 = v_停诊原因
    Where ID = 记录id_In;
  
    --调整"临床出诊序号控制.是否停诊"为1
    Update 临床出诊序号控制 A
    Set 是否停诊 = 1
    Where 记录id = 记录id_In And 开始时间 Between 停诊开始时间_In And 停诊终止时间_In And Exists
     (Select 1 From 临床出诊记录 Where ID = a.记录id And Nvl(是否序号控制, 0) = 1 And Nvl(是否分时段, 0) = 1);
  End Stopvisit;

  Procedure Changedaysoff
  (
    号源id_In     In 临床出诊记录.号源id%Type,
    安排id_In     In 临床出诊记录.安排id%Type,
    出诊日期_In   In 临床出诊记录.出诊日期%Type,
    原上班日期_In In 临床出诊记录.出诊日期%Type,
    调休日期_In   In 临床出诊记录.出诊日期%Type
  ) As
    --功能：换休处理
    n_安排id 临床出诊记录.安排id%Type;
    l_记录id t_Numlist := t_Numlist();
    n_Count  Number(2);
  Begin
    --1.前面的安排换到今日
    If 原上班日期_In Is Not Null Then
      --1.1.前面的日期没有安排则不处理
      Select Count(1)
      Into n_Count
      From 临床出诊记录
      Where 号源id = 号源id_In And 出诊日期 = 原上班日期_In And Rownum < 2;
    
      If Nvl(n_Count, 0) > 0 Then
        --[1]删除今日现有的安排
        Select ID Bulk Collect Into l_记录id From 临床出诊记录 Where 号源id = 号源id_In And 出诊日期 = 出诊日期_In;
        Zl_临床出诊记录_Batchdelete(l_记录id);
      
        --[2]复制安排
        For c_换休记录 In (Select ID, 是否发布 From 临床出诊记录 Where 号源id = 号源id_In And 出诊日期 = 原上班日期_In) Loop
          Zl_临床出诊记录_Copy(c_换休记录.Id, 安排id_In, 出诊日期_In, 登记人_In, 登记时间_In, c_换休记录.是否发布);
        End Loop;
      
        --[3]重新对今日进行停诊安排和法定节假日调整
        For c_记录 In (Select ID From 临床出诊记录 Where 号源id = 号源id_In And 出诊日期 = 出诊日期_In) Loop
          Zl_Clinicvisitmodify(号源id_In, 安排id_In, 出诊日期_In, 登记人_In, 登记时间_In, 1);
        End Loop;
      End If;
    End If;
  
    --2.今日的安排换到前面
    If 调休日期_In Is Not Null Then
      --2.1.今日没有安排则不处理
      Select Count(1)
      Into n_Count
      From 临床出诊记录
      Where 号源id = 号源id_In And 出诊日期 = 出诊日期_In And Rownum < 2;
    
      If Nvl(n_Count, 0) > 0 Then
        --2.2.前面那一天的安排已存在预约挂号记录则不替换(有漏洞)
        Select Count(1)
        Into n_Count
        From 临床出诊记录 A, 病人挂号记录 B
        Where a.Id = b.出诊记录id And a.号源id = 号源id_In And a.出诊日期 = 调休日期_In And Rownum < 2;
      
        If Nvl(n_Count, 0) = 0 Then
          --[1]记录前面那一天的原安排ID,没有就不处理
          Begin
            Select ID
            Into n_安排id
            From (Select Rownum As Rn, ID
                   From 临床出诊安排
                   Where 号源id = 号源id_In And 调休日期_In Between 开始时间 And 终止时间 And 审核时间 Is Not Null
                   Order By 登记时间 Desc)
            Where Rn < 2;
          Exception
            When Others Then
              n_安排id := 0;
          End;
        
          If Nvl(n_安排id, 0) <> 0 Then
            --[2]删除前面那一天现有的安排
            Select ID Bulk Collect Into l_记录id From 临床出诊记录 Where 号源id = 号源id_In And 出诊日期 = 调休日期_In;
            Zl_临床出诊记录_Batchdelete(l_记录id);
          
            --[3]复制安排
            For c_换休记录 In (Select ID From 临床出诊记录 Where 号源id = 号源id_In And 出诊日期 = 出诊日期_In) Loop
              --肯定是发布了的
              Zl_临床出诊记录_Copy(c_换休记录.Id, n_安排id, 调休日期_In, 登记人_In, 登记时间_In, 1);
            
            End Loop;
          
            --[4]重新对前面那一天进行停诊安排和法定节假日调整
            For c_记录 In (Select ID From 临床出诊记录 Where 号源id = 号源id_In And 出诊日期 = 调休日期_In) Loop
              Zl_Clinicvisitmodify(号源id_In, 安排id_In, 调休日期_In, 登记人_In, 登记时间_In, 1);
            End Loop;
          End If;
        End If;
      End If;
    End If;
  End Changedaysoff;
Begin
  Begin
    Select Nvl(b.假日控制状态, 0), Nvl(b.是否假日换休, 0)
    Into n_假日控制状态, n_是否假日换休
    From 临床出诊号源 B
    Where b.Id = 号源id_In;
  Exception
    When Others Then
      --没有找到号源，直接退出
      Return;
  End;

  --================================================================================
  --【1】假日换休处理
  --说明：只能用后面的日期向前面检查，因为后面的日期可能还没有制定安排
  --================================================================================
  If Nvl(是否已换休_In, 0) = 0 Then
    --确定法定节假日是否需要换休
    If Nvl(n_是否假日换休, 0) = 1 Then
      --1.前面的安排换到今日
      Begin
        --开始日期：原本休息日(即调休日) ， 终止日期：原本上班日(即被调休日)
        Select a.终止日期
        Into d_原上班日期
        From 法定假日表 A
        Where a.性质 = 1 And 出诊日期_In = a.开始日期 And a.终止日期 < 出诊日期_In And Rownum < 2;
      Exception
        When Others Then
          d_原上班日期 := Null;
      End;
    
      --2.今日的安排换到前面
      Begin
        --开始日期：原本休息日(即调休日) ， 终止日期：原本上班日(即被调休日)
        Select a.开始日期
        Into d_调休日期
        From 法定假日表 A
        Where a.性质 = 1 And 出诊日期_In = a.终止日期 And a.开始日期 < 出诊日期_In And Rownum < 2;
      Exception
        When Others Then
          d_调休日期 := Null;
      End;
    
      Changedaysoff(号源id_In, 安排id_In, 出诊日期_In, d_原上班日期, d_调休日期);
    End If;
  End If;

  For c_记录 In (Select ID, 出诊日期, 开始时间, 终止时间
               From 临床出诊记录
               Where 号源id = 号源id_In And 出诊日期 = 出诊日期_In And 上班时段 Is Not Null) Loop
    --================================================================================
    --【2】停诊安排停诊处理
    --================================================================================
    For c_停诊 In (Select a.开始时间, Nvl(a.失效时间, a.终止时间) As 终止时间, a.停诊原因
                 From 临床出诊停诊记录 A, 临床出诊记录 B
                 Where a.申请人 = b.医生姓名 And a.记录id Is Null And a.审批时间 Is Not Null And b.医生id Is Not Null And
                       b.Id = c_记录.Id And c_记录.开始时间 < Nvl(a.失效时间, a.终止时间) And c_记录.终止时间 > a.开始时间
                 Order By a.审批时间) Loop
    
      d_停诊开始时间 := c_停诊.开始时间;
      d_停诊终止时间 := c_停诊.终止时间;
      If d_停诊开始时间 < c_记录.开始时间 Then
        d_停诊开始时间 := c_记录.开始时间;
      End If;
      If d_停诊终止时间 > c_记录.终止时间 Then
        d_停诊终止时间 := c_记录.终止时间;
      End If;
      Stopvisit(c_记录.Id, d_停诊开始时间, d_停诊终止时间, c_停诊.停诊原因);
    End Loop;
  
    --================================================================================
    --【3】法定节假日停诊及禁止预约处理
    --================================================================================
    --1.查找含有上班时段时间的节假日，以第一个为准（开始时间升序排序），一般也只有一个
    Begin
      Select 开始日期, 终止日期, 节日名称, 允许预约日期, 允许挂号日期
      Into d_假日开始日期, d_假日终止日期, v_停诊原因, v_允许预约, v_允许挂号
      From (Select a.开始日期, a.终止日期, a.节日名称, a.允许预约日期, a.允许挂号日期
             From 法定假日表 A
             Where a.性质 = 0 And c_记录.开始时间 < a.终止日期 And c_记录.终止时间 > a.开始日期
             Order By a.开始日期)
      Where Rownum < 2;
    Exception
      When Others Then
        d_假日开始日期 := Null;
        d_假日终止日期 := Null;
        v_停诊原因     := Null;
        v_允许预约     := Null;
        v_允许挂号     := Null;
    End;
  
    If v_停诊原因 Is Not Null Then
      --假日控制状态:0-不上班;1-上班且开放预约;2-上班但不开放预约;3-受节假日设置控制
      If Nvl(n_假日控制状态, 0) = 0 Then
        --不上班，停诊
        d_停诊开始时间 := d_假日开始日期;
        d_停诊终止时间 := d_假日终止日期 + 1 - 1 / 24 / 60 / 60;
        If d_停诊开始时间 < c_记录.开始时间 Then
          d_停诊开始时间 := c_记录.开始时间;
        End If;
        If d_停诊终止时间 > c_记录.终止时间 Then
          d_停诊终止时间 := c_记录.终止时间;
        End If;
        Stopvisit(c_记录.Id, d_停诊开始时间, d_停诊终止时间, v_停诊原因);
      Elsif Nvl(n_假日控制状态, 0) = 2 Then
        --允许挂号，但禁止预约
        d_停止预约开始时间 := d_假日开始日期;
        d_停止预约终止时间 := d_假日终止日期 + 1 - 1 / 24 / 60 / 60;
        If d_停止预约开始时间 < c_记录.开始时间 Then
          d_停止预约开始时间 := c_记录.开始时间;
        End If;
        If d_停止预约终止时间 > c_记录.终止时间 Then
          d_停止预约终止时间 := c_记录.终止时间;
        End If;
        Stopbespeak(c_记录.Id, d_停止预约开始时间, d_停止预约终止时间);
      Elsif Nvl(n_假日控制状态, 0) = 3 Then
        --没有"允许挂号"的就一定没有"允许预约"的
        If v_允许挂号 Is Not Null Then
          --2.检查是否有包含上班时段时间的"允许挂号"
          --因为上班时段最多24小时，所以查出的结果最多两天，且这两天一定是连续的
          n_允许挂号 := 0;
          For c_允许挂号 In (With 临时表 As
                            (Select To_Date(Column_Value, 'yyyy-mm-dd') As 开始时间,
                                   To_Date(Column_Value, 'yyyy-mm-dd') + 1 - 1 / 24 / 60 / 60 As 终止时间
                            From Table(f_Str2list(v_允许挂号, ';'))
                            Where c_记录.开始时间 < To_Date(Column_Value, 'yyyy-mm-dd') + 1 - 1 / 24 / 60 / 60 And
                                  c_记录.终止时间 > To_Date(Column_Value, 'yyyy-mm-dd')
                            Order By To_Date(Column_Value, 'yyyy-mm-dd'))
                           Select a.开始时间, Nvl(b.终止时间, a.终止时间) As 终止时间
                           From 临时表 A, 临时表 B
                           Where a.终止时间 = b.开始时间(+) - 1 / 24 / 60 / 60 And Rownum < 2) Loop
          
            n_允许挂号 := 1;
            n_允许预约 := 0;
            --3.检查是否有包含上班时段时间的"允许预约"
            For c_允许预约 In (With 临时表 As
                              (Select To_Date(Column_Value, 'yyyy-mm-dd') As 开始时间,
                                     To_Date(Column_Value, 'yyyy-mm-dd') + 1 - 1 / 24 / 60 / 60 As 终止时间
                              From Table(f_Str2list(v_允许预约, ';'))
                              Where c_记录.开始时间 < To_Date(Column_Value, 'yyyy-mm-dd') + 1 - 1 / 24 / 60 / 60 And
                                    c_记录.终止时间 > To_Date(Column_Value, 'yyyy-mm-dd')
                              Order By To_Date(Column_Value, 'yyyy-mm-dd'))
                             Select a.开始时间, Nvl(b.终止时间, a.终止时间) As 终止时间
                             From 临时表 A, 临时表 B
                             Where a.终止时间 = b.开始时间(+) - 1 / 24 / 60 / 60 And Rownum < 2) Loop
            
              n_允许预约 := 1;
              --在"允许挂号","允许预约"时间范围内的不需要处理
            
              --检查前后是否需要禁止预约
              If c_记录.开始时间 < c_允许预约.开始时间 And c_允许挂号.开始时间 < c_允许预约.开始时间 Then
                If c_记录.开始时间 < c_允许挂号.开始时间 Then
                  d_停止预约开始时间 := c_允许挂号.开始时间;
                Else
                  d_停止预约开始时间 := c_记录.开始时间;
                End If;
                d_停止预约终止时间 := c_允许预约.开始时间;
                Stopbespeak(c_记录.Id, d_停止预约开始时间, d_停止预约终止时间);
              End If;
            
              If c_记录.终止时间 > c_允许预约.终止时间 And c_允许挂号.终止时间 > c_允许预约.终止时间 Then
                d_停止预约开始时间 := c_允许预约.终止时间;
                If c_记录.终止时间 > c_允许挂号.终止时间 Then
                  d_停止预约开始时间 := c_允许挂号.终止时间;
                Else
                  d_停止预约开始时间 := c_记录.终止时间;
                End If;
                Stopbespeak(c_记录.Id, d_停止预约开始时间, d_停止预约终止时间);
              End If;
            End Loop;
          
            --允许挂号，但禁止预约
            If Nvl(n_允许预约, 0) = 0 Then
              d_停止预约开始时间 := c_允许挂号.开始时间;
              d_停止预约终止时间 := c_允许挂号.终止时间;
              If d_停止预约开始时间 < c_记录.开始时间 Then
                d_停止预约开始时间 := c_记录.开始时间;
              End If;
              If d_停止预约终止时间 > c_记录.终止时间 Then
                d_停止预约终止时间 := c_记录.终止时间;
              End If;
              Stopbespeak(c_记录.Id, d_停止预约开始时间, d_停止预约终止时间);
            End If;
          
            --检查前后是否需要停诊
            If c_记录.开始时间 < c_允许挂号.开始时间 And d_假日开始日期 < c_允许挂号.开始时间 Then
              If c_记录.开始时间 < d_假日开始日期 Then
                d_停诊开始时间 := d_假日开始日期;
              Else
                d_停诊开始时间 := c_记录.开始时间;
              End If;
              d_停诊终止时间 := c_允许挂号.开始时间;
              Stopvisit(c_记录.Id, d_停诊开始时间, d_停诊终止时间, v_停诊原因);
            End If;
          
            If c_记录.终止时间 > c_允许挂号.终止时间 And d_假日终止日期 > c_允许挂号.终止时间 Then
              d_停诊开始时间 := c_允许挂号.终止时间;
              If c_记录.终止时间 > d_假日终止日期 Then
                d_停诊终止时间 := d_停诊终止时间;
              Else
                d_停诊终止时间 := c_记录.终止时间;
              End If;
              Stopvisit(c_记录.Id, d_停诊开始时间, d_停诊终止时间, v_停诊原因);
            End If;
          End Loop;
        
          --不在设置的允许挂号时间范围内，停诊
          If Nvl(n_允许挂号, 0) = 0 Then
            d_停诊开始时间 := d_假日开始日期;
            d_停诊终止时间 := d_假日终止日期 + 1 - 1 / 24 / 60 / 60;
            If d_停诊开始时间 < c_记录.开始时间 Then
              d_停诊开始时间 := c_记录.开始时间;
            End If;
            If d_停诊终止时间 > c_记录.终止时间 Then
              d_停诊终止时间 := c_记录.终止时间;
            End If;
            Stopvisit(c_记录.Id, d_停诊开始时间, d_停诊终止时间, v_停诊原因);
          End If;
        Else
          --未设置允许挂号/允许预约，则停诊
          d_停诊开始时间 := d_假日开始日期;
          d_停诊终止时间 := d_假日终止日期 + 1 - 1 / 24 / 60 / 60;
          If d_停诊开始时间 < c_记录.开始时间 Then
            d_停诊开始时间 := c_记录.开始时间;
          End If;
          If d_停诊终止时间 > c_记录.终止时间 Then
            d_停诊终止时间 := c_记录.终止时间;
          End If;
          Stopvisit(c_记录.Id, d_停诊开始时间, d_停诊终止时间, v_停诊原因);
        End If;
      End If;
    End If;
  End Loop;
End Zl_Clinicvisitmodify;
/

--105791:冉俊明,2017-04-19,法定假日表字段名调整
Create Or Replace Function Zl_Fun_Get临床出诊预约状态
(
  记录id_In   In 临床出诊记录.Id%Type,
  预约时间_In In 病人挂号记录.预约时间%Type,
  序号_In     临床出诊序号控制.序号%Type := Null,
  预约方式_In 预约方式.名称%Type := Null,
  合作单位_In 挂号合作单位.名称%Type := Null,
  收费预约_In Number := 0
) Return Varchar2 As
  --功能：判断出诊记录在预约时间是否可预约
  --入参：
  --返回：
  --     格式：预约状态|提示信息，如："1|预约时间不在当前上班时段时间范围内。"
  --     预约状态：
  --         0-可预约
  --         ======================================================
  --         1-不可预约，预约时间不在当前上班时段时间范围内
  --         2-不可预约，当前上班时段禁止预约
  --         3-不可预约，当前上班时段在预约时间时已停诊
  --         4-不可预约，当前上班时段剩余可预约数为零
  --         ======================================================
  --         5-不可预约，当前预约时间在法定节假日时间范围内，不上班
  --         6-不可预约，当前预约时间在法定节假日时间范围内，禁止预约
  --         7-不可预约，当前预约时间在法定节假日不允许预约的时间范围内
  --         8-不可预约，当前预约时间在法定节假日不允许挂号的时间范围内
  --         9-不可预约，当前预约时间在法定节假日时间范围内，已停诊
  --         ======================================================
  --         10-不可预约，当前预约方式禁止预约
  --         11-不可预约，当前预约方式可预约数不足
  --         ======================================================
  --         12-不可预约，当前合作单位禁止预约
  --         13-不可预约，当前合作单位可预约数不足
  --         ======================================================
  --         14-不可预约，当前序号禁止预约
  --         15-不可预约，当前序号已经被使用
  --         16-不可预约，当前序号不可用
  --
  n_号源id         临床出诊记录.号源id%Type;
  n_是否分时段     临床出诊记录.是否分时段%Type;
  n_预约控制       临床出诊记录.预约控制%Type;
  d_停诊开始时间   临床出诊记录.停诊开始时间%Type;
  d_停诊终止时间   临床出诊记录.停诊终止时间%Type;
  v_停诊原因       临床出诊记录.停诊原因%Type;
  n_限约数         临床出诊记录.限约数%Type;
  n_已约数         临床出诊记录.已约数%Type;
  n_独占           临床出诊记录.是否独占%Type;
  n_控制方式       临床出诊挂号控制记录.控制方式%Type;
  n_数量           临床出诊挂号控制记录.数量%Type;
  n_数量限制       临床出诊挂号控制记录.数量%Type;
  n_序号控制       临床出诊记录.是否序号控制%Type;
  v_预约方式       临床出诊挂号控制记录.名称%Type;
  n_类型           临床出诊挂号控制记录.类型%Type;
  n_预约方式限约数 临床出诊记录.限约数%Type;
  n_预约方式已约数 临床出诊记录.已约数%Type;
  n_挂号状态       临床出诊序号控制.挂号状态%Type;
  n_是否预约       临床出诊序号控制.是否预约%Type;

  n_假日控制状态 临床出诊号源.假日控制状态%Type;

  v_允许预约 法定假日表.允许预约日期%Type;
  v_允许挂号 法定假日表.允许挂号日期%Type;
  n_Count    Number(2);
  n_已使用   Number(5);
Begin
  Begin
    Select a.号源id, a.是否分时段, a.预约控制, a.停诊开始时间, a.停诊终止时间, a.停诊原因, Nvl(限约数, 限号数), 已约数, 是否独占, 是否序号控制
    Into n_号源id, n_是否分时段, n_预约控制, d_停诊开始时间, d_停诊终止时间, v_停诊原因, n_限约数, n_已约数, n_独占, n_序号控制
    From 临床出诊记录 A
    Where a.Id = 记录id_In And 预约时间_In Between 开始时间 And 终止时间;
  Exception
    When Others Then
      Return '1|预约时间不在当前上班时段时间范围内。';
  End;

  --预约方式检查
  If 预约方式_In Is Not Null Then
    Begin
      Select 控制方式
      Into n_控制方式
      From 临床出诊挂号控制记录
      Where 类型 = 2 And 性质 = 1 And 记录id = 记录id_In And 名称 = 预约方式_In And Rownum < 2;
    Exception
      When Others Then
        Begin
          Select 控制方式
          Into n_控制方式
          From 临床出诊挂号控制记录
          Where 类型 = 2 And 性质 = 1 And 记录id = 记录id_In And Rownum < 2;
        Exception
          When Others Then
            Null;
        End;
    End;
    If n_控制方式 = 0 Then
      Return '10|当前预约方式禁止预约。';
    End If;
    If n_控制方式 = 1 Or n_控制方式 = 2 Then
      Select Nvl(限约数, 限号数) Into n_预约方式限约数 From 临床出诊记录 Where ID = 记录id_In;
      If n_独占 = 0 Then
        Begin
          Select 数量
          Into n_数量
          From 临床出诊挂号控制记录
          Where 类型 = 2 And 性质 = 1 And 名称 = 预约方式_In And 记录id = 记录id_In;
        Exception
          When Others Then
            n_数量 := Null;
        End;
        If n_数量 Is Not Null Then
          If n_控制方式 = 1 Then
            n_预约方式限约数 := Round(n_预约方式限约数 * n_数量 / 100);
          Else
            n_预约方式限约数 := n_数量;
          End If;
          Select Count(1)
          Into n_预约方式已约数
          From 病人挂号记录
          Where 出诊记录id = 记录id_In And 记录状态 = 1 And 预约方式 = 预约方式_In;
          If n_预约方式已约数 >= n_预约方式限约数 Then
            Return '11|当前预约方式可预约数不足。';
          End If;
        End If;
      Else
        --限数量独占
        Begin
          Select 数量
          Into n_数量
          From 临床出诊挂号控制记录
          Where 类型 = 2 And 性质 = 1 And 名称 = 预约方式_In And 记录id = 记录id_In;
        Exception
          When Others Then
            n_数量 := Null;
        End;
        If n_数量 Is Not Null Then
          If n_控制方式 = 1 Then
            n_预约方式限约数 := Round(n_预约方式限约数 * n_数量 / 100);
          Else
            n_预约方式限约数 := n_数量;
          End If;
          Select Count(1)
          Into n_预约方式已约数
          From 病人挂号记录
          Where 出诊记录id = 记录id_In And 记录状态 = 1 And 预约方式 = 预约方式_In;
          If n_预约方式已约数 >= n_预约方式限约数 Then
            Return '11|当前预约方式可预约数不足。';
          End If;
        Else
          If 收费预约_In = 0 Then
            For r_限制 In (Select 数量, 名称, 类型 From 临床出诊挂号控制记录 Where 性质 = 1 And 记录id = 记录id_In) Loop
              If r_限制.类型 = 1 Then
                Select Count(1)
                Into n_已使用
                From 病人挂号记录
                Where 出诊记录id = 记录id_In And 合作单位 = r_限制.名称 And 记录状态 = 1;
              Else
                Select Count(1)
                Into n_已使用
                From 病人挂号记录
                Where 出诊记录id = 记录id_In And 预约方式 = r_限制.名称 And 记录状态 = 1;
              End If;
              If n_控制方式 = 1 Then
                n_数量限制 := Nvl(n_数量限制, 0) + Round(r_限制.数量 * n_预约方式限约数 / 100) - Nvl(n_已使用, 0);
              Else
                n_数量限制 := Nvl(n_数量限制, 0) + r_限制.数量 - Nvl(n_已使用, 0);
              End If;
            End Loop;
            Select Count(1) Into n_已使用 From 病人挂号记录 Where 出诊记录id = 记录id_In And 记录状态 = 1;
            If n_预约方式限约数 - n_数量限制 - n_已使用 > 0 Then
              Null;
            Else
              Return '11|当前预约方式可预约数不足。';
            End If;
          Else
            For r_限制 In (Select 数量, 名称, 类型
                         From 临床出诊挂号控制记录
                         Where 性质 = 1 And 类型 = 2 And 记录id = 记录id_In) Loop
              Select Count(1)
              Into n_已使用
              From 病人挂号记录
              Where 出诊记录id = 记录id_In And 预约方式 = r_限制.名称 And 记录状态 = 1;
              If n_控制方式 = 1 Then
                n_数量限制 := Nvl(n_数量限制, 0) + Round(r_限制.数量 * n_预约方式限约数 / 100) - Nvl(n_已使用, 0);
              Else
                n_数量限制 := Nvl(n_数量限制, 0) + r_限制.数量 - Nvl(n_已使用, 0);
              End If;
            End Loop;
            Select Count(1) Into n_已使用 From 病人挂号记录 Where 出诊记录id = 记录id_In And 记录状态 = 1;
            If n_预约方式限约数 - n_数量限制 - n_已使用 > 0 Then
              Null;
            Else
              Return '11|当前预约方式可预约数不足。';
            End If;
          End If;
        End If;
      End If;
    End If;
    If n_控制方式 = 3 Then
      If n_序号控制 = 1 Then
        If 收费预约_In = 0 Then
          Begin
            Select 数量, 名称, 类型
            Into n_预约方式限约数, v_预约方式, n_类型
            From 临床出诊挂号控制记录
            Where 性质 = 1 And 记录id = 记录id_In And 序号 = 序号_In;
          Exception
            When Others Then
              n_预约方式限约数 := Null;
          End;
          If n_预约方式限约数 Is Not Null Then
            If v_预约方式 <> 预约方式_In Or n_类型 = 1 Then
              Return '11|当前预约方式可预约数不足。';
            End If;
            Select Nvl(Max(1), 0)
            Into n_预约方式已约数
            From 病人挂号记录
            Where 出诊记录id = 记录id_In And 号序 = 序号_In;
            If n_预约方式已约数 >= n_预约方式限约数 Then
              Return '11|当前预约方式可预约数不足。';
            End If;
          End If;
        Else
          Begin
            Select 数量, 名称, 类型
            Into n_预约方式限约数, v_预约方式, n_类型
            From 临床出诊挂号控制记录
            Where 性质 = 1 And 类型 = 2 And 记录id = 记录id_In And 序号 = 序号_In;
          Exception
            When Others Then
              n_预约方式限约数 := Null;
          End;
          If n_预约方式限约数 Is Not Null Then
            If v_预约方式 <> 预约方式_In Then
              Return '11|当前预约方式可预约数不足。';
            End If;
            Select Nvl(Max(1), 0)
            Into n_预约方式已约数
            From 病人挂号记录
            Where 出诊记录id = 记录id_In And 号序 = 序号_In;
            If n_预约方式已约数 >= n_预约方式限约数 Then
              Return '11|当前预约方式可预约数不足。';
            End If;
          End If;
        End If;
      Else
        If 收费预约_In = 0 Then
          For r_限制 In (Select 数量, 名称, 类型
                       From 临床出诊挂号控制记录
                       Where 性质 = 1 And 记录id = 记录id_In And 序号 = 序号_In) Loop
            If r_限制.名称 <> 预约方式_In Or r_限制.类型 = 1 Then
              If r_限制.类型 = 1 Then
                Select Count(1)
                Into n_已使用
                From 临床出诊序号控制 A, 病人挂号记录 B
                Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And a.备注 = b.号序 And
                      b.合作单位 = r_限制.名称 And b.记录状态 = 1;
              Else
                Select Count(1)
                Into n_已使用
                From 临床出诊序号控制 A, 病人挂号记录 B
                Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And a.备注 = b.号序 And
                      b.预约方式 = r_限制.名称 And b.记录状态 = 1;
              End If;
              n_数量限制 := Nvl(n_数量限制, 0) + r_限制.数量 - Nvl(n_已使用, 0);
            Else
              Select Count(1)
              Into n_预约方式已约数
              From 临床出诊序号控制 A, 病人挂号记录 B
              Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And a.备注 = b.号序 And
                    b.预约方式 = 预约方式_In And b.记录状态 = 1;
              If n_预约方式已约数 >= n_预约方式限约数 Then
                Return '11|当前预约方式可预约数不足。';
              End If;
            End If;
          End Loop;
          Select Count(1)
          Into n_已使用
          From 临床出诊序号控制 A
          Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And 序号 = 序号_In;
          Select Nvl(限约数, 限号数) Into n_预约方式限约数 From 临床出诊记录 Where ID = 记录id_In;
          If n_预约方式限约数 - n_数量限制 - n_已使用 > 0 Then
            Null;
          Else
            Return '11|当前预约方式可预约数不足。';
          End If;
        Else
          For r_限制 In (Select 数量, 名称, 类型
                       From 临床出诊挂号控制记录
                       Where 性质 = 1 And 类型 = 2 And 记录id = 记录id_In And 序号 = 序号_In) Loop
            If r_限制.名称 <> 预约方式_In Then
              Select Count(1)
              Into n_已使用
              From 临床出诊序号控制 A, 病人挂号记录 B
              Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And a.备注 = b.号序 And
                    b.预约方式 = r_限制.名称 And b.记录状态 = 1;
              n_数量限制 := Nvl(n_数量限制, 0) + r_限制.数量 - Nvl(n_已使用, 0);
            Else
              Select Count(1)
              Into n_预约方式已约数
              From 临床出诊序号控制 A, 病人挂号记录 B
              Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And a.备注 = b.号序 And
                    b.预约方式 = 预约方式_In And b.记录状态 = 1;
              If n_预约方式已约数 >= n_预约方式限约数 Then
                Return '11|当前预约方式可预约数不足。';
              End If;
            End If;
          End Loop;
          Select Count(1)
          Into n_已使用
          From 临床出诊序号控制 A
          Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And 序号 = 序号_In;
          Select Nvl(限约数, 限号数) Into n_预约方式限约数 From 临床出诊记录 Where ID = 记录id_In;
          If n_预约方式限约数 - n_数量限制 - n_已使用 > 0 Then
            Null;
          Else
            Return '11|当前预约方式可预约数不足。';
          End If;
        End If;
      End If;
    End If;
  End If;

  --合作单位检查
  If 合作单位_In Is Not Null Then
    Begin
      Select 控制方式
      Into n_控制方式
      From 临床出诊挂号控制记录
      Where 类型 = 1 And 性质 = 1 And 记录id = 记录id_In And 名称 = 合作单位_In And Rownum < 2;
    Exception
      When Others Then
        Begin
          Select 控制方式
          Into n_控制方式
          From 临床出诊挂号控制记录
          Where 类型 = 1 And 性质 = 1 And 记录id = 记录id_In And Rownum < 2;
        Exception
          When Others Then
            Null;
        End;
    End;
    If n_控制方式 = 0 Then
      Return '12|当前合作单位禁止预约。';
    End If;
    If n_控制方式 = 1 Or n_控制方式 = 2 Then
      Select Nvl(限约数, 限号数) Into n_预约方式限约数 From 临床出诊记录 Where ID = 记录id_In;
      If n_独占 = 0 Then
        Begin
          Select 数量
          Into n_数量
          From 临床出诊挂号控制记录
          Where 类型 = 1 And 性质 = 1 And 名称 = 合作单位_In And 记录id = 记录id_In;
        Exception
          When Others Then
            n_数量 := Null;
        End;
        If n_数量 Is Not Null Then
          If n_控制方式 = 1 Then
            n_预约方式限约数 := Round(n_预约方式限约数 * n_数量 / 100);
          Else
            n_预约方式限约数 := n_数量;
          End If;
          Select Count(1)
          Into n_预约方式已约数
          From 病人挂号记录
          Where 出诊记录id = 记录id_In And 记录状态 = 1 And 合作单位 = 合作单位_In;
          If n_预约方式已约数 >= n_预约方式限约数 Then
            Return '13|当前合作单位可预约数不足。';
          End If;
        End If;
      Else
        --限数量独占
        Begin
          Select 数量
          Into n_数量
          From 临床出诊挂号控制记录
          Where 类型 = 1 And 性质 = 1 And 名称 = 合作单位_In And 记录id = 记录id_In;
        Exception
          When Others Then
            n_数量 := Null;
        End;
        If n_数量 Is Not Null Then
          If n_控制方式 = 1 Then
            n_预约方式限约数 := Round(n_预约方式限约数 * n_数量 / 100);
          Else
            n_预约方式限约数 := n_数量;
          End If;
          Select Count(1)
          Into n_预约方式已约数
          From 病人挂号记录
          Where 出诊记录id = 记录id_In And 记录状态 = 1 And 合作单位 = 合作单位_In;
          If n_预约方式已约数 >= n_预约方式限约数 Then
            Return '13|当前合作单位可预约数不足。';
          End If;
        Else
          For r_限制 In (Select 数量, 名称, 类型 From 临床出诊挂号控制记录 Where 性质 = 1 And 记录id = 记录id_In) Loop
            If r_限制.类型 = 1 Then
              Select Count(1)
              Into n_已使用
              From 病人挂号记录
              Where 出诊记录id = 记录id_In And 合作单位 = r_限制.名称 And 记录状态 = 1;
            Else
              Select Count(1)
              Into n_已使用
              From 病人挂号记录
              Where 出诊记录id = 记录id_In And 预约方式 = r_限制.名称 And 记录状态 = 1;
            End If;
            If n_控制方式 = 1 Then
              n_数量限制 := Nvl(n_数量限制, 0) + Round(r_限制.数量 * n_预约方式限约数 / 100) - Nvl(n_已使用, 0);
            Else
              n_数量限制 := Nvl(n_数量限制, 0) + r_限制.数量 - Nvl(n_已使用, 0);
            End If;
          End Loop;
          Select Count(1) Into n_已使用 From 病人挂号记录 Where 出诊记录id = 记录id_In And 记录状态 = 1;
          If n_预约方式限约数 - n_数量限制 - n_已使用 > 0 Then
            Null;
          Else
            Return '13|当前合作单位可预约数不足。';
          End If;
        End If;
      End If;
    End If;
    If n_控制方式 = 3 Then
      If n_序号控制 = 1 Then
        Begin
          Select 数量, 名称, 类型
          Into n_预约方式限约数, v_预约方式, n_类型
          From 临床出诊挂号控制记录
          Where 性质 = 1 And 记录id = 记录id_In And 序号 = 序号_In;
        Exception
          When Others Then
            n_预约方式限约数 := Null;
        End;
        If n_预约方式限约数 Is Not Null Then
          If v_预约方式 <> 合作单位_In Or n_类型 = 1 Then
            Return '13|当前合作单位可预约数不足。';
          End If;
          Select Nvl(Max(1), 0)
          Into n_预约方式已约数
          From 病人挂号记录
          Where 出诊记录id = 记录id_In And 号序 = 序号_In;
          If n_预约方式已约数 >= n_预约方式限约数 Then
            Return '13|当前合作单位可预约数不足。';
          End If;
        End If;
      Else
        For r_限制 In (Select 数量, 名称, 类型
                     From 临床出诊挂号控制记录
                     Where 性质 = 1 And 记录id = 记录id_In And 序号 = 序号_In) Loop
          If r_限制.名称 <> 合作单位_In Or r_限制.类型 = 1 Then
            If r_限制.类型 = 1 Then
              Select Count(1)
              Into n_已使用
              From 临床出诊序号控制 A, 病人挂号记录 B
              Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And a.备注 = b.号序 And
                    b.合作单位 = r_限制.名称 And b.记录状态 = 1;
            Else
              Select Count(1)
              Into n_已使用
              From 临床出诊序号控制 A, 病人挂号记录 B
              Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And a.备注 = b.号序 And
                    b.预约方式 = r_限制.名称 And b.记录状态 = 1;
            End If;
            n_数量限制 := Nvl(n_数量限制, 0) + r_限制.数量 - Nvl(n_已使用, 0);
          Else
            Select Count(1)
            Into n_预约方式已约数
            From 临床出诊序号控制 A, 病人挂号记录 B
            Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And a.备注 = b.号序 And b.合作单位 = 合作单位_In And
                  b.记录状态 = 1;
            If n_预约方式已约数 >= n_预约方式限约数 Then
              Return '13|当前合作单位可预约数不足。';
            End If;
          End If;
        End Loop;
        Select Count(1)
        Into n_已使用
        From 临床出诊序号控制 A
        Where a.记录id = 记录id_In And a.预约顺序号 Is Not Null And Nvl(a.挂号状态, 0) <> 0 And 序号 = 序号_In;
        Select Nvl(限约数, 限号数) Into n_预约方式限约数 From 临床出诊记录 Where ID = 记录id_In;
        If n_预约方式限约数 - n_数量限制 - n_已使用 > 0 Then
          Null;
        Else
          Return '13|当前合作单位可预约数不足。';
        End If;
      End If;
    End If;
  End If;

  --0-不作预约限制;1-该号别禁止预约;2-仅禁止三方机构平台的预约
  If Nvl(n_预约控制, 0) = 1 Then
    Return '2|当前上班时段禁止预约。';
  End If;

  If d_停诊开始时间 Is Not Null And Not (Nvl(n_序号控制, 0) = 1 And Nvl(n_是否分时段, 0) = 1) Then
    If 预约时间_In >= d_停诊开始时间 And 预约时间_In <= d_停诊终止时间 Then
      Return '3|当前上班时段在预约时间时已停诊，不能预约！';
    End If;
  End If;

  If Nvl(n_限约数, 0) > 0 Then
    If Nvl(n_限约数, 0) - Nvl(n_已约数, 0) <= 0 Then
      Return '4|当前上班时段剩余可预约数为零，不能继续预约！';
    End If;
  End If;

  If Nvl(n_是否分时段, 0) = 0 Then
    --不分时段
    Begin
      Select Nvl(b.假日控制状态, 0) Into n_假日控制状态 From 临床出诊号源 B Where b.Id = n_号源id;
    Exception
      When Others Then
        n_假日控制状态 := 0;
    End;
  
    --1.查找包含预约时间的节假日
    Begin
      Select a.允许预约日期, a.允许挂号日期
      Into v_允许预约, v_允许挂号
      From 法定假日表 A
      Where a.性质 = 0 And 预约时间_In Between a.开始日期 And a.终止日期 + 1 - 1 / 24 / 60 / 60 And Rownum < 2;
    Exception
      When Others Then
        Return '0|正常预约。';
    End;
  
    --假日控制状态：0-不上班;1-上班且开放预约;2-上班但不开放预约;3-受节假日设置控制
    If Nvl(n_假日控制状态, 0) = 0 Then
      --不上班的肯定是不能预约的
      Return '5|当前预约时间在法定节假日时间范围内，不上班。';
    Elsif Nvl(n_假日控制状态, 0) = 1 Then
      Return '0|正常预约。';
    Elsif Nvl(n_假日控制状态, 0) = 2 Then
      --在节假日时间范围内，则不能预约
      Return '6|当前预约时间在法定节假日时间范围内，禁止预约。';
    Elsif Nvl(n_假日控制状态, 0) = 3 Then
      --没有"允许挂号"就一定没有"允许预约"
      If v_允许挂号 Is Not Null Then
        --2.检查是否有包含预约时间的"允许挂号"
        Select Max(1)
        Into n_Count
        From Table(f_Str2list(v_允许挂号, ';'))
        Where 预约时间_In Between To_Date(Column_Value, 'yyyy-mm-dd') And
              To_Date(Column_Value, 'yyyy-mm-dd') + 1 - 1 / 24 / 60 / 60 And Rownum < 2;
      
        If Nvl(n_Count, 0) <> 0 Then
          --3.检查是否有包含预约时间的"允许预约"
          Select Max(1)
          Into n_Count
          From Table(f_Str2list(v_允许预约, ';'))
          Where 预约时间_In Between To_Date(Column_Value, 'yyyy-mm-dd') And
                To_Date(Column_Value, 'yyyy-mm-dd') + 1 - 1 / 24 / 60 / 60 And Rownum < 2;
        
          If Nvl(n_Count, 0) = 0 Then
            --不在"允许预约"时间范围内，则不能预约
            Return '7|当前预约时间在法定节假日不允许预约的时间范围内，不能预约。';
          Else
            Return '0|正常预约。';
          End If;
        Else
          Return '8|当前预约时间在法定节假日不允许挂号的时间范围内，不能预约。';
        End If;
      Else
        --没有设置"允许挂号"/"允许预约"表示停诊，肯定不能预约
        Return '9|当前预约时间在法定节假日时间范围内，已停诊，不能预约。';
      End If;
    End If;
  Else
    --分时段
    If Nvl(序号_In, 0) <> 0 Then
      Begin
        Select Nvl(是否预约, 0), Nvl(挂号状态, 0)
        Into n_是否预约, n_挂号状态
        From 临床出诊序号控制
        Where 记录id = 记录id_In And 序号 = 序号_In;
      Exception
        When Others Then
          Return '16|当前选择的序号不可用。';
      End;
      If n_是否预约 = 0 Then
        Return '14|当前选择的序号禁止预约。';
      End If;
      If n_挂号状态 <> 0 Then
        Return '15|当前选择的序号已经被使用。';
      End If;
    End If;
    Return '0|正常预约。';
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Fun_Get临床出诊预约状态;
/

--106321:刘尔旋,2017-04-05,删除新版本中不使用的过程
Drop Procedure zl_结帐预交记录_三方退款;

--105420:陈刘,2017-04-01,体温单数据修改时,需同步修改体温单打印的状态为重打
Create Or Replace Procedure Zl_体温单数据_Update
(
  文件id_In   In 病人护理文件.Id%Type, --病人护理文件ID
  发生时间_In In 病人护理数据.发生时间%Type, --护理数据的发生时间
  记录类型_In In 病人护理明细.记录类型%Type, --护理项目=1，上标说明=2，入出转标记=3，手术日标记=4,下标说明=6
  项目序号_In In 病人护理明细.项目序号%Type, --护理项目的序号，非护理项目固定为0
  记录内容_In In 病人护理明细.记录内容%Type := Null, --记录内容，如果内容为空，即清除以前的内容  36或36/37
  体温部位_In In 病人护理明细.体温部位%Type := Null, --删除数据时不用填写部位 除活动项目外
  复试合格_In In Number := 0,
  未记说明_In In 病人护理明细.未记说明%Type := Null, --未记说明
  他人记录_In In Number := 1,
  数据来源_In In 病人护理明细.数据来源%Type := 0,
  来源id_In   In 病人护理明细.来源id%Type := Null, --始终为原始记录的来源ID
  共用_In     In 病人护理明细.共用%Type := 0,
  项目首次_In In Number := 0, --汇总项目使用，保存数据前是否先删除一段时间内的数据信息。 1 删除
  开始时间_In In 病人护理数据.发生时间%Type := Null, --本记录有效跨度的开始时间
  结束时间_In In 病人护理数据.发生时间%Type := Null, --本记录有效跨度的终止时间，单独记录为每分钟，体温表为4小时,时间跨度内的相同项目记录要删除



  操作员_In   In 病人护理数据.保存人%Type := Null,
  检查科室_In In Number := 1
) Is
  n_项目序号 病人护理明细.项目序号%Type;
  n_记录标记 病人护理明细.记录标记%Type; --记录内容的特殊标志
  v_保存人   病人护理数据.保存人%Type;
  v_记录人   病人护理明细.记录人%Type;
  d_结束时间 病人护理数据.发生时间%Type;
  d_发生时间 病人护理数据.发生时间%Type;
  d_开始时间 病人护理数据.发生时间%Type;
  n_记录id   病人护理明细.记录id%Type;
  v_科室id   病人护理文件.科室id%Type;
  n_心率应用 护理记录项目.应用方式%Type;
  n_脉搏     护理记录项目.项目序号%Type := 2;
  n_体温     护理记录项目.项目序号%Type := 1;
  n_心率     护理记录项目.项目序号%Type := -1;
  n_项目性质 护理记录项目.项目性质%Type := 1;
  n_开始版本 病人护理明细.开始版本%Type;
  n_疼痛强度 护理记录项目.项目序号%Type;

  n_病人id       病人护理文件.病人id%Type;
  n_主页id       病人护理文件.主页id%Type;
  n_婴儿         病人护理文件.婴儿%Type;
  d_婴儿出院时间 病人医嘱记录.开始执行时间%Type;
  d_文件开始时间 病人护理文件.开始时间%Type;
  n_Preblue      Number;
  n_i            Number;
  n_Sqlrowcount  Number;
  Lngorder       Number;
  v_记录内容     病人护理明细.记录内容%Type;
  v_Data         病人护理明细.记录内容%Type;
  --主过程
  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  d_发生时间 := 发生时间_In;

  If d_发生时间 Is Null Then
    v_Error := '数据发生时间不能为空！';
    Raise Err_Custom;
  End If;

  If 开始时间_In Is Null Then
    d_开始时间 := d_发生时间;
  Else
    d_开始时间 := 开始时间_In;
  End If;

  If 结束时间_In Is Null Then
    d_结束时间 := d_开始时间;
  Else
    d_结束时间 := 结束时间_In;
  End If;

  --提取记录ID
  n_记录id := 0;
  If 操作员_In Is Null Then
    v_保存人 := Zl_Username;
  Else
    v_保存人 := 操作员_In;
  End If;
  ----------------------------------------------------------------------------------------------------------------------
  Begin
    Select Id Into n_记录id From 病人护理数据 Where 文件id = 文件id_In And 发生时间 = 发生时间_In;
  Exception
    When Others Then
      n_记录id := 0;
  End;

  --检查数据的发生时间是否对应科室
  ---------------------------------------------------------------------------------------------------------------------
  Select 病人id, 主页id, Nvl(婴儿, 0), 开始时间
  Into n_病人id, n_主页id, n_婴儿, d_文件开始时间
  From 病人护理文件
  Where Id = 文件id_In;
  d_婴儿出院时间 := Null;
  If n_婴儿 <> 0 Then
    Begin
      Select 开始执行时间
      Into d_婴儿出院时间
      From 病人医嘱记录 b, 诊疗项目目录 c
      Where b.诊疗项目id + 0 = c.Id And b.医嘱状态 = 8 And Nvl(b.婴儿, 0) <> 0 And c.类别 = 'Z' And
            Instr(',3,5,11,', ',' || c.操作类型 || ',', 1) > 0 And b.病人id = n_病人id And b.主页id = n_主页id And b.婴儿 = n_婴儿;
    Exception
      When Others Then
        d_婴儿出院时间 := Null;
    End;
  End If;
  If d_婴儿出院时间 Is Null Then
    v_科室id := 0;
    Begin
      Select a.科室id
      Into v_科室id
      From 病人变动记录 a, 病人护理文件 b
      Where a.科室id Is Not Null And a.病人id = b.病人id And a.主页id = b.主页id And b.Id = 文件id_In And
            (发生时间_In >= a.开始时间 And (发生时间_In < = Nvl(a.终止时间, Sysdate) Or a.终止时间 Is Null)) And Rownum < 2;
    Exception
      When Others Then
        v_科室id := 0;
    End;
    If v_科室id = 0 And 检查科室_In = 1 Then
      v_Error := '数据发生时间 ' || To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI:SS') || ' 不在病人有效变动时间范围内，不能操作！';
      Raise Err_Custom;
    End If;
  Else
    If 发生时间_In < d_文件开始时间 Or (发生时间_In > d_婴儿出院时间 and 检查科室_In = 1)  Then
      v_Error := '数据发生时间 ' || To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI:SS') || ' 不在病人有效变动时间范围内，不能操作！';
      Raise Err_Custom;
    End If;
  End If;
  --检查是不是本人的记录
  ---------------------------------------------------------------------------------------------------------------------
  If 他人记录_In = 0 And n_记录id > 0 Then
    v_记录人 := '';
    Begin
      Select 记录人
      Into v_记录人
      From 病人护理明细
      Where 记录id = n_记录id And 记录类型 = 记录类型_In And 项目序号 = 项目序号_In And 终止版本 Is Null And Rownum < 2
      Order By Nvl(记录标记, 0);
    Exception
      When Others Then
        v_记录人 := '';
    End;
    If v_记录人 Is Not Null And v_记录人 <> v_保存人 Then
      v_Error := '在' || To_Char(d_开始时间, 'yyyy-mm-dd hh24:mi:ss') || '至' || To_Char(d_结束时间, 'yyyy-mm-dd hh24:mi:ss') ||
                 '段内记录人不是当前人，你无权修改！';
      Raise Err_Custom;
    End If;
  End If;

  --提取疼痛强度曲线项目的项目序号
  Begin
    Select 项目序号 Into n_疼痛强度 From 体温记录项目 Where 记录名 = '疼痛强度';
  Exception
    When Others Then
      n_疼痛强度 := -999;
  End;
  --检查脉搏心率是否共用
  If 项目序号_In = n_脉搏 Then
    n_项目序号 := n_心率;
  Else
    n_项目序号 := 项目序号_In;
  End If;
  Begin
    Select 应用方式, 项目性质 Into n_心率应用, n_项目性质 From 护理记录项目 Where 项目序号 = n_项目序号;
  Exception
    When Others Then
      n_心率应用 := 0;
  End;

  ----清除某段时间内的护理数据信息
  --项目首次_In 汇总项目根据汇总时间段保存一天数据时先清除在保存 项目首次_In：=1
  --记录内容_In Is Null And 未记说明_In Is Null 则认为删除数据
  ---------------------------------------------------------------------------------------------------------------------
  If (项目首次_In = 1) Or (记录内容_In Is Null And 未记说明_In Is Null) Then
    For r_List In (Select l.Id, Count(*) As 记录数, Min(l.发生时间) 发生时间
                   From 病人护理文件 a, 病人护理数据 l, 病人护理明细 d
                   Where a.Id = l.文件id And l.Id = d.记录id And a.Id = 文件id_In And d.终止版本 Is Null And l.发生时间 >= d_开始时间 And
                         l.发生时间 <= d_结束时间
                   Group By l.Id) Loop
      n_Sqlrowcount := 0;
      If 记录类型_In = 2 Or 记录类型_In = 6 Then
        Delete 病人护理明细
        Where 记录id = r_List.Id And 记录类型 = 记录类型_In And 项目序号 = 项目序号_In And 终止版本 Is Null;
        n_Sqlrowcount := Sql%Rowcount;
      Else
        If 体温部位_In Is Not Null Then
          --此处主要针对活动项目
          Delete 病人护理明细
          Where 记录id = r_List.Id And 记录类型 = 记录类型_In And 项目序号 = 项目序号_In And Nvl(体温部位, '无') = Nvl(体温部位_In, '无') And
                终止版本 Is Null;
        Else
          Delete 病人护理明细
          Where 记录id = r_List.Id And 记录类型 = 记录类型_In And 项目序号 = 项目序号_In And 终止版本 Is Null;
        End If;
      
        n_Sqlrowcount := Sql%Rowcount;
        --如果脉搏和心率共用删除脉搏是同时删除心率数据
        If 项目序号_In = n_脉搏 And n_心率应用 = 2 Then
          Delete 病人护理明细
          Where 记录id = r_List.Id And 记录类型 = 记录类型_In And 项目序号 = n_心率 And 终止版本 Is Null;
          n_Sqlrowcount := n_Sqlrowcount + Sql%Rowcount;
        End If;
        --如果为收缩压/舒张压删除收缩压时同时删除舒张压数据
        If 项目序号_In = 4 Then
          Delete 病人护理明细
          Where 记录id = r_List.Id And 记录类型 = 记录类型_In And 项目序号 = 5 And 终止版本 Is Null;
          n_Sqlrowcount := n_Sqlrowcount + Sql%Rowcount;
        End If;
      End If;
      If n_Sqlrowcount >= r_List.记录数 Then
        Delete 病人护理数据 Where Id = r_List.Id;
      End If;
      --更新打印
      Update 体温单打印
      Set 打印人 = Null, 打印时间 = Null
      Where 文件id = 文件id_In And
            开始时间 = (Select Max(开始时间) From 体温单打印 Where 文件id = 文件id_In And 开始时间 <= r_List.发生时间);
    End Loop;
  End If;

  If 记录内容_In Is Null And 未记说明_In Is Null Then
    Return;
  End If;

  --分解项目记录内容
  n_Preblue := 0;
  If 记录类型_In = 1 And Instr(',' || n_疼痛强度 || ',1,2,4,', ',' || 项目序号_In || ',', 1) > 0 Then
    n_Preblue := Nvl(Instr(Nvl(记录内容_In, ''), '/', 1), 0);
    If n_Preblue > 1 Then
      n_Preblue := 1;
    End If;
  End If;

  If 项目序号_In = 4 And n_Preblue = 0 Then
    v_Error := '血压数据格式错误! 格式:收缩压/舒张压。';
    Raise Err_Custom;
  End If;

  --确认开始版本号
  ---------------------------------------------------------------------------------------------------------------------
  n_开始版本 := 1;

  --改写病人护理数据：如果已经存在与病人、科室和发生时间相同的记录则修改，否则增加新的记录
  ---------------------------------------------------------------------------------------------------------------------
  --汇总项目是删除后在增加，可能开始提取的记录ID已经不存在。
  Begin
    Select Id Into n_记录id From 病人护理数据 Where Id = n_记录id;
  Exception
    When Others Then
      n_记录id := 0;
  End;

  If n_记录id = 0 Then
    Select 病人护理数据_Id.Nextval Into n_记录id From Dual;
    Insert Into 病人护理数据
      (Id, 文件id, 显示, 发生时间, 保存人, 保存时间, 最后版本)
    Values
      (n_记录id, 文件id_In, 0, d_发生时间, v_保存人, Sysdate, n_开始版本);
  End If;

  --检查删除物理降温数据或脉搏短轴数据
  If (项目序号_In = n_体温 Or 项目序号_In = n_疼痛强度 Or (项目序号_In = n_脉搏 And n_心率应用 = 2)) And n_Preblue = 0 Then
    Delete From 病人护理明细
    Where 记录id = n_记录id And 项目序号 = Decode(项目序号_In, n_脉搏, n_心率, 项目序号_In) And
          Decode(项目序号_In, n_脉搏, 1, Nvl(记录标记, 0)) = 1 And 记录类型 = 记录类型_In And 终止版本 Is Null;
  End If;

  --改写病人护理明细：如果已经存在与病人、科室和发生时间相同的记录则修改，否则增加新的记录
  -----------------------------------------------------------------------------------------------------------------------
  v_Data     := 记录内容_In;
  n_项目序号 := 项目序号_In;
  For n_i In 0 .. n_Preblue Loop
    If n_i = 0 Then
      If 项目序号_In = n_心率 Then
        n_记录标记 := 1;
      Else
        n_记录标记 := 0;
      End If;
    Else
      --收缩压/舒张压
      If 项目序号_In = 4 Then
        n_记录标记 := 0;
        n_项目序号 := 5;
      Else
        n_记录标记 := 1;
        If 项目序号_In = n_脉搏 Then
          n_项目序号 := n_心率;
        End If;
      End If;
    
    End If;
    If n_Preblue > 0 Then
      v_记录内容 := Substr(v_Data, 1, Instr(v_Data, '/', 1) - 1);
      If v_记录内容 Is Null Then
        v_记录内容 := v_Data;
      End If;
    Else
      v_记录内容 := v_Data;
    End If;
  
    --为了兼容以前同步过来的心率数据记录标记为0
    If n_i = 0 Then
      Update 病人护理明细
      Set 记录内容 = v_记录内容, 体温部位 = 体温部位_In, 复试合格 = 复试合格_In,
          未记说明 = Decode(n_项目序号, n_体温, Decode(v_记录内容, '不升', Null, 未记说明_In), 未记说明_In), 记录人 = v_保存人, 记录时间 = Sysdate
      Where 记录id = n_记录id And 项目序号 = n_项目序号 And 记录类型 = 记录类型_In And
            Decode(项目序号_In, n_体温, Nvl(记录标记, 0), n_疼痛强度, Nvl(记录标记, 0), Nvl(n_记录标记, 0)) = Nvl(n_记录标记, 0) And
            Decode(n_项目性质, 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无')) = Nvl(体温部位_In, '无') And 终止版本 Is Null;
    Else
      Update 病人护理明细
      Set 记录内容 = v_记录内容, 记录人 = v_保存人, 记录时间 = Sysdate
      Where 记录id = n_记录id And 项目序号 = n_项目序号 And 记录类型 = 记录类型_In And
            Decode(项目序号_In, n_体温, Nvl(记录标记, 0), n_疼痛强度, Nvl(记录标记, 0), Nvl(n_记录标记, 0)) = Nvl(n_记录标记, 0) And 终止版本 Is Null;
    End If;
    If Sql%Rowcount = 0 Then
      --插入本次登记的病人护理内容
      If Mod(记录类型_In, 10) = 1 Then
        Insert Into 病人护理明细
          (Id, 记录id, 记录类型, 项目分组, 项目id, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 记录人, 体温部位, 复试合格, 开始版本, 终止版本, 记录组号, 未记说明,
           记录时间, 数据来源, 显示, 来源id, 共用)
          Select 病人护理明细_Id.Nextval, n_记录id, 记录类型_In, 分组名, 项目id, 项目序号, 项目名称, 项目类型, v_记录内容, 项目单位, n_记录标记, v_保存人, 体温部位_In,
                 复试合格_In, n_开始版本, Null, Null,
                 Decode(n_项目序号, n_体温, Decode(v_记录内容, '不升', Null, 未记说明_In), 未记说明_In), Sysdate, 数据来源_In, 0, 来源id_In, 共用_In
          From 护理记录项目
          Where 项目序号 = n_项目序号;
      Else
        Insert Into 病人护理明细
          (Id, 记录id, 记录类型, 项目分组, 项目id, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 记录人, 体温部位, 复试合格, 开始版本, 终止版本, 记录组号, 未记说明,
           记录时间, 数据来源, 显示, 来源id, 共用)
        Values
          (病人护理明细_Id.Nextval, n_记录id, 记录类型_In, Null, Null, 0,
           Decode(记录类型_In, 2, '上标说明', 6, '下标说明', 3, '入出转', 4, v_记录内容), Decode(记录类型_In, 3, 0, 1),
           Decode(记录类型_In, 4, '1', 记录内容_In), '', n_记录标记, v_保存人, 体温部位_In, 复试合格_In, n_开始版本, Null, Null, 未记说明_In, Sysdate,
           数据来源_In, 0, 来源id_In, 共用_In);
      End If;
    End If;
    If n_Preblue > 0 Then
      v_Data := Substr(v_Data, Instr(v_Data, '/', 1) + 1);
    End If;
  End Loop;
  --更新打印
  Update 体温单打印
  Set 打印人 = Null, 打印时间 = Null
  Where 文件id = 文件id_In And
        开始时间 = (Select Max(开始时间) From 体温单打印 Where 文件id = 文件id_In And 开始时间 <= d_发生时间);
        
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_体温单数据_Update;
/
--105420:陈刘,2017-04-01,体温设置显示时,需同步修改体温单打印的状态为重打

Create Or Replace Procedure ZL_体温单数据_设置显示(
	ID_IN		IN 病人护理明细.ID%Type,
	显示_IN		IN 病人护理明细.显示%Type
)
IS
	v_保存人  病人护理数据.保存人%Type;
	N_显示    病人护理明细.显示%Type;
  d_发生时间 病人护理数据.发生时间%Type;
  n_文件id   病人护理数据.文件id%Type;
Begin
	--提取原始显示状态
	Begin
		Select a.显示, b.发生时间, b.文件id
    Into n_显示, d_发生时间, n_文件id
    From 病人护理数据 b, 病人护理明细 a
    Where b.Id = a.记录id And a.Id = Id_In;
	Exception
		When Others Then
			N_显示 :=0;
	End ;

	IF n_显示=显示_IN THEN
		RETURN;
	End IF ;
	--提取保存人
	V_保存人 := ZL_USERNAME;

	UPDATE 病人护理明细 SET 显示=显示_IN,记录人=v_保存人,记录时间=sysdate WHERE ID=ID_IN;
  
  --更新打印
  Update 体温单打印
  Set 打印人 = Null, 打印时间 = Null
  Where 文件id = n_文件id And
        开始时间 = (Select Max(开始时间) From 体温单打印 Where 文件id = n_文件id And 开始时间 <= d_发生时间);
        
Exception
	When Others Then ZL_ERRORCENTER(SQLCODE, SQLERRM);
End ZL_体温单数据_设置显示;
/
--105420:陈刘,2017-04-01,体温单打印可视化修改

Create Or Replace Procedure Zl_体温单数据_Printer
(
  文件id_In   In 体温单打印.文件id%Type,
  删除_In     Number := 0,
  打印页号_In In 体温单打印.打印页号%Type := Null,
  开始时间_In In 体温单打印.开始时间%Type := Null
) As
  v_Temp     Varchar2(255);
  v_人员姓名 人员表.姓名%Type;
Begin
  If 删除_In = 1 Then
    If 打印页号_In Is Null Then
      Delete From 体温单打印 Where 文件id = 文件id_In;
    Else
      Delete From 体温单打印 Where 文件id = 文件id_In And 打印页号 = 打印页号_In;
    End If;
    Return;
  End If;

  If 打印页号_In Is Null Or 开始时间_In Is Null Then
    Return;
  End If;

  --操作员信息:部门ID,部门名称;人员ID,人员编号,人员姓名
  v_Temp     := Zl_Identity(1);
  v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);

  Update 体温单打印
  Set 开始时间 = 开始时间_In, 打印人 = v_人员姓名, 打印时间 = Sysdate
  Where 文件id = 文件id_In And 打印页号 = 打印页号_In;

  If Sql%Notfound Then
    Insert Into 体温单打印
      (文件id, 开始时间, 打印页号, 打印人, 打印时间)
    Values
      (文件id_In, 开始时间_In, 打印页号_In, v_人员姓名, Sysdate);
  End If;
Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_体温单数据_Printer;
/   

--108660:张德婷,2017-04-27,修正发药审核和静配审核的冲突
--105176:张德婷,2017-03-30,静配中心审核医嘱添加审核人
CREATE OR REPLACE Procedure Zl_输液配药记录_审核
(
  医嘱id_In   In Varchar2, --ID串:ID1,操作1||ID2,操作1....
  审核药师_In    In varchar2:=null
) Is
  v_Tansid Varchar2(20);
  v_Tmp    Varchar2(4000);
  v_Fields varchar2(50);
  v_状态   varchar2(2);
Begin
  If 医嘱id_In Is Null Then
    v_Tmp := Null;
  else
    v_Tmp:=医嘱id_In;
  End If;

  While v_Tmp Is Not Null Loop
    --分解单据ID串
    v_Fields := Substr(v_Tmp, 1, Instr(v_Tmp, '|') - 1);
    v_Tansid := Substr(v_Fields, 1, Instr(v_Fields, ',') - 1);
    v_状态   := Substr(v_Fields, Instr(v_Fields, ',') + 1);

    v_Tmp := Replace('|' || v_Tmp, '|' || v_Fields || '|');

    if 审核药师_In is null and v_状态<>'0' then
      Update 病人医嘱记录 Set 药师审核标志 = v_状态, 药师审核时间 = sysdate Where ID = v_Tansid and nvl(药师审核标志,0)=0;  
    else
      if v_状态='0' then
        Update 病人医嘱记录 Set 药师审核标志 = v_状态, 药师审核时间 = null,审核药师=null Where ID = v_Tansid;
      else
        Update 病人医嘱记录 Set 药师审核标志 = v_状态, 药师审核时间 = sysdate,审核药师=审核药师_In Where ID = v_Tansid;
      end if;
    end if;
  End Loop;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_输液配药记录_审核;
/

--108190:刘尔旋,2017-04-13,结帐作废冲预交记录填写卡类别ID
--105374:刘尔旋,2017-03-30,门诊医保结帐作废校对
Create Or Replace Procedure Zl_病人结帐作废_Modify
(
  操作类型_In      Number,
  病人id_In        病人结帐记录.病人id%Type,
  冲销id_In        病人预交记录.结帐id%Type,
  结算方式_In      Varchar2,
  卡类别id_In      病人预交记录.卡类别id%Type := Null,
  卡号_In          病人预交记录.卡号%Type := Null,
  交易流水号_In    病人预交记录.交易流水号%Type := Null,
  交易说明_In      病人预交记录.交易说明%Type := Null,
  缴款_In          病人预交记录.缴款%Type := Null,
  找补_In          病人预交记录.找补%Type := Null,
  误差金额_In      病人预交记录.冲预交%Type := Null,
  预交金额_In      病人预交记录.冲预交%Type := Null,
  操作员编号_In    病人预交记录.操作员编号%Type := Null,
  操作员姓名_In    病人预交记录.操作员姓名%Type := Null,
  收款时间_In      病人预交记录.收款时间%Type := Null,
  冲预交病人ids_In Varchar2 := Null,
  完成作废_In      Number := 0,
  医保校对标志_In  Number := 0
) As
  ------------------------------------------------------------------------------------------------------------------------------ 
  --功能:收费结算时,修改结算的相关信息 
  --操作类型_In: 
  --   0-原样退: 
  --       其他参数不处理 
  --   1-普通退费方式: 
  --     ①结算方式_IN:允许传入多个,格式为:"结算方式|结算金额|结算号码|结算摘要||.." ;也允许传入空. 
  --   2.三方卡退费结算: 
  --     ①结算方式_IN:只能传入一个结算方式,但允许包含一些辅助信息,格式为:"结算方式|结算金额|结算号码|结算摘要" 
  --     ②卡类别ID_IN,卡号_IN,交易流水号_IN,交易说明_In:需要传入 
  --   3-医保结算(如果存在医保的结算,则要先删除原医保结算,后按新传入的更新) 
  --     ①结算方式_IN:允许传入多个,格式为:结算方式|结算金额||.."
  --   4-消费卡结算:
  --     ①结算方式_IN:允许一次刷多张卡,格式为:卡类别ID|卡号|消费卡ID|消费金额||." 
  -- 预交金额_In:如果涉及预交款,则传入本次的退预交或冲预交金额 传入零<0时 表示退预交款;>0 时:表示冲预交款 
  -- 误差金额_In:存在误差费时,传入 
  -- 完成退费_In:0-未完成退费;1-异常完成退费;2-完成退费 
  -- 冲预交病人ids_In:多个用逗分分离,冲预交时有效(冲预交类别与业务操作保持一致),主要是使用家属的预交款 
  -- 医保校对标志_In:0-无需校对;1-需要校对
  ------------------------------------------------------------------------------------------------------------------------------ 
  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  v_结算内容 Varchar2(500);
  v_当前结算 Varchar2(50);
  v_卡号     病人医疗卡信息.卡号%Type;
  n_消费卡id 消费卡目录.Id%Type;
  n_卡类别id 病人预交记录.结算卡序号%Type;
  v_名称     Varchar2(100);
  n_自制卡   卡消费接口目录.自制卡%Type;
  n_序号     病人卡结算记录.序号%Type;
  n_Id       病人卡结算记录.Id%Type;
  n_预交id   病人预交记录.Id%Type;
  v_结算方式 病人预交记录.结算方式%Type;
  n_结算金额 病人预交记录.冲预交%Type;
  n_返回值   人员缴款余额.余额%Type;
  n_预交金额 病人预交记录.冲预交%Type;
  n_冲预交   病人预交记录.冲预交%Type;
  v_结算号码 病人预交记录.结算号码%Type;
  v_结算摘要 病人预交记录.摘要%Type;
  v_误差费   结算方式.名称%Type;
  n_预交类别 病人余额.类型%Type;
  n_缴款组id 病人预交记录.缴款组id%Type;
  n_异常作废 Number(3);
  n_校对标志 病人预交记录.校对标志%Type;

  n_Dec Number; --金额小数位数 

  n_Count         Number;
  n_Havenull      Number;
  l_预交id        t_Numlist := t_Numlist();
  n_原结帐id      病人预交记录.结帐id%Type;
  n_结帐id        病人预交记录.结帐id%Type;
  v_冲预交病人ids Varchar2(4000);
  Cursor c_Balance_Record Is
    Select Max(NO) As NO, Max(m.病人id) As 病人id, Max(Nvl(收款时间_In, m.收费时间)) As 登记时间, Max(Nvl(操作员编号_In, m.操作员编号)) As 操作员编号,
           Max(Nvl(操作员姓名_In, m.操作员姓名)) As 操作员姓名, Sum(结帐金额) As 结算金额, Max(Nvl(n_缴款组id, m.缴款组id)) As 缴款组id,
           Max(结帐类型) As 结帐类型
    From 病人结帐记录 M
    Where ID = 冲销id_In;
  r_Balance_Record c_Balance_Record%RowType;

  Cursor c_Balance_Data Is
    Select 记录性质, NO, 记录状态, 病人id, 科室id, 主页id, 结算方式, Nvl(收款时间_In, 收款时间) As 收款时间, Nvl(操作员编号_In, 操作员编号) As 操作员编号,
           Nvl(操作员姓名_In, 操作员姓名) As 操作员姓名, 冲预交, 结帐id, Nvl(n_缴款组id, 缴款组id) As 缴款组id, 结算序号
    From 病人预交记录
    Where 结帐id = 冲销id_In And 结算方式 Is Null;
  r_Balance_Data c_Balance_Data%RowType;

Begin
  If 操作员姓名_In Is Null Then
    n_缴款组id := Null;
  Else
    n_缴款组id := Zl_Get组id(操作员姓名_In);
  End If;

  Open c_Balance_Record;
  Fetch c_Balance_Record
    Into r_Balance_Record;

  Open c_Balance_Data;
  Fetch c_Balance_Data
    Into r_Balance_Data;

  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);

  If r_Balance_Record.No Is Null Then
    v_Err_Msg := '未找到指定的结帐作废记录！';
    Raise Err_Item;
  End If;

  If 操作类型_In = 0 Then
  
    --原样退(只有异常作废时才有效) 
    Begin
      Select a.Id
      Into n_原结帐id
      From 病人结帐记录 A, 病人结帐记录 B
      Where a.No = b.No And a.记录状态 In (1, 3) And b.Id = 冲销id_In And Rownum < 2;
    Exception
      When Others Then
        Begin
          v_Err_Msg := '没有发现要作废的结帐单据,可能已经作废！';
          Raise Err_Item;
        End;
    End;
    Delete 病人预交记录 Where 结帐id = 冲销id_In And 结算方式 Is Null;
  
    -- 退预交 
    Insert Into 病人预交记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 科室id, 主页id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交, 结帐id,
       缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算性质)
      Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 科室id, 主页id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
             r_Balance_Record.登记时间, r_Balance_Record.操作员姓名, r_Balance_Record.操作员编号, -1 * 冲预交, 冲销id_In,
             r_Balance_Record.缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 2, 2
      From 病人预交记录
      Where 结帐id = n_原结帐id And 记录性质 In (1, 11);
  
    For r_预交 In (Select 病人id, 预交类别, Sum(冲预交) As 冲预交
                 From 病人预交记录
                 Where 结帐id = 冲销id_In And Mod(记录性质, 10) = 1
                 Group By 病人id, 预交类别) Loop
      --病人余额(预交) 
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - Nvl(r_预交.冲预交, 0) --注:新的结帐ID产生的是负数金额 
      Where 病人id = r_预交.病人id And 类型 = Nvl(r_预交.预交类别, 2) And 性质 = 1
      Returning 预交余额 Into n_返回值;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 性质, 类型, 预交余额, 费用余额)
        Values
          (r_预交.病人id, 1, Nvl(r_预交.预交类别, 2), -1 * r_预交.冲预交, 0);
        n_返回值 := -1 * r_预交.冲预交;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete 病人余额 Where 性质 = 1 And 病人id = r_预交.病人id And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
      End If;
    End Loop;
  
    --退其他 
    Insert Into 病人预交记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交, 结帐id,
       缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算性质)
      Select 病人预交记录_Id.Nextval, NO, 实际票号, 12, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
             r_Balance_Record.登记时间, r_Balance_Record.操作员姓名, r_Balance_Record.操作员编号, -1 * 冲预交, 冲销id_In,
             r_Balance_Record.缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 2, 2
      From 病人预交记录
      Where 结帐id = n_原结帐id And Mod(记录性质, 10) <> 1;
  
    Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0 Where 结帐id = 冲销id_In;
    Begin
      Select 1
      Into n_异常作废
      From 病人结帐记录
      Where NO = r_Balance_Data.No And 记录状态 = 3 And 结算状态 = 1 And Rownum < 2;
    Exception
      When Others Then
        n_异常作废 := 0;
    End;
  
    If n_异常作废 = 1 Then
      Update 病人结帐记录
      Set 结算状态 = 2
      Where ID In (Select ID From 病人结帐记录 A Where NO = r_Balance_Data.No) And 结算状态 Is Not Null;
    Else
      Update 病人结帐记录
      Set 结算状态 = Null
      Where ID In (Select ID From 病人结帐记录 A Where NO = r_Balance_Data.No) And 结算状态 Is Not Null;
    End If;
    Close c_Balance_Record;
    Return;
  End If;

  n_预交类别 := Nvl(r_Balance_Record.结帐类型, 2);

  --0.正式结算 
  Select Count(1), Max(Decode(结算方式, Null, 1, 0))
  Into n_Count, n_Havenull
  From 病人预交记录
  Where 结帐id = 冲销id_In;

  --金额小数位数 
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into n_Dec From Dual;

  --1.增加结算方式为空的结算数据 
  If Nvl(n_Havenull, 0) = 0 Then
    n_Count := 0;
    Begin
      n_结算金额 := Round(Nvl(r_Balance_Record.结算金额, 0), n_Dec);
      If Nvl(n_结算金额, 0) = 0 Then
        Select Sum(结帐金额)
        Into n_结算金额
        From (Select Sum(结帐金额) As 结帐金额
               From 门诊费用记录
               Where 结帐id = 冲销id_In
               Union All
               Select Sum(结帐金额)
               From 住院费用记录
               Where 结帐id = 冲销id_In);
      End If;
    
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 校对标志, 结算性质)
      Values
        (病人预交记录_Id.Nextval, 12, r_Balance_Record.No, 1, r_Balance_Record.病人id, Null, r_Balance_Record.登记时间,
         r_Balance_Record.操作员编号, r_Balance_Record.操作员姓名, n_结算金额, 冲销id_In, r_Balance_Record.缴款组id, 2, 2);
    
      --误差费(先汇总后生成误差费 
      If n_结算金额 <> Nvl(r_Balance_Record.结算金额, 0) Then
        Begin
          Select 名称 Into v_误差费 From 结算方式 Where Nvl(性质, 0) = 9;
        Exception
          When Others Then
            v_误差费 := '误差费';
        End;
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 校对标志, 结算性质)
        Values
          (病人预交记录_Id.Nextval, 12, r_Balance_Record.No, 1, r_Balance_Record.病人id, v_误差费, r_Balance_Record.登记时间,
           r_Balance_Record.操作员编号, r_Balance_Record.操作员姓名, Nvl(r_Balance_Record.结算金额, 0) - n_结算金额, 冲销id_In,
           r_Balance_Record.缴款组id, 2, 2);
      End If;
    Exception
      When Others Then
        n_Count := 1;
    End;
    If n_Count = 1 Then
      v_Err_Msg := '未找到指定的结帐作废数据,退费操作失败！';
      Raise Err_Item;
    End If;
  End If;

  --处理误差费 

  If Nvl(误差金额_In, 0) <> 0 Then
    Begin
      Select 名称 Into v_误差费 From 结算方式 Where Nvl(性质, 0) = 9;
    Exception
      When Others Then
        v_误差费 := '误差费';
    End;
  
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 校对标志, 结算性质)
    Values
      (病人预交记录_Id.Nextval, 12, r_Balance_Record.No, 1, r_Balance_Record.病人id, v_误差费, r_Balance_Record.登记时间,
       r_Balance_Record.操作员编号, r_Balance_Record.操作员姓名, 误差金额_In, 冲销id_In, r_Balance_Record.缴款组id, 2, 2);
  
    --更新数据(结算方式为NULL的) 
    Update 病人预交记录
    Set 冲预交 = 冲预交 - Nvl(误差金额_In, 0)
    Where 结帐id = r_Balance_Data.结帐id And 结算方式 Is Null
    Returning Nvl(冲预交, 0) Into n_返回值;
  
  End If;

  --预交款处理:如果是冲预交,需要先处理冲预交款 
  If Nvl(预交金额_In, 0) > 0 Then
  
    --病人余额检查 
    Begin
    
      Select Nvl(预交余额, 0) - Nvl(费用余额, 0)
      Into n_预交金额
      From 病人余额
      Where 病人id = 病人id_In And Nvl(性质, 0) = 1 And 类型 = Nvl(n_预交类别, 0);
    Exception
      When Others Then
        n_预交金额 := 0;
    End;
    If n_预交金额 < 预交金额_In Then
      v_Err_Msg := '病人的当前预交余额为 ' || LTrim(To_Char(n_预交金额, '9999999990.00')) || '，小于本次支付金额 ' ||
                   LTrim(To_Char(预交金额_In, '9999999990.00')) || '，支付失败！';
      Raise Err_Item;
    End If;
  
    n_预交金额 := 预交金额_In;
  
    For c_冲预交 In (Select *
                  From (Select a.Id, a.记录状态, a.病人id, a.No, Nvl(a.金额, 0) As 金额, Sign(Nvl(a.金额, 0)) As 标志
                         From 病人预交记录 A,
                              (Select NO, Sum(Nvl(a.金额, 0)) As 金额
                                From 病人预交记录 A
                                Where a.结帐id Is Null And Nvl(a.金额, 0) <> 0 And
                                      a.病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And
                                      预交类别 = Nvl(n_预交类别, 0)
                                Group By NO
                                Having Sum(Nvl(a.金额, 0)) <> 0) B
                         Where a.结帐id Is Null And Nvl(a.金额, 0) <> 0 And a.No = b.No And
                               a.病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And
                               a.预交类别 = Nvl(n_预交类别, 0)
                         Union All
                         Select 0 As ID, 记录状态, Max(病人id) As 病人id, NO, Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) As 金额,
                                Sign(Sum(Nvl(金额, 0) - Nvl(冲预交, 0))) As 标志
                         From 病人预交记录
                         Where 记录性质 In (1, 11) And 结帐id Is Not Null And Nvl(金额, 0) <> Nvl(冲预交, 0) And
                               病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And 预交类别 = Nvl(n_预交类别, 0)
                          Having Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) <> 0
                         Group By 记录状态, NO)
                  Order By 标志, Decode(病人id, Nvl(病人id_In, 0), 0, 1), ID, NO) Loop
    
      If c_冲预交.金额 - n_预交金额 < 0 Then
        n_冲预交 := c_冲预交.金额;
      Else
        n_冲预交 := n_预交金额;
      End If;
    
      If c_冲预交.Id <> 0 Then
        --第一次冲预交(将第一次标上结帐ID,冲预交标记为0) 
        Update 病人预交记录 Set 冲预交 = 0, 结帐id = r_Balance_Data.结帐id, 结算性质 = 2 Where ID = c_冲预交.Id;
      End If;
    
      --冲上次剩余额 
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
         结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
               r_Balance_Data.收款时间, r_Balance_Data.操作员姓名, r_Balance_Data.操作员编号, n_冲预交, r_Balance_Data.结帐id,
               r_Balance_Data.缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 2
        From 病人预交记录
        Where NO = c_冲预交.No And 记录状态 = c_冲预交.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
    
      --更新数据(结算方式为NULL的) 
      Update 病人预交记录
      Set 冲预交 = 冲预交 + n_冲预交
      Where 结帐id = r_Balance_Data.结帐id And 结算方式 Is Null
      Returning Nvl(冲预交, 0) Into n_返回值;
    
      --更新病人预交余额 
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_冲预交
      Where 病人id = c_冲预交.病人id And 性质 = 1 And 类型 = Nvl(n_预交类别, 0)
      Returning 预交余额 Into n_返回值;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 类型, 预交余额, 性质)
        Values
          (c_冲预交.病人id, Nvl(n_预交类别, 0), -1 * n_冲预交, 1);
        n_返回值 := -1 * n_冲预交;
      End If;
    
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = c_冲预交.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      --检查是否已经处理完 
      If c_冲预交.金额 < n_预交金额 Then
        n_预交金额 := n_预交金额 - c_冲预交.金额;
      Else
        n_预交金额 := 0;
      End If;
      If n_预交金额 = 0 Then
        Exit;
      End If;
    
    End Loop;
    --检查金额是否足够 
    If Abs(n_预交金额) > 0 Then
      v_Err_Msg := '病人的当前预交余额小于本次支付金额 ' || LTrim(To_Char(预交金额_In, '9999999990.00')) || '，支付失败！';
      Raise Err_Item;
    End If;
  
  End If;

  If Nvl(预交金额_In, 0) < 0 Then
    Begin
      Select ID Into n_原结帐id From 病人结帐记录 Where 记录状态 In (1, 3) And NO = r_Balance_Data.No;
    Exception
      When Others Then
        Begin
          v_Err_Msg := '没有发现要作废的结帐单据,可能已经作废！';
          Raise Err_Item;
        End;
    End;
  
    --退预交款 
    n_返回值   := 0;
    n_预交金额 := -1 * 预交金额_In;
    For v_退预交 In (Select Max(a.Id) As ID, Max(病人id) As 病人id, Max(a.收款时间) As 收款时间, Sum(Nvl(a.冲预交, 0)) As 金额,
                         Max(预交类别) As 预交类别, Sign(Sum(Nvl(a.冲预交, 0))) As 标志
                  From 病人预交记录 A
                  Where a.结帐id = n_原结帐id And Mod(记录性质, 10) = 1
                  Group By NO
                  Having Sum(Nvl(冲预交, 0)) <> 0
                  Order By 标志, 收款时间 Desc) Loop
    
      If v_退预交.金额 - n_预交金额 < 0 Then
        n_结算金额 := -1 * v_退预交.金额;
        n_预交金额 := n_预交金额 - v_退预交.金额;
      Else
        n_结算金额 := -1 * n_预交金额;
        n_预交金额 := 0;
      End If;
    
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 实际票号, 记录状态, 病人id, 科室id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 校对标志, 卡类别id, 结算卡序号,
         卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 结算性质)
        Select 病人预交记录_Id.Nextval, 11, NO, 实际票号, 记录状态, 病人id, 科室id, 主页id, 摘要, 结算方式, r_Balance_Data.收款时间,
               r_Balance_Data.操作员编号, r_Balance_Data.操作员姓名, n_结算金额, r_Balance_Data.结帐id, r_Balance_Data.缴款组id, 2, 卡类别id,
               结算卡序号, 卡号, 交易流水号, 交易说明, Null, 预交类别, 2
        From 病人预交记录
        Where ID = v_退预交.Id;
    
      Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
    
      n_返回值 := 1;
      If Sql%NotFound Then
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
        Raise Err_Item;
      End If;
    
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + -1 * n_结算金额
      Where 病人id = Nvl(v_退预交.病人id, 病人id_In) And 性质 = 1 And 类型 = Nvl(v_退预交.预交类别, 2)
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 类型, 预交余额, 性质)
        Values
          (Nvl(v_退预交.病人id, 病人id_In), 1, -1 * n_结算金额, Nvl(v_退预交.预交类别, 2));
        n_返回值 := n_结算金额;
      End If;
    
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = Nvl(v_退预交.病人id, 病人id_In) And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      If n_预交金额 = 0 Then
        Exit;
      End If;
    
    End Loop;
  
    If Nvl(n_返回值, 0) = 0 Then
      v_Err_Msg := '未找到原始的冲预交记录,不能回退预交款！';
      Raise Err_Item;
    End If;
    If Nvl(n_预交金额, 0) <> 0 Then
      v_Err_Msg := '当前退预交超过了原结帐中的冲预交款,不能回退预交款！';
      Raise Err_Item;
    End If;
  
  End If;

  If 操作类型_In = 1 Then
    --   1-普通退费方式: 
    --各个收费结算 :格式为:"结算方式|结算金额|结算号码|结算摘要||.." 
    v_结算内容 := 结算方式_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
    
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      --不判断“结算金额”是否为零，有可能已经退完，但这时结算方式为空的重结和冲销记录的冲预交之和为零 
      If v_结算方式 Is Not Null Then
      
        --If Nvl(n_结算金额, 0) <> 0 Then 
        n_结算金额 := Nvl(n_结算金额, 0);
        If Nvl(n_结算金额, 0) <> 0 Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 科室id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 校对标志, 卡类别id, 结算卡序号,
             卡号, 交易流水号, 交易说明, 结算号码, 结算性质)
          Values
            (病人预交记录_Id.Nextval, 12, r_Balance_Data.No, 1, r_Balance_Data.病人id, r_Balance_Data.科室id, r_Balance_Data.主页id,
             v_结算摘要, v_结算方式, r_Balance_Data.收款时间, r_Balance_Data.操作员编号, r_Balance_Data.操作员姓名, n_结算金额,
             r_Balance_Data.结帐id, r_Balance_Data.缴款组id, 2, Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 2);
        
          Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
          If Sql%NotFound Then
            v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
            Raise Err_Item;
          End If;
        End If;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  
  End If;

  If 操作类型_In = 2 Then
    --   2.三方卡退费结算: 
  
    v_当前结算 := 结算方式_In;
    v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
    v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
  
    If Nvl(n_结算金额, 0) <> 0 Then
    
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 科室id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 校对标志, 卡类别id, 结算卡序号, 卡号,
         交易流水号, 交易说明, 结算号码, 结算性质)
      Values
        (病人预交记录_Id.Nextval, 12, r_Balance_Data.No, 1, r_Balance_Data.病人id, r_Balance_Data.科室id, r_Balance_Data.主页id,
         v_结算摘要, v_结算方式, r_Balance_Data.收款时间, r_Balance_Data.操作员编号, r_Balance_Data.操作员姓名, n_结算金额, r_Balance_Data.结帐id,
         r_Balance_Data.缴款组id, 2, 卡类别id_In, Null, 卡号_In, 交易流水号_In, 交易说明_In, v_结算号码, 2);
    
      Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
      If Sql%NotFound Then
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
        Raise Err_Item;
      End If;
    End If;
  End If;

  If 操作类型_In = 3 Then
    --   3-医保结算(如果存在医保的结算,则要先删除原医保结算,后按新传入的更新) 
    --3.1检查是否已经存在医保结算数据,存在先删除 
    n_结算金额 := 0;
    If 医保校对标志_In = 0 Then
      n_校对标志 := 2;
    Else
      n_校对标志 := 1;
    End If;
    For v_医保 In (Select ID, 结算方式, 冲预交
                 From 病人预交记录 A
                 Where 结帐id = 冲销id_In And Exists
                  (Select 1 From 结算方式 Where a.结算方式 = 名称 And 性质 In (3, 4)) And Mod(记录性质, 10) <> 1) Loop
      n_结算金额 := n_结算金额 + Nvl(v_医保.冲预交, 0);
      l_预交id.Extend;
      l_预交id(l_预交id.Count) := v_医保.Id;
    End Loop;
    If Nvl(n_结算金额, 0) <> 0 Then
      Update 病人预交记录
      Set 冲预交 = Nvl(冲预交, 0) + Nvl(n_结算金额, 0)
      Where 结帐id = 冲销id_In And 结算方式 Is Null;
      If Sql%NotFound Then
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
        Raise Err_Item;
      End If;
    End If;
    If l_预交id.Count <> 0 Then
      Forall I In 1 .. l_预交id.Count
        Delete 病人预交记录 Where ID = l_预交id(I);
    End If;
  
    If 结算方式_In Is Not Null Then
      v_结算内容 := 结算方式_In || '||';
    End If;
  
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      n_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      For c_结算信息 In (Select 记录性质, NO, 记录状态, 病人id, 科室id, 主页id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号
                     From 病人预交记录
                     Where 结帐id = 冲销id_In And 结算方式 Is Null) Loop
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 科室id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 校对标志, 结算性质)
        Values
          (病人预交记录_Id.Nextval, 12, c_结算信息.No, 1, c_结算信息.病人id, c_结算信息.科室id, c_结算信息.主页id, '保险结算', v_结算方式, c_结算信息.收款时间,
           c_结算信息.操作员编号, c_结算信息.操作员姓名, n_结算金额, c_结算信息.结帐id, c_结算信息.缴款组id, n_校对标志, 2);
      End Loop;
    
      --更新数据(结算方式为NULL的) 
      Update 病人预交记录
      Set 冲预交 = 冲预交 - n_结算金额
      Where 结帐id = 冲销id_In And 结算方式 Is Null
      Returning Nvl(冲预交, 0) Into n_返回值;
    
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --4-消费卡批量结算 
  If 操作类型_In = 4 Then
    v_结算内容 := 结算方式_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      --卡类别ID|卡号|消费卡ID|消费金额 
      n_卡类别id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_卡号     := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_消费卡id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(v_当前结算);
      Begin
        Select 名称, 自制卡, 结算方式 Into v_名称, n_自制卡, v_结算方式 From 卡消费接口目录 Where 编号 = n_卡类别id;
      Exception
        When Others Then
          v_名称 := Null;
      End;
      If v_名称 Is Null Then
        v_Err_Msg := '未找到对应的结算卡接口,本次刷卡消费失败!';
        Raise Err_Item;
      End If;
      If v_结算方式 Is Null Then
        v_Err_Msg := v_名称 || '未设置对应的结算方式,本次刷卡消费失败!';
        Raise Err_Item;
      End If;
      If Nvl(n_结算金额, 0) <> 0 Then
        n_结帐id := 冲销id_In;
      
        Update 病人预交记录
        Set 冲预交 = Nvl(冲预交, 0) + n_结算金额
        Where 结帐id = n_结帐id And 结算方式 = v_结算方式 And 结算卡序号 = n_卡类别id
        Returning ID Into n_预交id;
      
        If Sql%NotFound Then
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 科室id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算卡序号, 校对标志, 结算性质)
          Values
            (n_预交id, 12, r_Balance_Data.No, 1, r_Balance_Data. 病人id, r_Balance_Data.科室id, r_Balance_Data.主页id, Null,
             v_结算方式, r_Balance_Data. 收款时间, r_Balance_Data. 操作员编号, r_Balance_Data. 操作员姓名, n_结算金额, n_结帐id,
             r_Balance_Data. 缴款组id, n_卡类别id, 2, 2);
        End If;
      
        --插入卡结算记录 
        n_序号 := Zl_消费卡目录_Check(n_卡类别id, v_卡号, n_消费卡id, v_Err_Msg);
        If Nvl(n_序号, 0) = 0 Then
          Raise Err_Item;
        End If;
      
        Begin
          Select Nvl(Max(Nvl(序号, 0)), 0) + 1
          Into n_序号
          From 病人卡结算记录
          Where 接口编号 = n_卡类别id And Nvl(消费卡id, 0) = Nvl(n_消费卡id, 0) And 卡号 = v_卡号;
        Exception
          When Others Then
            n_序号 := 1;
        End;
      
        Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
      
        Insert Into 病人卡结算记录
          (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
        Values
          (n_Id, n_卡类别id, n_消费卡id, n_序号, 1, v_结算方式, n_结算金额, v_卡号, Null, r_Balance_Data.收款时间, Null, 0);
        --如果消费卡,需同时更改其余额 
        If Nvl(n_消费卡id, 0) <> 0 Then
          Update 消费卡目录 Set 余额 = 余额 - n_结算金额 Where ID = n_消费卡id;
          If Sql%NotFound Then
            v_Err_Msg := '卡号为' || v_卡号 || '的' || v_名称 || '未找到!';
            Raise Err_Item;
          End If;
        End If;
        Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
      
        --更新数据(结算方式为NULL的) 
        Update 病人预交记录
        Set 冲预交 = 冲预交 - n_结算金额
        Where 结帐id = n_结帐id And 结算方式 Is Null
        Returning Nvl(冲预交, 0) Into n_返回值;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If Nvl(完成作废_In, 0) = 0 Then
    Return;
  End If;

  ----------------------------------------------------------------------------------------- 
  --完成收费,需要处理人员缴款余额,预交记录(结算方式=NULL) 
  If Nvl(完成作废_In, 0) = 1 Then
    --异常完成退费 
    Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0 Where 结帐id = 冲销id_In;
    Update 病人结帐记录
    Set 结算状态 = Null
    Where ID In (Select ID From 病人结帐记录 A Where NO = r_Balance_Data.No) And 结算状态 Is Not Null;
    Return;
  End If;

  --1.删除结算方式为NULL的预交记录 
  Delete 病人预交记录 Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) = 0;
  If Sql%NotFound Then
    Select Count(*) Into n_Count From 病人预交记录 A Where 结帐id = 冲销id_In And 结算方式 Is Null;
    If n_Count <> 0 Then
      v_Err_Msg := '还存在未退款的数据,不能完成结帐作废操作!';
    Else
      v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[结帐窗口]中重新作废！!';
    End If;
    Raise Err_Item;
  End If;

  --结算金额为零时，增加一条金额为0的病人预交记录 
  Select Count(*) Into n_Count From 病人预交记录 A Where 结帐id = 冲销id_In;

  If n_Count = 0 Then
    If v_结算方式 Is Null Then
      Begin
        Select 结算方式 Into v_结算方式 From 结算方式应用 Where 应用场合 = '结帐' And Nvl(缺省标志, 0) = 1;
      Exception
        When Others Then
          v_结算方式 := Null;
      End;
      If v_结算方式 Is Null Then
        Begin
          Select 名称 Into v_结算方式 From 结算方式 Where Nvl(性质, 0) = 1;
        Exception
          When Others Then
            v_结算方式 := '现金';
        End;
      End If;
    End If;
  
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 科室id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 校对标志, 卡类别id, 结算卡序号, 卡号,
       交易流水号, 交易说明, 结算号码, 结算性质)
    Values
      (病人预交记录_Id.Nextval, 12, r_Balance_Data.No, 1, r_Balance_Data.病人id, r_Balance_Data.科室id, r_Balance_Data.主页id, Null,
       v_结算方式, r_Balance_Data.收款时间, r_Balance_Data.操作员编号, r_Balance_Data.操作员姓名, 0, r_Balance_Data.结帐id,
       r_Balance_Data.缴款组id, 2, Null, Null, Null, Null, 交易说明_In, Null, 2);
  End If;

  --2.处理缴款数据和找补数据及校对标志更新为0 
  Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0 Where 结帐id = 冲销id_In;

  --3.更新费用状态 
  Update 病人结帐记录 Set 结算状态 = Null Where ID = 冲销id_In;

  --4.更新人员缴款数据 
  For c_缴款 In (Select 结算方式, 操作员姓名, Sum(Nvl(a.冲预交, 0)) As 冲预交
               From 病人预交记录 A
               Where a.结帐id = 冲销id_In And Mod(a.记录性质, 10) <> 1
               Group By 结算方式, 操作员姓名) Loop
  
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + Nvl(c_缴款.冲预交, 0)
    Where 收款员 = c_缴款.操作员姓名 And 性质 = 1 And 结算方式 = c_缴款.结算方式;
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额
        (收款员, 结算方式, 性质, 余额)
      Values
        (c_缴款.操作员姓名, c_缴款.结算方式, 1, Nvl(c_缴款.冲预交, 0));
    End If;
  End Loop;

Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人结帐作废_Modify;
/

--107734:刘尔旋,2017-03-29,手机号兼容处理
Create Or Replace Procedure Zl_挂号病人病案_Insert
(
  处理类型_In       Number,
  病人id_In         病人信息.病人id%Type,
  门诊号_In         病人信息.门诊号%Type,
  就诊卡号_In       病人信息.就诊卡号%Type,
  卡验证码_In       病人信息.卡验证码%Type,
  姓名_In           病人信息.姓名%Type,
  性别_In           病人信息.性别%Type,
  年龄_In           病人信息.年龄%Type,
  费别_In           病人信息.费别%Type,
  医疗付款方式_In   病人信息.医疗付款方式%Type,
  国籍_In           病人信息.国籍%Type,
  民族_In           病人信息.民族%Type,
  婚姻_In           病人信息.婚姻状况%Type,
  职业_In           病人信息.职业%Type,
  身份证号_In       病人信息.身份证号%Type,
  工作单位_In       病人信息.工作单位%Type,
  合同单位id_In     病人信息.合同单位id%Type,
  单位电话_In       病人信息.单位电话%Type,
  单位邮编_In       病人信息.单位邮编%Type,
  家庭地址_In       病人信息.家庭地址%Type,
  家庭电话_In       病人信息.家庭电话%Type,
  家庭地址邮编_In   病人信息.家庭地址邮编%Type,
  登记时间_In       病人信息.登记时间%Type,
  挂号单_In         病人挂号记录.No%Type := Null,
  出生日期_In       病人信息.出生日期%Type := Null,
  医保号_In         病人信息.医保号%Type := Null,
  Ic卡号_In         病人信息.Ic卡号%Type := Null,
  险类_In           病人信息.险类%Type := Null,
  区域_In           病人信息.区域%Type := Null,
  户口地址_In       病人信息.户口地址%Type := Null,
  户口地址邮编_In   病人信息.户口地址邮编%Type := Null,
  联系人身份证号_In In 病人信息.联系人身份证号%Type := Null,
  联系人姓名_In     In 病人信息.联系人姓名%Type := Null,
  联系人电话_In     In 病人信息.联系人电话%Type := Null,
  联系人关系_In     In 病人信息.联系人关系%Type := Null,
  监护人_In         In 病人信息.监护人%Type := Null,
  出生地点_In       In 病人信息.出生地点%Type := Null,
  手机号_In         In 病人信息.手机号%Type := Null
) As
  --功能：处理挂号病人病案信息
  --参数：
  --处理类型：
  --             1=新建病人信息及门诊病案(用于新挂号病人)
  --             2=修改病人信息，新建门诊病案(用于无病案的病人)
  --             3=修改病人信息，不处理门诊病案(用于有病案的病人,但可能修改了病案的门诊号)
  v_年龄         Varchar2(20);
  v_年龄单位     Varchar2(20);
  v_出生日期     Date;
  n_一卡通       Number(1);
  v_Username     人员表.姓名%Type;
  v_姓名信息     病人信息.姓名%Type;
  v_年龄信息     病人信息.年龄%Type;
  v_性别信息     病人信息.性别%Type;
  v_身份证号     病人信息.身份证号%Type;
  d_出生日期信息 Date;
  d_变动时间     Date;
  v_手机号       病人信息.手机号%Type;
  v_手机号字段   Varchar2(500);
Begin
  If 出生日期_In Is Null And 年龄_In Is Not Null Then
    --根据年龄求出生日期
    v_年龄单位 := Substr(年龄_In, Length(年龄_In), 1);
    If Instr('岁,月,天', v_年龄单位) <= 0 Then
      v_年龄单位 := Null;
    Else
      v_年龄 := Replace(年龄_In, v_年龄单位, '');
    End If;
    Begin
      v_年龄 := To_Number(v_年龄);
    Exception
      When Others Then
        v_年龄 := Null;
    End;
    If v_年龄 Is Not Null And v_年龄单位 Is Not Null Then
      Select Decode(v_年龄单位, '岁', Add_Months(Sysdate, -12 * v_年龄), '月', Add_Months(Sysdate, -1 * v_年龄), '天',
                     Sysdate - v_年龄)
      Into v_出生日期
      From Dual;
    End If;
  Else
    v_出生日期 := 出生日期_In;
  End If;

  If 手机号_In Is Null Then
    If 家庭电话_In Is Not Null Then
      --中国移动
      v_手机号字段 := ',139,138,137,136,135,134,159,158,157,150,151,152,147,188,187,182,183,184,178';
      --中国联通
      v_手机号字段 := v_手机号字段 || ',130,131,132,156,155,186,185,145,176';
      --中国电信
      v_手机号字段 := v_手机号字段 || ',133,153,189,180,181,177,173';
      --虚拟运营商
      v_手机号字段 := v_手机号字段 || ',170,';
      If Not Instr(v_手机号字段, ',' || Substr(家庭电话_In, 1, 3) || ',') = 0 Then
        v_手机号 := 家庭电话_In;
      End If;
    End If;
  Else
    v_手机号 := 手机号_In;
  End If;

  Begin
    Select 姓名, 性别, 年龄, 出生日期, 身份证号
    Into v_姓名信息, v_性别信息, v_年龄信息, d_出生日期信息, v_身份证号
    From 病人信息
    Where 病人id = 病人id_In;
    v_年龄信息 := Zl_Age_Calc(病人id_In, d_出生日期信息);
  Exception
    When Others Then
      v_姓名信息     := 姓名_In;
      v_性别信息     := 性别_In;
      v_年龄信息     := 年龄_In;
      d_出生日期信息 := v_出生日期;
      v_身份证号     := 身份证号_In;
  End;

  Begin
    Select 1 Into n_一卡通 From 一卡通目录 Where 启用 = 2 And Rownum <= 1;
  Exception
    When Others Then
      n_一卡通 := 0;
  End;

  If Not 就诊卡号_In Is Null And n_一卡通 = 0 Then
    Update 病人信息
    Set 就诊卡号 = Null, Ic卡号 = Decode(Ic卡号, 就诊卡号, Null, Ic卡号)
    Where 病人id <> 病人id_In And 就诊卡号 = 就诊卡号_In;
  End If;

  If 处理类型_In = 1 Then
    --新病人信息
    Insert Into 病人信息
      (病人id, 门诊号, 就诊卡号, 卡验证码, Ic卡号, 姓名, 性别, 年龄, 出生日期, 费别, 医疗付款方式, 国籍, 民族, 婚姻状况, 职业, 身份证号, 工作单位, 合同单位id, 单位电话, 单位邮编,
       家庭地址, 家庭电话, 家庭地址邮编, 户口地址, 户口地址邮编, 登记时间, 医保号, 区域, 联系人身份证号, 联系人姓名, 联系人电话, 联系人关系, 监护人, 出生地点, 手机号)
    Values
      (病人id_In, 门诊号_In, 就诊卡号_In, 卡验证码_In, Ic卡号_In, 姓名_In, 性别_In, 年龄_In, v_出生日期, 费别_In, 医疗付款方式_In, 国籍_In, 民族_In, 婚姻_In,
       职业_In, 身份证号_In, 工作单位_In, Decode(合同单位id_In, 0, Null, 合同单位id_In), 单位电话_In, 单位邮编_In, 家庭地址_In, 家庭电话_In, 家庭地址邮编_In,
       户口地址_In, 户口地址邮编_In, 登记时间_In, 医保号_In, 区域_In, 联系人身份证号_In, 联系人姓名_In, 联系人电话_In, 联系人关系_In, 监护人_In, 出生地点_In, v_手机号);
  Elsif 处理类型_In In (2, 3) Then
    --宁波一卡通,档案号以IC卡号传入,此时不更新就诊卡号
    Update 病人信息
    Set 门诊号 = 门诊号_In, 就诊卡号 = Decode(n_一卡通, 1, Decode(Ic卡号_In, Null, Nvl(就诊卡号_In, 就诊卡号), 就诊卡号), Nvl(就诊卡号_In, 就诊卡号)),
        Ic卡号 = Decode(n_一卡通, 1, Decode(Ic卡号_In, Null, Ic卡号, Nvl(Ic卡号_In, Ic卡号)), Nvl(Ic卡号_In, Ic卡号)),
        卡验证码 = Decode(n_一卡通, 1, Decode(Ic卡号_In, Null, Nvl(卡验证码_In, 卡验证码), 卡验证码),
                       Decode(就诊卡号_In, Null, 卡验证码, Nvl(卡验证码_In, 卡验证码))), 姓名 = 姓名_In, 性别 = Nvl(性别_In, 性别), 年龄 = 年龄_In,
        出生日期 = v_出生日期, 费别 = Nvl(费别_In, 费别), 医疗付款方式 = Nvl(医疗付款方式_In, 医疗付款方式), 国籍 = Nvl(国籍_In, 国籍), 民族 = Nvl(民族_In, 民族),
        婚姻状况 = Nvl(婚姻_In, 婚姻状况), 职业 = Nvl(职业_In, 职业), 身份证号 = 身份证号_In, 工作单位 = 工作单位_In,
        合同单位id = Decode(合同单位id_In, 0, Null, 合同单位id_In), 单位电话 = 单位电话_In, 单位邮编 = 单位邮编_In, 家庭地址 = 家庭地址_In, 家庭电话 = 家庭电话_In,
        户口地址 = Nvl(户口地址_In, 户口地址), 户口地址邮编 = Nvl(户口地址邮编_In, 户口地址邮编), 家庭地址邮编 = 家庭地址邮编_In, 医保号 = 医保号_In, 险类 = 险类_In,
        区域 = Nvl(区域_In, 区域), 联系人身份证号 = 联系人身份证号_In, 联系人姓名 = 联系人姓名_In, 联系人电话 = 联系人电话_In, 联系人关系 = 联系人关系_In, 监护人 = 监护人_In,
        出生地点 = 出生地点_In, 手机号 = Nvl(v_手机号, 手机号)
    Where 病人id = 病人id_In;
  
    v_Username := Zl_Username;
    d_变动时间 := Sysdate;
    If Nvl(病人id_In, 0) > 0 Then
      If Nvl(姓名_In, '__') <> Nvl(v_姓名信息, '__') Then
        Insert Into 病人信息变动
          (病人id, 变动项目, 原信息, 新信息, 变动时间, 变动人, 变动模块, 说明)
        Values
          (病人id_In, '姓名', v_姓名信息, 姓名_In, d_变动时间, v_Username, '挂号', '病人基本信息调整');
      End If;
      If Nvl(身份证号_In, '__') <> Nvl(v_身份证号, '__') Then
        Insert Into 病人信息变动
          (病人id, 变动项目, 原信息, 新信息, 变动时间, 变动人, 变动模块, 说明)
        Values
          (病人id_In, '身份证号', v_身份证号, 身份证号_In, d_变动时间, v_Username, '挂号', '病人基本信息调整');
      End If;
      If Nvl(性别_In, '__') <> Nvl(v_性别信息, '__') Then
        Insert Into 病人信息变动
          (病人id, 变动项目, 原信息, 新信息, 变动时间, 变动人, 变动模块, 说明)
        Values
          (病人id_In, '性别', v_性别信息, 性别_In, d_变动时间, v_Username, '挂号', '病人基本信息调整');
      End If;
      If Nvl(年龄_In, '__') <> Nvl(v_年龄信息, '__') Then
        Insert Into 病人信息变动
          (病人id, 变动项目, 原信息, 新信息, 变动时间, 变动人, 变动模块, 说明)
        Values
          (病人id_In, '年龄', v_年龄信息, 年龄_In, d_变动时间, v_Username, '挂号', '病人基本信息调整');
      End If;
      If Nvl(v_出生日期, Sysdate) <> Nvl(d_出生日期信息, Sysdate) Then
        Insert Into 病人信息变动
          (病人id, 变动项目, 原信息, 新信息, 变动时间, 变动人, 变动模块, 说明)
        Values
          (病人id_In, '出生日期', To_Char(d_出生日期信息, 'YYYY-MM-DD hh24:mi'), To_Char(v_出生日期, 'YYYY-MM-DD hh24:mi'), d_变动时间,
           v_Username, '挂号', '病人基本信息调整');
      End If;
    End If;
  
    --北京医保:问题:26982
    If Nvl(险类_In, 0) = 920 And Not 医保号_In Is Null Then
      --需要反更新
      Update 医保病人档案 B
      Set 医保号 = 医保号_In
      Where (险类, 中心, 医保号) = (Select 险类, 中心, 医保号
                             From 医保病人关联表 A
                             Where 险类 = 险类_In And a.病人id = 病人id_In And a.医保号 <> 医保号_In And Rownum = 1);
      Update 医保病人关联表 Set 医保号 = 医保号_In Where 病人id = 病人id_In And 医保号 <> 医保号_In And 险类 = 险类_In;
    End If;
  
    If 挂号单_In Is Not Null Then
    
      Update 病人挂号记录
      Set 门诊号 = 门诊号_In, 姓名 = 姓名_In, 性别 = Nvl(性别_In, 性别), 年龄 = Nvl(年龄_In, 年龄)
      Where NO = 挂号单_In;
    
      Update 门诊费用记录
      Set 标识号 = 门诊号_In, 姓名 = 姓名_In, 性别 = Nvl(性别_In, 性别), 年龄 = Nvl(年龄_In, 年龄)
      Where NO = 挂号单_In And 记录性质 = 4;
    End If;
  End If;

  --门诊病案
  If 门诊号_In Is Not Null Then
    If 处理类型_In In (1, 2) Then
      Update 门诊病案记录 Set 病案号 = 门诊号_In Where 病人id = 病人id_In;
      If Sql%RowCount = 0 Then
        Insert Into 门诊病案记录
          (病人id, 病案号, 建立日期, 病案类别, 存储状态, 存放位置)
        Values
          (病人id_In, 门诊号_In, 登记时间_In, '一般', Null, Null);
      End If;
    Elsif 处理类型_In = 3 Then
      Update 门诊病案记录 Set 病案号 = 门诊号_In Where 病人id = 病人id_In;
    End If;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_挂号病人病案_Insert;
/

--107734:刘尔旋,2017-03-29,手机号兼容处理
Create Or Replace Procedure Zl_病人信息_Update
(
  病人id_In         病人信息.病人id%Type,
  门诊号_In         病人信息.门诊号%Type,
  住院号_In         病人信息.住院号%Type,
  费别_In           病人信息.费别%Type,
  医疗付款_In       病人信息.医疗付款方式%Type,
  姓名_In           病人信息.姓名%Type,
  性别_In           病人信息.性别%Type,
  年龄_In           病人信息.年龄%Type,
  出生日期_In       病人信息.出生日期%Type,
  出生地点_In       病人信息.出生地点%Type,
  身份证号_In       病人信息.身份证号%Type,
  身份_In           病人信息.身份%Type,
  职业_In           病人信息.职业%Type,
  民族_In           病人信息.民族%Type,
  国籍_In           病人信息.国籍%Type,
  学历_In           病人信息.学历%Type,
  婚姻_In           病人信息.婚姻状况%Type,
  家庭地址_In       病人信息.家庭地址%Type,
  家庭电话_In       病人信息.家庭电话%Type,
  家庭地址邮编_In   病人信息.家庭地址邮编%Type,
  联系人姓名_In     病人信息.联系人姓名%Type,
  联系人关系_In     病人信息.联系人关系%Type,
  联系人地址_In     病人信息.联系人地址%Type,
  联系人电话_In     病人信息.联系人电话%Type,
  合同单位id_In     病人信息.合同单位id%Type,
  工作单位_In       病人信息.工作单位%Type,
  单位电话_In       病人信息.单位电话%Type,
  单位邮编_In       病人信息.单位邮编%Type,
  单位开户行_In     病人信息.单位开户行%Type,
  单位帐号_In       病人信息.单位帐号%Type,
  担保人_In         病人信息.担保人%Type,
  担保额_In         病人信息.担保额%Type,
  险类_In           病人信息.险类%Type,
  住院费别_In       Number := 0, --是否修改的是病人的住院费别
  医保号_In         保险帐户.医保号%Type := Null,
  区域_In           病人信息.区域%Type := Null,
  担保性质_In       病人信息.担保性质%Type := Null,
  操作员编号_In     病人担保记录.操作员编号%Type := Null,
  操作员姓名_In     病人担保记录.操作员姓名%Type := Null,
  其他证件_In       病人信息.其他证件%Type := Null,
  病人类型_In       病案主页.病人类型%Type := Null,
  备注_In           病案主页.备注%Type := Null,
  籍贯_In           病人信息.籍贯%Type := Null,
  户口地址_In       病人信息.户口地址%Type := Null,
  户口地址邮编_In   病人信息.户口地址邮编%Type := Null,
  联系人身份证号_In In 病人信息.联系人身份证号%Type := Null,
  模块号_In         Number := 0, --修改病人姓名、性别、年龄、出生日期的模块
  监护人_In         病人信息.监护人%Type := Null,
  手机号_In         病人信息.手机号%Type := Null
) As
  v_主页id     病案主页.主页id%Type;
  v_出院日期   病案主页.出院日期%Type;
  v_模块号     Varchar2(1000); --要修改病人姓名的模块号组合,格式为:,模块号,模块号,....
  v_手机号     病人信息.手机号%Type;
  v_手机号字段 Varchar2(500);

Begin
  v_模块号 := ',1111,1107,1103,';
  Begin
    Select Max(主页id) Into v_主页id From 病案主页 Where 病人id = 病人id_In;
  Exception
    When Others Then
      Null;
  End;
  If 门诊号_In Is Not Null Then
    Update 门诊病案记录 Set 病案号 = 门诊号_In Where 病人id = 病人id_In;
    If Sql%RowCount = 0 Then
      Insert Into 门诊病案记录
        (病人id, 病案号, 建立日期, 病案类别, 存储状态, 存放位置)
      Values
        (病人id_In, 门诊号_In, Sysdate, '一般', '正常', Null);
    End If;
  Else
    Delete From 门诊病案记录 Where 病人id = 病人id_In;
  End If;

  If 手机号_In Is Null Then
    If 家庭电话_In Is Not Null Then
      --中国移动
      v_手机号字段 := ',139,138,137,136,135,134,159,158,157,150,151,152,147,188,187,182,183,184,178';
      --中国联通
      v_手机号字段 := v_手机号字段 || ',130,131,132,156,155,186,185,145,176';
      --中国电信
      v_手机号字段 := v_手机号字段 || ',133,153,189,180,181,177,173';
      --虚拟运营商
      v_手机号字段 := v_手机号字段 || ',170,';
      If Not Instr(v_手机号字段, ',' || Substr(家庭电话_In, 1, 3) || ',') = 0 Then
        v_手机号 := 家庭电话_In;
      End If;
    End If;
  Else
    v_手机号 := 手机号_In;
  End If;

  If Instr(v_模块号, ',' || 模块号_In || ',', 1) = 0 Then
    Update 病人信息
    Set 门诊号 = 门诊号_In, 住院号 = 住院号_In, 医疗付款方式 = 医疗付款_In, 费别 = Decode(Nvl(住院费别_In, 0), 0, 费别_In, 费别), 出生地点 = 出生地点_In,
        身份证号 = 身份证号_In, 身份 = 身份_In, 职业 = 职业_In, 民族 = 民族_In, 国籍 = 国籍_In, 籍贯 = Nvl(籍贯_In, 籍贯), 区域 = 区域_In, 学历 = 学历_In,
        婚姻状况 = 婚姻_In, 家庭地址 = 家庭地址_In, 家庭电话 = 家庭电话_In, 家庭地址邮编 = 家庭地址邮编_In, 户口地址 = Nvl(户口地址_In, 户口地址),
        户口地址邮编 = Nvl(户口地址邮编_In, 户口地址邮编), 联系人姓名 = 联系人姓名_In, 联系人关系 = 联系人关系_In, 联系人地址 = 联系人地址_In, 联系人电话 = 联系人电话_In,
        合同单位id = Decode(合同单位id_In, 0, Null, 合同单位id_In), 工作单位 = 工作单位_In, 单位电话 = 单位电话_In, 单位邮编 = 单位邮编_In, 单位开户行 = 单位开户行_In,
        单位帐号 = 单位帐号_In, 担保人 = 担保人_In, 担保额 = Decode(担保额_In, 0, Null, 担保额_In), 担保性质 = 担保性质_In, 险类 = 险类_In, 医保号 = 医保号_In,
        其他证件 = 其他证件_In, 联系人身份证号 = 联系人身份证号_In, 病人类型 = 病人类型_In, 监护人 = 监护人_In, 手机号 = Nvl(v_手机号, 手机号)
    Where 病人id = 病人id_In;
  Else
    Update 病人信息
    Set 门诊号 = 门诊号_In, 住院号 = 住院号_In, 医疗付款方式 = 医疗付款_In, 费别 = Decode(Nvl(住院费别_In, 0), 0, 费别_In, 费别), 姓名 = 姓名_In, 性别 = 性别_In,
        年龄 = 年龄_In, 出生日期 = 出生日期_In, 出生地点 = 出生地点_In, 身份证号 = 身份证号_In, 身份 = 身份_In, 职业 = 职业_In, 民族 = 民族_In, 国籍 = 国籍_In,
        籍贯 = Nvl(籍贯_In, 籍贯), 区域 = 区域_In, 学历 = 学历_In, 婚姻状况 = 婚姻_In, 家庭地址 = 家庭地址_In, 家庭电话 = 家庭电话_In, 家庭地址邮编 = 家庭地址邮编_In,
        户口地址 = Nvl(户口地址_In, 户口地址), 户口地址邮编 = Nvl(户口地址邮编_In, 户口地址邮编), 联系人姓名 = 联系人姓名_In, 联系人关系 = 联系人关系_In, 联系人地址 = 联系人地址_In,
        联系人电话 = 联系人电话_In, 合同单位id = Decode(合同单位id_In, 0, Null, 合同单位id_In), 工作单位 = 工作单位_In, 单位电话 = 单位电话_In, 单位邮编 = 单位邮编_In,
        单位开户行 = 单位开户行_In, 单位帐号 = 单位帐号_In, 担保人 = 担保人_In, 担保额 = Decode(担保额_In, 0, Null, 担保额_In), 担保性质 = 担保性质_In,
        险类 = 险类_In, 医保号 = 医保号_In, 其他证件 = 其他证件_In, 联系人身份证号 = 联系人身份证号_In, 病人类型 = 病人类型_In, 监护人 = 监护人_In,
        手机号 = Nvl(v_手机号, 手机号)
    Where 病人id = 病人id_In;
  End If;

  If v_主页id Is Not Null Then
    Update 病案主页
    Set 住院号 = 住院号_In, 费别 = Decode(Nvl(住院费别_In, 0), 1, 费别_In, 费别), 医疗付款方式 = 医疗付款_In, 区域 = Decode(区域_In, Null, 区域, 区域_In),
        备注 = 备注_In
    Where 病人id = 病人id_In And 主页id = v_主页id;
  
    --对在院病人更新病案主页中的信息
    Begin
      Select 出院日期 Into v_出院日期 From 病案主页 Where 病人id = 病人id_In And 主页id = v_主页id;
    Exception
      When Others Then
        Null;
    End;
    If v_出院日期 Is Null Then
      Update 病案主页
      Set 婚姻状况 = 婚姻_In, 学历 = 学历_In, 职业 = 职业_In, 单位电话 = 单位电话_In, 单位邮编 = 单位邮编_In, 家庭地址 = 家庭地址_In, 家庭电话 = 家庭电话_In,
          家庭地址邮编 = 家庭地址邮编_In, 户口地址 = Nvl(户口地址_In, 户口地址), 户口地址邮编 = Nvl(户口地址邮编_In, 户口地址邮编), 联系人姓名 = 联系人姓名_In,
          联系人关系 = 联系人关系_In, 联系人地址 = 联系人地址_In, 联系人电话 = 联系人电话_In, 病人类型 = 病人类型_In, 备注 = 备注_In
      Where 病人id = 病人id_In And 主页id = v_主页id;
    End If;
  
    If 医保号_In Is Not Null Then
      Update 病案主页从表 Set 信息值 = 医保号_In Where 病人id = 病人id_In And 主页id = v_主页id And 信息名 = '医保号';
      If Sql%RowCount = 0 Then
        Insert Into 病案主页从表 (病人id, 主页id, 信息名, 信息值) Values (病人id_In, v_主页id, '医保号', 医保号_In);
      End If;
    Else
      Delete From 病案主页从表 Where 病人id = 病人id_In And 主页id = v_主页id And 信息名 = '医保号';
    End If;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人信息_Update;
/

--107734:刘尔旋,2017-03-29,手机号兼容处理
Create Or Replace Procedure Zl_病人信息_Insert
(
  病人id_In         病人信息.病人id%Type,
  门诊号_In         病人信息.门诊号%Type,
  费别_In           病人信息.费别%Type,
  医疗付款_In       病人信息.医疗付款方式%Type,
  姓名_In           病人信息.姓名%Type,
  性别_In           病人信息.性别%Type,
  年龄_In           病人信息.年龄%Type,
  出生日期_In       病人信息.出生日期%Type,
  出生地点_In       病人信息.出生地点%Type,
  身份证号_In       病人信息.身份证号%Type,
  身份_In           病人信息.身份%Type,
  职业_In           病人信息.职业%Type,
  民族_In           病人信息.民族%Type,
  国籍_In           病人信息.国籍%Type,
  学历_In           病人信息.学历%Type,
  婚姻_In           病人信息.婚姻状况%Type,
  家庭地址_In       病人信息.家庭地址%Type,
  家庭电话_In       病人信息.家庭电话%Type,
  家庭地址邮编_In   病人信息.家庭地址邮编%Type,
  联系人姓名_In     病人信息.联系人姓名%Type,
  联系人关系_In     病人信息.联系人关系%Type,
  联系人地址_In     病人信息.联系人地址%Type,
  联系人电话_In     病人信息.联系人电话%Type,
  合同单位id_In     病人信息.合同单位id%Type,
  工作单位_In       病人信息.工作单位%Type,
  单位电话_In       病人信息.单位电话%Type,
  单位邮编_In       病人信息.单位邮编%Type,
  单位开户行_In     病人信息.单位开户行%Type,
  单位帐号_In       病人信息.单位帐号%Type,
  担保人_In         病人信息.担保人%Type,
  担保额_In         病人信息.担保额%Type,
  险类_In           病人信息.险类%Type,
  登记时间_In       病人信息.登记时间%Type,
  区域_In           病人信息.区域%Type := Null,
  担保性质_In       病人信息.担保性质%Type := Null,
  操作员编号_In     病人担保记录.操作员编号%Type := Null,
  操作员姓名_In     病人担保记录.操作员姓名%Type := Null,
  医保号_In         病人信息.医保号%Type := Null,
  其他证件_In       病人信息.其他证件%Type := Null,
  籍贯_In           病人信息.籍贯%Type := Null,
  户口地址_In       病人信息.户口地址%Type := Null,
  户口地址邮编_In   病人信息.户口地址邮编%Type := Null,
  联系人身份证号_In 病人信息.联系人身份证号%Type := Null,
  病人类型_In       病人信息.病人类型%Type := Null,
  监护人_In         病人信息.监护人%Type := Null,
  手机号_In         病人信息.手机号%Type := Null
) As
  v_费别       病人信息.费别%Type;
  v_手机号     病人信息.手机号%Type;
  v_手机号字段 Varchar2(500);
Begin
  If 费别_In Is Null Then
    Select Max(名称) Into v_费别 From 费别 Where 缺省标志 = 1; --不管适用科室和服务对象
  Else
    v_费别 := 费别_In;
  End If;

  If 手机号_In Is Null Then
    If 家庭电话_In Is Not Null Then
      --中国移动
      v_手机号字段 := ',139,138,137,136,135,134,159,158,157,150,151,152,147,188,187,182,183,184,178';
      --中国联通
      v_手机号字段 := v_手机号字段 || ',130,131,132,156,155,186,185,145,176';
      --中国电信
      v_手机号字段 := v_手机号字段 || ',133,153,189,180,181,177,173';
      --虚拟运营商
      v_手机号字段 := v_手机号字段 || ',170,';
      If Not Instr(v_手机号字段, ',' || Substr(家庭电话_In, 1, 3) || ',') = 0 Then
        v_手机号 := 家庭电话_In;
      End If;
    End If;
  Else
    v_手机号 := 手机号_In;
  End If;

  Insert Into 病人信息
    (病人id, 门诊号, 费别, 医疗付款方式, 姓名, 性别, 年龄, 出生日期, 出生地点, 身份证号, 身份, 职业, 民族, 国籍, 区域, 籍贯, 学历, 婚姻状况, 家庭地址, 家庭电话, 家庭地址邮编, 户口地址,
     户口地址邮编, 联系人姓名, 联系人关系, 联系人地址, 联系人电话, 合同单位id, 工作单位, 单位电话, 单位邮编, 单位开户行, 单位帐号, 担保人, 担保额, 担保性质, 险类, 登记时间, 医保号, 其他证件,
     联系人身份证号, 病人类型, 监护人, 手机号)
  Values
    (病人id_In, 门诊号_In, v_费别, 医疗付款_In, 姓名_In, 性别_In, 年龄_In, 出生日期_In, 出生地点_In, 身份证号_In, 身份_In, 职业_In, 民族_In, 国籍_In, 区域_In,
     籍贯_In, 学历_In, 婚姻_In, 家庭地址_In, 家庭电话_In, 家庭地址邮编_In, 户口地址_In, 户口地址邮编_In, 联系人姓名_In, 联系人关系_In, 联系人地址_In, 联系人电话_In,
     Decode(合同单位id_In, 0, Null, 合同单位id_In), 工作单位_In, 单位电话_In, 单位邮编_In, 单位开户行_In, 单位帐号_In, 担保人_In,
     Decode(担保额_In, 0, Null, 担保额_In), 担保性质_In, 险类_In, 登记时间_In, 医保号_In, 其他证件_In, 联系人身份证号_In, 病人类型_In, 监护人_In, v_手机号);

  If 门诊号_In Is Not Null Then
    Insert Into 门诊病案记录
      (病人id, 病案号, 建立日期, 病案类别, 存储状态, 存放位置)
    Values
      (病人id_In, 门诊号_In, 登记时间_In, '一般', '正常', Null);
  End If;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人信息_Insert;
/


--107734:刘尔旋,2017-03-29,手机号兼容处理
Create Or Replace Procedure Zl_Third_Buildpatiinfo
(
  Xml_In    In Xmltype,
  Expend_In In Xmltype,
  Xml_Out   Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:挂号数据写入
  --入参:Xml_In:
  --  <IN>
  --    <FB>费别</FB>                      //掌上中联后台中设定
  --    <FKFS>医疗付款方式</FKFS>          //掌上中联后台中设定
  --    <XM>姓名</XM>
  --    <XB>性别</XB>
  --    <NL>年龄</NL>
  --    <CSRQ>出生日期</CSRQ>
  --    <SFZ >身份证号</SFZ>              //必须有
  --    <KLB>医疗卡名称</KLB>             //固定为：手机支付
  --    <SJH>手机号</SJH>                //如果手机号为空，则以身份证号创建就诊卡；否则以手机号创建就诊卡
  --  </IN>
  --      Expend_In:扩展信息,暂不用,主要是适应移动产品的参数统一
  --出参:Xml_Out
  --  <OUTPUT>
  --    <BRID>1</BRID>                   //返回创建好的档案，或原来已有的档案
  --                                     //如无下列错误结点则说明正确执行
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_费别         病人信息.费别%Type;
  v_付款方式     病人信息.医疗付款方式%Type;
  v_姓名         病人信息.姓名%Type;
  v_性别         病人信息.性别%Type;
  v_年龄         病人信息.年龄%Type;
  d_出生日期     病人信息.出生日期%Type;
  v_身份证号     病人信息.身份证号%Type;
  v_医疗卡名称   医疗卡类别.名称%Type;
  v_卡号         病人医疗卡信息.卡号%Type;
  v_手机号       病人信息.手机号%Type;
  n_卡类别id     医疗卡类别.Id%Type;
  v_结算方式     医疗卡类别.结算方式%Type;
  v_验证姓名     病人信息.姓名%Type;
  n_病人id       病人信息.病人id%Type;
  n_卡病人id     病人信息.病人id%Type;
  v_医疗卡编码   医疗卡类别.编码%Type;
  n_是否缺省密码 医疗卡类别.是否缺省密码%Type;
  v_密码         病人医疗卡信息.密码%Type;
  n_密码长度     医疗卡类别.密码长度%Type;
  v_Temp         Varchar2(32767); --临时XML
  x_Templet      Xmltype; --模板XML
  v_Err_Msg      Varchar2(200);
  n_Exists       Number(2);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/FB'), Extractvalue(Value(A), 'IN/FKFS'), Extractvalue(Value(A), 'IN/XM'),
         Extractvalue(Value(A), 'IN/SFZ'), Extractvalue(Value(A), 'IN/KLB'), Extractvalue(Value(A), 'IN/SJH'),
         Extractvalue(Value(A), 'IN/XB'), Extractvalue(Value(A), 'IN/NL'), To_Date(Extractvalue(Value(A), 'IN/CSRQ')),
         Extractvalue(Value(A), 'IN/YLKID'), Extractvalue(Value(A), 'IN/YLKBM')
  Into v_费别, v_付款方式, v_姓名, v_身份证号, v_医疗卡名称, v_手机号, v_性别, v_年龄, d_出生日期, n_卡类别id, v_医疗卡编码
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  v_卡号 := v_手机号;

  --某些入参节点为空的情况
  If Nvl(v_卡号, '_') = '_' Then
    v_卡号 := v_身份证号;
  End If;

  If Nvl(v_性别, '_') = '_' Then
    If Mod(To_Number(Substr(v_身份证号, -2, 1)), 2) = 1 Then
      v_性别 := '男';
    Else
      v_性别 := '女';
    End If;
  End If;

  If d_出生日期 Is Null Then
    If Length(Trim(v_身份证号)) = 15 Then
      d_出生日期 := To_Date('19' || Substr(v_身份证号, 7, 6), 'yyyy-mm-dd');
    End If;
    If Length(Trim(v_身份证号)) = 18 Then
      d_出生日期 := To_Date(Substr(v_身份证号, 7, 8), 'yyyy-mm-dd');
    End If;
  End If;
  If Nvl(v_年龄, '_') = '_' Then
    v_年龄 := Zl_Age_Calc(0, d_出生日期, Sysdate);
  End If;

  --检查医疗卡名称
  If Nvl(n_卡类别id, 0) = 0 Then
    If Nvl(v_医疗卡编码, '_') <> '_' Then
      v_Err_Msg := Null;
      Begin
        Select ID, 结算方式, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行挂号!')
        Into n_卡类别id, v_结算方式, v_Err_Msg
        From 医疗卡类别
        Where 编码 = v_医疗卡编码;
      Exception
        When Others Then
          v_Err_Msg := '医疗卡编码:' || v_医疗卡编码 || '不存在!';
      End;
      If Not v_Err_Msg Is Null Then
        Raise Err_Item;
      End If;
    Elsif Nvl(v_医疗卡名称, '_') <> '_' Then
    
      v_Err_Msg := Null;
      Begin
        Select ID, 结算方式, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行挂号!')
        Into n_卡类别id, v_结算方式, v_Err_Msg
        From 医疗卡类别
        Where 名称 = v_医疗卡名称;
      Exception
        When Others Then
          v_Err_Msg := v_医疗卡名称 || '不存在!';
      End;
      If Not v_Err_Msg Is Null Then
        Raise Err_Item;
      End If;
    Else
      v_Err_Msg := '系统不能识别有效的医疗卡,不允许挂号!';
      Raise Err_Item;
    End If;
  Else
    v_Err_Msg := Null;
    Begin
      Select ID, 结算方式, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行挂号!')
      Into n_卡类别id, v_结算方式, v_Err_Msg
      From 医疗卡类别
      Where ID = n_卡类别id;
    Exception
      When Others Then
        v_Err_Msg := '系统不能识别指定的医疗卡(' || n_卡类别id || ')!';
    End;
    If Not v_Err_Msg Is Null Then
      Raise Err_Item;
    End If;
  End If;

  --建档操作
  Begin
    Select 1, 姓名, 病人id Into n_Exists, v_验证姓名, n_病人id From 病人信息 Where 身份证号 = v_身份证号;
  Exception
    When Others Then
      n_Exists := 0;
  End;
  If n_Exists >= 1 Then
    If v_姓名 <> v_验证姓名 Then
      v_Err_Msg := '身份证号码与病人姓名不匹配!';
      Raise Err_Item;
    End If;
  Else
    n_病人id := Nextno(1);
    Zl_挂号病人病案_Insert(1, n_病人id, Null, Null, Null, v_姓名, v_性别, v_年龄, v_费别, v_付款方式, Null, Null, Null, Null, v_身份证号, Null,
                     Null, Null, Null, Null, Null, Null, Sysdate, Null, d_出生日期, Null, Null, Null, Null, Null, Null,
                     Null, Null, Null, Null, Null, Null, v_手机号);
  End If;
  v_Temp := '<BRID>' || n_病人id || '</BRID>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
  --发卡操作
  Begin
    Select 1, 病人id Into n_Exists, n_卡病人id From 病人医疗卡信息 Where 卡类别id = n_卡类别id And 卡号 = v_卡号;
  Exception
    When Others Then
      n_Exists := 0;
  End;
  If n_Exists = 0 Then
    Zl_医疗卡变动_Insert(1, n_病人id, n_卡类别id, Null, v_卡号, '手机建档', Null, Null, Sysdate);
  Else
    If n_病人id <> n_卡病人id Then
      v_Err_Msg := '该卡号已经被其他人绑定!';
      Raise Err_Item;
    End If;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Buildpatiinfo;
/

--107734:刘尔旋,2017-03-29,手机号兼容处理
Create Or Replace Procedure Zl_Third_Buildpatient
(
  Patiinfo_In  In Xmltype,
  Patiinfo_Out Out Xmltype
) Is
  -------------------------------------------------------------------------------
  --参数说明:
  -- 入参 Patiinfo_In:
  --<IN>
  --  <ZJH></ZJH>                 //证件号，目前仅支持身份证号
  --  <ZJLX></ZJLX>                       //证件类型(目前仅支持身份证,为空时默认为身份证)
  --  <XM></XM>                       //姓名
  --  <SJH></SJH>                      //手机号
  --</IN>

  --出参 Patiinfo_Out：
  --<OUTPUT>
  --       <BRID></BRID>                //病人ID
  --       <MZH></MZH>                  //门诊号
  --     <ERROR></ERROR>         //如果有错误返回该节点
  --</OUTPUT>
  -------------------------------------------------------------------------------
  n_Pati_Id      病人信息.病人id%Type;
  n_Card_Type_Id 医疗卡类别.Id%Type;
  n_Count        Number(5);
  n_Sum          Number(5);
  v_校验位       Varchar2(50);

  v_姓名         病人信息.姓名%Type;
  v_身份证号     病人信息.身份证号%Type;
  v_手机号       病人信息.家庭电话%Type;
  v_性别         病人信息.性别%Type;
  v_年龄         病人信息.年龄%Type;
  v_操作员       人员表.姓名%Type;
  v_医疗付款方式 病人信息.医疗付款方式%Type;
  n_门诊号       病人信息.门诊号%Type;
  v_证件类型     医疗卡类别.名称%Type;
  v_证件号       病人医疗卡信息.卡号%Type;

  v_Pattern Varchar2(500);
  v_Temp    Varchar2(32767); --临时XML
  v_Err_Msg Varchar2(2000);
  n_存在    Number(2);

  d_出生日期  病人信息.出生日期%Type;
  d_Curr_Time Date;

  Err_Item Exception;
Begin
  Patiinfo_Out := Xmltype('<OUTPUT></OUTPUT>');
  Select Sysdate Into d_Curr_Time From Dual;

  --新建病人：姓名、身份证号、手机号（存在家庭电话中）、出生日期、性别、年龄(后面三项可从身份证中获取)。
  Select Extractvalue(Value(I), 'IN/XM'), Extractvalue(Value(I), 'IN/ZJH'), Extractvalue(Value(I), 'IN/SJH'),
         Extractvalue(Value(I), 'IN/ZJLX')
  Into v_姓名, v_证件号, v_手机号, v_证件类型
  From Table(Xmlsequence(Extract(Patiinfo_In, 'IN'))) I;

  Begin
    If v_证件类型 Is Null Then
      Select 病人id
      Into n_Pati_Id
      From 病人医疗卡信息
      Where 卡号 = v_证件号 And 卡类别id In (Select ID From 医疗卡类别 Where 名称 Like '%身份证%') And Rownum < 2;
    Else
      Select 病人id
      Into n_Pati_Id
      From 病人医疗卡信息
      Where 卡号 = v_证件号 And 卡类别id In (Select ID From 医疗卡类别 Where 名称 = v_证件类型) And Rownum < 2;
    End If;
    n_存在 := 1;
  Exception
    When Others Then
      n_存在 := 0;
  End;

  If Nvl(n_存在, 0) = 1 Then
    v_Temp := '<BRID>' || n_Pati_Id || '</BRID>';
    Select Appendchildxml(Patiinfo_Out, '/OUTPUT', Xmltype(v_Temp)) Into Patiinfo_Out From Dual;
    Select 门诊号 Into n_门诊号 From 病人信息 Where 病人id = n_Pati_Id;
    If n_门诊号 Is Null Then
      n_门诊号 := Nextno(3);
      Update 病人信息 Set 门诊号 = n_门诊号 Where 病人id = n_Pati_Id;
    End If;
    v_Temp := '<MZH>' || n_门诊号 || '</MZH>';
    Select Appendchildxml(Patiinfo_Out, '/OUTPUT', Xmltype(v_Temp)) Into Patiinfo_Out From Dual;
  Else
    If v_姓名 Is Null Then
      v_Err_Msg := '传人姓名为空!';
      Raise Err_Item;
    End If;
    If v_证件类型 Like '%身份证%' Or v_证件类型 Is Null Then
      v_身份证号 := v_证件号;
    Else
      v_Err_Msg := '目前不支持身份证以外的方式建档！';
      Raise Err_Item;
    End If;
  
    If v_身份证号 Is Null Then
      v_Err_Msg := '传人身份证号为空!';
      Raise Err_Item;
    Else
      --身份证合法验证
      v_Pattern := '11,12,13,14,15,21,22,23,31,32,33,34,35,36,37,41,42,43,44,45,46,50,51,52,53,54,61,62,63,64,65,71,81,82,91';
    
      --地区检验
      If Instr(v_Pattern, Substr(v_身份证号, 1, 2)) = 0 Then
        v_Err_Msg := '身份证前两位地区码不正确!';
        Raise Err_Item;
      End If;
      --身份证长度检查
      If Length(v_身份证号) = 15 Then
        --检查身份证号:15位身份证号要求全部为数字
        v_Pattern := '^\d{15}$';
        Select Count(1) Into n_Count From Dual Where Regexp_Like(v_身份证号, v_Pattern);
        If n_Count = 0 Then
          v_Err_Msg := '身份证中包含非法字符，请检查!';
          Raise Err_Item;
        End If;
        --获取性别
        If Mod(To_Number(Substr(v_身份证号, 15, 1)), 2) = 1 Then
          v_性别 := '男';
        Else
          v_性别 := '女';
        End If;
        --出生日期的合法性检查
        d_出生日期 := To_Date('19' || Substr(v_身份证号, 7, 6), 'yyyy-mm-dd');
        v_Pattern  := '^19[0-9]{2}((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))$';
        Select Count(1) Into n_Count From Dual Where Regexp_Like('19' || Substr(v_身份证号, 7, 6), v_Pattern);
        If n_Count = 0 Then
          v_Err_Msg := '身份证中的出生日期无效，请检查!';
          Raise Err_Item;
        Else
          If d_出生日期 > To_Date(To_Char(d_Curr_Time, 'YYYY-MM-DD'), 'YYYY-MM-dd') Then
            v_Err_Msg := '身份证中的出生日期无效，请检查!';
            Raise Err_Item;
          End If;
        End If;
      Elsif Length(v_身份证号) = 18 Then
        -- 18 位身份证号前17 位全部为数字，最后1位可为数字或x
        v_Pattern := '^\d{17}[0-9Xx]$';
        Select Count(1) Into n_Count From Dual Where Regexp_Like(v_身份证号, v_Pattern);
        If n_Count = 0 Then
          v_Err_Msg := '身份证中包含非法字符!';
          Raise Err_Item;
        End If;
        --获取性别
        If Mod(To_Number(Substr(v_身份证号, 17, 1)), 2) = 1 Then
          v_性别 := '男';
        Else
          v_性别 := '女';
        End If;
        --出生日期的合法性检查
        d_出生日期 := To_Date(Substr(v_身份证号, 7, 8), 'yyyy-mm-dd');
        v_Pattern  := '^(1[6-9]|[2-9][0-9])[0-9]{2}((01|03|05|07|08|10|12)(0[1-9]|[1-2][0-9]|3[0-1])|(04|06|09|11)(0[1-9]|[1-2][0-9]|30)|02(0[1-9]|[1-2][0-9]))$';
        Select Count(1) Into n_Count From Dual Where Regexp_Like(Substr(v_身份证号, 7, 8), v_Pattern);
        If n_Count = 0 Then
          v_Err_Msg := '身份证中的出生日期无效，请检查!';
          Raise Err_Item;
        Else
          If d_出生日期 > To_Date(To_Char(d_Curr_Time, 'YYYY-MM-DD'), 'YYYY-MM-dd') Then
            v_Err_Msg := '身份证中的出生日期无效，请检查!';
            Raise Err_Item;
          End If;
          --计算校验位
          n_Sum     := (To_Number(Substr(v_身份证号, 1, 1)) + To_Number(Substr(v_身份证号, 11, 1))) * 7 +
                       (To_Number(Substr(v_身份证号, 2, 1)) + To_Number(Substr(v_身份证号, 12, 1))) * 9 +
                       (To_Number(Substr(v_身份证号, 3, 1)) + To_Number(Substr(v_身份证号, 13, 1))) * 10 +
                       (To_Number(Substr(v_身份证号, 4, 1)) + To_Number(Substr(v_身份证号, 14, 1))) * 5 +
                       (To_Number(Substr(v_身份证号, 5, 1)) + To_Number(Substr(v_身份证号, 15, 1))) * 8 +
                       (To_Number(Substr(v_身份证号, 6, 1)) + To_Number(Substr(v_身份证号, 16, 1))) * 4 +
                       (To_Number(Substr(v_身份证号, 7, 1)) + To_Number(Substr(v_身份证号, 17, 1))) * 2 +
                       To_Number(Substr(v_身份证号, 8, 1)) * 1 + To_Number(Substr(v_身份证号, 9, 1)) * 6 +
                       To_Number(Substr(v_身份证号, 10, 1)) * 3;
          n_Count   := Mod(n_Sum, 11);
          v_Pattern := '10X98765432';
          v_校验位  := Substr(v_Pattern, n_Count + 1, 1);
          If v_校验位 <> Upper(Substr(v_身份证号, 18, 1)) Then
            v_Err_Msg := '身份证号码不正确，请检查。';
            Raise Err_Item;
          End If;
        End If;
      Else
        v_Err_Msg := '身份证长度不对,请检查。';
        Raise Err_Item;
      End If;
    
      If Nvl(v_年龄, '_') = '_' Then
        v_年龄 := Zl_Age_Calc(0, d_出生日期, d_Curr_Time);
      End If;
    End If;
  
    Select 名称 Into v_医疗付款方式 From 医疗付款方式 Where 缺省标志 = 1;
    n_Pati_Id := Nextno(1);
    n_门诊号  := Nextno(3);
    Insert Into 病人信息
      (病人id, 姓名, 身份证号, 家庭电话, 出生日期, 性别, 年龄, 登记时间, 门诊号, 医疗付款方式, 手机号)
      Select n_Pati_Id, v_姓名, v_身份证号, v_手机号, d_出生日期, v_性别, v_年龄, d_Curr_Time, n_门诊号, v_医疗付款方式, v_手机号

      From Dual;
  
    --病人信息保存完后，完成医疗卡绑定（二代身份证卡类别的绑定）
    Begin
      If v_证件类型 Is Null Then
        Select ID Into n_Card_Type_Id From 医疗卡类别 Where 名称 Like '%身份证%' And Rownum < 2;
      Else
        Select ID Into n_Card_Type_Id From 医疗卡类别 Where 名称 = v_证件类型 And Rownum < 2;
      End If;
    Exception
      When No_Data_Found Then
        v_Err_Msg := '身份证卡类别不存在！';
        Raise Err_Item;
    End;
    Select b.姓名 Into v_操作员 From 上机人员表 A, 人员表 B Where a.人员id = b.Id And a.用户名 = User;
  
    Zl_医疗卡变动_Insert(11, n_Pati_Id, n_Card_Type_Id, Null, v_身份证号, '创建虚拟卡', Null, v_操作员, d_Curr_Time);
  
    v_Temp := '<BRID>' || n_Pati_Id || '</BRID>';
    Select Appendchildxml(Patiinfo_Out, '/OUTPUT', Xmltype(v_Temp)) Into Patiinfo_Out From Dual;
    v_Temp := '<MZH>' || n_门诊号 || '</MZH>';
    Select Appendchildxml(Patiinfo_Out, '/OUTPUT', Xmltype(v_Temp)) Into Patiinfo_Out From Dual;
  End If;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Buildpatient;
/

--87258:刘尔旋,2017-03-27,多类别扎帐
Create Or Replace Procedure Zl_收费员轧帐记录_Cancel
(
  Id_In       In 人员收缴记录.Id%Type,
  作废人_In   In 人员收缴记录.作废人%Type,
  作废时间_In In 人员收缴记录.作废时间%Type
) Is
  --------------------------------------------------------------------------------------------
  --功能:收费员轧帐记录作废
  --------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(500);
  Err_Item Exception;

  n_Count      Number(18);
  v_No         人员收缴记录.No%Type;
  n_收款       Number(2);
  d_截止时间   人员收缴记录.终止时间%Type;
  v_收款员     人员收缴记录.收款员%Type;
  n_是否挂号   人员收缴记录.是否挂号%Type := 0;
  n_是否就诊卡 人员收缴记录.是否就诊卡%Type := 0;
  n_是否消费卡 人员收缴记录.是否消费卡%Type := 0;
  n_是否收费   人员收缴记录.是否收费%Type := 0;
  n_预交类别   人员收缴记录.预交类别%Type := 0;
  n_是否结帐   人员收缴记录.是否结帐%Type := 0;
Begin
  --并发检查,是否当前时间范围内已经有轧帐记录
  Begin
    Select NO, 收款员, Decode(小组收款时间, Null, 0, 1) + Decode(财务收款时间, Null, 0, 1), 是否挂号, 是否就诊卡, 是否消费卡, 是否收费, 预交类别, 是否结帐
    Into v_No, v_收款员, n_收款, n_是否挂号, n_是否就诊卡, n_是否消费卡, n_是否收费, n_预交类别, n_是否结帐
    From 人员收缴记录
    Where ID = Id_In;
  Exception
    When Others Then
      v_No := Null;
  End;
  If v_No Is Null Then
    v_Err_Msg := '未找到需要作废的轧帐记录,请检查！';
    Raise Err_Item;
  End If;

  --检查是否最后一次轧帐记录
  If n_是否挂号 = 1 Then
    Select Count(*)
    Into n_Count
    From 人员收缴记录
    Where 登记时间 > (Select 登记时间 From 人员收缴记录 Where ID = Id_In) And 记录性质 = 1 And ID + 0 <> Id_In And Rownum < 2 And
          收款员 || '' = v_收款员 And 作废时间 Is Null And 是否挂号 = 1;
  End If;

  If n_是否就诊卡 = 1 And n_Count = 0 Then
    Select Count(*)
    Into n_Count
    From 人员收缴记录
    Where 登记时间 > (Select 登记时间 From 人员收缴记录 Where ID = Id_In) And 记录性质 = 1 And ID + 0 <> Id_In And Rownum < 2 And
          收款员 || '' = v_收款员 And 作废时间 Is Null And 是否就诊卡 = 1;
  End If;

  If n_是否消费卡 = 1 And n_Count = 0 Then
    Select Count(*)
    Into n_Count
    From 人员收缴记录
    Where 登记时间 > (Select 登记时间 From 人员收缴记录 Where ID = Id_In) And 记录性质 = 1 And ID + 0 <> Id_In And Rownum < 2 And
          收款员 || '' = v_收款员 And 作废时间 Is Null And 是否消费卡 = 1;
  End If;

  If n_是否收费 = 1 And n_Count = 0 Then
    Select Count(*)
    Into n_Count
    From 人员收缴记录
    Where 登记时间 > (Select 登记时间 From 人员收缴记录 Where ID = Id_In) And 记录性质 = 1 And ID + 0 <> Id_In And Rownum < 2 And
          收款员 || '' = v_收款员 And 作废时间 Is Null And 是否收费 = 1;
  End If;

  If n_是否结帐 = 1 And n_Count = 0 Then
    Select Count(*)
    Into n_Count
    From 人员收缴记录
    Where 登记时间 > (Select 登记时间 From 人员收缴记录 Where ID = Id_In) And 记录性质 = 1 And ID + 0 <> Id_In And Rownum < 2 And
          收款员 || '' = v_收款员 And 作废时间 Is Null And 是否结帐 = 1;
  End If;

  If Nvl(n_预交类别, 0) <> 0 And n_Count = 0 Then
    Select Count(*)
    Into n_Count
    From 人员收缴记录
    Where 登记时间 > (Select 登记时间 From 人员收缴记录 Where ID = Id_In) And 记录性质 = 1 And ID + 0 <> Id_In And Rownum < 2 And
          收款员 || '' = v_收款员 And 作废时间 Is Null And 预交类别 = n_预交类别;
  End If;

  If n_Count >= 1 Then
    --是不是最后一次的轧帐记录
    v_Err_Msg := '轧帐单号为:' || v_No || '的轧帐记录不是你最后一次的轧帐记录,不允许作废!';
    Raise Err_Item;
  End If;

  Update 人员收缴记录 Set 作废人 = 作废人_In, 作废时间 = 作废时间_In Where ID = Id_In And 作废时间 Is Null;
  If Sql%NotFound Then
    v_Err_Msg := '轧帐单号为:' || v_No || '的轧帐记录已经被他人作废,不允许再作废操作!';
    Raise Err_Item;
  End If;
  Insert Into 人员收缴对照
    (收缴id, 性质, 记录id)
    Select Id_In, 8, 记录id From 人员收缴对照 Where 收缴id = Id_In And 性质 = 7;
  --恢复最后一次有效的轧帐时间
  Select Max(终止时间)
  Into d_截止时间
  From 人员收缴记录
  Where 登记时间 <= (Select 登记时间 From 人员收缴记录 Where ID = Id_In) And ID + 0 <> Id_In And 作废时间 Is Null And 收款员 || '' = v_收款员;
  If d_截止时间 Is Null Then
    --取上岗领用备用金的时间
    Select Min(登记时间)
    Into d_截止时间
    From 人员暂存记录
    Where 收款员 = v_收款员 And 记录性质 = 1 And 收回时间 Is Null;
  End If;
  Update 人员缴款余额 Set 上次轧帐时间 = d_截止时间 Where 收款员 = v_收款员 And 性质 = 1;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_收费员轧帐记录_Cancel;
/

--87258:刘尔旋,2017-04-05,多类别轧账
Create Or Replace Procedure Zl_收费员轧帐记录_Insert
(
  Id_In         In 人员收缴记录.Id%Type,
  No_In         In 人员收缴记录.No%Type,
  收款员_In     In 人员收缴记录.收款员%Type,
  收款部门id_In In 人员收缴记录.收款部门id%Type,
  组长id_In     In 人员表.Id%Type,
  冲预交款_In   In 人员收缴记录.冲预交款%Type,
  借入合计_In   In 人员收缴记录.借入合计%Type,
  借出合计_In   In 人员收缴记录.借出合计%Type,
  摘要_In       In 人员收缴记录.摘要%Type,
  开始时间_In   In 人员收缴记录.开始时间%Type,
  终止时间_In   In 人员收缴记录.终止时间%Type,
  登记人_In     In 人员收缴记录.登记人%Type,
  登记时间_In   In 人员收缴记录.登记时间%Type,
  收缴标志_In   In 人员收缴记录.收缴标志%Type,
  收费对照_In   In Varchar2,
  操作类别_In   In Integer := 0,
  暂存金_In     In 人员暂存记录.金额%Type := 0,
  类别_In       In Varchar2 := Null
) Is
  --------------------------------------------------------------------------------------------
  --功能:收费员轧帐记录写入
  --参数:记录性质_IN:
  --     收费对照_IN:性质1,记录ID1|性质2,记录ID2|...|性质n,记录IDn
  --     操作类别_In:0-保存轧帐记录和对照;1-只保存对照
  --------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(500);
  Err_Item Exception;

  n_组id       人员收缴记录.缴款组id%Type;
  n_暂存id     人员暂存记录.Id%Type;
  v_暂存单号   人员暂存记录.No%Type;
  v_小组收款人 人员收缴记录.小组收款人%Type;
  v_现金       结算方式.名称%Type;
  n_是否挂号   人员收缴记录.是否挂号%Type := 0;
  n_是否就诊卡 人员收缴记录.是否就诊卡%Type := 0;
  n_是否消费卡 人员收缴记录.是否消费卡%Type := 0;
  n_是否收费   人员收缴记录.是否收费%Type := 0;
  n_预交类别   人员收缴记录.预交类别%Type := 0;
  n_是否结帐   人员收缴记录.是否结帐%Type := 0;

Begin
  --检查是否已存在轧帐明细
  For c_检查 In (Select /*+ rule*/
                a.性质, a.记录id, m.收款员
               From 人员收缴对照 A, Table(f_Str2list2(收费对照_In, '|', ',')) B, 人员收缴记录 M
               Where a.性质 = b.C1 And a.记录id = b.C2 And a.收缴id = m.Id And m.作废时间 Is Null And Rownum < 2) Loop
    --1-收费(含挂号),2-结帐,3-预交,4-借款;5-消费卡充值;6--消费卡面值;7-暂存金(本次增加)；８－收款或轧帐作废对照（本次增加）
    If c_检查.性质 = 1 Then
      Select Decode(记录性质, 1, '收费', 4, '挂号', '') || '单据为:' || NO || '的' || Decode(记录性质, 1, '收费', 4, '挂号', '') ||
              '记录已经被轧帐，不能再进行轧帐处理'
      Into v_Err_Msg
      From 门诊费用记录
      Where 结帐id = c_检查.记录id And Rownum < 2;
    End If;
  
    If c_检查.性质 = 2 Then
      Select '结帐单据为:' || NO || '的结帐记录已经被轧帐，不能再进行轧帐处理'
      Into v_Err_Msg
      From 病人结帐记录
      Where ID = c_检查.记录id And Rownum < 2;
    End If;
    If c_检查.性质 = 3 Then
      Select '预交单据为:' || NO || '的预交记录已经被轧帐，不能再进行轧帐处理'
      Into v_Err_Msg
      From 病人预交记录
      Where ID = c_检查.记录id And Rownum < 2;
    End If;
    If c_检查.性质 = 4 And 收款员_In = c_检查.收款员 Then
      Select '收费员在' || To_Char(借出时间, 'yyyy-mm-dd hh24:mi:ss') || '的' || Decode(借款人, Null, '借出款', '借入款') ||
              '已经被轧帐，不能再进行轧帐处理'
      Into v_Err_Msg
      From 人员借款记录
      Where ID = c_检查.记录id And Rownum < 2;
    End If;
  
    If c_检查.性质 = 5 Then
      Select '收费员在' || To_Char(充值时间, 'yyyy-mm-dd hh24:mi:ss') || '的消费卡充值记录已经被轧帐，不能再进行轧帐处理'
      Into v_Err_Msg
      From 消费卡充值记录
      Where ID = c_检查.记录id And Rownum < 2;
    End If;
    If c_检查.性质 = 6 Then
      Select '收费员在发卡号为:' || 卡号 || '的且发卡时间为:' || To_Char(发卡时间, 'yyyy-mm-dd hh24:mi:ss') || '发卡记录已经被轧帐，不能再进行轧帐处理'
      Into v_Err_Msg
      From 消费卡目录
      Where ID = c_检查.记录id And Rownum < 2;
    End If;
    If c_检查.性质 = 7 Then
      Select '暂存单号为:' || NO || '的暂存记录已经被轧帐，不能再进行轧帐处理'
      Into v_Err_Msg
      From 人员暂存记录
      Where ID = c_检查.记录id And Rownum < 2;
    End If;
    If c_检查.性质 = 9 Then
      Select '单号为:' || NO || '的补充结算记录已经被轧帐，不能再进行轧帐处理'
      Into v_Err_Msg
      From 费用补充记录
      Where 结算id = c_检查.记录id And Rownum < 2;
    End If;
    If v_Err_Msg Is Not Null Then
      Raise Err_Item;
    End If;
  End Loop;

  If 操作类别_In = 0 Then
    n_组id := Zl_Get组id(收款员_In);
    If 组长id_In Is Not Null Then
      Select 姓名 Into v_小组收款人 From 人员表 Where ID = 组长id_In;
    End If;
    Insert Into 人员收缴记录
      (ID, 记录性质, NO, 收款员, 收款部门id, 冲预交款, 借入合计, 借出合计, 摘要, 开始时间, 终止时间, 缴款组id, 登记人, 登记时间, 收缴标志, 小组收款人)
    Values
      (Id_In, 1, No_In, 收款员_In, 收款部门id_In, 冲预交款_In, 借入合计_In, 借出合计_In, 摘要_In, 开始时间_In, 终止时间_In, n_组id, 登记人_In, 登记时间_In,
       收缴标志_In, v_小组收款人);
    If 类别_In Is Not Null Then
      If Instr(',' || 类别_In || ',', ',0,') > 0 Then
        --所有类别
        Update 人员收缴记录
        Set 是否挂号 = 1, 是否就诊卡 = 1, 是否消费卡 = 1, 是否收费 = 1, 预交类别 = 1, 是否结帐 = 1
        Where ID = Id_In;
      Else
        If Instr(',' || 类别_In || ',', ',1,') > 0 Then
          n_是否收费 := 1;
        End If;
        If Instr(',' || 类别_In || ',', ',21,') > 0 And Instr(',' || 类别_In || ',', ',22,') = 0 Then
          n_预交类别 := 2;
        End If;
        If Instr(',' || 类别_In || ',', ',21,') = 0 And Instr(',' || 类别_In || ',', ',22,') > 0 Then
          n_预交类别 := 3;
        End If;
        If Instr(',' || 类别_In || ',', ',2,') > 0 Or
           (Instr(',' || 类别_In || ',', ',21,') > 0 And Instr(',' || 类别_In || ',', ',22,') > 0) Then
          n_预交类别 := 1;
        End If;
        If Instr(',' || 类别_In || ',', ',3,') > 0 Then
          n_是否结帐 := 1;
        End If;
        If Instr(',' || 类别_In || ',', ',4,') > 0 Then
          n_是否挂号 := 1;
        End If;
        If Instr(',' || 类别_In || ',', ',5,') > 0 Then
          n_是否就诊卡 := 1;
        End If;
        If Instr(',' || 类别_In || ',', ',6,') > 0 Then
          n_是否消费卡 := 1;
        End If;
        Update 人员收缴记录
        Set 是否挂号 = n_是否挂号, 是否就诊卡 = n_是否就诊卡, 是否消费卡 = n_是否消费卡, 是否收费 = n_是否收费, 预交类别 = n_预交类别, 是否结帐 = n_是否结帐
        Where ID = Id_In;
      End If;
    End If;
  
    Update 人员缴款余额 Set 上次轧帐时间 = 终止时间_In Where 收款员 = 收款员_In;
  End If;
  --插入收费对照
  Insert Into 人员收缴对照
    (收缴id, 性质, 记录id)
    Select Id_In, C1, C2 From Table(f_Str2list2(收费对照_In, '|', ','));
  If 暂存金_In <> 0 Then
    Begin
      Select 名称 Into v_现金 From 结算方式 Where 性质 = 1 And Rownum < 2;
    Exception
      When Others Then
        v_现金 := '现金';
    End;
    Select 人员暂存记录_Id.Nextval Into n_暂存id From Dual;
    v_暂存单号 := Nextno(141);
    Insert Into 人员暂存记录
      (ID, 收缴id, 记录性质, NO, 结算方式, 金额, 收款员, 登记人, 登记时间)
    Values
      (n_暂存id, Id_In, 2, v_暂存单号, v_现金, -1 * 暂存金_In, 收款员_In, 登记人_In, 登记时间_In);
  
    Insert Into 人员收缴对照 (收缴id, 性质, 记录id) Values (Id_In, 7, n_暂存id);
    Select 人员暂存记录_Id.Nextval Into n_暂存id From Dual;
    v_暂存单号 := Nextno(141);
    Insert Into 人员暂存记录
      (ID, 收缴id, 记录性质, NO, 结算方式, 金额, 收款员, 登记人, 登记时间)
    Values
      (n_暂存id, Id_In, 2, v_暂存单号, v_现金, 暂存金_In, 收款员_In, 登记人_In, 登记时间_In + 1 / 24 / 60 / 60);
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_收费员轧帐记录_Insert;
/

--87258:刘尔旋,2017-04-06,多类别轧账
Create Or Replace Function Zl_Rollingcurtain_Lastdate
(
  收款员_In 人员收缴记录.收款员%Type,
  类别_In   Varchar2
) Return Date Is
  d_规零时间   Date;
  d_终止时间   Date;
  n_包含收费   Number(2) := 0;
  n_包含预交   Number(3) := 0;
  n_包含结帐   Number(2) := 0;
  n_包含挂号   Number(2) := 0;
  n_包含就诊卡 Number(2) := 0;
  n_包含消费卡 Number(2) := 0;
  d_比较时间   Date;
Begin
  --------------------------------------------------------------------------------
  --功能:获取指定用户的最后一次有效的轧帐时间
  --入参:类别_In:0-所有类别(按全额轧帐),1-收费,2-预交,3-结帐,4-挂号,5-就诊卡
  --     收款员_IN:具体的收费人员
  --获取规则:
  --    1.如果当前按指定类别轧帐时,则按下规则处理(以终止时间为准):
  --      1) 如果存在有效的轧帐记录时
  --          a)如果当前轧帐人员不存在所有类别的轧帐记录的,则以选中轧帐类别的最后一次帐的最小时间
  --          b)如果当前轧帐人员存在所有类别的轧帐记录且最后一次轧帐记录的终止时间>选中轧帐类别的最后一次帐的最小时间的,则以所有类别的最后一次轧帐记录的终止时间为准
  --          c)如果当前轧帐人员存在所有类别的轧帐记录且最后一次轧帐记录的终止时间<选中轧帐类别的最后一次帐的最小时间的,则以选中轧帐类别的最后一次帐的最小终止时间为准
  --      2)如果不存在有效轧帐记录时
  --          a)如果当前轧帐人员存在按所有类别轧帐的有效记录时,则以最后一次轧帐记录的终止时间为准
  --          b)如果不存在按所有类别轧帐的有效记录时,按下面的3以下规则处理
  --    2.如果当前按所有类别轧帐时,则按以下规则处理
  --          a)如果存在按所有类别轧帐的有效记录时,则以最后一次轧帐记录的终止时间为准
  --          b)如果不存在按所有类别轧帐的有效记录时,按下面的3以下规则处理
  --    3.如果存在轧帐规零记录,则以轧帐规零记录的登记时间为准
  --    4.未轧过的,缺省为领取备用金时间
  --    5.如果未领用备用金的,返回NULL,由界面处理(缺省时间为当前时间-1个月的且允许更改上次转帐时间)
  --------------------------------------------------------------------------------
  If Instr(',' || 类别_In || ',', ',0,') > 0 Then
    --所有类别
    n_包含收费   := 1;
    n_包含预交   := 1;
    n_包含结帐   := 1;
    n_包含挂号   := 1;
    n_包含就诊卡 := 1;
    n_包含消费卡 := 1;
  Else
    If Instr(',' || 类别_In || ',', ',1,') > 0 Then
      n_包含收费 := 1;
    End If;
    If Instr(',' || 类别_In || ',', ',3,') > 0 Then
      n_包含结帐 := 1;
    End If;
    If Instr(',' || 类别_In || ',', ',4,') > 0 Then
      n_包含挂号 := 1;
    End If;
    If Instr(',' || 类别_In || ',', ',5,') > 0 Then
      n_包含就诊卡 := 1;
    End If;
    If Instr(',' || 类别_In || ',', ',6,') > 0 Then
      n_包含消费卡 := 1;
    End If;
    If Instr(',' || 类别_In || ',', ',21,') > 0 Then
      n_包含预交 := 2;
    End If;
    If Instr(',' || 类别_In || ',', ',22,') > 0 Then
      n_包含预交 := 3;
    End If;
    If (Instr(',' || 类别_In || ',', ',21,') > 0 And Instr(',' || 类别_In || ',', ',22,') > 0) Or
       Instr(',' || 类别_In || ',', ',2,') > 0 Then
      n_包含预交 := 1;
    End If;
  End If;

  If n_包含收费 <> 0 Then
    Select Max(终止时间)
    Into d_终止时间
    From 人员收缴记录 A
    Where 收款员 = 收款员_In And 作废时间 Is Null And 记录性质 = 1 And Nvl(是否收费, 0) = n_包含收费;
  End If;

  If n_包含结帐 <> 0 Then
    Select Max(终止时间)
    Into d_比较时间
    From 人员收缴记录 A
    Where 收款员 = 收款员_In And 作废时间 Is Null And 记录性质 = 1 And Nvl(是否结帐, 0) = n_包含结帐;
    If d_比较时间 < d_终止时间 Or d_终止时间 Is Null Then
      d_终止时间 := d_比较时间;
    End If;
  End If;

  If n_包含挂号 <> 0 Then
    Select Max(终止时间)
    Into d_比较时间
    From 人员收缴记录 A
    Where 收款员 = 收款员_In And 作废时间 Is Null And 记录性质 = 1 And Nvl(是否挂号, 0) = n_包含挂号;
    If d_比较时间 < d_终止时间 Or d_终止时间 Is Null Then
      d_终止时间 := d_比较时间;
    End If;
  End If;

  If n_包含就诊卡 <> 0 Then
    Select Max(终止时间)
    Into d_比较时间
    From 人员收缴记录 A
    Where 收款员 = 收款员_In And 作废时间 Is Null And 记录性质 = 1 And Nvl(是否就诊卡, 0) = n_包含就诊卡;
    If d_比较时间 < d_终止时间 Or d_终止时间 Is Null Then
      d_终止时间 := d_比较时间;
    End If;
  End If;

  If n_包含消费卡 <> 0 Then
    Select Max(终止时间)
    Into d_比较时间
    From 人员收缴记录 A
    Where 收款员 = 收款员_In And 作废时间 Is Null And 记录性质 = 1 And Nvl(是否消费卡, 0) = n_包含消费卡;
    If d_比较时间 < d_终止时间 Or d_终止时间 Is Null Then
      d_终止时间 := d_比较时间;
    End If;
  End If;

  If n_包含预交 <> 0 Then
    Select Max(终止时间)
    Into d_比较时间
    From 人员收缴记录 A
    Where 收款员 = 收款员_In And 作废时间 Is Null And 记录性质 = 1 And Nvl(预交类别, 0) = n_包含预交;
    If d_比较时间 < d_终止时间 Or d_终止时间 Is Null Then
      d_终止时间 := d_比较时间;
    End If;
  End If;

  If d_终止时间 Is Not Null Then
    Return d_终止时间;
  End If;

  Select Max(登记时间)
  Into d_规零时间
  From 人员收缴记录 A
  Where 收款员 = 收款员_In And 作废时间 Is Null And 记录性质 = 6;

  If d_规零时间 Is Not Null Then
    Return d_规零时间;
  End If;

  --取备用金的时间
  Select Min(领用时间)
  Into d_终止时间
  From 人员暂存记录
  Where 收款员 = 收款员_In And (记录性质 = 1 Or 记录性质 = 11) And 收回时间 Is Null;
  If d_终止时间 Is Not Null Then
    Return d_终止时间;
  End If;

  --当前时间减少1个月
  If d_终止时间 Is Not Null Then
    Return d_终止时间;
  End If;

  Return Null;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Rollingcurtain_Lastdate;
/


--106806:张德婷,2017-03-27,修正数据死锁相关问题
Create Or Replace Procedure Zl_药品收发记录_部门发药
(
  Partid_In        In 药品收发记录.库房id%Type,
  Billid_In        In 药品收发记录.Id%Type,
  People_In        In 药品收发记录.审核人%Type,
  Date_In          In 药品收发记录.审核日期%Type,
  批次_In          In 药品收发记录.批次%Type := Null,
  发药方式_In      In 药品收发记录.发药方式%Type := 3,
  领药人_In        In 药品收发记录.领用人%Type := Null,
  汇总发药号_In    In 药品收发记录.汇总发药号%Type := Null,
  操作员编号_In    In 人员表.编号%Type := Null,
  操作员姓名_In    In 人员表.姓名%Type := Null,
  Intdigit_In      In Number := 2,
  Intautoverify_In In Number := 1
) Is
  --只读变量
  Lng入出类别id Number(18);
  Int入出系数   Number;
  Int执行状态   Number;
  Int单据       药品收发记录.单据%Type;
  Strno         药品收发记录.No%Type;
  Lng库房id     药品收发记录.库房id%Type;
  Lng药品id     药品收发记录.药品id%Type;
  Lng费用id     药品收发记录.费用id%Type;
  v_零售价      药品收发记录.零售价%Type;
  Dbl差价率     Number;
  Int未发数     未发药品记录.未发数%Type;
  n_药品id      药品收发记录.药品ID%type;
  --可写变量
  Dbl实际数量 药品收发记录.实际数量%Type;
  Dbl实际金额 药品收发记录.零售金额%Type;
  Dbl成本金额 药品收发记录.成本金额%Type;
  Dbl实际差价 药品收发记录.差价%Type;
  --2002-07-31朱玉宝
  --LNGLAST批次 发药前确定的批次(已减可用数量)
  Str药名           Varchar2(200);
  Dbl可用数量       药品收发记录.填写数量%Type;
  Lnglast批次       药品收发记录.批次%Type;
  Lngcur批次        药品收发记录.批次%Type;
  Bln收费与发药分离 Number(1);
  v_Error           Varchar2(255);
  Err_Custom Exception;

  Str批号          药品收发记录.批号%Type;
  Str效期          药品收发记录.效期%Type;
  n_上次供应商id   药品库存.上次供应商id%Type;
  n_上次采购价     药品库存.上次采购价%Type;
  v_上次产地       药品库存.上次产地%Type;
  d_上次生产日期   药品库存.上次生产日期%Type;
  v_批准文号       药品库存.批准文号%Type;
  n_平均成本价     药品库存.平均成本价%Type;
  n_记录状态       药品收发记录.记录状态%Type;
  n_流通售价小数   Number;
  n_流通金额小数   Number;
  n_零差价管理模式 Number(1);
  n_药品零差价管理 Number(1);
  --自动审核费用
  Int序号   住院费用记录.序号%Type;
  Lng病人id 住院费用记录.病人id%Type;
Begin
  --获取该收发记录的单据、药品ID、库房ID,零售金额及实际数量、入出类别ID
  Begin
    Select a.单据, a.No, a.药品id, a.库房id, a.费用id, Nvl(a.零售价, 0), Nvl(a.零售金额, 0), Nvl(a.实际数量, 0) * Nvl(a.付数, 1), a.入出类别id,
           a.入出系数, Nvl(a.批次, 0), a.药品id, a.批号, a.效期, a.供药单位id, a.产地, a.生产日期, a.批准文号, a.记录状态
    Into Int单据, Strno, Lng药品id, Lng库房id, Lng费用id, v_零售价, Dbl实际金额, Dbl实际数量, Lng入出类别id, Int入出系数, Lnglast批次, n_药品id, Str批号,
         Str效期, n_上次供应商id, v_上次产地, d_上次生产日期, v_批准文号, n_记录状态
    From 药品收发记录 A
    Where a.Id = Billid_In And a.审核日期 Is Null
    For Update Nowait;
    
    select '[' || 编码 || ']' || 名称 into Str药名 from 收费项目目录 where id=n_药品id;
  Exception
    When Others Then
      Int单据 := 0;
      v_Error := '已有其他用户在执行发药，不能重复操作！';
      Raise Err_Custom;
  End;

  --取流通业务精度位数
  --类别:1-药品 2-卫材
  --内容：2-零售价 4-金额
  --单位：药品:1-售价 5-金额单位
  Begin
    Select 精度 Into n_流通金额小数 From 药品卫材精度 Where 类别 = 1 And 内容 = 4 And 单位 = 5;
  Exception
    When Others Then
      n_流通金额小数 := 2;
  End;

  Begin
    Select 精度 Into n_流通售价小数 From 药品卫材精度 Where 类别 = 1 And 内容 = 2 And 单位 = 1;
  Exception
    When Others Then
      n_流通售价小数 := 2;
  End;

  Select Zl_To_Number(Nvl(zl_GetSysParameter(275), '0')) Into n_零差价管理模式 From Dual;

  If Int单据 > 0 Then
    If Nvl(批次_In, 0) = 0 Then
      Lngcur批次 := Lnglast批次;
    Else
      Lngcur批次 := Nvl(批次_In, 0);
    End If;
  
    --检查是否已经填写库房
    Bln收费与发药分离 := 0;
    If Lng库房id Is Null Then
      Bln收费与发药分离 := 1;
    End If;
    Lng库房id := Partid_In;
  
    --取该批药品的批号
    Begin
      Select 上次批号, 效期, Nvl(可用数量, 0), 上次供应商id, 上次产地, 上次生产日期, 批准文号, 上次采购价
      Into Str批号, Str效期, Dbl可用数量, n_上次供应商id, v_上次产地, d_上次生产日期, v_批准文号, n_上次采购价
      From 药品库存
      Where 库房id + 0 = Lng库房id And 药品id = Lng药品id And 性质 = 1 And Nvl(批次, 0) = Lngcur批次;
    Exception
      When Others Then
        Dbl可用数量  := 0;
        n_上次采购价 := 0;
    End;
  
    --可用数量不足则退出
    If Lngcur批次 <> Nvl(Lnglast批次, 0) Then
      If Dbl可用数量 < Dbl实际数量 And Lngcur批次 <> 0 Then
        v_Error := Str药名 || '的可用数量不足，操作中止！';
        Raise Err_Custom;
      End If;
    End If;
  
    If n_零差价管理模式 <> 0 Then
      Select Nvl(是否零差价管理, 0) Into n_药品零差价管理 From 药品规格 Where 药品id = Lng药品id;
    End If;
  
    --计算该药品收发记录的成本价、成本金额、零售金额及差价(先计算零售金额，再计算差价，最后计算成本金额及成本价)
    If n_记录状态 = 1 Then
      --原始发药记录，取最新价格
      n_平均成本价 := Zl_Fun_Getoutcost(Lng药品id, Lngcur批次, Lng库房id);
    
      If n_零差价管理模式 <> 0 And n_药品零差价管理 = 1 And (v_零售价 = n_平均成本价 Or Round(v_零售价, n_流通售价小数) = Round(n_平均成本价, n_流通售价小数)) Then
        Dbl成本金额 := Dbl实际金额;
      Else
        Dbl成本金额 := Round(n_平均成本价 * Nvl(Dbl实际数量, 0), n_流通金额小数);
      End If;
    Else
      --退药再发记录，取原始单据价格
      Select a.成本价
      Into n_平均成本价
      From 药品收发记录 A, 药品收发记录 B
      Where b.Id = Billid_In And a.单据 = b.单据 And a.No = b.No And a.库房id = b.库房id And a.药品id + 0 = b.药品id And
            a.序号 = b.序号 And Nvl(a.批次, 0) = Nvl(b.批次, 0) And (a.记录状态 = 1 Or Mod(a.记录状态, 3) = 0);
    
      Dbl成本金额 := Round(n_平均成本价 * Nvl(Dbl实际数量, 0), n_流通金额小数);
    End If;
    Dbl实际差价 := Round(Dbl实际金额 - Dbl成本金额, n_流通金额小数);
  
    --更新药品收发记录的零售金额、成本金额及差价
    Update 药品收发记录
    Set 库房id = Lng库房id, 成本价 = n_平均成本价, 成本金额 = Dbl成本金额, 差价 = Dbl实际差价, 批次 = Lngcur批次, 批号 = Str批号, 效期 = Str效期,
        审核人 = People_In, 审核日期 = Date_In, 发药方式 = 发药方式_In, 领用人 = 领药人_In, 汇总发药号 = 汇总发药号_In, 供药单位id = n_上次供应商id, 产地 = v_上次产地,
        生产日期 = d_上次生产日期, 批准文号 = v_批准文号
    Where ID = Billid_In;
    --并发操作检查
    If Sql%RowCount = 0 Then
      v_Error := '要发药的药品记录"' || Str药名 || '"不存在，操作中止！';
      Raise Err_Custom;
    End If;
  
    --更改所有已发药处方的配药人为发药人
    Update 药品收发记录
    Set 配药人 = People_In
    Where NO = Strno And 单据 = Int单据 And (库房id + 0 = Lng库房id Or 库房id Is Null) And 审核人 Is Not Null And Mod(记录状态, 3) = 1;
  
    --更新原批次库存的可用数量
    --更新发药批次库存的可用及实际数量
    If Lnglast批次 <> Lngcur批次 Then
      Update 药品库存
      Set 可用数量 = Nvl(可用数量, 0) + Dbl实际数量
      Where 库房id + 0 = Lng库房id And 药品id = Lng药品id And 性质 = 1 And Nvl(批次, 0) = Lnglast批次;
    
      Update 药品库存
      Set 可用数量 = Nvl(可用数量, 0) - Dbl实际数量
      Where 库房id + 0 = Lng库房id And 药品id = Lng药品id And 性质 = 1 And Nvl(批次, 0) = Lngcur批次;
    End If;
  
    If Bln收费与发药分离 = 1 Then
      Update 药品库存
      Set 可用数量 = Nvl(可用数量, 0) - Dbl实际数量, 实际数量 = Nvl(实际数量, 0) - Dbl实际数量, 实际金额 = Nvl(实际金额, 0) - Dbl实际金额,
          实际差价 = Nvl(实际差价, 0) - Dbl实际差价
      Where 库房id + 0 = Lng库房id And 药品id = Lng药品id And 性质 = 1 And Nvl(批次, 0) = Lngcur批次;
    Else
      Update 药品库存
      Set 实际数量 = Nvl(实际数量, 0) - Dbl实际数量, 实际金额 = Nvl(实际金额, 0) - Dbl实际金额, 实际差价 = Nvl(实际差价, 0) - Dbl实际差价
      Where 库房id + 0 = Lng库房id And 药品id = Lng药品id And 性质 = 1 And Nvl(批次, 0) = Lngcur批次;
    End If;
  
    If Sql%RowCount = 0 Then
      If n_上次采购价 = 0 Then
        If Dbl实际数量 = 0 Then
          Dbl实际数量 := 1;
        End If;
        n_上次采购价 := Round(Dbl成本金额 / Dbl实际数量, 5);
      End If;
    
      If Bln收费与发药分离 = 1 Then
        Insert Into 药品库存
          (库房id, 药品id, 批次, 性质, 可用数量, 实际数量, 实际金额, 实际差价, 上次供应商id, 上次采购价, 上次批号, 上次产地, 效期, 上次生产日期, 批准文号, 平均成本价)
        Values
          (Lng库房id, Lng药品id, Lngcur批次, 1, 0 - Dbl实际数量, 0 - Dbl实际数量, 0 - Dbl实际金额, 0 - Dbl实际差价, n_上次供应商id, n_上次采购价, Str批号,
           v_上次产地, Str效期, d_上次生产日期, v_批准文号, n_上次采购价);
      Else
        Insert Into 药品库存
          (库房id, 药品id, 批次, 性质, 实际数量, 实际金额, 实际差价, 上次供应商id, 上次采购价, 上次批号, 上次产地, 效期, 上次生产日期, 批准文号, 平均成本价)
        Values
          (Lng库房id, Lng药品id, Lngcur批次, 1, 0 - Dbl实际数量, 0 - Dbl实际金额, 0 - Dbl实际差价, n_上次供应商id, n_上次采购价, Str批号, v_上次产地,
           Str效期, d_上次生产日期, v_批准文号, n_上次采购价);
      End If;
    End If;
  
    Delete 药品库存
    Where 库房id + 0 = Lng库房id And 药品id = Lng药品id And 性质 = 1 And Nvl(可用数量, 0) = 0 And Nvl(实际数量, 0) = 0 And
          Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
  
    --更新费用记录的执行状态(已执行)
    Select Decode(Sum(Nvl(付数, 1) * 实际数量), Null, 1, 0, 1, 2)
    Into Int执行状态
    From 药品收发记录
    Where 单据 = Int单据 And NO = Strno And 费用id = Lng费用id And 审核人 Is Null And 记录状态 <> 1 And Mod(记录状态, 3) <> 0;
    Update 住院费用记录
    Set 执行状态 = Int执行状态, 执行人 = Decode(People_In, Null, Zl_Username, People_In), 执行时间 = Date_In
    Where ID = Lng费用id;
  
    --更新未发药品记录(如果未发数为零则删除)
    Select Count(*)
    Into Int未发数
    From 药品收发记录
    Where 单据 = Int单据 And (库房id + 0 = Lng库房id Or 库房id Is Null) And NO = Strno And 审核人 Is Null And
          Nvl(LTrim(RTrim(摘要)), '小宝') <> '拒发';
  
    If Int未发数 = 0 Then
      Delete 未发药品记录 Where NO = Strno And 单据 = Int单据 And (库房id + 0 = Lng库房id Or 库房id Is Null);
    End If;
  
    --费用审核（重复审核也没有关系）
    Select 序号, 病人id, NO
    Into Int序号, Lng病人id, Strno
    From 住院费用记录
    Where ID = (Select 费用id From 药品收发记录 Where ID = Billid_In);
  
    Zl_住院记帐记录_Verify(Strno, 操作员编号_In, 操作员姓名_In, Int序号, Lng病人id, Date_In);
  
    --处理调价修正
    Zl_药品收发记录_调价修正(Billid_In);
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_药品收发记录_部门发药;
/

--104606:冉俊明,2017-03-21,门诊号启用了“年月日+顺序号”规则后，缺省不按年月日自动补齐。
Create Or Replace Function Zl1_Clinicno_Full
(
  No_In  In 号码控制表.最大号码%Type,
  Mod_In In 号码控制表.编号规则%Type
) Return Varchar2
--    功能：门诊号处理规则，用户自己定义
  --    参数：
  --        No_In：输入门诊号
  --        Mod_In：系统参数设置的门诊号编号规则
  --    返回：按规则处理后的门诊号
 Is
  v_No 号码控制表.最大号码%Type;
Begin
  --===================================================================
  --说明：在门诊号规则设置为“1-年月日(YYMMDD)+顺序号(0000)”时，
  --      如果需要启用门诊号按年月日自动补齐功能，请屏蔽下面这个语句
  Return No_In;
  --===================================================================

  --门诊号默认按如下规则处理
  If Mod_In = 0 Then
    --0.顺序编号
    v_No := No_In;
  Elsif Mod_In = 1 Then
    --1.年月日 + 顺序号:YYMMDD0000
    If Length(No_In) > 10 Then
      v_No := No_In;
    Elsif Length(No_In) > 8 Then
      v_No := Substr(To_Char(Sysdate, 'YY'), 1, 10 - Length(No_In)) || No_In;
    Elsif Length(No_In) > 6 Then
      v_No := To_Char(Sysdate, 'YY') || LPad(No_In, 8, '0');
    Elsif Length(No_In) > 4 Then
      v_No := To_Char(Sysdate, 'YYMM') || LPad(No_In, 6, '0');
    Else
      v_No := To_Char(Sysdate, 'YYMMDD') || LPad(No_In, 4, '0');
    End If;
  End If;
  Return v_No;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl1_Clinicno_Full;
/

--105593:冉俊明,2017-03-20,医疗付款方式缺省结算方式设置。
Create Or Replace Procedure Zl_结算方式应用_Update
(
  应用场合_In     In 结算方式应用.应用场合%Type,
  结算方式_In     In Varchar2,
  缺省设置_In     Number := 0,
  付款方式缺省_In In Varchar2 := Null
) Is
  -----------------------------------------------------------
  --结算方式_IN 参数的填写方式如下：现金:1;支票:0;...
  --缺省设置_In 是否缺省结算方式设置
  --付款方式_in 缺省设置_In=1时，传入医疗付款方式的缺省结算方式，格式：医疗付款方式1:结算方式1;医疗付款方式2:结算方式2;...
  -----------------------------------------------------------
  v_解析串   Varchar2(4000);
  v_Temp     Varchar2(1000);
  v_结算方式 结算方式.名称%Type;
  n_缺省     结算方式应用.缺省标志%Type;
  v_付款方式 结算方式应用.付款方式%Type;
Begin
  --1.结算方式应用更新
  If Nvl(缺省设置_In, 0) = 0 Then
    --删除已有场合的结算方式
    Delete From 结算方式应用 Where 应用场合 = 应用场合_In And 付款方式 Is Null;
  
    --接着修改应用场合的结算方式
    If 结算方式_In Is Not Null Then
      v_解析串 := 结算方式_In || ';';
    End If;
  
    While v_解析串 Is Not Null Loop
      --得到结算方式
      v_Temp     := Substr(v_解析串, 1, Instr(v_解析串, ';') - 1);
      v_结算方式 := Substr(v_Temp, 1, Instr(v_Temp, ':') - 1);
      --得到是否缺省
      n_缺省 := To_Number(Substr(v_Temp, Instr(v_Temp, ':') + 1));
    
      If v_结算方式 Is Not Null Then
        Insert Into 结算方式应用 (应用场合, 结算方式, 缺省标志) Values (应用场合_In, v_结算方式, n_缺省);
      End If;
    
      v_解析串 := Substr(v_解析串, Instr(v_解析串, ';') + 1);
    End Loop;
  
    --删除缺省结算方式不在该场合下的医疗付款方式缺省结算方式记录
    Delete From 结算方式应用 A
    Where 应用场合 = 应用场合_In And 付款方式 Is Not Null And Not Exists
     (Select 1 From 结算方式应用 Where 结算方式 = a.结算方式 And 应用场合 = a.应用场合 And 付款方式 Is Null);
    Return;
  End If;

  --2.设置医疗付款方式缺省的结算方式
  --删除已有缺省结算方式
  Delete From 结算方式应用 Where 应用场合 = 应用场合_In And 付款方式 Is Not Null;

  If 付款方式缺省_In Is Not Null Then
    v_解析串 := 付款方式缺省_In || ';';
  End If;

  While v_解析串 Is Not Null Loop
    --得到医疗付款方式
    v_Temp     := Substr(v_解析串, 1, Instr(v_解析串, ';') - 1);
    v_付款方式 := Substr(v_Temp, 1, Instr(v_Temp, ':') - 1);
    --得到结算方式
    v_结算方式 := Substr(v_Temp, Instr(v_Temp, ':') + 1);
  
    If v_结算方式 Is Not Null Then
      Insert Into 结算方式应用 (应用场合, 结算方式, 付款方式) Values (应用场合_In, v_结算方式, v_付款方式);
    End If;
  
    v_解析串 := Substr(v_解析串, Instr(v_解析串, ';') + 1);
  End Loop;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_结算方式应用_Update;
/

--105593:冉俊明,2017-03-20,医疗付款方式缺省结算方式设置。
Create Or Replace Procedure Zl_结算方式应用_Default
(
  应用场合_In In 结算方式应用.应用场合%Type,
  结算方式_In In 结算方式应用.结算方式%Type
) Is
  Cursor c_结算场合 Is
    Select 结算方式 From 结算方式应用 Where 应用场合 = 应用场合_In And 付款方式 Is Null For Update Of 缺省标志;

  v_结算方式 结算方式应用.结算方式%Type;
Begin
  Open c_结算场合;

  Loop
    Fetch c_结算场合
      Into v_结算方式;
  
    If c_结算场合%NotFound Then
      Exit;
    End If;
  
    --修改缺省标志
    If v_结算方式 = 结算方式_In Then
      Update 结算方式应用 Set 缺省标志 = 1 Where Current Of c_结算场合;
    Else
      Update 结算方式应用 Set 缺省标志 = 0 Where Current Of c_结算场合;
    End If;
  End Loop;

  Close c_结算场合;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_结算方式应用_Default;
/

--104997:刘尔旋,2017-03-29,三方卡强制退现
Create Or Replace Procedure Zl_住院收费结算_Update
(
  结帐id_In       住院费用记录.结帐id%Type,
  结帐结算_In     Varchar2, --结帐结算_IN-非医保时:结算方式|结算金额|结算号码||.....医保时:结算方式|结算金额|保险类别,保险密码,保险帐号||.....
  冲预交_In       Varchar2, --冲预交_IN= ID|单据号|金额|记录状态||.....
  缴款_In         病人预交记录.缴款%Type := Null,
  找补_In         病人预交记录.找补%Type := Null,
  三方帐户结算_In Varchar2 := Null, --:结算方式|结算金额|卡类别ID|卡号|交易流水号|交易说明||...
  交易说明_In     病人预交记录.交易说明%Type := Null
) As
  --功能:处理结帐时和医保正式结算后,相关结算信息的调整
  --     因为虚拟结帐后,生成的医保结算金额总额及分摊可能会与正式结算时有差异,所以提供了校对功能,
  --   操作员在结算校对时,可以调整非医保结算方式的各种结算金额及方式,重新生成结算串,并且可能产生误差金额.

  --病人信息
  Cursor c_Pati(v_病人id 病人信息.病人id%Type) Is
    Select a.姓名, a.性别, a.年龄, a.住院号, a.门诊号, b.主页id, b.出院病床, b.当前病区id, b.出院科室id, Nvl(b.费别, a.费别) As 费别, c.编码 As 付款方式
    From 病人信息 A, 病案主页 B, 医疗付款方式 C, (Select Max(主页id) As 主页id From 住院费用记录 Where 结帐id = 结帐id_In) D
    Where a.病人id = v_病人id And a.病人id = b.病人id(+) And b.主页id = Nvl(d.主页id, 0) And a.医疗付款方式 = c.名称(+);
  r_Pati c_Pati%RowType;

  --过程变量
  v_结算内容 Varchar2(4000);
  v_当前结算 Varchar2(100);
  v_结算方式 病人预交记录.结算方式%Type;
  n_结算金额 病人预交记录.冲预交%Type;
  v_结算号码 Varchar2(100); --保险结算记录时,存入:保险类别,保险密码,保险帐号

  n_卡类别id   病人预交记录.卡类别id%Type;
  v_卡号       病人预交记录.卡号%Type;
  v_交易流水号 病人预交记录.交易流水号%Type;
  v_交易说明   病人预交记录.交易说明%Type;

  v_No         病人预交记录.No%Type;
  v_病人id     病人预交记录.病人id%Type;
  v_收款时间   病人预交记录.收款时间%Type;
  v_操作员编号 病人预交记录.操作员编号%Type;
  v_操作员姓名 病人预交记录.操作员姓名%Type;
  v_误差结算   病人预交记录.结算方式%Type;

  v_预交id   病人预交记录.Id%Type;
  v_记录状态 病人预交记录.记录状态%Type;

  v_保险类别 病人预交记录.缴款单位%Type;
  v_保险帐号 病人预交记录.单位开户行%Type;
  v_保险密码 病人预交记录.单位帐号%Type;
  v_付款方式 门诊费用记录.付款方式%Type;
  n_性质     结算方式.性质%Type;
  n_返回值   病人余额.预交余额%Type;
  n_Dele     Number; --0-不删除,1-删除
  v_Error    Varchar2(255);
  Err_Custom Exception;
  n_门诊标志   Number; --1.门诊,2-住院,3-门诊和住院
  n_组id       财务缴款分组.Id%Type;
  n_类别       Number;
  n_门诊冲预交 病人预交记录.冲预交%Type;
  n_住院冲预交 病人预交记录.冲预交%Type;

Begin

  --1.取预交记录中的需要的相关信息
  Select NO, 病人id, 收费时间, 操作员编号, 操作员姓名, 缴款组id
  Into v_No, v_病人id, v_收款时间, v_操作员编号, v_操作员姓名, n_组id
  From 病人结帐记录
  Where ID = 结帐id_In;

  Open c_Pati(v_病人id);
  Fetch c_Pati
    Into r_Pati;

  --误差相关信息
  Begin
    Select 名称 Into v_误差结算 From 结算方式 Where 性质 = 9;
  Exception
    When Others Then
      Begin
        v_Error := '不能正确读取收费误差项的信息，请先检查该项目是否设置正确。';
        Raise Err_Custom;
      End;
  End;

  --2.删除旧的记录,回退汇总数据
  --回退人员缴款余额,病人余额,
  For c_Del In (Select 结算方式, 操作员姓名, 冲预交 From 病人预交记录 Where 结帐id = 结帐id_In And 记录性质 = 2) Loop
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) - Nvl(c_Del.冲预交, 0)
    Where 结算方式 = c_Del.结算方式 And 收款员 = v_操作员姓名 And 性质 = 1;
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额
        (收款员, 结算方式, 性质, 余额)
      Values
        (v_操作员姓名, c_Del.结算方式, 1, -1 * c_Del.冲预交);
    End If;
  End Loop;

  If v_病人id > 0 Then
    For v_预交 In (Select 预交类别, Sum(Nvl(冲预交, 0)) As 预交金额
                 From 病人预交记录
                 Where 结帐id = 结帐id_In And 记录性质 In (1, 11)
                 Group By 预交类别
                 Having Sum(Nvl(冲预交, 0)) <> 0) Loop
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + Nvl(v_预交.预交金额, 0)
      Where 病人id = v_病人id And 类型 = Nvl(v_预交.预交类别, 2) And 性质 = 1;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 类型, 预交余额, 性质)
        Values
          (v_病人id, Nvl(v_预交.预交类别, 2), Nvl(v_预交.预交金额, 0), 1);
      End If;
    End Loop;
  End If;

  --取门诊标志
  Select Case
           When 门诊标志 = 1 And 住院标志 = 1 Then
            3
           When 门诊标志 = 1 Then
            1
           Else
            2
         End, 付款方式
  Into n_门诊标志, v_付款方式
  From (Select Nvl(Max(门诊标志), 0) As 门诊标志, Nvl(Max(住院标志), 0) As 住院标志, Max(付款方式) As 付款方式
         From (Select 1 As 门诊标志, 0 As 住院标志, 付款方式
                From 门诊费用记录
                Where 结帐id = 结帐id_In And Rownum = 1
                Union All
                Select 0 As 门诊标志, 1 As 住院标志, '' As 付款方式
                From 住院费用记录
                Where 结帐id = 结帐id_In And Rownum = 1));

  --回退汇总表.         病人未结费用(因为新误差将立即结帐,所以不处理)
  --只可能产生误差金额的变化. 旧误差只可能存在一行,仅为了变量处理方便而用游标

  --删除结帐缴款,保险结算记录
  Delete 三方结算交易 Where 交易id In (Select ID From 病人预交记录 Where 结帐id = 结帐id_In And 记录性质 = 2);

  Delete 病人预交记录 Where 结帐id = 结帐id_In And 记录性质 = 2;

  --第一次冲预交的,清空冲减额
  Update 病人预交记录 Set 冲预交 = Null, 结帐id = Null, 结算性质 = Null Where 结帐id = 结帐id_In And 记录性质 = 1;
  --删除冲余款
  Delete 病人预交记录 Where 结帐id = 结帐id_In And 记录性质 = 11;

  --删除误差记录
  If n_门诊标志 = 1 Then
    Delete 门诊费用记录 Where 结帐id = 结帐id_In And 附加标志 = 9;
  Else
    Delete 住院费用记录 Where 结帐id = 结帐id_In And 附加标志 = 9;
  End If;

  --4.重新生成病人预交记录相关数据
  --4.1.补款结算,保险结算
  If 结帐结算_In Is Not Null Then
    v_结算内容 := 结帐结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_结算号码 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
      If Instr(v_结算号码, ',') > 0 Then
        --医保结算:保险类别,保险密码,保险帐号
        v_结算号码 := v_结算号码 || ',';
        v_保险类别 := Substr(v_结算号码, 1, Instr(v_结算号码, ',') - 1);
        v_结算号码 := Substr(v_结算号码, Instr(v_结算号码, ',') + 1);
        v_保险密码 := Substr(v_结算号码, 1, Instr(v_结算号码, ',') - 1);
        v_结算号码 := Substr(v_结算号码, Instr(v_结算号码, ',') + 1);
        v_保险帐号 := Substr(v_结算号码, 1, Instr(v_结算号码, ',') - 1);
        v_结算号码 := Null;
      Else
        v_保险类别 := Null;
        v_保险密码 := Null;
        v_保险帐号 := Null;
      End If;
    
      If Nvl(n_结算金额, 0) <> 0 Then
        Select Nvl(Max(性质), 0) Into n_性质 From 结算方式 Where 名称 = v_结算方式;
        If n_性质 = 1 Then
          v_交易说明 := 交易说明_In;
        Else
          v_交易说明 := Null;
        End If;
      
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员编号, 操作员姓名, 冲预交,
           结帐id, 缴款, 找补, 缴款组id, 结算性质, 交易说明)
        Values
          (病人预交记录_Id.Nextval, v_No, Null, 2, 1, v_病人id, r_Pati.主页id, r_Pati.出院科室id, Null, v_结算方式, v_结算号码, '结帐缴款',
           v_保险类别, v_保险密码, v_保险帐号, v_收款时间, v_操作员编号, v_操作员姓名, n_结算金额, 结帐id_In,
           Decode(v_结算内容, 结帐结算_In || '||', 缴款_In, Null), Decode(v_结算内容, 结帐结算_In || '||', 找补_In, Null), n_组id, 2, v_交易说明);
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If 三方帐户结算_In Is Not Null Then
    --结算方式|结算金额|卡类别ID|卡号|交易流水号|交易说明||...
    v_结算内容 := 三方帐户结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
    
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    
      n_卡类别id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    
      v_卡号     := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    
      v_交易流水号 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算   := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_交易说明   := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      If Nvl(n_结算金额, 0) <> 0 Then
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员编号, 操作员姓名, 冲预交,
           结帐id, 缴款, 找补, 缴款组id, 结算性质, 卡类别id, 卡号, 交易流水号, 交易说明)
        Values
          (病人预交记录_Id.Nextval, v_No, Null, 2, 1, v_病人id, r_Pati.主页id, r_Pati.出院科室id, Null, v_结算方式, v_结算号码, '结帐缴款', Null,
           Null, Null, v_收款时间, v_操作员编号, v_操作员姓名, n_结算金额, 结帐id_In, Null, Null, n_组id, 2, n_卡类别id, v_卡号, v_交易流水号, v_交易说明);
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --4.2.预交结算
  If 冲预交_In Is Not Null Then
    v_结算内容   := 冲预交_In || '||';
    n_门诊冲预交 := 0;
    n_住院冲预交 := 0;
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_预交id   := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1)); --是记录冲预交的ID
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算号码 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1); --是记录冲预交的NO号
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_记录状态 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      If v_预交id <> 0 Then
        --第一次冲预交(将第一次标上结帐ID,冲预交标记为0)
        Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 2 Where ID = v_预交id;
      End If;
      --冲上次剩余额
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
         结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, v_记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
               v_收款时间, v_操作员姓名, v_操作员编号, n_结算金额, 结帐id_In, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 2
        From 病人预交记录
        Where NO = v_结算号码 And 记录性质 In (1, 11) And 记录状态 = v_记录状态 And Rownum = 1;
    
      Begin
        Select Nvl(预交类别, 2)
        Into n_类别
        From 病人预交记录
        Where NO = v_结算号码 And 记录性质 In (1, 11) And 记录状态 = v_记录状态 And Rownum = 1;
      Exception
        When Others Then
          n_类别 := 2;
      End;
      If Nvl(n_类别, 0) = 1 Then
        n_门诊冲预交 := n_门诊冲预交 + Nvl(n_结算金额, 0);
      Else
        n_住院冲预交 := n_住院冲预交 + Nvl(n_结算金额, 0);
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  
    --更新病人余额
    If n_门诊冲预交 <> 0 Then
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_门诊冲预交
      Where 病人id = v_病人id And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (v_病人id, 1, -1 * n_门诊冲预交, 1);
        n_返回值 := -1 * n_门诊冲预交;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额 Where 病人id = v_病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    End If;
    If n_住院冲预交 <> 0 Then
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_住院冲预交
      Where 病人id = v_病人id And 性质 = 1 And 类型 = 2
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (v_病人id, 2, -1 * n_住院冲预交, 1);
        n_返回值 := -1 * n_住院冲预交;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额 Where 病人id = v_病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    End If;
  
  End If;

  --5.相关汇总表的处理
  --汇总人员缴款余额
  --缴款结算,保险结算
  n_Dele := 0;
  For c_结帐 In (Select 结算方式, 冲预交 From 病人预交记录 Where 结帐id = 结帐id_In And 记录性质 = 2) Loop
  
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + Nvl(c_结帐.冲预交, 0)
    Where 收款员 = v_操作员姓名 And 性质 = 1 And 结算方式 = c_结帐.结算方式
    Returning 余额 Into n_返回值;
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额
        (收款员, 结算方式, 性质, 余额)
      Values
        (v_操作员姓名, c_结帐.结算方式, 1, Nvl(c_结帐.冲预交, 0));
      n_返回值 := Nvl(Nvl(c_结帐.冲预交, 0), 0);
    End If;
  
    If Nvl(n_返回值, 0) = 0 Then
      n_Dele := 1;
    End If;
  
  End Loop;

  If n_Dele = 1 Then
    Delete From 人员缴款余额 Where 性质 = 1 And 收款员 = v_操作员姓名 And Nvl(余额, 0) = 0;
  End If;
  --汇总表,只需重汇误差行,因为其它项不会变,未结费用不变(新产生的误差项已结帐),只有一行误差记录,仅为使用变量方便而用游标

  --6.医保相关表的处理
  --Delete 医保核对表 Where 结帐Id=结帐Id_IN;
  Update 保险结算明细 Set 标志 = 2 Where 结帐id = 结帐id_In;

  Close c_Pati;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_住院收费结算_Update;
/

--106960:胡俊勇,2017-03-17,三方LIS报告
Create Or Replace Procedure Zl_报告查阅记录_Insert
(
  医嘱id_In 报告查阅记录.医嘱id%Type,
  病历id_In 报告查阅记录.病历id%Type,
  报告id_In 报告查阅记录.医嘱id%Type := Null
  --功能：当前人员查阅报告时填写记录 
) Is
  v_Temp     Varchar2(255);
  v_人员姓名 报告查阅记录.查阅人%Type;
Begin
  If Nvl(报告id_In, 0) <> 0 Then
    Update 病人医嘱报告 Set 查阅状态 = 1 Where 医嘱id = 医嘱id_In And 报告id = 报告id_In;
  Else
    --当前操作人员 
    v_Temp     := Zl_Identity;
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
    v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  
    Update 病人医嘱报告 Set 查阅状态 = 1 Where 医嘱id = 医嘱id_In And 病历id = 病历id_In;
  
    Update 报告查阅记录
    Set 查阅时间 = Sysdate, 查阅次数 = Nvl(查阅次数, 0) + 1, 取消时间 = Null
    Where 医嘱id = 医嘱id_In And 病历id = 病历id_In And 查阅人 = v_人员姓名;
  
    If Sql%RowCount = 0 Then
      Insert Into 报告查阅记录
        (医嘱id, 病历id, 查阅人, 查阅时间, 查阅次数)
      Values
        (医嘱id_In, 病历id_In, v_人员姓名, Sysdate, 1);
    End If;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_报告查阅记录_Insert;
/

--105433:刘尔旋,2017-03-16,挂号三方卡强制退现
Create Or Replace Procedure Zl_病人挂号记录_出诊_Delete
(
  单据号_In       门诊费用记录.No%Type,
  操作员编号_In   门诊费用记录.操作员编号%Type,
  操作员姓名_In   门诊费用记录.操作员姓名%Type,
  摘要_In         门诊费用记录.摘要%Type := Null, --预约取消时 填写 存放预约取消原因
  删除门诊号_In   Number := 0,
  非原样退结算_In Varchar2 := Null,
  退费类型_In     In Number := 0, --0-全退 1-退挂号费 2-退病历费
  退指定结算_In   病人预交记录.结算方式%Type := Null,
  退号重用_In     Number := 1,
  结算方式_In     Varchar2 := Null,
  退预交_In       病人预交记录.冲预交%Type := Null,
  收回票据号_In   Varchar2 := Null,
  交易说明_In     病人预交记录.交易说明%Type := Null
) As
  --退费类型_In,在一下几种情况下不准进行部分退费
  --    2.三方接口,暂时不支持
  -- 挂号费病历费分开退,规则
  --    普通结算方式:原结算方式退部分费用
  --    预交款:预交款,退部分
  --    预交款与普通结算方式混合:退款按照普通结算方式部分退
  --    消费卡:原样将费用部分退入消费卡
  --非原样退结算_In:指不能退还给原样结算方式(如医保的个人账户,三方账户的退现等),多个用逗分离
  --退指定结算_IN:指非原样退结算部分,应该退给哪种结算方式,为空时缺省退给现金,否则退给指定的结算方式

  --该游标用于判断是否单独收病历费,及挂号汇总表处理
  Cursor c_Registinfo(v_状态 门诊费用记录.记录状态%Type) Is
    Select a.发生时间, a.登记时间, c.接收时间, a.收费细目id As 项目id, c.执行部门id As 科室id, c.执行人 As 医生姓名, d.Id As 医生id, c.号别 As 号码
    From 门诊费用记录 A, 病人挂号记录 C, 人员表 D
    Where a.记录性质 = 4 And a.No = 单据号_In And a.No = c.No And a.记录状态 = v_状态 And c.执行人 = d.姓名(+) And Rownum < 2;
  r_Registrow c_Registinfo%RowType;

  --该游标用于判断记录是否存在,及费用汇总表处理
  Cursor c_Moneyinfo(v_状态 门诊费用记录.记录状态%Type) Is
    Select 病人科室id, 开单部门id, 执行部门id, 收入项目id, Nvl(Sum(应收金额), 0) As 应收, Nvl(Sum(实收金额), 0) As 实收, Nvl(Sum(结帐金额), 0) As 结帐
    From 门诊费用记录
    Where 记录性质 = 4 And 记录状态 = v_状态 And NO = 单据号_In
    Group By 病人科室id, 开单部门id, 执行部门id, 收入项目id;
  r_Moneyrow c_Moneyinfo%RowType;

  --该光标用于处理人员缴款余额中退的不同结算方式的金额
  Cursor c_Opermoney(n_Id 病人预交记录.结帐id%Type) Is
    Select Distinct b.结算方式, -1 * Nvl(b.冲预交, 0) As 冲预交
    From 病人预交记录 B
    Where b.结帐id = n_Id And b.记录性质 = 4 And b.记录状态 = 2 And Nvl(b.冲预交, 0) <> 0;

  v_Err_Msg Varchar(255);
  Err_Item Exception;

  n_结帐id 病人预交记录.结帐id%Type;
  n_销帐id 门诊费用记录.结帐id%Type;

  v_退指定结算方式 病人预交记录.结算方式%Type;
  n_退款金额       病人预交记录.冲预交%Type;
  n_打印id         票据打印内容.Id%Type;
  n_病人id         病人信息.病人id%Type;
  n_退费金额       病人预交记录.冲预交%Type;
  n_预交金额       病人预交记录.冲预交%Type; --原记录 预交缴款金额
  n_返回值         病人余额.预交余额%Type;
  n_挂号id         病人挂号记录.Id%Type;
  n_组id           财务缴款分组.Id%Type;

  n_二次退费       Number; --记录是否是此单据的第二次退费
  n_分诊台签到排队 Number;
  n_预约生成队列   Number;
  n_预约挂号       Number;
  n_挂号生成队列   Number;
  d_Date           Date;
  n_记帐           门诊费用记录.记帐费用%Type;
  n_病人id1        病人信息.病人id%Type;
  n_返回额         门诊费用记录.实收金额%Type;
  n_已结帐         Number;
  n_序号           病人挂号记录.号序%Type;
  n_就诊病人id     病人信息.病人id%Type;
  d_就诊时间       就诊登记记录.就诊时间%Type;
  n_出诊记录id     临床出诊记录.Id%Type;
  v_结算内容       Varchar2(5000);
  v_当前结算       Varchar2(1000);
  v_附加ids        Varchar2(500);
  v_Temp           Varchar2(500);
  v_结算方式       病人预交记录.结算方式%Type;
  n_三方卡标志     Number;
  n_结算金额       病人预交记录.冲预交%Type;
  n_检查数         Number;
Begin
  n_组id           := Zl_Get组id(操作员姓名_In);
  v_退指定结算方式 := 退指定结算_In;

  Select 出诊记录id, 号序 Into n_出诊记录id, n_序号 From 病人挂号记录 Where NO = 单据号_In And Rownum < 2;

  --首先判断要退号/取消预约的记录是否存在
  Open c_Moneyinfo(1);
  Fetch c_Moneyinfo
    Into r_Moneyrow;
  If c_Moneyinfo%RowCount = 0 Then
    Close c_Moneyinfo;
    Open c_Moneyinfo(0);
    Fetch c_Moneyinfo
      Into r_Moneyrow;
    If c_Moneyinfo%RowCount = 0 Then
      v_Err_Msg := '要处理的单据不存在。';
      Raise Err_Item;
    End If;
    n_预约挂号 := 1;
  End If;
  Close c_Moneyinfo;

  Begin
    Select Zl_Fun_Regcustomname Into v_Temp From Dual;
    If v_Temp Is Not Null Then
      v_附加ids := Substr(v_Temp, Instr(v_Temp, '|') + 1);
    End If;
  Exception
    When Others Then
      v_附加ids := Null;
  End;

  --1.预约处理
  If Nvl(n_预约挂号, 0) = 1 Then
    --减少已约数
    Open c_Registinfo(0);
    Fetch c_Registinfo
      Into r_Registrow;
  
    n_检查数 := Null;
    Update 临床出诊记录 Set 已约数 = Nvl(已约数, 0) - 1 Where ID = n_出诊记录id Returning 已约数 Into n_检查数;
    If Nvl(n_检查数, 0) < 0 Then
      Update 临床出诊记录 Set 已约数 = 0 Where ID = n_出诊记录id;
    End If;
  
    Update 病人挂号汇总
    Set 已约数 = Nvl(已约数, 0) - 1
    Where 日期 = Trunc(r_Registrow.发生时间) And Nvl(医生id, 0) = Nvl(r_Registrow.医生id, 0) And
          Nvl(医生姓名, '-') = Nvl(r_Registrow.医生姓名, '-') And 科室id = r_Registrow.科室id And 项目id = r_Registrow.项目id And
          (号码 = r_Registrow.号码 Or 号码 Is Null);
  
    If Sql%RowCount = 0 Then
      Insert Into 病人挂号汇总
        (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已约数)
      Values
        (Trunc(r_Registrow.发生时间), r_Registrow.科室id, r_Registrow.项目id, r_Registrow.医生姓名,
         Decode(r_Registrow.医生id, 0, Null, r_Registrow.医生id), r_Registrow.号码, -1);
    End If;
  
    Close c_Registinfo;
  
    --更新挂号序号状态
    Update 临床出诊序号控制
    Set 挂号状态 = 0, 操作员姓名 = Null
    Where 挂号状态 = 2 And 记录id = n_出诊记录id And 序号 = n_序号;
  
    Update 临床出诊序号控制
    Set 挂号状态 = 4, 操作员姓名 = Null
    Where 挂号状态 = 2 And 记录id = n_出诊记录id And 备注 = To_Char(n_序号);
  
    --添加病人挂号记录的 冲销记录
    Select 病人挂号记录_Id.Nextval, Sysdate Into n_挂号id, d_Date From Dual;
  
    Update 病人挂号记录 Set 记录状态 = 3 Where NO = 单据号_In And 记录状态 = 1 And 记录性质 = 2;
    If Sql%NotFound Then
      v_Err_Msg := '预约单【' || 单据号_In || '】不存在或由于并发原因已经被取消预约';
      Raise Err_Item;
    End If;
  
    Insert Into 病人挂号记录
      (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 操作员编号, 操作员姓名,
       复诊, 号序, 社区, 预约, 摘要, 预约方式, 接收人, 接收时间, 交易流水号, 交易说明, 合作单位, 医疗付款方式, 出诊记录id, 预约操作员, 预约操作员编号)
      Select n_挂号id, NO, 记录性质, 2, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, d_Date, 发生时间,
             操作员编号_In, 操作员姓名_In, 复诊, 号序, 社区, 预约, Nvl(摘要_In, 摘要) As 摘要, 预约方式, 接收人, 接收时间, 交易流水号, 交易说明, 合作单位, 医疗付款方式,
             n_出诊记录id, 预约操作员, 预约操作员编号
      From 病人挂号记录
      Where NO = 单据号_In;
  
    Update 门诊费用记录 Set 记录状态 = 3 Where NO = 单据号_In And 记录性质 = 4 And 记录状态 = 0;
    Insert Into 门诊费用记录
      (ID, 记录性质, NO, 实际票号, 记录状态, 序号, 从属父号, 价格父号, 记帐单id, 病人id, 医嘱序号, 门诊标志, 记帐费用, 姓名, 性别, 年龄, 标识号, 付款方式, 病人科室id, 费别, 收费类别,
       收费细目id, 计算单位, 付数, 发药窗口, 数次, 加班标志, 附加标志, 婴儿费, 收入项目id, 收据费目, 标准单价, 应收金额, 实收金额, 划价人, 开单部门id, 开单人, 发生时间, 登记时间, 执行部门id,
       执行人, 执行状态, 执行时间, 结论, 操作员编号, 操作员姓名, 结帐id, 结帐金额, 保险大类id, 保险项目否, 保险编码, 费用类型, 统筹金额, 是否上传, 摘要, 是否急诊, 缴款组id, 费用状态, 待转出,
       挂号id, 主页id)
      Select 病人费用记录_Id.Nextval, 记录性质, NO, 实际票号, 2, 序号, 从属父号, 价格父号, 记帐单id, 病人id, 医嘱序号, 门诊标志, 记帐费用, 姓名, 性别, 年龄, 标识号, 付款方式,
             病人科室id, 费别, 收费类别, 收费细目id, 计算单位, 付数, 发药窗口, -1 * 数次, 加班标志, 附加标志, 婴儿费, 收入项目id, 收据费目, 标准单价, -1 * 应收金额,
             -1 * 实收金额, 划价人, 开单部门id, 开单人, 发生时间, d_Date, 执行部门id, 执行人, -1, 执行时间, 结论, 操作员编号_In, 操作员姓名_In, Null, Null,
             保险大类id, 保险项目否, 保险编码, 费用类型, 统筹金额, 是否上传, 摘要, 是否急诊, 缴款组id, 费用状态, 待转出, 挂号id, 主页id
      From 门诊费用记录
      Where NO = 单据号_In And 记录性质 = 4 And 记录状态 = 3;
  
    --如果预约生成队列时需要清除队列
  
    n_预约生成队列 := Zl_To_Number(zl_GetSysParameter('预约生成队列', 1113));
    If Nvl(n_预约生成队列, 0) = 1 Then
      --要删除队列
      For v_挂号 In (Select ID, 诊室, 执行部门id, 执行人 From 病人挂号记录 Where NO = 单据号_In) Loop
        Zl_排队叫号队列_Delete(v_挂号.执行部门id, v_挂号.Id);
      End Loop;
    End If;
    Return;
  End If;

  Select Nvl(记帐费用, 0), 病人id, Decode(Sign(Nvl(结帐id, 0)), 0, 0, 1)
  Into n_记帐, n_病人id, n_已结帐
  From 门诊费用记录
  Where 记录性质 = 4 And NO = 单据号_In And 记录状态 In (1, 3) And Rownum < 2;

  --2.挂号处理
  n_已结帐 := Nvl(n_已结帐, 0);

  If n_已结帐 = 1 And n_记帐 = 1 Then
    Select Sysdate, Null Into d_Date, n_销帐id From Dual;
  Else
    Select Sysdate, 病人结帐记录_Id.Nextval Into d_Date, n_销帐id From Dual;
  End If;

  ----0-全退 1-退挂号费 2-退病历费
  If Nvl(退费类型_In, 0) <> 2 Then
    --不是光退病历费时处理
    --更新挂号序号状态
    If 退号重用_In = 1 Then
      Update 临床出诊序号控制
      Set 挂号状态 = 0, 操作员姓名 = Null
      Where 挂号状态 = 1 And 记录id = n_出诊记录id And 序号 = n_序号;
    
      Update 临床出诊序号控制
      Set 挂号状态 = 4, 操作员姓名 = Null
      Where 挂号状态 = 1 And 记录id = n_出诊记录id And 备注 = To_Char(n_序号);
    Else
      Update 临床出诊序号控制
      Set 挂号状态 = 4, 操作员姓名 = 操作员姓名_In
      Where 挂号状态 = 1 And 记录id = n_出诊记录id And (序号 = n_序号 Or 备注 = To_Char(n_序号));
    End If;
  
    --病人就诊状态
    If n_病人id Is Not Null Then
      Update 病人信息 Set 就诊状态 = 0, 就诊诊室 = Null Where 病人id = n_病人id;
    
      --删除门诊号相关处理,只有当只有一条挂号记录并且病人建档日期与挂号日期近似时才会处理
      If 删除门诊号_In = 1 Then
        Delete 门诊病案记录 Where 病人id = n_病人id;
        Update 病人信息 Set 门诊号 = Null Where 病人id = n_病人id;
        --费用记录包括挂号及病案、就诊卡费用,以及病人交费后退费或销帐的费用,挂号记录在最后处理
        Update 门诊费用记录 Set 标识号 = Null Where 门诊标志 = 1 And 病人id = n_病人id;
      End If;
    End If;
  
    --如果挂时收了就诊卡费,退费时清除就诊卡号,在非光退病历费时
    n_病人id1 := Null;
    Begin
      Select 病人id
      Into n_病人id1
      From 门诊费用记录
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And 附加标志 = 2 And Rownum < 2;
    Exception
      When Others Then
        Null;
    End;
  
    If n_病人id1 Is Not Null And Nvl(退费类型_In, 0) <> 2 Then
      Update 病人信息
      Set 就诊卡号 = Null, 卡验证码 = Null, Ic卡号 = Decode(Ic卡号, 就诊卡号, Null, Ic卡号)
      Where 病人id = n_病人id1;
    End If;
  
  End If;

  --检查前面是否已经部分退过费用
  Begin
    Select 1 Into n_二次退费 From 门诊费用记录 Where 记录性质 = 4 And NO = 单据号_In And 记录状态 = 3 And Rownum < 2;
  Exception
    When Others Then
      n_二次退费 := 0;
  End;

  --门诊费用记录
  --冲销记录
  If Nvl(退费类型_In, 0) = 0 Or Nvl(退费类型_In, 0) = 2 Then
    --全退,退病历费
    --门诊费用记录，冲销记录
    Insert Into 门诊费用记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别, 收费细目id, 计算单位, 付数,
       数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 执行人, 操作员编号, 操作员姓名, 发生时间, 登记时间,
       结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 缴款组id)
      Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别,
             收费细目id, 计算单位, 付数, -数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, -应收金额, -实收金额, 开单部门id, 开单人, 执行部门id, 执行人,
             操作员编号_In, 操作员姓名_In, 发生时间, d_Date, n_销帐id,
             Decode(n_记帐, 1, Decode(Nvl(n_已结帐, 0), 0, -1 * 实收金额, Null), -1 * 结帐金额), 保险项目否, 保险大类id, -1 * 统筹金额,
             Nvl(摘要_In, 摘要) As 摘要, Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, n_组id
      From 门诊费用记录
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
  
    --原始记录
    If n_记帐 = 1 And Nvl(n_已结帐, 0) = 0 Then
      Update 门诊费用记录
      Set 记录状态 = 3, 结帐id = n_销帐id, 结帐金额 = 实收金额
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    Else
      Update 门诊费用记录
      Set 记录状态 = 3
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    End If;
  Elsif Nvl(退费类型_In, 0) = 1 Or Nvl(退费类型_In, 0) = 4 Then
    --退挂号费,退挂号与病历费
    --门诊费用记录，冲销记录
    Insert Into 门诊费用记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别, 收费细目id, 计算单位, 付数,
       数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 执行人, 操作员编号, 操作员姓名, 发生时间, 登记时间,
       结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 缴款组id)
      Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别,
             收费细目id, 计算单位, 付数, -数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, -应收金额, -实收金额, 开单部门id, 开单人, 执行部门id, 执行人,
             操作员编号_In, 操作员姓名_In, 发生时间, d_Date, n_销帐id,
             Decode(n_记帐, 1, Decode(Nvl(n_已结帐, 0), 0, -1 * 实收金额, Null), -1 * 结帐金额), 保险项目否, 保险大类id, -1 * 统筹金额,
             Nvl(摘要_In, 摘要) As 摘要, Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, n_组id
      From 门诊费用记录
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') = 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
  
    --原始记录
    If n_记帐 = 1 And Nvl(n_已结帐, 0) = 0 Then
      Update 门诊费用记录
      Set 记录状态 = 3, 结帐id = n_销帐id, 结帐金额 = 实收金额
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') = 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    Else
      Update 门诊费用记录
      Set 记录状态 = 3
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') = 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    End If;
  Elsif Nvl(退费类型_In, 0) = 3 Then
    --退附加费
    --门诊费用记录，冲销记录
    Insert Into 门诊费用记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别, 收费细目id, 计算单位, 付数,
       数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 执行人, 操作员编号, 操作员姓名, 发生时间, 登记时间,
       结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 缴款组id)
      Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别,
             收费细目id, 计算单位, 付数, -数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, -应收金额, -实收金额, 开单部门id, 开单人, 执行部门id, 执行人,
             操作员编号_In, 操作员姓名_In, 发生时间, d_Date, n_销帐id,
             Decode(n_记帐, 1, Decode(Nvl(n_已结帐, 0), 0, -1 * 实收金额, Null), -1 * 结帐金额), 保险项目否, 保险大类id, -1 * 统筹金额,
             Nvl(摘要_In, 摘要) As 摘要, Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, n_组id
      From 门诊费用记录
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') > 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
  
    --原始记录
    If n_记帐 = 1 And Nvl(n_已结帐, 0) = 0 Then
      Update 门诊费用记录
      Set 记录状态 = 3, 结帐id = n_销帐id, 结帐金额 = 实收金额
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') > 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    Else
      Update 门诊费用记录
      Set 记录状态 = 3
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') > 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    End If;
  Elsif Nvl(退费类型_In, 0) = 5 Then
    --退挂号与附加费
    --门诊费用记录，冲销记录
    Insert Into 门诊费用记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别, 收费细目id, 计算单位, 付数,
       数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 执行人, 操作员编号, 操作员姓名, 发生时间, 登记时间,
       结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 缴款组id)
      Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别,
             收费细目id, 计算单位, 付数, -数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, -应收金额, -实收金额, 开单部门id, 开单人, 执行部门id, 执行人,
             操作员编号_In, 操作员姓名_In, 发生时间, d_Date, n_销帐id,
             Decode(n_记帐, 1, Decode(Nvl(n_已结帐, 0), 0, -1 * 实收金额, Null), -1 * 结帐金额), 保险项目否, 保险大类id, -1 * 统筹金额,
             Nvl(摘要_In, 摘要) As 摘要, Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, n_组id
      From 门诊费用记录
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Nvl(附加标志, 0) <> 1;
  
    --原始记录
    If n_记帐 = 1 And Nvl(n_已结帐, 0) = 0 Then
      Update 门诊费用记录
      Set 记录状态 = 3, 结帐id = n_销帐id, 结帐金额 = 实收金额
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Nvl(附加标志, 0) <> 1;
    Else
      Update 门诊费用记录
      Set 记录状态 = 3
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Nvl(附加标志, 0) <> 1;
    End If;
  End If;

  n_结帐id := 0;
  If n_记帐 = 0 Then
    --获取结帐ID
    Select Nvl(结帐id, 0)
    Into n_结帐id
    From 门诊费用记录
    Where 记录性质 = 4 And 记录状态 = 3 And NO = 单据号_In And
          Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0)) And
          Rownum = 1;
  End If;

  If n_记帐 = 1 Then
    --记帐
    For c_费用 In (Select 实收金额, 病人科室id, 开单部门id, 执行部门id, 收入项目id
                 From 门诊费用记录
                 Where 记录性质 = 4 And 记录状态 = 3 And NO = 单据号_In And
                       Nvl(附加标志, 0) =
                       Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0)) And
                       Nvl(记帐费用, 0) = 1) Loop
      --病人余额
      Update 病人余额
      Set 费用余额 = Nvl(费用余额, 0) - Nvl(c_费用.实收金额, 0)
      Where 病人id = Nvl(n_病人id, 0) And 性质 = 1 And 类型 = 1
      Returning 费用余额 Into n_返回额;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 性质, 类型, 费用余额, 预交余额)
        Values
          (n_病人id, 1, 1, -1 * Nvl(c_费用.实收金额, 0), 0);
        n_返回额 := Nvl(c_费用.实收金额, 0);
      End If;
      If Nvl(n_返回额, 0) = 0 Then
        Delete 病人余额
        Where 病人id = Nvl(n_病人id, 0) And 性质 = 1 And 类型 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
      --病人未结费用
      Update 病人未结费用
      Set 金额 = Nvl(金额, 0) - Nvl(c_费用.实收金额, 0)
      Where 病人id = n_病人id And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And Nvl(病人科室id, 0) = Nvl(c_费用.病人科室id, 0) And
            Nvl(开单部门id, 0) = Nvl(c_费用.开单部门id, 0) And Nvl(执行部门id, 0) = Nvl(c_费用.执行部门id, 0) And 收入项目id + 0 = c_费用.收入项目id And
            来源途径 + 0 = 1;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人未结费用
          (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
        Values
          (n_病人id, Null, Null, c_费用.病人科室id, c_费用.开单部门id, c_费用.执行部门id, c_费用.收入项目id, 1, -1 * Nvl(c_费用.实收金额, 0));
      End If;
    End Loop;
    Delete 病人未结费用
    Where 病人id = n_病人id And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And Nvl(金额, 0) = 0 And 来源途径 + 0 = 1;
  End If;

  If n_记帐 = 0 Then
    --1.退费
    --病人挂号结算:现金和个人帐户部份
    If 结算方式_In Is Null Then
      If 非原样退结算_In Is Not Null Then
        --退款金额获取
        If Nvl(退费类型_In, 0) <> 0 Or Nvl(n_二次退费, 0) <> 0 Then
          --如果是单独退病历费,或者只退挂号费,先获取退费金额
          Begin
            --获取本次退款金额
            Select Sum(Nvl(实收金额, 0)) As 收款金额
            Into n_退款金额
            From 门诊费用记录
            Where NO = 单据号_In And 记录性质 = 4 And 记录状态 = 3 And
                  Nvl(附加标志, 0) =
                  Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
          
          Exception
            When Others Then
              v_Err_Msg := '单据【' || 单据号_In || '】的' || Case Nvl(退费类型_In, 0)
                             When 1 Then
                              '挂号费用'
                             When 2 Then
                              '病历费'
                           End || '可能由于并发原因已经进行了退费或者单据不存在!';
              Raise Err_Item;
          End;
          Begin
            Select 冲预交
            Into n_退费金额
            From 病人预交记录
            Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id And Instr(',' || 非原样退结算_In || ',', ',' || 结算方式 || ',') = 0;
          Exception
            When Others Then
              n_退费金额 := 0;
          End;
        
          --a.允许的结算方式
        
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In, -n_退款金额,
                   n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
            From 病人预交记录
            Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id And Instr(',' || 非原样退结算_In || ',', ',' || 结算方式 || ',') = 0;
        
          If n_退费金额 = 0 Then
            --b.不允许的退现金
            If n_退款金额 <> 0 Then
              If v_退指定结算方式 Is Null Then
                --退给现金
                Begin
                  Select 名称 Into v_退指定结算方式 From 结算方式 Where 性质 = 1;
                Exception
                  When Others Then
                    v_退指定结算方式 := '现金';
                End;
              End If;
              Update 病人预交记录
              Set 冲预交 = 冲预交 + (-1 * n_退款金额), 交易说明 = Nvl(交易说明_In, 交易说明)
              Where 记录性质 = 4 And 记录状态 = 2 And 结帐id = n_销帐id And 结算方式 = v_退指定结算方式;
              If Sql%RowCount = 0 Then
                Insert Into 病人预交记录
                  (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别,
                   卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
                  Select 病人预交记录_Id.Nextval, a.No, a.实际票号, a.记录性质, 2, a.病人id, a.主页id, a.科室id, a.摘要, v_退指定结算方式, d_Date,
                         操作员编号_In, 操作员姓名_In, -1 * n_退款金额, n_销帐id, n_组id, 预交类别, Decode(交易说明_In, Null, 卡类别id, Null), 结算卡序号,
                         Decode(交易说明_In, Null, 卡号, Null), Decode(交易说明_In, Null, 交易流水号, Null), Nvl(交易说明_In, 交易说明), 合作单位,
                         4
                  From 病人预交记录 A
                  Where a.记录性质 = 4 And a.记录状态 = 1 And a.结帐id = n_结帐id And Rownum < 2;
              End If;
            End If;
          End If;
        Else
          --a.允许的结算方式原样退
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In, -冲预交,
                   n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
            From 病人预交记录
            Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id And Instr(',' || 非原样退结算_In || ',', ',' || 结算方式 || ',') = 0;
        
          --b.不允许的退现金
          Begin
            Select Sum(冲预交)
            Into n_退费金额
            From 病人预交记录
            Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id And Instr(',' || 非原样退结算_In || ',', ',' || 结算方式 || ',') > 0;
          Exception
            When Others Then
              n_退费金额 := 0;
          End;
          If n_退费金额 <> 0 Then
            If v_退指定结算方式 Is Null Then
              --退给现金
              Begin
                Select 结算方式
                Into v_退指定结算方式
                From 病人预交记录
                Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id And
                      Instr(',' || 非原样退结算_In || ',', ',' || 结算方式 || ',') = 0;
              
              Exception
                When Others Then
                  Begin
                    Select 名称 Into v_退指定结算方式 From 结算方式 Where 性质 = 1;
                  Exception
                    When Others Then
                      v_退指定结算方式 := '现金';
                  End;
              End;
            End If;
            Update 病人预交记录
            Set 冲预交 = 冲预交 + (-1 * n_退费金额), 交易说明 = Nvl(交易说明_In, 交易说明)
            Where 记录性质 = 4 And 记录状态 = 2 And 结帐id = n_销帐id And 结算方式 = v_退指定结算方式;
            If Sql%RowCount = 0 Then
              Insert Into 病人预交记录
                (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别,
                 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
                Select 病人预交记录_Id.Nextval, a.No, a.实际票号, a.记录性质, 2, a.病人id, a.主页id, a.科室id, a.摘要, v_退指定结算方式, d_Date,
                       操作员编号_In, 操作员姓名_In, -1 * n_退费金额, n_销帐id, n_组id, 预交类别, Decode(交易说明_In, Null, 卡类别id, Null), 结算卡序号,
                       Decode(交易说明_In, Null, 卡号, Null), Decode(交易说明_In, Null, 交易流水号, Null), Nvl(交易说明_In, 交易说明), 合作单位, 4
                From 病人预交记录 A
                Where a.记录性质 = 4 And a.记录状态 = 1 And a.结帐id = n_结帐id And Rownum < 2;
            End If;
          End If;
        End If;
      Else
        --退款金额获取
        If Nvl(退费类型_In, 0) <> 0 Or Nvl(n_二次退费, 0) <> 0 Then
          --如果是单独退病历费,或者只退挂号费,先获取退费金额
          Begin
            --获取本次退款金额
            Select Sum(Nvl(实收金额, 0)) As 收款金额
            Into n_退款金额
            From 门诊费用记录
            Where NO = 单据号_In And 记录性质 = 4 And 记录状态 = 3 And
                  Nvl(附加标志, 0) =
                  Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
          Exception
            When Others Then
              v_Err_Msg := '单据【' || 单据号_In || '】的' || Case Nvl(退费类型_In, 0)
                             When 1 Then
                              '挂号费用'
                             When 2 Then
                              '病历费'
                           End || '可能由于并发原因已经进行了退费或者单据不存在!';
              Raise Err_Item;
          End;
        End If;
        If Nvl(n_二次退费, 0) = 0 And Nvl(退费类型_In, 0) = 0 Then
          --首次全退
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In,
                   -1 * 冲预交, n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
            From 病人预交记录
            Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id;
        Else
          --二次退费,或者本次单退一部分
          --二次退费时,记录状态=3 ,首次部分退,记录状态为1
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In,
                   -1 * n_退款金额, n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
            From 病人预交记录
            Where 记录性质 = 4 And 记录状态 = Decode(Nvl(n_二次退费, 0), 0, 1, 3) And 结帐id = n_结帐id And 摘要 = '医保挂号' And
                  冲预交 = n_退款金额 And Rownum < 2;
          If Sql%RowCount = 0 Then
            Insert Into 病人预交记录
              (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
               结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
              Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In,
                     -1 * n_退款金额, n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
              From 病人预交记录
              Where 记录性质 = 4 And 记录状态 = Decode(Nvl(n_二次退费, 0), 0, 1, 3) And 结帐id = n_结帐id And 冲预交 = n_退款金额 And
                    Rownum < 2;
          End If;
          If Sql%RowCount = 0 Then
            Insert Into 病人预交记录
              (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
               结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
              Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In,
                     -1 * n_退款金额, n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
              From 病人预交记录
              Where 记录性质 = 4 And 记录状态 = Decode(Nvl(n_二次退费, 0), 0, 1, 3) And 结帐id = n_结帐id And Rownum < 2;
            If Sql%RowCount = 0 Then
              --部分退费,并且全部使用预交款缴费时才存在此种情况
              n_预交金额 := n_退款金额;
            End If;
          End If;
        
        End If;
      End If;
    Else
      --按结算方式退
      v_结算内容 := 结算方式_In || '|'; --以空格分开以|结尾,没有结算号码的
      While v_结算内容 Is Not Null Loop
        v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '|') - 1);
        v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1);
      
        v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
        n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1));
      
        v_当前结算   := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
        n_三方卡标志 := To_Number(v_当前结算);
      
        If n_三方卡标志 = 0 Then
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质, 结算号码)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, v_结算方式, d_Date, 操作员编号_In, 操作员姓名_In,
                   -1 * n_结算金额, n_销帐id, n_组id, 预交类别, Null, Null, Null, Null, 交易说明_In, 合作单位, 4, 结算号码
            From 病人预交记录
            Where 记录性质 = 4 And 记录状态 = Decode(Nvl(n_二次退费, 0), 0, 1, 3) And 结帐id = n_结帐id And Rownum < 2;
        Else
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质, 结算号码)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, v_结算方式, d_Date, 操作员编号_In, 操作员姓名_In,
                   -1 * n_结算金额, n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, Nvl(交易说明_In, 交易说明), 合作单位, 4, 结算号码
            
            From 病人预交记录
            Where 记录性质 = 4 And 记录状态 = Decode(Nvl(n_二次退费, 0), 0, 1, 3) And 结帐id = n_结帐id And
                  (卡类别id Is Not Null Or 结算卡序号 Is Not Null) And Rownum < 2;
        End If;
        v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '|') + 1);
      End Loop;
      n_预交金额 := Nvl(退预交_In, 0);
    End If;
    --首次退费时,记录状态便调整为了3
    Update 病人预交记录
    Set 记录状态 = 3
    Where 记录性质 = 4 And 记录状态 = Decode(Nvl(n_二次退费, 0), 0, 1, 3) And 结帐id = n_结帐id;
  
    --冲预交 1-全退 2-部分退,部分退时当全部使用预交进行缴款
    If Nvl(退费类型_In, 0) = 0 Or (Nvl(退费类型_In, 0) <> 0 And n_预交金额 <> 0) Then
      --病人挂号结算:冲预交款部份
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
         结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, d_Date,
               操作员姓名_In, 操作员编号_In, -1 * Decode(Nvl(退费类型_In, 0) + Nvl(n_二次退费, 0), 0, 冲预交, n_预交金额), n_销帐id, n_组id, 预交类别,
               卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
        From 病人预交记录
        Where 记录性质 In (1, 11) And 结帐id = n_结帐id And Nvl(冲预交, 0) <> 0 And
              Rownum = Decode(Nvl(退费类型_In, 0) + Nvl(n_二次退费, 0), 0, Rownum, 1);
    End If;
  
    --处理病人预交余额
    For c_预交 In (Select 病人id, 预交类别, -1 * Sum(Nvl(冲预交, 0)) As 冲预交
                 From 病人预交记录
                 Where 记录性质 In (1, 11) And 结帐id = n_销帐id
                 Group By 病人id, 预交类别) Loop
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + Nvl(c_预交.冲预交, 0)
      Where 病人id = c_预交.病人id And 类型 = Nvl(c_预交.预交类别, 2) And 性质 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 预交余额, 性质, 类型)
        Values
          (c_预交.病人id, Nvl(c_预交.冲预交, 0), 1, Nvl(c_预交.预交类别, 2));
        n_返回值 := Nvl(c_预交.冲预交, 0);
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = c_预交.病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
      End If;
    End Loop;
  
    If 收回票据号_In Is Not Null Then
      --光退挂号费,不回收票据
      --退卡收回票据(可能上次挂号使用票据,不能收回)
      Begin
        --从最后一次打印的内容中取
        --81907
        Select ID
        Into n_打印id
        From (Select b.Id
               From 票据使用明细 A, 票据打印内容 B
               Where a.打印id = b.Id And a.性质 = 1 And a.原因 In (1, 3) And b.数据性质 = 4 And b.No = 单据号_In
               Order By a.使用时间 Desc)
        Where Rownum < 2;
      Exception
        When Others Then
          n_打印id := Null;
      End;
    
      --先收回原票据
      If n_打印id Is Not Null Then
        Begin
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
            Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, d_Date, 操作员姓名_In
            From 票据使用明细
            Where 打印id = n_打印id And 性质 = 1 And Instr(',' || 收回票据号_In || ',', ',' || 号码 || ',') > 0;
        Exception
          When Others Then
            Delete From 票据使用明细 Where 打印id = n_打印id And 性质 = 2 And 原因 = 2;
            Insert Into 票据使用明细
              (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
              Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, d_Date, 操作员姓名_In
              From 票据使用明细
              Where 打印id = n_打印id And 性质 = 1 And Instr(',' || 收回票据号_In || ',', ',' || 号码 || ',') > 0;
        End;
      End If;
    End If;
  End If;

  --单独退病历费用,不处理汇总记录
  --相关汇总表的处理

  --病人挂号汇总
  Open c_Registinfo(3);
  Fetch c_Registinfo
    Into r_Registrow;

  If c_Registinfo%RowCount = 0 Then
    --只收病历费时无号别,不处理
    Close c_Registinfo;
  Else
  
    --需要确定是否预约挂号
    --1.如果是退预约挂号产生的挂号记录,则需要减已挂数和其中已接数
    --2.如果是正常挂号,则只减已挂数
  
    Begin
      Select Decode(预约, Null, 0, 0, 0, 1) Into n_预约挂号 From 病人挂号记录 Where NO = 单据号_In And Rownum = 1;
    Exception
      When Others Then
        n_预约挂号 := 0;
    End;
    n_检查数 := Null;
    Update 临床出诊记录
    Set 已挂数 = Nvl(已挂数, 0) - 1, 其中已接收 = Nvl(其中已接收, 0) - n_预约挂号, 已约数 = Nvl(已约数, 0) - n_预约挂号
    Where ID = n_出诊记录id
    Returning 已挂数 Into n_检查数;
  
    If Nvl(n_检查数, 0) < 0 Then
      Update 临床出诊记录 Set 已挂数 = 0 Where ID = n_出诊记录id;
    End If;
  
    Update 病人挂号汇总
    Set 已挂数 = Nvl(已挂数, 0) - 1, 其中已接收 = Nvl(其中已接收, 0) - n_预约挂号, 已约数 = Nvl(已约数, 0) - n_预约挂号
    Where 日期 = Trunc(r_Registrow.发生时间) And Nvl(医生id, 0) = Nvl(r_Registrow.医生id, 0) And
          Nvl(医生姓名, '-') = Nvl(r_Registrow.医生姓名, '-') And 科室id = r_Registrow.科室id And 项目id = r_Registrow.项目id And
          (号码 = r_Registrow.号码 Or 号码 Is Null);
  
    If Sql%RowCount = 0 Then
      Insert Into 病人挂号汇总
        (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已挂数, 其中已接收, 已约数)
      Values
        (Trunc(r_Registrow.发生时间), r_Registrow.科室id, r_Registrow.项目id, r_Registrow.医生姓名,
         Decode(r_Registrow.医生id, 0, Null, r_Registrow.医生id), r_Registrow.号码, -1, -1 * n_预约挂号, -1 * n_预约挂号);
    End If;
  
    Close c_Registinfo;
  End If;

  If n_记帐 = 0 Then
    --人员缴款余额(包括个人帐户等的结算金额,不含退冲预交款)
    For r_Opermoney In c_Opermoney(n_销帐id) Loop
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) + (-1 * r_Opermoney.冲预交)
      Where 收款员 = 操作员姓名_In And 结算方式 = r_Opermoney.结算方式 And 性质 = 1
      Returning 余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (操作员姓名_In, r_Opermoney.结算方式, 1, -1 * r_Opermoney.冲预交);
        n_返回值 := r_Opermoney.冲预交;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 人员缴款余额
        Where 收款员 = 操作员姓名_In And 结算方式 = r_Opermoney.结算方式 And 性质 = 1 And Nvl(余额, 0) = 0;
      End If;
    End Loop;
  End If;
  If Nvl(退费类型_In, 0) Not In (2, 3) Then
    n_挂号生成队列 := Zl_To_Number(zl_GetSysParameter('排队叫号模式', 1113));
    If n_挂号生成队列 <> 0 Then
      n_分诊台签到排队 := Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113));
      If Nvl(n_分诊台签到排队, 0) = 0 Then
      
        --要删除队列
        For v_挂号 In (Select ID, 诊室, 执行部门id, 执行人 From 病人挂号记录 Where NO = 单据号_In) Loop
          Zl_排队叫号队列_Delete(v_挂号.执行部门id, v_挂号.Id);
        End Loop;
      End If;
    End If;
  
    --医保产生的就诊登记记录
    Begin
      Select 病人id, 发生时间 Into n_就诊病人id, d_就诊时间 From 病人挂号记录 Where NO = 单据号_In;
      Delete From 就诊登记记录 Where 病人id = n_就诊病人id And 就诊时间 = d_就诊时间 And 主页id Is Null;
    Exception
      When Others Then
        Null;
    End;
  
    --病人挂号记录
    Select 病人挂号记录_Id.Nextval Into n_挂号id From Dual;
  
    Update 病人挂号记录 Set 记录状态 = 3 Where NO = 单据号_In And 记录性质 = 1 And 记录状态 = 1;
    If Sql%NotFound Then
      v_Err_Msg := '挂号单【' || 单据号_In || '】不存在或由于并发原因已经被退号';
      Raise Err_Item;
    End If;
    Insert Into 病人挂号记录
      (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 操作员编号, 操作员姓名,
       复诊, 号序, 社区, 预约, 摘要, 预约方式, 接收人, 接收时间, 交易流水号, 交易说明, 合作单位, 险类, 医疗付款方式, 出诊记录id)
      Select n_挂号id, NO, 记录性质, 2, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, d_Date, 发生时间,
             操作员编号_In, 操作员姓名_In, 复诊, 号序, 社区, 预约, Nvl(摘要_In, 摘要) As 摘要, 预约方式, 接收人, 接收时间, 交易流水号, 交易说明, 合作单位, 险类, 医疗付款方式,
             n_出诊记录id
      From 病人挂号记录
      Where NO = 单据号_In;
  End If;
  --消息推送
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 2, 单据号_In;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人挂号记录_出诊_Delete;
/

--105433:刘尔旋,2017-03-16,三方卡强制退现
Create Or Replace Procedure Zl_病人挂号记录_Delete
(
  单据号_In       门诊费用记录.No%Type,
  操作员编号_In   门诊费用记录.操作员编号%Type,
  操作员姓名_In   门诊费用记录.操作员姓名%Type,
  摘要_In         门诊费用记录.摘要%Type := Null, --预约取消时 填写 存放预约取消原因
  删除门诊号_In   Number := 0,
  非原样退结算_In Varchar2 := Null,
  退费类型_In     In Number := 0, --0-全退 1-退挂号费 2-退病历费 3-退附加费 4-退挂号与病历 5-退挂号与附加
  退指定结算_In   病人预交记录.结算方式%Type := Null,
  退号重用_In     Number := 1,
  收回票据号_In   Varchar2 := Null,
  交易说明_In     病人预交记录.交易说明%Type := Null
) As
  --退费类型_In,在一下几种情况下不准进行部分退费
  --    2.三方接口,暂时不支持
  -- 挂号费病历费分开退,规则
  --    普通结算方式:原结算方式退部分费用
  --    预交款:预交款,退部分
  --    预交款与普通结算方式混合:退款按照普通结算方式部分退
  --    消费卡:原样将费用部分退入消费卡
  --非原样退结算_In:指不能退还给原样结算方式(如医保的个人账户,三方账户的退现等),多个用逗分离
  --退指定结算_IN:指非原样退结算部分,应该退给哪种结算方式,为空时缺省退给现金,否则退给指定的结算方式

  --该游标用于判断是否单独收病历费,及挂号汇总表处理
  Cursor c_Registinfo(v_状态 门诊费用记录.记录状态%Type) Is
    Select a.发生时间, a.登记时间, c.接收时间, a.收费细目id As 项目id, c.执行部门id As 科室id, c.执行人 As 医生姓名, d.Id As 医生id, c.号别 As 号码
    From 门诊费用记录 A, 挂号安排 B, 病人挂号记录 C, 人员表 D
    Where a.记录性质 = 4 And a.序号 = 1 And a.记录状态 = v_状态 And c.No = a.No And c.执行人 = d.姓名(+) And a.No = 单据号_In And
          Nvl(a.计算单位, '号别') = c.号别 And Rownum < 2;
  r_Registrow c_Registinfo%RowType;

  --该游标用于判断记录是否存在,及费用汇总表处理
  Cursor c_Moneyinfo(v_状态 门诊费用记录.记录状态%Type) Is
    Select 病人科室id, 开单部门id, 执行部门id, 收入项目id, Nvl(Sum(应收金额), 0) As 应收, Nvl(Sum(实收金额), 0) As 实收, Nvl(Sum(结帐金额), 0) As 结帐
    From 门诊费用记录
    Where 记录性质 = 4 And 记录状态 = v_状态 And NO = 单据号_In
    Group By 病人科室id, 开单部门id, 执行部门id, 收入项目id;
  r_Moneyrow c_Moneyinfo%RowType;

  --该光标用于处理人员缴款余额中退的不同结算方式的金额
  Cursor c_Opermoney(n_Id 病人预交记录.结帐id%Type) Is
    Select Distinct b.结算方式, -1 * Nvl(b.冲预交, 0) As 冲预交
    From 病人预交记录 B
    Where b.结帐id = n_Id And b.记录性质 = 4 And b.记录状态 = 2 And Nvl(b.冲预交, 0) <> 0;

  v_Err_Msg Varchar(255);
  Err_Item Exception;

  n_结帐id 病人预交记录.结帐id%Type;
  n_销帐id 门诊费用记录.结帐id%Type;

  v_退指定结算方式 病人预交记录.结算方式%Type;
  n_退款金额       病人预交记录.冲预交%Type;
  n_打印id         票据打印内容.Id%Type;
  n_病人id         病人信息.病人id%Type;
  n_退费金额       病人预交记录.冲预交%Type;
  n_预交金额       病人预交记录.冲预交%Type; --原记录 预交缴款金额
  n_返回值         病人余额.预交余额%Type;
  n_挂号id         病人挂号记录.Id%Type;
  n_组id           财务缴款分组.Id%Type;

  n_二次退费       Number; --记录是否是此单据的第二次退费
  n_分诊台签到排队 Number;
  n_预约生成队列   Number;
  n_预约挂号       Number;
  n_挂号生成队列   Number;
  d_Date           Date;
  n_记帐           门诊费用记录.记帐费用%Type;
  n_病人id1        病人信息.病人id%Type;
  n_返回额         门诊费用记录.实收金额%Type;
  n_已结帐         Number;
  n_安排id         挂号安排.Id%Type;
  n_计划id         挂号安排计划.Id%Type;
  d_启用时间       Date;
  d_发生时间       病人挂号记录.发生时间%Type;
  n_出诊记录id     临床出诊记录.Id%Type;
  v_号码           挂号安排.号码%Type;
  n_序号           病人挂号记录.号序%Type;
  v_时间段         时间段.时间段%Type;
  d_检查开始时间   Date;
  d_检查结束时间   Date;
  v_Temp           Varchar2(500);
  v_附加ids        Varchar2(500);
  n_就诊病人id     病人信息.病人id%Type;
  d_就诊时间       就诊登记记录.就诊时间%Type;
Begin
  n_组id           := Zl_Get组id(操作员姓名_In);
  v_退指定结算方式 := 退指定结算_In;

  --首先判断要退号/取消预约的记录是否存在
  Open c_Moneyinfo(1);
  Fetch c_Moneyinfo
    Into r_Moneyrow;
  If c_Moneyinfo%RowCount = 0 Then
    Close c_Moneyinfo;
    Open c_Moneyinfo(0);
    Fetch c_Moneyinfo
      Into r_Moneyrow;
    If c_Moneyinfo%RowCount = 0 Then
      v_Err_Msg := '要处理的单据不存在。';
      Raise Err_Item;
    End If;
    n_预约挂号 := 1;
  End If;
  Close c_Moneyinfo;

  v_Temp := zl_GetSysParameter(256);
  If v_Temp Is Null Or Substr(v_Temp, 1, 1) = '0' Then
    Null;
  Else
    Begin
      d_启用时间 := To_Date(Substr(v_Temp, 3), 'YYYY-MM-DD hh24:mi:ss');
    Exception
      When Others Then
        d_启用时间 := Null;
    End;
  End If;

  Select 号别, 号序, 发生时间 Into v_号码, n_序号, d_发生时间 From 病人挂号记录 Where NO = 单据号_In And Rownum < 2;

  Begin
    Select a.Id Into n_安排id From 挂号安排 A Where a.号码 = v_号码;
  Exception
    When Others Then
      n_安排id := -1;
  End;

  Begin
    Select ID
    Into n_计划id
    From 挂号安排计划
    Where 安排id = n_安排id And 审核时间 Is Not Null And
          Nvl(生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) =
          (Select Max(a.生效时间) As 生效
           From 挂号安排计划 A
           Where a.审核时间 Is Not Null And d_发生时间 Between Nvl(a.生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) And
                 Nvl(a.失效时间, To_Date('3000-01-01', 'yyyy-mm-dd')) And a.安排id = n_安排id) And
          d_发生时间 Between Nvl(生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) And
          Nvl(失效时间, To_Date('3000-01-01', 'yyyy-mm-dd'));
  Exception
    When Others Then
      n_计划id := 0;
  End;

  Begin
    If Nvl(n_计划id, 0) = 0 Then
      Select Decode(To_Char(d_发生时间, 'D'), '1', 周日, '2', 周一, '3', 周二, '4', 周三, '5', 周四, '6', 周五, '7', 周六, Null)
      Into v_时间段
      From 挂号安排
      Where ID = n_安排id;
    Else
      Select Decode(To_Char(d_发生时间, 'D'), '1', 周日, '2', 周一, '3', 周二, '4', 周三, '5', 周四, '6', 周五, '7', 周六, Null)
      Into v_时间段
      From 挂号安排计划
      Where ID = n_计划id;
    End If;
  Exception
    When Others Then
      v_时间段 := Null;
  End;

  If v_时间段 Is Not Null And d_启用时间 Is Not Null Then
    --检查是否跨模式挂号安排
    Select To_Date(To_Char(d_发生时间, 'yyyy-mm-dd') || ' ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'),
           To_Date(To_Char(d_发生时间, 'yyyy-mm-dd') || ' ' || To_Char(终止时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
    Into d_检查开始时间, d_检查结束时间
    From 时间段
    Where 时间段 = v_时间段 And 站点 Is Null And 号类 Is Null;
    If d_检查开始时间 > d_检查结束时间 Then
      d_检查结束时间 := d_检查结束时间 + 1;
    End If;
    If d_检查结束时间 > d_启用时间 Then
      --获取出诊记录id
      Begin
        Select a.Id
        Into n_出诊记录id
        From 临床出诊记录 A, 临床出诊号源 B
        Where a.号源id = b.Id And b.号码 = v_号码 And 上班时段 = v_时间段 And d_发生时间 Between 开始时间 And 终止时间;
      Exception
        When Others Then
          n_出诊记录id := Null;
      End;
    End If;
  End If;

  Begin
    Select Zl_Fun_Regcustomname Into v_Temp From Dual;
    If v_Temp Is Not Null Then
      v_附加ids := Substr(v_Temp, Instr(v_Temp, '|') + 1);
    End If;
  Exception
    When Others Then
      v_附加ids := Null;
  End;

  --1.预约处理
  If Nvl(n_预约挂号, 0) = 1 Then
    --减少已约数
    Open c_Registinfo(0);
    Fetch c_Registinfo
      Into r_Registrow;
  
    Update 病人挂号汇总
    Set 已约数 = Nvl(已约数, 0) - 1
    Where 日期 = Trunc(r_Registrow.发生时间) And 科室id = r_Registrow.科室id And 项目id = r_Registrow.项目id And
          (号码 = r_Registrow.号码 Or 号码 Is Null);
  
    If Sql%RowCount = 0 Then
      Insert Into 病人挂号汇总
        (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已约数)
      Values
        (Trunc(r_Registrow.发生时间), r_Registrow.科室id, r_Registrow.项目id, r_Registrow.医生姓名,
         Decode(r_Registrow.医生id, 0, Null, r_Registrow.医生id), r_Registrow.号码, -1);
    End If;
    Close c_Registinfo;
  
    --更新挂号序号状态
    Delete 挂号序号状态
    Where 状态 = 2 And
          (号码, 序号, 日期) = (Select 计算单位, 发药窗口, Trunc(发生时间)
                          From 门诊费用记录
                          Where 记录性质 = 4 And 记录状态 = 0 And 序号 = 1 And Rownum = 1 And NO = 单据号_In) Or
          (号码, 序号, 日期) = (Select 计算单位, 发药窗口, 发生时间
                          From 门诊费用记录
                          Where 记录性质 = 4 And 记录状态 = 0 And 序号 = 1 And Rownum = 1 And NO = 单据号_In);
  
    --添加病人挂号记录的 冲销记录
    Select 病人挂号记录_Id.Nextval, Sysdate Into n_挂号id, d_Date From Dual;
  
    Update 病人挂号记录 Set 记录状态 = 3 Where NO = 单据号_In And 记录状态 = 1 And 记录性质 = 2;
    If Sql%NotFound Then
      v_Err_Msg := '预约单【' || 单据号_In || '】不存在或由于并发原因已经被取消预约';
      Raise Err_Item;
    End If;
  
    Insert Into 病人挂号记录
      (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 操作员编号, 操作员姓名,
       复诊, 号序, 社区, 预约, 摘要, 预约方式, 接收人, 接收时间, 交易流水号, 交易说明, 合作单位, 医疗付款方式)
      Select n_挂号id, NO, 记录性质, 2, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, d_Date, 发生时间,
             操作员编号_In, 操作员姓名_In, 复诊, 号序, 社区, 预约, Nvl(摘要_In, 摘要) As 摘要, 预约方式, 接收人, 接收时间, 交易流水号, 交易说明, 合作单位, 医疗付款方式
      From 病人挂号记录
      Where NO = 单据号_In;
  
    If n_出诊记录id Is Not Null Then
      Update 临床出诊记录 Set 已约数 = 已约数 - 1 Where ID = n_出诊记录id And Nvl(已约数, 0) > 0;
      Update 临床出诊序号控制 Set 挂号状态 = Null, 操作员姓名 = Null Where 记录id = n_出诊记录id And 序号 = n_序号;
    End If;
  
    --Update 病人挂号记录 set 摘要=nvl(摘要_IN,摘要) where NO=单据号_IN;
    --删除门诊费用记录
    Delete From 门诊费用记录 Where NO = 单据号_In And 记录性质 = 4 And 记录状态 = 0;
    --如果预约生成队列时需要清除队列
  
    n_预约生成队列 := Zl_To_Number(zl_GetSysParameter('预约生成队列', 1113));
    If Nvl(n_预约生成队列, 0) = 1 Then
      --要删除队列
      For v_挂号 In (Select ID, 诊室, 执行部门id, 执行人 From 病人挂号记录 Where NO = 单据号_In) Loop
        Zl_排队叫号队列_Delete(v_挂号.执行部门id, v_挂号.Id);
      End Loop;
    End If;
    Return;
  End If;

  Select Nvl(记帐费用, 0), 病人id, Decode(Sign(Nvl(结帐id, 0)), 0, 0, 1)
  Into n_记帐, n_病人id, n_已结帐
  From 门诊费用记录
  Where 记录性质 = 4 And NO = 单据号_In And 记录状态 In (1, 3) And Rownum < 2;

  --2.挂号处理
  n_已结帐 := Nvl(n_已结帐, 0);

  If n_已结帐 = 1 And n_记帐 = 1 Then
    Select Sysdate, Null Into d_Date, n_销帐id From Dual;
  Else
    Select Sysdate, 病人结帐记录_Id.Nextval Into d_Date, n_销帐id From Dual;
  End If;

  ----0-全退 1-退挂号费 2-退病历费
  If Nvl(退费类型_In, 0) Not In (2, 3) Then
    --不是光退病历费时处理
    --更新挂号序号状态
    If 退号重用_In = 1 Then
      Delete 挂号序号状态
      Where 状态 = 1 And
            (号码, 序号, 日期) = (Select 号别, 号序, Trunc(发生时间) From 病人挂号记录 Where NO = 单据号_In And Rownum = 1) Or
            (号码, 序号, 日期) = (Select 号别, 号序, 发生时间 From 病人挂号记录 Where NO = 单据号_In And Rownum = 1);
    Else
      Update 挂号序号状态
      Set 状态 = 4
      Where 状态 = 1 And
            (号码, 序号, 日期) = (Select 号别, 号序, Trunc(发生时间) From 病人挂号记录 Where NO = 单据号_In And Rownum = 1) Or
            (号码, 序号, 日期) = (Select 号别, 号序, 发生时间 From 病人挂号记录 Where NO = 单据号_In And Rownum = 1);
    End If;
  
    --病人就诊状态
    If n_病人id Is Not Null Then
      Update 病人信息 Set 就诊状态 = 0, 就诊诊室 = Null Where 病人id = n_病人id;
    
      --删除门诊号相关处理,只有当只有一条挂号记录并且病人建档日期与挂号日期近似时才会处理
      If 删除门诊号_In = 1 Then
        Delete 门诊病案记录 Where 病人id = n_病人id;
        Update 病人信息 Set 门诊号 = Null Where 病人id = n_病人id;
        --费用记录包括挂号及病案、就诊卡费用,以及病人交费后退费或销帐的费用,挂号记录在最后处理
        Update 门诊费用记录 Set 标识号 = Null Where 门诊标志 = 1 And 病人id = n_病人id;
      End If;
    End If;
  
    --如果挂时收了就诊卡费,退费时清除就诊卡号,在非光退病历费时
    n_病人id1 := Null;
    Begin
      Select 病人id
      Into n_病人id1
      From 门诊费用记录
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And 附加标志 = 2 And Rownum < 2;
    Exception
      When Others Then
        Null;
    End;
  
    If n_病人id1 Is Not Null And Nvl(退费类型_In, 0) Not In (2, 3) Then
      Update 病人信息
      Set 就诊卡号 = Null, 卡验证码 = Null, Ic卡号 = Decode(Ic卡号, 就诊卡号, Null, Ic卡号)
      Where 病人id = n_病人id1;
    End If;
  
  End If;

  --检查前面是否已经部分退过费用
  Begin
    Select 1 Into n_二次退费 From 门诊费用记录 Where 记录性质 = 4 And NO = 单据号_In And 记录状态 = 3 And Rownum < 2;
  Exception
    When Others Then
      n_二次退费 := 0;
  End;

  If Nvl(退费类型_In, 0) = 0 Or Nvl(退费类型_In, 0) = 2 Then
    --全退,退病历费
    --门诊费用记录，冲销记录
    Insert Into 门诊费用记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别, 收费细目id, 计算单位, 付数,
       数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 执行人, 操作员编号, 操作员姓名, 发生时间, 登记时间,
       结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 缴款组id)
      Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别,
             收费细目id, 计算单位, 付数, -数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, -应收金额, -实收金额, 开单部门id, 开单人, 执行部门id, 执行人,
             操作员编号_In, 操作员姓名_In, 发生时间, d_Date, n_销帐id,
             Decode(n_记帐, 1, Decode(Nvl(n_已结帐, 0), 0, -1 * 实收金额, Null), -1 * 结帐金额), 保险项目否, 保险大类id, -1 * 统筹金额,
             Nvl(摘要_In, 摘要) As 摘要, Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, n_组id
      From 门诊费用记录
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
  
    --原始记录
    If n_记帐 = 1 And Nvl(n_已结帐, 0) = 0 Then
      Update 门诊费用记录
      Set 记录状态 = 3, 结帐id = n_销帐id, 结帐金额 = 实收金额
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    Else
      Update 门诊费用记录
      Set 记录状态 = 3
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    End If;
  Elsif Nvl(退费类型_In, 0) = 1 Or Nvl(退费类型_In, 0) = 4 Then
    --退挂号费,退挂号与病历费
    --门诊费用记录，冲销记录
    Insert Into 门诊费用记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别, 收费细目id, 计算单位, 付数,
       数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 执行人, 操作员编号, 操作员姓名, 发生时间, 登记时间,
       结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 缴款组id)
      Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别,
             收费细目id, 计算单位, 付数, -数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, -应收金额, -实收金额, 开单部门id, 开单人, 执行部门id, 执行人,
             操作员编号_In, 操作员姓名_In, 发生时间, d_Date, n_销帐id,
             Decode(n_记帐, 1, Decode(Nvl(n_已结帐, 0), 0, -1 * 实收金额, Null), -1 * 结帐金额), 保险项目否, 保险大类id, -1 * 统筹金额,
             Nvl(摘要_In, 摘要) As 摘要, Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, n_组id
      From 门诊费用记录
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') = 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
  
    --原始记录
    If n_记帐 = 1 And Nvl(n_已结帐, 0) = 0 Then
      Update 门诊费用记录
      Set 记录状态 = 3, 结帐id = n_销帐id, 结帐金额 = 实收金额
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') = 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    Else
      Update 门诊费用记录
      Set 记录状态 = 3
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') = 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    End If;
  Elsif Nvl(退费类型_In, 0) = 3 Then
    --退附加费
    --门诊费用记录，冲销记录
    Insert Into 门诊费用记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别, 收费细目id, 计算单位, 付数,
       数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 执行人, 操作员编号, 操作员姓名, 发生时间, 登记时间,
       结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 缴款组id)
      Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别,
             收费细目id, 计算单位, 付数, -数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, -应收金额, -实收金额, 开单部门id, 开单人, 执行部门id, 执行人,
             操作员编号_In, 操作员姓名_In, 发生时间, d_Date, n_销帐id,
             Decode(n_记帐, 1, Decode(Nvl(n_已结帐, 0), 0, -1 * 实收金额, Null), -1 * 结帐金额), 保险项目否, 保险大类id, -1 * 统筹金额,
             Nvl(摘要_In, 摘要) As 摘要, Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, n_组id
      From 门诊费用记录
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') > 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
  
    --原始记录
    If n_记帐 = 1 And Nvl(n_已结帐, 0) = 0 Then
      Update 门诊费用记录
      Set 记录状态 = 3, 结帐id = n_销帐id, 结帐金额 = 实收金额
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') > 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    Else
      Update 门诊费用记录
      Set 记录状态 = 3
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Instr(',' || v_附加ids || ',', ',' || 收费细目id || ',') > 0 And
            Nvl(附加标志, 0) = Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0));
    End If;
  Elsif Nvl(退费类型_In, 0) = 5 Then
    --退挂号与附加费
    --门诊费用记录，冲销记录
    Insert Into 门诊费用记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别, 收费细目id, 计算单位, 付数,
       数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 执行人, 操作员编号, 操作员姓名, 发生时间, 登记时间,
       结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 缴款组id)
      Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 价格父号, 从属父号, 病人id, 病人科室id, 门诊标志, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 收费类别,
             收费细目id, 计算单位, 付数, -数次, 加班标志, 附加标志, 发药窗口, 收入项目id, 收据费目, 记帐费用, 标准单价, -应收金额, -实收金额, 开单部门id, 开单人, 执行部门id, 执行人,
             操作员编号_In, 操作员姓名_In, 发生时间, d_Date, n_销帐id,
             Decode(n_记帐, 1, Decode(Nvl(n_已结帐, 0), 0, -1 * 实收金额, Null), -1 * 结帐金额), 保险项目否, 保险大类id, -1 * 统筹金额,
             Nvl(摘要_In, 摘要) As 摘要, Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, n_组id
      From 门诊费用记录
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Nvl(附加标志, 0) <> 1;
  
    --原始记录
    If n_记帐 = 1 And Nvl(n_已结帐, 0) = 0 Then
      Update 门诊费用记录
      Set 记录状态 = 3, 结帐id = n_销帐id, 结帐金额 = 实收金额
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Nvl(附加标志, 0) <> 1;
    Else
      Update 门诊费用记录
      Set 记录状态 = 3
      Where 记录性质 = 4 And 记录状态 = 1 And NO = 单据号_In And Nvl(附加标志, 0) <> 1;
    End If;
  End If;

  n_结帐id := 0;
  If n_记帐 = 0 Then
    --获取结帐ID
    Select Nvl(结帐id, 0)
    Into n_结帐id
    From 门诊费用记录
    Where 记录性质 = 4 And 记录状态 = 3 And NO = 单据号_In And Rownum < 2;
  End If;

  If n_记帐 = 1 Then
    --记帐
    For c_费用 In (Select 实收金额, 病人科室id, 开单部门id, 执行部门id, 收入项目id
                 From 门诊费用记录
                 Where 记录性质 = 4 And 记录状态 = 3 And NO = 单据号_In And
                       Nvl(附加标志, 0) =
                       Decode(Nvl(退费类型_In, 0), 2, 1, 1, Decode(Nvl(附加标志, 0), 1, -1, Nvl(附加标志, 0)), Nvl(附加标志, 0)) And
                       Nvl(记帐费用, 0) = 1) Loop
      --病人余额
      Update 病人余额
      Set 费用余额 = Nvl(费用余额, 0) - Nvl(c_费用.实收金额, 0)
      Where 病人id = Nvl(n_病人id, 0) And 性质 = 1 And 类型 = 1
      Returning 费用余额 Into n_返回额;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 性质, 类型, 费用余额, 预交余额)
        Values
          (n_病人id, 1, 1, -1 * Nvl(c_费用.实收金额, 0), 0);
        n_返回额 := Nvl(c_费用.实收金额, 0);
      End If;
      If Nvl(n_返回额, 0) = 0 Then
        Delete 病人余额
        Where 病人id = Nvl(n_病人id, 0) And 性质 = 1 And 类型 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
      --病人未结费用
      Update 病人未结费用
      Set 金额 = Nvl(金额, 0) - Nvl(c_费用.实收金额, 0)
      Where 病人id = n_病人id And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And Nvl(病人科室id, 0) = Nvl(c_费用.病人科室id, 0) And
            Nvl(开单部门id, 0) = Nvl(c_费用.开单部门id, 0) And Nvl(执行部门id, 0) = Nvl(c_费用.执行部门id, 0) And 收入项目id + 0 = c_费用.收入项目id And
            来源途径 + 0 = 1;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人未结费用
          (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
        Values
          (n_病人id, Null, Null, c_费用.病人科室id, c_费用.开单部门id, c_费用.执行部门id, c_费用.收入项目id, 1, -1 * Nvl(c_费用.实收金额, 0));
      End If;
    End Loop;
    Delete 病人未结费用
    Where 病人id = n_病人id And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And Nvl(金额, 0) = 0 And 来源途径 + 0 = 1;
  End If;

  If n_记帐 = 0 Then
    --1.退费
    --病人挂号结算:现金和个人帐户部份
    If 非原样退结算_In Is Not Null Then
      --退款金额获取
      If Nvl(退费类型_In, 0) <> 0 Or Nvl(n_二次退费, 0) <> 0 Then
        --如果是单独退病历费,或者只退挂号费,先获取退费金额
        Begin
          --获取本次退款金额
          Select -1 * Sum(Nvl(实收金额, 0)) As 收款金额
          Into n_退款金额
          From 门诊费用记录
          Where NO = 单据号_In And 记录性质 = 4 And 记录状态 = 2 And 结帐id = n_销帐id;
        
        Exception
          When Others Then
            v_Err_Msg := '单据【' || 单据号_In || '】的' || Case Nvl(退费类型_In, 0)
                           When 1 Then
                            '挂号费用'
                           When 2 Then
                            '病历费'
                         End || '可能由于并发原因已经进行了退费或者单据不存在!';
            Raise Err_Item;
        End;
        Begin
          Select 冲预交
          Into n_退费金额
          From 病人预交记录
          Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id And Instr(',' || 非原样退结算_In || ',', ',' || 结算方式 || ',') = 0;
        Exception
          When Others Then
            n_退费金额 := 0;
        End;
      
        --a.允许的结算方式
      
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
           结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In, -n_退款金额,
                 n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
          From 病人预交记录
          Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id And Instr(',' || 非原样退结算_In || ',', ',' || 结算方式 || ',') = 0;
      
        If n_退费金额 = 0 Then
          --b.不允许的退现金
          If n_退款金额 <> 0 Then
            If v_退指定结算方式 Is Null Then
              --退给现金
              Begin
                Select 名称 Into v_退指定结算方式 From 结算方式 Where 性质 = 1;
              Exception
                When Others Then
                  v_退指定结算方式 := '现金';
              End;
            End If;
            Update 病人预交记录
            Set 冲预交 = 冲预交 + (-1 * n_退款金额), 交易说明 = Nvl(交易说明_In, 交易说明)
            Where 记录性质 = 4 And 记录状态 = 2 And 结帐id = n_销帐id And 结算方式 = v_退指定结算方式;
            If Sql%RowCount = 0 Then
              Insert Into 病人预交记录
                (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别,
                 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
                Select 病人预交记录_Id.Nextval, a.No, a.实际票号, a.记录性质, 2, a.病人id, a.主页id, a.科室id, a.摘要, v_退指定结算方式, d_Date,
                       操作员编号_In, 操作员姓名_In, -1 * n_退款金额, n_销帐id, n_组id, 预交类别, Decode(交易说明_In, Null, 卡类别id, Null), 结算卡序号,
                       Decode(交易说明_In, Null, 卡号, Null), Decode(交易说明_In, Null, 交易流水号, Null), Nvl(交易说明_In, 交易说明), 合作单位, 4
                From 病人预交记录 A
                Where a.记录性质 = 4 And a.记录状态 = 1 And a.结帐id = n_结帐id And Rownum < 2;
            End If;
          End If;
        End If;
      Else
        --a.允许的结算方式原样退
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
           结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In, -冲预交,
                 n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
          From 病人预交记录
          Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id And Instr(',' || 非原样退结算_In || ',', ',' || 结算方式 || ',') = 0;
      
        --b.不允许的退现金
        Begin
          Select Sum(冲预交)
          Into n_退费金额
          From 病人预交记录
          Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id And Instr(',' || 非原样退结算_In || ',', ',' || 结算方式 || ',') > 0;
        Exception
          When Others Then
            n_退费金额 := 0;
        End;
        If n_退费金额 <> 0 Then
          If v_退指定结算方式 Is Null Then
            --退给现金
            Begin
              Select 结算方式
              Into v_退指定结算方式
              From 病人预交记录
              Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id And Instr(',' || 非原样退结算_In || ',', ',' || 结算方式 || ',') = 0;
            
            Exception
              When Others Then
                Begin
                  Select 名称 Into v_退指定结算方式 From 结算方式 Where 性质 = 1;
                Exception
                  When Others Then
                    v_退指定结算方式 := '现金';
                End;
            End;
          End If;
          Update 病人预交记录
          Set 冲预交 = 冲预交 + (-1 * n_退费金额), 交易说明 = Nvl(交易说明_In, 交易说明)
          Where 记录性质 = 4 And 记录状态 = 2 And 结帐id = n_销帐id And 结算方式 = v_退指定结算方式;
          If Sql%RowCount = 0 Then
            Insert Into 病人预交记录
              (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
               结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
              Select 病人预交记录_Id.Nextval, a.No, a.实际票号, a.记录性质, 2, a.病人id, a.主页id, a.科室id, a.摘要, v_退指定结算方式, d_Date,
                     操作员编号_In, 操作员姓名_In, -1 * n_退费金额, n_销帐id, n_组id, 预交类别, Decode(交易说明_In, Null, 卡类别id, Null), 结算卡序号,
                     Decode(交易说明_In, Null, 卡号, Null), Decode(交易说明_In, Null, 交易流水号, Null), Nvl(交易说明_In, 交易说明), 合作单位, 4
              From 病人预交记录 A
              Where a.记录性质 = 4 And a.记录状态 = 1 And a.结帐id = n_结帐id And Rownum < 2;
          End If;
        End If;
      End If;
    Else
      --退款金额获取
      If Nvl(退费类型_In, 0) <> 0 Or Nvl(n_二次退费, 0) <> 0 Then
        --如果是单独退病历费,或者只退挂号费,先获取退费金额
        Begin
          --获取本次退款金额
          Select -1 * Sum(Nvl(实收金额, 0)) As 收款金额
          Into n_退款金额
          From 门诊费用记录
          Where NO = 单据号_In And 记录性质 = 4 And 记录状态 = 2 And 结帐id = n_销帐id;
        Exception
          When Others Then
            v_Err_Msg := '单据【' || 单据号_In || '】的' || Case Nvl(退费类型_In, 0)
                           When 1 Then
                            '挂号费用'
                           When 2 Then
                            '病历费'
                         End || '可能由于并发原因已经进行了退费或者单据不存在!';
            Raise Err_Item;
        End;
      End If;
      If Nvl(n_二次退费, 0) = 0 And Nvl(退费类型_In, 0) = 0 Then
        --首次全退
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
           结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In, -1 * 冲预交,
                 n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
          From 病人预交记录
          Where 记录性质 = 4 And 记录状态 = 1 And 结帐id = n_结帐id;
      Else
        --二次退费,或者本次单退一部分
        --二次退费时,记录状态=3 ,首次部分退,记录状态为1
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
           结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In,
                 -1 * n_退款金额, n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
          From 病人预交记录
          Where 记录性质 = 4 And 记录状态 = Decode(Nvl(n_二次退费, 0), 0, 1, 3) And 结帐id = n_结帐id And 摘要 = '医保挂号' And 冲预交 = n_退款金额 And
                Rownum < 2;
        If Sql%RowCount = 0 Then
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In,
                   -1 * n_退款金额, n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
            From 病人预交记录
            Where 记录性质 = 4 And 记录状态 = Decode(Nvl(n_二次退费, 0), 0, 1, 3) And 结帐id = n_结帐id And 冲预交 = n_退款金额 And Rownum < 2;
        End If;
        If Sql%RowCount = 0 Then
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要, 结算方式, d_Date, 操作员编号_In, 操作员姓名_In,
                   -1 * n_退款金额, n_销帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
            From 病人预交记录
            Where 记录性质 = 4 And 记录状态 = Decode(Nvl(n_二次退费, 0), 0, 1, 3) And 结帐id = n_结帐id And Rownum < 2;
          If Sql%RowCount = 0 Then
            --部分退费,并且全部使用预交款缴费时才存在此种情况
            n_预交金额 := n_退款金额;
          End If;
        End If;
      
      End If;
    End If;
    --首次退费时,记录状态便调整为了3
    Update 病人预交记录
    Set 记录状态 = 3
    Where 记录性质 = 4 And 记录状态 = Decode(Nvl(n_二次退费, 0), 0, 1, 3) And 结帐id = n_结帐id;
  
    --冲预交 1-全退 2-部分退,部分退时当全部使用预交进行缴款
    If Nvl(退费类型_In, 0) = 0 Or (Nvl(退费类型_In, 0) <> 0 And n_预交金额 <> 0) Then
      --病人挂号结算:冲预交款部份
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
         结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, d_Date,
               操作员姓名_In, 操作员编号_In, -1 * Decode(Nvl(退费类型_In, 0) + Nvl(n_二次退费, 0), 0, 冲预交, n_预交金额), n_销帐id, n_组id, 预交类别,
               卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
        From 病人预交记录
        Where 记录性质 In (1, 11) And 结帐id = n_结帐id And Nvl(冲预交, 0) <> 0 And
              Rownum = Decode(Nvl(退费类型_In, 0) + Nvl(n_二次退费, 0), 0, Rownum, 1);
    End If;
  
    --处理病人预交余额
    For c_预交 In (Select 病人id, 预交类别, -1 * Sum(Nvl(冲预交, 0)) As 冲预交
                 From 病人预交记录
                 Where 记录性质 In (1, 11) And 结帐id = n_销帐id
                 Group By 病人id, 预交类别) Loop
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + Nvl(c_预交.冲预交, 0)
      Where 病人id = c_预交.病人id And 类型 = Nvl(c_预交.预交类别, 2) And 性质 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 预交余额, 性质, 类型)
        Values
          (c_预交.病人id, Nvl(c_预交.冲预交, 0), 1, Nvl(c_预交.预交类别, 2));
        n_返回值 := Nvl(c_预交.冲预交, 0);
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = c_预交.病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
      End If;
    End Loop;
  
    If 收回票据号_In Is Not Null Then
      --光退挂号费,不回收票据
      --退卡收回票据(可能上次挂号使用票据,不能收回)
      Begin
        --从最后一次打印的内容中取
        --81907
        Select ID
        Into n_打印id
        From (Select b.Id
               From 票据使用明细 A, 票据打印内容 B
               Where a.打印id = b.Id And a.性质 = 1 And a.原因 In (1, 3) And b.数据性质 = 4 And b.No = 单据号_In
               Order By a.使用时间 Desc)
        Where Rownum < 2;
      Exception
        When Others Then
          n_打印id := Null;
      End;
    
      --先收回原票据
      If n_打印id Is Not Null Then
        Begin
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
            Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, d_Date, 操作员姓名_In
            From 票据使用明细
            Where 打印id = n_打印id And 性质 = 1 And Instr(',' || 收回票据号_In || ',', ',' || 号码 || ',') > 0;
        Exception
          When Others Then
            Delete From 票据使用明细 Where 打印id = n_打印id And 性质 = 2 And 原因 = 2;
            Insert Into 票据使用明细
              (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
              Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, d_Date, 操作员姓名_In
              From 票据使用明细
              Where 打印id = n_打印id And 性质 = 1 And Instr(',' || 收回票据号_In || ',', ',' || 号码 || ',') > 0;
        End;
      End If;
    End If;
  End If;

  --单独退病历费用,不处理汇总记录
  --相关汇总表的处理

  --病人挂号汇总
  If Nvl(退费类型_In, 0) Not In (2, 3) Then
    Open c_Registinfo(3);
    Fetch c_Registinfo
      Into r_Registrow;
  
    If c_Registinfo%RowCount = 0 Then
      --只收病历费时无号别,不处理
      Close c_Registinfo;
    Else
    
      --需要确定是否预约挂号
      --1.如果是退预约挂号产生的挂号记录,则需要减已挂数和其中已接数
      --2.如果是正常挂号,则只减已挂数
    
      Begin
        Select Decode(预约, Null, 0, 0, 0, 1) Into n_预约挂号 From 病人挂号记录 Where NO = 单据号_In And Rownum = 1;
      Exception
        When Others Then
          n_预约挂号 := 0;
      End;
    
      Update 病人挂号汇总
      Set 已挂数 = Nvl(已挂数, 0) - 1, 其中已接收 = Nvl(其中已接收, 0) - n_预约挂号, 已约数 = Nvl(已约数, 0) - n_预约挂号
      Where 日期 = Trunc(r_Registrow.发生时间) And 科室id = r_Registrow.科室id And 项目id = r_Registrow.项目id And
            (号码 = r_Registrow.号码 Or 号码 Is Null);
    
      If Sql%RowCount = 0 Then
        Insert Into 病人挂号汇总
          (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已挂数, 其中已接收, 已约数)
        Values
          (Trunc(r_Registrow.发生时间), r_Registrow.科室id, r_Registrow.项目id, r_Registrow.医生姓名,
           Decode(r_Registrow.医生id, 0, Null, r_Registrow.医生id), r_Registrow.号码, -1, -1 * n_预约挂号, -1 * n_预约挂号);
      End If;
    
      If n_出诊记录id Is Not Null Then
        Update 临床出诊记录
        Set 已挂数 = Nvl(已挂数, 0) - 1, 其中已接收 = Nvl(其中已接收, 0) - n_预约挂号, 已约数 = Nvl(已约数, 0) - n_预约挂号
        Where ID = n_出诊记录id And Nvl(已约数, 0) > 0;
        Update 临床出诊序号控制 Set 挂号状态 = Null, 操作员姓名 = Null Where 记录id = n_出诊记录id And 序号 = n_序号;
      End If;
    
      Close c_Registinfo;
    End If;
  End If;

  If n_记帐 = 0 Then
    --人员缴款余额(包括个人帐户等的结算金额,不含退冲预交款)
    For r_Opermoney In c_Opermoney(n_销帐id) Loop
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) + (-1 * r_Opermoney.冲预交)
      Where 收款员 = 操作员姓名_In And 结算方式 = r_Opermoney.结算方式 And 性质 = 1
      Returning 余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (操作员姓名_In, r_Opermoney.结算方式, 1, -1 * r_Opermoney.冲预交);
        n_返回值 := r_Opermoney.冲预交;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 人员缴款余额
        Where 收款员 = 操作员姓名_In And 结算方式 = r_Opermoney.结算方式 And 性质 = 1 And Nvl(余额, 0) = 0;
      End If;
    End Loop;
  End If;
  If Nvl(退费类型_In, 0) Not In (2, 3) Then
    n_挂号生成队列 := Zl_To_Number(zl_GetSysParameter('排队叫号模式', 1113));
    If n_挂号生成队列 <> 0 Then
      n_分诊台签到排队 := Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113));
      If Nvl(n_分诊台签到排队, 0) = 0 Then
      
        --要删除队列
        For v_挂号 In (Select ID, 诊室, 执行部门id, 执行人 From 病人挂号记录 Where NO = 单据号_In) Loop
          Zl_排队叫号队列_Delete(v_挂号.执行部门id, v_挂号.Id);
        End Loop;
      End If;
    End If;
  
    --医保产生的就诊登记记录
    Begin
      Select 病人id, 发生时间 Into n_就诊病人id, d_就诊时间 From 病人挂号记录 Where NO = 单据号_In;
      Delete From 就诊登记记录 Where 病人id = n_就诊病人id And 就诊时间 = d_就诊时间 And 主页id Is Null;
    Exception
      When Others Then
        Null;
    End;
  
    --病人挂号记录
    Select 病人挂号记录_Id.Nextval Into n_挂号id From Dual;
  
    Update 病人挂号记录 Set 记录状态 = 3 Where NO = 单据号_In And 记录性质 = 1 And 记录状态 = 1;
    If Sql%NotFound Then
      v_Err_Msg := '挂号单【' || 单据号_In || '】不存在或由于并发原因已经被退号';
      Raise Err_Item;
    End If;
    Insert Into 病人挂号记录
      (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 操作员编号, 操作员姓名,
       复诊, 号序, 社区, 预约, 摘要, 预约方式, 接收人, 接收时间, 交易流水号, 交易说明, 合作单位, 险类, 医疗付款方式)
      Select n_挂号id, NO, 记录性质, 2, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, d_Date, 发生时间,
             操作员编号_In, 操作员姓名_In, 复诊, 号序, 社区, 预约, Nvl(摘要_In, 摘要) As 摘要, 预约方式, 接收人, 接收时间, 交易流水号, 交易说明, 合作单位, 险类, 医疗付款方式
      From 病人挂号记录
      Where NO = 单据号_In;
  End If;
  --消息推送
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 2, 单据号_In;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人挂号记录_Delete;
/

--105435:刘尔旋,2017-03-15,余额退款三方卡强制退现
Create Or Replace Procedure Zl_病人预交记录_Insert
(
  Id_In         病人预交记录.Id%Type,
  单据号_In     病人预交记录.No%Type,
  票据号_In     票据使用明细.号码%Type,
  病人id_In     病人预交记录.病人id%Type,
  主页id_In     病人预交记录.主页id%Type,
  科室id_In     病人预交记录.科室id%Type,
  金额_In       病人预交记录.金额%Type,
  结算方式_In   病人预交记录.结算方式%Type,
  结算号码_In   病人预交记录.结算号码%Type,
  缴款单位_In   病人预交记录.缴款单位%Type,
  单位开户行_In 病人预交记录.单位开户行%Type,
  单位帐号_In   病人预交记录.单位帐号%Type,
  摘要_In       病人预交记录.摘要%Type,
  操作员编号_In 病人预交记录.操作员编号%Type,
  操作员姓名_In 病人预交记录.操作员姓名%Type,
  领用id_In     票据使用明细.领用id%Type,
  预交类别_In   病人预交记录.预交类别%Type := Null,
  卡类别id_In   病人预交记录.卡类别id%Type := Null,
  结算卡序号_In 病人预交记录.结算卡序号%Type := Null,
  卡号_In       病人预交记录.卡号%Type := Null,
  交易流水号_In 病人预交记录.交易流水号%Type := Null,
  交易说明_In   病人预交记录.交易说明%Type := Null,
  合作单位_In   病人预交记录.合作单位%Type := Null,
  收款时间_In   病人预交记录.收款时间%Type := Null,
  操作类型_In   Integer := 0,
  结帐id_In     病人预交记录.结帐id%Type := Null,
  结算性质_In   病人预交记录.结算性质%Type := Null,
  退款方式_In   Number := 0,
  强制退现_In   Number := 0
) As
  ----------------------------------------------
  --操作类型_In:0-正常缴预交;1-存为划价单;3-余额退款
  --结帐ID_IN:>0时,表示某次结帐时,同步产生的预交记录
  --退款方式_In;0-提示;1-禁止；2-忽略

  v_Err_Msg Varchar2(200);
  n_Err_Num Number;
  Err_Item Exception;

  v_性质     结算方式.性质%Type;
  v_打印id   票据打印内容.Id%Type;
  v_担保     病人信息.担保性质%Type;
  v_Date     Date;
  n_返回值   病人余额.预交余额%Type;
  n_组id     财务缴款分组.Id%Type;
  n_病人余额 病人余额.预交余额%Type;
  n_三方预交 病人余额.预交余额%Type;
Begin
  v_Date := 收款时间_In;
  If v_Date Is Null Then
    Select Sysdate Into v_Date From Dual;
  End If;
  n_组id := Zl_Get组id(操作员姓名_In);

  --插入预交缴款记录
  Insert Into 病人预交记录
    (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 摘要, 缴款组id, 预交类别,
     卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结帐id, 冲预交, 结算性质)
  Values
    (Id_In, 单据号_In, 票据号_In, 1, Decode(操作类型_In, 1, 0, 1), 病人id_In, Decode(主页id_In, 0, Null, 主页id_In),
     Decode(科室id_In, 0, Null, 科室id_In), 金额_In, 结算方式_In, 结算号码_In, v_Date, 缴款单位_In, 单位开户行_In, 单位帐号_In, 操作员编号_In, 操作员姓名_In,
     摘要_In, n_组id, 预交类别_In, 卡类别id_In, 结算卡序号_In, 卡号_In, 交易流水号_In, 交易说明_In, 合作单位_In, 结帐id_In,
     Decode(结帐id_In, Null, Null, 0), 结算性质_In);
  If 操作类型_In = 1 Then
    --暂不处理汇总表
    Return;
  End If;

  --处理票据
  If 票据号_In Is Not Null Then
    Select 票据打印内容_Id.Nextval Into v_打印id From Dual;
  
    --发出票据
    Insert Into 票据打印内容 (ID, 数据性质, NO) Values (v_打印id, 2, 单据号_In);
  
    Insert Into 票据使用明细
      (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
    Values
      (票据使用明细_Id.Nextval, 2, 票据号_In, 1, 1, 领用id_In, v_打印id, v_Date, 操作员姓名_In);
  
    --状态改动
    Update 票据领用记录
    Set 当前号码 = 票据号_In, 剩余数量 = Decode(Sign(剩余数量 - 1), -1, 0, 剩余数量 - 1), 使用时间 = Sysdate
    Where ID = Nvl(领用id_In, 0);
  End If;

  --相关汇总表处理

  --病人余额(预交余额现收)
  Begin
    Select 性质 Into v_性质 From 结算方式 Where 名称 = 结算方式_In;
  Exception
    When Others Then
      Null;
  End;
  If Nvl(v_性质, 1) <> 5 Then
    Update 病人余额
    Set 预交余额 = Nvl(预交余额, 0) + 金额_In
    Where 性质 = 1 And 病人id = 病人id_In And Nvl(类型, 0) = Nvl(预交类别_In, 0)
    Returning 预交余额 Into n_返回值;
    If Sql%RowCount = 0 Then
      Insert Into 病人余额
        (病人id, 性质, 类型, 预交余额, 费用余额)
      Values
        (病人id_In, 1, Nvl(预交类别_In, 0), 金额_In, 0);
      n_返回值 := 金额_In;
    End If;
    If Nvl(金额_In, 0) = 0 Then
      Delete From 病人余额 Where 病人id = 病人id_In And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
    End If;
  End If;

  If 金额_In < 0 Then
    Begin
      Select Nvl(预交余额, 0) - Nvl(费用余额, 0)
      Into n_病人余额
      From 病人余额
      Where 性质 = 1 And 病人id = 病人id_In And Nvl(类型, 0) = Nvl(预交类别_In, 0);
    Exception
      When Others Then
        Null;
    End;
    --余额退款要考虑三方预交是否支持退现
    If 操作类型_In = 3 And Nvl(强制退现_In, 0) = 0 Then
      For c_三方预交 In (Select a.预交id, a.预交类别, a.卡类别id, a.结算卡序号 As 消费接口id, Nvl(b.编码, c.编号) As 编码, Nvl(b.名称, c.名称) As 名称,
                            Decode(b.编码, Null, c.是否全退, b.是否全退) As 是否全退, Decode(b.编码, Null, c.是否退现, b.是否退现) As 是否退现, a.卡号,
                            a.交易流水号, a.交易说明, a.预交余额
                     From (Select a.预交类别, Nvl(a.卡类别id, 0) As 卡类别id, Nvl(a.结算卡序号, 0) As 结算卡序号, a.卡号, a.交易流水号, a.交易说明,
                                   Max(Decode(Sign(金额), -1, Decode(a.记录状态, 1, 0, 2, 0, ID), ID)) As 预交id,
                                   Nvl(Sum(金额), 0) - Nvl(Sum(Nvl(冲预交, 0)), 0) As 预交余额
                            From 病人预交记录 A
                            Where a.病人id = 病人id_In And (Nvl(a.结算卡序号, 0) <> 0 Or Nvl(卡类别id, 0) <> 0)
                            Group By a.预交类别, Nvl(a.卡类别id, 0), Nvl(a.结算卡序号, 0), a.卡号, a.交易流水号, a.交易说明
                            Having Nvl(Sum(金额), 0) - Nvl(Sum(Nvl(冲预交, 0)), 0) <> 0) A, 医疗卡类别 B, 卡消费接口目录 C
                     Where a.预交类别 = Nvl(预交类别_In, 0) And a.卡类别id = b.Id(+) And a.结算卡序号 = c.编号(+) And Nvl(a.预交余额, 0) <> 0
                     Order By 编码, a.卡号, a.交易流水号, a.交易说明) Loop
      
        If Instr(',7,8,', ',' || v_性质 || ',') = 0 And Nvl(c_三方预交.是否退现, 0) = 0 And Nvl(c_三方预交.预交余额, 0) > 0 Then
          n_三方预交 := Nvl(n_三方预交, 0) + Nvl(c_三方预交.预交余额, 0);
        Elsif Instr(',7,8,', ',' || v_性质 || ',') > 0 Then
          If Nvl(c_三方预交.卡号, '0') = Nvl(卡号_In, '0') And Nvl(c_三方预交.交易流水号, '0') = Nvl(交易流水号_In, '0') And
             Nvl(c_三方预交.交易说明, '0') = Nvl(交易说明_In, '0') Then
            n_三方预交 := Nvl(n_三方预交, 0) + Nvl(c_三方预交.预交余额, 0);
          End If;
        End If;
      End Loop;
    End If;
  
    If Instr(',7,8,', ',' || v_性质 || ',') > 0 And Nvl(n_三方预交, 0) < 0 And 操作类型_In = 3 Then
      n_Err_Num := -20101;
      v_Err_Msg := '退款金额大于病人三方预交金额，不能继续！';
      Raise Err_Item;
    Elsif Nvl(n_病人余额, 0) < 0 And 退款方式_In <> 2 Then
      n_Err_Num := -20101;
      v_Err_Msg := '退款金额大于病人剩余预交余额，不能继续！';
      If 退款方式_In = 0 Then
        n_Err_Num := -20111;
        v_Err_Msg := '退款金额大于病人剩余预交余额，是否忽略？';
      End If;
      Raise Err_Item;
    Elsif Instr(',7,8,', ',' || v_性质 || ',') = 0 And Nvl(n_病人余额, 0) - Nvl(n_三方预交, 0) < 0 And 操作类型_In = 3 And
          退款方式_In <> 2 Then
      n_Err_Num := -20101;
      v_Err_Msg := '退款金额大于病人剩余预交余额，不能继续！';
      If 退款方式_In = 0 Then
        n_Err_Num := -20111;
        v_Err_Msg := '退款金额大于病人剩余预交余额，是否忽略？';
      End If;
      Raise Err_Item;
    End If;
  End If;

  --人员缴款余额(现收)
  Update 人员缴款余额
  Set 余额 = Nvl(余额, 0) + 金额_In
  Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = 结算方式_In
  Returning 余额 Into n_返回值;

  If Sql%RowCount = 0 Then
    Insert Into 人员缴款余额 (收款员, 结算方式, 性质, 余额) Values (操作员姓名_In, 结算方式_In, 1, 金额_In);
    n_返回值 := 金额_In;
  End If;
  If Nvl(n_返回值, 0) = 0 Then
    Delete From 人员缴款余额 Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = 结算方式_In And Nvl(余额, 0) = 0;
  End If;
  --对临时担保的处理
  Select Nvl(担保性质, 0) Into v_担保 From 病人信息 Where 病人id = 病人id_In;
  If v_担保 = 1 And Nvl(金额_In, 0) > 0 Then
    Update 病人信息
    Set 担保额 = Decode(Sign(Nvl(担保额, 0) - Nvl(金额_In, 0)), 1, Nvl(担保额, 0) - Nvl(金额_In, 0), Null),
        担保人 = Decode(Sign(Nvl(担保额, 0) - Nvl(金额_In, 0)), 1, 担保人, Null),
        担保性质 = Decode(Sign(Nvl(担保额, 0) - Nvl(金额_In, 0)), 1, 担保性质, Null)
    Where 病人id = 病人id_In;
  End If;
  If 操作类型_In <> 1 And 结帐id_In Is Null Then
    --消息推送;
    Begin
      Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
        Using 11, Id_In;
    Exception
      When Others Then
        Null;
    End;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(n_Err_Num, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人预交记录_Insert;
/

--106960:胡俊勇,2017-03-15,三方LIS报告
Create Or Replace Procedure Zl_医嘱报告内容_Insert
(
  医嘱id_In  In 病人医嘱记录.Id%Type,
  类型_In    In 医嘱报告内容.类型%Type,
  报告名_In  In 医嘱报告内容.报告名%Type,
  内容_In    In 医嘱报告内容.内容%Type,
  说明_In    In 医嘱报告内容.报告说明%Type,
  创建人_In  In 医嘱报告内容.创建人%Type,
  报告id_Out Out 医嘱报告内容.Id%Type
) Is
  v_人员姓名 医嘱报告内容.创建人%Type;
  n_Id       病人医嘱记录.Id%Type;
Begin
  If 创建人_In Is Null Then
    v_人员姓名 := User;
  Else
    v_人员姓名 := 创建人_In;
  End If;
  Select 医嘱报告内容_Id.Nextval Into n_Id From Dual;
  Insert Into 医嘱报告内容
    (ID, 类型, 报告名, 报告说明, 内容, 创建人, 创建时间)
  Values
    (n_Id, 类型_In, 报告名_In, 说明_In, 内容_In, v_人员姓名, Sysdate);
  Insert Into 病人医嘱报告 (医嘱id, 报告id) Values (医嘱id_In, n_Id);
  报告id_Out := n_Id;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_医嘱报告内容_Insert;
/

--106960:胡俊勇,2017-03-15,三方LIS报告
Create Or Replace Procedure Zl_医嘱报告内容_Update
(
  报告id_In In 医嘱报告内容.Id%Type,
  类型_In   In 医嘱报告内容.类型%Type,
  报告名_In In 医嘱报告内容.报告名%Type,
  内容_In   In 医嘱报告内容.内容%Type,
  说明_In   In 医嘱报告内容.报告说明%Type,
  创建人_In In 医嘱报告内容.创建人%Type
) Is
  v_人员姓名 医嘱报告内容.创建人%Type;
Begin
  If 创建人_In Is Null Then
    v_人员姓名 := User;
  Else
    v_人员姓名 := 创建人_In;
  End If;

  Update 医嘱报告内容
  Set 类型 = 类型_In, 报告名 = 报告名_In, 报告说明 = 说明_In, 内容 = 内容_In, 创建人 = v_人员姓名, 创建时间 = Sysdate
  Where ID = 报告id_In;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_医嘱报告内容_Update;
/

--106960:胡俊勇,2017-03-15,三方LIS报告
Create Or Replace Procedure Zl_医嘱报告内容_Delete
(
  报告id_In In 医嘱报告内容.Id%Type
) Is
Begin
  Delete 医嘱报告内容 Where ID = 报告id_In;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_医嘱报告内容_Delete;
/

--106960:胡俊勇,2017-03-15,三方LIS报告
--103022:李业庆,2017-3-22,供应商照片
Create Or Replace Procedure Zl_Lob_Append
(
  Tab_In     In Number,
  Key_In     In Varchar2,
  Txt_In     In Varchar2, --16进制的文件片段或文字片段
  Cls_In     In Number := 0, --是否清除原来的内容，第一片段传递时为1，以后为0
  Lobtype_In In Number := 0 --0-BLOB;1-CLOB
  --参数说明：
  --Tab_In：包含LOB的数据表
  --        0-病历标记图形;1-病历文件格式;2-病历文件图形;3-病历范文格式;4-病历范文图形;
  --        5/21-电子病历格式;6-电子病历图形;7-病历页面格式；8-电子病历附件;9-体温重叠标记
  --        10-临床路径文件,11-临床路径图标;14-人员证书记录;15-人员表;16-人员照片;
  --        19-部门扩展信息;20-人员扩展信息;22-医嘱报告内容;23-供应商照片
  --Key_In：数据记录的关键字
  --Txt_In：16进制的文件片段或文字片段
  --Cls_In：是否清除原来的内容，第一片段传递时为1，以后为0
  --Lobtype_In:--0-BLOB;1-CLOB
) Is
  l_Blob Blob;
  l_Clob Clob;
  t_Key  t_Strlist;

Begin
  If Tab_In = 0 Then
    If Cls_In = 1 Then
      Update 病历标记图形 Set 图形 = Empty_Blob() Where 编码 = Key_In;
    End If;
    Select 图形 Into l_Blob From 病历标记图形 Where 编码 = Key_In For Update;
  Elsif Tab_In = 1 Then
    If Cls_In = 1 Then
      Update 病历文件格式 Set 内容 = Empty_Blob() Where 文件id = To_Number(Key_In);
      If Sql%RowCount = 0 Then
        Insert Into 病历文件格式 (文件id, 内容) Values (To_Number(Key_In), Empty_Blob());
      End If;
    End If;
    Select 内容 Into l_Blob From 病历文件格式 Where 文件id = To_Number(Key_In) For Update;
  Elsif Tab_In = 2 Then
    If Cls_In = 1 Then
      Update 病历文件图形 Set 图形 = Empty_Blob() Where 对象id = To_Number(Key_In);
      If Sql%RowCount = 0 Then
        Insert Into 病历文件图形 (对象id, 图形) Values (To_Number(Key_In), Empty_Blob());
      End If;
    End If;
    Select 图形 Into l_Blob From 病历文件图形 Where 对象id = To_Number(Key_In) For Update;
  Elsif Tab_In = 3 Then
    If Cls_In = 1 Then
      Update 病历范文格式 Set 内容 = Empty_Blob() Where 文件id = To_Number(Key_In);
      If Sql%RowCount = 0 Then
        Insert Into 病历范文格式 (文件id, 内容) Values (To_Number(Key_In), Empty_Blob());
      End If;
    End If;
    Select 内容 Into l_Blob From 病历范文格式 Where 文件id = To_Number(Key_In) For Update;
  Elsif Tab_In = 4 Then
    If Cls_In = 1 Then
      Update 病历范文图形 Set 图形 = Empty_Blob() Where 对象id = To_Number(Key_In);
      If Sql%RowCount = 0 Then
        Insert Into 病历范文图形 (对象id, 图形) Values (To_Number(Key_In), Empty_Blob());
      End If;
    End If;
    Select 图形 Into l_Blob From 病历范文图形 Where 对象id = To_Number(Key_In) For Update;
  Elsif Tab_In = 5 Then
    If Cls_In = 1 Then
      Update 电子病历格式 Set 内容 = Empty_Blob() Where 文件id = To_Number(Key_In);
      If Sql%RowCount = 0 Then
        Insert Into 电子病历格式 (文件id, 内容) Values (To_Number(Key_In), Empty_Blob());
      End If;
    End If;
    Select 内容 Into l_Blob From 电子病历格式 Where 文件id = To_Number(Key_In) For Update;
  Elsif Tab_In = 6 Then
    If Cls_In = 1 Then
      Update 电子病历图形 Set 图形 = Empty_Blob() Where 对象id = To_Number(Key_In);
      If Sql%RowCount = 0 Then
        Insert Into 电子病历图形 (对象id, 图形) Values (To_Number(Key_In), Empty_Blob());
      End If;
    End If;
    Select 图形 Into l_Blob From 电子病历图形 Where 对象id = To_Number(Key_In) For Update;
  Elsif Tab_In = 7 Then
    If Cls_In = 1 Then
      Update 病历页面格式
      Set 图形 = Empty_Blob()
      Where 种类 = To_Number(Substr(Key_In, 1, 1)) And 编号 = Substr(Key_In, 3);
    End If;
    Select 图形
    Into l_Blob
    From 病历页面格式
    Where 种类 = To_Number(Substr(Key_In, 1, 1)) And 编号 = Substr(Key_In, 3)
    For Update;
  Elsif Tab_In = 8 Then
    If Cls_In = 1 Then
      Update 电子病历附件
      Set 内容 = Empty_Blob()
      Where 病历id = To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)) And 序号 = Substr(Key_In, Instr(Key_In, ',') + 1);
    End If;
    Select 内容
    Into l_Blob
    From 电子病历附件
    Where 病历id = To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)) And 序号 = Substr(Key_In, Instr(Key_In, ',') + 1)
    For Update;
  Elsif Tab_In = 9 Then
    If Cls_In = 1 Then
      Update 体温重叠标记 Set 标记图形 = Empty_Blob() Where 序号 = To_Number(Key_In);
    End If;
    Select 标记图形 Into l_Blob From 体温重叠标记 Where 序号 = To_Number(Key_In) For Update;
  Elsif Tab_In = 10 Then
    If Cls_In = 1 Then
      Update 临床路径文件
      Set 内容 = Empty_Blob()
      Where 路径id = To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)) And
            文件名 = Substr(Key_In, Instr(Key_In, ',') + 1);
    End If;
    Select 内容
    Into l_Blob
    From 临床路径文件
    Where 路径id = To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)) And 文件名 = Substr(Key_In, Instr(Key_In, ',') + 1)
    For Update;
  Elsif Tab_In = 11 Then
    If Cls_In = 1 Then
      Update 临床路径图标 Set 图标 = Empty_Blob() Where ID = To_Number(Key_In);
    End If;
    Select 图标 Into l_Blob From 临床路径图标 Where ID = To_Number(Key_In) For Update;
  Elsif Tab_In = 12 Then
    If Cls_In = 1 Then
      Update 病历页面格式
      Set 页眉文件 = Empty_Blob()
      Where 种类 = To_Number(Substr(Key_In, 1, 1)) And 编号 = Substr(Key_In, 3);
    End If;
    Select 页眉文件
    Into l_Blob
    From 病历页面格式
    Where 种类 = To_Number(Substr(Key_In, 1, 1)) And 编号 = Substr(Key_In, 3)
    For Update;
  Elsif Tab_In = 13 Then
    If Cls_In = 1 Then
      Update 病历页面格式
      Set 页脚文件 = Empty_Blob()
      Where 种类 = To_Number(Substr(Key_In, 1, 1)) And 编号 = Substr(Key_In, 3);
    End If;
    Select 页脚文件
    Into l_Blob
    From 病历页面格式
    Where 种类 = To_Number(Substr(Key_In, 1, 1)) And 编号 = Substr(Key_In, 3)
    For Update;
  Elsif Tab_In = 14 Then
    Select Column_Value Bulk Collect Into t_Key From Table(f_Str2list(Key_In));
    If Cls_In = 1 Then
      Update 人员证书记录 Set 签章信息 = Empty_Clob() Where 人员id = To_Number(t_Key(1)) And Certsn = t_Key(2);
    End If;
    Select 签章信息 Into l_Clob From 人员证书记录 Where 人员id = To_Number(t_Key(1)) And Certsn = t_Key(2) For Update;
  Elsif Tab_In = 15 Then
    If Cls_In = 1 Then
      Update 人员表 Set 签名图片 = Empty_Blob() Where ID = To_Number(Key_In);
    End If;
    Select 签名图片 Into l_Blob From 人员表 Where ID = To_Number(Key_In) For Update;
    Update 人员表 Set 最后修改时间 = Sysdate Where ID = To_Number(Key_In);
  Elsif Tab_In = 16 Then
    If Cls_In = 1 Then
      Update 人员照片 Set 照片 = Empty_Blob() Where 人员id = To_Number(Key_In);
      If Sql%RowCount = 0 Then
        Insert Into 人员照片 (人员id, 照片) Values (To_Number(Key_In), Empty_Blob());
      End If;
    End If;
    Select 照片 Into l_Blob From 人员照片 Where 人员id = To_Number(Key_In) For Update;
    Update 人员表 Set 最后修改时间 = Sysdate Where ID = To_Number(Key_In);
  Elsif Tab_In = 19 Then
    Select Column_Value Bulk Collect Into t_Key From Table(f_Str2list(Key_In));
    If Cls_In = 1 Then
      Update 部门扩展信息 Set 图片 = Empty_Blob() Where 部门id = To_Number(t_Key(1)) And 项目 = t_Key(2);
    End If;
    Select 图片 Into l_Blob From 部门扩展信息 Where 部门id = To_Number(t_Key(1)) And 项目 = t_Key(2) For Update;
    Update 部门表 Set 最后修改时间 = Sysdate Where ID = To_Number(t_Key(1));
  Elsif Tab_In = 20 Then
    Select Column_Value Bulk Collect Into t_Key From Table(f_Str2list(Key_In));
    If Cls_In = 1 Then
      Update 人员扩展信息 Set 图片 = Empty_Blob() Where 人员id = To_Number(t_Key(1)) And 项目 = t_Key(2);
    End If;
    Select 图片 Into l_Blob From 人员扩展信息 Where 人员id = To_Number(t_Key(1)) And 项目 = t_Key(2) For Update;
    Update 人员表 Set 最后修改时间 = Sysdate Where ID = To_Number(t_Key(1));
  Elsif Tab_In = 21 Then
    If Cls_In = 1 Then
      Update 电子病历格式 Set 文本内容 = Empty_Clob() Where 文件id = To_Number(Key_In);
      If Sql%RowCount = 0 Then
        Insert Into 电子病历格式 (文件id, 文本内容) Values (To_Number(Key_In), Empty_Clob());
      End If;
    End If;
    Select 文本内容 Into l_Clob From 电子病历格式 Where 文件id = To_Number(Key_In) For Update;
  Elsif Tab_In = 22 Then
    Select Column_Value Bulk Collect Into t_Key From Table(f_Str2list(Key_In));
    If Cls_In = 1 Then
      Update 医嘱报告内容 Set 内容 = Empty_Blob() Where ID = To_Number(t_Key(1));
    End If;
    Select 内容 Into l_Blob From 医嘱报告内容 Where ID = To_Number(t_Key(1)) For Update;
  Elsif Tab_In = 23 Then
    If To_Number(Substr(Key_In, Instr(Key_In, ',') + 1))=0 Then
      If Cls_In = 1 Then
        Update 供应商照片 Set 许可证号照片 = Empty_Blob() Where 供应商ID = To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1));
        If Sql%RowCount = 0 Then
          Insert Into 供应商照片 (供应商ID, 许可证号照片,执照号照片,授权号照片) Values (To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)), Empty_Blob(), Empty_Blob(), Empty_Blob());
        End If;
      End If;
      Select 许可证号照片 Into l_Blob From 供应商照片 Where 供应商ID =To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)) For Update;
    Elsif  To_Number(Substr(Key_In, Instr(Key_In, ',') + 1))=1 Then
      If Cls_In = 1 Then
        Update 供应商照片 Set 执照号照片 = Empty_Blob() Where 供应商ID = To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1));
        If Sql%RowCount = 0 Then
          Insert Into 供应商照片 (供应商ID, 许可证号照片,执照号照片,授权号照片) Values (To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)), Empty_Blob(), Empty_Blob(), Empty_Blob());
        End If;
      End If;
      Select 执照号照片 Into l_Blob From 供应商照片 Where 供应商ID =To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)) For Update;
    Elsif To_Number(Substr(Key_In, Instr(Key_In, ',') + 1))=2 Then
     If Cls_In = 1 Then
        Update 供应商照片 Set 授权号照片 = Empty_Blob() Where 供应商ID = To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1));
        If Sql%RowCount = 0 Then
          Insert Into 供应商照片 (供应商ID, 许可证号照片,执照号照片,授权号照片) Values (To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)), Empty_Blob(), Empty_Blob(), Empty_Blob());
        End If;
      End If;
      Select 授权号照片 Into l_Blob From 供应商照片 Where 供应商ID =To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)) For Update;
    End If;
  End If;

  If Lobtype_In = 1 Then
    Dbms_Lob.Writeappend(l_Clob, Length(Txt_In), Txt_In);
  Else
    Dbms_Lob.Writeappend(l_Blob, Length(Hextoraw(Txt_In)) / 2, Hextoraw(Txt_In));
  End If;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Lob_Append;
/

--106960:胡俊勇,2017-03-15,三方LIS报告
Create Or Replace Procedure Zl1_Datamove_Tag
(
  d_End            In Date,
  n_批次           In Number,
  n_System         In Number,
  n_预交剩余款上限 In 病人预交记录.金额%Type := 10 --当病人不存在未结费用，也不是在院病人时，允许未冲完的预交款在指定值以下的数据强制转出，避免大量呆帐未转出从而影响转出速度

  
) As
  --功能：标记待转出的数据
  --说明：为避免Undo表空间膨胀过大，分段提交
  d_Lastend Date; --最终转出截止时间（d_End为本批转出截止时间）

  --递归取消“一张预交款单据中的一部分被标记为待转出”的数据
  Procedure Datamove_Tag_Update
  (
    结帐id_In t_Numlist,
    d_End     In Date,
    n_批次    In Number
  ) As
  
    c_结帐id t_Numlist := t_Numlist();
    c_No     t_Strlist := t_Strlist();
  Begin
    --1.1一张预交单据被多个结帐ID冲了，找出其中的一部分被标记为待转出的数据，如：
    --   NO=A001 记录性质=11 结帐ID=10 待转出=1
    --   NO=A001 记录性质=11 结帐ID=11 待转出=NULL
    If 结帐id_In Is Null Then
      Select Distinct a.No
      Bulk Collect
      Into c_No
      From 病人预交记录 A
      Where a.记录性质 In (1, 11) And a.待转出 = n_批次 And Exists
       (Select 1 From 病人预交记录 Where NO = a.No And 记录性质 In (1, 11) And 待转出 Is Null);
    Else
      Select Distinct a.No
      Bulk Collect
      Into c_No
      From 病人预交记录 A
      Where a.结帐id In (Select /*+cardinality(b,10) */
                        Column_Value
                       From Table(结帐id_In) B) And a.记录性质 In (1, 11) And a.待转出 Is Null And Exists
       (Select 1 From 病人预交记录 Where NO = a.No And 记录性质 In (1, 11) And 待转出 + 0 = n_批次);
    End If;
  
    If c_No.Count = 0 Then
      Return;
    End If;
  
    --1.2取消标记
    Forall I In 1 .. c_No.Count
      Update 病人预交记录 Set 待转出 = Null Where NO = c_No(I) And 记录性质 In (1, 11);
  
    --------------------------------------------------------------------------------------------------------
    --2.1一个结帐ID冲了多张预交单据，找出其中的一部分被标记为待转出的数据，如：
    --   NO=A001 记录性质=11 结帐ID=20 待转出=1
    --   NO=A002 记录性质=11 结帐ID=20 待转出=NULL
    Select Distinct a.结帐id
    Bulk Collect
    Into c_结帐id
    From 病人预交记录 A
    Where a.No In (Select /*+cardinality(b,10) */
                    Column_Value
                   From Table(c_No) B) And a.记录性质 In (1, 11) And a.待转出 Is Null And a.收款时间 + 0 < d_End And Exists
     (Select 1 From 病人预交记录 Where 结帐id = a.结帐id And 待转出 + 0 = n_批次);
  
    If c_结帐id.Count = 0 Then
      Return;
    End If;
  
    --2.2取消标记(包括一次结帐的其他结算方式的记录)
    Forall I In 1 .. c_结帐id.Count
      Update 病人预交记录 Set 待转出 = Null Where 结帐id = c_结帐id(I);
  
    --递归调用
    Datamove_Tag_Update(c_结帐id, d_End, n_批次);
  End Datamove_Tag_Update;
Begin
  Select 本次最终日期 Into d_Lastend From zlDataMove Where 系统 = n_System And 组号 = 1;
  If d_Lastend Is Null Then
    Return;
  End If;
  --新加子查询注意性能优化，把能够将数据过滤到最小的条件放到最后，Exists类条件放前面

  --1.经济核算（费用,药品,收款和票据等）
  --冲销业务与原始业务的发生时间相同，登记时间不同，所以要按发生时间来查询.
  --以下情况，可能有多个结帐ID，或涉及多个费用单据，这些数据要一起转出或排除转出，否则影响后续判断是否结清
  --1.一张费用单据的一行费用或多行费用可能分多次结帐（有多个不同的结帐ID）
  --2.结帐作废后也可能分多次结清(一张单据多个不同的结帐ID)
  --3.结帐作废后可能与其他费用单据一起结(一张单据的多个结帐ID，涉及多个费用NO，这些NO可能之前结帐作废过，有其他结帐ID)
  --考虑到这情况的复杂性，为简化逻辑，提升查询性能，按病人ID来排除(该病人的结帐数据都不转出)

  Update /*+ rule*/ 病人预交记录 L
  Set 待转出 = n_批次
  Where 结帐id In
        (Select Distinct a.结帐id --1.门诊收费和挂号的收费结算记录
         From 门诊费用记录 A
         Where (a.记录状态 In (1, 2) Or a.记录状态 = 3 And Not Exists
                (Select 1
                 From 门诊费用记录 B
                 Where a.No = b.No And a.记录性质 = b.记录性质 And b.记录状态 = 2 And b.登记时间 >= d_Lastend)) And a.待转出 Is Null And
               a.记录性质 In (1, 4) And a.发生时间 < d_End
         Union All
         Select Distinct b.结算id --2.医保补结算(没有发生时间字段,作废记录的登记时间不同，为了把收费和作废的一次性转出，所以要连接B表)
         From 费用补充记录 A, 费用补充记录 B
         Where a.待转出 Is Null And a.No = b.No And a.记录性质 = b.记录性质 And a.登记时间 < d_End
         Union All
         Select Distinct a.结帐id --3.就诊卡的收费结算记录(排除之后退卡费的,一张单据中只要其中一行退了)
         From 住院费用记录 A
         Where (a.记录状态 In (1, 2) Or a.记录状态 = 3 And Not Exists
                (Select 1
                 From 住院费用记录 B
                 Where a.No = b.No And a.记录性质 = b.记录性质 And b.记录状态 = 2 And b.登记时间 >= d_Lastend)) And a.待转出 Is Null And
               a.记帐费用 = 0 And a.记录性质 = 5 And a.发生时间 < d_End
         Union All --4.住院记帐费用的结帐结算记录
         Select 结帐id
         From (With Settle As (Select Distinct c.结帐id
                               From (Select Distinct b.No, b.序号, Mod(b.记录性质, 10) As 记录性质
                                      From (Select Distinct b.Id
                                             From 病人结帐记录 A, 病人结帐记录 B --作废的结帐单的收费时间可能在指定时间之后，所以要连接B表
                                             Where (a.记录状态 In (1, 2) Or a.记录状态 = 3 And Not Exists
                                                    (Select 1
                                                     From 病人结帐记录 C
                                                     Where a.No = c.No And c.记录状态 = 2 And c.收费时间 >= d_Lastend)) And
                                                   a.待转出 Is Null And a.No = b.No And (a.结帐类型 = 2 Or Nvl(a.结帐类型, 0) = 0) And
                                                   a.收费时间 < d_End) A, 住院费用记录 B
                                      Where a.Id = b.结帐id) B, 住院费用记录 C --通过C表找到这些费用单据的所有结帐ID一起转(可能在转出时间之后)
                               Where c.No = b.No And Mod(c.记录性质, 10) = b.记录性质 And c.序号 = b.序号)
                Select 结帐id
                From Settle
                Minus
                Select Distinct a.Id
                From 病人结帐记录 A,
                     (Select Distinct 病人id
                       From (Select c.病人id, c.No, Mod(c.记录性质, 10) As 记录性质, Nvl(Sum(c.实收金额), 0) As 实收金额,
                                     Nvl(Sum(c.结帐金额), 0) As 结帐金额
                              From 住院费用记录 C, Settle S
                              Where c.结帐id = s.结帐id
                              Group By c.No, Mod(c.记录性质, 10), c.病人id) C
                       Where c.实收金额 <> c.结帐金额 And Exists (Select 1 From 在院病人 F Where c.病人id = f.病人id) --出院病人没有结清的也转走（在需要时再抽回），否则排除的数据量太大
                             Or Exists (Select 1
                              From 住院费用记录 E, 病人结帐记录 S
                              Where e.No = c.No And Mod(e.记录性质, 10) = c.记录性质 And e.结帐id = s.Id And
                                    s.待转出 Is Null And s.收费时间 >= d_Lastend)) N --即使是在本批转出时间之后结清，只要不是在最终转出时间之后，就不排除

                
                Where a.病人id = n.病人id And (a.结帐类型 = 2 Or Nvl(a.结帐类型, 0) = 0))
                Union All --5.门诊记帐费用的结帐结算记录
                Select 结帐id
                From (With Settle As (Select Distinct c.结帐id
                                      From (Select Distinct b.No, b.序号, Mod(b.记录性质, 10) As 记录性质
                                             From (Select Distinct b.Id
                                                    From 病人结帐记录 A, 病人结帐记录 B
                                                    Where a.待转出 Is Null And a.No = b.No And (a.结帐类型 = 1 Or Nvl(a.结帐类型, 0) = 0) And
                                                          a.收费时间 < d_End) A, 门诊费用记录 B
                                             Where a.Id = b.结帐id) B, 门诊费用记录 C
                                      Where c.No = b.No And Mod(c.记录性质, 10) = b.记录性质 And c.序号 = b.序号)
                       Select 结帐id
                       From Settle
                       Minus
                       Select Distinct a.Id
                       From 病人结帐记录 A,
                            (Select Distinct c.病人id
                              From (Select c.病人id, c.No, Mod(c.记录性质, 10) As 记录性质, Nvl(Sum(c.实收金额), 0) As 实收金额,
                                            Nvl(Sum(c.结帐金额), 0) As 结帐金额
                                     From 门诊费用记录 C, Settle S
                                     Where c.结帐id = s.结帐id
                                     Group By c.No, Mod(c.记录性质, 10), c.病人id) C
                              Where c.实收金额 <> c.结帐金额 --门诊病人没有结清的不转走
                                    Or Exists (Select 1
                                     From 门诊费用记录 E, 病人结帐记录 S
                                     Where e.No = c.No And Mod(e.记录性质, 10) = c.记录性质 And e.结帐id = s.Id And
                                           s.待转出 Is Null And s.收费时间 >= d_Lastend)) N
                       Where a.病人id = n.病人id And (a.结帐类型 = 1 Or Nvl(a.结帐类型, 0) = 0))
         
         );

  --排除预交款未冲完的
  --为了降低逻辑的复杂性，不排除在转出时间之后发药或未发药的费用记录对应的结帐ID，将这种情况的结算数据和费用数据强制转走
  --因为前面的SQL查出的结帐ID可能不全是冲预交的(门诊收费和住院结帐补费等)，所以，需要单独一个SQL来排除
  Update /*+ rule*/ 病人预交记录
  Set 待转出 = Null
  Where 待转出 = n_批次 And
        结帐id In
        (Select Distinct d.结帐id --该单据相关的所有冲预交的结帐ID都不转出
         From 病人预交记录 D,
              (Select Distinct l.No
                From (Select l.No, l.病人id, l.预交类别, Nvl(Sum(l.金额), 0) As 金额, Nvl(Sum(l.冲预交), 0) As 冲预交,
                              Sum(Decode(l.待转出, Null, 1, 0)) As 未转出
                       From 病人预交记录 L --可能按结帐ID确认本次待转出的冲的只是剩余款，所以需要连接L表，查原始交预交的单据，以及记录性质为11的可能还有转出时间之后其他冲剩余款的结帐ID
                       Where l.记录性质 In (1, 11) And
                             l.No In
                             (Select Distinct p.No From 病人预交记录 P Where p.记录性质 In (1, 11) And p.待转出 = n_批次)
                       Group By l.No, l.病人id, l.预交类别) L --多次住院可以一次结清，所以，不能加主页ID
                Where 未转出 > 0 --只要该预交单据还有未转出的预交或冲预交记录，则不转出，避免转出一部分导致后续判断错误
                      Or
                      l.金额 <> l.冲预交 And
                      (Exists (Select 1
                               From 病人预交记录 E --剩的预交款，一般用负数交预交来退款（NO号不同），这种相当于是冲完了，不排除
                               Where e.病人id = l.病人id And e.预交类别 = l.预交类别 And e.记录性质 In (1, 11) And
                                     (e.待转出 = n_批次 Or e.待转出 Is Null And e.结帐id Is Null And e.记录性质 = 1 And 收款时间 < d_End)
                                Having Abs(Nvl(Sum(e.金额), 0) - Nvl(Sum(e.冲预交), 0)) > n_预交剩余款上限) --余额小于等于n不排除，与下面第3种结帐ID为空的要保持一致
                       Or l.预交类别 = 2 And Exists (Select 1 From 在院病人 E Where l.病人id = e.病人id) Or Exists
                       (Select 1
                        From 病人未结费用 E
                        Where l.病人id = e.病人id And (l.预交类别 = 1 And e.主页id Is Null Or l.预交类别 = 2 And e.主页id Is Not Null)))) N
         Where d.No = n.No And d.记录性质 In (1, 11));

  --单独处理3种结帐ID为空的预交记录
  --1.预交款没有使用就直接退了的记录(结帐ID为空)
  Update /*+ rule*/ 病人预交记录
  Set 待转出 = n_批次
  Where 记录性质 = 1 And
        NO In (Select a.No
               From 病人预交记录 A
               Where a.结帐id Is Null And a.记录性质 = 1 And a.记录状态 In (2, 3) And a.待转出 Is Null And a.收款时间 < d_End
               Group By a.No
               Having Sum(a.金额) = 0);

  --2.交预交款后退款的记录（结帐ID为空，记录状态为2）
  Update /*+ rule*/ 病人预交记录
  Set 待转出 = n_批次
  Where 结帐id Is Null And 记录性质 = 1 And 记录状态 = 2 And
        NO In (Select a.No From 病人预交记录 A Where a.记录性质 = 1 And a.记录状态 = 3 And a.待转出 = n_批次);

  --排除同一张预交款单据部分记录被标记为转出的,只要有不转出的，则整张单据都不转出
  --跟第2种有关联影响，所以要放在它之后执行
  --要影响第3种情况的判断，所以要放在它之前执行
  Datamove_Tag_Update(Null, d_End, n_批次);

  --3.预交款未用完时用交负数预交来退款(结帐ID为空，并且跟原始的冲预交的NO没有关联关系)
  --不加条件"金额 < 0"，因为存在预交款没有使用过，就直接用交负数预交来退款的情况
  Update /*+ rule*/ 病人预交记录 L
  Set 待转出 = n_批次
  Where Exists (Select 1
         From 病人预交记录 E
         Where e.病人id = l.病人id And e.预交类别 = l.预交类别 And e.记录性质 In (1, 11) And
               (e.待转出 = n_批次 Or e.待转出 Is Null And e.结帐id Is Null And e.记录性质 = 1 And 记录状态 = 1 And 收款时间 < d_End)
         Group By e.病人id
         Having Abs(Nvl(Sum(e.金额), 0) - Nvl(Sum(e.冲预交), 0)) <= n_预交剩余款上限) --余额小于等于n要转出，与前面“排除预交款未冲完的”要保持一致

       
        And Exists (Select 1
         From 病人预交记录 E
         Where e.病人id = l.病人id And e.预交类别 = l.预交类别 And e.记录性质 In (1, 11) And e.待转出 = n_批次) And
        待转出 Is Null And 结帐id Is Null And 记录性质 = 1 And 记录状态 = 1 And 收款时间 < d_End;

  Update Zldatamovelog
  Set 当前进度 = '(1/10)结算数据标记完成，正在标记费用数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  Update /*+ rule*/ 病人结帐记录
  Set 待转出 = n_批次
  Where ID In (Select 结帐id From 病人预交记录 Where 待转出 = n_批次);

  --结帐无结算的记录(为了提升性能，不判断费用，只要结了帐且无预交记录就当成是零费用结帐)
  Update /*+ rule*/ 病人结帐记录 L
  Set 待转出 = n_批次
  Where 收费时间 < d_End And 待转出 Is Null And Not Exists (Select 1 From 病人预交记录 P Where l.Id = p.结帐id);

  Update /*+ rule*/ 病人卡结算对照
  Set 待转出 = n_批次
  Where 预交id In (Select a.Id From 病人预交记录 A Where 待转出 = n_批次);

  Update /*+ rule*/ 病人卡结算记录
  Set 待转出 = n_批次
  Where ID In (Select 卡结算id From 病人卡结算对照 Where 待转出 = n_批次);

  Update /*+ rule*/ 三方结算交易
  Set 待转出 = n_批次
  Where 交易id In (Select a.Id From 病人预交记录 A Where 待转出 = n_批次);

  Update /*+ rule*/ 三方退款信息
  Set 待转出 = n_批次
  Where (记录id, 结帐id) In (Select a.Id, a.结帐id From 病人预交记录 A Where 待转出 = n_批次);

  --1.挂号费用异常数据
  --a.结帐ID为空（实收金额可能不为零）
  --b.结帐ID不为空，打折后实收金额为0（应收金额正负冲销）的挂号费用，没有挂号记录，也没有预交记录
  --按发生时间转出，因为收和退的发生时间相同，登记时间不同。
  Update /*+ rule*/ 门诊费用记录
  Set 待转出 = n_批次
  Where 待转出 Is Null And 发生时间 < d_End And 记录性质 = 4 And (实收金额 = 0 Or 结帐id Is Null);

  --2.直接收费的和结帐无结算（预交）记录的，Union不加all去掉重复以减少in的数量
  Update /*+ rule*/ 门诊费用记录
  Set 待转出 = n_批次
  Where 结帐id In
        (Select 结帐id From 病人预交记录 Where 待转出 = n_批次 Union Select ID From 病人结帐记录 Where 待转出 = n_批次);

  --3.没有结帐id的数据(按发生时间)
  --a.未结帐的划价记录
  --b.未收费的零费用
  --加条件"待转出 Is Null"是为了处理连续多次标记转出的情况
  Update /*+ rule*/ 门诊费用记录 A
  Set 待转出 = n_批次
  Where (记录状态 = 0 Or 记录性质 = 1 And 实收金额 = 0 And 结帐金额 = 0) And 结帐id Is Null And 待转出 Is Null And 发生时间 < d_End;

  --4.没有结帐id的数据(按发生时间)
  --未结帐的门诊记帐费用(赖账)，该病人没有预交余额，并且病人在最终转出时间之后无未结门诊记帐费用
  Update /*+ rule*/ 门诊费用记录 A
  Set 待转出 = n_批次
  Where Not Exists (Select 1
         From 病人预交记录 B
         Where b.病人id = a.病人id And b.待转出 Is Null And b.预交类别 = 1 And b.记录性质 In (1, 11) Having
          Nvl(Sum(b.金额), 0) <> Nvl(Sum(b.冲预交), 0)) And Not Exists
   (Select 1
         From 门诊费用记录 B
         Where a.病人id = b.病人id And b.记录性质 = 2 And b.结帐id Is Null And b.待转出 Is Null And b.登记时间 > = d_Lastend) And
        记录性质 = 2 And 结帐id Is Null And 待转出 Is Null And 发生时间 < d_End;

  --5.没有结帐id的数据(按发生时间)
  --冲销产生的记帐记录（记录状态为2），登记时间可能在当前指定转出时间之后，而原始记帐记录（记录状态为3），登记时间在指定转出时间之前。前后两者的发生时间是相同的。
  --a.未结帐的零记帐费用或打折后实收金额为零的（结帐模块参数没有勾选对零费用结帐）
  --b.结帐作废后，记帐单销帐的记录（结帐ID为空且记录状态为2的），记录状态为3的且有结帐ID的在最前面已转出.
  Update /*+ rule*/ 门诊费用记录 A
  Set 待转出 = n_批次
  Where (Exists (Select 1
                 From 门诊费用记录 B
                 Where a.No = b.No And a.记录性质 = b.记录性质 And a.序号 = b.序号 And b.记录状态 = 3 And b.结帐id Is Not Null And
                       b.待转出 + 0 = n_批次) And 记录状态 = 2 Or Exists
         (Select 1
          From 门诊费用记录 B
          Where a.No = b.No And a.记录性质 = b.记录性质 And a.序号 = b.序号 And b.结帐id Is Null
          Group By b.No, b.记录性质, b.序号
          Having Nvl(Sum(b.实收金额), 0) = 0)) And 记录性质 = 2 And 结帐id Is Null And 待转出 Is Null And 发生时间 < d_End;

  --6.有结帐id的零费用(按发生时间)
  --a.按费别打折后结帐金额为零的收费记录,
  --b.一张单据相同结帐ID的结帐金额之和为0(冲销后为零)
  --即使在转出时间之后发药的，也强制转出（为了减少逻辑复杂性，提高查询性能）
  Update /*+ rule*/ 门诊费用记录 A
  Set 待转出 = n_批次
  Where (结帐金额 = 0 Or Exists
         (Select 1 From 门诊费用记录 C Where a.结帐id = c.结帐id Group By c.结帐id, c.No Having Sum(c.结帐金额) = 0)) And Not Exists
   (Select 1 From 病人预交记录 B Where a.结帐id = b.结帐id And b.待转出 Is Null) And 记录性质 = 1 And 结帐id Is Not Null And
        待转出 Is Null And 发生时间 < d_End;

  Update /*+ rule*/ 医保结算明细
  Set 待转出 = n_批次
  Where 结帐id In (Select 结帐id From 病人预交记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 费用补充记录
  Set 待转出 = n_批次
  Where 结算id In (Select 结帐id From 病人预交记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 凭条打印记录
  Set 待转出 = n_批次
  Where (NO, 记录性质) In (Select NO, 记录性质 From 门诊费用记录 Where 待转出 = n_批次);

  --1.从预交记录读是为了取就诊卡直接收费的（无结帐ID）,再加结帐记录是为了取结帐无结算（预交）记录的
  Update /*+ rule*/ 住院费用记录
  Set 待转出 = n_批次
  Where 结帐id In
        (Select 结帐id From 病人预交记录 Where 待转出 = n_批次 Union Select ID From 病人结帐记录 Where 待转出 = n_批次);

  --2.没有结帐id的数据(按发生时间)
  --冲销产生的记帐记录（记录状态为2），原始记录和冲销记录的发生时间是相同的。
  --1)转出结帐作废后，记帐单销帐的记录（记录状态为2，且没有结帐ID，且(记录状态为3的有结帐ID的)在最前面已转出）
  --2)未结帐的零费用(已冲销的记帐单或打折后实收金额为零)
  --3)没有结帐ID的划价记录处理为转出
  Update /*+ rule*/ 住院费用记录 A
  Set 待转出 = n_批次
  Where ((Exists (Select 1
                  From 住院费用记录 B
                  Where a.No = b.No And a.记录性质 = b.记录性质 And a.序号 = b.序号 And b.记录状态 = 3 And b.结帐id Is Not Null And
                        b.待转出 + 0 = n_批次) And 记录状态 = 2 Or Exists
         (Select 1
           From 住院费用记录 B
           Where a.No = b.No And a.记录性质 = b.记录性质 And a.序号 = b.序号 And b.结帐id Is Null
           Group By b.No, b.记录性质, b.序号
           Having Nvl(Sum(b.实收金额), 0) = 0)) And a.记录性质 In (2, 3) Or a.记录状态 = 0) And a.结帐id Is Null And a.待转出 Is Null And
        a.发生时间 < d_End;

  --3.离院未结帐的（赖帐病人），因为是很久以前的这些数据，如果预交已冲完，则处理为要转出
  Update /*+ rule*/ 住院费用记录 A
  Set 待转出 = n_批次
  Where 待转出 Is Null And 结帐id Is Null And
        (病人id, 主页id) In (Select 病人id, 主页id
                         From 病案主页 C
                         Where 出院日期 < d_End And 待转出 Is Null And 数据转出 Is Null And Not Exists
                          (Select 1
                                From 病人预交记录 B
                                Where b.病人id = c.病人id And b.待转出 Is Null And b.预交类别 = 2 And b.记录性质 In (1, 11) Having
                                 Nvl(Sum(b.金额), 0) <> Nvl(Sum(b.冲预交), 0)));

  Update /*+ rule*/ 费用清单打印
  Set 待转出 = n_批次
  Where (NO, Mod(记录性质, 10), Decode(记录状态, 3, 1, 记录状态), 序号) In
        (Select NO, Mod(记录性质, 10) As 记录性质, Decode(记录状态, 3, 1, 记录状态) As 记录状态, 序号
         From 门诊费用记录
         Where 待转出 = n_批次
         Union
         Select NO, Mod(记录性质, 10) As 记录性质, Decode(记录状态, 3, 1, 记录状态) As 记录状态, 序号
         From 住院费用记录
         Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(2/10)费用数据标记完成，正在标记药品数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  Update /*+ Rule*/ 药品收发记录 A
  Set 待转出 = n_批次
  Where Rowid In (Select m.Rowid
                  From 药品收发记录 M, 门诊费用记录 E
                  Where m.费用id = e.Id And (e.记录性质 = 1 And m.单据 In (8, 24) Or e.记录性质 = 2 And m.单据 In (9, 25)) And
                        e.收费类别 In ('4', '5', '6', '7') And e.待转出 = n_批次
                  Union All
                  Select m.Rowid
                  From 药品收发记录 M, 住院费用记录 E
                  Where m.费用id = e.Id And m.单据 In (9, 10, 25, 26) And e.记录性质 = 2 And e.收费类别 In ('4', '5', '6', '7') And
                        e.待转出 = n_批次);

  Update /*+ rule*/ 收发记录补充信息
  Set 待转出 = n_批次
  Where 收发id In (Select ID From 药品收发记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 输液配药内容
  Set 待转出 = n_批次
  Where 收发id In (Select ID From 药品收发记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 输液配药记录
  Set 待转出 = n_批次
  Where ID In (Select 记录id From 输液配药内容 Where 待转出 = n_批次);

  Update /*+ rule*/ 输液配药附费
  Set 待转出 = n_批次
  Where 配药id In (Select ID From 输液配药记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 输液配药状态
  Set 待转出 = n_批次
  Where 配药id In (Select ID From 输液配药记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 药品留存计划
  Set 待转出 = n_批次
  Where 留存id In (Select ID From 药品收发记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 药品签名明细
  Set 待转出 = n_批次
  Where 收发id In (Select ID From 药品收发记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 药品签名记录
  Set 待转出 = n_批次
  Where ID In (Select 签名id From 药品签名明细 Where 待转出 = n_批次);

  Update /*+ rule*/ 药品收发门诊标志 A
  Set 待转出 = n_批次
  Where (a.处方号, a.单据) In (Select b.No, b.单据 From 药品收发记录 B Where b.待转出 = n_批次);

  Update /*+ rule*/ 药品收发住院标志
  Set 待转出 = n_批次
  Where 收发id In (Select ID From 药品收发记录 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(3/10)药品数据标记完成，正在标记缴款与票据数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  Update /*+ rule*/ 人员借款记录 Set 待转出 = n_批次 Where 待转出 Is Null And 借出时间 < d_End;

  Update /*+ rule*/ 人员收缴记录 Set 待转出 = n_批次 Where 待转出 Is Null And 登记时间 < d_End;

  Update /*+ rule*/ 人员收缴对照
  Set 待转出 = n_批次
  Where 收缴id In (Select ID From 人员收缴记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 人员收缴明细
  Set 待转出 = n_批次
  Where 收缴id In (Select ID From 人员收缴记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 人员收缴票据
  Set 待转出 = n_批次
  Where 收缴id In (Select ID From 人员收缴记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 人员暂存记录
  Set 待转出 = n_批次
  Where 收缴id In (Select ID From 人员收缴记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 人员暂存记录 Set 待转出 = n_批次 Where 待转出 Is Null And 记录性质 = 1 And 登记时间 < d_End;

  Update /*+ rule*/ 票据领用记录 A
  Set 待转出 = n_批次
  Where Not Exists (Select 1 From 票据使用明细 B Where b.领用id = a.Id And b.使用时间 >= d_Lastend) And 待转出 Is Null And 剩余数量 = 0 And
        登记时间 < d_End;

  Update /*+ rule*/ 票据使用明细
  Set 待转出 = n_批次
  Where 领用id In (Select ID From 票据领用记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 票据打印内容
  Set 待转出 = n_批次
  Where ID In (Select 打印id From 票据使用明细 Where 待转出 = n_批次);

  Update /*+ rule*/ 票据打印明细
  Set 待转出 = n_批次
  Where 使用id In (Select ID From 票据使用明细 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(4/10)缴款与票据数据标记完成，正在标记就诊及诊治数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  --2.就诊及诊治数据
  --不转出的条件：挂号费用未转出的，最终转出时间之后存在医嘱（这些医嘱因为时间没有到，不应转出），医嘱对应的费用未转出的
  --即使正在就诊(r.执行状态 <> 2 )的也强制转出(医生可能没有使用完成就诊功能)
  Update /*+ rule*/ 病人挂号记录 T
  Set 待转出 = n_批次
  Where Rowid In
        (Select Rowid
         From 病人挂号记录 R
         Where Not Exists (Select 1 From 门诊费用记录 A Where r.No = a.No And a.记录性质 = 4 And a.待转出 Is Null) And Not Exists
          (Select 1
                From 病人医嘱记录 A
                Where a.挂号单 = r.No And a.待转出 Is Null And a.病人来源 <> 4 And Nvl(a.停嘱时间, a.开嘱时间) >= d_Lastend) And
               Not Exists (Select 1
                From 门诊费用记录 E, 病人医嘱记录 A
                Where r.No = a.挂号单 And a.Id = e.医嘱序号 And a.病人来源 <> 4 And e.待转出 Is Null) And
               r.待转出 Is Null And r.发生时间 < d_End);

  --由于有一部分挂号数据未转出，所以，汇总表的数据可能与挂号数据不匹配
  Update 病人挂号汇总 Set 待转出 = n_批次 Where 待转出 Is Null And 日期 < d_End;
  Update /*+ rule*/ 病人转诊记录 Set 待转出 = n_批次 Where NO In (Select NO From 病人挂号记录 Where 待转出 = n_批次);

  --通过"住院费用记录"来查询，而不是"病人结帐记录",因为离院未结的赖帐病人也转出了费用
  --出院日期条件仍然需要，因为可能某次结帐转出了，但病人在最终转出截止时间之前并未出院(一次住院多次结帐)。
  --通过指定索引方式进行特殊优化（缺省采用"病案主页IX_出院日期"索引的效率太低）
  --不加"数据转出 is null"的条件，因为一次住院多次结帐时，如果跨不同的转出批次(转出截止时间)，该字段将会被更新多次。
  Update /*+ rule*/ 病案主页 P
  Set 待转出 = n_批次
  Where Not Exists
   (Select 1 From 住院费用记录 A Where a.病人id = p.病人id And a.主页id = p.主页id And a.待转出 Is Null) And 待转出 Is Null And
        出院日期 < d_Lastend And (病人id, 主页id) In (Select Distinct 病人id, 主页id From 住院费用记录 Where 待转出 = n_批次);

  --已出院，但没有费用的，也标记为转出，以便转出病历数据
  Update /*+ rule*/ 病案主页 P
  Set 待转出 = n_批次
  Where Not Exists (Select 1 From 住院费用记录 A Where a.病人id = p.病人id And a.主页id = p.主页id) And 待转出 Is Null And 数据转出 Is Null And
        出院日期 < d_End;

  Update /*+ rule*/ 病人过敏记录
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, ID
                         From 病人挂号记录
                         Where 待转出 = n_批次
                         Union All
                         Select 病人id, 主页id
                         From 病案主页
                         Where 待转出 = n_批次);

  Update /*+ rule*/ 病人诊断记录
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, ID
                         From 病人挂号记录
                         Where 待转出 = n_批次
                         Union All
                         Select 病人id, 主页id
                         From 病案主页
                         Where 待转出 = n_批次);

  Update /*+ rule*/ 病人手麻记录
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, ID
                         From 病人挂号记录
                         Where 待转出 = n_批次
                         Union All
                         Select 病人id, 主页id
                         From 病案主页
                         Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(5/10)就诊及诊治数据标记完成，正在标记护理数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  --3.护理数据
  Update /*+ rule*/ 病人护理文件
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, 主页id From 病案主页 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人护理数据
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 病人护理文件 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人护理明细
  Set 待转出 = n_批次
  Where 记录id In (Select ID From 病人护理数据 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人护理打印
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 病人护理文件 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人护理活动项目
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 病人护理文件 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人护理要素内容
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 病人护理文件 Where 待转出 = n_批次);
  Update /*+ rule*/ 产程要素内容
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 病人护理文件 Where 待转出 = n_批次);

  --老版护理系统数据
  Update /*+ rule*/ 病人护理记录
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, 主页id From 病案主页 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人护理内容
  Set 待转出 = n_批次
  Where 记录id In (Select ID From 病人护理记录 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(6/10)护理数据标记完成，正在标记病历数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  --4.病历数据  
  Update /*+ rule*/ 电子病历记录
  Set 待转出 = n_批次
  Where 病人来源 <> 4 And (病人id, 主页id) In (Select 病人id, ID
                                       From 病人挂号记录
                                       Where 待转出 = n_批次
                                       Union All
                                       Select 病人id, 主页id
                                       From 病案主页
                                       Where 待转出 = n_批次);

  --自登记类病人(无挂号单号)
  --病历ID可能重复是因为检验报告之类的，如肝功、肾功共打一张报告，即在病人医嘱报告表中，多个医嘱id对应同一报告ID
  --为提升性能，不从医嘱发送记录的发送时间查询，不采用精确的时间，因为直接登记的检验医嘱，一般开嘱时间与发送时间相差不大
  Update /*+ rule*/ 电子病历记录
  Set 待转出 = n_批次
  Where ID In (Select c.病历id
               From 病人医嘱记录 B, 病人医嘱报告 C
               Where c.医嘱id = b.Id And Nvl(b.主页id, 0) = 0 And b.挂号单 Is Null And b.相关id Is Null And b.待转出 Is Null And
                     b.开嘱时间 < d_End);

  Update /*+ rule*/ 电子病历附件
  Set 待转出 = n_批次
  Where 病历id In (Select ID From 电子病历记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 电子病历格式
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 电子病历记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 电子病历内容
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 电子病历记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 电子病历图形
  Set 待转出 = n_批次
  Where 对象id In (Select ID From 电子病历内容 Where 待转出 = n_批次 And 对象类型 = 5);

  Update /*+ rule*/ 病人医嘱报告
  Set 待转出 = n_批次
  Where 病历id In (Select ID From 电子病历记录 Where 病历种类 = 7 And 待转出 = n_批次);

  Update /*+ rule*/ 影像报告驳回
  Set 待转出 = n_批次
  Where (医嘱id, 病历id) In (Select 医嘱id, 病历id From 病人医嘱报告 Where 待转出 = n_批次);

  Update /*+ rule*/ 医嘱报告内容
  Set 待转出 = n_批次
  Where ID In (Select 报告id From 病人医嘱报告 Where 待转出 = n_批次);

  Update /*+ rule*/ 报告查阅记录
  Set 待转出 = n_批次
  Where 病历id In (Select ID From 电子病历记录 Where 病历种类 = 7 And 待转出 = n_批次);

  Update /*+ rule*/ 疾病申报记录
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 电子病历记录 Where 病历种类 = 5 And 待转出 = n_批次);

  Update /*+ rule*/ 疾病报告反馈
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 电子病历记录 Where 病历种类 = 5 And 待转出 = n_批次);

  Update /*+ rule*/ 疾病申报反馈
  Set 待转出 = n_批次
  Where 申报id In (Select ID From 电子病历记录 Where 病历种类 = 5 And 待转出 = n_批次);

  Update /*+ rule*/ 病人诊断记录
  Set 待转出 = n_批次
  Where 病历id In (Select ID From 电子病历记录 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(7/10)病历数据标记完成，正在标记临床路径数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  --5.临床路径
  Update /*+ rule*/ 病人临床路径
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, 主页id From 病案主页 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人合并路径
  Set 待转出 = n_批次
  Where 首要路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人合并路径评估
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人出径记录
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人路径执行
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人路径评估
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人路径变异
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人路径指标
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人路径医嘱
  Set 待转出 = n_批次
  Where 路径执行id In (Select ID From 病人路径执行 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(8/10)临床路径数据标记完成，正在标记医嘱数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  --6.医嘱，检验，检查
  Update /*+ rule*/ 病人医嘱记录
  Set 待转出 = n_批次
  Where 挂号单 In (Select NO From 病人挂号记录 Where 待转出 = n_批次) And 病人来源 <> 4;
  Update /*+ rule*/ 病人医嘱记录
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, 主页id From 病案主页 Where 待转出 = n_批次);

  --自登记类病人(无挂号单)，病人医嘱报告在前面转病历时已转出
  Update /*+ rule*/ 病人医嘱记录
  Set 待转出 = n_批次
  Where Rowid In (Select b.Rowid
                  From 病人医嘱记录 B, 病人医嘱报告 C
                  Where (b.相关id = c.医嘱id Or b.Id = c.医嘱id) And c.待转出 = n_批次);

  --自登记类病人(无挂号单)，没有医嘱报告
  Update /*+ rule*/ 病人医嘱记录 A
  Set 待转出 = n_批次
  Where Not Exists (Select 1 From 病人医嘱报告 B Where a.Id = b.医嘱id) And Not Exists
   (Select 1 From 病人医嘱报告 B Where a.相关id = b.医嘱id) And 挂号单 Is Null And 病人来源 = 3 And 待转出 Is Null And 开嘱时间 < d_End;

  Update /*+ rule*/ 病人医嘱计价
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人医嘱附费
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人医嘱附件
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 输血申请记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 输血检验结果
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人医嘱执行
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人医嘱打印
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 医嘱执行打印
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人诊断医嘱
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人诊断记录
  Set 待转出 = n_批次
  Where ID In (Select 诊断id From 病人诊断医嘱 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人医嘱状态
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 医嘱签名记录
  Set 待转出 = n_批次
  Where ID In (Select 签名id From 病人医嘱状态 Where 待转出 = n_批次 And 签名id Is Not Null);

  Update /*+ rule*/ 病人医嘱发送
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 诊疗单据打印
  Set 待转出 = n_批次
  Where (NO, 记录性质) In (Select NO, 记录性质 From 病人医嘱发送 Where 待转出 = n_批次);

  Update /*+ rule*/ 医嘱执行时间
  Set 待转出 = n_批次
  Where (医嘱id, 发送号) In (Select 医嘱id, 发送号 From 病人医嘱发送 Where 待转出 = n_批次);

  Update /*+ rule*/ 医嘱执行计价
  Set 待转出 = n_批次
  Where (医嘱id, 发送号) In (Select 医嘱id, 发送号 From 病人医嘱发送 Where 待转出 = n_批次);

  Update /*+ rule*/ 执行打印记录
  Set 待转出 = n_批次
  Where (医嘱id, 发送号) In (Select 医嘱id, 发送号 From 病人医嘱发送 Where 待转出 = n_批次);

  Update /*+ rule*/ 处方审查明细
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 处方审查记录
  Set 待转出 = n_批次
  Where ID In (Select 审方id From 处方审查明细 Where 待转出 = n_批次);

  Update /*+ rule*/ 处方审查结果
  Set 待转出 = n_批次
  Where 审方id In (Select ID From 处方审查记录 Where 待转出 = n_批次);

  Update /*+ rule*/ Ris检查预约
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 疾病阳性记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(9/10)医嘱数据标记完成，正在标记检查检验数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  Update /*+ rule*/ 影像检查记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 影像报告记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 影像报告操作记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 影像检查序列
  Set 待转出 = n_批次
  Where 检查uid In (Select 检查uid From 影像检查记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 影像检查图象
  Set 待转出 = n_批次
  Where 序列uid In (Select 序列uid From 影像检查序列 Where 待转出 = n_批次);

  Update /*+ rule*/ 影像申请单图像
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 影像收藏内容
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 影像危急值记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(10/10)影像数据标记完成，正在标记检验数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  Update /*+ rule*/ 检验标本记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验申请项目
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验项目分布
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验分析记录
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验质控记录
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 检验操作记录
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 检验签名记录
  Set 待转出 = n_批次
  Where 检验标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 检验图像结果
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 检验试剂记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验拒收记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 检验普通结果
  Set 待转出 = n_批次
  Where 检验标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验质控报告
  Set 待转出 = n_批次
  Where 结果id In (Select ID From 检验普通结果 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验药敏结果
  Set 待转出 = n_批次
  Where 细菌结果id In (Select ID From 检验普通结果 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验流水线标本
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验流水线指标
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);

  Commit;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl1_Datamove_Tag;
/

--106960:胡俊勇,2017-03-15,三方LIS报告
Create Or Replace Procedure Zl_Retu_Clinic
(
  n_Patiid In Number,
  v_Times  In Varchar2,
  n_Flag   In Number
) As
  --------------------------------------------
  --参数:n_Patiid,病人id
  --     v_Times,挂号单号或住院主页id（体检时，挂号单是体检单号）
  --     n_Flag,门诊或住院标志:0-门诊,1-住院,2-体检（此时，只有n_Patiid参数无效）
  --------------------------------------------
  Err_Item Exception;
  v_Err_Msg    Varchar2(100);
  n_System     Number(5);
  n_Opersystem Number(5);
  n_只读       Number(2);

  v_Table    Varchar2(100);
  v_Subtable Varchar2(100);
  v_Field    Varchar2(100);
  v_Subfield Varchar2(100);
  v_Sql      Varchar2(4000);
  v_Sqlchild Varchar2(4000);
  v_Fields   Varchar2(4000);

  --功能：获取表的字段字符串
  Function Getfields(v_Table In Varchar2) Return Varchar2 As
    v_Colstr Varchar2(4000);
  Begin
    Select f_List2str(Cast(Collect(Column_Name) As t_Strlist)) As Colsstr
    Into v_Colstr
    From (Select Column_Name From User_Tab_Columns Where Table_Name = v_Table Order By Column_Id);
  
    Return v_Colstr;
  End Getfields;

  --------------------------------------------
  --返回指定病人ID和主页的相关表的子过程
  --------------------------------------------
  Procedure Zl_Retu_Other
  (
    n_Pati_Id 病案主页.病人id%Type,
    n_Page_Id 病案主页.主页id%Type
  ) As
  
  Begin
  
    For R In (Select Column_Value From Table(f_Str2list('病人过敏记录,病人诊断记录,病人手麻记录'))) Loop
      v_Table  := r.Column_Value;
      v_Fields := Getfields(v_Table);
      v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                  Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where 病人id = :1 And 主页id = :2';
      Execute Immediate v_Sql
        Using n_Pati_Id, n_Page_Id;
    
      v_Sql := 'Delete From H' || v_Table || ' Where 病人id = :1 And 主页id = :2';
      Execute Immediate v_Sql
        Using n_Pati_Id, n_Page_Id;
    End Loop;
  End Zl_Retu_Other;

  --------------------------------------------
  --返回指定病人ID和主页的临床路径相关表的子过程
  --------------------------------------------
  Procedure Zl_Retu_Path
  (
    n_Pati_Id 病案主页.病人id%Type,
    n_Page_Id 病案主页.主页id%Type
  ) As
  Begin
    v_Table  := '病人临床路径';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where 病人id = :1 And 主页id = :2 ';
    Execute Immediate v_Sql
      Using n_Pati_Id, n_Page_Id;
  
    --病人路径医嘱，在病人医嘱记录转出之后执行
    For P In (Select ID As 路径记录id From H病人临床路径 Where 病人id = n_Pati_Id And 主页id = n_Page_Id) Loop
      For R In (Select Column_Value
                From Table(f_Str2list('病人路径执行,病人合并路径,病人路径评估,病人路径变异,病人路径指标,病人合并路径评估,病人出径记录'))) Loop
        v_Table := r.Column_Value;
        If v_Table = '病人合并路径' Then
          v_Field := '首要路径记录id';
        Else
          v_Field := '路径记录id';
        End If;
      
        v_Fields := Getfields(v_Table);
        v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                    Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where ' || v_Field || ' = :1';
        Execute Immediate v_Sql
          Using p.路径记录id;
      
        v_Sql := 'Delete H' || v_Table || ' Where ' || v_Field || ' = :1';
        Execute Immediate v_Sql
          Using p.路径记录id;
      End Loop;
    End Loop;
  
    Delete H病人临床路径 Where 病人id = n_Pati_Id And 主页id = n_Page_Id;
  End Zl_Retu_Path;

  --------------------------------------------
  --返回指定病人ID和主页的护理相关表的子过程
  --------------------------------------------
  Procedure Zl_Retu_Tend
  (
    n_Pati_Id 病案主页.病人id%Type,
    n_Page_Id 病案主页.主页id%Type
  ) As
  Begin
  
    v_Table  := '病人护理文件';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where 病人id = :1 And 主页id = :2 ';
    Execute Immediate v_Sql
      Using n_Pati_Id, n_Page_Id;
  
    For P In (Select ID As 文件id From H病人护理文件 Where 病人id = n_Pati_Id And 主页id = n_Page_Id) Loop
      For R In (Select Column_Value
                From Table(f_Str2list('病人护理数据,病人护理打印,病人护理活动项目,病人护理要素内容,产程要素内容'))) Loop
        v_Table  := r.Column_Value;
        v_Fields := Getfields(v_Table);
        v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                    Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where 文件id = :1';
        Execute Immediate v_Sql
          Using p.文件id;
      
        If v_Table = '病人护理数据' Then
          v_Fields := Getfields('病人护理明细');
          v_Sql    := 'Insert Into 病人护理明细(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                      ' From H病人护理明细 Where 记录id In (Select ID From H病人护理数据 Where 文件id = :1)';
          Execute Immediate v_Sql
            Using p.文件id;
        
          v_Sql := 'Delete H病人护理明细 Where 记录id In (Select ID From H病人护理数据 Where 文件id = :1)';
          Execute Immediate v_Sql
            Using p.文件id;
        End If;
      
        v_Sql := 'Delete H' || v_Table || ' Where 文件id = :1';
        Execute Immediate v_Sql
          Using p.文件id;
      End Loop;
    End Loop;
  
    Delete H病人护理文件 Where 病人id = n_Pati_Id And 主页id = n_Page_Id;
  
    --老版护理系统数据
    ------------------------------------------------------------------------
    v_Table  := '病人护理记录';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where 病人id = :1 And 主页id = :2 ';
    Execute Immediate v_Sql
      Using n_Pati_Id, n_Page_Id;
  
    For P In (Select ID From H病人护理记录 Where 病人id = n_Pati_Id And 主页id = n_Page_Id) Loop
      v_Table  := '病人护理内容';
      v_Fields := Getfields(v_Table);
      v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                  Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where 记录ID = :1';
      Execute Immediate v_Sql
        Using p.Id;
    
      v_Sql := 'Delete H' || v_Table || ' Where 记录ID = :1';
      Execute Immediate v_Sql
        Using p.Id;
    End Loop;
  
    Delete H病人护理记录 Where 病人id = n_Pati_Id And 主页id = n_Page_Id;
  End Zl_Retu_Tend;

  --------------------------------------------
  --返回指定ID的病人新版电子病历记录子过程
  --------------------------------------------
  Procedure Zl_Retu_Epr(n_Rec_Id H电子病历记录.Id%Type) As
    v_Field Varchar(100);
  Begin
    v_Table  := '电子病历记录';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where id = :1';
    Execute Immediate v_Sql
      Using n_Rec_Id;
  
    --病人诊断记录在Zl_Retu_Other中已转回（无病历ID外键）
    --影像报告驳回,病人医嘱报告,报告查阅记录,这几张表的数据在Zl_Retu_Order中转回医嘱后再处理
    For R In (Select Column_Value
              From Table(f_Str2list('电子病历附件,电子病历格式,电子病历内容,疾病申报记录,疾病报告反馈,疾病申报反馈'))) Loop
      v_Table := r.Column_Value;
      If v_Table = '电子病历附件' Then
        v_Field := '病历id';
      Else
        v_Field := '文件id';
      End If;
      v_Fields := Getfields(v_Table);
      v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                  Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where ' || v_Field || ' = :1';
      Execute Immediate v_Sql
        Using n_Rec_Id;
    
      If v_Table = '电子病历内容' Then
        v_Fields := Getfields('电子病历图形');
        v_Sql    := 'Insert Into 电子病历图形(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H电子病历图形 Where 对象id In (Select ID From H电子病历内容 Where 文件id = :1 And 对象类型 = 5)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        Delete H电子病历图形 Where 对象id In (Select ID From H电子病历内容 Where 文件id = n_Rec_Id And 对象类型 = 5);
      End If;
    
      v_Sql := 'Delete H' || v_Table || ' Where ' || v_Field || ' = :1';
      Execute Immediate v_Sql
        Using n_Rec_Id;
    End Loop;
  
    Delete H电子病历记录 Where ID = n_Rec_Id;
  End Zl_Retu_Epr;
  --------------------------------------------
  --返回指定ID的病人医嘱记录子过程，必须在病历、临床路径转出之后执行(病人医嘱报告,影像报告驳回，病人路径医嘱)
  --在Zl_Retu_Other中已转回了"病人诊断记录",转回"病人诊断医嘱"时不用再转
  --------------------------------------------
  Procedure Zl_Retu_Order(n_Rec_Id H病人医嘱记录.Id%Type) As
  Begin
    v_Table  := '病人医嘱记录';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where id = :1';
    Execute Immediate v_Sql
      Using n_Rec_Id;
  
    --以"医嘱ID,发送号"为外键的，都按医嘱ID直接转回，只需要排在"病人医嘱发送"之后即可
    --由于外键关系，"报告查阅记录"须在"病人医嘱报告"后面
    For P In (Select Column_Value
              From Table(f_Str2list('病人医嘱计价,病人医嘱状态,病人医嘱发送,病人医嘱附费,病人医嘱附件,病人医嘱执行,病人医嘱打印,输血申请记录,输血检验结果,' ||
                                     '医嘱执行打印,医嘱执行时间,医嘱执行计价,执行打印记录,病人诊断医嘱,病人路径医嘱,病人医嘱报告,报告查阅记录,' ||
                                     '影像报告驳回,影像报告记录,影像报告操作记录,影像检查记录,影像申请单图像,影像收藏内容,影像危急值记录,检验标本记录,检验试剂记录,检验拒收记录,RIS检查预约,疾病阳性记录'))) Loop
      v_Table := p.Column_Value;
      If Instr('病人路径医嘱', v_Table) > 0 Then
        v_Field := '病人医嘱ID';
      Else
        v_Field := '医嘱ID';
      End If;
    
      v_Fields := Getfields(v_Table);
      v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                  Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where ' || v_Field || ' = :1';
      If v_Table = '病人医嘱状态' Or v_Table = '病人医嘱报告' Then
        v_Sqlchild := v_Sql;
      Else
        Execute Immediate v_Sql
          Using n_Rec_Id;
      End If;
    
      If v_Table = '病人医嘱状态' Then
        v_Fields := Getfields('医嘱签名记录');
        v_Sql    := 'Insert Into 医嘱签名记录(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H医嘱签名记录 Where ID In (Select 签名id From H病人医嘱状态 Where 医嘱id = :1 And 签名id Is Not Null)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        Delete H医嘱签名记录
        Where ID In (Select 签名id From H病人医嘱状态 Where 医嘱id = n_Rec_Id And 签名id Is Not Null);
      
        Execute Immediate v_Sqlchild
          Using n_Rec_Id;
      
      Elsif v_Table = '病人医嘱发送' Then
        v_Fields := Getfields('诊疗单据打印');
        v_Sql    := 'Insert Into 诊疗单据打印(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H诊疗单据打印 Where (NO, 记录性质) In (Select NO, 记录性质 From H病人医嘱发送 Where 医嘱id = :1)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
        Delete H诊疗单据打印 Where (NO, 记录性质) In (Select NO, 记录性质 From H病人医嘱发送 Where 医嘱id = n_Rec_Id);
      
      Elsif v_Table = '影像检查记录' Then
        v_Fields := Getfields('影像检查序列');
        v_Sql    := 'Insert Into 影像检查序列(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H影像检查序列 Where 检查uid In (Select 检查uid From H影像检查记录 Where 医嘱id = :1)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        v_Fields := Getfields('影像检查图象');
        v_Sql    := 'Insert Into 影像检查图象(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H影像检查图象 Where 序列uid In (Select b.序列uid From H影像检查记录 A, H影像检查序列 B Where a.医嘱id = :1 And a.检查uid = b.检查uid)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        Delete H影像检查图象
        Where 序列uid In (Select b.序列uid
                        From H影像检查记录 A, H影像检查序列 B
                        Where a.医嘱id = n_Rec_Id And a.检查uid = b.检查uid);
        Delete H影像检查序列 Where 检查uid In (Select 检查uid From H影像检查记录 Where 医嘱id = n_Rec_Id);
      
      Elsif v_Table = '检验标本记录' Then
        For R In (Select Column_Value
                  From Table(f_Str2list('检验申请项目,检验分析记录,检验项目分布,检验质控记录,检验操作记录,检验签名记录,检验图像结果'))) Loop
          v_Subtable := r.Column_Value;
          If v_Subtable = '检验签名记录' Then
            v_Subfield := '检验标本ID';
          Else
            v_Subfield := '标本ID';
          End If;
          v_Fields := Getfields(v_Subtable);
          v_Sql    := 'Insert Into ' || v_Subtable || '(' || v_Fields || ') Select ' ||
                      Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Subtable || ' Where ' || v_Subfield ||
                      ' In (Select ID From H检验标本记录 Where 医嘱id = :1)';
          Execute Immediate v_Sql
            Using n_Rec_Id;
        
          v_Sql := 'Delete H' || v_Subtable || ' Where ' || v_Subfield ||
                   ' In (Select ID From H检验标本记录 Where 医嘱id = :1)';
          Execute Immediate v_Sql
            Using n_Rec_Id;
        End Loop;
      
        v_Fields := Getfields('检验普通结果');
        v_Sql    := 'Insert Into 检验普通结果(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = :1)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        v_Fields := Getfields('检验药敏结果');
        v_Sql    := 'Insert Into 检验药敏结果(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H检验药敏结果 Where 细菌结果id In (Select ID From H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = :1))';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        v_Fields := Getfields('检验质控报告');
        v_Sql    := 'Insert Into 检验质控报告(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H检验质控报告 Where 结果ID In (Select ID From H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = :1))';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        Delete H检验药敏结果
        Where 细菌结果id In
              (Select ID From H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = n_Rec_Id));
        Delete H检验质控报告
        Where 结果id In
              (Select ID From H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = n_Rec_Id));
      
        Delete H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = n_Rec_Id);
      Elsif v_Table = '病人医嘱报告' Then
        v_Fields := Getfields('医嘱报告内容');
        v_Sql    := 'Insert Into 医嘱报告内容(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H医嘱报告内容 Where ID In (Select 报告id From H病人医嘱报告 Where 医嘱id = :1 And 报告id Is Not Null)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        Delete H医嘱报告内容
        Where ID In (Select 报告id From H病人医嘱报告 Where 医嘱id = n_Rec_Id And 报告id Is Not Null);
      
        Execute Immediate v_Sqlchild
          Using n_Rec_Id;
      End If;
    
      v_Sql := 'Delete H' || v_Table || ' Where ' || v_Field || ' = :1';
      Execute Immediate v_Sql
        Using n_Rec_Id;
    End Loop;
  
    --手麻数据
    If n_Opersystem > 0 Then
      Execute Immediate 'Call zl24_Retu_Oper(:1)'
        Using n_Rec_Id;
    End If;
  
    Delete H病人医嘱记录 Where ID = n_Rec_Id;
  End Zl_Retu_Order;

  --------------------------------------------
  --以下为主程序体
  --------------------------------------------
Begin
  ----------------------------------------------------------------------------------------------------------
  --对基于视图的转储方案进行了只读判断.
  Select 编号 Into n_System From zlSystems Where Upper(所有者) = Zl_Owner And 编号 Like '1%';
  Begin
    Select Nvl(只读, 0) Into n_只读 From zlBakSpaces Where 系统 = n_System And 当前 = 1;
  Exception
    When Others Then
      v_Err_Msg := '[ZLSOFT]当前没有可用的历史数据空间,不能继续![ZLSOFT]';
      Raise Err_Item;
  End;
  If n_只读 = 1 Then
    v_Err_Msg := '[ZLSOFT]历史数据空间目前的状态为只读,不能继续![ZLSOFT]';
    Raise Err_Item;
  End If;

  --对基于视图的转储方案进行了只读判断.
  n_Opersystem := 0;
  Select 编号 Into n_Opersystem From zlSystems Where Upper(所有者) = Zl_Owner And 编号 Like '24%';
  If n_Opersystem > 0 Then
    Begin
      Select Nvl(只读, 0) Into n_只读 From zlBakSpaces Where 系统 = n_Opersystem And 当前 = 1;
    Exception
      When Others Then
        v_Err_Msg := '[ZLSOFT]当前没有可用的手麻子系统历史数据空间,不能继续![ZLSOFT]';
        Raise Err_Item;
    End;
    If n_只读 = 1 Then
      v_Err_Msg := '[ZLSOFT]手麻子系统历史数据空间目前的状态为只读,不能继续![ZLSOFT]';
      Raise Err_Item;
    End If;
  End If;

  --1.门诊病人，按挂号单抽回
  If n_Flag = 0 Then
    --抽回未结记帐费用
    Zl_Retu_Exes(n_Patiid, 8);
  
    v_Table  := '病人挂号记录';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where NO =:1 ';
    Execute Immediate v_Sql
      Using v_Times;
  
    For r_Other In (Select ID, 病人id From H病人挂号记录 Where NO = v_Times) Loop
      Zl_Retu_Other(r_Other.病人id, r_Other.Id);
    End Loop;
  
    For r_Epr In (Select /*+ Rule*/
                   b.Id
                  From H病人挂号记录 A, H电子病历记录 B
                  Where a.No = v_Times And a.病人id = n_Patiid And b.病人id = a.病人id And b.主页id = a.Id) Loop
      Zl_Retu_Epr(r_Epr.Id);
    End Loop;
  
    For r_Order In (Select ID From H病人医嘱记录 Where 病人来源 <> 4 And 病人id = n_Patiid And 挂号单 = v_Times) Loop
      Zl_Retu_Order(r_Order.Id);
    End Loop;
  
    --转诊记录
    v_Table  := '病人转诊记录';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where NO =:1';
    Execute Immediate v_Sql
      Using v_Times;
  
    Delete H病人转诊记录 Where NO = v_Times;
    Delete H病人挂号记录 Where NO = v_Times;
  
    --2.住院病人，按病人ID和主页ID抽回
  Elsif n_Flag = 1 Then
    --抽回未结记帐费用
    Zl_Retu_Exes(n_Patiid || ',' || v_Times, 8);
  
    Zl_Retu_Other(n_Patiid, To_Number(v_Times));
    Zl_Retu_Path(n_Patiid, To_Number(v_Times));
  
    --先转病历，再转医嘱（影像报告驳回，病人医嘱报告这类又有病历又有医嘱的子表，在医嘱转回后处理）
    For r_Epr In (Select ID From H电子病历记录 Where 病人id = n_Patiid And 主页id = To_Number(v_Times)) Loop
      Zl_Retu_Epr(r_Epr.Id);
    End Loop;
  
    Zl_Retu_Tend(n_Patiid, To_Number(v_Times));
  
    For r_Order In (Select ID From H病人医嘱记录 Where 病人id = n_Patiid And 主页id = To_Number(v_Times)) Loop
      Zl_Retu_Order(r_Order.Id);
    End Loop;
    Update 病案主页 Set 数据转出 = 0 Where 病人id = n_Patiid And 主页id = To_Number(v_Times);
  
    --3.体检病人
  Elsif n_Flag = 2 Then
    Zl_Retu_Other(n_Patiid, v_Times);
  
    For r_Cpr In (Select ID From H病人医嘱记录 Where 病人来源 = 4 And 挂号单 = v_Times) Loop
      Zl_Retu_Order(r_Cpr.Id);
    End Loop;
  
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, v_Err_Msg);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM || ':' || v_Sql);
End Zl_Retu_Clinic;
/

--106960:胡俊勇,2017-03-15,三方LIS报告
--103022:李业庆,2017-3-22,供应商照片
Create Or Replace Function Zl_Lob_Read
(
  Tab_In     In Number,
  Key_In     In Varchar2,
  Pos_In     In Number,
  Moved_In   In Number := 0,
  Lobtype_In In Number := 0
  --参数说明：
  --Tab_In：包含LOB的数据表
  --        0-病历标记图形;1-病历文件格式;2-病历文件图形;3-病历范文格式;4-病历范文图形;
  --        5-电子病历格式;6-电子病历图形;7-病历页面格式(图形);8-电子病历附件;9-体温重叠标记;
  --        10-临床路径文件;11-临床路径图标;12-病历页面格式(页眉文件);13-病历页面格式(页脚文件);
  --        14-人员证书记录;15-人员表;16-人员照片;19-部门扩展信息;20-人员扩展信息;22-医嘱报告内容;23-供应商照片
  --Key_In：数据记录的关键字
  --Pos_In：从0开始不断读取，直到返回为空
  --Moved_In: 0正常记录,1读取转储后备表记录
  --LobType_IN:0-BLOb,1-CLOB
) Return Varchar2 Is
  l_Blob   Blob;
  l_Clob   Clob;
  v_Buffer Varchar2(32767);
  n_Amount Number := 2000;
  n_Offset Number := 1;
  t_Key    t_Strlist;
Begin
  If Tab_In = 0 Then
    Select 图形 Into l_Blob From 病历标记图形 Where 编码 = Key_In;
  Elsif Tab_In = 1 Then
    Select 内容 Into l_Blob From 病历文件格式 Where 文件id = To_Number(Key_In);
  Elsif Tab_In = 2 Then
    Select 图形 Into l_Blob From 病历文件图形 Where 对象id = To_Number(Key_In);
  Elsif Tab_In = 3 Then
    Select 内容 Into l_Blob From 病历范文格式 Where 文件id = To_Number(Key_In);
  Elsif Tab_In = 4 Then
    Select 图形 Into l_Blob From 病历范文图形 Where 对象id = To_Number(Key_In);
  Elsif Tab_In = 5 Then
    If Moved_In = 0 Then
      Select 内容 Into l_Blob From 电子病历格式 Where 文件id = To_Number(Key_In);
    Else
      Select 内容 Into l_Blob From H电子病历格式 Where 文件id = To_Number(Key_In);
    End If;
  Elsif Tab_In = 6 Then
    If Moved_In = 0 Then
      Select 图形 Into l_Blob From 电子病历图形 Where 对象id = To_Number(Key_In);
    Else
      Select 图形 Into l_Blob From H电子病历图形 Where 对象id = To_Number(Key_In);
    End If;
  Elsif Tab_In = 7 Then
    Select 图形
    Into l_Blob
    From 病历页面格式
    Where 种类 = To_Number(Substr(Key_In, 1, 1)) And 编号 = Substr(Key_In, 3);
  Elsif Tab_In = 8 Then
    If Moved_In = 0 Then
      Select 内容
      Into l_Blob
      From 电子病历附件
      Where 病历id = To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)) And 序号 = Substr(Key_In, Instr(Key_In, ',') + 1);
    Else
      Select 内容
      Into l_Blob
      From H电子病历附件
      Where 病历id = To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)) And 序号 = Substr(Key_In, Instr(Key_In, ',') + 1);
    End If;
  Elsif Tab_In = 9 Then
    Select 标记图形 Into l_Blob From 体温重叠标记 Where 序号 = To_Number(Key_In);
  Elsif Tab_In = 10 Then
    Select 内容
    Into l_Blob
    From 临床路径文件
    Where 路径id = To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1)) And 文件名 = Substr(Key_In, Instr(Key_In, ',') + 1);
  Elsif Tab_In = 11 Then
    Select 图标 Into l_Blob From 临床路径图标 Where ID = To_Number(Key_In);
  Elsif Tab_In = 12 Then
    Select 页眉文件
    Into l_Blob
    From 病历页面格式
    Where 种类 = To_Number(Substr(Key_In, 1, 1)) And 编号 = Substr(Key_In, 3);
  Elsif Tab_In = 13 Then
    Select 页脚文件
    Into l_Blob
    From 病历页面格式
    Where 种类 = To_Number(Substr(Key_In, 1, 1)) And 编号 = Substr(Key_In, 3);
  Elsif Tab_In = 14 Then
    Select Column_Value Bulk Collect Into t_Key From Table(f_Str2list(Key_In));
    Select 签章信息 Into l_Clob From 人员证书记录 Where 人员id = To_Number(t_Key(1)) And Certsn = t_Key(2);
  Elsif Tab_In = 15 Then
    Select 签名图片 Into l_Blob From 人员表 Where ID = To_Number(Key_In);
  Elsif Tab_In = 16 Then
    Select 照片 Into l_Blob From 人员照片 Where 人员id = To_Number(Key_In);
  Elsif Tab_In = 19 Then
    Select Column_Value Bulk Collect Into t_Key From Table(f_Str2list(Key_In));
    Select 图片 Into l_Blob From 部门扩展信息 Where 部门id = To_Number(t_Key(1)) And 项目 = t_Key(2);
  Elsif Tab_In = 20 Then
    Select Column_Value Bulk Collect Into t_Key From Table(f_Str2list(Key_In));
    Select 图片 Into l_Blob From 人员扩展信息 Where 人员id = To_Number(t_Key(1)) And 项目 = t_Key(2);
  Elsif Tab_In = 22 Then
    Select Column_Value Bulk Collect Into t_Key From Table(f_Str2list(Key_In));
    Select 内容 Into l_Blob From 医嘱报告内容 Where ID = To_Number(Key_In);
  Elsif Tab_In = 23 Then
    If To_Number(Substr(Key_In, Instr(Key_In, ',') + 1))=0 Then
       Select 许可证号照片 Into l_Blob From 供应商照片 Where 供应商ID =To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1));
    Elsif  To_Number(Substr(Key_In, Instr(Key_In, ',') + 1))=1 Then
       Select 执照号照片 Into l_Blob From 供应商照片 Where 供应商ID =To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1));
    Elsif To_Number(Substr(Key_In, Instr(Key_In, ',') + 1))=2 Then
       Select 授权号照片 Into l_Blob From 供应商照片 Where 供应商ID =To_Number(Substr(Key_In, 1, Instr(Key_In, ',') - 1));
    End If;
  End If;

  n_Offset := n_Offset + Pos_In * n_Amount;
  If Lobtype_In = 1 Then
    If l_Clob Is Null Then
      v_Buffer := Null;
    Else
      Dbms_Lob.Read(l_Clob, n_Amount, n_Offset, v_Buffer);
    End If;
  Else
    If l_Blob Is Null Then
      v_Buffer := Null;
    Else
      Dbms_Lob.Read(l_Blob, n_Amount, n_Offset, v_Buffer);
    End If;
  End If;
  Return v_Buffer;
Exception
  When No_Data_Found Then
    Return Null;
End Zl_Lob_Read;
/

--106755:冉俊明,2017-03-14,作废的预交款单据不能再在消费环节使用。
Create Or Replace Procedure Zl_门诊收费结算_Modify
(
  操作类型_In      Number,
  病人id_In        门诊费用记录.病人id%Type,
  结帐id_In        病人预交记录.结帐id%Type,
  结算方式_In      Varchar2,
  冲预交_In        病人预交记录.冲预交%Type := Null,
  退支票额_In      病人预交记录.冲预交%Type := Null,
  卡类别id_In      病人预交记录.卡类别id%Type := Null,
  卡号_In          病人预交记录.卡号%Type := Null,
  交易流水号_In    病人预交记录.交易流水号%Type := Null,
  交易说明_In      病人预交记录.交易说明%Type := Null,
  缴款_In          病人预交记录.缴款%Type := Null,
  找补_In          病人预交记录.找补%Type := Null,
  误差金额_In      门诊费用记录.实收金额%Type := Null,
  完成结算_In      Number := 0,
  缺省结算方式_In  结算方式.名称%Type := Null,
  冲预交病人ids_In Varchar2 := Null
) As
  ------------------------------------------------------------------------------------------------------------------------------
  --功能:收费结算时,修改结算的相关信息
  --操作类型_In:
  --   0-普通收费方式:
  --     ①结算方式_IN:允许传入多个,格式为:"结算方式|结算金额|结算号码|结算摘要||.." ;也允许传入空.
  --     ②退支票额_In:如果涉及退支票,则传入本次的退支票额,非正常收费时,传入零
  --   1.三方卡结算:
  --     ①结算方式_IN:只能传入一个结算方式,但允许包含一些辅助信息,格式为:"结算方式|结算金额|结算号码|结算摘要"
  --     ②退支票额_In:传入零
  --     ③卡类别ID_IN,卡号_IN,交易流水号_IN,交易说明_In:需要传入
  --   2-医保结算(如果存在医保的结算,则要先删除原医保结算,后按新传入的更新)
  --     ①结算方式_IN:允许传入多个,格式为:结算方式|结算金额||.."
  --     ②退支票额_In:传入零
  --   3-消费卡结算:
  --     ①结算方式_IN:允许一次刷多张卡,格式为:卡类别ID|卡号|消费卡ID|消费金额||."  消费卡ID:为零时,根据卡号自动定位
  --     ②冲预交_In: 传入零
  --     ②退支票额_In:传入零
  -- 冲预交_In: 存在冲预交时,传入
  -- 误差金额_In:存在误差费时,传入
  -- 完成结算_In:1-完成收费;0-未完成收费
  -- 冲预交病人ids_In:多个用逗分分离,冲预交时有效(冲预交类别与业务操作保持一致),主要是使用家属的预交款
  ------------------------------------------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  v_结算内容      Varchar2(500);
  v_当前结算      Varchar2(50);
  v_卡号          病人医疗卡信息.卡号%Type;
  n_消费卡id      消费卡目录.Id%Type;
  n_卡类别id      病人预交记录.结算卡序号%Type;
  v_名称          Varchar2(100);
  n_自制卡        卡消费接口目录.自制卡%Type;
  n_序号          病人卡结算记录.序号%Type;
  n_Id            病人卡结算记录.Id%Type;
  n_预交id        病人预交记录.Id%Type;
  v_结算方式      病人预交记录.结算方式%Type;
  n_结算金额      病人预交记录.冲预交%Type;
  n_返回值        人员缴款余额.余额%Type;
  n_预交金额      病人预交记录.冲预交%Type;
  n_冲预交        病人预交记录.冲预交%Type;
  v_退支票        病人预交记录.结算方式%Type;
  v_结算号码      病人预交记录.结算号码%Type;
  v_结算摘要      病人预交记录.摘要%Type;
  v_误差费        结算方式.名称%Type;
  n_Count         Number;
  n_Havenull      Number;
  l_预交id        t_Numlist := t_Numlist();
  v_冲预交病人ids Varchar2(4000);
  n_会话号        病人预交记录.会话号%Type; --格式：SID+'_'+SERIAL#

  Cursor c_Feedata Is
    Select Max(m.病人id) As 病人id, Max(m.登记时间) As 登记时间, Max(m.操作员编号) As 操作员编号, Max(m.操作员姓名) As 操作员姓名, Sum(结帐金额) As 结算金额,
           Max(m.缴款组id) As 缴款组id
    From 门诊费用记录 M
    Where m.结帐id = 结帐id_In;
  r_Feedata c_Feedata%RowType;

  Cursor c_Balancedata Is
    Select 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号
    From 病人预交记录
    Where 结帐id = 结帐id_In And 结算方式 Is Null;
  r_Balancedata c_Balancedata%RowType;

Begin
  Begin
    Select Sid || '_' || Serial# Into n_会话号 From V$session Where Audsid = Userenv('sessionid');
  Exception
    When Others Then
      n_会话号 := Null;
  End;

  Begin
    Select 名称 Into v_误差费 From 结算方式 Where Nvl(性质, 0) = 9;
  Exception
    When Others Then
      v_误差费 := '误差费';
  End;

  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);

  --0.正式结算
  Select Count(1), Max(Decode(结算方式, Null, 1, 0))
  Into n_Count, n_Havenull
  From 病人预交记录
  Where 结帐id = 结帐id_In;

  --1.增加结算方式为空的结算数据
  n_结算金额 := 0;
  n_Count    := 0;
  Open c_Feedata;
  Begin
    Fetch c_Feedata
      Into r_Feedata;
    --修正或新增结算方式为null的记录
    Select Nvl(Sum(冲预交), 0) Into n_结算金额 From 病人预交记录 Where 结帐id = 结帐id_In;
    If Nvl(n_Havenull, 0) = 0 Or Round(Nvl(r_Feedata.结算金额, 0), 6) <> Round(Nvl(n_结算金额, 0), 6) Then
      --先删除存在的结算方式为null的记录
      Delete From 病人预交记录 Where 结帐id = 结帐id_In And 结算方式 Is Null;
      Select Nvl(Sum(冲预交), 0) Into n_结算金额 From 病人预交记录 Where 结帐id = 结帐id_In;
    
      n_结算金额 := Round(Nvl(r_Feedata.结算金额, 0) - n_结算金额, 6);
    
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 结算性质, 会话号)
      Values
        (病人预交记录_Id.Nextval, 3, Null, 1, Decode(病人id_In, 0, Null, 病人id_In), Null, r_Feedata.登记时间, r_Feedata.操作员编号,
         r_Feedata.操作员姓名, n_结算金额, 结帐id_In, r_Feedata.缴款组id, -1 * 结帐id_In, 1, 3, n_会话号);
    End If;
  Exception
    When Others Then
      n_Count := 1;
  End;
  Close c_Feedata;
  If n_Count = 1 Then
    v_Err_Msg := '未找到指定的收费明细数据,结算操作失败！';
    Raise Err_Item;
  End If;

  If 操作类型_In = 0 And Nvl(退支票额_In, 0) <> 0 Then
    Begin
      Select b.名称
      Into v_退支票
      From 结算方式应用 A, 结算方式 B
      Where a.应用场合 = '收费' And b.名称 = a.结算方式 And Nvl(b.应付款, 0) = 1 And Rownum <= 1;
    Exception
      When Others Then
        v_退支票 := '无';
    End;
    If v_退支票 = '无' Then
      v_Err_Msg := '在结算场合中,不存在结算性质为应付款的结算方式,请在[结算方式]中设置！';
      Raise Err_Item;
    End If;
  End If;

  Open c_Balancedata;
  Fetch c_Balancedata
    Into r_Balancedata;

  If Nvl(误差金额_In, 0) <> 0 Then
    Update 病人预交记录
    Set 冲预交 = Nvl(冲预交, 0) + Nvl(误差金额_In, 0)
    Where 结帐id = 结帐id_In And 结算方式 = v_误差费;
    If Sql%NotFound Then
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
         交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
      Values
        (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, Null, v_误差费, r_Balancedata.收款时间, r_Balancedata.操作员编号,
         r_Balancedata.操作员姓名, 误差金额_In, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null, Null, 卡号_In,
         交易流水号_In, 交易说明_In, Null, 3, n_会话号);
    End If;
    Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(误差金额_In, 0) Where 结帐id = 结帐id_In And 结算方式 Is Null;
    If Sql%NotFound Then
      v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
      Raise Err_Item;
    End If;
  End If;

  --预交款处理
  If Nvl(冲预交_In, 0) <> 0 Then
    If Nvl(病人id_In, 0) = 0 Then
      v_Err_Msg := '不能确定病人的病人ID,收费不能使用预交款结算,结算操作失败！';
      Raise Err_Item;
    End If;
  
    --病人余额检查
    Begin
      Select Sum(Nvl(预交余额, 0) - Nvl(费用余额, 0))
      Into n_预交金额
      From 病人余额
      Where 病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And Nvl(性质, 0) = 1 And 类型 = 1;
    Exception
      When Others Then
        n_预交金额 := 0;
    End;
    If n_预交金额 < 冲预交_In Then
      v_Err_Msg := '病人的当前预交余额为 ' || LTrim(To_Char(n_预交金额, '9999999990.00')) || '，小于本次支付金额 ' ||
                   LTrim(To_Char(冲预交_In, '9999999990.00')) || '，支付失败！';
      Raise Err_Item;
    End If;
  
    n_预交金额 := 冲预交_In;
  
    --先缴先用，且先用自己的
    --不包含结算方式为代收款项的预交款。
    For c_冲预交 In (Select a.No, Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) As 金额, Nvl(Max(a.结帐id), 0) As 结帐id, Max(病人id) As 病人id,
                         Max(Decode(a.记录性质, 1, a.记录状态, 1)) As 记录状态,
                         Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.Id, 3, a.Id, 0), 0)) As ID,
                         Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.收款时间, 3, a.收款时间, Null, Null))) As 收款时间
                  From 病人预交记录 A
                  Where a.记录性质 In (1, 11) And a.病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And
                        Nvl(a.预交类别, 2) = 1 And a.结算方式 Not In (Select 名称 From 结算方式 Where 性质 = 5)
                  Group By a.No
                  Having Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) <> 0
                  Order By Decode(病人id, Nvl(病人id_In, 0), 0, 1), 收款时间) Loop
    
      If c_冲预交.金额 - n_预交金额 < 0 Then
        n_冲预交 := c_冲预交.金额;
      Else
        n_冲预交 := n_预交金额;
      End If;
    
      If c_冲预交.结帐id = 0 Then
        --第一次冲预交(填上结帐ID,金额为0)
        Update 病人预交记录
        Set 冲预交 = 0, 结帐id = 结帐id_In, 结算序号 = -1 * 结帐id_In, 结算性质 = 3, 会话号 = n_会话号
        Where ID = c_冲预交.Id;
      End If;
      --冲上次剩余额
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
         结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质, 会话号)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
               r_Balancedata.收款时间, r_Balancedata.操作员姓名, r_Balancedata.操作员编号, n_冲预交, 结帐id_In, r_Balancedata.缴款组id, 预交类别,
               卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, -1 * 结帐id_In, 3, n_会话号
        From 病人预交记录
        Where NO = c_冲预交.No And 记录状态 = c_冲预交.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
    
      --更新数据(结算方式为NULL的)
      Update 病人预交记录
      Set 冲预交 = 冲预交 - n_冲预交
      Where 结帐id = 结帐id_In And 结算方式 Is Null
      Returning Nvl(冲预交, 0) Into n_返回值;
    
      --更新病人预交余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_冲预交
      Where 病人id = c_冲预交.病人id And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (c_冲预交.病人id, 1, -1 * n_冲预交, 1);
        n_返回值 := -1 * n_冲预交;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = c_冲预交.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      --检查是否已经处理完
      If c_冲预交.金额 < n_预交金额 Then
        n_预交金额 := n_预交金额 - c_冲预交.金额;
      Else
        n_预交金额 := 0;
      End If;
      If n_预交金额 = 0 Then
        Exit;
      End If;
    
    End Loop;
    --检查金额是否足够
    If Abs(n_预交金额) > 0 Then
      v_Err_Msg := '病人的当前预交余额小于本次支付金额 ' || LTrim(To_Char(冲预交_In, '9999999990.00')) || '，支付失败！';
      Raise Err_Item;
    End If;
  End If;

  If 操作类型_In = 0 Then
  
    If Nvl(退支票额_In, 0) <> 0 Then
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
         交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
      Values
        (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, Null, v_退支票, r_Balancedata.收款时间, r_Balancedata.操作员编号,
         r_Balancedata.操作员姓名, 退支票额_In, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null, Null, 卡号_In,
         交易流水号_In, 交易说明_In, Null, 3, n_会话号);
    
      Update 病人预交记录 Set 冲预交 = 冲预交 - 退支票额_In Where 结帐id = 结帐id_In And 结算方式 Is Null;
      If Sql%NotFound Then
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
        Raise Err_Item;
      End If;
    End If;
  
    --各个收费结算 :格式为:"结算方式|结算金额|结算号码|结算摘要||.."
    v_结算内容 := 结算方式_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
    
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      If Nvl(n_结算金额, 0) <> 0 Then
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
           交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
           r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号,
           2, Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, v_结算号码, 3, n_会话号);
      
        Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 结帐id_In And 结算方式 Is Null;
        If Sql%NotFound Then
          v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
          Raise Err_Item;
        End If;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If 操作类型_In = 1 Then
    --三方卡结算交易
  
    v_当前结算 := 结算方式_In;
  
    v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
    v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
  
    If Nvl(n_结算金额, 0) <> 0 Then
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
         交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
      Values
        (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
         r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号,
         2, 卡类别id_In, Null, 卡号_In, 交易流水号_In, 交易说明_In, v_结算号码, 3, n_会话号);
    
      Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 结帐id_In And 结算方式 Is Null;
      If Sql%NotFound Then
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
        Raise Err_Item;
      End If;
    End If;
  End If;

  --2.医保结算(调用此过程,采取平均分摊的方式分摊结算情况):这种情况医保结处后,必须全退
  If 操作类型_In = 2 Then
    --2.1检查是否已经存在医保结算数据,存在先删除
    n_结算金额 := 0;
    For v_医保 In (Select ID, 结算方式, 冲预交
                 From 病人预交记录 A
                 Where 结帐id = 结帐id_In And Exists
                  (Select 1 From 结算方式 Where a.结算方式 = 名称 And 性质 In (3, 4)) And Mod(记录性质, 10) <> 1)
    
     Loop
      n_结算金额 := n_结算金额 + Nvl(v_医保.冲预交, 0);
      l_预交id.Extend;
      l_预交id(l_预交id.Count) := v_医保.Id;
    End Loop;
    If Nvl(n_结算金额, 0) <> 0 Then
      Update 病人预交记录
      Set 冲预交 = Nvl(冲预交, 0) + Nvl(n_结算金额, 0)
      Where 结帐id = 结帐id_In And 结算方式 Is Null;
      If Sql%NotFound Then
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
        Raise Err_Item;
      End If;
    End If;
    If l_预交id.Count <> 0 Then
      Forall I In 1 .. l_预交id.Count
        Delete 病人预交记录 Where ID = l_预交id(I);
    End If;
  
    If 结算方式_In Is Not Null Then
      v_结算内容 := 结算方式_In || '||';
    End If;
  
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      n_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      For c_结算信息 In (Select 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号
                     From 病人预交记录
                     Where 结帐id = 结帐id_In And 结算方式 Is Null) Loop
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 1, c_结算信息.病人id, Null, '保险结算', v_结算方式, c_结算信息.收款时间, c_结算信息.操作员编号, c_结算信息.操作员姓名,
           n_结算金额, c_结算信息.结帐id, c_结算信息.缴款组id, c_结算信息.结算序号, 1, 3, n_会话号);
      End Loop;
      --更新数据(结算方式为NULL的)
      Update 病人预交记录
      Set 冲预交 = 冲预交 - n_结算金额
      Where 结帐id = 结帐id_In And 结算方式 Is Null
      Returning Nvl(冲预交, 0) Into n_返回值;
    
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --3-消费卡批量结算
  If 操作类型_In = 3 Then
    v_结算内容 := 结算方式_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      --卡类别ID|卡号|消费卡ID|消费金额
      n_卡类别id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_卡号     := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_消费卡id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(v_当前结算);
      Begin
        Select 名称, 自制卡, 结算方式 Into v_名称, n_自制卡, v_结算方式 From 卡消费接口目录 Where 编号 = 卡类别id_In;
      Exception
        When Others Then
          v_名称 := Null;
      End;
      If v_名称 Is Null Then
        v_Err_Msg := '未找到对应的结算卡接口,本次刷卡消费失败!';
        Raise Err_Item;
      End If;
      If v_结算方式 Is Null Then
        v_Err_Msg := v_名称 || '未设置对应的结算方式,本次刷卡消费失败!';
        Raise Err_Item;
      End If;
      If Nvl(n_消费卡id, 0) = 0 Then
        --未传入消费卡ID时,以卡号为准进行查找(卡号的合法性,在程序中有判断)
        Begin
          Select ID
          Into n_消费卡id
          From 消费卡目录
          Where 接口编号 = n_卡类别id And 卡号 = v_卡号 And
                序号 = (Select Max(序号) From 消费卡目录 Where 接口编号 = n_卡类别id And 卡号 = v_卡号);
        Exception
          When Others Then
            n_消费卡id := 0;
        End;
        If Nvl(n_消费卡id, 0) = 0 Then
          v_Err_Msg := '未找到卡号为:' || v_卡号 || '的' || v_名称 || '.,本次刷卡消费失败!';
          Raise Err_Item;
        End If;
      End If;
    
      If Nvl(n_结算金额, 0) <> 0 Then
      
        Update 病人预交记录
        Set 冲预交 = Nvl(冲预交, 0) + n_结算金额
        Where 结帐id = r_Balancedata. 结帐id And 结算方式 = v_结算方式 And 结算卡序号 = n_卡类别id
        Returning ID Into n_预交id;
        If Sql%NotFound Then
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算卡序号, 校对标志, 结算性质,
             会话号)
          Values
            (n_预交id, 3, Null, 1, r_Balancedata. 病人id, Null, Null, v_结算方式, r_Balancedata. 收款时间, r_Balancedata. 操作员编号,
             r_Balancedata. 操作员姓名, n_结算金额, r_Balancedata. 结帐id, r_Balancedata. 缴款组id, r_Balancedata. 结算序号, n_卡类别id, 2, 3,
             n_会话号);
        End If;
      
        --插入卡结算记录
        Begin
          Select Nvl(Max(Nvl(序号, 0)), 0) + 1
          Into n_序号
          From 病人卡结算记录
          Where 接口编号 = n_卡类别id And Nvl(消费卡id, 0) = Nvl(n_消费卡id, 0) And 卡号 = v_卡号;
        Exception
          When Others Then
            n_序号 := 1;
        End;
      
        Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
      
        Insert Into 病人卡结算记录
          (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
        Values
          (n_Id, n_卡类别id, n_消费卡id, n_序号, 1, v_结算方式, n_结算金额, v_卡号, Null, r_Balancedata. 收款时间, Null, 0);
        --如果消费卡,需同时更改其余额
        If Nvl(n_消费卡id, 0) <> 0 Then
          Update 消费卡目录 Set 余额 = 余额 - n_结算金额 Where ID = n_消费卡id;
          If Sql%NotFound Then
            v_Err_Msg := '卡号为' || v_卡号 || '的' || v_名称 || '未找到!';
            Raise Err_Item;
          End If;
        End If;
        Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
      
        --更新数据(结算方式为NULL的)
        Update 病人预交记录
        Set 冲预交 = 冲预交 - n_结算金额
        Where 结帐id = r_Balancedata. 结帐id And 结算方式 Is Null And Nvl(校对标志, 0) = 1
        Returning Nvl(冲预交, 0) Into n_返回值;
      
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If Nvl(完成结算_In, 0) = 0 Then
    Return;
  End If;

  -----------------------------------------------------------------------------------------
  --完成收费,需要处理人员缴款余额,预交记录(结算方式=NULL)

  --1.删除结算方式为NULL的预交记录
  Delete 病人预交记录 Where 结帐id = 结帐id_In And 结算方式 Is Null And Nvl(冲预交, 0) = 0;
  If Sql%NotFound Then
    Select Count(*) Into n_Count From 病人预交记录 A Where 结帐id = 结帐id_In And 结算方式 Is Null;
    If n_Count <> 0 Then
      v_Err_Msg := '还存在未缴款的数据,不能完成结算!';
    Else
      v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！!';
    End If;
    Raise Err_Item;
  End If;

  --检查门诊费用记录与病人预交记录的金额是否相等
  n_结算金额 := 0;
  n_冲预交   := 0;
  Select Nvl(Sum(实收金额), 0) Into n_结算金额 From 门诊费用记录 Where 结帐id = 结帐id_In;
  Select Nvl(Sum(冲预交), 0) Into n_冲预交 From 病人预交记录 Where 结帐id = 结帐id_In;
  If n_结算金额 <> n_冲预交 Then
    v_Err_Msg := '结算信息有误，实收金额(' || n_结算金额 || ')与结算金额(' || n_冲预交 || ')不一致，不能完成结算！';
    Raise Err_Item;
  End If;

  --结算金额为零时，增加一条金额为0的病人预交记录
  Select Count(*) Into n_Count From 病人预交记录 A Where 结帐id = 结帐id_In;

  If n_Count = 0 Then
    v_结算方式 := 缺省结算方式_In;
    If v_结算方式 Is Null Then
      Begin
        Select 结算方式 Into v_结算方式 From 结算方式应用 Where 应用场合 = '收费' And Nvl(缺省标志, 0) = 1;
      Exception
        When Others Then
          v_结算方式 := Null;
      End;
      If v_结算方式 Is Null Then
        Begin
          Select 名称 Into v_结算方式 From 结算方式 Where Nvl(性质, 0) = 1;
        Exception
          When Others Then
            v_结算方式 := '现金';
        End;
      End If;
    End If;
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
       交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
    Values
      (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, Null, v_结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
       r_Balancedata.操作员姓名, 0, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null, Null, Null, Null,
       交易说明_In, Null, 3, n_会话号);
  End If;

  --2.处理缴款数据和找补数据及校对标志更新为0，会话号更新为NULL
  Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0, 会话号 = Null Where 结帐id = 结帐id_In;

  --3.更新费用状态
  Update 门诊费用记录 Set 费用状态 = 0 Where 结帐id = 结帐id_In;

  --4.更新人员缴款数据
  For c_缴款 In (Select 结算方式, 操作员姓名, Sum(Nvl(a.冲预交, 0)) As 冲预交
               From 病人预交记录 A
               Where a.结帐id = 结帐id_In And Mod(a.记录性质, 10) <> 1
               Group By 结算方式, 操作员姓名) Loop
  
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + Nvl(c_缴款.冲预交, 0)
    Where 收款员 = c_缴款.操作员姓名 And 性质 = 1 And 结算方式 = c_缴款.结算方式;
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额
        (收款员, 结算方式, 性质, 余额)
      Values
        (c_缴款.操作员姓名, c_缴款.结算方式, 1, Nvl(c_缴款.冲预交, 0));
    End If;
  End Loop;
  --收费后产生导引
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 4, 结帐id_In;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊收费结算_Modify;
/

--106755:冉俊明,2017-03-14,作废的预交款单据不能再在消费环节使用。
Create Or Replace Procedure Zl_门诊退费结算_Modify
(
  操作类型_In      Number,
  病人id_In        门诊费用记录.病人id%Type,
  冲销id_In        病人预交记录.结帐id%Type,
  结算方式_In      Varchar2,
  冲预交_In        病人预交记录.冲预交%Type := Null,
  卡类别id_In      病人预交记录.卡类别id%Type := Null,
  卡号_In          病人预交记录.卡号%Type := Null,
  交易流水号_In    病人预交记录.交易流水号%Type := Null,
  交易说明_In      病人预交记录.交易说明%Type := Null,
  缴款_In          病人预交记录.缴款%Type := Null,
  找补_In          病人预交记录.找补%Type := Null,
  误差金额_In      门诊费用记录.实收金额%Type := Null,
  完成退费_In      Number := 0,
  原结帐id_In      病人预交记录.结帐id%Type := Null,
  剩余转预交_In    Number := 0,
  缺省结算方式_In  结算方式.名称%Type := Null,
  冲预交病人ids_In Varchar2 := Null
) As
  ------------------------------------------------------------------------------------------------------------------------------
  --功能:收费结算时,修改结算的相关信息
  --操作类型_In:
  --   0-原样退
  --      原样结算一起全退,所有校对标志都为1,医保调用成功后,调整为2,完成后变成0
  --   1-普通退费方式:
  --     ①结算方式_IN:允许传入多个,格式为:"结算方式|结算金额|结算号码|结算摘要||.." ;也允许传入空.
  --   2.三方卡退费结算:
  --     ①结算方式_IN:只能传入一个结算方式,但允许包含一些辅助信息,格式为:"结算方式|结算金额|结算号码|结算摘要"
  --     ②卡类别ID_IN,卡号_IN,交易流水号_IN,交易说明_In:需要传入
  --   3-医保结算(如果存在医保的结算,则要先删除原医保结算,后按新传入的更新)
  --     ①结算方式_IN:允许传入多个,格式为:结算方式|结算金额||.."
  --     ②退支票额_In:传入零
  --   4-消费卡结算:
  --     ①结算方式_IN:允许一次刷多张卡,格式为:卡类别ID|卡号|消费卡ID|消费金额||."
  --     ②退支票额_In:传入零

  -- 冲预交_In:如果涉及预交款,则传入本次的退预交 传入零<0时 表示退预交款或充值;>0 时:表示冲预交款
  -- 剩余转预交_In: 1表示将剩余退款额转换为充值金额;0表示退预交
  -- 误差金额_In:存在误差费时,传入
  -- 完成退费_In:0-未完成退费;1-异常完成退费;2-完成退费
  -- 原结帐ID_IN:原样退时,传入(如果原样退未传入时,则以最后一次结帐为准)
  -- 冲预交病人ids_In:多个用逗分分离,冲预交时有效(冲预交类别与业务操作保持一致),主要是使用家属的预交款
  ------------------------------------------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  v_结算内容 Varchar2(500);
  v_当前结算 Varchar2(50);
  v_卡号     病人医疗卡信息.卡号%Type;
  n_消费卡id 消费卡目录.Id%Type;
  n_卡类别id 病人预交记录.结算卡序号%Type;
  v_名称     Varchar2(100);
  n_自制卡   卡消费接口目录.自制卡%Type;
  n_序号     病人卡结算记录.序号%Type;
  n_Id       病人卡结算记录.Id%Type;
  n_预交id   病人预交记录.Id%Type;
  v_结算方式 病人预交记录.结算方式%Type;
  n_结算金额 病人预交记录.冲预交%Type;
  n_返回值   人员缴款余额.余额%Type;
  n_预交金额 病人预交记录.冲预交%Type;
  n_冲预交   病人预交记录.冲预交%Type;
  v_结算号码 病人预交记录.结算号码%Type;
  v_结算摘要 病人预交记录.摘要%Type;
  v_误差费   结算方式.名称%Type;
  n_记录状态 病人预交记录.记录状态%Type;

  v_退费结算 结算方式.名称%Type;
  v_No       病人预交记录.No%Type;
  n_Dec      Number; --金额小数位数

  n_Count         Number;
  n_Havenull      Number;
  l_预交id        t_Numlist := t_Numlist();
  n_原结帐id      病人预交记录.结帐id%Type;
  n_重结id        病人预交记录.结帐id%Type;
  n_结帐id        病人预交记录.结帐id%Type;
  n_结算序号      病人预交记录.结帐id%Type;
  v_冲预交病人ids Varchar2(4000);
  v_Msg           Varchar2(500);
  n_会话号        病人预交记录.会话号%Type; --格式：SID+'_'+SERIAL#

  Cursor c_Feedata Is
    Select Max(NO) As NO, Max(m.病人id) As 病人id, Max(m.登记时间) As 登记时间, Max(m.操作员编号) As 操作员编号, Max(m.操作员姓名) As 操作员姓名,
           Sum(结帐金额) As 结算金额, Max(m.缴款组id) As 缴款组id
    From 门诊费用记录 M
    Where m.结帐id = 冲销id_In;
  r_Feedata c_Feedata%RowType;

  Cursor c_Balancedata Is
    Select 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号
    From 病人预交记录
    Where 结帐id = 冲销id_In And 结算方式 Is Null;
  r_Balancedata c_Balancedata%RowType;

  Procedure Zl_Square_Update
  (
    原结帐id_In 病人预交记录.结帐id%Type,
    现结帐id_In 病人预交记录.结帐id%Type,
    缴款组id_In 病人预交记录.缴款组id%Type,
    退款时间_In 病人预交记录.收款时间%Type,
    结算序号_In 病人预交记录.结算序号%Type,
    结算内容_In Varchar2 := Null
  ) As
    n_记录状态 病人卡结算记录.记录状态%Type;
    n_预交id   病人预交记录.Id%Type;
    v_卡号     病人卡结算记录.卡号%Type;
    n_存在卡片 Number;
    d_停用日期 消费卡目录.停用日期%Type;
    n_最大序号 病人卡结算记录.序号%Type;
    n_序号     病人卡结算记录.序号%Type;
    n_余额     消费卡目录.余额%Type;
    n_接口编号 病人卡结算记录.接口编号%Type;
    d_回收时间 消费卡目录.回收时间%Type;
    n_Id       病人预交记录.Id%Type;
  Begin
    n_预交id := 0;
  
    --处理消费卡,结算卡在上面就已经处理了
    For v_校对 In (Select a.Id As 预交id, c.消费卡id, c.结算金额, c.接口编号, c.卡号, c.序号, c.Id
                 From 病人预交记录 A, 病人卡结算对照 B, 病人卡结算记录 C
                 Where a.Id = b.预交id And b.卡结算id = c.Id And a.记录性质 = 3 And a.记录状态 In (1, 3) And
                       Instr(Nvl(结算内容_In, '_LXH'), ',' || a.结算方式 || ',') = 0 And a.结帐id = 原结帐id_In) Loop
    
      If Nvl(v_校对.消费卡id, 0) <> 0 Then
        Select Max(记录状态)
        Into n_记录状态
        From 病人卡结算记录
        Where 接口编号 = v_校对.接口编号 And 消费卡id = Nvl(v_校对.消费卡id, 0) And 卡号 = v_校对.卡号 And Nvl(序号, 0) = Nvl(v_校对.序号, 0);
      Else
        Select Max(记录状态)
        Into n_记录状态
        From 病人卡结算记录
        Where 接口编号 = v_校对.接口编号 And 消费卡id Is Null And 卡号 = v_校对.卡号 And Nvl(序号, 0) = Nvl(v_校对.序号, 0);
      End If;
    
      If n_记录状态 = 1 Then
        n_记录状态 := 2;
      Else
        n_记录状态 := n_记录状态 + 2;
      End If;
      --多条时,只更新一条
      If n_预交id = 0 Then
        Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id,
           预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
          Select n_预交id, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, 退款时间_In, 缴款单位, 单位开户行, 单位帐号, r_Balancedata.操作员编号,
                 r_Balancedata.操作员姓名, -1 * 冲预交, 现结帐id_In, 缴款组id_In, 预交类别, 卡类别id, Nvl(结算卡序号, v_校对.接口编号), 卡号, 交易流水号, 交易说明,
                 合作单位, 2, 结算序号_In, Mod(记录性质, 10), n_会话号
          From 病人预交记录 A
          Where ID = v_校对.预交id;
      End If;
    
      If Nvl(v_校对.消费卡id, 0) <> 0 Then
        --消费卡,直接退回卡数据中
        Begin
          Select 卡号, 1, 停用日期, (Select Max(序号) From 消费卡目录 B Where a.卡号 = b.卡号 And a.接口编号 = b.接口编号), 序号, 余额, 接口编号, 回收时间
          Into v_卡号, n_存在卡片, d_停用日期, n_最大序号, n_序号, n_余额, n_接口编号, d_回收时间
          From 消费卡目录 A
          Where ID = v_校对.消费卡id;
        Exception
          When Others Then
            n_存在卡片 := 0;
        End;
      
        --取消停用
        If n_存在卡片 = 0 Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡被他人删除，不能再启用该卡片,请检查！';
          Raise Err_Item;
        End If;
        If Nvl(n_序号, 0) < Nvl(n_最大序号, 0) Then
          v_Err_Msg := '不能启用历史发卡记录(卡号为"' || v_卡号 || '"),请检查！';
          Raise Err_Item;
        End If;
        If Nvl(d_停用日期, To_Date('3000-01-01', 'yyyy-mm-dd')) < To_Date('3000-01-01', 'yyyy-mm-dd') Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡已经被他人停用，不能再进行退费,请检查！';
          Raise Err_Item;
        End If;
      
        If d_回收时间 < To_Date('3000-01-01', 'yyyy-mm-dd') Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡已经回收，不能退费,请检查！';
          Raise Err_Item;
        End If;
        Update 消费卡目录 Set 余额 = Nvl(余额, 0) + v_校对.结算金额 Where ID = Nvl(v_校对.消费卡id, 0);
      End If;
    
      Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
      Insert Into 病人卡结算记录
        (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
        Select n_Id, 接口编号, 消费卡id, 序号, n_记录状态, 结算方式, -1 * v_校对.结算金额, 卡号, 交易流水号, 交易时间, 备注,
               Decode(消费卡id, Null, 0, 0, 0, 1) As 标志
        From 病人卡结算记录
        Where ID = v_校对.Id;
      Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
    
      If n_记录状态 <> 2 And n_记录状态 <> 1 Then
        Update 病人卡结算记录 Set 记录状态 = 3 Where ID = v_校对.Id;
      End If;
    End Loop;
  End;

Begin
  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);
  Begin
    Select Sid || '_' || Serial# Into n_会话号 From V$session Where Audsid = Userenv('sessionid');
  Exception
    When Others Then
      n_会话号 := Null;
  End;

  Begin
    Select 名称 Into v_退费结算 From 结算方式 Where 性质 = 1;
  Exception
    When Others Then
      v_退费结算 := '现金';
  End;

  Open c_Feedata;
  Fetch c_Feedata
    Into r_Feedata;

  If r_Feedata.No Is Null Then
    v_Err_Msg := '未找到指定的退费记录！';
    Raise Err_Item;
  End If;

  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into n_Dec From Dual;

  --0.正式结算
  Select Count(1), Max(Decode(结算方式, Null, 1, 0)), Max(结算序号)
  Into n_Count, n_Havenull, n_结算序号
  From 病人预交记录
  Where 结帐id = 冲销id_In;

  If Nvl(n_Count, 0) = 0 Or Nvl(误差金额_In, 0) <> 0 Then
    --增加结算方式为NULL的记录
    Begin
      Select 名称 Into v_误差费 From 结算方式 Where Nvl(性质, 0) = 9;
    Exception
      When Others Then
        v_误差费 := '误差费';
    End;
  End If;

  --1.增加结算方式为空的结算数据
  If Nvl(n_Havenull, 0) = 0 Then
    n_Count := 0;
    Begin
      n_结算金额 := Round(Nvl(r_Feedata.结算金额, 0), n_Dec);
    
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 结算性质, 会话号)
      Values
        (病人预交记录_Id.Nextval, 3, Null, 2, Decode(病人id_In, 0, Null, 病人id_In), Null, r_Feedata.登记时间, r_Feedata.操作员编号,
         r_Feedata.操作员姓名, n_结算金额, 冲销id_In, r_Feedata.缴款组id, -1 * 冲销id_In, 1, 3, n_会话号);
      --误差费(先汇总后生成误差费
      If n_结算金额 <> Nvl(r_Feedata.结算金额, 0) Then
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 1, Decode(病人id_In, 0, Null, 病人id_In), v_误差费, r_Feedata.登记时间, r_Feedata.操作员编号,
           r_Feedata.操作员姓名, Nvl(r_Feedata.结算金额, 0) - n_结算金额, 冲销id_In, r_Feedata.缴款组id, -1 * 冲销id_In, 1, 3, n_会话号);
      End If;
      n_结算序号 := -1 * 冲销id_In;
    Exception
      When Others Then
        n_Count := 1;
    End;
    If n_Count = 1 Then
      v_Err_Msg := '未找到指定的退费明细数据,结算操作失败！';
      Raise Err_Item;
    End If;
  End If;

  Open c_Balancedata;
  Fetch c_Balancedata
    Into r_Balancedata;

  If 操作类型_In = 0 Then
    --0.原样退
    n_原结帐id := 原结帐id_In;
    If Nvl(n_原结帐id, 0) = 0 Then
      Select Max(结帐id)
      Into n_原结帐id
      From 门诊费用记录 A,
           (Select 登记时间 From 门诊费用记录 Where NO = r_Feedata.No And Mod(记录性质, 10) = 1 And 记录状态 In (1, 3)) B
      Where a.No = r_Feedata.No And Mod(a.记录性质, 10) = 1 And a.登记时间 = b.登记时间;
    End If;
    If Nvl(n_原结帐id, 0) = 0 Then
      v_Err_Msg := '未找到原结帐数据,不能原样退！';
      Raise Err_Item;
    End If;
  
    --1.先处理预交款
    For v_退预交 In (Select a.Id, a.病人id, Nvl(a.冲预交, 0) As 金额
                  From 病人预交记录 A
                  Where Mod(记录性质, 10) = 1 And 结帐id = n_原结帐id And Nvl(冲预交, 0) <> 0
                  Order By 收款时间 Desc) Loop
    
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 实际票号, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
         卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 结算性质, 会话号)
        Select 病人预交记录_Id.Nextval, 11, NO, 实际票号, 记录状态, 病人id, Null, 摘要, 结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
               r_Balancedata.操作员姓名, -1 * v_退预交.金额, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null,
               Null, 卡号, 交易流水号, 交易说明, Null, 预交类别, 3, n_会话号
        From 病人预交记录
        Where ID = v_退预交.Id;
    
      --更新病人余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + v_退预交.金额
      Where 病人id = v_退预交.病人id And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (v_退预交.病人id, 1, v_退预交.金额, 1);
        n_返回值 := (-1 * v_退预交.金额);
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = v_退预交.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      Update 病人预交记录 Set 冲预交 = 冲预交 - v_退预交.金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
      If Sql%NotFound Then
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
        Raise Err_Item;
      End If;
    End Loop;
  
    --2.处理消费卡部分
    Zl_Square_Update(n_原结帐id, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.收款时间, r_Balancedata.结算序号, v_结算内容);
    --3.处理其他结算部分
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号,
       交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
      Select 病人预交记录_Id.Nextval, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, r_Balancedata.收款时间, r_Balancedata.操作员编号,
             r_Balancedata.操作员姓名, -1 * 冲预交, r_Balancedata.结帐id, r_Balancedata.缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明,
             合作单位,
             Case
               When Nvl(a.卡类别id, 0) <> 0 Then
                1
               When Nvl(a.结算卡序号, 0) <> 0 Then
                1
               When Nvl(q.预交id, 0) <> 0 Then
                1
               When Nvl(j.名称, '-') <> '-' Then
               --医保
                1
               Else
                2
             End As 校对标志, r_Balancedata.结算序号, Mod(记录性质, 10), n_会话号
      From 病人预交记录 A, (Select 名称 From 结算方式 Where 性质 In (3, 4)) J,
           (Select m.Id As 预交id
             From 病人预交记录 M, 一卡通目录 C
             Where m.结帐id = n_原结帐id And m.结算方式 = c.结算方式 And m.记录性质 = 3 And m.记录状态 In (1, 3)) Q
      Where Mod(a.记录性质, 10) <> 1 And a.记录状态 In (1, 3) And a.结算方式 = j.名称(+) And a.结算方式 Is Not Null And a.结帐id = n_原结帐id And
            a.Id = q.预交id(+) And (Not Exists (Select 1 From 病人卡结算对照 Where a.Id = 预交id) Or Nvl(结算卡序号, 0) = 0);
  
    --更新结算方式为NULL 的记录
    Select Sum(冲预交) Into n_返回值 From 病人预交记录 Where 结帐id = r_Balancedata.结帐id And 结算方式 Is Not Null;
    Select Sum(结帐金额)
    Into n_结算金额
    From 门诊费用记录
    Where 结帐id = r_Balancedata.结帐id And Mod(记录性质, 10) = 1;
  
    Update 病人预交记录
    Set 冲预交 = Nvl(n_结算金额, 0) - Nvl(n_返回值, 0)
    Where 结帐id = 冲销id_In And 结算方式 Is Null;
    If Sql%NotFound Then
      v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
      Raise Err_Item;
    End If;
  
  End If;

  n_重结id := 0;
  If 操作类型_In <> 0 Then
    --不是全退时,检查是否产生了重新收费数据的
    Begin
      Select 结帐id Into n_重结id From 病人预交记录 Where 结算序号 = n_结算序号 And 结帐id <> 冲销id_In And Rownum < 2;
    Exception
      When Others Then
        n_重结id := 0;
    End;
  End If;

  --需要处理误差金额
  If Nvl(误差金额_In, 0) <> 0 Then
    --误差费放在重收的结算记录中
    n_结帐id   := 冲销id_In;
    n_记录状态 := 2;
    If Nvl(n_重结id, 0) <> 0 Then
      n_结帐id   := n_重结id;
      n_记录状态 := 1;
    End If;
  
    Update 病人预交记录
    Set 冲预交 = Nvl(冲预交, 0) + Nvl(误差金额_In, 0)
    Where 结帐id = n_结帐id And 结算方式 = v_误差费;
    If Sql%NotFound Then
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
         交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
      Values
        (病人预交记录_Id.Nextval, 3, Null, n_记录状态, r_Balancedata.病人id, Null, Null, v_误差费, r_Balancedata.收款时间,
         r_Balancedata.操作员编号, r_Balancedata.操作员姓名, 误差金额_In, n_结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null,
         Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
    End If;
  
    Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(误差金额_In, 0) Where 结帐id = n_结帐id And 结算方式 Is Null;
    If Sql%NotFound Then
      v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
      Raise Err_Item;
    End If;
  End If;

  --预交款处理:如果是冲预交,需要先处理冲预交款
  If Nvl(冲预交_In, 0) <> 0 Then
    If Nvl(r_Balancedata.病人id, 0) = 0 Then
      v_Err_Msg := '不能确定病人信息,不能使用预交款结算！';
      Raise Err_Item;
    End If;
  
    n_预交金额 := 冲预交_In;
    If n_预交金额 < 0 And Nvl(剩余转预交_In, 0) = 1 Then
    
      --     ②冲预交_In:如果涉及预交款,则传入本次的退预交 传入零<0时 表示退预交款或充值;>0 时:表示冲预交款
      --     ③剩余转预交_In: 1表示将剩余退款额转换为充值金额;0表示退预交
    
      --1.先生成冲值预交:
      v_No := Nextno(11);
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 金额, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
         交易流水号, 交易说明, 结算号码, 预交类别, 结算性质, 会话号)
      Values
        (病人预交记录_Id.Nextval, 1, v_No, 1, r_Balancedata.病人id, Null, '退费生成预交', v_退费结算, r_Balancedata.收款时间,
         r_Balancedata.操作员编号, r_Balancedata.操作员姓名, -1 * n_预交金额, r_Balancedata.结帐id, r_Balancedata.缴款组id,
         r_Balancedata.结算序号, 0, Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 1, Null, n_会话号);
    
      --更新病人余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + (-1 * n_预交金额)
      Where 病人id = 病人id_In And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (病人id_In, 1, -1 * n_预交金额, 1);
        n_返回值 := -1 * n_预交金额;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Balancedata.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      --2.生成退费记录
      If Nvl(n_重结id, 0) <> 0 Then
        Select Sum(冲预交)
        Into n_返回值
        From 病人预交记录
        Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
        If Nvl(n_返回值, 0) <> 0 Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
             卡号, 交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
          Values
            (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_退费结算, r_Balancedata.收款时间,
             r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_返回值, 冲销id_In, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null,
             Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
        
          Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(n_返回值, 0) Where 结帐id = 冲销id_In And 结算方式 Is Null;
        End If;
        n_结算金额 := n_结算金额 - Nvl(n_返回值, 0);
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
           交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, v_结算摘要, v_退费结算, r_Balancedata.收款时间,
           r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, n_重结id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null,
           Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
        Update 病人预交记录 Set 冲预交 = 冲预交 + n_预交金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
        If Sql%NotFound Then
          v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
          Raise Err_Item;
        End If;
      Else
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
           交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
           r_Balancedata.操作员编号, r_Balancedata.操作员姓名, -1 * n_预交金额, r_Balancedata.结帐id, r_Balancedata.缴款组id,
           r_Balancedata.结算序号, 2, Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
        Update 病人预交记录 Set 冲预交 = 冲预交 + n_预交金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
        If Sql%NotFound Then
          v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
          Raise Err_Item;
        End If;
      End If;
    End If;
  
    If Nvl(n_预交金额, 0) < 0 And Nvl(剩余转预交_In, 0) = 0 Then
      n_原结帐id := 原结帐id_In;
      If Nvl(n_原结帐id, 0) = 0 Then
        Select Max(b.结帐id)
        Into n_原结帐id
        From 门诊费用记录 A, 门诊费用记录 B
        Where a.结帐id = 冲销id_In And a.No = b.No And b.记录性质 = 1 And b.记录状态 In (1, 3);
      End If;
    
      If Nvl(n_原结帐id, 0) = 0 Then
        v_Err_Msg := '未找到原结帐数据,不能原样退！';
        Raise Err_Item;
      End If;
      If Nvl(n_重结id, 0) <> 0 Then
        --1.退预交款
        For v_退预交 In (Select Max(a.Id) As ID, a.病人id, Max(a.收款时间) As 收款时间, Sum(Nvl(a.冲预交, 0)) As 金额
                      From 病人预交记录 A,
                           (Select Distinct a.结帐id
                             From 门诊费用记录 A, 门诊费用记录 B
                             Where a.No = b.No And Mod(b.记录性质, 10) = 1 And b.结帐id = n_原结帐id) B
                      Where a.结帐id = b.结帐id And Mod(a.记录性质, 10) = 1 And Nvl(a.预交类别, 0) = 1
                      Group By NO, 病人id
                      Having Sum(Nvl(a.冲预交, 0)) > 0
                      Order By 收款时间 Desc) Loop
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 实际票号, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 结算性质, 会话号)
            Select 病人预交记录_Id.Nextval, 11, NO, 实际票号, 记录状态, 病人id, Null, 摘要, 结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
                   r_Balancedata.操作员姓名, -1 * v_退预交.金额, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2,
                   Null, Null, 卡号, 交易流水号, 交易说明, Null, 预交类别, 3, n_会话号
            From 病人预交记录
            Where ID = v_退预交.Id;
        
          --更新病人余额
          Update 病人余额
          Set 预交余额 = Nvl(预交余额, 0) + v_退预交.金额
          Where 病人id = v_退预交.病人id And 性质 = 1 And 类型 = 1
          Returning 预交余额 Into n_返回值;
          If Sql%RowCount = 0 Then
            Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (v_退预交.病人id, 1, v_退预交.金额, 1);
            n_返回值 := v_退预交.金额;
          End If;
          If Nvl(n_返回值, 0) = 0 Then
            Delete From 病人余额
            Where 病人id = v_退预交.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
          End If;
        
          Update 病人预交记录 Set 冲预交 = 冲预交 - (-1 * v_退预交.金额) Where 结帐id = 冲销id_In And 结算方式 Is Null;
          If Sql%NotFound Then
            v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
            Raise Err_Item;
          End If;
          n_预交金额 := n_预交金额 - (-1 * v_退预交.金额);
        End Loop;
      
        --2.冲预交款
        If n_预交金额 <> 0 Then
          For v_退预交 In (Select Max(a.Id) As ID, a.病人id, Max(a.收款时间) As 收款时间, Sum(Nvl(a.冲预交, 0)) As 金额
                        From 病人预交记录 A,
                             (Select Distinct a.结帐id
                               From 门诊费用记录 A, 门诊费用记录 B
                               Where a.No = b.No And Mod(b.记录性质, 10) = 1 And b.结帐id = n_原结帐id) B
                        Where a.结帐id = b.结帐id And Mod(a.记录性质, 10) = 1 And Nvl(a.预交类别, 0) = 1 And a.结帐id <> 冲销id_In
                        Group By NO, 病人id
                        Having Sum(Nvl(a.冲预交, 0)) > 0
                        Order By 收款时间 Desc) Loop
          
            If v_退预交.金额 - n_预交金额 < 0 Then
              n_结算金额 := v_退预交.金额;
              n_预交金额 := n_预交金额 - v_退预交.金额;
            Else
              n_结算金额 := n_预交金额;
              n_预交金额 := 0;
            End If;
          
            Insert Into 病人预交记录
              (ID, 记录性质, NO, 实际票号, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id,
               结算卡序号, 卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 结算性质, 会话号)
              Select 病人预交记录_Id.Nextval, 11, NO, 实际票号, 记录状态, 病人id, Null, 摘要, 结算方式, r_Balancedata.收款时间,
                     r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, n_重结id, r_Balancedata.缴款组id, r_Balancedata.结算序号,
                     2, Null, Null, 卡号, 交易流水号, 交易说明, Null, 预交类别, 3, n_会话号
              From 病人预交记录
              Where ID = v_退预交.Id;
          
            --更新病人余额
            Update 病人余额
            Set 预交余额 = Nvl(预交余额, 0) + (-1 * n_结算金额)
            Where 病人id = v_退预交.病人id And 性质 = 1 And 类型 = 1
            Returning 预交余额 Into n_返回值;
            If Sql%RowCount = 0 Then
              Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (v_退预交.病人id, 1, -1 * n_结算金额, 1);
              n_返回值 := -1 * n_结算金额;
            End If;
            If Nvl(n_返回值, 0) = 0 Then
              Delete From 病人余额
              Where 病人id = v_退预交.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
            End If;
          
            Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = n_重结id And 结算方式 Is Null;
            n_返回值 := 1;
            If Sql%NotFound Then
              v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
              Raise Err_Item;
            End If;
            If n_预交金额 = 0 Then
              Exit;
            End If;
          End Loop;
        End If;
      Else
        --退预交款
        n_返回值   := 0;
        n_预交金额 := -1 * n_预交金额;
      
        For v_退预交 In (Select Max(a.Id) As ID, a.病人id, Max(a.收款时间) As 收款时间, Sum(Nvl(a.冲预交, 0)) As 金额
                      From 病人预交记录 A,
                           (Select Distinct a.结帐id
                             From 门诊费用记录 A, 门诊费用记录 B
                             Where a.No = b.No And Mod(b.记录性质, 10) = 1 And b.结帐id = n_原结帐id) B
                      Where a.结帐id = b.结帐id And Mod(a.记录性质, 10) = 1 And Nvl(a.预交类别, 0) = 1
                      Group By NO, 病人id
                      Having Sum(Nvl(a.冲预交, 0)) > 0
                      Order By 收款时间 Desc) Loop
        
          If v_退预交.金额 - n_预交金额 < 0 Then
            n_结算金额 := -1 * v_退预交.金额;
            n_预交金额 := n_预交金额 - v_退预交.金额;
          Else
            n_结算金额 := -1 * n_预交金额;
            n_预交金额 := 0;
          End If;
        
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 实际票号, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 结算性质, 会话号)
            Select 病人预交记录_Id.Nextval, 11, NO, 实际票号, 记录状态, 病人id, 主页id, 摘要, 结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
                   r_Balancedata.操作员姓名, n_结算金额, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null,
                   Null, 卡号, 交易流水号, 交易说明, Null, 预交类别, 3, n_会话号
            From 病人预交记录
            Where ID = v_退预交.Id;
        
          --更新病人余额
          Update 病人余额
          Set 预交余额 = Nvl(预交余额, 0) + (-1 * n_结算金额)
          Where 病人id = v_退预交.病人id And 性质 = 1 And 类型 = 1
          Returning 预交余额 Into n_返回值;
          If Sql%RowCount = 0 Then
            Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (v_退预交.病人id, 1, -1 * n_结算金额, 1);
            n_返回值 := -1 * n_结算金额;
          End If;
          If Nvl(n_返回值, 0) = 0 Then
            Delete From 病人余额
            Where 病人id = v_退预交.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
          End If;
        
          Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
          n_返回值 := 1;
          If Sql%NotFound Then
            v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
            Raise Err_Item;
          End If;
          If n_预交金额 = 0 Then
            Exit;
          End If;
        End Loop;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        v_Err_Msg := '未找到原始的冲预交记录,不能回退预交款！';
        Raise Err_Item;
      End If;
    
      If Nvl(n_预交金额, 0) <> 0 Then
        v_Err_Msg := '当前退预交超过了收费结算中的冲预交款,不能回退预交款！';
        Raise Err_Item;
      End If;
    
    End If;
  
    n_预交金额 := 冲预交_In;
    If Nvl(n_预交金额, 0) > 0 Then
      --冲预交款
      --病人余额检查
      Begin
        Select Sum(Nvl(预交余额, 0) - Nvl(费用余额, 0))
        Into n_预交金额
        From 病人余额
        Where 病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And Nvl(性质, 0) = 1 And 类型 = 1;
      Exception
        When Others Then
          n_预交金额 := 0;
      End;
      If n_预交金额 < 冲预交_In Then
        v_Err_Msg := '病人的当前预交余额为 ' || LTrim(To_Char(n_预交金额, '9999999990.00')) || '，小于本次支付金额 ' ||
                     LTrim(To_Char(冲预交_In, '9999999990.00')) || ' ！';
        Raise Err_Item;
      End If;
    
      n_预交金额 := 冲预交_In;
      n_结帐id   := 冲销id_In;
      If Nvl(n_重结id, 0) <> 0 Then
        n_结帐id := n_重结id;
      End If;
    
      --先缴先用，且先用自己的
      --不包含结算方式为代收款项的预交款。
      For c_冲预交 In (Select a.No, Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) As 金额, Nvl(Max(a.结帐id), 0) As 结帐id, Max(病人id) As 病人id,
                           Max(Decode(a.记录性质, 1, a.记录状态, 1)) As 记录状态,
                           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.Id, 3, a.Id, 0), 0)) As ID,
                           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.收款时间, 3, a.收款时间, Null, Null))) As 收款时间
                    From 病人预交记录 A
                    Where a.记录性质 In (1, 11) And a.病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And
                          Nvl(a.预交类别, 2) = 1 And a.结算方式 Not In (Select 名称 From 结算方式 Where 性质 = 5)
                    Group By a.No
                    Having Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) <> 0
                    Order By Decode(病人id, Nvl(病人id_In, 0), 0, 1), 收款时间) Loop
      
        If c_冲预交.金额 - n_预交金额 < 0 Then
          n_冲预交 := c_冲预交.金额;
        Else
          n_冲预交 := n_预交金额;
        End If;
      
        If c_冲预交.结帐id = 0 Then
          --第一次冲预交(填上结帐ID，金额为0)
          Update 病人预交记录
          Set 冲预交 = 0, 结帐id = n_结帐id, 结算序号 = n_结算序号, 结算性质 = 3, 会话号 = n_会话号
          Where ID = c_冲预交.Id;
        End If;
        --冲上次剩余额
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
           结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质, 会话号)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
                 r_Balancedata.收款时间, r_Balancedata.操作员姓名, r_Balancedata.操作员编号, n_冲预交, n_结帐id, r_Balancedata.缴款组id, 预交类别,
                 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, n_结算序号, 3, n_会话号
          From 病人预交记录
          Where NO = c_冲预交.No And 记录状态 = c_冲预交.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
      
        --更新数据(结算方式为NULL的)
        Update 病人预交记录
        Set 冲预交 = 冲预交 - n_冲预交
        Where 结帐id = n_结帐id And 结算方式 Is Null
        Returning Nvl(冲预交, 0) Into n_返回值;
      
        --更新病人预交余额
        Update 病人余额
        Set 预交余额 = Nvl(预交余额, 0) - n_冲预交
        Where 病人id = c_冲预交.病人id And 性质 = 1 And 类型 = 1
        Returning 预交余额 Into n_返回值;
        If Sql%RowCount = 0 Then
          Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (c_冲预交.病人id, 1, -1 * n_冲预交, 1);
          n_返回值 := -1 * n_冲预交;
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 病人余额
          Where 病人id = c_冲预交.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
        End If;
      
        --检查是否已经处理完
        If c_冲预交.金额 < n_预交金额 Then
          n_预交金额 := n_预交金额 - c_冲预交.金额;
        Else
          n_预交金额 := 0;
        End If;
        If n_预交金额 = 0 Then
          Exit;
        End If;
      End Loop;
    
      --检查金额是否足够
      If Abs(n_预交金额) > 0 Then
        v_Err_Msg := '病人的当前预交余额小于本次支付金额 ' || LTrim(To_Char(冲预交_In, '9999999990.00')) || ' ！';
        Raise Err_Item;
      End If;
    End If;
  End If;

  If 操作类型_In = 1 Then
    --   1-普通退费方式:
    --各个收费结算 :格式为:"结算方式|结算金额|结算号码|结算摘要||.."
    v_结算内容 := 结算方式_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
    
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      If v_结算方式 Is Null Then
        v_结算方式 := 缺省结算方式_In;
      End If;
      If Nvl(n_结算金额, 0) <> 0 Then
        n_结算金额 := Nvl(n_结算金额, 0);
        If Nvl(n_重结id, 0) <> 0 Then
          --肯定是收款
          --1.先按此种方式全退
          --2.再按此种方式收款
          --3:1+2=本次退款
          --1.先将退费的全部作废掉
          Select Sum(冲预交)
          Into n_返回值
          From 病人预交记录
          Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
        
          If Nvl(n_返回值, 0) <> 0 Then
            Insert Into 病人预交记录
              (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
               卡号, 交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
            Values
              (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
               r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_返回值, 冲销id_In, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2,
               Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
            Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(n_返回值, 0) Where 结帐id = 冲销id_In And 结算方式 Is Null;
          End If;
          n_结算金额 := n_结算金额 - Nvl(n_返回值, 0);
          --2.退款
          If Nvl(n_结算金额, 0) <> 0 Then
            Insert Into 病人预交记录
              (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
               卡号, 交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
            Values
              (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
               r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, n_重结id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2,
               Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
            Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = n_重结id And 结算方式 Is Null;
          End If;
        Else
          --退款
          If Nvl(n_结算金额, 0) <> 0 Then
            Insert Into 病人预交记录
              (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
               卡号, 交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
            Values
              (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
               r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, r_Balancedata.结帐id, r_Balancedata.缴款组id,
               r_Balancedata.结算序号, 2, Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
          
            Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
            If Sql%NotFound Then
              v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
              Raise Err_Item;
            End If;
          End If;
        End If;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If 操作类型_In = 2 Then
    --   2.三方卡退费结算:
    v_当前结算 := 结算方式_In;
    v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
    v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
  
    If Nvl(n_结算金额, 0) <> 0 Then
      If Nvl(n_重结id, 0) <> 0 Then
        --1.先按此种方式全退
        --2.再按此种方式收款
        --3:1+2=本次退款
        --1.先将退费的全部作废掉
        Select Sum(冲预交)
        Into n_返回值
        From 病人预交记录
        Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
        If Nvl(n_返回值, 0) <> 0 Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
             卡号, 交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
          Values
            (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
             r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_返回值, 冲销id_In, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2,
             卡类别id_In, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
          Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(n_返回值, 0) Where 结帐id = 冲销id_In And 结算方式 Is Null;
        End If;
        n_结算金额 := n_结算金额 - Nvl(n_返回值, 0);
      
        --2.退款
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
           交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
           r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, n_重结id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2,
           卡类别id_In, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
        Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = n_重结id And 结算方式 Is Null;
      
      Else
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
           交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
           r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号,
           2, 卡类别id_In, Null, 卡号_In, 交易流水号_In, 交易说明_In, v_结算号码, 3, n_会话号);
      
        Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
        If Sql%NotFound Then
          v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
          Raise Err_Item;
        End If;
      End If;
    End If;
  End If;

  If 操作类型_In = 3 Then
    --   3-医保结算(如果存在医保的结算,则要先删除原医保结算,后按新传入的更新)
    --3.1检查是否已经存在医保结算数据,存在先删除
    n_结算金额 := 0;
    For v_医保 In (Select ID, 结算方式, 冲预交
                 From 病人预交记录 A
                 Where 结帐id = 冲销id_In And Exists
                  (Select 1 From 结算方式 Where a.结算方式 = 名称 And 性质 In (3, 4)) And Mod(记录性质, 10) <> 1) Loop
      n_结算金额 := n_结算金额 + Nvl(v_医保.冲预交, 0);
      l_预交id.Extend;
      l_预交id(l_预交id.Count) := v_医保.Id;
    End Loop;
    If Nvl(n_结算金额, 0) <> 0 Then
      Update 病人预交记录
      Set 冲预交 = Nvl(冲预交, 0) + Nvl(n_结算金额, 0)
      Where 结帐id = 冲销id_In And 结算方式 Is Null;
      If Sql%NotFound Then
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
        Raise Err_Item;
      End If;
    End If;
    If l_预交id.Count <> 0 Then
      Forall I In 1 .. l_预交id.Count
        Delete 病人预交记录 Where ID = l_预交id(I);
    End If;
  
    If 结算方式_In Is Not Null Then
      v_结算内容 := 结算方式_In || '||';
    End If;
  
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      n_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      For c_结算信息 In (Select 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号
                     From 病人预交记录
                     Where 结帐id = 冲销id_In And 结算方式 Is Null) Loop
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 2, c_结算信息.病人id, Null, '保险结算', v_结算方式, c_结算信息.收款时间, c_结算信息.操作员编号, c_结算信息.操作员姓名,
           n_结算金额, c_结算信息.结帐id, c_结算信息.缴款组id, c_结算信息.结算序号, 1, 3, n_会话号);
      End Loop;
      --更新数据(结算方式为NULL的)
      Update 病人预交记录
      Set 冲预交 = 冲预交 - n_结算金额
      Where 结帐id = 冲销id_In And 结算方式 Is Null
      Returning Nvl(冲预交, 0) Into n_返回值;
    
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --4-消费卡批量结算
  If 操作类型_In = 4 Then
    v_结算内容 := 结算方式_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      --卡类别ID|卡号|消费卡ID|消费金额
      n_卡类别id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_卡号     := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_消费卡id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(v_当前结算);
      Begin
        Select 名称, 自制卡, 结算方式 Into v_名称, n_自制卡, v_结算方式 From 卡消费接口目录 Where 编号 = n_卡类别id;
      Exception
        When Others Then
          v_名称 := Null;
      End;
      If v_名称 Is Null Then
        v_Err_Msg := '未找到对应的结算卡接口,本次刷卡消费失败!';
        Raise Err_Item;
      End If;
      If v_结算方式 Is Null Then
        v_Err_Msg := v_名称 || '未设置对应的结算方式,本次刷卡消费失败!';
        Raise Err_Item;
      End If;
      If Nvl(n_结算金额, 0) <> 0 Then
        n_结帐id := 冲销id_In;
      
        If Nvl(n_重结id, 0) <> 0 Then
        
          Select Sum(冲预交)
          Into n_返回值
          From 病人预交记录
          Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
          If Nvl(n_返回值, 0) <> 0 Then
          
            Update 病人预交记录
            Set 冲预交 = Nvl(冲预交, 0) + Nvl(n_返回值, 0)
            Where 结帐id = 冲销id_In And 结算方式 = v_结算方式 And 结算卡序号 = n_卡类别id
            Returning ID Into n_预交id;
          
            If Sql%NotFound Then
              Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
              Insert Into 病人预交记录
                (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算卡序号, 校对标志,
                 结算性质, 会话号)
              Values
                (n_预交id, 3, Null, 2, r_Balancedata. 病人id, Null, Null, v_结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
                 r_Balancedata. 操作员姓名, n_返回值, r_Balancedata.结帐id, r_Balancedata. 缴款组id, r_Balancedata.结算序号, n_卡类别id, 2,
                 3, n_会话号);
            End If;
            Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(n_返回值, 0) Where 结帐id = 冲销id_In And 结算方式 Is Null;
          
            --插入卡结算记录
            --检查消费卡是否正确
            n_序号 := Zl_消费卡目录_Check(n_卡类别id, v_卡号, n_消费卡id, v_Err_Msg);
            If Nvl(n_序号, 0) = 0 Then
              Raise Err_Item;
            End If;
            Begin
              Select Nvl(Max(Nvl(序号, 0)), 0) + 1
              Into n_序号
              From 病人卡结算记录
              Where 接口编号 = n_卡类别id And Nvl(消费卡id, 0) = Nvl(n_消费卡id, 0) And 卡号 = v_卡号;
            Exception
              When Others Then
                n_序号 := 1;
            End;
          
            Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
          
            Insert Into 病人卡结算记录
              (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
            Values
              (n_Id, n_卡类别id, n_消费卡id, n_序号, 1, v_结算方式, n_返回值, v_卡号, Null, r_Balancedata.收款时间, Null, 0);
          
            --如果消费卡,需同时更改其余额
            If Nvl(n_消费卡id, 0) <> 0 Then
              Update 消费卡目录 Set 余额 = 余额 - n_返回值 Where ID = n_消费卡id;
              If Sql%NotFound Then
                v_Err_Msg := '卡号为' || v_卡号 || '的' || v_名称 || '未找到!';
                Raise Err_Item;
              End If;
            End If;
            Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
            n_结算金额 := n_结算金额 - Nvl(n_返回值, 0);
          End If;
          n_结帐id := n_重结id;
        
        End If;
      
        Update 病人预交记录
        Set 冲预交 = Nvl(冲预交, 0) + n_结算金额
        Where 结帐id = n_结帐id And 结算方式 = v_结算方式 And 结算卡序号 = n_卡类别id
        Returning ID Into n_预交id;
      
        If Sql%NotFound Then
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算卡序号, 校对标志, 结算性质,
             会话号)
          Values
            (n_预交id, 3, Null, Decode(Nvl(n_重结id, 0), 0, 2, 1), r_Balancedata. 病人id, Null, Null, v_结算方式,
             r_Balancedata. 收款时间, r_Balancedata. 操作员编号, r_Balancedata. 操作员姓名, n_结算金额, n_结帐id, r_Balancedata. 缴款组id,
             r_Balancedata. 结算序号, n_卡类别id, 2, 3, n_会话号);
        End If;
      
        --插入卡结算记录
        n_序号 := Zl_消费卡目录_Check(n_卡类别id, v_卡号, n_消费卡id, v_Err_Msg);
        If Nvl(n_序号, 0) = 0 Then
          Raise Err_Item;
        End If;
      
        Begin
          Select Nvl(Max(Nvl(序号, 0)), 0) + 1
          Into n_序号
          From 病人卡结算记录
          Where 接口编号 = n_卡类别id And Nvl(消费卡id, 0) = Nvl(n_消费卡id, 0) And 卡号 = v_卡号;
        Exception
          When Others Then
            n_序号 := 1;
        End;
      
        Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
      
        Insert Into 病人卡结算记录
          (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
        Values
          (n_Id, n_卡类别id, n_消费卡id, n_序号, 1, v_结算方式, n_结算金额, v_卡号, Null, r_Balancedata.收款时间, Null, 0);
        --如果消费卡,需同时更改其余额
        If Nvl(n_消费卡id, 0) <> 0 Then
          Update 消费卡目录 Set 余额 = 余额 - n_结算金额 Where ID = n_消费卡id;
          If Sql%NotFound Then
            v_Err_Msg := '卡号为' || v_卡号 || '的' || v_名称 || '未找到!';
            Raise Err_Item;
          End If;
        End If;
        Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
      
        --更新数据(结算方式为NULL的)
        Update 病人预交记录
        Set 冲预交 = 冲预交 - n_结算金额
        Where 结帐id = n_结帐id And 结算方式 Is Null
        Returning Nvl(冲预交, 0) Into n_返回值;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If Nvl(完成退费_In, 0) = 0 Then
    Return;
  End If;

  -----------------------------------------------------------------------------------------
  --完成收费,需要处理人员缴款余额,预交记录(结算方式=NULL)
  If Nvl(完成退费_In, 0) = 1 Then
    Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0, 会话号 = Null Where 结帐id = 冲销id_In;
    Return;
  End If;

  --1.删除结算方式为NULL的预交记录
  --结算方式为NULL的冲销记录和重结记录的金额之和为零，说明已完成全部结算
  If Nvl(n_重结id, 0) <> 0 Then
    Select Sum(Nvl(冲预交, 0))
    Into n_冲预交
    From 病人预交记录
    Where 结帐id In (冲销id_In, n_重结id) And 结算方式 Is Null;
    If Nvl(n_冲预交, 0) <> 0 Then
      v_Err_Msg := '还存在未缴款的数据,不能完成结算!';
      Raise Err_Item;
    Else
      Delete 病人预交记录 Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) = 0;
      If Sql%NotFound Then
        Update 病人预交记录 Set 结算方式 = v_退费结算 Where 结帐id = 冲销id_In And 结算方式 Is Null;
        If Sql%NotFound Then
          v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！!';
          Raise Err_Item;
        End If;
      End If;
    
      Delete 病人预交记录 Where 结帐id = n_重结id And 结算方式 Is Null And Nvl(冲预交, 0) = 0;
      If Sql%NotFound Then
        Update 病人预交记录 Set 结算方式 = v_退费结算 Where 结帐id = n_重结id And 结算方式 Is Null;
        If Sql%NotFound Then
          v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！!';
          Raise Err_Item;
        End If;
      End If;
    End If;
    Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0 Where 结帐id = n_重结id;
  Else
    Delete 病人预交记录 Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) = 0;
    If Sql%NotFound Then
      Select Count(*) Into n_Count From 病人预交记录 A Where 结帐id = 冲销id_In And 结算方式 Is Null;
      If n_Count <> 0 Then
        v_Err_Msg := '还存在未缴款的数据,不能完成结算!';
      Else
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！!';
      End If;
      Raise Err_Item;
    End If;
  End If;

  --检查门诊费用记录与病人预交记录的金额是否相等
  n_结算金额 := 0;
  n_冲预交   := 0;
  Select Nvl(Sum(实收金额), 0)
  Into n_结算金额
  From 门诊费用记录
  Where 结帐id In (Select 结帐id From 病人预交记录 Where 结算序号 = n_结算序号);
  Select Nvl(Sum(冲预交), 0) Into n_冲预交 From 病人预交记录 Where 结算序号 = n_结算序号;
  If n_结算金额 <> n_冲预交 Then
    v_Err_Msg := '结算信息有误，实收金额(' || n_结算金额 || ')与结算金额(' || n_冲预交 || ')不一致，不能完成结算！';
    Raise Err_Item;
  End If;

  --结算金额为零时，增加一条金额为0的病人预交记录
  Select Count(*) Into n_Count From 病人预交记录 A Where 结帐id = 冲销id_In;

  If n_Count = 0 Then
    v_结算方式 := 缺省结算方式_In;
    If v_结算方式 Is Null Then
      Begin
        Select 结算方式 Into v_结算方式 From 结算方式应用 Where 应用场合 = '收费' And Nvl(缺省标志, 0) = 1;
      Exception
        When Others Then
          v_结算方式 := Null;
      End;
      If v_结算方式 Is Null Then
        Begin
          Select 名称 Into v_结算方式 From 结算方式 Where Nvl(性质, 0) = 1;
        Exception
          When Others Then
            v_结算方式 := '现金';
        End;
      End If;
    End If;
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
       交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
    Values
      (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, Null, v_结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
       r_Balancedata.操作员姓名, 0, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null, Null, Null, Null,
       交易说明_In, Null, 3, n_会话号);
  End If;

  --2.处理缴款数据和找补数据及校对标志更新为0，会话号更新为NULL
  Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0, 会话号 = Null Where 结帐id = 冲销id_In;
  If Nvl(n_重结id, 0) <> 0 Then
    Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0, 会话号 = Null Where 结帐id = n_重结id;
  End If;

  --3.更新费用状态
  Update 门诊费用记录 Set 费用状态 = 0 Where 结帐id = 冲销id_In;
  If Nvl(n_重结id, 0) <> 0 Then
    Update 门诊费用记录 Set 费用状态 = 0 Where 结帐id = n_重结id;
  End If;

  --4.更新人员缴款数据
  If n_重结id <> 0 Then
    For c_缴款 In (Select 结算方式, 操作员姓名, Sum(Nvl(a.冲预交, 0)) As 冲预交
                 From 病人预交记录 A
                 Where a.结帐id In (冲销id_In, n_重结id) And Mod(a.记录性质, 10) <> 1
                 Group By 结算方式, 操作员姓名) Loop
    
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) + Nvl(c_缴款.冲预交, 0)
      Where 收款员 = c_缴款.操作员姓名 And 性质 = 1 And 结算方式 = c_缴款.结算方式;
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (c_缴款.操作员姓名, c_缴款.结算方式, 1, Nvl(c_缴款.冲预交, 0));
      End If;
    End Loop;
  
  Else
    For c_缴款 In (Select 结算方式, 操作员姓名, Sum(Nvl(a.冲预交, 0)) As 冲预交
                 From 病人预交记录 A
                 Where a.结帐id = 冲销id_In And Mod(a.记录性质, 10) <> 1
                 Group By 结算方式, 操作员姓名) Loop
    
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) + Nvl(c_缴款.冲预交, 0)
      Where 收款员 = c_缴款.操作员姓名 And 性质 = 1 And 结算方式 = c_缴款.结算方式;
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (c_缴款.操作员姓名, c_缴款.结算方式, 1, Nvl(c_缴款.冲预交, 0));
      End If;
    End Loop;
  End If;
  --消息推送
  Select 病人id_In || ',' || 冲销id_In || ',' || Decode(完成退费_In, 2, 0, 0, 0, 1) Into v_Msg From Dual;
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 5, v_Msg;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊退费结算_Modify;
/

--106755:冉俊明,2017-03-14,作废的预交款单据不能再在消费环节使用。
Create Or Replace Procedure Zl_门诊收费记录_Insert
(
  No_In            门诊费用记录.No%Type,
  序号_In          门诊费用记录.序号%Type,
  病人id_In        门诊费用记录.病人id%Type,
  病人来源_In      Number,
  标识号_In        门诊费用记录.标识号%Type,
  付款方式_In      门诊费用记录.付款方式%Type,
  姓名_In          门诊费用记录.姓名%Type,
  性别_In          门诊费用记录.性别%Type,
  年龄_In          门诊费用记录.年龄%Type,
  费别_In          门诊费用记录.费别%Type,
  加班标志_In      门诊费用记录.加班标志%Type,
  病人科室id_In    门诊费用记录.病人科室id%Type,
  开单部门id_In    门诊费用记录.开单部门id%Type,
  开单人_In        门诊费用记录.开单人%Type,
  从属父号_In      门诊费用记录.从属父号%Type,
  收费细目id_In    门诊费用记录.收费细目id%Type,
  收费类别_In      门诊费用记录.收费类别%Type,
  计算单位_In      门诊费用记录.计算单位%Type,
  保险项目否_In    门诊费用记录.保险项目否%Type,
  保险大类id_In    门诊费用记录.保险大类id%Type,
  发药窗口_In      门诊费用记录.发药窗口%Type,
  付数_In          门诊费用记录.付数%Type,
  数次_In          门诊费用记录.数次%Type,
  附加标志_In      门诊费用记录.附加标志%Type,
  执行部门id_In    门诊费用记录.执行部门id%Type,
  价格父号_In      门诊费用记录.价格父号%Type,
  收入项目id_In    门诊费用记录.收入项目id%Type,
  收据费目_In      门诊费用记录.收据费目%Type,
  标准单价_In      门诊费用记录.标准单价%Type,
  应收金额_In      门诊费用记录.应收金额%Type,
  实收金额_In      门诊费用记录.实收金额%Type,
  统筹金额_In      门诊费用记录.统筹金额%Type,
  发生时间_In      门诊费用记录.发生时间%Type,
  登记时间_In      门诊费用记录.登记时间%Type,
  原no_In          门诊费用记录.No%Type,
  结帐id_In        门诊费用记录.结帐id%Type,
  收费结算_In      Varchar2,
  冲预交额_In      病人预交记录.冲预交%Type,
  保险结算_In      Varchar2,
  操作员编号_In    门诊费用记录.操作员编号%Type,
  操作员姓名_In    门诊费用记录.操作员姓名%Type,
  摘要_In          门诊费用记录.摘要%Type := Null,
  是否急诊_In      门诊费用记录.是否急诊%Type := 0,
  用法_In          药品收发记录.用法%Type := Null, --用法[|煎法]
  缴款_In          病人预交记录.缴款%Type := Null,
  找补_In          病人预交记录.找补%Type := Null,
  中药形态_In      门诊费用记录.结论%Type := Null,
  冲预交病人ids_In Varchar2 := Null
) As
  --功能：新收一张门诊收费单据
  --参数：
  --  病人来源_IN:1-门诊;2-住院  住院病人收费时用。
  --  原NO_IN:修改保存新单据时用。目前用于存放于药品收发记录的摘要中。
  --         原单据(记录状态=2)记录修改产生的新单据号。
  --         新单据(记录状态=1)记录所修改的原单据号。
  -- 收费结算_IN:格式="结算方式|结算金额|结算号码|结算摘要||.....",注意无结算号码和摘要时要用空格填充
  -- 保险结算_IN:格式="结算方式|结算金额||....."
  -- 冲预交病人ids_In:多个用逗分分离,冲预交时有效(冲预交类别与业务操作保持一致),主要是使用家属的预交款

  --该游标用于收费冲预交的可用预交列表(该SQL参考住院结帐)
  --先缴先用，且先用自己的
  --不包含结算方式为代收款项的预交款。
  Cursor c_Deposit
  (
    v_病人id        病人信息.病人id%Type,
    v_冲预交病人ids Varchar2
  ) Is
    Select a.No, Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) As 金额, Nvl(Max(a.结帐id), 0) As 结帐id, Max(病人id) As 病人id,
           Max(Decode(a.记录性质, 1, a.记录状态, 1)) As 记录状态,
           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.Id, 3, a.Id, 0), 0)) As ID,
           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.收款时间, 3, a.收款时间, Null, Null))) As 收款时间
    From 病人预交记录 A
    Where a.记录性质 In (1, 11) And a.病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And
          Nvl(a.预交类别, 2) = 1 And a.结算方式 Not In (Select 名称 From 结算方式 Where 性质 = 5)
    Group By a.No
    Having Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) <> 0
    Order By Decode(病人id, Nvl(v_病人id, 0), 0, 1), 收款时间;

  v_费用id        门诊费用记录.Id%Type;
  v_预交金额      病人预交记录.冲预交%Type;
  v_冲预交病人ids Varchar2(4000);
  n_冲预交        病人预交记录.冲预交%Type;

  v_用法 药品收发记录.用法%Type;
  v_煎法 药品收发记录.外观%Type;
  ------------------------------------------------------------
  --结算方式串
  v_结算内容 Varchar2(3000);
  v_当前结算 Varchar2(150);
  v_结算方式 病人预交记录.结算方式%Type;
  v_结算金额 病人预交记录.冲预交%Type;
  v_结算号码 病人预交记录.结算号码%Type;
  v_结算摘要 病人预交记录.摘要%Type;
  n_返回值   病人余额.费用余额%Type;

  v_Dec        Number;
  v_付款方式   医疗付款方式.名称%Type;
  v_费别性质   费别.属性%Type;
  n_新病人模式 Number;

  --临时变量
  Err_Custom Exception;
  v_Error    Varchar2(255);
  n_组id     财务缴款分组.Id%Type;
  n_单价小数 Number;

Begin
  n_组id          := Zl_Get组id(操作员姓名_In);
  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);

  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')), Zl_To_Number(Nvl(zl_GetSysParameter(157), '5'))
  Into v_Dec, n_单价小数
  From Dual;

  --门诊费用记录
  Select 病人费用记录_Id.Nextval Into v_费用id From Dual;
  Insert Into 门诊费用记录
    (ID, 记录性质, NO, 记录状态, 序号, 从属父号, 价格父号, 门诊标志, 病人id, 标识号, 付款方式, 姓名, 性别, 年龄, 病人科室id, 费别, 收费类别, 收费细目id, 计算单位, 保险项目否,
     保险大类id, 付数, 数次, 发药窗口, 加班标志, 附加标志, 收入项目id, 收据费目, 标准单价, 应收金额, 实收金额, 统筹金额, 记帐费用, 划价人, 开单部门id, 开单人, 发生时间, 登记时间, 执行部门id,
     执行状态, 结帐id, 结帐金额, 操作员编号, 操作员姓名, 摘要, 是否急诊, 结论, 缴款组id)
  Values
    (v_费用id, 1, No_In, 1, 序号_In, Decode(从属父号_In, 0, Null, 从属父号_In), Decode(价格父号_In, 0, Null, 价格父号_In),
     Decode(病人来源_In, 1, 1, 2), Decode(病人id_In, 0, Null, 病人id_In), Decode(标识号_In, 0, Null, 标识号_In), 付款方式_In, 姓名_In, 性别_In,
     年龄_In, 病人科室id_In, 费别_In, 收费类别_In, 收费细目id_In, 计算单位_In, 保险项目否_In, 保险大类id_In, 付数_In, 数次_In, 发药窗口_In, 加班标志_In, 附加标志_In,
     收入项目id_In, 收据费目_In, 标准单价_In, 应收金额_In, 实收金额_In, 统筹金额_In, 0, 操作员姓名_In, 开单部门id_In, 开单人_In, 发生时间_In, 登记时间_In, 执行部门id_In,
     0, 结帐id_In, 实收金额_In, 操作员编号_In, 操作员姓名_In, 摘要_In, 是否急诊_In, 中药形态_In, n_组id);

  If 序号_In = 1 Then
    --病人预交记录(第一行时处理)
    --正常结算
    If 收费结算_In Is Not Null Then
      --各个收费结算
      v_结算内容 := 收费结算_In || '||';
      While v_结算内容 Is Not Null Loop
      
        v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
        v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      
        v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
        v_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      
        v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
        v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
        v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
      
        If Nvl(v_结算金额, 0) <> 0 Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款, 找补, 缴款组id, 结算性质)
          Values
            (病人预交记录_Id.Nextval, 3, No_In, 1, Decode(病人id_In, 0, Null, 病人id_In), Null, v_结算摘要, v_结算方式, v_结算号码, 登记时间_In,
             操作员编号_In, 操作员姓名_In, v_结算金额, 结帐id_In, Decode(v_结算内容, 收费结算_In || '||', 缴款_In, Null),
             Decode(v_结算内容, 收费结算_In || '||', 找补_In, Null), n_组id, 3);
        End If;
      
        v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
      End Loop;
    End If;
  
    --各个保险结算
    If 保险结算_In Is Not Null Then
      v_结算内容 := 保险结算_In || '||';
      While v_结算内容 Is Not Null Loop
        v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      
        v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
        v_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
      
        If Nvl(v_结算金额, 0) <> 0 Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算性质)
          Values
            (病人预交记录_Id.Nextval, 3, No_In, 1, Decode(病人id_In, 0, Null, 病人id_In), '保险结算', v_结算方式, 登记时间_In, 操作员编号_In,
             操作员姓名_In, v_结算金额, 结帐id_In, n_组id, 3);
        End If;
        v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
      End Loop;
    End If;
  
    --预交结算
    If Nvl(冲预交额_In, 0) <> 0 Then
      If Nvl(病人id_In, 0) = 0 Then
        v_Error := '不能确定病人病人ID,收费使用预交款结算失败！';
        Raise Err_Custom;
      End If;
    
      v_预交金额 := 冲预交额_In;
      For r_Deposit In c_Deposit(病人id_In, v_冲预交病人ids) Loop
        If r_Deposit.金额 - v_预交金额 < 0 Then
          n_冲预交 := r_Deposit.金额;
        Else
          n_冲预交 := v_预交金额;
        End If;
      
        If r_Deposit.结帐id = 0 Then
          --第一次冲预交(填上结帐ID,金额为0)
          Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 3 Where ID = r_Deposit.Id;
        End If;
        --冲上次剩余额
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
           结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
                 登记时间_In, 操作员姓名_In, 操作员编号_In, n_冲预交, 结帐id_In, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 3
          From 病人预交记录
          Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
      
        --更新病人预交余额
        Update 病人余额
        Set 预交余额 = Nvl(预交余额, 0) - n_冲预交
        Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = 1
        Returning 预交余额 Into n_返回值;
        If Sql%RowCount = 0 Then
          Insert Into 病人余额 (病人id, 预交余额, 性质, 类型) Values (r_Deposit.病人id, -1 * n_冲预交, 1, 1);
          n_返回值 := -1 * 冲预交额_In;
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 病人余额
          Where 病人id = r_Deposit.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
        End If;
      
        --检查是否已经处理完
        If r_Deposit.金额 < v_预交金额 Then
          v_预交金额 := v_预交金额 - r_Deposit.金额;
        Else
          v_预交金额 := 0;
        End If;
        If v_预交金额 = 0 Then
          Exit;
        End If;
      End Loop;
      --检查金额是否足够
      If v_预交金额 > 0 Then
        v_Error := '病人的当前预交余额不足金额 ' || LTrim(To_Char(冲预交额_In, '9999999990.00')) || ' ！';
        Raise Err_Custom;
      End If;
    
    End If;
  End If;

  --相关汇总表的处理
  --汇总"人员缴款余额"(注意要处理个人帐户的结算)
  n_返回值 := 0;
  If 序号_In = 1 Then
    --各个收费结算
    If 收费结算_In Is Not Null Then
      v_结算内容 := 收费结算_In || '||';
      While v_结算内容 Is Not Null Loop
        v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
        v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
        v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
        v_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      
        If Nvl(v_结算金额, 0) <> 0 Then
          Update 人员缴款余额
          Set 余额 = Nvl(余额, 0) + Nvl(v_结算金额, 0)
          Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_结算方式
          Returning 余额 + n_返回值 Into n_返回值;
        
          If Sql%RowCount = 0 Then
            Insert Into 人员缴款余额
              (收款员, 结算方式, 性质, 余额)
            Values
              (操作员姓名_In, v_结算方式, 1, Nvl(v_结算金额, 0));
            n_返回值 := n_返回值 + Nvl(v_结算金额, 0);
          End If;
        End If;
      
        v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
      End Loop;
    End If;
  
    --各个保险结算
    If 保险结算_In Is Not Null Then
      v_结算内容 := 保险结算_In || '||';
      While v_结算内容 Is Not Null Loop
        v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      
        v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
        v_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
      
        If Nvl(v_结算金额, 0) <> 0 Then
          Update 人员缴款余额
          Set 余额 = Nvl(余额, 0) + Nvl(v_结算金额, 0)
          Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_结算方式
          Returning 余额 + n_返回值 Into n_返回值;
        
          If Sql%RowCount = 0 Then
            Insert Into 人员缴款余额
              (收款员, 结算方式, 性质, 余额)
            Values
              (操作员姓名_In, v_结算方式, 1, Nvl(v_结算金额, 0));
            n_返回值 := n_返回值 + Nvl(v_结算金额, 0);
          End If;
        End If;
      
        v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
      End Loop;
    End If;
    If Nvl(n_返回值, 0) = 0 Then
      Delete From 人员缴款余额 Where 性质 = 1 And 收款员 = 操作员姓名_In And Nvl(余额, 0) = 0;
    End If;
  End If;

  --药品和卫生材料部分
  If 收费类别_In In ('4', '5', '6', '7') Then
    --药品用法煎法分解
    If 用法_In Is Not Null Then
      If Instr(用法_In, '|') > 0 Then
        v_用法 := Substr(用法_In, 1, Instr(用法_In, '|') - 1);
        v_煎法 := Substr(用法_In, Instr(用法_In, '|') + 1);
      Else
        v_用法 := 用法_In;
      End If;
    End If;
    Zl_药品收发记录_销售出库(v_费用id, 原no_In, Null, Null, v_用法, v_煎法);
  End If;

  --更新部份病人信息
  If 序号_In = 1 And 病人id_In Is Not Null Then
    If 付款方式_In Is Not Null And Nvl(病人来源_In, 1) = 1 Then
      Select 名称 Into v_付款方式 From 医疗付款方式 Where 编码 = 付款方式_In;
    End If;
    Select Max(属性) Into v_费别性质 From 费别 Where 名称 = 费别_In; --2-动态费别不更新
  
    Update 病人信息
    Set 性别 = Decode(姓名, '新病人', Nvl(性别_In, 性别), 性别), 年龄 = Decode(姓名, '新病人', Nvl(年龄_In, 年龄), 年龄),
        姓名 = Decode(姓名, '新病人', 姓名_In, 姓名), 医疗付款方式 = Nvl(v_付款方式, 医疗付款方式), 费别 = Decode(v_费别性质, 1, 费别_In, 费别)
    Where 病人id = 病人id_In;
    Select Zl_To_Number(Nvl(zl_GetSysParameter('自动产生姓名', '1111'), '0')) Into n_新病人模式 From Dual;
    If n_新病人模式 = 1 Then
      Update 病人挂号记录
      Set 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = 年龄_In
      Where 病人id = 病人id_In And 姓名 = '新病人';
      Update 门诊费用记录
      Set 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = 年龄_In, 付款方式 = 付款方式_In
      Where 病人id = 病人id_In And 姓名 = '新病人';
    End If;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊收费记录_Insert;
/

--106755:冉俊明,2017-03-14,作废的预交款单据不能再在消费环节使用。
Create Or Replace Procedure Zl_病人预交记录_冲预交
(
  病人id_In        门诊费用记录.病人id%Type,
  预交支付_In      病人预交记录.冲预交%Type,
  结帐id_In        门诊费用记录.结帐id%Type,
  冲预交病人ids_In Varchar2 := Null
) As
  --冲预交病人ids_In:多个用逗分分离,冲预交时有效(冲预交类别与业务操作保持一致),主要是使用家属的预交款

  --该游标用于收费冲预交的可用预交列表
  --先缴先用，且先用自己的
  --不包含结算方式为代收款项的预交款。
  Cursor c_Deposit
  (
    v_病人id        病人信息.病人id%Type,
    v_冲预交病人ids Varchar2
  ) Is
    Select a.No, Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) As 金额, Nvl(Max(a.结帐id), 0) As 结帐id, Max(病人id) As 病人id,
           Max(Decode(a.记录性质, 1, a.记录状态, 1)) As 记录状态,
           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.Id, 3, a.Id, 0), 0)) As ID,
           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.收款时间, 3, a.收款时间, Null, Null))) As 收款时间
    From 病人预交记录 A
    Where a.记录性质 In (1, 11) And a.病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And a.预交类别 = 1 And
          a.结算方式 Not In (Select 名称 From 结算方式 Where 性质 = 5)
    Group By a.No
    Having Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) <> 0
    Order By Decode(病人id, Nvl(v_病人id, 0), 0, 1), 收款时间;
  --功能：新增一行病人挂号费用，并将结算汇总到病人预交记录
  --       同时汇总相关的汇总表(病人挂号汇总、费用汇总)
  --       第一行费用处理票据使用情况(领用ID_IN>0)

  v_Err_Msg Varchar2(255);
  Err_Item Exception;
  n_预交金额      病人预交记录.金额%Type;
  n_当前金额      病人预交记录.金额%Type;
  v_冲预交病人ids Varchar2(4000);
  n_返回值        病人余额.预交余额%Type;

  v_收款时间   病人预交记录.收款时间%Type;
  v_操作员编号 病人预交记录.操作员编号%Type;
  v_操作员姓名 病人预交记录.操作员姓名%Type;
  n_组id       财务缴款分组.Id%Type;
Begin
  Begin
    Select 登记时间, 操作员编号, 操作员姓名, 缴款组id
    Into v_收款时间, v_操作员编号, v_操作员姓名, n_组id
    From 门诊费用记录
    Where 结帐id = 结帐id_In And Rownum < 2;
  Exception
    When Others Then
      v_Err_Msg := '对应费用记录不存在,不能继续操作！';
      Raise Err_Item;
  End;

  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);

  --对于就诊卡通过预交金挂号
  If Nvl(预交支付_In, 0) <> 0 Then
    n_预交金额 := 预交支付_In;
    For r_Deposit In c_Deposit(病人id_In, v_冲预交病人ids) Loop
      n_当前金额 := Case
                  When r_Deposit.金额 - n_预交金额 < 0 Then
                   r_Deposit.金额
                  Else
                   n_预交金额
                End;
    
      If r_Deposit.结帐id = 0 Then
        --第一次冲预交(填上结帐ID,金额为0)
        Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 4 Where ID = r_Deposit.Id;
      End If;
      --冲上次剩余额
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 预交类别, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号,
         冲预交, 结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 预交类别, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
               v_收款时间, v_操作员姓名, v_操作员编号, n_当前金额, 结帐id_In, n_组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4
        From 病人预交记录
        Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
    
      --更新病人预交余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_当前金额
      Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (r_Deposit.病人id, 1, -1 * n_当前金额, 1);
        n_返回值 := -1 * n_当前金额;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Deposit.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      --检查是否已经处理完
      If r_Deposit.金额 < n_预交金额 Then
        n_预交金额 := n_预交金额 - r_Deposit.金额;
      Else
        n_预交金额 := 0;
      End If;
    
      If n_预交金额 = 0 Then
        Exit;
      End If;
    End Loop;
    If n_预交金额 > 0 Then
      v_Err_Msg := '预交余不够支付本次支付金额,不能继续操作！';
      Raise Err_Item;
    End If;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人预交记录_冲预交;
/

--106755:冉俊明,2017-03-14,作废的预交款单据不能再在消费环节使用。
CREATE OR REPLACE Procedure Zl_门诊收费结算_完成收费
(
  病人id_In     门诊费用记录.病人id%Type,
  结算序号id_In 病人预交记录.结算序号%Type,
  缴款_In       病人预交记录.缴款%Type := Null,
  找补_In       病人预交记录.找补%Type := Null,
  误差金额_In   门诊费用记录.实收金额%Type := Null,
  结算方式_In   病人预交记录.结算方式%Type := Null,
  预存款_In     病人预交记录.冲预交%Type := Null,
  退支票额_In   病人预交记录.冲预交%Type := Null,
  收费结算_In   Varchar2 := Null
) As
  --功能:完成收费处理
  --入参:结算方式_In-只针对全免费用的数据(即:一张单据中实收金额为零的费用)
  --收费结算_IN:格式="结算方式|结算金额|结算号码|结算摘要||.....",注意无结算号码和摘要时要用空格填充
  --预存款_IN:冲预存款

  --该游标用于收费冲预交的可用预交列表
  --先缴先用
  --不包含结算方式为代收款项的预交款。
  Cursor c_Deposit(v_病人id 病人信息.病人id%Type) Is
    Select a.No, Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) As 金额, Nvl(Max(a.结帐id), 0) As 结帐id,
           Max(Decode(a.记录性质, 1, a.记录状态, 1)) As 记录状态,
           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.Id, 3, a.Id, 0), 0)) As ID,
           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.收款时间, 3, a.收款时间, Null, Null))) As 收款时间
    From 病人预交记录 A
    Where a.记录性质 In (1, 11) And a.病人id = v_病人id And a.预交类别 = 1 And
          a.结算方式 Not In (Select 名称 From 结算方式 Where 性质 = 5)
    Group By a.No
    Having Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) <> 0
    Order By 收款时间;

  Cursor c_Balancedata(n_结帐id 病人预交记录.结帐id%Type) Is
    Select 记录性质, NO, 记录状态, 病人id, 主页id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号



    From 病人预交记录
    Where 结帐id = n_结帐id And 结算方式 Is Null;
  r_Balancedata c_Balancedata%RowType;

  v_Err_Msg Varchar2(255);
  Err_Item Exception;
  v_操作员姓名 病人预交记录.操作员姓名%Type;
  v_误差no     门诊费用记录.No%Type;
  v_Maxno      门诊费用记录.No%Type;
  n_误差结帐id 病人预交记录.结帐id%Type;
  n_Count      Number;
  v_结帐ids    Varchar2(500);
  n_Max结帐id  病人预交记录.结帐id%Type;
  n_执行状态   门诊费用记录.执行状态%Type;
  l_结帐id     t_Numlist := t_Numlist();
  n_病人id     病人预交记录.病人id%Type;
  ------------------------------------------------------------
  --结算方式串
  v_结算内容 Varchar2(3000);
  v_当前结算 Varchar2(150);
  v_结算方式 病人预交记录.结算方式%Type;

  n_结算金额     病人预交记录.冲预交%Type;
  v_结算号码     病人预交记录.结算号码%Type;
  v_结算摘要     病人预交记录.摘要%Type;
  n_冲预交       病人预交记录.冲预交%Type;
  n_当前剩余预交 病人预交记录.冲预交%Type;
  --------------------------------------------------------------
  --预存款
  n_预交金额 病人预交记录.冲预交%Type;
  n_返回值   病人预交记录.冲预交%Type;
  n_发送号   病人医嘱发送.发送号%Type;

Begin
  n_Max结帐id  := 0;
  n_误差结帐id := 0;
  v_操作员姓名 := Null;

  For v_结帐 In (Select 结帐id, Max(Decode(结算方式, Null, '-', '')) As 结算方式, Max(Decode(结算方式, Null, 冲预交, 0)) As 冲预交,
                      Max(Decode(记录性质, 1, Null, 11, Null, 操作员姓名)) As 操作员姓名,
                      Max(Decode(记录性质, 1, Null, 11, Null, NO)) As NO
               From 病人预交记录
               Where Nvl(病人id, 0) = Nvl(病人id_In, 0) And (结算序号 = 结算序号id_In Or 结帐id = 结算序号id_In)
               Group By 结帐id
               Order By 结帐id) Loop

    If Nvl(n_Max结帐id, 0) < Nvl(v_结帐.结帐id, 0) Then
      n_Max结帐id := Nvl(v_结帐.结帐id, 0);
      v_Maxno     := v_结帐.No;
    End If;
    If v_结帐.操作员姓名 Is Not Null And v_操作员姓名 Is Null Then
      v_操作员姓名 := v_结帐.操作员姓名;
    End If;

    If Nvl(v_结帐.结算方式, '-') = '-' And Floor(Abs(v_结帐.冲预交) * 10) <> Abs(v_结帐.冲预交) * 10 Then
      --存在分币小数,则可能需要处理分币,误差放在有小数的单据上
      n_误差结帐id := Nvl(v_结帐.结帐id, 0);
      v_误差no     := v_结帐.No;
    End If;
    l_结帐id.Extend;
    l_结帐id(l_结帐id.Count) := v_结帐.结帐id;
  End Loop;

  If l_结帐id.Count = 0 Or Nvl(n_Max结帐id, 0) = 0 Then
    v_Err_Msg := '未找到相关的结帐数据,不能完成收费,请与系统管员联系！';
    Raise Err_Item;
  End If;
  If Nvl(n_误差结帐id, 0) = 0 Then
    n_误差结帐id := n_Max结帐id;
    v_误差no     := v_Maxno;
  End If;

  n_病人id := Nvl(病人id_In, 0);
  If n_病人id = 0 Then
    n_病人id := Null;
  End If;

  If v_操作员姓名 Is Null Or v_误差no Is Null Or Nvl(n_误差结帐id, 0) = 0 Then
    Begin
      Select NO, 操作员姓名, 结帐id, 病人id
      Into v_误差no, v_操作员姓名, n_误差结帐id, n_病人id
      From 门诊费用记录
      Where 结帐id = Nvl(n_Max结帐id, 0) And Rownum = 1;
    Exception
      When Others Then
        n_误差结帐id := 0;
    End;
  End If;

  Open c_Balancedata(n_Max结帐id);
  Fetch c_Balancedata
    Into r_Balancedata;

  If Nvl(误差金额_In, 0) <> 0 Then
    --：填写门诊收费时所产生的误差费用,以保证与结算金额一致。
    --误差处理规则:放在存在小数结算的最后一张单据
    Zl_门诊收费误差_Insert(v_误差no, 误差金额_In);
    Update 病人预交记录
    Set 冲预交 = Nvl(冲预交, 0) + Nvl(误差金额_In, 0)
    Where 结帐id = n_误差结帐id And 结算方式 Is Null;
    If Sql%NotFound Then
      --插入保存数据
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款, 找补, 缴款组id, 结算序号, 结算性质)
        Select 病人预交记录_Id.Nextval, 3, v_误差no, 1, 病人id, 主页id, Null, Null, Null, 收款时间, 操作员编号, 操作员姓名, Nvl(误差金额_In, 0),
               n_误差结帐id, 0, 0, 缴款组id, 结算序号, 3
        From 病人预交记录
        Where 结帐id = n_Max结帐id And Rownum < 2;
    End If;
  End If;

  If Nvl(预存款_In, 0) <> 0 Then

    If Nvl(n_病人id, 0) = 0 Then
      v_Err_Msg := '不能确定病人的病人ID,收费使用预交款结算失败！';
      Raise Err_Item;
    End If;

    n_预交金额 := 预存款_In;
    For v_预交 In (Select /*+ rule */
                 Distinct c.结帐id, Max(c.冲预交) As 冲预交, Max(a.No) As NO
                 From 门诊费用记录 A, 病人预交记录 C, Table(l_结帐id) B
                 Where a.结帐id = c.结帐id And a.结帐id = b.Column_Value And c.结算方式 Is Null
                 Group By c.结帐id
                 Order By 结帐id) Loop
      If Nvl(n_预交金额, 0) > Nvl(v_预交.冲预交, 0) Then
        n_冲预交   := Nvl(v_预交.冲预交, 0);
        n_预交金额 := Nvl(n_预交金额, 0) - Nvl(v_预交.冲预交, 0);
      Else
        n_冲预交   := Nvl(n_预交金额, 0);
        n_预交金额 := 0;
      End If;

      If n_冲预交 <> 0 Then
        Update 病人预交记录 Set 冲预交 = Nvl(冲预交, 0) - n_冲预交 Where 结算方式 Is Null And 结帐id = v_预交.结帐id;
        n_当前剩余预交 := n_冲预交;
        For r_Deposit In c_Deposit(n_病人id) Loop
          If n_当前剩余预交 >= Nvl(r_Deposit.金额, 0) Then
            n_当前剩余预交 := n_当前剩余预交 - Nvl(r_Deposit.金额, 0);
            n_冲预交       := Nvl(r_Deposit.金额, 0);
          Else
            n_冲预交       := Nvl(n_当前剩余预交, 0);
            n_当前剩余预交 := 0;
          End If;
          If n_冲预交 <> 0 Then

            If r_Deposit.结帐id = 0 Then
              --第一次冲预交(填上结帐ID,金额为0)
              Update 病人预交记录
              Set 冲预交 = 0, 结帐id = v_预交.结帐id, 结算序号 = 结算序号id_In, 结算性质 = 3
              Where ID = r_Deposit.Id;
            End If;

            --冲上次剩余额
            Insert Into 病人预交记录
              (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号,
               冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质)
              Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
                     r_Balancedata.收款时间, r_Balancedata.操作员姓名, r_Balancedata.操作员编号,
                     Decode(Sign(r_Deposit.金额 - n_冲预交), -1, r_Deposit.金额, n_冲预交), v_预交.结帐id, r_Balancedata.缴款组id, 预交类别,
                     卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号id_In, 3
              From 病人预交记录
              Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;

          End If;
          If Nvl(n_当前剩余预交, 0) = 0 Then
            Exit;
          End If;
        End Loop;

        --检查金额是否足够
        If Nvl(n_当前剩余预交, 0) > 0 Then
          v_Err_Msg := '病人的当前预交余额不足金额 ' || LTrim(To_Char(预存款_In, '9999999990.00')) || ' ！';
          Raise Err_Item;
        End If;
      End If;
      If Nvl(n_预交金额, 0) = 0 Then
        Exit;
      End If;
    End Loop;
    --检查金额是否足够
    If n_预交金额 > 0 Then
      v_Err_Msg := '病人的当前预交余额不足金额 ' || LTrim(To_Char(预存款_In, '9999999990.00')) || ' ！';
      Raise Err_Item;
    End If;

    --更新病人预交余额
    Update 病人余额
    Set 预交余额 = Nvl(预交余额, 0) - Nvl(预存款_In, 0)
    Where 病人id = 病人id_In And 性质 = 1 And 类型 = 1
    Returning 预交余额 Into n_返回值;
    If Sql%RowCount = 0 Then
      Insert Into 病人余额 (病人id, 预交余额, 性质, 类型) Values (病人id_In, -预存款_In, 1, 1);
      n_返回值 := -预存款_In;
    End If;
    If Nvl(n_返回值, 0) = 0 Then
      Delete From 病人余额 Where 病人id = 病人id_In And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
    End If;
    If n_返回值 < 0 Then
      v_Err_Msg := '病人的当前预交余额不足金额 ' || LTrim(To_Char(预存款_In, '9999999990.00')) || ' ！';
      Raise Err_Item;
    End If;
  End If;

  If 收费结算_In Is Not Null Then
    If Nvl(退支票额_In, 0) <> 0 Then
      Begin
        Select b.名称
        Into v_结算方式
        From 结算方式应用 A, 结算方式 B
        Where a.应用场合 = '收费' And b.名称 = a.结算方式 And Nvl(b.应付款, 0) = 1 And Rownum <= 1;
      Exception
        When Others Then
          v_结算方式 := Null;
      End;
      If v_结算方式 Is Null Then
        v_Err_Msg := '在结算方式设置中不存在退支票的结算方式,请在结算方式中设置！';
        Raise Err_Item;
      End If;
      --退支票,单独处理
      Update 病人预交记录 Set 冲预交 = Nvl(冲预交, 0) - 退支票额_In Where 结算方式 Is Null And 结帐id = n_Max结帐id;
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款, 找补, 缴款组id, 结算序号, 结算性质)
        Select 病人预交记录_Id.Nextval, 3, NO, 1, 病人id, 主页id, Null, v_结算方式, Null, 收款时间, 操作员编号, 操作员姓名, 退支票额_In, 结帐id, 缴款_In,
               找补_In, 缴款组id, 结算序号, 3
        From 病人预交记录 A
        Where 结帐id = n_Max结帐id And 结算方式 Is Null;
    End If;
    --各个收费结算
    v_结算内容 := 收费结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);

      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
      If Nvl(n_结算金额, 0) <> 0 Then
        For v_预交 In (Select /*+ rule */
                     Distinct c.结帐id, Max(c.冲预交) As 冲预交, Max(a.No) As NO
                     From 门诊费用记录 A, 病人预交记录 C, Table(l_结帐id) B
                     Where a.结帐id = c.结帐id And a.结帐id = b.Column_Value And c.结算方式 Is Null
                     Group By c.结帐id
                     Order By 结帐id) Loop
          n_冲预交 := Nvl(n_结算金额, 0);
          If Abs(Nvl(n_结算金额, 0)) > Abs(Nvl(v_预交.冲预交, 0)) Then
            n_冲预交 := Nvl(v_预交.冲预交, 0);
          End If;
          n_结算金额 := Nvl(n_结算金额, 0) - Nvl(n_冲预交, 0);
          If Nvl(n_冲预交, 0) <> 0 Then
            Update 病人预交记录
            Set 冲预交 = Nvl(冲预交, 0) - n_冲预交
            Where 结算方式 Is Null And 结帐id = v_预交.结帐id;
            Insert Into 病人预交记录
              (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款, 找补, 缴款组id, 结算序号, 结算性质)
              Select 病人预交记录_Id.Nextval, 3, v_预交.No, 1, 病人id, 主页id, v_结算摘要, v_结算方式, v_结算号码, 收款时间, 操作员编号, 操作员姓名, n_冲预交,
                     结帐id, 缴款_In, 找补_In, 缴款组id, 结算序号, 3
              From 病人预交记录
              Where 结帐id = v_预交.结帐id And 结算方式 Is Null;
          End If;
          If n_结算金额 = 0 Then
            Exit;
          End If;
        End Loop;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --如果本次结算中结算方式为空的记录的冲预交之和为0，也表示全部结算
  Begin
    Select Nvl(Sum(冲预交), 0)
    Into n_预交金额
    From 病人预交记录
    Where 结算序号 = 结算序号id_In And 结算方式 Is Null And Nvl(病人id, 0) = Nvl(病人id_In, 0)
    Group By 结算序号;
  Exception
    When Others Then
      n_预交金额 := 0;
  End;

  If Nvl(n_预交金额, 0) = 0 Then
    Begin
      Select 名称 Into v_结算方式 From 结算方式 Where 性质 = 1 And Rownum = 1;
    Exception
      When Others Then
        v_结算方式 := '现金';
    End;

    For v_预交 In (Select Distinct 结帐id, Nvl(冲预交, 0) As 冲预交
                 From 病人预交记录
                 Where 结算序号 = 结算序号id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0) Loop

      n_冲预交 := v_预交.冲预交;
      Update 病人预交记录
      Set 冲预交 = Nvl(冲预交, 0) + n_冲预交
      Where 结算方式 = v_结算方式 And 结帐id = v_预交.结帐id;
      If Sql%NotFound Then
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款, 找补, 缴款组id, 结算序号, 结算性质)
          Select 病人预交记录_Id.Nextval, 3, NO, 1, 病人id, 主页id, 摘要, v_结算方式, v_结算号码, 收款时间, 操作员编号, 操作员姓名, n_冲预交, 结帐id, 缴款_In,
                 找补_In, 缴款组id, 结算序号, 3
          From 病人预交记录
          Where 结帐id = v_预交.结帐id And 结算方式 Is Null;
      End If;

      Update 病人预交记录 Set 冲预交 = Nvl(冲预交, 0) - n_冲预交 Where 结算方式 Is Null And 结帐id = v_预交.结帐id;
    End Loop;
  End If;

  --删除已经分摊完成的记录
  Forall I In 1 .. l_结帐id.Count
    Delete 病人预交记录 Where 结帐id = l_结帐id(I) And 结算方式 Is Null And Nvl(冲预交, 0) = 0;

  Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In Where 结算序号 = 结算序号id_In;
  Select Count(*) Into n_Count From 病人预交记录 A Where 结算序号 = 结算序号id_In And 结算方式 Is Null;
  If n_Count <> 0 Then
    v_Err_Msg := '还存在未缴款的数据,不能完成结算!';
    Raise Err_Item;
  End If;

  Forall I In 1 .. l_结帐id.Count
    Update 病人预交记录 Set 校对标志 = 0 Where 结帐id = l_结帐id(I) And Nvl(病人id, 0) = Nvl(病人id_In, 0);

  Forall I In 1 .. l_结帐id.Count
    Update 门诊费用记录 Set 执行状态 = 0, 费用状态 = 0 Where 结帐id = l_结帐id(I) And Nvl(费用状态, 0) = 1;

  --更新执行状态
  --执行状态含义：0:未执行;1:完全执行;2:部份执行
  --1:非药品和卫材,如果执行人不为空,则执行状态为1,否则为0
  --2.药品和卫材,如果执行人为空,则为零,否则按如下规则处理:
  --  存在数量与药品收发记录中的数量不等时,则为部分执行,填为2,否则为1完全执行
  For v_费用 In (Select /*+ rule */
                Max(Decode(a.价格父号, Null, a.Id, 0)) ID, NO, Nvl(a.价格父号, a.序号) As 序号, a.收费类别, a.收费细目id, a.执行人, Avg(a.付数) 付数,
                Avg(a.数次) 数次, a.医嘱序号, Max(Nvl(m.跟踪在用, 0)) As 跟踪在用, Max(Nvl(j.诊疗类别, '--')) As 诊疗类别
               From 门诊费用记录 A, Table(l_结帐id) B, 材料特性 M, 病人医嘱记录 J
               Where a.结帐id = b.Column_Value And a.记录性质 = 1 And a.收费细目id + 0 = m.材料id(+) And a.执行时间 Is Not Null And
                     a.医嘱序号 + 0 = j.Id(+)
               Group By NO, Nvl(a.价格父号, a.序号), 收费类别, a.收费细目id, 执行人, a.医嘱序号) Loop
    n_执行状态 := 1;
    If Instr(',5,6,7,', ',' || v_费用.收费类别 || ',') > 0 Or (v_费用.跟踪在用 = 1 And v_费用.收费类别 = '4') Then
      --药品卫生材料,需要检查是否存数据
      Begin
        Select Max(2)
        Into n_执行状态
        From 药品收发记录
        Where 单据 In (24, 8) And NO = v_费用.No And 费用id = v_费用.Id And 审核日期 Is Not Null Having
         Sum(Nvl(付数, 1) * Nvl(实际数量, 0)) <> Nvl(v_费用.付数, 1) * Nvl(v_费用.数次, 0);
      Exception
        When Others Then
          Null;
      End;
    Else
      If Nvl(v_费用.医嘱序号, 0) <> 0 Then
        Begin
          --拒绝执行的,表示未执行
          Select Decode(执行状态, 2, 0, 执行状态), 发送号
          Into n_执行状态, n_发送号
          From 病人医嘱发送
          Where NO = v_费用.No And 记录性质 = 1 And 医嘱id = Nvl(v_费用.医嘱序号, 0);
        Exception
          When Others Then
            n_执行状态 := 0;
        End;
        If Nvl(n_执行状态, 0) = 3 Then
          --分两种情况判断(根据医吃执行计价表中有无数据进行检查)
          --1.无数据,就按以前的统计办法来判断是否部分执行(主要是歉容以前数据)
          --2.有数据,按此表数据统计未执行数量来判断是否部分执行
          Select Count(*)
          Into n_Count
          From 医嘱执行计价 A
          Where 医嘱id = Nvl(v_费用.医嘱序号, 0) And a.发送号 = Nvl(n_发送号, 0) And Rownum <= 1;

          If Nvl(n_Count, 0) = 0 Then
            --1.无数据,就按以前的统计办法来判断是否部分执行(主要是歉容以前数据)
            If Instr(',C,D,F,G,K,--,', ',' || v_费用.诊疗类别 || ',') = 0 And Nvl(v_费用.医嘱序号, 0) <> 0 Then
              --总执行与未执数相同,为未执行;未执行数为零,完全执行;否则部分执行
              Begin
                Select Decode(剩余数, 执行总次数, 0, 0, 1, 2)
                Into n_执行状态
                From (Select Max(a.发送数次) As 执行总次数,
                              Max(a.发送数次) - Nvl(Sum(Decode(Nvl(b.执行结果, 0), 1, 1, 0) * Nvl(b.本次数次, 0)), 0) As 剩余数
                       From 病人医嘱发送 A, 病人医嘱执行 B
                       Where a.医嘱id = b.医嘱id(+) And a.发送号 = b.发送号(+) And a.医嘱id = Nvl(v_费用.医嘱序号, 0) And
                             a.发送号 = Nvl(n_发送号, 0));
              Exception
                When Others Then
                  n_执行状态 := 1;
              End;
            End If;
          Else
            --2. 有数据,按此表数据统计未执行数量来判断是否部分执行
            Begin
              Select Decode(Sign(Nvl(未执行数量, 0)), 0, 1, 2)
              Into n_执行状态
              From (Select Sum(Decode(Nvl(b.执行结果, 0), 0, 1, 0) * a.数量) As 未执行数量
                     From 医嘱执行计价 A, 病人医嘱执行 B
                     Where a.医嘱id = b.医嘱id(+) And a.发送号 = b.发送号(+) And a.要求时间 = b.要求时间(+) And a.医嘱id = Nvl(v_费用.医嘱序号, 0) And
                           a.发送号 = Nvl(n_发送号, 0));
            Exception
              When Others Then
                n_执行状态 := 0;
            End;
          End If;
        End If;
      End If;
    End If;
    n_执行状态 := Nvl(n_执行状态, 1);
    Update 门诊费用记录
    Set 执行状态 = n_执行状态
    Where 记录性质 = 1 And 记录状态 = 1 And NO = v_费用.No And Nvl(价格父号, 序号) = v_费用.序号 And 收费细目id = v_费用.收费细目id;
  End Loop;

  For v_缴款 In (Select 结算方式, Sum(Nvl(a.冲预交, 0)) As 冲预交
               From 病人预交记录 A
               Where a.结算序号 = 结算序号id_In And Mod(a.记录性质, 10) <> 1 And Nvl(病人id, 0) = Nvl(病人id_In, 0)
               Group By 结算方式) Loop

    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + Nvl(v_缴款.冲预交, 0)
    Where 收款员 = v_操作员姓名 And 性质 = 1 And 结算方式 = v_缴款.结算方式;
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额
        (收款员, 结算方式, 性质, 余额)
      Values
        (v_操作员姓名, v_缴款.结算方式, 1, Nvl(v_缴款.冲预交, 0));
    End If;
  End Loop;
  --收费后产生导引
  For r_结帐 In (Select Distinct a.结帐id From 病人预交记录 A Where 结算序号 = 结算序号id_In) Loop
    v_结帐ids := v_结帐ids || ',' || r_结帐.结帐id;
  End Loop;
  If v_结帐ids Is Not Null Then
    v_结帐ids := Substr(v_结帐ids, 2);
  End If;
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 4, v_结帐ids;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊收费结算_完成收费;
/

--106755:冉俊明,2017-03-14,作废的预交款单据不能再在消费环节使用。
Create Or Replace Procedure Zl_划价收费记录_Insert
(
  No_In            门诊费用记录.No%Type,
  病人id_In        门诊费用记录.病人id%Type,
  病人来源_In      Number,
  付款方式_In      门诊费用记录.付款方式%Type,
  姓名_In          门诊费用记录.姓名%Type,
  性别_In          门诊费用记录.性别%Type,
  年龄_In          门诊费用记录.年龄%Type,
  病人科室id_In    门诊费用记录.病人科室id%Type,
  开单部门id_In    门诊费用记录.开单部门id%Type,
  开单人_In        门诊费用记录.开单人%Type,
  收费结算_In      Varchar2,
  冲预交额_In      病人预交记录.冲预交%Type,
  保险结算_In      Varchar2,
  结帐id_In        门诊费用记录.结帐id%Type,
  发生时间_In      门诊费用记录.发生时间%Type,
  操作员编号_In    门诊费用记录.操作员编号%Type,
  操作员姓名_In    门诊费用记录.操作员姓名%Type,
  发药窗口_In      Varchar2,
  是否急诊_In      门诊费用记录.是否急诊%Type := 0,
  缴款_In          病人预交记录.缴款%Type := Null,
  找补_In          病人预交记录.找补%Type := Null,
  三方卡结算_In    Varchar2 := Null,
  登记时间_In      门诊费用记录.登记时间%Type := Null,
  结算序号_In      病人预交记录.结算序号%Type := Null,
  交易流水号_In    病人预交记录.交易流水号%Type := Null,
  交易说明_In      病人预交记录.交易说明%Type := Null,
  简单收费_In      Number := 0,
  冲预交病人ids_In Varchar2 := Null
) As
  --功能：用于收费时收取划价单费用
  --参数：
  --      发药窗口_In:执行部门ID1|发药窗口1;...;执行部门IDn|发药窗口n
  --        病人来源_IN:1-门诊;2-住院
  --        收费结算_IN:格式="结算方式|结算金额|结算号码|结算摘要||.....",注意无结算号码和摘要时要用空格填充
  --        保险结算_IN:格式="结算方式|结算金额||....."
  --        三方卡结算_In:格式=卡类别Id|是否消费卡|结算金额|卡号|备注||...
  --        交易流水号_In和交易说明_In:收费结算_IN时有效.
  --        冲预交病人ids_In:多个用逗分分离,冲预交时有效(冲预交类别与业务操作保持一致),主要是使用家属的预交款
  --说明：
  --        1.收取划价费用时,才计算费用相关汇总,在划价时不处理;但药品相关汇总(姓名除外)划价时已经计算。
  --        2.收取划价费用时,目前界面及过程中未处理加收工本费,由划价时直接处理。
  --该游标为划价原单据内容

  --=================================
  --备注：该过程目前只有简单收费使用！
  --=================================

  Cursor c_Price Is
    Select ID
    From 门诊费用记录
    Where NO = No_In And 记录性质 = 1 And 记录状态 = 0 And 操作员姓名 Is Null
    Order By 序号;

  n_Array_Size Number := 200;
  t_费用id     t_Numlist;
  v_部门名称   部门表.名称%Type;
  --该游标用于收费冲预交的可用预交列表(该SQL参考住院结帐)
  --先缴先用，且先用自己的
  --不包含结算方式为代收款项的预交款。
  Cursor c_Deposit
  (
    v_病人id        病人信息.病人id%Type,
    v_冲预交病人ids Varchar2
  ) Is
    Select a.No, Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) As 金额, Nvl(Max(a.结帐id), 0) As 结帐id, Max(病人id) As 病人id,
           Max(Decode(a.记录性质, 1, a.记录状态, 1)) As 记录状态,
           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.Id, 3, a.Id, 0), 0)) As ID,
           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.收款时间, 3, a.收款时间, Null, Null))) As 收款时间
    From 病人预交记录 A
    Where a.记录性质 In (1, 11) And a.病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And
          Nvl(a.预交类别, 2) = 1 And a.结算方式 Not In (Select 名称 From 结算方式 Where 性质 = 5)
    Group By a.No
    Having Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) <> 0
    Order By Decode(病人id, Nvl(v_病人id, 0), 0, 1), 收款时间;

  --预交与结算相关变量
  n_预交金额 病人预交记录.冲预交%Type;
  v_结算内容 Varchar2(3000);
  v_当前结算 Varchar2(150);
  v_结算方式 病人预交记录.结算方式%Type;
  n_结算金额 病人预交记录.冲预交%Type;
  v_结算号码 病人预交记录.结算号码%Type;
  v_结算摘要 病人预交记录.摘要%Type;

  v_标识号        门诊费用记录.标识号%Type;
  v_付款方式      医疗付款方式.名称%Type;
  n_返回值        病人余额.预交余额%Type;
  v_冲预交病人ids Varchar2(4000);

  --临时变量
  n_Count      Number;
  n_新病人模式 Number;
  v_出库no     药品收发记录.No%Type;
  v_Date       Date;
  v_Err_Msg    Varchar2(255);
  Err_Item Exception;
  n_组id     财务缴款分组.Id%Type;
  n_卡类别id 医疗卡类别.Id%Type;
  n_消费卡   Number;
  v_卡号     病人预交记录.卡号%Type;
  v_卡名称   Varchar2(100);
  n_自制卡   Number;
  n_预交id   病人预交记录.Id%Type;
  n_消费卡id 消费卡目录.Id%Type;
  n_金额     病人预交记录.金额%Type;
Begin
  n_组id          := Zl_Get组id(操作员姓名_In);
  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);

  Select Count(ID)
  Into n_Count
  From 门诊费用记录
  Where 记录性质 = 1 And 记录状态 = 0 And NO = No_In And 操作员姓名 Is Null;
  If n_Count = 0 Then
    v_Err_Msg := '不能读取划价单内容,该单据可能已经删除或已经收费！';
    Raise Err_Item;
  End If;
  v_Date := 登记时间_In;
  If v_Date Is Null Then
    Select Sysdate Into v_Date From Dual;
  End If;
  If Nvl(病人id_In, 0) <> 0 Then
    Select Decode(当前科室id, Null, 门诊号, 住院号) Into v_标识号 From 病人信息 Where 病人id = 病人id_In;
  End If;

  ------------------------------------------------------------------------------------------------------------------------
  --批量更新
  Open c_Price;
  Loop
    Fetch c_Price Bulk Collect
      Into t_费用id Limit n_Array_Size;
    Exit When t_费用id.Count = 0;
  
    --循环处理门诊费用记录
    Forall I In 1 .. t_费用id.Count
    --执行状态相关字段不处理,在划价时处理;因为可能未收费发药,这种已执行的划价单是允许收费操作的。
    --为保证与预交结算记录的时间相同,重新填写登记时间,但药品部分不变动。
      Update 门诊费用记录
      Set 记录状态 = 1, 病人id = Decode(病人id_In, 0, Null, 病人id_In), 标识号 = v_标识号, 付款方式 = 付款方式_In, 姓名 = 姓名_In, 年龄 = 年龄_In,
          性别 = 性别_In,
          --可能保持医嘱发送的内容
          病人科室id = Nvl(病人科室id_In, 病人科室id), 开单部门id = Nvl(开单部门id_In, 开单部门id), 开单人 = Nvl(开单人_In, 开单人), 结帐金额 = 实收金额,
          结帐id = 结帐id_In, 发生时间 = 发生时间_In, 登记时间 = v_Date, 操作员编号 = 操作员编号_In, 操作员姓名 = 操作员姓名_In, 是否急诊 = 是否急诊_In,
          缴款组id = n_组id
      Where ID = t_费用id(I) And 记录状态 = 0;
  
    If Sql%RowCount <> t_费用id.Count Then
      v_Err_Msg := '由于并发操作,该单据可能已经删除或已经收费！';
      Raise Err_Item;
    End If;
  
  End Loop;
  Close c_Price;
  ------------------------------------------------------------------------------------------------------------------------

  --预交款相关结算
  --收费结算
  If 收费结算_In Is Not Null Then
    v_结算内容 := 收费结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      If Nvl(n_结算金额, 0) <> 0 Then
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款, 找补, 缴款组id, 结算序号, 交易流水号,
           交易说明, 结算性质)
        Values
          (病人预交记录_Id.Nextval, 3, No_In, 1, Decode(病人id_In, 0, Null, 病人id_In), Null, v_结算摘要, v_结算方式, v_结算号码, v_Date,
           操作员编号_In, 操作员姓名_In, n_结算金额, 结帐id_In, Decode(v_结算内容, 收费结算_In || '||', 缴款_In, Null),
           Decode(v_结算内容, 收费结算_In || '||', 找补_In, Null), n_组id, 结算序号_In, 交易流水号_In, 交易说明_In, 3);
      End If;
    
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If 保险结算_In Is Not Null Then
    --各个保险结算
    v_结算内容 := 保险结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
    
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      n_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      If Nvl(n_结算金额, 0) <> 0 Then
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算性质)
        Values
          (病人预交记录_Id.Nextval, 3, No_In, 1, Decode(病人id_In, 0, Null, 病人id_In), '保险结算', v_结算方式, v_Date, 操作员编号_In,
           操作员姓名_In, n_结算金额, 结帐id_In, n_组id, 结算序号_In, 3);
      End If;
    
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If 三方卡结算_In Is Not Null Then
    v_结算内容 := 三方卡结算_In || '||';
    While v_结算内容 Is Not Null Loop
      --卡类别Id|是否消费卡|结算金额|卡号|备注||...
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      n_卡类别id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_消费卡   := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_卡号     := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算摘要 := v_当前结算;
    
      If n_消费卡 = 1 Then
        Select 结算方式, 名称, Nvl(自制卡, 0)
        Into v_结算方式, v_卡名称, n_自制卡
        From 卡消费接口目录
        Where 编号 = n_卡类别id;
        If v_结算方式 Is Null Then
          v_Err_Msg := v_卡名称 || '未设置结算方式对照,请在消费卡中进行设置,结算失败！';
          Raise Err_Item;
        End If;
      Else
        Select 结算方式, 名称 Into v_结算方式, v_卡名称 From 医疗卡类别 Where ID = n_卡类别id;
        If v_结算方式 Is Null Then
          v_Err_Msg := v_卡名称 || '未设置结算方式对照,请在医疗卡管理中进行设置,结算失败！';
          Raise Err_Item;
        End If;
      End If;
      If Nvl(n_结算金额, 0) <> 0 Then
        Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 卡类别id, 结算卡序号, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款, 找补, 缴款组id,
           结算序号, 卡号, 结算性质)
        Values
          (n_预交id, 3, No_In, 1, Decode(病人id_In, 0, Null, 病人id_In), Null, v_结算摘要, Decode(n_消费卡, 1, Null, n_卡类别id),
           Decode(n_消费卡, 0, Null, n_卡类别id), v_结算方式, v_结算号码, v_Date, 操作员编号_In, 操作员姓名_In, n_结算金额, 结帐id_In, Null, Null,
           n_组id, 结算序号_In, v_卡号, 3);
      
        --卡结算对照
        If n_消费卡 = 1 Then
          n_消费卡id := Null;
          If n_自制卡 = 1 Then
            Select ID
            Into n_消费卡id
            From 消费卡目录
            Where 接口编号 = n_卡类别id And 卡号 = v_卡号 And
                  序号 = (Select Max(序号) From 消费卡目录 Where 接口编号 = n_卡类别id And 卡号 = v_卡号);
          End If;
          Zl_病人卡结算记录_Insert(n_卡类别id, n_消费卡id, v_结算方式, n_结算金额, v_卡号, Null, Null, v_结算摘要, 结帐id_In, n_预交id);
        End If;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --预交结算
  If Nvl(冲预交额_In, 0) <> 0 Then
    If Nvl(病人id_In, 0) = 0 Then
      v_Err_Msg := '不能确定病人信息,收费使用预交款结算失败！';
      Raise Err_Item;
    End If;
    --病人余额检查
    Begin
      Select Sum(Nvl(预交余额, 0) - Nvl(费用余额, 0))
      Into n_预交金额
      From 病人余额
      Where 病人id = 病人id_In And Nvl(性质, 0) = 1 And 类型 = 1;
    Exception
      When Others Then
        n_预交金额 := 0;
    End;
  
    If n_预交金额 < 冲预交额_In Then
      v_Err_Msg := '病人的当前预交余额为 ' || LTrim(To_Char(n_预交金额, '9999999990.00')) || '，小于本次支付金额 ' ||
                   LTrim(To_Char(冲预交额_In, '9999999990.00')) || '，支付失败！';
      Raise Err_Item;
    End If;
  
    n_预交金额 := 冲预交额_In;
    For r_Deposit In c_Deposit(病人id_In, v_冲预交病人ids) Loop
    
      n_金额 := Case
                When r_Deposit.金额 - n_预交金额 < 0 Then
                 r_Deposit.金额
                Else
                 n_预交金额
              End;
      If r_Deposit.结帐id = 0 Then
        --第一次冲预交(填上结帐ID,金额为0)
        Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 3 Where ID = r_Deposit.Id;
      End If;
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
         结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 登记时间_In,
               操作员姓名_In, 操作员编号_In, n_金额, 结帐id_In, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 3
        From 病人预交记录
        Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
    
      --更新病人预交余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_金额
      Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 预交余额, 类型, 性质) Values (r_Deposit.病人id, -n_金额, 1, 1);
        n_返回值 := -n_金额;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Deposit.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      --检查是否已经处理完
      If r_Deposit.金额 < n_预交金额 Then
        n_预交金额 := n_预交金额 - r_Deposit.金额;
      Else
        n_预交金额 := 0;
      End If;
      If n_预交金额 = 0 Then
        Exit;
      End If;
    End Loop;
    --检查金额是否足够
    If n_预交金额 > 0 Then
      v_Err_Msg := '病人的当前预交余额不足金额 ' || LTrim(To_Char(冲预交额_In, '9999999990.00')) || ' ！';
      Raise Err_Item;
    End If;
  
  End If;

  --相关汇总表的处理

  --汇总"人员缴款余额"
  --收费结算
  n_返回值 := 0;
  If 收费结算_In Is Not Null Then
    v_结算内容 := 收费结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    
      If Nvl(n_结算金额, 0) <> 0 Then
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + Nvl(n_结算金额, 0)
        Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_结算方式
        Returning Nvl(余额, 0) + n_返回值 Into n_返回值;
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额
            (收款员, 结算方式, 性质, 余额)
          Values
            (操作员姓名_In, v_结算方式, 1, Nvl(n_结算金额, 0));
          n_返回值 := Nvl(n_返回值, 0) + Nvl(n_结算金额, 0);
        End If;
      
      End If;
    
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --各个保险结算
  If 保险结算_In Is Not Null Then
    v_结算内容 := 保险结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
    
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      n_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      If Nvl(n_结算金额, 0) <> 0 Then
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + Nvl(n_结算金额, 0)
        Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_结算方式
        Returning Nvl(余额, 0) + n_返回值 Into n_返回值;
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额
            (收款员, 结算方式, 性质, 余额)
          Values
            (操作员姓名_In, v_结算方式, 1, Nvl(n_结算金额, 0));
          n_返回值 := Nvl(n_返回值, 0) + Nvl(n_结算金额, 0);
        End If;
      End If;
    
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If 三方卡结算_In Is Not Null Then
    v_结算内容 := 三方卡结算_In || '||';
    While v_结算内容 Is Not Null Loop
      --卡类别Id|是否消费卡|结算金额|卡号|备注||...
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      n_卡类别id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_消费卡   := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_卡号     := Substr(v_当前结算, 1, Instr(v_当前结算, '|') + 1);
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算摘要 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    
      If n_消费卡 = 1 Then
        Select 结算方式, 名称, Nvl(自制卡, 0)
        Into v_结算方式, v_卡名称, n_自制卡
        From 卡消费接口目录
        Where 编号 = n_卡类别id;
        If v_结算方式 Is Null Then
          v_Err_Msg := v_卡名称 || '未设置结算方式对照,请在消费卡中进行设置,结算失败！';
          Raise Err_Item;
        End If;
      Else
        Select 结算方式, 名称 Into v_结算方式, v_卡名称 From 医疗卡类别 Where ID = n_卡类别id;
        If v_结算方式 Is Null Then
          v_Err_Msg := v_卡名称 || '未设置结算方式对照,请在医疗卡管理中进行设置,结算失败！';
          Raise Err_Item;
        End If;
      End If;
    
      If Nvl(n_结算金额, 0) <> 0 Then
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + Nvl(n_结算金额, 0)
        Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_结算方式
        Returning Nvl(余额, 0) + n_返回值 Into n_返回值;
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额
            (收款员, 结算方式, 性质, 余额)
          Values
            (操作员姓名_In, v_结算方式, 1, Nvl(n_结算金额, 0));
          n_返回值 := Nvl(n_返回值, 0) + Nvl(n_结算金额, 0);
        End If;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If Nvl(n_返回值, 0) = 0 Then
    Delete From 人员缴款余额 Where 性质 = 1 And 收款员 = 操作员姓名_In And Nvl(余额, 0) = 0;
  End If;

  --药品部分非费用信息的修改
  --药品未发记录(如果已发药则修改不到),分离发药时无库房ID
  --可能存在材料和药品库房相同，但材料无发药窗口
  Update 未发药品记录
  Set 病人id = Decode(病人id_In, 0, Null, 病人id_In), 姓名 = 姓名_In, 对方部门id = 开单部门id_In, 已收费 = 1, 填制日期 = v_Date
  Where 单据 = 24 And NO = No_In And
        Nvl(库房id, 0) In (Select Distinct Nvl(执行部门id, 0)
                         From 门诊费用记录
                         Where 记录性质 = 1 And 记录状态 = 1 And NO = No_In And 收费类别 = '4');

  Update 未发药品记录
  Set 病人id = Decode(病人id_In, 0, Null, 病人id_In), 姓名 = 姓名_In, 对方部门id = 开单部门id_In, 已收费 = 1, 填制日期 = v_Date
  Where 单据 = 8 And NO = No_In And
        Nvl(库房id, 0) In (Select Distinct Nvl(执行部门id, 0)
                         From 门诊费用记录
                         Where 记录性质 = 1 And 记录状态 = 1 And NO = No_In And 收费类别 In ('5', '6', '7'));

  --药品收发记录(可能已经发药或取消发药,所有记录更改)
  Update 药品收发记录
  Set 对方部门id = 开单部门id_In, 填制日期 = Decode(Sign(Nvl(审核日期, v_Date) - v_Date), -1, 填制日期, v_Date)
  Where 单据 = 24 And NO = No_In And
        费用id + 0 In (Select ID From 门诊费用记录 Where 记录性质 = 1 And 记录状态 = 1 And NO = No_In And 收费类别 = '4');

  -------------------------------------------------------------------------------------------
  --处理备货卫材
  n_Count := Null;
  Begin
    Select Count(*), Max(a.No)
    Into n_Count, v_出库no
    From 药品收发记录 A, 门诊费用记录 B
    Where a.费用id = b.Id And b.收费类别 = '4' And b.记录性质 = 1 And b.记录状态 = 1 And
          Instr(',8,9,10,21,24,25,26,', ',' || a.单据 || ',') > 0 And b.No = No_In And Rownum <= 1;
  Exception
    When Others Then
      Null;
  End;
  If Nvl(n_Count, 0) > 0 Then
    If Nvl(病人科室id_In, 0) <> 0 Then
      Select 名称 Into v_部门名称 From 部门表 Where ID = 病人科室id_In;
    End If;
    v_Err_Msg := LPad(' ', 4);
    v_Err_Msg := Substr('病人姓名:' || 姓名_In || v_Err_Msg || '性别:' || 性别_In || v_Err_Msg || '年龄' || 年龄_In || v_Err_Msg ||
                        '门诊号:' || Nvl(v_标识号, '') || v_Err_Msg || '病人科室:' || v_部门名称, 1, 100);
  
    Update 药品收发记录
    Set 对方部门id = 开单部门id_In, 填制日期 = Decode(Sign(Nvl(审核日期, v_Date) - v_Date), -1, 填制日期, v_Date), 摘要 = v_Err_Msg
    Where 单据 = 21 And NO = v_出库no And
          费用id + 0 In (Select ID From 门诊费用记录 Where 记录性质 = 1 And 记录状态 = 1 And NO = No_In And 收费类别 = '4');
  End If;

  Update 药品收发记录
  Set 对方部门id = 开单部门id_In, 填制日期 = Decode(Sign(Nvl(审核日期, v_Date) - v_Date), -1, 填制日期, v_Date)
  Where 单据 = 8 And NO = No_In And
        费用id + 0 In
        (Select ID From 门诊费用记录 Where 记录性质 = 1 And 记录状态 = 1 And NO = No_In And 收费类别 In ('5', '6', '7'));
  If Not 发药窗口_In Is Null Then
    --更新发药窗口
    If Nvl(简单收费_In, 0) <> 0 Then
      Update 门诊费用记录
      Set 发药窗口 = 发药窗口_In
      Where NO = No_In And 记录性质 = 1 And 记录状态 = 1 And 收费类别 = 'Z';
    Else
      For v_窗口 In (Select To_Number(C1) As C1, C2 From Table(f_Str2list2(发药窗口_In, ';', '|'))) Loop
        Update 门诊费用记录
        Set 发药窗口 = Nvl(v_窗口.C2, 发药窗口)
        Where NO = No_In And 记录性质 = 1 And 记录状态 = 1 And 执行部门id = Nvl(v_窗口.C1, 执行部门id) And 收费类别 In ('5', '6', '7');
      
        Update 药品收发记录
        Set 发药窗口 = Nvl(v_窗口.C2, 发药窗口)
        Where 单据 = 8 And NO = No_In And 库房id = Nvl(v_窗口.C1, 库房id) And
              费用id + 0 In (Select ID
                           From 门诊费用记录
                           Where 记录性质 = 1 And 记录状态 = 1 And NO = No_In And 收费类别 In ('5', '6', '7'));
      
        Update 未发药品记录
        Set 发药窗口 = Nvl(v_窗口.C2, 发药窗口)
        Where 单据 = 8 And NO = No_In And 库房id = Nvl(v_窗口.C1, 库房id) And
              Nvl(库房id, 0) In (Select Distinct Nvl(执行部门id, 0)
                               From 门诊费用记录
                               Where 记录性质 = 1 And 记录状态 = 1 And NO = No_In And 收费类别 In ('5', '6', '7'));
      End Loop;
    End If;
  End If;

  --更新部份病人信息
  If 病人id_In Is Not Null Then
    If 付款方式_In Is Not Null And 病人来源_In = 1 Then
      Select 名称 Into v_付款方式 From 医疗付款方式 Where 编码 = 付款方式_In;
    End If;
    --通过划价单收费时不允许改费别,因为费用不允许变
    Update 病人信息
    Set 性别 = Nvl(性别_In, 性别), 年龄 = Nvl(年龄_In, 年龄), 姓名 = Decode(姓名, '新病人', 姓名_In, 姓名), 医疗付款方式 = Nvl(v_付款方式, 医疗付款方式)
    Where 病人id = 病人id_In;
    Select Zl_To_Number(Nvl(zl_GetSysParameter('自动产生姓名', '1111'), '0')) Into n_新病人模式 From Dual;
    If n_新病人模式 = 1 Then
    
      Update 病人挂号记录
      Set 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = 年龄_In
      Where 病人id = 病人id_In And 姓名 = '新病人';
    
      Update 门诊费用记录
      Set 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = 年龄_In, 付款方式 = 付款方式_In
      Where 病人id = 病人id_In And 姓名 = '新病人';
    End If;
  End If;
  --医嘱处理
  --场合_In    Integer:=0, --0:门诊;1-住院
  --性质_In    Integer:=1, --1-收费单;2-记帐单
  --操作_In    Integer:=0, --0:删除划价单;1-收费或记帐;2-退费或销帐
  --No_In      门诊费用记录.No%Type,
  --医嘱ids_In Varchar2 := Null
  Zl_医嘱发送_计费状态_Update(0, 1, 1, No_In);

Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_划价收费记录_Insert;
/

--106755:冉俊明,2017-03-14,作废的预交款单据不能再在消费环节使用。
Create Or Replace Procedure Zl_门诊收费结算_Update
(
  结帐id_In        门诊费用记录.结帐id%Type,
  收费结算_In      Varchar2,
  冲预交额_In      病人预交记录.冲预交%Type,
  保险结算_In      Varchar2,
  误差_In          门诊费用记录.实收金额%Type,
  缴款_In          病人预交记录.缴款%Type := Null,
  找补_In          病人预交记录.找补%Type := Null,
  冲预交病人ids_In Varchar2 := Null,
  是否退费结算_In  Number := 0
) As
  --功能:处理收费时和医保正式结算后,相关结算信息的调整
  --     因为预结算后,生成的医保结算金额总额及分摊可能会与正式结算时有差异,所以提供了校对功能,
  --   操作员在结算校对时,可以调整非医保结算方式的各种结算金额及方式,重新生成结算串,并且可能产生误差金额.
  -- 冲预交病人ids_In:多个用逗分分离,冲预交时有效(冲预交类别与业务操作保持一致),主要是使用家属的预交款
  --是否退费结算_In:是否退费结算调用

  --该游标用于收费冲预交的可用预交列表(该SQL参考住院结帐)
  --先缴先用，且先用自己的
  --不包含结算方式为代收款项的预交款。
  Cursor c_Deposit
  (
    v_病人id        病人信息.病人id%Type,
    v_冲预交病人ids Varchar2
  ) Is
    Select a.No, Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) As 金额, Nvl(Max(a.结帐id), 0) As 结帐id, Max(病人id) As 病人id,
           Max(Decode(a.记录性质, 1, a.记录状态, 1)) As 记录状态,
           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.Id, 3, a.Id, 0), 0)) As ID,
           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.收款时间, 3, a.收款时间, Null, Null))) As 收款时间
    From 病人预交记录 A
    Where a.记录性质 In (1, 11) And a.病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And
          Nvl(a.预交类别, 2) = 1 And a.结算方式 Not In (Select 名称 From 结算方式 Where 性质 = 5)
    Group By a.No
    Having Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) <> 0
    Order By Decode(病人id, Nvl(v_病人id, 0), 0, 1), 收款时间;

  --过程变量
  v_结算内容 Varchar2(500);
  v_当前结算 Varchar2(50);
  v_结算方式 病人预交记录.结算方式%Type;
  v_结算金额 病人预交记录.冲预交%Type;
  v_结算号码 病人预交记录.结算号码%Type;

  v_费用id 门诊费用记录.Id%Type;
  v_序号   门诊费用记录.序号%Type;

  v_收费类别      门诊费用记录.收费类别%Type;
  v_收费细目id    门诊费用记录.收费细目id%Type;
  v_计算单位      门诊费用记录.计算单位%Type;
  v_收入项目id    门诊费用记录.收入项目id%Type;
  v_收据费目      门诊费用记录.收据费目%Type;
  v_执行部门id    门诊费用记录.执行部门id%Type;
  v_Temp          Varchar2(500);
  n_返回值        人员缴款余额.余额%Type;
  v_No            病人预交记录.No%Type;
  v_病人id        病人预交记录.病人id%Type;
  v_收款时间      病人预交记录.收款时间%Type;
  v_操作员编号    病人预交记录.操作员编号%Type;
  v_操作员姓名    病人预交记录.操作员姓名%Type;
  v_冲预交病人ids Varchar2(4000);
  n_冲预交        病人预交记录.冲预交%Type;

  v_预交金额 病人预交记录.冲预交%Type;
  n_组id     财务缴款分组.Id%Type;
  n_结算序号 病人预交记录.结算序号%Type;
  n_执行状态 门诊费用记录.执行状态%Type;
  n_费用状态 门诊费用记录.费用状态%Type;
  v_Error    Varchar2(255);
  Err_Custom Exception;
Begin
  --1.取预交记录需要的相关信息
  Select NO, 病人id, 登记时间, 操作员编号, 操作员姓名, 缴款组id, 执行状态, 费用状态
  Into v_No, v_病人id, v_收款时间, v_操作员编号, v_操作员姓名, n_组id, n_执行状态, n_费用状态
  From 门诊费用记录
  Where 结帐id = 结帐id_In And Rownum = 1 And 记录性质 = 1;

  v_冲预交病人ids := Nvl(冲预交病人ids_In, v_病人id);

  --误差相关信息
  Begin
    Select a.类别, a.Id, a.计算单位, c.Id, c.收据费目
    Into v_收费类别, v_收费细目id, v_计算单位, v_收入项目id, v_收据费目
    From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费特定项目 D
    Where d.特定项目 = '误差项' And d.收费细目id = a.Id And a.Id = b.收费细目id And b.收入项目id = c.Id And Sysdate Between b.执行日期 And
          Nvl(b.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD'));
  Exception
    When Others Then
      Begin
        v_Error := '不能正确读取收费误差项的信息，请先检查该项目是否设置正确。';
        Raise Err_Custom;
      End;
  End;

  Select 结算序号 Into n_结算序号 From 病人预交记录 Where 结帐id = 结帐id_In And Rownum = 1;

  If Nvl(n_费用状态, 0) <> 1 Then
    --2.删除旧的记录,回退汇总数据
    --回退人员缴款余额,病人余额,
    --人员缴款余额中不包含未较对的,未较对的直接删除
    For c_Del In (Select 冲预交, 操作员姓名, 结算方式
                  From 病人预交记录
                  Where 结帐id = 结帐id_In And 记录性质 = 3 And Nvl(校对标志, 0) = 0) Loop
    
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) - Nvl(c_Del.冲预交, 0)
      Where 结算方式 = c_Del.结算方式 And 收款员 = v_操作员姓名 And 性质 = 1
      Returning 余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (v_操作员姓名, c_Del.结算方式, 1, -1 * c_Del.冲预交);
        n_返回值 := -1 * c_Del.冲预交;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 人员缴款余额
        Where 性质 = 1 And 收款员 = v_操作员姓名 And 结算方式 = c_Del.结算方式 And Nvl(余额, 0) = 0;
      End If;
    End Loop;
  End If;
  If v_病人id > 0 Then
    For v_预交 In (Select 预交类别, Nvl(Sum(冲预交), 0) As 预交金额
                 From 病人预交记录
                 Where 结帐id = 结帐id_In And 记录性质 In (1, 11)
                 Group By 预交类别
                 Having Sum(Nvl(冲预交, 0)) <> 0) Loop
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + Nvl(v_预交.预交金额, 0)
      Where 病人id = v_病人id And 性质 = 1 And 类型 = Nvl(v_预交.预交类别, 2);
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (v_病人id, Nvl(v_预交.预交类别, 2), v_预交金额, 1);
      End If;
    
    End Loop;
  End If;

  --回退汇总表
  --只可能产生误差金额的变化,其它的不会变,并且只可能存在一行,仅为了变量处理方便而用游标

  --删除收费结算,保险结算记录
  Delete 病人预交记录 Where 结帐id = 结帐id_In And 记录性质 = 3;
  --第一次冲预交的,清空冲减额
  Update 病人预交记录 Set 冲预交 = Null, 结帐id = Null, 结算性质 = Null Where 结帐id = 结帐id_In And 记录性质 = 1;
  --删除冲余款
  Delete 病人预交记录 Where 结帐id = 结帐id_In And 记录性质 = 11;
  --删除误差记录
  Delete 门诊费用记录 Where 结帐id = 结帐id_In And 附加标志 = 9;

  --3.产生门诊费用记录的误差记录
  If 误差_In <> 0 Then
    Select 病人费用记录_Id.Nextval Into v_费用id From Dual;
    Select Max(序号) + 1 Into v_序号 From 门诊费用记录 Where 结帐id = 结帐id_In And 记录性质 = 1;
    v_Temp       := Zl_Identity;
    v_执行部门id := To_Number(Substr(v_Temp, 1, Instr(v_Temp, ',') - 1));
  
    Insert Into 门诊费用记录
      (ID, 记录性质, NO, 实际票号, 记录状态, 序号, 从属父号, 价格父号, 门诊标志, 病人id, 标识号, 付款方式, 姓名, 性别, 年龄, 病人科室id, 费别, 收费类别, 收费细目id, 计算单位,
       发药窗口, 付数, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 标准单价, 应收金额, 实收金额, 记帐费用, 划价人, 开单部门id, 开单人, 发生时间, 登记时间, 执行部门id, 执行状态, 费用状态,
       结帐id, 结帐金额, 操作员编号, 操作员姓名, 是否上传, 缴款组id)
      Select v_费用id, 记录性质, NO, 实际票号, 记录状态, v_序号, Null, Null, 门诊标志, 病人id, 标识号, 付款方式, 姓名, 性别, 年龄, 病人科室id, 费别, v_收费类别,
             v_收费细目id, v_计算单位, 发药窗口, 1, 1, 加班标志, 9, v_收入项目id, v_收据费目, 误差_In, 误差_In, 误差_In, 记帐费用, 划价人, 开单部门id, 开单人, 发生时间,
             登记时间, v_执行部门id, 执行状态, 费用状态, 结帐id, 误差_In, 操作员编号, 操作员姓名, 1, 缴款组id
      From 门诊费用记录
      Where 记录性质 = 1 And 结帐id = 结帐id_In And Rownum = 1;
  End If;

  --4.重新生成病人预交记录相关数据
  --4.1.收费结算
  If 收费结算_In Is Not Null Then
    v_结算内容 := 收费结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_结算号码 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      If Nvl(v_结算金额, 0) <> 0 Then
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款, 找补, 缴款组id, 结算性质)
        Values
          (病人预交记录_Id.Nextval, 3, v_No, Decode(是否退费结算_In, 1, 2, 1), v_病人id, Null, Decode(是否退费结算_In, 1, '退费结算', '收费结算'),
           v_结算方式, v_结算号码, v_收款时间, v_操作员编号, v_操作员姓名, v_结算金额, 结帐id_In, Decode(v_结算内容, 收费结算_In || '||', 缴款_In, Null),
           Decode(v_结算内容, 收费结算_In || '||', 找补_In, Null), n_组id, 3);
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --4.2.保险结算
  If 保险结算_In Is Not Null Then
    v_结算内容 := 保险结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      If Nvl(v_结算金额, 0) <> 0 Then
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算性质)
        Values
          (病人预交记录_Id.Nextval, 3, v_No, Decode(是否退费结算_In, 1, 2, 1), v_病人id, Null, '保险结算', v_结算方式, v_收款时间, v_操作员编号,
           v_操作员姓名, v_结算金额, 结帐id_In, n_组id, n_结算序号, 3);
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --4.3.预交结算
  If Nvl(冲预交额_In, 0) <> 0 Then
    If Nvl(v_病人id, 0) = 0 Then
      v_Error := '不能确定病人的病人ID,收费不能使用预交款结算,结算操作失败！';
      Raise Err_Custom;
    End If;
  
    v_预交金额 := 冲预交额_In;
    For r_Deposit In c_Deposit(v_病人id, v_冲预交病人ids) Loop
      If r_Deposit.金额 - v_预交金额 < 0 Then
        n_冲预交 := r_Deposit.金额;
      Else
        n_冲预交 := v_预交金额;
      End If;
    
      If r_Deposit.结帐id = 0 Then
        --第一次冲预交(填上结帐ID,金额为0)
        Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 3 Where ID = r_Deposit.Id;
      End If;
      --冲上次剩余额
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
         结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, v_收款时间,
               v_操作员姓名, v_操作员编号, n_冲预交, 结帐id_In, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 3
        From 病人预交记录
        Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
    
      --更新病人预交余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_冲预交
      Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (r_Deposit.病人id, 1, -1 * n_冲预交, 1);
        n_返回值 := -1 * n_冲预交;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Deposit.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      --检查是否已经处理完
      If r_Deposit.金额 < v_预交金额 Then
        v_预交金额 := v_预交金额 - r_Deposit.金额;
      Else
        v_预交金额 := 0;
      End If;
      If v_预交金额 = 0 Then
        Exit;
      End If;
    End Loop;
    --检查金额是否足够
    If v_预交金额 > 0 Then
      v_Error := '病人的当前预交余额不足金额 ' || LTrim(To_Char(冲预交额_In, '9999999990.00')) || ' ！';
      Raise Err_Custom;
    End If;
  End If;

  --5.相关汇总表的处理
  --汇总"人员缴款余额"
  --收费结算
  If 收费结算_In Is Not Null And Nvl(n_费用状态, 0) <> 1 Then
    v_结算内容 := 收费结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    
      If Nvl(v_结算金额, 0) <> 0 Then
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + Nvl(v_结算金额, 0)
        Where 收款员 = v_操作员姓名 And 性质 = 1 And 结算方式 = v_结算方式;
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额
            (收款员, 结算方式, 性质, 余额)
          Values
            (v_操作员姓名, v_结算方式, 1, Nvl(v_结算金额, 0));
        End If;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --各个保险结算

  If 保险结算_In Is Not Null And Nvl(n_费用状态, 0) <> 1 Then
    v_结算内容 := 保险结算_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      If Nvl(v_结算金额, 0) <> 0 Then
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + Nvl(v_结算金额, 0)
        Where 收款员 = v_操作员姓名 And 性质 = 1 And 结算方式 = v_结算方式;
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额
            (收款员, 结算方式, 性质, 余额)
          Values
            (v_操作员姓名, v_结算方式, 1, Nvl(v_结算金额, 0));
        End If;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --汇总表,只需重汇误差行,因为其它项不会变
  --6.医保相关表的处理
  --Delete 医保核对表 Where 结帐Id=结帐Id_IN;
  Update 保险结算明细 Set 标志 = 2 Where 结帐id = 结帐id_In;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊收费结算_Update;
/

--106755:冉俊明,2017-03-14,作废的预交款单据不能再在消费环节使用。
Create Or Replace Procedure Zl_病人结算记录_Update
(
  结帐id_In        病人预交记录.结帐id%Type,
  保险结算_In      Varchar2, --"结算方式|结算金额||....."
  结帐_In          Number := 0,
  缺省结算方式_In  Varchar2 := Null,
  缺省冲预交_In    Number := 0, --0-用现金缴款,1:剩于款项用冲预交支付(门诊预交),2-剩于款项用冲预交支付(住院预交)
  卡类别id_In      病人预交记录.卡类别id%Type := Null,
  结算卡序号_In    病人预交记录.结算卡序号%Type := Null,
  卡号_In          病人预交记录.卡号%Type := Null,
  交易流水号_In    病人预交记录.交易流水号%Type := Null,
  交易说明_In      病人预交记录.交易说明%Type := Null,
  合作单位_In      病人预交记录.合作单位%Type := Null,
  冲预交病人ids_In Varchar2 := Null,
  仅修正医保_In    Number := 0
) As
  --该游标为要删除的由费用记录产生的结算记录

  Cursor c_Del Is
    Select a.Id, a.记录性质, a.冲预交, a.结算方式, b.性质, a.预交类别
    From 病人预交记录 A, 结算方式 B
    Where a.结算方式 = b.名称 And a.结帐id = 结帐id_In;

  Cursor c_Del_医保 Is
    Select a.Id, a.记录性质, a.冲预交, a.结算方式, b.性质, a.预交类别
    From 病人预交记录 A, 结算方式 B
    Where a.结算方式 = b.名称 And b.性质 In (3, 4) And a.结帐id = 结帐id_In;

  --相关信息
  v_No         病人预交记录.No%Type;
  v_病人id     住院费用记录.病人id%Type;
  v_主页id     住院费用记录.主页id%Type;
  v_发生时间   住院费用记录.发生时间%Type;
  v_登记时间   住院费用记录.登记时间%Type;
  v_操作员编号 住院费用记录.操作员编号%Type;
  v_操作员姓名 住院费用记录.操作员姓名%Type;

  v_冲预交病人ids Varchar2(4000);

  --本次结算变量
  v_金额合计 病人预交记录.冲预交%Type;

  --保险结算
  v_保险结算 Varchar2(255);
  v_当前结算 Varchar2(50);
  v_结算方式 病人预交记录.结算方式%Type;
  v_结算金额 病人预交记录.冲预交%Type;

  v_记录性质 病人预交记录.记录性质%Type;
  v_缺省     病人预交记录.结算方式%Type;

  --分币处理及误差变量
  v_现金金额   病人预交记录.冲预交%Type;
  v_Cashcented 病人预交记录.冲预交%Type;
  v_误差金额   病人预交记录.冲预交%Type;
  v_费用id     住院费用记录.Id%Type;
  v_序号       住院费用记录.序号%Type;
  v_收费类别   住院费用记录.收费类别%Type;
  v_收费细目id 住院费用记录.收费细目id%Type;
  v_收入项目id 住院费用记录.收入项目id%Type;
  v_收据费目   住院费用记录.收据费目%Type;
  n_Noexists   Number(3);
  n_医疗小组id 住院费用记录.医疗小组id%Type;
  n_结算序号   病人预交记录.结算序号%Type;
  n_费用状态   门诊费用记录.费用状态%Type;
  n_预交金额   病人预交记录.金额%Type;
  n_当前金额   病人预交记录.金额%Type;
  v_误差项     结算方式.名称%Type;

  --临时变量
  Err_Item Exception;
  v_Err_Msg  Varchar2(255);
  n_组id     财务缴款分组.Id%Type;
  n_执行状态 门诊费用记录.执行状态%Type;
Begin
  --如果缺省结算方式为空，则取现金结算方式
  If 缺省结算方式_In Is Null Then
    Begin
      Select 名称 Into v_缺省 From 结算方式 Where 性质 = 1 And Rownum < 2;
    Exception
      When Others Then
        v_缺省 := '现金';
    End;
  Else
    v_缺省 := 缺省结算方式_In;
  End If;

  --取得本次结算的相关信息
  If Nvl(结帐_In, 0) = 1 Then
    Select NO, 病人id, 收费时间, 操作员编号, 操作员姓名, 缴款组id, 0
    Into v_No, v_病人id, v_登记时间, v_操作员编号, v_操作员姓名, n_组id, n_执行状态
    From 病人结帐记录
    Where ID = 结帐id_In;
  Else
    Begin
      n_Noexists := 0;
      Select NO, 病人id, 登记时间, 操作员编号, 操作员姓名, 缴款组id, 执行状态, 费用状态
      Into v_No, v_病人id, v_登记时间, v_操作员编号, v_操作员姓名, n_组id, n_执行状态, n_费用状态
      From 门诊费用记录
      Where 结帐id = 结帐id_In And Rownum < 2;
    Exception
      When Others Then
        n_Noexists := 1;
    End;
    If n_Noexists = 1 Then
      --费用记录不存在，从补充记录中找
      Select NO, 病人id, 登记时间, 操作员编号, 操作员姓名, 缴款组id, 费用状态
      Into v_No, v_病人id, v_登记时间, v_操作员编号, v_操作员姓名, n_组id, n_费用状态
      From 费用补充记录
      Where 结算id = 结帐id_In And Rownum < 2;
    End If;
    If Nvl(n_费用状态, 0) = 1 Then
      --异常单据为空:
      v_缺省 := Null;
    End If;
  
    Begin
      --20051027 陈东
      Select 记录性质
      Into v_记录性质
      From 病人预交记录
      Where 结帐id = 结帐id_In And Rownum = 1 And Mod(记录性质, 10) <> 1;
    Exception
      When Others Then
        v_记录性质 := -1;
    End;
    If v_记录性质 = -1 Then
      Begin
        Select Decode(记录性质, 1, 3, 11, 3, 4, 4, 记录性质)
        Into v_记录性质
        From 门诊费用记录
        Where 结帐id = 结帐id_In And Rownum = 1;
      Exception
        When Others Then
          --可能是卡费
          Select 记录性质 Into v_记录性质 From 住院费用记录 Where 结帐id = 结帐id_In And Rownum = 1;
      End;
    End If;
  End If;

  If Nvl(v_病人id, 0) <> 0 And Nvl(结帐_In, 0) = 1 Then
    Select 主页id Into v_主页id From 病人信息 Where 病人id = v_病人id;
  End If;
  Select 结算序号 Into n_结算序号 From 病人预交记录 Where 结帐id = 结帐id_In And Rownum = 1;

  v_冲预交病人ids := Nvl(冲预交病人ids_In, v_病人id);

  ----回退缴款,预交不动,因为没有改冲预交的
  --收费未最未最终完成的,代表按异常单据修正,不处理人员缴款余额
  v_金额合计 := 0;
  If Nvl(仅修正医保_In, 0) = 0 Then
    For r_Del In c_Del Loop
      If r_Del.记录性质 Not In (1, 11) Then
        If Nvl(n_费用状态, 0) <> 1 Then
          Update 人员缴款余额
          Set 余额 = Nvl(余额, 0) - r_Del.冲预交
          Where 收款员 = v_操作员姓名 And 性质 = 1 And 结算方式 = r_Del.结算方式;
        
          If Sql%RowCount = 0 Then
            Insert Into 人员缴款余额
              (收款员, 结算方式, 性质, 余额)
            Values
              (v_操作员姓名, r_Del.结算方式, 1, -1 * r_Del.冲预交);
          End If;
        End If;
        v_金额合计 := v_金额合计 + r_Del.冲预交;
        Delete From 病人预交记录 Where ID = r_Del.Id;
      Else
        --检查是否冲预交
        If Nvl(缺省冲预交_In, 0) <> 0 Then
          v_金额合计 := v_金额合计 + r_Del.冲预交;
          If Nvl(n_费用状态, 0) <> 1 Then
            Update 病人余额
            Set 预交余额 = Nvl(预交余额, 0) + Nvl(r_Del.冲预交, 0)
            Where 病人id = v_病人id And 类型 = Nvl(r_Del.预交类别, 2);
            If Sql%NotFound Then
              Insert Into 病人余额
                (病人id, 性质, 预交余额, 费用余额, 类型)
              Values
                (v_病人id, 1, Nvl(r_Del.冲预交, 0), 0, Nvl(r_Del.预交类别, 2));
            End If;
          End If;
          If r_Del.记录性质 = 1 Then
            Update 病人预交记录 Set 冲预交 = 0 Where ID = r_Del.Id;
          Else
            Delete 病人预交记录 Where ID = r_Del.Id;
          End If;
        End If;
      End If;
    End Loop;
  Else
    For r_Del In c_Del_医保 Loop
      If r_Del.记录性质 Not In (1, 11) Then
        If Nvl(n_费用状态, 0) <> 1 Then
          Update 人员缴款余额
          Set 余额 = Nvl(余额, 0) - r_Del.冲预交
          Where 收款员 = v_操作员姓名 And 性质 = 1 And 结算方式 = r_Del.结算方式;
        
          If Sql%RowCount = 0 Then
            Insert Into 人员缴款余额
              (收款员, 结算方式, 性质, 余额)
            Values
              (v_操作员姓名, r_Del.结算方式, 1, -1 * r_Del.冲预交);
          End If;
        End If;
        v_金额合计 := v_金额合计 + r_Del.冲预交;
        Delete From 病人预交记录 Where ID = r_Del.Id;
      Else
        --检查是否冲预交
        If Nvl(缺省冲预交_In, 0) <> 0 Then
          v_金额合计 := v_金额合计 + r_Del.冲预交;
          If Nvl(n_费用状态, 0) <> 1 Then
            Update 病人余额
            Set 预交余额 = Nvl(预交余额, 0) + Nvl(r_Del.冲预交, 0)
            Where 病人id = v_病人id And 类型 = Nvl(r_Del.预交类别, 2);
            If Sql%NotFound Then
              Insert Into 病人余额
                (病人id, 性质, 预交余额, 费用余额, 类型)
              Values
                (v_病人id, 1, Nvl(r_Del.冲预交, 0), 0, Nvl(r_Del.预交类别, 2));
            End If;
          End If;
          If r_Del.记录性质 = 1 Then
            Update 病人预交记录 Set 冲预交 = 0 Where ID = r_Del.Id;
          Else
            Delete 病人预交记录 Where ID = r_Del.Id;
          End If;
        End If;
      End If;
    End Loop;
  End If;

  --------------------------------------------------------------------------------------------------------------
  --------------------------------------------------------------------------------------------------------------
  --产生医保支付结算
  If 保险结算_In Is Not Null Then
    --各个保险结算
    v_保险结算 := 保险结算_In || '||';
    While v_保险结算 Is Not Null Loop
      v_当前结算 := Substr(v_保险结算, 1, Instr(v_保险结算, '||') - 1);
    
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算性质)
      Values
        (病人预交记录_Id.Nextval, Decode(结帐_In, 1, 2, v_记录性质), v_No, 1, v_病人id, v_主页id, '保险部份', v_结算方式, v_登记时间, v_操作员编号,
         v_操作员姓名, v_结算金额, 结帐id_In, n_组id, n_结算序号, Mod(Decode(结帐_In, 1, 2, v_记录性质), 10));
    
      v_金额合计 := v_金额合计 - v_结算金额;
    
      v_保险结算 := Substr(v_保险结算, Instr(v_保险结算, '||') + 2);
    End Loop;
  End If;
  --剩余部分用预交
  If Nvl(缺省冲预交_In, 0) <> 0 And v_金额合计 <> 0 Then
    n_预交金额 := v_金额合计;
    --先缴先用，且先用自己的
    --不包含结算方式为代收款项的预交款。
    For c_预交 In (Select a.No, Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) As 金额, Nvl(Max(a.结帐id), 0) As 结帐id, Max(病人id) As 病人id,
                        a.预交类别, Max(Decode(a.记录性质, 1, a.记录状态, 1)) As 记录状态,
                        Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.Id, 3, a.Id, 0), 0)) As ID,
                        Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.收款时间, 3, a.收款时间, Null, Null))) As 收款时间
                 From 病人预交记录 A
                 Where a.记录性质 In (1, 11) And a.病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And
                       Nvl(a.预交类别, 2) = 缺省冲预交_In And a.结算方式 Not In (Select 名称 From 结算方式 Where 性质 = 5)
                 Group By a.No, a.预交类别
                 Having Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) <> 0
                 Order By Decode(病人id, Nvl(v_病人id, 0), 0, 1), 收款时间) Loop
    
      n_当前金额 := Case
                  When c_预交.金额 - n_预交金额 < 0 Then
                   c_预交.金额
                  Else
                   n_预交金额
                End;
    
      If c_预交.结帐id = 0 Then
        --第一次冲预交(填上结帐ID,金额为0)
        Update 病人预交记录
        Set 冲预交 = 0, 结帐id = 结帐id_In, 结算序号 = n_结算序号, 结算性质 = Mod(Decode(结帐_In, 1, 2, v_记录性质), 10)
        Where ID = c_预交.Id;
      End If;
      --冲上次剩余额
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 预交类别, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号,
         冲预交, 结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 预交类别, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
               v_登记时间, v_操作员姓名, v_操作员编号, n_当前金额, 结帐id_In, n_组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, n_结算序号,
               Mod(Decode(结帐_In, 1, 2, v_记录性质), 10)
        From 病人预交记录
        Where NO = c_预交.No And 记录状态 = c_预交.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
    
      --更新病人预交余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_当前金额
      Where 病人id = c_预交.病人id And 性质 = 1 And 类型 = Nvl(c_预交.预交类别, 2);
    
      --检查是否已经处理完
      If c_预交.金额 < n_预交金额 Then
        n_预交金额 := n_预交金额 - c_预交.金额;
      Else
        n_预交金额 := 0;
      End If;
    
      If n_预交金额 = 0 Then
        Exit;
      End If;
    End Loop;
    If n_预交金额 <> 0 Then
      v_Err_Msg := '[ZLSOFT]预交余不够支付本次支付金额,不能继续操作！[ZLSOFT]';
      Raise Err_Item;
    End If;
    Delete From 病人余额 Where 病人id = v_病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
    v_金额合计 := n_预交金额;
  End If;

  --剩余部份全部用缺省结算方式结算，(小于零也不进行额外处理)
  If v_金额合计 <> 0 Then
    Update 病人预交记录
    Set 冲预交 = 冲预交 + v_金额合计, 卡类别id = 卡类别id_In, 结算卡序号 = 结算卡序号_In, 卡号 = 卡号_In, 交易流水号 = 交易流水号_In, 交易说明 = 交易说明_In,
        合作单位 = 合作单位_In, 结算序号 = n_结算序号
    
    Where 结帐id = 结帐id_In And Nvl(结算方式, 'LXH_Test') = Nvl(v_缺省, 'LXH_Test') And 记录性质 = Decode(结帐_In, 1, 2, v_记录性质);
    If Sql%RowCount = 0 Then
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 卡类别id, 结算卡序号, 卡号, 交易流水号,
         交易说明, 合作单位, 结算性质)
      Values
        (病人预交记录_Id.Nextval, Decode(结帐_In, 1, 2, v_记录性质), v_No, 1, v_病人id, v_主页id, '保险结算修正', v_缺省, v_登记时间, v_操作员编号,
         v_操作员姓名, v_金额合计, 结帐id_In, n_组id, n_结算序号, 卡类别id_In, 结算卡序号_In, 卡号_In, 交易流水号_In, 交易说明_In, 合作单位_In,
         Mod(Decode(结帐_In, 1, 2, v_记录性质), 10));
    End If;
  
    --挂号结算,分币处理(由于挂号界面没有预结算,所以在此过程中根据分币处理规则来修正)
    If v_记录性质 = 4 Then
      Begin
        Select a.冲预交
        Into v_现金金额
        From 病人预交记录 A, 结算方式 B
        Where a.结算方式 = b.名称 And b.性质 = 1 And a.结帐id = 结帐id_In;
      Exception
        When Others Then
          v_现金金额 := 0;
      End;
      If Floor(Abs(v_现金金额) * 10) <> Abs(v_现金金额) * 10 Then
        --误差处理
        v_Cashcented := Zl_Cent_Money(v_现金金额);
      
        v_误差金额 := v_Cashcented - v_现金金额;
        If v_误差金额 <> 0 Then
          Begin
            Select 名称 Into v_误差项 From 结算方式 Where 性质 = 9;
          Exception
            When Others Then
              v_误差项 := Null;
          End;
          If v_误差项 Is Not Null Then
            --10.34之后误差数据
            Insert Into 病人预交记录
              (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算性质)
            Values
              (病人预交记录_Id.Nextval, Decode(结帐_In, 1, 2, v_记录性质), v_No, 1, v_病人id, v_主页id, '误差费', v_误差项, v_登记时间, v_操作员编号,
               v_操作员姓名, v_误差金额, 结帐id_In, n_组id, n_结算序号, Mod(Decode(结帐_In, 1, 2, v_记录性质), 10));
          Else
            --1.更新预交记录(一定存在记录)
            Update 病人预交记录
            Set 冲预交 = v_Cashcented
            Where 结算方式 = (Select 名称 From 结算方式 Where 性质 = 1 And Rownum = 1) And 结帐id = 结帐id_In;
          
            --2.生成误差费用记录(注:计算单位记录的是号别,所以不取误差项的)
            Begin
              Select a.类别, a.Id, c.Id, c.收据费目
              Into v_收费类别, v_收费细目id, v_收入项目id, v_收据费目
              From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费特定项目 D
              Where d.特定项目 = '误差项' And d.收费细目id = a.Id And a.Id = b.收费细目id And b.收入项目id = c.Id And
                    Sysdate Between b.执行日期 And Nvl(b.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD'));
            Exception
              When Others Then
                v_Err_Msg := '不能正确读取收费误差项的信息，请先检查该项目是否设置正确。';
                Raise Err_Item;
            End;
            If Nvl(结帐_In, 0) = 1 Then
              Select 病人费用记录_Id.Nextval Into v_费用id From Dual;
              Select Max(序号) + 1, Max(发生时间) Into v_序号, v_发生时间 From 住院费用记录 Where 结帐id = 结帐id_In;
              n_医疗小组id := Zl_医疗小组_Get(0, v_操作员姓名, v_病人id, v_主页id, v_发生时间);
            
              Insert Into 住院费用记录
                (ID, 记录性质, NO, 实际票号, 记录状态, 序号, 从属父号, 价格父号, 门诊标志, 病人id, 标识号, 床号, 姓名, 性别, 年龄, 病人病区id, 病人科室id, 费别, 收费类别,
                 收费细目id, 计算单位, 发药窗口, 付数, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 标准单价, 应收金额, 实收金额, 记帐费用, 划价人, 开单部门id, 开单人, 发生时间,
                 登记时间, 执行部门id, 执行人, 执行状态, 结帐id, 结帐金额, 操作员编号, 操作员姓名, 是否上传, 缴款组id, 医疗小组id)
                Select v_费用id, 记录性质, NO, 实际票号, 记录状态, v_序号, Null, Null, 门诊标志, 病人id, 标识号, 床号, 姓名, 性别, 年龄, 病人病区id, 病人科室id,
                       费别, v_收费类别, v_收费细目id, 计算单位, 发药窗口, 1, 1, 加班标志, 9, v_收入项目id, v_收据费目, v_误差金额, v_误差金额, v_误差金额, 记帐费用,
                       划价人, 开单部门id, 开单人, 发生时间, 登记时间, 执行部门id, 执行人, 执行状态, 结帐id_In, v_误差金额, 操作员编号, 操作员姓名, 1, 缴款组id,
                       Decode(n_医疗小组id, Null, 医疗小组id, n_医疗小组id)
                From 住院费用记录
                Where 结帐id = 结帐id_In And Rownum = 1;
            Else
              Select 病人费用记录_Id.Nextval Into v_费用id From Dual;
              Select Max(序号) + 1 Into v_序号 From 门诊费用记录 Where 结帐id = 结帐id_In;
              Insert Into 门诊费用记录
                (ID, 记录性质, NO, 实际票号, 记录状态, 序号, 从属父号, 价格父号, 门诊标志, 病人id, 标识号, 付款方式, 姓名, 性别, 年龄, 病人科室id, 费别, 收费类别, 收费细目id,
                 计算单位, 发药窗口, 付数, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 标准单价, 应收金额, 实收金额, 记帐费用, 划价人, 开单部门id, 开单人, 发生时间, 登记时间,
                 执行部门id, 执行人, 执行状态, 费用状态, 结帐id, 结帐金额, 操作员编号, 操作员姓名, 是否上传, 缴款组id)
                Select v_费用id, 记录性质, NO, 实际票号, 记录状态, v_序号, Null, Null, 门诊标志, 病人id, 标识号, 付款方式, 姓名, 性别, 年龄, 病人科室id, 费别,
                       v_收费类别, v_收费细目id, 计算单位, 发药窗口, 1, 1, 加班标志, 9, v_收入项目id, v_收据费目, v_误差金额, v_误差金额, v_误差金额, 记帐费用, 划价人,
                       开单部门id, 开单人, 发生时间, 登记时间, 执行部门id, 执行人, 执行状态, 费用状态, 结帐id_In, v_误差金额, 操作员编号, 操作员姓名, 1, 缴款组id
                From 门诊费用记录
                Where 结帐id = 结帐id_In And Rownum = 1;
            End If;
          End If;
          --3.更新汇总表
          --只可能产生误差金额的变化.仅为了变量处理方便而用游标
        End If;
      End If;
    End If;
  End If;

  --最后再处理"人员缴款余额"(没有动冲预交那部分,所以"病人余额"的预交余额不用更新)
  For r_Del In c_Del Loop
    If r_Del.记录性质 Not In (1, 11) Then
      If Nvl(n_费用状态, 0) <> 1 Then
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + r_Del.冲预交
        Where 收款员 = v_操作员姓名 And 性质 = 1 And 结算方式 = r_Del.结算方式;
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额
            (收款员, 结算方式, 性质, 余额)
          Values
            (v_操作员姓名, r_Del.结算方式, 1, r_Del.冲预交);
        End If;
      End If;
    End If;
  End Loop;
  Delete From 人员缴款余额 Where 性质 = 1 And 收款员 = v_操作员姓名 And Nvl(余额, 0) = 0;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人结算记录_Update;
/

--108340:蔡青松,2017-04-18,执行相关操作之前先判断是否收费
--106309:蔡青松,2017-03-13,登记标本时保存输入的送检人
Create Or Replace Procedure Zl_病人医嘱发送_Sampleinput
(
  医嘱id      In Varchar2,
  接收人_In   In 病人医嘱发送.接收人%Type := Null,
  接收批次_In In 病人医嘱发送.接收批次%Type := 0,
  人员编号_In In 人员表.编号%Type := Null,
  人员姓名_In In 人员表.姓名%Type := Null,
  送检人_In   In 病人医嘱发送.送检人%Type := Null
) Is
  --未审核的费用行(不包含药品)
  Cursor c_Verify(v_医嘱id In Number) Is
    Select Distinct 记录性质, NO, 序号, 记录状态, 门诊标志
    From 住院费用记录
    Where 收费类别 Not In ('5', '6', '7') And 医嘱序号 + 0 = v_医嘱id And 记帐费用 = 1 And 记录状态 = 0 And 价格父号 Is Null And
          (记录性质, NO) In (Select 记录性质, NO
                         From 病人医嘱附费
                         Where 医嘱id = v_医嘱id
                         Union All
                         Select 记录性质, NO
                         From 病人医嘱发送
                         Where 医嘱id In (Select ID From 病人医嘱记录 Where v_医嘱id In (ID, 相关id)))
    Union All
    Select Distinct 记录性质, NO, 序号, 记录状态, 门诊标志
    From 门诊费用记录
    Where 收费类别 Not In ('5', '6', '7') And 医嘱序号 + 0 = v_医嘱id And 记帐费用 = 1 And 记录状态 = 0 And 价格父号 Is Null And
          (记录性质, NO) In (Select 记录性质, NO
                         From 病人医嘱附费
                         Where 医嘱id = v_医嘱id
                         Union All
                         Select 记录性质, NO
                         From 病人医嘱发送
                         Where 医嘱id In (Select ID From 病人医嘱记录 Where v_医嘱id In (ID, 相关id)))
    Order By 记录性质, NO, 序号;

  --查找当前标本的相关申请
  Cursor c_Samplequest(v_医嘱id In Number) Is
    Select Distinct ID As 医嘱id, 病人来源 From 病人医嘱记录 Where v_医嘱id In (ID, 相关id);

  v_No   病人医嘱发送.No%Type;
  v_性质 病人医嘱发送.记录性质%Type;
  v_序号 Varchar2(1000);

  v_医嘱id   病人医嘱发送.医嘱id%Type;
  v_相关id   病人医嘱记录.相关id%Type;
  v_费用性质 病人医嘱发送.记录性质%Type;
  v_样本条码 病人医嘱发送.样本条码%Type;
  v_Records  Varchar2(2000);
  v_Currrec  Varchar2(50);
  v_Fields   Varchar2(50);
  v_Count    Number(18);
  v_病人id   病人医嘱记录.病人id%Type;
  v_主页id   病人医嘱记录.主页id%Type;
  v_是否出院 Number; --0=出院,1=在院
  v_记录状态 Number;
  v_病人来源 病人医嘱记录.病人来源%Type;
  v_Date     Date;
  Err_Custom Exception;
  v_Error Varchar2(100);
  n_Par   Number;
Begin
  Select Sysdate Into v_Date From Dual;

  v_Records := 医嘱id || '|';

  While v_Records Is Not Null Loop
  
    v_Currrec := Substr(v_Records, 1, Instr(v_Records, '|') - 1);
    v_Fields  := v_Currrec;
    v_医嘱id  := Substr(v_Fields, 1, Instr(v_Fields, ',') - 1);
    v_相关id  := Substr(v_Fields, Instr(v_Fields, ',') + 1);
    If 接收人_In Is Null Then
      Update 病人医嘱发送 Set 接收人 = Null, 接收时间 = Null, 接收批次 = Null Where 医嘱id In (v_医嘱id, v_相关id);
      Update 病人医嘱发送
      Set 执行状态 = Decode(样本条码, Null, 0, 1)
      Where 医嘱id In (Select ID From 病人医嘱记录 Where ID In (v_医嘱id, v_相关id) And 相关id Is Null);
      For r_Samplequest In c_Samplequest(v_相关id) Loop
        If r_Samplequest.病人来源 = 2 Then
          Select Decode(记录性质, 1, 1, Decode(门诊记帐, 1, 1, 2))
          Into v_费用性质
          From 病人医嘱发送
          Where 医嘱id = r_Samplequest.医嘱id;
        Else
          v_费用性质 := 1;
        End If;
        If v_费用性质 = 2 Then
          --2.费用执行处理
          Update 住院费用记录
          Set 执行状态 = 0, 执行时间 = Null, 执行人 = 接收人_In
          Where 收费类别 Not In ('5', '6', '7') And
                (医嘱序号, 记录性质, NO) In
                (Select 医嘱id, 记录性质, NO
                 From 病人医嘱附费
                 Where 医嘱id = r_Samplequest.医嘱id
                 Union All
                 Select 医嘱id, 记录性质, NO
                 From 病人医嘱发送
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where ID = r_Samplequest.医嘱id And 相关id Is Not Null)
                 Union All
                 Select 医嘱id, 记录性质, NO
                 From 病人医嘱发送
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where ID = r_Samplequest.医嘱id And 相关id Is Null) And 采样人 Is Null);
        Else
          Update 门诊费用记录
          Set 执行状态 = 0, 执行时间 = Null, 执行人 = 接收人_In
          Where 收费类别 Not In ('5', '6', '7') And
                (医嘱序号, 记录性质, NO) In
                (Select 医嘱id, 记录性质, NO
                 From 病人医嘱附费
                 Where 医嘱id = r_Samplequest.医嘱id
                 Union All
                 Select 医嘱id, 记录性质, NO
                 From 病人医嘱发送
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where ID = r_Samplequest.医嘱id And 相关id Is Not Null)
                 Union All
                 Select 医嘱id, 记录性质, NO
                 From 病人医嘱发送
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where ID = r_Samplequest.医嘱id And 相关id Is Null) And 采样人 Is Null);
        End If;
      End Loop;
    Else
      --判断是否已出院，如果已出院负不完成登记
      Begin
        If v_主页id Is Null Then
          Select a.病人id, a.主页id, a.病人来源
          Into v_病人id, v_主页id, v_病人来源
          From 病人医嘱记录 A, 病案主页 B
          Where a.病人id = b.病人id And a.主页id = b.主页id(+) And a.Id = v_医嘱id;
        End If;
      Exception
        When Others Then
          v_病人来源 := 1;
      End;
      If v_病人来源 = 2 Then
        If Nvl(v_主页id, 0) > 0 Then
          Select Decode(出院日期, Null, 1, 0)
          Into v_是否出院
          From 病案主页
          Where 病人id = v_病人id And 主页id = v_主页id;
        Else
          v_是否出院 := 0;
        End If;
      
        If v_是否出院 = 0 Then
          --出院的才处理
          Begin
            Select Nvl(记录状态, 0)
            Into v_记录状态
            From 住院费用记录
            Where 医嘱序号 = v_医嘱id And Nvl(记录状态, 0) = 0 And Rownum = 1;
          Exception
            When Others Then
              v_记录状态 := 1;
          End;
        
          Select Nvl(样本条码, 0) Into v_样本条码 From 病人医嘱发送 Where 医嘱id = v_医嘱id;
          If v_样本条码 = 0 Then
            v_Error := '病人已出院不能完成登记!';
            Raise Err_Custom;
          End If;
        End If;
      End If;
    
      --检查医嘱是否收费
      n_Par := Zl_To_Number(Nvl(zl_GetSysParameter(163), '0'));
      If n_Par = 1 Then
        For r_Samplequest In c_Samplequest(v_相关id) Loop
          For r_Verify In c_Verify(r_Samplequest.医嘱id) Loop
            If r_Verify.记录状态 = 0 Then
              If r_Verify.门诊标志 = 1 Then
                v_Error := '标本未收费，不允许执行，请联系管理员！';
                Raise Err_Custom;
              Elsif r_Verify.门诊标志 = 2 Then
                v_Error := '标本未记账，不允许执行，请联系管理员！';
                Raise Err_Custom;
              End If;
            End If;
          End Loop;
        End Loop;
      End If;
    
      Update 病人医嘱发送
      Set 接收人 = 接收人_In, 接收时间 = v_Date, 接收批次 = 接收批次_In, 重采标本 = Null, 送检人 = 送检人_In
      Where 医嘱id In (v_医嘱id, v_相关id);
      Update 病人医嘱发送
      Set 执行状态 = 1
      Where 医嘱id In (Select ID From 病人医嘱记录 Where ID In (v_医嘱id, v_相关id) And 相关id Is Null);
      --记帐划价单是否转为记帐单
      --2.检查当前标本相关的申请的相关标本是否完成审核
      For r_Samplequest In c_Samplequest(v_相关id) Loop
        v_Count := 0;
        --r_SampleQuest.医嘱id申请已经完成,处理后续环节
        If v_Count = 0 Then
          If r_Samplequest.病人来源 = 2 Then
            Select Decode(记录性质, 1, 1, Decode(门诊记帐, 1, 1, 2))
            Into v_费用性质
            From 病人医嘱发送
            Where 医嘱id = r_Samplequest.医嘱id;
          Else
            v_费用性质 := 1;
          End If;
          If v_费用性质 = 2 Then
            --2.费用执行处理
            Update 住院费用记录
            Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = 人员姓名_In
            Where 收费类别 Not In ('5', '6', '7') And
                  (医嘱序号, 记录性质, NO) In
                  (Select 医嘱id, 记录性质, NO
                   From 病人医嘱附费
                   Where 医嘱id = r_Samplequest.医嘱id
                   Union All
                   Select 医嘱id, 记录性质, NO
                   From 病人医嘱发送
                   Where 医嘱id In (Select ID From 病人医嘱记录 Where ID = r_Samplequest.医嘱id And 相关id Is Not Null)
                   Union All
                   Select 医嘱id, 记录性质, NO
                   From 病人医嘱发送
                   Where 医嘱id In (Select ID From 病人医嘱记录 Where ID = r_Samplequest.医嘱id And 相关id Is Null) And 采样人 Is Null);
          Else
            Update 门诊费用记录
            Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = 人员姓名_In
            Where 收费类别 Not In ('5', '6', '7') And
                  (医嘱序号, 记录性质, NO) In
                  (Select 医嘱id, 记录性质, NO
                   From 病人医嘱附费
                   Where 医嘱id = r_Samplequest.医嘱id
                   Union All
                   Select 医嘱id, 记录性质, NO
                   From 病人医嘱发送
                   Where 医嘱id In (Select ID From 病人医嘱记录 Where ID = r_Samplequest.医嘱id And 相关id Is Not Null)
                   Union All
                   Select 医嘱id, 记录性质, NO
                   From 病人医嘱发送
                   Where 医嘱id In (Select ID From 病人医嘱记录 Where ID = r_Samplequest.医嘱id And 相关id Is Null) And 采样人 Is Null);
          End If;
          --3.自动审核记帐
          For r_Verify In c_Verify(r_Samplequest.医嘱id) Loop
            If r_Verify.No || ',' || r_Verify.记录性质 <> v_No || ',' || v_性质 Then
              If v_序号 Is Not Null Then
                If v_费用性质 = 1 Then
                  Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
                Elsif v_费用性质 = 2 Then
                  Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
                End If;
              End If;
              v_序号 := Null;
            End If;
            v_No   := r_Verify.No;
            v_性质 := r_Verify.记录性质;
            v_序号 := v_序号 || ',' || r_Verify.序号;
          End Loop;
          If v_序号 Is Not Null Then
            If v_费用性质 = 1 Then
              Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
            Elsif v_费用性质 = 2 Then
              Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
            End If;
          End If;
        End If;
      End Loop;
    End If;
    v_Records := Substr('|' || v_Records, Length('|' || v_Currrec || '|') + 1);
  End Loop;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人医嘱发送_Sampleinput;
/

--106752:冉俊明,2017-03-12,停用（或删除）了科室或医生或收费项目的号源按停用号源处理。
Create Or Replace Procedure Zl_临床出诊号源_Stopandstart
(
  Id_In   临床出诊号源.Id%Type,
  停用_In Number := 0
) As
  d_开始时间 临床出诊记录.开始时间%Type;
  n_Count    Number;

  v_Err_Msg Varchar2(255);
  Err_Item Exception;
Begin
  If Nvl(停用_In, 0) = 1 Then
    Update 临床出诊号源
    Set 撤档时间 = Sysdate
    Where ID = Id_In And Nvl(撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd');
    If Sql%NotFound Then
      v_Err_Msg := '该号源已被他人启用，你无需再启用！请刷新数据...';
      Raise Err_Item;
    End If;
  
    --将当前时间以后的所有出诊记录停诊
    For c_记录 In (Select ID, 开始时间, 终止时间
                 From 临床出诊记录
                 Where 号源id = Id_In And 出诊日期 >= Trunc(Sysdate) - 1 And 终止时间 > Sysdate And 上班时段 Is Not Null) Loop
    
      If c_记录.开始时间 < Sysdate Then
        d_开始时间 := Sysdate;
      Else
        d_开始时间 := c_记录.开始时间;
      End If;
      Zl_临床出诊记录_Stopvisit(c_记录.Id, d_开始时间, c_记录.终止时间, '停用号源', Zl_Username, Sysdate, 0, 1);
    End Loop;
  Else
    Select Count(1)
    Into n_Count
    From 临床出诊号源 A, 人员表 C
    Where a.医生id = c.Id(+) And a.Id = Id_In And (Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) <= Sysdate);
    If n_Count = 1 Then
      v_Err_Msg := '该号源的医生已被停用或删除，在未重新启用医生前不能启用该号源！';
      Raise Err_Item;
    End If;
  
    Select Count(1)
    Into n_Count
    From 临床出诊号源 A, 部门表 B
    Where a.科室id = b.Id And a.Id = Id_In And (Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) <= Sysdate);
    If n_Count = 1 Then
      v_Err_Msg := '该号源的科室已被停用或删除，在未重新启用科室前不能启用该号源！';
      Raise Err_Item;
    End If;
  
    Select Count(1)
    Into n_Count
    From 临床出诊号源 A, 收费项目目录 B
    Where a.项目id = b.Id And a.Id = Id_In And (Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) <= Sysdate);
    If n_Count = 1 Then
      v_Err_Msg := '该号源的收费项目已被停用或删除，在未重新启用收费项目前不能启用该号源！';
      Raise Err_Item;
    End If;
  
    Update 临床出诊号源
    Set 撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd'), 是否删除 = 0
    Where ID = Id_In And Nvl(撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) < To_Date('3000-01-01', 'yyyy-mm-dd');
    If Sql%NotFound Then
      v_Err_Msg := '该号源已被他人停用或删除，你无需再停用！请刷新数据...';
      Raise Err_Item;
    End If;
  
    --将所有当前时间以后的所有出诊记录取消停诊（终止时间大于当前时间的都取消停诊，但是要排除长期停诊的）
    For c_记录 In (Select ID
                 From 临床出诊记录
                 Where 号源id = Id_In And 出诊日期 >= Trunc(Sysdate) - 1 And 终止时间 > Sysdate And 上班时段 Is Not Null) Loop
    
      Zl_临床出诊记录_Stopvisit(c_记录.Id, Null, Null, Null, Zl_Username, Sysdate, 1, 1);
    End Loop;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊号源_Stopandstart;
/

--106752:冉俊明,2017-03-12,停用（或删除）了科室或医生或收费项目的号源按停用号源处理。
Create Or Replace Procedure Zl_临床出诊表_Add
(
  操作类型_In Number,
  出诊id_In   临床出诊表.Id%Type,
  出诊表名_In 临床出诊表.出诊表名%Type,
  站点_In     部门表.站点%Type,
  操作员_In   临床出诊安排.操作员姓名%Type,
  操作时间_In 临床出诊安排.登记时间%Type,
  开始时间_In 临床出诊安排.开始时间%Type := Null,
  终止时间_In 临床出诊安排.终止时间%Type := Null,
  年份_In     临床出诊表.年份%Type := Null,
  月份_In     临床出诊表.月份%Type := Null,
  周数_In     临床出诊表.周数%Type := Null,
  应用范围_In 临床出诊表.应用范围%Type := Null,
  科室id_In   临床出诊表.科室id%Type := Null,
  备注_In     临床出诊表.备注%Type := Null,
  人员id_In   人员表.Id%Type := Null,
  删除安排_In Number := 0,
  模板类型_In 临床出诊表.模板类型%Type := Null
) As
  --功能：增加出诊表或模板
  --参数：
  --        操作类型_In 1-模板，2-固定安排, 3-月安排，4-周安排
  --        人员id_In 除固定安排外有效，不为0或null表示临床科室人员在添加
  --        删除安排_In 固定排班转为月排班/周排班时，在制定月排班/周排班时是否删除新出诊表时间内未使用的出诊记录
  --说明：
  v_Err_Msg Varchar2(255);
  Err_Item Exception;
  n_Count Number(8);

  n_出诊id       临床出诊表.Id%Type;
  n_跨月周出诊id 临床出诊表.Id%Type;
  n_跨月周安排id 临床出诊安排.Id%Type;

  l_记录id t_Numlist := t_Numlist();

  Function Get跨月周出诊id(出诊id_In 临床出诊表.Id%Type) Return 临床出诊表.Id%Type Is
    ----------------------------------------
    --如果原周出诊表不是整周(不足7天)，则需要查找到另一个出诊表构成整周
    ----------------------------------------
    n_出诊id 临床出诊表.Id%Type;
    n_年份   临床出诊表.年份%Type;
    n_月份   临床出诊表.月份%Type;
    n_周数   临床出诊表.周数%Type;
  
    d_开始时间 临床出诊安排.开始时间%Type;
    d_结束时间 临床出诊安排.终止时间%Type;
  
    --根据日期计算当月的周数，以及每一周的时间范围
    Cursor c_Weekrange(Date_In Date) Is
      Select Rownum As 周数, 开始日期, 结束日期
      From (With Month_Range As (Select Trunc(Date_In) As First_Day, Last_Day(Trunc(Date_In)) As Last_Day From Dual)
             Select Decode(To_Char(First_Day, 'day'), '星期日', First_Day, Null) As 开始日期,
                    Decode(To_Char(First_Day, 'day'), '星期日', First_Day, Null) As 结束日期
             From Month_Range
             Union All
             Select Decode(Sign(Trunc(First_Day + 7 * Week, 'day') + 1 - First_Day), 1,
                            Trunc(First_Day + 7 * Week, 'day') + 1, First_Day) As 开始日期,
                    Decode(Sign(Trunc(First_Day + 7 * Week, 'day') + 7 - Last_Day), 1, Last_Day,
                            Trunc(First_Day + 7 * Week, 'day') + 7) As 结束日期
             From Month_Range A, (Select Level - 1 As Week From Dual Connect By Level <= 6) B)
             Where 开始日期 <= 结束日期;
  
  
  Begin
    Begin
      Select 年份, 月份, 周数 Into n_年份, n_月份, n_周数 From 临床出诊表 Where ID = 出诊id_In;
    Exception
      When Others Then
        Return 0;
    End;
  
    If n_年份 Is Null Or n_月份 Is Null Or n_周数 Is Null Then
      Return 0;
    End If;
  
    For r_Weekrange In c_Weekrange(To_Date(n_年份 || '-' || n_月份 || '-01', 'yyyy-mm-dd')) Loop
      If r_Weekrange.周数 = n_周数 Then
        d_开始时间 := r_Weekrange.开始日期;
        d_结束时间 := r_Weekrange.结束日期;
        Exit;
      End If;
    End Loop;
  
    If d_开始时间 Is Null Or d_结束时间 Is Null Then
      Return 0;
    End If;
    If Trunc(d_结束时间) - Trunc(d_开始时间) >= 6 Then
      Return 0;
    End If;
  
    --存在跨月的，查找另一个出诊表的年月周
    n_年份 := Null;
    n_月份 := Null;
    n_周数 := Null;
    If Trunc(d_开始时间 - 1, 'month') <> Trunc(d_开始时间, 'month') Then
      --当前是第一周,获取另一个出诊表的年月
      n_年份 := To_Number(To_Char(d_开始时间 - 1, 'yyyy'));
      n_月份 := To_Number(To_Char(d_开始时间 - 1, 'mm'));
    Elsif Trunc(d_结束时间 + 1, 'month') <> Trunc(d_结束时间, 'month') Then
      --当前是最后一周,获取另一个出诊表的年月
      n_年份 := To_Number(To_Char(d_结束时间 + 1, 'yyyy'));
      n_月份 := To_Number(To_Char(d_结束时间 + 1, 'mm'));
      n_周数 := 1;
    Else
      Return 0;
    End If;
  
    --获取跨月的另一个出诊表的ID
    Begin
      Select ID
      Into n_出诊id
      From (Select Rownum As 行号, ID
             From 临床出诊表
             Where Nvl(排班方式, 0) = 2 And 年份 = n_年份 And 月份 = n_月份 And (n_周数 Is Null Or 周数 = n_周数)
             Order By 周数 Desc)
      Where 行号 < 2;
    Exception
      When Others Then
        Return 0;
    End;
  
    Return n_出诊id;
  End;
Begin
  n_出诊id := 出诊id_In;
  If Nvl(n_出诊id, 0) = 0 Then
    Select 临床出诊表_Id.Nextval Into n_出诊id From Dual;
  End If;

  --排班方式：0-固定排班;1-按月排班;2-按周排班;3-模板
  --============================================================================================================================================
  --1.模板
  If Nvl(操作类型_In, 0) = 1 Then
    Begin
      Select 1 Into n_Count From 临床出诊表 Where 出诊表名 = 出诊表名_In And 排班方式 = 3 And Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If Nvl(n_Count, 0) > 0 Then
      v_Err_Msg := '当前已存在名为“' || 出诊表名_In || '”的模板！';
      Raise Err_Item;
    End If;
  
    --检查是否有可操作的有效号源
    Begin
      Select 1
      Into n_Count
      From 临床出诊号源 A, 部门表 D, 人员表 B, 收费项目目录 C
      Where a.科室id = d.Id And a.医生id = b.Id(+) And a.项目id = c.Id And a.排班方式 = Decode(Nvl(模板类型_In, 0), 0, 2, 1) And
            Nvl(a.是否删除, 0) = 0 And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
            Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
            Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
            Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd')
           --当前人员可操作的号源
            And (Nvl(人员id_In, 0) = 0 Or
            (Nvl(a.是否临床排班, 0) = 1 And Exists (Select 1 From 部门人员 Where 部门id = a.科室id And 人员id = 人员id_In)))
           --站点
            And (d.站点 Is Null Or d.站点 = 站点_In) And Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If Nvl(n_Count, 0) = 0 Then
      If Nvl(模板类型_In, 0) = 0 Then
        v_Err_Msg := '当前无可按周排班的号源，不能新增模板，请先到“基础设置>临床号源管理”中添加出诊号源！';
      Else
        v_Err_Msg := '当前无可按月排班的号源，不能新增模板，请先到“基础设置>临床号源管理”中添加出诊号源！';
      End If;
      Raise Err_Item;
    End If;
  
    --模板，肯定是新出诊表
    Insert Into 临床出诊表
      (ID, 排班方式, 出诊表名, 应用范围, 科室id, 备注, 发布人, 发布时间, 模板类型)
    Values
      (n_出诊id, 3, 出诊表名_In, 应用范围_In, 科室id_In, 备注_In, 操作员_In, 操作时间_In, 模板类型_In);
  
    --临床出诊安排
    For c_号源 In (Select 临床出诊安排_Id.Nextval As 安排id, n_出诊id As 出诊id, a.Id As 号源id, a.项目id, a.医生id, a.医生姓名
                 From 临床出诊号源 A, 部门表 D, 人员表 B, 收费项目目录 C
                 Where a.科室id = d.Id And a.医生id = b.Id(+) And a.项目id = c.Id And
                       a.排班方式 = Decode(Nvl(模板类型_In, 0), 0, 2, 1) And Nvl(a.是否删除, 0) = 0 And
                       (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
                       Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                       Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                       Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd')
                      --当前人员可操作的号源
                       And (Nvl(人员id_In, 0) = 0 Or (Nvl(a.是否临床排班, 0) = 1 And Exists
                        (Select 1 From 部门人员 Where 部门id = a.科室id And 人员id = 人员id_In)))
                      --站点
                       And (d.站点 Is Null Or d.站点 = 站点_In)) Loop
    
      If Nvl(模板类型_In, 0) = 2 Then
        --2-按天排班的月排班模板，排班规则缺省为6-特定日期
        Insert Into 临床出诊安排
          (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 排班规则, 操作员姓名, 登记时间)
        Values
          (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 6, 操作员_In, 操作时间_In);
      Else
        Insert Into 临床出诊安排
          (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 排班规则, 操作员姓名, 登记时间)
        Values
          (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 1, 操作员_In, 操作时间_In);
      End If;
    End Loop;
    Return;
  End If;

  --============================================================================================================================================
  --2.固定排班
  If Nvl(操作类型_In, 0) = 2 Then
    Begin
      Select 1 Into n_Count From 临床出诊表 Where 出诊表名 = 出诊表名_In And 排班方式 = 0 And Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If Nvl(n_Count, 0) > 0 Then
      v_Err_Msg := '当前已存在名为“' || 出诊表名_In || '”的固定出诊表！';
      Raise Err_Item;
    End If;
  
    --检查是否有有效号源
    Begin
      Select 1
      Into n_Count
      From 临床出诊号源 A, 部门表 D, 人员表 B, 收费项目目录 C
      Where a.科室id = d.Id And a.医生id = b.Id(+) And a.项目id = c.Id And a.排班方式 = 0 And Nvl(a.是否删除, 0) = 0 And
            (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
            Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
            Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
            Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd')
           --站点
            And (d.站点 Is Null Or d.站点 = 站点_In) And Rownum < 2;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If Nvl(n_Count, 0) = 0 Then
      v_Err_Msg := '当前无可按固定排班的号源，不能新增固定安排，请先到“基础设置>临床号源管理”中添加出诊号源！';
      Raise Err_Item;
    End If;
  
    --固定安排，肯定是新出诊表,只有有"所有科室"权限的人才能新增
    Insert Into 临床出诊表
      (ID, 排班方式, 出诊表名, 年份)
    Values
      (n_出诊id, 0, 出诊表名_In, To_Number(To_Char(开始时间_In, 'yyyy')));
  
    --缺省加入上一次有效的出诊安排
    For c_号源 In (Select 临床出诊安排_Id.Nextval As 安排id, n_出诊id As 出诊id, 原安排id, 号源id, 项目id, 医生id, 医生姓名
                 From (Select a.Id As 原安排id, b.Id As 号源id, b.项目id, b.医生id, b.医生姓名,
                               Row_Number() Over(Partition By b.Id Order By a.开始时间 Desc) As 组号
                        From 临床出诊安排 A, 临床出诊号源 B, 临床出诊表 C, 部门表 D, 人员表 E, 收费项目目录 F
                        Where a.号源id = b.Id And a.出诊id = c.Id And b.科室id = d.Id And b.医生id = e.Id(+) And b.项目id = f.Id
                             --号源限制
                              And b.排班方式 = 0 And Nvl(b.是否删除, 0) = 0 And
                              (b.撤档时间 Is Null Or b.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
                              Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                              Nvl(e.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                              Nvl(f.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd')
                             --上一次出诊安排限制
                              And c.发布人 Is Not Null And c.排班方式 = 0 And (d.站点 Is Null Or d.站点 = 站点_In)) M
                 Where 组号 = 1) Loop
    
      Insert Into 临床出诊安排
        (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 开始时间, 终止时间, 操作员姓名, 登记时间)
      Values
        (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 开始时间_In, 终止时间_In, 操作员_In, 操作时间_In);
    
      --复制出诊安排
      For c_限制 In (Select ID From 临床出诊限制 Where 安排id = c_号源.原安排id) Loop
        Zl_临床出诊限制_Copy(c_限制.Id, c_号源.安排id);
      End Loop;
    End Loop;
  
    --加入无上一次有效出诊安排的号源
    For c_号源 In (Select 临床出诊安排_Id.Nextval As 安排id, n_出诊id As 出诊id, a.Id As 号源id, a.项目id, a.医生id, a.医生姓名
                 From 临床出诊号源 A, 部门表 D, 人员表 B, 收费项目目录 C
                 Where a.科室id = d.Id And a.医生id = b.Id(+) And a.项目id = c.Id And a.排班方式 = 0 And Nvl(a.是否删除, 0) = 0 And
                       (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
                       Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                       Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                       Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd')
                      --站点
                       And (d.站点 Is Null Or d.站点 = 站点_In)
                      
                       And Not Exists (Select 1 From 临床出诊安排 Where 出诊id = n_出诊id And 号源id = a.Id)) Loop
    
      Insert Into 临床出诊安排
        (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 开始时间, 终止时间, 操作员姓名, 登记时间)
      Values
        (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 开始时间_In, 终止时间_In, 操作员_In, 操作时间_In);
    End Loop;
    Return;
  End If;

  --============================================================================================================================================
  --月排班、周排班
  --检查是否有有效号源
  Begin
    Select 1
    Into n_Count
    From 临床出诊号源 A, 部门表 B, 人员表 C, 收费项目目录 D
    Where a.科室id = b.Id And a.医生id = c.Id(+) And a.项目id = d.Id
         --有效号源
          And Nvl(a.是否删除, 0) = 0 And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
          Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
          (
          --月排班
           Nvl(操作类型_In, 0) = 3 And a.排班方式 = 1
          --周排班
           Or Nvl(操作类型_In, 0) = 4 And
           (
           --当前出诊表所在时间范围内不能有月排班
            a.排班方式 = 2 And Not Exists
            (Select 1
                From 临床出诊安排 P, 临床出诊表 Q
                Where p.出诊id = q.Id And p.号源id = a.Id And
                      Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 1)
           --当前已调整为了月排班,但是本月又用了周排班，则本月剩下的部分将继续按周进行排班
            Or a.排班方式 = 1 And Exists
            (Select 1
                From 临床出诊安排 P, 临床出诊表 Q
                Where p.出诊id = q.Id And p.号源id = a.Id And
                      Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 2)))
         --号源在该出诊表时间范围内无出诊记录
          And Not Exists
     (Select 1
           From 临床出诊记录 O, 临床出诊安排 P, 临床出诊表 Q
           Where o.安排id = p.Id And p.出诊id = q.Id And p.号源id = a.Id And o.出诊日期 Between 开始时间_In And 终止时间_In And
                 (q.排班方式 In (1, 2)
                 --原来为固定出诊安排
                 Or q.排班方式 = 0 And (Nvl(删除安排_In, 0) = 0 Or Nvl(删除安排_In, 0) = 1 And Exists
                  (Select 1 From 病人挂号记录 Where 出诊记录id = a.Id))))
         --当前人员可操作的号源
          And (Nvl(人员id_In, 0) = 0 Or
          (Nvl(a.是否临床排班, 0) = 1 And Exists (Select 1 From 部门人员 Where 部门id = a.科室id And 人员id = 人员id_In)))
         --站点
          And (b.站点 Is Null Or b.站点 = 站点_In) And Rownum < 2;
  Exception
    When Others Then
      n_Count := 0;
  End;
  If Nvl(n_Count, 0) = 0 Then
    If Nvl(操作类型_In, 0) = 3 Then
      v_Err_Msg := '当前无可按月排班的号源，不能新增月出诊表，请先到“基础设置>临床号源管理”中添加出诊号源！';
    Else
      v_Err_Msg := '当前无可按周排班的号源，不能新增周出诊表，请先到“基础设置>临床号源管理”中添加出诊号源！';
    End If;
    Raise Err_Item;
  End If;

  --出诊表存在，则不再新增出诊表，直接向该出诊表添加上次有效号源安排即可
  --涉及到临床排班，当前操作员可能只能操作某一部分号源
  Begin
    Select 1 Into n_Count From 临床出诊表 Where ID = n_出诊id;
  Exception
    When Others Then
      n_Count := 0;
  End;
  If Nvl(n_Count, 0) = 0 Then
    Insert Into 临床出诊表
      (ID, 排班方式, 出诊表名, 年份, 月份, 周数)
    Values
      (n_出诊id,
       Case
          When Nvl(操作类型_In, 0) = 3 Then
           1
          Else
           2
        End, 出诊表名_In, 年份_In, 月份_In, 周数_In);
  End If;

  --如果当前出诊表时间范围内无挂号且无预约的出诊记录(固定安排)，则删除这部分出诊记录(在删除出诊表时可恢复)，程序中已询问

  If Nvl(删除安排_In, 0) = 1 Then
    For c_安排 In (Select b.Id As 安排id
                 From 临床出诊安排 B, 临床出诊表 C, 临床出诊号源 D
                 Where b.出诊id = c.Id And b.号源id = d.Id
                      --号源
                       And Nvl(d.是否删除, 0) = 0 And (d.撤档时间 Is Null Or d.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
                       Nvl(d.排班方式, 0) = Decode(Nvl(操作类型_In, 0), 3, 1, 2)
                      --安排有被使用了的出诊记录
                       And c.排班方式 = 0 And b.终止时间 >= 开始时间_In And Not Exists
                  (Select 1
                        From 临床出诊记录 M, 病人挂号记录 N
                        Where m.安排id = b.Id And m.Id = n.出诊记录id And m.出诊日期 >= 开始时间_In)
                      --当前人员可操作的号源
                       And (Nvl(人员id_In, 0) = 0 Or (Nvl(d.是否临床排班, 0) = 1 And Exists
                        (Select 1 From 部门人员 Where 部门id = d.科室id And 人员id = 人员id_In)))) Loop
    
      For c_记录 In (Select ID As 记录id From 临床出诊记录 Where 安排id = c_安排.安排id And 出诊日期 >= 开始时间_In) Loop
        l_记录id.Extend();
        l_记录id(l_记录id.Count) := c_记录.记录id;
      End Loop;
    End Loop;
    Zl_临床出诊记录_Batchdelete(l_记录id);
  
  End If;

  --缺省加入上一次有效的出诊安排
  For c_号源 In (Select 临床出诊安排_Id.Nextval As 安排id, n_出诊id As 出诊id, 原安排id, 号源id, 项目id, 医生id, 医生姓名, 原出诊id
               From (Select a.Id As 原安排id, b.Id As 号源id, b.项目id, b.医生id, b.医生姓名, c.Id As 原出诊id,
                             Row_Number() Over(Partition By b.Id Order By a.开始时间 Desc) As 组号
                      From 临床出诊安排 A, 临床出诊号源 B, 临床出诊表 C, 部门表 D, 人员表 E, 收费项目目录 F
                      Where a.号源id = b.Id And a.出诊id = c.Id And b.科室id = d.Id And b.医生id = e.Id(+) And b.项目id = f.Id
                           --有效号源
                            And Nvl(b.是否删除, 0) = 0 And
                            Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                            Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                            Nvl(e.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                            Nvl(f.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                            (
                            --月排班
                             Nvl(操作类型_In, 0) = 3 And b.排班方式 = 1
                            --周排班
                             Or
                             Nvl(操作类型_In, 0) = 4 And
                             (
                             --当前出诊表所在时间范围内不能有月排班
                              b.排班方式 = 2 And Not Exists
                              (Select 1
                               From 临床出诊安排 P, 临床出诊表 Q
                               Where p.出诊id = q.Id And p.号源id = b.Id And
                                     Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 1)
                             --当前已调整为了月排班,但是本月又用了周排班，则本月剩下的部分将继续按周进行排班
                              Or b.排班方式 = 1 And Exists
                              (Select 1
                               From 临床出诊安排 P, 临床出诊表 Q
                               Where p.出诊id = q.Id And p.号源id = b.Id And
                                     Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 2)))
                           --上一次有效出诊安排
                            And c.发布人 Is Not Null And c.排班方式 = Decode(Nvl(操作类型_In, 0), 3, 1, 2)
                           --号源在该出诊表时间范围内无出诊记录
                            And Not Exists (Select 1
                             From 临床出诊记录 P
                             Where p.号源id = b.Id And p.出诊日期 Between 开始时间_In And 终止时间_In)
                           --当前人员可操作的号源
                            And (Nvl(人员id_In, 0) = 0 Or
                            (Nvl(b.是否临床排班, 0) = 1 And Exists
                             (Select 1 From 部门人员 Where 部门id = b.科室id And 人员id = 人员id_In)))
                           --站点
                            And (d.站点 Is Null Or d.站点 = 站点_In))
               Where 组号 = 1) Loop
  
    Insert Into 临床出诊安排
      (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 开始时间, 终止时间, 操作员姓名, 登记时间)
    Values
      (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 开始时间_In, 终止时间_In, 操作员_In, 操作时间_In);
  
    --整周跨月的周出诊表需要找到相邻的出诊表的安排
    n_跨月周安排id := 0;
    If Nvl(操作类型_In, 0) = 4 Then
      n_跨月周出诊id := Get跨月周出诊id(c_号源.原出诊id);
      If Nvl(n_跨月周出诊id, 0) <> 0 Then
        Begin
          Select a.Id
          Into n_跨月周安排id
          From 临床出诊安排 A, 临床出诊表 B
          Where a.出诊id = b.Id And b.Id = n_跨月周出诊id And a.号源id = c_号源.号源id And b.发布时间 Is Not Null;
        Exception
          When Others Then
            n_跨月周安排id := 0;
        End;
      End If;
    End If;
  
    --复制出诊安排
    For c_记录 In (Select Decode(b.Id, Null, a.Id, b.Id) As ID, c.日期
                 From 临床出诊记录 A, 临床出诊记录 B,
                      (Select Trunc(开始时间_In) + Level - 1 As 日期
                        From Dual
                        Connect By Level <= Trunc(终止时间_In) - Trunc(开始时间_In) + 1) C
                 Where a.Id = b.相关id(+) And (a.安排id = c_号源.原安排id Or a.安排id = n_跨月周安排id) And a.相关id Is Null And
                       Nvl(a.是否临时出诊, 0) = 0
                      --月排班
                       And (Nvl(操作类型_In, 0) = 3 And To_Char(a.出诊日期, 'dd') = To_Char(c.日期, 'dd')
                       --周排班
                       Or Nvl(操作类型_In, 0) = 4 And To_Char(a.出诊日期, 'D') = To_Char(c.日期, 'D'))) Loop
      Zl_临床出诊记录_Copy(c_记录.Id, c_号源.安排id, c_记录.日期, 操作员_In, 操作时间_In);
    End Loop;
  End Loop;

  --加入无上一次有效出诊安排的号源
  For c_号源 In (Select 临床出诊安排_Id.Nextval As 安排id, n_出诊id As 出诊id, a.Id As 号源id, a.项目id, a.医生id, a.医生姓名
               From 临床出诊号源 A, 部门表 D, 人员表 B, 收费项目目录 C
               Where a.科室id = d.Id And a.医生id = b.Id(+) And a.项目id = c.Id
                    --有效号源
                     And Nvl(a.是否删除, 0) = 0 And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
                     Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     (
                     --月排班
                      Nvl(操作类型_In, 0) = 3 And a.排班方式 = 1
                     --周排班
                      Or Nvl(操作类型_In, 0) = 4 And
                      (
                      --当前出诊表所在时间范围内不能有月排班
                       a.排班方式 = 2 And Not Exists
                       (Select 1
                           From 临床出诊安排 P, 临床出诊表 Q
                           Where p.出诊id = q.Id And p.号源id = a.Id And
                                 Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 1)
                      --当前已调整为了月排班,但是本月又用了周排班，则本月剩下的部分将继续按周进行排班
                       Or a.排班方式 = 1 And Exists
                       (Select 1
                           From 临床出诊安排 P, 临床出诊表 Q
                           Where p.出诊id = q.Id And p.号源id = a.Id And
                                 Not (p.终止时间 < Trunc(开始时间_In, 'MONTH') Or p.开始时间 > Last_Day(开始时间_In)) And q.排班方式 = 2)))
                    --号源在该出诊表时间范围内无出诊记录
                     And Not Exists
                (Select 1
                      From 临床出诊记录 P
                      Where p.号源id = a.Id And p.出诊日期 Between 开始时间_In And 终止时间_In)
                    --当前人员可操作的号源
                     And (Nvl(人员id_In, 0) = 0 Or (Nvl(a.是否临床排班, 0) = 1 And Exists
                      (Select 1 From 部门人员 Where 部门id = a.科室id And 人员id = 人员id_In)))
                    --站点
                     And (d.站点 Is Null Or d.站点 = 站点_In)
                    
                     And Not Exists (Select 1 From 临床出诊安排 Where 出诊id = n_出诊id And 号源id = a.Id)) Loop
  
    Insert Into 临床出诊安排
      (ID, 出诊id, 号源id, 项目id, 医生id, 医生姓名, 开始时间, 终止时间, 操作员姓名, 登记时间)
    Values
      (c_号源.安排id, c_号源.出诊id, c_号源.号源id, c_号源.项目id, c_号源.医生id, c_号源.医生姓名, 开始时间_In, 终止时间_In, 操作员_In, 操作时间_In);
  End Loop;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊表_Add;
/

--106752:冉俊明,2017-03-12,停用（或删除）了科室或医生或收费项目的号源按停用号源处理。
Create Or Replace Procedure Zl_临床出诊表_Totemplet
(
  出诊id_In   临床出诊表.Id%Type,
  模板id_In   临床出诊表.Id%Type,
  出诊表名_In 临床出诊表.出诊表名%Type,
  应用范围_In 临床出诊表.应用范围%Type,
  科室id_In   临床出诊表.科室id%Type,
  备注_In     临床出诊表.备注%Type,
  操作员_In   临床出诊安排.操作员姓名%Type,
  操作时间_In 临床出诊安排.登记时间%Type,
  站点_In     部门表.站点%Type,
  人员id_In   人员表.Id%Type := Null
) As
  --功能：由月/周出诊表生成模板
  --参数：
  --        出诊id_In 月/周出诊表的出诊ID
  --        人员id_In 除固定安排外有效，不为0或null表示临床科室人员在添加
  --说明：
  v_Err_Msg Varchar2(255);
  Err_Item Exception;
  n_Count Number(8);

  n_模板id       临床出诊表.Id%Type;
  n_模板类型     临床出诊表.模板类型%Type;
  n_跨月周出诊id 临床出诊表.Id%Type;

  n_安排id 临床出诊安排.Id%Type;

  Function Get跨月周出诊id(出诊id_In 临床出诊表.Id%Type) Return 临床出诊表.Id%Type Is
    ----------------------------------------
    --如果原周出诊表不是整周(不足7天)，则需要查找到另一个出诊表构成整周
    ----------------------------------------
    n_出诊id 临床出诊表.Id%Type;
    n_年份   临床出诊表.年份%Type;
    n_月份   临床出诊表.月份%Type;
    n_周数   临床出诊表.周数%Type;
  
    d_开始时间 临床出诊安排.开始时间%Type;
    d_结束时间 临床出诊安排.终止时间%Type;
  
    --根据日期计算当月的周数，以及每一周的时间范围
    Cursor c_Weekrange(Date_In Date) Is
      Select Rownum As 周数, 开始日期, 结束日期
      From (With Month_Range As (Select Trunc(Date_In) As First_Day, Last_Day(Trunc(Date_In)) As Last_Day From Dual)
             Select Decode(To_Char(First_Day, 'day'), '星期日', First_Day, Null) As 开始日期,
                    Decode(To_Char(First_Day, 'day'), '星期日', First_Day, Null) As 结束日期
             From Month_Range
             Union All
             Select Decode(Sign(Trunc(First_Day + 7 * Week, 'day') + 1 - First_Day), 1,
                            Trunc(First_Day + 7 * Week, 'day') + 1, First_Day) As 开始日期,
                    Decode(Sign(Trunc(First_Day + 7 * Week, 'day') + 7 - Last_Day), 1, Last_Day,
                            Trunc(First_Day + 7 * Week, 'day') + 7) As 结束日期
             From Month_Range A, (Select Level - 1 As Week From Dual Connect By Level <= 6) B)
             Where 开始日期 <= 结束日期;
  
  
  Begin
    Begin
      Select 年份, 月份, 周数 Into n_年份, n_月份, n_周数 From 临床出诊表 Where ID = 出诊id_In;
    Exception
      When Others Then
        Return 0;
    End;
  
    If n_年份 Is Null Or n_月份 Is Null Or n_周数 Is Null Then
      Return 0;
    End If;
  
    For r_Weekrange In c_Weekrange(To_Date(n_年份 || '-' || n_月份 || '-01', 'yyyy-mm-dd')) Loop
      If r_Weekrange.周数 = n_周数 Then
        d_开始时间 := r_Weekrange.开始日期;
        d_结束时间 := r_Weekrange.结束日期;
        Exit;
      End If;
    End Loop;
  
    If d_开始时间 Is Null Or d_结束时间 Is Null Then
      Return 0;
    End If;
    If Trunc(d_结束时间) - Trunc(d_开始时间) >= 6 Then
      Return 0;
    End If;
  
    --存在跨月的，查找另一个出诊表的年月周
    n_年份 := Null;
    n_月份 := Null;
    n_周数 := Null;
    If Trunc(d_开始时间 - 1, 'month') <> Trunc(d_开始时间, 'month') Then
      --当前是第一周,获取另一个出诊表的年月
      n_年份 := To_Number(To_Char(d_开始时间 - 1, 'yyyy'));
      n_月份 := To_Number(To_Char(d_开始时间 - 1, 'mm'));
    Elsif Trunc(d_结束时间 + 1, 'month') <> Trunc(d_结束时间, 'month') Then
      --当前是最后一周,获取另一个出诊表的年月
      n_年份 := To_Number(To_Char(d_结束时间 + 1, 'yyyy'));
      n_月份 := To_Number(To_Char(d_结束时间 + 1, 'mm'));
      n_周数 := 1;
    Else
      Return 0;
    End If;
  
    --获取跨月的另一个出诊表的ID
    Begin
      Select ID
      Into n_出诊id
      From (Select Rownum As 行号, ID
             From 临床出诊表
             Where Nvl(排班方式, 0) = 2 And 年份 = n_年份 And 月份 = n_月份 And (n_周数 Is Null Or 周数 = n_周数)
             Order By 周数 Desc)
      Where 行号 < 2;
    Exception
      When Others Then
        Return 0;
    End;
  
    Return n_出诊id;
  End;
Begin
  Select Count(1)
  Into n_Count
  From 临床出诊号源 A, 临床出诊安排 B, 临床出诊记录 C, 部门表 D, 人员表 E, 收费项目目录 F
  Where a.Id = b.号源id And b.Id = c.安排id And a.科室id = d.Id And a.医生id = e.Id(+) And a.项目id = f.Id And a.排班方式 In (1, 2) And
        Nvl(a.是否删除, 0) = 0 And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
        Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
        Nvl(e.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
        Nvl(f.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd')
       --当前人员可操作的号源
        And (Nvl(人员id_In, 0) = 0 Or
        (Nvl(a.是否临床排班, 0) = 1 And Exists (Select 1 From 部门人员 Where 部门id = a.科室id And 人员id = 人员id_In)))
       --站点
        And (d.站点 Is Null Or d.站点 = 站点_In) And b.出诊id = 出诊id_In And Rownum < 2;
  If Nvl(n_Count, 0) = 0 Then
    v_Err_Msg := '当前出诊表中无有效的安排，不能另存为模板！';
    Raise Err_Item;
  End If;

  --排班方式：0-固定排班;1-按月排班;2-按周排班;3-模板
  Select Count(1) Into n_Count From 临床出诊表 Where 出诊表名 = 出诊表名_In And 排班方式 = 3 And Rownum < 2;
  If Nvl(n_Count, 0) > 0 Then
    v_Err_Msg := '当前已存在名为“' || 出诊表名_In || '”的模板！';
    Raise Err_Item;
  End If;

  Begin
    Select Decode(排班方式, 1, 2, 0)
    Into n_模板类型
    From 临床出诊表
    Where ID = 出诊id_In And 排班方式 In (1, 2) And Rownum < 2;
  Exception
    When Others Then
      v_Err_Msg := '未发现当前出诊表！';
      Raise Err_Item;
  End;

  n_模板id := 模板id_In;
  If Nvl(n_模板id, 0) = 0 Then
    Select 临床出诊表_Id.Nextval Into n_模板id From Dual;
  End If;

  --模板，肯定是新出诊表
  Insert Into 临床出诊表
    (ID, 排班方式, 出诊表名, 应用范围, 科室id, 备注, 发布人, 发布时间, 模板类型)
  Values
    (n_模板id, 3, 出诊表名_In, 应用范围_In, 科室id_In, 备注_In, 操作员_In, 操作时间_In, n_模板类型);

  --如果原周出诊表不是整周(不足7天)，则需要查找到另一个出诊表构成整周
  If Nvl(n_模板类型, 0) = 0 Then
    n_跨月周出诊id := Get跨月周出诊id(出诊id_In);
  End If;

  --月/周出诊表保存为模板
  For c_安排 In (Select b.Id As 安排id, b.号源id, a.项目id, a.医生id, a.医生姓名
               From 临床出诊号源 A, 临床出诊安排 B, 部门表 D, 人员表 E, 收费项目目录 F
               Where a.Id = b.号源id And a.科室id = d.Id And a.医生id = e.Id(+) And a.项目id = f.Id And a.排班方式 In (1, 2) And
                     Nvl(a.是否删除, 0) = 0 And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
                     Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(e.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(f.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd')
                    --当前人员可操作的号源
                     And (Nvl(人员id_In, 0) = 0 Or (Nvl(a.是否临床排班, 0) = 1 And Exists
                      (Select 1 From 部门人员 Where 部门id = a.科室id And 人员id = 人员id_In)))
                    --站点
                     And (d.站点 Is Null Or d.站点 = 站点_In) And (b.出诊id = 出诊id_In Or b.出诊id = n_跨月周出诊id)) Loop
  
    Begin
      Select ID Into n_安排id From 临床出诊安排 Where 出诊id = n_模板id And 号源id = c_安排.号源id;
    Exception
      When Others Then
        n_安排id := Null;
    End;
  
    If Nvl(n_安排id, 0) = 0 Then
      Select 临床出诊安排_Id.Nextval Into n_安排id From Dual;
    
      --1.临床出诊安排
      --排班规则:1-星期排班;2-单日排班;3-双日排班;4-月内轮循;5-轮循不限制;6-特定日期
      If Nvl(n_模板类型, 0) = 2 Then
        --按天安排出诊的月出诊表保存为特定日期的规则
        Zl_临床出诊安排_Insert(n_安排id, n_模板id, c_安排.号源id, c_安排.项目id, c_安排.医生id, c_安排.医生姓名, 6, Null, Null, Null, Null, 操作员_In,
                         操作时间_In);
      Else
        Zl_临床出诊安排_Insert(n_安排id, n_模板id, c_安排.号源id, c_安排.项目id, c_安排.医生id, c_安排.医生姓名, 1, Null, Null, Null, Null, 操作员_In,
                         操作时间_In);
      End If;
    End If;
  
    For c_记录 In (Select 临床出诊限制_Id.Nextval As 限制id, Decode(b.Id, Null, a.Id, b.Id) As 记录id,
                        Decode(To_Char(a.出诊日期, 'D'), '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7', '周六',
                                '1', '周日') As 限制项目, To_Number(To_Char(a.出诊日期, 'dd')) || '日' As 出诊日期, a.上班时段,
                        Decode(b.Id, Null, a.限号数, b.限号数) As 限号数, Decode(b.Id, Null, a.限约数, b.限约数) As 限约数,
                        Decode(b.Id, Null, a.是否分时段, b.是否分时段) As 是否分时段, Decode(b.Id, Null, a.是否序号控制, b.是否序号控制) As 是否序号控制,
                        Decode(b.Id, Null, a.预约控制, b.预约控制) As 预约控制, Decode(b.Id, Null, a.是否独占, b.是否独占) As 是否独占,
                        Decode(b.Id, Null, a.分诊方式, b.分诊方式) As 分诊方式
                 From 临床出诊记录 A, 临床出诊记录 B
                 Where a.Id = b.相关id(+) And a.安排id = c_安排.安排id And a.相关id Is Null And Nvl(a.是否临时出诊, 0) = 0) Loop
    
      --2.临床出诊限制
      If Nvl(n_模板类型, 0) = 2 Then
        Insert Into 临床出诊限制
          (ID, 安排id, 限制项目, 上班时段, 限号数, 限约数, 是否分时段, 是否序号控制, 预约控制, 是否独占, 分诊方式)
        Values
          (c_记录.限制id, n_安排id, c_记录.出诊日期, c_记录.上班时段, c_记录.限号数, c_记录.限约数, c_记录.是否分时段, c_记录.是否序号控制, c_记录.预约控制, c_记录.是否独占,
           c_记录.分诊方式);
      Else
        Insert Into 临床出诊限制
          (ID, 安排id, 限制项目, 上班时段, 限号数, 限约数, 是否分时段, 是否序号控制, 预约控制, 是否独占, 分诊方式)
        Values
          (c_记录.限制id, n_安排id, c_记录.限制项目, c_记录.上班时段, c_记录.限号数, c_记录.限约数, c_记录.是否分时段, c_记录.是否序号控制, c_记录.预约控制, c_记录.是否独占,
           c_记录.分诊方式);
      End If;
    
      --3.临床出诊诊室
      Insert Into 临床出诊诊室
        (限制id, 诊室id)
        Select c_记录.限制id, 诊室id From 临床出诊诊室记录 Where 记录id = c_记录.记录id;
    
      --4.临床出诊时段
      --分时段不分序号的，在预约挂号时会新增记录，填写预约顺序号
      If Nvl(c_记录.是否分时段, 0) = 1 And Nvl(c_记录.是否序号控制, 0) = 1 Then
        Insert Into 临床出诊时段
          (限制id, 序号, 开始时间, 终止时间, 限制数量, 是否预约)
          Select c_记录.限制id, 序号, 开始时间, 终止时间, 数量, 是否预约
          From 临床出诊序号控制
          Where 记录id = c_记录.记录id;
      Else
        Insert Into 临床出诊时段
          (限制id, 序号, 开始时间, 终止时间, 限制数量, 是否预约)
          Select c_记录.限制id, 序号, 开始时间, 终止时间, 数量, 是否预约
          From 临床出诊序号控制
          Where 记录id = c_记录.记录id And 预约顺序号 Is Null;
      End If;
    
      --5.临床出诊挂号控制
      Insert Into 临床出诊挂号控制
        (限制id, 类型, 性质, 名称, 序号, 控制方式, 数量)
        Select c_记录.限制id, 类型, 性质, 名称, 序号, 控制方式, 数量
        From 临床出诊挂号控制记录
        Where 记录id = c_记录.记录id;
    End Loop;
  End Loop;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊表_Totemplet;
/

--106752:冉俊明,2017-03-12,停用（或删除）了科室或医生或收费项目的号源按停用号源处理。
Create Or Replace Procedure Zl_临床出诊安排_Publish
(
  Id_In       临床出诊表.Id%Type,
  发布人_In   临床出诊表.发布人%Type := Null,
  发布时间_In 临床出诊表.发布时间%Type := Null,
  取消发布_In Number := 0
) As
  --发布和取消发布安排
  --参数：
  --        取消发布_In 是否取消发布
  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  n_Count    Number(2);
  n_排班方式 临床出诊表.排班方式%Type;
  l_记录id   t_Numlist := t_Numlist();

  d_开始时间 临床出诊安排.开始时间%Type;
  d_终止时间 临床出诊安排.终止时间%Type;

  n_跨月周出诊id 临床出诊表.Id%Type;

  Function Get跨月周出诊id(出诊id_In 临床出诊表.Id%Type) Return 临床出诊表.Id%Type Is
    ----------------------------------------
    --如果原周出诊表不是整周(不足7天)，则需要查找到另一个出诊表构成整周
    ----------------------------------------
    n_出诊id 临床出诊表.Id%Type;
    n_年份   临床出诊表.年份%Type;
    n_月份   临床出诊表.月份%Type;
    n_周数   临床出诊表.周数%Type;
  
    d_开始时间 临床出诊安排.开始时间%Type;
    d_结束时间 临床出诊安排.终止时间%Type;
  
    --根据日期计算当月的周数，以及每一周的时间范围
    Cursor c_Weekrange(Date_In Date) Is
      Select Rownum As 周数, 开始日期, 结束日期
      From (With Month_Range As (Select Trunc(Date_In) As First_Day, Last_Day(Trunc(Date_In)) As Last_Day From Dual)
             Select Decode(To_Char(First_Day, 'day'), '星期日', First_Day, Null) As 开始日期,
                    Decode(To_Char(First_Day, 'day'), '星期日', First_Day, Null) As 结束日期
             From Month_Range
             Union All
             Select Decode(Sign(Trunc(First_Day + 7 * Week, 'day') + 1 - First_Day), 1,
                            Trunc(First_Day + 7 * Week, 'day') + 1, First_Day) As 开始日期,
                    Decode(Sign(Trunc(First_Day + 7 * Week, 'day') + 7 - Last_Day), 1, Last_Day,
                            Trunc(First_Day + 7 * Week, 'day') + 7) As 结束日期
             From Month_Range A, (Select Level - 1 As Week From Dual Connect By Level <= 6) B)
             Where 开始日期 <= 结束日期;
  
  
  Begin
    Begin
      Select 年份, 月份, 周数 Into n_年份, n_月份, n_周数 From 临床出诊表 Where ID = 出诊id_In;
    Exception
      When Others Then
        Return 0;
    End;
  
    If n_年份 Is Null Or n_月份 Is Null Or n_周数 Is Null Then
      Return 0;
    End If;
  
    For r_Weekrange In c_Weekrange(To_Date(n_年份 || '-' || n_月份 || '-01', 'yyyy-mm-dd')) Loop
      If r_Weekrange.周数 = n_周数 Then
        d_开始时间 := r_Weekrange.开始日期;
        d_结束时间 := r_Weekrange.结束日期;
        Exit;
      End If;
    End Loop;
  
    If d_开始时间 Is Null Or d_结束时间 Is Null Then
      Return 0;
    End If;
    If Trunc(d_结束时间) - Trunc(d_开始时间) >= 6 Then
      Return 0;
    End If;
  
    --存在跨月的，查找另一个出诊表的年月周
    n_年份 := Null;
    n_月份 := Null;
    n_周数 := Null;
    If Trunc(d_开始时间 - 1, 'month') <> Trunc(d_开始时间, 'month') Then
      --当前是第一周,获取另一个出诊表的年月
      n_年份 := To_Number(To_Char(d_开始时间 - 1, 'yyyy'));
      n_月份 := To_Number(To_Char(d_开始时间 - 1, 'mm'));
    Elsif Trunc(d_结束时间 + 1, 'month') <> Trunc(d_结束时间, 'month') Then
      --当前是最后一周,获取另一个出诊表的年月
      n_年份 := To_Number(To_Char(d_结束时间 + 1, 'yyyy'));
      n_月份 := To_Number(To_Char(d_结束时间 + 1, 'mm'));
      n_周数 := 1;
    Else
      Return 0;
    End If;
  
    --获取跨月的另一个出诊表的ID
    Begin
      Select ID
      Into n_出诊id
      From (Select Rownum As 行号, ID
             From 临床出诊表
             Where Nvl(排班方式, 0) = 2 And 年份 = n_年份 And 月份 = n_月份 And (n_周数 Is Null Or 周数 = n_周数)
             Order By 周数 Desc)
      Where 行号 < 2;
    Exception
      When Others Then
        Return 0;
    End;
  
    Return n_出诊id;
  End;
Begin
  Begin
    Select Nvl(排班方式, 0) Into n_排班方式 From 临床出诊表 Where ID = Id_In;
  Exception
    When Others Then
      v_Err_Msg := '出诊表信息未找到！';
      Raise Err_Item;
  End;

  If Nvl(取消发布_In, 0) = 0 Then
    --发布安排
    If Nvl(n_排班方式, 0) = 0 Then
      Select Max(1)
      Into n_Count
      From 临床出诊安排 A, 临床出诊限制 B, 临床出诊表 C
      Where a.Id = b.安排id And a.出诊id = c.Id And c.排班方式 = 0 And c.Id = Id_In And Rownum < 2;
      If Nvl(n_Count, 0) = 0 Then
        v_Err_Msg := '当前出诊表无有效的安排，不能发布！';
        Raise Err_Item;
      End If;
    Else
      If Nvl(n_排班方式, 0) = 2 Then
        n_跨月周出诊id := Get跨月周出诊id(Id_In);
      End If;
      Select Max(1)
      Into n_Count
      From 临床出诊安排 A, 临床出诊记录 B, 临床出诊表 C
      Where a.Id = b.安排id And a.出诊id = c.Id And c.排班方式 In (1, 2) And (c.Id = Id_In Or c.Id = n_跨月周出诊id) And Rownum < 2;
      If Nvl(n_Count, 0) = 0 Then
        v_Err_Msg := '当前出诊表无有效的安排，不能发布！';
        Raise Err_Item;
      End If;
    
      Select Max(1)
      Into n_Count
      From 临床出诊记录 A, 临床出诊安排 B
      Where a.号源id = b.号源id And a.出诊日期 Between b.开始时间 And b.终止时间 And a.安排id <> b.Id And b.出诊id = Id_In And Rownum < 2;
      If Nvl(n_Count, 0) <> 0 Then
        v_Err_Msg := '当前出诊表中的部分号源在当前出诊表的生效时间范围内已经存在有效的安排，不能发布！';
        Raise Err_Item;
      End If;
    End If;
  
    --如果存在多个未发布的安排表，则不允许发布后面日期的安排，必须按最小有效时间进行发布
    Select Max(1)
    Into n_Count
    From (Select ID, 年份 || LPad(月份, 2, '0') || 周数 As 日期
           From 临床出诊表
           Where Nvl(排班方式, 0) = Nvl(n_排班方式, 0) And 发布人 Is Null) A,
         (Select ID, 年份 || LPad(月份, 2, '0') || 周数 As 日期 From 临床出诊表 Where ID = Id_In) B
    Where a.日期 < b.日期 And Rownum < 2;
    If Nvl(n_Count, 0) <> 0 Then
      If Nvl(n_排班方式, 0) = 0 Then
        v_Err_Msg := '当前出诊表前面还有未发布的固定出诊表，必须先将其发布或删除后才能发布该出诊表！';
      Elsif Nvl(n_排班方式, 0) = 1 Then
        v_Err_Msg := '当前出诊表前面还有未发布的月出诊表，必须先将其发布或删除后才能发布该出诊表！';
      Elsif Nvl(n_排班方式, 0) = 2 Then
        v_Err_Msg := '当前出诊表前面还有未发布的周出诊表，必须先将其发布或删除后才能发布该出诊表！';
      End If;
      Raise Err_Item;
    End If;
  
    Update 临床出诊表 Set 发布人 = 发布人_In, 发布时间 = 发布时间_In Where ID = Id_In;
    Update 临床出诊安排 Set 审核人 = 发布人_In, 审核时间 = 发布时间_In Where 出诊id = Id_In;
  
    --删除发布时有安排，但是号源已被停用的记录
    For c_安排 In (Select a.Id
                 From 临床出诊安排 A, 临床出诊号源 B, 部门表 C, 人员表 D, 收费项目目录 E
                 Where a.号源id = b.Id And b.科室id = c.Id And a.医生id = d.Id(+) And b.项目id = e.Id And a.出诊id = Id_In And
                       Not (Nvl(b.是否删除, 0) = 0 And (b.撤档时间 Is Null Or b.撤档时间 = To_Date('3000-01-01', 'yyyy-mm-dd')) And
                        Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                        Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                        Nvl(e.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd'))) Loop
      Zl_临床出诊安排_Delete(c_安排.Id, Nvl(n_排班方式, 0));
    End Loop;
  
    If Nvl(n_排班方式, 0) <> 0 Then
      --月安排/周安排根据停诊安排和法定节假日调整出诊记录的出诊/预约情况
      Select 开始时间, 终止时间 Into d_开始时间, d_终止时间 From 临床出诊安排 Where 出诊id = Id_In And Rownum < 2;
      For c_安排 In (Select a.Id, a.号源id, b.日期
                   From 临床出诊安排 A,
                        (Select Trunc(d_开始时间) + Level - 1 As 日期
                          From Dual
                          Connect By Level <= Trunc(d_终止时间) - Trunc(d_开始时间) + 1) B
                   Where a.出诊id = Id_In
                   Order By 号源id, 日期) Loop
      
        Zl_Clinicvisitmodify(c_安排.号源id, c_安排.Id, c_安排.日期, 发布人_In, 发布时间_In);
      End Loop;
    
      --修改临床出诊记录中的"是否发布"
      Select a.Id Bulk Collect
      Into l_记录id
      From 临床出诊记录 A, 临床出诊安排 B
      Where a.安排id = b.Id And b.出诊id = Id_In;
    
      Forall I In 1 .. l_记录id.Count
        Update 临床出诊记录 Set 是否发布 = 1 Where ID = l_记录id(I);
    End If;
    Return;
  End If;

  --==================================================================================================================
  --取消发布
  Select Max(1)
  Into n_Count
  From (Select ID, 年份 || LPad(月份, 2, '0') || 周数 As 日期
         From 临床出诊表
         Where Nvl(排班方式, 0) = Nvl(n_排班方式, 0) And 发布人 Is Not Null) A,
       (Select ID, 年份 || LPad(月份, 2, '0') || 周数 As 日期 From 临床出诊表 Where ID = Id_In) B
  Where a.日期 > b.日期 And Rownum < 2;
  If Nvl(n_Count, 0) <> 0 Then
    If Nvl(n_排班方式, 0) = 0 Then
      v_Err_Msg := '当前出诊后面还有已发布的固定出诊表，必须先将其取消发布后才能取消发布该出诊表！';
    Elsif Nvl(n_排班方式, 0) = 1 Then
      v_Err_Msg := '当前出诊后面还有已发布的月出诊表，必须先将其取消发布后才能取消发布该出诊表！';
    Elsif Nvl(n_排班方式, 0) = 2 Then
      v_Err_Msg := '当前出诊后面还有已发布的周出诊表，必须先将其取消发布后才能取消发布该出诊表！';
    End If;
    Raise Err_Item;
  End If;

  Select Max(1)
  Into n_Count
  From 病人挂号记录 C, 临床出诊记录 A, 临床出诊安排 B
  Where c.出诊记录id = a.Id And a.安排id = b.Id And b.出诊id = Id_In And Rownum < 2;
  If Nvl(n_Count, 0) <> 0 Then
    v_Err_Msg := '当前出诊表的安排已被使用，不允许取消发布！';
    Raise Err_Item;
  End If;

  Update 临床出诊表 Set 发布人 = Null, 发布时间 = Null Where ID = Id_In;
  If Sql%NotFound Then
    v_Err_Msg := '出诊表信息未找到！';
    Raise Err_Item;
  End If;
  Update 临床出诊安排 Set 审核人 = Null, 审核时间 = Null Where 出诊id = Id_In;

  --固定安排取消发布时删除出诊记录
  If Nvl(n_排班方式, 0) = 0 Then
    --删除出诊记录
    Select a.Id Bulk Collect
    Into l_记录id
    From 临床出诊记录 A, 临床出诊安排 B
    Where a.安排id = b.Id And b.出诊id = Id_In;
  
    Zl_临床出诊记录_Batchdelete(l_记录id);
  Else
    --月安排/周安排清除停诊信息，并修改是否发布
    Select a.Id Bulk Collect
    Into l_记录id
    From 临床出诊记录 A, 临床出诊安排 B
    Where a.安排id = b.Id And b.出诊id = Id_In;
  
    Forall I In 1 .. l_记录id.Count
      Delete From 临床出诊停诊记录 Where 记录id = l_记录id(I);
  
    --修改临床出诊记录中的"是否发布"
    Select a.Id Bulk Collect
    Into l_记录id
    From 临床出诊记录 A, 临床出诊安排 B
    Where a.安排id = b.Id And b.出诊id = Id_In;
  
    Forall I In 1 .. l_记录id.Count
      Update 临床出诊记录
      Set 停诊开始时间 = Null, 停诊终止时间 = Null, 停诊原因 = Null, 是否发布 = 0
      Where ID = l_记录id(I);
  
    --恢复临床出诊序号控制的"是否预约"及"是否停诊"
    For c_记录 In (Select a.Id, a.是否分时段, a.是否序号控制
                 From 临床出诊记录 A, 临床出诊安排 B
                 Where a.安排id = b.Id And b.出诊id = Id_In) Loop
      If Nvl(c_记录.是否分时段, 0) = 1 Then
        If Nvl(c_记录.是否序号控制, 0) = 0 Then
          Update 临床出诊序号控制 Set 是否预约 = 1 Where 记录id = c_记录.Id;
        Else
          Update 临床出诊序号控制 Set 是否预约 = Nvl(预约顺序号, 0), 是否停诊 = 0 Where 记录id = c_记录.Id;
        End If;
      End If;
    End Loop;
  
    --换休的不再恢复
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_临床出诊安排_Publish;
/

--106648:刘尔旋,2017-03-23,分诊换号序号处理
Create Or Replace Procedure Zl_病人挂号记录_换号
(
  No_In         病人挂号记录.No%Type,
  号别_In       病人挂号记录.号别%Type,
  诊室_In       病人挂号记录.诊室%Type,
  科室id_In     病人挂号记录.执行部门id%Type,
  原医生_In     病人挂号记录.执行人%Type,
  原医生id_In   病人挂号汇总.医生id%Type,
  新医生_In     病人挂号记录.执行人%Type,
  新医生id_In   病人挂号汇总.医生id%Type,
  出诊记录id_In 临床出诊记录.Id%Type := Null
  --功能：完成病人换号功能，在挂号项目ID相同的情况下。
) As
  Cursor c_Bill Is
    Select a.Id, a.记录性质, a.No, a.实际票号, a.记录状态, b.号序, a.序号, a.从属父号, a.价格父号, a.记帐单id, a.病人id, a.医嘱序号, a.门诊标志, a.记帐费用, a.姓名,
           a.性别, a.年龄, a.标识号, a.付款方式, a.病人科室id, a.费别, 收费类别, a.收费细目id, a.计算单位, a.付数, a.发药窗口, a.数次, a.加班标志, a.附加标志, a.婴儿费,
           a.收入项目id, a.收据费目, a.标准单价, a.应收金额, a.实收金额, a.划价人, a.开单部门id, a.开单人, b.发生时间, a.登记时间, a.执行部门id, a.执行人, a.执行状态,
           a.执行时间, a.结论, a.操作员编号, a.操作员姓名, a.结帐id, a.结帐金额, a.保险大类id, a.保险项目否, a.保险编码, a.费用类型, a.统筹金额, a.是否上传, a.摘要,
           a.是否急诊
    From 门诊费用记录 A, 病人挂号记录 B
    Where a.记录性质 = 4 And a.记录状态 = 1 And a.No = No_In And a.No = b.No
    Order By a.序号;

  v_病人id           门诊费用记录.Id%Type;
  v_队列名称         排队叫号队列.队列名称%Type;
  v_现队列名称       排队叫号队列.队列名称%Type;
  v_挂号生成队列     Varchar2(2);
  n_分诊台签到排队   Number;
  n_再次签到重新排队 Number;
  v_预约挂号         Number(2);
  n_业务id           病人挂号记录.Id%Type;
  v_排队号码         排队叫号队列.排队号码%Type;
  v_号别             病人挂号记录.号别%Type;
  n_号序             病人挂号记录.号序%Type;
  v_排队序号         排队叫号队列.排队序号%Type;
  d_排队时间         排队叫号队列.排队时间%Type;
  v_Temp             Varchar2(500);
  n_Exists           Number(3);
  v_操作员编号       就诊变动记录.操作员编号%Type;
  v_操作员姓名       就诊变动记录.操作员姓名%Type;
  n_医生id           人员表.Id%Type;
  n_诊室id           门诊诊室.Id%Type;
  n_原出诊记录id     临床出诊记录.Id%Type;
  v_Error            Varchar2(255);
  n_原序号           临床出诊序号控制.序号%Type;
  n_原预约顺序号     临床出诊序号控制.预约顺序号%Type;
  n_原挂号状态       临床出诊序号控制.挂号状态%Type;
  v_原操作员         临床出诊序号控制.操作员姓名%Type;
  Err_Custom Exception;
Begin
  v_病人id := 0;
  If 出诊记录id_In Is Null Then
    Begin
      Select 病人id Into v_病人id From 病人挂号记录 Where NO = No_In And 记录性质 = 1 And 记录状态 = 1;
    Exception
      When Others Then
        Null;
    End;
    If v_病人id = 0 Then
      v_Error := '没有找到病人的挂号信息。';
      Raise Err_Custom;
    Elsif v_病人id Is Null Then
      v_Error := '没有找到病人信息。';
      Raise Err_Custom;
    End If;
  
    ---先更新病人信息的就诊诊室和状态
    Update 病人信息 Set 就诊诊室 = 诊室_In, 就诊状态 = 1 Where 病人id = v_病人id And 就诊状态 In (1, 2);
  
    For r_Bill In c_Bill Loop
      If r_Bill.序号 = 1 Then
      
        --需要确定是否预约挂号
        --1.如果是退预约挂号产生的挂号记录,则需要减已挂数和其中已接数
        --2.如果是正常挂号,则只减已挂数
        Begin
          Select Decode(预约, Null, 0, 0, 0, 1) Into v_预约挂号 From 病人挂号记录 Where NO = r_Bill.No And Rownum = 1;
        Exception
          When Others Then
            v_预约挂号 := 0;
        End;
      
        --恢复以前的挂号汇总
        Update 病人挂号汇总
        Set 已挂数 = Nvl(已挂数, 0) - 1, 其中已接收 = Nvl(其中已接收, 0) - v_预约挂号, 已约数 = Nvl(已约数, 0) - v_预约挂号
        Where 日期 = Trunc(r_Bill.发生时间) And Nvl(科室id, 0) = Nvl(r_Bill.执行部门id, 0) And Nvl(项目id, 0) = Nvl(r_Bill.收费细目id, 0) And
              (号码 = r_Bill.计算单位 Or 号码 Is Null);
        If Sql%RowCount = 0 Then
          Insert Into 病人挂号汇总
            (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已挂数, 已约数, 其中已接收)
          Values
            (Trunc(r_Bill.发生时间), r_Bill.执行部门id, r_Bill.收费细目id, 原医生_In, Decode(原医生id_In, 0, Null, 原医生id_In), r_Bill.计算单位,
             -1, -1 * v_预约挂号, -1 * v_预约挂号);
        End If;
      
        ----然后再更新挂号汇总
        Update 病人挂号汇总
        Set 已挂数 = Nvl(已挂数, 0) + 1, 其中已接收 = Nvl(其中已接收, 0) + v_预约挂号, 已约数 = Nvl(已约数, 0) + v_预约挂号
        Where 日期 = Trunc(r_Bill.发生时间) And Nvl(科室id, 0) = 科室id_In And Nvl(项目id, 0) = Nvl(r_Bill.收费细目id, 0) And
              (号码 = 号别_In Or 号码 Is Null);
        If Sql%RowCount = 0 Then
          Insert Into 病人挂号汇总
            (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已挂数, 已约数, 其中已接收)
          Values
            (Trunc(r_Bill.发生时间), 科室id_In, r_Bill.收费细目id, 新医生_In, Decode(新医生id_In, 0, Null, 新医生id_In), 号别_In, 1, v_预约挂号,
             v_预约挂号);
        End If;
      
        --更新序号状态
        Select Count(1)
        Into n_Exists
        From 挂号序号状态
        Where 号码 = 号别_In And Trunc(日期) = Trunc(r_Bill.发生时间) And 序号 = r_Bill.号序 And Nvl(状态,0) <> 0;
      
        If n_Exists = 0 Then
          Update 挂号序号状态
          Set 号码 = 号别_In
          Where Trunc(日期) = Trunc(r_Bill.发生时间) And 号码 = r_Bill.计算单位 And 序号 = r_Bill.号序;
        Else
          Delete From 挂号序号状态
          Where Trunc(日期) = Trunc(r_Bill.发生时间) And 号码 = r_Bill.计算单位 And 序号 = r_Bill.号序;
          Update 病人挂号记录 Set 号序 = Null Where NO = r_Bill.No;
        End If;
      
      End If;
    
      ---更新挂号记录
      Update 门诊费用记录
      Set 执行部门id = 科室id_In, 病人科室id = 科室id_In, 计算单位 = 号别_In, 发药窗口 = 诊室_In,
          --病人病区id = 科室id_In,
          执行人 = 新医生_In, 执行状态 = 0, 执行时间 = Null
      Where ID = r_Bill.Id;
    
      --更新病人挂号记录
      If r_Bill.序号 = 1 Then
        v_Temp := Zl_Identity(1);
        Select Substr(v_Temp, Instr(v_Temp, ',') + 1) Into v_Temp From Dual;
        Select Substr(v_Temp, 0, Instr(v_Temp, ',') - 1) Into v_操作员编号 From Dual;
        Select Substr(v_Temp, Instr(v_Temp, ',') + 1) Into v_操作员姓名 From Dual;
        Begin
          Select ID Into n_医生id From 人员表 Where 姓名 = 新医生_In And Rownum < 2;
        Exception
          When Others Then
            n_医生id := Null;
        End;
        Zl_就诊变动记录_Insert(r_Bill.No, 2, '分诊换号', v_操作员姓名, v_操作员编号, 号别_In, 科室id_In, Null, n_医生id, 新医生_In, 诊室_In, n_号序,
                         Null);
        v_挂号生成队列     := Zl_To_Number(zl_GetSysParameter('排队叫号模式', 1113));
        n_分诊台签到排队   := Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113));
        n_再次签到重新排队 := Zl_To_Number(zl_GetSysParameter('再次签到需重新排队', 1113));
      
        Select ID, 号别, Nvl(号序, 0)
        Into n_业务id, v_号别, n_号序
        From 病人挂号记录
        Where NO = r_Bill.No And Rownum = 1;
      
        If v_挂号生成队列 <> 0 Then
          If Nvl(n_分诊台签到排队, 0) = 1 Then
            Select 队列名称 Into v_队列名称 From 排队叫号队列 Where 业务id = n_业务id;
            If Nvl(v_队列名称, 0) <> 0 And Nvl(n_再次签到重新排队, 0) = 1 Then
              --删除原来排队记录重新排队：队列名称_IN，业务ID_IN
              Zl_排队叫号队列_Delete(v_队列名称, n_业务id);
            Else
              Update 排队叫号队列 Set 排队状态 = 2 Where 业务id = n_业务id And 业务类型 = 0;
            End If;
            Update 病人挂号记录 Set 记录标志 = 0 Where ID = n_业务id;
          Else
            v_现队列名称 := 科室id_In;
            --Zlgetnextqueue(执行部门id_In Number,业务id_In     Number := Null)
            v_排队号码 := Zlgetnextqueue(科室id_In, n_业务id, v_号别 || '|' || n_号序);
            v_排队序号 := Zlgetsequencenum(0, n_业务id, 1);
            d_排队时间 := Zl_Get_Requeuedate(3, n_业务id, 科室id_In, 新医生_In, 诊室_In);
            --新队列名称_IN, 业务类型_In, 业务id_In , 科室id_In , 患者姓名_In , 诊室_In , 医生姓名_In
            Zl_排队叫号队列_Update(v_现队列名称, 0, n_业务id, 科室id_In, r_Bill.姓名, 诊室_In, 新医生_In, v_排队号码, v_排队序号, d_排队时间);
            --换号后更新队列信息，排队状态也更新为排队中
            Update 排队叫号队列 Set 排队状态 = 0 Where 业务id = n_业务id And 业务类型 = 0;
          End If;
        End If;
        --删除转诊信息
        Update 病人挂号记录
        Set 执行部门id = 科室id_In, 号别 = 号别_In, 诊室 = 诊室_In, 执行人 = 新医生_In, 执行状态 = 0, 执行时间 = Null, 转诊号别 = Null, 转诊科室id = Null,
            转诊诊室 = Null, 转诊医生 = Null, 转诊状态 = Null
        Where NO = r_Bill.No;
      End If;
    End Loop;
  Else
    --出诊表排班模式
    Begin
      Select 病人id, 出诊记录id
      Into v_病人id, n_原出诊记录id
      From 病人挂号记录
      Where NO = No_In And 记录性质 = 1 And 记录状态 = 1;
      Select ID Into n_诊室id From 门诊诊室 Where 名称 = 诊室_In;
    Exception
      When Others Then
        Null;
    End;
    If v_病人id = 0 Then
      v_Error := '没有找到病人的挂号信息。';
      Raise Err_Custom;
    Elsif v_病人id Is Null Then
      v_Error := '没有找到病人信息。';
      Raise Err_Custom;
    End If;
  
    ---先更新病人信息的就诊诊室和状态
    Update 病人信息 Set 就诊诊室 = 诊室_In, 就诊状态 = 1 Where 病人id = v_病人id And 就诊状态 In (1, 2);
  
    For r_Bill In c_Bill Loop
      If r_Bill.序号 = 1 Then
      
        --需要确定是否预约挂号
        --1.如果是退预约挂号产生的挂号记录,则需要减已挂数和其中已接数
        --2.如果是正常挂号,则只减已挂数
        Begin
          Select Decode(预约, Null, 0, 0, 0, 1) Into v_预约挂号 From 病人挂号记录 Where NO = r_Bill.No And Rownum = 1;
        Exception
          When Others Then
            v_预约挂号 := 0;
        End;
      
        --恢复以前的挂号汇总
        Update 病人挂号汇总
        Set 已挂数 = Nvl(已挂数, 0) - 1, 其中已接收 = Nvl(其中已接收, 0) - v_预约挂号, 已约数 = Nvl(已约数, 0) - v_预约挂号
        Where 日期 = Trunc(r_Bill.发生时间) And Nvl(医生id, 0) = Nvl(原医生id_In, 0) And Nvl(医生姓名, '-') = Nvl(原医生_In, '-') And
              Nvl(科室id, 0) = Nvl(r_Bill.执行部门id, 0) And Nvl(项目id, 0) = Nvl(r_Bill.收费细目id, 0) And
              (号码 = r_Bill.计算单位 Or 号码 Is Null);
        If Sql%RowCount = 0 Then
          Insert Into 病人挂号汇总
            (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已挂数, 已约数, 其中已接收)
          Values
            (Trunc(r_Bill.发生时间), r_Bill.执行部门id, r_Bill.收费细目id, 原医生_In, Decode(原医生id_In, 0, Null, 原医生id_In), r_Bill.计算单位,
             -1, -1 * v_预约挂号, -1 * v_预约挂号);
        End If;
        Update 临床出诊记录
        Set 已挂数 = Nvl(已挂数, 0) - 1, 其中已接收 = Nvl(其中已接收, 0) - v_预约挂号, 已约数 = Nvl(已约数, 0) - v_预约挂号
        Where ID = n_原出诊记录id;
      
        ----然后再更新挂号汇总
        Update 病人挂号汇总
        Set 已挂数 = Nvl(已挂数, 0) + 1, 其中已接收 = Nvl(其中已接收, 0) + v_预约挂号, 已约数 = Nvl(已约数, 0) + v_预约挂号
        Where 日期 = Trunc(r_Bill.发生时间) And Nvl(科室id, 0) = 科室id_In And Nvl(项目id, 0) = Nvl(r_Bill.收费细目id, 0) And
              (号码 = 号别_In Or 号码 Is Null);
        If Sql%RowCount = 0 Then
          Insert Into 病人挂号汇总
            (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已挂数, 已约数, 其中已接收)
          Values
            (Trunc(r_Bill.发生时间), 科室id_In, r_Bill.收费细目id, 新医生_In, Decode(新医生id_In, 0, Null, 新医生id_In), 号别_In, 1, v_预约挂号,
             v_预约挂号);
        End If;
        Update 临床出诊记录
        Set 已挂数 = Nvl(已挂数, 0) + 1, 其中已接收 = Nvl(其中已接收, 0) + v_预约挂号, 已约数 = Nvl(已约数, 0) + v_预约挂号
        Where ID = 出诊记录id_In;
      
        --更新序号控制
        Select Max(序号), Max(预约顺序号), Max(挂号状态), Max(操作员姓名)
        Into n_原序号, n_原预约顺序号, n_原挂号状态, v_原操作员
        From 临床出诊序号控制
        Where 记录id = n_原出诊记录id And (序号 = r_Bill.号序 Or 备注 = To_Char(r_Bill.号序));
      
        If n_原序号 Is Not Null Then
          Select Count(1)
          Into n_Exists
          From 临床出诊序号控制
          Where 记录id = 出诊记录id_In And 序号 = n_原序号 And Nvl(预约顺序号, 0) = Nvl(n_原预约顺序号, 0) And Nvl(挂号状态, 0) = 0;
          If n_Exists = 1 Then
            Update 临床出诊序号控制
            Set 挂号状态 = n_原挂号状态, 操作员姓名 = v_原操作员
            Where 记录id = 出诊记录id_In And 序号 = n_原序号 And Nvl(预约顺序号, 0) = Nvl(n_原预约顺序号, 0) And Nvl(挂号状态, 0) = 0;
          Else
            Update 病人挂号记录 Set 号序 = Null Where NO = r_Bill.No;
          End If;
          Update 临床出诊序号控制
          Set 挂号状态 = 0, 操作员姓名 = Null
          Where 记录id = n_原出诊记录id And 序号 = n_原序号 And Nvl(预约顺序号, 0) = Nvl(n_原预约顺序号, 0);
        End If;
      End If;
    
      ---更新挂号记录
      Update 门诊费用记录
      Set 执行部门id = 科室id_In, 病人科室id = 科室id_In, 计算单位 = 号别_In, 发药窗口 = 诊室_In,
          --病人病区id = 科室id_In,
          执行人 = 新医生_In, 执行状态 = 0, 执行时间 = Null
      Where ID = r_Bill.Id;
    
      --更新病人挂号记录
      If r_Bill.序号 = 1 Then
        v_Temp := Zl_Identity(1);
        Select Substr(v_Temp, Instr(v_Temp, ',') + 1) Into v_Temp From Dual;
        Select Substr(v_Temp, 0, Instr(v_Temp, ',') - 1) Into v_操作员编号 From Dual;
        Select Substr(v_Temp, Instr(v_Temp, ',') + 1) Into v_操作员姓名 From Dual;
        Begin
          Select ID Into n_医生id From 人员表 Where 姓名 = 新医生_In And Rownum < 2;
        Exception
          When Others Then
            n_医生id := Null;
        End;
        Zl_就诊变动记录_Insert(r_Bill.No, 2, '分诊换号', v_操作员姓名, v_操作员编号, 号别_In, 科室id_In, Null, n_医生id, 新医生_In, 诊室_In, n_号序,
                         Null);
        v_挂号生成队列     := Zl_To_Number(zl_GetSysParameter('排队叫号模式', 1113));
        n_分诊台签到排队   := Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113));
        n_再次签到重新排队 := Zl_To_Number(zl_GetSysParameter('再次签到需重新排队', 1113));
        Select ID, 号别, Nvl(号序, 0)
        Into n_业务id, v_号别, n_号序
        From 病人挂号记录
        Where NO = r_Bill.No And Rownum = 1;
        If v_挂号生成队列 <> 0 Then
          If Nvl(n_分诊台签到排队, 0) = 1 Then
            Select 队列名称 Into v_队列名称 From 排队叫号队列 Where 业务id = n_业务id;
            If Nvl(v_队列名称, 0) <> 0 And Nvl(n_再次签到重新排队, 0) = 1 Then
              --删除原来排队记录重新排队：队列名称_IN，业务ID_IN
              Zl_排队叫号队列_Delete(v_队列名称, n_业务id);
            Else
              Update 排队叫号队列 Set 排队状态 = 2 Where 业务id = n_业务id And 业务类型 = 0;
            End If;
            Update 病人挂号记录 Set 记录标志 = 0 Where ID = n_业务id;
          Else
            v_现队列名称 := 科室id_In;
            --Zlgetnextqueue(执行部门id_In Number,业务id_In     Number := Null)
            v_排队号码 := Zlgetnextqueue(科室id_In, n_业务id, v_号别 || '|' || n_号序);
            v_排队序号 := Zlgetsequencenum(0, n_业务id, 1);
            d_排队时间 := Zl_Get_Requeuedate(3, n_业务id, 科室id_In, 新医生_In, 诊室_In);
            --新队列名称_IN, 业务类型_In, 业务id_In , 科室id_In , 患者姓名_In , 诊室_In , 医生姓名_In
            Zl_排队叫号队列_Update(v_现队列名称, 0, n_业务id, 科室id_In, r_Bill.姓名, 诊室_In, 新医生_In, v_排队号码, v_排队序号, d_排队时间);
            --换号后更新队列信息，排队状态也更新为排队中
            Update 排队叫号队列 Set 排队状态 = 0 Where 业务id = n_业务id And 业务类型 = 0;
          End If;
        End If;
        Update 病人挂号记录
        Set 执行部门id = 科室id_In, 号别 = 号别_In, 诊室 = 诊室_In, 执行人 = 新医生_In, 执行状态 = 0, 执行时间 = Null, 出诊记录id = 出诊记录id_In,
            转诊号别 = Null, 转诊科室id = Null, 转诊诊室 = Null, 转诊医生 = Null, 转诊状态 = Null
        Where NO = r_Bill.No;
      End If;
    End Loop;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人挂号记录_换号;
/

--108251:刘尔旋,2017-04-27,产生划价单的挂号单处理
--102751:刘尔旋,2017-04-11,病人挂号记录对应收费单
--105554:刘尔旋,2017-03-10,产生划价单的挂号单据正常显示金额
Create Or Replace Procedure Zl_Third_Getvisitinfo
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:根据挂号单号获取该次就诊详情(医嘱为主要显示)
  --入参:Xml_In:
  --<IN>
  --    <GHDH>挂号单号</GHDH>
  --    <JSKLB>结算卡类别</JSKLB>
  --    <MXGL>明细过滤</MXGL> 0-不过滤,明细包含治疗 1-过滤,明细不包含治疗,默认为1
  --</IN>
  --出参:Xml_Out
  --<OUTPUT>
  --  <GH>
  --     <GHDH>挂号单号</GHDH> //本次查询的挂号单号
  --     <YYSJ>预约时间</YYSJ> //yyyy-mm-dd hh24:mi:ss
  --     <JZSJ></JZSJ>      //实际就诊时间
  --     <DJH></DJH>        //单据号
  --     <JE></JE>          //金额
  --     <DJLX></DJLX>      //单据类型,1-收费单，4-挂号单
  --     <KDSJ></KDSJ>      //开单时间
  --     <JKFS></JKFS>      //缴款方式,0-挂号或预约缴款;1-预约不缴款
  --     <ZFZT></ZFZT>  //支付状态,0-待支付，1-已支付，2-已退费
  --     <SFJSK></SFJSK>    //是否结算卡支付，0-否，1-是
  --  </GH>
  --  <YZLIST>
  --     <YZ>                   //医嘱返回与HIS中显示的内容相同
  --        <YZID><YZID>        //医嘱ID，返回组医嘱ID
  --        <YZLX><YZLX>        //医嘱类型,如处方、检查、检验
  --         <YZMC></YZMC>        //医嘱名称
  --        <ZXKS></ZXKS>       //执行科室
  --        <ZXKSID></ZXKSID>   //执行科室ID
  --        <FYCK></FYCK>       //发药窗口
  --        <YZMX>
  --           <MX>
  --              <YZNR></YZNR>        //医嘱内容
  --              <ZXZT></ZXZT>        //医嘱执行状态
  --              <SFFY>是否发药</SFFY> // 0-否 ，1-是
  --              <GG>规格</GG>
  --              <SL>数量</SL>
  --              <DW>计算单位</DW>
  --              <BZDJ>标准单价</BZDJ>
  --              <YSJE>应收金额</YSJE>
  --              <SSJE>实收金额</SSJE>
  --           </MX>
  --           <MX/>
  --        </YZMX>
  --        <BG></BG>                   //是否已出报告，是否签名
  --        <BGLY></BGLY>               //是否外检项目,1-院内项目，2-外检项目
  --        <BGLYSM></BGLYSM>           //外检项目说明
  --        <JZBG></JZBG>                //禁止显示报告。0-允许，1-禁止
  --        <JZTS></JZTS>                 //提示文字。对于禁止查看的报告，可返回用于提示病人的信息
  --        <BLID></BLID>              //病历ID，如果<BG>字段为1，该值不为空
  --        <DJLIST>
  --           <DJ>                //费用单据信息
  --              <DJH></DJH>      //费用单据号
  --              <DJLX></DJLX>    //单据类型
  --              <JE></JE>        //单据总金额
  --              <KDSJ></KDSJ>    //开单时间
  --              <ZFZT></ZFZT>    //支付状态,0-待支付，1-已支付，2-已退费,3-退费申请中,4-审核通过,5-审核未通过
  --              <SHSM></SHSM>    //审核说明,审核未通过原因
  --              <SFJSK></SFJSK>  //是否结算卡支付，0-否，1-是
  --           </DJ>
  --           <DJ/>
  --        </DJLIST>
  --     </YZ>
  --  </YZLIST>
  --    <ERROR><MSG></MSG></ERROR>                      //如果错误返回
  --</OUTPUT>

  --------------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(200);
  Err_Item Exception;
  x_Templet Xmltype; --模板XML

  v_卡类别   Varchar2(100);
  n_卡类别id Number(18);
  v_挂号单   Varchar2(10);
  v_排队号码 Varchar2(10);
  n_Temp     Number(18);
  v_队列名称 排队叫号队列.队列名称%Type;

  n_Count Number(18);

  v_Temp       Varchar2(32767); --临时XML
  v_队列       Varchar2(32767);
  v_No         Varchar2(50);
  n_Add_Djlist Number(1); --是否增加了DJLIST的
  n_性质       Number(2);
  n_组医嘱id   Number(18);
  n_独立医嘱   Number(8);
  n_执行科室id Number(18);
  v_执行科室   Varchar2(50);
  n_退款金额   病人预交记录.冲预交%Type;
  n_明细过滤   Number(3);
  n_退费状态   病人退费申请.状态%Type;
  v_申请原因   病人退费申请.申请原因%Type;
  v_审核原因   病人退费申请.审核原因%Type;
  v_发药窗口   门诊费用记录.发药窗口%Type;

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/GHDH'), Extractvalue(Value(A), 'IN/JSKLB'), Extractvalue(Value(A), 'IN/MXGL')
  Into v_挂号单, v_卡类别, n_明细过滤
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If v_挂号单 Is Null Then
    v_Err_Msg := '不能找到指定的挂号单号(当前挂号单号为空)';
    Raise Err_Item;
  End If;
  If n_明细过滤 Is Null Then
    n_明细过滤 := 1;
  End If;
  n_Add_Djlist := 0;

  v_Err_Msg := Null;
  If v_卡类别 Is Not Null Then
    Begin
      n_卡类别id := To_Number(v_卡类别);
    Exception
      When Others Then
        n_卡类别id := 0;
    End;
  
    If n_卡类别id = 0 Then
      Begin
        Select ID, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!')
        Into n_卡类别id, v_Err_Msg
        From 医疗卡类别
        Where 名称 = v_卡类别;
      Exception
        When Others Then
          v_Err_Msg := '卡类别:' || v_卡类别 || '不存在!';
      End;
    
    Else
    
      Begin
        Select ID, Decode(Nvl(是否启用, 0), 1, Null, 名称 || '未启用,不允许进行缴费!')
        Into n_卡类别id, v_Err_Msg
        From 医疗卡类别
        Where ID = n_卡类别id;
      Exception
        When Others Then
          v_Err_Msg := '未找到指定的结算支付信息!';
      End;
    
    End If;
    If Not v_Err_Msg Is Null Then
      Raise Err_Item;
    End If;
  End If;
  n_性质 := 4;
  --1.获取挂号数据
  Begin
    Select 收费单 Into v_No From 病人挂号记录 Where NO = v_挂号单;
  Exception
    When Others Then
      v_No := Null;
  End;

  If v_No Is Not Null Then
    Select Count(*) Into n_Count From 门诊费用记录 Where NO = v_No And 记录性质 = 1;
    If n_Count <> 0 Then
      n_性质 := 1;
    End If;
  End If;
  If n_性质 = 4 Then
    v_No := v_挂号单;
  End If;

  n_Count := 0;
  For c_挂号 In (Select a.Id, v_No As NO, n_性质 As 记录性质, a.执行部门id, c.名称 As 执行部门,
                      To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 登记时间, To_Char(a.预约时间, 'yyyy-mm-dd hh24:mi:ss') As 预约时间,
                      a.接收时间, To_Char(a.发生时间, 'yyyy-mm-dd HH24:mi:ss') As 就诊时间, a.号别, a.号序, b.金额, a.记录状态,
                      Decode(Nvl(a.执行状态, 0), 0, '等待接诊', 1, '完成就诊', 2, '正在就诊', -1, '取消就诊') As 执行状态,
                      Decode(Nvl(b.结帐id, 0), 0, 0, 1) As 支付标志, Decode(Nvl(a.记录性质, 0), 2, 1, 0) As 缴款方式, b.结帐id As 结帐id
               From 病人挂号记录 A,
                    (Select Max(Decode(记录状态, 0, 0, 2, 0, Nvl(结帐id, 0))) As 结帐id, Sum(实收金额) As 金额
                      From 门诊费用记录 B
                      Where 记录性质 = n_性质 And NO = v_No) B, 部门表 C
               Where a.No = v_挂号单 And a.执行部门id = c.Id(+)) Loop
  
    If Nvl(c_挂号.记录状态, 0) <> 1 Then
      v_Err_Msg := '单据号:' || v_挂号单 || '已经被退号!';
      Raise Err_Item;
    End If;
  
    Begin
      Select 排队号码, 队列名称
      Into v_排队号码, v_队列名称
      From 排队叫号队列
      Where 业务id = c_挂号.Id And Nvl(业务类型, 0) = 0;
    Exception
      When Others Then
        v_排队号码 := Null;
    End;
    If v_排队号码 Is Not Null Then
      --业务id_In ,业务类型_In 排队号码_In Number := Null
      n_Temp := Zl_Getsequencebeforperons(c_挂号.Id, 0, v_排队号码, v_队列名称);
      v_队列 := v_队列 || '<DL><XH>' || v_排队号码 || '</XH><QMRS>' || n_Temp || '</QMRS></DL>';
    End If;
    n_Temp := 0;
    If Nvl(n_卡类别id, 0) <> 0 Then
      Begin
        Select 1
        Into n_Temp
        From 病人预交记录
        Where 结帐id = c_挂号.结帐id And 记录性质 = 4 And 记录状态 In (1, 3) And 卡类别id = n_卡类别id And Rownum < 2;
      Exception
        When Others Then
          Null;
      End;
    End If;
  
    v_Temp := '<GHDH>' || v_挂号单 || '</GHDH>';
    v_Temp := v_Temp || '<DJH>' || c_挂号.No || '</DJH>';
    v_Temp := v_Temp || '<YYSJ>' || c_挂号.预约时间 || '</YYSJ>';
    v_Temp := v_Temp || '<JZSJ>' || c_挂号.就诊时间 || '</JZSJ>';
    v_Temp := v_Temp || '<KDSJ>' || c_挂号.登记时间 || '</KDSJ>';
    v_Temp := v_Temp || '<JKFS>' || c_挂号.缴款方式 || '</JKFS>';
    v_Temp := v_Temp || '<JE>' || c_挂号.金额 || '</JE>';
    v_Temp := v_Temp || '<DJLX>' || n_性质 || '</DJLX>';
    v_Temp := v_Temp || '<ZFZT>' || c_挂号.支付标志 || '</ZFZT>';
    v_Temp := v_Temp || '<SFJSK>' || n_Temp || '</SFJSK>';
    If v_队列 Is Not Null Then
      v_Temp := v_Temp || v_队列;
    End If;
    v_Temp := '<GH>' || v_Temp || '</GH>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
    n_Count := n_Count + 1;
  End Loop;

  If Nvl(n_Count, 0) = 0 Then
    v_Err_Msg := '未找到指定的挂号单据:' || v_挂号单 || '!';
    Raise Err_Item;
  End If;

  --2.组建医嘱及费用相关数据
  n_组医嘱id := 0;

  For c_医嘱 In (With 医嘱费用 As
                  (Select 医嘱id, 发送号, 记录性质, NO, Max(Nvl(执行状态, 0)) As 执行状态
                  From (Select b.医嘱id, b.发送号, b.记录性质, b.No, Nvl(b.执行状态, 0) As 执行状态
                         From 病人医嘱记录 A, 病人医嘱发送 B
                         Where a.挂号单 = v_挂号单 And a.Id = b.医嘱id(+)
                         Union All
                         Select b.医嘱id, b.发送号, b.记录性质, b.No, Nvl(c.执行状态, 0) As 执行状态
                         From 病人医嘱记录 A, 病人医嘱附费 B, 病人医嘱发送 C
                         Where a.挂号单 = v_挂号单 And a.Id = b.医嘱id(+) And b.医嘱id = c.医嘱id(+) And b.发送号 = c.发送号(+))
                  Group By 医嘱id, 发送号, 记录性质, NO)
                 
                 Select Nvl(a.相关id, a.Id) As 组id, Decode(a.相关id, Null, 0, 1) As 附医嘱, a.Id, a.相关id, e.发药窗口,
                        Max(Decode(a.诊疗类别, 'E', Decode(q.操作类型, '2', '处方', '4', '处方', '6', '检验', m.名称), m.名称)) As 医嘱类型,
                        a.执行科室id, d.名称 As 执行科室, Decode(a.相关id, Null, a.医嘱内容, Null) As 组医嘱内容,
                        Max(Decode(a.诊疗类别, '5', 1, '6', 1, '7', 1, 0) * Decode(Nvl(e.执行状态, 0), 1, 1, 3, 1, 0)) As 发药状态,
                        Decode(a.相关id, Null, Null, q.名称) As 明细医嘱内容, s.规格, (e.数次 * e.付数) As 数量, e.计算单位 As 单位,
                        Decode(Nvl(b.执行状态, 0), 0, '未执行', 1, '完全执行', 2, '拒绝执行', 3, '正在执行', '正在执行') As 执行状态,
                        Max(Decode(p.审核时间, Null, Decode(C1.完成时间, Null, 0, 1), 1)) As 是否已出报告, c.病历id, e.No, e.记录性质 As 单据类型,
                        Max(e.标准单价) As 标准单价, Sum(e.应收金额) As 应收金额, Sum(e.实收金额) As 实收金额,
                        To_Char(e.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 开单时间, Decode(Nvl(e.记录状态, 0), 0, 0, 3, 2, 1) As 支付状态,
                        a.病人id
                 
                 From 病人医嘱记录 A, 医嘱费用 B, 病人医嘱报告 C, 电子病历记录 C1, 部门表 D, 门诊费用记录 E, 诊疗项目类别 M, 诊疗项目目录 Q, 收费项目目录 S, 检验标本记录 P
                 Where a.Id = b.医嘱id(+) And a.执行科室id = d.Id(+) And c.病历id = C1.Id(+) And a.Id = c.医嘱id(+) And
                       a.Id = p.医嘱id(+) And b.医嘱id = e.医嘱序号(+) And e.收费细目id = s.Id(+) And b.No = e.No(+) And
                       b.记录性质 = e.记录性质(+) And e.记录状态(+) <> 2 And a.挂号单 = v_挂号单 And a.诊疗类别 = m.编码(+) And
                       a.诊疗项目id = q.Id(+) And a.医嘱状态 In (3, 8)
                 Group By a.Id, a.婴儿, a.序号, a.相关id, e.发药窗口, a.诊疗类别, a.执行科室id, d.名称, a.医嘱内容, q.名称, s.规格, e.数次 * e.付数,
                          e.计算单位, Decode(Nvl(b.执行状态, 0), 0, '未执行', 1, '完全执行', 2, '拒绝执行', 3, '正在执行', '正在执行'), C1.完成时间,
                          Decode(c.病历id, Null, 0, 1), c.病历id, e.No, e.记录性质, e.登记时间, Decode(Nvl(e.记录状态, 0), 0, 0, 3, 2, 1),
                          p.审核时间, a.病人id
                 Order By 组id, 附医嘱, Nvl(a.婴儿, 0), a.序号) Loop
    If Nvl(n_Add_Djlist, 0) = 0 Then
      --增加DJList节点
      Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<YZLIST></YZLIST>')) Into x_Templet From Dual;
      n_Add_Djlist := 1;
    End If;
  
    If n_组医嘱id <> Nvl(c_医嘱.组id, 0) Then
      n_组医嘱id := Nvl(c_医嘱.组id, 0);
    
      Zl_Third_Custom_Getdeptinfo(n_组医嘱id, n_执行科室id, v_执行科室);
    
      If Nvl(n_执行科室id, 0) = 0 Then
        If c_医嘱.医嘱类型 = '检验' Then
          --检验医嘱以显示采集科室
          n_执行科室id := c_医嘱.执行科室id;
          v_执行科室   := c_医嘱.执行科室;
        Else
          Begin
            Select b.Id, b.名称, c.发药窗口
            Into n_执行科室id, v_执行科室, v_发药窗口
            From 病人医嘱记录 A, 部门表 B, 门诊费用记录 C
            Where a.Id = c.医嘱序号 And a.相关id = n_组医嘱id And a.执行科室id = b.Id And Rownum <= 1;
          Exception
            When Others Then
              n_执行科室id := c_医嘱.执行科室id;
              v_执行科室   := c_医嘱.执行科室;
              v_发药窗口   := c_医嘱.发药窗口;
          End;
        End If;
      End If;
    
      v_Temp := '<YZID>' || n_组医嘱id || '</YZID>';
      v_Temp := v_Temp || '<YZLX>' || c_医嘱.医嘱类型 || '</YZLX>';
      v_Temp := v_Temp || '<YZMC>' || c_医嘱.组医嘱内容 || '</YZMC>';
      v_Temp := v_Temp || '<ZXKS>' || v_执行科室 || '</ZXKS>';
      v_Temp := v_Temp || '<ZXKSID>' || n_执行科室id || '</ZXKSID>';
      v_Temp := v_Temp || '<FYCK>' || v_发药窗口 || '</FYCK>';
      v_Temp := v_Temp || '<BG>' || c_医嘱.是否已出报告 || '</BG>';
      v_Temp := v_Temp || Zl_Third_Custom_Getrptfrom(n_组医嘱id);
      v_Temp := v_Temp || Zl_Third_Custom_Rptlimit(c_医嘱.病人id, n_组医嘱id);
      If Nvl(c_医嘱.是否已出报告, 0) = 1 And c_医嘱.病历id Is Not Null Then
        v_Temp := v_Temp || '<BLID>' || c_医嘱.病历id || '</BLID>';
      End If;
      v_Temp := '<YZ 医嘱ID="' || n_组医嘱id || '">' || v_Temp || '<YZMX></YZMX><DJLIST></DJLIST></YZ>';
      Select Appendchildxml(x_Templet, '/OUTPUT/YZLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
    
      For v_费用 In (
                   
                   Select a.No, Mod(a.记录性质, 10) As 单据类型, To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss') As 开单时间,
                           Max(Decode(Nvl(a.记录状态, 0), 0, 0, 3, 2, 1)) As 支付状态, Sum(a.实收金额) As 单据金额, Max(a.结帐id) As 结算卡支付
                   From 门诊费用记录 A
                   Where (a.No, a.记录性质) In
                         (Select Distinct q.No, q.记录性质
                          From 病人医嘱记录 M, 病人医嘱发送 Q
                          Where m.Id = q.医嘱id(+) And (m.Id = n_组医嘱id Or m.相关id = n_组医嘱id)
                          Union All
                          Select Distinct q.No, q.记录性质
                          From 病人医嘱记录 M, 病人医嘱附费 Q
                          Where m.Id = q.医嘱id(+) And (m.Id = n_组医嘱id Or m.相关id = n_组医嘱id)) And
                         Nvl(a.记录状态, 0) In (0, 1, 3)
                   Group By a.No, Mod(a.记录性质, 10), To_Char(a.登记时间, 'yyyy-mm-dd hh24:mi:ss')) Loop
        Begin
          Select 1
          Into n_Temp
          From 病人预交记录 A, 门诊费用记录 B
          Where a.结帐id = b.结帐id And b.No = v_费用.No And Mod(b.记录性质, 10) = 1 And b.记录状态 In (1, 3) And a.卡类别id = n_卡类别id And
                Rownum < 2;
        Exception
          When Others Then
            n_Temp := 0;
        End;
        Begin
          Select -1 * Sum(结帐金额)
          Into n_退款金额
          From 门诊费用记录 B
          Where b.No = v_费用.No And Mod(b.记录性质, 10) = 1 And b.记录状态 = 2;
        Exception
          When Others Then
            n_退款金额 := 0;
        End;
        Begin
          Select 状态, 申请原因, 审核原因
          Into n_退费状态, v_申请原因, v_审核原因
          From 病人退费申请
          Where NO = v_费用.No And Mod(记录性质, 10) = Mod(v_费用.单据类型, 10);
        Exception
          When Others Then
            n_退费状态 := -1;
            v_申请原因 := '';
            v_审核原因 := '';
        End;
      
        v_Temp := '<DJH>' || v_费用.No || '</DJH>';
        v_Temp := v_Temp || '<DJLX>' || v_费用.单据类型 || '</DJLX>';
        v_Temp := v_Temp || '<JE>' || v_费用.单据金额 || '</JE>';
        v_Temp := v_Temp || '<KDSJ>' || v_费用.开单时间 || '</KDSJ>';
        If n_退费状态 = -1 Then
          v_Temp := v_Temp || '<ZFZT>' || v_费用.支付状态 || '</ZFZT>';
        Else
          If n_退费状态 = 0 Then
            v_Temp := v_Temp || '<ZFZT>3</ZFZT>';
          End If;
          If n_退费状态 = 1 Then
            If v_费用.支付状态 = 2 Then
              v_Temp := v_Temp || '<ZFZT>2</ZFZT>';
            Else
              v_Temp := v_Temp || '<ZFZT>4</ZFZT>';
            End If;
          End If;
          If n_退费状态 = 2 Then
            v_Temp := v_Temp || '<ZFZT>5</ZFZT>';
          End If;
        End If;
      
        If n_退费状态 = -1 Then
          v_Temp := v_Temp || '<SHSM>' || '' || '</SHSM>';
        Else
          If n_退费状态 = 0 Then
            v_Temp := v_Temp || '<SHSM>' || v_申请原因 || '</SHSM>';
          End If;
          If n_退费状态 = 1 Then
            v_Temp := v_Temp || '<SHSM>' || v_审核原因 || '</SHSM>';
          End If;
          If n_退费状态 = 2 Then
            v_Temp := v_Temp || '<SHSM>' || v_审核原因 || '</SHSM>';
          End If;
        End If;
      
        v_Temp := v_Temp || '<YTJE>' || Nvl(n_退款金额, 0) || '</YTJE>';
        v_Temp := v_Temp || '<SFJSK>' || n_Temp || '</SFJSK>';
        v_Temp := '<DJ>' || v_Temp || '</DJ>';
        Select Appendchildxml(x_Templet, '/OUTPUT/YZLIST/YZ[@医嘱ID="' || n_组医嘱id || '"]/DJLIST', Xmltype(v_Temp))
        Into x_Templet
        From Dual;
      End Loop;
    End If;
  
    --只有一条记录的医嘱，在明细中增加该条医嘱，以获取执行状态
    Select Decode(Count(*), 0, 1, 0) Into n_独立医嘱 From 病人医嘱记录 Where 相关id = n_组医嘱id;
    If n_独立医嘱 = 1 Then
      v_Temp := '<YZNR>' || c_医嘱.组医嘱内容 || '</YZNR>';
      v_Temp := v_Temp || '<GG>' || c_医嘱.规格 || '</GG>';
      v_Temp := v_Temp || '<SFFY>' || c_医嘱.发药状态 || '</SFFY>';
      v_Temp := v_Temp || '<SL>' || c_医嘱.数量 || '</SL>';
      v_Temp := v_Temp || '<DW>' || c_医嘱.单位 || '</DW>';
      v_Temp := v_Temp || '<BZDJ>' || Nvl(c_医嘱.标准单价, 0) || '</BZDJ>';
      v_Temp := v_Temp || '<YSJE>' || Nvl(c_医嘱.应收金额, 0) || '</YSJE>';
      v_Temp := v_Temp || '<SSJE>' || Nvl(c_医嘱.实收金额, 0) || '</SSJE>';
      v_Temp := v_Temp || '<ZXZT>' || c_医嘱.执行状态 || '</ZXZT>';
      v_Temp := '<MX>' || v_Temp || '</MX>';
      Select Appendchildxml(x_Templet, '/OUTPUT/YZLIST/YZ[@医嘱ID="' || n_组医嘱id || '"]/YZMX', Xmltype(v_Temp))
      Into x_Templet
      From Dual;
    End If;
  
    If Nvl(c_医嘱.附医嘱, 0) = 1 Then
      If n_明细过滤 = 0 Or (n_明细过滤 = 1 And c_医嘱.医嘱类型 <> '治疗') Then
        v_Temp := '<YZNR>' || c_医嘱.明细医嘱内容 || '</YZNR>';
        v_Temp := v_Temp || '<GG>' || c_医嘱.规格 || '</GG>';
        v_Temp := v_Temp || '<SL>' || c_医嘱.数量 || '</SL>';
        v_Temp := v_Temp || '<DW>' || c_医嘱.单位 || '</DW>';
        v_Temp := v_Temp || '<SFFY>' || c_医嘱.发药状态 || '</SFFY>';
        v_Temp := v_Temp || '<ZXZT>' || c_医嘱.执行状态 || '</ZXZT>';
        v_Temp := v_Temp || '<BZDJ>' || Nvl(c_医嘱.标准单价, 0) || '</BZDJ>';
        v_Temp := v_Temp || '<YSJE>' || Nvl(c_医嘱.应收金额, 0) || '</YSJE>';
        v_Temp := v_Temp || '<SSJE>' || Nvl(c_医嘱.实收金额, 0) || '</SSJE>';
        v_Temp := '<MX>' || v_Temp || '</MX>';
        Select Appendchildxml(x_Templet, '/OUTPUT/YZLIST/YZ[@医嘱ID="' || n_组医嘱id || '"]/YZMX', Xmltype(v_Temp))
        Into x_Templet
        From Dual;
      End If;
    End If;
  
  End Loop;
  Xml_Out := x_Templet;

Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getvisitinfo;
/

--106912:刘尔旋,2017-03-10,新挂号安排可预约天数调整
Create Or Replace Procedure Zl_Third_Getnolist
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取号源列表(简易模式)
  --入参:Xml_In:
  --<IN>
  --  <RQ>日期</RQ>
  --  <KSID>科室ID</KSID>
  --  <YSID>医生ID</YSID>
  --  <YSXM>医生姓名</YSXM>
  --  <HZDW>支付宝</HZDW>    //合作单位，传入了的时候，只取合作单位的号;为空时，只取非合作单位的号
  --  <SJJG>60</SJJG>     //时间间隔,不传则返回序号时段
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --  <GROUP>
  --    <RQ>日期</RQ>
  --    <HBLIST>
  --     <HB>
  --        <CZJLID>1</CZJLID>     //出诊记录ID
  --        <HM>235</HM>       //号码
  --        <YSID>549</YSID>      //医生ID
  --        <YS>张锐</YS>       //医生姓名
  --        <KSID>123</KSID>   //科室ID
  --        <KSMC>内科</KSMC>   //科室名称
  --        <ZC>主治医师</ZC> //职称
  --        <XMID>10086<XMID> //挂号项目的ID
  --        <XMMC>挂号费</XMMC> //挂号项目的名称
  --        <YGHS>0</YGHS>      //已挂号数
  --        <SYHS>99</SYHS>   //剩余号数
  --        <PRICE>15</PRICE>      //价格
  --        <HL>普通</HL>       //挂号类型
  --        <HCXH>1</HCXH>    //是否存在缓冲序号时间段，1-存在 0或者空-不存在
  --        <FSD>0</FSD>      //是否分时段
  --        <FWMC>白天</FWMC>     //号别时段
  --        <HBTIME>(08:00-17:59)</HBTIME> //可挂时间
  --     <SPANLIST>
  --            <SPAN>
  --                  <SJD></SJD>          //时间段,格式:hh24:mi-hh24:mi
  --                  <GHZS></GHZS>      //时段挂号总数
  --                  <SL></SL>      //剩余数量
  --            </SPAN>
  --            ……
  --          </SPANLIST>
  --      </HB>
  --      <HB>
  --      ……
  --      </HB>
  --    </HBLIST>
  --  </GROUP>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  d_日期         Date;
  n_科室id       病人挂号记录.执行部门id%Type;
  n_医生id       人员表.Id%Type;
  v_医生姓名     人员表.姓名%Type;
  v_星期         挂号安排限制.限制项目%Type;
  v_时间段       Varchar2(100);
  v_合作单位     挂号合作单位.名称%Type;
  n_分时段       Number(3);
  n_单个剩余     Number(5);
  n_已挂数       Number(5);
  n_合约已挂数   Number(5);
  n_合计金额     收费价目.现价%Type;
  n_合约总数量   Number(5);
  n_合约剩余数量 Number(5);
  n_最大可用数量 Number(5);
  n_合约模式     Number(3); --合约模式:1-合约单位限数量模式 0-合约单位指定序号模式
  n_非合约       Number(3);
  n_是否预留     Number(3);
  d_加号时间     Date;
  d_开始时间     临床出诊记录.开始时间%Type;
  d_终止时间     临床出诊记录.终止时间%Type;
  n_缓冲序号     Number(3);
  n_时段数量     Number(5);
  n_序号控制     临床出诊记录.是否序号控制%Type;
  n_预留数量     Number(5);
  n_特殊预约     Number(3);
  n_禁用         Number(3);
  v_剩余数量     Varchar2(100);
  v_Timetemp     Varchar2(100);
  v_Temp         Varchar2(32767); --临时XML
  v_Xmlmain      Clob; --临时XML
  c_Xmlmain      Clob; --临时XML
  x_Templet      Xmltype; --模板XML
  v_Err_Msg      Varchar2(200);
  n_Exists       Number(5);
  n_时段已挂     Number(5);
  n_挂号模式     Number(3);
  v_挂号模式     Varchar2(500);
  v_启用时间     Varchar2(500);
  n_时间间隔     Number(5);
  n_预约天数     Number(5);
  n_补充天数     Number(5);
  d_时段开始     Date;
  d_时段结束     Date;
  n_时段总数     Number(5);
  n_时段剩余     Number(5);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select To_Date(Extractvalue(Value(A), 'IN/RQ'), 'YYYY-MM-DD hh24:mi:ss'), Extractvalue(Value(A), 'IN/KSID'),
         Extractvalue(Value(A), 'IN/YSID'), Extractvalue(Value(A), 'IN/YSXM'), Extractvalue(Value(A), 'IN/HZDW'),
         Extractvalue(Value(A), 'IN/SJJG')
  Into d_日期, n_科室id, n_医生id, v_医生姓名, v_合作单位, n_时间间隔
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  v_挂号模式 := zl_GetSysParameter('挂号排班模式');
  n_挂号模式 := To_Number(Substr(v_挂号模式, 1, 1));
  If n_挂号模式 = 1 Then
    Begin
      v_启用时间 := Substr(v_挂号模式, 3);
    Exception
      When Others Then
        v_启用时间 := Null;
    End;
  End If;
  --日期节点为空的情况
  If d_日期 Is Null Then
    d_日期 := Trunc(Sysdate);
  End If;
  n_预约天数 := Nvl(zl_GetSysParameter(66), 7);
  If d_日期 < To_Date(v_启用时间, 'yyyy-mm-dd hh24:mi:ss') And n_挂号模式 = 1 Then
    n_挂号模式 := 0;
  End If;

  If n_挂号模式 = 0 Then
    Select Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7', '周六', Null)
    Into v_星期
    From Dual;
    n_合约剩余数量 := 0;
  
    For r_No In (Select a.科室id, a.号类, a.科室名称, a.医生姓名, a.医生id, a.职称, a.号码, a.安排id, a.计划id, a.排班, a.项目id, a.项目名称, a.序号控制,
                        a.限号数, a.限约数, a.预约天数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数, Nvl(Hz.其中已接收, 0) As 已接收,
                        Sum(b.现价) As 价格
                 From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称, Ap.号码,
                               Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数, Ap.预约天数
                        From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                      Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                      Decode(To_Char(d_日期, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4', Ap.周三, '5', Ap.周四,
                                              '6', Ap.周五, '7', Ap.周六, Null) As 排班, Xz.限约数, Xz.限号数,
                                      Nvl(Ap.预约天数, n_预约天数) As 预约天数
                               From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                               Where Ap.科室id = Bm.Id(+) And Decode(Nvl(n_科室id, 0), 0, 0, Ap.科室id) = Nvl(n_科室id, 0) And
                                     Decode(Nvl(n_医生id, 0), 0, 0, Ap.医生id) = Nvl(n_医生id, 0) And
                                     Decode(Nvl(v_医生姓名, '-'), '-', '-', Ap.医生姓名) = Nvl(v_医生姓名, '-') And Ap.停用日期 Is Null And
                                     d_日期 Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                     Nvl(Ap.终止时间, To_Date('3000 - 01 - 01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                     Xz.限制项目(+) = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                         '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                (Select Rownum
                                      From 挂号安排停用状态 Ty
                                      Where Ty.安排id = Ap.Id And d_日期 Between Ty.开始停止时间 And Ty.结束停止时间) And Not Exists
                                (Select Rownum
                                      From 挂号安排计划 Jh
                                      Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                            d_日期 Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                            Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')))
                               Union All
                               Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id, Jh.Id As 计划id,
                                      Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                      Decode(To_Char(d_日期, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4', Jh.周三, '5', Jh.周四,
                                              '6', Jh.周五, '7', Jh.周六, Null) As 排班, Xz.限约数, Xz.限号数,
                                      Nvl(Ap.预约天数, n_预约天数) As 预约天数
                               From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                               Where Jh.安排id = Ap.Id And Ap.科室id = Bm.Id(+) And Ap.停用日期 Is Null And
                                     Decode(Nvl(n_科室id, 0), 0, 0, Ap.科室id) = Nvl(n_科室id, 0) And
                                     Decode(Nvl(n_医生id, 0), 0, 0, Jh.医生id) = Nvl(n_医生id, 0) And
                                     Decode(Nvl(v_医生姓名, '-'), '-', '-', Jh.医生姓名) = Nvl(v_医生姓名, '-') And
                                     d_日期 Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                     Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.计划id(+) = Jh.Id And
                                     Xz.限制项目(+) = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                         '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                (Select Rownum
                                      From 挂号安排停用状态 Ty
                                      Where Ty.安排id = Ap.Id And d_日期 Between Ty.开始停止时间 And Ty.结束停止时间) And
                                     (Jh.生效时间, Jh.安排id) =
                                     (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                      From 挂号安排计划 Sxjh
                                      Where Sxjh.审核时间 Is Not Null And
                                            d_日期 Between Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                            Nvl(Sxjh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Sxjh.安排id = Jh.安排id
                                      Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                        Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                      病人挂号汇总 Hz, 收费价目 B
                 Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_日期) And a.项目id = b.收费细目id And
                       Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-Mm-DD')) > d_日期 And b.执行日期 <= d_日期
                 Group By a.科室id, a.号类, a.科室名称, a.医生姓名, a.医生id, a.职称, a.号码, a.安排id, a.计划id, a.排班, a.项目id, a.项目名称, a.序号控制,
                          a.限号数, a.限约数, a.预约天数, Nvl(Hz.已挂数, 0), Nvl(Hz.已约数, 0), Nvl(Hz.其中已接收, 0)) Loop
      Zl_挂号序号状态_Delete(1, r_No.号码);
      If Sysdate + Nvl(r_No.预约天数, n_预约天数) >= d_日期 Then
        If r_No.计划id <> 0 Then
          Select Sign(Count(Rownum))
          Into n_分时段
          From 挂号安排计划 Jh, 挂号计划时段 Sd
          Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And
                Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7',
                               '周六', Null) And Rownum < 2;
        Else
          Select Sign(Count(Rownum))
          Into n_分时段
          From 挂号安排 Ap, 挂号安排时段 Sd
          Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And
                Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7',
                               '周六', Null) And Rownum < 2;
        End If;
        --分时段不序号控制当天号为普通号
        If Trunc(Sysdate) = Trunc(d_日期) And n_分时段 = 1 And r_No.序号控制 = 0 Then
          n_分时段 := 0;
        End If;
        If n_分时段 = 0 Then
          v_Temp := '';
          If v_合作单位 Is Not Null And r_No.序号控制 = 1 Then
            If r_No.计划id <> 0 Then
              Select Nvl(Sum(数量), 0)
              Into n_合约总数量
              From 合作单位计划控制
              Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
              Select Count(1)
              Into n_合约模式
              From 合作单位计划控制
              Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 序号 = 0;
            Else
              Select Nvl(Sum(数量), 0)
              Into n_合约总数量
              From 合作单位安排控制
              Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
              Select Count(1)
              Into n_合约模式
              From 合作单位安排控制
              Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 序号 = 0;
            End If;
            If n_合约模式 = 0 Then
              If r_No.计划id <> 0 Then
                Select Count(1)
                Into n_合约已挂数
                From 病人挂号记录 A
                Where 号别 = r_No.号码 And 记录状态 = 1 And 发生时间 Between Trunc(d_日期) And Trunc(d_日期 + 1) - 1 / 60 / 60 / 24 And
                      Exists
                 (Select 1
                       From 合作单位计划控制
                       Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And
                             限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                           '周五', '7', '周六', Null) And 序号 = a.号序 And 数量 <> 0);
              Else
                Select Count(1)
                Into n_合约已挂数
                From 病人挂号记录 A
                Where 号别 = r_No.号码 And 记录状态 = 1 And 发生时间 Between Trunc(d_日期) And Trunc(d_日期 + 1) - 1 / 60 / 60 / 24 And
                      Exists
                 (Select 1
                       From 合作单位安排控制
                       Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And
                             限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                           '周五', '7', '周六', Null) And 序号 = a.号序 And 数量 <> 0);
              End If;
            Else
              Select Count(1)
              Into n_合约已挂数
              From 病人挂号记录
              Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                    Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
            End If;
            If n_合约总数量 = 0 Then
              n_合约剩余数量 := 0;
            Else
              n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
              If n_合约剩余数量 > (Nvl(r_No.限号数, 0) - r_No.已挂数) Then
                n_合约剩余数量 := Nvl(r_No.限号数, 0) - r_No.已挂数;
              End If;
            End If;
          End If;
        Else
          v_Temp := '<SPANLIST>';
          If r_No.计划id <> 0 Then
            Select To_Date(To_Char(d_日期, 'yyyy-mm-dd') || To_Char(Max(结束时间), 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
            Into d_加号时间
            From 挂号计划时段
            Where 计划id = r_No.计划id And 星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                   '周四', '6', '周五', '7', '周六', Null);
            If r_No.序号控制 = 1 Then
              If Trunc(d_日期) = Trunc(Sysdate) Then
                n_特殊预约 := 0;
              Else
                Select Nvl(Max(Jh.是否预约), 0)
                Into n_特殊预约
                From (Select Sd.计划id, Sd.序号, Sd.星期, Jh.号码,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                       From 挂号安排计划 Jh, 挂号计划时段 Sd
                       Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And
                             Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                            '周五', '7', '周六', Null)) Jh, 挂号序号状态 Zt
                Where Zt.日期(+) = Jh.开始时间 And Zt.号码(+) = Jh.号码 And Zt.序号(+) = Jh.序号 And
                      Decode(Sign(Sysdate - Jh.开始时间), -1, 0, 1) <> 1;
              End If;
            
              d_时段开始 := Null;
              d_时段结束 := Null;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              For r_Time In (Select Jh.号码, Jh.序号, Jh.星期, Jh.开始时间, Jh.结束时间, Jh.限制数量, Jh.是否预约, 0 As 已约数,
                                    Decode(Nvl(Zt.序号, 0), 0, 1, 0) As 剩余数,
                                    Decode(Sign(Sysdate - Jh.开始时间), -1, 0, 1) As 失效时段
                             From (Select Sd.计划id, Sd.序号, Sd.星期, Jh.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排计划 Jh, 挂号计划时段 Sd
                                    Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Jh.安排id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Jh, 挂号序号状态 Zt
                             Where Zt.日期(+) = Jh.开始时间 And Zt.号码(+) = Jh.号码 And Zt.序号(+) = Jh.序号
                             Order By 序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Select Nvl(Max(1), 0)
                  Into n_合约模式
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = 0 And 合作单位 = v_合作单位;
                Else
                  n_合约模式 := 0;
                End If;
                If r_Time.剩余数 = 0 Then
                  n_单个剩余 := 0;
                Else
                  n_单个剩余 := r_Time.限制数量;
                End If;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                      End If;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位计划控制
                    Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_合约剩余数量 := n_合约剩余数量 + 1;
                      End If;
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            Else
              n_最大可用数量 := Nvl(r_No.限约数, Nvl(r_No.限号数, 0)) - Nvl(r_No.已约数, 0);
              n_时段总数     := 0;
              n_时段剩余     := 0;
              d_时段开始     := Null;
              d_时段结束     := Null;
              For r_Time In (Select Jh.号码, Jh.序号, Jh.星期, Jh.开始时间, Jh.结束时间, Jh.限制数量, Jh.是否预约,
                                    Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 已约数,
                                    Jh.限制数量 - Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 剩余数,
                                    Decode(Sign(Sysdate - Jh.开始时间), -1, 0, 1) As 失效时段
                             From (Select Sd.计划id, Sd.序号, Sd.星期, Jh.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排计划 Jh, 挂号计划时段 Sd
                                    Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Jh.安排id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Jh, 挂号序号状态 Zt
                             Where Jh.号码 = Zt.号码(+) And Jh.开始时间 = Zt.日期(+)
                             Group By Jh.号码, Jh.序号, Jh.星期, Jh.开始时间, Jh.结束时间, Jh.限制数量, Jh.是否预约
                             Order By Jh.序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Select Nvl(Max(1), 0)
                  Into n_合约模式
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = 0 And 合作单位 = v_合作单位;
                Else
                  n_合约模式 := 0;
                End If;
                n_单个剩余 := r_Time.剩余数;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_最大可用数量;
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位计划控制
                    Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_最大可用数量, 0);
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_单个剩余, 0);
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            End If;
          Else
            Select To_Date(To_Char(d_日期, 'yyyy-mm-dd') || To_Char(Max(结束时间), 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
            Into d_加号时间
            From 挂号安排时段
            Where 安排id = r_No.安排id And 星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                   '周四', '6', '周五', '7', '周六', Null);
            If r_No.序号控制 = 1 Then
              If Trunc(d_日期) = Trunc(Sysdate) Then
                n_特殊预约 := 0;
              Else
                Select Nvl(Max(Ap.是否预约), 0)
                Into n_特殊预约
                From (Select Sd.安排id, Sd.序号, Sd.星期, Ap.号码,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                       From 挂号安排 Ap, 挂号安排时段 Sd
                       Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And
                             Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                            '周五', '7', '周六', Null)) Ap, 挂号序号状态 Zt
                Where Zt.日期(+) = Ap.开始时间 And Zt.号码(+) = Ap.号码 And Zt.序号(+) = Ap.序号 And
                      Decode(Sign(Sysdate - Ap.开始时间), -1, 0, 1) <> 1;
              End If;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              For r_Time In (Select Ap.号码, Ap.序号, Ap.星期, Ap.开始时间, Ap.结束时间, Ap.限制数量, Ap.是否预约, 0 As 已约数,
                                    Decode(Nvl(Zt.序号, 0), 0, 1, 0) As 剩余数,
                                    Decode(Sign(Sysdate - Ap.开始时间), -1, 0, 1) As 失效时段
                             
                             From (Select Sd.安排id, Sd.序号, Sd.星期, Ap.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排 Ap, 挂号安排时段 Sd
                                    Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Ap.Id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Ap, 挂号序号状态 Zt
                             Where Zt.日期(+) = Ap.开始时间 And Zt.号码(+) = Ap.号码 And Zt.序号(+) = Ap.序号
                             Order By 序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Begin
                    Select 1
                    Into n_合约模式
                    From 合作单位安排控制
                    Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = 0 And 合作单位 = v_合作单位;
                  Exception
                    When Others Then
                      n_合约模式 := 0;
                  End;
                Else
                  n_合约模式 := 0;
                End If;
                If r_Time.剩余数 = 0 Then
                  n_单个剩余 := 0;
                Else
                  n_单个剩余 := r_Time.限制数量;
                End If;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                      End If;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位安排控制
                    Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_合约剩余数量 := n_合约剩余数量 + n_单个剩余;
                      End If;
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            Else
              n_最大可用数量 := Nvl(r_No.限约数, Nvl(r_No.限号数, 0)) - Nvl(r_No.已约数, 0);
              n_时段总数     := 0;
              n_时段剩余     := 0;
              d_时段开始     := Null;
              d_时段结束     := Null;
              For r_Time In (Select Ap.号码, Ap.序号, Ap.星期, Ap.开始时间, Ap.结束时间, Ap.限制数量, Ap.是否预约,
                                    Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 已约数,
                                    Ap.限制数量 - Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 剩余数,
                                    Decode(Sign(Sysdate - Ap.开始时间), -1, 0, 1) As 失效时段
                             From (Select Sd.安排id, Sd.序号, Sd.星期, Ap.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排 Ap, 挂号安排时段 Sd
                                    Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Ap.Id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Ap, 挂号序号状态 Zt
                             Where Ap.号码 = Zt.号码(+) And Ap.开始时间 = Zt.日期(+)
                             Group By Ap.号码, Ap.序号, Ap.星期, Ap.开始时间, Ap.结束时间, Ap.限制数量, Ap.是否预约
                             Order By Ap.序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Select Nvl(Max(1), 0)
                  Into n_合约模式
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = 0 And 合作单位 = v_合作单位;
                Else
                  n_合约模式 := 0;
                End If;
                n_单个剩余 := r_Time.剩余数;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_最大可用数量;
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位安排控制
                    Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_最大可用数量, 0);
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_单个剩余, 0);
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            End If;
          End If;
        End If;
        If v_合作单位 Is Not Null Then
          If Nvl(r_No.计划id, 0) <> 0 Then
            Begin
              Select 0
              Into n_非合约
              From 合作单位计划控制
              Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And Rownum < 2;
            Exception
              When Others Then
                n_非合约 := 1;
            End;
          Else
            Begin
              Select 0
              Into n_非合约
              From 合作单位安排控制
              Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And Rownum < 2;
            Exception
              When Others Then
                n_非合约 := 1;
            End;
          End If;
        End If;
        If v_合作单位 Is Null Or n_非合约 = 1 Then
          If r_No.限号数 = 0 Then
            v_剩余数量 := '';
          Else
            If Nvl(r_No.计划id, 0) <> 0 Then
              Select Sum(数量)
              Into n_合约总数量
              From 合作单位计划控制
              Where 计划id = r_No.计划id And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
            Else
              Select Sum(数量)
              Into n_合约总数量
              From 合作单位安排控制
              Where 安排id = r_No.安排id And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
            End If;
            Select Count(1)
            Into n_合约已挂数
            From 病人挂号记录
            Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_日期) And
                  Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
            Select Count(1)
            Into n_预留数量
            From 挂号序号状态
            Where 状态 = 3 And 号码 = r_No.号码 And Trunc(日期) = Trunc(d_日期);
            If Trunc(d_日期) = Trunc(Sysdate) Then
              If Nvl(n_合约总数量, 0) = 0 Then
                v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_预留数量;
              Else
                v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_合约总数量 + n_合约已挂数 - n_预留数量;
              End If;
              n_已挂数 := r_No.已挂数;
              If Nvl(n_时段数量, 0) < v_剩余数量 And n_分时段 <> 0 Then
                n_缓冲序号 := 1;
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD>' ||
                              '<SL>' || To_Number(v_剩余数量 - Nvl(n_时段数量, 0) - Nvl(n_合约剩余数量, 0)) || '</SL>' || '</SPAN>';
              Else
                n_缓冲序号 := 0;
              End If;
            Else
              If Nvl(n_合约总数量, 0) = 0 Then
                v_剩余数量 := r_No.限约数 - r_No.已约数 - n_预留数量;
                If v_剩余数量 Is Null Then
                  v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_预留数量;
                End If;
              Else
                v_剩余数量 := r_No.限约数 - r_No.已约数 - n_合约总数量 + n_合约已挂数 - n_预留数量;
                If v_剩余数量 Is Null Then
                  v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_合约总数量 + n_合约已挂数 - n_预留数量;
                End If;
              End If;
              n_已挂数 := r_No.已挂数;
            End If;
          End If;
        Else
          If Nvl(r_No.计划id, 0) <> 0 Then
            If v_合作单位 Is Not Null Then
              Select Nvl(Max(1), 0)
              Into n_合约模式
              From 合作单位计划控制
              Where 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 计划id = r_No.计划id And 序号 = 0 And 合作单位 = v_合作单位;
            Else
              n_合约模式 := 0;
            End If;
            Select Sum(数量)
            Into n_合约总数量
            From 合作单位计划控制
            Where 计划id = r_No.计划id And 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                     '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
          Else
            If v_合作单位 Is Not Null Then
              Select Nvl(Max(1), 0)
              Into n_合约模式
              From 合作单位安排控制
              Where 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 安排id = r_No.安排id And 序号 = 0 And 合作单位 = v_合作单位;
            Else
              n_合约模式 := 0;
            End If;
            Select Sum(数量)
            Into n_合约总数量
            From 合作单位安排控制
            Where 安排id = r_No.安排id And 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                     '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
          End If;
          If n_合约模式 = 0 Then
            v_剩余数量   := n_合约剩余数量;
            n_已挂数     := r_No.已挂数;
            n_合约已挂数 := Nvl(n_合约总数量, 0) - n_合约剩余数量;
          Else
            n_已挂数 := r_No.已挂数;
            Select Count(1)
            Into n_合约已挂数
            From 病人挂号记录
            Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                  Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
            If Nvl(n_合约总数量, 0) = 0 Then
              v_剩余数量 := '0';
            Else
              v_剩余数量 := n_合约总数量 - n_合约已挂数;
            End If;
          End If;
        End If;
        Select To_Char(开始时间, 'hh24:mi') Into v_Timetemp From 时间段 Where 时间段 = r_No.排班;
        v_时间段 := v_Timetemp || '-';
        Select To_Char(终止时间, 'hh24:mi') Into v_Timetemp From 时间段 Where 时间段 = r_No.排班;
        v_时间段 := v_时间段 || v_Timetemp;
        If v_Temp Is Not Null Then
          v_Temp := v_Temp || '</SPANLIST>';
        End If;
        If v_合作单位 Is Not Null Then
          If Nvl(r_No.计划id, 0) <> 0 Then
            Select Nvl(Max(1), 0)
            Into n_禁用
            From 合作单位计划控制
            Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And 数量 = 0 And Rownum < 2;
          Else
            Select Nvl(Max(1), 0)
            Into n_禁用
            From 合作单位安排控制
            Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And 数量 = 0 And Rownum < 2;
          End If;
        End If;
        --限约数=0的预约禁止
        If Trunc(d_日期) <> Trunc(Sysdate) Then
          If r_No.限约数 = 0 Then
            n_禁用 := 1;
          End If;
        End If;
        If Nvl(n_禁用, 0) = 0 Then
          --从项金额计算
          n_合计金额 := r_No.价格;
          For r_Subfee In (Select 现价, 从项数次
                           From 收费从属项目 A, 收费价目 B
                           Where a.主项id = r_No.项目id And a.从项id = b.收费细目id And Sysdate Between b.执行日期 And
                                 Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))) Loop
            n_合计金额 := n_合计金额 + r_Subfee.现价 * r_Subfee.从项数次;
          End Loop;
          If Trunc(Sysdate) = Trunc(d_日期) Then
            Select Nvl(Max(1), 0)
            Into n_Exists
            From (Select 时间段
                   From 时间段
                   Where ('3000-01-10 ' || To_Char(Sysdate, 'HH24:MI:SS') < '3000-01-10 ' || To_Char(终止时间, 'HH24:MI:SS')) Or
                         ('3000-01-10 ' || To_Char(Sysdate, 'HH24:MI:SS') <
                         Decode(Sign(开始时间 - 终止时间), 1, '3000-01-11 ' || To_Char(终止时间, 'HH24:MI:SS'),
                                 '3000-01-10 ' || To_Char(终止时间, 'HH24:MI:SS'))))
            Where 时间段 = r_No.排班;
          Else
            n_Exists := 1;
          End If;
          If n_Exists = 1 Then
            If v_剩余数量 > 0 Then
              c_Xmlmain := '<HB>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' || r_No.医生id || '</YSID>' || '<YS>' ||
                           r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id || '</KSID>' || '<KSMC>' || r_No.科室名称 ||
                           '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' || r_No.项目id || '</XMID>' || '<XMMC>' ||
                           r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 || '</YGHS>' || '<SYHS>' || v_剩余数量 || '</SYHS>' ||
                           '<PRICE>' || n_合计金额 || '</PRICE>' || '<HCXH>' || n_缓冲序号 || '</HCXH>' || '<HL>' || r_No.号类 ||
                           '</HL>' || '<FSD>' || n_分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' || '<FWMC>' ||
                           r_No.排班 || '</FWMC>' || v_Temp || '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            Else
              c_Xmlmain := '<HB>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' || r_No.医生id || '</YSID>' || '<YS>' ||
                           r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id || '</KSID>' || '<KSMC>' || r_No.科室名称 ||
                           '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' || r_No.项目id || '</XMID>' || '<XMMC>' ||
                           r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 || '</YGHS>' || '<SYHS>' || v_剩余数量 || '</SYHS>' ||
                           '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' || r_No.号类 || '</HL>' || '<FSD>' || n_分时段 ||
                           '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' || '<FWMC>' || r_No.排班 || '</FWMC>' ||
                           '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            End If;
          End If;
        End If;
      End If;
      n_合约剩余数量 := 0;
      n_合约总数量   := 0;
      n_时段数量     := 0;
      n_禁用         := 0;
      n_非合约       := 0;
    End Loop;
    v_Xmlmain := '<GROUP>' || '<RQ>' || To_Char(d_日期, 'yyyy-mm-dd') || '</RQ>' || '<HBLIST>' || v_Xmlmain ||
                 '</HBLIST>' || '</GROUP>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Xmlmain)) Into x_Templet From Dual;
  Else
    --出诊表排班模式
    n_合约剩余数量 := 0;
    n_补充天数     := Zl_Fun_Getappointmentdays;
    For r_No In (Select a.科室id, b.号类, c.名称 As 科室名称, a.医生姓名, a.医生id, d.专业技术职务 As 职称, b.号码, a.Id As 记录id, a.上班时段 As 排班,
                        a.项目id, e.名称 As 项目名称, a.是否序号控制 As 序号控制, a.限号数, Nvl(a.限约数, a.限号数) As 限约数, Nvl(a.已挂数, 0) As 已挂数,
                        Nvl(a.已约数, 0) As 已约数, Nvl(a.其中已接收, 0) As 已接收, a.是否分时段 As 分时段, a.开始时间, a.终止时间, a.预约控制, a.替诊开始时间,
                        a.替诊终止时间, Nvl(b.预约天数, n_预约天数) + n_补充天数 As 预约天数, a.停诊开始时间, a.停诊终止时间
                 From 临床出诊记录 A, 临床出诊号源 B, 部门表 C, 人员表 D, 收费项目目录 E
                 Where a.出诊日期 = Trunc(d_日期) And a.终止时间 > Sysdate And a.号源id = b.Id And a.项目id = e.Id And
                       a.医生id = d.Id(+) And b.科室id = c.Id And Nvl(a.是否锁定, 0) = 0 And
                       (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间) Or Exists
                        (Select 1
                         From 临床出诊序号控制 C, 临床出诊记录 D
                         Where d.Id = a.Id And c.记录id = d.Id And Nvl(c.是否停诊, 0) = 0 And d.是否序号控制 = 1 And d.是否分时段 = 1 And
                               c.开始时间 <> c.终止时间)) And (a.开始时间 < Nvl(a.替诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.替诊终止时间, a.开始时间)) And
                       Nvl(a.是否发布, 0) = 1 And a.开始时间 > Trunc(To_Date(v_启用时间, 'yyyy-mm-dd hh24:mi:ss')) And
                       Decode(Nvl(n_科室id, 0), 0, 0, b.科室id) = Nvl(n_科室id, 0) And
                       Decode(Nvl(n_医生id, 0), 0, 0, a.医生id) = Nvl(n_医生id, 0) And
                       Decode(Nvl(v_医生姓名, '-'), '-', '-', a.医生姓名) = Nvl(v_医生姓名, '-')) Loop
      Zl_挂号序号状态_出诊_Delete(r_No.记录id);
      v_Temp := Null;
      If Sysdate + Nvl(r_No.预约天数, n_预约天数) + n_补充天数 >= d_日期 Then
        If Trunc(d_日期) = Trunc(Sysdate) Then
          --当天挂号
          If v_合作单位 Is Null Then
            --未传入合作单位
            n_已挂数   := r_No.已挂数;
            v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0) - (Nvl(r_No.已约数, 0) - Nvl(r_No.已接收, 0));
            If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
              --分时段
              Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
              v_Temp     := '<SPANLIST>';
              n_Exists   := 0;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                             From 临床出诊序号控制
                             Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                   Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    n_时段总数 := n_时段总数 + 1;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := 1;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + 1;
                    End If;
                  End If;
                End If;
                If r_Time.开始时间 > Sysdate Then
                  If Nvl(n_时间间隔, 0) = 0 Then
                    v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                              To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                      n_Exists := n_Exists + 1;
                    Else
                      v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                    End If;
                  Else
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      n_时段剩余 := n_时段剩余 + 1;
                      n_Exists   := n_Exists + 1;
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            
              If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                          To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
              End If;
              v_Temp := v_Temp || '</SPANLIST>';
            End If;
          Else
            --传入合作单位
            n_已挂数 := r_No.已挂数;
            Begin
              Select 控制方式
              Into n_合约模式
              From 临床出诊挂号控制记录
              Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
            Exception
              When Others Then
                n_合约模式 := 4;
            End;
            If n_合约模式 = 0 Then
              n_禁用 := 1;
            End If;
            If n_合约模式 = 1 Or n_合约模式 = 2 Then
              Select 数量
              Into n_合约总数量
              From 临床出诊挂号控制记录
              Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
              If n_合约模式 = 1 Then
                n_合约总数量 := Round(r_No.限号数 * n_合约总数量 / 100);
              End If;
              Select Count(1)
              Into n_合约已挂数
              From 病人挂号记录
              Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                    Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
              n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
              If r_No.限号数 - Nvl(r_No.已挂数, 0) < n_合约剩余数量 Then
                v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
              Else
                v_剩余数量 := n_合约剩余数量;
              End If;
              If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
                --分时段
                v_Temp   := '<SPANLIST>';
                n_Exists := 0;
                Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                               From 临床出诊序号控制
                               Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                  If Nvl(n_时间间隔, 0) <> 0 Then
                    If d_时段开始 Is Null Then
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                      n_时段总数 := n_时段总数 + 1;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      If r_Time.开始时间 >= d_时段结束 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  End If;
                  If r_Time.开始时间 > Sysdate Then
                    If Nvl(n_时间间隔, 0) = 0 Then
                      v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                        n_Exists := n_Exists + 1;
                      Else
                        v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                      End If;
                    Else
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        n_时段剩余 := n_时段剩余 + 1;
                        n_Exists   := n_Exists + 1;
                      End If;
                    End If;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                  v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                            To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            End If;
            If n_合约模式 = 3 Then
              If n_序号控制 = 0 Then
                n_已挂数   := r_No.已挂数;
                v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0) - (Nvl(r_No.已约数, 0) - Nvl(r_No.已接收, 0));
              Else
                n_已挂数   := 0;
                v_剩余数量 := 0;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_合作 In (Select 序号
                             From 临床出诊挂号控制记录
                             Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                  Begin
                    Select 1, 开始时间, 终止时间
                    Into n_Exists, d_开始时间, d_终止时间
                    From 临床出诊序号控制
                    Where 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                          Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1;
                  Exception
                    When Others Then
                      n_Exists := 0;
                  End;
                  If Nvl(n_时间间隔, 0) <> 0 Then
                    If d_时段开始 Is Null Then
                      d_时段开始 := d_开始时间;
                      d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                      n_时段总数 := n_时段总数 + 1;
                    Else
                      If d_开始时间 >= d_时段结束 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := d_开始时间;
                        d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  End If;
                  If n_Exists = 1 Then
                    v_剩余数量 := v_剩余数量 + 1;
                    If r_No.分时段 = 1 Then
                      If d_开始时间 > Sysdate Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD><SL>1</SL></SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + 1;
                        End If;
                      End If;
                    End If;
                  Else
                    n_已挂数 := n_已挂数 + 1;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If v_Temp Is Not Null Then
                  v_Temp := '<SPANLIST>' || v_Temp || '</SPANLIST>';
                End If;
              End If;
            End If;
            If n_合约模式 = 4 Then
              n_已挂数   := r_No.已挂数;
              v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0) - (Nvl(r_No.已约数, 0) - Nvl(r_No.已接收, 0));
              If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
                --分时段
                v_Temp   := '<SPANLIST>';
                n_Exists := 0;
                Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                               From 临床出诊序号控制
                               Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                  If Nvl(n_时间间隔, 0) <> 0 Then
                    If d_时段开始 Is Null Then
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                      n_时段总数 := n_时段总数 + 1;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      If r_Time.开始时间 >= d_时段结束 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  End If;
                  If r_Time.开始时间 > Sysdate Then
                    If Nvl(n_时间间隔, 0) = 0 Then
                      v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                        n_Exists := n_Exists + 1;
                      Else
                        v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                      End If;
                    Else
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        n_时段剩余 := n_时段剩余 + 1;
                        n_Exists   := n_Exists + 1;
                      End If;
                    End If;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                  v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                            To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            End If;
          End If;
        Else
          --预约挂号
          If r_No.预约控制 = 1 Then
            n_禁用 := 1;
          Else
            --不限制预约
            If v_合作单位 Is Null Then
              If r_No.分时段 = 0 Then
                n_已挂数   := r_No.已约数;
                v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
              Else
                --分时段
                n_已挂数   := 0;
                v_剩余数量 := 0;
                v_Temp     := '<SPANLIST>';
                If r_No.序号控制 = 0 Then
                  --非序号控制分时段预约
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                 From 临床出诊序号控制
                                 Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                       开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                       开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                    If Nvl(n_时间间隔, 0) <> 0 Then
                      If d_时段开始 Is Null Then
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                        n_时段总数 := n_时段总数 + r_Time.数量;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        If r_Time.开始时间 >= d_时段结束 Then
                          v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                        '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                          n_时段总数 := r_Time.数量;
                          n_时段剩余 := 0;
                          d_时段开始 := r_Time.开始时间;
                          d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                          If d_加号时间 < d_时段结束 Then
                            d_时段结束 := d_加号时间;
                          End If;
                        Else
                          n_时段总数 := n_时段总数 + r_Time.数量;
                        End If;
                      End If;
                    End If;
                    Select Count(1)
                    Into n_时段已挂
                    From 临床出诊序号控制
                    Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                    If r_Time.开始时间 > Sysdate Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                        v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + r_Time.数量 - n_时段已挂;
                      End If;
                      n_已挂数   := n_已挂数 + n_时段已挂;
                      v_剩余数量 := v_剩余数量 + (r_Time.数量 - n_时段已挂);
                    End If;
                  End Loop;
                  If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                    v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                  To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                  '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                  End If;
                Else
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                 From 临床出诊序号控制
                                 Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                       Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                    If Nvl(n_时间间隔, 0) <> 0 Then
                      If d_时段开始 Is Null Then
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                        n_时段总数 := n_时段总数 + 1;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        If r_Time.开始时间 >= d_时段结束 Then
                          v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                        '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                          n_时段总数 := 1;
                          n_时段剩余 := 0;
                          d_时段开始 := r_Time.开始时间;
                          d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                          If d_加号时间 < d_时段结束 Then
                            d_时段结束 := d_加号时间;
                          End If;
                        Else
                          n_时段总数 := n_时段总数 + 1;
                        End If;
                      End If;
                    End If;
                    If r_Time.开始时间 > Sysdate Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                        If Nvl(r_Time.挂号状态, 0) = 0 Then
                          v_Temp     := v_Temp || '<SL>1</SL></SPAN>';
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          v_Temp   := v_Temp || '<SL>0</SL></SPAN>';
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                      Else
                        If Nvl(r_Time.挂号状态, 0) = 0 Then
                          n_时段剩余 := n_时段剩余 + 1;
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                        n_时段剩余 := n_时段剩余 + 1;
                      End If;
                    End If;
                  End Loop;
                  If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                    v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                  To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                  '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                  End If;
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            Else
              --合作单位预约挂号
              If r_No.预约控制 = 2 Then
                n_禁用 := 1;
              Else
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 0 Then
                  n_禁用 := 1;
                End If;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_合约总数量
                  From 临床出诊挂号控制记录
                  Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_合约总数量 := Round(r_No.限号数 * n_合约总数量 / 100);
                  End If;
                  Begin
                    Select Count(1)
                    Into n_合约已挂数
                    From 病人挂号记录
                    Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                          Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
                  Exception
                    When Others Then
                      n_合约已挂数 := 0;
                  End;
                  n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
                  If Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0) < n_合约剩余数量 Then
                    v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                  Else
                    v_剩余数量 := n_合约剩余数量;
                  End If;
                  If r_No.分时段 = 1 Then
                    v_Temp := '<SPANLIST>';
                    If r_No.序号控制 = 1 Then
                      --分时段,序号控制
                      n_Exists   := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                           Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                              n_Exists := n_Exists + 1;
                            Else
                              v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                            End If;
                          Else
                            n_Exists   := n_Exists + 1;
                            n_时段剩余 := n_时段剩余 + 1;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      If n_Exists < To_Number(v_剩余数量) Then
                        v_剩余数量 := n_Exists;
                      End If;
                    Else
                      --分时段,非序号控制
                      n_Exists   := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                           开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                           开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + r_Time.数量;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := r_Time.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_Time.数量;
                            End If;
                          End If;
                        End If;
                        Select Count(1)
                        Into n_时段已挂
                        From 临床出诊序号控制
                        Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                          Else
                            n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                          End If;
                          n_Exists := n_Exists + (r_Time.数量 - n_时段已挂);
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      If n_Exists < To_Number(v_剩余数量) Then
                        v_剩余数量 := n_Exists;
                      End If;
                    End If;
                    v_Temp := v_Temp || '</SPANLIST>';
                  End If;
                  n_已挂数 := r_No.已约数;
                End If;
                If n_合约模式 = 3 Then
                  If r_No.分时段 = 0 Then
                    If r_No.序号控制 = 0 Then
                      n_禁用 := 1;
                    Else
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      For r_合作 In (Select 序号
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Begin
                          Select 1
                          Into n_Exists
                          From 临床出诊序号控制
                          Where 记录id = r_No.记录id And 序号 = r_合作.序号 And 是否预约 = 1 And Nvl(挂号状态, 0) = 0 And
                                开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                Nvl(是否停诊, 0) <> 1;
                        Exception
                          When Others Then
                            n_Exists := 0;
                        End;
                        If n_Exists = 1 Then
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                      End Loop;
                      If Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0) < v_剩余数量 Then
                        v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                      End If;
                    End If;
                  Else
                    If r_No.序号控制 = 0 Then
                      --合作单位,分时段,非序号控制
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      v_Temp     := '<SPANLIST>';
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      For r_合作 In (Select 序号, 数量
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Begin
                          Select Count(1), Max(开始时间), Max(终止时间)
                          Into n_时段已挂, d_开始时间, d_终止时间
                          From 临床出诊序号控制
                          Where 记录id = r_No.记录id And 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0 And 序号 = r_合作.序号 And
                                开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1);
                        
                          If Nvl(n_时间间隔, 0) <> 0 Then
                            If d_时段开始 Is Null Then
                              d_时段开始 := d_开始时间;
                              d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                              n_时段总数 := n_时段总数 + r_合作.数量;
                            Else
                              If d_开始时间 >= d_时段结束 Then
                                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                              '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                                n_时段总数 := r_合作.数量;
                                n_时段剩余 := 0;
                                d_时段开始 := d_开始时间;
                                d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              Else
                                n_时段总数 := n_时段总数 + r_合作.数量;
                              End If;
                            End If;
                          End If;
                          If d_开始时间 > Sysdate Then
                            n_已挂数 := n_已挂数 + n_时段已挂;
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || r_合作.数量 - n_时段已挂 || '</SL></SPAN>';
                            Else
                              n_时段剩余 := n_时段剩余 + r_合作.数量 - n_时段已挂;
                            End If;
                            v_剩余数量 := v_剩余数量 + r_合作.数量 - n_时段已挂;
                          End If;
                        Exception
                          When Others Then
                            Null;
                        End;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      v_Temp := v_Temp || '</SPANLIST>';
                    Else
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      v_Temp     := '<SPANLIST>';
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      For r_合作 In (Select 序号
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Begin
                          Select 1, 开始时间, 终止时间
                          Into n_Exists, d_开始时间, d_终止时间
                          From 临床出诊序号控制
                          Where 记录id = r_No.记录id And Nvl(挂号状态, 0) = 0 And 序号 = r_合作.序号 And
                                开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                Nvl(是否停诊, 0) <> 1;
                        Exception
                          When Others Then
                            n_Exists := 0;
                        End;
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := d_开始时间;
                            d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                          Else
                            If d_开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := d_开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If d_开始时间 > Sysdate Then
                          If n_Exists = 1 Then
                            v_剩余数量 := v_剩余数量 + 1;
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || 1 || '</SL></SPAN>';
                            Else
                              n_时段剩余 := n_时段剩余 + 1;
                            End If;
                          Else
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || 0 || '</SL></SPAN>';
                            End If;
                            n_已挂数 := n_已挂数 + 1;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    End If;
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  If r_No.分时段 = 0 Then
                    n_已挂数   := r_No.已约数;
                    v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                  Else
                    --分时段
                    n_已挂数   := 0;
                    v_剩余数量 := 0;
                    v_Temp     := '<SPANLIST>';
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                    Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                    If r_No.序号控制 = 0 Then
                      --非序号控制分时段预约
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                           开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                           开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + r_Time.数量;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := r_Time.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_Time.数量;
                            End If;
                          End If;
                        End If;
                        Select Count(1)
                        Into n_时段已挂
                        From 临床出诊序号控制
                        Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                          Else
                            n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                          End If;
                          n_已挂数   := n_已挂数 + n_时段已挂;
                          v_剩余数量 := v_剩余数量 + (r_Time.数量 - n_时段已挂);
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    Else
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                           Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              v_Temp     := v_Temp || '<SL>1</SL></SPAN>';
                              v_剩余数量 := v_剩余数量 + 1;
                            Else
                              v_Temp   := v_Temp || '<SL>0</SL></SPAN>';
                              n_已挂数 := n_已挂数 + 1;
                            End If;
                          Else
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              n_时段剩余 := n_时段剩余 + 1;
                              v_剩余数量 := v_剩余数量 + 1;
                            Else
                              n_已挂数 := n_已挂数 + 1;
                            End If;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    End If;
                    v_Temp := v_Temp || '</SPANLIST>';
                  End If;
                End If;
              End If;
            End If;
          End If;
        End If;
      
        If Not (r_No.分时段 = 1 And r_No.序号控制 = 1) Then
          If d_日期 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) Then
            n_禁用 := 1;
          End If;
          If d_日期 Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1) Then
            n_禁用 := 1;
          End If;
        End If;
      
        If Nvl(n_禁用, 0) = 0 Then
          n_合计金额 := 0;
          For r_Fee In (Select b.现价, a.从项数次
                        From 收费从属项目 A, 收费价目 B
                        Where a.主项id = r_No.项目id And a.从项id = b.收费细目id And Sysdate Between b.执行日期 And
                              Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                        Union
                        Select b.现价, 1 As 从项数次
                        From 收费项目目录 A, 收费价目 B
                        Where a.Id = b.收费细目id And a.Id = r_No.项目id And Sysdate Between b.执行日期 And
                              Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))) Loop
            n_合计金额 := n_合计金额 + r_Fee.现价 * r_Fee.从项数次;
          End Loop;
          v_时间段 := To_Char(r_No.开始时间, 'HH24:MI') || '-' || To_Char(r_No.终止时间, 'HH24:MI');
          If Trunc(Sysdate) = Trunc(d_日期) Then
            c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                         r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id || '</KSID>' ||
                         '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' || r_No.项目id ||
                         '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 || '</YGHS>' || '<SYHS>' ||
                         v_剩余数量 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' || r_No.号类 || '</HL>' ||
                         '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' || '<FWMC>' || r_No.排班 ||
                         '</FWMC>' || v_Temp || '</HB>';
            v_Xmlmain := v_Xmlmain || c_Xmlmain;
          Else
            If r_No.已约数 >= r_No.限约数 Then
              c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                           r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id ||
                           '</KSID>' || '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' ||
                           r_No.项目id || '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || r_No.已约数 ||
                           '</YGHS>' || '<SYHS>' || 0 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' ||
                           r_No.号类 || '</HL>' || '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' ||
                           '<FWMC>' || r_No.排班 || '</FWMC>' || '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            Else
              c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                           r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id ||
                           '</KSID>' || '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' ||
                           r_No.项目id || '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 ||
                           '</YGHS>' || '<SYHS>' || v_剩余数量 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' ||
                           r_No.号类 || '</HL>' || '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' ||
                           '<FWMC>' || r_No.排班 || '</FWMC>' || v_Temp || '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            End If;
          End If;
        End If;
      End If;
      n_禁用 := 0;
    End Loop;
  
    --加入替诊号源
    n_合约剩余数量 := 0;
    For r_No In (Select a.科室id, b.号类, c.名称 As 科室名称, a.替诊医生姓名 As 医生姓名, a.替诊医生id As 医生id, d.专业技术职务 As 职称, b.号码,
                        a.Id As 记录id, a.上班时段 As 排班, a.项目id, e.名称 As 项目名称, a.是否序号控制 As 序号控制, a.限号数,
                        Nvl(a.限约数, a.限号数) As 限约数, Nvl(a.已挂数, 0) As 已挂数, Nvl(a.已约数, 0) As 已约数, Nvl(a.其中已接收, 0) As 已接收,
                        a.是否分时段 As 分时段, a.开始时间, a.终止时间, a.预约控制, a.替诊开始时间, a.替诊终止时间, Nvl(b.预约天数, n_预约天数) + n_补充天数 As 预约天数,
                        a.停诊开始时间, a.停诊终止时间
                 From 临床出诊记录 A, 临床出诊号源 B, 部门表 C, 人员表 D, 收费项目目录 E
                 Where a.出诊日期 = Trunc(d_日期) And a.替诊医生姓名 Is Not Null And a.终止时间 > Sysdate And a.号源id = b.Id And
                       a.项目id = e.Id And a.替诊医生id = d.Id(+) And b.科室id = c.Id And Nvl(a.是否锁定, 0) = 0 And
                       (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间) Or Exists
                        (Select 1
                         From 临床出诊序号控制 C, 临床出诊记录 D
                         Where d.Id = a.Id And c.记录id = d.Id And Nvl(c.是否停诊, 0) = 0 And d.是否序号控制 = 1 And d.是否分时段 = 1 And
                               c.开始时间 <> c.终止时间)) And Nvl(a.是否发布, 0) = 1 And
                       a.开始时间 > Trunc(To_Date(v_启用时间, 'yyyy-mm-dd hh24:mi:ss')) And
                       Decode(Nvl(n_科室id, 0), 0, 0, b.科室id) = Nvl(n_科室id, 0) And
                       Decode(Nvl(n_医生id, 0), 0, 0, a.医生id) = Nvl(n_医生id, 0) And
                       Decode(Nvl(v_医生姓名, '-'), '-', '-', a.医生姓名) = Nvl(v_医生姓名, '-')) Loop
      v_Temp := '';
      If Sysdate + Nvl(r_No.预约天数, n_预约天数) + n_补充天数 >= d_日期 Then
        If Trunc(d_日期) = Trunc(Sysdate) Then
          --当天挂号
          If v_合作单位 Is Null Then
            --未传入合作单位
            n_已挂数   := r_No.已挂数;
            v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
            If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
              --分时段
              v_Temp     := '<SPANLIST>';
              n_Exists   := 0;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
              For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                             From 临床出诊序号控制
                             Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                   Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    n_时段总数 := n_时段总数 + 1;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := 1;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + 1;
                    End If;
                  End If;
                End If;
                If r_Time.开始时间 > Sysdate Then
                  If Nvl(n_时间间隔, 0) = 0 Then
                    v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                              To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                      n_Exists := n_Exists + 1;
                    Else
                      v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                    End If;
                  Else
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      n_Exists   := n_Exists + 1;
                      n_时段剩余 := n_时段剩余 + 1;
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
              If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                          To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
              End If;
              v_Temp := v_Temp || '</SPANLIST>';
            End If;
          Else
            --传入合作单位
            n_已挂数 := r_No.已挂数;
            Begin
              Select 控制方式
              Into n_合约模式
              From 临床出诊挂号控制记录
              Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
            Exception
              When Others Then
                n_合约模式 := 4;
            End;
            If n_合约模式 = 0 Then
              n_禁用 := 1;
            End If;
            If n_合约模式 = 1 Or n_合约模式 = 2 Then
              Select 数量
              Into n_合约总数量
              From 临床出诊挂号控制记录
              Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
              If n_合约模式 = 1 Then
                n_合约总数量 := Round(r_No.限号数 * n_合约总数量 / 100);
              End If;
              Select Count(1)
              Into n_合约已挂数
              From 病人挂号记录
              Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                    Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
              n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
              If r_No.限号数 - Nvl(r_No.已挂数, 0) < n_合约剩余数量 Then
                v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
              Else
                v_剩余数量 := n_合约剩余数量;
              End If;
              If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
                --分时段
                v_Temp   := '<SPANLIST>';
                n_Exists := 0;
                Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                               From 临床出诊序号控制
                               Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                
                  If Nvl(n_时间间隔, 0) <> 0 Then
                    If d_时段开始 Is Null Then
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                      n_时段总数 := n_时段总数 + 1;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      If r_Time.开始时间 >= d_时段结束 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  End If;
                  If r_Time.开始时间 > Sysdate Then
                    If Nvl(n_时间间隔, 0) = 0 Then
                      v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                        n_Exists := n_Exists + 1;
                      Else
                        v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                      End If;
                    Else
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        n_Exists   := n_Exists + 1;
                        n_时段剩余 := n_时段剩余 + 1;
                      End If;
                    End If;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                  v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                            To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            End If;
            If n_合约模式 = 3 Then
              If n_序号控制 = 0 Then
                n_已挂数   := r_No.已挂数;
                v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
              Else
                n_已挂数   := 0;
                v_剩余数量 := 0;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_合作 In (Select 序号
                             From 临床出诊挂号控制记录
                             Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                  Begin
                    Select 1, 开始时间, 终止时间
                    Into n_Exists, d_开始时间, d_终止时间
                    From 临床出诊序号控制
                    Where 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                          Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1;
                  Exception
                    When Others Then
                      n_Exists := 0;
                  End;
                  If n_Exists = 1 Then
                    v_剩余数量 := v_剩余数量 + 1;
                    If r_No.分时段 = 1 Then
                    
                      If Nvl(n_时间间隔, 0) <> 0 Then
                        If d_时段开始 Is Null Then
                          d_时段开始 := d_开始时间;
                          d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                          n_时段总数 := n_时段总数 + 1;
                        Else
                          If d_开始时间 >= d_时段结束 Then
                            v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                          To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                          '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                            n_时段总数 := 1;
                            n_时段剩余 := 0;
                            d_时段开始 := d_开始时间;
                            d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                          Else
                            n_时段总数 := n_时段总数 + 1;
                          End If;
                        End If;
                      End If;
                      If d_开始时间 > Sysdate Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD><SL>1</SL></SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + 1;
                        End If;
                      End If;
                    End If;
                  Else
                    n_已挂数 := n_已挂数 + 1;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If v_Temp Is Not Null Then
                  v_Temp := '<SPANLIST>' || v_Temp || '</SPANLIST>';
                End If;
              End If;
            End If;
            If n_合约模式 = 4 Then
              n_已挂数   := r_No.已挂数;
              v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
              If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
                --分时段
                v_Temp   := '<SPANLIST>';
                n_Exists := 0;
                Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                               From 临床出诊序号控制
                               Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                
                  If Nvl(n_时间间隔, 0) <> 0 Then
                    If d_时段开始 Is Null Then
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                      n_时段总数 := n_时段总数 + 1;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      If r_Time.开始时间 >= d_时段结束 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  End If;
                  If r_Time.开始时间 > Sysdate Then
                    If Nvl(n_时间间隔, 0) = 0 Then
                      v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                        n_Exists := n_Exists + 1;
                      Else
                        v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                      End If;
                    Else
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        n_Exists   := n_Exists + 1;
                        n_时段剩余 := n_时段剩余 + 1;
                      End If;
                    End If;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                
                  v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                            To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            End If;
          End If;
        Else
          --预约挂号
          If r_No.预约控制 = 1 Then
            n_禁用 := 1;
          Else
            --不限制预约
            If v_合作单位 Is Null Then
              If r_No.分时段 = 0 Then
                n_已挂数   := r_No.已约数;
                v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
              Else
                --分时段
                n_已挂数   := 0;
                v_剩余数量 := 0;
                v_Temp     := '<SPANLIST>';
                If r_No.序号控制 = 0 Then
                  --非序号控制分时段预约
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                 From 临床出诊序号控制
                                 Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                       开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                       开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                    If Nvl(n_时间间隔, 0) <> 0 Then
                      If d_时段开始 Is Null Then
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                        n_时段总数 := n_时段总数 + r_Time.数量;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        If r_Time.开始时间 >= d_时段结束 Then
                          v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                        '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                          n_时段总数 := r_Time.数量;
                          n_时段剩余 := 0;
                          d_时段开始 := r_Time.开始时间;
                          d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                          If d_加号时间 < d_时段结束 Then
                            d_时段结束 := d_加号时间;
                          End If;
                        Else
                          n_时段总数 := n_时段总数 + r_Time.数量;
                        End If;
                      End If;
                    End If;
                    Select Count(1)
                    Into n_时段已挂
                    From 临床出诊序号控制
                    Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                    If r_Time.开始时间 > Sysdate Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                        v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                      End If;
                      n_已挂数   := n_已挂数 + n_时段已挂;
                      v_剩余数量 := v_剩余数量 + (r_Time.数量 - n_时段已挂);
                    End If;
                  End Loop;
                  If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                    v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                  To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                  '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                  End If;
                Else
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                 From 临床出诊序号控制
                                 Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                       Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                    If Nvl(n_时间间隔, 0) <> 0 Then
                      If d_时段开始 Is Null Then
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                        n_时段总数 := n_时段总数 + 1;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        If r_Time.开始时间 >= d_时段结束 Then
                          v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                        '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                          n_时段总数 := 1;
                          n_时段剩余 := 0;
                          d_时段开始 := r_Time.开始时间;
                          d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                          If d_加号时间 < d_时段结束 Then
                            d_时段结束 := d_加号时间;
                          End If;
                        Else
                          n_时段总数 := n_时段总数 + 1;
                        End If;
                      End If;
                    End If;
                    If r_Time.开始时间 > Sysdate Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                        If Nvl(r_Time.挂号状态, 0) = 0 Then
                          v_Temp     := v_Temp || '<SL>1</SL></SPAN>';
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          v_Temp   := v_Temp || '<SL>0</SL></SPAN>';
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                      Else
                        If Nvl(r_Time.挂号状态, 0) = 0 Then
                          n_时段剩余 := n_时段剩余 + 1;
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                      End If;
                    End If;
                  End Loop;
                  If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                    v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                  To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                  '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                  End If;
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            Else
              --合作单位预约挂号
              If r_No.预约控制 = 2 Then
                n_禁用 := 1;
              Else
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 0 Then
                  n_禁用 := 1;
                End If;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_合约总数量
                  From 临床出诊挂号控制记录
                  Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_合约总数量 := Round(r_No.限号数 * n_合约总数量 / 100);
                  End If;
                  Select Count(1)
                  Into n_合约已挂数
                  From 病人挂号记录
                  Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                        Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
                  n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
                  If Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0) < n_合约剩余数量 Then
                    v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                  Else
                    v_剩余数量 := n_合约剩余数量;
                  End If;
                  If r_No.分时段 = 1 Then
                    v_Temp := '<SPANLIST>';
                    If r_No.序号控制 = 1 Then
                      --分时段,序号控制
                      n_Exists   := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                           Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                      
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                              n_Exists := n_Exists + 1;
                            Else
                              v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                            End If;
                          Else
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              n_时段剩余 := n_时段剩余 + 1;
                              n_Exists   := n_Exists + 1;
                            End If;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      If n_Exists < To_Number(v_剩余数量) Then
                        v_剩余数量 := n_Exists;
                      End If;
                    Else
                      --分时段,非序号控制
                      n_Exists   := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                           开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                           开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + r_Time.数量;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := r_Time.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_Time.数量;
                            End If;
                          End If;
                        End If;
                        Select Count(1)
                        Into n_时段已挂
                        From 临床出诊序号控制
                        Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                          Else
                            n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                          End If;
                          n_Exists := n_Exists + (r_Time.数量 - n_时段已挂);
                        
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      If n_Exists < To_Number(v_剩余数量) Then
                        v_剩余数量 := n_Exists;
                      End If;
                    End If;
                    v_Temp := v_Temp || '</SPANLIST>';
                  End If;
                  n_已挂数 := r_No.已约数;
                End If;
                If n_合约模式 = 3 Then
                  If r_No.分时段 = 0 Then
                    If r_No.序号控制 = 0 Then
                      n_禁用 := 1;
                    Else
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      For r_合作 In (Select 序号
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Select Nvl(Max(1), 0)
                        Into n_Exists
                        From 临床出诊序号控制
                        Where 记录id = r_No.记录id And 序号 = r_合作.序号 And 是否预约 = 1 And Nvl(挂号状态, 0) = 0 And
                              开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                              Nvl(是否停诊, 0) <> 1;
                        If n_Exists = 1 Then
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                      End Loop;
                      If Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0) < v_剩余数量 Then
                        v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                      End If;
                    End If;
                  Else
                    If r_No.序号控制 = 0 Then
                      --合作单位,分时段,非序号控制
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      v_Temp     := '<SPANLIST>';
                      For r_合作 In (Select 序号, 数量
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Begin
                          Select Count(1), Max(开始时间), Max(终止时间)
                          Into n_时段已挂, d_开始时间, d_终止时间
                          From 临床出诊序号控制
                          Where 记录id = r_No.记录id And 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0 And 序号 = r_合作.序号 And
                                开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1);
                        
                          If Nvl(n_时间间隔, 0) <> 0 Then
                            If d_时段开始 Is Null Then
                              d_时段开始 := d_开始时间;
                              d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                              n_时段总数 := n_时段总数 + r_合作.数量;
                            Else
                              If d_开始时间 >= d_时段结束 Then
                                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                              '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                                n_时段总数 := r_合作.数量;
                                n_时段剩余 := 0;
                                d_时段开始 := d_开始时间;
                                d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              Else
                                n_时段总数 := n_时段总数 + r_合作.数量;
                              End If;
                            End If;
                          End If;
                          n_已挂数 := n_已挂数 + n_时段已挂;
                          If d_开始时间 > Sysdate Then
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || r_合作.数量 - n_时段已挂 || '</SL></SPAN>';
                            Else
                              n_时段剩余 := n_时段剩余 + r_合作.数量 - n_时段已挂;
                            End If;
                            v_剩余数量 := v_剩余数量 + r_合作.数量 - n_时段已挂;
                          End If;
                        Exception
                          When Others Then
                            Null;
                        End;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      v_Temp := v_Temp || '</SPANLIST>';
                    Else
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      v_Temp     := '<SPANLIST>';
                      For r_合作 In (Select 序号
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Begin
                          Select 1, 开始时间, 终止时间
                          Into n_Exists, d_开始时间, d_终止时间
                          From 临床出诊序号控制
                          Where 记录id = r_No.记录id And Nvl(挂号状态, 0) = 0 And 序号 = r_合作.序号 And
                                开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                Nvl(是否停诊, 0) <> 1;
                        Exception
                          When Others Then
                            n_Exists := 0;
                        End;
                      
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := d_开始时间;
                            d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                          Else
                            If d_开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := d_开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If d_开始时间 > Sysdate Then
                          If n_Exists = 1 Then
                            v_剩余数量 := v_剩余数量 + 1;
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || 1 || '</SL></SPAN>';
                            Else
                              n_时段剩余 := n_时段剩余 + 1;
                            End If;
                          Else
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || 0 || '</SL></SPAN>';
                            End If;
                            n_已挂数 := n_已挂数 + 1;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    End If;
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  If r_No.分时段 = 0 Then
                    n_已挂数   := r_No.已约数;
                    v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                  Else
                    --分时段
                    n_已挂数   := 0;
                    v_剩余数量 := 0;
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                    v_Temp     := '<SPANLIST>';
                    If r_No.序号控制 = 0 Then
                      --非序号控制分时段预约
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                           开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                           开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                      
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + r_Time.数量;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := r_Time.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_Time.数量;
                            End If;
                          End If;
                        End If;
                        Select Count(1)
                        Into n_时段已挂
                        From 临床出诊序号控制
                        Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                          Else
                            n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                          End If;
                          n_已挂数   := n_已挂数 + n_时段已挂;
                          v_剩余数量 := v_剩余数量 + (r_Time.数量 - n_时段已挂);
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    Else
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                           Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                      
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              v_Temp     := v_Temp || '<SL>1</SL></SPAN>';
                              v_剩余数量 := v_剩余数量 + 1;
                            Else
                              v_Temp   := v_Temp || '<SL>0</SL></SPAN>';
                              n_已挂数 := n_已挂数 + 1;
                            End If;
                          Else
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              n_时段剩余 := n_时段剩余 + 1;
                              v_剩余数量 := v_剩余数量 + 1;
                            Else
                              n_已挂数 := n_已挂数 + 1;
                            End If;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    End If;
                    v_Temp := v_Temp || '</SPANLIST>';
                  End If;
                End If;
              End If;
            End If;
          End If;
        End If;
      
        If Not (r_No.分时段 = 1 And r_No.序号控制 = 1) Then
          If d_日期 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) Then
            n_禁用 := 1;
          End If;
          If d_日期 Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1) Then
            n_禁用 := 1;
          End If;
        End If;
      
        If Nvl(n_禁用, 0) = 0 Then
          n_合计金额 := 0;
          For r_Fee In (Select b.现价, a.从项数次
                        From 收费从属项目 A, 收费价目 B
                        Where a.主项id = r_No.项目id And a.从项id = b.收费细目id And Sysdate Between b.执行日期 And
                              Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                        Union
                        Select b.现价, 1 As 从项数次
                        From 收费项目目录 A, 收费价目 B
                        Where a.Id = b.收费细目id And a.Id = r_No.项目id And Sysdate Between b.执行日期 And
                              Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))) Loop
            n_合计金额 := n_合计金额 + r_Fee.现价 * r_Fee.从项数次;
          End Loop;
          v_时间段 := To_Char(r_No.替诊开始时间, 'HH24:MI') || '-' || To_Char(r_No.替诊终止时间, 'HH24:MI');
          If Trunc(Sysdate) = Trunc(d_日期) Then
            c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                         r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id || '</KSID>' ||
                         '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' || r_No.项目id ||
                         '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 || '</YGHS>' || '<SYHS>' ||
                         v_剩余数量 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' || r_No.号类 || '</HL>' ||
                         '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' || '<FWMC>' || r_No.排班 ||
                         '</FWMC>' || v_Temp || '</HB>';
            v_Xmlmain := v_Xmlmain || c_Xmlmain;
          Else
            If r_No.已约数 >= r_No.限约数 Then
              c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                           r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id ||
                           '</KSID>' || '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' ||
                           r_No.项目id || '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || r_No.已约数 ||
                           '</YGHS>' || '<SYHS>' || 0 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' ||
                           r_No.号类 || '</HL>' || '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' ||
                           '<FWMC>' || r_No.排班 || '</FWMC>' || '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            Else
              c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                           r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id ||
                           '</KSID>' || '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' ||
                           r_No.项目id || '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 ||
                           '</YGHS>' || '<SYHS>' || v_剩余数量 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' ||
                           r_No.号类 || '</HL>' || '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' ||
                           '<FWMC>' || r_No.排班 || '</FWMC>' || v_Temp || '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            End If;
          End If;
        End If;
      End If;
      n_禁用 := 0;
    End Loop;
    v_Xmlmain := '<GROUP>' || '<RQ>' || To_Char(d_日期, 'yyyy-mm-dd') || '</RQ>' || '<HBLIST>' || v_Xmlmain ||
                 '</HBLIST>' || '</GROUP>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Xmlmain)) Into x_Templet From Dual;
  End If;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getnolist;
/

--106912:刘尔旋,2017-03-10,新挂号安排可预约天数调整
Create Or Replace Procedure Zl_Third_Docarrange
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:医生排班计划
  --入参:Xml_In:
  --<IN>
  --   <YSID>870</YSID>    //医生ID
  --   <KDID>870</KSID>    //科室ID
  --   <KSSJ>2014-10-29 </KSSJ>    //开始时间
  --   <CXTS>14</CXTS>    //查询天数
  --   <HZDW>支付宝</HZDW> //合作单位
  --   <HL>号类</HL>      //号类，可传多个，用逗号分隔，格式:普通,专家,...
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --   <PBLIST>       //未返回该节点表示没有数据
  --    <PB>
  --     <RQ>2014-10-29</RQ>     //日期
  --     <SYHS>5</SYHS>    //剩余号数
  --     <SBSJ>全日</SBSJ>             //上班时间
  --     <YGS>5</YGS>    //已挂号数
  --    </PB>
  --   <PBLIST>
  --   <ERROR><MSG></MSG></ERROR> //错误情况返回
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  d_日期         Date;
  v_排班         挂号安排.周日%Type;
  n_限号数       挂号安排限制.限号数%Type;
  n_已挂数       挂号安排限制.限号数%Type;
  n_总已挂数     挂号安排限制.限号数%Type;
  n_限约数       挂号安排限制.限号数%Type;
  n_已约数       挂号安排限制.限号数%Type;
  n_剩余数       挂号安排限制.限号数%Type;
  v_上班时间     Varchar2(300);
  n_医生id       人员表.Id%Type;
  n_科室id       部门表.Id%Type;
  n_查询天数     Number(4);
  n_合作单位数量 Number(5);
  n_合约已挂数   Number(4);
  n_合约存在     Number(3);
  n_安排存在     Number(3);
  v_号码         挂号安排.号码%Type;
  n_安排id       挂号安排计划.安排id%Type;
  n_计划id       挂号安排计划.Id%Type;
  v_合作单位     挂号合作单位.名称%Type;
  n_Daycount     Number(4);
  d_开始时间     Date;
  d_原始时间     Date;
  n_禁用         Number(3);
  v_Temp         Varchar2(32767); --临时XML
  x_Templet      Xmltype; --模板XML
  v_Err_Msg      Varchar2(200);
  v_号类         Varchar2(200);
  n_Exists       Number(2);
  n_预约天数     Number(5);
  n_补充天数     Number(5);
  n_挂号模式     Number(3);
  n_合约模式     临床出诊挂号控制记录.控制方式%Type;
  v_启用时间     Varchar2(500);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/YSID'), Extractvalue(Value(A), 'IN/KSID'), Extractvalue(Value(A), 'IN/CXTS'),
         To_Date(Extractvalue(Value(A), 'IN/KSSJ'), 'YYYY-MM-DD hh24:mi:ss'), Extractvalue(Value(A), 'IN/HZDW'),
         Extractvalue(Value(A), 'IN/HL')
  Into n_医生id, n_科室id, n_查询天数, d_开始时间, v_合作单位, v_号类
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  n_查询天数 := Nvl(n_查询天数, 14);
  n_预约天数 := Nvl(zl_GetSysParameter(66), 7);
  d_原始时间 := Trunc(d_开始时间);
  d_开始时间 := Trunc(d_开始时间);
  n_Daycount := 0;
  n_挂号模式 := To_Number(Substr(Nvl(zl_GetSysParameter('挂号排班模式'), '0'), 1, 1));
  v_启用时间 := Substr(Nvl(zl_GetSysParameter('挂号排班模式'), '0'), 3);
  If n_挂号模式 = 0 Then
    If Nvl(n_科室id, 0) = 0 Then
      While (n_Daycount < n_查询天数) Loop
        If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
          d_开始时间 := Sysdate - n_Daycount;
        Else
          d_开始时间 := d_原始时间;
        End If;
        n_安排存在 := 0;
        v_上班时间 := Null;
        n_总已挂数 := 0;
        n_已挂数   := 0;
        n_剩余数   := 0;
        n_限号数   := 0;
        n_已约数   := 0;
        n_限约数   := 0;
        For r_排班 In (Select d_开始时间 + n_Daycount As 日期, a.排班, a.限号数, a.限约数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数,
                            a.安排id, a.计划id, a.号码, a.号类
                     
                     From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称, Ap.号码,
                                   Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数

                            
                            From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                          Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                          Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4',
                                                  Ap.周三, '5', Ap.周四, '6', Ap.周五, '7', Ap.周六, Null) As 排班,
                                          Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                   From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                                   Where Ap.科室id = Bm.Id(+) And Ap.医生id = n_医生id And
                                         Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And Ap.停用日期 Is Null And
                                         d_开始时间 + n_Daycount Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                         Nvl(Ap.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                         Xz.限制项目(+) =
                                         Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                    (Select Rownum
                                          From 挂号安排停用状态 Ty
                                          Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                         Not Exists
                                    (Select Rownum
                                          From 挂号安排计划 Jh
                                          Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                                d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')))
                                   Union All
                                   Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id,
                                          Jh.Id As 计划id, Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                          Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4',
                                                  Jh.周三, '5', Jh.周四, '6', Jh.周五, '7', Jh.周六, Null) As 排班,
                                          Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                   From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                                   Where Jh.安排id = Ap.Id And Ap.科室id = Bm.Id(+) And
                                         Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And Ap.停用日期 Is Null And
                                         Jh.医生id = n_医生id And
                                         d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                         Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.计划id(+) = Jh.Id And
                                         Xz.限制项目(+) =
                                         Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                    (Select Rownum
                                          From 挂号安排停用状态 Ty
                                          Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                         (Jh.生效时间, Jh.安排id) =
                                         (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                          From 挂号安排计划 Sxjh
                                          Where Sxjh.审核时间 Is Not Null And d_开始时间 + n_Daycount Between
                                                Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                Nvl(Sxjh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Sxjh.安排id = Jh.安排id
                                          Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                            Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                          病人挂号汇总 Hz, 收费价目 B
                     Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_开始时间 + n_Daycount) And a.项目id = b.收费细目id And
                           b.终止日期 > d_开始时间 + n_Daycount And b.执行日期 <= d_开始时间 + n_Daycount
                     
                     ) Loop
          If v_号类 Is Null Or Instr(',' || v_号类 || ',', ',' || r_排班.号类 || ',') > 0 Then
            v_上班时间 := v_上班时间 || '+' || r_排班.排班;
            n_总已挂数 := n_总已挂数 + r_排班.已挂数;
            n_已挂数   := r_排班.已挂数;
            n_限号数   := r_排班.限号数;
            n_已约数   := r_排班.已约数;
            n_限约数   := r_排班.限约数;
            n_安排id   := Nvl(r_排班.安排id, 0);
            n_计划id   := Nvl(r_排班.计划id, 0);
            v_号码     := r_排班.号码;
            n_安排存在 := 1;
            If v_上班时间 Is Not Null Then
              If v_合作单位 Is Not Null Then
                If n_计划id <> 0 Then
                  Begin
                    Select 1
                    Into n_合约存在
                    From 合作单位计划控制
                    Where 计划id = n_计划id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_合约存在 := 0;
                  End;
                Else
                  Begin
                    Select 1
                    Into n_合约存在
                    From 合作单位安排控制
                    Where 安排id = n_安排id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_合约存在 := 0;
                  End;
                End If;
              End If;
            
              If v_合作单位 Is Null Or Nvl(n_合约存在, 0) = 0 Then
                If n_计划id <> 0 Then
                  Begin
                    Select Sum(数量)
                    Into n_合作单位数量
                    From 合作单位计划控制
                    Where 计划id = n_计划id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null);
                  Exception
                    When Others Then
                      n_合作单位数量 := 0;
                  End;
                Else
                  Begin
                    Select Sum(数量)
                    Into n_合作单位数量
                    From 合作单位安排控制
                    Where 安排id = n_安排id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null);
                  Exception
                    When Others Then
                      n_合作单位数量 := 0;
                  End;
                End If;
                Begin
                  Select Count(1)
                  Into n_合约已挂数
                  From 病人挂号记录
                  Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                        Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                Exception
                  When Others Then
                    n_合约已挂数 := 0;
                End;
                If n_合作单位数量 = 0 Then
                  n_合作单位数量 := Null;
                End If;
                If Trunc(d_开始时间 + n_Daycount) > Trunc(Sysdate) Then
                  n_剩余数 := Nvl(n_剩余数, 0) + n_限约数 - n_已约数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                Else
                  n_剩余数 := Nvl(n_剩余数, 0) + n_限号数 - n_已挂数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                End If;
              Else
                --合约单位
                If n_计划id <> 0 Then
                  Begin
                    Select 1
                    Into n_禁用
                    From 合作单位计划控制
                    Where 计划id = n_计划id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                          Rownum < 2;
                  Exception
                    When Others Then
                      n_禁用 := 0;
                  End;
                Else
                  Begin
                    Select 1
                    Into n_禁用
                    From 合作单位安排控制
                    Where 安排id = n_安排id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                          Rownum < 2;
                  Exception
                    When Others Then
                      n_禁用 := 0;
                  End;
                End If;
                If Nvl(n_禁用, 0) = 0 Then
                  Begin
                    Select Count(1)
                    Into n_合约已挂数
                    From 病人挂号记录
                    Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                          Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                  Exception
                    When Others Then
                      n_合约已挂数 := 0;
                  End;
                  If n_计划id <> 0 Then
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  Else
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  End If;
                  If n_合作单位数量 = 0 Then
                    n_合作单位数量 := Null;
                  End If;
                  n_剩余数 := Nvl(n_剩余数, 0) + Nvl(n_合作单位数量, n_合约已挂数) - Nvl(n_合约已挂数, 0);
                
                End If;
              End If;
            End If;
            n_合作单位数量 := 0;
            n_合约存在     := 0;
            n_禁用         := 0;
          End If;
        End Loop;
        v_上班时间 := Substr(v_上班时间, 2);
        If n_安排存在 = 1 Then
          v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                    '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 || '</YGS>' ||
                    '</PB>';
        End If;
        n_Daycount := n_Daycount + 1;
      End Loop;
    Else
      While (n_Daycount < n_查询天数) Loop
        If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
          d_开始时间 := Sysdate - n_Daycount;
        Else
          d_开始时间 := d_原始时间;
        End If;
        v_上班时间 := Null;
        n_总已挂数 := 0;
        n_已挂数   := 0;
        n_剩余数   := 0;
        n_限号数   := 0;
        n_已约数   := 0;
        n_限约数   := 0;
        n_安排存在 := 0;
        For r_排班 In (Select d_开始时间 + n_Daycount As 日期, a.排班, a.限号数, a.限约数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数,
                            a.安排id, a.计划id, a.号码, a.号类
                     
                     From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称, Ap.号码,
                                   Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数

                            
                            From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                          Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                          Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4',
                                                  Ap.周三, '5', Ap.周四, '6', Ap.周五, '7', Ap.周六, Null) As 排班,
                                          Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                   From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                                   Where Ap.科室id = Bm.Id(+) And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                         Ap.医生id = n_医生id And Ap.科室id = n_科室id And Ap.停用日期 Is Null And
                                         d_开始时间 + n_Daycount Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                         Nvl(Ap.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                         Xz.限制项目(+) =
                                         Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                    (Select Rownum
                                          From 挂号安排停用状态 Ty
                                          Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                         Not Exists
                                    (Select Rownum
                                          From 挂号安排计划 Jh
                                          Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                                d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')))
                                   Union All
                                   Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id,
                                          Jh.Id As 计划id, Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                          Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4',
                                                  Jh.周三, '5', Jh.周四, '6', Jh.周五, '7', Jh.周六, Null) As 排班,
                                          Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                   From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                                   Where Jh.安排id = Ap.Id And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                         Ap.科室id = Bm.Id(+) And Ap.停用日期 Is Null And Jh.医生id = n_医生id And Ap.科室id = n_科室id And
                                         d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                         Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.计划id(+) = Jh.Id And
                                         Xz.限制项目(+) =
                                         Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                    (Select Rownum
                                          From 挂号安排停用状态 Ty
                                          Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                         (Jh.生效时间, Jh.安排id) =
                                         (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                          From 挂号安排计划 Sxjh
                                          Where Sxjh.审核时间 Is Not Null And d_开始时间 + n_Daycount Between
                                                Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                Nvl(Sxjh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Sxjh.安排id = Jh.安排id
                                          Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                            Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                          病人挂号汇总 Hz, 收费价目 B
                     Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_开始时间 + n_Daycount) And a.项目id = b.收费细目id And
                           b.终止日期 > d_开始时间 + n_Daycount And b.执行日期 <= d_开始时间 + n_Daycount
                     
                     ) Loop
          If v_号类 Is Null Or Instr(',' || v_号类 || ',', ',' || r_排班.号类 || ',') > 0 Then
            v_上班时间 := v_上班时间 || '+' || r_排班.排班;
            n_总已挂数 := n_总已挂数 + r_排班.已挂数;
            n_已挂数   := r_排班.已挂数;
            n_限号数   := r_排班.限号数;
            n_已约数   := r_排班.已约数;
            n_限约数   := r_排班.限约数;
            n_安排id   := Nvl(r_排班.安排id, 0);
            n_计划id   := Nvl(r_排班.计划id, 0);
            v_号码     := r_排班.号码;
            n_安排存在 := 1;
          
            If v_上班时间 Is Not Null Then
              If v_合作单位 Is Not Null Then
                If n_计划id <> 0 Then
                  Begin
                    Select 1
                    Into n_合约存在
                    From 合作单位计划控制
                    Where 计划id = n_计划id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_合约存在 := 0;
                  End;
                Else
                  Begin
                    Select 1
                    Into n_合约存在
                    From 合作单位安排控制
                    Where 安排id = n_安排id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_合约存在 := 0;
                  End;
                End If;
              End If;
            
              If v_合作单位 Is Null Or Nvl(n_合约存在, 0) = 0 Then
                If n_计划id <> 0 Then
                  Begin
                    Select Sum(数量)
                    Into n_合作单位数量
                    From 合作单位计划控制
                    Where 计划id = n_计划id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null);
                  Exception
                    When Others Then
                      n_合作单位数量 := 0;
                  End;
                Else
                  Begin
                    Select Sum(数量)
                    Into n_合作单位数量
                    From 合作单位安排控制
                    Where 安排id = n_安排id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null);
                  Exception
                    When Others Then
                      n_合作单位数量 := 0;
                  End;
                End If;
                Begin
                  Select Count(1)
                  Into n_合约已挂数
                  From 病人挂号记录
                  Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                        Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                Exception
                  When Others Then
                    n_合约已挂数 := 0;
                End;
                If n_合作单位数量 = 0 Then
                  n_合作单位数量 := Null;
                End If;
                If Trunc(d_开始时间 + n_Daycount) > Trunc(Sysdate) Then
                  n_剩余数 := Nvl(n_剩余数, 0) + n_限约数 - n_已约数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                Else
                  n_剩余数 := Nvl(n_剩余数, 0) + n_限号数 - n_已挂数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                End If;
              Else
                --合约单位
                If n_计划id <> 0 Then
                  Begin
                    Select 1
                    Into n_禁用
                    From 合作单位计划控制
                    Where 计划id = n_计划id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                          Rownum < 2;
                  Exception
                    When Others Then
                      n_禁用 := 0;
                  End;
                Else
                  Begin
                    Select 1
                    Into n_禁用
                    From 合作单位安排控制
                    Where 安排id = n_安排id And
                          限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                        '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                          Rownum < 2;
                  Exception
                    When Others Then
                      n_禁用 := 0;
                  End;
                End If;
                If Nvl(n_禁用, 0) = 0 Then
                  Begin
                    Select Count(1)
                    Into n_合约已挂数
                    From 病人挂号记录
                    Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                          Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                  Exception
                    When Others Then
                      n_合约已挂数 := 0;
                  End;
                  If n_计划id <> 0 Then
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  Else
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  End If;
                  If n_合作单位数量 = 0 Then
                    n_合作单位数量 := Null;
                  End If;
                  n_剩余数 := Nvl(n_剩余数, 0) + Nvl(n_合作单位数量, n_合约已挂数) - Nvl(n_合约已挂数, 0);
                
                End If;
              End If;
            End If;
            n_合作单位数量 := 0;
            n_合约存在     := 0;
            n_禁用         := 0;
          End If;
        End Loop;
        v_上班时间 := Substr(v_上班时间, 2);
        If n_安排存在 = 1 Then
          v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                    '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 || '</YGS>' ||
                    '</PB>';
        End If;
        n_Daycount := n_Daycount + 1;
      End Loop;
    End If;
    v_Temp := '<PBLIST>' || v_Temp || '</PBLIST>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Else
    --出诊表排班模式
    n_补充天数 := Zl_Fun_Getappointmentdays;
    If Nvl(n_科室id, 0) = 0 Then
      --通过医生查找
      While (n_Daycount < n_查询天数) Loop
        If Trunc(d_开始时间 + n_Daycount) < To_Date(Substr(v_启用时间, 1, Instr(v_启用时间, ' ') - 1), 'yyyy-mm-dd') Then
          n_安排存在 := 0;
          v_上班时间 := Null;
          n_总已挂数 := 0;
          n_已挂数   := 0;
          n_剩余数   := 0;
          n_限号数   := 0;
          n_已约数   := 0;
          n_限约数   := 0;
          For r_排班 In (Select d_开始时间 + n_Daycount As 日期, a.排班, a.限号数, a.限约数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数,
                              a.安排id, a.计划id, a.号码, a.号类
                       From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称,
                                     Ap.号码, Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数
                              
                              From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                            Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                            Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4',
                                                    Ap.周三, '5', Ap.周四, '6', Ap.周五, '7', Ap.周六, Null) As 排班,
                                            Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                     From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                                     Where Ap.科室id = Bm.Id(+) And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                           Ap.医生id = n_医生id And Ap.停用日期 Is Null And
                                           d_开始时间 + n_Daycount Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                           Nvl(Ap.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                           Xz.限制项目(+) =
                                           Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                                  '周三', '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                      (Select Rownum
                                            From 挂号安排停用状态 Ty
                                            Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                           Not Exists (Select Rownum
                                            From 挂号安排计划 Jh
                                            Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                                  d_开始时间 + n_Daycount Between
                                                  Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                  Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')))
                                     Union All
                                     Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id,
                                            Jh.Id As 计划id, Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                            Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4',
                                                    Jh.周三, '5', Jh.周四, '6', Jh.周五, '7', Jh.周六, Null) As 排班,
                                            Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                     From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                                     Where Jh.安排id = Ap.Id And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                           Ap.科室id = Bm.Id(+) And Ap.停用日期 Is Null And Jh.医生id = n_医生id And
                                           d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                           Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.计划id(+) = Jh.Id And
                                           Xz.限制项目(+) =
                                           Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                                  '周三', '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                      (Select Rownum
                                            From 挂号安排停用状态 Ty
                                            Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                           (Jh.生效时间, Jh.安排id) =
                                           (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                            From 挂号安排计划 Sxjh
                                            Where Sxjh.审核时间 Is Not Null And
                                                  d_开始时间 + n_Daycount Between
                                                  Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                  Nvl(Sxjh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Sxjh.安排id = Jh.安排id
                                            Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                              Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                            病人挂号汇总 Hz, 收费价目 B
                       Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_开始时间 + n_Daycount) And a.项目id = b.收费细目id And
                             b.终止日期 > d_开始时间 + n_Daycount And b.执行日期 <= d_开始时间 + n_Daycount
                       
                       ) Loop
            If v_号类 Is Null Or Instr(',' || v_号类 || ',', ',' || r_排班.号类 || ',') > 0 Then
              v_上班时间 := v_上班时间 || '+' || r_排班.排班;
              n_总已挂数 := n_总已挂数 + r_排班.已挂数;
              n_已挂数   := r_排班.已挂数;
              n_限号数   := r_排班.限号数;
              n_已约数   := r_排班.已约数;
              n_限约数   := r_排班.限约数;
              n_安排id   := Nvl(r_排班.安排id, 0);
              n_计划id   := Nvl(r_排班.计划id, 0);
              v_号码     := r_排班.号码;
              n_安排存在 := 1;
              If v_上班时间 Is Not Null Then
                If v_合作单位 Is Not Null Then
                  If n_计划id <> 0 Then
                    Begin
                      Select 1
                      Into n_合约存在
                      From 合作单位计划控制
                      Where 计划id = n_计划id And 合作单位 = v_合作单位 And Rownum < 2;
                    Exception
                      When Others Then
                        n_合约存在 := 0;
                    End;
                  Else
                    Begin
                      Select 1
                      Into n_合约存在
                      From 合作单位安排控制
                      Where 安排id = n_安排id And 合作单位 = v_合作单位 And Rownum < 2;
                    Exception
                      When Others Then
                        n_合约存在 := 0;
                    End;
                  End If;
                End If;
              
                If v_合作单位 Is Null Or Nvl(n_合约存在, 0) = 0 Then
                  If n_计划id <> 0 Then
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null);
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  Else
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null);
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  End If;
                  Begin
                    Select Count(1)
                    Into n_合约已挂数
                    From 病人挂号记录
                    Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                          Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                  Exception
                    When Others Then
                      n_合约已挂数 := 0;
                  End;
                  If n_合作单位数量 = 0 Then
                    n_合作单位数量 := Null;
                  End If;
                  If Trunc(d_开始时间 + n_Daycount) > Trunc(Sysdate) Then
                    n_剩余数 := Nvl(n_剩余数, 0) + n_限约数 - n_已约数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                  Else
                    n_剩余数 := Nvl(n_剩余数, 0) + n_限号数 - n_已挂数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                  End If;
                Else
                  --合约单位
                  If n_计划id <> 0 Then
                    Begin
                      Select 1
                      Into n_禁用
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                            Rownum < 2;
                    Exception
                      When Others Then
                        n_禁用 := 0;
                    End;
                  Else
                    Begin
                      Select 1
                      Into n_禁用
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                            Rownum < 2;
                    Exception
                      When Others Then
                        n_禁用 := 0;
                    End;
                  End If;
                  If Nvl(n_禁用, 0) = 0 Then
                    Begin
                      Select Count(1)
                      Into n_合约已挂数
                      From 病人挂号记录
                      Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                            Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                    Exception
                      When Others Then
                        n_合约已挂数 := 0;
                    End;
                    If n_计划id <> 0 Then
                      Begin
                        Select Sum(数量)
                        Into n_合作单位数量
                        From 合作单位计划控制
                        Where 计划id = n_计划id And
                              限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                            '周三', '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                      Exception
                        When Others Then
                          n_合作单位数量 := 0;
                      End;
                    Else
                      Begin
                        Select Sum(数量)
                        Into n_合作单位数量
                        From 合作单位安排控制
                        Where 安排id = n_安排id And
                              限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                            '周三', '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                      Exception
                        When Others Then
                          n_合作单位数量 := 0;
                      End;
                    End If;
                    If n_合作单位数量 = 0 Then
                      n_合作单位数量 := Null;
                    End If;
                    n_剩余数 := Nvl(n_剩余数, 0) + Nvl(n_合作单位数量, n_合约已挂数) - Nvl(n_合约已挂数, 0);
                  
                  End If;
                End If;
              End If;
              n_合作单位数量 := 0;
              n_合约存在     := 0;
              n_禁用         := 0;
            End If;
          End Loop;
          v_上班时间 := Substr(v_上班时间, 2);
          If n_安排存在 = 1 Then
            v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                      '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                      '</YGS>' || '</PB>';
          End If;
        Else
          n_安排存在 := 0;
          v_上班时间 := Null;
          n_总已挂数 := 0;
          n_已挂数   := 0;
          n_剩余数   := 0;
          n_限号数   := 0;
          n_已约数   := 0;
          n_限约数   := 0;
          If v_合作单位 Is Null Then
            --非合作单位
            If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
              --当天挂号
              For r_出诊 In (Select a.已挂数, a.限号数, a.上班时段
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And Exists
                            (Select 1
                                  From 临床出诊安排 M, 临床出诊表 N
                                  Where m.Id = a.安排id And m.出诊id = n.Id And n.发布时间 Is Not Null)) Loop
                n_已挂数   := n_已挂数 + Nvl(r_出诊.已挂数, 0);
                n_限号数   := n_限号数 + r_出诊.限号数;
                v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                n_安排存在 := 1;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_限号数 - n_已挂数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            Else
              --预约挂号
              For r_出诊 In (Select a.已约数, a.限号数, a.限约数, a.上班时段
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And Exists
                            (Select 1
                                  From 临床出诊安排 M, 临床出诊表 N
                                  Where m.Id = a.安排id And m.出诊id = n.Id And n.发布时间 Is Not Null)) Loop
                n_已挂数   := n_已挂数 + Nvl(r_出诊.已约数, 0);
                n_限号数   := n_限号数 + Nvl(r_出诊.限约数, r_出诊.限号数);
                v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                n_安排存在 := 1;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_限号数 - n_已挂数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            End If;
          Else
            --合作单位
            If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
              For r_出诊 In (Select a.Id, a.已挂数, a.限号数, a.限约数, a.上班时段, a.是否序号控制
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And Exists
                            (Select 1
                                  From 临床出诊安排 M, 临床出诊表 N
                                  Where m.Id = a.安排id And m.出诊id = n.Id And n.发布时间 Is Not Null)) Loop
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_限号数
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_限号数 := n_限号数 * Nvl(r_出诊.限约数, r_出诊.限号数) / 100;
                  End If;
                  Select Count(1)
                  Into n_已挂数
                  From 病人挂号记录
                  Where 出诊记录id = r_出诊.Id And 记录状态 = 1 And 合作单位 = v_合作单位;
                  If r_出诊.限号数 - r_出诊.已挂数 < n_限号数 - n_已挂数 Then
                    n_剩余数 := n_剩余数 + r_出诊.限号数 - r_出诊.已挂数;
                  Else
                    n_剩余数 := n_剩余数 + n_限号数 - n_已挂数;
                  End If;
                  n_总已挂数 := n_总已挂数 + n_已挂数;
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
                If n_合约模式 = 3 Then
                  If r_出诊.是否序号控制 = 0 Then
                    n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                    n_剩余数   := n_剩余数 + r_出诊.限号数 - Nvl(r_出诊.已挂数, 0);
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                    n_安排存在 := 1;
                  Else
                    For r_合作 In (Select 序号, 数量
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Begin
                        Select 1
                        Into n_Exists
                        From 临床出诊序号控制
                        Where 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0;
                      Exception
                        When Others Then
                          n_Exists := 0;
                      End;
                      If n_Exists = 1 Then
                        n_剩余数   := n_剩余数 + 1;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                    n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                  n_剩余数   := n_剩余数 + r_出诊.限号数 - Nvl(r_出诊.已挂数, 0);
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
              End Loop;
            
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            Else
              --非当天
              For r_出诊 In (Select a.Id, a.已约数, a.已挂数, a.限号数, a.限约数, a.上班时段, a.是否序号控制
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And Exists
                            (Select 1
                                  From 临床出诊安排 M, 临床出诊表 N
                                  Where m.Id = a.安排id And m.出诊id = n.Id And n.发布时间 Is Not Null)) Loop
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_限号数
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_限号数 := n_限号数 * Nvl(r_出诊.限约数, r_出诊.限号数) / 100;
                  End If;
                  Select Count(1)
                  Into n_已挂数
                  From 病人挂号记录
                  Where 出诊记录id = r_出诊.Id And 记录状态 = 1 And 合作单位 = v_合作单位;
                  If Nvl(r_出诊.限约数, r_出诊.限号数) - r_出诊.已约数 < n_限号数 - n_已挂数 Then
                    n_剩余数 := n_剩余数 + Nvl(r_出诊.限约数, r_出诊.限号数) - r_出诊.已约数;
                  Else
                    n_剩余数 := n_剩余数 + n_限号数 - n_已挂数;
                  End If;
                  n_总已挂数 := n_总已挂数 + n_已挂数;
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
                If n_合约模式 = 3 Then
                  If r_出诊.是否序号控制 = 0 Then
                    --分时段非序号控制
                    For r_合作 In (Select 序号, 数量
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Select Count(1)
                      Into n_Exists
                      From 临床出诊序号控制
                      Where 预约顺序号 Is Not Null And 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) <> 0;
                      If r_合作.数量 - n_Exists > 0 Then
                        n_剩余数   := n_剩余数 + r_合作.数量 - n_Exists;
                        n_总已挂数 := n_总已挂数 + n_Exists;
                        n_安排存在 := 1;
                      Else
                        n_总已挂数 := n_总已挂数 + n_Exists;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  Else
                    For r_合作 In (Select 序号
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Begin
                        Select 1
                        Into n_Exists
                        From 临床出诊序号控制
                        Where 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0;
                      Exception
                        When Others Then
                          n_Exists := 0;
                      End;
                      If n_Exists = 1 Then
                        n_剩余数   := n_剩余数 + 1;
                        n_安排存在 := 1;
                      Else
                        n_总已挂数 := n_总已挂数 + 1;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已约数, 0);
                  n_剩余数   := n_剩余数 + r_出诊.限约数 - Nvl(r_出诊.已约数, 0);
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            End If;
          End If;
        End If;
        n_Daycount := n_Daycount + 1;
      End Loop;
    Else
      --通过科室+医生查找
      While (n_Daycount < n_查询天数) Loop
        If Trunc(d_开始时间 + n_Daycount) < To_Date(Substr(v_启用时间, 1, Instr(v_启用时间, ' ') - 1), 'yyyy-mm-dd') Then
          v_上班时间 := Null;
          n_总已挂数 := 0;
          n_已挂数   := 0;
          n_剩余数   := 0;
          n_限号数   := 0;
          n_已约数   := 0;
          n_限约数   := 0;
          n_安排存在 := 0;
          For r_排班 In (Select d_开始时间 + n_Daycount As 日期, a.排班, a.限号数, a.限约数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数,
                              a.安排id, a.计划id, a.号码, a.号类
                       
                       From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称,
                                     Ap.号码, Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数
                              
                              From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                            Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                            Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4',
                                                    Ap.周三, '5', Ap.周四, '6', Ap.周五, '7', Ap.周六, Null) As 排班,
                                            Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                     From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                                     Where Ap.科室id = Bm.Id(+) And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                           Ap.医生id = n_医生id And Ap.科室id = n_科室id And Ap.停用日期 Is Null And
                                           d_开始时间 + n_Daycount Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                           Nvl(Ap.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                           Xz.限制项目(+) =
                                           Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                                  '周三', '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                      (Select Rownum
                                            From 挂号安排停用状态 Ty
                                            Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                           Not Exists (Select Rownum
                                            From 挂号安排计划 Jh
                                            Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                                  d_开始时间 + n_Daycount Between
                                                  Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                  Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')))
                                     Union All
                                     Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id,
                                            Jh.Id As 计划id, Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                            Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4',
                                                    Jh.周三, '5', Jh.周四, '6', Jh.周五, '7', Jh.周六, Null) As 排班,
                                            Nvl(Xz.限约数, Xz.限号数) As 限约数, Nvl(Xz.限号数, 0) As 限号数
                                     From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                                     Where Jh.安排id = Ap.Id And Sysdate + Nvl(Ap.预约天数, n_预约天数) >= d_开始时间 + n_Daycount And
                                           Ap.科室id = Bm.Id(+) And Ap.停用日期 Is Null And Jh.医生id = n_医生id And Ap.科室id = n_科室id And
                                           d_开始时间 + n_Daycount Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                           Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.计划id(+) = Jh.Id And
                                           Xz.限制项目(+) =
                                           Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                                  '周三', '5', '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                      (Select Rownum
                                            From 挂号安排停用状态 Ty
                                            Where Ty.安排id = Ap.Id And d_开始时间 + n_Daycount Between Ty.开始停止时间 And Ty.结束停止时间) And
                                           (Jh.生效时间, Jh.安排id) =
                                           (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                            From 挂号安排计划 Sxjh
                                            Where Sxjh.审核时间 Is Not Null And
                                                  d_开始时间 + n_Daycount Between
                                                  Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                                  Nvl(Sxjh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Sxjh.安排id = Jh.安排id
                                            Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                              Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                            病人挂号汇总 Hz, 收费价目 B
                       Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_开始时间 + n_Daycount) And a.项目id = b.收费细目id And
                             b.终止日期 > d_开始时间 + n_Daycount And b.执行日期 <= d_开始时间 + n_Daycount
                       
                       ) Loop
            If v_号类 Is Null Or Instr(',' || v_号类 || ',', ',' || r_排班.号类 || ',') > 0 Then
              v_上班时间 := v_上班时间 || '+' || r_排班.排班;
              n_总已挂数 := n_总已挂数 + r_排班.已挂数;
              n_已挂数   := r_排班.已挂数;
              n_限号数   := r_排班.限号数;
              n_已约数   := r_排班.已约数;
              n_限约数   := r_排班.限约数;
              n_安排id   := Nvl(r_排班.安排id, 0);
              n_计划id   := Nvl(r_排班.计划id, 0);
              v_号码     := r_排班.号码;
              n_安排存在 := 1;
            
              If v_上班时间 Is Not Null Then
                If v_合作单位 Is Not Null Then
                  If n_计划id <> 0 Then
                    Begin
                      Select 1
                      Into n_合约存在
                      From 合作单位计划控制
                      Where 计划id = n_计划id And 合作单位 = v_合作单位 And Rownum < 2;
                    Exception
                      When Others Then
                        n_合约存在 := 0;
                    End;
                  Else
                    Begin
                      Select 1
                      Into n_合约存在
                      From 合作单位安排控制
                      Where 安排id = n_安排id And 合作单位 = v_合作单位 And Rownum < 2;
                    Exception
                      When Others Then
                        n_合约存在 := 0;
                    End;
                  End If;
                End If;
              
                If v_合作单位 Is Null Or Nvl(n_合约存在, 0) = 0 Then
                  If n_计划id <> 0 Then
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null);
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  Else
                    Begin
                      Select Sum(数量)
                      Into n_合作单位数量
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null);
                    Exception
                      When Others Then
                        n_合作单位数量 := 0;
                    End;
                  End If;
                  Begin
                    Select Count(1)
                    Into n_合约已挂数
                    From 病人挂号记录
                    Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                          Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                  Exception
                    When Others Then
                      n_合约已挂数 := 0;
                  End;
                  If n_合作单位数量 = 0 Then
                    n_合作单位数量 := Null;
                  End If;
                  If Trunc(d_开始时间 + n_Daycount) > Trunc(Sysdate) Then
                    n_剩余数 := Nvl(n_剩余数, 0) + n_限约数 - n_已约数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                  Else
                    n_剩余数 := Nvl(n_剩余数, 0) + n_限号数 - n_已挂数 - Nvl(n_合作单位数量, n_合约已挂数) + Nvl(n_合约已挂数, 0);
                  End If;
                Else
                  --合约单位
                  If n_计划id <> 0 Then
                    Begin
                      Select 1
                      Into n_禁用
                      From 合作单位计划控制
                      Where 计划id = n_计划id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                            Rownum < 2;
                    Exception
                      When Others Then
                        n_禁用 := 0;
                    End;
                  Else
                    Begin
                      Select 1
                      Into n_禁用
                      From 合作单位安排控制
                      Where 安排id = n_安排id And
                            限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                          '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位 And 数量 = 0 And
                            Rownum < 2;
                    Exception
                      When Others Then
                        n_禁用 := 0;
                    End;
                  End If;
                  If Nvl(n_禁用, 0) = 0 Then
                    Begin
                      Select Count(1)
                      Into n_合约已挂数
                      From 病人挂号记录
                      Where 号别 = v_号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_开始时间 + n_Daycount) And
                            Trunc(d_开始时间 + n_Daycount + 1) - 1 / 60 / 60 / 24;
                    Exception
                      When Others Then
                        n_合约已挂数 := 0;
                    End;
                    If n_计划id <> 0 Then
                      Begin
                        Select Sum(数量)
                        Into n_合作单位数量
                        From 合作单位计划控制
                        Where 计划id = n_计划id And
                              限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                            '周三', '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                      Exception
                        When Others Then
                          n_合作单位数量 := 0;
                      End;
                    Else
                      Begin
                        Select Sum(数量)
                        Into n_合作单位数量
                        From 合作单位安排控制
                        Where 安排id = n_安排id And
                              限制项目 = Decode(To_Char(d_开始时间 + n_Daycount, 'D'), '1', '周日', '2', '周一', '3', '周二', '4',
                                            '周三', '5', '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
                      Exception
                        When Others Then
                          n_合作单位数量 := 0;
                      End;
                    End If;
                    If n_合作单位数量 = 0 Then
                      n_合作单位数量 := Null;
                    End If;
                    n_剩余数 := Nvl(n_剩余数, 0) + Nvl(n_合作单位数量, n_合约已挂数) - Nvl(n_合约已挂数, 0);
                  
                  End If;
                End If;
              End If;
              n_合作单位数量 := 0;
              n_合约存在     := 0;
              n_禁用         := 0;
            End If;
          End Loop;
          v_上班时间 := Substr(v_上班时间, 2);
          If n_安排存在 = 1 Then
            v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                      '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                      '</YGS>' || '</PB>';
          End If;
        Else
          n_安排存在 := 0;
          v_上班时间 := Null;
          n_总已挂数 := 0;
          n_已挂数   := 0;
          n_剩余数   := 0;
          n_限号数   := 0;
          n_已约数   := 0;
          n_限约数   := 0;
          If v_合作单位 Is Null Then
            --非合作单位
            If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
              --当天挂号
              For r_出诊 In (Select a.已挂数, a.限号数, a.上班时段
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 a.科室id = n_科室id And (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And Exists
                            (Select 1
                                  From 临床出诊安排 M, 临床出诊表 N
                                  Where m.Id = a.安排id And m.出诊id = n.Id And n.发布时间 Is Not Null)) Loop
                n_已挂数   := n_已挂数 + Nvl(r_出诊.已挂数, 0);
                n_限号数   := n_限号数 + r_出诊.限号数;
                v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                n_安排存在 := 1;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_限号数 - n_已挂数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            Else
              --预约挂号
              For r_出诊 In (Select a.已约数, a.限号数, a.限约数, a.上班时段
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 a.科室id = n_科室id And (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And Exists
                            (Select 1
                                  From 临床出诊安排 M, 临床出诊表 N
                                  Where m.Id = a.安排id And m.出诊id = n.Id And n.发布时间 Is Not Null)) Loop
                n_已挂数   := n_已挂数 + Nvl(r_出诊.已约数, 0);
                n_限号数   := n_限号数 + Nvl(r_出诊.限约数, r_出诊.限号数);
                v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                n_安排存在 := 1;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_限号数 - n_已挂数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            End If;
          Else
            --合作单位
            If Trunc(d_开始时间 + n_Daycount) = Trunc(Sysdate) Then
              For r_出诊 In (Select a.Id, a.已挂数, a.限号数, a.限约数, a.上班时段, a.是否序号控制
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 a.科室id = n_科室id And (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And Exists
                            (Select 1
                                  From 临床出诊安排 M, 临床出诊表 N
                                  Where m.Id = a.安排id And m.出诊id = n.Id And n.发布时间 Is Not Null)) Loop
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_限号数
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_限号数 := n_限号数 * Nvl(r_出诊.限约数, r_出诊.限号数) / 100;
                  End If;
                  Select Count(1)
                  Into n_已挂数
                  From 病人挂号记录
                  Where 出诊记录id = r_出诊.Id And 记录状态 = 1 And 合作单位 = v_合作单位;
                  If r_出诊.限号数 - r_出诊.已挂数 < n_限号数 - n_已挂数 Then
                    n_剩余数 := n_剩余数 + r_出诊.限号数 - r_出诊.已挂数;
                  Else
                    n_剩余数 := n_剩余数 + n_限号数 - n_已挂数;
                  End If;
                  n_总已挂数 := n_总已挂数 + n_已挂数;
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
                If n_合约模式 = 3 Then
                  If r_出诊.是否序号控制 = 0 Then
                    n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                    n_剩余数   := n_剩余数 + r_出诊.限号数 - Nvl(r_出诊.已挂数, 0);
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                    n_安排存在 := 1;
                  Else
                    For r_合作 In (Select 序号, 数量
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Begin
                        Select 1
                        Into n_Exists
                        From 临床出诊序号控制
                        Where 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0;
                      Exception
                        When Others Then
                          n_Exists := 0;
                      End;
                      If n_Exists = 1 Then
                        n_剩余数   := n_剩余数 + 1;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                    n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已挂数, 0);
                  n_剩余数   := n_剩余数 + r_出诊.限号数 - Nvl(r_出诊.已挂数, 0);
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
              End Loop;
            
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            Else
              --非当天
              For r_出诊 In (Select a.Id, a.已约数, a.已挂数, a.限号数, a.限约数, a.上班时段, a.是否序号控制
                           From 临床出诊记录 A, 临床出诊号源 B
                           Where a.出诊日期 = Trunc(d_开始时间 + n_Daycount) And a.号源id = b.Id And
                                 Sysdate + Nvl(b.预约天数, n_预约天数) + n_补充天数 >= d_开始时间 + n_Daycount And a.医生id = n_医生id And
                                 a.科室id = n_科室id And (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间)) And
                                 Nvl(a.是否锁定, 0) = 0 And Exists
                            (Select 1
                                  From 临床出诊安排 M, 临床出诊表 N
                                  Where m.Id = a.安排id And m.出诊id = n.Id And n.发布时间 Is Not Null)) Loop
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_限号数
                  From 临床出诊挂号控制记录
                  Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_限号数 := n_限号数 * Nvl(r_出诊.限约数, r_出诊.限号数) / 100;
                  End If;
                  Select Count(1)
                  Into n_已挂数
                  From 病人挂号记录
                  Where 出诊记录id = r_出诊.Id And 记录状态 = 1 And 合作单位 = v_合作单位;
                  If Nvl(r_出诊.限约数, r_出诊.限号数) - r_出诊.已约数 < n_限号数 - n_已挂数 Then
                    n_剩余数 := n_剩余数 + Nvl(r_出诊.限约数, r_出诊.限号数) - r_出诊.已约数;
                  Else
                    n_剩余数 := n_剩余数 + n_限号数 - n_已挂数;
                  End If;
                  n_总已挂数 := n_总已挂数 + n_已挂数;
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
                If n_合约模式 = 3 Then
                  If r_出诊.是否序号控制 = 0 Then
                    --分时段非序号控制
                    For r_合作 In (Select 序号, 数量
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Select Count(1)
                      Into n_Exists
                      From 临床出诊序号控制
                      Where 预约顺序号 Is Not Null And 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) <> 0;
                      If r_合作.数量 - n_Exists > 0 Then
                        n_剩余数   := n_剩余数 + r_合作.数量 - n_Exists;
                        n_总已挂数 := n_总已挂数 + n_Exists;
                        n_安排存在 := 1;
                      Else
                        n_总已挂数 := n_总已挂数 + n_Exists;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  Else
                    For r_合作 In (Select 序号
                                 From 临床出诊挂号控制记录
                                 Where 记录id = r_出诊.Id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1) Loop
                      Begin
                        Select 1
                        Into n_Exists
                        From 临床出诊序号控制
                        Where 记录id = r_出诊.Id And 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0;
                      Exception
                        When Others Then
                          n_Exists := 0;
                      End;
                      If n_Exists = 1 Then
                        n_剩余数   := n_剩余数 + 1;
                        n_安排存在 := 1;
                      Else
                        n_总已挂数 := n_总已挂数 + 1;
                        n_安排存在 := 1;
                      End If;
                    End Loop;
                    v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  n_总已挂数 := n_总已挂数 + Nvl(r_出诊.已约数, 0);
                  n_剩余数   := n_剩余数 + r_出诊.限约数 - Nvl(r_出诊.已约数, 0);
                  v_上班时间 := v_上班时间 || '+' || r_出诊.上班时段;
                  n_安排存在 := 1;
                End If;
              End Loop;
              If v_上班时间 Is Not Null Then
                v_上班时间 := Substr(v_上班时间, 2);
              End If;
              If n_安排存在 = 1 Then
                v_Temp := v_Temp || '<PB>' || '<RQ>' || To_Char(Trunc(d_开始时间 + n_Daycount), 'YYYY-MM-DD') || '</RQ>' ||
                          '<SYHS>' || n_剩余数 || '</SYHS>' || '<SBSJ>' || v_上班时间 || '</SBSJ>' || '<YGS>' || n_总已挂数 ||
                          '</YGS>' || '</PB>';
              End If;
            End If;
          End If;
        End If;
        n_Daycount := n_Daycount + 1;
      End Loop;
    End If;
    v_Temp := '<PBLIST>' || v_Temp || '</PBLIST>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  End If;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Docarrange;
/

--106912:刘尔旋,2017-03-10,新挂号安排可预约天数调整
Create Or Replace Procedure Zl_Third_Getdeptlist
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取可挂号科室

  --入参:Xml_In:
  --<IN>
  --  <CXTS>14</CXTS>        //查询天数
  --  <HZDW>支付宝</HZDW>    //合作单位
  --  <ZD></ZD>              //站点
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  -- <KSLIST>
  --  <KS>
  --    <ID>科室ID</ID>       //科室ID
  --    <MC>科室名称</MC>     //科室名称
  --    <ZDYYTS>最大可预约天数</ZDYYTS>     //最大可预约天数
  --  </KS>
  --  <KS>
  --    ...
  --  </KS>
  -- </KSLIST>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_Temp      Varchar(5000); --临时XML
  x_Templet   Xmltype; --模板XML
  v_Para      Varchar2(4000);
  n_查询天数  Number(5);
  n_预约天数  Number(5);
  n_天数补充  Number(5);
  n_Add_Lists Number(3);
  v_合作单位  合作单位安排控制.合作单位%Type;
  n_站点      部门表.站点%Type;
  v_Err_Msg   Varchar2(200);
  d_启用时间  Date;
  Err_Item Exception;
  n_挂号模式 Number(3);
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/CXTS'), Extractvalue(Value(A), 'IN/HZDW'), Extractvalue(Value(A), 'IN/ZD')
  Into n_查询天数, v_合作单位, n_站点
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  v_Para     := zl_GetSysParameter('挂号排班模式');
  n_预约天数 := zl_GetSysParameter(66);
  n_挂号模式 := To_Number(Substr(v_Para, 1, 1));
  If n_挂号模式 = 1 Then
    Begin
      d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
    Exception
      When Others Then
        d_启用时间 := Null;
    End;
  End If;
  If n_挂号模式 = 0 Then
    If n_查询天数 Is Null Then
      If v_合作单位 Is Null Then
        For r_Dept In (Select Distinct a.科室id, b.名称, Max(Nvl(a.预约天数, n_预约天数)) As 预约天数
                       From 挂号安排 A, 部门表 B
                       Where a.停用日期 Is Null And a.科室id = b.Id And (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null)
                       Group By a.科室id, b.名称) Loop
          If Nvl(n_Add_Lists, 0) = 0 Then
            --增加DJList节点
            Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<KSLIST></KSLIST>')) Into x_Templet From Dual;
            n_Add_Lists := 1;
          End If;
          v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>' || '<ZDYYTS>' ||
                    r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
          Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        End Loop;
      Else
        For r_Dept In (Select 科室id, 名称, Max(预约天数) As 预约天数
                       From (Select b.科室id, d.名称, Max(a.预约天数) As 预约天数
                              From (Select a.Id, Nvl(a.预约天数, n_预约天数) As 预约天数
                                     From 挂号安排 A
                                     Where a.停用日期 Is Null And Not Exists
                                      (Select 1 From 合作单位安排控制 Where 安排id = a.Id And 合作单位 = v_合作单位)
                                     Union All
                                     Select a.Id, Nvl(a.预约天数, n_预约天数) As 预约天数
                                     From 挂号安排 A, 合作单位安排控制 B
                                     Where a.停用日期 Is Null And 合作单位 = v_合作单位 And a.Id = b.安排id And b.数量 <> 0) A, 挂号安排 B,
                                   挂号安排计划 C, 部门表 D
                              Where a.Id = b.Id And c.安排id = a.Id And c.审核时间 Is Not Null And
                                    ((c.生效时间 < Sysdate And c.失效时间 > Sysdate + a.预约天数) Or
                                    (c.生效时间 Between Sysdate And Sysdate + a.预约天数) Or
                                    (c.失效时间 Between Sysdate And Sysdate + a.预约天数)) And Not Exists
                               (Select 1
                                     From 合作单位计划控制
                                     Where 计划id = c.Id And 合作单位 = v_合作单位 And 数量 = 0) And b.科室id = d.Id And
                                    (d.站点 = Nvl(n_站点, 0) Or d.站点 Is Null) And
                                    (Sysdate Between d.建档时间 And d.撤档时间 Or Sysdate >= d.建档时间 And d.撤档时间 Is Null)
                              Group By b.科室id, d.名称
                              Union All
                              Select b.科室id, d.名称, Max(a.预约天数) As 预约天数
                              From (Select a.Id, Nvl(a.预约天数, n_预约天数) As 预约天数
                                     From 挂号安排 A
                                     Where a.停用日期 Is Null And Not Exists
                                      (Select 1 From 合作单位安排控制 Where 安排id = a.Id And 合作单位 = v_合作单位)
                                     Union All
                                     Select a.Id, Nvl(a.预约天数, n_预约天数) As 预约天数
                                     From 挂号安排 A, 合作单位安排控制 B
                                     Where a.停用日期 Is Null And 合作单位 = v_合作单位 And a.Id = b.安排id And b.数量 <> 0) A, 挂号安排 B,
                                   部门表 D
                              Where a.Id = b.Id And Not Exists
                               (Select 1 From 挂号安排计划 Where 安排id = a.Id And Rownum < 2) And b.科室id = d.Id And
                                    (d.站点 = Nvl(n_站点, 0) Or d.站点 Is Null) And
                                    (Sysdate Between d.建档时间 And d.撤档时间 Or Sysdate >= d.建档时间 And d.撤档时间 Is Null)
                              Group By b.科室id, d.名称)
                       Group By 科室id, 名称) Loop
          If Nvl(n_Add_Lists, 0) = 0 Then
            --增加DJList节点
            Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<KSLIST></KSLIST>')) Into x_Templet From Dual;
            n_Add_Lists := 1;
          End If;
          v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>' || '<ZDYYTS>' ||
                    r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
          Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        End Loop;
      End If;
    Else
      If v_合作单位 Is Null Then
        For r_Dept In (Select Distinct a.科室id, b.名称, Max(Nvl(a.预约天数, n_预约天数)) As 预约天数
                       From 挂号安排 A, 部门表 B
                       Where a.停用日期 Is Null And a.科室id = b.Id And (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null)
                       Group By a.科室id, b.名称) Loop
        
          If Nvl(n_Add_Lists, 0) = 0 Then
            --增加DJList节点
            Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<KSLIST></KSLIST>')) Into x_Templet From Dual;
            n_Add_Lists := 1;
          End If;
          v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>' || '<ZDYYTS>' ||
                    r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
          Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        End Loop;
      Else
        For r_Dept In (Select 科室id, 名称, Max(预约天数) As 预约天数
                       From (Select b.科室id, d.名称, Max(a.预约天数) As 预约天数
                              From (Select a.Id, Nvl(a.预约天数, n_预约天数) As 预约天数
                                     From 挂号安排 A
                                     Where a.停用日期 Is Null And Not Exists
                                      (Select 1 From 合作单位安排控制 Where 安排id = a.Id And 合作单位 = v_合作单位)
                                     Union All
                                     Select a.Id, Nvl(a.预约天数, n_预约天数) As 预约天数
                                     From 挂号安排 A, 合作单位安排控制 B
                                     Where a.停用日期 Is Null And 合作单位 = v_合作单位 And a.Id = b.安排id And b.数量 <> 0) A, 挂号安排 B,
                                   挂号安排计划 C, 部门表 D
                              Where a.Id = b.Id And c.安排id = a.Id And c.审核时间 Is Not Null And
                                    ((c.生效时间 < Sysdate And c.失效时间 > Sysdate + n_查询天数) Or
                                    (c.生效时间 Between Sysdate And Sysdate + n_查询天数) Or
                                    (c.失效时间 Between Sysdate And Sysdate + n_查询天数)) And Not Exists
                               (Select 1
                                     From 合作单位计划控制
                                     Where 计划id = c.Id And 合作单位 = v_合作单位 And 数量 = 0) And b.科室id = d.Id And
                                    (d.站点 = Nvl(n_站点, 0) Or d.站点 Is Null) And
                                    (Sysdate Between d.建档时间 And d.撤档时间 Or Sysdate >= d.建档时间 And d.撤档时间 Is Null)
                              Group By b.科室id, d.名称
                              Union All
                              Select b.科室id, d.名称, Max(a.预约天数) As 预约天数
                              From (Select a.Id, Nvl(a.预约天数, n_预约天数) As 预约天数
                                     From 挂号安排 A
                                     Where a.停用日期 Is Null And Not Exists
                                      (Select 1 From 合作单位安排控制 Where 安排id = a.Id And 合作单位 = v_合作单位)
                                     Union All
                                     Select a.Id, Nvl(a.预约天数, n_预约天数) As 预约天数
                                     From 挂号安排 A, 合作单位安排控制 B
                                     Where a.停用日期 Is Null And 合作单位 = v_合作单位 And a.Id = b.安排id And b.数量 <> 0) A, 挂号安排 B,
                                   部门表 D
                              Where a.Id = b.Id And Not Exists
                               (Select 1 From 挂号安排计划 Where 安排id = a.Id And Rownum < 2) And b.科室id = d.Id And
                                    (d.站点 = Nvl(n_站点, 0) Or d.站点 Is Null) And
                                    (Sysdate Between d.建档时间 And d.撤档时间 Or Sysdate >= d.建档时间 And d.撤档时间 Is Null)
                              Group By b.科室id, d.名称)
                       Group By 科室id, 名称) Loop
          If Nvl(n_Add_Lists, 0) = 0 Then
            --增加DJList节点
            Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<KSLIST></KSLIST>')) Into x_Templet From Dual;
            n_Add_Lists := 1;
          End If;
          v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>' || '<ZDYYTS>' ||
                    r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
          Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        End Loop;
      End If;
    End If;
  Else
    --出诊表排班模式
    n_天数补充 := Zl_Fun_Getappointmentdays;
    If n_查询天数 Is Null Then
      If v_合作单位 Is Null Then
        For r_Dept In (Select 科室id, 名称, Max(预约天数) As 预约天数
                       From (Select 科室id, 名称, 预约天数
                              From (Select a.科室id, b.名称, Nvl(a.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                     From 挂号安排 A, 部门表 B
                                     Where a.停用日期 Is Null And a.科室id = b.Id And (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null) And
                                           Sysdate < d_启用时间
                                     Union
                                     Select a.科室id, b.名称, Nvl(c.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                     From 临床出诊记录 A, 部门表 B, 临床出诊号源 C
                                     Where a.号源id = c.Id And a.开始时间 > d_启用时间 And a.出诊日期 >= Trunc(Sysdate) And
                                           a.出诊日期 <= Trunc(Sysdate + Nvl(c.预约天数, n_预约天数) + Zl_Fun_Getappointmentdays) And
                                           Nvl(a.是否发布, 0) = 1 And a.科室id = b.Id And (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null)))
                       Group By 科室id, 名称) Loop
          If Nvl(n_Add_Lists, 0) = 0 Then
            Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<KSLIST></KSLIST>')) Into x_Templet From Dual;
            n_Add_Lists := 1;
          End If;
          v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>' || '<ZDYYTS>' ||
                    r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
          Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        End Loop;
      Else
        For r_Dept In (Select 科室id, 名称, Max(预约天数) As 预约天数
                       From (Select 科室id, 名称, 预约天数
                              From (Select b.科室id, d.名称, a.预约天数
                                     From (Select a.Id, Nvl(a.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                            From 挂号安排 A
                                            Where a.停用日期 Is Null And Not Exists
                                             (Select 1 From 合作单位安排控制 Where 安排id = a.Id And 合作单位 = v_合作单位)
                                            Union All
                                            Select a.Id, Nvl(a.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                            From 挂号安排 A, 合作单位安排控制 B
                                            Where a.停用日期 Is Null And 合作单位 = v_合作单位 And a.Id = b.安排id And b.数量 <> 0) A, 挂号安排 B,
                                          挂号安排计划 C, 部门表 D
                                     Where a.Id = b.Id And Sysdate < d_启用时间 And c.安排id = a.Id And c.审核时间 Is Not Null And
                                           ((c.生效时间 < Sysdate And c.失效时间 > Sysdate + a.预约天数 + n_天数补充) Or
                                           (c.生效时间 Between Sysdate And Sysdate + a.预约天数 + n_天数补充) Or
                                           (c.失效时间 Between Sysdate And Sysdate + a.预约天数 + n_天数补充)) And Not Exists
                                      (Select 1
                                            From 合作单位计划控制
                                            Where 计划id = c.Id And 合作单位 = v_合作单位 And 数量 = 0) And b.科室id = d.Id And
                                           (d.站点 = Nvl(n_站点, 0) Or d.站点 Is Null) And
                                           (Sysdate Between d.建档时间 And d.撤档时间 Or Sysdate >= d.建档时间 And d.撤档时间 Is Null)
                                     Union All
                                     Select b.科室id, d.名称, a.预约天数
                                     From (Select a.Id, Nvl(a.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                            From 挂号安排 A
                                            Where a.停用日期 Is Null And Not Exists
                                             (Select 1 From 合作单位安排控制 Where 安排id = a.Id And 合作单位 = v_合作单位)
                                            Union All
                                            Select a.Id, Nvl(a.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                            From 挂号安排 A, 合作单位安排控制 B
                                            Where a.停用日期 Is Null And 合作单位 = v_合作单位 And a.Id = b.安排id And b.数量 <> 0) A, 挂号安排 B,
                                          部门表 D
                                     Where a.Id = b.Id And Sysdate < d_启用时间 And Not Exists
                                      (Select 1 From 挂号安排计划 Where 安排id = a.Id And Rownum < 2) And b.科室id = d.Id And
                                           (d.站点 = Nvl(n_站点, 0) Or d.站点 Is Null) And
                                           (Sysdate Between d.建档时间 And d.撤档时间 Or Sysdate >= d.建档时间 And d.撤档时间 Is Null))
                              Union
                              Select 科室id, 名称, 预约天数
                              From (Select a.科室id, b.名称, Nvl(c.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                     From 临床出诊记录 A, 部门表 B, 临床出诊号源 C
                                     Where a.号源id = c.Id And a.开始时间 > d_启用时间 And a.出诊日期 >= Trunc(Sysdate) And
                                           a.出诊日期 <= Trunc(Sysdate + Nvl(c.预约天数, n_预约天数) + n_天数补充) And Nvl(a.是否发布, 0) = 1 And
                                           a.科室id = b.Id And (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null) And Not Exists
                                      (Select 1 From 临床出诊挂号控制记录 Where 记录id = a.Id And 性质 = 1 And 类型 = 1)
                                     Union
                                     Select a.科室id, b.名称, Nvl(c.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                     From 临床出诊记录 A, 部门表 B, 临床出诊号源 C
                                     Where a.号源id = c.Id And a.开始时间 > d_启用时间 And a.出诊日期 >= Trunc(Sysdate) And
                                           a.出诊日期 <= Trunc(Sysdate + Nvl(c.预约天数, n_预约天数) + n_天数补充) And Nvl(a.是否发布, 0) = 1 And
                                           a.科室id = b.Id And (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null) And Exists
                                      (Select 1
                                            From 临床出诊挂号控制记录
                                            Where 记录id = a.Id And 名称 = v_合作单位 And 性质 = 1 And 类型 = 1 And 控制方式 <> 0)))
                       Group By 科室id, 名称) Loop
          If Nvl(n_Add_Lists, 0) = 0 Then
            Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<KSLIST></KSLIST>')) Into x_Templet From Dual;
            n_Add_Lists := 1;
          End If;
          v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>' || '<ZDYYTS>' ||
                    r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
          Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        End Loop;
      End If;
    Else
      If v_合作单位 Is Null Then
        For r_Dept In (Select 科室id, 名称, Max(预约天数) As 预约天数
                       From (Select 科室id, 名称, 预约天数
                              From (Select a.科室id, b.名称, Nvl(a.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                     From 挂号安排 A, 部门表 B
                                     Where a.停用日期 Is Null And a.科室id = b.Id And (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null) And
                                           Sysdate < d_启用时间
                                     Union
                                     Select a.科室id, b.名称, Nvl(c.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                     From 临床出诊记录 A, 部门表 B, 临床出诊号源 C
                                     Where a.出诊日期 >= Trunc(Sysdate) And a.号源id = c.Id And a.开始时间 > d_启用时间 And
                                           a.出诊日期 <= Trunc(Sysdate + n_查询天数) And Nvl(a.是否发布, 0) = 1 And a.科室id = b.Id And
                                           (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null)))
                       Group By 科室id, 名称) Loop
          If Nvl(n_Add_Lists, 0) = 0 Then
            Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<KSLIST></KSLIST>')) Into x_Templet From Dual;
            n_Add_Lists := 1;
          End If;
          v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>' || '<ZDYYTS>' ||
                    r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
          Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        End Loop;
      Else
        For r_Dept In (Select 科室id, 名称, Max(预约天数) As 预约天数
                       From (Select 科室id, 名称, 预约天数
                              From (Select b.科室id, d.名称, a.预约天数
                                     From (Select a.Id, Nvl(a.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                            From 挂号安排 A
                                            Where a.停用日期 Is Null And Not Exists
                                             (Select 1 From 合作单位安排控制 Where 安排id = a.Id And 合作单位 = v_合作单位)
                                            Union All
                                            Select a.Id, Nvl(a.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                            From 挂号安排 A, 合作单位安排控制 B
                                            Where a.停用日期 Is Null And 合作单位 = v_合作单位 And a.Id = b.安排id And b.数量 <> 0) A, 挂号安排 B,
                                          挂号安排计划 C, 部门表 D
                                     Where a.Id = b.Id And Sysdate < d_启用时间 And c.安排id = a.Id And c.审核时间 Is Not Null And
                                           ((c.生效时间 < Sysdate And c.失效时间 > Sysdate + n_查询天数) Or
                                           (c.生效时间 Between Sysdate And Sysdate + n_查询天数) Or
                                           (c.失效时间 Between Sysdate And Sysdate + n_查询天数)) And Not Exists
                                      (Select 1
                                            From 合作单位计划控制
                                            Where 计划id = c.Id And 合作单位 = v_合作单位 And 数量 = 0) And b.科室id = d.Id And
                                           (d.站点 = Nvl(n_站点, 0) Or d.站点 Is Null) And
                                           (Sysdate Between d.建档时间 And d.撤档时间 Or Sysdate >= d.建档时间 And d.撤档时间 Is Null)
                                     Union All
                                     Select b.科室id, d.名称, a.预约天数
                                     From (Select a.Id, Nvl(a.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                            From 挂号安排 A
                                            Where a.停用日期 Is Null And Not Exists
                                             (Select 1 From 合作单位安排控制 Where 安排id = a.Id And 合作单位 = v_合作单位)
                                            Union All
                                            Select a.Id, Nvl(a.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                            From 挂号安排 A, 合作单位安排控制 B
                                            Where a.停用日期 Is Null And 合作单位 = v_合作单位 And a.Id = b.安排id And b.数量 <> 0) A, 挂号安排 B,
                                          部门表 D
                                     Where a.Id = b.Id And Sysdate < d_启用时间 And Not Exists
                                      (Select 1 From 挂号安排计划 Where 安排id = a.Id And Rownum < 2) And b.科室id = d.Id And
                                           (d.站点 = Nvl(n_站点, 0) Or d.站点 Is Null) And
                                           (Sysdate Between d.建档时间 And d.撤档时间 Or Sysdate >= d.建档时间 And d.撤档时间 Is Null))
                              Union
                              Select 科室id, 名称, 预约天数
                              From (Select a.科室id, b.名称, Nvl(c.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                     From 临床出诊记录 A, 部门表 B, 临床出诊号源 C
                                     Where a.出诊日期 >= Trunc(Sysdate) And a.号源id = c.Id And a.开始时间 > d_启用时间 And
                                           a.出诊日期 <= Trunc(Sysdate + n_查询天数) And Nvl(a.是否发布, 0) = 1 And a.科室id = b.Id And
                                           (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null) And Not Exists
                                      (Select 1 From 临床出诊挂号控制记录 Where 记录id = a.Id And 性质 = 1 And 类型 = 1)
                                     Union
                                     Select a.科室id, b.名称, Nvl(c.预约天数, n_预约天数) + n_天数补充 As 预约天数
                                     From 临床出诊记录 A, 部门表 B, 临床出诊号源 C
                                     Where a.出诊日期 >= Trunc(Sysdate) And a.号源id = c.Id And a.开始时间 > d_启用时间 And
                                           a.出诊日期 <= Trunc(Sysdate + n_查询天数) And Nvl(a.是否发布, 0) = 1 And a.科室id = b.Id And
                                           (b.站点 = Nvl(n_站点, 0) Or b.站点 Is Null) And Exists
                                      (Select 1
                                            From 临床出诊挂号控制记录
                                            Where 记录id = a.Id And 名称 = v_合作单位 And 性质 = 1 And 类型 = 1 And 控制方式 <> 0)))
                       Group By 科室id, 名称) Loop
          If Nvl(n_Add_Lists, 0) = 0 Then
            Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype('<KSLIST></KSLIST>')) Into x_Templet From Dual;
            n_Add_Lists := 1;
          End If;
          v_Temp := '<KS>' || '<ID>' || r_Dept.科室id || '</ID>' || '<MC>' || r_Dept.名称 || '</MC>' || '<ZDYYTS>' ||
                    r_Dept.预约天数 || '</ZDYYTS>' || '</KS>';
          Select Appendchildxml(x_Templet, '/OUTPUT/KSLIST', Xmltype(v_Temp)) Into x_Templet From Dual;
        End Loop;
      End If;
    End If;
  End If;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getdeptlist;
/

--106722:冉俊明,2017-04-25,退费在处理药品库存时，收费项目未按药品ID排序，可能会导致死锁发生。
Create Or Replace Procedure Zl_门诊划价记录_Clear(Day_In Number) As
  --功能：自动清除划价单
  --参数：Day_IN=删除划价后超过Day_IN天未收费的单据
  Cursor c_Price Is
  --必须按照“收费细目id”升序排序，防止并发锁“药品库存”表
    Select a.Id, a.No, a.序号, a.医嘱序号, a.收费类别, a.执行部门id, a.收费细目id, Nvl(a.付数, 1) * a.数次 As 数量
    From 门诊费用记录 A, 未发药品记录 B
    Where a.记录性质 = 1 And a.记录状态 = 0 And a.执行状态 Not In (1, 2) And a.划价人 Is Not Null And a.操作员姓名 Is Null And
          b.单据 In (8, 24) And Nvl(b.已收费, 0) = 0 And a.No = b.No And Nvl(a.执行部门id, 0) = Nvl(b.库房id, 0) And
          Sysdate - b.填制日期 >= Day_In
    Order By a.No, a.收费细目id;

  --一个单据提交一次
  v_No     门诊费用记录.No%Type;
  l_医嘱id t_Numlist := t_Numlist();
  v_医嘱id Varchar2(4000);

  Procedure 医嘱信息_Update
  (
    No_In     门诊费用记录.No%Type,
    医嘱id_In t_Numlist
  ) As
    --删除病人医嘱附费,调整计费状态
    n_Count Number;
  Begin
    --病人医嘱附费
    If 医嘱id_In Is Not Null Then
      For I In 1 .. 医嘱id_In.Count Loop
        Select Count(1)
        Into n_Count
        From 门诊费用记录
        Where 记录性质 = 1 And 记录状态 = 0 And NO = No_In And 医嘱序号 = 医嘱id_In(I) And Rownum < 2;
        If n_Count = 0 Then
          Delete From 病人医嘱附费 Where 医嘱id = 医嘱id_In(I) And NO = No_In And 记录性质 = 1;
        End If;
      End Loop;
    End If;
  
    --医嘱处理
    --场合_In    Integer:=0, --0:门诊;1-住院
    --性质_In    Integer:=1, --1-收费单;2-记帐单
    --操作_In    Integer:=0, --0:删除划价单;1-收费或记帐;2-退费或销帐
    --No_In      门诊费用记录.No%Type,
    --医嘱ids_In Varchar2 := Null
    Zl_医嘱发送_计费状态_Update(0, 1, 0, No_In);
  End 医嘱信息_Update;

  Procedure 费用序号_Update(No_In 门诊费用记录.No%Type) As
    --重新调整剩余费用费用记录的序号
    --该游标用于处理费用记录序号
    Cursor c_Serial Is
      Select ID, 价格父号 From 门诊费用记录 Where 记录性质 = 1 And 记录状态 = 0 And NO = No_In Order By 序号;
  
    n_序号 门诊费用记录.序号%Type;
    n_父号 门诊费用记录.价格父号%Type;
  Begin
    n_序号 := 1;
    For r_Serial In c_Serial Loop
      If r_Serial.价格父号 Is Null Then
        n_父号 := n_序号;
      End If;
      Update 门诊费用记录 Set 序号 = n_序号, 价格父号 = Decode(价格父号, Null, Null, n_父号) Where ID = r_Serial.Id;
    
      n_序号 := n_序号 + 1;
    End Loop;
  End 费用序号_Update;
Begin
  For r_Price In c_Price Loop
    If v_No Is Not Null And v_No <> r_Price.No Then
      If l_医嘱id.Count <> 0 Then
        --删除病人医嘱附费,调整计费状态
        医嘱信息_Update(v_No, l_医嘱id);
      End If;
      费用序号_Update(v_No);
      Commit;
    
      l_医嘱id.Delete;
      v_医嘱id := '';
      v_No     := '';
    End If;
  
    --费用部份
    Delete From 门诊费用记录 Where ID = r_Price.Id;
    If Sql%RowCount <> 0 Then
      --药品部份
      If Instr(',4,5,6,7,', ',' || r_Price.收费类别 || ',') > 0 Then
        Zl_药品收发记录_销售退费(r_Price.Id);
      End If;
    End If;
  
    v_No := r_Price.No;
    If Nvl(r_Price.医嘱序号, 0) <> 0 Then
      If Instr(v_医嘱id || ',', ',' || r_Price.医嘱序号 || ',') = 0 Then
        l_医嘱id.Extend;
        l_医嘱id(l_医嘱id.Count) := r_Price.医嘱序号;
        v_医嘱id := v_医嘱id || ',' || r_Price.医嘱序号;
      End If;
    End If;
  End Loop;

  If v_No Is Not Null Then
    If l_医嘱id.Count <> 0 Then
      --删除病人医嘱附费,调整计费状态
      医嘱信息_Update(v_No, l_医嘱id);
    End If;
    费用序号_Update(v_No);
    Commit;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊划价记录_Clear;
/

--106722:冉俊明,2017-03-10,退费在处理药品库存时，收费项目未按药品ID排序，可能会导致死锁发生。
Create Or Replace Procedure Zl_门诊划价记录_Delete
(
  No_In   门诊费用记录.No%Type,
  序号_In Varchar2 := Null --主要用于门诊医生站作废单个药品
) As
  --功能：删除一张门诊划价单据
  --该游标用于处理费用记录序号
  Cursor c_Serial Is
    Select ID, 价格父号 From 门诊费用记录 Where NO = No_In And 记录性质 = 1 And 记录状态 = 0 Order By 序号;

  l_医嘱id t_Numlist := t_Numlist();
  v_医嘱id 病人医嘱记录.Id%Type;

  n_父号         门诊费用记录.序号%Type;
  n_Count        Number;
  n_医嘱数       Number(5);
  n_已执行_Count Number;
  v_医嘱ids      Varchar2(4000);

  Err_Item Exception;
  v_Err_Msg Varchar2(255);
Begin

  --是否已经删除或收费
  Select Nvl(Count(ID), 0), Sum(Decode(医嘱序号, Null, 0, 1)), Max(医嘱序号), Sum(Decode(Nvl(执行状态, 0), 1, 1, 2, 1, 0))
  Into n_Count, n_医嘱数, v_医嘱id, n_已执行_Count
  From 门诊费用记录
  Where 记录性质 = 1 And 记录状态 = 0 And NO = No_In And
        (Instr(',' || 序号_In || ',', ',' || Nvl(价格父号, 序号) || ',') > 0 Or 序号_In Is Null);

  If n_Count = 0 Then
    v_Err_Msg := '要删除的费用记录不存在，可能已经删除或已经收费。';
    Raise Err_Item;
  End If;
  --是否已经执行
  If Nvl(n_已执行_Count, 0) > 0 Then
    v_Err_Msg := '要删除的费用记录中包含已执行的内容！';
    Raise Err_Item;
  End If;

  --医嘱费用：检查正在执行的医嘱(注意已执行的情况在下面检查,因为不传 序号_IN 这种情况费用界面已限制)
  Select Nvl(Count(*), 0)
  Into n_Count
  From 病人医嘱发送
  Where 执行状态 = 3 And (NO, 记录性质, 医嘱id) In
        (Select NO, 记录性质, 医嘱序号
                      From 门诊费用记录
                      Where NO = No_In And 记录性质 = 1 And 记录状态 = 0 And 医嘱序号 Is Not Null And
                            (Instr(',' || 序号_In || ',', ',' || 序号 || ',') > 0 Or 序号_In Is Null));
  If n_Count > 0 Then
    v_Err_Msg := '要删除的费用中存在对应的医嘱正在执行的情况，不能删除！';
    Raise Err_Item;
  End If;

  --药品相关内容
  --必须按照“收费细目id”升序排序，防止并发锁“药品库存”表
  For r_Expenses In (Select ID
                     From 门诊费用记录
                     Where NO = No_In And 记录性质 = 1 And 记录状态 = 0 And 收费类别 In ('4', '5', '6', '7') And
                           (Instr(',' || 序号_In || ',', ',' || 序号 || ',') > 0 Or 序号_In Is Null)
					 Order By 收费细目ID) Loop
    Zl_药品收发记录_销售退费(r_Expenses.Id);
  End Loop;

  --删除病人医嘱附费(最后一次删除时)
  If 序号_In Is Null Then
    --Begin
    --  Select 医嘱序号
    --  Into v_医嘱id
    --  From 门诊费用记录
    --  Where 记录性质 = 1 And 记录状态 = 0 And NO = No_In And Rownum = 1;
    -- Exception
    --  When Others Then
    --    Null;
    -- End;
  
    If v_医嘱id Is Not Null Then
      Delete From 病人医嘱附费 Where 医嘱id = v_医嘱id And NO = No_In And 记录性质 = 1;
    End If;
  End If;

  If n_医嘱数 > 0 Then
    If n_医嘱数 = 1 Then
      l_医嘱id.Extend;
      l_医嘱id(l_医嘱id.Count) := v_医嘱id;
    Else
      Select Distinct 医嘱序号 Bulk Collect
      Into l_医嘱id
      From 门诊费用记录
      Where 记录性质 = 1 And 记录状态 = 0 And NO = No_In And 医嘱序号 Is Not Null And
            (Instr(',' || 序号_In || ',', ',' || Nvl(价格父号, 序号) || ',') > 0 Or 序号_In Is Null);
    End If;
  End If;

  --门诊费用记录
  Delete From 门诊费用记录
  Where 记录性质 = 1 And 记录状态 = 0 And NO = No_In And
        (Instr(',' || 序号_In || ',', ',' || Nvl(价格父号, 序号) || ',') > 0 Or 序号_In Is Null);
  If Sql%RowCount = 0 Then
    v_Err_Msg := '要删除的费用记录不存在，可能已经删除或已经收费。';
    Raise Err_Item;
  End If;

  v_医嘱ids := Null;
  For I In 1 .. l_医嘱id.Count Loop
    v_医嘱ids := Nvl(v_医嘱ids, '') || ',' || l_医嘱id(I);
  End Loop;
  If v_医嘱ids Is Not Null Then
    v_医嘱ids := Substr(v_医嘱ids, 2);
    --场合_In    Integer, --0:门诊;1-住院
    --性质_In    Integer, --1-收费单;2-记帐单
    --操作_In    Integer, --0:删除划价单;1-收费或记帐;2-退费或销帐
    --No_In      门诊费用记录.No%Type,
    --医嘱ids_In Varchar2
    Zl_医嘱发送_计费状态_Update(0, 1, 0, No_In, v_医嘱ids);
  End If;

  If 序号_In Is Not Null Then
    --重新调整剩余费用费用记录的序号
    n_Count := 1;
    For r_Serial In c_Serial Loop
      If r_Serial.价格父号 Is Null Then
        n_父号 := n_Count;
      End If;
      Update 门诊费用记录 Set 序号 = n_Count, 价格父号 = Decode(价格父号, Null, Null, n_父号) Where ID = r_Serial.Id;
      n_Count := n_Count + 1;
    End Loop;
  End If;

Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊划价记录_Delete;
/

--106722:冉俊明,2017-03-10,退费在处理药品库存时，收费项目未按药品ID排序，可能会导致死锁发生。
Create Or Replace Procedure Zl_门诊收费记录_Delete
(
  No_In           门诊费用记录.No%Type,
  操作员编号_In   门诊费用记录.操作员编号%Type,
  操作员姓名_In   门诊费用记录.操作员姓名%Type,
  医保结算方式_In Varchar2 := Null,
  序号_In         Varchar2 := Null,
  结算方式_In     病人预交记录.结算方式%Type := Null,
  误差_In         门诊费用记录.实收金额%Type := 0,
  退费时间_In     门诊费用记录.登记时间%Type := Null,
  回收票据_In     Number := 0,
  退费摘要_In     门诊费用记录.摘要%Type := Null,
  校对标志_In     Number := 0,
  结帐id_In       病人预交记录.结帐id%Type := Null,
  结算序号_In     病人预交记录.结算序号%Type := Null,
  一卡通结算_In   Varchar2 := Null,
  退款操作_In     Number := 0,
  多单据全退_In   Number := 0
) As
  --功能：删除一张门诊收费单据
  --参数：
  --        医保结算方式_IN   =医保退费时,不支持结算作废的结算方式,如果为空表示非医保退费或医保退费全部结算允许作废。
  --        序号_IN           =要退费的项目序号,格式为"1,3,5,6...",缺省NULL表示退"未退的"所有行。
  --        结算方式_IN       =当为部分退费时,退费金额的结算方式。
  --        误差_IN           =指退费时新产生的误差金额,部份退费或医保全退但某种结算退现金时才会产生新的误差。
  --                           此时传入仅用于计算本次退费的结算金额,误差费用记录的处理在本过程执行完后调用Zl_门诊收费误差_Insert产生
  --        回收票据_In       =0:单张全退或多张一起全退时收回票据,注意,多张单据退费循环调本过程时只收回一次。
  --                           1:部份退费不处理票据,通过重打调用单独处理。
  --        校对标志_IN:0-不需要较对;1-需较对(不处理人员缴款余额,不回收票据,不处理预交余额)
  --        一卡通结算_In 全退时传入不原样退回的结算方式；医疗卡部分退费时，传入"结算方式|金额"
  --        退款操作_In:1-进行部分退(将退款方式退到指定的结算方式<结算方式_In>中,0-不指定退款方式)
  --        多单据全退_IN=1-多单据全退(多张单据全退,原样退);0-非原样退
  --该游标为要退费单据的所有原始记录

  --医保全退但某种结算退现金从而产生了新的误差时,排开此处的误差处理,执行完本过程后,界面程序中单独处理新误差
  Cursor c_Bill Is
    Select a.Id, a.No, a.附加标志, a.收费细目id, a.序号, a.价格父号, a.执行状态, a.收费类别, a.付数, a.数次, a.医嘱序号, j.诊疗类别, m.跟踪在用,
           Nvl(a.附加标志, 0) As 误差
    From 门诊费用记录 A, 病人医嘱记录 J, 材料特性 M
    Where a.医嘱序号 = j.Id(+) And a.No = No_In And a.记录性质 = 1 And a.记录状态 In (1, 3) And a.收费细目id + 0 = m.材料id(+) And
          Nvl(a.附加标志, 0) <> Decode(多单据全退_In, 1, 999, 9)
    Order By a.收费细目id, a.序号;
  --:不管原始单据误差,都应该根据当前退费产生的误差项进行处理
  -- Decode(Sign(误差_In), 0, 999, 9)

  --该光标用于处理人员缴款余额中退的不同结算方式的金额
  Cursor c_Money(冲销id_In 病人预交记录.结帐id%Type) Is
    Select 结算方式, 冲预交
    From 病人预交记录
    Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = 冲销id_In And 结算方式 Is Not Null And Nvl(冲预交, 0) <> 0 And Nvl(校对标志, 0) = 0;

  --该游标用于查找收费时使用过的冲预交款记录
  Cursor c_Deposit(V结帐id 病人预交记录.结帐id%Type) Is
    Select ID, 病人id, 冲预交 As 金额, 预交类别
    From 病人预交记录
    Where 记录性质 In (1, 11) And 记录状态 In (1, 3) And 结帐id = V结帐id And Nvl(冲预交, 0) <> 0
    Order By ID Desc;

  n_病人id   病人信息.病人id%Type;
  n_结帐id   门诊费用记录.结帐id%Type;
  n_结算序号 病人预交记录.结算序号%Type;
  n_打印id   票据打印内容.Id%Type;

  n_已退金额 病人预交记录.冲预交%Type;
  n_预交金额 病人预交记录.冲预交%Type;
  n_返回值   病人预交记录.冲预交%Type;
  n_原误差费 门诊费用记录.实收金额%Type;
  --部分退费计算变量
  n_剩余数量 Number;
  n_剩余应收 Number;
  n_剩余实收 Number;
  n_剩余统筹 Number;
  n_准退数量 Number;
  n_退费次数 Number;

  n_应收金额 Number;
  n_实收金额 Number;
  n_统筹金额 Number;
  n_总金额   Number;
  n_费用状态 门诊费用记录.费用状态%Type;
  n_正常退费 Number; --是否第一次退费且全部退费,在每行退费过程中判断得到。
  n_组id     财务缴款分组.Id%Type;

  v_退费结算 结算方式.名称%Type;
  v_结算内容 Varchar2(500);
  n_部分退   Number(2);
  v_当前结算 Varchar2(50);
  v_结算方式 病人预交记录.结算方式%Type;
  n_结算金额 病人预交记录.冲预交%Type;

  l_使用id   t_Numlist := t_Numlist();
  n_Dec      Number;
  d_Date     Date;
  n_Count    Number;
  n_原结帐id Number;

  Err_Item Exception;
  v_Err_Msg      Varchar2(255);
  n_启用模式     Number(3);
  v_Para         Varchar2(1000);
  n_医属执行计价 Number;
  n_会话号       病人预交记录.会话号%Type; --格式：SID+'_'+SERIAL#

  Procedure Zl_Square_Update
  (
    原结帐id_In 病人预交记录.结帐id%Type,
    现结帐id_In 病人预交记录.结帐id%Type,
    缴款组id_In 病人预交记录.缴款组id%Type,
    退款时间_In 病人预交记录.收款时间%Type,
    结算序号_In 病人预交记录.结算序号%Type,
    结算内容_In Varchar2 := Null
  ) As
    n_记录状态 病人卡结算记录.记录状态%Type;
    n_预交id   病人预交记录.Id%Type;
    v_卡号     病人卡结算记录.卡号%Type;
    n_存在卡片 Number;
    d_停用日期 消费卡目录.停用日期%Type;
    n_最大序号 病人卡结算记录.序号%Type;
    n_序号     病人卡结算记录.序号%Type;
    n_余额     消费卡目录.余额%Type;
    n_接口编号 病人卡结算记录.接口编号%Type;
    d_回收时间 消费卡目录.回收时间%Type;
    n_Id       病人预交记录.Id%Type;
  Begin
    n_预交id := 0;
    --处理消费卡,结算卡在上面就已经处理了
    For v_校对 In (Select a.Id As 预交id, c.消费卡id, c.结算金额, c.接口编号, c.卡号, c.序号, c.Id
                 From 病人预交记录 A, 病人卡结算对照 B, 病人卡结算记录 C
                 Where a.Id = b.预交id And b.卡结算id = c.Id And a.记录性质 = 3 And a.记录状态 = 1 And
                       Instr(Nvl(结算内容_In, '_LXH'), ',' || a.结算方式 || ',') = 0 And a.结帐id = 原结帐id_In) Loop
    
      If Nvl(v_校对.消费卡id, 0) <> 0 Then
        Select Max(记录状态)
        Into n_记录状态
        From 病人卡结算记录
        Where 接口编号 = v_校对.接口编号 And 消费卡id = Nvl(v_校对.消费卡id, 0) And 卡号 = v_校对.卡号 And Nvl(序号, 0) = Nvl(v_校对.序号, 0);
      Else
        Select Max(记录状态)
        Into n_记录状态
        From 病人卡结算记录
        Where 接口编号 = v_校对.接口编号 And 消费卡id Is Null And 卡号 = v_校对.卡号 And Nvl(序号, 0) = Nvl(v_校对.序号, 0);
      End If;
    
      If n_记录状态 = 1 Then
        n_记录状态 := 2;
      Else
        n_记录状态 := n_记录状态 + 2;
      End If;
      --多条时,只更新一条
      If n_预交id = 0 Then
        Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id,
           预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
          Select n_预交id, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, 退款时间_In, 缴款单位, 单位开户行, 单位帐号, 操作员编号_In, 操作员姓名_In,
                 -1 * 冲预交, 现结帐id_In, 缴款组id_In, 预交类别, 卡类别id, Nvl(结算卡序号, v_校对.接口编号), 卡号, 交易流水号, 交易说明, 合作单位,
                 Decode(Nvl(校对标志_In, 0), 0, 0, Decode(Nvl(v_校对.消费卡id, 0), 0, 1, 2)), 结算序号_In, 3, n_会话号
          From 病人预交记录 A
          Where ID = v_校对.预交id;
      End If;
    
      If Nvl(v_校对.消费卡id, 0) <> 0 Then
        --消费卡,直接退回卡数据中
        Begin
          Select 卡号, 1, 停用日期, (Select Max(序号) From 消费卡目录 B Where a.卡号 = b.卡号 And a.接口编号 = b.接口编号), 序号, 余额, 接口编号, 回收时间
          Into v_卡号, n_存在卡片, d_停用日期, n_最大序号, n_序号, n_余额, n_接口编号, d_回收时间
          From 消费卡目录 A
          Where ID = v_校对.消费卡id;
        Exception
          When Others Then
            n_存在卡片 := 0;
        End;
      
        --取消停用
        If n_存在卡片 = 0 Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡被他人删除，不能再启用该卡片,请检查！';
          Raise Err_Item;
        End If;
        If Nvl(n_序号, 0) < Nvl(n_最大序号, 0) Then
          v_Err_Msg := '不能启用历史发卡记录(卡号为"' || v_卡号 || '"),请检查！';
          Raise Err_Item;
        End If;
        If Nvl(d_停用日期, To_Date('3000-01-01', 'yyyy-mm-dd')) < To_Date('3000-01-01', 'yyyy-mm-dd') Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡已经被他人停用，不能再进行退费,请检查！';
          Raise Err_Item;
        End If;
      
        If d_回收时间 < To_Date('3000-01-01', 'yyyy-mm-dd') Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡已经回收，不能退费,请检查！';
          Raise Err_Item;
        End If;
        Update 消费卡目录 Set 余额 = Nvl(余额, 0) + v_校对.结算金额 Where ID = Nvl(v_校对.消费卡id, 0);
      End If;
    
      Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
      Insert Into 病人卡结算记录
        (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
        Select n_Id, 接口编号, 消费卡id, 序号, n_记录状态, 结算方式, -1 * v_校对.结算金额, 卡号, 交易流水号, 交易时间, 备注,
               Decode(消费卡id, Null, 0, 0, 0, 1) As 标志
        From 病人卡结算记录
        Where ID = v_校对.Id;
      Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
    
      If n_记录状态 <> 2 And n_记录状态 <> 1 Then
        Update 病人卡结算记录 Set 记录状态 = 3 Where ID = v_校对.Id;
      End If;
    End Loop;
  End;

Begin
  n_组id := Zl_Get组id(操作员姓名_In);

  Begin
    Select Sid || '_' || Serial# Into n_会话号 From V$session Where Audsid = Userenv('sessionid');
  Exception
    When Others Then
      n_会话号 := Null;
  End;

  n_部分退 := 0;
  --是否已经全部完全执行(只是该单据整张单据的检查)
  Select Nvl(Count(*), 0)
  Into n_Count
  From 门诊费用记录
  Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3) And Nvl(执行状态, 0) <> 1;
  If n_Count = 0 Then
    v_Err_Msg := '该单据中的项目已经全部完全执行！';
    Raise Err_Item;
  End If;

  --未完全执行的项目是否有剩余数量(只是整张单据的检查)
  --执行状态在原始记录上判断
  Select Nvl(Count(*), 0)
  Into n_Count
  From (Select 序号, Sum(数量) As 剩余数量
         From (Select 记录状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                From 门诊费用记录
                Where NO = No_In And 记录性质 = 1 And Nvl(附加标志, 0) <> 9 And
                      Nvl(价格父号, 序号) In
                      (Select Nvl(价格父号, 序号)
                       From 门诊费用记录
                       Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3) And Nvl(执行状态, 0) <> 1)
                Group By 记录状态, Nvl(价格父号, 序号))
         Group By 序号
         Having Sum(数量) <> 0);
  If n_Count = 0 Then
    v_Err_Msg := '该单据中未完全执行部分项目剩余数量为零,没有可以退费的费用！';
    Raise Err_Item;
  End If;
  --确定是否在医嘱执行计价中存在数据,如果存在数据,则根据医嘱执行计价进行退费,否则按旧方式进行处理
  Select Count(1)
  Into n_医属执行计价
  From 门诊费用记录 A, 医嘱执行计价 B
  Where a.医嘱序号 = b.医嘱id And a.记录性质 = 1 And a.No = No_In And a.记录状态 In (1, 3) And Rownum = 1;

  ---------------------------------------------------------------------------------
  --公用变量
  If 退费时间_In Is Not Null Then
    d_Date := 退费时间_In;
  Else
    Select Sysdate Into d_Date From Dual;
  End If;
  If 结帐id_In Is Null Then
    Select 病人结帐记录_Id.Nextval Into n_结帐id From Dual;
  Else
    n_结帐id := 结帐id_In;
  End If;
  n_结算序号 := 结算序号_In;
  If n_结算序号 Is Null Then
    n_结算序号 := 结帐id_In;
  End If;
  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into n_Dec From Dual;

  --获取结算方式名称
  v_退费结算 := 结算方式_In;
  If v_退费结算 Is Null Then
    Begin
      Select 名称 Into v_退费结算 From 结算方式 Where 性质 = 1;
    Exception
      When Others Then
        v_退费结算 := '现金';
    End;
  End If;
  --循环处理每行费用(收入项目行)
  n_总金额   := 0;
  n_正常退费 := 1;
  For r_Bill In c_Bill Loop
    If Instr(',' || 序号_In || ',', ',' || Nvl(r_Bill.价格父号, r_Bill.序号) || ',') > 0 Or 序号_In Is Null Then
      If Nvl(r_Bill.执行状态, 0) <> 1 Then
        --求剩余数量,剩余应收,剩余实收
        Select Sum(Nvl(付数, 1) * 数次), Sum(应收金额), Sum(实收金额), Sum(统筹金额)
        Into n_剩余数量, n_剩余应收, n_剩余实收, n_剩余统筹
        From 门诊费用记录
        Where NO = No_In And 记录性质 = 1 And 序号 = r_Bill.序号;
      
        If n_剩余数量 = 0 Then
          If 序号_In Is Not Null Then
            v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经全部退费！';
            Raise Err_Item;
          End If;
          --情况：未限定行号,原始单据中的该笔已经全部退费(执行状态=0的一种可能)
          n_正常退费 := 0;
        Else
          --准退数量(非药品项目为剩余数量,原始数量)
          If Instr(',4,5,6,7,', r_Bill.收费类别) = 0 Or (r_Bill.收费类别 = '4' And Nvl(r_Bill.跟踪在用, 0) = 0) Then
            --@@@
            --非药品部分(以具体医嘱执行为准进行检查)
            --: 1.存在医嘱发送的,则以医嘱执行为准(但不能包含:检查;检验;手术;麻醉及输血)
            --: 2.不存在医嘱的,则以剩余数量为准
            n_Count := 0;
            If Instr(',C,D,F,G,K,', ',' || r_Bill.诊疗类别 || ',') = 0 And r_Bill.诊疗类别 Is Not Null Then
              If n_医属执行计价 = 1 Then
                Select Decode(Sign(Sum(数量)), -1, 0, Sum(数量)), Count(*)
                Into n_准退数量, n_Count
                From (Select Max(Decode(a.记录状态, 2, 0, a.Id)) As ID, Max(a.医嘱序号) As 医嘱id, Max(a.收费细目id) As 收费细目id,
                              Sum(Nvl(a.付数, 1) * Nvl(a.数次, 1)) As 数量,
                              Sum(Decode(a.记录状态, 2, 0, Nvl(a.付数, 1) * Nvl(a.数次, 1))) As 原始数量
                       From 门诊费用记录 A, 病人医嘱记录 M
                       Where a.医嘱序号 = m.Id And Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And
                             Instr('5,6,7', a.收费类别) = 0 And a.No = No_In And a.序号 = r_Bill.序号 And a.记录性质 = 1 And
                             a.记录状态 In (1, 2, 3) And a.价格父号 Is Null
                       Group By a.序号
                       Union All
                       Select a.Id, a.医嘱序号 As 医嘱id, a.收费细目id, -1 * b.数量 As 已执行, 0 原始数量
                       From 门诊费用记录 A, 医嘱执行计价 B, 病人医嘱记录 M
                       Where a.医嘱序号 = b.医嘱id And a.收费细目id = b.收费细目id + 0 And a.医嘱序号 = m.Id And
                             Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And Instr('5,6,7', a.收费类别) = 0 And
                             (Exists
                              (Select 1
                               From 病人医嘱执行
                               Where b.医嘱id = 医嘱id And b.发送号 = 发送号 And b.要求时间 = 要求时间 And Nvl(执行结果, 0) = 1) Or Exists
                              (Select 1
                               From 病人医嘱发送
                               Where b.医嘱id = 医嘱id And b.发送号 = 发送号 And Nvl(执行状态, 0) = 1)) And Not Exists
                        (Select 1
                              From 病人医嘱附费
                              Where a.医嘱序号 = 医嘱id And a.No = NO And Mod(a.记录性质, 10) = 记录性质) And a.No = No_In And
                             a.序号 = r_Bill.序号 And a.记录性质 = 1 And a.记录状态 In (1, 3) 　and a.价格父号 Is Null) Q1
                Where Not Exists (Select 1
                       From 药品收发记录
                       Where 费用id = Q1.Id And Instr(',8,9,10,21,24,25,26,', ',' || 单据 || ',') > 0) Having
                 Max(ID) <> 0;
              Else
              
                Select Nvl(Sum(数量), 0), Count(*)
                Into n_准退数量, n_Count
                From (Select a.医嘱id, a.收费细目id, Nvl(a.数量, 1) * Nvl(b.发送数次, 1) As 数量
                       From 病人医嘱计价 A, 病人医嘱发送 B, 门诊费用记录 J, 病人医嘱记录 M
                       Where a.医嘱id = b.医嘱id And a.医嘱id = m.Id And Nvl(b.执行状态, 0) <> 1 And a.医嘱id = j.医嘱序号 And
                             a.收费细目id = j.收费细目id And j.No = No_In And j.记录性质 = 1 And j.序号 = r_Bill.序号 And
                             j.记录状态 In (1, 3) And j.价格父号 Is Null And Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And
                             Exists
                        (Select 1
                              From 病人医嘱计价 A
                              Where a.医嘱id = j.医嘱序号 And a.收费细目id = j.收费细目id And Nvl(a.收费方式, 0) = 0) And Not Exists
                        (Select 1
                              From 药品收发记录
                              Where 费用id = j.Id And Instr(',8,9,10,21,24,25,26,', ',' || 单据 || ',') > 0)
                       Union All
                       Select a.医嘱id, a.收费细目id, -1 * Nvl(a.数量, 1) * Nvl(c.本次数次, 1) As 数量
                       From 病人医嘱计价 A, 病人医嘱发送 B, 病人医嘱执行 C, 门诊费用记录 J, 病人医嘱记录 M
                       Where a.医嘱id = b.医嘱id And b.医嘱id = c.医嘱id And b.发送号 = c.发送号 And a.医嘱id = m.Id And
                             Nvl(c.执行结果, 1) = 1 And Nvl(b.执行状态, 0) <> 1 And a.医嘱id = j.医嘱序号 And a.收费细目id = j.收费细目id And
                             j.No = No_In And j.记录性质 = 1 And Nvl(a.收费方式, 0) = 0 And j.序号 = r_Bill.序号 And j.记录状态 In (1, 3) And
                             j.价格父号 Is Null And Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And Not Exists
                        (Select 1
                              From 药品收发记录
                              Where 费用id = j.Id And Instr(',8,9,10,21,24,25,26,', ',' || 单据 || ',') > 0) And Not Exists
                        (Select 1 From 材料特性 Where 材料id = j.收费细目id And Nvl(跟踪在用, 0) = 1)
                       Union All
                       Select a.医嘱序号 As 医嘱id, a.收费细目id, Nvl(a.付数, 1) * a.数次 As 数量
                       From 门诊费用记录 A, 病人医嘱记录 M
                       Where a.医嘱序号 = m.Id And Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And a.No = No_In And
                             a.记录性质 = 1 And a.序号 = r_Bill.序号 And a.记录状态 = 2 And a.价格父号 Is Null And Not Exists
                        (Select 1 From 药品收发记录 Where NO = No_In And 单据 In (8, 24) And 药品id = a.收费细目id));
              End If;
            End If;
            If Nvl(n_Count, 0) <> 0 And n_准退数量 = 0 Then
              v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已执行,不允许退费！';
              Raise Err_Item;
            End If;
          
            If Nvl(n_Count, 0) = 0 Then
              n_准退数量 := n_剩余数量;
            End If;
          
          Else
            Select Nvl(Sum(Nvl(付数, 1) * 实际数量), 0), Count(*)
            Into n_准退数量, n_Count
            From 药品收发记录
            Where NO = No_In And 单据 In (8, 24) And Mod(记录状态, 3) = 1 --@@@
                  And 审核人 Is Null And 费用id = r_Bill.Id;
          
            --有剩余数量无准退数量的有两种情况：
            --1.不跟踪在用的卫材无对应的收发记录,这时使用剩余数量
            --2.并发操作,此时已发药或发料
            If n_准退数量 = 0 Then
              If r_Bill.收费类别 = '4' Then
                If n_Count > 0 Then
                  v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已发料,须退料后再退费！';
                  Raise Err_Item;
                Else
                  n_准退数量 := n_剩余数量;
                End If;
              Else
                v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已发药,须退药后再退费！';
                Raise Err_Item;
              End If;
            End If;
          End If;
        
          --是否部分退费
          If r_Bill.执行状态 = 2 Or n_准退数量 <> Nvl(r_Bill.付数, 1) * r_Bill.数次 Then
            n_正常退费 := 0;
          End If;
        
          --处理门诊费用记录
          n_费用状态 := 0;
          --该笔项目第几次退费
          If Nvl(校对标志_In, 0) <> 0 Then
            n_退费次数 := -9; --先标明,固定为9
            n_费用状态 := 1;
          Else
            Select Nvl(Max(Abs(执行状态)), 0) + 1
            Into n_退费次数
            From 门诊费用记录
            Where NO = No_In And 记录性质 = 1 And 记录状态 = 2 And Nvl(执行状态, 0) < 0 And 序号 = r_Bill.序号;
          End If;
        
          --金额=剩余金额*(准退数/剩余数)
          If Nvl(r_Bill.误差, 0) = 9 Then
            --误差可以超过设置的小数位(比如:医保结算超过小数位后,误差就可能超过小数位
            n_应收金额 := Round(n_剩余应收 * (n_准退数量 / n_剩余数量), 5);
            n_实收金额 := Round(n_剩余实收 * (n_准退数量 / n_剩余数量), 5);
            n_统筹金额 := Round(n_剩余统筹 * (n_准退数量 / n_剩余数量), 5);
          Else
            n_应收金额 := Round(n_剩余应收 * (n_准退数量 / n_剩余数量), n_Dec);
            n_实收金额 := Round(n_剩余实收 * (n_准退数量 / n_剩余数量), n_Dec);
            n_统筹金额 := Round(n_剩余统筹 * (n_准退数量 / n_剩余数量), n_Dec);
          End If;
          n_总金额 := n_总金额 + n_实收金额;
        
          --插入退费记录
          Insert Into 门诊费用记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 姓名, 性别, 年龄, 标识号, 付款方式, 费别, 病人科室id, 收费类别,
             收费细目id, 计算单位, 付数, 发药窗口, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人,
             执行状态, 费用状态, 执行时间, 操作员编号, 操作员姓名, 发生时间, 登记时间, 结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 结论,
             缴款组id)
            Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 姓名, 性别, 年龄, 标识号, 付款方式, 费别,
                   病人科室id, 收费类别, 收费细目id, 计算单位, Decode(Sign(n_准退数量 - Nvl(付数, 1) * 数次), 0, 付数, 1), 发药窗口,
                   Decode(Sign(n_准退数量 - Nvl(付数, 1) * 数次), 0, -1 * 数次, -1 * n_准退数量), 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价,
                   -1 * n_应收金额, -1 * n_实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人, -1 * n_退费次数, n_费用状态, 执行时间, 操作员编号_In,
                   操作员姓名_In, 发生时间, d_Date, n_结帐id, -1 * n_实收金额, 保险项目否, 保险大类id, -1 * n_统筹金额, Nvl(退费摘要_In, 摘要),
                   Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, 结论, n_组id
            From 门诊费用记录
            Where ID = r_Bill.Id;
        
          --标记原费用记录
          --执行状态:全部退完(准退数=剩余数)标记为0,否则标记为1,异常收费单,还是标明9
          Update 门诊费用记录
          Set 记录状态 = 3, 执行状态 = Decode(Nvl(执行状态, 0), 9, 9, Decode(Sign(n_准退数量 - n_剩余数量), 0, 0, 1))
          Where ID = r_Bill.Id;
        End If;
      Else
        If 序号_In Is Not Null Then
          v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经完全执行,不能退费！';
          Raise Err_Item;
        End If;
        --情况:没限定行号,原始单据中包括已经完全执行的
        n_正常退费 := 0;
      End If;
    Else
      n_正常退费 := 0; --未指定该笔,属于部分退费
    End If;
  End Loop;
  ---------------------------------------------------------------------------------
  --处理病人预交记录

  --原单据的结帐ID
  Select 结帐id, 病人id
  Into n_原结帐id, n_病人id
  From 门诊费用记录
  Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3) And Rownum = 1;

  If n_正常退费 = 1 And Nvl(退款操作_In, 0) = 0 Then
    --单据第一次退费且全部退完
    --冲预交部分记录
    Insert Into 病人预交记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交, 结帐id,
       缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
      Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, d_Date,
             操作员姓名_In, 操作员编号_In, -1 * 冲预交, n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
             Decode(校对标志_In, 1, 2, 校对标志_In), n_结算序号, 3, n_会话号
      From 病人预交记录
      Where 记录性质 In (1, 11) And 结帐id = n_原结帐id And Nvl(冲预交, 0) <> 0;
    If Nvl(校对标志_In, 0) = 0 Then
      --处理病人预交余额
      For v_预交 In (Select 预交类别, Nvl(Sum(Nvl(冲预交, 0)), 0) As 预交金额, 病人id
                   From 病人预交记录
                   Where 记录性质 In (1, 11) And 结帐id = n_原结帐id
                   Group By 预交类别, 病人id
                   Having Sum(Nvl(冲预交, 0)) <> 0) Loop
        Update 病人余额
        Set 预交余额 = Nvl(预交余额, 0) + Nvl(v_预交.预交金额, 0)
        Where 病人id = v_预交.病人id And 性质 = 1 And 类型 = Nvl(v_预交.预交类别, 2)
        Returning 预交余额 Into n_返回值;
        If Sql%RowCount = 0 Then
          Insert Into 病人余额
            (病人id, 类型, 预交余额, 性质)
          Values
            (v_预交.病人id, Nvl(v_预交.预交类别, 2), Nvl(v_预交.预交金额, 0), 1);
          n_返回值 := n_预交金额;
        End If;
        If n_返回值 = 0 Then
          Delete From 病人余额
          Where 病人id = v_预交.病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
        End If;
      End Loop;
    End If;
    --非医保全退,和医保所有结算方式都允许回退,原样退回(冲预交在前面已处理)
    If 医保结算方式_In Is Null Then
      v_结算内容 := ',' || Nvl(一卡通结算_In, '-Lxh') || ',' || Nvl(一卡通结算_In, 'Lxh') || ',';
    
      --一卡通或消费卡或银行卡的相关数据需要特殊处理,需要最后较对.
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别,
         卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
        Select 病人预交记录_Id.Nextval, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, d_Date, 缴款单位, 单位开户行, 单位帐号, 操作员编号_In, 操作员姓名_In,
               -1 * 冲预交, n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
               Case
                 When Nvl(卡类别id, 0) <> 0 Then
                  Decode(校对标志_In, 1, 1, 0) * 1
                 When Nvl(结算卡序号, 0) <> 0 Then
                  Decode(校对标志_In, 1, 1, 0) * 1
                 When Nvl(q.预交id, 0) <> 0 Then
                  Decode(校对标志_In, 1, 1, 0) * 1
                 When Nvl(j.名称, '-') <> '-' Then
                  Decode(校对标志_In, 1, 1, 0)
                 Else
                  Decode(校对标志_In, 1, 2, 0)
               End As 校对标志, n_结算序号, 3, n_会话号
        From 病人预交记录 A, (Select 名称 From 结算方式 Where 性质 In (3, 4)) J,
             (Select m.Id As 预交id
               From 病人预交记录 M, 一卡通目录 C
               Where m.结帐id = n_原结帐id And m.结算方式 = c.结算方式 And m.记录性质 = 3 And m.记录状态 = 1) Q
        Where a.记录性质 = 3 And a.记录状态 = 1 And a.结帐id = n_原结帐id And a.Id = q.预交id(+) And a.结算方式 = j.名称(+) And
              Instr(v_结算内容, ',' || 结算方式 || ',') = 0 And
              (Not Exists (Select 1 From 病人卡结算对照 Where a.Id = 预交id) Or Nvl(结算卡序号, 0) = 0);
    
      --处理消费卡,结算卡在上面就已经处理了
      Zl_Square_Update(n_原结帐id, n_结帐id, n_组id, d_Date, n_结算序号, v_结算内容);
      --b.余下的就是三方接口支持的退现了,不允许作废的结算方式,加上到指定的结算方式上,加上误差(因为界面程序会在这之后退误差)
      If 一卡通结算_In Is Not Null Then
        Begin
          Select -1 * Nvl(Sum(冲预交), 0) Into n_已退金额 From 病人预交记录 Where 结帐id = n_结帐id;
        Exception
          When Others Then
            n_已退金额 := 0;
        End;
      
        If (n_总金额 - n_已退金额) <> 0 Then
          --此时的总金额还没有包含误差,因为界面程序中在调用本过程后才产生误差费用记录
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号,
             交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
            Select 病人预交记录_Id.Nextval, 3, NO, 2, 病人id, 主页id, '门诊退费结算', v_退费结算, d_Date, 操作员编号_In, 操作员姓名_In,
                   -1 * (n_总金额 - n_已退金额), n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
                   Decode(校对标志_In, 1, 2, 0), n_结算序号, 3, n_会话号
            From 病人预交记录
            Where 记录性质 = 3 And 记录状态 = 1 And 结帐id = n_原结帐id And Rownum = 1;
          n_部分退 := 1;
        End If;
      End If;
      --医保按允许作废的结算方式退,不允许的,退到指定的结算方式上
      --需要处理误差金额
    Else
      --a.原样退回
      v_结算内容 := ',' || 医保结算方式_In || ',' || Nvl(一卡通结算_In, '-Lxh') || ',' || v_退费结算 || ',';
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号,
         交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
        Select 病人预交记录_Id.Nextval, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, d_Date, 操作员编号_In, 操作员姓名_In, -1 * 冲预交, n_结帐id,
               n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
               
               Case
                 When Nvl(卡类别id, 0) <> 0 Then
                  Decode(校对标志_In, 1, 1, 0) * 1
                 When Nvl(结算卡序号, 0) <> 0 Then
                  Decode(校对标志_In, 1, 1, 0) * 1
                 When Nvl(q.预交id, 0) <> 0 Then
                  Decode(校对标志_In, 1, 1, 0) * 1
                 When Nvl(j.名称, '-') <> '-' Then
                  Decode(校对标志_In, 1, 1, 0)
                 Else
                  Decode(校对标志_In, 1, 2, 0)
               End As 校对标志, n_结算序号, 3, n_会话号
        From 病人预交记录 A, (Select 名称 From 结算方式 Where 性质 In (3, 4)) J,
             (Select m.Id As 预交id
               From 病人预交记录 M, 一卡通目录 C
               Where m.结帐id = n_原结帐id And m.结算方式 = c.结算方式 And m.记录性质 = 3 And m.记录状态 = 1) Q
        Where a.记录性质 = 3 And a.记录状态 = 1 And a.结算方式 = j.名称(+) And a.结帐id = n_原结帐id And
              Instr(v_结算内容, ',' || a.结算方式 || ',') = 0 And a.Id = q.预交id(+) And
              (Not Exists (Select 1 From 病人卡结算对照 Where a.Id = 预交id) Or Nvl(结算卡序号, 0) = 0);
    
      --处理消费卡,结算卡在上面就已经处理了
      Zl_Square_Update(n_原结帐id, n_结帐id, n_组id, d_Date, n_结算序号, v_结算内容);
    
      --b.余下的就是医保不允许作废的结算方式,加上到指定的结算方式上,加上误差(因为界面程序会在这之后退误差)
      Begin
        Select -1 * Nvl(Sum(冲预交), 0) Into n_已退金额 From 病人预交记录 Where 结帐id = n_结帐id;
      Exception
        When Others Then
          n_已退金额 := 0;
      End;
    
      If (n_总金额 - n_已退金额) <> 0 Then
        --此时的总金额还没有包含误差,因为界面程序中在调用本过程后才产生误差费用记录
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号,
           交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
          Select 病人预交记录_Id.Nextval, 3, NO, 2, 病人id, 主页id, Decode(一卡通结算_In, Null, '门诊医保接口退费', '门诊医保接口和三方接口退费'), v_退费结算,
                 d_Date, 操作员编号_In, 操作员姓名_In, -1 * (n_总金额 - n_已退金额), n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明,
                 合作单位, Decode(校对标志_In, 1, 2, 0), n_结算序号, 3, n_会话号
          From 病人预交记录
          Where 记录性质 = 3 And 记录状态 = 1 And 结帐id = n_原结帐id And Rownum = 1;
        n_部分退 := 1;
      End If;
    
    End If;
  Else
    -------------------------------------------------
    --部分退费
    n_已退金额 := 0;
    --医疗卡部分退费时，传入:结算方式|金额
    If 一卡通结算_In Is Not Null Then
      If Instr(一卡通结算_In, '|') > 0 Then
        v_当前结算 := 一卡通结算_In;
        v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
        v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
        n_结算金额 := Nvl(To_Number(v_当前结算), 0);
        If Not Nvl(v_结算方式, 'TMP') = 'TMP' Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别,
             卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
            Select 病人预交记录_Id.Nextval, 3, No_In, 2, 病人id, 主页id, '三方接口部分退费', v_结算方式, d_Date, Null, Null, Null, 操作员编号_In,
                   操作员姓名_In, -1 * (n_结算金额), n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
                   Decode(校对标志_In, 1, 1, 0), n_结算序号, 3, n_会话号
            From 病人预交记录
            Where 记录性质 = 3 And 记录状态 In (1, 3) And 结帐id = n_原结帐id And Rownum < 2;
        End If;
        n_已退金额 := n_结算金额;
      End If;
    End If;
    --其它直接退为指定结算方式
    If (n_总金额 - n_已退金额 + Nvl(误差_In, 0)) <> 0 Then
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
         结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
        Select 病人预交记录_Id.Nextval, 3, No_In, 2, 病人id, 主页id, '部分退费结算', v_退费结算, d_Date, Null, Null, Null, 操作员编号_In,
               操作员姓名_In, -1 * (n_总金额 - n_已退金额 + Nvl(误差_In, 0)), n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
               Decode(校对标志, 1, 2, 0), n_结算序号, 3, n_会话号
        From 病人预交记录
        Where 记录性质 = 3 And 记录状态 In (1, 3) And 结帐id = n_原结帐id And Rownum = 1;
    End If;
    --如果收费时只使用了预交款,则要退预交,并且可能有多笔冲预交
    If Sql%RowCount = 0 And 一卡通结算_In Is Null Then
      n_预交金额 := n_总金额 - n_已退金额 + Nvl(误差_In, 0);
    
      For r_Deposit In c_Deposit(n_原结帐id) Loop
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
           结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
                 d_Date, 操作员姓名_In, 操作员编号_In, Decode(Sign(r_Deposit.金额 - n_预交金额), -1, -1 * r_Deposit.金额, -1 * n_预交金额),
                 n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, Decode(校对标志_In, 1, 2, 0), n_结算序号, 3, n_会话号
          From 病人预交记录
          Where ID = r_Deposit.Id;
      
        If Nvl(校对标志_In, 0) = 0 Then
          --更新病人预交余额
          Update 病人余额
          Set 预交余额 = Nvl(预交余额, 0) + n_总金额 + Nvl(误差_In, 0)
          Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = 1
          Returning 预交余额 Into n_返回值;
          If Sql%RowCount = 0 Then
            Insert Into 病人余额
              (病人id, 类型, 预交余额, 性质)
            Values
              (r_Deposit.病人id, 1, n_总金额 + Nvl(误差_In, 0), 1);
            n_返回值 := n_总金额 + Nvl(误差_In, 0);
          End If;
          If Nvl(n_返回值, 0) = 0 Then
            Delete From 病人余额
            Where 病人id = r_Deposit.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
          End If;
        End If;
      
        --检查是否已经处理完
        If r_Deposit.金额 < n_预交金额 Then
          n_预交金额 := n_预交金额 - r_Deposit.金额;
        Else
          n_预交金额 := 0;
        End If;
        If n_预交金额 = 0 Then
          Exit;
        End If;
      End Loop;
    End If;
  End If;

  --更新原记录
  Update 病人预交记录 Set 记录状态 = 3 Where 记录性质 = 3 And 记录状态 In (1, 3) And 结帐id = n_原结帐id;

  If 多单据全退_In <> 1 Then
    --处理误差项,多单据全退时 ,按原样退无误差处理
    --将误差项的记录状态调整为3
    If Nvl(误差_In, 0) <> 0 Then
      n_Count := 1;
      If n_正常退费 = 1 And Nvl(退款操作_In, 0) = 0 Then
        n_原误差费 := 0;
        --原样退,但存在误差
        If n_部分退 = 0 Then
          Select -1 * Nvl(Sum(实收金额), 0)
          Into n_原误差费
          From 门诊费用记录 A
          Where NO = No_In And a.记录性质 = 1 And a.记录状态 In (1, 3) And Nvl(a.附加标志, 0) = 9;
        End If;
        If Nvl(n_原误差费, 0) <> 0 Or Nvl(误差_In, 0) <> 0 Then
          Update 病人预交记录
          Set 冲预交 = 冲预交 - n_原误差费 - Nvl(误差_In, 0)
          Where 结算方式 = v_退费结算 And 结帐id = n_结帐id;
          If Sql%NotFound Then
            Insert Into 病人预交记录
              (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别,
               卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
              Select 病人预交记录_Id.Nextval, 3, No_In, 2, 病人id, 主页id, '误差费', v_退费结算, d_Date, Null, Null, Null, 操作员编号_In,
                     操作员姓名_In, -1 * n_原误差费 - Nvl(误差_In, 0), n_结帐id, n_组id, 预交类别, Null, Null, Null, Null, Null, Null, 0,
                     n_结算序号, 3, n_会话号
              From 病人预交记录
              Where 记录性质 = 3 And 记录状态 In (1, 3) And 结帐id = n_原结帐id And Rownum = 1;
          End If;
        End If;
      End If;
    Elsif n_正常退费 = 1 And Nvl(退款操作_In, 0) = 0 Then
      --原样退时,需要处理预交记录不足的情况
      Select Nvl(Sum(Nvl(结帐金额, 0)), 0) Into n_实收金额 From 门诊费用记录 Where 结帐id = n_结帐id;
      Select Nvl(Sum(Nvl(冲预交, 0)), 0) Into n_返回值 From 病人预交记录 Where 结帐id = n_结帐id;
      If Abs(n_实收金额) <> Abs(n_返回值) Then
        n_实收金额 := n_实收金额 - n_返回值;
        Update 病人预交记录 Set 冲预交 = 冲预交 + Nvl(n_实收金额, 0) Where 结算方式 = v_退费结算 And 结帐id = n_结帐id;
        If Sql%NotFound Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别,
             卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
            Select 病人预交记录_Id.Nextval, 3, No_In, 2, 病人id, 主页id, '误差费', v_退费结算, d_Date, Null, Null, Null, 操作员编号_In,
                   操作员姓名_In, Nvl(n_实收金额, 0), n_结帐id, n_组id, 预交类别, Null, Null, Null, Null, Null, Null, 0, n_结算序号, 3,
                   n_会话号
            From 病人预交记录
            Where 记录性质 = 3 And 记录状态 In (1, 3) And 结帐id = n_原结帐id And Rownum = 1;
        End If;
      End If;
    End If;
  
    Select Nvl(Sum(Nvl(结帐金额, 0)), 0) Into n_实收金额 From 门诊费用记录 Where 结帐id = n_结帐id;
    Select Nvl(Sum(Nvl(冲预交, 0)), 0) Into n_返回值 From 病人预交记录 Where 结帐id = n_结帐id;
  
    n_实收金额 := n_实收金额 - n_返回值;
  
    If n_实收金额 <> 0 Then
      --未找到，新产生误差项
      Zl_门诊收费误差_Insert(No_In, n_实收金额, 1);
    End If;
  End If;
  ---------------------------------------------------------------------------------
  --人员缴款余额(注意是预交记录处理后才处理，包括个人帐户等的结算金额,不含退冲预交款)
  --如果是需要校对的,暂不处理人员缴款余额
  If Nvl(校对标志_In, 0) = 0 Then
    For r_Moneyrow In c_Money(n_结帐id) Loop
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) + r_Moneyrow.冲预交
      Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_Moneyrow.结算方式
      Returning 余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (操作员姓名_In, r_Moneyrow.结算方式, 1, r_Moneyrow.冲预交);
        n_返回值 := r_Moneyrow.冲预交;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 人员缴款余额
        Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_Moneyrow.结算方式 And Nvl(余额, 0) = 0;
      End If;
    End Loop;
  End If;

  ---------------------------------------------------------------------------------
  --退费票据回收(仅全退时才回退,部分退是在重打过程中回收)
  If 回收票据_In = 0 Then
  
    --启用标志||NO;执行科室(条数);收据费目(首页汇总,条数);收费细目(条数)
    v_Para     := Nvl(zl_GetSysParameter('票据分配规则', 1121), '0||0;0;0,0;0');
    n_启用模式 := Zl_To_Number(Substr(v_Para, 1, 1));
    If n_启用模式 <> 0 Then
      --收回票据
      Select 使用id Bulk Collect
      Into l_使用id
      From (Select Distinct b.使用id From 票据打印明细 B Where b.No = No_In And Nvl(b.票种, 0) = 1);
    
      n_启用模式 := l_使用id.Count;
      If l_使用id.Count <> 0 Then
        --插入回收记录
        Forall I In 1 .. l_使用id.Count
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用人, 使用时间)
            Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, 操作员姓名_In, d_Date
            From 票据使用明细 A
            Where ID = l_使用id(I) And 性质 = 1 And Not Exists
             (Select 1 From 票据使用明细 Where 号码 = a.号码 And 票种 = a.票种 And Nvl(性质, 0) <> 1);
      
        Forall I In 1 .. l_使用id.Count
          Update 票据打印明细 Set 是否回收 = 1 Where 使用id = l_使用id(I) And Nvl(是否回收, 0) = 0;
      
      End If;
    End If;
    If n_启用模式 = 0 Then
      --获取单据最后一次的打印ID(可能是多张单据收费打印)
      Begin
        --性质=1，原因=6为退费打印票据(红票)，不回收
        Select ID
        Into n_打印id
        From (Select b.Id
               From 票据使用明细 A, 票据打印内容 B
               Where a.打印id = b.Id And a.性质 = 1 And a.原因 In (1, 3) And b.数据性质 = 1 And b.No = No_In
               Order By a.使用时间 Desc)
        Where Rownum < 2;
      Exception
        When Others Then
          Null;
      End;
      --可能以前没有打印,无收回
      If n_打印id Is Not Null Then
        --a.多张单据循环调用时只能收回一次
        Select Count(*) Into n_Count From 票据使用明细 Where 票种 = 1 And 性质 = 2 And 打印id = n_打印id;
        If n_Count = 0 Then
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
            Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, d_Date, 操作员姓名_In
            From 票据使用明细
            Where 打印id = n_打印id And 票种 = 1 And 性质 = 1;
        Else
          --b.部分退费多次收回时,最后一次全退收回要排开已收回的
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
            Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, d_Date, 操作员姓名_In
            From 票据使用明细 A
            Where 打印id = n_打印id And 票种 = 1 And 性质 = 1 And Not Exists
             (Select 1 From 票据使用明细 B Where a.号码 = b.号码 And 打印id = n_打印id And 票种 = 1 And 性质 = 2);
        End If;
      End If;
    End If;
  End If;

  ---------------------------------------------------------------------------------
  --药品卫材相关内容
  --必须按照“收费细目id”升序排序，防止并发锁“药品库存”表
  For r_Expenses In (Select ID
                     From 门诊费用记录
                     Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3) And 收费类别 In ('4', '5', '6', '7') And
                           (Instr(',' || 序号_In || ',', ',' || 序号 || ',') > 0 Or 序号_In Is Null)
					 Order By 收费细目ID) Loop
    Zl_药品收发记录_销售退费(r_Expenses.Id);
  End Loop;

  --医嘱处理
  --删除病人医嘱附费(最后一次删除时)
  For c_医嘱 In (Select Distinct 医嘱序号
               From 门诊费用记录
               Where NO = No_In And 记录性质 = 1 And 记录状态 = 3 And 医嘱序号 Is Not Null) Loop
    Select Nvl(Count(*), 0)
    Into n_Count
    From (Select 序号, Sum(数量) As 剩余数量
           From (Select 记录状态, 执行状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                  From 门诊费用记录
                  Where 记录性质 = 1 And Nvl(附加标志, 0) <> 9 And 医嘱序号 + 0 = c_医嘱.医嘱序号 And NO = No_In
                  Group By 记录状态, 执行状态, Nvl(价格父号, 序号))
           Group By 序号
           Having Sum(数量) <> 0);
  
    If n_Count = 0 Then
      Delete From 病人医嘱附费 Where 医嘱id = c_医嘱.医嘱序号 And 记录性质 = 1 And NO = No_In;
    End If;
  End Loop;

  --场合_In    Integer:=0, --0:门诊;1-住院
  --性质_In    Integer:=1, --1-收费单;2-记帐单
  --操作_In    Integer:=0, --0:删除划价单;1-收费或记帐;2-退费或销帐
  --No_In      门诊费用记录.No%Type,
  --医嘱ids_In Varchar2 := Null
  Zl_医嘱发送_计费状态_Update(0, 1, 2, No_In);
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊收费记录_Delete;
/

--106722:冉俊明,2017-03-10,退费在处理药品库存时，收费项目未按药品ID排序，可能会导致死锁发生。
Create Or Replace Procedure Zl_门诊收费记录_销帐
(
  No_In         门诊费用记录.No%Type,
  操作员编号_In 门诊费用记录.操作员编号%Type,
  操作员姓名_In 门诊费用记录.操作员姓名%Type,
  序号_In       Varchar2 := Null,
  退费时间_In   门诊费用记录.登记时间%Type := Null,
  退费摘要_In   门诊费用记录.摘要%Type := Null,
  结帐id_In     病人预交记录.结帐id%Type := Null,
  回收票据_In   Number := 0
) As
  --功能：删除一张门诊收费单据
  --参数：
  --        序号_IN           =要退费的项目序号,格式为"1,3,5,6...",缺省NULL表示退"未退的"所有行。
  --        回收票据_In       =0:全退或最后一次全退时,收回票据。
  --                           1:部份退费不处理票据,通过重打调用单独处理。
  --该游标为要退费单据的所有原始记录

  --医保全退但某种结算退现金从而产生了新的误差时,排开此处的误差处理,执行完本过程后,界面程序中单独处理新误差
  Cursor c_Bill Is
    Select a.Id, a.No, a.附加标志, a.收费细目id, a.序号, a.价格父号, a.执行状态, a.收费类别, a.付数, a.数次, a.医嘱序号, j.诊疗类别, m.跟踪在用,
           Nvl(a.附加标志, 0) As 误差, Nvl(j.医嘱状态, 0) As 医嘱状态
    From 门诊费用记录 A, 病人医嘱记录 J, 材料特性 M
    Where a.医嘱序号 = j.Id(+) And a.No = No_In And a.记录性质 = 1 And a.记录状态 In (1, 3) And a.收费细目id + 0 = m.材料id(+)
    Order By a.收费细目id, a.序号;

  --:不管原始单据误差,都应该根据当前退费产生的误差项进行处理
  -- Decode(Sign(误差_In), 0, 999, 9)

  --该光标用于处理人员缴款余额中退的不同结算方式的金额

  n_结帐id 门诊费用记录.结帐id%Type;
  n_打印id 票据打印内容.Id%Type;

  --部分退费计算变量
  n_剩余数量 Number;
  n_剩余应收 Number;
  n_剩余实收 Number;
  n_剩余统筹 Number;
  n_准退数量 Number;
  n_退费次数 Number;

  n_应收金额 Number;
  n_实收金额 Number;
  n_统筹金额 Number;
  n_总金额   Number;
  n_组id     财务缴款分组.Id%Type;

  l_使用id   t_Numlist := t_Numlist();
  l_序号     t_Numlist := t_Numlist();
  l_执行状态 t_Numlist := t_Numlist();

  n_Dec   Number;
  d_Date  Date;
  n_Count Number;

  Err_Item Exception;
  v_Err_Msg  Varchar2(255);
  n_启用模式 Number(3);
  v_Para     Varchar2(1000);

Begin
  n_组id := Zl_Get组id(操作员姓名_In);
  --是否已经全部完全执行(只是该单据整张单据的检查)
  Select Nvl(Count(*), 0)
  Into n_Count
  From 门诊费用记录
  Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3) And Nvl(执行状态, 0) <> 1;
  If n_Count = 0 Then
    v_Err_Msg := '该单据中的项目已经全部完全执行！';
    Raise Err_Item;
  End If;

  --未完全执行的项目是否有剩余数量(只是整张单据的检查)
  --执行状态在原始记录上判断
  Select Nvl(Count(*), 0)
  Into n_Count
  From (Select 序号, Sum(数量) As 剩余数量
         From (Select 记录状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量, 结帐id
                From 门诊费用记录
                Where NO = No_In And Mod(记录性质, 10) = 1 And Nvl(附加标志, 0) <> 9 And
                      Nvl(价格父号, 序号) In
                      (Select Nvl(价格父号, 序号)
                       From 门诊费用记录
                       Where NO = No_In And Mod(记录性质, 10) = 1 And 记录状态 In (1, 3) And Nvl(执行状态, 0) <> 1)
                Group By 记录状态, Nvl(价格父号, 序号), 结帐id)
         Group By 序号
         Having Sum(数量) <> 0);
  If n_Count = 0 Then
    v_Err_Msg := '该单据中未完全执行部分项目剩余数量为零,没有可以退费的费用！';
    Raise Err_Item;
  End If;

  ---------------------------------------------------------------------------------
  --公用变量
  If 退费时间_In Is Not Null Then
    d_Date := 退费时间_In;
  Else
    Select Sysdate Into d_Date From Dual;
  End If;

  If 结帐id_In Is Null Then
    Select 病人结帐记录_Id.Nextval Into n_结帐id From Dual;
  Else
    n_结帐id := 结帐id_In;
  End If;

  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into n_Dec From Dual;

  --循环处理每行费用(收入项目行)
  n_总金额 := 0;
  For r_Bill In c_Bill Loop
    If Instr(',' || 序号_In || ',', ',' || Nvl(r_Bill.价格父号, r_Bill.序号) || ',') > 0 Or 序号_In Is Null Then
      If Nvl(r_Bill.执行状态, 0) <> 1 Then
        --求剩余数量,剩余应收,剩余实收
        Select Sum(Nvl(付数, 1) * 数次), Sum(应收金额), Sum(实收金额), Sum(统筹金额)
        Into n_剩余数量, n_剩余应收, n_剩余实收, n_剩余统筹
        From 门诊费用记录
        Where NO = No_In And Mod(记录性质, 10) = 1 And 序号 = r_Bill.序号;
      
        If n_剩余数量 = 0 Then
          If 序号_In Is Not Null Then
            v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经全部退费！';
            Raise Err_Item;
          End If;
        Else
          --准退数量(非药品项目为剩余数量,原始数量)
          If Instr(',4,5,6,7,', r_Bill.收费类别) = 0 Or (r_Bill.收费类别 = '4' And Nvl(r_Bill.跟踪在用, 0) = 0) Then
            --@@@
            --非药品部分(以具体医嘱执行为准进行检查)
            --: 1.存在医嘱执行计价的,则以医嘱执行为准(但不能包含:检查;检验;手术;麻醉及输血),已执行的不允许退费
            --: 2.不存在医嘱执行计价的,则以剩余数量为准
            --: 3.医嘱作废了的,则以剩余数量为准(病人医嘱记录.医嘱状态=4表示作废医嘱，会删除"病人医嘱发送",门诊药嘱先作废后退药)
            n_Count := 0;
            If Instr(',C,D,F,G,K,', ',' || r_Bill.诊疗类别 || ',') = 0 And r_Bill.诊疗类别 Is Not Null And r_Bill.医嘱状态 <> 4 Then
              Select Nvl(Sum(Decode(c.执行状态, 0, 1, 0) * c.数量), 0), Count(1)
              Into n_准退数量, n_Count
              From 病人医嘱发送 B, 医嘱执行计价 C
              Where b.医嘱id = r_Bill.医嘱序号 And b.No = r_Bill.No And b.医嘱id = c.医嘱id And b.发送号 = c.发送号 And
                    c.收费细目id + 0 = r_Bill.收费细目id And b.记录性质 = 1;
            End If;
            If Nvl(n_Count, 0) <> 0 And n_准退数量 = 0 Then
              v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已执行，不允许退费！';
              Raise Err_Item;
            End If;
          
            If Nvl(n_Count, 0) = 0 Then
              If r_Bill.执行状态 = 2 Then
                --无医嘱执行计价的部分退费无法判断准退数量，不允许退费
                v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已部分执行，无法判断准退数量，不允许退费！';
                Raise Err_Item;
              Else
                n_准退数量 := n_剩余数量;
              End If;
            End If;
          
          Else
            Select Nvl(Sum(Nvl(付数, 1) * 实际数量), 0), Count(*)
            Into n_准退数量, n_Count
            From 药品收发记录
            Where NO = No_In And 单据 In (8, 24) And Mod(记录状态, 3) = 1 --@@@
                  And 审核人 Is Null And 费用id = r_Bill.Id;
          
            --有剩余数量无准退数量的有两种情况：
            --1.不跟踪在用的卫材无对应的收发记录,这时使用剩余数量
            --2.并发操作,此时已发药或发料
            If n_准退数量 = 0 Then
              If r_Bill.收费类别 = '4' Then
                If n_Count > 0 Then
                  v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已发料,须退料后再退费！';
                  Raise Err_Item;
                Else
                  n_准退数量 := n_剩余数量;
                End If;
              Else
                v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已发药,须退药后再退费！';
                Raise Err_Item;
              End If;
            End If;
          End If;
        
          If n_准退数量 > n_剩余数量 Then
            v_Err_Msg := '单据[' || No_In || '] 中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用的退费数量(' || n_准退数量 ||
                         ')大于了剩余数量(' || n_剩余数量 || ')，不允许退费！';
            Raise Err_Item;
          End If;
          --收费的时候是负数数量的不检查准退数量是否小于零
          If n_准退数量 < 0 And Nvl(r_Bill.付数, 1) * r_Bill.数次 > 0 Then
            v_Err_Msg := '单据[' || No_In || '] 中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用的退费数量(' || n_准退数量 ||
                         ')小于了零，不允许退费！';
            Raise Err_Item;
          End If;
        
          --该笔项目第几次退费
          Select Nvl(Max(Abs(执行状态)), 0) + 1
          Into n_退费次数
          From 门诊费用记录
          Where NO = No_In And Mod(记录性质, 10) = 1 And 记录状态 = 2 And Nvl(执行状态, 0) < 0 And 序号 = r_Bill.序号;
        
          --金额=剩余金额*(准退数/剩余数)
          n_应收金额 := Round(n_剩余应收 * (n_准退数量 / n_剩余数量), n_Dec);
          n_实收金额 := Round(n_剩余实收 * (n_准退数量 / n_剩余数量), n_Dec);
          n_统筹金额 := Round(n_剩余统筹 * (n_准退数量 / n_剩余数量), n_Dec);
          n_总金额   := n_总金额 + n_实收金额;
        
          --插入退费记录
          Insert Into 门诊费用记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 姓名, 性别, 年龄, 标识号, 付款方式, 费别, 病人科室id, 收费类别,
             收费细目id, 计算单位, 付数, 发药窗口, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人,
             执行状态, 费用状态, 执行时间, 操作员编号, 操作员姓名, 发生时间, 登记时间, 结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 结论,
             缴款组id, 挂号id, 主页id)
            Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 姓名, 性别, 年龄, 标识号, 付款方式, 费别,
                   病人科室id, 收费类别, 收费细目id, 计算单位, Decode(Sign(n_准退数量 - Nvl(付数, 1) * 数次), 0, 付数, 1), 发药窗口,
                   Decode(Sign(n_准退数量 - Nvl(付数, 1) * 数次), 0, -1 * 数次, -1 * n_准退数量), 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价,
                   -1 * n_应收金额, -1 * n_实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人, -1 * n_退费次数, 1, 执行时间, 操作员编号_In, 操作员姓名_In,
                   发生时间, d_Date, n_结帐id, -1 * n_实收金额, 保险项目否, 保险大类id, -1 * n_统筹金额, Nvl(退费摘要_In, 摘要),
                   Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码, 费用类型, 结论, n_组id, 挂号id, 主页id
            From 门诊费用记录
            Where ID = r_Bill.Id;
        
          --标记原费用记录
          l_序号.Extend;
          l_序号(l_序号.Count) := r_Bill.序号;
          l_执行状态.Extend;
          l_执行状态(l_执行状态.Count) := Case
                                    When Sign(n_准退数量 - n_剩余数量) = 0 Then
                                     0
                                    Else
                                     1
                                  End;
        End If;
      Else
        If 序号_In Is Not Null Then
          v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经完全执行,不能退费！';
          Raise Err_Item;
        End If;
      End If;
    End If;
  End Loop;
  --标记原费用记录
  Forall I In 1 .. l_序号.Count
    Update 门诊费用记录
    Set 记录状态 = 3, 执行状态 = l_执行状态(I)
    Where Mod(记录性质, 10) = 1 And NO = No_In And 序号 = l_序号(I) And 记录状态 In (1, 3);

  l_序号.Delete;
  For c_结帐 In (Select Distinct b.结帐id
               From 门诊费用记录 A, 病人预交记录 B
               Where a.结帐id = b.结帐id And a.No = No_In And Mod(a.记录性质, 10) = 1 And a.记录状态 In (1, 3) And
                     Nvl(b.记录状态, 0) = 1) Loop
    l_序号.Extend;
    l_序号(l_序号.Count) := c_结帐.结帐id;
  End Loop;

  Forall I In 1 .. l_序号.Count
    Update 病人预交记录 Set 记录状态 = 3 Where 结帐id = l_序号(I) And Mod(记录性质, 10) <> 1;

  ---------------------------------------------------------------------------------
  --退费票据回收(仅全退时才回退,部分退是在重打过程中回收)
  If 回收票据_In = 1 Then
  
    --启用标志||NO;执行科室(条数);收据费目(首页汇总,条数);收费细目(条数)
    v_Para     := Nvl(zl_GetSysParameter('票据分配规则', 1121), '0||0;0;0,0;0');
    n_启用模式 := Zl_To_Number(Substr(v_Para, 1, 1));
    If n_启用模式 <> 0 Then
      --收回票据
      Select 使用id Bulk Collect
      Into l_使用id
      From (Select Distinct b.使用id From 票据打印明细 B Where b.No = No_In And Nvl(b.票种, 0) = 1);
    
      n_启用模式 := l_使用id.Count;
      If l_使用id.Count <> 0 Then
        --插入回收记录
        Forall I In 1 .. l_使用id.Count
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用人, 使用时间)
            Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, 操作员姓名_In, d_Date
            From 票据使用明细 A
            Where ID = l_使用id(I) And 性质 = 1 And Not Exists
             (Select 1 From 票据使用明细 Where 号码 = a.号码 And 票种 = a.票种 And Nvl(性质, 0) <> 1);
      
        Forall I In 1 .. l_使用id.Count
          Update 票据打印明细 Set 是否回收 = 1 Where 使用id = l_使用id(I) And Nvl(是否回收, 0) = 0;
      
      End If;
    End If;
    If n_启用模式 = 0 Then
      --获取单据最后一次的打印ID(可能是多张单据收费打印)
      Begin
        --性质=1，原因=6为退费打印票据(红票)，不回收
        Select ID
        Into n_打印id
        From (Select b.Id
               From 票据使用明细 A, 票据打印内容 B
               Where a.打印id = b.Id And a.性质 = 1 And a.原因 In (1, 3) And b.数据性质 = 1 And b.No = No_In
               Order By a.使用时间 Desc)
        Where Rownum < 2;
      Exception
        When Others Then
          Null;
      End;
      --可能以前没有打印,无收回
      If n_打印id Is Not Null Then
        --a.多张单据循环调用时只能收回一次
        Select Count(*) Into n_Count From 票据使用明细 Where 票种 = 1 And 性质 = 2 And 打印id = n_打印id;
        If n_Count = 0 Then
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
            Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, d_Date, 操作员姓名_In
            From 票据使用明细
            Where 打印id = n_打印id And 票种 = 1 And 性质 = 1;
        Else
          --b.部分退费多次收回时,最后一次全退收回要排开已收回的
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
            Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, d_Date, 操作员姓名_In
            From 票据使用明细 A
            Where 打印id = n_打印id And 票种 = 1 And 性质 = 1 And Not Exists
             (Select 1 From 票据使用明细 B Where a.号码 = b.号码 And 打印id = n_打印id And 票种 = 1 And 性质 = 2);
        End If;
      End If;
    End If;
  End If;

  ---------------------------------------------------------------------------------
  --药品卫材相关内容
  --必须按照“收费细目id”升序排序，防止并发锁“药品库存”表
  For r_Expenses In (Select ID
                     From 门诊费用记录
                     Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3) And 收费类别 In ('4', '5', '6', '7') And
                           (Instr(',' || 序号_In || ',', ',' || 序号 || ',') > 0 Or 序号_In Is Null)
				     Order By 收费细目ID) Loop
    Zl_药品收发记录_销售退费(r_Expenses.Id);
  End Loop;

  --医嘱处理
  --删除病人医嘱附费(最后一次删除时)
  For c_医嘱 In (Select Distinct 医嘱序号
               From 门诊费用记录
               Where NO = No_In And Mod(记录性质, 10) = 1 And 记录状态 = 3 And 医嘱序号 Is Not Null) Loop
    Select Nvl(Count(*), 0)
    Into n_Count
    From (Select 序号, Sum(数量) As 剩余数量
           From (Select 记录状态, 执行状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                  From 门诊费用记录
                  Where Mod(记录性质, 10) = 1 And Nvl(附加标志, 0) <> 9 And 医嘱序号 + 0 = c_医嘱.医嘱序号 And NO = No_In
                  Group By 记录状态, 执行状态, Nvl(价格父号, 序号))
           Group By 序号
           Having Sum(数量) <> 0);
  
    If n_Count = 0 Then
      Delete From 病人医嘱附费 Where 医嘱id = c_医嘱.医嘱序号 And 记录性质 = 1 And NO = No_In;
    End If;
  End Loop;

  --调整医嘱执行计价.执行状态 NULL-历史数据；0-未执行；1-已执行；2-已退费
  For c_费用 In (Select Distinct a.医嘱序号 As 医嘱id, a.收费细目id, b.发送号
               From 门诊费用记录 A, 病人医嘱发送 B
               Where a.医嘱序号 = b.医嘱id And a.No = b.No And a.记录性质 = 1 And a.记录状态 In (1, 3) And a.No = No_In And
                     (Instr(',' || 序号_In || ',', ',' || a.序号 || ',') > 0 Or 序号_In Is Null) And a.价格父号 Is Null And
                     b.记录性质 = 1) Loop
    Update 医嘱执行计价
    Set 执行状态 = 2
    Where 医嘱id = c_费用.医嘱id And 发送号 = c_费用.发送号 And 收费细目id = c_费用.收费细目id And 执行状态 = 0;
  End Loop;

  --场合_In    Integer:=0, --0:门诊;1-住院
  --性质_In    Integer:=1, --1-收费单;2-记帐单
  --操作_In    Integer:=0, --0:删除划价单;1-收费或记帐;2-退费或销帐
  --No_In      门诊费用记录.No%Type,
  --医嘱ids_In Varchar2 := Null
  Zl_医嘱发送_计费状态_Update(0, 1, 2, No_In);
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊收费记录_销帐;
/

--108264:刘尔旋,2017-04-17,销账附加费用处理问题
--106722:冉俊明,2017-03-10,退费在处理药品库存时，收费项目未按药品ID排序，可能会导致死锁发生。
Create Or Replace Procedure Zl_门诊记帐记录_Delete
(
  No_In         门诊费用记录.No%Type,
  序号_In       Varchar2,
  操作员编号_In 门诊费用记录.操作员编号%Type,
  操作员姓名_In 门诊费用记录.操作员姓名%Type
) As
  --功能：冲销一张门诊记帐单据中指定序号行
  --序号：格式如"1,3,5,7,8",为空表示冲销所有可冲销行
  --该光标用于销帐指定费用行

  --该游标为要退费单据的所有原始记录
  Cursor c_Bill(n_标志 Number) Is
    Select a.Id, a.价格父号, a.序号, a.执行状态, a.收费类别, a.医嘱序号, a.病人id, a.收入项目id, a.开单部门id, a.执行部门id, a.病人科室id, a.实收金额,
           Decode(a.记录状态, 0, 1, 0) As 划价, j.诊疗类别, m.跟踪在用
    From 门诊费用记录 A, 病人医嘱记录 J, 材料特性 M
    Where a.医嘱序号 = j.Id(+) And a.收费细目id + 0 = m.材料id(+) And a.No = No_In And a.记录性质 = 2 And a.记录状态 In (0, 1, 3) And
          a.门诊标志 = n_标志
    Order By a.收费细目id, a.序号;

  --该游标用于处理费用记录序号
  Cursor c_Serial Is
    Select 序号, 价格父号 From 门诊费用记录 Where NO = No_In And 记录性质 = 2 And 记录状态 In (0, 1, 3) Order By 序号;
  l_划价 t_Numlist := t_Numlist();

  n_医嘱id   病人医嘱记录.Id%Type;
  v_医嘱ids  Varchar2(4000);
  n_父号     门诊费用记录.价格父号%Type;
  n_门诊标志 门诊费用记录.门诊标志%Type;

  --部分退费计算变量
  n_剩余数量 Number;
  n_剩余应收 Number;
  n_剩余实收 Number;
  n_剩余统筹 Number;

  n_准退数量 Number;
  n_退费次数 Number;

  n_应收金额 Number;
  n_实收金额 Number;
  n_统筹金额 Number;

  n_Dec Number;

  n_Count   Number;
  d_Curdate Date;
  Err_Item Exception;
  v_Err_Msg Varchar2(255);
Begin
  --是否已经全部完全执行(只是整张单据的检查)
  Select Nvl(Count(*), 0), Max(Nvl(门诊标志, 1))
  Into n_Count, n_门诊标志
  From 门诊费用记录
  Where NO = No_In And 记录性质 = 2 And 记录状态 In (0, 1, 3) And Nvl(执行状态, 0) <> 1;
  If n_Count = 0 Then
    v_Err_Msg := '该单据中的项目已经全部完全执行！';
    Raise Err_Item;
  End If;

  If Nvl(n_门诊标志, 0) = 0 Then
    n_门诊标志 := 1;
  End If;

  --未完全执行的项目是否有剩余数量(只是整张单据的检查)
  Select Nvl(Count(*), 0)
  Into n_Count
  From (Select 序号, Sum(数量) As 剩余数量
         From (Select 记录状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                From 门诊费用记录
                Where NO = No_In And 记录性质 = 2 And 门诊标志 = n_门诊标志 And
                      Nvl(价格父号, 序号) In
                      (Select Nvl(价格父号, 序号)
                       From 门诊费用记录
                       Where NO = No_In And 记录性质 = 2 And 门诊标志 = n_门诊标志 And 记录状态 In (0, 1, 3) And Nvl(执行状态, 0) <> 1)
                Group By 记录状态, Nvl(价格父号, 序号))
         Group By 序号
         Having Sum(数量) <> 0);
  If n_Count = 0 Then
    v_Err_Msg := '该单据中未完全执行部分项目剩余数量为零,没有可以销帐的费用！';
    Raise Err_Item;
  End If;

  ---------------------------------------------------------------------------------
  --公用变量
  Select Sysdate Into d_Curdate From Dual;

  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into n_Dec From Dual;

  --循环处理每行费用(收入项目行)
  For r_Bill In c_Bill(n_门诊标志) Loop
    If Instr(',' || 序号_In || ',', ',' || Nvl(r_Bill.价格父号, r_Bill.序号) || ',') > 0 Or 序号_In Is Null Then
    
      If r_Bill.划价 = 0 Then
        If Nvl(r_Bill.执行状态, 0) <> 1 Then
          --求剩余数量,剩余应收,剩余实收
          Select Sum(Nvl(付数, 1) * 数次), Sum(应收金额), Sum(实收金额), Sum(统筹金额)
          Into n_剩余数量, n_剩余应收, n_剩余实收, n_剩余统筹
          From 门诊费用记录
          Where NO = No_In And 记录性质 = 2 And 序号 = r_Bill.序号;
        
          If n_剩余数量 = 0 Then
            If 序号_In Is Not Null Then
              v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经全部销帐！';
              Raise Err_Item;
            End If;
            --情况：未限定行号,原始单据中的该笔已经全部销帐(执行状态=0的一种可能)
          Else
            --准销数量(非药品项目为剩余数量,原始数量)
            If Instr(',4,5,6,7,', r_Bill.收费类别) = 0 Or (r_Bill.收费类别 = '4' And Nvl(r_Bill.跟踪在用, 0) = 0) Then
            
              --@@@
              --非药品部分(以具体医嘱执行为准进行检查)
              --: 1.存在医嘱发送的,则以医嘱执行为准(但不能包含:检查;检验;手术;麻醉及输血)
              --: 2.对于病人医吃计价中的收费方式为:0-正常收取 的,才支持部分退;如果是其他的,则只能全退
              --: 3.不存在医嘱的,则以剩余数量为准
              n_Count := 0;
              If Instr(',C,D,F,G,K,', ',' || r_Bill.诊疗类别 || ',') = 0 And r_Bill.诊疗类别 Is Not Null Then
              
                Select Nvl(Sum(数量), 0), Count(*)
                Into n_准退数量, n_Count
                From (Select j.医嘱序号 As 医嘱id, j.收费细目id, Nvl(j.付数, 1) * Nvl(j.数次, 1) As 数量
                       From 门诊费用记录 J, 病人医嘱记录 M
                       Where j.医嘱序号 = m.Id And j.No = No_In And j.记录性质 = 2 And j.序号 = r_Bill.序号 And j.记录状态 In (1, 3) And
                             Exists
                        (Select 1
                              From 病人医嘱发送 A
                              Where a.医嘱id = j.医嘱序号 And Nvl(a.执行状态, 0) <> 1 And a.No || '' = No_In) And Exists
                        (Select 1
                              From 病人医嘱计价 A
                              Where a.医嘱id = j.医嘱序号 And a.收费细目id = j.收费细目id And Nvl(a.收费方式, 0) = 0) And j.价格父号 Is Null And
                             Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And
                             (j.记录状态 In (1, 3) And Not Exists
                              (Select 1
                               From 药品收发记录
                               Where 费用id = j.Id And Instr(',8,9,10,21,24,25,26,', ',' || 单据 || ',') > 0) Or
                              j.记录状态 = 2 And Not Exists
                              (Select 1 From 药品收发记录 Where NO = No_In And 单据 In (8, 24) And 药品id = j.收费细目id))
                       Union All
                       Select a.医嘱id, a.收费细目id, -1 * Nvl(a.数量, 1) * Nvl(c.本次数次, 1) As 数量
                       From 病人医嘱计价 A, 病人医嘱发送 B, 病人医嘱执行 C, 门诊费用记录 J, 病人医嘱记录 M
                       Where a.医嘱id = b.医嘱id And b.医嘱id = c.医嘱id And Nvl(a.收费方式, 0) = 0 And b.发送号 = c.发送号 And
                             a.医嘱id = m.Id And Nvl(c.执行结果, 1) = 1 And Nvl(b.执行状态, 0) <> 1 And a.医嘱id = j.医嘱序号 And
                             a.收费细目id = j.收费细目id And j.No = No_In And j.记录性质 = 2 And j.序号 = r_Bill.序号 And
                             j.记录状态 In (1, 3) And j.价格父号 Is Null And Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And
                             Not Exists
                        (Select 1
                              From 药品收发记录
                              Where 费用id = j.Id And Instr(',8,9,10,21,24,25,26,', ',' || 单据 || ',') > 0) And Not Exists
                        (Select 1 From 材料特性 Where 材料id = j.收费细目id And Nvl(跟踪在用, 0) = 1)
                       Union All
                       Select a.医嘱id, a.收费细目id, 0 As 数量
                       From 病人医嘱计价 A, 门诊费用记录 J, 病人医嘱记录 M
                       Where a.医嘱id = m.Id And a.医嘱id = j.医嘱序号 And a.收费细目id = j.收费细目id And Nvl(a.收费方式, 0) <> 0 And
                             j.No = No_In And j.记录性质 = 2 And Nvl(j.执行状态, 0) = 2 And Not Exists
                        (Select 1 From 材料特性 Where 材料id = j.收费细目id And Nvl(跟踪在用, 0) = 1) And
                             Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0);
              
              End If;
            
              If Nvl(n_Count, 0) = 0 Then
                n_准退数量 := n_剩余数量;
              End If;
            
            Else
              Select Sum(Nvl(付数, 1) * 实际数量)
              Into n_准退数量
              From 药品收发记录
              Where NO = No_In And 单据 In (9, 25) And Mod(记录状态, 3) = 1 And 审核人 Is Null And 费用id = r_Bill.Id;
            
              --不跟踪在用的卫生材料
              If r_Bill.收费类别 = '4' And Nvl(n_准退数量, 0) = 0 Then
                n_准退数量 := n_剩余数量;
              End If;
            End If;
          
            --处理门诊费用记录
          
            --该笔项目第几次销帐
            Select Nvl(Max(Abs(执行状态)), 0) + 1
            Into n_退费次数
            From 门诊费用记录
            Where NO = No_In And 记录性质 = 2 And 记录状态 = 2 And 序号 = r_Bill.序号;
          
            --金额=剩余金额*(准退数/剩余数)
            n_应收金额 := Round(n_剩余应收 * (n_准退数量 / n_剩余数量), n_Dec);
            n_实收金额 := Round(n_剩余实收 * (n_准退数量 / n_剩余数量), n_Dec);
            n_统筹金额 := Round(n_剩余统筹 * (n_准退数量 / n_剩余数量), n_Dec);
          
            --插入退费记录
            Insert Into 门诊费用记录
              (ID, NO, 记录性质, 记录状态, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 婴儿费, 姓名, 性别, 年龄, 标识号, 付款方式, 费别, 病人科室id, 收费类别,
               收费细目id, 计算单位, 付数, 发药窗口, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 划价人,
               执行人, 执行状态, 执行时间, 操作员编号, 操作员姓名, 发生时间, 登记时间, 保险项目否, 保险大类id, 统筹金额, 记帐单id, 摘要, 保险编码, 是否急诊, 结论)
              Select 病人费用记录_Id.Nextval, NO, 记录性质, 2, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 婴儿费, 姓名, 性别, 年龄, 标识号, 付款方式, 费别,
                     病人科室id, 收费类别, 收费细目id, 计算单位, Decode(Sign(n_准退数量 - Nvl(付数, 1) * 数次), 0, 付数, 1), 发药窗口,
                     Decode(Sign(n_准退数量 - Nvl(付数, 1) * 数次), 0, -1 * 数次, -1 * n_准退数量), 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用,
                     标准单价, -1 * n_应收金额, -1 * n_实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人, -1 * n_退费次数, 执行时间, 操作员编号_In,
                     操作员姓名_In, 发生时间, d_Curdate, 保险项目否, 保险大类id, -1 * n_统筹金额, 记帐单id, 摘要, 保险编码, 是否急诊, 结论
              From 门诊费用记录
              Where ID = r_Bill.Id;
          
            --记录病人医嘱附费对应的医嘱ID(不是主费用)
            If n_医嘱id Is Null And r_Bill.医嘱序号 Is Not Null Then
              n_医嘱id := r_Bill.医嘱序号;
            End If;
          
            --病人余额
            If n_门诊标志 <> 4 Then
              Update 病人余额
              Set 费用余额 = Nvl(费用余额, 0) - n_实收金额
              Where 病人id = r_Bill.病人id And 性质 = 1 And 类型 = 1;
              If Sql%RowCount = 0 Then
                Insert Into 病人余额
                  (病人id, 性质, 类型, 费用余额, 预交余额)
                Values
                  (r_Bill.病人id, 1, 1, -1 * n_实收金额, 0);
              End If;
            End If;
          
            --病人未结费用
            Update 病人未结费用
            Set 金额 = Nvl(金额, 0) - n_实收金额
            Where 病人id = r_Bill.病人id And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And
                  Nvl(病人科室id, 0) = Nvl(r_Bill.病人科室id, 0) And Nvl(开单部门id, 0) = Nvl(r_Bill.开单部门id, 0) And
                  Nvl(执行部门id, 0) = Nvl(r_Bill.执行部门id, 0) And 收入项目id + 0 = r_Bill.收入项目id And 来源途径 + 0 = n_门诊标志;
            If Sql%RowCount = 0 Then
              Insert Into 病人未结费用
                (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
              Values
                (r_Bill.病人id, Null, Null, r_Bill.病人科室id, r_Bill.开单部门id, r_Bill.执行部门id, r_Bill.收入项目id, n_门诊标志,
                 -1 * n_实收金额);
            End If;
          
            --标记原费用记录
            --执行状态:全部退完(准退数=剩余数)标记为0,否则标记为1
            Update 门诊费用记录
            Set 记录状态 = 3, 执行状态 = Decode(Sign(n_准退数量 - n_剩余数量), 0, 0, 1)
            Where ID = r_Bill.Id;
          End If;
        Else
          If 序号_In Is Not Null Then
            v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经完全执行,不能销帐！';
            Raise Err_Item;
          End If;
          --情况:没限定行号,原始单据中包括已经完全执行的
        End If;
      End If;
    End If;
  End Loop;

  ---------------------------------------------------------------------------------
  --药品相关内容
  --必须按照“收费细目id”升序排序，防止并发锁“药品库存”表
  For r_Expenses In (Select ID
                     From 门诊费用记录
                     Where NO = No_In And 记录性质 = 2 And 记录状态 In (0, 1, 3) And 收费类别 In ('4', '5', '6', '7') And
                           门诊标志 = n_门诊标志 And (Instr(',' || 序号_In || ',', ',' || 序号 || ',') > 0 Or 序号_In Is Null)
                     Order By 收费细目id) Loop
    Zl_药品收发记录_销售退费(r_Expenses.Id);
  End Loop;

  ---------------------------------------------------------------------------------
  --如果是划价,直接删除费用记录(药品处理后)
  n_Count   := 0;
  v_医嘱ids := Null;
  For r_Bill In c_Bill(n_门诊标志) Loop
    If Instr(',' || 序号_In || ',', ',' || Nvl(r_Bill.价格父号, r_Bill.序号) || ',') > 0 Or 序号_In Is Null Then
      If r_Bill.划价 = 1 Then
        If Nvl(r_Bill.执行状态, 0) <> 1 Then
          l_划价.Extend;
          l_划价(l_划价.Count) := r_Bill.Id;
        
          --Delete From 门诊费用记录 Where ID = r_Bill.ID;
          n_Count := n_Count + 1; --记录是否有删除行
        
          If r_Bill.医嘱序号 Is Not Null Then
            If Instr(',' || Nvl(v_医嘱ids, '') || ',', ',' || r_Bill.医嘱序号 || ',') = 0 Then
              v_医嘱ids := Nvl(v_医嘱ids, '') || ',' || r_Bill.医嘱序号;
            End If;
          
            --记录病人医嘱附费对应的医嘱ID(不是主费用)
            If n_医嘱id Is Null Then
              n_医嘱id := r_Bill.医嘱序号;
            End If;
          End If;
        Else
          If 序号_In Is Not Null Then
            v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经完全执行,不能销帐！';
            Raise Err_Item;
          End If;
          --情况:没限定行号,原始单据中包括已经完全执行的
        End If;
      End If;
    End If;
  End Loop;

  --删除划价记录
  Forall I In 1 .. l_划价.Count
    Delete From 门诊费用记录 Where ID = l_划价(I);

  --删除之后再统一调整序号
  If n_Count > 0 Then
    n_Count := 1;
    For r_Serial In c_Serial Loop
      If r_Serial.价格父号 Is Null Then
        n_父号 := n_Count;
      End If;
    
      Update 门诊费用记录
      Set 序号 = n_Count, 价格父号 = Decode(价格父号, Null, Null, n_父号)
      Where NO = No_In And 记录性质 = 2 And 序号 = r_Serial.序号;
    
      Update 门诊费用记录 Set 从属父号 = n_Count Where NO = No_In And 记录性质 = 2 And 从属父号 = r_Serial.序号;
    
      n_Count := n_Count + 1;
    End Loop;
  End If;

  --整张单据全部冲完时，删除病人医嘱附费
  For c_医嘱 In (Select Distinct 医嘱序号
               From 门诊费用记录
               Where NO = No_In And 记录性质 = 2 And 记录状态 = 3 And 医嘱序号 Is Not Null) Loop
    Select Nvl(Count(*), 0)
    Into n_Count
    From (Select 序号, Sum(数量) As 剩余数量
           From (Select 记录状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                  From 门诊费用记录
                  Where 记录性质 = 2 And 医嘱序号 + 0 = c_医嘱.医嘱序号 And NO = No_In
                  Group By 记录状态, Nvl(价格父号, 序号))
           Group By 序号
           Having Sum(数量) <> 0);
  
    If n_Count = 0 Then
      Delete From 病人医嘱附费 Where 医嘱id = c_医嘱.医嘱序号 And 记录性质 = 2 And NO = No_In;
    End If;
  End Loop;

  If v_医嘱ids Is Not Null Then
    --医嘱处理
    --场合_In    Integer:=0, --0:门诊;1-住院
    --性质_In    Integer:=1, --1-收费单;2-记帐单
    --操作_In    Integer:=0, --0:删除划价单;1-收费或记帐;2-退费或销帐
    --No_In      门诊费用记录.No%Type,
    --医嘱ids_In Varchar2 := Null
    v_医嘱ids := Substr(v_医嘱ids, 2);
    Zl_医嘱发送_计费状态_Update(0, 2, 0, No_In, v_医嘱ids);
  Else
    Zl_医嘱发送_计费状态_Update(0, 2, 2, No_In, v_医嘱ids);
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊记帐记录_Delete;
/

--106722:冉俊明,2017-03-10,退费在处理药品库存时，收费项目未按药品ID排序，可能会导致死锁发生。
Create Or Replace Procedure Zl_门诊简单收费_Delete
(
  No_In         门诊费用记录.No%Type,
  操作员编号_In 门诊费用记录.操作员编号%Type,
  操作员姓名_In 门诊费用记录.操作员姓名%Type
) As
  --功能：删除一张门诊简单收费单据

  --该游标为要退费单据的所有原始记录
  Cursor c_Bill Is
    Select a.Id, a.No, a.附加标志, a.收费细目id, a.序号, a.价格父号, a.执行状态, a.收费类别, a.付数, a.数次, a.医嘱序号, j.诊疗类别, m.跟踪在用
    From 门诊费用记录 A, 病人医嘱记录 J, 材料特性 M
    Where a.医嘱序号 = j.Id(+) And a.No = No_In And a.记录性质 = 1 And a.记录状态 In (1, 3) And a.收费细目id + 0 = m.材料id(+)
    Order By a.收费细目id, a.序号;

  --该光标用于处理人员缴款余额中退的不同结算方式的金额
  Cursor c_Money(冲销id_In 病人预交记录.结帐id%Type) Is
    Select 结算方式, 冲预交
    From 病人预交记录
    Where 记录性质 = 3 And 记录状态 = 2 And 结帐id = 冲销id_In And 结算方式 Is Not Null And Nvl(冲预交, 0) <> 0 And Nvl(校对标志, 0) = 0;

  --该游标用于查找收费时使用过的冲预交款记录
  Cursor c_Deposit(V结帐id 病人预交记录.结帐id%Type) Is
    Select ID, 病人id, 冲预交 As 金额, 预交类别
    From 病人预交记录
    Where 记录性质 In (1, 11) And 记录状态 In (1, 3) And 结帐id = V结帐id And Nvl(冲预交, 0) <> 0
    Order By ID Desc;

  n_病人id   病人信息.病人id%Type;
  n_结帐id   门诊费用记录.结帐id%Type;
  n_结算序号 病人预交记录.结算序号%Type;
  n_打印id   票据打印内容.Id%Type;

  n_预交金额 病人预交记录.冲预交%Type;
  n_返回值   病人预交记录.冲预交%Type;
  --部分退费计算变量
  n_剩余数量 Number;
  n_剩余应收 Number;
  n_剩余实收 Number;
  n_剩余统筹 Number;
  n_准退数量 Number;
  n_退费次数 Number;

  n_应收金额 Number;
  n_实收金额 Number;
  n_统筹金额 Number;
  n_总金额   Number;
  n_费用状态 门诊费用记录.费用状态%Type;
  n_正常退费 Number; --是否第一次退费且全部退费,在每行退费过程中判断得到。
  n_组id     财务缴款分组.Id%Type;

  v_退费结算 结算方式.名称%Type;
  l_使用id   t_Numlist := t_Numlist();
  n_Dec      Number;
  d_Date     Date;
  n_Count    Number;
  n_原结帐id Number;

  Err_Item Exception;
  v_Err_Msg      Varchar2(255);
  n_启用模式     Number(3);
  v_Para         Varchar2(1000);
  n_医属执行计价 Number;
Begin
  n_组id := Zl_Get组id(操作员姓名_In);

  --是否已经全部完全执行(只是该单据整张单据的检查)
  Select Nvl(Count(*), 0)
  Into n_Count
  From 门诊费用记录
  Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3) And Nvl(执行状态, 0) <> 1;
  If n_Count = 0 Then
    v_Err_Msg := '该单据中的项目已经全部完全执行！';
    Raise Err_Item;
  End If;

  --未完全执行的项目是否有剩余数量(只是整张单据的检查)
  --执行状态在原始记录上判断
  Select Nvl(Count(*), 0)
  Into n_Count
  From (Select 序号, Sum(数量) As 剩余数量
         From (Select 记录状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                From 门诊费用记录
                Where NO = No_In And 记录性质 = 1 And Nvl(附加标志, 0) <> 9 And
                      Nvl(价格父号, 序号) In
                      (Select Nvl(价格父号, 序号)
                       From 门诊费用记录
                       Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3) And Nvl(执行状态, 0) <> 1)
                Group By 记录状态, Nvl(价格父号, 序号))
         Group By 序号
         Having Sum(数量) <> 0);
  If n_Count = 0 Then
    v_Err_Msg := '该单据中未完全执行部分项目剩余数量为零,没有可以退费的费用！';
    Raise Err_Item;
  End If;
  --确定是否在医嘱执行计价中存在数据,如果存在数据,则根据医嘱执行计价进行退费,否则按旧方式进行处理
  Select Count(1)
  Into n_医属执行计价
  From 门诊费用记录 A, 医嘱执行计价 B
  Where a.医嘱序号 = b.医嘱id And a.记录性质 = 1 And a.No = No_In And a.记录状态 In (1, 3) And Rownum = 1;

  ---------------------------------------------------------------------------------
  --公用变量
  Select Sysdate Into d_Date From Dual;
  Select 病人结帐记录_Id.Nextval Into n_结帐id From Dual;
  n_结算序号 := Null;

  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into n_Dec From Dual;

  --获取结算方式名称
  Begin
    Select 名称 Into v_退费结算 From 结算方式 Where 性质 = 1;
  Exception
    When Others Then
      v_退费结算 := '现金';
  End;

  ---------------------------------------------------------------------------------
  --循环处理每行费用(收入项目行)
  n_总金额   := 0;
  n_正常退费 := 1;
  For r_Bill In c_Bill Loop
    If Nvl(r_Bill.执行状态, 0) <> 1 Then
      --求剩余数量,剩余应收,剩余实收
      Select Sum(Nvl(付数, 1) * 数次), Sum(应收金额), Sum(实收金额), Sum(统筹金额)
      Into n_剩余数量, n_剩余应收, n_剩余实收, n_剩余统筹
      From 门诊费用记录
      Where NO = No_In And 记录性质 = 1 And 序号 = r_Bill.序号;
    
      If n_剩余数量 = 0 Then
        --情况：未限定行号,原始单据中的该笔已经全部退费(执行状态=0的一种可能)
        n_正常退费 := 0;
      Else
        --准退数量(非药品项目为剩余数量,原始数量)
        If Instr(',4,5,6,7,', r_Bill.收费类别) = 0 Or (r_Bill.收费类别 = '4' And Nvl(r_Bill.跟踪在用, 0) = 0) Then
          --@@@
          --非药品部分(以具体医嘱执行为准进行检查)
          --: 1.存在医嘱发送的,则以医嘱执行为准(但不能包含:检查;检验;手术;麻醉及输血)
          --: 2.不存在医嘱的,则以剩余数量为准
          n_Count := 0;
          If Instr(',C,D,F,G,K,', ',' || r_Bill.诊疗类别 || ',') = 0 And r_Bill.诊疗类别 Is Not Null Then
            If n_医属执行计价 = 1 Then
              Select Decode(Sign(Sum(数量)), -1, 0, Sum(数量)), Count(*)
              Into n_准退数量, n_Count
              From (Select Max(Decode(a.记录状态, 2, 0, a.Id)) As ID, Max(a.医嘱序号) As 医嘱id, Max(a.收费细目id) As 收费细目id,
                            Sum(Nvl(a.付数, 1) * Nvl(a.数次, 1)) As 数量,
                            Sum(Decode(a.记录状态, 2, 0, Nvl(a.付数, 1) * Nvl(a.数次, 1))) As 原始数量
                     From 门诊费用记录 A, 病人医嘱记录 M
                     Where a.医嘱序号 = m.Id And Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And
                           Instr('5,6,7', a.收费类别) = 0 And a.No = No_In And a.序号 = r_Bill.序号 And a.记录性质 = 1 And
                           a.记录状态 In (1, 2, 3) And a.价格父号 Is Null
                     Group By a.序号
                     Union All
                     Select a.Id, a.医嘱序号 As 医嘱id, a.收费细目id, -1 * b.数量 As 已执行, 0 原始数量
                     From 门诊费用记录 A, 医嘱执行计价 B, 病人医嘱记录 M
                     Where a.医嘱序号 = b.医嘱id And a.收费细目id = b.收费细目id + 0 And a.医嘱序号 = m.Id And
                           Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And Instr('5,6,7', a.收费类别) = 0 And
                           (Exists
                            (Select 1
                             From 病人医嘱执行
                             Where b.医嘱id = 医嘱id And b.发送号 = 发送号 And b.要求时间 = 要求时间 And Nvl(执行结果, 0) = 1) Or Exists
                            (Select 1
                             From 病人医嘱发送
                             Where b.医嘱id = 医嘱id And b.发送号 = 发送号 And Nvl(执行状态, 0) = 1)) And Not Exists
                      (Select 1
                            From 病人医嘱附费
                            Where a.医嘱序号 = 医嘱id And a.No = NO And Mod(a.记录性质, 10) = 记录性质) And a.No = No_In And
                           a.序号 = r_Bill.序号 And a.记录性质 = 1 And a.记录状态 In (1, 3) 　and a.价格父号 Is Null) Q1
              Where Not Exists (Select 1 From 药品收发记录 Where 费用id = Q1.Id) Having Max(ID) <> 0;
            Else
              Select Nvl(Sum(数量), 0), Count(*)
              Into n_准退数量, n_Count
              From (Select a.医嘱id, a.收费细目id, Nvl(a.数量, 1) * Nvl(b.发送数次, 1) As 数量
                     From 病人医嘱计价 A, 病人医嘱发送 B, 门诊费用记录 J, 病人医嘱记录 M
                     Where a.医嘱id = b.医嘱id And a.医嘱id = m.Id And Nvl(b.执行状态, 0) <> 1 And a.医嘱id = j.医嘱序号 And
                           a.收费细目id = j.收费细目id And j.No = No_In And j.记录性质 = 1 And j.序号 = r_Bill.序号 And j.记录状态 In (1, 3) And
                           j.价格父号 Is Null And Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And Exists
                      (Select 1
                            From 病人医嘱计价 A
                            Where a.医嘱id = j.医嘱序号 And a.收费细目id = j.收费细目id And Nvl(a.收费方式, 0) = 0) And Not Exists
                      (Select 1 From 药品收发记录 Where 费用id = j.Id)
                     Union All
                     Select a.医嘱id, a.收费细目id, -1 * Nvl(a.数量, 1) * Nvl(c.本次数次, 1) As 数量
                     From 病人医嘱计价 A, 病人医嘱发送 B, 病人医嘱执行 C, 门诊费用记录 J, 病人医嘱记录 M
                     Where a.医嘱id = b.医嘱id And b.医嘱id = c.医嘱id And b.发送号 = c.发送号 And a.医嘱id = m.Id And Nvl(c.执行结果, 1) = 1 And
                           Nvl(b.执行状态, 0) <> 1 And a.医嘱id = j.医嘱序号 And a.收费细目id = j.收费细目id And j.No = No_In And
                           j.记录性质 = 1 And Nvl(a.收费方式, 0) = 0 And j.序号 = r_Bill.序号 And j.记录状态 In (1, 3) And j.价格父号 Is Null And
                           Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And Not Exists
                      (Select 1 From 药品收发记录 Where 费用id = j.Id) And Not Exists
                      (Select 1 From 材料特性 Where 材料id = j.收费细目id And Nvl(跟踪在用, 0) = 1)
                     Union All
                     Select a.医嘱序号 As 医嘱id, a.收费细目id, Nvl(a.付数, 1) * a.数次 As 数量
                     From 门诊费用记录 A, 病人医嘱记录 M
                     Where a.医嘱序号 = m.Id And Instr(',C,D,F,G,K,', ',' || m.诊疗类别 || ',') = 0 And a.No = No_In And
                           a.记录性质 = 1 And a.序号 = r_Bill.序号 And a.记录状态 = 2 And a.价格父号 Is Null And Not Exists
                      (Select 1 From 药品收发记录 Where NO = No_In And 单据 In (8, 24) And 药品id = a.收费细目id));
            End If;
          End If;
          If Nvl(n_Count, 0) <> 0 And n_准退数量 = 0 Then
            v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已执行,不允许退费！';
            Raise Err_Item;
          End If;
        
          If Nvl(n_Count, 0) = 0 Then
            n_准退数量 := n_剩余数量;
          End If;
        
        Else
          Select Nvl(Sum(Nvl(付数, 1) * 实际数量), 0), Count(*)
          Into n_准退数量, n_Count
          From 药品收发记录
          Where NO = No_In And 单据 In (8, 24) And Mod(记录状态, 3) = 1 --@@@
                And 审核人 Is Null And 费用id = r_Bill.Id;
        
          --有剩余数量无准退数量的有两种情况：
          --1.不跟踪在用的卫材无对应的收发记录,这时使用剩余数量
          --2.并发操作,此时已发药或发料
          If n_准退数量 = 0 Then
            If r_Bill.收费类别 = '4' Then
              If n_Count > 0 Then
                v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已发料,须退料后再退费！';
                Raise Err_Item;
              Else
                n_准退数量 := n_剩余数量;
              End If;
            Else
              v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已发药,须退药后再退费！';
              Raise Err_Item;
            End If;
          End If;
        End If;
      
        --是否部分退费
        If r_Bill.执行状态 = 2 Or n_准退数量 <> Nvl(r_Bill.付数, 1) * r_Bill.数次 Then
          n_正常退费 := 0;
        End If;
      
        --处理门诊费用记录
        n_费用状态 := 0;
        --该笔项目第几次退费
        Select Nvl(Max(Abs(执行状态)), 0) + 1
        Into n_退费次数
        From 门诊费用记录
        Where NO = No_In And 记录性质 = 1 And 记录状态 = 2 And Nvl(执行状态, 0) < 0 And 序号 = r_Bill.序号;
      
        n_应收金额 := Round(n_剩余应收 * (n_准退数量 / n_剩余数量), n_Dec);
        n_实收金额 := Round(n_剩余实收 * (n_准退数量 / n_剩余数量), n_Dec);
        n_统筹金额 := Round(n_剩余统筹 * (n_准退数量 / n_剩余数量), n_Dec);
        n_总金额   := n_总金额 + n_实收金额;
      
        --插入退费记录
        Insert Into 门诊费用记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 姓名, 性别, 年龄, 标识号, 付款方式, 费别, 病人科室id, 收费类别, 收费细目id,
           计算单位, 付数, 发药窗口, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人, 执行状态,
           费用状态, 执行时间, 操作员编号, 操作员姓名, 发生时间, 登记时间, 结帐id, 结帐金额, 保险项目否, 保险大类id, 统筹金额, 摘要, 是否上传, 保险编码, 费用类型, 结论, 缴款组id)
          Select 病人费用记录_Id.Nextval, NO, 实际票号, 记录性质, 2, 序号, 从属父号, 价格父号, 病人id, 医嘱序号, 门诊标志, 姓名, 性别, 年龄, 标识号, 付款方式, 费别,
                 病人科室id, 收费类别, 收费细目id, 计算单位, Decode(Sign(n_准退数量 - Nvl(付数, 1) * 数次), 0, 付数, 1), 发药窗口,
                 Decode(Sign(n_准退数量 - Nvl(付数, 1) * 数次), 0, -1 * 数次, -1 * n_准退数量), 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价,
                 -1 * n_应收金额, -1 * n_实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人, -1 * n_退费次数, n_费用状态, 执行时间, 操作员编号_In, 操作员姓名_In,
                 发生时间, d_Date, n_结帐id, -1 * n_实收金额, 保险项目否, 保险大类id, -1 * n_统筹金额, 摘要, Decode(Nvl(附加标志, 0), 9, 1, 0), 保险编码,
                 费用类型, 结论, n_组id
          From 门诊费用记录
          Where ID = r_Bill.Id;
      
        --标记原费用记录
        --执行状态:全部退完(准退数=剩余数)标记为0,否则标记为1,异常收费单,还是标明9
        Update 门诊费用记录
        Set 记录状态 = 3, 执行状态 = Decode(Nvl(执行状态, 0), 9, 9, Decode(Sign(n_准退数量 - n_剩余数量), 0, 0, 1))
        Where ID = r_Bill.Id;
      End If;
    Else
      --情况:没限定行号,原始单据中包括已经完全执行的
      n_正常退费 := 0;
    End If;
  End Loop;

  ---------------------------------------------------------------------------------
  --处理病人预交记录
  --自动产生误差费,默认保留一位
  n_总金额 := Round(n_总金额, 1);
  --原单据的结帐ID
  Select 结帐id, 病人id
  Into n_原结帐id, n_病人id
  From 门诊费用记录
  Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3) And Rownum = 1;

  If n_正常退费 = 1 Then
    --单据第一次退费且全部退完
    --冲预交部分记录
    Insert Into 病人预交记录
      (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交, 结帐id,
       缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质)
      Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, d_Date,
             操作员姓名_In, 操作员编号_In, -1 * 冲预交, n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 0, n_结算序号, 3
      From 病人预交记录
      Where 记录性质 In (1, 11) And 结帐id = n_原结帐id And Nvl(冲预交, 0) <> 0;
    --处理病人预交余额
    For v_预交 In (Select 预交类别, Nvl(Sum(Nvl(冲预交, 0)), 0) As 预交金额, 病人id
                 From 病人预交记录
                 Where 记录性质 In (1, 11) And 结帐id = n_原结帐id
                 Group By 预交类别, 病人id
                 Having Sum(Nvl(冲预交, 0)) <> 0) Loop
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + Nvl(v_预交.预交金额, 0)
      Where 病人id = v_预交.病人id And 性质 = 1 And 类型 = Nvl(v_预交.预交类别, 2)
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 类型, 预交余额, 性质)
        Values
          (v_预交.病人id, Nvl(v_预交.预交类别, 2), Nvl(v_预交.预交金额, 0), 1);
        n_返回值 := n_预交金额;
      End If;
      If n_返回值 = 0 Then
        Delete From 病人余额
        Where 病人id = v_预交.病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
      End If;
    End Loop;
  
    --原样退回(冲预交在前面已处理)
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别,
       卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质)
      Select 病人预交记录_Id.Nextval, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, d_Date, 缴款单位, 单位开户行, 单位帐号, 操作员编号_In, 操作员姓名_In,
             -1 * 冲预交, n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 0, n_结算序号, 3
      From 病人预交记录 A, (Select 名称 From 结算方式 Where 性质 In (3, 4)) J,
           (Select m.Id As 预交id From 病人预交记录 M Where m.结帐id = n_原结帐id And m.记录性质 = 3 And m.记录状态 = 1) Q
      Where a.记录性质 = 3 And a.记录状态 = 1 And a.结帐id = n_原结帐id And a.Id = q.预交id(+) And a.结算方式 = j.名称(+);
  Else
    --部分退费直接退为指定结算方式
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id,
       结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质)
      Select 病人预交记录_Id.Nextval, 3, No_In, 2, 病人id, 主页id, '部分退费结算', v_退费结算, d_Date, Null, Null, Null, 操作员编号_In, 操作员姓名_In,
             -1 * n_总金额, n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 0, n_结算序号, 3
      
      From 病人预交记录
      Where 记录性质 = 3 And 记录状态 In (1, 3) And 结帐id = n_原结帐id And Rownum = 1;
  
    --如果收费时只使用了预交款,则要退预交,并且可能有多笔冲预交
    If Sql%RowCount = 0 Then
      n_预交金额 := n_总金额;
    
      For r_Deposit In c_Deposit(n_原结帐id) Loop
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
           结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
                 d_Date, 操作员姓名_In, 操作员编号_In, Decode(Sign(r_Deposit.金额 - n_预交金额), -1, -1 * r_Deposit.金额, -1 * n_预交金额),
                 n_结帐id, n_组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 0, n_结算序号, 3
          From 病人预交记录
          Where ID = r_Deposit.Id;
      
        --更新病人预交余额
        Update 病人余额
        Set 预交余额 = Nvl(预交余额, 0) + n_总金额
        Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = 1
        Returning 预交余额 Into n_返回值;
        If Sql%RowCount = 0 Then
          Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (r_Deposit.病人id, 1, n_总金额, 1);
          n_返回值 := n_总金额;
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 病人余额
          Where 病人id = r_Deposit.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
        End If;
      
        --检查是否已经处理完
        If r_Deposit.金额 < n_预交金额 Then
          n_预交金额 := n_预交金额 - r_Deposit.金额;
        Else
          n_预交金额 := 0;
        End If;
        If n_预交金额 = 0 Then
          Exit;
        End If;
      End Loop;
    
    End If;
  End If;
  --更新原记录
  Update 病人预交记录 Set 记录状态 = 3 Where 记录性质 = 3 And 记录状态 In (1, 3) And 结帐id = n_原结帐id;

  Select Nvl(Sum(Nvl(结帐金额, 0)), 0) Into n_实收金额 From 门诊费用记录 Where 结帐id = n_结帐id;
  Select Nvl(Sum(Nvl(冲预交, 0)), 0) Into n_返回值 From 病人预交记录 Where 结帐id = n_结帐id;

  n_实收金额 := n_实收金额 - n_返回值;

  If n_实收金额 <> 0 Then
    --未找到，新产生误差项
    Zl_简单收费误差_Insert(No_In, n_病人id, n_结帐id, n_实收金额, d_Date, 操作员编号_In, 操作员姓名_In, 1);
  End If;

  --人员缴款余额(注意是预交记录处理后才处理，包括个人帐户等的结算金额,不含退冲预交款)
  For r_Moneyrow In c_Money(n_结帐id) Loop
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + r_Moneyrow.冲预交
    Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_Moneyrow.结算方式
    Returning 余额 Into n_返回值;
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额
        (收款员, 结算方式, 性质, 余额)
      Values
        (操作员姓名_In, r_Moneyrow.结算方式, 1, r_Moneyrow.冲预交);
      n_返回值 := r_Moneyrow.冲预交;
    End If;
    If Nvl(n_返回值, 0) = 0 Then
      Delete From 人员缴款余额
      Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_Moneyrow.结算方式 And Nvl(余额, 0) = 0;
    End If;
  End Loop;

  ---------------------------------------------------------------------------------
  --退费票据回收(仅全退时才回退,部分退是在重打过程中回收)
  --启用标志||NO;执行科室(条数);收据费目(首页汇总,条数);收费细目(条数)
  v_Para     := Nvl(zl_GetSysParameter('票据分配规则', 1121), '0||0;0;0,0;0');
  n_启用模式 := Zl_To_Number(Substr(v_Para, 1, 1));
  If n_启用模式 <> 0 Then
    --收回票据
    Select 使用id Bulk Collect
    Into l_使用id
    From (Select Distinct b.使用id From 票据打印明细 B Where b.No = No_In And Nvl(b.票种, 0) = 1);
  
    n_启用模式 := l_使用id.Count;
    If l_使用id.Count <> 0 Then
      --插入回收记录
      Forall I In 1 .. l_使用id.Count
        Insert Into 票据使用明细
          (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用人, 使用时间)
          Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, 操作员姓名_In, d_Date
          From 票据使用明细 A
          Where ID = l_使用id(I) And 性质 = 1 And Not Exists
           (Select 1 From 票据使用明细 Where 号码 = a.号码 And 票种 = a.票种 And Nvl(性质, 0) <> 1);
    
      Forall I In 1 .. l_使用id.Count
        Update 票据打印明细 Set 是否回收 = 1 Where 使用id = l_使用id(I) And Nvl(是否回收, 0) = 0;
    
    End If;
  End If;
  If n_启用模式 = 0 Then
    --获取单据最后一次的打印ID(可能是多张单据收费打印)
    Begin
      --性质=1，原因=6为退费打印票据(红票)，不回收
      Select ID
      Into n_打印id
      From (Select b.Id
             From 票据使用明细 A, 票据打印内容 B
             Where a.打印id = b.Id And a.性质 = 1 And a.原因 In (1, 3) And b.数据性质 = 1 And b.No = No_In
             Order By a.使用时间 Desc)
      Where Rownum < 2;
    Exception
      When Others Then
        Null;
    End;
    --可能以前没有打印,无收回
    If n_打印id Is Not Null Then
      --a.多张单据循环调用时只能收回一次
      Select Count(*) Into n_Count From 票据使用明细 Where 票种 = 1 And 性质 = 2 And 打印id = n_打印id;
      If n_Count = 0 Then
        Insert Into 票据使用明细
          (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
          Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, d_Date, 操作员姓名_In
          From 票据使用明细
          Where 打印id = n_打印id And 票种 = 1 And 性质 = 1;
      Else
        --b.部分退费多次收回时,最后一次全退收回要排开已收回的
        Insert Into 票据使用明细
          (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
          Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, d_Date, 操作员姓名_In
          From 票据使用明细 A
          Where 打印id = n_打印id And 票种 = 1 And 性质 = 1 And Not Exists
           (Select 1 From 票据使用明细 B Where a.号码 = b.号码 And 打印id = n_打印id And 票种 = 1 And 性质 = 2);
      End If;
    End If;
  End If;

  ---------------------------------------------------------------------------------
  --药品卫材相关内容
  --必须按照“收费细目id”升序排序，防止并发锁“药品库存”表
  For r_Expenses In (Select ID
                     From 门诊费用记录
                     Where NO = No_In And 记录性质 = 1 And 记录状态 In (1, 3) And 收费类别 In ('4', '5', '6', '7')
					 Order By 收费细目ID) Loop
    Zl_药品收发记录_销售退费(r_Expenses.Id);
  End Loop;

  --医嘱处理
  --删除病人医嘱附费(最后一次删除时)
  For c_医嘱 In (Select Distinct 医嘱序号
               From 门诊费用记录
               Where NO = No_In And 记录性质 = 1 And 记录状态 = 3 And 医嘱序号 Is Not Null) Loop
    Select Nvl(Count(*), 0)
    Into n_Count
    From (Select 序号, Sum(数量) As 剩余数量
           From (Select 记录状态, 执行状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                  From 门诊费用记录
                  Where 记录性质 = 1 And Nvl(附加标志, 0) <> 9 And 医嘱序号 + 0 = c_医嘱.医嘱序号 And NO = No_In
                  Group By 记录状态, 执行状态, Nvl(价格父号, 序号))
           Group By 序号
           Having Sum(数量) <> 0);
  
    If n_Count = 0 Then
      Delete From 病人医嘱附费 Where 医嘱id = c_医嘱.医嘱序号 And 记录性质 = 1 And NO = No_In;
    End If;
  End Loop;

  --场合_In    Integer:=0, --0:门诊;1-住院
  --性质_In    Integer:=1, --1-收费单;2-记帐单
  --操作_In    Integer:=0, --0:删除划价单;1-收费或记帐;2-退费或销帐
  --No_In      门诊费用记录.No%Type,
  --医嘱ids_In Varchar2 := Null
  Zl_医嘱发送_计费状态_Update(0, 1, 2, No_In);
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊简单收费_Delete;
/

--104266:冉俊明,2017-03-10,自定义临床出诊号源开放时间。
Create Or Replace Function Zl_Fun_Getappointmentdays Return Number
--功能: 根据参数“号源开放时间”确定当前时间是否应该在当前预约天数基础上多开放一天的号源，
  --    如果应该多开放一天的号源，则返回1，否则返回0
  --说明：以半天为单位,如果参数“号源开放时间”在12:00:00-23:59:59期间的，则开放预约天数+1天
 Is
  v_开放时间 Varchar2(20);
  d_开放时间 Date;
Begin
  v_开放时间 := Nvl(zl_GetSysParameter(277), '00:00:00');
  d_开放时间 := To_Date(To_Char(Sysdate, 'yyyy-mm-dd') || ' ' || v_开放时间, 'yyyy-mm-dd hh24:mi:ss');

  If Sysdate >= d_开放时间 And d_开放时间 Between Trunc(Sysdate) + 1 / 2 And Trunc(Sysdate) + 1 - 1 / 24 / 60 / 60 Then
    Return 1;
  End If;
  Return 0;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Fun_Getappointmentdays;
/

--107584:冉俊明,2017-04-06,修正跨天的上班时段序号分配时日期规则错误
--106752:冉俊明,2017-03-12,停用（或删除）了科室或医生或收费项目的号源按停用号源处理。
--106781:冉俊明,2017-03-10,在制定启用序号不分时段的安排时，保存的序号时段信息的开始时间和终止时间不正确。
--104266:冉俊明,2017-03-10,自定义临床出诊号源开放时间。
Create Or Replace Procedure Zl1_Auto_Buildingregisterplan
(
  挂号时间_In In Date := Null,
  号源id_In   临床出诊号源.Id%Type := Null
) As
  -------------------------------------------------------------------------
  --功能说明：自动生成临床出诊记录
  --          1、根据号源自动生成预约数内的临床出诊记录;
  --          2、预约天数的确定:号源预约天数-->预约方式的天数（取最大)-->系统预约天数
  --入参:挂号时间_IN:NULL时，自动生成;否则只检查指定日期是否生成了出诊记录没有
  --    号源id_In:NULL时处理所有号源，否则只处理指定号源
  -------------------------------------------------------------------------
  n_缺省预约天数 临床出诊号源.预约天数%Type;
  v_操作员姓名   临床出诊安排.操作员姓名%Type;
  d_登记日期     临床出诊安排.登记时间%Type;
  n_安排id       临床出诊安排.Id%Type;
  n_项目id       临床出诊安排.项目id %Type;

  n_记录id   临床出诊记录.Id%Type;
  d_当前日期 临床出诊记录.出诊日期%Type;

  n_是否出诊 Number(2);
  l_固定时段 t_Strlist := t_Strlist();
  n_Count    Number(18);

  n_加预约天数 Number := 0;
  d_开始时间   临床出诊记录.开始时间%Type;
Begin

  Select Max(预约天数) Into n_缺省预约天数 From 预约方式;
  If Nvl(n_缺省预约天数, 0) = 0 Then
    n_缺省预约天数 := To_Number(Nvl(zl_GetSysParameter('挂号允许预约天数'), '0'));
  End If;
  If Nvl(n_缺省预约天数, 0) = 0 Then
    n_缺省预约天数 := 7;
  End If;

  --以半天为单位,如果参数“号源开放时间”在12:00:00-23:59:59期间的，则开放预约天数+1天
  n_加预约天数 := Zl_Fun_Getappointmentdays;

  d_当前日期   := Trunc(Nvl(挂号时间_In, Sysdate));
  d_登记日期   := Sysdate;
  v_操作员姓名 := Zl_Username;

  --第一层循环，号源信息
  For c_号源 In (Select c.Id, c.号类, c.号码, c.项目id, c.科室id, c.医生姓名,
                      Decode(Nvl(c.预约天数, 0), 0, n_缺省预约天数, c.预约天数) + n_加预约天数 As 预约天数, Nvl(b.站点, '-') As 站点,
                      Nvl(c.是否假日换休, 0) As 是否假日换休, Nvl(c.假日控制状态, 0) As 假日控制状态, Nvl(c.排班方式, 0) As 排班方式
               From 临床出诊号源 C, 部门表 B, 人员表 A, 收费项目目录 D
               Where c.科室id = b.Id And c.医生id = a.Id(+) And c.项目id = d.Id And Nvl(c.是否删除, 0) = 0 And
                     Nvl(c.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(b.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(a.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     Nvl(d.撤档时间, To_Date('3000-01-01', 'yyyy-mm-dd')) = To_Date('3000-01-01', 'yyyy-mm-dd') And
                     (号源id_In Is Null Or c.Id = 号源id_In)
                    --
                     And Exists (Select 1
                      From 临床出诊安排 M, 临床出诊表 N
                      Where m.出诊id = n.Id And m.号源id = c.Id And Nvl(n.排班方式, 0) = 0 And n.发布时间 Is Not Null And
                            m.审核时间 Is Not Null And d_当前日期 <= m.终止时间)) Loop
  
    --检查当前日期所在的安排的收费项目是否为号源中的收费项目，如果不是，则更新号源中的收费项目
    Begin
      Select 项目id
      Into n_项目id
      From (Select a.项目id
             From 临床出诊安排 A, 临床出诊表 B
             Where a.出诊id = b.Id And a.号源id = c_号源.Id And a.审核时间 Is Not Null And d_当前日期 Between a.开始时间 And a.终止时间 And
                   Nvl(b.排班方式, 0) = 0 And b.发布时间 Is Not Null
             Order By a.登记时间 Desc)
      Where Rownum < 2;
    Exception
      When Others Then
        n_项目id := Null;
    End;
    If Nvl(n_项目id, 0) <> 0 Then
      If Nvl(c_号源.项目id, 0) <> n_项目id Then
        Update 临床出诊号源 Set 项目id = n_项目id Where ID = c_号源.Id;
        Commit;
      End If;
    End If;
  
    --第二层循环，出诊日期
    --从头一天开始生成，避免如全日(8:00-7:59)在0:00-7:59没有出诊记录
    For c_日期 In (Select m.日期,
                        Decode(To_Char(m.日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7',
                                '周六', Null) As 星期
                 From (Select Trunc(d_当前日期) + 天数 As 日期
                        From (Select Level - 1 As 天数 From Dual Connect By Level <= c_号源.预约天数 + 1)
                        Where 号源id_In Is Not Null
                        Union All
                        Select Trunc(d_当前日期 - 1) + 天数 As 日期
                        From (Select Level - 1 As 天数 From Dual Connect By Level <= c_号源.预约天数 + 2)
                        Where 号源id_In Is Null) M) Loop
    
      l_固定时段 := t_Strlist();
      --检查当日是否在月/周出诊表中,若在，则不生成出诊记录
      Select Count(1)
      Into n_Count
      From 临床出诊安排 A, 临床出诊表 B
      Where a.出诊id = b.Id And a.号源id = c_号源.Id And c_日期.日期 Between Trunc(a.开始时间) And Trunc(a.终止时间) And
            Nvl(b.排班方式, 0) In (1, 2) And Rownum < 2;
    
      --当前号源为按月/周排班，且当前日期之前已有按月/周排班的出诊记录就不再按固定安排生成出诊记录了
      If Nvl(n_Count, 0) = 0 And Nvl(c_号源.排班方式, 0) <> 0 Then
        Select Count(1)
        Into n_Count
        From 临床出诊安排 A, 临床出诊表 B
        Where a.出诊id = b.Id And Nvl(b.排班方式, 0) In (1, 2) And a.号源id = c_号源.Id And a.开始时间 < c_日期.日期 And Rownum < 2;
      End If;
    
      If Nvl(n_Count, 0) = 0 Then
        If 号源id_In Is Null Then
          --出诊安排,取最后登记的一个
          Begin
            Select 安排id
            Into n_安排id
            From (Select a.Id As 安排id
                   From 临床出诊安排 A, 临床出诊表 B
                   Where a.号源id = c_号源.Id And a.出诊id = b.Id And Nvl(b.排班方式, 0) = 0 And b.发布时间 Is Not Null And
                         a.审核时间 Is Not Null And c_日期.日期 Between a.开始时间 And a.终止时间
                   Order By a.登记时间 Desc)
            Where Rownum < 2;
          Exception
            When Others Then
              n_安排id := 0;
          End;
        Else
          --如果指定了号源ID，肯定是发布后新增了临时安排重新生成出诊记录，最后登记的一个肯定是本次新增的，
          --只需要处理这个安排即可，不在这个安排有效时间范围内的就不处理
          Begin
            Select 安排id
            Into n_安排id
            From (Select a.Id As 安排id, a.开始时间, a.终止时间, Row_Number() Over(Order By a.登记时间 Desc) As 行号
                   From 临床出诊安排 A, 临床出诊表 B
                   Where a.号源id = c_号源.Id And a.出诊id = b.Id And Nvl(b.排班方式, 0) = 0 And b.发布时间 Is Not Null And
                         a.审核时间 Is Not Null)
            Where 行号 = 1 And c_日期.日期 Between 开始时间 And 终止时间;
          Exception
            When Others Then
              n_安排id := 0;
          End;
        End If;
      
        If Nvl(n_安排id, 0) <> 0 Then
          If 号源id_In Is Null Then
            --确定当日是否有出诊记录
            Select Count(1)
            Into n_Count
            From 临床出诊记录 A
            Where a.号源id = c_号源.Id And a.出诊日期 = c_日期.日期 And Rownum < 2;
          
            --1.未指定号源ID，则是正常生成出诊记录，有出诊记录的日期将不再处理
            If Nvl(n_Count, 0) = 0 Then
              --1.1无出诊记录，正常生成
              n_是否出诊 := 1;
            Else
              --1.2有出诊记录，不再处理
              n_是否出诊 := 0;
            End If;
          Else
            --2.指定了号源ID，肯定是发布后新增了临时安排重新生成出诊记录
            n_是否出诊 := 1;
            --当日有出诊记录，需要做如下处理
            For c_记录 In (Select a.安排id, a.Id As 记录id, a.出诊日期, a.上班时段, a.是否分时段, a.是否序号控制
                         From 临床出诊记录 A
                         Where a.号源id = c_号源.Id And a.出诊日期 = c_日期.日期) Loop
            
              Select Count(1) Into n_Count From 病人挂号记录 Where 出诊记录id = c_记录.记录id;
              If Nvl(n_Count, 0) = 0 Then
                --2.2.1如果时段不存在预约挂号数据，则删除重新生成
                Zl_临床出诊上班时段_Delete(c_记录.安排id, To_Char(c_记录.出诊日期, 'yyyy-mm-dd'), 1, c_记录.上班时段);
              Else
                --2.2.2如果时段存在预约挂号数据，则只需调整出诊记录的安排ID即可
                Update 临床出诊记录 Set 安排id = n_安排id Where ID = c_记录.记录id;
                l_固定时段.Extend();
                l_固定时段(l_固定时段.Count) := c_记录.上班时段;
              End If;
            End Loop;
          End If;
        
          --检查这天是否出诊
          If n_是否出诊 = 1 Then
            Select Count(1) Into n_Count From 临床出诊限制 Where 安排id = n_安排id And 限制项目 = c_日期.星期;
            If Nvl(n_Count, 0) = 0 Then
              n_是否出诊 := 0;
            End If;
          End If;
        
          If Nvl(n_是否出诊, 0) = 0 Then
            --如果不存在临床出诊记录，则增加临床出诊记录(时间段为NULL 的空记录)
            Insert Into 临床出诊记录
              (ID, 安排id, 号源id, 出诊日期, 登记人, 登记时间)
              Select 临床出诊记录_Id.Nextval, n_安排id, a.Id As ID, c_日期.日期, v_操作员姓名, d_登记日期 As 登记时间
              From 临床出诊号源 A, 临床出诊安排 B
              Where a.Id = b.号源id And b.Id = n_安排id
                   --
                    And Not Exists (Select 1 From 临床出诊记录 Where 号源id = a.Id And 出诊日期 = c_日期.日期);
          Else
            For c_记录 In (With c_时间段 As
                            (Select 时间段, 开始时间, 终止时间, 号类, 站点, 缺省时间, 提前时间
                            From (Select 时间段, 开始时间, 终止时间, 号类, 站点, 缺省时间, 提前时间,
                                          Row_Number() Over(Partition By 时间段 Order By 时间段, 站点 Asc, 号类 Asc) As 组号
                                   From 时间段
                                   Where Nvl(站点, c_号源.站点) = c_号源.站点 And Nvl(号类, c_号源.号类) = c_号源.号类)
                            Where 组号 = 1)
                           Select n_安排id As 安排id, B1.号源id, c_日期.日期 As 出诊日期, m.上班时段, m.Id As 限制id,
                                  To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(j.开始时间, 'hh24:mi:ss'),
                                           'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                  To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(j.终止时间, 'hh24:mi:ss'),
                                          'yyyy-mm-dd hh24:mi:ss') + Case
                                    When j.终止时间 <= j.开始时间 Then
                                     1
                                    Else
                                     0
                                  End As 终止时间, Null As 停诊开始时间, Null As 停诊终止时间, Null As 停诊原因,
                                  To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(Nvl(j.缺省时间, j.开始时间), 'hh24:mi:ss'),
                                          'yyyy-mm-dd hh24:mi:ss') + Case
                                    When j.缺省时间 < j.开始时间 Then
                                     1
                                    Else
                                     0
                                  End As 缺省预约时间,
                                  To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(Nvl(j.提前时间, j.开始时间), 'hh24:mi:ss'),
                                          'yyyy-mm-dd hh24:mi:ss') + Case
                                    When j.开始时间 < j.提前时间 Then
                                     -1
                                    Else
                                     0
                                  End As 提前挂号时间, m.限号数, 0 As 已挂数, m.限约数, 0 As 已约数, 0 As 其中已接收, m.是否序号控制, m.是否分时段, m.预约控制,
                                  m.是否独占, B1.项目id, B1.医生id, B1.医生姓名, Null As 替诊医生id, Null As 替诊医生姓名, m.分诊方式, m.诊室id,
                                  0 As 是否锁定, 0 As 是否临时出诊, v_操作员姓名 As 操作员姓名, d_登记日期 As 登记时间, c_日期.星期 As 限制项目
                           From 临床出诊安排 B1, 临床出诊限制 M, c_时间段 J
                           Where B1.Id = n_安排id And B1.Id = m.安排id And m.限制项目 = c_日期.星期 And m.上班时段 = j.时间段 And
                                 To_Date(To_Char(c_日期.日期, 'yyyy-mm-dd ') || To_Char(j.开始时间, 'hh24:mi:ss'),
                                         'yyyy-mm-dd hh24:mi:ss') >= B1.开始时间) Loop
              Begin
                Select 1 Into n_Count From Table(l_固定时段) Where Column_Value = c_记录.上班时段;
              Exception
                When Others Then
                  n_Count := 0;
              End;
            
              If Nvl(n_Count, 0) = 0 Then
                Select 临床出诊记录_Id.Nextval Into n_记录id From Dual;
                Insert Into 临床出诊记录
                  (ID, 安排id, 号源id, 出诊日期, 上班时段, 开始时间, 终止时间, 停诊开始时间, 停诊终止时间, 停诊原因, 缺省预约时间, 提前挂号时间, 限号数, 已挂数, 限约数, 已约数,
                   其中已接收, 是否序号控制, 是否分时段, 预约控制, 是否独占, 项目id, 科室id, 医生id, 医生姓名, 替诊医生id, 替诊医生姓名, 分诊方式, 诊室id, 是否锁定, 是否临时出诊,
                   登记人, 登记时间, 是否发布)
                Values
                  (n_记录id, c_记录.安排id, c_记录.号源id, c_记录.出诊日期, c_记录.上班时段, c_记录.开始时间, c_记录.终止时间, c_记录.停诊开始时间, c_记录.停诊终止时间,
                   c_记录.停诊原因, c_记录.缺省预约时间, c_记录.提前挂号时间, c_记录.限号数, c_记录.已挂数, c_记录.限约数, c_记录.已约数, c_记录.其中已接收, c_记录.是否序号控制,
                   c_记录.是否分时段, c_记录.预约控制, c_记录.是否独占, c_记录.项目id, c_号源.科室id, c_记录.医生id, c_记录.医生姓名, c_记录.替诊医生id,
                   c_记录.替诊医生姓名, c_记录.分诊方式, c_记录.诊室id, c_记录.是否锁定, c_记录.是否临时出诊, c_记录.操作员姓名, d_登记日期, 1);
              
                d_开始时间 := c_记录.开始时间;
                --插入临床出诊序号控制
                If Nvl(c_记录.是否分时段, 0) = 1 And Nvl(c_记录.是否序号控制, 0) = 1 Then
                  --分时段且启用序号控制，使用"预约顺序号"记录"是否预约"
                  Insert Into 临床出诊序号控制
                    (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 预约顺序号)
                    Select n_记录id, 序号,
                           To_Date(To_Char(c_记录.出诊日期, 'yyyy-mm-dd ') || To_Char(开始时间, 'hh24:mi:ss'),
                                    'yyyy-mm-dd hh24:mi:ss') + Case
                              When d_开始时间 > To_Date(To_Char(c_记录.出诊日期, 'yyyy-mm-dd ') || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Then
                               1
                              Else
                               0
                            End,
                           To_Date(To_Char(c_记录.出诊日期, 'yyyy-mm-dd ') || To_Char(终止时间, 'hh24:mi:ss'),
                                    'yyyy-mm-dd hh24:mi:ss') + Case
                              When d_开始时间 >= To_Date(To_Char(c_记录.出诊日期, 'yyyy-mm-dd ') || To_Char(终止时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Then
                               1
                              Else
                               0
                            End, 限制数量, 是否预约, 是否预约
                    From 临床出诊时段
                    Where 限制id = c_记录.限制id;
                Else
                  Insert Into 临床出诊序号控制
                    (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约)
                    Select n_记录id, 序号,
                           To_Date(To_Char(c_记录.出诊日期, 'yyyy-mm-dd ') || To_Char(开始时间, 'hh24:mi:ss'),
                                   'yyyy-mm-dd hh24:mi:ss') + Case
                             When d_开始时间 > To_Date(To_Char(c_记录.出诊日期, 'yyyy-mm-dd ') || To_Char(开始时间, 'hh24:mi:ss'),
                                                   'yyyy-mm-dd hh24:mi:ss') Then
                              1
                             Else
                              0
                           End,
                           To_Date(To_Char(c_记录.出诊日期, 'yyyy-mm-dd ') || To_Char(终止时间, 'hh24:mi:ss'),
                                   'yyyy-mm-dd hh24:mi:ss') + Case
                             When d_开始时间 >= To_Date(To_Char(c_记录.出诊日期, 'yyyy-mm-dd ') || To_Char(终止时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') Then
                              1
                             Else
                              0
                           End, 限制数量, 是否预约
                    From 临床出诊时段
                    Where 限制id = c_记录.限制id;
                End If;
              
                --插入合作单位挂号控制记录
                Insert Into 临床出诊挂号控制记录
                  (类型, 性质, 名称, 记录id, 序号, 控制方式, 数量)
                  Select 类型, 性质, 名称, n_记录id, 序号, 控制方式, 数量
                  From 临床出诊挂号控制
                  Where 限制id = c_记录.限制id;
              
                --插入临床出诊诊室记录
                Insert Into 临床出诊诊室记录
                  (记录id, 诊室id)
                  Select n_记录id, 诊室id From 临床出诊诊室 Where 限制id = c_记录.限制id;
              End If;
            End Loop;
          
            --根据停诊安排和法定节假日调整出诊记录的出诊/预约情况
            Zl_Clinicvisitmodify(c_号源.Id, n_安排id, c_日期.日期, v_操作员姓名, d_登记日期);
          End If;
        End If;
      End If;
      --一天一提交
      Commit;
    End Loop;
  End Loop;
End Zl1_Auto_Buildingregisterplan;
/

--108264:刘尔旋,2017-04-17,销账附加费用处理问题
--106729:刘尔旋,2017-03-09,销账时处理库存根据药品ID排序
Create Or Replace Procedure Zl_住院记帐记录_Delete
(
  No_In           住院费用记录.No%Type,
  序号_In         Varchar2,
  操作员编号_In   住院费用记录.操作员编号%Type,
  操作员姓名_In   住院费用记录.操作员姓名%Type,
  记录性质_In     住院费用记录.记录性质%Type := 2,
  操作状态_In     Number := 0,
  输液配药检查_In Number := 1,
  登记时间_In     住院费用记录.登记时间%Type := Sysdate
) As
  --功能：冲销一张住院记帐单据中指定序号行
  --序号：格式如"1,3,5,7,8",或"1:2:33456,3:2,5:2,7:2,8:2",冒号前面的数字表示行号,中间的数字表示退的数量,后面的数字表示配药记录的ID,目前仅在销帐审核时才传入
  --      为空表示冲销所有可冲销行
  --记录性质:    2-人工记帐单,3-自动记帐单
  --输液配药检查:    0-医嘱调用，不检查药品是否进入输液配药中心；1-非医嘱调用，检查药品是否进入配药中心
  --该光标用于销帐指定费用行
  --操作状态_In:0-表示直接销帐;1-表示审核销帐(通过销帐申请-->销帐审核流程)
  --该游标为要退费单据的所有原始记录
  Cursor c_Bill Is
    Select ID, 价格父号, 序号, 执行状态, 记录性质, 收费类别, 医嘱序号, 收费细目id, 病人id, 主页id, 收入项目id, 开单部门id, 病人科室id, 执行部门id, 病人病区id, 付数, 数次
    From 住院费用记录
    Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 门诊标志 = 2
    Order By 收费细目id, 序号;

  --该游标用于处理药品库存可用数量
  --不要管费用的执行状态,因为先于此步处理
  Cursor c_Stock(v_序号_In Varchar2) Is
    Select ID, 单据, NO, 库房id, 药品id, 批次, 发药方式, 付数, 实际数量, 灭菌效期, 效期, 产地, 批号, 填制日期, 费用id, 商品条码, 内部条码
    From 药品收发记录
    Where NO = No_In And 单据 In (9, 10, 25, 26) And Mod(记录状态, 3) = 1 And 审核人 Is Null And
          费用id In (Select ID
                   From 住院费用记录
                   Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 收费类别 In ('4', '5', '6', '7') And
                         门诊标志 = 2 And (Instr(',' || v_序号_In || ',', ',' || 序号 || ',') > 0 Or v_序号_In Is Null))
    Order By 药品id, 填制日期 Desc;

  r_Stock c_Stock%RowType;
  --该游标用于处理费用记录序号
  Cursor c_Serial Is
    Select 序号, 价格父号
    From 住院费用记录
    Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3)
    Order By 序号;

  Cursor Cr_药品 Is
    Select ID, 单据, NO, 库房id, 药品id, 批次, 发药方式, 0 As 数量, 灭菌效期, 效期, 产地, 批号, 填制日期, 费用id
    From 药品收发记录
    Where Rownum <= 1;
  v_药品 Cr_药品%RowType;

  v_医嘱id 病人医嘱记录.Id%Type;
  n_划价   Number;
  v_父号   住院费用记录.价格父号%Type;
  v_序号   Varchar2(2000);
  v_Tmp    Varchar2(4000);

  v_医嘱ids    Varchar2(4000);
  l_药品收发   t_Numlist := t_Numlist();
  l_划价       t_Numlist := t_Numlist();
  l_费用id     t_Numlist := t_Numlist();
  n_付数       Number;
  n_虚拟库房id 药品收发记录.库房id%Type;
  n_其他出库id 药品收发记录.Id%Type;
  n_库房id     药品收发记录.库房id%Type;
  n_返回值     Number;
  --部分退费计算变量
  v_剩余数量 Number;
  v_剩余应收 Number;
  v_剩余实收 Number;
  v_剩余统筹 Number;

  v_准退数量 Number;
  v_退费次数 Number;
  v_应收金额 Number;
  v_实收金额 Number;
  v_统筹金额 Number;
  n_Temp     Number;
  n_部分销帐 Number;
  v_Dec      Number;
  n_Count    Number;
  v_Curdate  Date;
  Err_Item Exception;
  v_Err_Msg        Varchar2(255);
  n_备货卫材       Number;
  n_病人id         病案主页.病人id%Type;
  n_主页id         病案主页.主页id%Type;
  n_审核标志       病案主页.审核标志%Type;
  n_住院状态       病案主页.状态%Type;
  n_病人审核方式   Number(2);
  n_未入科禁止记账 Number(2);
  v_配药id         Varchar2(4000);
  Type Ty_药品 Is Ref Cursor;
  c_药品 Ty_药品; --游标变量

Begin
  --销帐审核时,非药品会传入行号的销帐数量
  If Not 序号_In Is Null Then
    If Instr(序号_In, ':') > 0 Then
      v_Tmp := 序号_In || ',';
      While Not v_Tmp Is Null Loop
        v_序号 := v_序号 || ',' || Substr(v_Tmp, 1, Instr(v_Tmp, ':') - 1);
        If Instr(Substr(v_Tmp, Instr(v_Tmp, ':') + 1, Instr(v_Tmp, ',') - Instr(v_Tmp, ':') - 1), ':') > 0 Then
          v_配药id := v_配药id || ',' ||
                    Substr(v_Tmp, Instr(v_Tmp, ':', 1, 2) + 1, Instr(v_Tmp, ',') - Instr(v_Tmp, ':', 1, 2) - 1);
        End If;
        v_Tmp := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
      End Loop;
      v_序号 := Substr(v_序号, 2);
      If v_配药id Is Not Null Then
        v_配药id := Substr(v_配药id, 2);
      End If;
    Else
      v_序号 := 序号_In;
    End If;
  End If;

  --是否已经全部完全执行(只是整张单据的检查)
  Select Nvl(Count(*), 0), Nvl(Max(病人id), 0), Nvl(Max(主页id), 0)
  Into n_Count, n_病人id, n_主页id
  From 住院费用记录
  Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And Nvl(执行状态, 0) <> 1 And 门诊标志 = 2;
  If n_Count = 0 Then
    v_Err_Msg := '该单据中的项目已经全部完全执行！';
    Raise Err_Item;
  End If;

  n_病人审核方式   := Nvl(zl_GetSysParameter(185), 0);
  n_未入科禁止记账 := Nvl(zl_GetSysParameter(215), 0);
  If n_病人审核方式 = 1 Or n_未入科禁止记账 = 1 Then
  
    Begin
      Select 审核标志, 状态 Into n_审核标志, n_住院状态 From 病案主页 Where 病人id = n_病人id And 主页id = n_主页id;
    Exception
      When Others Then
        n_审核标志 := 0;
        n_住院状态 := 0;
    End;
    If n_未入科禁止记账 = 1 And n_住院状态 = 1 Then
      v_Err_Msg := '病人未入科,禁止对病人相关费用的操作!';
      Raise Err_Item;
    End If;
  
    If n_病人审核方式 = 1 Then
    
      If Nvl(n_审核标志, 0) = 1 Then
        v_Err_Msg := '该病人目前正在审核费用,不能进行费用相关调整!';
        Raise Err_Item;
      End If;
      If Nvl(n_审核标志, 0) = 2 Then
        v_Err_Msg := '该病人目前已经完成了费用审核,不能进行费用相关调整!';
        Raise Err_Item;
      End If;
    End If;
  End If;

  --未完全执行的项目是否有剩余数量(只是整张单据的检查)
  Select Nvl(Count(*), 0)
  Into n_Count
  From (Select 序号, Sum(数量) As 剩余数量
         From (Select 记录状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                From 住院费用记录
                Where NO = No_In And 记录性质 = 记录性质_In And 门诊标志 = 2 And
                      Nvl(价格父号, 序号) In
                      (Select Nvl(价格父号, 序号)
                       From 住院费用记录
                       Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And Nvl(执行状态, 0) <> 1)
                Group By 记录状态, Nvl(价格父号, 序号))
         Group By 序号
         Having Sum(数量) <> 0);
  If n_Count = 0 Then
    v_Err_Msg := '该单据中未完全执行部分项目剩余数量为零,没有可以销帐的费用！';
    Raise Err_Item;
  End If;

  --医嘱费用：检查正在执行的医嘱(注意已执行的情况在下面检查,因为不传 序号_IN 这种情况费用界面已限制)
  If Nvl(操作状态_In, 0) <> 1 Then
    --走销帐申请流程的，不检查医保执行状态
    Select Nvl(Count(*), 0)
    Into n_Count
    From 病人医嘱发送
    Where 执行状态 = 3 And (NO, 记录性质, 医嘱id) In
          (Select NO, 记录性质, 医嘱序号
                        From 住院费用记录
                        Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 医嘱序号 Is Not Null And
                              (Instr(',' || v_序号 || ',', ',' || 序号 || ',') > 0 Or v_序号 Is Null));
    If n_Count > 0 Then
      v_Err_Msg := '要销帐的费用中存在对应的医嘱正在执行的情况，不能销帐！';
      Raise Err_Item;
    End If;
  End If;

  ---------------------------------------------------------------------------------
  --先打开药品对应数据集,以确保当前条件下有数据,为了处理并发判断
  --不能在游标条件中取消"审核人 is Null"条件，因为多次退药可能部份又已发
  Open c_Stock(v_序号);

  --公用变量
  Select 登记时间_In Into v_Curdate From Dual;

  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into v_Dec From Dual;

  For c_编目病案 In (Select a.姓名
                 From 病人信息 A, 病案主页 B
                 Where a.病人id = b.病人id And b.编目日期 Is Not Null And
                       (b.病人id, b.主页id) In
                       (Select Distinct 病人id, 主页id
                        From 住院费用记录
                        Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 门诊标志 = 2)) Loop
    v_Err_Msg := '病人『' || c_编目病案.姓名 || '』 已经被病案编目,不能被销帐！';
    Raise Err_Item;
  End Loop;
  v_医嘱ids := Null;
  --循环处理每行费用(收入项目行)
  For r_Bill In c_Bill Loop
    --检查已经存在病案编目的,则不能进行销帐处理
    If Instr(',' || v_序号 || ',', ',' || Nvl(r_Bill.价格父号, r_Bill.序号) || ',') > 0 Or v_序号 Is Null Then
      Select Decode(记录状态, 0, 1, 0) Into n_划价 From 住院费用记录 Where ID = r_Bill.Id;
      If Nvl(r_Bill.执行状态, 0) <> 1 Then
        --求剩余数量,剩余应收,剩余实收
        Select Sum(Nvl(付数, 1) * 数次), Sum(应收金额), Sum(实收金额), Sum(统筹金额)
        Into v_剩余数量, v_剩余应收, v_剩余实收, v_剩余统筹
        From 住院费用记录
        Where NO = No_In And 记录性质 = 记录性质_In And 序号 = r_Bill.序号;
        n_部分销帐 := 0;
        If v_剩余数量 = 0 Then
          If v_序号 Is Not Null Then
            v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经全部销帐！';
            Raise Err_Item;
          End If;
          --情况：未限定行号,原始单据中的该笔已经全部销帐(执行状态=0的一种可能)
        Else
        
          If Instr(序号_In, ':') > 0 Then
            v_Tmp := ',' || 序号_In;
            v_Tmp := Substr(v_Tmp, Instr(v_Tmp, ',' || r_Bill.序号 || ':') + Length(',' || r_Bill.序号 || ':'));
            v_Tmp := Substr(v_Tmp, 1, Instr(v_Tmp || ',', ',') - 1);
            If Instr(v_Tmp, ':') > 0 Then
              v_Tmp := Substr(v_Tmp, 1, Instr(v_Tmp, ':') - 1);
            End If;
            v_准退数量 := v_Tmp;
            n_部分销帐 := 1;
          End If;
        
          --准销数量(非药品项目为剩余数量,原始数量)
          If Instr(',4,5,6,7,', r_Bill.收费类别) = 0 Then
            If Instr(序号_In, ':') = 0 Or 序号_In Is Null Then
              v_准退数量 := v_剩余数量;
            End If;
          Else
            --医嘱超期收回时,卫材可能没有发放,但申请销帐的是部分数量,所以要以申请的为准
            If Instr(序号_In, ':') = 0 Or 序号_In Is Null Then
              Select Nvl(Sum(Nvl(付数, 1) * 实际数量), 0), Count(*)
              Into v_准退数量, n_Count
              From 药品收发记录
              Where NO = No_In And 单据 In (9, 10, 25, 26) And Mod(记录状态, 3) = 1 And 审核人 Is Null And 费用id = r_Bill.Id;
            End If;
          
            --有剩余数量无准退数量的有两种情况：
            --1.不跟踪在用的卫材无对应的收发记录,这时使用剩余数量
            --2.并发操作,此时已发药或发料
            If v_准退数量 = 0 Then
              If r_Bill.收费类别 = '4' Then
                If n_Count > 0 Then
                  v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已发料,须退料后再退费！';
                  Raise Err_Item;
                Else
                  v_准退数量 := v_剩余数量;
                End If;
              Else
                v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已发药,须退药后再退费！';
                Raise Err_Item;
              End If;
            End If;
          End If;
        
          --处理住院费用记录
          If Nvl(n_划价, 0) = 0 Then
            --划价时,直接更改数量,所以不须查划冲销次数
            --该笔项目第几次销帐
            Select Nvl(Max(Abs(执行状态)), 0) + 1
            Into v_退费次数
            From 住院费用记录
            Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 = 2 And 序号 = r_Bill.序号 And 门诊标志 = 2;
          End If;
        
          --金额=剩余金额*(准退数/剩余数)
          v_应收金额 := Round(v_剩余应收 * (v_准退数量 / v_剩余数量), v_Dec);
          v_实收金额 := Round(v_剩余实收 * (v_准退数量 / v_剩余数量), v_Dec);
          v_统筹金额 := Round(v_剩余统筹 * (v_准退数量 / v_剩余数量), v_Dec);
          If Nvl(n_划价, 0) = 1 Then
            If Nvl(n_部分销帐, 0) = 0 Then
              l_划价.Extend;
              l_划价(l_划价.Count) := r_Bill.Id;
              n_返回值 := 0;
            Else
              --更新数量
              --划价的,先将相关的数据处理在内部表集中
              n_付数 := 0;
              If r_Bill.付数 > 1 Then
                --如果是中药,超期回收肯定是回收的付数,而不是次数.因此,需要检查准退数量是否可以整 除
                If Trunc(v_准退数量 / r_Bill.数次) <> (v_准退数量 / r_Bill.数次) Then
                  v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用为中药,请按付数进行退费！';
                  Raise Err_Item;
                End If;
                n_付数 := Trunc(v_准退数量 / r_Bill.数次);
                If Nvl(r_Bill.付数, 0) - n_付数 < 0 Then
                  v_准退数量 := r_Bill.数次;
                Else
                  v_准退数量 := 0;
                End If;
              End If;
              Update 住院费用记录
              Set 付数 = 付数 - n_付数, 数次 = 数次 - v_准退数量, 应收金额 = Nvl(应收金额, 0) - v_应收金额, 实收金额 = Nvl(实收金额, 0) - v_实收金额,
                  登记时间 = v_Curdate, 统筹金额 = Nvl(统筹金额, 0) - v_统筹金额
              Where ID = r_Bill.Id
              Returning Nvl(数次, 0) * Nvl(付数, 0) Into n_返回值;
            End If;
            If Nvl(n_返回值, 0) <= 0 Then
              l_划价.Extend;
              l_划价(l_划价.Count) := r_Bill.Id;
            End If;
            If r_Bill.医嘱序号 Is Not Null Then
              If Instr(',' || Nvl(v_医嘱ids, '') || ',', ',' || r_Bill.医嘱序号 || ',') = 0 Then
                v_医嘱ids := Nvl(v_医嘱ids, '') || ',' || r_Bill.医嘱序号;
              End If;
              --记录病人医嘱附费对应的医嘱ID(不是主费用)
              If v_医嘱id Is Null Then
                v_医嘱id := r_Bill.医嘱序号;
              End If;
            End If;
          
          End If;
        
          If Nvl(n_划价, 0) = 0 Then
            --划价时,直接更改数量,所以不须查划冲销次数
            --插入退费记录
            Insert Into 住院费用记录
              (ID, NO, 记录性质, 记录状态, 序号, 从属父号, 价格父号, 主页id, 病人id, 医嘱序号, 门诊标志, 多病人单, 婴儿费, 姓名, 性别, 年龄, 标识号, 床号, 费别, 病人病区id,
               病人科室id, 收费类别, 收费细目id, 计算单位, 付数, 发药窗口, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人,
               执行部门id, 划价人, 执行人, 执行状态, 执行时间, 操作员编号, 操作员姓名, 发生时间, 登记时间, 保险项目否, 保险大类id, 统筹金额, 保险编码, 记帐单id, 摘要, 费用类型, 是否急诊,
               结论, 医疗小组id)
              Select 病人费用记录_Id.Nextval, NO, 记录性质, 2, 序号, 从属父号, 价格父号, 主页id, 病人id, 医嘱序号, 门诊标志, 多病人单, 婴儿费, 姓名, 性别, 年龄, 标识号,
                     床号, 费别, 病人病区id, 病人科室id, 收费类别, 收费细目id, 计算单位, Decode(Sign(v_准退数量 - Nvl(付数, 1) * 数次), 0, 付数, 1), 发药窗口,
                     Decode(Sign(v_准退数量 - Nvl(付数, 1) * 数次), 0, -1 * 数次, -1 * v_准退数量), 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用,
                     标准单价, -1 * v_应收金额, -1 * v_实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人, -1 * v_退费次数, 执行时间, 操作员编号_In,
                     操作员姓名_In, 发生时间, v_Curdate, 保险项目否, 保险大类id, -1 * v_统筹金额, 保险编码, 记帐单id, 摘要, 费用类型, 是否急诊, 结论, 医疗小组id
              From 住院费用记录
              Where ID = r_Bill.Id;
          
            --记录病人医嘱附费对应的医嘱ID(不是主费用)
            If v_医嘱id Is Null And r_Bill.医嘱序号 Is Not Null Then
              v_医嘱id := r_Bill.医嘱序号;
            End If;
          
            Update 病人审批项目
            Set 已用数量 = Nvl(已用数量, 0) - v_准退数量
            Where 病人id = r_Bill.病人id And 主页id = r_Bill.主页id And 项目id = r_Bill.收费细目id And Nvl(使用限量, 0) <> 0;
          
            --病人余额
            Update 病人余额
            Set 费用余额 = Nvl(费用余额, 0) - v_实收金额
            Where 病人id = r_Bill.病人id And 类型 = 2 And 性质 = 1;
            If Sql%RowCount = 0 Then
              Insert Into 病人余额
                (病人id, 类型, 性质, 费用余额, 预交余额)
              Values
                (r_Bill.病人id, 2, 1, -1 * v_实收金额, 0);
            End If;
          
            --病人未结费用
            Update 病人未结费用
            Set 金额 = Nvl(金额, 0) - v_实收金额
            Where 病人id = r_Bill.病人id And Nvl(主页id, 0) = Nvl(r_Bill.主页id, 0) And Nvl(病人病区id, 0) = Nvl(r_Bill.病人病区id, 0) And
                  Nvl(病人科室id, 0) = Nvl(r_Bill.病人科室id, 0) And Nvl(开单部门id, 0) = Nvl(r_Bill.开单部门id, 0) And
                  Nvl(执行部门id, 0) = Nvl(r_Bill.执行部门id, 0) And 收入项目id + 0 = r_Bill.收入项目id And 来源途径 + 0 = 2;
            If Sql%RowCount = 0 Then
              Insert Into 病人未结费用
                (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
              Values
                (r_Bill.病人id, r_Bill.主页id, r_Bill.病人病区id, r_Bill.病人科室id, r_Bill.开单部门id, r_Bill.执行部门id, r_Bill.收入项目id, 2,
                 -1 * v_实收金额);
            End If;
          
            --标记原费用记录
            --执行状态:全部退完(准退数=剩余数)标记为0,否则保持原状态
            If Instr(',4,5,6,7,', r_Bill.收费类别) = 0 Then
              --一般情况非药品和卫材的项目,不存在部分销帐的情况,只有销帐申请和销帐审核时,才会出现部分销帐,所以
              --执行状态只有两种:0.未执行;1已执行;
              --由于在销帐审核过程中将已执行强制改为了2部分执行,因此需要在此处改为1已执行.未执行的不变.
              Update 住院费用记录
              Set 记录状态 = 3, 执行状态 = Decode(Sign(v_准退数量 - v_剩余数量), 0, 0, Decode(执行状态, 2, 1, 执行状态))
              Where ID = r_Bill.Id;
            Else
              Update 住院费用记录
              Set 记录状态 = 3, 执行状态 = Decode(Sign(v_准退数量 - v_剩余数量), 0, 0, 执行状态)
              Where ID = r_Bill.Id;
            End If;
          End If;
        End If;
      Else
        If v_序号 Is Not Null Then
          v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经完全执行,不能销帐！';
          Raise Err_Item;
        End If;
        --情况:没限定行号,原始单据中包括已经完全执行的
      End If;
    End If;
  End Loop;

  --不存在配药ID,检查该药品是否在输液配药中心
  If v_配药id Is Null And 输液配药检查_In = 1 Then
    For v_费用 In (Select ID
                 From 住院费用记录
                 Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 收费类别 In ('4', '5', '6', '7') And 门诊标志 = 2 And
                       (Instr(',' || v_序号 || ',', ',' || 序号 || ',') > 0 Or v_序号 Is Null)) Loop
      Begin
        Select Count(1)
        Into n_Count
        From 输液配药内容 A, 药品收发记录 B
        Where a.收发id = b.Id And b.费用id = v_费用.Id And Instr(',8,9,10,21,24,25,26,', ',' || b.单据 || ',') > 0;
      Exception
        When Others Then
          n_Count := 0;
      End;
      If n_Count <> 0 Then
        v_Err_Msg := '存在已经进入输液配药中心的待销帐药品，无法完成销帐！';
        Raise Err_Item;
      End If;
    End Loop;
  End If;

  n_部分销帐 := 0;
  ---------------------------------------------------------------------------------
  --药品相关处理:主要是对销帐审核有效.(可以是部分)
  For v_费用 In (Select ID, 序号, 收费类别
               From 住院费用记录
               Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 收费类别 In ('4', '5', '6', '7') And 门诊标志 = 2 And
                     (Instr(',' || v_序号 || ',', ',' || 序号 || ',') > 0 Or v_序号 Is Null)
               Order By 收费细目id) Loop
    --根据费用ID来进行相关的处理
    v_准退数量 := 0;
    If Instr(序号_In, ':') > 0 Then
      v_Tmp := ',' || 序号_In;
      v_Tmp := Substr(v_Tmp, Instr(v_Tmp, ',' || v_费用.序号 || ':') + Length(',' || v_费用.序号 || ':'));
      v_Tmp := Substr(v_Tmp, 1, Instr(v_Tmp || ',', ',') - 1);
      If Instr(v_Tmp, ':') > 0 Then
        v_Tmp := Substr(v_Tmp, 1, Instr(v_Tmp, ':') - 1);
      End If;
      v_准退数量 := v_Tmp;
    End If;
    If v_准退数量 <> 0 Then
      n_部分销帐 := 1;
      n_Temp     := 0;
      --------------------------------------------------------------------------------------
      --检查是否备货记帐卫材,规则如下
      -- a.如果存在存在未审核的其他出库且部分销帐时,直接在原来的基础上更改其他出库数量
      -- b.如果存在存在未审核的其他出库且完全销帐时,直接删除
      -- c.库存处理:还原为虚拟库房的可用数量;发料部门不处理
      -- d.如果已经发了料,这个时间由于其他出库单已经审核,因此就按正常情况流转,库存恢复到发料部门中
      n_虚拟库房id := Null;
      n_其他出库id := Null;
      If v_费用.收费类别 = '4' Then
        Begin
          Select 1, 库房id, ID
          Into n_备货卫材, n_虚拟库房id, n_其他出库id
          From 药品收发记录
          Where 费用id = v_费用.Id And 审核日期 Is Null And 单据 = 21 And Rownum = 1;
        Exception
          When Others Then
            n_备货卫材 := 0;
        End;
      Else
        n_备货卫材 := 0;
      End If;
      --------------------------------------------------------------------------------------
      If v_配药id Is Not Null Then
        Open c_药品 For
          Select /*+ rule*/
           a.Id, a.单据, a.No, a.库房id, a.药品id, a.批次, a.发药方式,
           Decode(a.发药方式, Null, 1, -1, 0, 1) * Nvl(a.付数, 1) * Nvl(a.实际数量, 0) As 数量, a.灭菌效期, a.效期, a.产地, a.批号, a.填制日期,
           a.费用id
          From 药品收发记录 A, Table(f_Str2list(v_配药id)) B, 输液配药内容 C
          Where a.No = No_In And a.单据 In (9, 10, 25, 26) And Mod(a.记录状态, 3) = 1 And a.审核人 Is Null And a.费用id = v_费用.Id And
                a.Id = c.收发id And c.记录id = b.Column_Value
          Order By 填制日期;
      Else
        Open c_药品 For
          Select ID, 单据, NO, 库房id, 药品id, 批次, 发药方式, Decode(发药方式, Null, 1, -1, 0, 1) * Nvl(付数, 1) * Nvl(实际数量, 0) As 数量,
                 灭菌效期, 效期, 产地, 批号, 填制日期, 费用id
          From 药品收发记录
          Where NO = No_In And 单据 In (9, 10, 25, 26) And Mod(记录状态, 3) = 1 And 审核人 Is Null And 费用id = v_费用.Id
          Order By 填制日期;
      End If;
      Loop
        Fetch c_药品
          Into v_药品;
        Exit When c_药品%NotFound;
        n_Temp := v_药品.数量;
        If v_准退数量 >= n_Temp Then
          l_药品收发.Extend;
          l_药品收发(l_药品收发.Count) := v_药品.Id;
          If Nvl(n_其他出库id, 0) > 0 Then
            l_药品收发.Extend;
            l_药品收发(l_药品收发.Count) := n_其他出库id;
          End If;
          v_准退数量 := v_准退数量 - n_Temp;
        Else
          If v_费用.收费类别 = '7' Then
            --当前行的数量要大
            Update 药品收发记录
            Set 付数 = 1, 实际数量 = Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量,
                填写数量 = Decode(付数, Null, 1, 0, 1, 付数) * Nvl(填写数量, 0) - v_准退数量,
                成本金额 =
                 (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 成本价,
                零售金额 =
                 (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 零售价,
                差价 = Round((Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 零售价 -
                            (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 成本价, 5)
            Where ID = v_药品.Id;
          Else
            Update 药品收发记录
            Set 实际数量 = Nvl(实际数量, 0) - v_准退数量, 填写数量 = Nvl(填写数量, 0) - v_准退数量,
                成本金额 =
                 (Nvl(实际数量, 0) - v_准退数量) * 成本价,
                零售金额 =
                 (Nvl(实际数量, 0) - v_准退数量) * 零售价,
                差价 = Round((Nvl(实际数量, 0) - v_准退数量) * 零售价 - (Nvl(实际数量, 0) - v_准退数量) * 成本价, 5)
            Where ID = v_药品.Id;
          End If;
          --更新其他出库单
          If Nvl(n_其他出库id, 0) <> 0 Then
            If v_费用.收费类别 = '7' Then
              Update 药品收发记录
              Set 付数 = 1, 实际数量 = Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量,
                  填写数量 = Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量,
                  成本金额 =
                   (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 成本价,
                  零售金额 =
                   (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 零售价,
                  差价 = Round((Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 零售价 -
                              (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 成本价, 5)
              Where ID = Nvl(n_其他出库id, 0);
            Else
              Update 药品收发记录
              Set 实际数量 = Nvl(实际数量, 0) - v_准退数量, 填写数量 = Nvl(实际数量, 0) - v_准退数量,
                  成本金额 =
                   (Nvl(实际数量, 0) - v_准退数量) * 成本价,
                  零售金额 =
                   (Nvl(实际数量, 0) - v_准退数量) * 零售价,
                  差价 = Round((Nvl(实际数量, 0) - v_准退数量) * 零售价 - (Nvl(实际数量, 0) - v_准退数量) * 成本价, 5)
              Where ID = Nvl(n_其他出库id, 0);
            End If;
          End If;
          n_Temp     := v_准退数量;
          v_准退数量 := 0;
        End If;
        If Nvl(n_备货卫材, 0) = 1 Then
          n_库房id := n_虚拟库房id;
        Else
          n_库房id := v_药品.库房id;
        End If;
      
        If n_库房id Is Not Null Then
          Update 药品库存
          Set 可用数量 = Nvl(可用数量, 0) + n_Temp
          Where 库房id = n_库房id And 药品id = v_药品.药品id And Nvl(批次, 0) = Nvl(v_药品.批次, 0) And 性质 = 1;
          If Sql%RowCount = 0 Then
            Insert Into 药品库存
              (库房id, 药品id, 性质, 批次, 效期, 可用数量, 上次批号, 上次产地, 灭菌效期)
            Values
              (n_库房id, v_药品.药品id, 1, v_药品.批次, v_药品.效期, n_Temp, v_药品.批号, v_药品.产地, v_药品.灭菌效期);
          End If;
          Delete 药品库存
          Where 库房id = n_库房id And 药品id = v_药品.药品id And Nvl(批次, 0) = Nvl(v_药品.批次, 0) And 性质 = 1 And Nvl(可用数量, 0) = 0 And
                Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
        End If;
      
        If Nvl(n_备货卫材, 0) = 1 Then
          Update 药品库存
          Set 可用数量 = Nvl(可用数量, 0) + n_Temp
          Where 库房id = v_药品.库房id And 药品id = v_药品.药品id And Nvl(批次, 0) = Nvl(v_药品.批次, 0) And 性质 = 1;
          If Sql%RowCount = 0 Then
            Insert Into 药品库存
              (库房id, 药品id, 性质, 批次, 效期, 可用数量, 上次批号, 上次产地, 灭菌效期)
            Values
              (v_药品.库房id, v_药品.药品id, 1, v_药品.批次, v_药品.效期, n_Temp, v_药品.批号, v_药品.产地, v_药品.灭菌效期);
          End If;
        End If;
      
        If v_准退数量 = 0 Then
          Exit;
        End If;
      End Loop;
      --不跟踪卫材的,不检查:因为不跟噻的话,不会在药品收发记录中存在
      If Nvl(v_准退数量, 0) <> 0 And Not (v_费用.收费类别 = '4' And n_Temp = 0) Then
        --未分配完成,表示此药品可能已经执行.
        v_Err_Msg := '要销帐的费用中存在已发的药品或卫材，或已被其他人销帐；这可能是并发操作引起的。';
        Raise Err_Item;
      End If;
    End If;
  End Loop;

  If n_部分销帐 = 0 Then
    ------------------------------------------------------------------------------------------------------------------------
    --先处理备货材料
    For v_出库 In (Select ID, 单据, NO, 库房id, 药品id, 批次, 发药方式, 付数, 实际数量, 灭菌效期, 效期, 产地, 批号, 填制日期, 费用id, 商品条码, 内部条码
                 From 药品收发记录
                 Where 单据 = 21 And Mod(记录状态, 3) = 1 And 审核人 Is Null And
                       费用id In (Select ID
                                From 住院费用记录
                                Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 收费类别 = '4' And 门诊标志 = 2 And
                                      (Instr(',' || v_序号 || ',', ',' || 序号 || ',') > 0 Or v_序号 Is Null))
                 Order By 药品id, 填制日期 Desc) Loop
      --处理药品库存
      If v_出库.库房id Is Not Null Then
        Update 药品库存
        Set 可用数量 = Nvl(可用数量, 0) + Decode(v_出库.发药方式, Null, 1, -1, 0, 1) * Nvl(v_出库.付数, 1) * Nvl(v_出库.实际数量, 0)
        Where 库房id = v_出库.库房id And 药品id = v_出库.药品id And Nvl(批次, 0) = Nvl(v_出库.批次, 0) And 性质 = 1;
        If Sql%RowCount = 0 Then
          Insert Into 药品库存
            (库房id, 药品id, 性质, 批次, 效期, 可用数量, 上次批号, 上次产地, 灭菌效期, 商品条码, 内部条码)
          Values
            (v_出库.库房id, v_出库.药品id, 1, v_出库.批次, v_出库.效期,
             Decode(v_出库.发药方式, Null, 1, -1, 0, 1) * Nvl(v_出库.付数, 1) * Nvl(v_出库.实际数量, 0), v_出库.批号, v_出库.产地, v_出库.灭菌效期,
             v_出库.商品条码, v_出库.内部条码);
        End If;
        Delete 药品库存
        Where 库房id = v_出库.库房id And 药品id = v_出库.药品id And Nvl(批次, 0) = Nvl(v_出库.批次, 0) And 性质 = 1 And Nvl(可用数量, 0) = 0 And
              Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
      End If;
      l_费用id.Extend;
      l_费用id(l_费用id.Count) := v_出库.费用id;
      l_药品收发.Extend;
      l_药品收发(l_药品收发.Count) := v_出库.Id;
    End Loop;
  
    --药品相关内容
    Fetch c_Stock
      Into r_Stock;
    While c_Stock%Found Loop
    
      --处理药品库存
      If r_Stock.库房id Is Not Null Then
      
        Select Decode(Count(Column_Value), Null, 0, 0, 0, 1)
        Into n_备货卫材
        From Table(l_费用id)
        Where Column_Value = r_Stock.费用id;
      
        Update 药品库存
        Set 可用数量 = Nvl(可用数量, 0) + Decode(r_Stock.发药方式, Null, 1, -1, 0, 1) * Nvl(r_Stock.付数, 1) * Nvl(r_Stock.实际数量, 0)
        Where 库房id = r_Stock.库房id And 药品id = r_Stock.药品id And Nvl(批次, 0) = Nvl(r_Stock.批次, 0) And 性质 = 1;
        If Sql%RowCount = 0 Then
          Insert Into 药品库存
            (库房id, 药品id, 性质, 批次, 效期, 可用数量, 上次批号, 上次产地, 灭菌效期)
          Values
            (r_Stock.库房id, r_Stock.药品id, 1, r_Stock.批次, r_Stock.效期,
             Decode(r_Stock.发药方式, Null, 1, -1, 0, 1) * Nvl(r_Stock.付数, 1) * Nvl(r_Stock.实际数量, 0), r_Stock.批号, r_Stock.产地,
             r_Stock.灭菌效期);
        End If;
        Delete 药品库存
        Where 库房id = r_Stock.库房id And 药品id = r_Stock.药品id And Nvl(批次, 0) = Nvl(r_Stock.批次, 0) And 性质 = 1 And
              Nvl(可用数量, 0) = 0 And Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
      End If;
    
      --删除药品收发记录(加上并发操作检查:审核人 Is Null)
      --Delete From 药品收发记录 Where ID = r_Stock.ID And 审核人 Is Null;
    
      l_药品收发.Extend;
      l_药品收发(l_药品收发.Count) := r_Stock.Id;
      Fetch c_Stock
        Into r_Stock;
    End Loop;
    Close c_Stock;
  
    --删除药品收发记录
    Forall I In 1 .. l_药品收发.Count
      Delete From 药品收发记录 Where ID = l_药品收发(I) And 审核人 Is Null;
    If Sql%RowCount <> l_药品收发.Count And l_药品收发.Count <> 0 Then
      v_Err_Msg := '要销帐的费用中存在已发的药品或卫材，或已被其他人销帐；这可能是并发操作引起的。';
      Raise Err_Item;
    End If;
  Else
    --删除药品收发记录
    Forall I In 1 .. l_药品收发.Count
      Delete From 药品收发记录 Where ID = l_药品收发(I) And 审核人 Is Null;
  End If;
  --未发药品记录
  Delete From 未发药品记录 A
  Where NO = No_In And 单据 In (9, 10, 25, 26) And Not Exists
   (Select 1
         From 药品收发记录
         Where 单据 = a.单据 And Nvl(库房id, 0) = Nvl(a.库房id, 0) And NO = No_In And Mod(记录状态, 3) = 1 And 审核人 Is Null);

  ---------------------------------------------------------------------------------
  --如果是划价,直接删除费用记录(药品处理后)
  n_Count := l_划价.Count;
  --删除划价记录
  Forall I In 1 .. l_划价.Count
    Delete From 住院费用记录 Where ID = l_划价(I);

  --删除之后再统一调整序号
  If n_Count > 0 Then
    n_Count := 1;
    For r_Serial In c_Serial Loop
      If r_Serial.价格父号 Is Null Then
        v_父号 := n_Count;
      End If;
    
      Update 住院费用记录
      Set 序号 = n_Count, 价格父号 = Decode(价格父号, Null, Null, v_父号)
      Where NO = No_In And 记录性质 = 记录性质_In And 序号 = r_Serial.序号;
    
      Update 住院费用记录
      Set 从属父号 = n_Count
      Where NO = No_In And 记录性质 = 记录性质_In And 从属父号 = r_Serial.序号;
    
      n_Count := n_Count + 1;
    End Loop;
  
  End If;
  --整张单据全部冲完时，删除病人医嘱附费
  For c_医嘱 In (Select Distinct 医嘱序号
               From 住院费用记录
               Where NO = No_In And 记录性质 = 2 And 记录状态 = 3 And 医嘱序号 Is Not Null) Loop
    Select Nvl(Count(*), 0)
    Into n_Count
    From (Select 序号, Sum(数量) As 剩余数量
           From (Select 记录状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                  From 住院费用记录
                  Where 记录性质 = 2 And 医嘱序号 + 0 = c_医嘱.医嘱序号 And NO = No_In
                  Group By 记录状态, Nvl(价格父号, 序号))
           Group By 序号
           Having Sum(数量) <> 0);
  
    If n_Count = 0 Then
      Delete From 病人医嘱附费 Where 医嘱id = c_医嘱.医嘱序号 And 记录性质 = 2 And NO = No_In;
    End If;
  End Loop;

  If v_医嘱ids Is Not Null Then
    --医嘱处理
    --场合_In    Integer:=0, --0:门诊;1-住院
    --性质_In    Integer:=1, --1-收费单;2-记帐单
    --操作_In    Integer:=0, --0:删除划价单;1-收费或记帐;2-退费或销帐
    --No_In      门诊费用记录.No%Type,
    --医嘱ids_In Varchar2 := Null
    v_医嘱ids := Substr(v_医嘱ids, 2);
    Zl_医嘱发送_计费状态_Update(1, 2, 0, No_In, v_医嘱ids);
  Else
    Zl_医嘱发送_计费状态_Update(1, 2, 2, No_In);
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_住院记帐记录_Delete;
/

--106250:胡俊勇,2017-03-09,代办人信息增加
Create Or Replace Procedure Zl_代办人信息_Insert
(
  病人id_In         In 病人信息从表.病人id%Type,
  身份证号_In       In 病人信息.身份证号%Type,
  代办人姓名_In     In 病人信息从表.信息值%Type,
  代办人身份证号_In In 病人信息从表.信息值%Type,
  就诊id_In         In 病人信息从表.就诊id%Type,
  代办人性别_In     In 病人信息从表.信息值%Type := Null,
  代办人年龄_In     In 病人信息从表.信息值%Type := Null,
  代办人电话_In     In 病人信息从表.信息值%Type := Null
) As
Begin
  --修改病人身份证号 
  Update 病人信息
  Set 身份证号 = 身份证号_In
  Where 病人id = 病人id_In And (身份证号 Is Null Or 身份证号 <> 身份证号_In);

  Update 病人信息从表
  Set 信息值 = 身份证号_In
  Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '病人身份证号';
  If Sql%RowCount = 0 Then
    Insert Into 病人信息从表
      (病人id, 就诊id, 信息名, 信息值)
    Values
      (病人id_In, 就诊id_In, '病人身份证号', 身份证号_In);
  End If;
  --修改病人信息从表――代办人姓名、代办人身份证号 
  If 代办人姓名_In Is Null Then
    Delete From 病人信息从表 Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '代办人姓名';
    Delete From 病人信息从表
    Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '代办人身份证号';
    Delete From 病人信息从表 Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '代办人性别';
    Delete From 病人信息从表 Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '代办人年龄';
    Delete From 病人信息从表 Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '代办人电话';
  Else
    Update 病人信息从表
    Set 信息值 = 代办人姓名_In
    Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '代办人姓名';
    If Sql%RowCount = 0 Then
      Insert Into 病人信息从表
        (病人id, 就诊id, 信息名, 信息值)
      Values
        (病人id_In, 就诊id_In, '代办人姓名', 代办人姓名_In);
    End If;
  
    Update 病人信息从表
    Set 信息值 = 代办人身份证号_In
    Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '代办人身份证号';
    If Sql%RowCount = 0 Then
      Insert Into 病人信息从表
        (病人id, 就诊id, 信息名, 信息值)
      Values
        (病人id_In, 就诊id_In, '代办人身份证号', 代办人身份证号_In);
    End If;
  
    Update 病人信息从表
    Set 信息值 = 代办人性别_In
    Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '代办人性别';
    If Sql%RowCount = 0 Then
      Insert Into 病人信息从表
        (病人id, 就诊id, 信息名, 信息值)
      Values
        (病人id_In, 就诊id_In, '代办人性别', 代办人性别_In);
    End If;
  
    Update 病人信息从表
    Set 信息值 = 代办人年龄_In
    Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '代办人年龄';
    If Sql%RowCount = 0 Then
      Insert Into 病人信息从表
        (病人id, 就诊id, 信息名, 信息值)
      Values
        (病人id_In, 就诊id_In, '代办人年龄', 代办人年龄_In);
    End If;
  
    Update 病人信息从表
    Set 信息值 = 代办人电话_In
    Where 病人id = 病人id_In And Nvl(就诊id, 0) = Nvl(就诊id_In, 0) And 信息名 = '代办人电话';
    If Sql%RowCount = 0 Then
      Insert Into 病人信息从表
        (病人id, 就诊id, 信息名, 信息值)
      Values
        (病人id_In, 就诊id_In, '代办人电话', 代办人电话_In);
    End If;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_代办人信息_Insert;
/

--106770:黄捷,2017-03-09,RIS预约消息通知
CREATE OR REPLACE Function zl_影像消息_XML内容获取
( 
    医嘱ID_In 病人医嘱记录.id%Type, 
    消息类型_In Varchar2, 
    当前用户_In Varchar2,
    消息标记_In Varchar2:=Null         --新版：检查报告ID 
) Return Varchar2 IS 
  v_Context Varchar2(4000); 
 
  --ZLHIS_CIS_005(医技执行安排完成) 
  Function Get_Zlhis_Cis_005 Return Varchar As 
    v_Return Varchar2(4000); 
  Begin 
        Select 
          '<patient_info>' || 
             '<patient_id>' || a.病人id || '</patient_id>' || 
             '<patient_name>' || a.姓名 ||'</patient_name>' || 
          '</patient_info>' || 
          '<patient_clinic>' || 
             '<patient_source>' || b.病人来源 ||'</patient_source>' || 
             '<clinic_dept_id>' || b.病人科室id || '</clinic_dept_id>' || 
          '</patient_clinic>' || 
          '<patient_order>' || 
             '<order_id>' || c.医嘱id || '</order_id>' || 
             '<order_expiry>' || b.医嘱期效 ||'</order_expiry>' || 
             '<order_kind>' || b.诊疗类别 || '</order_kind>' || 
             '<operation_kind>' || d.操作类型 ||'</operation_kind>' || 
             '<order_item_id>' || c.医嘱id || '</order_item_id>' || 
             '<order_item_title>' || b.医嘱内容 ||'</order_item_title>' || 
          '</patient_order>' || 
          '<arrange_result>' || 
             '<arrange_time>' ||To_Char(c.安排时间,'yyyy/mm/dd hh24:mi:ss')|| '</arrange_time>' || 
          '</arrange_result>'   Into v_Return 
 
      From 病人信息 A, 病人医嘱记录 B, 病人医嘱发送 C, 诊疗项目目录 D 
      Where a.病人id = b.病人id And c.医嘱id = b.Id And b.诊疗项目id = d.Id And c.安排时间 Is Not Null And b.相关id Is Null And 
          b.诊疗类别 = 'D' And b.Id = 医嘱id_In; 
    Return v_Return; 
  End Get_Zlhis_Cis_005; 
 
  --ZLHIS_CIS_017(患者检查申请) 
  Function Get_ZLHIS_CIS_017 Return Varchar As 
    v_return Varchar2(4000); 
  Begin 
        Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(d.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_dept_id>' || nvl(a.当前科室id,0) || '</clinic_dept_id>' || 
           '</patient_clinic>' || 
           '<check_request>' || 
               '<request_id>' || b.id || '</request_id>' || 
               '<check_item_id>' || b.诊疗项目id || '</check_item_id>' || 
               '<check_item_title>' || b.医嘱内容 || '</check_item_title>' || 
               '<execute_dept_id>' || nvl(c.执行部门id,0) || '</execute_dept_id>' || 
               '<send_serial>' || c.发送号 || '</send_serial>' || 
               '<bill_no>' || c.NO || '</bill_no>' || 
               '<bill_kind>' || c.记录性质 || '</bill_kind>' || 
               '<create_doctor>' || b.开嘱医生 || '</create_doctor>' || 
               '<create_time>' || b.开嘱时间 || '</create_time>' || 
               '<create_dept_id>' || nvl(b.开嘱科室id,0) || '</create_dept_id>' || 
           '</check_request>' into v_return 
 
        From 病人信息 a, 病人医嘱记录 b, 病人医嘱发送 c, 病人挂号记录 d 
        Where a.病人id=b.病人id And b.id=c.医嘱id And b.挂号单=d.no(+) And b.相关ID Is Null 
              And a.病人id=b.病人id And b.id=医嘱ID_In; 
 
      Return v_return; 
  End Get_ZLHIS_CIS_017; 
  
  --ZLHIS_CIS_015(医技拒绝执行) 
  Function Get_ZLHIS_CIS_015 Return Varchar As 
    v_return Varchar2(4000); 
  Begin 
       Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(e.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_dept_id>' || nvl(a.当前科室id,0) || '</clinic_dept_id>' || 
           '</patient_clinic>' || 
           '<refuse_order>' || 
               '<order_id>' || b.id || '</order_id>' || 
               '<order_expiry>1</order_expiry>' || 
               '<order_kind>' || b.诊疗类别 || '</order_kind>' || 
               '<operation_kind>' || d.操作类型 || '</operation_kind>' || 
               '<order_item_id>' || b.诊疗项目ID || '</order_item_id>' || 
               '<order_item_title>' || d.名称 || '</order_item_title>' || 
           '</refuse_order>' Into v_return 
 
       From 病人信息 a, 病人医嘱记录 b, 病人医嘱发送 c, 诊疗项目目录 d, 病人挂号记录 e 
       Where a.病人id=b.病人id And b.id=c.医嘱id And b.诊疗项目id=d.id And b.挂号单=e.no(+) And b.相关ID Is Null 
              And a.病人id=b.病人id And b.id=医嘱ID_In; 
              
       Return v_return;     
  End Get_ZLHIS_CIS_015;   
   
 
  --ZLHIS_CIS_024(患者医嘱撤销) 
  Function Get_ZLHIS_CIS_024 Return Varchar As 
    v_return Varchar2(4000); 
  Begin 
       Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(e.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_dept_id>' || nvl(a.当前科室id,0) || '</clinic_dept_id>' || 
           '</patient_clinic>' || 
           '<cancel_order>' || 
               '<order_id>' || b.id || '</order_id>' || 
               '<order_kind>' || b.诊疗类别 || '</order_kind>' || 
               '<operation_kind>' || d.操作类型 || '</operation_kind>' || 
           '</cancel_order>' Into v_return 
 
       From 病人信息 a, 病人医嘱记录 b, 病人医嘱发送 c, 诊疗项目目录 d, 病人挂号记录 e 
       Where a.病人id=b.病人id And b.id=c.医嘱id And b.诊疗项目id=d.id And b.挂号单=e.no(+) And b.相关ID Is Null 
              And a.病人id=b.病人id And b.id=医嘱ID_In; 
 
      Return v_return; 
  End Get_ZLHIS_CIS_024; 
 
 
  --ZLHIS_PACS_001(检查报告完成) 
  Function Get_ZLHIS_PACS_001 Return Varchar As 
    v_return Varchar2(4000); 
  Begin 
    If 消息标记_In Is Null Then
        Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(e.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_dept_id>' || nvl(a.当前科室id,0) || '</clinic_dept_id>' || 
           '</patient_clinic>' || 
           '<advice_info>' || 
               '<order_id>' || b.id || '</order_id>' || 
               '<check_item_id>' || b.诊疗项目id || '</check_item_id>' || 
               '<check_item_title>' || b.医嘱内容 || '</check_item_title>' || 
               '<create_doctor>' || b.开嘱医生 || '</create_doctor>' || 
               '<create_dept_id>' || nvl(b.开嘱科室id, 0) || '</create_dept_id>' || 
               '<study_execute_id>' || nvl(b.执行科室id,0) || '</study_execute_id>' || 
           '</advice_info>' || 
           '<report_inf>' || 
               '<report_id>' || d.病历id || '</report_id>' || 
               '<report_doctor>' || c.完成人 || '</report_doctor>' || 
               '<result_positive>' || c.结果阳性 || '</result_positive>' || 
           '</report_inf>'  Into v_return 
 
        From 病人信息 a, 病人医嘱记录 b, 病人医嘱发送 c, 病人医嘱报告 d, 病人挂号记录 e 
        Where a.病人id=b.病人id And b.id=c.医嘱id And b.id=d.医嘱id And b.挂号单=e.no(+) And b.相关ID Is Null 
              And d.检查报告id Is Null And a.病人id=b.病人id And b.id=医嘱ID_In; 
    Else
        Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(e.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_dept_id>' || nvl(a.当前科室id,0) || '</clinic_dept_id>' || 
           '</patient_clinic>' || 
           '<advice_info>' || 
               '<order_id>' || b.id || '</order_id>' || 
               '<check_item_id>' || b.诊疗项目id || '</check_item_id>' || 
               '<check_item_title>' || b.医嘱内容 || '</check_item_title>' || 
               '<create_doctor>' || b.开嘱医生 || '</create_doctor>' || 
               '<create_dept_id>' || nvl(b.开嘱科室id, 0) || '</create_dept_id>' || 
               '<study_execute_id>' || nvl(b.执行科室id,0) || '</study_execute_id>' || 
           '</advice_info>' || 
           '<report_inf>' || 
               '<report_id>' || d.检查报告id || '</report_id>' || 
               '<report_doctor>' || c.完成人 || '</report_doctor>' || 
               '<result_positive>' || c.结果阳性 || '</result_positive>' || 
           '</report_inf>'  Into v_return 
 
        From 病人信息 a, 病人医嘱记录 b, 病人医嘱发送 c, 病人医嘱报告 d, 病人挂号记录 e 
        Where a.病人id=b.病人id And b.id=c.医嘱id And b.id=d.医嘱id And b.挂号单=e.no(+) And b.相关ID Is Null 
              And d.病历id Is Null And a.病人id=b.病人id And b.id=医嘱ID_In And d.检查报告id=消息标记_In; 
    End If;
    
    Return v_return; 
  End Get_ZLHIS_PACS_001; 
 
  --ZLHIS_PACS_002(患者状态同步) 
  Function Get_ZLHIS_PACS_002 Return Varchar As 
    v_return Varchar2(4000); 
  Begin 
        Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<identity_card>' || a.身份证号 || '</identity_card>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(d.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_dept_id>' || nvl(a.当前科室id,0) || '</clinic_dept_id>' || 
           '</patient_clinic>' || 
           '<study_state>' || 
               '<study_cur_state>' || nvl(c.执行过程,0) || '</study_cur_state>' || 
               '<study_cur_time>' || sysdate || '</study_cur_time>' || 
               '<order_id>' || b.id || '</order_id>' || 
               '<study_item_id>' || b.诊疗项目id || '</study_item_id>' || 
               '<study_item_title>' || b.医嘱内容 || '</study_item_title>' || 
               '<study_oper_person>' || 当前用户_In || '</study_oper_person>' || 
               '<study_execute_id>' || nvl(b.执行科室id,0) || '</study_execute_id>' || 
           '</study_state>' Into v_return 
 
        From 病人信息 a, 病人医嘱记录 b, 病人医嘱发送 c, 病人挂号记录 d 
        Where a.病人id=b.病人id And b.id=c.医嘱id And b.挂号单=d.no(+) And b.相关ID Is Null 
              And a.病人id=b.病人id And b.id=医嘱ID_In; 
 
      Return v_return; 
  End Get_ZLHIS_PACS_002; 
 
 
  --ZLHIS_PACS_003(检查状态回退) 
  Function Get_ZLHIS_PACS_003 Return Varchar As 
    v_return Varchar2(4000); 
  Begin 
        Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<identity_card>' || a.身份证号 || '</identity_card>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(d.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_dept_id>' || nvl(a.当前科室id, 0) || '</clinic_dept_id>' || 
           '</patient_clinic>' || 
           '<study_state>' || 
               '<study_cur_state>' || nvl(c.执行过程,0) || '</study_cur_state>' || 
               '<study_cur_time>' || Sysdate || '</study_cur_time>' || 
               '<study_order_id>' || b.id || '</study_order_id>' || 
               '<study_item_id>' || b.诊疗项目id || '</study_item_id>' || 
               '<study_item_title>' || b.医嘱内容 || '</study_item_title>' || 
               '<study_oper_person>' || 当前用户_In || '</study_oper_person>' || 
               '<study_execute_id>' || nvl(b.执行科室id,0) || '</study_execute_id>' || 
           '</study_state>' Into v_return 
 
        From 病人信息 a, 病人医嘱记录 b, 病人医嘱发送 c, 病人挂号记录 d 
        Where a.病人id=b.病人id And b.id=c.医嘱id And b.挂号单=d.no(+) And b.相关ID Is Null 
              And a.病人id=b.病人id And b.id=医嘱ID_In; 
 
      Return v_return; 
  End Get_ZLHIS_PACS_003; 
 
 
  --ZLHIS_PACS_004(检查报告撤销) 
  Function Get_ZLHIS_PACS_004 Return Varchar As 
    v_return Varchar2(4000); 
  Begin 
    If 消息标记_In Is Null Then
        Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(e.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_dept_id>' || nvl(a.当前科室id,0) || '</clinic_dept_id>' || 
           '</patient_clinic>' || 
           '<advice_info>' || 
               '<order_id>' || b.id || '</order_id>' || 
               '<cur_state>' || nvl(c.执行过程,0) || '</cur_state>' || 
               '<check_item_id>' || b.诊疗项目id || '</check_item_id>' || 
               '<check_item_title>' || b.医嘱内容 || '</check_item_title>' || 
               '<create_doctor>' || b.开嘱医生 || '</create_doctor>' || 
               '<create_dept_id>' || nvl(b.开嘱科室id,0) || '</create_dept_id>' || 
               '<study_execute_id>' || nvl(b.执行科室id,0) || '</study_execute_id>' || 
           '</advice_info>' || 
           '<report_info>' || 
               '<report_id>' || d.病历id || '</report_id>' || 
           '</report_info>'  Into v_return 
 
        From 病人信息 a, 病人医嘱记录 b, 病人医嘱发送 c, 病人医嘱报告 d, 病人挂号记录 e 
        Where a.病人id=b.病人id And b.id=c.医嘱id And b.id=d.医嘱id And b.挂号单=e.no(+) And b.相关ID Is Null 
              And d.检查报告id Is Null And a.病人id=b.病人id And b.id=医嘱ID_In; 
    Else
        Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(e.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_dept_id>' || nvl(a.当前科室id,0) || '</clinic_dept_id>' || 
           '</patient_clinic>' || 
           '<advice_info>' || 
               '<order_id>' || b.id || '</order_id>' || 
               '<cur_state>' || nvl(c.执行过程,0) || '</cur_state>' || 
               '<check_item_id>' || b.诊疗项目id || '</check_item_id>' || 
               '<check_item_title>' || b.医嘱内容 || '</check_item_title>' || 
               '<create_doctor>' || b.开嘱医生 || '</create_doctor>' || 
               '<create_dept_id>' || nvl(b.开嘱科室id,0) || '</create_dept_id>' || 
               '<study_execute_id>' || nvl(b.执行科室id,0) || '</study_execute_id>' || 
           '</advice_info>' || 
           '<report_info>' || 
               '<report_id>' || d.检查报告id || '</report_id>' || 
           '</report_info>'  Into v_return 
 
        From 病人信息 a, 病人医嘱记录 b, 病人医嘱发送 c, 病人医嘱报告 d, 病人挂号记录 e 
        Where a.病人id=b.病人id And b.id=c.医嘱id And b.id=d.医嘱id And b.挂号单=e.no(+) And b.相关ID Is Null 
              And d.病历id Is Null And a.病人id=b.病人id And b.id=医嘱ID_In And d.检查报告id=消息标记_In; 
    End If;
    
    Return v_return; 
  End Get_ZLHIS_PACS_004; 
  
  --ZLHIS_PACS_005(检查危急值通知) 
  Function Get_ZLHIS_PACS_005 Return Varchar As 
    v_return Varchar2(4000); 
  Begin 
        With t As (Select id, 姓名 From 人员表) 
        Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(i.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_area_id>' || nvl(a.当前病区id,0) || '</clinic_area_id>' || 
               '<clinic_dept_id>' || nvl(b.开嘱科室id,0) || '</clinic_dept_id>' || 
               '<in_doctor_id>' || nvl(e.id,0) || '</in_doctor_id>' || 
               '<director_doctor_id>' || nvl(g.id,0) || '</director_doctor_id>' || 
               '<treat_doctor_id>' || nvl(h.id,0) || '</treat_doctor_id>' || 
               '<duty_nurse_id>' || nvl(f.id,0) || '</duty_nurse_id>' || 
           '</patient_clinic>' || 
           '<check_order>' || 
               '<order_id>' || b.id || '</order_id>' || 
               '<check_item_id>' || b.诊疗项目id || '</check_item_id>' || 
               '<check_item_title>' || b.医嘱内容 || '</check_item_title>' || 
               '<study_execute_id>' || nvl(b.执行科室id,0) || '</study_execute_id>' || 
           '</check_order>'  Into v_return 
 
        From 病人信息 a, 病人医嘱记录 b, 病案主页 c, 病人挂号记录 i, 
             (Select a.病人ID,a.主页ID,主任医师,主治医师 From 病人变动记录 a,病人医嘱记录 b 
              Where a.病人id=b.病人id And a.开始原因 Is Not Null And a.终止时间 Is Null And b.id=0) d, 
              t e, t f, t g, t h 
        Where b.病人id = a.病人id And b.挂号单=i.no(+) 
              And b.病人id=c.病人id(+) And b.主页id=c.主页id(+) 
              And c.住院医师=e.姓名(+) And c.责任护士=f.姓名(+) 
              And c.病人id =d.病人id(+) And c.主页id=d.主页id(+) 
              And d.主任医师=g.姓名(+) And d.主治医师=h.姓名(+) 
              And b.相关id Is Null And a.病人id=b.病人id And b.id=医嘱ID_In; 
 
      Return v_return; 
  End Get_ZLHIS_PACS_005;
  
  --ZLHIS_PACS_006(检查预约通知) 
  Function Get_ZLHIS_PACS_006 Return Varchar As 
    v_return Varchar2(4000); 
  Begin 
        Select 
           '<patient_info>' || 
               '<patient_id>' || a.病人id || '</patient_id>' || 
               '<patient_name>' || a.姓名 || '</patient_name>' || 
               '<in_number>' || nvl(a.住院号,0) || '</in_number>' || 
               '<out_number>' || nvl(a.门诊号,0) || '</out_number>' || 
           '</patient_info>' || 
           '<patient_clinic>' || 
               '<patient_source>' || b.病人来源 || '</patient_source>' || 
               '<clinic_id>' || Case b.病人来源 When 1 Then nvl(i.id,0) When 2 Then nvl(b.主页id, 0) Else 0 End || '</clinic_id>' || 
               '<clinic_area_id>' || nvl(a.当前病区id,0) || '</clinic_area_id>' || 
               '<clinic_dept_id>' || nvl(b.开嘱科室id,0) || '</clinic_dept_id>' || 
           '</patient_clinic>' || 
           '<check_order>' || 
               '<order_id>' || b.id || '</order_id>' || 
               '<check_item_id>' || b.诊疗项目id || '</check_item_id>' || 
               '<check_item_title>' || b.医嘱内容 || '</check_item_title>' || 
               '<study_execute_id>' || nvl(b.执行科室id,0) || '</study_execute_id>' ||
               '<schedult_id>' || k.预约id || '</schedult_id>' ||
               '<machine_id>' || nvl(k.检查设备id,0) || '</machine_id>' ||
               '<machine_name>' || nvl(k.检查设备名称,'') || '</machine_name>' ||
               '<schedule_date>' || To_Char(k.预约日期, 'YYYY-MM-DD HH24:MI:SS') || '</schedule_date>' ||
               '<schedule_begin_time>' || To_Char(k.预约开始时间, 'YYYY-MM-DD HH24:MI:SS') || '</schedule_begin_time>' ||
               '<schedule_end_time>' || To_Char(k.预约结束时间, 'YYYY-MM-DD HH24:MI:SS')  || '</schedule_end_time>' ||
               '<schedule_sec_begin>' || To_Char(k.预约开始时间段, 'YYYY-MM-DD HH24:MI:SS')  || '</schedule_sec_begin>' ||
               '<schedule_sec_end>' || To_Char(k.预约结束时间段, 'YYYY-MM-DD HH24:MI:SS')  || '</schedule_sec_end>' ||
               '<schedule_call_no>' || nvl(k.序号,0) || '</schedule_call_no>' || 
           '</check_order>'  Into v_return 
 
        From 病人信息 a, 病人医嘱记录 b, 病案主页 c, 病人挂号记录 i, Ris检查预约 k 
        Where b.病人id = a.病人id And b.挂号单=i.no(+) 
              And b.病人id=c.病人id(+) And b.主页id=c.主页id(+) 
              And b.id =k.医嘱id 
              And b.相关id Is Null And a.病人id=b.病人id And b.id=医嘱ID_In; 
 
      Return v_return; 
  End Get_ZLHIS_PACS_006; 
 
Begin 
  v_Context := ''; 
 
  Case 消息类型_In 
    When 'ZLHIS_CIS_005' Then 
      --ZLHIS_CIS_005(医技执行安排完成) 
      v_Context := Get_ZLHIS_CIS_005; 
 
    When 'ZLHIS_CIS_015' Then 
        --ZLHIS_CIS_015(医技拒绝执行) 
        v_Context := Get_ZLHIS_CIS_015; 
        
    When 'ZLHIS_CIS_017' Then 
        --ZLHIS_CIS_017(患者检查申请) 
        v_Context := Get_ZLHIS_CIS_017; 
 
    When 'ZLHIS_CIS_024' Then 
        --ZLHIS_PACS_024(患者医嘱撤销) 
        v_Context := Get_ZLHIS_CIS_024; 
 
    When 'ZLHIS_PACS_001' Then 
        --ZLHIS_PACS_001(检查报告完成) 
        v_Context := Get_ZLHIS_PACS_001; 
 
    When 'ZLHIS_PACS_002' Then 
        --ZLHIS_PACS_002(检查状态同步) 
        v_Context := Get_ZLHIS_PACS_002; 
 
    When 'ZLHIS_PACS_003' Then 
        --ZLHIS_PACS_003(检查状态回退) 
        v_Context := Get_ZLHIS_PACS_003; 
 
    When 'ZLHIS_PACS_004' Then 
        --ZLHIS_PACS_004(检查报告撤销) 
        v_Context := Get_ZLHIS_PACS_004; 
 
    When 'ZLHIS_PACS_005' Then 
        --ZLHIS_PACS_005(检查危急值通知) 
        v_Context := Get_ZLHIS_PACS_005; 
    
    When 'ZLHIS_PACS_006' Then 
        --ZLHIS_PACS_006(检查预约通知) 
        v_Context := Get_ZLHIS_PACS_006; 
    Else 
      Return ''; 
  End Case; 
 
  Return v_Context; 
End zl_影像消息_XML内容获取;
/
--106126:余伟节,2017-03-10,分娩信息维护
Create Or Replace Procedure Zl_分娩信息_Delete
(
  病人id_In 病案主页.病人id%Type,
  主页id_In 病案主页.主页id%Type,
  n_类型    Number := 0
  --N_类型:0 Null,删除新生儿信息，由于新生儿与新生儿诊断存在父子关系，所以删除新生儿信息就可以删除新生儿诊断信息
  --    1,只删除新生儿诊断信息
) As

Begin
  If Nvl(n_类型, 0) = 0 Then
    Delete 病人分娩信息 Where 病人id = 病人id_In And 主页id = 主页id_In;
  Else
    Delete 新生儿诊断记录 Where 病人id = 病人id_In And 主页id = 主页id_In;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_分娩信息_Delete;
/
--106126:余伟节,2017-03-10,分娩信息维护
Create Or Replace Procedure Zl_病人分娩信息_Insert
(
  病人id_In    病人分娩信息.病人id%Type,
  主页id_In    病人分娩信息.主页id%Type,
  胎儿次序_In  病人分娩信息.胎儿次序%Type,
  分娩方式_In  病人分娩信息.分娩方式%Type,
  出生胎位_In  病人分娩信息.出生胎位%Type,
  分娩情况_In  病人分娩信息.分娩情况%Type,
  出生缺陷_In  病人分娩信息.出生缺陷%Type,
  婴儿性别_In  病人分娩信息.婴儿性别%Type,
  婴儿体重_In  病人分娩信息.婴儿体重%Type,
  Apgar评分_In 病人分娩信息.Apgar评分%Type
) Is
Begin
  Insert Into 病人分娩信息
    (病人id, 主页id, 胎儿次序, 分娩方式, 出生胎位, 分娩情况, 出生缺陷, 婴儿性别, 婴儿体重, Apgar评分)
  Values
    (病人id_In, 主页id_In, 胎儿次序_In, 分娩方式_In, 出生胎位_In, 分娩情况_In, 出生缺陷_In, 婴儿性别_In, 婴儿体重_In, Apgar评分_In);
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人分娩信息_Insert;
/
--106126:余伟节,2017-03-10,分娩信息维护
Create Or Replace Procedure Zl_新生儿诊断记录_Insert
(
  病人id_In   新生儿诊断记录.病人id%Type,
  主页id_In   新生儿诊断记录.主页id%Type,
  胎儿次序_In 新生儿诊断记录.胎儿次序%Type,
  诊断次序_In 新生儿诊断记录.诊断次序%Type,
  疾病id_In   新生儿诊断记录.疾病id%Type,
  描述信息_In 新生儿诊断记录.描述信息%Type
) Is
Begin
  Insert Into 新生儿诊断记录
    (病人id, 主页id, 胎儿次序, 诊断次序, 疾病id, 描述信息)
  Values
    (病人id_In, 主页id_In, 胎儿次序_In, 诊断次序_In, 疾病id_In, 描述信息_In);
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_新生儿诊断记录_Insert;
/

--107636:张德婷,2017-04-01,多次发送医嘱自动保持批次后取消变标识
--107036:李业庆,2017-03-13,变量类型造成小数位数问题
Create Or Replace Procedure Zl_输液配药记录_核查
(
  部门id_In   In 输液配药记录.部门id%Type,
  医嘱id_In   In Varchar2, --输液医嘱给药途径对应的医嘱ID:医嘱ID1,医嘱ID2...
  发送号_In   In 病人医嘱发送.发送号%Type,
  核查人_In   In 输液配药状态.操作人员%Type,
  核查时间_In In 输液配药状态.操作时间%Type
) Is
  v_Count    Number;
  v_序号     Number;
  v_执行时间 Date;

  v_相关id      Number;
  v_New相关id   Number;
  v_Old相关id   Number;
  v_发送号      Number;
  v_Tmp         Varchar2(200);
  I             Number;
  v_配药id      Number;
  v_批次        Number;
  v_Maxno       Varchar2(4000);
  v_Lableno     Varchar2(200);
  v_Maxbatch    Number;
  v_Curdose     Number;
  v_Sumdose     Number;
  v_Drugcount   Number;
  v_Currdate    Date;
  n_Needcheck   Number;
  n_Lngid       药品收发记录.Id%Type;
  n_Count       Number(3);
  n_单据        药品收发记录.单据%Type;
  v_No          药品收发记录.No%Type;
  n_发送次数    Number(5);
  n_病人id      病人信息.病人id%Type := 0;
  b_Change      Boolean := True;
  n_Sum         Number;
  n_调整批次    Number(1);
  n_Cur         Number(5);
  v_上次发送号  病人医嘱发送.发送号%Type;
  v_医嘱ids     Varchar2(4000);
  v_Tansid      Varchar2(12);
  v_当前病人    Varchar2(20);
  n_Num         Number(8);
  d_Old执行时间 Date;
  n_是否打包    Number(1);
  n_打包        Number(1);
  n_摆药单      Number(2);
  --控制参数
  v_医嘱类型       Number;
  v_输液总量       Number;
  v_大输液剂型     Varchar2(2000);
  v_大输液给药途径 Varchar2(2000);
  v_来源科室       Varchar2(4000);
  v_Continue       Number := 1;
  v_Nodosage       Number := 0;
  v_保持上次批次   Number := 0;
  d_手工打包时间   Date;
  n_Tpn处置方式    Number := 0;
  v_药品类型       Varchar2(20);
  n_打包药品批次   Number(1);
  n_特殊药品批次   Number(1);
  n_优先级         Number := 999;
  n_自动排批       Number := 0;
  n_科室id         Number := 0;
  n_Row            Number(2);
  n_备用批次       Number := 0;
  n_剩余数量       Number := 0;
  n_单次数量       Number := 0;
  n_累计数量       Number := 0;
  n_医嘱id         Number := 0;
  n_填写数量       Number := 0;
  v_配药类型       Varchar2(20);
  v_时间串         Varchar2(100);
  v_时间值         Date;
  v_Fields         Varchar2(100);
  v_是否改变       Varchar2(20);
  v_时间串1        Varchar2(100);
  Err_Item Exception;
  n_流通金额小数 Number;

  Cursor c_医嘱记录 Is
    Select /*+rule */
    Distinct e.医嘱id As 相关id, e.发送号, b.频率间隔, b.间隔单位, b.执行时间方案, a.姓名, a.性别, a.年龄, a.住院号, a.当前床号 As 床号, a.当前病区id As 病人病区id,
             a.当前科室id As 病人科室id, e.首次时间, e.末次时间, b.开始执行时间, Nvl(e.发送数次, 0) As 次数, e.发送时间, Decode(b.医嘱期效, 0, 1, 2) As 医嘱类型,
             b.诊疗项目id As 给药途径, b.病人id, Nvl(c.执行标记, 0) As 是否tpn
    From 病人医嘱发送 E, 病人医嘱记录 B, 病人信息 A, 诊疗项目目录 C, Table(f_Num2list(医嘱id_In)) D
    Where e.医嘱id = b.Id And b.病人id = a.病人id And c.类别 = 'E' And c.操作类型 = '2' And c.执行分类 = 1 And b.诊疗项目id = c.Id And
          e.医嘱id = d.Column_Value And e.发送号 = 发送号_In
    Order By b.病人id, e.医嘱id, e.发送号;

  Cursor c_单个医嘱记录 Is
    Select /*+rule */
    Distinct e.医嘱id, e.发送号, b.频率间隔, b.间隔单位, b.执行时间方案, a.姓名, a.性别, a.年龄, a.住院号, a.当前床号 As 床号, a.当前病区id As 病人病区id,
             a.当前科室id As 病人科室id, e.首次时间, e.末次时间, b.开始执行时间, Nvl(e.发送数次, 0) As 次数, e.发送时间, Decode(b.医嘱期效, 0, 1, 2) As 医嘱类型,
             b.诊疗项目id As 给药途径, b.病人id
    From 病人医嘱发送 E, 病人医嘱记录 B, 病人信息 A, 诊疗项目目录 C
    Where e.医嘱id = b.Id And b.病人id = a.病人id And b.诊疗项目id = c.Id And b.相关id = v_相关id And e.发送号 = 发送号_In
    Order By e.医嘱id, e.发送号;

  Cursor c_收发记录 Is
    Select Distinct c.Id As 收发id, c.序号, c.实际数量 As 数量, Nvl(e.是否不予配置, 0) As 是否不予配置, c.单据, c.No
    From 病人医嘱记录 A, 病人医嘱发送 B, 药品收发记录 C, 住院费用记录 D, 输液药品属性 E
    Where a.Id = b.医嘱id And c.费用id = d.Id And a.Id = d.医嘱序号 And b.No = c.No And c.药品id = e.药品id(+) And
          b.执行部门id + 0 = 部门id_In And c.单据 = 9 And c.审核日期 Is Null And a.Id = n_医嘱id And b.发送号 = 发送号_In And c.序号 < 1000
    Order By c.No, c.序号;

  Cursor c_原始收发记录 Is
    Select Distinct c.Id As 收发id, c.序号, c.实际数量 As 数量, Nvl(e.是否不予配置, 0) As 是否不予配置, c.单据, c.No
    From 病人医嘱记录 A, 病人医嘱发送 B, 药品收发记录 C, 住院费用记录 D, 输液药品属性 E
    Where a.Id = b.医嘱id And c.费用id = d.Id And a.Id = d.医嘱序号 And b.No = c.No And c.药品id = e.药品id(+) And
          b.执行部门id + 0 = 部门id_In And c.单据 = 9 And c.审核日期 Is Null And a.相关id = v_相关id And b.发送号 = 发送号_In And c.序号 < 1000
    Order By c.No, c.序号;

  Cursor c_输液单记录 Is
    Select a.Id, a.执行时间, a.配药批次, a.医嘱id, d.发送时间
    From 输液配药记录 A, 病人医嘱记录 B, 配药工作批次 C, 病人医嘱发送 D
    Where a.医嘱id = b.Id And a.配药批次 = c.批次 And d.医嘱id = a.医嘱id And a.发送号 = d.发送号 And c.批次 <> 0 And c.药品类型 Is Null And
          b.病人id = n_病人id And a.操作状态 < 2 And a.执行时间 Between Trunc(v_时间值) And Trunc(v_时间值 + 1) - 1 / 24 / 60 / 60;

  v_输液单记录   c_输液单记录%RowType;
  v_医嘱记录     c_医嘱记录%RowType;
  v_收发记录     c_收发记录%RowType;
  v_单个医嘱记录 c_单个医嘱记录%RowType;

  Function Zl_Getpivaworkbatch
  (
    执行时间_In In Date,
    发送时间_In In Date,
    药品类型_In In Varchar2 := Null
  ) Return Number As
  
    v_Exetime   Date;
    v_Starttime Date;
    v_Endtime   Date;
    v_Maxbatch  Number(2);
    v_Batch     Number;
    Cursor c_配药批次 Is
      Select 批次, 配药时间, 给药时间, 打包, 药品类型
      From 配药工作批次
      Where 启用 = 1 And 配置中心id = 部门id_In
      Order By 药品类型, 批次;
  
    v_配药批次 c_配药批次%RowType;
  Begin
    v_Exetime := To_Date(Substr(To_Char(执行时间_In, 'yyyy-mm-dd hh24:mi'), 12), 'hh24:mi');
  
    Select Max(Nvl(批次, 0)) + 1 Into v_Maxbatch From 配药工作批次 Where 启用 = 1 And 配置中心id = 部门id_In;
  
    For v_配药批次 In c_配药批次 Loop
      v_Batch := 0;
    
      --当天发送的医嘱发送到备用批次
      If (Trunc(执行时间_In) >= Trunc(v_Currdate) And Trunc(发送时间_In) < Trunc(执行时间_In)) Or n_备用批次 = 0 Then
        If v_配药批次.批次 <> '0' And
           ((Nvl(v_配药批次.药品类型, '0') <> '0' And v_配药批次.药品类型 = 药品类型_In) Or Nvl(v_配药批次.药品类型, '0') = '0') Then
          v_Starttime := To_Date(Substr(v_配药批次.给药时间, 1, Instr(v_配药批次.给药时间, '-') - 1), 'hh24:mi');
          v_Endtime   := To_Date(Substr(v_配药批次.给药时间, Instr(v_配药批次.给药时间, '-') + 1), 'hh24:mi');
        
          If v_Exetime >= v_Starttime And v_Exetime <= v_Endtime Then
            v_Batch := v_配药批次.批次;
            n_打包  := v_配药批次.打包;
            Exit When v_Batch > 0;
          End If;
        End If;
      End If;
    End Loop;
  
    If v_Batch = 0 And (n_打包药品批次 <> 1 Or n_备用批次 = 1) Then
      v_Batch := v_Maxbatch;
    End If;
    Return(v_Batch);
  End;

  Function Zl_Getfirst
  (
    配药id_In In Number,
    科室id_In In Number
  ) Return Number As
    n_First  Number;
    n_科室id Number;
    Cursor c_优先级 Is
      Select 科室id, 配药类型, 优先级, 频次
      From 输液药品优先级
      Where (科室id = 科室id_In Or 科室id = 0)
      Order By 科室id, 优先级 Desc;
  
    r_优先级 c_优先级%RowType;
  Begin
    n_First := 0;
    For r_优先级 In c_优先级 Loop
      If n_科室id <> 0 And r_优先级.科室id = 0 Then
        Exit;
      End If;
      n_科室id := r_优先级.科室id;
    
      For r_配药记录 In (Select Distinct d.配药类型, e.执行频次
                     From 输液配药记录 A, 输液配药内容 B, 药品收发记录 C, 输液药品属性 D, 病人医嘱记录 E
                     Where a.医嘱id = e.Id And a.Id = b.记录id And b.收发id = c.Id And c.药品id = d.药品id And a.Id = 配药id_In) Loop
        If Instr(r_配药记录.配药类型, r_优先级.配药类型, 1) > 0 And (Instr(r_优先级.频次, r_配药记录.执行频次, 1) > 0 Or r_优先级.频次 = '所有频次') Then
          n_First := r_优先级.优先级;
          Exit;
        End If;
      End Loop;
    End Loop;
  
    If n_First = 0 Then
      n_First := 999;
    End If;
    Return(n_First);
  End;
Begin
  n_Count          := 0;
  v_医嘱类型       := Zl_To_Number(Nvl(zl_GetSysParameter('医嘱类型', 1345), 1));
  v_输液总量       := Zl_To_Number(Nvl(zl_GetSysParameter('同批次输液总量', 1345), 0));
  v_大输液剂型     := Nvl(zl_GetSysParameter('大输液药品剂型', 1345), '');
  v_大输液给药途径 := Nvl(zl_GetSysParameter('输液给药途径', 1345), '');
  v_来源科室       := Nvl(zl_GetSysParameter('来源科室', 1345), '');
  v_保持上次批次   := Zl_To_Number(Nvl(zl_GetSysParameter('保持上次批次', 1345), 0));
  n_Tpn处置方式    := Zl_To_Number(Nvl(zl_GetSysParameter('静脉营养药物处置方式', 1345), 0));
  n_打包药品批次   := Zl_To_Number(Nvl(zl_GetSysParameter('单个药品，不予配置药品及根据给药时间没有配药批次的输液单默认为0批次并打包', 1345), 0));
  n_特殊药品批次   := Zl_To_Number(Nvl(zl_GetSysParameter('特殊药品按药品类型指定批次', 1345), 0));
  n_自动排批       := Zl_To_Number(Nvl(zl_GetSysParameter('启动自动排批', 1345), 0));
  n_备用批次       := Zl_To_Number(Nvl(zl_GetSysParameter('当天发送的医嘱产生的输液单全部到备用批次', 1345), 0));
  v_医嘱ids        := 医嘱id_In;
  v_当前病人       := '';
  n_发送次数       := 0;

  --取流通业务精度位数
  --类别:1-药品 2-卫材
  --内容：2-零售价 4-金额
  --单位：药品:1-售价 5-金额单位
  Select 精度 Into n_流通金额小数 From 药品卫材精度 Where 类别 = 1 And 内容 = 4 And 单位 = 5;

  Select Trunc(Sysdate) Into v_Currdate From Dual;

  Select Max(Nvl(批次, 0)) + 1 Into v_Maxbatch From 配药工作批次;

  --检查当前病人的医嘱是否有今天需要执行的输液单是锁定状态的
  If Instr(v_医嘱ids, ',') = 0 Then
    v_Tansid := v_医嘱ids;
  Else
    v_Tansid := Substr(v_Tmp, 1, Instr(v_医嘱ids, ',') - 1);
  End If;

  Select Count(ID)
  Into n_Num
  From 输液配药记录
  Where 是否锁定 = 1 And 执行时间 Between Trunc(v_Currdate) And Trunc(v_Currdate + 1) - 1 / 24 / 60 / 60 And
        医嘱id In
        (Select 相关id
         From 病人医嘱记录
         Where 病人id = (Select 病人id From 病人医嘱记录 Where 相关id = v_Tansid And Rownum < 2) And (诊疗类别 = '5' Or 诊疗类别 = '6')) And
        Rownum < 2;

  If n_Num > 0 Then
    Select 姓名
    Into v_当前病人
    From 输液配药记录
    Where 是否锁定 = 1 And 执行时间 Between Trunc(v_Currdate) And Trunc(v_Currdate + 1) - 1 / 24 / 60 / 60 And
          医嘱id In
          (Select 相关id
           From 病人医嘱记录
           Where 病人id = (Select 病人id From 病人医嘱记录 Where 相关id = v_Tansid And Rownum < 2) And (诊疗类别 = '5' Or 诊疗类别 = '6')) And
          Rownum < 2;
    Raise Err_Item;
  End If;

  --先将原收发记录的序号增大，新的收发记录产生后再删除
  --Update 药品收发记录
  --Set 序号 = 序号 + 10000
  --Where ID In (Select \*+rule *\
  --             Distinct c.Id
  --             From 病人医嘱记录 A, 病人医嘱发送 B, 药品收发记录 C, 住院费用记录 D, Table(f_Num2list(医嘱id_In)) F
  --             Where a.Id = b.医嘱id And c.费用id = d.Id And a.Id = d.医嘱序号 And b.No = c.No And b.执行部门id + 0 = 部门id_In And
  --                   c.单据 = 9 And c.审核日期 Is Null And a.相关id = f.Column_Value And b.发送号 = 发送号_In And c.序号 < 10000);

  For v_医嘱记录 In c_医嘱记录 Loop
    v_Continue := 1;
    n_病人id   := v_医嘱记录.病人id;
    n_科室id   := v_医嘱记录.病人科室id;
  
    Select Count(1)
    Into v_Continue
    From 病人医嘱记录 A, 输液不配置药品 B, 住院费用记录 C
    Where c.收费细目id = b.药品id And c.医嘱序号 = a.Id And a.相关id = v_医嘱记录.相关id;
    If v_Continue = 0 Then
      v_Continue := 1;
    Else
      v_Continue := 0;
    End If;
  
    --参数控制产生输液单
    If (v_医嘱类型 = 1 And v_医嘱记录.医嘱类型 <> 1) Or (v_医嘱类型 = 2 And v_医嘱记录.医嘱类型 <> 2) Then
      v_Continue := 0;
    End If;
  
    If Not v_大输液给药途径 Is Null Then
      If Instr(',' || v_大输液给药途径 || ',', ',' || v_医嘱记录.给药途径 || ',') = 0 Then
        v_Continue := 0;
      End If;
    End If;
  
    If Not v_来源科室 Is Null Then
      If Instr(',' || v_来源科室 || ',', ',' || v_医嘱记录.病人科室id || ',') = 0 Then
        v_Continue := 0;
      End If;
    End If;
  
    v_药品类型 := Null;
    For r_药品类型 In (Select Decode(Nvl(d.抗生素, 0), 0, Decode(Nvl(d.是否肿瘤药, 0), 0, '', '肿瘤药'), '抗生素') 药品类型
                   From 病人医嘱记录 A, 药品规格 B, 住院费用记录 C, 药品特性 D
                   Where c.收费细目id = b.药品id And b.药名id = d.药名id And c.医嘱序号 = a.Id And a.相关id = v_医嘱记录.相关id) Loop
      If r_药品类型.药品类型 Is Not Null Then
        v_药品类型 := r_药品类型.药品类型;
        v_Continue := 1;
      End If;
    End Loop;
  
    If v_药品类型 Is Null Then
      If v_医嘱记录.是否tpn = 2 Then
        v_药品类型 := '营养药';
        v_Continue := 1;
      End If;
    End If;
  
    If v_Continue = 1 Then
      v_Old相关id := v_New相关id;
      v_相关id    := v_医嘱记录.相关id;
      v_New相关id := v_相关id;
      v_发送号    := v_医嘱记录.发送号;
      v_序号      := 0;
    
      If v_Continue = 1 Then
        --v_Count := Zl_Gettransexenumber(v_医嘱记录.开始执行时间, v_医嘱记录.首次时间, v_医嘱记录.末次时间, v_医嘱记录.频率间隔, v_医嘱记录.间隔单位, v_医嘱记录.执行时间方案);
        Select Count(医嘱id)
        Into v_Count
        From 医嘱执行时间
        Where 医嘱id = v_医嘱记录.相关id And 发送号 = v_医嘱记录.发送号;
      
        v_Nodosage := 0;
      
        For I In 1 .. v_Count Loop
          Select 输液配药记录_Id.Nextval Into v_配药id From Dual;
          v_序号 := v_序号 + 1;
        
          If I > 1 Then
            --从医嘱执行时间表中取医嘱的执行时间
            Select 要求时间
            Into v_执行时间
            From 医嘱执行时间
            Where 医嘱id = v_医嘱记录.相关id And 发送号 = v_医嘱记录.发送号 And 要求时间 > v_执行时间 And Rownum = 1
            Order By 要求时间;
          Else
            Select Min(要求时间)
            Into v_执行时间
            From 医嘱执行时间
            Where 医嘱id = v_医嘱记录.相关id And 发送号 = v_医嘱记录.发送号 And Rownum = 1
            Order By 要求时间;
          End If;
        
          v_批次 := 0;
        
          If d_Old执行时间 <> Trunc(v_执行时间) Or d_Old执行时间 Is Null Then
            b_Change := True;
          End If;
        
          If b_Change = True Then
            If d_Old执行时间 <> Trunc(v_执行时间) Or d_Old执行时间 Is Null Then
              d_Old执行时间 := v_执行时间;
            
              Select Count(Distinct a.摆药单号)
              Into n_摆药单
              From 输液配药记录 A
              Where a.医嘱id In (Select ID From 病人医嘱记录 Where 病人id = v_医嘱记录.病人id And 相关id Is Null) And
                    a.执行时间 Between Trunc(v_执行时间 - 1) And Trunc(v_执行时间) - 1 / 24 / 60 / 60 And 操作状态 >= 2 And 操作状态 < 9;
            
              If n_摆药单 > 1 Then
                Update 输液配药记录
                Set 是否调整批次 = 1
                Where 医嘱id In (Select ID From 病人医嘱记录 Where 病人id = n_病人id) And
                     
                      执行时间 Between Trunc(v_执行时间) And Trunc(v_执行时间 + 1) - 1 / 24 / 60 / 60 And 操作状态 < 2;
                b_Change := False;
              
              End If;
            End If;
          End If;
        
          If b_Change = True Then
            n_病人id := v_医嘱记录.病人id;
            Select Count(ID)
            
            Into n_Sum
            From 输液配药记录
            Where 医嘱id = v_医嘱记录.相关id And 执行时间 Between Trunc(v_执行时间 - 1) And Trunc(v_执行时间) - 1 / 24 / 60 / 60;
            If n_Sum = 0 Then
              Update 输液配药记录
              Set 是否调整批次 = 1
              Where 医嘱id In (Select ID From 病人医嘱记录 Where 病人id = n_病人id) And
                   
                    执行时间 Between Trunc(v_执行时间) And Trunc(v_执行时间 + 1) - 1 / 24 / 60 / 60 And 操作状态 < 2;
              b_Change := False;
            
            End If;
          
            If b_Change = True Then
              --检查输液单是否调整到打包状态
              Select Count(a.Id)
              Into n_Sum
              From 输液配药记录 A, 输液配药内容 B, 药品收发记录 C
              Where a.Id = b.记录id And b.收发id = c.Id And
                    a.医嘱id In (Select ID
                               From 病人医嘱记录
                               Where 病人id = (Select 病人id From 病人医嘱记录 Where ID = v_医嘱记录.相关id And Rownum < 2)) And
                    a.执行时间 Between Trunc(v_执行时间 - 1) And Trunc(v_执行时间) - 1 / 24 / 60 / 60 And a.打包时间 Is Not Null;
              If n_Sum <> 0 Then
                Update 输液配药记录
                Set 是否调整批次 = 1
                Where 医嘱id In (Select ID From 病人医嘱记录 Where 病人id = n_病人id) And 执行时间 Between Trunc(v_执行时间) And
                      Trunc(v_执行时间 + 1) - 1 / 24 / 60 / 60 And 操作状态 < 2;
                b_Change := False;
              End If;
            
              Select Count(医嘱id)
              Into n_Cur
              From 医嘱执行时间
              Where 医嘱id = v_医嘱记录.相关id And 要求时间 Between Trunc(v_执行时间) And Trunc(v_执行时间 + 1) - 1 / 24 / 60 / 60;
            
              Select Count(医嘱id)
              Into n_Sum
              From 医嘱执行时间
              Where 医嘱id = v_医嘱记录.相关id And 要求时间 Between Trunc(v_执行时间 - 1) And Trunc(v_执行时间) - 1 / 24 / 60 / 60;
            
              If n_Sum <> n_Cur Then
                Update 输液配药记录
                Set 是否调整批次 = 1
                Where 医嘱id In (Select ID From 病人医嘱记录 Where 病人id = n_病人id) And 执行时间 Between Trunc(v_执行时间) And
                      Trunc(v_执行时间 + 1) - 1 / 24 / 60 / 60 And 操作状态 < 2;
                b_Change := False;
              End If;
            End If;
          End If;
        
          If v_时间串 <> Trunc(Sysdate) || ';false\' Or v_时间串 Is Null Then
            If Trunc(v_执行时间) = Trunc(Sysdate) Then
              If b_Change = False Then
                v_时间串 := Trunc(v_执行时间) || ';false\';
              Else
                v_时间串 := Trunc(v_执行时间) || ';true\';
              End If;
            End If;
          End If;
        
          If v_时间串1 <> Trunc(Sysdate + 1) || ';false\' Or v_时间串1 Is Null Then
            If Trunc(v_执行时间) = Trunc(Sysdate + 1) Then
              If b_Change = False Then
                v_时间串1 := Trunc(v_执行时间) || ';false\';
              Else
                v_时间串1 := Trunc(v_执行时间) || ';true\';
              End If;
            End If;
          End If;
        
          If v_药品类型 Is Null Or n_特殊药品批次 = 0 Then
            v_批次 := Zl_Getpivaworkbatch(v_执行时间, Sysdate);
          Else
            --药品类型不为空，直接根据药品类型匹配批次
            v_批次 := Zl_Getpivaworkbatch(v_执行时间, Sysdate, v_药品类型);
          End If;
        
          Select Count(医嘱id)
          Into n_发送次数
          From 医嘱执行时间
          Where 医嘱id = v_医嘱记录.相关id And 要求时间 <= v_执行时间
          Order By 要求时间;
        
          If n_发送次数 > 99 Then
            n_发送次数 := Mod(n_发送次数, 99);
          End If;
        
          If Length(v_医嘱记录.相关id) > 9 Then
            If n_发送次数 < 10 Then
              Select '91' || Substr(To_Char(v_医嘱记录.相关id), Length(v_医嘱记录.相关id) - 8) || To_Char(v_医嘱记录.相关id) || '0' ||
                      To_Char(n_发送次数)
              Into v_Maxno
              From Dual;
            Else
              Select '91' || Substr(To_Char(v_医嘱记录.相关id), Length(v_医嘱记录.相关id) - 8) || To_Char(v_医嘱记录.相关id) ||
                      To_Char(n_发送次数)
              Into v_Maxno
              From Dual;
            End If;
          Else
            If n_发送次数 < 10 Then
              Select '91' || Substr('000000000', Length(v_医嘱记录.相关id) + 1) || To_Char(v_医嘱记录.相关id) || '0' ||
                      To_Char(n_发送次数)
              Into v_Maxno
              From Dual;
            Else
              Select '91' || Substr('000000000', Length(v_医嘱记录.相关id) + 1) || To_Char(v_医嘱记录.相关id) || To_Char(n_发送次数)
              Into v_Maxno
              From Dual;
            End If;
          End If;
          n_调整批次 := 0;
          If b_Change = False Then
            n_调整批次 := 1;
          End If;
        
          If v_批次 <> 0 Then
            Select Nvl(Max(打包), 0), Max(药品类型)
            Into n_打包, v_配药类型
            From 配药工作批次
            Where 批次 = v_批次 And 配置中心id = 部门id_In;
          End If;
        
          If (Trunc(v_执行时间) <= v_Currdate Or n_打包 <> 0) And v_配药类型 Is Null Then
            n_是否打包     := 1;
            d_手工打包时间 := Null;
          Else
            n_是否打包     := 0;
            d_手工打包时间 := Null;
          End If;
        
          --如果是TPN不管其他条件如何都设置为配置
          If v_医嘱记录.是否tpn = 2 Then
            n_是否打包     := 0;
            d_手工打包时间 := Null;
          End If;
        
          If v_批次 = 0 Then
            n_是否打包 := 1;
          End If;
          --产生配药记录
          Insert Into 输液配药记录
            (ID, 部门id, 序号, 姓名, 性别, 年龄, 住院号, 床号, 病人病区id, 病人科室id, 执行时间, 医嘱id, 发送号, 配药批次, 瓶签号, 是否调整批次, 是否打包, 打包时间, 操作状态,
             操作人员, 操作时间)
          Values
            (v_配药id, 部门id_In, v_序号, v_医嘱记录.姓名, v_医嘱记录.性别, v_医嘱记录.年龄, v_医嘱记录.住院号, v_医嘱记录.床号, v_医嘱记录.病人病区id,
             v_医嘱记录.病人科室id, v_执行时间, v_医嘱记录.相关id, v_医嘱记录.发送号, v_批次, v_Maxno, n_调整批次, n_是否打包, d_手工打包时间, 1, 核查人_In, 核查时间_In);
        
          Insert Into 输液配药状态 (配药id, 操作类型, 操作人员, 操作时间) Values (v_配药id, 1, 核查人_In, 核查时间_In);
        
          For v_单个医嘱记录 In c_单个医嘱记录 Loop
            n_医嘱id   := v_单个医嘱记录.医嘱id;
            n_累计数量 := 0;
            n_剩余数量 := 0;
          
            Select Sum(c.实际数量)
            Into n_Sum
            From 病人医嘱记录 A, 病人医嘱发送 B, 药品收发记录 C, 住院费用记录 D
            Where a.Id = b.医嘱id And c.费用id = d.Id And a.Id = d.医嘱序号 And b.No = c.No And b.执行部门id + 0 = 部门id_In And
                  c.单据 = 9 And c.审核日期 Is Null And a.Id = n_医嘱id And b.发送号 = v_医嘱记录.发送号 And c.序号 < 1000;
          
            --产生配药记录对应的药品记录
            For v_收发记录 In c_收发记录 Loop
              If v_收发记录.是否不予配置 = 1 Then
                v_Nodosage := 1;
              End If;
            
              Select 药品收发记录_Id.Nextval Into n_Lngid From Dual;
              n_累计数量 := n_累计数量 + v_收发记录.数量;
            
              If n_剩余数量 = 0 Then
                n_剩余数量 := n_Sum / v_Count;
              End If;
              n_单次数量 := n_Sum / v_Count;
            
              If n_累计数量 >= n_Sum / v_Count * I Then
                n_Count := n_Count + 1;
                Insert Into 药品收发记录
                  (ID, 记录状态, 单据, NO, 序号, 库房id, 供药单位id, 入出类别id, 对方部门id, 入出系数, 药品id, 批次, 产地, 批号, 生产日期, 效期, 付数, 填写数量, 实际数量,
                   成本价, 成本金额, 扣率, 零售价, 零售金额, 差价, 摘要, 填制人, 填制日期, 配药人, 配药日期, 审核人, 审核日期, 价格id, 费用id, 单量, 频次, 用法, 外观, 灭菌日期,
                   灭菌效期, 产品合格证, 发药方式, 发药窗口, 领用人, 批准文号, 汇总发药号, 注册证号, 库房货位, 商品条码, 内部条码, 核查人, 核查日期, 签到确认人, 签到时间)
                  Select n_Lngid, 记录状态, 单据, NO, n_Count + 1000, 库房id, 供药单位id, 入出类别id, 对方部门id, 入出系数, 药品id, 批次, 产地, 批号,
                         生产日期, 效期, 付数, n_剩余数量, n_剩余数量, 成本价, Round(成本价 * n_剩余数量, n_流通金额小数), 扣率, 零售价,
                         Round(零售价 * n_剩余数量, n_流通金额小数), Round(差价 * (实际数量 / n_剩余数量), n_流通金额小数), '复制', 填制人, 填制日期, 配药人,
                         配药日期, 审核人, 审核日期, 价格id, 费用id, 单量, 频次, 用法, 外观, 灭菌日期, 灭菌效期, 产品合格证, 发药方式, 发药窗口, 领用人, 批准文号, 汇总发药号,
                         注册证号, 库房货位, 商品条码, 内部条码, 核查人, 核查日期, 签到确认人, 签到时间
                  From 药品收发记录
                  Where ID = v_收发记录.收发id;
              
                Insert Into 输液配药内容 (记录id, 收发id, 数量) Values (v_配药id, n_Lngid, n_剩余数量);
              
                n_剩余数量 := 0;
                Exit;
              Elsif n_累计数量 > (n_Sum / v_Count * (I - 1)) Then
                n_Count    := n_Count + 1;
                n_填写数量 := n_累计数量 - (n_Sum / v_Count * (I - 1)) - (n_单次数量 - n_剩余数量);
                Insert Into 药品收发记录
                  (ID, 记录状态, 单据, NO, 序号, 库房id, 供药单位id, 入出类别id, 对方部门id, 入出系数, 药品id, 批次, 产地, 批号, 生产日期, 效期, 付数, 填写数量, 实际数量,
                   成本价, 成本金额, 扣率, 零售价, 零售金额, 差价, 摘要, 填制人, 填制日期, 配药人, 配药日期, 审核人, 审核日期, 价格id, 费用id, 单量, 频次, 用法, 外观, 灭菌日期,
                   灭菌效期, 产品合格证, 发药方式, 发药窗口, 领用人, 批准文号, 汇总发药号, 注册证号, 库房货位, 商品条码, 内部条码, 核查人, 核查日期, 签到确认人, 签到时间)
                  Select n_Lngid, 记录状态, 单据, NO, n_Count + 1000, 库房id, 供药单位id, 入出类别id, 对方部门id, 入出系数, 药品id, 批次, 产地, 批号,
                         生产日期, 效期, 付数, n_填写数量, n_填写数量, 成本价, Round(成本价 * n_填写数量, n_流通金额小数), 扣率, 零售价,
                         Round(零售价 * n_填写数量, n_流通金额小数), Round(差价 * (实际数量 / n_填写数量), n_流通金额小数), '复制', 填制人, 填制日期, 配药人,
                         配药日期, 审核人, 审核日期, 价格id, 费用id, 单量, 频次, 用法, 外观, 灭菌日期, 灭菌效期, 产品合格证, 发药方式, 发药窗口, 领用人, 批准文号, 汇总发药号,
                         注册证号, 库房货位, 商品条码, 内部条码, 核查人, 核查日期, 签到确认人, 签到时间
                  From 药品收发记录
                  Where ID = v_收发记录.收发id;
              
                Insert Into 输液配药内容 (记录id, 收发id, 数量) Values (v_配药id, n_Lngid, n_填写数量);
              
                n_剩余数量 := n_剩余数量 - n_填写数量;
              End If;
            End Loop;
          End Loop;
          n_优先级 := Zl_Getfirst(v_配药id, v_医嘱记录.病人科室id);
          Update 输液配药记录 Set 优先级 = n_优先级 Where ID = v_配药id;
        
        End Loop;
      
        For v_收发记录 In c_原始收发记录 Loop
          n_单据 := v_收发记录.单据;
        
          v_No := v_收发记录.No;
          Delete From 药品收发记录 Where ID = v_收发记录.收发id;
        End Loop;
      
        --单个药品或者不予配置的药品默认为0批次
        Select Count(收发id) Into n_Row From 输液配药内容 Where 记录id = v_配药id;
        If (v_Nodosage = 1 Or n_Row = 1) And n_打包药品批次 = 1 Then
          Update 输液配药记录
          Set 配药批次 = 0, 是否打包 = 1
          Where 医嘱id = v_医嘱记录.相关id And 发送号 = v_医嘱记录.发送号 And 操作状态 < 2;
        End If;
        --如果存在“不予配置”属性的药品，也设置为打包
        If v_Nodosage = 1 Then
          Update 输液配药记录
          Set 是否打包 = 1
          Where 医嘱id = v_医嘱记录.相关id And 发送号 = v_医嘱记录.发送号 And 操作状态 < 2;
        End If;
      End If;
    End If;
  End Loop;

  For v_收发记录 In (Select ID From 药品收发记录 Where 序号 < 1000 And 单据 = n_单据 And NO = v_No) Loop
    n_Count := n_Count + 1;
    Update 药品收发记录 Set 序号 = n_Count + 1000, 摘要 = '复制' Where ID = v_收发记录.Id;
  End Loop;

  Update 药品收发记录
  Set 序号 = 序号 - 1000, 摘要 = '医嘱发送'
  Where 摘要 = '复制' And 序号 > 1000 And 单据 = n_单据 And NO = v_No;

  If n_备用批次 = 1 Then
  
    Select Count(a.Id)
    Into n_Sum
    From 输液配药记录 A, 病人医嘱发送 B
    Where a.医嘱id = b.医嘱id And a.发送号 = b.发送号 And
          a.医嘱id In (Select ID From 病人医嘱记录 Where 病人id = n_病人id And 相关id Is Null) And b.发送时间 Between Trunc(Sysdate) And
          Trunc(Sysdate + 1) - 1 / 24 / 60 / 60 And a.执行时间 Between Trunc(Sysdate) And
          Trunc(Sysdate + 1) - 1 / 24 / 60 / 60 And 操作状态 < 9;
    If n_Sum <> 0 Then
      b_Change  := False;
      v_时间串1 := Trunc(Sysdate + 1) || ';false\';
    
      Update 输液配药记录
      Set 是否调整批次 = 1
      Where 医嘱id In (Select ID From 病人医嘱记录 Where 病人id = n_病人id) And 执行时间 Between Trunc(Sysdate + 1) And
            Trunc(Sysdate + 2) - 1 / 24 / 60 / 60 And 操作状态 < 2;
    End If;
  End If;
  If v_时间串 Is Null Then
    v_时间串 := v_时间串1;
  Else
    v_时间串 := v_时间串 || v_时间串1;
  End If;

  While v_时间串 Is Not Null Loop
    --分解单据ID串
    v_Fields   := Substr(v_时间串, 1, Instr(v_时间串, '\') - 1);
    v_时间值   := Substr(v_Fields, 1, Instr(v_Fields, ';') - 1);
    v_是否改变 := Substr(v_Fields, Instr(v_Fields, ';') + 1);
  
    v_时间串 := Replace('\' || v_时间串, '\' || v_Fields || '\');
  
    If v_是否改变 = 'true' Then
      b_Change := True;
    Else
      b_Change := False;
    End If;
  
    If b_Change = True Then
      Select Count(医嘱id)
      Into n_Cur
      From (Select Distinct a.要求时间, a.医嘱id
             From 医嘱执行时间 A, 输液配药记录 B
             Where a.要求时间 = b.执行时间 And a.医嘱id = b.医嘱id And a.要求时间 Between Trunc(v_时间值) And
                   Trunc(v_时间值 + 1) - 1 / 24 / 60 / 60 And
                   a.医嘱id In (Select ID From 病人医嘱记录 Where 病人id = n_病人id And 相关id Is Null));
    
      Select Count(医嘱id)
      Into n_Sum
      From (Select Distinct a.要求时间, a.医嘱id
             From 医嘱执行时间 A, 输液配药记录 B
             Where a.要求时间 = b.执行时间 And a.医嘱id = b.医嘱id And a.要求时间 Between Trunc(v_时间值 - 1) And
                   Trunc(v_时间值) - 1 / 24 / 60 / 60 And
                   a.医嘱id In (Select ID From 病人医嘱记录 Where 病人id = n_病人id And 相关id Is Null));
    
      If n_Cur <> n_Sum Then
        Update 输液配药记录
        Set 是否调整批次 = 1
        Where 医嘱id In (Select ID From 病人医嘱记录 Where 病人id = n_病人id) And 执行时间 Between Trunc(v_时间值) And
              Trunc(v_时间值 + 1) - 1 / 24 / 60 / 60 And 操作状态 < 2;
        b_Change := False;
      End If;
    End If;
  
    If v_保持上次批次 = 1 And b_Change = True Then
      For v_输液单记录 In c_输液单记录 Loop
        Select Distinct 配药批次
        Into v_批次
        From 输液配药记录 A, 输液配药内容 B, 药品收发记录 C
        Where a.Id = b.记录id And b.收发id = c.Id And a.医嘱id = v_输液单记录.医嘱id And
              To_Char(a.执行时间, 'hh24:mi:ss') = To_Char(v_输液单记录.执行时间, 'hh24:mi:ss') And
              a.执行时间 Between Trunc(v_输液单记录.执行时间 - 1) And Trunc(v_输液单记录.执行时间) - 1 / 24 / 60 / 60 And Rownum = 1;
      
        Update 输液配药记录
        Set 是否确认调整 = 0,是否调整批次 = 0
        Where 医嘱id In (Select ID From 病人医嘱记录 Where 病人id = n_病人id) And 执行时间 Between Trunc(v_输液单记录.执行时间) And
              Trunc(v_输液单记录.执行时间 + 1) - 1 / 24 / 60 / 60 And 操作状态 < 2;
      
        If v_输液单记录.配药批次 <> v_批次 Then
          Update 输液配药记录 Set 配药批次 = v_批次 Where ID = v_输液单记录.Id;
          Select Nvl(Max(打包), 0) Into n_打包 From 配药工作批次 Where 批次 = v_批次 And 配置中心id = 部门id_In;
          If n_打包 <> 0 Then
            Update 输液配药记录 Set 是否打包 = n_打包 Where ID = v_输液单记录.Id;
          Else
            Select Nvl(Max(打包), 0)
            Into n_打包
            From 配药工作批次
            Where 批次 = v_输液单记录.配药批次 And 配置中心id = 部门id_In;
          
            If n_打包 <> 0 Then
              Update 输液配药记录 Set 是否打包 = 0 Where ID = v_输液单记录.Id;
            End If;
          End If;
        End If;
      End Loop;
    End If;
  
    If n_自动排批 = 1 And (b_Change = False Or v_保持上次批次 = 0) Then
      For v_输液单记录 In c_输液单记录 Loop
        v_批次 := Zl_Getpivaworkbatch(v_输液单记录.执行时间, v_输液单记录.发送时间);
        Update 输液配药记录 Set 配药批次 = v_批次 Where ID = v_输液单记录.Id;
      End Loop;
      Zl_输液配药记录_自动排批(n_病人id, n_科室id, 部门id_In, v_时间值);
    End If;
  End Loop;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]病人' || v_当前病人 || '在输液配置中心有被锁定的输液单，发送失败！[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_输液配药记录_核查;
/

--98570:李业庆,2017-03-15,供应商为空不更新药品规格表
Create Or Replace Procedure Zl_药品其他入库_Verify
(
  No_In     In 药品收发记录.No%Type := Null,
  审核人_In In 药品收发记录.审核人%Type := Null
) Is
  Err_Isverified Exception;
  Err_Isbatch Exception;
  v_Druginf Varchar2(50); --原不分批现在分批的药品信息

  Cursor c_药品收发记录 Is
    Select a.Id, a.实际数量, a.零售金额, a.零售价, a.差价, a.库房id, a.药品id, a.批次, a.成本价, a.批号, a.效期, a.产地, a.入出类别id, a.生产日期, a.批准文号,
           a.供药单位id, Nvl(b.是否变价, 0) As 时价
    From 药品收发记录 A, 收费项目目录 B
    Where a.药品id = b.Id And a.No = No_In And a.单据 = 4 And a.记录状态 = 1
    Order By a.药品id;
Begin
  Update 药品收发记录
  Set 审核人 = 审核人_In, 审核日期 = Sysdate
  Where NO = No_In And 单据 = 4 And 记录状态 = 1 And 审核人 Is Null;

  If Sql%RowCount = 0 Then
    Raise Err_Isverified;
  End If;

  --主要针对原不分批现在分批的药品，不能对其审核
  Begin
    Select Distinct '(' || i.编码 || ')' || Nvl(n.名称, i.名称) As 药品信息
    Into v_Druginf
    From 药品收发记录 A, 药品规格 B, 收费项目目录 I, 收费项目别名 N
    Where a.药品id = b.药品id And a.药品id = i.Id And a.药品id = n.收费细目id(+) And n.性质(+) = 3 And a.No = No_In And a.单据 = 4 And
          a.记录状态 = 1 And Nvl(a.批次, 0) = 0 And
          ((Nvl(b.药库分批, 0) = 1 And
          a.库房id Not In (Select 部门id From 部门性质说明 Where (工作性质 Like '%药房') Or (工作性质 Like '制剂室'))) Or Nvl(b.药房分批, 0) = 1) And
          Rownum = 1;
  Exception
    When Others Then
      v_Druginf := '';
  End;

  If v_Druginf Is Not Null Then
    Raise Err_Isbatch;
  End If;

  --原分批现不分批的药品,在审核时，要处理他
  Update 药品收发记录
  Set 批次 = 0
  Where ID In
        (Select ID
         From 药品收发记录 A, 药品规格 B
         Where b.药品id = a.药品id And a.No = No_In And a.单据 = 4 And a.记录状态 = 1 And Nvl(a.批次, 0) > 0 And
               (Nvl(b.药库分批, 0) = 0 Or
               (Nvl(b.药房分批, 0) = 0 And
               a.库房id In (Select 部门id From 部门性质说明 Where (工作性质 Like '%药房') Or (工作性质 Like '制剂室')))));

  For v_药品收发记录 In c_药品收发记录 Loop
    --更新库存 入库审核
    Zl_药品库存_Update(v_药品收发记录.Id, 2, 0);
  
    Update 药品规格
    Set 成本价 = v_药品收发记录.成本价, 上次售价 = Decode(v_药品收发记录.时价, 1, v_药品收发记录.零售价, Null),
        上次供应商id = Decode(v_药品收发记录.供药单位id, Null, 上次供应商id, v_药品收发记录.供药单位id), 上次批号 = v_药品收发记录.批号, 上次生产日期 = v_药品收发记录.生产日期,
        上次产地 = v_药品收发记录.产地, 上次批准文号 = v_药品收发记录.批准文号
    Where 药品id = v_药品收发记录.药品id;
  End Loop;
Exception
  When Err_Isverified Then
    Raise_Application_Error(-20101, '[ZLSOFT]该单据已经被他人审核！[ZLSOFT]');
  When Err_Isbatch Then
    Raise_Application_Error(-20102, '[ZLSOFT]该单据中包含有一条原来不分批，现在分批的药品[' || v_Druginf || ']，不能审核！[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_药品其他入库_Verify;
/

--107175:李业庆,2017-03-16,卫材调价产生药品收发记录的NO方式改进
Create Or Replace Procedure Zl_材料收发记录_调价修正(收发id_In In 药品收发记录.Id%Type) Is
  v_单据         药品收发记录.单据%Type;
  v_入出类别id   药品收发记录.入出类别id%Type;
  v_售价精度     Number;
  v_金额精度     Number;
  v_收发id       药品收发记录.Id%Type;
  v_原价         药品收发记录.零售价%Type;
  v_现价         药品收发记录.零售价%Type;
  v_是否变价     收费项目目录.是否变价%Type;
  v_价格id       收费价目.Id%Type;
  v_库房id       药品收发记录.库房id%Type;
  v_药品id       药品收发记录.药品id%Type;
  v_批次         药品收发记录.批次%Type;
  v_实际数量     药品收发记录.实际数量%Type;
  v_修正金额     药品收发记录.零售金额%Type;
  v_入出系数     药品收发记录.入出系数%Type;
  v_执行修正     Number;
  v_审核日期     药品收发记录.审核日期%Type;
  v_零售金额     药品收发记录.零售金额%Type;
  v_差价         药品收发记录.差价%Type;
  v_No           药品收发记录.No%Type;
  n_平均成本价   药品库存.平均成本价%Type;
  n_费用单价精度 Number;
  d_填制日期     药品收发记录.填制日期%Type;
  d_日期         药品收发记录.填制日期%Type;
  v_Billno       药品收发记录.No%Type;
Begin

  --1、售价调剂处理
  --提取单据信息，原价，现价及药价属性
  Select a.单据, a.库房id, a.药品id, Nvl(a.批次, 0) As 批次, Nvl(a.实际数量, 0) * Nvl(a.付数, 1) As 实际数量, a.入出系数, Nvl(a.零售价, 0) 原价, b.现价,
         Nvl(c.是否变价, 0) 是否变价, b.Id As 价格id
  Into v_单据, v_库房id, v_药品id, v_批次, v_实际数量, v_入出系数, v_原价, v_现价, v_是否变价, v_价格id
  From 药品收发记录 A, 收费价目 B, 收费项目目录 C
  Where a.药品id = b.收费细目id And a.药品id = c.Id And
        (Sysdate Between b.执行日期 And b.终止日期 Or Sysdate >= b.执行日期 And b.终止日期 Is Null) And a.Id = 收发id_In;

  --获取金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(157), '5')) Into n_费用单价精度 From Dual;
  If v_单据 = 24 Or v_单据 = 25 Or v_单据 = 26 Then
    --发药应该取费用精度，其他业务应该取药品卫材精度中精度
    Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into v_金额精度 From Dual;
  Else
    Select Nvl(精度, 2) Into v_金额精度 From 药品卫材精度 Where 性质 = 0 And 类别 = 2 And 内容 = 4 And 单位 = 5;
  End If;
  --定价直接取收费价目中现价
  v_执行修正 := 0;
  If v_是否变价 = 0 Then
    v_执行修正 := 1;
  Else
    --时价药品的现售价，不能从收费价目中取，因为时价调价可能是按库房和批次来调整的
    v_现价 := 0;
  
    If v_批次 > 0 Then
      --时价分批优先从库存表中取，时价不分批则直接在明细表中查调价记录的零售价
      --从库存记录中取现价
      Begin
        Select Nvl(零售价, 0)
        Into v_现价
        From 药品库存
        Where 性质 = 1 And 库房id + 0 = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = v_批次;
      Exception
        When Others Then
          v_现价 := 0;
      End;
    End If;
  
    If v_现价 = 0 Then
      Begin
        --取原始单据的审核时间
        Select a.审核日期, a.填制日期
        Into v_审核日期, d_填制日期
        From 药品收发记录 A, 药品收发记录 B
        Where b.Id = 收发id_In And a.单据 = b.单据 And a.No = b.No And a.库房id = b.库房id And a.药品id + 0 = b.药品id And
              a.序号 = b.序号 And (a.记录状态 = 1 Or Mod(a.记录状态, 3) = 0);
        If v_单据 = 24 Or v_单据 = 25 Or v_单据 = 26 Then
          d_日期 := d_填制日期;
        Else
          d_日期 := v_审核日期;
        End If;
      
        If Months_Between(Sysdate, d_日期) <= 1 Then
          --只处理小于一个月的数据
          --从调价记录中取现零售价
          Select 零售价, 价格id
          Into v_现价, v_价格id
          From (Select 零售价, 价格id
                 From 药品收发记录
                 Where 单据 = 13 And 摘要 = '卫材调价' And 库房id + 0 = v_库房id And 药品id + 0 = v_药品id And Nvl(批次, 0) = v_批次 And
                       审核日期 Between d_日期 And Sysdate
                 Order By 审核日期 Desc)
          Where Rownum = 1;
        End If;
      Exception
        When Others Then
          v_现价 := 0;
      End;
    End If;
  
    If v_现价 > 0 Then
      v_执行修正 := 1;
    End If;
  End If;

  If v_执行修正 = 1 Then
    --发药类单据售价精度为5，其他流通类单据为7
    If v_单据 = 24 Or v_单据 = 25 Or v_单据 = 26 Then
      v_售价精度 := n_费用单价精度;
    Else
      v_售价精度 := 7;
    End If;
  
    --比较原价和现价，不同则处理
    If v_原价 <> Round(v_现价, v_售价精度) Then
      Select 药品收发记录_Id.Nextval Into v_收发id From Dual;
      Select Nextno(147) Into v_Billno From Dual;
    
      Select 类别id Into v_入出类别id From 药品单据性质 Where 单据 = 38;
    
      v_修正金额 := Round(v_入出系数 * (Round(v_现价, v_售价精度) - v_原价) * v_实际数量, v_金额精度);
    
      --产生调价修正记录
      Insert Into 药品收发记录
        (ID, 记录状态, 单据, NO, 序号, 入出类别id, 药品id, 批次, 批号, 效期, 产地, 付数, 填写数量, 实际数量, 成本价, 成本金额, 零售价, 扣率, 零售金额, 差价, 摘要, 填制人,
         填制日期, 库房id, 入出系数, 价格id, 审核人, 审核日期, 费用id)
        Select v_收发id, 1, 13, v_Billno, 序号, v_入出类别id, 药品id, 批次, 批号, 效期, 产地, 付数, Abs(v_实际数量), 0, v_原价, 0,
               Round(v_现价, v_售价精度), 扣率, v_修正金额, v_修正金额, '自动修正调价变动', 审核人, 审核日期, 库房id, 1, v_价格id, 审核人, 审核日期, 收发id_In
        From 药品收发记录
        Where ID = 收发id_In;
    
      --更新药品库存
      Update 药品库存
      Set 实际金额 = Nvl(实际金额, 0) + v_修正金额, 实际差价 = Nvl(实际差价, 0) + v_修正金额
      Where 性质 = 1 And 库房id = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = Nvl(v_批次, 0);
    
      --重新计算库存表中的平均成本价
      Update 药品库存
      Set 平均成本价 = Decode(Nvl(批次, 0), 0, Decode((实际金额 - 实际差价) / 实际数量, 0, 上次采购价, (实际金额 - 实际差价) / 实际数量), 上次采购价)
      Where 性质 = 1 And 库房id = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = v_批次 And Nvl(实际数量, 0) <> 0;
      If Sql%NotFound Then
        Select 成本价 Into n_平均成本价 From 材料特性 Where 材料id = v_药品id;
        Update 药品库存
        Set 平均成本价 = n_平均成本价
        Where 性质 = 1 And 库房id = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = v_批次;
      End If;
    
      --删除数量、金额、差价为零的情况
      Delete 药品库存
      Where 库房id = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = Nvl(v_批次, 0) And 性质 = 1 And Nvl(可用数量, 0) = 0 And
            Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
    
    End If;
  End If;

  --2、成本价调价
  Select 库房id, 药品id, Nvl(批次, 0) 批次, 入出系数 * 实际数量, 入出系数 * 零售金额, 入出系数 * 差价, 成本价
  Into v_库房id, v_药品id, v_批次, v_实际数量, v_零售金额, v_差价, v_原价
  From 药品收发记录
  Where ID = 收发id_In;

  --取原始单据的审核时间
  Select a.审核日期
  Into v_审核日期
  From 药品收发记录 A, 药品收发记录 B
  Where b.Id = 收发id_In And a.单据 = b.单据 And a.No = b.No And a.库房id = b.库房id And a.药品id + 0 = b.药品id And a.序号 = b.序号 And
        (a.记录状态 = 1 Or Mod(a.记录状态, 3) = 0);

  v_执行修正 := 0;
  Begin
    Select 1, 新成本价
    Into v_执行修正, v_现价
    From 成本价调价信息
    Where 库房id + 0 = v_库房id And 药品id + 0 = v_药品id And Nvl(批次, 0) = v_批次 And 执行日期 > v_审核日期 And Rownum = 1
    Order By 执行日期 Desc;
  
  Exception
    When Others Then
      v_执行修正 := 0;
      v_现价     := 0;
    
  End;

  If v_执行修正 = 1 Then
    v_修正金额 := (v_零售金额 - v_差价) - Round(v_现价 * v_实际数量, v_金额精度);
  
    If v_修正金额 <> 0 Then
      Select 药品收发记录_Id.Nextval Into v_收发id From Dual;
      Select b.Id, b.系数
      Into v_入出类别id, v_入出系数
      From 药品单据性质 A, 药品入出类别 B
      Where a.类别id = b.Id And a.单据 = 33 And Rownum < 2;
    
      v_No := Nextno(71, v_库房id);
    
      --产生库存差价调整单
      Insert Into 药品收发记录
        (ID, 记录状态, 单据, NO, 序号, 库房id, 入出类别id, 供药单位id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 填写数量, 零售价, 成本价, 差价, 摘要, 填制人, 填制日期, 审核人,
         审核日期, 生产日期, 批准文号, 单量, 发药方式, 扣率, 灭菌效期, 费用id)
        Select v_收发id, 1, 18, v_No, 1, 库房id, v_入出类别id, 供药单位id, v_入出系数, 药品id, 批次, 产地, 批号, 效期, v_实际数量, v_零售金额, v_差价,
               v_修正金额, '自动修正调价变动', 审核人, 审核日期, 审核人, 审核日期, 生产日期, 批准文号, v_现价, 1, 成本价, 灭菌效期, 收发id_In
        From 药品收发记录
        Where ID = 收发id_In;
    
      --更新库存
      Update 药品库存
      Set 实际差价 = Nvl(实际差价, 0) + v_修正金额, 上次采购价 = v_现价
      Where 库房id = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = v_批次 And 性质 = 1;
    End If;
  End If;
  --重新计算库存表中的平均成本价
  Update 药品库存
  Set 平均成本价 = Decode(Nvl(批次, 0), 0, Decode((实际金额 - 实际差价) / 实际数量, 0, 上次采购价, (实际金额 - 实际差价) / 实际数量), 上次采购价)
  Where 性质 = 1 And 库房id = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = v_批次 And Nvl(实际数量, 0) <> 0;
  If Sql%NotFound Then
    Select 成本价 Into n_平均成本价 From 材料特性 Where 材料id = v_药品id;
    Update 药品库存
    Set 平均成本价 = n_平均成本价
    Where 性质 = 1 And 库房id = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = v_批次;
  End If;

  --删除数量、金额、差价为零的情况
  Delete 药品库存
  Where 库房id = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = Nvl(v_批次, 0) And 性质 = 1 And Nvl(可用数量, 0) = 0 And
        Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_材料收发记录_调价修正;
/

--107215:李业庆,2017-03-17,药品库存表零售价字段取值空值处理
--106107:李业庆,2017-05-03,冲销无库存时成本价调价判断
Create Or Replace Procedure Zl_药品收发记录_调价修正(收发id_In In 药品收发记录.Id%Type) Is
  v_单据         药品收发记录.单据%Type;
  v_入出类别id   药品收发记录.入出类别id%Type;
  v_售价精度     Number;
  v_金额精度     Number;
  v_收发id       药品收发记录.Id%Type;
  v_原价         药品收发记录.零售价%Type;
  v_现价         药品收发记录.零售价%Type;
  v_是否变价     收费项目目录.是否变价%Type;
  v_价格id       收费价目.Id%Type;
  v_库房id       药品收发记录.库房id%Type;
  v_药品id       药品收发记录.药品id%Type;
  v_批次         药品收发记录.批次%Type;
  v_实际数量     药品收发记录.实际数量%Type;
  v_修正金额     药品收发记录.零售金额%Type;
  v_入出系数     药品收发记录.入出系数%Type;
  v_执行修正     Number;
  v_填制日期     药品收发记录.填制日期%Type;
  v_审核日期     药品收发记录.审核日期%Type;
  d_调价时间     收费价目.执行日期%Type;
  v_零售金额     药品收发记录.零售金额%Type;
  v_差价         药品收发记录.差价%Type;
  v_No           药品收发记录.No%Type;
  n_记录状态     药品收发记录.记录状态%Type;
  n_当前数量     药品库存.实际数量%Type;
  n_是否门诊记录 Number;
  n_价目表售价   药品收发记录.零售价%Type;
Begin
  ----售价：
  --定价和时价分批：判断在此期间有无主动调价，有则修正，无则不修正
  --时价不分批：直接比较价格
  --要修正时：判断当前价格与冲销价格是否不同，不同则处理否则不处理
  --          时价无库存不修正，因为取不出价格

  ----成本价：
  --有调价记录则修正，无调价检查库存与冲销价格是否不同，不同则修正，否则不修正

  --取原始单据的审核时间
  Select a.审核日期, a.填制日期
  Into v_审核日期, v_填制日期
  From 药品收发记录 A, 药品收发记录 B
  Where b.Id = 收发id_In And a.单据 = b.单据 And a.No = b.No And a.库房id = b.库房id And a.药品id + 0 = b.药品id And a.序号 = b.序号 And
        (a.记录状态 = 1 Or Mod(a.记录状态, 3) = 0);

  --1、售价调价处理
  --提取单据信息，原价，现价及药价属性
  Select a.单据, a.记录状态, a.库房id, a.药品id, Nvl(a.批次, 0) As 批次, a.入出系数 * Nvl(a.实际数量, 0) * Nvl(a.付数, 1) As 实际数量,
         Nvl(a.零售价, 0) 原价, b.现价, Nvl(c.是否变价, 0) 是否变价, b.Id As 价格id, b.执行日期
  Into v_单据, n_记录状态, v_库房id, v_药品id, v_批次, v_实际数量, v_原价, v_现价, v_是否变价, v_价格id, d_调价时间
  From 药品收发记录 A, 收费价目 B, 收费项目目录 C
  Where a.药品id = b.收费细目id And a.药品id = c.Id And
        (Sysdate Between b.执行日期 And b.终止日期 Or Sysdate >= b.执行日期 And b.终止日期 Is Null) And a.Id = 收发id_In;

  v_执行修正 := 0;
  If v_是否变价 = 0 Then
    --定价，单据原始时间在最新调价时间后，需要执行调价修正
    If v_单据 = 8 Or v_单据 = 9 Or v_单据 = 10 Then
      --发药单看填制日期
      If v_填制日期 < d_调价时间 Then
        v_执行修正 := 1;
      End If;
    Elsif v_审核日期 < d_调价时间 Then
      --其他流通单据看审核时间
      v_执行修正 := 1;
    End If;
  Else
    --时价主要比较新老价格，这里不判断
    v_执行修正 := 1;
  End If;

  If v_执行修正 = 1 Then
    If v_是否变价 = 1 Then
      --时价从库存记录中取现价
      Begin
        Select Decode(Nvl(零售价, 0), 0, Decode(Nvl(实际数量, 0), 0, 0, 实际金额 / 实际数量), 零售价)
        Into v_现价
        From 药品库存
        Where 性质 = 1 And 库房id + 0 = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = v_批次;
      Exception
        When Others Then
          --时价如果无库存则不进行修正
          v_现价     := 0;
          v_执行修正 := 0;
      End;
    
      If v_现价 = 0 Then
        v_执行修正 := 0;
      End If;
    End If;
  
    If v_执行修正 = 1 Then
      Select 精度 Into v_金额精度 From 药品卫材精度 Where 类别 = 1 And 内容 = 4 And 单位 = 5 And 性质 = 0;
    
      --比较原价和现价，不同则处理
      If Round(v_原价, 4) <> Round(v_现价, 4) Then
        v_修正金额 := Round(v_现价 * v_实际数量, v_金额精度) - Round(v_原价 * v_实际数量, v_金额精度);
      
        If v_修正金额 <> 0 Then
          Select 药品收发记录_Id.Nextval Into v_收发id From Dual;
          Select Nextno(147) Into v_No From Dual;
        
          Select 类别id Into v_入出类别id From 药品单据性质 Where 单据 = 13;
        
          --产生调价修正记录
          Insert Into 药品收发记录
            (ID, 记录状态, 单据, NO, 序号, 入出类别id, 药品id, 批次, 批号, 效期, 产地, 付数, 填写数量, 实际数量, 成本价, 成本金额, 零售价, 扣率, 零售金额, 差价, 摘要, 填制人,
             填制日期, 库房id, 入出系数, 价格id, 审核人, 审核日期, 费用id)
            Select v_收发id, 1, 13, v_No, 序号, v_入出类别id, 药品id, 批次, 批号, 效期, 产地, 付数, v_实际数量, 0, v_原价, 0, v_现价, 扣率, v_修正金额,
                   v_修正金额, '自动修正调价变动', 审核人, 审核日期, 库房id, 1, v_价格id, 审核人, 审核日期, 收发id_In
            From 药品收发记录
            Where ID = 收发id_In;
        
          --更新药品库存
          Zl_药品库存_Update(v_收发id, 2, 0);
        End If;
      End If;
    End If;
  End If;

  --2、成本价调价，发药单退药再发和冲销业务才修正
  v_执行修正 := 0;
  If (v_单据 In (8, 9, 10) And Mod(n_记录状态, 3) = 1 And n_记录状态 <> 1) Or Mod(n_记录状态, 3) = 2 Then
    Select 库房id, 药品id, Nvl(批次, 0) 批次, 入出系数 * Nvl(实际数量, 0) * Nvl(付数, 1) As 实际数量, 入出系数 * 零售金额, 入出系数 * 差价,
           Decode(单据, 12, 单量, 成本价) As 原价
    Into v_库房id, v_药品id, v_批次, v_实际数量, v_零售金额, v_差价, v_原价
    From 药品收发记录
    Where ID = 收发id_In;
  
    --冲销时取当前库存成本价
    Begin
      Select 1, 平均成本价, Nvl(实际数量, 0) As 实际数量
      Into v_执行修正, v_现价, n_当前数量
      From 药品库存
      Where 库房id = v_库房id And 药品id = v_药品id And Nvl(批次, 0) = v_批次 And 性质 = 1;
    Exception
      When Others Then
        v_现价     := 0;
        v_执行修正 := 0;
    End;
  
    --无库存判断
    If v_实际数量 = n_当前数量 Then
      --表示冲销或退药回去前无库存
      Begin
        Select 现价
        Into v_现价
        From (Select 新成本价 As 现价
               From 成本价调价信息
               Where 库房id = v_库房id And 药品id = v_药品id And 批次 = v_批次 And 执行日期 > v_审核日期
               Order By 执行日期 Desc)
        Where Rownum < 2;
      Exception
        When Others Then
          v_现价     := 0;
          v_执行修正 := 0;
      End;
    End If;
  
    If v_执行修正 = 1 And Round(v_现价, 4) <> Round(v_原价, 4) Then
      Select 精度 Into v_金额精度 From 药品卫材精度 Where 类别 = 1 And 内容 = 4 And 单位 = 5 And 性质 = 0;
    
      v_修正金额 := Round(v_原价 * v_实际数量, v_金额精度) - Round(v_现价 * v_实际数量, v_金额精度);
    
      If v_修正金额 <> 0 Then
        Select 药品收发记录_Id.Nextval Into v_收发id From Dual;
        Select b.Id, b.系数
        Into v_入出类别id, v_入出系数
        From 药品单据性质 A, 药品入出类别 B
        Where a.类别id = b.Id And a.单据 = 5 And Rownum < 2;
      
        v_No := Nextno(25, v_库房id);
      
        --产生库存差价调整单
        Insert Into 药品收发记录
          (ID, 记录状态, 单据, NO, 序号, 库房id, 入出类别id, 供药单位id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 填写数量, 零售价, 成本价, 差价, 摘要, 填制人, 填制日期,
           审核人, 审核日期, 生产日期, 批准文号, 单量, 发药方式, 扣率, 灭菌效期, 费用id)
          Select v_收发id, 1, 5, v_No, 1, 库房id, v_入出类别id, 供药单位id, v_入出系数, 药品id, 批次, 产地, 批号, 效期, v_实际数量, v_零售金额, v_差价,
                 v_修正金额, '自动修正调价变动', 审核人, 审核日期, 审核人, 审核日期, 生产日期, 批准文号, v_现价, 1, 成本价, 灭菌效期, 收发id_In
          From 药品收发记录
          Where ID = 收发id_In;
      
        --更新库存
        Zl_药品库存_Update(v_收发id, 2, 0);
      
      End If;
    End If;
  End If;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_药品收发记录_调价修正;
/

--103022:李业庆,2017-3-22,供应商照片
Create Or Replace Procedure Zl_供应商照片_Delete
(
  供应商id_In In 供应商照片.供应商id%Type,
  删除类型_In In Number
) Is
Begin
  If 删除类型_In = 0 Then
    Update 供应商照片 Set 许可证号照片 = Empty_Blob() Where 供应商id = 供应商id_In;
  Elsif 删除类型_In = 1 Then
    Update 供应商照片 Set 执照号照片 = Empty_Blob() Where 供应商id = 供应商id_In;
  Elsif 删除类型_In = 2 Then
    Update 供应商照片 Set 授权号照片 = Empty_Blob() Where 供应商id = 供应商id_In;
  End If;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
  
End Zl_供应商照片_Delete;
/


--106632:李业庆,2017-04-19,操作类型修改，适应申请和审核冲销业务
Create Or Replace Procedure Zl_药品库存_Update
(
  Id_In       In 药品收发记录.Id%Type,
  业务类型_In In Number := 0,
  入出类型_In In Number := 0,
  操作类型_In In Number := 0
) Is
  --功能：
  --      根据业务类型处理库存表，处理业务药品所有业务和卫材发料业务，卫材内部流通业务不处理
  --id_in  需要处理收发记录单
  --业务类型_in  业务类型，0-新增、1-删除、2-审核、3-冲销
  --入出类型_in  0-入库，1-出库
  --操作类型：根据业务情况确定
  ----外购入库中，表示财务审核：  0-不是财务审核，1-财务审核，目前只有外购入库有财务审核
  ----申领，移库中冲销流程：0-正常冲销流程，1-申请，审核冲销流程

  n_可用数量 药品库存.实际数量%Type;
  n_实际数量 药品库存.实际数量%Type;
  n_零售金额 药品库存.实际金额%Type;
  n_差价     药品库存.实际差价%Type;
  n_时价     Number(1);
  n_成本价   药品收发记录.成本价%Type;
  n_零售价   药品库存.零售价%Type;

  n_库存数量   药品库存.实际数量%Type;
  n_库存平均价 药品库存.平均成本价%Type;
  n_库存售价   药品库存.零售价%Type;
  n_总数量     药品收发记录.实际数量%Type;
  n_总成本价   药品收发记录.成本价%Type;
  n_总售价     药品收发记录.零售价%Type;
  n_库房分批   药品规格.药库分批%Type;
  n_申请冲销   Number(1);
  n_更新库存   Number(1) := 0;
  v_现价       药品收发记录.零售价%Type;
  v_执行新价格 Number(1) := 0;
  n_有库存     Number(1) := 0;
  v_审核日期   药品收发记录.审核日期%Type;
  --业务明细数据，把库存数据更新需要的数据都列出来
  Cursor c_Detail Is
    Select a.Id, a.记录状态, a.单据, a.No, a.序号, a.库房id, a.供药单位id, a.入出类别id, a.对方部门id, a.入出系数, Nvl(a.发药方式, 0) As 发药方式, a.药品id,
           Nvl(a.批次, 0) 批次, a.产地, a.批号, a.生产日期, a.效期, a.付数, Nvl(a.填写数量, 0) As 填写数量, a.实际数量, a.成本价, a.成本金额, a.扣率, a.零售价,
           Nvl(a.零售金额, 0) As 零售金额, Nvl(a.差价, 0) As 差价, a.配药人, a.配药日期, a.审核人, a.审核日期, a.灭菌日期, a.灭菌效期, a.批准文号, a.商品条码,
           a.内部条码, b.是否变价, a.单量, a.频次, a.摘要, Nvl(a.费用id, 0) As 费用id
    From 药品收发记录 A, 收费项目目录 B
    Where a.药品id = b.Id And a.Id = Id_In;

  r_Detail c_Detail%RowType;
Begin
  For r_Detail In c_Detail Loop
    n_实际数量 := r_Detail.入出系数 * r_Detail.实际数量 * Nvl(r_Detail.付数, 1);
    If n_实际数量 Is Null Then
      n_实际数量 := 0;
    End If;
    n_可用数量 := 0;
    n_零售价   := r_Detail.零售价;
    If r_Detail.单据 = 12 Then
      n_成本价 := r_Detail.单量;
    Else
      n_成本价 := r_Detail.成本价;
    End If;
    n_零售金额 := r_Detail.入出系数 * r_Detail.零售金额;
    n_差价     := r_Detail.入出系数 * r_Detail.差价;
  
    --先取库存和单据的数量和成本价
    Begin
      Select Nvl(实际数量, 0), Nvl(平均成本价, 0), Decode(Nvl(零售价, 0), 0, Decode(Nvl(实际数量, 0), 0, n_零售价, 实际金额 / 实际数量), 零售价)
      Into n_库存数量, n_库存平均价, n_库存售价
      From 药品库存
      Where 性质 = 1 And 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次;
    Exception
      When Others Then
        n_库存数量   := 0;
        n_库存平均价 := 0;
        n_库存售价   := 0;
    End;
  
    --时价药品都需要更新库存表零售价字段
    If r_Detail.是否变价 = 1 Then
      n_时价 := 1;
    Else
      n_时价 := 0;
    End If;
  
    --特殊业务处理库存
    --包含业务--5-差价调整；13-调价变动
    --单据5，13都是业务类型_in，2-审核、入出类型_in  0-入库
    If r_Detail.单据 = 5 Or r_Detail.单据 = 13 Then
      --这种类型的单据收发记录成本价字段不是保存的真正成本价而是存储的其他数据
      If r_Detail.单据 = 5 Then
        If r_Detail.填写数量 <> 0 Then
          n_零售价 := Nvl(r_Detail.零售价, 0) / r_Detail.填写数量;
        Else
          n_零售价 := 0;
        End If;
        --审核
        If r_Detail.记录状态 = 1 Then
          --差价调整发药方式=0；主动调价、退货、发药产生的调价修正发药方式=1
          n_成本价 := r_Detail.单量;
        Else
          --冲销 还原原始成本价
          Begin
            --成本价=(金额-差价)/数量
            n_成本价 := (Nvl(r_Detail.零售价, 0) - Nvl(r_Detail.成本价, 0)) / r_Detail.填写数量;
          Exception
            When Others Then
              Select 成本价 Into n_成本价 From 药品规格 Where 药品id = r_Detail.药品id;
          End;
        End If;
      Else
        n_成本价 := Nvl(r_Detail.单量, 0) - Nvl(r_Detail.频次, 0);
      End If;
    
      If r_Detail.单据 = 5 Then
        --单据=5 的成本价修正记录 平均成本价不需要重算，因为保存了最新价格的
        If r_Detail.摘要 = '外购退库差价误差自动修正' Or r_Detail.摘要 = '财务审核价格变动修正' Then
          --这一步肯定是外购退库，外购退库只更新成本价,且肯定有库存
          Update 药品库存
          Set 实际差价 = Nvl(实际差价, 0) + n_差价
          Where 性质 = 1 And 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次;
        Else
          Update 药品库存
          Set 平均成本价 = n_成本价, 上次采购价 = n_成本价, 实际金额 = Nvl(实际金额, 0) + n_零售金额, 实际差价 = Nvl(实际差价, 0) + n_差价
          Where 性质 = 1 And 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次;
          If Sql%NotFound Then
            Insert Into 药品库存
              (库房id, 药品id, 批次, 性质, 实际差价, 上次批号, 效期, 上次产地, 上次供应商id, 上次生产日期, 批准文号, 实际金额, 上次采购价, 平均成本价)
            Values
              (r_Detail.库房id, r_Detail.药品id, r_Detail.批次, 1, n_差价, r_Detail.批号, r_Detail.效期, r_Detail.产地,
               r_Detail.供药单位id, r_Detail.生产日期, r_Detail.批准文号, n_零售金额, n_成本价, n_成本价);
          End If;
        End If;
      Elsif r_Detail.单据 = 13 Then
        --单据=13 的售价修正记录 同步更新的金额和差价，所以不需要重算平均成本价
        If r_Detail.费用id = 0 Then
          Update 药品库存
          Set 零售价 = Decode(n_时价, 1, n_零售价, Null), 实际金额 = Nvl(实际金额, 0) + n_零售金额, 实际差价 = Nvl(实际差价, 0) + n_差价
          Where 性质 = 1 And 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次;
        Else
          Update 药品库存
          Set 实际金额 = Nvl(实际金额, 0) + n_零售金额, 实际差价 = Nvl(实际差价, 0) + n_差价
          Where 性质 = 1 And 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次;
        End If;
      
        If Sql%RowCount = 0 Then
          Insert Into 药品库存
            (库房id, 药品id, 批次, 性质, 可用数量, 实际数量, 实际金额, 实际差价, 零售价)
          Values
            (r_Detail.库房id, r_Detail.药品id, r_Detail.批次, 1, 0, 0, n_零售金额, n_零售金额, Decode(n_时价, 1, n_零售价, Null));
        End If;
      End If;
    Else
      --一般业务处理库存
      --包含业务--1-外购入库；2-自制入库；3-协药入库；4-其他入库；6-库房移出；
      --7-部门领用；8-收费处方发药；9-记帐单处方发药；10-记帐表处方发药；11-其他出库；
      --12-盘点；14-药品盘点记录单
      --21-材料其他出库；24-收费处方发料；25-记帐单处方发料；26-记帐表处方发料
      If 业务类型_In = 0 Or 业务类型_In = 1 Then
        --新增，删除
        If r_Detail.单据 = 8 Or r_Detail.单据 = 9 Or r_Detail.单据 = 10 Or r_Detail.单据 = 21 Or r_Detail.单据 = 24 Or
           r_Detail.单据 = 25 Or r_Detail.单据 = 26 Or r_Detail.单据 = 7 Or r_Detail.单据 = 11 Or
           ((r_Detail.单据 = 2 Or r_Detail.单据 = 3 Or r_Detail.单据 = 12) And r_Detail.入出系数 = -1) Or
           (r_Detail.单据 = 1 And r_Detail.发药方式 = 1) Or (r_Detail.单据 = 6 And r_Detail.入出系数 = -1 And r_Detail.记录状态 = 1) Or
           (r_Detail.单据 = 6 And Mod(r_Detail.记录状态, 3) = 2 And r_Detail.入出系数 = 1) Then
          --需要在新增/删除单据时减少/增加可用数量的单据类型
          ----1.发药/发料单据(收费处方，记账单，记账表)
          ----2.普通出库（领用、其他出库、移库中出的那笔(r_Detail.单据 = 6 And r_Detail.入出系数 = -1 And r_Detail.记录状态 = 1)、盘点单中盘亏那笔）
          ----3.退库单（r_Detail.单据 = 1 And r_Detail.发药方式 = 1）
          ----4.移库申请冲销单（原入库那笔的冲销记录，r_Detail.单据 = 6 And Mod(r_Detail.记录状态, 3) = 2 And r_Detail.入出系数 = 1）
        
          --新增，删除单据时，因为没有审核所以只处理数量不处理金额和差价
        
          If 业务类型_In = 0 Then
            --新增时正常处理可用数量
            n_可用数量 := n_实际数量;
          Else
            --删除时按相反数计算可用数量
            n_可用数量 := -1 * n_实际数量;
          End If;
        
          n_实际数量 := 0;
          n_零售金额 := 0;
          n_差价     := 0;
        
          --处理库存
          Update 药品库存
          Set 可用数量 = 可用数量 + n_可用数量
          Where 药品id = r_Detail.药品id And 库房id = r_Detail.库房id And Nvl(批次, 0) = r_Detail.批次 And 性质 = 1;
        
          n_更新库存 := 1;
        End If;
      Elsif 业务类型_In = 2 Then
        --审核
        --10.35开始，理论上所有的出库类单据在审核时都不再处理可用数量
        If r_Detail.单据 = 8 Or r_Detail.单据 = 9 Or r_Detail.单据 = 10 Or r_Detail.单据 = 21 Or r_Detail.单据 = 24 Or
           r_Detail.单据 = 25 Or r_Detail.单据 = 26 Or r_Detail.单据 = 7 Or r_Detail.单据 = 11 Or
           ((r_Detail.单据 = 2 Or r_Detail.单据 = 3 Or r_Detail.单据 = 12) And r_Detail.入出系数 = -1) Or
           (r_Detail.单据 = 1 And r_Detail.发药方式 = 1) Or (r_Detail.单据 = 6 And r_Detail.入出系数 = -1 And r_Detail.记录状态 = 1) Or
           (r_Detail.单据 = 6 And Mod(r_Detail.记录状态, 3) = 2 And r_Detail.入出系数 = 1) Then
          n_可用数量 := 0;
        Else
          n_可用数量 := n_实际数量;
        End If;
      
        --处理库存
        If 入出类型_In = 0 Then
          --入库审核
          Update 药品库存
          Set 可用数量 = Nvl(可用数量, 0) + n_可用数量, 实际数量 = Nvl(实际数量, 0) + n_实际数量, 实际金额 = Nvl(实际金额, 0) + n_零售金额,
              实际差价 = Nvl(实际差价, 0) + n_差价, 上次供应商id = r_Detail.供药单位id,
              上次采购价 = Decode(r_Detail.单据, 1, Decode(r_Detail.发药方式, 1, 上次采购价, n_成本价), n_成本价),
              上次批号 = Nvl(r_Detail.批号, 上次批号), 上次生产日期 = Nvl(r_Detail.生产日期, 上次生产日期), 上次产地 = Nvl(r_Detail.产地, 上次产地),
              灭菌效期 = Nvl(r_Detail.灭菌效期, 灭菌效期), 效期 = Nvl(r_Detail.效期, 效期), 批准文号 = Nvl(r_Detail.批准文号, 批准文号),
              上次扣率 = Decode(r_Detail.单据, 12, 上次扣率, r_Detail.扣率), 商品条码 = Nvl(r_Detail.商品条码, 商品条码),
              内部条码 = Nvl(r_Detail.内部条码, 内部条码)
          Where 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次 And 性质 = 1;
        Else
          --出库审核，只需要下数量和金额
          Update 药品库存
          Set 可用数量 = Nvl(可用数量, 0) + n_可用数量, 实际数量 = Nvl(实际数量, 0) + n_实际数量, 实际金额 = Nvl(实际金额, 0) + n_零售金额,
              实际差价 = Nvl(实际差价, 0) + n_差价
          Where 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次 And 性质 = 1;
        End If;
      
        n_更新库存 := 1;
      Elsif 业务类型_In = 3 Then
        --冲销
        If r_Detail.单据 = 8 Or r_Detail.单据 = 9 Or r_Detail.单据 = 10 Or r_Detail.单据 = 21 Or r_Detail.单据 = 24 Or
           r_Detail.单据 = 25 Or r_Detail.单据 = 26 Then
          --发药/发料单退药/退料时同时又产生了未发单据，所以就不处理可用数量
          n_可用数量 := 0;
        Elsif r_Detail.单据 = 6 And Mod(r_Detail.记录状态, 3) = 2 And r_Detail.入出系数 = 1 Then
          --药库单的冲销单据，要判断是否需要申请
          n_申请冲销 := 操作类型_In;
          If n_申请冲销 = 0 Then
            --不需要申请的在冲销时处理可用数量
            n_可用数量 := n_实际数量;
          Else
            --需要申请的，已经在申请时处理了可用数量
            n_可用数量 := 0;
          End If;
        Else
          n_可用数量 := n_实际数量;
        End If;
      
        Begin
          Select 1
          Into n_有库存
          From 药品库存
          Where 性质 = 1 And 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次;
        Exception
          When Others Then
            n_有库存 := 0;
        End;
      
        --冲销时如果原来无库存，由于需要重新插入数据，则需要取最新成本价格，因为后面可能还要触发调价修正
        If n_有库存 = 0 Then
          --取原始单据的审核时间
          Select a.审核日期
          Into v_审核日期
          From 药品收发记录 A, 药品收发记录 B
          Where b.Id = r_Detail.Id And a.单据 = b.单据 And a.No = b.No And a.库房id = b.库房id And a.药品id + 0 = b.药品id And
                a.序号 = b.序号 And (a.记录状态 = 1 Or Mod(a.记录状态, 3) = 0);
        
          --成本价取最新价格
          Begin
            Select 1, 新成本价
            Into v_执行新价格, v_现价
            From 成本价调价信息
            Where 库房id + 0 = r_Detail.库房id And 药品id + 0 = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次 And 执行日期 > v_审核日期 And
                  Rownum = 1
            Order By 执行日期 Desc;
          Exception
            When Others Then
              v_执行新价格 := 0;
            
              --可能是无库存调价，那么不需要库房id和批次判断，只需要用药品id
              Begin
                Select 1, 新成本价
                Into v_执行新价格, v_现价
                From 成本价调价信息
                Where 药品id + 0 = r_Detail.药品id And 执行日期 > v_审核日期 And Rownum = 1
                Order By 执行日期 Desc;
              Exception
                When Others Then
                  v_执行新价格 := 0;
              End;
          End;
        
          If v_执行新价格 = 1 Then
            n_成本价 := v_现价;
          End If;
        End If;
      
        --处理库存
        If 入出类型_In = 0 Then
          --出库单据冲销需要将入库库房数据都更新
          Update 药品库存
          Set 可用数量 = Nvl(可用数量, 0) + n_可用数量, 实际数量 = Nvl(实际数量, 0) + n_实际数量, 实际金额 = Nvl(实际金额, 0) + n_零售金额,
              实际差价 = Nvl(实际差价, 0) + n_差价, 上次供应商id = r_Detail.供药单位id,
              上次采购价 = Decode(r_Detail.单据, 1, Decode(r_Detail.发药方式, 1, 上次采购价, n_成本价), 上次采购价),
              上次批号 = Nvl(r_Detail.批号, 上次批号), 上次生产日期 = Nvl(r_Detail.生产日期, 上次生产日期), 上次产地 = Nvl(r_Detail.产地, 上次产地),
              灭菌效期 = Nvl(r_Detail.灭菌效期, 灭菌效期), 效期 = Nvl(r_Detail.效期, 效期), 批准文号 = Nvl(r_Detail.批准文号, 批准文号),
              上次扣率 = Decode(r_Detail.单据, 12, 上次扣率, r_Detail.扣率), 商品条码 = Nvl(r_Detail.商品条码, 商品条码),
              内部条码 = Nvl(r_Detail.内部条码, 内部条码)
          Where 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次 And 性质 = 1;
        Else
          --入库单据冲销只需要下数量和金额
          Update 药品库存
          Set 可用数量 = Nvl(可用数量, 0) + n_可用数量, 实际数量 = Nvl(实际数量, 0) + n_实际数量, 实际金额 = Nvl(实际金额, 0) + n_零售金额,
              实际差价 = Nvl(实际差价, 0) + n_差价
          Where 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次 And 性质 = 1;
        End If;
      
        n_更新库存 := 1;
      End If;
    
      --新增/删除/审核/冲销业务时，库存表未找到数据则需要产生库存表所有信息
      If Sql%RowCount = 0 And n_更新库存 = 1 Then
        Insert Into 药品库存
          (库房id, 药品id, 批次, 效期, 性质, 可用数量, 实际数量, 实际金额, 实际差价, 上次供应商id, 上次采购价, 上次批号, 上次生产日期, 上次产地, 灭菌效期, 批准文号, 零售价, 上次扣率,
           商品条码, 内部条码, 平均成本价)
        Values
          (r_Detail.库房id, r_Detail.药品id, r_Detail.批次, r_Detail.效期, 1, n_可用数量, n_实际数量, n_零售金额, n_差价, r_Detail.供药单位id,
           n_成本价, r_Detail.批号, r_Detail.生产日期, r_Detail.产地, r_Detail.灭菌效期, r_Detail.批准文号, Decode(n_时价, 1, n_零售价, Null),
           r_Detail.扣率, r_Detail.商品条码, r_Detail.内部条码, n_成本价);
      End If;
    
      --重算平均成本价，入库审核需要重算平均成本价和零售价，注意只限于不分批药品，分批药品不用重算（确保和之前库存的数据一致）
      If 入出类型_In = 0 And 业务类型_In = 2 And r_Detail.批次 = 0 Then
        --按总金额/总数量方式计算平均成本价而不用（金额-差价）/数量是为了数据的准确性
        n_总数量 := (n_库存数量 + n_实际数量);
        If n_总数量 <> 0 Then
          n_总成本价 := (n_库存数量 * n_库存平均价 + n_实际数量 * n_成本价) / n_总数量;
        
          If n_总成本价 < 0 Then
            n_总成本价 := n_成本价;
          End If;
        
          Update 药品库存
          Set 平均成本价 = n_总成本价
          Where 性质 = 1 And 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次;
        
          --更新时价零售价
          If n_时价 = 1 Then
            n_总售价 := (n_库存数量 * n_库存售价 + n_实际数量 * n_零售价) / n_总数量;
            Update 药品库存
            Set 零售价 = n_总售价
            Where 性质 = 1 And 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次 And
                  Nvl(实际数量, 0) <> 0;
            If Sql%NotFound Then
              Update 药品库存
              Set 零售价 = n_零售价
              Where 性质 = 1 And 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次;
            End If;
          End If;
        End If;
      End If;
    End If;
  
    --删除多余的库存数据，外购入库财务审核为了确保库存不变产生修正数据必须保证不删除库存
    If Not (r_Detail.单据 = 1 And 操作类型_In = 1) Then
      Delete From 药品库存
      Where 性质 = 1 And 库房id = r_Detail.库房id And 药品id = r_Detail.药品id And Nvl(批次, 0) = r_Detail.批次 And Nvl(可用数量, 0) = 0 And
            Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
    End If;
  End Loop;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_药品库存_Update;
/

--108071:李业庆,2017-04-13,修改查询库存SQL批次条件错误
Create Or Replace Procedure Zl_药品收发记录_销售出库
(
  Id_In           In 门诊费用记录.Id%Type,
  药品摘要_In     药品收发记录.摘要%Type := Null,
  频次_In         药品收发记录.频次%Type := Null,
  单量_In         药品收发记录.单量%Type := Null,
  用法_In         药品收发记录.用法%Type := Null,
  煎法_In         药品收发记录.外观%Type := Null,
  期效_In         药品收发记录.扣率%Type := Null,
  计价特性_In     药品收发记录.扣率%Type := Null,
  主页id_In       未发药品记录.主页id%Type := Null,
  备货材料_In     Number := 0,
  备货材料批次_In 药品收发记录.批次%Type := Null
) Is
  ----------------------------------
  --功能：收费、划价时按照参数设置分解药品并产生相应的收发记录
  --规则：
  --      1、循环游标判断总出库数量与游标中每条记录数量是否充足，如果充足就是总数量，不充足挨个遍历直到数量直到遍历完并退出
  --      2、金额计算方式：定价取收费价目表现价，时价分批取库存表零售价，时价不分批，零售金额/实际数量，并将所有批次的金额累加起来为总出库金额
  --参数：
  --      Id_In：门诊费用记录或者住院费用记录ID
  --      备货材料_In：只有高值卫材才需要传入，非0表示是高值卫材
  --      备货材料批次_In：只有高值卫材才需要传入，非空表示是高值卫材的批次
  --      药品摘要_In：可选参数
  --      频次_In；单量_In；用法_In；煎法_In；期效_In；计价特性_In，可选参数，医嘱记录产生
  -----------------------------------
  Cursor c_Stock
  (
    n_Outmode  Number,
    n_库房id   药品收发记录.库房id%Type,
    n_药品id   药品收发记录.药品id%Type,
    n_备货材料 Number,
    n_备货批次 药品收发记录.批次%Type
  ) Is
    Select 库房id, 药品id, 批次, 效期, 性质, 可用数量, 实际数量, 实际金额, 实际差价, 上次供应商id, 上次采购价, 上次批号, 上次生产日期, 上次产地, 灭菌效期, 批准文号, 平均成本价, 零售价,
           上次扣率, 商品条码, 内部条码
    From 药品库存
    Where 药品id = n_药品id And 库房id = n_库房id And 性质 = 1 And
          Decode(n_备货材料, 0, 0, Nvl(批次, 0)) = Decode(n_备货材料, 0, 0, Nvl(n_备货批次, 0)) And
          (Nvl(批次, 0) = 0 Or 效期 Is Null Or 效期 > Trunc(Sysdate)) And Nvl(可用数量, 0) > 0
    Order By Decode(n_Outmode, 1, 效期, Null), Nvl(批次, 0);
  r_Stock c_Stock%RowType;

  n_Outmode      Number;
  n_分批         药品规格.药房分批%Type;
  n_时价         收费项目目录.是否变价%Type;
  n_当前数量     药品库存.实际数量%Type;
  n_费用金额小数 Number;
  n_费用单价小数 Number;
  n_流通金额小数 Number;
  n_流通单价小数 Number;
  n_标准单价     收费价目.现价%Type;
  n_当前单价     收费价目.现价%Type;
  n_类别         药品单据性质.类别id%Type;
  n_总金额       Number;
  n_总数量       药品库存.实际数量%Type;
  n_单据         药品单据性质.单据%Type;
  n_跟踪在用     材料特性.跟踪在用%Type;
  n_序号         门诊费用记录.序号%Type;
  v_名称         收费项目目录.名称%Type;
  n_虚拟库房id   部门表.Id%Type;
  n_库房id       部门表.Id%Type;
  n_优先级       身份.优先级%Type;
  n_Count        Number;
  Err_Custom Exception;
  v_Rust     Varchar2(300);
  v_Error    Varchar2(255);
  v_部门名称 部门表.名称%Type;

  v_单据类别   Varchar2(10);
  v_No         药品收发记录.No%Type;
  n_对方部门id 药品收发记录.对方部门id%Type;
  n_收费细目id 药品收发记录.药品id%Type;
  n_总出库数量 药品库存.实际数量%Type;
  n_发药库房id 药品收发记录.库房id%Type;
  n_记录性质   门诊费用记录.记录性质%Type;
  v_收费类别   门诊费用记录.收费类别%Type;
  n_多病人单   住院费用记录.多病人单%Type;
  n_医嘱序号   门诊费用记录.医嘱序号%Type;
  v_姓名       门诊费用记录.姓名%Type;
  n_付数       门诊费用记录.付数%Type;
  v_操作员     门诊费用记录.操作员姓名%Type;
  d_登记时间   门诊费用记录.登记时间%Type;
  n_门诊标志   门诊费用记录.门诊标志%Type;
  n_病人科室id 门诊费用记录.病人科室id%Type;
  n_标识号     门诊费用记录.标识号%Type;
  v_性别       门诊费用记录.性别%Type;
  n_年龄       门诊费用记录.年龄%Type;
  n_病人id     门诊费用记录.病人id%Type;
  v_发药窗口   门诊费用记录.发药窗口%Type;
  n_记录状态   门诊费用记录.记录状态%Type;

  --药品收发记录
  n_收发id   药品收发记录.Id%Type;
  n_扣率     药品收发记录.扣率%Type;
  d_灭菌效期 药品收发记录.灭菌效期%Type;
  d_灭菌日期 药品收发记录.灭菌日期%Type;

  v_其他出库no 药品收发记录.No%Type;
  n_出库序号   药品收发记录.序号%Type;
  n_定价售价   收费价目.现价%Type;
  n_出库检查   Number(1);
Begin
  Begin
    Select 类别, NO, 序号, 对方部门id, 收费细目id, 总出库数量, 发药库房id, 记录性质, 收费类别, 多病人单, 医嘱序号, 姓名, 付数, 划价人, 登记时间, 门诊标志, 病人科室id, 标识号, 性别,
           年龄, 病人id, 发药窗口, 记录状态, 标准单价
    Into v_单据类别, v_No, n_序号, n_对方部门id, n_收费细目id, n_总出库数量, n_发药库房id, n_记录性质, v_收费类别, n_多病人单, n_医嘱序号, v_姓名, n_付数, v_操作员,
         d_登记时间, n_门诊标志, n_病人科室id, n_标识号, v_性别, n_年龄, n_病人id, v_发药窗口, n_记录状态, n_标准单价
    From (Select '门诊' As 类别, NO, 序号, 病人科室id As 对方部门id, 收费细目id, 付数 * 数次 As 总出库数量, 执行部门id As 发药库房id, 记录性质, 收费类别, 0 As 多病人单,
                  医嘱序号, 姓名, 付数, 划价人, 登记时间, 门诊标志, 病人科室id, 标识号, 性别, 年龄, 病人id, 发药窗口, 记录状态, 标准单价
           From 门诊费用记录
           Where ID = Id_In
           Union All
           Select '住院' As 类别, NO, 序号, 病人科室id As 对方部门id, 收费细目id, 付数 * 数次 As 总出库数量, 执行部门id As 发药库房id, 记录性质, 收费类别, 多病人单, 医嘱序号,
                  姓名, 付数, 划价人, 登记时间, 门诊标志, 病人科室id, 标识号, 性别, 年龄, 病人id, 发药窗口, 记录状态, 标准单价
           From 住院费用记录
           Where ID = Id_In);
  Exception
    When Others Then
      v_No         := Null;
      n_对方部门id := 0;
      n_总出库数量 := 0;
  End;

  n_跟踪在用 := 0;
  --只处理有数量的
  If n_总出库数量 <> 0 Then
    --药品分批出库方式
    Select Zl_To_Number(Nvl(zl_GetSysParameter(150), 0)) Into n_Outmode From Dual;
    --金额小数位数
    Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')), Zl_To_Number(Nvl(zl_GetSysParameter(157), '5'))
    Into n_费用金额小数, n_费用单价小数
    From Dual;
  
    --取流通业务精度位数
    --类别:1-药品 2-卫材
    --内容：2-零售价 4-金额
    --单位：药品:1-售价 5-金额单位
    If v_收费类别 = '4' Then
      Select 精度 Into n_流通单价小数 From 药品卫材精度 Where 类别 = 2 And 内容 = 2 And 单位 = 1;
      Select 精度 Into n_流通金额小数 From 药品卫材精度 Where 类别 = 2 And 内容 = 4 And 单位 = 5;
    Else
      Select 精度 Into n_流通单价小数 From 药品卫材精度 Where 类别 = 1 And 内容 = 2 And 单位 = 1;
      Select 精度 Into n_流通金额小数 From 药品卫材精度 Where 类别 = 1 And 内容 = 4 And 单位 = 5;
    End If;
  
    n_总数量 := n_总出库数量;
  
    If v_收费类别 = '4' Then
      --收费类别=4表示是卫材单据
      If v_单据类别 = '门诊' Then
        If n_记录性质 = 1 Then
          n_单据 := 24;
        Else
          n_单据 := 25;
        End If;
      Elsif v_单据类别 = '住院' Then
        If n_多病人单 = 1 Then
          n_单据 := 26;
        Else
          n_单据 := 25;
        End If;
      End If;
    
      Select Nvl(a.在用分批, 0), Nvl(b.是否变价, 0), b.名称, c.现价
      Into n_分批, n_时价, v_名称, n_定价售价
      From 材料特性 A, 收费项目目录 B, 收费价目 C
      Where a.材料id = b.Id And b.Id = n_收费细目id And b.Id = c.收费细目id And Sysdate Between c.执行日期 And c.终止日期;
      --跟踪在用
      Select 跟踪在用 Into n_跟踪在用 From 材料特性 Where 材料id = n_收费细目id;
      --备货卫材需要判断是否设置了虚拟库房对照
      If Nvl(备货材料_In, 0) = 1 Then
        Begin
          Select 虚拟库房id Into n_虚拟库房id From 虚拟库房对照 Where 科室id = n_发药库房id And Rownum <= 1;
        Exception
          When Others Then
            n_虚拟库房id := 0;
        End;
        If Nvl(n_虚拟库房id, 0) = 0 Then
          Begin
            Select 名称 Into v_Error From 部门表 Where ID = n_发药库房id;
          Exception
            When Others Then
              v_Error := '';
          End;
          v_Error := '执行部门"' || Nvl(v_Error, '') || '"未设置虚拟部门,请在卫材参数设置中设置.';
          Raise Err_Custom;
        End If;
      End If;
    Else
      --收费类别<>4表示是药品单据，收费类别有"5，6，7"
      If v_单据类别 = '门诊' Then
        If n_记录性质 = 1 Then
          n_单据 := 8;
        Else
          n_单据 := 9;
        End If;
      Elsif v_单据类别 = '住院' Then
        If n_多病人单 = 1 Then
          n_单据 := 10;
        Else
          n_单据 := 9;
        End If;
      End If;
    
      Select Nvl(a.药房分批, 0), Nvl(b.是否变价, 0), b.名称, c.现价
      Into n_分批, n_时价, v_名称, n_定价售价
      From 药品规格 A, 收费项目目录 B, 收费价目 C
      Where a.药品id = b.Id And b.Id = n_收费细目id And b.Id = c.收费细目id And Sysdate Between c.执行日期 And c.终止日期;
    End If;
  
    --可能分批时价药品分解的批次变了
    If n_时价 = 1 Then
      --只有一个批次时,直接取该批次的单价
      --按照最小单位进行格式化
      v_Rust     := Zl_Fun_Getprice(n_收费细目id, n_发药库房id, n_总出库数量, 备货材料_In, 备货材料批次_In);
      n_当前单价 := To_Number(Substr(v_Rust, 1, Instr(v_Rust, '|') - 1));
    
      If Round(n_当前单价, n_费用单价小数) <> Round(n_标准单价, n_费用单价小数) Then
        If n_医嘱序号 Is Null Then
          If v_收费类别 = '4' Then
            v_Error := '第 ' || n_序号 || ' 行的时价卫生材料"' || v_名称 || '"当前计算单价不一致,请重新输入数量计算！';
          Else
            v_Error := '第 ' || n_序号 || ' 行的时价药品"' || v_名称 || '"当前计算单价不一致,请重新输入数量计算！';
          End If;
        Else
          If v_收费类别 = '4' Then
            v_Error := '在处理病人"' || v_姓名 || '"时发现时价卫生材料"' || v_名称 || '"当前计算的单价发生变化。' || Chr(13) || Chr(10) ||
                       '请检查该病人是否同时使用了两笔相同的"' || v_名称 || '"！';
          Else
            v_Error := '在处理病人"' || v_姓名 || '"时发现时价药品"' || v_名称 || '"当前计算的单价发生变化。' || Chr(13) || Chr(10) ||
                       '请检查该病人是否同时使用了两笔相同的"' || v_名称 || '"！';
          End If;
        End If;
        Raise Err_Custom;
      End If;
    End If;
  
    If v_收费类别 In ('5', '6', '7') Or (v_收费类别 = '4' And Nvl(n_跟踪在用, 0) = 1) Then
      If Nvl(备货材料_In, 0) = 1 And v_收费类别 = '4' Then
        n_库房id := n_虚拟库房id;
      Else
        n_库房id := n_发药库房id;
      End If;
    
      Begin
        If v_收费类别 In ('5', '6', '7') Then
          Select 检查方式 Into n_出库检查 From 药品出库检查 Where 库房id = n_库房id;
        Else
          Select 检查方式 Into n_出库检查 From 材料出库检查 Where 库房id = n_库房id;
        End If;
      Exception
        When Others Then
          n_出库检查 := 0;
      End;
    
      If v_收费类别 = '4' Then
        Select 类别id Into n_类别 From 药品单据性质 Where 单据 = n_单据 + 16;
      Else
        Select 类别id Into n_类别 From 药品单据性质 Where 单据 = n_单据;
      End If;
    
      n_总金额 := 0;
      --打开游标
      Open c_Stock(n_Outmode, n_库房id, n_收费细目id, 备货材料_In, 备货材料批次_In);
      --循环遍历
      While n_总出库数量 <> 0 Loop
        Fetch c_Stock
          Into r_Stock;
        If c_Stock%NotFound Then
          --第一次就没有库存,分批或时价都不允许。
          --分批药品数量分解不完,也就是库存不足。
          If n_分批 = 1 Or n_时价 = 1 Then
            Close c_Stock;
            If n_单据 = 8 Or n_单据 = 24 Then
              If v_收费类别 = '4' Then
                v_Error := '第 ' || n_序号 || ' 行的分批或时价卫生材料"' || v_名称 || '"没有可用的库存！';
              Else
                v_Error := '第 ' || n_序号 || ' 行的分批或时价药品"' || v_名称 || '"没有可用的药品库存！';
              End If;
            Else
              --单据=9，10，25，26是记账单提示不一样
              If n_医嘱序号 Is Null Then
                If v_收费类别 = '4' Then
                  If Nvl(备货材料_In, 0) = 1 And Not (n_分批 = 1 Or n_时价 = 1) Then
                    v_Error := '第 ' || n_序号 || ' 行的卫生材料"' || v_名称 || '"没有足够的材料库存,不能进行备货记帐！';
                  Else
                    v_Error := '第 ' || n_序号 || ' 行的分批或时价卫生材料"' || v_名称 || '"没有足够的材料库存' || Case
                                 When Nvl(备货材料_In, 0) = 0 Then
                                  '！'
                                 Else
                                  ',不能进行备货记帐！'
                               End;
                  End If;
                Else
                  v_Error := '第 ' || n_序号 || ' 行的分批或时价药品"' || v_名称 || '"没有足够的库存！';
                End If;
              Else
                If v_收费类别 = '4' Then
                  If Nvl(备货材料_In, 0) = 1 And Not (n_分批 = 1 Or n_时价 = 1) Then
                    v_Error := '在处理病人"' || v_姓名 || '"时发现卫生材料"' || v_名称 || '"没有足够的材料库存,不能进行备货记帐！';
                  Else
                    v_Error := '在处理病人"' || v_姓名 || '"时发现分批或时价卫生材料"' || v_名称 || '"没有足够的材料库存' || Case
                                 When Nvl(备货材料_In, 0) = 0 Then
                                  '！'
                                 Else
                                  ',不能进行备货记帐！'
                               End;
                  End If;
                Else
                  v_Error := '在处理病人"' || v_姓名 || '"时发现分批或时价药品"' || v_名称 || '"没有足够的库存！';
                End If;
              End If;
            End If;
            Raise Err_Custom;
          End If;
        Elsif (n_分批 = 1 And Nvl(r_Stock.批次, 0) = 0) Or (n_分批 = 0 And Nvl(r_Stock.批次, 0) <> 0) Then
          Close c_Stock;
          If n_医嘱序号 Is Null Then
            If v_收费类别 = '4' Then
              v_Error := '第 ' || n_序号 || ' 行卫生材料"' || v_名称 || '"的在用分批属性与库存记录不相符,请检查材料数据的正确性！';
            Else
              v_Error := '第 ' || n_序号 || ' 行药品"' || v_名称 || '"的分批属性与库存记录不相符,请检查药品数据的正确性！';
            End If;
          Else
            If v_收费类别 = '4' Then
              v_Error := '在处理病人"' || v_姓名 || '"时发现卫生材料"' || v_名称 || '"的分批属性与库存记录不相符,请检查材料数据的正确性！';
            Else
              v_Error := '在处理病人"' || v_姓名 || '"时发现药品"' || v_名称 || '"的分批属性与库存记录不相符,请检查药品数据的正确性！';
            End If;
          End If;
          Raise Err_Custom;
        End If;
      
        If c_Stock%Found Then
          If Nvl(r_Stock.实际数量, 0) = 0 And (n_总出库数量 > 0 Or n_时价 = 1) And n_出库检查 = 2 Then
            --实际数量为零时，如果严格控制库存，不允许出库
            --实际数量不为零，金额为零，可能是正常的零价格管理。
            --负数的情况相当于入库,这种情况应是允许的；但时价需要计算价格，必须要有实际数量。
            Close c_Stock;
            If n_医嘱序号 Is Null Then
              If v_收费类别 = '4' Then
                v_Error := '第 ' || n_序号 || ' 行的卫生材料"' || v_名称 || '"当前无库存实际数量，可能存在尚未退料的记录，当前不能出库。';
              Else
                v_Error := '第 ' || n_序号 || ' 行药品"' || v_名称 || '"当前无库存实际数量，可能存在尚未退药的记录，当前不能出库。';
              End If;
            Else
              If v_收费类别 = '4' Then
                v_Error := '在处理病人"' || v_姓名 || '"时发现卫生材料"' || v_名称 || '"当前无库存实际数量，可能存在尚未退料的记录，当前不能出库。';
              Else
                v_Error := '在处理病人"' || v_姓名 || '"时发现药品"' || v_名称 || '"当前无库存实际数量，可能存在尚未退药的记录，当前不能出库。';
              End If;
            End If;
            Raise Err_Custom;
          End If;
        End If;
      
        If n_分批 = 1 Or n_时价 = 1 Then
          --对于不分批的时价只可能分解一次,分解不完上面判断了.它分解是为了计算单价.
          --每次分解取小者,库存不够分解不完在上面判断.
          If n_总出库数量 <= Nvl(r_Stock.可用数量, 0) Then
            n_当前数量 := n_总出库数量;
          Else
            n_当前数量 := Nvl(r_Stock.可用数量, 0);
          End If;
          If n_时价 = 1 Then
            n_当前单价 := Nvl(r_Stock.零售价, Nvl(r_Stock.实际金额 / r_Stock.实际数量, 0));
          Elsif n_分批 = 1 Then
            n_当前单价 := n_定价售价;
          End If;
        Else
          --定价不分批
          --非门诊单据且是高值卫材需要检查库存
          If n_单据 <> 8 Or n_单据 <> 24 Then
            If Nvl(备货材料_In, 0) = 1 And v_收费类别 = '4' Then
              If n_总出库数量 > Nvl(r_Stock.可用数量, 0) Then
                --不分批, 但又是备货卫材方式出库的,则需要检查当前库存是否充足.
                v_Error := '第 ' || n_序号 || ' 行的卫生材料"' || v_名称 || '"没有足够的材料库存,不能进行备货记帐！';
                Raise Err_Custom;
              End If;
            End If;
          End If;
          n_当前数量 := n_总出库数量;
          n_当前单价 := n_定价售价;
        End If;
      
        --药品收发记录
        If c_Stock%Found Then
          --卫材灭菌效期:一次性材料且有效期
          If v_收费类别 = '4' Then
            n_Count := 0;
            Begin
              Select 灭菌效期 Into n_Count From 材料特性 Where Nvl(一次性材料, 0) = 1 And 材料id = n_收费细目id;
            Exception
              When Others Then
                Null;
            End;
            If Nvl(n_Count, 0) > 0 Then
              d_灭菌效期 := r_Stock.灭菌效期;
              d_灭菌日期 := d_灭菌效期 - n_Count * 30;
            End If;
          End If;
        End If;
      
        Select Nvl(Max(序号), 0) + 1 Into n_序号 From 药品收发记录 Where 单据 = n_单据 And 记录状态 = 1 And NO = v_No;
      
        n_扣率 := Null;
        If 期效_In Is Not Null Or 计价特性_In Is Not Null Then
          n_扣率 := Nvl(期效_In, 0) || Nvl(计价特性_In, 0);
        End If;
      
        --分批药品,如果是只使用了一个批次,则要填写付数
        If n_分批 = 1 And n_当前数量 <> n_总数量 Then
          n_Count := 1;
        Else
          n_Count := 0;
        End If;
      
        Select 药品收发记录_Id.Nextval Into n_收发id From Dual;
        --修改的原单据号存放在摘要中
        Insert Into 药品收发记录
          (ID, 记录状态, 单据, NO, 序号, 库房id, 对方部门id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 付数, 填写数量, 实际数量, 零售价, 零售金额, 摘要, 填制人,
           填制日期, 费用id, 频次, 单量, 用法, 外观, 扣率, 灭菌效期, 灭菌日期, 供药单位id, 生产日期, 批准文号, 商品条码, 内部条码)
        Values
          (n_收发id, 1, n_单据, v_No, n_序号, n_发药库房id, n_对方部门id, n_类别, -1, n_收费细目id, r_Stock.批次, r_Stock.上次产地, r_Stock.上次批号,
           r_Stock.效期, Decode(n_Count, 1, 1, n_付数), Decode(n_Count, 1, n_当前数量, n_当前数量 / n_付数),
           Decode(n_Count, 1, n_当前数量, n_当前数量 / n_付数), n_当前单价, Round(n_当前单价 * n_当前数量, n_流通金额小数), 药品摘要_In, v_操作员, d_登记时间,
           Id_In, 频次_In, 单量_In, 用法_In, 煎法_In, n_扣率, d_灭菌效期, d_灭菌日期, r_Stock.上次供应商id, r_Stock.上次生产日期, r_Stock.批准文号,
           r_Stock.商品条码, r_Stock.内部条码);
      
        --药品库存(普通情况可能没有记录)
        Zl_药品库存_Update(n_收发id, 0, 1);
      
        --产生其他出库单 ，只有高值卫材才需要处理
        If v_收费类别 = '4' And Nvl(备货材料_In, 0) = 1 Then
          Begin
            Select Max(a.No), Max(a.序号)
            Into v_其他出库no, n_出库序号
            From 药品收发记录 A, 住院费用记录 B
            Where a.费用id = b.Id And b.No = v_No And 记录性质 = 2 And b.门诊标志 = n_门诊标志 And
                  Instr(',8,9,10,21,24,25,26,', ',' || a.单据 || ',') > 0;
          Exception
            When Others Then
              v_其他出库no := Null;
          End;
          If v_其他出库no Is Null Then
            v_其他出库no := Nextno(74, n_虚拟库房id, Null, 1);
          End If;
          If v_其他出库no Is Null Then
            v_Error := '在生成卫生材料的其他出库单时,获取相关的出库NO有误,请检查出库单的规则是否有误!';
            Raise Err_Custom;
          End If;
          If Nvl(n_病人科室id, 0) <> 0 Then
            Select 名称 Into v_部门名称 From 部门表 Where ID = n_病人科室id;
          End If;
          v_Error := LPad(' ', 4);
          v_Error := Substr('病人姓名:' || v_姓名 || v_Error || '性别:' || v_性别 || v_Error || '年龄' || n_年龄 || v_Error || '门诊号:' ||
                            Nvl(n_标识号, '') || v_Error || '病人科室:' || v_部门名称, 1, 100);
        
          n_出库序号 := Nvl(n_出库序号, 0) + 1;
          Select 药品收发记录_Id.Nextval Into n_收发id From Dual;
        
          --高值卫材类别id默认19是为了方便统计，因为其他出库可以设置很多类别，所以默认19
          Insert Into 药品收发记录
            (ID, 记录状态, 单据, NO, 序号, 库房id, 对方部门id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 付数, 填写数量, 实际数量, 零售价, 零售金额, 摘要, 填制人,
             填制日期, 费用id, 频次, 发药窗口, 单量, 用法, 外观, 扣率, 灭菌效期, 灭菌日期, 供药单位id, 生产日期, 批准文号, 商品条码, 内部条码)
          Values
            (n_收发id, 1, 21, v_其他出库no, n_出库序号, n_虚拟库房id, n_对方部门id, 19, -1, n_收费细目id, r_Stock.批次, r_Stock.上次产地,
             r_Stock.上次批号, r_Stock.效期, 1, n_当前数量, n_当前数量, n_当前单价, Round(n_当前单价 * n_当前数量, n_流通金额小数), v_Error, v_操作员,
             d_登记时间, Id_In, 频次_In, v_发药窗口, 单量_In, 用法_In, 煎法_In, n_扣率, d_灭菌效期, d_灭菌日期, r_Stock.上次供应商id, r_Stock.上次生产日期,
             r_Stock.批准文号, r_Stock.商品条码, r_Stock.内部条码);
        
          --药品库存(普通情况可能没有记录)
          Zl_药品库存_Update(n_收发id, 0, 1);
        End If;
      
        v_Error      := '';
        n_总出库数量 := n_总出库数量 - n_当前数量;
        n_总金额     := n_总金额 + n_当前数量 * n_当前单价;
      End Loop;
    
      --未发药品记录
      Update 未发药品记录
      Set 病人id = n_病人id, 姓名 = v_姓名, 发药窗口 = v_发药窗口, 主页id = 主页id_In
      Where 单据 = n_单据 And NO = v_No And Nvl(库房id, 0) = Nvl(n_发药库房id, 0);
      If Sql%RowCount = 0 Then
        --取身份优先级
        Begin
          Select b.优先级 Into n_优先级 From 病人信息 A, 身份 B Where a.身份 = b.名称(+) And a.病人id = n_病人id;
        Exception
          When Others Then
            Null;
        End;
        Insert Into 未发药品记录
          (单据, NO, 病人id, 主页id, 姓名, 优先级, 库房id, 对方部门id, 填制日期, 已收费, 打印状态, 发药窗口)
        Values
          (n_单据, v_No, n_病人id, 主页id_In, v_姓名, n_优先级, n_发药库房id, n_对方部门id, d_登记时间, n_记录状态, 0, v_发药窗口);
      End If;
    
      --处理未发药记录状态
      Zl_Prescription_Type_Update(v_No, n_记录性质, n_收费细目id, v_收费类别);
    
      Close c_Stock;
    End If;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_药品收发记录_销售出库;
/

--106936:李业庆,2017-04-13,药品批号对照表数据重复问题
--108303:李业庆,2017-04-13,药品批号对照表数据重复问题
Create Or Replace Procedure Zl_药品盘点记录单_Insert
(
  No_In         In 药品收发记录.No%Type,
  序号_In       In 药品收发记录.序号%Type,
  库房id_In     In 药品收发记录.库房id%Type,
  批次_In       In 药品收发记录.批次%Type,
  入出类别id_In In 药品收发记录.入出类别id%Type,
  入出系数_In   In 药品收发记录.入出系数%Type,
  药品id_In     In 药品收发记录.药品id%Type,
  帐面数量_In   In 药品收发记录.填写数量%Type,
  实盘数量_In   In 药品收发记录.扣率%Type,
  数量差_In     In 药品收发记录.实际数量%Type,
  售价_In       In 药品收发记录.零售价%Type,
  金额差_In     In 药品收发记录.零售金额%Type,
  差价差_In     In 药品收发记录.差价%Type,
  填制人_In     In 药品收发记录.填制人%Type,
  填制日期_In   In 药品收发记录.填制日期%Type,
  摘要_In       In 药品收发记录.摘要%Type := Null,
  产地_In       In 药品收发记录.产地%Type := Null,
  批号_In       In 药品收发记录.批号%Type := Null,
  效期_In       In 药品收发记录.效期%Type := Null,
  盘点时间_In   In 药品收发记录.频次%Type := Null,
  库存金额_In   In 药品收发记录.成本价%Type := Null,
  库存差价_In   In 药品收发记录.成本金额%Type := Null,
  批准文号_In   In 药品收发记录.批准文号%Type := Null,
  成本价_In     In 药品收发记录.单量%Type := Null,
  库房货位_In   In 药品收发记录.库房货位%Type := Null
) Is
  v_批次 药品收发记录.批次%Type;
Begin
  v_批次 := 批次_In;
  If v_批次 < 0 Then
    v_批次 := Zl_Fun_Getbatchnum(药品id_In, 产地_In, 批号_In, 成本价_In, 售价_In, 批次_In);
  End If;

  Insert Into 药品收发记录
    (ID, 记录状态, 单据, NO, 序号, 库房id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 填写数量, 扣率, 实际数量, 零售价, 零售金额, 差价, 摘要, 填制人, 填制日期, 频次,
     成本价, 成本金额, 批准文号, 单量, 库房货位)
  Values
    (药品收发记录_Id.Nextval, 1, 14, No_In, 序号_In, 库房id_In, 入出类别id_In, 入出系数_In, 药品id_In, v_批次, 产地_In, 批号_In, 效期_In, 帐面数量_In,
     实盘数量_In, 数量差_In, 售价_In, 金额差_In, 差价差_In, 摘要_In, 填制人_In, 填制日期_In, 盘点时间_In, 库存金额_In, 库存差价_In, 批准文号_In, 成本价_In, 库房货位_In);
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_药品盘点记录单_Insert;
/

--106936:李业庆,2017-04-13,药品批号对照表数据重复问题
Create Or Replace Function Zl_Fun_Getbatchnum
(
  药品id_In   药品批号对照.药品id%Type,
  生产厂家_In 药品批号对照.生产厂家%Type,
  批号_In     药品批号对照.批号%Type,
  成本价_In   药品批号对照.成本价%Type,
  售价_In     药品批号对照.售价%Type,
  新批次_In   药品批号对照.批次%Type
) Return Number Is
  --功能：药品入库产生入库记录时根据传递过来的参数找对应的批次
  --返回值：查询到的批次，如果批次>0则说明找到了批次,如果批次=0则说明没有找到
  --参数：
  --     生产厂家_in：入库传递过来的生产商
  --     批号_in：入库时录入的批号
  --     成本价_in 入库时的成本价
  --     售价_in  入库时的售价
  --     
  n_批次     药品批号对照.批次%Type;
  n_药库包装 药品规格.药库包装%Type;
  n_是否变价 收费项目目录.是否变价%Type;
  n_Count    Number(1);
Begin
  --只处理生产厂家和批号不为空的情况
  If 生产厂家_In Is Not Null And 批号_In Is Not Null Then
    Begin
      Select 批次
      Into n_批次
      From 药品批号对照
      Where 药品id = 药品id_In And Nvl(生产厂家, 'a') = Nvl(生产厂家_In, 'a') And Nvl(批号, 'b') = Nvl(批号_In, 'b') And 成本价 = 成本价_In And
            售价 = 售价_In;
    Exception
      When Others Then
        n_批次 := 新批次_In;
      
        If n_批次 > 0 Then
          --检查有无重复记录
          Begin
            Select 1
            Into n_Count
            From 药品批号对照
            Where 药品id = 药品id_In And Nvl(生产厂家, 'a') = Nvl(生产厂家_In, 'a') And Nvl(批号, 'b') = Nvl(批号_In, 'b') And
                  批次 = n_批次;
          Exception
            When Others Then
              n_Count := 0;
          End;
          
          --没有重复记录才能插入
          If n_Count = 0 Then
            Insert Into 药品批号对照
              (药品id, 生产厂家, 批号, 批次, 成本价, 售价)
            Values
              (药品id_In, 生产厂家_In, 批号_In, 新批次_In, 成本价_In, 售价_In);
          End If;
        End If;
    End;
  End If;

  Return(n_批次);
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Fun_Getbatchnum;
/

--106632:李业庆,2017-04-19,调用Zl_药品库存_Update参数修改，适应申请和审核冲销业务
Create Or Replace Procedure Zl_药品移库_Strike
(
  行次_In       In Integer,
  原记录状态_In In 药品收发记录.记录状态%Type,
  No_In         In 药品收发记录.No%Type,
  序号_In       In 药品收发记录.序号%Type,
  药品id_In     In 药品收发记录.药品id%Type,
  冲销数量_In   In 药品收发记录.实际数量%Type,
  填制人_In     In 药品收发记录.填制人%Type,
  填制日期_In   In 药品收发记录.填制日期%Type,
  摘要_In       In 药品收发记录.摘要%Type := Null,
  冲销方式_In   In Integer := 0 --0－正常冲销方式；1－产生冲销申请单据；2－审核已产生的冲销申请单据
) Is
  Err_Isstriked Exception;
  Err_Isoutstock Exception;
  Err_Isnonum Exception;
  Err_Isbatch Exception;
  v_Druginf      Varchar2(50); --原不分批现在分批的药品信息
  v_库房id       药品收发记录.库房id%Type;
  v_批次         药品收发记录.批次%Type;
  v_成本价       药品收发记录.成本价%Type;
  v_成本金额     药品收发记录.成本金额%Type;
  v_零售价       药品收发记录.零售价%Type;
  v_零售金额     药品收发记录.零售金额%Type;
  v_差价         药品收发记录.差价%Type;
  v_剩余数量     药品收发记录.实际数量%Type;
  v_剩余成本金额 药品收发记录.成本金额%Type;
  v_剩余零售金额 药品收发记录.零售金额%Type;
  v_收发id       药品收发记录.Id%Type;
  v_批准文号     药品收发记录.批准文号%Type;

  v_药库分批 Integer;
  v_药房分批 Integer;
  Intdigit   Number;
  n_操作类型 Number;

  Cursor c_药品收发记录 Is
    Select a.Id, a.序号, a.库房id, a.对方部门id, a.入出类别id, a.入出系数, a.药品id, a.批次, a.产地, a.批号, a.效期, a.配药人, a.配药日期, a.摘要, a.供药单位id,
           a.批准文号, a.生产日期, a.成本价, a.零售价, Nvl(b.是否变价, 0) As 时价, a.扣率, a.单量, a.频次
    From 药品收发记录 A, 收费项目目录 B
    Where a.药品id = b.Id And a.No = No_In And a.单据 = 6 And (a.序号 >= 序号_In And a.序号 <= 序号_In + 1) And
          (a.记录状态 = 1 Or Mod(a.记录状态, 3) = 0)
    Order By a.药品id;

  Cursor c_冲销申请记录 Is
    Select a.Id, a.序号, a.库房id, a.对方部门id, a.入出类别id, a.入出系数, a.药品id, a.批次, a.产地, a.批号, a.效期, a.配药人, a.配药日期, a.摘要, a.供药单位id,
           a.批准文号, a.生产日期, a.成本价, a.实际数量, a.零售金额, a.差价, a.零售价, Nvl(b.是否变价, 0) As 时价, a.扣率, a.单量, a.频次
    From 药品收发记录 A, 收费项目目录 B
    Where a.药品id = b.Id And a.No = No_In And a.单据 = 6 And (a.序号 >= 序号_In And a.序号 <= 序号_In + 1) And
          (a.记录状态 = 原记录状态_In And Mod(a.记录状态, 3) = 2) And a.审核日期 Is Null
    Order By a.药品id;
Begin
  --获取金额小数位数
  Select Nvl(精度, 2) Into Intdigit From 药品卫材精度 Where 性质 = 0 And 类别 = 1 And 内容 = 4 And 单位 = 5;

  If 冲销方式_In = 0 Then
    n_操作类型 := 0;
  Else
    n_操作类型 := 1;
  End If;

  If 冲销方式_In = 1 Then
    --产生冲销申请单据，不填写审核人、审核日期，不更新库存记录
    If 行次_In = 1 Then
      Update 药品收发记录
      Set 记录状态 = Decode(原记录状态_In, 1, 3, 原记录状态_In + 3)
      Where NO = No_In And 单据 = 6 And 记录状态 = 原记录状态_In;
      If Sql%RowCount = 0 Then
        Raise Err_Isstriked;
      End If;
    End If;
  
    --主要针对原不分批现在分批的药品，不能对其冲销
    Begin
      Select Distinct '(' || i.编码 || ')' || Nvl(n.名称, i.名称) As 药品信息
      Into v_Druginf
      From 药品收发记录 A, 药品规格 B, 收费项目目录 I, 收费项目别名 N
      Where a.药品id = b.药品id And a.药品id = i.Id And a.药品id = n.收费细目id(+) And n.性质(+) = 3 And a.No = No_In And a.单据 = 6 And
            a.药品id + 0 = 药品id_In And Mod(a.记录状态, 3) = 0 And Nvl(a.批次, 0) = 0 And a.序号 = 序号_In And
            ((Nvl(b.药库分批, 0) = 1 And
            a.库房id Not In (Select 部门id From 部门性质说明 Where (工作性质 Like '%药房') Or (工作性质 Like '制剂室'))) Or
            Nvl(b.药房分批, 0) = 1) And Rownum = 1;
    Exception
      When Others Then
        v_Druginf := '';
    End;
  
    If v_Druginf Is Not Null Then
      Raise Err_Isbatch;
    End If;
  
    Select Sum(a.实际数量) As 剩余数量, Sum(a.成本金额) As 剩余成本金额, Sum(a.零售金额) As 剩余零售金额, a.成本价, a.零售价, a.对方部门id, Nvl(a.批次, 0),
           b.药库分批, b.药房分批, a.批准文号
    Into v_剩余数量, v_剩余成本金额, v_剩余零售金额, v_成本价, v_零售价, v_库房id, v_批次, v_药库分批, v_药房分批, v_批准文号
    From 药品收发记录 A, 药品规格 B
    Where a.No = No_In And a.药品id = b.药品id And a.单据 = 6 And a.药品id = 药品id_In And a.序号 = 序号_In
    Group By a.成本价, a.零售价, a.对方部门id, Nvl(a.批次, 0), b.药库分批, b.药房分批, a.批准文号;
  
    --V_分批:(原分批,现分批为批次;否则为零)原不分批,现分批,本过程不考虑
    --因为对于对方库房，相当于出库，而对于当前库房，相当于入库，所以当前库房不予检查，仅检查退库那条记录
    Select Nvl(a.批次, 0)
    Into v_批次
    From 药品收发记录 A
    Where a.No = No_In And a.单据 = 6 And a.药品id = 药品id_In And a.序号 = 序号_In + 1 And Mod(a.记录状态, 3) = 0;
  
    --冲销数量大于剩余数量，不允许
    If v_剩余数量 < 冲销数量_In Then
      Raise Err_Isnonum;
    End If;
  
    v_成本金额 := Round(冲销数量_In / v_剩余数量 * v_剩余成本金额, Intdigit);
    v_零售金额 := Round(冲销数量_In / v_剩余数量 * v_剩余零售金额, Intdigit);
    v_差价     := v_零售金额 - v_成本金额;
  
    For v_药品收发记录 In c_药品收发记录 Loop
    
      Select 药品收发记录_Id.Nextval Into v_收发id From Dual;
      Insert Into 药品收发记录
        (ID, 记录状态, 单据, NO, 序号, 库房id, 对方部门id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 填写数量, 实际数量, 成本价, 成本金额, 零售价, 零售金额, 差价,
         摘要, 填制人, 填制日期, 审核人, 审核日期, 配药人, 配药日期, 供药单位id, 批准文号, 生产日期, 扣率, 单量, 频次)
      Values
        (v_收发id, Decode(原记录状态_In, 1, 2, 原记录状态_In + 2), 6, No_In, v_药品收发记录.序号, v_药品收发记录.库房id, v_药品收发记录.对方部门id,
         v_药品收发记录.入出类别id, v_药品收发记录.入出系数, 药品id_In, v_药品收发记录.批次, v_药品收发记录.产地, v_药品收发记录.批号, v_药品收发记录.效期, -冲销数量_In, -冲销数量_In,
         v_成本价, -v_成本金额, v_零售价, -v_零售金额, -v_差价, 摘要_In, 填制人_In, 填制日期_In, Null, Null, v_药品收发记录.配药人, v_药品收发记录.配药日期,
         v_药品收发记录.供药单位id, v_药品收发记录.批准文号, v_药品收发记录.生产日期, v_药品收发记录.扣率, v_药品收发记录.单量, v_药品收发记录.频次);
    
      --处理库存，原入的那笔相当于出库
      If v_药品收发记录.入出系数 = 1 Then
        Zl_药品库存_Update(v_收发id, 0, 1);
      End If;
    
      If v_药品收发记录.入出系数 = -1 Then
        v_库房id := v_药品收发记录.库房id;
      End If;
    End Loop;
    --插入未审药品记录
    Zl_未审药品记录_Update(0, 6, No_In, v_库房id, 填制日期_In);
  
  Elsif 冲销方式_In = 2 Then
    --审核已产生的冲销申请单据，填写审核人、审核日期，更新库存记录
    For v_药品收发记录 In c_冲销申请记录 Loop
      --填写审核人、审核日期
      Update 药品收发记录
      Set 审核人 = 填制人_In, 审核日期 = 填制日期_In
      Where NO = No_In And 单据 = 6 And ID = v_药品收发记录.Id;
    
      --更改药品库存表的相应数据，注意这时传入的数量等是负数
      --参数为1表示申请冲销时下可用数量，仅对原移入库房，下了可用数量就不用再更新可用数量了
      If v_药品收发记录.入出系数 = 1 Then
        Zl_药品库存_Update(v_药品收发记录.Id, 3, 1, n_操作类型);
      Else
        Zl_药品库存_Update(v_药品收发记录.Id, 3, 0);
      End If;
    
      If v_药品收发记录.入出系数 = -1 Then
        v_库房id := v_药品收发记录.库房id;
      
        --删除未审药品记录
        Zl_未审药品记录_Update(1, 6, No_In, v_库房id);
      End If;
    
      --处理调价后冲销
      Zl_药品收发记录_调价修正(v_药品收发记录.Id);
    End Loop;
  Else
    --正常冲销方式，产生冲销记录，填写审核人、审核日期，更新库存记录
    If 行次_In = 1 Then
      Update 药品收发记录
      Set 记录状态 = Decode(原记录状态_In, 1, 3, 原记录状态_In + 3)
      Where NO = No_In And 单据 = 6 And 记录状态 = 原记录状态_In;
      If Sql%RowCount = 0 Then
        Raise Err_Isstriked;
      End If;
    End If;
  
    --主要针对原不分批现在分批的药品，不能对其冲销
    Begin
      Select Distinct '(' || i.编码 || ')' || Nvl(n.名称, i.名称) As 药品信息
      Into v_Druginf
      From 药品收发记录 A, 药品规格 B, 收费项目目录 I, 收费项目别名 N
      Where a.药品id = b.药品id And a.药品id = i.Id And a.药品id = n.收费细目id(+) And n.性质(+) = 3 And a.No = No_In And a.单据 = 6 And
            a.药品id + 0 = 药品id_In And Mod(a.记录状态, 3) = 0 And Nvl(a.批次, 0) = 0 And a.序号 = 序号_In And
            ((Nvl(b.药库分批, 0) = 1 And
            a.库房id Not In (Select 部门id From 部门性质说明 Where (工作性质 Like '%药房') Or (工作性质 Like '制剂室'))) Or
            Nvl(b.药房分批, 0) = 1) And Rownum = 1;
    Exception
      When Others Then
        v_Druginf := '';
    End;
  
    If v_Druginf Is Not Null Then
      Raise Err_Isbatch;
    End If;
  
    Select Sum(a.实际数量) As 剩余数量, Sum(a.成本金额) As 剩余成本金额, Sum(a.零售金额) As 剩余零售金额, a.成本价, a.零售价, a.对方部门id, Nvl(a.批次, 0),
           b.药库分批, b.药房分批, a.批准文号
    Into v_剩余数量, v_剩余成本金额, v_剩余零售金额, v_成本价, v_零售价, v_库房id, v_批次, v_药库分批, v_药房分批, v_批准文号
    From 药品收发记录 A, 药品规格 B
    Where a.No = No_In And a.药品id = b.药品id And a.单据 = 6 And a.药品id = 药品id_In And a.序号 = 序号_In
    Group By a.成本价, a.零售价, a.对方部门id, Nvl(a.批次, 0), b.药库分批, b.药房分批, a.批准文号;
  
    --V_分批:(原分批,现分批为批次;否则为零)原不分批,现分批,本过程不考虑
    --因为对于对方库房，相当于出库，而对于当前库房，相当于入库，所以当前库房不予检查，仅检查退库那条记录
    Select Nvl(a.批次, 0)
    Into v_批次
    From 药品收发记录 A
    Where a.No = No_In And a.单据 = 6 And a.药品id = 药品id_In And a.序号 = 序号_In + 1 And Mod(a.记录状态, 3) = 0;
  
    --冲销数量大于剩余数量，不允许
    If v_剩余数量 < 冲销数量_In Then
      Raise Err_Isnonum;
    End If;
  
    v_成本金额 := Round(冲销数量_In / v_剩余数量 * v_剩余成本金额, Intdigit);
    v_零售金额 := Round(冲销数量_In / v_剩余数量 * v_剩余零售金额, Intdigit);
    v_差价     := v_零售金额 - v_成本金额;
  
    For v_药品收发记录 In c_药品收发记录 Loop
      Select 药品收发记录_Id.Nextval Into v_收发id From Dual;
      Insert Into 药品收发记录
        (ID, 记录状态, 单据, NO, 序号, 库房id, 对方部门id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 填写数量, 实际数量, 成本价, 成本金额, 零售价, 零售金额, 差价,
         摘要, 填制人, 填制日期, 审核人, 审核日期, 配药人, 配药日期, 供药单位id, 批准文号, 生产日期, 扣率, 单量, 频次)
      Values
        (v_收发id, Decode(原记录状态_In, 1, 2, 原记录状态_In + 2), 6, No_In, v_药品收发记录.序号, v_药品收发记录.库房id, v_药品收发记录.对方部门id,
         v_药品收发记录.入出类别id, v_药品收发记录.入出系数, 药品id_In, v_药品收发记录.批次, v_药品收发记录.产地, v_药品收发记录.批号, v_药品收发记录.效期, -冲销数量_In, -冲销数量_In,
         v_成本价, -v_成本金额, v_零售价, -v_零售金额, -v_差价, 摘要_In, 填制人_In, 填制日期_In, 填制人_In, 填制日期_In, v_药品收发记录.配药人, v_药品收发记录.配药日期,
         v_药品收发记录.供药单位id, v_药品收发记录.批准文号, v_药品收发记录.生产日期, v_药品收发记录.扣率, v_药品收发记录.单量, v_药品收发记录.频次);
    
      --更改药品库存表的相应数据
      If v_药品收发记录.入出系数 = 1 Then
        Zl_药品库存_Update(v_收发id, 3, 1, n_操作类型);
      Else
        Zl_药品库存_Update(v_收发id, 3, 0);
      End If;
    
      --处理调价后冲销
      Zl_药品收发记录_调价修正(v_收发id);
    End Loop;
  End If;
Exception
  When Err_Isstriked Then
    Raise_Application_Error(-20101, '[ZLSOFT]该单据已经被他人冲销！[ZLSOFT]');
  When Err_Isbatch Then
    Raise_Application_Error(-20102, '[ZLSOFT]该单据中包含有一条原来不分批，现在分批的药品[' || v_Druginf || ']，不能冲销！[ZLSOFT]');
  When Err_Isnonum Then
    Raise_Application_Error(-20103, '[ZLSOFT]该单据中第' || Ceil(序号_In / 2) || '行的药品冲销的数量大于了剩余的数据，不能冲销！[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_药品移库_Strike;
/

---------------------------------------------------------------------------------------------------
--更改系统及部件的版本号
-------------------------------------------------------------------------------------------------------
--107306:涂建华,2017-03-20,调整pacs智能报告编辑器升级路径
Update zlFilesUpgrade Set 安装路径='[APPSOFT]\Pacs\PacsEditor', 自动注册=0 Where Upper(文件名)='ZLPACSCONTROL.DLL';
--00000:刘硕,2017-3-31,部件类型调整
update zlfilesupgrade set 强制覆盖 = 0, 自动注册 = 0, 文件类型 = 5 where upper(文件名) in ('MSXML6.DLL', 'COMDLG32.DLL', 'MSSCRIPT.OCX','MSXML3.DLL', 'SCRRUN.DLL');
update zlfilesupgrade set 强制覆盖 = 0, 自动注册 =1, 文件类型 = 5 where upper(文件名)='MSINET.OCX';

--104825:黄捷,2017-04-07,RIS接口中医嘱窗体修改成独立exe
Insert Into Zlfilesupgrade
  (文件类型, 文件名, 版本号, 修改日期, 所属系统, 业务部件, 安装路径, 文件说明, 强制覆盖, 自动注册, 加入日期, 序号)
  Select 1, 'ZL9XWINTERFACE.DLL', '', Null, '1,21', 'ZLSVRSTUDIO.EXE,ZLHIS+.EXE,zl9BaseItem.dll,zl9CISJob.dll,zl9PACSWork.dll,zlCISKernel.dll,zl9peimanage.dll', '[APPSOFT]\APPLY', 'XWRIS接口部件', '1', '1',
         Sysdate, 序号
  From Dual a, (Select Max(To_Number(序号)) + 1 序号 From Zlfilesupgrade) b
  Where Not Exists (Select 1 From Zlfilesupgrade Where Upper(文件名) = 'ZL9XWINTERFACE.DLL');

Insert Into Zlfilesupgrade
  (文件类型, 文件名, 版本号, 修改日期, 所属系统, 业务部件, 安装路径, 文件说明, 强制覆盖, 自动注册, 加入日期, 序号)
  Select 1, 'ZLSOFTSHOWHISFORMS.EXE', '', Null, '1', 'zl9XWInterface.dll', '[APPSOFT]\APPLY',
         'RIS查看HIS中电子病历，门诊医嘱，住院医嘱等功能的独立exe程序', '1', '0', Sysdate, 序号
  From Dual a, (Select Max(To_Number(序号)) + 1 序号 From Zlfilesupgrade) b
  Where Not Exists (Select 1 From Zlfilesupgrade Where Upper(文件名) = 'ZLSOFTSHOWHISFORMS.EXE');

--101826:余伟节,2017-05-06,住院一览部件
Insert Into zlFilesUpgrade
  (文件类型, 文件名, 版本号, 修改日期, 所属系统, 业务部件, 安装路径, 文件说明, 强制覆盖, 自动注册, 加入日期, 序号)
  Select 4, 'ZLSoft.BusinessHome.ClientControl.TimeLineBase.tlb', '', Null, '1', 'zl9CISJOB.dll', '[PUBLIC]',
         '提供住院一览数据展现功能', '1', '1', Sysdate, 序号
  From Dual A, (Select NVL(Max(To_Number(序号)),0) + 1 序号 From zlFilesUpgrade) B
  Where Not Exists
   (Select 1 From zlFilesUpgrade Where Upper(文件名) = Upper('ZLSoft.BusinessHome.ClientControl.TimeLineBase.tlb'));

Insert Into zlFilesUpgrade
  (文件类型, 文件名, 版本号, 修改日期, 所属系统, 业务部件, 安装路径, 文件说明, 强制覆盖, 自动注册, 加入日期, 序号)
  Select 4, 'ZLSoft.BusinessHome.ClientControl.TimeLineBase.dll', '', Null, '1', 'zl9CISJOB.dll', '[PUBLIC]',
         '提供住院一览数据展现功能', '1', '1', Sysdate, 序号
  From Dual A, (Select NVL(Max(To_Number(序号)),0) + 1 序号 From zlFilesUpgrade) B
  Where Not Exists
   (Select 1 From zlFilesUpgrade Where Upper(文件名) = Upper('ZLSoft.BusinessHome.ClientControl.TimeLineBase.dll'));

--zlfiles
EXECUTE Zlfiles_Autoupdate('7CACKY16.DLL','5BC90529B6E4C1AC842E97A847DE969F',Null,To_Date('2000-03-29 10:51:46', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'语音报价接口文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('7CACKY95.DLL','EAC9442E0D695FBC41E863BAB377407C',Null,To_Date('2000-03-22 20:10:56', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'语音报价接口文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('7CADSBNT.DLL','D77A5058DB6930BC9E8DD7C44BD8C74F',Null,To_Date('2000-03-28 11:48:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'语音报价接口文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('7Z.DLL','E3C7BC97672CDEB280DD43F2A69776BB','9.20.0.0',To_Date('2011-03-30 11:44:26', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'7-ZIP压缩程序',0,0,Null);
EXECUTE Zlfiles_Autoupdate('7Z.EXE','7083BA03D91F9D76CC659F973F14F839','9.20.0.0',To_Date('2011-03-30 11:44:26', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'7-ZIP压缩程序',0,0,Null);
EXECUTE Zlfiles_Autoupdate('AAMD532.DLL','CEFD956A1EF122CDA4D53007BAB6C694','1.0.0.1',To_Date('2011-09-27 11:15:40', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[System]',Null,Null,'Almeida & Andrade Ltda MD5 Maker DLL',0,0,Null);
EXECUTE Zlfiles_Autoupdate('Anigif.ocx','769D2ADF8126AA2A319EF5C3A7462ABE','2.4.3.0',To_Date('2012-04-20 10:25:26', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('BEIJING_TAX.DLL','F75E7082787D499BDA01B6ECB37ACF03','1.0.0.0',To_Date('2004-05-26 10:00:26', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'北京医疗行业外挂式税控器开票API接口库',1,0,Null);
EXECUTE Zlfiles_Autoupdate('C1REGSVR.EXE','F408A0E2369427403299BC63EE273C0C',Null,To_Date('2004-10-01 10:26:56', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'ComponentOne Chart 2D的注册程序',0,0,Null);
EXECUTE Zlfiles_Autoupdate('CKY32.DLL','9FB806B837B3781C3F24EF26E5FE8C6A',Null,To_Date('2001-12-26 11:23:48', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'语音报价接口文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('CKY95H.DLL','E969175463B1AED7D1333EFF9440491E',Null,To_Date('2005-01-10 11:27:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'语音报价接口文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('CM.DLL','596D744BEB23A50BCEAD721452B75077','1.10.0.1',To_Date('2000-09-20 15:42:18', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'快速和方便的C++运算功能库，LIS使用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.COMMANDBARS.9600.LIC','ED46DCDCF57502AEAA7BE86D252F437B',Null,To_Date('2005-12-23 07:53:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX License',0,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.COMMANDBARS.9600.OCX','CABB63F5268AA4FD0D097743ABD903F1','9.6.0.0',To_Date('2005-12-23 07:53:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX，公用界面控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.COMMANDBARS.UNICODE.9600.OCX','809AFFE35F156F1AFE034A6619CAA512','9.6.0.0',To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX，公用界面控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.DOCKINGPANE.9600.LIC','3A676CD407912795EAF5237CFB5AC227',Null,To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX License',0,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.DOCKINGPANE.9600.OCX','DA1C0D8AC594334A25D03A089C88D356','9.6.0.0',To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX，公用界面控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.DOCKINGPANE.UNICODE.9600.OCX','067A890FC0FA47DB4A5253F9401FC2EA','9.6.0.0',To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX，公用界面控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.PROPERTYGRID.9600.LIC','8AA50250F7A5771E8868B08643032F30',Null,To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX License',0,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.PROPERTYGRID.9600.OCX','A59F212A58789CB0041AD6D6C9DFE9C4','9.6.0.0',To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX，公用界面控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.PROPERTYGRID.UNICODE.9600.OCX','5A5C9DB738260CF7386732CB1A2BE7BD','9.6.0.0',To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX，公用界面控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.REPORTCONTROL.9600.LIC','FD979FF45D93E43B9527E420A6BB531D',Null,To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX License',0,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.REPORTCONTROL.9600.OCX','FAD0A8D707F057AF7B0388DB99409409','9.6.0.0',To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX，公用界面控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.REPORTCONTROL.UNICODE.9600.OCX','93C69111E3EB48D3A2BE3612C3BCA11E','9.6.0.0',To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX，公用界面控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.SUITECTRLS.9600.LIC','30089843FEDBE8FD2F66BD536CB12DB1',Null,To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX License',0,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.SUITECTRLS.9600.OCX','B72B2DD6B5810F48D6FD1F1136166B6E','9.6.0.0',To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX，公用界面控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('CODEJOCK.SUITECTRLS.UNICODE.9600.OCX','9B0B4585A130DCA83436A12AD6386CC3','9.6.0.0',To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX，公用界面控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('CTS2R.DLL','D0DC712EC17AC883B2F5EEEEF4B086A5',Null,To_Date('2003-07-17 09:53:58', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'NJF-VH语音报价接口文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('CTSVR.EXE','5E7FBB0B5070E73620AD725F9F6028B7','1.0.0.1',To_Date('2010-04-27 14:04:30', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'NJF-VH语音报价接口文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('Codejock.SyntaxEdit.v15.3.1.lic','26046FB1E5310C24FF62EC9B2FC79C0F',Null,To_Date('2014-09-10 16:33:02', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Xtreme CommandBars ActiveX Control 15.3.1的许可文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('Codejock.SyntaxEdit.v15.3.1.ocx','7010CEB71C0AEAFFE49A16EF5A27E582','15.3.1.0',To_Date('2014-09-10 16:33:04', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Xtreme CommandBars ActiveX Control 15.3.1',1,0,Null);
EXECUTE Zlfiles_Autoupdate('Crcdes.dll','95B6B837D8454841F23EFB8146F70427',Null,To_Date('2002-06-09 17:35:48', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('Crwicc.dll','021E3D2EEF171A651D28B24A960D0276',Null,To_Date('2002-06-09 17:35:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('DICOMOBJECTS.LIC','596DE9629453A9EBF6963492B6A79122',Null,To_Date('2004-10-01 10:23:28', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'DicomObjects注册文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('DICOMOBJECTS.OCX','09A8853D33F1DD50C04C5B3920DD0F49','4.3.82.2',To_Date('2009-10-21 16:07:52', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'DicomObjects，PACS观片站使用',1,0,Null);
EXECUTE Zlfiles_Autoupdate('DVDPROX2.DLL','9E71EFB14917D41448ECC43AAECCAB51','1.0.0.8',To_Date('2006-07-05 11:13:48', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'DVDWriterPro2 ActiveX Control，PACS使用',1,0,Null);
EXECUTE Zlfiles_Autoupdate('EZTW32.DLL','F0E99175D1F85098CD23D54ED7C9B761',Null,To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'扫描仪API，电子病历使用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('FINDFILE.AVI','416F9E50BA85BC43A5EB464AB74F6151',Null,To_Date('1998-04-24 00:00:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('FLASH.OCX','C917184D61A06B1E144AB48EB4AE43C1','6.0.23.0',To_Date('2002-07-14 16:10:38', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Macromedia Flash Player ActiveX Control，导诊，LED使用。',0,0,Null);
EXECUTE Zlfiles_Autoupdate('FLASH9F.OCX','48FDF435B8595604E54125B321924510','9.0.124.0',To_Date('2008-03-25 10:32:42', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[System]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('FTP_TRANS.DLL','1EE7A40E279D3036EFAEF2F4C63033FC',Null,To_Date('2002-06-09 17:35:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'FTP传输、加密API库，医保使用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('Gapi32.dll','DCA8111D07CADD143207FBA3C2CA4B98','4.0.994.25',To_Date('1998-04-24 00:00:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('HASHCTL.DLL','A33B99621F6AA045F14EC8A263CC3A03','10.0.2316.0',To_Date('2003-06-25 10:31:24', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[System]',Null,Null,Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('HOSP_INTERFACE_FYPROJ.OCX','043A05A17EA272E87E89DDB78C434B63',Null,To_Date('2002-08-01 11:36:42', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[System]',Null,Null,Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('ICAPI.DLL','09F7414ECEEF633B972DFCE5A3D233F8',Null,To_Date('2002-07-22 10:21:08', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'中软医保接口API库',0,0,Null);
EXECUTE Zlfiles_Autoupdate('ICREAD.DLL','A2F1668C08DF5BE7A945F886F57DA0D8',Null,To_Date('2002-06-09 17:35:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'医保用的IC卡读卡API接口库',0,0,Null);
EXECUTE Zlfiles_Autoupdate('ICWRITE.DLL','944C8EFC0F69DC83FF4FFFA8971CDF57',Null,To_Date('2002-06-09 17:35:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'医保用的IC卡写卡API接口库',0,0,Null);
EXECUTE Zlfiles_Autoupdate('IME.EXE','6242B69581D9CF830BE82632F655775D','4.0.1381.1',To_Date('2014-10-16 16:58:54', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\TOOLS',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('IMGCMN.DLL','229997F4C39A5304378FDA4A8374FDB1','5.0.2134.1',To_Date('2010-03-29 17:43:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('IMGSCAN.OCX','3CFA184C981CE73EF8BF7DAE05CD89FE','5.0.2134.1',To_Date('2010-03-29 17:43:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak Image Scan for Windows，PACS使用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('IMGSHL.DLL','A54B4B5473CDC0ABC8F1DB095FC9D489','5.0.2134.1',To_Date('2010-03-29 17:43:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('INMONEYONLINE.DLL','FE0580F5F7BCDFCBD33F8922FEEE30F8',Null,To_Date('2002-09-05 16:14:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'医保用的IC卡处理API接口库',0,0,Null);
EXECUTE Zlfiles_Autoupdate('ISHF_EX.TLB','07934C956B971F10B7F73D55239AB976',Null,To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'IShellFolder Extended Type Library 1.2，病历编辑器和表格病历使用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('JPEG1X32.DLL','1E7919CC2305C6F15E0DC476B0440686','4.10.0.2000',To_Date('2010-03-29 17:43:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('JPEG2X32.DLL','8E73DD953D4A6FA116B2CE4CB7647B0D','4.10.0.2000',To_Date('2010-03-29 17:43:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('LAME_ENC.DLL','803B4ABFE7552D12640E292159F2280C',Null,To_Date('2010-12-28 16:20:24', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[System]',Null,Null,'视频采集支持文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('LNCATOOLKITS.OCX','096D3A2C35AD2D1599993608A5B17794','2.5.0.1',To_Date('2005-11-18 17:01:52', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'辽宁CA电子签名接口控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('LSOUND.DIC','4CC6D271CE620C06049D43A9A0511634',Null,To_Date('2009-05-19 14:14:56', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'排队叫号语音库',0,0,Null);
EXECUTE Zlfiles_Autoupdate('MSINET.OCX','90A39346E9B67F132EF133725C487FF6','6.1.97.82',To_Date('2013-05-02 10:13:26', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),5,'[System]',Null,Null,'Microsoft Internet Transfer Control，自动升级、PACS等使用',1,0,Null);
EXECUTE Zlfiles_Autoupdate('MSSTKPRP.DLL','D08A99C462298C041139789627168A0B','6.0.81.69',To_Date('1998-06-18 00:00:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[System]',Null,Null,Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('Msprpchs.dll','92930846270F378F23A4BB1F206FC79E','6.0.81.63',To_Date('1998-07-29 00:00:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('OIADM400.DLL','1A6E7C331F871E8099F544D2F81A6E74','4.10.0.2000',To_Date('2010-03-29 17:43:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OICOM400.DLL','8F9693CD3BBECE1A12B151927C9DEE9A','4.10.0.2000',To_Date('2010-03-29 17:43:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:15', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OIDIS400.DLL','89D0BD8C2E9C3596B97D47FAE11CCCE1','4.10.0.2000',To_Date('2010-03-29 17:43:36', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OIENG400.DLL','931764D251736C753E821222D7C0824A','5.0.2134.1',To_Date('2010-03-29 17:43:36', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OIFIL400.DLL','CCCB9B2E0DDB66953202A991E9E717B6','4.10.0.2000',To_Date('2010-03-29 17:43:36', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OIGFS400.DLL','683521ADC21EE6C668518FE650464F15','4.10.0.2000',To_Date('2010-03-29 17:43:36', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OIPRT400.DLL','CCA69D3352246AA42CA9A32F4E7705A3','5.0.2134.1',To_Date('2010-03-29 17:43:36', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OISLB400.DLL','512956CB4ACEB022BBA873518E34BBDE','5.0.2134.1',To_Date('2010-03-29 17:43:38', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OISSQ400.DLL','1E73D6F4ADDB4148377D89AD0203872D','5.0.2134.1',To_Date('2010-03-29 17:43:38', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OITWA400.DLL','CDCF612BE58C12C32BBA4F8A97C76AF9','5.0.2134.1',To_Date('2010-03-29 17:43:38', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OIUI400.DLL','2663E07C8D3E2D0B015A6C3C4351CB65','5.0.2134.1',To_Date('2010-03-29 17:43:38', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Kodak扫描控件支持库，影像采集对Twain接口的支持',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OLCH2X8.OCX','4A6E99A3FD8EC2B0E0D5D3A2F2A6D219','8.0.20043.45',To_Date('2004-10-01 10:26:56', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'ComponentOne Chart 2D 8.0 OLE/ActiveX，自定义报表、LIS等使用',1,0,Null);
EXECUTE Zlfiles_Autoupdate('OLEGUIDS.TLB','21699843C3F8594D68263645ECE51DD3',Null,To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Ole Guid  and Interface  Definitions，电子病历使用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('OLELIB.TLB','ABA5F3549C922EA6B1BB9F8226C78362',Null,To_Date('2009-09-03 13:02:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Edanmo-s OLE interface & functions v1.81，LIS、电子病历使用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('PDFTOTEXT.DLL','8C9F672996B03CE91678094F584CAED6','1.7.7.14',To_Date('2013-11-19 14:13:52', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),4,'[System]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('QRMAKER.LIC','29C08475686167BBD20F1D3A0E8F053E',Null,To_Date('2013-11-19 14:13:28', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Microsoft Internet Transfer Control，自动升级、PACS等使用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('QRMAKER.OCX','C00A0B76BC515DAA01060F7F9A230D0D','1.31.0.0',To_Date('2013-11-19 14:13:28', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Microsoft Internet Transfer Control，自动升级、PACS等使用',1,0,Null);
EXECUTE Zlfiles_Autoupdate('READBARCOMM.DLL','8BDFF3C6AC2ECC26503016D51C948257','1.0.0.1',To_Date('2005-01-11 10:20:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'海量公司二维条码识别控件，医保用',1,0,Null);
EXECUTE Zlfiles_Autoupdate('SHLEXT.TLB','FD0EBEFD50F7AD036F9DAA93715A285B',Null,To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Shell Extension Interfaces v1.01，病历编辑器和表格病历使用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('SQLite3.dll','8A1CBAE63FC06EDAEDCCE1B23E9C9267','3.7.5.111',To_Date('2014-07-15 14:27:22', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'SQLite相关支持文件',0,1,Null);
EXECUTE Zlfiles_Autoupdate('SSMDRAW.DLL','9256921D458CD02E6706DACA57771BB3','1.0.0.1',To_Date('2009-02-16 11:14:14', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Graphic Process DLL，LIS用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('SSMG7.DLL','1FA6998784F256AC8D56B73F2D15024F','1.0.0.0',To_Date('2005-01-19 21:40:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'GIF图形处理工具，LIS用',0,0,Null);
EXECUTE Zlfiles_Autoupdate('STRSOUND.DLL','C66CBE7551F0E70C6379DCBDA6167D55','1.0.0.1',To_Date('2009-05-19 14:14:56', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'排队叫号语音输出程序',0,0,Null);
EXECUTE Zlfiles_Autoupdate('Sdtapi.dll','1640584FF35B1B9820E28DE5C8C59F4B',Null,To_Date('2011-06-24 10:53:56', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('Sqlite36_engine.dll','0C9BA5358338BC4A141F0F2D1E83B275',Null,To_Date('2014-07-15 14:27:22', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'SQLite引擎文件',0,1,Null);
EXECUTE Zlfiles_Autoupdate('TTF16.OCX','AE9B2EE1564B46045E078D4618C2834E','6.1.4.1',To_Date('2001-06-28 19:42:54', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Formula One OLE Control，主要是表格病历使用',1,0,Null);
EXECUTE Zlfiles_Autoupdate('UNZIP32.DLL','8326C4DCD9EBD90ED4C0C14FBAAAC1C3','1.1.0.0',To_Date('2002-06-09 17:35:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Info-ZIP-s UnZip Windows DLL',0,0,Null);
EXECUTE Zlfiles_Autoupdate('VSFLEX8.OCX','46DD6C80DCCDB51F83FBDC8CB739B6ED','8.0.20041.202',To_Date('2006-08-09 12:03:48', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'ComponentOne VSFlexGrid 8 (OLEDB/ADO)，公用控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('VSPRINT8.OCX','61B0322CAAB5646A7DBE2DE794A00AF7','8.0.20082.148',To_Date('2009-09-03 13:02:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'ComponentOne VSPrinter8 Control，LIS使用',1,0,Null);
EXECUTE Zlfiles_Autoupdate('WBX.TXT','BBFDF552D55B81FE987A9D816B4B9846',Null,To_Date('2003-01-20 14:17:36', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('WINCMP3.EXE','4A8C0E6B9E9537418FAADAB1223376AE','4.2.0.2221',To_Date('2013-11-19 14:13:54', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),4,'[System]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('Wltrs.dll','0F50CAABFB6CF343B65DC6594D495175',Null,To_Date('2011-06-24 10:53:58', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('XCDZIP35.OCX','E2259545A6EDABFABF613CB7BE765CDA','3.5.0.0',To_Date('2004-06-18 09:10:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Xceed Zip ActiveX Control，收费价格导入用',1,0,Null);
EXECUTE Zlfiles_Autoupdate('XTPRESOURCEZHCN.DLL','C241E8B935C2B35763FEAAB2209AADBC',Null,To_Date('2005-12-23 07:53:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Codejock Xtreme Suite Pro ActiveX 中文语言文件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('XTXAPPCOM.DLL','8829809B322B2479550FB174A80B7487','2.0.1.5',To_Date('2013-01-22 10:06:20', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[System]',Null,Null,'Microsoft Internet Transfer Control，自动升级、PACS等使用',1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZIP32.DLL','65B137E17EE7D9E400B7AB20C55F8FCF','1.1.0.0',To_Date('2002-06-09 17:35:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'Info-ZIP-s Zip dll',0,0,Null);
EXECUTE Zlfiles_Autoupdate('ZL9BillEdit.ocx','8EE6B672D9FB072D9C09141CC8DE9ADD','10.35.40',To_Date('2017-03-06 14:46:08', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'表格控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZL9Insure.dll','23E5C485A24E7A7CDF98E39DD83DA9EB','10.35.50',To_Date('2017-05-05 10:16:40', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'医保部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZL9LABWork.dll','48FDEE322534802EED9F4A08C633AA2A','10.35.50',To_Date('2017-05-05 09:47:19', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'25','新版LIS不仅安',1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZL9LisInsideComm.dll','A094C906491E250642583BD40AE61C1E','10.35.50',To_Date('2017-05-05 09:45:11', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1,22,21,25','新版LIS与HIS接口部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZL9PACSIMAGECAP.DLL','8EB99D9291470BAEBFAC1E68B71F937A','10.35.50',To_Date('2017-05-05 09:41:58', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:25:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[Appsoft]\Apply',Null,'1',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZL9TEMPERATURECHARTSD.dll','F9C1EFE2F8CA33F7BA258A3C917863C3','10.35.40',To_Date('2017-03-08 11:55:03', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Appsoft]\apply',Null,'1','山东省专用体温部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZL9TemperaTureChartYN.Dll','AD4B02A130AEE33ED655E0004E80D222','10.35.40',To_Date('2017-03-08 11:54:30', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Appsoft]\Apply','zl9CISJob.dll','1','云南大理专用体温部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZL9XWINTERFACE.DLL','E722E8A02403F3C10359848C82C86A84','10.35.50',To_Date('2017-05-05 09:52:21', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-05-05 14:54:22', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','ZLSVRSTUDIO.EXE,ZLHIS+.EXE,zl9BaseItem.dll,zl9CISJob.dll,zl9PACSWork.dll,zlCISKernel.dll,zl9peimanage.dll','1,21','XWRIS接口部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('ZLDSVIDEOPROCESS.OCX','915B1465C101552783EF186341BDA99A','1.2.74',To_Date('2016-08-03 14:10:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9CardSquare.dll,zl9PACSWork.dll','1,21,22,24,26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZLFLAG.AVI','4AC428B4D37D58BF77555CDD1EBFCBC4',Null,To_Date('1999-05-21 16:29:08', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('ZLHIS+.exe','ABAB690259237E692999C821E42178F0','10.35.50',To_Date('2017-05-05 09:25:36', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[APPSOFT]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('ZLHISCRUST.EXE','E4DDA39DB45251089C4223EE3BB99430','10.35.50',To_Date('2017-05-05 09:25:19', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[APPSOFT]',Null,Null,'部件升级程序',0,0,Null);
EXECUTE Zlfiles_Autoupdate('ZLLOGIN.DLL','B5B3C55493011FF1FC9E568C84B545D0','10.35.50',To_Date('2017-05-05 09:52:13', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:25:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,'1',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZLNewQuery.exe','5FA646244D3B4AFBF9045810FF7274C1','10.35.50',To_Date('2017-05-05 09:29:13', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]','ZLNewQuery.exe','1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('ZLPacsBrowserStation.exe','8F1D75B19CD6111B66DAAC7C6DB2BCB3','10.35.40',To_Date('2017-03-08 14:48:44', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]','zl9PACSWork.dll','1','独立观片站',0,0,Null);
EXECUTE Zlfiles_Autoupdate('ZLREGISTER.DLL','6453263453491C4CB8CE691E895F4E51','10.35.50',To_Date('2017-05-03 09:23:04', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:25:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,'1',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZLRUNAS.exe','CACE237C26F0699C63828FF3D79B8566','9.43.0',To_Date('2013-11-04 10:14:23', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[APPSOFT]',Null,Null,'该文件在自动升级zlhisCrust.exe中使用。主要功能,在USER权限下可以使用管理员权限来进行登录执行管理操作',0,0,Null);
EXECUTE Zlfiles_Autoupdate('ZLSOFTSHOWHISFORMS.EXE','117D16BBFD14718A59A41B169E0B23BE','10.35.50',To_Date('2017-05-05 09:53:19', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-05-05 14:54:22', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9XWInterface.dll','1','RIS查看HIS中电子病历，门诊医嘱，住院医嘱等功能的独立exe程序',0,1,Null);
EXECUTE Zlfiles_Autoupdate('ZLSoft.BusinessHome.ClientControl.TimeLineBase.dll','E7181C04903EA3430C6C1630785867AB','1.0.0',To_Date('2017-04-18 09:20:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-05-05 14:54:22', 'yyyy-mm-dd HH24:mi:ss'),4,'[Public]','zl9CISJOB.dll','1','提供住院一览数据展现功能',1,1,Null);
EXECUTE Zlfiles_Autoupdate('ZLSoft.BusinessHome.ClientControl.TimeLineBase.tlb','494038A709F7757CDD99C497A97C7C97',Null,To_Date('2017-04-07 09:18:59', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-05-05 14:54:22', 'yyyy-mm-dd HH24:mi:ss'),4,'[Public]','zl9CISJOB.dll','1','提供住院一览数据展现功能',1,1,Null);
EXECUTE Zlfiles_Autoupdate('ZLUZIP10.DLL','90C34787F181708DC15233E06A275CBE','1.1.0',To_Date('2006-04-28 16:48:38', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),0,'[SYSTEM]',Null,Null,'ZIP解压部件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('ZLZIP11.DLL','ABEE1079EA3F3E74C933915BF10A7B9B','1.1.0',To_Date('2006-04-28 16:48:38', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),0,'[SYSTEM]',Null,Null,'ZIP压缩部件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('Zl9DrugStore.dll','737DA20B02D369AEDB6C8ED5080512FA','10.35.50',To_Date('2017-05-05 09:27:57', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','Zl9DrugStore.dll','1','药房处理部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('Zl9LISComm.exe','DBFB7163B45F606E4385F7212DBB0EB1','10.35.50',To_Date('2017-05-05 09:38:45', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]','zl9LisWork.dll','1','老版LIS仪器设置程序',0,0,Null);
EXECUTE Zlfiles_Autoupdate('ZlBrw.dll','6789A979E09681F754A4DC91D19665C9','10.35.50',To_Date('2017-05-05 09:25:37', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[APPSOFT]\APPLY','zl9BaseItem.dll,zl9CISBase.dll,zl9InExse.DLL',Null,'导航台部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZlMdi.dll','20F7EA1E8E9B3194C6A230004DB8CCD1','10.35.50',To_Date('2017-05-05 09:25:56', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[APPSOFT]\APPLY',Null,Null,Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZlPacsSrv.exe','86DBDC2173D24F8708D6C35AAA1BD558','10.35.50',To_Date('2017-05-05 09:40:14', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]','zl9PACSWork.dll','1','PACS网关服务程序',0,0,Null);
EXECUTE Zlfiles_Autoupdate('ZlPatiAddress.ocx','F4653A64B8E6E4559DA0C5E3C455BFBB','10.35.50',To_Date('2017-05-05 09:26:04', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9CISJob.dll,zl9InExse.DLL,zl9InPatient.dll,zl9MedRec.dll','1,3','地址录入控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('ZlWin.dll','3EACF7B75B913727DA278684475EE82E','10.35.50',To_Date('2017-05-05 09:26:02', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[APPSOFT]\APPLY',Null,Null,Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('_sql.schclass','DB00476956C307C75B75808662F482BE',Null,To_Date('2014-09-10 16:33:01', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),4,'[Public]',Null,Null,'SyntaxEdit控件SQL颜色方案配置文件。',0,0,Null);
EXECUTE Zlfiles_Autoupdate('avi.bmp','919525151F3194043A5FD1A9F75B8A07',Null,To_Date('2011-02-11 17:23:58', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('aviDownLoad.bmp','852B762B823B345C939C67CD3D517271',Null,To_Date('2011-02-11 17:24:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('codejock.calendar.v16.3.1.lic','EA1945B52D982049E4CAA7EA28AA9877',Null,To_Date('2016-06-28 11:33:14', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:25:39', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('codejock.calendar.v16.3.1.ocx','78ED7FE2F2076E79AE2E8FA2D40B44CF','16.3.1.0',To_Date('2016-06-28 11:33:16', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:25:39', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('dhRichClient3.dll','9A40975DD04C50B128D9C6D288671054','3.0.0.25',To_Date('2014-07-15 14:27:22', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]',Null,Null,'SQLite相关文件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('vfpodbc.dll','FC0660A47BA63D8FEEEBCFD59069E6D6','6.0.8167.0',To_Date('2013-11-11 09:34:26', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:16', 'yyyy-mm-dd HH24:mi:ss'),4,'[SYSTEM]','zl9MedRec.dll',Null,'该文件为创建dbf文件的驱动文件',0,1,Null);
EXECUTE Zlfiles_Autoupdate('wav.bmp','F9433769970E83406522C0BE89C9E186',Null,To_Date('2011-02-11 17:24:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('wavDownLoad.bmp','F8ADC35B1E3C436D0B1207147359C2DF',Null,To_Date('2011-02-11 17:24:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('zL9Analysis.dll','C447183C678E3D6228DCA6215823D79E','10.35.50',To_Date('2017-05-05 09:26:08', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zL9Analysis.dll','1','查询分析部件（涂建华）？？？',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zL9CashBill.dll','D5CB9E53F28B7B478B00C976B37F666D','10.35.50',To_Date('2017-05-05 09:26:41', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zL9CashBill.dll','1,21','财务监控部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9AppTool.dll','AF158AB011CA2EBB810AB184589EA685','10.35.50',To_Date('2017-05-05 09:24:44', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'字典管理工具',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BaseItem.dll','69F8D80FF3EDB944D839E43889AC64D4','10.35.50',To_Date('2017-05-05 09:27:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9BaseItem.dll','1,3,4,6,21','基础设置部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Blood.dll','7A4416D9D5B358899330C6C9F634E309','10.35.50',To_Date('2017-05-05 09:40:13', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Blood.dll','22','血库系统部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditor.dll','EC89C494C63010EFD147190DCECBFACB','10.35.50',To_Date('2017-05-05 09:42:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll,zl9Oper.dll','1,24','体温单部件（系统自带，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorGS.dll','6DC781CA7DE5E73B0DC5A6AD10C1B643','10.35.50',To_Date('2017-05-05 09:43:44', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','体温单部件（甘肃，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorGX.dll','2E066F19292F6E2AEBAA48FB30006665','10.35.50',To_Date('2017-05-05 09:43:54', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','体温单部件（广西，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorHEN.dll','CE4A01C0C1F1A50A4E67FFB431958C6C','10.35.50',To_Date('2017-05-05 09:44:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','体温单部件（河南，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorHN.dll','874A1769F663D3EEB1D2E3B31190C969','10.35.50',To_Date('2017-05-05 09:43:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','体温单部件（河南，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorHun.dll','65184A010B3019F16BED08B8E29B7697','10.35.50',To_Date('2017-05-05 09:44:49', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','体温单部件（湖南，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorQD.dll','CF456780EF8A251FE4E2EA9702013978','10.35.50',To_Date('2017-05-05 09:44:03', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','体温单部件（青岛，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorSCDQ.dll','2F7990605F928072FA3C10623EE5FD97','10.35.50',To_Date('2017-05-05 09:42:56', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','体温单部件（四川，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorSXHZ.dll','BB52C79240978878AA1F9FC28DC2D162','10.35.50',To_Date('2017-05-05 09:43:25', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','陕西汉中专用体温部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorSxet.dll','7DE86312CB5C411FDB8110BEDA5C88E8','10.35.50',To_Date('2017-05-05 09:44:40', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','体温单部件（陕西儿童医院，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorYDEY.dll','DAA4B45C8D635786B68F9BA03B1A75E9','10.35.50',To_Date('2017-05-05 09:43:03', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','体温单部件（医大二院，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9BodyEditorYX.dll','4520EB148D7CDA08B050F906D77045C6','10.35.50',To_Date('2017-05-05 09:42:43', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','玉溪市人民医院专用体温部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9CISAudit.dll','801C0C0C9EDA3A26D10010AC8DF2A6FF','10.35.50',To_Date('2017-05-05 09:40:35', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISAudit.dll','1','电子病历监控',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9CISBase.dll','B8D4FEB39232B48B606B1C21F4FD9A84','10.35.50',To_Date('2017-05-05 09:39:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISBase.dll','1','基础设置部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9CISCore.dll','63CF7E293A9075EA66CDB46D41945116','10.35.50',To_Date('2017-05-05 10:08:33', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','这几个部件应该是老版医生站相关，是否可以取消？',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9CISJob.dll','967F0762E42A964A17F590C5BEF0715C','10.35.50',To_Date('2017-05-05 09:37:47', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','临床工作站',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9CardSquare.dll','AAF1F2B3E6E433AD523F50F35F6AE01B','10.35.50',To_Date('2017-05-05 09:31:31', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9BaseItem.dll,zl9Blood.dll,zl9CISBase.dll,zl9InExse.DLL,zl9PeisManage.dll','1,21,22,24','一卡通相关部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9ComLib.dll','398D7511239B862F27099A178E21A850','10.35.50',To_Date('2017-05-05 10:07:52', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'公共部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9ComLibpss.dll','1D5D9C88DA0629DCA5C691D1EC2911F6','10.35.50',To_Date('2017-05-05 09:45:57', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9WizardManage.dll','26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9CommEvents.dll','EC167190703A0991F1B36D6844CB9FA9','10.35.50',To_Date('2017-05-05 09:47:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9CardSquare.dll,zl9WizardCards.dll,zl9WizardDeposit.dll,zl9WizardFeeQuery.dll,zl9WizardPayFee.dll,zl9WizardPeisQueue.dll,zl9WizardRegEvent.dll,zlWizardNewLabPrint.dll,zlWizardPacsPrint.dll','1,21,22,24,26','一卡通公共事务部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9CustAcc.dll','BD5A0085B6E46DF809F13195D1A68D79','10.35.50',To_Date('2017-05-05 09:27:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9InExse.DLL,zl9OutExse.dll','1','自定义收费单',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Device.dll','91606EB0953691B14E59F3F22F8883CC','10.35.40',To_Date('2017-04-19 10:58:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Device.dll','6','设备相关部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Disease.dll','FA1153B388D8EE9A4A6D6506E3E95781','10.35.50',To_Date('2017-05-05 16:20:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:25:39', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','疾病报告部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9DrawReport.dll','5567E4488D3AC46BF9BD975737C6E5B9','10.35.50',To_Date('2017-05-05 09:40:36', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Oper.dll,zl9PeisManage.dll','21,24','麻醉单打印和体检报告打印的公共处理程序',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9Due.dll','CD94334AA4552C0E4859EB0E7F99706E','10.35.50',To_Date('2017-05-05 09:28:04', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Due.dll','1,4,6','应付账款部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9ESign.dll','324D6BBA28AF2D331999DD7D1237FCA8','10.35.50',To_Date('2017-05-05 09:24:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'签名部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Function.dll','B33CFB413F256FC16504BC19F964272F','10.35.50',To_Date('2017-05-04 14:10:53', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'函数部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9I_Configure.dll','FBECDADC86437D14A0BB580452CEC522','9.29.0',To_Date('2015-11-30 10:01:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Appsoft]\Apply',Null,'1','医保工具部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9InExse.DLL','C649B320D850D5949824D2C43C4DBAD2','10.35.50',To_Date('2017-05-05 09:33:19', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','住院收费部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9InPatient.dll','0370DC89D432E97F3BD0D00B9A74F5C2','10.35.50',To_Date('2017-05-05 09:28:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','病人入出管理',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Infect.dll','5CFC6895672B43D235476AD2B02E8498','10.35.0',To_Date('2016-04-18 17:36:58', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Infect.dll','23','院感系统部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9LCDShow.dll','476E41EEF820770B9BAD63A4770C037F','10.35.50',To_Date('2017-05-05 09:39:15', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zlQueueManage.dll','1',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9LabPrintSvr.exe','43E16A949D7D38987DE58C756453073E','10.35.20',To_Date('2016-08-17 13:41:51', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]',Null,'25','检验报告打印',0,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9LabReceiv.exe','7CCCB97224392702BD1187F6BEF83F39','10.35.50',To_Date('2017-05-05 09:46:02', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]',Null,'25','新版LIS通讯程序',0,0,'[APPSOFT]\DEV_[*]');
EXECUTE Zlfiles_Autoupdate('zl9LabTcpSvr.exe','96ADDFB20DE9CAD357CE0C56F215E4E1','10.35.0',To_Date('2015-12-01 09:20:47', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]',Null,'25',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9LedVoice.dll','A719270D55B745247CB72C06CBC81B44','10.35.50',To_Date('2017-05-05 09:23:51', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9InExse.DLL,zl9InPatient.dll,zl9OutExse.dll,zl9Patient.dll,zl9RegEvent.dll','1','LED呼叫显示部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9LisQuery_Base.dll','E4AEDCE7605521A7700BE779248FA7E7','10.35.10',To_Date('2016-07-11 16:55:46', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9LisWork.dll','1','新版LIS的自定义查询部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9LisQuery_Dfn.dll','0BE8EEAD6D6EB47F9C63E2685EE955AF','10.35.0',To_Date('2015-12-01 09:06:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9LisWork.dll','1','老版LIS自定义查询部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9LisWork.dll','F8D1FF6F5A331F836F7CCA95F6BAE1D8','10.35.50',To_Date('2017-05-05 09:39:17', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9LisWork.dll','1','老版LIS部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Material.dll','90D1E752C95E9F5382E1591F52FC826B','10.35.40',To_Date('2017-04-19 10:58:43', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Material.dll','4','物资系统部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9MedRec.dll','3134A82C5CB4832B42843F234C493C1C','10.35.50',To_Date('2017-05-05 09:39:47', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9MedRec.dll','3','病案系统部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9MediStore.dll','3CB2162D7D7F3DCC7D5456EF4FAA6CF1','10.35.50',To_Date('2017-05-05 09:29:14', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9MediStore.dll','1','药品流通处理部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Medical.dll','DEB456258A601EA7E6D751F50D6DC129','10.34.0',To_Date('2014-08-26 11:10:17', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','老版体检部件，现在未用可以取消',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Oper.dll','CADF7817E475C3CBF714DC35377DF824','10.35.50',To_Date('2017-05-05 09:41:12', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'24','手麻部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Ops.dll','07D54DAA3207F3FC212407F6224A8AB4','10.34.0',To_Date('2014-10-30 22:33:19', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','老版手麻系统',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9OpsStarand.dll','5BE38ED9CA82CB944262A4886249C385','10.35.3',To_Date('2016-10-31 11:29:25', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'24','麻醉单输出格式',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9OutExse.dll','0D8C0E122163232F9B2C3A77D857D344','10.35.50',To_Date('2017-05-05 09:29:46', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9OutExse.dll','1','门诊收费部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9PACSWork.dll','BC75DCCC8886464E35FB679CC190D439','10.35.50',To_Date('2017-05-05 09:43:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PACSWork.dll','1','PACS工作站部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9PacsCapture.exe','CBDB085A9B92470CD1DA54C7F0985E75','10.35.0',To_Date('2015-12-01 09:17:41', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PACSWork.dll','1','因影像采集系统的视频采集方式优化调整,而独立出来的ActivexExe项目',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9PacsControl.ocx','D5A859E6A24869EC9E2074616F9BD325','10.35.50',To_Date('2017-05-05 09:41:47', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PACSWork.dll','1','因影像采集系统的视频采集方式优化调整,而独立出来的pacs所需组件.',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9PacsCore.dll','9BCF7D2713E1D12D6F1B2B25B3180459','10.35.50',To_Date('2017-05-05 09:41:41', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PACSWork.dll,zl9PeisManage.dll','1,21','观片站部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Partogram.dll','F0973870CE85E0A0CF917D34191E8C51','10.35.0',To_Date('2016-04-18 10:49:33', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','产程图专用部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Patient.dll','3A62AE6832C01E06E59E3732C65F0C01','10.35.50',To_Date('2017-05-05 09:30:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Patient.dll','1','病人管理部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisBase.dll','1762FE38BE59F2A00E49A6374AF2D6EC','10.35.50',To_Date('2017-05-05 09:51:38', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PeisManage.dll','21','体检基础业务',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisComLib.dll','48E9EBD9A0686F625F618FE9DEA17854','10.35.50',To_Date('2017-05-05 10:14:39', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9PeisManage.dll','21','体检公共资源部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisDevAnalyse.dll','191FB33503B62F5F44588EFB0B4606E6','10.35.0',To_Date('2015-12-01 09:22:53', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PeisManage.dll','21','体检外接仪器接口（非标准的接口）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisFlow.dll','63620597B8A5B84D79CBE8FADF6A1783','10.35.50',To_Date('2017-05-05 09:50:25', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PeisManage.dll','21','体检执行业务',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisInnerInterface.dll','A40B4B997CDA5DBF4310EE2E8BAA40BF','10.35.50',To_Date('2017-05-05 09:49:38', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PeisManage.dll','21','体检内部接口',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisInstrument.dll','E72B4A469D1F491BB4DA1E110169A4E2','10.35.0',To_Date('2015-12-01 09:20:44', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PeisManage.dll','21','体检外接仪器接口（准的串口接口）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisInterface.dll','5D11046D018DC68AFA609A416FC4A8EF','10.35.50',To_Date('2017-05-05 09:43:15', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PeisManage.dll','21','第三方体检接口部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisManage.dll','15D8916AD0D21DEE83E904E8DD207007','10.35.50',To_Date('2017-05-05 10:10:12', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'21','体检管理业务部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisPersonPDF.dll','12B8F8E1E95B4E92825AB13DED21E73F','10.35.50',To_Date('2017-05-05 09:52:01', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLy',Null,'21','体检个人报告（PDF格式）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisPersonReport.dll','65C72A123DC8ACBDC53A442E0652FCE8','10.35.50',To_Date('2017-05-05 09:51:57', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'21','体检个人报告中的一种格式，专门用于处理报表类的个人报告',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisPersonRpt.dll','6B804D8AD577305A04F233B8FA91F61E','10.35.50',To_Date('2017-05-05 09:44:11', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PeisManage.dll','21','个人体检报告',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9PeisRpt.dll','7CA1BF209741F01E0DE0DCC282F4ECB8','10.35.50',To_Date('2017-05-05 09:40:59', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PeisManage.dll','21','固定格式的个人报告',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9PrintMode.dll','C553618E89D267AF1A47AB3C785396B3','10.35.50',To_Date('2017-05-05 09:24:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'打印部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Purvey.dll','E8E47FF97A2F64855F1339200301697E','10.35.40',To_Date('2017-03-06 15:06:06', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Material.dll','4','供应室部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9RTFCreator.dll','57F781977E1DA406D0F4A71FAC7ADB00','10.35.0',To_Date('2015-12-01 09:04:05', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9CISJob.dll','1','老版电子病历导出为RTF使用的部件，在用需要保留。',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9RecipeAudit.dll','21E46A2E5100AAAEC74628271EC019BC','10.35.50',To_Date('2017-05-05 09:52:09', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Appsoft]\Apply','zl9CISJob.dll','1','处方审核系统',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9RegEvent.dll','E8F997180D26A62F026CFBEFB747DC13','10.35.50',To_Date('2017-05-05 09:31:20', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9RegEvent.dll','1','挂号部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Report.dll','34304F54A0C34BF9AD8C37D22F401916','10.35.50',To_Date('2017-05-05 13:38:48', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'报表部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Stuff.dll','1BF5BC81AB5055F4F72E1EFDA958A61D','10.35.50',To_Date('2017-05-05 09:31:20', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Stuff.dll','1','卫材管理部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TaxBill.dll','48AA7B4EB172B9D45F37436FB673EE4E','10.35.50',To_Date('2017-05-05 09:24:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9InExse.DLL,zl9OutExse.dll,zl9WizardPayFee.dll,zl9WizardRegEvent.dll','1,26','税控打印部件（标准版是安装）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TechCore.dll','332AA3BD3D88AF55DB4B3CB4CFC86DE7','10.35.0',To_Date('2015-12-01 09:12:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChart.dll','CC8A17DA49AA29E6611E9EFB4EFB53BE','10.35.50',To_Date('2017-05-05 09:36:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','体温单部件（系统自带，老版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChartGD.dll','4B1CC1912AFE63878A447E63AD83D068','10.35.40',To_Date('2017-03-08 11:54:14', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','广东省专用体温部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChartGS.dll','1FB5622975674DA72CFD8C0C76185788','10.35.40',To_Date('2017-03-08 11:53:12', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','体温单部件（甘肃，新版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChartGX.dll','CD424AED47A6E0471006436A11C7438C','10.35.50',To_Date('2017-05-05 09:36:16', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','体温单部件（广西，新版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChartHnnx.dll','0D0EBDDDF94BD6723EFC885C0C54B3DF','10.35.40',To_Date('2017-03-08 11:53:42', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','湖南宁乡人民医院专用部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChartNJ.dll','B3F9CEF43DB6CDB984F84F3110525DF3','10.35.40',To_Date('2017-03-08 11:54:47', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','江苏省专用体温部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChartS3201.dll','5E176905D9CD953F97D21D21D6408E10','10.35.40',To_Date('2017-03-08 11:53:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','陕西汉中3201医院',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChartSC.dll','7D342E4F3E137DBB6527AA0DD34C0750','10.35.40',To_Date('2017-03-08 11:52:08', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','四川专用体温部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChartSCZG.dll','66E94E66D85AC4D66EC578E3B4287C4D','10.35.40',To_Date('2017-03-08 11:52:24', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','四川自贡地区专用体温部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChartSX.dll','E10922FB6157E5895A830F34CABD123D','10.35.50',To_Date('2017-05-05 09:47:57', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','山西地区专用体温部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TemperatureChartYDEY.dll','52272B1592B3A1E2E76C976A10E3F939','10.35.40',To_Date('2017-03-08 11:53:57', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','体温单部件（医大二院，新版）',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9TendFile.dll','98530883EEB0C9D704A329CA8A226FCB','10.35.50',To_Date('2017-05-05 09:36:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll,zl9Oper.dll','1,24','护理记录单',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9Transfusion.dll','CE079831105F7A407AE297B0414FB8D1','10.35.50',To_Date('2017-05-05 09:39:42', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Transfusion.dll','1','门诊输液部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WardMonitor.dll','8D35B71860EEBAB22EBD39050EBF983F','10.35.0',To_Date('2015-12-01 09:06:54', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9CISJob.dll','1','护士工作站(非新版)嵌入监护仪界面使用的部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardCards.dll','2A252FFCA30DFAD66B64191AC1C0BA1A','10.35.50',To_Date('2017-05-05 09:49:26', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardControl.ocx','53F948534BB5F593A5665C80FB15E4AA','10.35.50',To_Date('2017-05-05 09:46:49', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9WizardManage.dll,zl9WizardPage.dll','26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardDeposit.dll','654DBD0D304A5B1CB76ABD0DC587B51F','10.35.50',To_Date('2017-05-05 09:48:20', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardEMR.dll','C1149D2783BCAEF6E43353C050C41080','10.35.50',To_Date('2017-05-05 09:51:39', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[Appsoft]\Apply',Null,'26','门诊病历自助打印',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardFeeQuery.dll','04EA47E8A396603C814D28317DF1765A','10.35.50',To_Date('2017-05-05 09:48:26', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardInvoicePrint.dll','872E56162B4E107E8BE04FCDEA625C71','10.35.50',To_Date('2017-05-05 09:48:35', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardLABCall.dll','1A7E1B561EDF642DA466115F29A99A46','10.35.40',To_Date('2017-03-08 15:38:23', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardLabPrint.dll','C1A05FA644E9C6D2A710B1DAA2DB2AE8','10.35.50',To_Date('2017-05-05 09:48:41', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardLib.dll','D491B213D2517B30878C25599898B1E4','10.35.50',To_Date('2017-05-05 09:46:06', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9WizardManage.dll,zl9WizardPage.dll','26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardMain.exe','0454549F94410448325617C0C7216AE5','10.35.50',To_Date('2017-05-05 09:49:11', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]',Null,'26',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardManage.dll','97C06DE158926592457675DFF3D130E3','10.35.50',To_Date('2017-05-05 09:47:43', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardPage.dll','AD5C9A12DEE7D2FEA37507EE2AA921C8','10.35.50',To_Date('2017-05-05 09:47:17', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardPayFee.dll','9D2C51937AD4B74A4376040441A53604','10.35.50',To_Date('2017-05-05 09:48:58', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardPeisQueue.dll','F05379F9F2D8B0CD2DDCAC82A9BB8B77','10.35.50',To_Date('2017-05-05 09:49:33', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9WizardManage.dll','26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardPharmacy.dll','84D2D21CF53376770C396767737FF081','10.35.50',To_Date('2017-05-05 09:52:44', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:25:39', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9WizardManage.dll','26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardPrice.dll','AA8C40E010BCAA8A72B11CF2A6AECACF','10.35.50',To_Date('2017-05-05 09:47:22', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardProficient.dll','A7FA02F38A22C71E47C53AD8E0B0AEFA','10.35.50',To_Date('2017-05-05 09:47:29', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardProof.dll','EED8A606E4F26E11683FFF96991CACF9','10.35.50',To_Date('2017-05-05 09:51:57', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[Appsoft]\Apply',Null,'26','自助凭条件打印',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardRegEvent.dll','59C785A975D79F30FF39F38AC70DE8EA','10.35.50',To_Date('2017-05-05 09:49:23', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9WizardToday.dll','FD103DD4986F15F41C5B5FEDB6F43271','10.35.50',To_Date('2017-05-05 09:47:35', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9keyboard.dll','94EFD2A89C9714355BDC7BB8EA7F8143','10.35.0',To_Date('2015-12-01 09:01:40', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9CardSquare.dll,zl9ComLibpss.dll,zl9InPatient.dll,zl9Patient.dll,zl9RegEvent.dll','1,21,22,24,26','密码键盘的接口部件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('zl9peisgrouprpt.dll','6C67BCC0B29E2160747B152EDCA8B2BB','10.35.50',To_Date('2017-05-05 09:44:20', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PeisManage.dll','21','团队体检报告部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlActMain.exe','F68F92DA53F434B7C03117C5295B4B49','10.35.50',To_Date('2017-05-05 09:49:37', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]',Null,'1','BH融合启动程序',0,0,Null);
EXECUTE Zlfiles_Autoupdate('zlCISKernel.dll','E3B48C0C3957407F8EA0F05BBA92654A','10.35.50',To_Date('2017-05-05 14:51:03', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Blood.dll,zl9CISAudit.dll,zl9CISBase.dll,zl9CISJob.dll,zl9LisWork.dll,zl9Oper.dll,zl9Ops.dll,zl9PACSWork.dll,zl9Transfusion.dll','1,21,22,24','临床公共部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlCISPath.dll','6A63A3CBA4543A11BF875FCD2EB18297','10.35.50',To_Date('2017-05-05 09:34:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','临床路径相关部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlCisAuditPrint.EXE','B7ABB75AB2728075BDAFB2B2602BBFCD','10.35.30',To_Date('2017-03-06 16:58:03', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','用于电子病案审查中对病案进行PDF批量输出，以防止GDI泄露',0,1,Null);
EXECUTE Zlfiles_Autoupdate('zlCommunity.dll','8459394D91918552CD8B48ABA4BE690D','10.35.50',To_Date('2017-05-05 09:29:58', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9BaseItem.dll,zl9CISJob.dll,zl9RegEvent.dll','1','社区接口部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlDataOracle.dll','9963D738201D9B5948714579458F8F01','10.35.0',To_Date('2015-12-01 08:53:59', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'消息集成平台ZLHIS客户端公共部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlDataSQLite.dll','4C5A2923C0A3B5264ED3B32E316D3179','10.35.0',To_Date('2015-12-01 08:54:01', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'消息集成平台ZLHIS客户端公共部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlDisReportCard.DLL','2A104B9AC38273F96AABAC0C329B7519','10.35.50',To_Date('2017-05-05 09:51:55', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','ZLRICHEPR.DLL,ZL9DISEASE.DLL','1','传染病报告卡专用编辑器',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlGetImage.exe','0B732B8809DD7A96191D6FB86B63C6D2','10.35.0',To_Date('2015-12-01 09:19:46', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9PACSWork.dll','1','PACS观片下载图像',0,0,Null);
EXECUTE Zlfiles_Autoupdate('zlGetImageEx.exe','7B548F51F375D84777CD61F0930D9D3C','10.35.0',To_Date('2015-12-01 09:24:50', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:13', 'yyyy-mm-dd HH24:mi:ss'),1,'[Appsoft]\Apply',Null,'1','zlGetImageEx是使用ActiveExe的方式实现后台进程加载及上传图像，是一个ActiveExe部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlGrant.dll','D1C83ED751EF296AC18791135D3C6E3B','9.0.2',To_Date('2004-10-08 18:48:18', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'授权部件',0,0,Null);
EXECUTE Zlfiles_Autoupdate('zlICCard.dll','3E1CD4CD40D6C57B7BAF3A1ABB9FFF70','10.35.50',To_Date('2017-05-05 09:24:58', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlIDCard.dll','1BB54E69EEF95F96A8B3561BC3D30B1E','10.35.50',To_Date('2017-05-05 09:24:52', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlIDKind.ocx','7B1418554C70D93A256D1987AF95463C','10.35.50',To_Date('2017-05-05 09:23:35', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlLISDev.dll','E31A4AF897463A0CAC341B60F840351E','10.35.0',To_Date('2015-12-01 09:16:26', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9LisWork.dll','25,1','LIS仪器接口部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlLISInterface.DLL','D50E3B0322623B12A0D3000C27243D7D','10.35.30',To_Date('2016-11-08 09:09:59', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'1','LIS第三方接口',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlLisReceiveSend.exe','1A7E194151478D9BE76375DBF4890389','10.35.0',To_Date('2015-12-01 09:12:48', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]','zl9LisWork.dll','1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('zlMedRecPage.dll','0F7ED506BFCF3DA3398125D2D31FA29B','10.35.50',To_Date('2017-05-05 09:25:23', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'首页相关信息的统一部件,主要包括电子病案审查查阅,诊断选择器,门诊首页,住院首页,病案首页窗体.  ',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlMipClient.dll','531EA518F537DA0A3085D269D5235336','1.0.0',To_Date('2014-05-26 15:03:40', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),4,'[Public]',Null,Null,'消息集成平台接口',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlMipClientComLib.dll','0D6D2333DBCE41913EB05F73A1F5006B','10.35.0',To_Date('2015-12-01 08:54:08', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'消息集成平台ZLHIS客户端公共部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlMipClientManage.exe','B686B7BCD8E021DD88496B538E494C6E','10.35.0',To_Date('2015-12-01 08:54:22', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),0,'[AppSoft]',Null,Null,'消息集成平台ZLHIS客户端后台管理程序（exe）',0,1,Null);
EXECUTE Zlfiles_Autoupdate('zlMipClientPoll.exe','1BDD1B42D83A56AC90DC831A71EE2EE8','10.35.0',To_Date('2015-12-01 08:54:19', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),0,'[AppSoft]',Null,Null,'消息集成平台ZLHIS客户端轮询检查服务程序（exe）',0,1,Null);
EXECUTE Zlfiles_Autoupdate('zlMipClientShell.exe','63EA8CA7D98D030000D472D6C294E2F0','10.35.0',To_Date('2015-12-01 08:54:20', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'消息集成平台ZLHIS客户端公共部件(ActiveX EXE)',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlOperInterface.dll','F9F887762DAC099C158C379B028FF9A9','10.35.50',To_Date('2017-05-05 09:43:11', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'24','第三方手麻接口部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlOrclConfig.exe','BFC1E7171D907BB30B5A82FAAC4BED0F','10.35.0',To_Date('2015-12-01 09:23:20', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]',Null,'1,3,4,6,21,22,23,24,25,26','用于快速配置ORACLE配置文件的工具。',0,0,Null);
EXECUTE Zlfiles_Autoupdate('zlPacsRichPages.ocx','1AECE8FE5ABB73B5DC04BE911A46D289','1.3520.345',To_Date('2016-08-08 15:17:06', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'新Pacs报告编辑器核心处理控件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlPacsVBCommon.dll','67103C1CB5EA4C0D66F2EB7F45A0BD4F','10.35.50',To_Date('2017-05-05 09:42:00', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'新版PACS报告编辑器和vb层PACS程序交互的部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlPassInterface.dll','D1C7D65962BD4C4C0636FFD742D67DD1','10.35.50',To_Date('2017-05-05 09:31:59', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'从ZLCisKernel里提取出来的合理用药接口部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlPeisAutoAnalyse.exe','9247812BAA7A1321A5A24D8E0E67E9DC','10.35.50',To_Date('2017-05-05 09:49:40', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]','zl9PeisManage.dll','21','非标准接口的服务程序',0,0,Null);
EXECUTE Zlfiles_Autoupdate('zlPictureEditor.dll','FFC89C7F96949A5DF393A8317D2B3968','10.35.50',To_Date('2017-05-05 09:31:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9CISJob.dll','1,22,24','是否只有标准版用到',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlPublicAdvice.dll','F176AA0B8DC2654A70F60302F33867FF','10.35.50',To_Date('2017-05-05 09:34:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'医嘱业务封装公共部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlPublicExpense.dll','CEFB63BF47E19B14FE6ADE284C0257C8','10.35.50',To_Date('2017-05-05 09:25:43', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'医嘱附费部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlPublicLIS.dll','87E5C2EC4F9EDA76FFE4EDE402BD4416','10.35.50',To_Date('2017-05-05 09:34:09', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,Null,1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlPublicPacs.dll','F524937374E8BE36843AACD1CAEA5892','10.35.50',To_Date('2017-05-05 09:35:40', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'pacs依赖业务封装部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlPublicPath.dll','278BA2711013006FFAD6EB3E74FC773E','10.35.50',To_Date('2017-05-05 09:35:42', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'路径业务封装公共部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlPublicPatient.dll','E17C833ADB397EB42E1219C54482320F','10.35.50',To_Date('2017-05-05 09:34:14', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'病人管理业务封装公共部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlPublicPeis.dll','D06D09AE0E7BCFDC603F14AD704BDD65','10.35.0',To_Date('2015-12-01 09:03:42', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'体检业务封装公共部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlQueueManage.dll','839306EC61E57E39903D69DD3B92689F','10.35.50',To_Date('2017-05-05 09:30:02', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll,zl9PACSWork.dll,zl9PeisManage.dll,zl9RegEvent.dll','1,21','排队叫号部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlQueueOper.ocx','30BBF86FCE3B0D0666F264DE4923AA19','10.35.50',To_Date('2017-05-05 09:41:12', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]','zl9PACSWork.dll',Null,Null,1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlQueueShow.exe','6884D9711C3743E02C3C4B0DF0A14C68','10.35.40',To_Date('2017-03-06 15:13:29', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\zlQueueShow',Null,'1','新版排队叫号显示程序',0,1,Null);
EXECUTE Zlfiles_Autoupdate('zlRecipeAuditEx.dll','969D919DCB63D6877A2AA17FD3477A2E','10.35.0',To_Date('2015-12-01 09:25:35', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),1,'[Appsoft]\Apply','zl9CISJob.dll','1','处方审查系统的外挂部件（用户可自行维护）',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlRichEPR.DLL','442A3386B021D1C827B9CD01494320C1','10.35.50',To_Date('2017-05-05 16:38:06', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Blood.dll,zl9CISAudit.dll,zl9CISJob.dll,zl9LisWork.dll,zl9Oper.dll,zl9Ops.dll,zl9PACSWork.dll','1,22,24','老版电子病历相关部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlRichEditor.ocx','D10211FB3CEF79D5CE20444AAABE935A','10.35.50',To_Date('2017-05-05 09:32:12', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9Blood.dll,zl9CISJob.dll,zl9Oper.dll','1,22,24','电子病历编辑控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlScreenKeyboard.exe','B8C3E47A26784CA912ADD4C91B43A991','10.35.0',To_Date('2015-12-01 09:23:05', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9CISJob.dll','1','小键盘程序文件位置调整',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlSubclass.ocx','A4DD9499478F784A0FDB25EA1EC08B80','10.35.50',To_Date('2017-05-05 09:31:34', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9Blood.dll,zl9CISJob.dll,zl9Oper.dll','1,22,24','电子病历低层消息处理的部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlSvgProcess.dll','9E00926BA33C621864432B114DF8CE93','1.0.3',To_Date('2015-09-29 16:24:43', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'用于处理svg图像',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlSvrNotice.exe','854AA71CC9F8F9F7A51EEA52C31B397E','10.35.50',To_Date('2017-05-05 09:25:13', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('zlSvrStudio.exe','0EBA7D6ECAA78C21637E0995AFB4698B','10.35.50',To_Date('2017-05-05 09:26:09', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]',Null,Null,Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('zlSwitchEffect.dll','55968705B856B2947F168E114D35309C','10.35.0',To_Date('2015-12-01 09:22:27', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlSwitchPage.dll','EDB7BEA3A23946049A12248AC02AD01E','10.35.0',To_Date('2015-12-01 09:22:25', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlTable.ocx','D0546EAC7082209CB7BB8AA989F88E72','10.35.50',To_Date('2017-05-05 09:31:54', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[Public]','zl9Blood.dll,zl9CISJob.dll,zl9Oper.dll,zl9PACSWork.dll','1,22,24','表格控件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlTableEPR.dll','B3F709A8883613721FEE377FFFAD449B','10.35.50',To_Date('2017-05-05 09:31:59', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:11', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY','zl9Blood.dll,zl9CISJob.dll,zl9Oper.dll','1,22,24','表格电子病历相关部件',1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlVSFlexGrid.dll','74AAB740FFFA50077602CCEC909756CF','10.35.0',To_Date('2015-12-01 08:54:03', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:12', 'yyyy-mm-dd HH24:mi:ss'),0,'[Public]',Null,Null,'消息集成平台ZLHIS客户端公共部件',1,1,Null);
EXECUTE Zlfiles_Autoupdate('zlWizardNewLabPrint.dll','3DD869023CB72803D03336D244C570BF','10.35.50',To_Date('2017-05-05 09:48:05', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlWizardPacsPrint.dll','F5B60DCDF99F2868A76DAE48319A8242','10.35.50',To_Date('2017-05-05 09:49:32', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]\APPLY',Null,'26',Null,1,0,Null);
EXECUTE Zlfiles_Autoupdate('zlWizardStart.exe','52EF6BB9AE99E759337E1A761BED9B73','10.35.50',To_Date('2017-05-05 09:47:46', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:10', 'yyyy-mm-dd HH24:mi:ss'),1,'[APPSOFT]',Null,'26',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('打印.AVI','C181F16316913B78F518EFB789581084',Null,To_Date('2003-02-14 17:37:12', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('单病人宽屏深蓝.ini','2E78B1F478EDC7142842A433B1288CA3',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\单病人样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('单病人宽屏深蓝.jpg','25CF28EC30A8E6B893B53A1A41E66250',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\单病人样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('单队列宽屏浅紫.ini','771D5C66769E78214AAAD0978189E97C',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\单队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('单队列宽屏浅紫.jpg','D99E55E3C12482DBA258CC2EBA0249CE',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\单队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('单队列宽屏深蓝.ini','1D906F234FE8081784B8854E2B9761B0',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\单队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('单队列宽屏深蓝.jpg','2F5241399197FCA726FA3355C66B4F43',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\单队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('单队列宽屏天蓝.ini','95C216EC8FA5662BB73A42C2A0059EBC',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\单队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('单队列宽屏天蓝.jpg','40689FACC5B8DA5E11AA24903C48274C',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\单队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('单队列竖屏天蓝.ini','EAFFF1AEAFFDA6C8E0666ECCCB9543D1',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\单队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('单队列竖屏天蓝.jpg','A7381080C65DCD8C87105EB6C6FEC79F',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\单队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('多队列样式浅紫.ini','9DEB997BDE5D1E4E25CA540C84B96651',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\多队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('多队列样式浅紫.jpg','811E1412AFE4F228A2702E5ECFA6D2DA',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\多队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('多队列样式深蓝.ini','98857A8901F5801320A8E2C5E3ED6234',Null,To_Date('2014-10-16 17:01:07', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\多队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('多队列样式深蓝.jpg','3BA502B067D6DDEA7B7B2BF0713AB16B',Null,To_Date('2014-10-16 17:01:08', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\多队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('多队列样式天蓝.ini','95A2D13E95282C473D2EDE718EE1CCD6',Null,To_Date('2014-10-16 17:01:08', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\多队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('多队列样式天蓝.jpg','BCCFD2F0617A1020A7FF8E8377E3F4B2',Null,To_Date('2014-10-16 17:01:08', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\zlQueueShow\Skin\多队列样式',Null,'1','新版排队叫号显示程序的皮肤',0,0,Null);
EXECUTE Zlfiles_Autoupdate('收费项目.xlsx','3769E6B8DD69023D34C8AFA17DEB4755',Null,To_Date('2014-01-09 11:11:41', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('卫材目录.xlsx','8D6E43900F148CACB72C4ECAAF372BE5',Null,To_Date('2014-01-09 11:11:41', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);
EXECUTE Zlfiles_Autoupdate('药品目录.xlsx','92DDE8BE67C6978B9862D3E40F951A97',Null,To_Date('2014-01-09 11:11:41', 'yyyy-mm-dd HH24:mi:ss'),To_Date('2017-03-08 09:18:14', 'yyyy-mm-dd HH24:mi:ss'),3,'[APPSOFT]\附加文件',Null,'1',Null,0,0,Null);

--系统版本号
Update zlSystems Set 版本号='10.35.50' Where 编号=&n_System;
--部件版本号
Commit;
