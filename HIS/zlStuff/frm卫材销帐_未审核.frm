VERSION 5.00
Object = "{BEEECC20-4D5F-4F8B-BFDC-5D9B6FBDE09D}#1.0#0"; "VSFLEX8.OCX"
Begin VB.Form frmŒ¿≤ƒœ˙’ _Œ¥…Û∫À 
   BorderStyle     =   0  'None
   Caption         =   "Œ¿≤ƒœ˙’ Œ¥…Û∫À"
   ClientHeight    =   6495
   ClientLeft      =   0
   ClientTop       =   0
   ClientWidth     =   10965
   LinkTopic       =   "Form1"
   MaxButton       =   0   'False
   MinButton       =   0   'False
   ScaleHeight     =   6495
   ScaleWidth      =   10965
   ShowInTaskbar   =   0   'False
   StartUpPosition =   3  '¥∞ø⁄»± °
   Begin VB.PictureBox picHsc 
      Appearance      =   0  'Flat
      AutoRedraw      =   -1  'True
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   45
      Left            =   0
      MousePointer    =   7  'Size N S
      ScaleHeight     =   45
      ScaleWidth      =   12615
      TabIndex        =   5
      TabStop         =   0   'False
      Top             =   2490
      Width           =   12615
   End
   Begin VB.PictureBox picBatHsc 
      Appearance      =   0  'Flat
      AutoRedraw      =   -1  'True
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   45
      Left            =   -330
      MousePointer    =   7  'Size N S
      ScaleHeight     =   45
      ScaleWidth      =   12735
      TabIndex        =   4
      TabStop         =   0   'False
      Top             =   4470
      Width           =   12735
   End
   Begin VB.CheckBox chk»´—° 
      Caption         =   "»´…Û(&A)"
      Height          =   225
      Left            =   45
      TabIndex        =   0
      Top             =   90
      Width           =   1500
   End
   Begin VSFlex8Ctl.VSFlexGrid vsHeadGrid 
      Height          =   2055
      Left            =   75
      TabIndex        =   1
      Tag             =   "¥˝¥¶¿Ì"
      Top             =   435
      Width           =   10800
      _cx             =   19050
      _cy             =   3625
      Appearance      =   1
      BorderStyle     =   1
      Enabled         =   -1  'True
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "ÀŒÃÂ"
         Size            =   10.5
         Charset         =   134
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      MousePointer    =   0
      BackColor       =   -2147483643
      ForeColor       =   -2147483640
      BackColorFixed  =   -2147483633
      ForeColorFixed  =   -2147483630
      BackColorSel    =   -2147483635
      ForeColorSel    =   -2147483634
      BackColorBkg    =   -2147483636
      BackColorAlternate=   -2147483643
      GridColor       =   -2147483633
      GridColorFixed  =   -2147483632
      TreeColor       =   -2147483632
      FloodColor      =   192
      SheetBorder     =   -2147483643
      FocusRect       =   1
      HighLight       =   2
      AllowSelection  =   0   'False
      AllowBigSelection=   0   'False
      AllowUserResizing=   1
      SelectionMode   =   0
      GridLines       =   1
      GridLinesFixed  =   2
      GridLineWidth   =   1
      Rows            =   2
      Cols            =   6
      FixedRows       =   1
      FixedCols       =   0
      RowHeightMin    =   300
      RowHeightMax    =   0
      ColWidthMin     =   0
      ColWidthMax     =   0
      ExtendLastCol   =   0   'False
      FormatString    =   $"frmŒ¿≤ƒœ˙’ _Œ¥…Û∫À.frx":0000
      ScrollTrack     =   -1  'True
      ScrollBars      =   3
      ScrollTips      =   0   'False
      MergeCells      =   0
      MergeCompare    =   0
      AutoResize      =   -1  'True
      AutoSizeMode    =   0
      AutoSearch      =   0
      AutoSearchDelay =   2
      MultiTotals     =   -1  'True
      SubtotalPosition=   1
      OutlineBar      =   0
      OutlineCol      =   0
      Ellipsis        =   0
      ExplorerBar     =   1
      PicturesOver    =   0   'False
      FillStyle       =   0
      RightToLeft     =   0   'False
      PictureType     =   0
      TabBehavior     =   0
      OwnerDraw       =   0
      Editable        =   0
      ShowComboButton =   1
      WordWrap        =   0   'False
      TextStyle       =   0
      TextStyleFixed  =   0
      OleDragMode     =   0
      OleDropMode     =   0
      DataMode        =   0
      VirtualData     =   -1  'True
      DataMember      =   ""
      ComboSearch     =   3
      AutoSizeMouse   =   -1  'True
      FrozenRows      =   0
      FrozenCols      =   0
      AllowUserFreezing=   0
      BackColorFrozen =   0
      ForeColorFrozen =   0
      WallPaperAlignment=   9
      AccessibleName  =   ""
      AccessibleDescription=   ""
      AccessibleValue =   ""
      AccessibleRole  =   24
   End
   Begin VSFlex8Ctl.VSFlexGrid vsDetail 
      Height          =   1935
      Left            =   15
      TabIndex        =   2
      Tag             =   "√˜œ∏"
      Top             =   2535
      Width           =   10800
      _cx             =   19050
      _cy             =   3413
      Appearance      =   1
      BorderStyle     =   1
      Enabled         =   -1  'True
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "ÀŒÃÂ"
         Size            =   10.5
         Charset         =   134
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      MousePointer    =   0
      BackColor       =   -2147483643
      ForeColor       =   -2147483640
      BackColorFixed  =   -2147483633
      ForeColorFixed  =   -2147483630
      BackColorSel    =   -2147483635
      ForeColorSel    =   -2147483634
      BackColorBkg    =   -2147483636
      BackColorAlternate=   -2147483643
      GridColor       =   -2147483633
      GridColorFixed  =   -2147483632
      TreeColor       =   -2147483632
      FloodColor      =   192
      SheetBorder     =   -2147483643
      FocusRect       =   1
      HighLight       =   2
      AllowSelection  =   0   'False
      AllowBigSelection=   0   'False
      AllowUserResizing=   1
      SelectionMode   =   0
      GridLines       =   1
      GridLinesFixed  =   2
      GridLineWidth   =   1
      Rows            =   2
      Cols            =   10
      FixedRows       =   1
      FixedCols       =   0
      RowHeightMin    =   300
      RowHeightMax    =   0
      ColWidthMin     =   0
      ColWidthMax     =   0
      ExtendLastCol   =   0   'False
      FormatString    =   $"frmŒ¿≤ƒœ˙’ _Œ¥…Û∫À.frx":00DD
      ScrollTrack     =   -1  'True
      ScrollBars      =   3
      ScrollTips      =   0   'False
      MergeCells      =   0
      MergeCompare    =   0
      AutoResize      =   -1  'True
      AutoSizeMode    =   0
      AutoSearch      =   0
      AutoSearchDelay =   2
      MultiTotals     =   -1  'True
      SubtotalPosition=   1
      OutlineBar      =   0
      OutlineCol      =   0
      Ellipsis        =   0
      ExplorerBar     =   1
      PicturesOver    =   0   'False
      FillStyle       =   0
      RightToLeft     =   0   'False
      PictureType     =   0
      TabBehavior     =   0
      OwnerDraw       =   0
      Editable        =   0
      ShowComboButton =   1
      WordWrap        =   0   'False
      TextStyle       =   0
      TextStyleFixed  =   0
      OleDragMode     =   0
      OleDropMode     =   0
      DataMode        =   0
      VirtualData     =   -1  'True
      DataMember      =   ""
      ComboSearch     =   3
      AutoSizeMouse   =   -1  'True
      FrozenRows      =   0
      FrozenCols      =   0
      AllowUserFreezing=   0
      BackColorFrozen =   0
      ForeColorFrozen =   0
      WallPaperAlignment=   9
      AccessibleName  =   ""
      AccessibleDescription=   ""
      AccessibleValue =   ""
      AccessibleRole  =   24
   End
   Begin VSFlex8Ctl.VSFlexGrid vsBatch 
      Height          =   1815
      Left            =   15
      TabIndex        =   3
      Tag             =   "√˜œ∏"
      Top             =   4575
      Width           =   10800
      _cx             =   19050
      _cy             =   3201
      Appearance      =   1
      BorderStyle     =   1
      Enabled         =   -1  'True
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "ÀŒÃÂ"
         Size            =   10.5
         Charset         =   134
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      MousePointer    =   0
      BackColor       =   -2147483643
      ForeColor       =   -2147483640
      BackColorFixed  =   -2147483633
      ForeColorFixed  =   -2147483630
      BackColorSel    =   -2147483635
      ForeColorSel    =   -2147483634
      BackColorBkg    =   -2147483636
      BackColorAlternate=   -2147483643
      GridColor       =   -2147483633
      GridColorFixed  =   -2147483632
      TreeColor       =   -2147483632
      FloodColor      =   192
      SheetBorder     =   -2147483643
      FocusRect       =   1
      HighLight       =   2
      AllowSelection  =   0   'False
      AllowBigSelection=   0   'False
      AllowUserResizing=   1
      SelectionMode   =   0
      GridLines       =   1
      GridLinesFixed  =   2
      GridLineWidth   =   1
      Rows            =   2
      Cols            =   11
      FixedRows       =   1
      FixedCols       =   0
      RowHeightMin    =   300
      RowHeightMax    =   0
      ColWidthMin     =   0
      ColWidthMax     =   0
      ExtendLastCol   =   0   'False
      FormatString    =   $"frmŒ¿≤ƒœ˙’ _Œ¥…Û∫À.frx":0242
      ScrollTrack     =   -1  'True
      ScrollBars      =   3
      ScrollTips      =   0   'False
      MergeCells      =   0
      MergeCompare    =   0
      AutoResize      =   -1  'True
      AutoSizeMode    =   0
      AutoSearch      =   0
      AutoSearchDelay =   2
      MultiTotals     =   -1  'True
      SubtotalPosition=   1
      OutlineBar      =   0
      OutlineCol      =   0
      Ellipsis        =   0
      ExplorerBar     =   1
      PicturesOver    =   0   'False
      FillStyle       =   0
      RightToLeft     =   0   'False
      PictureType     =   0
      TabBehavior     =   0
      OwnerDraw       =   0
      Editable        =   0
      ShowComboButton =   1
      WordWrap        =   0   'False
      TextStyle       =   0
      TextStyleFixed  =   0
      OleDragMode     =   0
      OleDropMode     =   0
      DataMode        =   0
      VirtualData     =   -1  'True
      DataMember      =   ""
      ComboSearch     =   3
      AutoSizeMouse   =   -1  'True
      FrozenRows      =   0
      FrozenCols      =   0
      AllowUserFreezing=   0
      BackColorFrozen =   0
      ForeColorFrozen =   0
      WallPaperAlignment=   9
      AccessibleName  =   ""
      AccessibleDescription=   ""
      AccessibleValue =   ""
      AccessibleRole  =   24
   End
End
Attribute VB_Name = "frmŒ¿≤ƒœ˙’ _Œ¥…Û∫À"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Private mfrmMain As Form
Private mstrPrivs As String
Private mlngModule As Long
Private mArrFilter As Variant   'π˝¬ÀÃıº˛
Private mrsDetail As ADODB.Recordset
Private mrsBatch As ADODB.Recordset
Private mint…Û∫À±Í÷æ As Integer
Private mintUnit As Integer '0-…¢◊∞µ•Œª,1-∞¸◊∞µ•Œª
'----------------------------------------------------------------------------------------------------------
'¡ı–À∫Í:‘ˆº”–° ˝Œª ˝µƒ∏Ò Ω¥Æ
'–ﬁ∏ƒ:2007/03/06
Private mFMT As g_FmtString
Private mOraFMT As g_FmtString
'----------------------------------------------------------------------------------------------------------
'“Ω±£Ω”ø⁄
Private gclsInsure As New clsInsure
Private Type TYPE_MedicarePAR
    ∏∫ ˝º«’  As Boolean
    º«’ …œ¥´ As Boolean
    º«’ ÕÍ≥…∫Û…œ¥´ As Boolean
    º«’ ◊˜∑œ…œ¥´ As Boolean
End Type
Private MCPAR As TYPE_MedicarePAR

Public Enum “Ω‘∫“µŒÒ
    support√≈’Ô‘§À„ = 0
    
    support√≈’ÔÕÀ∑— = 1
    support‘§ΩªÕÀ∏ˆ»À’ ªß = 2
    
    support ’∑—’ ªß»´◊‘∑— = 4       '√≈’Ô ’∑—∫Õπ“∫≈ «∑Ò”√∏ˆ»À’ ªß÷ß∏∂»´◊‘∑—≤ø∑÷°£»´◊‘∑—£∫÷∏Õ≥≥Ô±»¿˝Œ™0µƒΩ∂ÓªÚ≥¨≥ˆœﬁº€µƒ¥≤Œª∑—≤ø∑÷
    support ’∑—’ ªß ◊œ»◊‘∏∂ = 5     '√≈’Ô ’∑—∫Õπ“∫≈ «∑Ò”√∏ˆ»À’ ªß÷ß∏∂ ◊œ»◊‘∏∂≤ø∑÷°£ ◊œ»◊‘∏∂£∫£®1-Õ≥≥Ô±»¿˝£©* Ω∂Ó
    
    supportΩ·À„’ ªß»´◊‘∑— = 6       '◊°‘∫Ω·À„”ÎÃÿ ‚√≈’Ô «∑Ò”√∏ˆ»À’ ªß÷ß∏∂»´◊‘∑—≤ø∑÷°£
    supportΩ·À„’ ªß ◊œ»◊‘∏∂ = 7     '◊°‘∫Ω·À„”ÎÃÿ ‚√≈’Ô «∑Ò”√∏ˆ»À’ ªß÷ß∏∂ ◊œ»◊‘∏∂≤ø∑÷°£
    supportΩ·À„’ ªß≥¨œﬁ = 8         '◊°‘∫Ω·À„”ÎÃÿ ‚√≈’Ô «∑Ò”√∏ˆ»À’ ªß÷ß∏∂≥¨œﬁ≤ø∑÷°£
    
    supportΩ·À„ π”√∏ˆ»À’ ªß = 9     'Ω·À„ ±ø… π”√∏ˆ»À’ ªß÷ß∏∂
    supportŒ¥Ω·«Â≥ˆ‘∫ = 10          '‘ –Ì≤°»Àªπ”–Œ¥Ω·∑—”√ ±≥ˆ‘∫
    
    support√≈’Ô≤ø∑÷ÕÀœ÷Ω = 11      '÷ª”–‘⁄√≈’Ô“Ω±£≤ª÷ß≥÷ÕÀ∑—≤≈ π”√±æ≤Œ ˝°£“≤æÕ «Àµ‘⁄ÕÀœ÷Ω ±≤≈øº¬«≤ø∑÷ÕÀ”Î∑Ò£¨∂¯ÕÀªÿµΩ∏ˆ»À’ ªßµƒ“Ω±£∂º±ÿ–Î’˚’≈ÕÀ∑—°£
    support‘ –Ì≤ª…Ë÷√“Ω±£œÓƒø = 12  '‘⁄Ω·À„ ±£¨≤ª∂‘∏˜ ’∑—œ∏ƒø «∑Ò…Ë÷√“Ω±£œÓƒøΩ¯––ºÏ≤È
    
    support√≈’Ô±ÿ–Î¥´µ›√˜œ∏ = 13    '√≈’Ô ’∑—∫Õπ“∫≈ «∑Ò±ÿ–Î¥´µ›√˜œ∏
    
    supportº«’ …œ¥´ = 14            '◊°‘∫º«’ ∑—”√√˜œ∏ µ ±¥´ ‰
    supportº«’ ◊˜∑œ…œ¥´ = 15        '◊°‘∫∑—”√ÕÀ∑— µ ±¥´ ‰

    support≥ˆ‘∫≤°»ÀΩ·À„◊˜∑œ = 16    '‘ –Ì≥ˆ‘∫≤°»ÀΩ·’ ◊˜∑œ
    support≥∑œ˚≥ˆ‘∫ = 17            '‘ –Ì≥∑œ˚≤°»À≥ˆ‘∫
    support±ÿ–Î¬º»Î»Î≥ˆ’Ô∂œ = 18    '≤°»À»Î‘∫”Î≥ˆ‘∫ ±£¨±ÿ–Î¬º»Î’Ô∂œ√˚
    supportº«’ ÕÍ≥…∫Û…œ¥´ = 19      '“™«Û…œ¥´‘⁄º«’  ˝æ›Ã·Ωª∫Û‘ŸΩ¯––
    support≥ˆ‘∫Ω·À„±ÿ–Î≥ˆ‘∫ = 20    '≤°»ÀΩ·’  ±»Áπ˚—°‘Ò≥ˆ‘∫Ω·’ £¨æÕºÏ≤È±ÿ–Î≥ˆ‘∫≤≈ø…“‘Ω¯––
    
    supportπ“∫≈ π”√∏ˆ»À’ ªß = 21    ' π”√“Ω±£π“∫≈ ± «∑Ò π”√∏ˆ»À’ ªßΩ¯––÷ß∏∂

    support√≈’Ô¡¨–¯ ’∑— = 22        '√≈’Ô‘⁄…Ì∑›—È÷§∫Û£¨ø…Ω¯––∂‡¥Œ ’∑—≤Ÿ◊˜
    support√≈’Ô ’∑—ÕÍ≥…∫Û—È÷§ = 23  '‘⁄√≈’Ô ’∑—ÕÍ≥…£¨ «∑Ò‘Ÿ¥Œµ˜”√…Ì∑›—È÷§
    
    support“Ω÷ˆ…œ¥´ = 24            '“Ω÷ˆ≤˙…˙∑—”√ ± «∑Ò µ ±¥´ ‰
    support∑÷±“¥¶¿Ì = 25            '“Ω±£≤°»À «∑Ò¥¶¿Ì∑÷±“
    support÷–ÕæΩ·À„Ωˆ¥¶¿Ì“—…œ¥´≤ø∑÷ = 26 'Ã·π©∂‘“—…œ¥´≤ø∑÷ ˝æ›µƒΩ·À„π¶ƒ‹
    support‘ –Ì≥Âœ˙“—Ω·’ µƒº«’ µ•æ› = 27 ' «∑Ò‘ –Ì≥Âœ˙º«’ µ•æ›£¨»Áπ˚∏√µ•æ›“—æ≠Ω·’ 
    
    support‘ –Ì≤ø∑›≥Âœ˙µ•æ› = 28
    support≥ˆ‘∫Œﬁ µº Ωª“◊ = 29       '≥ˆ‘∫Ω”ø⁄÷– «∑Ò“™”ÎΩ”ø⁄…ÃΩ¯––Ωª“◊
    support‘ –Ì≤ø∑÷≥Âœ˙√˜œ∏ = 32    '‘ –Ì’Î∂‘◊°‘∫º«’ ¥¶∑Ωµƒ√ø± √˜œ∏Ω¯––≤ø∑÷≥Âœ˙
    support√≈’ÔΩ·À„◊˜∑œ = 33        '“Ω±£ «∑Ò÷ß≥÷√≈’ÔΩ·À„◊˜∑œ£¨≤ª÷ß≥÷÷ª”–∏ˆ»À’ ’ ªß‘≠—˘ÕÀ,∆‰”‡µƒ“Ω±£Ω·À„∑Ω ΩÕÀŒ™œ÷Ω,÷ß≥÷µƒ‘Ÿ≈–∂œ√ø“ª÷÷Ω·À„∑Ω Ω «∑Ò‘ –ÌÕÀªÿ
    support◊°‘∫Ω·À„◊˜∑œ = 34        'HIS º÷’»œŒ™◊°‘∫÷ß≥÷Ω·À„◊˜∑œ£¨»Áπ˚≤ª÷ß≥÷–Ë“Ω±£Ω”ø⁄ƒ⁄≤ø¥¶¿Ì£¨∑µªÿºŸº¥ø…£ª‘ˆº”∏√≤Œ ˝ «Œ™¡À≈‰∫œGetCapabilityΩª“◊¿¥ºÏ≤È∏˜÷÷Ω·À„∑Ω Ω «∑Ò÷ß≥÷»´ÕÀ
    support∏∫ ˝º«’  = 35            ' «∑Ò‘ –Ì∏∫ ˝º«’ £¨≤Ÿ◊˜‘± ◊œ»“™”µ”–∏∫ ˝º«’ µƒ»®œﬁ°£¥À≤Œ ˝»± °Œ™’Ê£¨≤ª÷ß≥÷µƒΩ”ø⁄–Ëµ•∂¿¥¶¿Ì
    supportΩ·’ _÷∏∂®◊°‘∫¥Œ ˝ = 36   ' «∑Ò÷ß≥÷÷∏∂®◊°‘∫¥Œ ˝Ω¯––“Ω±£Ω·À„
    supportΩ·’ _÷∏∂®»’∆⁄∑∂Œß = 37   ' «∑Ò÷ß≥÷÷∏∂®Ω·’ »’∆⁄∑∂ŒßΩ¯––“Ω±£Ω·À„
    supportΩ·’ _…Ë÷√”§∂˘∑—Ãıº˛ = 38 ' «∑Ò‘ –Ì…Ë÷√”§∂˘∑—Ãıº˛
    
    support√≈’ÔΩ·’  = 41            ' «∑Ò÷ß≥÷√≈’Ô“Ω±£≤°»Àµƒº«’ ∑—”√ π”√√≈’ÔΩ·’ ¿¥ÕÍ≥…
End Enum

Private mobjPlugIn As Object             'Õ‚π“Ω”ø⁄∂‘œÛ

Public Property Get In_PlugIn() As Object
    Set In_PlugIn = mobjPlugIn
End Property
Public Property Set In_PlugIn(ByVal objVal As Object)
    Set mobjPlugIn = objVal
End Property
 
Private Sub initPara()
    '¡ı–À∫Í:‘ˆº”–° ˝∏Ò ΩªØ¥Æ
    With mFMT
        .FM_≥…±æº€ = GetFmtString(mintUnit, g_≥…±æº€)
        .FM_Ω∂Ó = GetFmtString(mintUnit, g_Ω∂Ó)
        .FM_¡„ €º€ = GetFmtString(mintUnit, g_ €º€)
        .FM_ ˝¡ø = GetFmtString(mintUnit, g_ ˝¡ø)
    End With
    With mOraFMT
        .FM_≥…±æº€ = GetFmtString(mintUnit, g_≥…±æº€, True)
        .FM_Ω∂Ó = GetFmtString(mintUnit, g_Ω∂Ó, True)
        .FM_¡„ €º€ = GetFmtString(mintUnit, g_ €º€, True)
        .FM_ ˝¡ø = GetFmtString(mintUnit, g_ ˝¡ø, True)
    End With
    With vsHeadGrid
      '  .Editable = flexEDKbdMouse
    End With
    
End Sub
Private Function RefreshData() As Boolean
    '-----------------------------------------------------------------------------------------------------------
    'π¶ƒ‹:÷ÿ–¬ªÒ»° ˝æ›
    '»Î≤Œ:
    '≥ˆ≤Œ:
    '∑µªÿ:≥…π¶,∑µªÿtrue,∑Ò‘Ú∑µªÿFalse
    '±‡÷∆:¡ı–À∫È
    '»’∆⁄:2008-05-03 21:09:18
    '-----------------------------------------------------------------------------------------------------------

    Dim rsTemp As ADODB.Recordset, strFields As String, strWere As String, lngRow As Long
    Dim str∑—”√ID As String
    Dim strNOS As String
    
    On Error GoTo ErrHandle
    Call InitRsStruct
    vsHeadGrid.Rows = 1
    mint…Û∫À±Í÷æ = 1
        
    ''''1°¢Ã·»°ª„◊‹ ˝æ›
    'µ•Œª£¨∞¸◊∞ªªÀ„
    Select Case mintUnit
    Case 0
        strFields = "X.º∆À„µ•Œª µ•Œª,1 ªªÀ„œµ ˝,A. ˝¡ø As œ˙’  ˝¡ø "
    Case Else
        strFields = "D.∞¸◊∞µ•Œª µ•Œª,d.ªªÀ„œµ ˝ ªªÀ„œµ ˝,A. ˝¡ø As œ˙’  ˝¡ø "
    End Select
    If CDate(mArrFilter("»’∆⁄∑∂Œß")(0)) <= CDate("1949-02-01") Then
        strWere = strWere & " And A.…Û∫À»À Is Null And A.◊¥Ã¨ = 0  "
    Else
        strWere = strWere & " And A.…Û∫À»À Is Null And A.◊¥Ã¨ = 0 And A.…Í«Î ±º‰ Between [3] And [4] "
    End If
    
    '≤°«¯/“Ωººø∆ “
    If Val(mArrFilter("…Í«Îø∆ “ID")) > 0 Then strWere = strWere & " And A.…Í«Î≤ø√≈id = [2] "
    '…Í«Î»À
    If Trim(mArrFilter("…Í«Î»À")) <> "" Then strWere = strWere & " And A.…Í«Î»À=[7] "
    '≤°»À–’√˚
    If Trim(mArrFilter("≤°»À–’√˚")) <> "" Then strWere = strWere & " And nvl(F.–’√˚,B.–’√˚)=[8] "
    strWere = strWere & IIf(Val(mArrFilter("◊°‘∫∫≈")) = 0, "", "             AND b.±Í ∂∫≈=[9] and b.√≈’Ô±Í÷æ=2 ")
    strWere = strWere & IIf(Val(mArrFilter("≤°»ÀID")) = 0, "", "             AND b.≤°»ÀiD=[10]  ")
    strWere = strWere & IIf(Trim(mArrFilter("¥≤∫≈")) = "", "", "             AND b.¥≤∫≈=[11]  ")

    'Àµ√˜:
    '1.≤ª∞¸∫¨≥ˆ‘∫≤°»À: F.◊¥Ã¨:0-’˝≥£◊°‘∫£ª1-…–Œ¥»Îø∆£ª2-’˝‘⁄◊™ø∆£ª3-“—‘§≥ˆ‘∫
    '2.–Ë“™π˝¬ÀµÙŒ¥∑¢¡œ≤ø∑›µƒ…Í«Î:‘≠‘Ú…œ‘⁄º«’ µƒœ˙’ …Û«Î ±, «≤ªª·≥ˆ‘∫∂‘Œ¥∑¢≤ø∑÷µƒ…Í«Î.
    gstrSQL = "" & _
    "   Select Distinct A. ’∑—œ∏ƒøid,'['||X.±‡¬Î||']'||X.√˚≥∆ as ≤ƒ¡œ√˚≥∆, X.πÊ∏Ò,A.±Í◊ºµ•º€ as ¡„ €º€, " & strFields & _
    "   From (  Select A. ’∑—œ∏ƒøid, Sum(A. ˝¡ø) As  ˝¡ø,B.±Í◊ºµ•º€  " & _
    "           From ◊°‘∫∑—”√º«¬º B, ≤°∞∏÷˜“≥ F, ≤°»À∑—”√œ˙’  A " & _
    "           Where A.…Í«Î¿‡±=1 And A.∑—”√id = B.ID And A.…Û∫À≤ø√≈id = [1] And B.≤°»Àid = F.≤°»Àid  " & _
    "                 And B.÷˜“≥id = F.÷˜“≥id  And F.≥ˆ‘∫»’∆⁄  Is Null And F.◊¥Ã¨  <> 3 " & _
    "                 " & vbCrLf & strWere & _
    "                 And Exists (Select 1 From “©∆∑ ’∑¢º«¬º C  Where C.∑—”√id = A.∑—”√id And C.…Û∫À»À Is Not Null And (C.º«¬º◊¥Ã¨ = 1 Or Mod(C.º«¬º◊¥Ã¨, 3) = 0))" & _
    "           Group By A. ’∑—œ∏ƒøid,b.±Í◊ºµ•º€) A,≤ƒ¡œÃÿ–‘ D,  ’∑—œÓƒø±√˚ E,  ’∑—œÓƒøƒø¬º X " & _
    " Where A. ’∑—œ∏ƒøid = D.≤ƒ¡œid And A. ’∑—œ∏ƒøid = X.ID And X.ID = E. ’∑—œ∏ƒøid(+) And E.–‘÷ (+) = 3 " & _
    " Order By ≤ƒ¡œ√˚≥∆"
    
    '[5],[6]œ÷‘⁄»°œ˚
    Set rsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "Ã·»°ÕÀ¡œ…Í«Î", _
        Val(mArrFilter("∑¢¡œ≤ø√≈id")), Val(mArrFilter("…Í«Îø∆ “id")), _
        CDate(mArrFilter("»’∆⁄∑∂Œß")(0)), CDate(mArrFilter("»’∆⁄∑∂Œß")(1)), _
        CDate(mArrFilter("»’∆⁄∑∂Œß")(0)), CDate(mArrFilter("»’∆⁄∑∂Œß")(1)), _
        Trim(mArrFilter("…Í«Î»À")), Trim(mArrFilter("≤°»À–’√˚")), _
        Val(mArrFilter("◊°‘∫∫≈")), Val(mArrFilter("≤°»ÀID")), Trim(mArrFilter("¥≤∫≈")))
    
    With vsHeadGrid
        .Clear 1
        .Rows = 2
        If rsTemp.RecordCount <> 0 Then .Rows = rsTemp.RecordCount + 1
        lngRow = 0
        Do While Not rsTemp.EOF
            lngRow = lngRow + 1
            .TextMatrix(lngRow, .ColIndex("…Û∫À")) = "°Ã"
            .TextMatrix(lngRow, .ColIndex("≤ƒ¡œ√˚≥∆")) = NVL(rsTemp!≤ƒ¡œ√˚≥∆)
            .TextMatrix(lngRow, .ColIndex("πÊ∏Ò")) = NVL(rsTemp!πÊ∏Ò)
            .TextMatrix(lngRow, .ColIndex("œ˙’  ˝¡ø")) = Format(Val(NVL(rsTemp!œ˙’  ˝¡ø)) / rsTemp!ªªÀ„œµ ˝, mFMT.FM_ ˝¡ø)
            .TextMatrix(lngRow, .ColIndex("œ˙’ Ω∂Ó")) = Format(Val(NVL(rsTemp!œ˙’  ˝¡ø)) * rsTemp!¡„ €º€, mFMT.FM_Ω∂Ó)
            .TextMatrix(lngRow, .ColIndex("µ•Œª")) = NVL(rsTemp!µ•Œª)
            .Cell(flexcpData, lngRow, .ColIndex("≤ƒ¡œ√˚≥∆")) = NVL(rsTemp! ’∑—œ∏ƒøid)
            .Cell(flexcpData, lngRow, .ColIndex("œ˙’  ˝¡ø")) = NVL(rsTemp!œ˙’  ˝¡ø)
            rsTemp.MoveNext
        Loop

    End With
    
    
    ''''2°¢Ã·»°√˜œ∏ ˝æ›
    'µ•Œª◊÷¥Æ
    Select Case mintUnit
    Case 0
        strFields = "X.º∆À„µ•Œª µ•Œª,1 ªªÀ„œµ ˝, A. ˝¡ø "
    Case Else
        strFields = "D.∞¸◊∞µ•Œª µ•Œª,D.ªªÀ„œµ ˝, A. ˝¡ø "
    End Select
    
    gstrSQL = "" & _
        "   Select µ•æ›, NO, “©∆∑ID as ≤ƒ¡œID, …Í«Î ±º‰, ±Í ∂∫≈, –’√˚, ¥≤∫≈, µ•Œª, ªªÀ„œµ ˝,ø™µ•ø∆ “, Sum( ˝¡ø) As œ˙’  ˝¡ø,¡„ €º€ " & _
        "   From (  Select Distinct C.µ•æ›, C.NO, C.“©∆∑ID, A.…Í«Î ±º‰, B.±Í ∂∫≈,B.±Í◊ºµ•º€ as ¡„ €º€, nvl(F.–’√˚,B.–’√˚) –’√˚, B.¥≤∫≈,P.√˚≥∆ ø™µ•ø∆ “, " & strFields & " " & _
        "           From ≤°»À∑—”√œ˙’  A, ◊°‘∫∑—”√º«¬º B,“©∆∑ ’∑¢º«¬º C, ≤ƒ¡œÃÿ–‘ D,  ’∑—œÓƒøƒø¬º X, ≤ø√≈±Ì P, ≤°∞∏÷˜“≥ F, ≤ø√≈±Ì E " & _
        "           Where   A.…Í«Î¿‡±=1 And A.∑—”√id = B.ID And B.ID = C.∑—”√id And B.ø™µ•≤ø√≈id = P.ID And B. ’∑—œ∏ƒøid = D.≤ƒ¡œid And B. ’∑—œ∏ƒøid = X.ID  " & _
        "                   And  B.≤°»Àid = F.≤°»Àid And B.÷˜“≥id = F.÷˜“≥id And F.≥ˆ‘∫»’∆⁄ Is Null And F.◊¥Ã¨ <> 3 " & _
        "                   And A.…Í«Î≤ø√≈id = E.ID And B.÷¥––≤ø√≈id = [1]  " & _
        "                   And C.…Û∫À»À Is Not Null And C.µ•æ› In (24, 25, 26) And (C.º«¬º◊¥Ã¨ = 1 Or Mod(C.º«¬º◊¥Ã¨, 3) = 0) " & strWere & ")" & _
        "           Group By µ•æ›, NO, “©∆∑ID, …Í«Î ±º‰, ±Í ∂∫≈, –’√˚, ¥≤∫≈, µ•Œª, ªªÀ„œµ ˝,¡„ €º€,ø™µ•ø∆ “ "
        
    Set rsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "Ã·»°µ•æ›√˜œ∏", _
          Val(mArrFilter("∑¢¡œ≤ø√≈id")), Val(mArrFilter("…Í«Îø∆ “id")), _
          CDate(mArrFilter("»’∆⁄∑∂Œß")(0)), CDate(mArrFilter("»’∆⁄∑∂Œß")(1)), _
          CDate(mArrFilter("»’∆⁄∑∂Œß")(0)), CDate(mArrFilter("»’∆⁄∑∂Œß")(1)), _
          Trim(mArrFilter("…Í«Î»À")), Trim(mArrFilter("≤°»À–’√˚")), _
          Val(mArrFilter("◊°‘∫∫≈")), Val(mArrFilter("≤°»ÀID")), Trim(mArrFilter("¥≤∫≈")))
      
    Do While Not rsTemp.EOF
        With mrsDetail
            .AddNew
    
            !µ•æ› = rsTemp!µ•æ›
            !NO = rsTemp!NO
            !≤ƒ¡œID = rsTemp!≤ƒ¡œID
            !…Í«Î ±º‰ = Format(rsTemp!…Í«Î ±º‰, "yyyy-mm-dd hh:mm:ss")
            !±Í ∂∫≈ = rsTemp!±Í ∂∫≈
            !–’√˚ = rsTemp!–’√˚
            !¥≤∫≈ = rsTemp!¥≤∫≈
            !œ˙’  ˝¡ø = rsTemp!œ˙’  ˝¡ø
            !œ˙’ Ω∂Ó = rsTemp!œ˙’  ˝¡ø * rsTemp!¡„ €º€
            !ªªÀ„œµ ˝ = rsTemp!ªªÀ„œµ ˝
            !µ•Œª = rsTemp!µ•Œª
            !ø™µ•ø∆ “ = rsTemp!ø™µ•ø∆ “
            .Update
            
            If InStr(1, strNOS, rsTemp!NO) = 0 Then
                strNOS = IIf(strNOS = "", "", strNOS & ",") & rsTemp!NO
            End If
            rsTemp.MoveNext
        End With
    Loop
     
    ''''3°¢Ã·»°≈˙¥Œ√˜œ∏ ˝æ›
    'µ•Œª£¨∞¸◊∞ªªÀ„
    Select Case mintUnit
    Case 0
        strFields = "X.º∆À„µ•Œª µ•Œª,1 ªªÀ„œµ ˝,C. µº  ˝¡ø As ◊ºÕÀ ˝¡ø,A. ˝¡ø As œ˙’  ˝¡ø"
    Case Else
        strFields = "D.∞¸◊∞µ•Œª µ•Œª,D.ªªÀ„œµ ˝ ,C. µº  ˝¡ø As ◊ºÕÀ ˝¡ø,A. ˝¡ø As œ˙’  ˝¡ø"
    End Select
    
    ' 'Having Sum( µº  ˝¡ø) > 0
    gstrSQL = "Select /*+ Rule*/ C.ID As  ’∑¢ID, C.“©∆∑ID, C.µ•æ›, C.NO, C.–Ú∫≈ As  ’∑¢–Ú∫≈, C.≤˙µÿ, C.≈˙∫≈, C.–ß∆⁄, F.œ’¿‡, P.√˚≥∆ As ø™µ•ø∆ “,B.±Í◊ºµ•º€ as ¡„ €º€, " & _
        " A.∑—”√id, B.–Ú∫≈ As ∑—”√–Ú∫≈, B.º«¬º–‘÷ , B.÷˜“≥ID, A.…Í«Î ±º‰, C.¡„ €º€ As µ•º€, " & strFields & " " & _
        " From ≤°»À∑—”√œ˙’  A, ◊°‘∫∑—”√º«¬º B, " & _
        " (Select A.ID, A.µ•æ›, A.NO, A.–Ú∫≈, A.“©∆∑id, A.≤˙µÿ, A.≈˙∫≈, A.–ß∆⁄, A.∑—”√id, B. µº  ˝¡ø, A.¡„ €º€ " & _
        " From “©∆∑ ’∑¢º«¬º A, " & _
        " (Select a.µ•æ›, a.NO, a.–Ú∫≈, a.“©∆∑id, Sum(Nvl(a.∏∂ ˝, 1) * a. µº  ˝¡ø) As  µº  ˝¡ø " & _
        " From “©∆∑ ’∑¢º«¬º a ,Table(Cast(f_Str2list([12]) As zlTools.t_Strlist)) b " & _
        " Where a.µ•æ› In (24, 25,26) And a.…Û∫À»’∆⁄ Is Not Null And a.No=b.Column_Value "
        
    gstrSQL = gstrSQL & " Group By µ•æ›, NO, –Ú∫≈, “©∆∑id " & _
        " ) B" & _
        " Where A.NO = B.NO And A.µ•æ› = B.µ•æ› And A.“©∆∑id + 0 = B.“©∆∑id And A.–Ú∫≈ = B.–Ú∫≈ And A.…Û∫À»À Is Not Null " & _
        " And (A.º«¬º◊¥Ã¨ = 1 Or Mod(A.º«¬º◊¥Ã¨, 3) = 0))C, " & _
        " ≤ƒ¡œÃÿ–‘ D,  ’∑—œÓƒøƒø¬º X, ≤ø√≈±Ì P, ≤°∞∏÷˜“≥ F, ≤ø√≈±Ì E " & _
        " Where A.…Í«Î¿‡±=1 And A.∑—”√id = B.ID And B.No = C.No And B.ID = C.∑—”√id And B.ø™µ•≤ø√≈id = P.ID And B. ’∑—œ∏ƒøid = D.≤ƒ¡œid And B. ’∑—œ∏ƒøid = X.ID And B.≤°»Àid = F.≤°»Àid And B.÷˜“≥id = F.÷˜“≥id And A.…Í«Î≤ø√≈id = E.ID " & _
        " And B.÷¥––≤ø√≈id = [1] " & strWere

    gstrSQL = gstrSQL & " Order By A.…Í«Î ±º‰, C.µ•æ›, C.NO, C.–Ú∫≈ Desc "
    
    
    Set rsTemp = zlDatabase.OpenSQLRecord(gstrSQL, "Ã·»°≈˙¥Œ√˜œ∏", _
          Val(mArrFilter("∑¢¡œ≤ø√≈id")), Val(mArrFilter("…Í«Îø∆ “id")), _
          CDate(mArrFilter("»’∆⁄∑∂Œß")(0)), CDate(mArrFilter("»’∆⁄∑∂Œß")(1)), _
          CDate(mArrFilter("»’∆⁄∑∂Œß")(0)), CDate(mArrFilter("»’∆⁄∑∂Œß")(1)), _
          Trim(mArrFilter("…Í«Î»À")), Trim(mArrFilter("≤°»À–’√˚")), _
          Val(mArrFilter("◊°‘∫∫≈")), Val(mArrFilter("≤°»ÀID")), Trim(mArrFilter("¥≤∫≈")), strNOS)
          
    Do While Not rsTemp.EOF
        With mrsBatch
            .AddNew
            !µ•æ› = rsTemp!µ•æ›
            !NO = rsTemp!NO
            !≤ƒ¡œID = rsTemp!“©∆∑ID
            !…Í«Î ±º‰ = Format(rsTemp!…Í«Î ±º‰, "yyyy-mm-dd hh:mm:ss")
            ! ’∑¢–Ú∫≈ = rsTemp! ’∑¢–Ú∫≈
            !≤˙µÿ = rsTemp!≤˙µÿ
            !≈˙∫≈ = rsTemp!≈˙∫≈
            !–ß∆⁄ = rsTemp!–ß∆⁄
            !◊ºÕÀ ˝¡ø = rsTemp!◊ºÕÀ ˝¡ø
            !œ˙’  ˝¡ø = rsTemp!œ˙’  ˝¡ø
            !œ˙’ Ω∂Ó = rsTemp!œ˙’  ˝¡ø * rsTemp!¡„ €º€
            !ªªÀ„œµ ˝ = rsTemp!ªªÀ„œµ ˝
            !µ•Œª = rsTemp!µ•Œª
            ! ’∑¢ID = rsTemp! ’∑¢ID
            !÷˜“≥id = Val(NVL(rsTemp!÷˜“≥id))
            !∑—”√–Ú∫≈ = rsTemp!∑—”√–Ú∫≈
            !œ’¿‡ = rsTemp!œ’¿‡
            !∑—”√ID = rsTemp!∑—”√ID
            !º«¬º–‘÷  = rsTemp!º«¬º–‘÷ 
            !…Û∫À±Í÷æ = 1
            .Update
            rsTemp.MoveNext
        End With
    Loop
    Call AutoExpendQuantity
    ''''''4°¢∂®ŒªµΩª„◊‹µ⁄“ª––£¨≤¢Ã·»°µ⁄“ª––√˜œ∏ ˝æ›
    With vsHeadGrid
        If .Rows > 1 Then
            .Row = 1: .TopRow = 1
            Call LoadDetailList(Val(vsHeadGrid.TextMatrix(1, vsHeadGrid.ColIndex("≤ƒ¡œ√˚≥∆"))))
        End If
    End With
    With vsDetail
        'Ã·»°µ⁄“ª––≈˙¥Œ√˜œ∏ ˝æ›
        If .Rows > 1 Then
            Call LoadBatchList(Val(.TextMatrix(1, .ColIndex("µ•æ›"))), .TextMatrix(1, .ColIndex("NO")), .RowData(1), .TextMatrix(1, .ColIndex("…Í«Î ±º‰")), False)
        End If
    End With
    Exit Function
ErrHandle:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function


Private Function InitRsStruct() As Boolean
    '-----------------------------------------------------------------------------------------------------------
    'π¶ƒ‹:≥ı ºªØƒ⁄≤øº«¬ººØ
    '»Î≤Œ:
    '≥ˆ≤Œ:
    '∑µªÿ:≥…π¶,∑µªÿtrue,∑Ò‘Ú∑µªÿFalse
    '±‡÷∆:¡ı–À∫È
    '»’∆⁄:2008-05-03 21:08:22
    '-----------------------------------------------------------------------------------------------------------
    Set mrsDetail = New ADODB.Recordset
    With mrsDetail
        If .State = 1 Then .Close
        .Fields.Append "µ•æ›", adDouble, 18, adFldIsNullable
        .Fields.Append "NO", adLongVarChar, 20, adFldIsNullable
        .Fields.Append "≤ƒ¡œID", adDouble, 18, adFldIsNullable
        .Fields.Append "…Í«Î ±º‰", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "±Í ∂∫≈", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "–’√˚", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "¥≤∫≈", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "œ˙’  ˝¡ø", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "œ˙’ Ω∂Ó", adDouble, 18, adFldIsNullable
        .Fields.Append "ªªÀ„œµ ˝", adDouble, 18, adFldIsNullable
        .Fields.Append "µ•Œª", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "ø™µ•ø∆ “", adLongVarChar, 50, adFldIsNullable
        .CursorLocation = adUseClient
        .CursorType = adOpenStatic
        .LockType = adLockOptimistic
        .Open
    End With
    Set mrsBatch = New ADODB.Recordset
    With mrsBatch
        If .State = 1 Then .Close
        .Fields.Append "µ•æ›", adDouble, 18, adFldIsNullable
        .Fields.Append "NO", adLongVarChar, 20, adFldIsNullable
        .Fields.Append "≤ƒ¡œID", adDouble, 18, adFldIsNullable
        .Fields.Append "…Í«Î ±º‰", adLongVarChar, 50, adFldIsNullable
        .Fields.Append " ’∑¢–Ú∫≈", adDouble, 18, adFldIsNullable
        .Fields.Append "≤˙µÿ", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "≈˙∫≈", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "–ß∆⁄", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "◊ºÕÀ ˝¡ø", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "œ˙’  ˝¡ø", adLongVarChar, 50, adFldIsNullable
        .Fields.Append "œ˙’ Ω∂Ó", adDouble, 18, adFldIsNullable
        .Fields.Append "ªªÀ„œµ ˝", adDouble, 18, adFldIsNullable
        .Fields.Append "µ•Œª", adLongVarChar, 50, adFldIsNullable
        .Fields.Append " ’∑¢ID", adDouble, 18, adFldIsNullable
        .Fields.Append "÷˜“≥ID", adDouble, 18, adFldIsNullable
        .Fields.Append "∑—”√–Ú∫≈", adDouble, 18, adFldIsNullable
        .Fields.Append "œ’¿‡", adDouble, 18, adFldIsNullable
        .Fields.Append "∑—”√ID", adDouble, 18, adFldIsNullable
        .Fields.Append "º«¬º–‘÷ ", adDouble, 18, adFldIsNullable
        .Fields.Append "…Û∫À±Í÷æ", adDouble, 18, adFldIsNullable
        
        .CursorLocation = adUseClient
        .CursorType = adOpenStatic
        .LockType = adLockOptimistic
        .Open
    End With
End Function

Private Sub chk»´—°_Click()
    Dim n As Integer
    With vsHeadGrid
        If .Rows > 1 Then
            If Val(.Cell(flexcpData, 1, .ColIndex("≤ƒ¡œ√˚≥∆"))) = 0 Then Exit Sub
        End If
        For n = 1 To .Rows - 1
            If Val(.Cell(flexcpData, n, .ColIndex("≤ƒ¡œ√˚≥∆"))) <> 0 Then
                .TextMatrix(n, .ColIndex("…Û∫À")) = IIf(chk»´—°.Value = 1, "°Ã", "")
            End If
        Next
    End With
    With mrsBatch
        .Filter = 0
        If mrsBatch.RecordCount <> 0 Then .MoveFirst
        Do While Not .EOF
            !…Û∫À±Í÷æ = IIf(chk»´—°.Value = 1, 1, 0)
            .Update
            .MoveNext
        Loop
    End With
End Sub
Private Sub Form_Load()
    zl_vsGrid_Para_Restore mlngModule, vsHeadGrid, Me.Caption, "œ˙’ Œ¥…Û_Head"
    zl_vsGrid_Para_Restore mlngModule, vsDetail, Me.Caption, "œ˙’ Œ¥…Û_Detail"
    zl_vsGrid_Para_Restore mlngModule, vsBatch, Me.Caption, "œ˙’ Œ¥…Û_Batch"
    
    Call initPara
End Sub
Private Sub AutoExpendQuantity()
    'øº¬«µΩÕ¨“ª∑—”√ID∂‘”¶∂‡∏ˆ ’∑¢IDµƒ«Èøˆ£¨–Ë“™Ω´œ˙’  ˝¡ø∑÷Ω‚µΩ∂‡∏ˆ ’∑¢º«¬º…œ
    '∑÷Ω‚µƒ‘≠‘Ú «∞¥–Ú∫≈¥Ûµƒ”≈œ»∑÷≈‰£®“—∞¥–Ú∫≈Ωµ–Ú≈≈–Ú£©
    Dim n As Integer
    Dim dbl◊ºÕÀ ˝¡ø As Double
    Dim dbl £”‡ ˝¡ø As Double
    Dim int ’∑¢–Ú∫≈ As Integer
    Dim lng∑—”√ID As Long
    Dim str…Í«Î ±º‰ As String
    
    With mrsBatch
        If mrsBatch.RecordCount <> 0 Then .MoveFirst
        For n = 1 To .RecordCount
            dbl◊ºÕÀ ˝¡ø = !◊ºÕÀ ˝¡ø
            
            If lng∑—”√ID = !∑—”√ID And str…Í«Î ±º‰ = !…Í«Î ±º‰ Then

            Else
                dbl £”‡ ˝¡ø = !œ˙’  ˝¡ø
            End If
            
            If dbl £”‡ ˝¡ø >= dbl◊ºÕÀ ˝¡ø Then
                dbl £”‡ ˝¡ø = dbl £”‡ ˝¡ø - dbl◊ºÕÀ ˝¡ø
                !œ˙’  ˝¡ø = dbl◊ºÕÀ ˝¡ø
            Else
                !œ˙’  ˝¡ø = dbl £”‡ ˝¡ø
                dbl £”‡ ˝¡ø = 0
            End If
            
            lng∑—”√ID = !∑—”√ID
            str…Í«Î ±º‰ = !…Í«Î ±º‰
            
            .Update
            .MoveNext
        Next
    End With
End Sub
Private Sub LoadDetailList(ByVal lng≤ƒ¡œID As Long)
    '-----------------------------------------------------------------------------------------------------------
    'π¶ƒ‹:º”‘ÿ√˜œ∏ ˝æ›
    '»Î≤Œ:lng≤ƒ¡œID-≤ƒ¡œID
    '≥ˆ≤Œ:
    '∑µªÿ:≥…π¶,∑µªÿtrue,∑Ò‘Ú∑µªÿFalse
    '±‡÷∆:¡ı–À∫È
    '»’∆⁄:2008-05-03 22:25:04
    '-----------------------------------------------------------------------------------------------------------
    Dim lngRow As Long
    With vsDetail
        .Clear 1
        .Rows = 2
        mrsDetail.Filter = "≤ƒ¡œID=" & lng≤ƒ¡œID
        If mrsDetail.RecordCount = 0 Then Exit Sub
        .Rows = mrsDetail.RecordCount + 1
        lngRow = 0
        Do While Not mrsDetail.EOF
            lngRow = lngRow + 1
            .RowData(lngRow) = Val(NVL(mrsDetail!≤ƒ¡œID))
            .TextMatrix(lngRow, .ColIndex("µ•æ›")) = NVL(mrsDetail!µ•æ›)
            .TextMatrix(lngRow, .ColIndex("NO")) = NVL(mrsDetail!NO)
            .TextMatrix(lngRow, .ColIndex("…Í«Î ±º‰")) = Format(mrsDetail!…Í«Î ±º‰, "yyyy-mm-dd hh:mm:ss")
            .TextMatrix(lngRow, .ColIndex("√≈’Ô(◊°‘∫)∫≈")) = NVL(mrsDetail!±Í ∂∫≈)
            .TextMatrix(lngRow, .ColIndex("–’√˚")) = NVL(mrsDetail!–’√˚)
            .TextMatrix(lngRow, .ColIndex("¥≤∫≈")) = NVL(mrsDetail!¥≤∫≈)
            .TextMatrix(lngRow, .ColIndex("œ˙’  ˝¡ø")) = Format(Val(NVL(mrsDetail!œ˙’  ˝¡ø)) / mrsDetail!ªªÀ„œµ ˝, mFMT.FM_ ˝¡ø)
            .TextMatrix(lngRow, .ColIndex("œ˙’ Ω∂Ó")) = Format(Val(NVL(mrsDetail!œ˙’ Ω∂Ó)), mFMT.FM_Ω∂Ó)
            .TextMatrix(lngRow, .ColIndex("µ•Œª")) = NVL(mrsDetail!µ•Œª)
            .TextMatrix(lngRow, .ColIndex("ø™µ•ø∆ “")) = NVL(mrsDetail!ø™µ•ø∆ “)
            
            .Cell(flexcpData, lngRow, .ColIndex("œ˙’  ˝¡ø")) = Val(NVL(mrsDetail!œ˙’  ˝¡ø))
            .Cell(flexcpData, lngRow, .ColIndex("NO")) = Val(NVL(mrsDetail!ªªÀ„œµ ˝))
            mrsDetail.MoveNext
        Loop
        .Cell(flexcpForeColor, 1, .ColIndex("œ˙’  ˝¡ø"), .Rows - 1, .ColIndex("œ˙’  ˝¡ø")) = vbBlue
    End With
End Sub
Private Sub LoadBatchList(ByVal intµ•æ› As Integer, _
                ByVal strNo As String, ByVal lng≤ƒ¡œID As Long, _
                ByVal str…Í«Î ±º‰ As String, ByVal bln∏¸–¬±Í÷æ As Boolean)
                
    '-----------------------------------------------------------------------------------------------------------
    'π¶ƒ‹:º”‘ÿ≈˙¥Œ–≈œ¢
    '»Î≤Œ:
    '≥ˆ≤Œ:
    '∑µªÿ:≥…π¶,∑µªÿtrue,∑Ò‘Ú∑µªÿFalse
    '±‡÷∆:¡ı–À∫È
    '»’∆⁄:2008-05-03 22:42:02
    '-----------------------------------------------------------------------------------------------------------
    Dim lngRow As Long
    With vsBatch
        mrsBatch.Filter = "µ•æ›=" & intµ•æ› & _
                " And No='" & strNo & "' " & _
                " And ≤ƒ¡œID=" & lng≤ƒ¡œID & _
                " And …Í«Î ±º‰='" & str…Í«Î ±º‰ & "' "
        mrsBatch.Sort = " ’∑¢–Ú∫≈ Desc"
        .Clear 1
        .Rows = 2
        If mrsBatch.RecordCount = 0 Then Exit Sub
        
        If mrsBatch.RecordCount = 0 Then
            vsDetail.Height = Me.ScaleHeight - vsDetail.Top
            picBatHsc.Visible = False
        Else
            picBatHsc.Top = Me.ScaleHeight - 1935
            vsDetail.Height = picBatHsc.Top - vsDetail.Top
            vsBatch.Top = picBatHsc.Top + picBatHsc.Height
            vsBatch.Height = Me.ScaleHeight - Me.vsBatch.Top
            picBatHsc.Visible = True
        End If
            
        .Rows = mrsBatch.RecordCount + 1
        mrsBatch.MoveFirst
        lngRow = 0
        Do While Not mrsBatch.EOF
                lngRow = lngRow + 1
                .RowData(lngRow) = Val(NVL(mrsBatch!≤ƒ¡œID))
                vsBatch.TextMatrix(lngRow, .ColIndex("µ•æ›")) = NVL(mrsBatch!µ•æ›)
                vsBatch.TextMatrix(lngRow, .ColIndex("NO")) = NVL(mrsBatch!NO)
                vsBatch.TextMatrix(lngRow, .ColIndex("…Í«Î ±º‰")) = Format(mrsBatch!…Í«Î ±º‰, "yyyy-mm-dd hh:mm:ss")
                vsBatch.TextMatrix(lngRow, .ColIndex("≤˙µÿ")) = NVL(mrsBatch!≤˙µÿ)
                vsBatch.TextMatrix(lngRow, .ColIndex("≈˙∫≈")) = NVL(mrsBatch!≈˙∫≈)
                vsBatch.TextMatrix(lngRow, .ColIndex("–ß∆⁄")) = Format(mrsBatch!–ß∆⁄, "yyyy-mm-dd")
                vsBatch.TextMatrix(lngRow, .ColIndex("◊ºÕÀ ˝¡ø")) = Format(Val(NVL(mrsBatch!◊ºÕÀ ˝¡ø)) / mrsBatch!ªªÀ„œµ ˝, mFMT.FM_ ˝¡ø)
                vsBatch.TextMatrix(lngRow, .ColIndex("œ˙’  ˝¡ø")) = Format(Val(NVL(mrsBatch!œ˙’  ˝¡ø)) / mrsBatch!ªªÀ„œµ ˝, mFMT.FM_ ˝¡ø)
                vsBatch.TextMatrix(lngRow, .ColIndex("œ˙’ Ω∂Ó")) = Format(Val(NVL(mrsBatch!œ˙’ Ω∂Ó)), mFMT.FM_Ω∂Ó)
                vsBatch.TextMatrix(lngRow, .ColIndex("µ•Œª")) = NVL(mrsBatch!µ•Œª)
                
                vsBatch.Cell(flexcpData, lngRow, .ColIndex("◊ºÕÀ ˝¡ø")) = Val(NVL(mrsBatch!◊ºÕÀ ˝¡ø))
                vsBatch.Cell(flexcpData, lngRow, .ColIndex("œ˙’  ˝¡ø")) = Val(NVL(mrsBatch!œ˙’  ˝¡ø))
                vsBatch.Cell(flexcpData, lngRow, .ColIndex("NO")) = Val(NVL(mrsBatch!ªªÀ„œµ ˝))
                If bln∏¸–¬±Í÷æ Then
                    mrsBatch!…Û∫À±Í÷æ = mint…Û∫À±Í÷æ
                    mrsBatch.Update
                End If
            mrsBatch.MoveNext
        Loop
        .Cell(flexcpForeColor, 1, .ColIndex("œ˙’  ˝¡ø"), lngRow, .ColIndex("œ˙’  ˝¡ø")) = vbBlue
    End With
End Sub

Private Sub Form_Resize()
    
    With vsHeadGrid
        .Left = ScaleLeft
        .Width = ScaleWidth - .Left
        .Height = IIf(picHsc.Top - Top < 500, 500, picHsc.Top - Top)
        picHsc.Top = .Top + .Height
    End With
    With vsDetail
        .Top = picHsc.Top + picHsc.Height
        .Width = vsHeadGrid.Width
        If picBatHsc.Visible Then
            .Height = IIf(picBatHsc.Top - .Top < 500, 500, picBatHsc.Top - .Top)
            picBatHsc.Top = .Top + .Height
        Else
            .Height = Me.ScaleHeight - .Top
        End If
    End With
    
    If picBatHsc.Visible = True Then
        With vsBatch
            .Top = picBatHsc.Top + picBatHsc.Height
            .Width = vsHeadGrid.Width
            .Height = IIf(Me.ScaleHeight - .Top < 0, 0, Me.ScaleHeight - .Top)
            .Left = ScaleLeft
        End With
    End If
End Sub

Private Sub Form_Unload(Cancel As Integer)
    zl_vsGrid_Para_Save mlngModule, vsHeadGrid, Me.Caption, "œ˙’ Œ¥…Û_Head"
    zl_vsGrid_Para_Save mlngModule, vsDetail, Me.Caption, "œ˙’ Œ¥…Û_Detail"
    zl_vsGrid_Para_Save mlngModule, vsBatch, Me.Caption, "œ˙’ Œ¥…Û_Batch"
End Sub

Private Sub vsBatch_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    With vsBatch
        Select Case .Col
        Case .ColIndex("œ˙’  ˝¡ø")
            If .TextMatrix(Row, .ColIndex("µ•æ›")) = "" Then Cancel = True
        Case Else
            Cancel = True
        End Select
    End With
End Sub

 

Private Sub vsDetail_EnterCell()
    Dim lng≤ƒ¡œID As Long
    With vsDetail
        If .Row > 0 Then
            lng≤ƒ¡œID = IIf(IsNull(.RowData(.Row)), 0, .RowData(.Row))
            'Ã·»°≈˙¥Œ√˜œ∏ ˝æ›
            Call LoadBatchList(Val(.TextMatrix(.Row, .ColIndex("µ•æ›"))), .TextMatrix(.Row, .ColIndex("NO")), lng≤ƒ¡œID, .TextMatrix(.Row, .ColIndex("…Í«Î ±º‰")), False)
        End If
    End With
End Sub

 
Private Sub vsHeadGrid_Click()
    Dim bln∏¸–¬±Í÷æ As Boolean
    
    With vsHeadGrid
        If .Row > 0 Then
            If .Cell(flexcpData, .Row, .ColIndex("≤ƒ¡œ√˚≥∆")) = 0 Then Exit Sub
        End If
        
        
        If .Row > 0 And .Col = .ColIndex("…Û∫À") Then
            If .TextMatrix(.Row, .Col) = "°Ã" Then
                .TextMatrix(.Row, .Col) = "°¡"
                mint…Û∫À±Í÷æ = 2
            ElseIf .TextMatrix(.Row, .Col) = "°¡" Then
                .TextMatrix(.Row, .Col) = ""
                mint…Û∫À±Í÷æ = 0
            Else
                .TextMatrix(.Row, .Col) = "°Ã"
                mint…Û∫À±Í÷æ = 1
            End If
            bln∏¸–¬±Í÷æ = True
        End If
        
        If .Row > 0 Then
            'Ã·»°√˜œ∏ ˝æ›
            Call LoadDetailList(Val(.Cell(flexcpData, .Row, .ColIndex("≤ƒ¡œ√˚≥∆"))))
        End If
    End With
    
    'Ã·»°≈˙¥Œ√˜œ∏ ˝æ›
    With vsDetail
        Call LoadBatchList(Val(.TextMatrix(.Row, .ColIndex("µ•æ›"))), .TextMatrix(.Row, .ColIndex("NO")), .RowData(.Row), .TextMatrix(.Row, .ColIndex("…Í«Î ±º‰")), bln∏¸–¬±Í÷æ)
    End With
End Sub


Private Sub vsBatch_KeyPressEdit(ByVal Row As Long, ByVal Col As Long, KeyAscii As Integer)
    '÷ªƒ‹ ‰»Î ˝◊÷
    With vsBatch
        If Col = .ColIndex("œ˙’  ˝¡ø") Then
            If InStr("1234567890" + Chr(46) + Chr(8), Chr(KeyAscii)) = 0 Then
                KeyAscii = 0
            End If
        End If
    End With
End Sub

Private Sub vsBatch_ValidateEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    Dim dblKey As Double
    With vsBatch
        dblKey = Val(.EditText)

        If dblKey > Val(.TextMatrix(Row, .ColIndex("◊ºÕÀ ˝¡ø"))) Or dblKey < 0 Then
            dblKey = Val(.TextMatrix(Row, .ColIndex("◊ºÕÀ ˝¡ø")))
        End If
        .EditText = Format(dblKey, mFMT.FM_ ˝¡ø)
        .TextMatrix(Row, .ColIndex("œ˙’  ˝¡ø")) = Format(dblKey, mFMT.FM_ ˝¡ø)

        mrsBatch.Filter = "µ•æ›=" & Val(.TextMatrix(Row, .ColIndex("µ•æ›"))) & _
                        " And No='" & .TextMatrix(Row, .ColIndex("NO")) & "' " & _
                        " And ≤ƒ¡œID=" & .RowData(Row) & _
                        " And  ’∑¢–Ú∫≈=" & Val(.TextMatrix(Row, .ColIndex(" ’∑¢–Ú∫≈"))) & _
                        " And …Í«Î ±º‰='" & Val(.TextMatrix(Row, .ColIndex("…Í«Î ±º‰"))) & "' "
        If mrsBatch.EOF Then Exit Sub
        mrsBatch!œ˙’  ˝¡ø = Val(.TextMatrix(Row, .ColIndex("œ˙’  ˝¡ø"))) * mrsBatch!ªªÀ„œµ ˝
        mrsBatch.Update
    End With
End Sub
Public Function zlRefreshData(ByVal frmMain As Form, ByVal strPrivs As String, ByVal lngModule As Long, ByVal intUnit As Integer, _
    ByVal arrFilter As Variant) As Boolean
     '-----------------------------------------------------------------------------------------------------------
    'π¶ƒ‹:÷ÿ–¬À¢–¬ ˝æ›
    '»Î≤Œ:frmMain-∏∏¥∞ø⁄
    '     strPrivs-»®œﬁ¥Æ
    '     lngModule-ƒ£øÈ∫≈
    '     intUnit-œ‘ æµ•Œª(0-…¢◊∞µ•Œª,1-∞¸◊∞µ•Œª)
    '     arrFilter-Ãıº˛π˝¬À
    '≥ˆ≤Œ:
    '∑µªÿ:≥…π¶,∑µªÿtrue,∑Ò‘Ú∑µªÿFalse
    '±‡÷∆:¡ı–À∫È
    '»’∆⁄:2008-04-22 14:25:18
    '-----------------------------------------------------------------------------------------------------------
    Set mfrmMain = frmMain: mstrPrivs = strPrivs: mlngModule = lngModule:
    Set mArrFilter = arrFilter
    mintUnit = intUnit
    
    '≥ı ºªØ÷µ
    Call Form_Load
    zlRefreshData = RefreshData
End Function
Public Function zlVerifyData() As Boolean
    '-----------------------------------------------------------------------------------------------------------
    'π¶ƒ‹:ÕÀ¡œœ˙’ 
    '»Î≤Œ:
    '≥ˆ≤Œ:
    '∑µªÿ:≥…π¶,∑µªÿtrue,∑Ò‘Ú∑µªÿFalse
    '±‡÷∆:¡ı–À∫È
    '»’∆⁄:2008-05-04 00:23:54
    '-----------------------------------------------------------------------------------------------------------
    Screen.MousePointer = 11
    zlVerifyData = SaveData()
    Screen.MousePointer = 0
End Function
Private Function SaveData() As Boolean
    '-----------------------------------------------------------------------------------------------------------
    'π¶ƒ‹:…Û∫À
    '»Î≤Œ:
    '≥ˆ≤Œ:
    '∑µªÿ:≥…π¶,∑µªÿtrue,∑Ò‘Ú∑µªÿFalse
    '±‡÷∆:¡ı–À∫È
    '»’∆⁄:2008-05-04 00:08:26
    '-----------------------------------------------------------------------------------------------------------
    Dim i As Integer
    Dim strCurDate As String
    
    Dim strMCNO As String, arrMCRec As Variant, arrMCPar As Variant
    Dim int…Û∫À±Í÷æ As Integer
    Dim bln «∑Ò”–ÕÀ¡œ As Boolean
    Dim str–Ú∫≈ ˝¡ø As String
    Dim cllPro As Collection
    Dim strAudit As String  'º«¬º“—Ω¯––œ˙’ µƒ∑—”√º«¬º£¨±‹√‚÷ÿ∏¥÷¥––
    Dim strReturnInfo As String
    Dim strReserve As String
    
    If vsHeadGrid.Rows = 1 Then Exit Function
    If Val(vsHeadGrid.Cell(flexcpData, 1, vsHeadGrid.ColIndex("≤ƒ¡œ√˚≥∆"))) = 0 Then Exit Function
    strCurDate = Format(Sys.Currentdate(), "yyyy-MM-dd HH:mm:ss")
    Set cllPro = New Collection
    
    With mrsBatch
        .Filter = 0
        If .State = 0 Then Exit Function
        If .RecordCount = 0 Then Exit Function
        Do While Not .EOF
            If !…Û∫À±Í÷æ <> 0 And InStr("," & strAudit & ",", "," & !∑—”√ID & !…Í«Î ±º‰ & ",") = 0 Then
                strAudit = IIf(strAudit = "", !∑—”√ID & !…Í«Î ±º‰, strAudit & "," & !∑—”√ID & !…Í«Î ±º‰)
                
                'Zl_≤°»À∑—”√œ˙’ _Audit
                gstrSQL = "Zl_≤°»À∑—”√œ˙’ _Audit("
                '  Id_In       ≤°»À∑—”√œ˙’ .∑—”√id%Type,
                gstrSQL = gstrSQL & "" & Val(NVL(!∑—”√ID)) & ","
                '  …Í«Î ±º‰_In ≤°»À∑—”√œ˙’ .…Í«Î ±º‰%Type,
                gstrSQL = gstrSQL & "To_Date('" & !…Í«Î ±º‰ & "','YYYY-MM-DD HH24:MI:SS'),"
                '  …Û∫À»À_In   ≤°»À∑—”√œ˙’ .…Û∫À»À%Type,
                gstrSQL = gstrSQL & "'" & gstrUserName & "',"
                '  …Û∫À ±º‰_In ≤°»À∑—”√œ˙’ .…Û∫À ±º‰%Type,
                gstrSQL = gstrSQL & "To_Date('" & strCurDate & "','YYYY-MM-DD HH24:MI:SS'),"
                '  ◊¥Ã¨_In     ≤°»À∑—”√œ˙’ .◊¥Ã¨%Type,
                gstrSQL = gstrSQL & "" & Val(NVL(!…Û∫À±Í÷æ)) & ","
                '  int◊‘∂ØÕÀ¡œ Integer:=1
                gstrSQL = gstrSQL & "0)"
                AddArray cllPro, gstrSQL
            End If
            
            'ÕÀ¡œ¥¶¿Ì
            If !…Û∫À±Í÷æ = 1 And !œ˙’  ˝¡ø <> 0 Then
                    'Zl_≤ƒ¡œ ’∑¢º«¬º_≤ø√≈ÕÀ¡œ
                    gstrSQL = "Zl_≤ƒ¡œ ’∑¢º«¬º_≤ø√≈ÕÀ¡œ("
                    '     ’∑¢id_In   In “©∆∑ ’∑¢º«¬º.ID%Type,
                    gstrSQL = gstrSQL & "" & NVL(! ’∑¢ID) & ","
                    '    …Û∫À»À_In   In “©∆∑ ’∑¢º«¬º.…Û∫À»À%Type,
                    gstrSQL = gstrSQL & "'" & gstrUserName & "',"
                    '    …Û∫À»’∆⁄_In In “©∆∑ ’∑¢º«¬º.…Û∫À»’∆⁄%Type,
                    gstrSQL = gstrSQL & "to_date('" & strCurDate & "','yyyy-mm-dd HH24:mi:ss'),"
                    '    ≈˙∫≈_In     In “©∆∑ø‚¥Ê.…œ¥Œ≈˙∫≈%Type := Null,
                    gstrSQL = gstrSQL & "'" & NVL(!≈˙∫≈) & "',"
                    '    –ß∆⁄_In     In “©∆∑ø‚¥Ê.–ß∆⁄%Type := Null,
                    gstrSQL = gstrSQL & "" & IIf(IsNull(!–ß∆⁄), "NULL", IIf(NVL(!–ß∆⁄) = "", "NULL", "To_Date('" & Format(!–ß∆⁄, "yyyy-MM-dd") & "','yyyy-MM-dd')")) & ","
                    '    ≤˙µÿ_In     In “©∆∑ø‚¥Ê.…œ¥Œ≤˙µÿ%Type := Null,
                    gstrSQL = gstrSQL & "'" & NVL(!≤˙µÿ) & "',"
                    '    ÕÀ¡œ ˝¡ø_In In “©∆∑ ’∑¢º«¬º. µº  ˝¡ø%Type := Null,
                    gstrSQL = gstrSQL & "" & NVL(!œ˙’  ˝¡ø) & ","
                    '    ◊‘∂Øœ˙’ _In Integer := 0,
                    gstrSQL = gstrSQL & "" & 0 & ","
                    '    ÕÀ¡œ»À_In   In “©∆∑ ’∑¢º«¬º.¡Ï”√»À%Type := Null
                    gstrSQL = gstrSQL & "'" & gstrUserName & "',"
                    
                    '     «∑Òœ˙’ _In Integer := 1,
                    gstrSQL = gstrSQL & "" & 0 & ")"
                    AddArray cllPro, gstrSQL
                    bln «∑Ò”–ÕÀ¡œ = True
                    'œ˙’ ¥¶¿Ì
                    str–Ú∫≈ ˝¡ø = !∑—”√–Ú∫≈ & ":" & !œ˙’  ˝¡ø
                    '--–Ú∫≈£∫∏Ò Ω»Á"1,3,5,7,8",ªÚ"1:2,3:2,5:2,7:2,8:2",√∞∫≈«∞√Êµƒ ˝◊÷±Ì æ––∫≈,∫Û√Êµƒ ˝◊÷±Ì æÕÀµƒ ˝¡ø,ƒø«∞Ωˆ‘⁄œ˙’ …Û∫À ±∑«“©∆∑≤≈¥´»Î
                    '--      Œ™ø’±Ì æ≥Âœ˙À˘”–ø…≥Âœ˙––

                    If !÷˜“≥id = 0 Then
                        gstrSQL = "Zl_√≈’Ôº«’ º«¬º_Delete('" & !NO & "','" & !∑—”√–Ú∫≈ & "','" & gstrUserCode & "','" & gstrUserName & "')"
                    Else
                        gstrSQL = "ZL_◊°‘∫º«’ º«¬º_Delete('" & !NO & "','" & str–Ú∫≈ ˝¡ø & "','" & gstrUserCode & "','" & gstrUserName & "'," & !º«¬º–‘÷  & ",1)"
                    End If
                    AddArray cllPro, gstrSQL
                    
                    '“Ω±£¥¶¿Ì
                    If Not IsNull(!œ’¿‡) And InStr(1, strMCNO, !NO) = 0 Then
                        MCPAR.º«’ ◊˜∑œ…œ¥´ = gclsInsure.GetCapability(supportº«’ ◊˜∑œ…œ¥´, , Val(!œ’¿‡))
                        MCPAR.º«’ ÕÍ≥…∫Û…œ¥´ = gclsInsure.GetCapability(supportº«’ ÕÍ≥…∫Û…œ¥´, , Val(!œ’¿‡))
                        strMCNO = strMCNO & IIf(strMCNO = "", "", "|") & !NO & "," & !œ’¿‡ & _
                                "," & IIf(MCPAR.º«’ ◊˜∑œ…œ¥´, "1", "0") & "," & IIf(MCPAR.º«’ ÕÍ≥…∫Û…œ¥´, "1", "0")
                    End If
                    
                    strReturnInfo = IIf(strReturnInfo = "", "", strReturnInfo & "|") & NVL(! ’∑¢ID) & "," & NVL(!œ˙’  ˝¡ø)
            End If
            .MoveNext
        Loop
    End With
    err = 0: On Error GoTo ErrHand:
    ExecuteProcedureArrAy cllPro, Me.Caption, True
    '“Ω±££¨º«’ ◊˜∑œ…œ¥´£¨◊˜∑œ ±…œ¥´
    If strMCNO <> "" Then
        arrMCRec = Split(strMCNO, "|")
        For i = 0 To UBound(arrMCRec)
            arrMCPar = Split(arrMCRec(i), ",")
            If arrMCPar(2) = 1 And arrMCPar(3) = 0 Then
                If Not gclsInsure.TranChargeDetail(2, CStr(arrMCPar(0)), 2, 2, "", , Val(arrMCPar(1))) Then
                    gcnOracle.RollbackTrans:  Exit Function
                End If
            End If
        Next
    End If
                            
    gcnOracle.CommitTrans
    
    '“Ω±££¨º«’ ◊˜∑œ…œ¥´£¨ÕÍ≥…∫Û…œ¥´
    If strMCNO <> "" Then
        For i = 0 To UBound(arrMCRec)
            arrMCPar = Split(arrMCRec(i), ",")
            If arrMCPar(2) = 1 And arrMCPar(3) = 1 Then
                If Not gclsInsure.TranChargeDetail(2, CStr(arrMCPar(0)), 2, 2, "", , Val(arrMCPar(1))) Then
                    MsgBox "µ•æ›""" & CStr(arrMCPar(0)) & """µƒœ˙’  ˝æ›œÚ“Ω±£¥´ÀÕ ß∞‹£¨∏√µ•æ›“—œ˙’ °£", vbInformation, gstrSysName
                End If
            End If
        Next
    End If
    Screen.MousePointer = 0
    err = 0: On Error GoTo ErrHandRpt:
    If bln «∑Ò”–ÕÀ¡œ = True Then
      If zlStr.IsHavePrivs(mstrPrivs, "ÕÀ¡œÕ®÷™µ•") Then
            If MsgBox("ƒ„–Ë“™¥Ú”°ÕÀ¡œ«Âµ•¬£ø", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbYes Then
                Call ReportOpen(gcnOracle, glngSys, "ZL1_BILL_1723_2", Me, "ÕÀ¡œ ±º‰=" & strCurDate, "µ•Œª=" & mintUnit + 1, 2)
            End If
     End If
    End If
    
    'µ˜”√ÕÀ“©∫ÛµƒÕ‚π“Ω”ø⁄
    If Not mobjPlugIn Is Nothing And bln «∑Ò”–ÕÀ¡œ Then
        mobjPlugIn.DrugReturnByID Val(mArrFilter("∑¢¡œ≤ø√≈id")), strReturnInfo, CDate(strCurDate), strReserve
    End If
    
    SaveData = True
    Exit Function
ErrHand:
    gcnOracle.RollbackTrans
    If ErrCenter = 1 Then Resume
    Call SaveErrLog
    Exit Function
ErrHandRpt:
    If ErrCenter = 1 Then Resume
    Call SaveErrLog
    SaveData = True
End Function
  

Private Sub picHsc_MouseMove(Button As Integer, Shift As Integer, x As Single, Y As Single)
    If Button = 1 Then
        If vsHeadGrid.Height + Y <= 500 Or vsDetail.Height - Y <= 500 Then Exit Sub
        picHsc.Top = picHsc.Top + Y
        
        vsHeadGrid.Height = vsHeadGrid.Height + Y
        If picBatHsc.Visible Then
            vsDetail.Height = vsDetail.Height - Y
            vsDetail.Top = vsDetail.Top + Y
        Else
            vsDetail.Top = vsDetail.Top + Y
            vsDetail.Height = Me.ScaleHeight - vsDetail.Top
        End If
        Me.Refresh
    End If
End Sub

Private Sub picBatHsc_MouseMove(Button As Integer, Shift As Integer, x As Single, Y As Single)
    If Button = 1 Then
        If vsDetail.Height + Y <= 500 Then Exit Sub
        picBatHsc.Top = picBatHsc.Top + Y
        If Me.ScaleHeight - picBatHsc.Top < 500 Then picBatHsc.Top = Me.ScaleHeight - 500
        vsDetail.Height = picBatHsc.Top - vsDetail.Top
        vsBatch.Top = picBatHsc.Top + picBatHsc.Height
        vsBatch.Height = Me.ScaleHeight - vsBatch.Top
            
        Me.Refresh
    End If
End Sub

