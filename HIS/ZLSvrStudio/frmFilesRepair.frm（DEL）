VERSION 5.00
Object = "{BEEECC20-4D5F-4F8B-BFDC-5D9B6FBDE09D}#1.0#0"; "vsflex8.ocx"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.0#0"; "mscomctl.ocx"
Begin VB.Form frmFilesRepair 
   BorderStyle     =   3  'Fixed Dialog
   Caption         =   "服务器文件检测"
   ClientHeight    =   8136
   ClientLeft      =   48
   ClientTop       =   372
   ClientWidth     =   8904
   Icon            =   "frmFilesRepair.frx":0000
   LinkTopic       =   "Form1"
   MaxButton       =   0   'False
   MinButton       =   0   'False
   ScaleHeight     =   8136
   ScaleWidth      =   8904
   ShowInTaskbar   =   0   'False
   StartUpPosition =   1  '所有者中心
   Begin VSFlex8Ctl.VSFlexGrid vsfSever 
      Height          =   2235
      Left            =   45
      TabIndex        =   0
      Top             =   1875
      Width           =   8805
      _cx             =   15531
      _cy             =   3942
      Appearance      =   0
      BorderStyle     =   1
      Enabled         =   -1  'True
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "宋体"
         Size            =   9
         Charset         =   134
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      MousePointer    =   0
      BackColor       =   -2147483643
      ForeColor       =   -2147483640
      BackColorFixed  =   -2147483633
      ForeColorFixed  =   -2147483630
      BackColorSel    =   -2147483635
      ForeColorSel    =   -2147483634
      BackColorBkg    =   -2147483636
      BackColorAlternate=   -2147483643
      GridColor       =   -2147483633
      GridColorFixed  =   -2147483632
      TreeColor       =   -2147483632
      FloodColor      =   192
      SheetBorder     =   -2147483642
      FocusRect       =   1
      HighLight       =   1
      AllowSelection  =   -1  'True
      AllowBigSelection=   -1  'True
      AllowUserResizing=   0
      SelectionMode   =   0
      GridLines       =   1
      GridLinesFixed  =   2
      GridLineWidth   =   1
      Rows            =   50
      Cols            =   10
      FixedRows       =   1
      FixedCols       =   0
      RowHeightMin    =   0
      RowHeightMax    =   0
      ColWidthMin     =   0
      ColWidthMax     =   0
      ExtendLastCol   =   0   'False
      FormatString    =   ""
      ScrollTrack     =   0   'False
      ScrollBars      =   3
      ScrollTips      =   0   'False
      MergeCells      =   0
      MergeCompare    =   0
      AutoResize      =   -1  'True
      AutoSizeMode    =   0
      AutoSearch      =   0
      AutoSearchDelay =   2
      MultiTotals     =   -1  'True
      SubtotalPosition=   1
      OutlineBar      =   0
      OutlineCol      =   0
      Ellipsis        =   0
      ExplorerBar     =   0
      PicturesOver    =   0   'False
      FillStyle       =   0
      RightToLeft     =   0   'False
      PictureType     =   0
      TabBehavior     =   0
      OwnerDraw       =   0
      Editable        =   0
      ShowComboButton =   1
      WordWrap        =   0   'False
      TextStyle       =   0
      TextStyleFixed  =   0
      OleDragMode     =   0
      OleDropMode     =   0
      DataMode        =   0
      VirtualData     =   -1  'True
      DataMember      =   ""
      ComboSearch     =   3
      AutoSizeMouse   =   -1  'True
      FrozenRows      =   0
      FrozenCols      =   0
      AllowUserFreezing=   0
      BackColorFrozen =   0
      ForeColorFrozen =   0
      WallPaperAlignment=   9
      AccessibleName  =   ""
      AccessibleDescription=   ""
      AccessibleValue =   ""
      AccessibleRole  =   24
   End
   Begin VB.PictureBox Picture2 
      BackColor       =   &H00FFFFFF&
      BorderStyle     =   0  'None
      Height          =   3900
      Left            =   -60
      ScaleHeight     =   3900
      ScaleWidth      =   9012
      TabIndex        =   13
      Top             =   4230
      Width           =   9015
      Begin VSFlex8Ctl.VSFlexGrid vsfWarning 
         Height          =   3765
         Left            =   105
         TabIndex        =   14
         Top             =   75
         Width           =   8805
         _cx             =   15531
         _cy             =   6641
         Appearance      =   0
         BorderStyle     =   1
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   -2147483635
         ForeColorSel    =   -2147483634
         BackColorBkg    =   -2147483636
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483633
         GridColorFixed  =   -2147483632
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483642
         FocusRect       =   1
         HighLight       =   1
         AllowSelection  =   -1  'True
         AllowBigSelection=   -1  'True
         AllowUserResizing=   0
         SelectionMode   =   0
         GridLines       =   1
         GridLinesFixed  =   2
         GridLineWidth   =   1
         Rows            =   1
         Cols            =   6
         FixedRows       =   1
         FixedCols       =   0
         RowHeightMin    =   0
         RowHeightMax    =   0
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   0   'False
         FormatString    =   $"frmFilesRepair.frx":6852
         ScrollTrack     =   0   'False
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   -1  'True
         AutoSizeMode    =   0
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   0
         Editable        =   0
         ShowComboButton =   1
         WordWrap        =   0   'False
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         DataMode        =   0
         VirtualData     =   -1  'True
         DataMember      =   ""
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   24
      End
   End
   Begin VB.PictureBox Picture1 
      BackColor       =   &H00FFFFFF&
      BorderStyle     =   0  'None
      Height          =   1185
      Left            =   -15
      ScaleHeight     =   1298.63
      ScaleMode       =   0  'User
      ScaleWidth      =   8925
      TabIndex        =   6
      Top             =   0
      Width           =   8925
      Begin VB.PictureBox picWarning 
         BackColor       =   &H00FFFFFF&
         BorderStyle     =   0  'None
         Height          =   1035
         Left            =   945
         ScaleHeight     =   1032
         ScaleWidth      =   6468
         TabIndex        =   15
         Top             =   75
         Visible         =   0   'False
         Width           =   6465
         Begin VB.Label lblWarning 
            BackStyle       =   0  'Transparent
            Caption         =   "服务器文件缺失-说明上传过程有遗漏，或上传时环境本身缺失，请检查"
            ForeColor       =   &H000000FF&
            Height          =   180
            Index           =   2
            Left            =   315
            TabIndex        =   18
            Top             =   780
            Width           =   6075
         End
         Begin VB.Label lblWarning 
            BackStyle       =   0  'Transparent
            Caption         =   "服务器文件损坏-服务器上的文件和升级表中文件不匹配，需要重新上传"
            ForeColor       =   &H000000FF&
            Height          =   240
            Index           =   1
            Left            =   315
            TabIndex        =   17
            Top             =   450
            Width           =   6060
         End
         Begin VB.Label lblWarning 
            BackStyle       =   0  'Transparent
            Caption         =   "服务器存在问题"
            Height          =   225
            Index           =   0
            Left            =   330
            TabIndex        =   16
            Top             =   120
            Width           =   1665
         End
      End
      Begin MSComctlLib.ImageList imgList 
         Left            =   8010
         Top             =   420
         _ExtentX        =   995
         _ExtentY        =   995
         BackColor       =   -2147483643
         ImageWidth      =   48
         ImageHeight     =   48
         MaskColor       =   12632256
         _Version        =   393216
         BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
            NumListImages   =   6
            BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmFilesRepair.frx":6942
               Key             =   "准备检查"
            EndProperty
            BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmFilesRepair.frx":8494
               Key             =   "正在检查"
            EndProperty
            BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmFilesRepair.frx":9FE6
               Key             =   "检查完成正常"
            EndProperty
            BeginProperty ListImage4 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmFilesRepair.frx":BB38
               Key             =   "检查完成错误"
            EndProperty
            BeginProperty ListImage5 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmFilesRepair.frx":D68A
               Key             =   "检查完成信息"
            EndProperty
            BeginProperty ListImage6 {2C247F27-8591-11D1-B16A-00C0F0283628} 
               Picture         =   "frmFilesRepair.frx":F1DC
               Key             =   "检查完成警告"
            EndProperty
         EndProperty
      End
      Begin VB.Label lblEXP 
         BackStyle       =   0  'Transparent
         Caption         =   "检测功能只能检测服务器上的文件准确性，并不能确保上传的环境正常"
         Height          =   180
         Index           =   2
         Left            =   1245
         TabIndex        =   9
         Top             =   855
         Width           =   5955
      End
      Begin VB.Image imgCaption 
         Height          =   576
         Left            =   240
         Picture         =   "frmFilesRepair.frx":10D2E
         Top             =   252
         Width           =   576
      End
      Begin VB.Label lblEXP 
         BackStyle       =   0  'Transparent
         Caption         =   "一般情况上传过程没有出错，客户端升级后没有出错，不需要检测服务器文件"
         Height          =   195
         Index           =   1
         Left            =   1245
         TabIndex        =   8
         Top             =   525
         Width           =   6750
      End
      Begin VB.Label lblEXP 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "对已经上传过的升级文件服务器进行检测，发现服务器问题"
         Height          =   180
         Index           =   0
         Left            =   1245
         TabIndex        =   7
         Top             =   195
         Width           =   4680
      End
   End
   Begin VSFlex8Ctl.VSFlexGrid vsfData 
      Height          =   480
      Left            =   7185
      TabIndex        =   12
      Top             =   330
      Width           =   1020
      _cx             =   1799
      _cy             =   847
      Appearance      =   1
      BorderStyle     =   1
      Enabled         =   -1  'True
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "宋体"
         Size            =   9
         Charset         =   134
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      MousePointer    =   0
      BackColor       =   -2147483643
      ForeColor       =   -2147483640
      BackColorFixed  =   -2147483633
      ForeColorFixed  =   -2147483630
      BackColorSel    =   -2147483635
      ForeColorSel    =   -2147483634
      BackColorBkg    =   -2147483636
      BackColorAlternate=   -2147483643
      GridColor       =   -2147483633
      GridColorFixed  =   -2147483632
      TreeColor       =   -2147483632
      FloodColor      =   192
      SheetBorder     =   -2147483642
      FocusRect       =   1
      HighLight       =   1
      AllowSelection  =   -1  'True
      AllowBigSelection=   -1  'True
      AllowUserResizing=   0
      SelectionMode   =   0
      GridLines       =   1
      GridLinesFixed  =   2
      GridLineWidth   =   1
      Rows            =   50
      Cols            =   10
      FixedRows       =   1
      FixedCols       =   1
      RowHeightMin    =   0
      RowHeightMax    =   0
      ColWidthMin     =   0
      ColWidthMax     =   0
      ExtendLastCol   =   0   'False
      FormatString    =   ""
      ScrollTrack     =   0   'False
      ScrollBars      =   3
      ScrollTips      =   0   'False
      MergeCells      =   0
      MergeCompare    =   0
      AutoResize      =   -1  'True
      AutoSizeMode    =   0
      AutoSearch      =   0
      AutoSearchDelay =   2
      MultiTotals     =   -1  'True
      SubtotalPosition=   1
      OutlineBar      =   0
      OutlineCol      =   0
      Ellipsis        =   0
      ExplorerBar     =   0
      PicturesOver    =   0   'False
      FillStyle       =   0
      RightToLeft     =   0   'False
      PictureType     =   0
      TabBehavior     =   0
      OwnerDraw       =   0
      Editable        =   0
      ShowComboButton =   1
      WordWrap        =   0   'False
      TextStyle       =   0
      TextStyleFixed  =   0
      OleDragMode     =   0
      OleDropMode     =   0
      DataMode        =   0
      VirtualData     =   -1  'True
      DataMember      =   ""
      ComboSearch     =   3
      AutoSizeMouse   =   -1  'True
      FrozenRows      =   0
      FrozenCols      =   0
      AllowUserFreezing=   0
      BackColorFrozen =   0
      ForeColorFrozen =   0
      WallPaperAlignment=   9
      AccessibleName  =   ""
      AccessibleDescription=   ""
      AccessibleValue =   ""
      AccessibleRole  =   24
   End
   Begin VB.Frame fraBounds 
      Height          =   45
      Index           =   1
      Left            =   -120
      TabIndex        =   11
      Top             =   4200
      Width           =   9360
   End
   Begin VB.Frame fraBounds 
      Height          =   45
      Index           =   0
      Left            =   -1050
      TabIndex        =   10
      Top             =   1170
      Width           =   10230
   End
   Begin VB.CommandButton cmdCheck 
      Caption         =   "检测(&Z)"
      Height          =   300
      Left            =   6600
      TabIndex        =   2
      Top             =   1470
      Width           =   1000
   End
   Begin MSComctlLib.ProgressBar pgbThis 
      Height          =   330
      Left            =   45
      TabIndex        =   5
      Top             =   1905
      Width           =   8800
      _ExtentX        =   15536
      _ExtentY        =   572
      _Version        =   393216
      BorderStyle     =   1
      Appearance      =   0
      Scrolling       =   1
   End
   Begin VB.CommandButton cmdExit 
      Caption         =   "退出(&Q)"
      Height          =   300
      Left            =   7830
      TabIndex        =   4
      Top             =   1470
      Width           =   1000
   End
   Begin VB.CommandButton cmdRepair 
      Caption         =   "修复(&X)"
      Enabled         =   0   'False
      Height          =   300
      Left            =   6600
      TabIndex        =   3
      Top             =   1470
      Visible         =   0   'False
      Width           =   1000
   End
   Begin VB.Label lblstatus 
      BackStyle       =   0  'Transparent
      Height          =   540
      Left            =   75
      TabIndex        =   1
      Top             =   1455
      Width           =   5865
   End
End
Attribute VB_Name = "frmFilesRepair"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Private mrsTemp As New ADODB.Recordset
Private mblnStates As Boolean

Private Enum DownLoadCol
    Col_文件 = 0
    Col_当前版本 = 1
    Col_安装路径 = 2
    Col_系统 = 3
    Col_修改日期 = 4
    Col_业务部件 = 5
    Col_文件说明 = 6
    Col_对比md5 = 7 '对比用标准md5
    Col_检测 = 8
    Col_正确服务器 = 9
    Col_本地文件地址 = 10
    Col_列数 = 11
End Enum

Private Enum WarningInfoCOL
    WICol_编号 = 0
    WICol_文件名称 = 1
    WICol_当前版本 = 2
    WICol_安装路径 = 3
    WICol_警告 = 4
    WICol_服务器编号 = 5
    WICol_列数 = 6
End Enum

Private Enum FilesCheckWarning
    Warning_正常 = 0
    Warning_本地文件缺失 = 1
    Warning_服务器文件缺失 = 2
    Warning_MD5不匹配 = 3
    Warning_不能修复 = 4
    Warning_已修复 = 5
End Enum

Private Enum DownSeverCol
    Col_编号 = 0
    Col_类型 = 1
    Col_地址 = 2
    Col_用户名 = 3
    Col_密码 = 4
    Col_端口 = 5
    Col_检测结果 = 6
    Col_批次 = 7
    Col_服务器列数 = 8
End Enum

Public mstrScratchFilePath As String
Public mstrFilePath As String
Public mobjFile As New FileSystemObject
Public mstrCorrectSever As String
Public mblnCheck As Boolean

Public Function ShowMe() As Boolean

    If gblnInIDE Then
        mstrFilePath = "C:\APPSOFT\ZLUPTMP"
        mstrScratchFilePath = "C:\APPSOFT\ZLUPTMP\SeverCheck"
    Else
        mstrFilePath = App.Path & "\ZLUPTMP"
        mstrScratchFilePath = App.Path & "\ZLUPTMP\SeverCheck"
    End If
    
    If FindFile(mstrFilePath) = False Then
        On Error Resume Next
        Call mobjFile.CreateFolder(mstrFilePath)
        If mobjFile.FolderExists(mstrFilePath) = False Then
            MsgBox "临时收集目录不能创建,请检查!" & vbCrLf & mstrFilePath, vbInformation + vbDefaultButton1, gstrSysName
            Exit Function
        End If
    End If
    
    If FindFile(mstrScratchFilePath) = False Then
        On Error Resume Next
        Call mobjFile.CreateFolder(mstrScratchFilePath)
        If mobjFile.FolderExists(mstrScratchFilePath) = False Then
            MsgBox "临时收集目录不能创建,请检查!" & vbCrLf & mstrScratchFilePath, vbInformation + vbDefaultButton1, gstrSysName
            Exit Function
        End If
    End If
    
    Call LoadData
    Call InitVSFWarning
    If LoadSever = True Then Me.Show 1, frmMDIMain
    
End Function

Private Sub cmdCheck_Click()
    Dim strNumber As String
    Dim strSeverType As String
    Dim strServerAddress As String
    Dim strUser As String
    Dim strPassword As String
    Dim strPort As String
    Dim i As Integer
    Dim strErrInfor As String '错误信息

    On Error GoTo errH
    '本地环境检测
    Call DataCheck(strErrInfor)
'    If DataCheck(strErrInfor) = False Then Call MsgBox("本地环境文件缺失:" & vbCrLf & strErrInfor, vbInformation, gstrSysName)
    cmdCheck.Enabled = False
    cmdExit.Enabled = False
    mblnStates = True
    vsfWarning.Rows = 1
    imgCaption.Picture = imgList.ListImages.Item("正在检查").Picture
    picWarning.Visible = False
    ShowPgbThis True
    With vsfSever
        mblnCheck = False
        For i = 1 To .Rows - 1
            .TextMatrix(i, Col_检测结果) = "正在检测"
            .Row = i: .ShowCell i, 0: strErrInfor = ""
            strNumber = .TextMatrix(i, Col_编号): strSeverType = .TextMatrix(i, Col_类型)
            strServerAddress = .TextMatrix(i, Col_地址): strUser = .TextMatrix(i, Col_用户名)
            strPassword = Decipher(.Cell(flexcpData, i, Col_密码)): strPort = .TextMatrix(i, Col_端口)

            If SeverFilesCheck(strNumber, strServerAddress, strUser, strPassword, strPort, strErrInfor, strSeverType) = True Then
                .TextMatrix(i, Col_检测结果) = "正常"
            Else
                If strErrInfor <> "" Then MsgBox strErrInfor, vbInformation, gstrSysName
                .TextMatrix(i, Col_检测结果) = "需要重新上传"
            End If
        Next
        mblnCheck = True
        .Row = 1
    End With

    ShowPgbThis False
    lblstatus.Caption = ""
    cmdRepair.Enabled = True
    cmdCheck.Enabled = True
    cmdExit.Enabled = True
    mblnStates = False
    Exit Sub
errH:
    MsgBox err.Description, vbInformation, gstrSysName
    mblnStates = False
    If False = 1 Then
        Resume
    End If
End Sub

Private Sub cmdExit_Click()
    Unload Me
End Sub

Private Sub cmdRepair_Click()
    Dim strNumber As String
    Dim strSeverType As String
    Dim strServerAddress As String
    Dim strUser As String
    Dim strPassword As String
    Dim strPort As String
    Dim strBatch As String '批次
    Dim i As Integer
    Dim strErrInfor As String '错误信息

    On Error GoTo errH
    '本地环境检测
    Call DataCheck(strErrInfor)
'    If DataCheck(strErrInfor) = False Then Call MsgBox("本地环境文件缺失:" & vbCrLf & strErrInfor, vbInformation, gstrSysName)
    cmdCheck.Enabled = False
    cmdRepair.Enabled = False
    cmdExit.Enabled = False
    mblnStates = True
    With vsfSever
        For i = 1 To .Rows - 1
            If .TextMatrix(i, Col_检测结果) <> "正常" Then
                .TextMatrix(i, Col_检测结果) = "正在修复"
                .Row = i: .ShowCell i, 0: strErrInfor = ""
                strNumber = .TextMatrix(i, Col_编号): strSeverType = .TextMatrix(i, Col_类型)
                strServerAddress = .TextMatrix(i, Col_地址): strUser = .TextMatrix(i, Col_用户名)
                strPassword = .Cell(flexcpData, i, Col_密码): strPort = .TextMatrix(i, Col_端口)

                If SeverFilesRepair(strNumber, strServerAddress, strUser, strPassword, strPort, strErrInfor, strSeverType) = True Then
                    .TextMatrix(i, Col_检测结果) = "修复完成"
                Else
                    If strErrInfor <> "" Then MsgBox strErrInfor, vbInformation, gstrSysName
                    .TextMatrix(i, Col_检测结果) = "未修复"
                End If
            End If
        Next
        strBatch = BatchLoad
        BatchUpdate strBatch '修正批次
    End With
    cmdRepair.Enabled = True
    cmdCheck.Enabled = True
    cmdExit.Enabled = True
    mblnStates = False
    Exit Sub
errH:
    MsgBox "出现未知错误"
    If False = 1 Then
        Resume
    End If
End Sub

Public Function LoadData() As Boolean
    Dim i, j As Long
    Dim strSQL       As String
    Dim strTemp As String
    Dim arrSys As Variant
    On Error GoTo errH

    With vsfData
        .Tag = ""
        .Rows = 1
        .Clear
        .Cols = Col_列数
        
        .Cell(flexcpText, 0, Col_文件) = "文件名"
        .ColWidth(Col_文件) = 500
        
        .Cell(flexcpText, 0, Col_当前版本) = "当前版本"
        .ColWidth(Col_当前版本) = 500
        
        .Cell(flexcpText, 0, Col_安装路径) = "安装路径"
        .ColWidth(Col_安装路径) = 500
        
        .Cell(flexcpText, 0, Col_系统) = "系统"
        .ColWidth(Col_系统) = 500
        
        .Cell(flexcpText, 0, Col_业务部件) = "业务部件"
        .ColWidth(Col_业务部件) = 500
        
        .Cell(flexcpText, 0, Col_文件说明) = "文件说明"
        .ColWidth(Col_文件说明) = 500

        .Cell(flexcpText, 0, Col_修改日期) = "修改日期"
        .ColWidth(Col_修改日期) = 500
        
        .Cell(flexcpText, 0, Col_对比md5) = "md5"
        .ColWidth(Col_对比md5) = 500
        
        .Cell(flexcpText, 0, Col_检测) = "检测结果"
        .ColWidth(Col_检测) = 500
        
        .Cell(flexcpText, 0, Col_正确服务器) = "正确服务器编号"
        .ColWidth(Col_正确服务器) = 500

        .Cell(flexcpText, 0, Col_本地文件地址) = "本地文件地址"
        .ColWidth(Col_本地文件地址) = 500
        
        strSQL = "Select a.文件名 As 部件名称, a.文件版本号 As 当前版本, a.安装路径 As 安装路径, a.所属系统 As 系统, a.修改日期 As 修改日期, a.业务部件 As 业务部件, a.文件说明 As 文件说明," & vbNewLine & _
                        "       a.Md5 As 当前md5" & vbNewLine & _
                        "From zlFilesUpgrade A" & vbNewLine & _
                        "Order By 部件名称"
        Call OpenRecordset(mrsTemp, strSQL, Me.Caption)

        '数据填入
        .Rows = mrsTemp.RecordCount + 1
        i = 1
        Do Until mrsTemp.EOF
            .Cell(flexcpText, i, Col_文件) = Nvl(mrsTemp.Fields("部件名称"), "")
            
            strTemp = Nvl(mrsTemp.Fields("当前版本"), "")
'            .Cell(flexcpData, i, Col_当前版本) = strTemp '未转换版本号
'            strTemp = GetFileVision(strTemp)
            .Cell(flexcpText, i, Col_当前版本) = strTemp '转换后版本号

            .Cell(flexcpText, i, Col_安装路径) = Nvl(mrsTemp.Fields("安装路径"), "")

            strTemp = Nvl(mrsTemp.Fields("系统"), "")
            If Trim(strTemp) <> "" Then
                arrSys = Split(Trim(strTemp), ",")
                strTemp = ""
                For j = 0 To UBound(arrSys)
                    If GetSystemName(arrSys(j)) <> "" Then strTemp = strTemp & "，" & GetSystemName(arrSys(j))
                Next
                strTemp = Mid(strTemp, 2)
            Else
                strTemp = ""
            End If
            .Cell(flexcpText, i, Col_系统) = strTemp
                        
            .Cell(flexcpText, i, Col_业务部件) = Nvl(mrsTemp.Fields("业务部件"), "")
            
            .Cell(flexcpText, i, Col_修改日期) = Nvl(mrsTemp.Fields("修改日期"), "")
    
            .Cell(flexcpText, i, Col_文件说明) = Nvl(mrsTemp.Fields("文件说明"), "")

            .Cell(flexcpText, i, Col_对比md5) = Trim(Nvl(mrsTemp.Fields("当前md5"), ""))

            .Cell(flexcpText, i, Col_检测) = ""
            
            .Cell(flexcpText, i, Col_正确服务器) = "-1" '-1表是默认本地服务器正常
                   
            .Cell(flexcpText, 0, Col_本地文件地址) = ""
            
            mrsTemp.MoveNext
            i = i + 1
        Loop
    End With
    Exit Function
errH:
    MsgBox err.Description, vbInformation, gstrSysName
    If False Then
        Resume
    End If
End Function

Public Function LoadSever() As Boolean

    Dim i, j As Long
    Dim strSQL       As String
    
    On Error GoTo errH

    With vsfSever
        .Tag = ""
'        .Redraw = flexRDNone
        .Rows = 1
        .Clear
        .Cols = Col_服务器列数
'        Exit Sub
        .Cell(flexcpText, 0, Col_编号) = "编号"
        .Cell(flexcpAlignment, 0, Col_编号) = flexAlignCenterCenter
        .ColWidth(Col_编号) = 800
        
        .Cell(flexcpText, 0, Col_类型) = "类型"
        .Cell(flexcpAlignment, 0, Col_类型) = flexAlignCenterCenter
        .ColWidth(Col_类型) = 1000
        
        .Cell(flexcpText, 0, Col_地址) = "服务目录"
        .Cell(flexcpAlignment, 0, Col_地址) = flexAlignCenterCenter
        .ColWidth(Col_地址) = 3500
        
        .Cell(flexcpText, 0, Col_用户名) = "用户名"
        .Cell(flexcpAlignment, 0, Col_用户名) = flexAlignCenterCenter
        .ColWidth(Col_用户名) = 1000
        
        .Cell(flexcpText, 0, Col_密码) = "密码"
        .Cell(flexcpAlignment, 0, Col_密码) = flexAlignCenterCenter
        .ColWidth(Col_密码) = 1000
        .ColHidden(Col_密码) = True
        
        .Cell(flexcpText, 0, Col_端口) = "端口"
        .Cell(flexcpAlignment, 0, Col_端口) = flexAlignCenterCenter
        .ColWidth(Col_端口) = 500
        .ColHidden(Col_端口) = True
        
        .Cell(flexcpText, 0, Col_检测结果) = "检测结果"
        .Cell(flexcpAlignment, 0, Col_检测结果) = flexAlignCenterCenter
        .ColWidth(Col_检测结果) = 100
        
        .Cell(flexcpText, 0, Col_批次) = "检测结果"
        .Cell(flexcpAlignment, 0, Col_批次) = flexAlignCenterCenter
        .ColWidth(Col_批次) = 100
        .ColHidden(Col_批次) = True
        
        strSQL = "select * from ZLUpgradeServer where 是否升级 = '1' order by 编号"
        Call OpenRecordset(mrsTemp, strSQL, Me.Caption)

        '数据填入
        .Rows = mrsTemp.RecordCount + 1
        i = 1
        Do Until mrsTemp.EOF
            .Cell(flexcpText, i, Col_编号) = Nvl(mrsTemp.Fields("编号"), "")
            .Cell(flexcpAlignment, i, Col_编号) = flexAlignCenterCenter


            .Cell(flexcpText, i, Col_类型) = IIf(Nvl(mrsTemp.Fields("类型"), "") = "1", "FTP", "共享")
            .Cell(flexcpAlignment, i, Col_类型) = flexAlignLeftCenter

            .Cell(flexcpText, i, Col_地址) = Nvl(mrsTemp.Fields("位置"), "")
            .Cell(flexcpAlignment, i, Col_地址) = flexAlignLeftCenter

            .Cell(flexcpText, i, Col_用户名) = Nvl(mrsTemp.Fields("用户名"), "")
            .Cell(flexcpAlignment, i, Col_用户名) = flexAlignLeftCenter

            .Cell(flexcpText, i, Col_密码) = "***" 'Nvl(mrsTemp.Fields("密码"), "")
            .Cell(flexcpAlignment, i, Col_密码) = flexAlignCenterCenter
            .Cell(flexcpData, i, Col_密码) = Nvl(mrsTemp.Fields("密码"), "")
            
            .Cell(flexcpText, i, Col_端口) = Nvl(mrsTemp.Fields("端口"), "")
            .Cell(flexcpAlignment, i, Col_端口) = flexAlignLeftCenter

            .Cell(flexcpText, i, Col_检测结果) = ""
            .Cell(flexcpAlignment, i, Col_检测结果) = flexAlignCenterCenter
                    
            .Cell(flexcpText, 0, Col_批次) = Nvl(mrsTemp.Fields("批次"), "0")
            
            mrsTemp.MoveNext
            i = i + 1
        Loop
        
        '选中框风格
        .FocusRect = flexFocusSolid
        '最后一列自动列宽
        .ExtendLastCol = True
        '滚动画面跟随
        .ScrollTrack = True
        '自动换行
        .WordWrap = True
        '行高设置
        .RowHeightMin = 300
        .RowHeightMax = 300
        '最大宽度设置
        .ColWidthMax = 7000
        '自动适应行高、列宽
        .AutoSizeMode = flexAutoSizeRowHeight
        .SelectionMode = flexSelectionListBox
        .AllowBigSelection = False
        .Redraw = flexRDBuffered
        .AllowUserResizing = flexResizeColumns
        .AllowSelection = False
        
        If .Rows > 1 Then
            LoadSever = True
            .Row = 1
        Else
            .Row = -1
            MsgBox "未检测到已启用的服务器，请配置服务器！", vbInformation + vbDefaultButton1, gstrSysName
            LoadSever = False
        End If
        
    End With
    Exit Function
errH:
    If False Then
        Resume
    End If
End Function

Private Sub InitVSFWarning()
With vsfWarning
        '选中框风格
        .FocusRect = flexFocusSolid
        '最后一列自动列宽
        .ExtendLastCol = True
        '滚动画面跟随
        .ScrollTrack = True
        '自动换行
        .WordWrap = True
        '行高设置
        .RowHeightMin = 300
        .RowHeightMax = 300
        '最大宽度设置
        .ColWidthMax = 7000
        '自动适应行高、列宽
        .AutoSizeMode = flexAutoSizeRowHeight
        .SelectionMode = flexSelectionListBox
        .AllowBigSelection = False
        .Redraw = flexRDBuffered
        .AllowUserResizing = flexResizeColumns
        .AllowSelection = False
End With
End Sub
Private Function GetFileVision(ByVal strVision As String) As String
    Dim lng版本号 As Variant
    Dim str版本号 As String
    If Len(strVision) > 0 Then
        lng版本号 = strVision
        str版本号 = Int(lng版本号 / 10 ^ 8)
        If Len(lng版本号) > 9 Then
            lng版本号 = Right(lng版本号, 9) Mod (10 ^ 8)
        Else
            lng版本号 = lng版本号 Mod (10 ^ 8)
        End If
        
        str版本号 = str版本号 & "." & Int(lng版本号 / 10 ^ 4)
        lng版本号 = lng版本号 Mod 10 ^ 4
        str版本号 = str版本号 & "." & lng版本号
        GetFileVision = str版本号
    End If
End Function

Private Function GetSystemName(ByVal strNum As String) As String
'传入系统编号，获得对应系统名称，若未找到
On err GoTo errH
    Select Case strNum
        Case "1", "100"
            GetSystemName = "医院系统标准版"
        Case "2", "200"
            GetSystemName = "人事工资系统"
        Case "3", "300"
            GetSystemName = "病案管理系统"
        Case "4", "400"
            GetSystemName = "物资供应系统"
        Case "5", "500"
            GetSystemName = "财务核算系统"
        Case "6", "600"
            GetSystemName = "设备管理系统"
        Case "7", "700"
            GetSystemName = "成本效益核算系统"
        Case "21", "2100"
            GetSystemName = "体检管理系统"
        Case "22", "2200"
            GetSystemName = "血库管理系统"
        Case "23", "2300"
            GetSystemName = "院感管理系统"
        Case "24", "2400"
            GetSystemName = "手麻管理系统"
        Case "25", "2500"
            GetSystemName = "临床检验管理系统"
        Case "26", "2600"
            GetSystemName = "病人自助服务系统"
    End Select
    Exit Function

errH:
    If False Then
        Resume
    End If
End Function

Private Function BatchLoad() As String
'读取上传批次
    Dim strSQL As String
    Dim strTemp As String
    Dim rsTemp As New ADODB.Recordset
    
    On Error GoTo errH
    
    strSQL = "select 内容 as 批次 from ZLReginfo where 项目 = '最新升级文件批次'"
    Call OpenRecordset(rsTemp, strSQL, Me.Caption)
    
    If rsTemp.EOF Then
        strSQL = "insert into zltools.ZLReginfo(项目,内容) select '最新升级文件批次','0' from dual where not Exists (select 1 from zltools.ZLReginfo where 项目 ='最新升级文件批次')"
        gcnOracle.Execute strSQL
        BatchLoad = "0"
    Else
        BatchLoad = rsTemp.Fields("批次")
    End If
    Exit Function
errH:
    MsgBox "批次读取错误"
End Function

Private Function BatchUpdate(strBath As String) As Boolean
'更新上传批次
    Dim strSQL As String
    Dim i As Long
    
    On Error GoTo errH
    
'    strSQL = "update ZLReginfo set 内容 = '" & Trim(strBath) & "' where 项目 = '最新升级文件批次'"
'    gcnOracle.Execute strSQL
    
    With vsfSever
        If .Rows < 1 Then BatchUpdate = False: Exit Function
        For i = 1 To .Rows - 1
            If .TextMatrix(i, Col_检测结果) = "修复完成" Then
                strSQL = "update ZLUpgradeServer set 批次 = " & strBath & " where 编号 = " & Trim(.TextMatrix(i, Col_编号))
                gcnOracle.Execute strSQL
            End If
        Next
    End With

    BatchUpdate = True
    
    Exit Function
errH:
    BatchUpdate = False
    MsgBox "批次更新错误"
End Function

Private Function CheckFTPServer(ByVal strIp As String, ByVal strUser As String, ByVal strPass As String, ByVal strPort As String) As Boolean
    '-----------------------------------------------------------------------------
    '功能:检查当前的FTP服务器是否正确
    '返回:当前的文件服务器的各项正确,返回true,否则返回False
    '编制:陈振原
    '日期:2016/07/05
    'strIp - FTP地址
    'strUser - 用户名
    'strPass - 密码
    'strPort - 端口
    '-----------------------------------------------------------------------------
    On Error GoTo errHand:
    
    If strIp = "" Or strUser = "" Or strPass = "" Or strPort = "" Then
        CheckFTPServer = False
        Exit Function
    End If
    
    If IsFtpServer(Trim(strIp), Trim(strUser), Trim(strPass), Trim(strPort)) Then
        CheckFTPServer = True
    Else
        CheckFTPServer = False
        MsgBox "不能连接升级服务器，请检查FTP服务器配置!", vbInformation + vbDefaultButton1, gstrSysName
    End If
    Exit Function
    
errHand:
    If err Then
        MsgBox err.Description, vbInformation, gstrSysName
    End If
End Function

Private Function CheckShareServer(ByVal strAddress As String, ByVal strUser As String, ByVal strPass As String) As Boolean
    '-----------------------------------------------------------------------------
    '功能:检查当前的文件服务器是否正确
    '返回:当前的文件服务器的各项正确,返回true,否则返回False
    '编制:陈振原
    '日期:2016/07/05
    'strAddress - 地址
    'strUser - 用户
    'strPass - 密码
    '-----------------------------------------------------------------------------
    Dim typOfStruct As OFSTRUCT

    On Error GoTo errHand:
    
    If strAddress = "" Or strUser = "" Or strPass = "" Then
        CheckShareServer = False
        Exit Function
    End If
    
    If FindFile(Trim(strAddress)) = False Then
        If IsNetServer(Trim(strAddress), Trim(strUser), Trim(strPass)) = False Then
            MsgBox "不能连接升级服务器，请检查共享服务器配置！", vbInformation + vbDefaultButton1, gstrSysName
            CheckShareServer = False
            Exit Function
        End If
    End If
    Call CancelNetServer(Trim(strAddress))
    CheckShareServer = True
    Exit Function
errHand:
    If err Then
        MsgBox err.Description, vbInformation, gstrSysName
    End If
End Function

Private Function SeverFilesCheck(ByVal strNumber As String, ByVal strServerAddress As String, Optional ByVal strUser As String, Optional ByVal strPassword As String, Optional ByVal strPort As String, Optional ByRef strErrInfor As String, Optional ByVal strSeverType As String) As Boolean
    '---------------------------------------------------------------------------------------------------
    '功能:从指定服务器下载文件
    '参数:strNumber-文件服务器编号
    '     strSourcePath-源文件目录
    '     strServerAddress-服务器的共享目录
    '     strUser-访问的用户名
    '     strPassword-密码
    '     strPort-端口
    '出参:strErrInfor-返回的错误信息
    '返回:拷贝成功,返回true,否则返回False
    '编制:陈振原
    '日期:2016/07/22
    '---------------------------------------------------------------------------------------------------
    Dim objFile As New FileSystemObject
    Dim strTemp As String
    Dim strFileName As String   '复制文件名称
    Dim strFileCompressName As String '复制文件压缩后名称
    Dim strFileSource As String '被复制文件源地址
    Dim strFilePath As String
    
    Dim lngPercent As Long '进度条百分比
    Dim intPercent As Integer '文字显示百分比
    Dim lngWarning As Long  '警告
    Dim lngCount As Long
    Dim strWarning As String
    Dim i As Long
    Dim strSQL As String
    Dim blnUpLoadFail As Boolean
    Dim strFolderPath As String
    Dim strCompressionPath As String
    Dim strMD5 As String
    Dim driver As Drive
    
    For Each driver In objFile.Drives
        If driver.IsReady Then
            If driver.DriveLetter = "C" Then
                If driver.FreeSpace < 204800000 Then '小于200M
                    MsgBox "C盘没有足够的空间!", vbInformation, gstrSysName
                    Exit Function
                End If
                Exit For
            End If
        End If
    Next driver
    
    strFolderPath = mstrScratchFilePath & "\" & strNumber
    If FindFile(strFolderPath) = False Then
        On Error Resume Next
        Call mobjFile.CreateFolder(strFolderPath)
        If mobjFile.FolderExists(strFolderPath) = False Then
            MsgBox "下载目录不能创建,请检查!" & vbCrLf & strFolderPath, vbInformation + vbDefaultButton1, gstrSysName
            Exit Function
        End If
    End If
    
    objFile.DeleteFile strFolderPath & "\*.*", True
    objFile.DeleteFolder strFolderPath & "\*", True
    
    If Init7Z = False Then Exit Function
    
    err = 0: On Error GoTo errHand:
    
    Select Case strSeverType
        Case "共享"
'            1.检查服务器是否连通
            If CheckShareServer(strServerAddress, strUser, strPassword) = False Then Exit Function '共享服务器连接校验
'            MsgBox strNumber & " 号服服务器 " & """" & strServerAddress & """" & " 测试连接成功", vbDefaultButton1 + vbInformation, gstrSysName

            With vsfData
'                If .Rows < 1 Then MsgBox "部件升级表没有数据，请检查！", vbDefaultButton1 + vbInformation, gstrSysName: Exit Function
                pgbThis.Max = .Rows - 1: lngPercent = 0: pgbThis.value = lngPercent: lngWarning = 0: strWarning = ""
                .Cols = .Cols + 1: .TextMatrix(0, .Cols - 1) = strNumber
                For i = 1 To .Rows - 1
                    strFileName = UCase(Trim(vsfData.TextMatrix(i, Col_文件)))
                    If UCase(Nvl(strFileName, "")) <> UCase("zlHisCrust.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.dll") And UCase(Nvl(strFileName, "")) <> UCase("aamd532.dll") And UCase(Nvl(strFileName, "")) <> UCase("zlRunas.exe") And UCase(Nvl(strFileName, "")) <> UCase("RegCom.dll") And UCase(Nvl(strFileName, "")) <> UCase("GACUTIL.EXE") Then
                        strFileName = strFileName & ".7z"
                    End If
                    strFileSource = strServerAddress & "\" & strFileName
                    strFilePath = strFolderPath & "\" & strFileName
                    
                    intPercent = pgbThis.value / pgbThis.Max * 100
                    lblstatus.Caption = intPercent & "% 正在下载 " & strFileName & " 至 " & strFilePath
                    If objFile.FileExists(strFileSource) = True Then  '判断服务器上文件是否存在
                        DoEvents '防止界面卡顿
                        Call objFile.CopyFile(strFileSource, strFilePath, True)

                        If UCase(Nvl(strFileName, "")) <> UCase("zlHisCrust.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.dll") And UCase(Nvl(strFileName, "")) <> UCase("aamd532.dll") And UCase(Nvl(strFileName, "")) <> UCase("zlRunas.exe") And UCase(Nvl(strFileName, "")) <> UCase("RegCom.dll") And UCase(Nvl(strFileName, "")) <> UCase("GACUTIL.EXE") Then
                            strCompressionPath = Mid(strFilePath, 1, Len(strFilePath) - 3) '解压地址
                            DoEvents
                            lblstatus.Caption = intPercent & "% 正在解压 " & strFileName & " 至 " & strCompressionPath
                            If DeCompression(strCompressionPath, strFilePath, , False, False, strErrInfor) = False Then MsgBox strErrInfor
                        Else
                            strCompressionPath = strFilePath
                        End If

                        DoEvents
                        lblstatus.Caption = intPercent & "% 正在对比 " & strFileName & " MD5 "
                        strMD5 = FileMD5(strCompressionPath)
                        If strMD5 = .TextMatrix(i, Col_对比md5) Then
                            If .TextMatrix(i, Col_正确服务器) = "-1" Then .TextMatrix(i, Col_正确服务器) = strNumber
                            .TextMatrix(i, .Cols - 1) = Warning_正常
'                            .TextMatrix(i, .Cols - 1) = Warning_MD5不匹配 '测试
                        Else
                            lngCount = lngCount + 1
                            .TextMatrix(i, .Cols - 1) = Warning_MD5不匹配
                            strWarning = strWarning & strFileName & " - MD5不匹配" & vbCrLf
                            InsertWarning str(lngCount), strFileName, .TextMatrix(i, Col_当前版本), .TextMatrix(i, Col_安装路径), "服务器文件损坏", strNumber
                            FiltrWarning vsfSever.TextMatrix(vsfSever.Row, Col_编号)
                        End If
                    Else
                        lngCount = lngCount + 1
                        .TextMatrix(i, .Cols - 1) = Warning_服务器文件缺失
                        strWarning = strWarning & strFileName & " - 服务器文件缺失" & vbCrLf
                        InsertWarning str(lngCount), strFileName, .TextMatrix(i, Col_当前版本), .TextMatrix(i, Col_安装路径), "服务器文件缺失", strNumber
                        FiltrWarning vsfSever.TextMatrix(vsfSever.Row, Col_编号)
                    End If
                    pgbThis.value = lngPercent + i
                Next
            End With

        Case "FTP"
'            1.检查服务器是否连通
            If CheckFTPServer(strServerAddress, strUser, strPassword, strPort) = False Then Exit Function 'FTP服务器连接校验
'            MsgBox strNumber & " 号服服务器 " & """" & strServerAddress & """" & " 测试连接成功", vbDefaultButton1 + vbInformation, gstrSysName
                
            With vsfData
'                If .Rows < 1 Then MsgBox "部件升级表没有数据，请检查！", vbDefaultButton1 + vbInformation, gstrSysName: Exit Function
                pgbThis.Max = .Rows - 1: lngPercent = 0: pgbThis.value = lngPercent: lngWarning = 0: strWarning = ""
                .Cols = .Cols + 1: .TextMatrix(0, .Cols - 1) = strNumber
                For i = 1 To .Rows - 1
                    strFileName = UCase(Trim(vsfData.TextMatrix(i, Col_文件)))
                    If UCase(Nvl(strFileName, "")) <> UCase("zlHisCrust.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.dll") And UCase(Nvl(strFileName, "")) <> UCase("aamd532.dll") And UCase(Nvl(strFileName, "")) <> UCase("zlRunas.exe") And UCase(Nvl(strFileName, "")) <> UCase("RegCom.dll") And UCase(Nvl(strFileName, "")) <> UCase("GACUTIL.EXE") Then
                        strFileName = strFileName & ".7z"
                    End If
                    strFileSource = strServerAddress & "\" & strFileName
                    strFilePath = strFolderPath & "\" & strFileName
                    
                    intPercent = pgbThis.value / pgbThis.Max * 100
                    lblstatus.Caption = intPercent & "% 正在下载 " & strFileName & " 至 " & strFilePath
                    
                    DoEvents
                    If FtpDownFile(strFileName, strFilePath) = True Then
                    
                        If UCase(Nvl(strFileName, "")) <> UCase("zlHisCrust.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.dll") And UCase(Nvl(strFileName, "")) <> UCase("aamd532.dll") And UCase(Nvl(strFileName, "")) <> UCase("zlRunas.exe") And UCase(Nvl(strFileName, "")) <> UCase("RegCom.dll") And UCase(Nvl(strFileName, "")) <> UCase("GACUTIL.EXE") Then
                            strCompressionPath = Mid(strFilePath, 1, Len(strFilePath) - 3) '解压地址
                            DoEvents
                            lblstatus.Caption = intPercent & "% 正在解压 " & strFileName & " 至 " & strCompressionPath
                            If DeCompression(strCompressionPath, strFilePath, , False, False, strErrInfor) = False Then MsgBox strErrInfor
                        Else
                            strCompressionPath = strFilePath
                        End If

                        DoEvents
                        lblstatus.Caption = intPercent & "% 正在对比 " & strFileName & " MD5 "
                        strMD5 = FileMD5(strCompressionPath)
                        If strMD5 = .TextMatrix(i, Col_对比md5) Then
                            If .TextMatrix(i, Col_正确服务器) = "-1" Then .TextMatrix(i, Col_正确服务器) = strNumber
                            .TextMatrix(i, .Cols - 1) = Warning_正常
                        Else
                            lngCount = lngCount + 1
                            .TextMatrix(i, .Cols - 1) = Warning_MD5不匹配
                            strWarning = strWarning & strFileName & " - MD5不匹配" & vbCrLf
                            InsertWarning str(lngCount), strFileName, .TextMatrix(i, Col_当前版本), .TextMatrix(i, Col_安装路径), "服务器文件损坏", strNumber
                            FiltrWarning vsfSever.TextMatrix(vsfSever.Row, Col_编号)
                        End If
                    Else
                        lngCount = lngCount + 1
                        .TextMatrix(i, .Cols - 1) = Warning_服务器文件缺失
                        strWarning = strWarning & strFileName & " - 服务器文件缺失" & vbCrLf
                        InsertWarning str(lngCount), strFileName, .TextMatrix(i, Col_当前版本), .TextMatrix(i, Col_安装路径), "服务器文件缺失", strNumber
                        FiltrWarning vsfSever.TextMatrix(vsfSever.Row, Col_编号)
                    End If
                    pgbThis.value = lngPercent + i
                Next
            End With
    End Select
    pgbThis.value = pgbThis.Max
    lblstatus.Caption = strNumber & " 号服务器检测完成"
    SeverFilesCheck = True
    If strWarning <> "" Then
'        MsgBox "服务器缺失文件:" & vbCrLf & strWarning, vbInformation, gstrSysName
        SeverFilesCheck = False
    End If
    Exit Function
errHand:
    strErrInfor = "出现无可预知的错误,错误信息如下:" & vbCrLf & "错误号:" & err.Number & vbCrLf & "错误描述:" & err.Description
    mblnStates = False
    If False = 1 Then
        Resume
    End If
End Function

Private Function SeverFilesRepair(ByVal strNumber As String, ByVal strServerAddress As String, Optional ByVal strUser As String, Optional ByVal strPassword As String, Optional ByVal strPort As String, Optional ByRef strErrInfor As String, Optional ByVal strSeverType As String) As Boolean
    
    '---------------------------------------------------------------------------------------------------
    '功能:从指定服务器下载文件
    '参数:strNumber-文件服务器编号
    '     strSourcePath-源文件目录
    '     strServerAddress-服务器的共享目录
    '     strUser-访问的用户名
    '     strPassword-密码
    '     strPort-端口
    '出参:strErrInfor-返回的错误信息
    '返回:拷贝成功,返回true,否则返回False
    '编制:陈振原
    '日期:2016/07/22
    '---------------------------------------------------------------------------------------------------
    Dim objFile As New FileSystemObject
    Dim strTemp As String
    Dim strFileName As String   '复制文件名称
    
    Dim strFileSource As String '被复制文件源地址
    Dim strFilePath As String '目标文件地址
    Dim strFolderPath As String '文件夹地址
    Dim strCompressionPath As String '压缩解压地址
    Dim strFileRepair As String '本地修复文件存储地址
    
    Dim lngPercent As Long '进度条百分比
    Dim intPercent As Integer '文字显示百分比
    Dim lngWarning As Long  '警告
    Dim strWarning As String '部件错误记录
    Dim strErr As String '临时错误记录
    
    Dim i As Long
    Dim strSQL As String
    Dim strMD5 As String
    Dim driver As Drive
    Dim intSeverCol As Integer


    '查找记录当前服务器检测结果的列
    For i = Col_列数 To vsfData.Cols - 1
        If vsfData.TextMatrix(0, i) = strNumber Then intSeverCol = i: Exit For
    Next
    If intSeverCol = vsfData.Cols Then strErrInfor = "选中的服务器没有检测记录": Exit Function
    
    strFileRepair = mstrScratchFilePath & "\Repair"
    
    If FindFile(strFileRepair) = False Then
        On Error Resume Next
        Call mobjFile.CreateFolder(strFileRepair)
        If mobjFile.FolderExists(strFileRepair) = False Then
            MsgBox "下载目录不能创建,请检查!" & vbCrLf & strFileRepair, vbInformation + vbDefaultButton1, gstrSysName
            Exit Function
        End If
    End If
    objFile.DeleteFile strFileRepair & "\*.*", True
    objFile.DeleteFolder strFileRepair & "\*", True

    
    If Init7Z = False Then Exit Function
    
    err = 0: On Error GoTo errHand:

    Select Case strSeverType
        Case "共享"
'            1.检查服务器是否连通
            If CheckShareServer(strServerAddress, strUser, strPassword) = False Then Exit Function '共享服务器连接校验
            With vsfData
'                If .Rows < 1 Then MsgBox "部件升级表没有数据，请检查！", vbDefaultButton1 + vbInformation, gstrSysName: Exit Function
                pgbThis.Max = .Rows - 1: lngPercent = 0: pgbThis.value = lngPercent: lngWarning = 0: strWarning = ""
                
                For i = 1 To .Rows - 1
                    strFileName = UCase(Trim(vsfData.TextMatrix(i, Col_文件)))
                    If Nvl(.TextMatrix(i, intSeverCol), "0") <> Warning_正常 Then
                        intPercent = pgbThis.value / pgbThis.Max * 100
                        lblstatus.Caption = intPercent & "% 正在修复 " & strFileName
                        
                        If UCase(Nvl(strFileName, "")) <> UCase("zlHisCrust.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.dll") And UCase(Nvl(strFileName, "")) <> UCase("aamd532.dll") And UCase(Nvl(strFileName, "")) <> UCase("zlRunas.exe") And UCase(Nvl(strFileName, "")) <> UCase("RegCom.dll") And UCase(Nvl(strFileName, "")) <> UCase("GACUTIL.EXE") Then
                            strFileName = strFileName & ".7z"
                        End If
                        strFilePath = strServerAddress & "\" & strFileName
                        
                        If Trim(.TextMatrix(i, Col_正确服务器)) <> "-1" Then
                            strFolderPath = mstrScratchFilePath & "\" & Trim(.TextMatrix(i, Col_正确服务器)) '正常服务器文件地址
                            strFileSource = strFolderPath & "\" & strFileName
                            If objFile.FileExists(strFileSource) = False Then
                                strFileSource = ""
                                .TextMatrix(i, intSeverCol) = Warning_不能修复
                                strWarning = strWarning & strFileName & " - 文件缺失未修复" & vbCrLf
                            End If
                        Else '需要使用本地文件修复
                            If Nvl(.TextMatrix(i, Col_检测)) <> Warning_本地文件缺失 Then
                                DoEvents
                                strMD5 = FileMD5(.TextMatrix(i, Col_本地文件地址))
                                If strMD5 = .TextMatrix(i, Col_对比md5) Then '对比md5
                                    If UCase(Nvl(strFileName, "")) <> UCase("zlHisCrust.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.dll") And UCase(Nvl(strFileName, "")) <> UCase("aamd532.dll") And UCase(Nvl(strFileName, "")) <> UCase("zlRunas.exe") And UCase(Nvl(strFileName, "")) <> UCase("RegCom.dll") And UCase(Nvl(strFileName, "")) <> UCase("GACUTIL.EXE") Then
                                        strCompressionPath = strFileRepair & "\" & strFileName '压缩地址
                                        DoEvents
                                        If DeCompression(strCompressionPath, .TextMatrix(i, Col_本地文件地址), , True, False, strErr) = False Then MsgBox strErr: strErr = ""
                                    Else
                                        strCompressionPath = .TextMatrix(i, Col_本地文件地址)
                                    End If
                                    strFileSource = strCompressionPath
                                Else
                                    strFileSource = ""
                                    .TextMatrix(i, intSeverCol) = Warning_不能修复
                                    strWarning = strWarning & strFileName & " - MD5不匹配未修复" & vbCrLf
                                End If
                            Else
                                strFileSource = ""
                                .TextMatrix(i, intSeverCol) = Warning_不能修复
                                strWarning = strWarning & strFileName & " - 未修复" & vbCrLf
                            End If
                        End If
                
                        If strFileSource <> "" Then
                            DoEvents '防止界面卡顿
                            Call objFile.CopyFile(strFileSource, strFilePath, True)
                            .TextMatrix(i, intSeverCol) = Warning_正常
                        End If
                    Else
                        intPercent = pgbThis.value / pgbThis.Max * 100
                        lblstatus.Caption = intPercent & "% " & strFileName & " 正常 "
                    End If
                    pgbThis.value = lngPercent + i
                Next
            End With

        Case "FTP"
'            1.检查服务器是否连通
            If CheckFTPServer(strServerAddress, strUser, strPassword, strPort) = False Then Exit Function 'FTP服务器连接校验
            MsgBox strNumber & " 号服服务器 " & """" & strServerAddress & """" & " 测试连接成功", vbDefaultButton1 + vbInformation, gstrSysName
                  
            With vsfData
                pgbThis.Max = .Rows - 1: lngPercent = 0: pgbThis.value = lngPercent: lngWarning = 0: strWarning = ""
                For i = 1 To .Rows - 1
                    strFileName = UCase(Trim(vsfData.TextMatrix(i, Col_文件)))
                    
                    If Nvl(.TextMatrix(i, intSeverCol), "0") <> Warning_正常 Then
                        intPercent = pgbThis.value / pgbThis.Max * 100
                        lblstatus.Caption = intPercent & "% 正在修复 " & strFileName
                        
                        If UCase(Nvl(strFileName, "")) <> UCase("zlHisCrust.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.dll") And UCase(Nvl(strFileName, "")) <> UCase("aamd532.dll") And UCase(Nvl(strFileName, "")) <> UCase("zlRunas.exe") And UCase(Nvl(strFileName, "")) <> UCase("RegCom.dll") And UCase(Nvl(strFileName, "")) <> UCase("GACUTIL.EXE") Then
                            strFileName = strFileName & ".7z"
                        End If
                        strFilePath = strServerAddress & "\" & strFileName
                        
                        If Trim(.TextMatrix(i, Col_正确服务器)) <> "-1" Then '优先使用标记为正常的服务器文件修复
                            strFolderPath = mstrScratchFilePath & "\" & Trim(.TextMatrix(i, Col_正确服务器)) '正常服务器文件地址
                            strFileSource = strFolderPath & "\" & strFileName
                            If objFile.FileExists(strFileSource) = False Then
                                strFileSource = ""
                                .TextMatrix(i, intSeverCol) = Warning_不能修复
                                strWarning = strWarning & strFileName & " - 文件缺失未修复" & vbCrLf
                            End If
                        Else '需要使用本地文件修复
                            If .TextMatrix(i, Col_检测) <> Warning_本地文件缺失 Then
                                DoEvents
                                strMD5 = FileMD5(.TextMatrix(i, Col_本地文件地址))
                                If strMD5 = .TextMatrix(i, Col_对比md5) Then '对比md5
                                    If UCase(Nvl(strFileName, "")) <> UCase("zlHisCrust.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.exe") And UCase(Nvl(strFileName, "")) <> UCase("7z.dll") And UCase(Nvl(strFileName, "")) <> UCase("aamd532.dll") And UCase(Nvl(strFileName, "")) <> UCase("zlRunas.exe") And UCase(Nvl(strFileName, "")) <> UCase("RegCom.dll") And UCase(Nvl(strFileName, "")) <> UCase("GACUTIL.EXE") Then
                                        strCompressionPath = strFileRepair & "\" & strFileName '压缩地址
                                        DoEvents
                                        If DeCompression(strCompressionPath, .TextMatrix(i, Col_本地文件地址), , True, False, strErr) = False Then MsgBox strErr: strErr = ""
                                    Else
                                        strCompressionPath = .TextMatrix(i, Col_本地文件地址)
                                    End If
                                    strFileSource = strCompressionPath
                                Else
                                    strFileSource = ""
                                    .TextMatrix(i, intSeverCol) = Warning_不能修复
                                    strWarning = strWarning & strFileName & " - MD5不匹配未修复" & vbCrLf
                                End If
                            Else
                                strFileSource = ""
                                .TextMatrix(i, intSeverCol) = Warning_不能修复
                                strWarning = strWarning & strFileName & " - 本地文件缺失" & vbCrLf
                            End If
                        End If
                
                        If strFileSource <> "" Then
                            DoEvents '防止界面卡顿
                            If FtpupFile(strFileSource, strFileName) = False Then
                                .TextMatrix(i, intSeverCol) = Warning_不能修复
                                strWarning = strWarning & strFileName & " - 上传失败" & vbCrLf
                            Else
                                .TextMatrix(i, intSeverCol) = Warning_正常
                            End If
                        End If
                    Else
                        intPercent = pgbThis.value / pgbThis.Max * 100
                        lblstatus.Caption = intPercent & "% " & strFileName & " 正常 "
                    End If
                    pgbThis.value = lngPercent + i
                Next
            End With
    End Select
    pgbThis.value = pgbThis.Max
    lblstatus.Caption = "100% " & strNumber & " 号服务器尝试修复完成"
    
    SeverFilesRepair = True
    If strWarning <> "" Then
'        MsgBox "修复失败:" & vbCrLf & strWarning, vbInformation, gstrSysName
        SeverFilesRepair = False
    End If
    Exit Function
errHand:
    strErrInfor = "出现无可预知的错误,错误信息如下:" & vbCrLf & "错误号:" & err.Number & vbCrLf & "错误描述:" & err.Description
    mblnStates = False
    If False = 1 Then
        Resume
    End If
End Function

Private Function FindFile(ByVal strFileName As String) As Boolean
    '------------------------------------------------------------------------------------------------------------------------------------
    '--功能:查找指定的文件或文夹是否存在
    '--返回: 如果存在此文件为True,否则为Flase
    '------------------------------------------------------------------------------------------------------------------------------------
    Dim typOfStruct As OFSTRUCT
    
    On Error Resume Next
    FindFile = False
    If Len(strFileName) > 0 Then
        apiOpenFile strFileName, typOfStruct, OF_EXIST
        FindFile = typOfStruct.nErrCode <> 2
    End If
End Function

Private Function DataCheck(Optional ByRef strInformation As String) As Boolean
    Dim objFile As New FileSystemObject
    Dim strFileName As String
    Dim strTemp As String
    Dim i As Long
    Dim lngAbnormal As Long
    '本地环境检测
    DataCheck = True
    With vsfData
        If .Rows < 1 Then MsgBox "部件升级表没有数据，请检查", vbInformation, gstrSysName: Exit Function
        For i = 1 To .Rows - 1
            lngAbnormal = 0
            strFileName = UCase(.Cell(flexcpText, i, Col_安装路径) & "\" & .Cell(flexcpText, i, Col_文件))
            If InStr(strFileName, "[PUBLIC]") > 0 Then
                If gblnInIDE Then
                    strFileName = Replace(strFileName, "[PUBLIC]", "C:\APPSOFT\PUBLIC") '测试路径
                Else
                    strFileName = Replace(strFileName, "[PUBLIC]", App.Path & "\" & "")
                End If
            End If
            If InStr(strFileName, "[APPSOFT]") > 0 Then
                If gblnInIDE Then
                    strFileName = Replace(strFileName, "[APPSOFT]", "C:\APPSOFT") '测试路径
                Else
                    strFileName = Replace(strFileName, "[APPSOFT]", App.Path)
                End If
            End If
            If InStr(strFileName, "[SYSTEM]") > 0 Then
                strFileName = Replace(strFileName, "[SYSTEM]", objFile.GetSpecialFolder(SystemFolder))
            End If
            .Cell(flexcpText, i, Col_本地文件地址) = UCase(Trim(strFileName))
                
            If objFile.FileExists(strFileName) = False Then
                .TextMatrix(i, Col_检测) = Warning_本地文件缺失
                strInformation = strInformation & strFileName & vbCrLf
            End If
        Next
        If strInformation <> "" Then DataCheck = False
    End With
End Function

Private Sub Form_Unload(Cancel As Integer)
    If mblnStates Then Cancel = True
End Sub

Private Sub vsfSever_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
'    If vsfSever.Visible = True Then If vsfSever.TextMatrix(OldRow, Col_检测结果) = "正在检测" Then vsfSever.Row = OldRow
    Dim lngWarning As Long
    lngWarning = FiltrWarning(vsfSever.TextMatrix(NewRow, Col_编号))
    If mblnCheck = False Then Exit Sub '检查完成后允许显示提示信息
    If lngWarning > 0 Then
        imgCaption.Picture = imgList.ListImages.Item("检查完成错误").Picture
        lblWarning(0).Caption = vsfSever.TextMatrix(NewRow, Col_编号) & "号服务器存在问题"
        picWarning.Visible = True
    Else
        imgCaption.Picture = imgList.ListImages.Item("检查完成正常").Picture
        picWarning.Visible = False
    End If
End Sub

Private Sub vsfSever_BeforeRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long, Cancel As Boolean)
'    If vsfSever.Visible = True Then If vsfSever.TextMatrix(OldRow, Col_检测结果) = "正在检测" Then Cancel = 1
End Sub

Private Sub InsertWarning(strNo As String, strFileName As String, strFileVision As String, strFilePath As String, strWaring As String, strSeverNo As String)
    With vsfWarning
        .Rows = .Rows + 1
        .Redraw = flexRDNone
        .TextMatrix(.Rows - 1, WICol_编号) = strNo
        .TextMatrix(.Rows - 1, WICol_文件名称) = strFileName
        .TextMatrix(.Rows - 1, WICol_当前版本) = strFileVision
        .TextMatrix(.Rows - 1, WICol_安装路径) = strFilePath
        .TextMatrix(.Rows - 1, WICol_警告) = strWaring
        .TextMatrix(.Rows - 1, WICol_服务器编号) = Trim(strSeverNo)
        .Cell(flexcpForeColor, .Rows - 1, WICol_警告) = vbRed
        .Redraw = flexRDBuffered
        .Row = .Rows - 1
        .ShowCell .Row, 1
    End With
End Sub

Private Function FiltrWarning(strSeverNo As String) As Long
    Dim i As Long
    Dim lngCount As Long
    strSeverNo = Trim(strSeverNo)
    With vsfWarning
        If .Rows < .FixedRows Then Exit Function
        .Redraw = flexRDNone
        For i = .FixedRows To .Rows - 1
            If .TextMatrix(i, WICol_服务器编号) = strSeverNo Then
                .RowHidden(i) = False
                lngCount = lngCount + 1
            Else
                .RowHidden(i) = True
            End If
        Next
        .Redraw = flexRDBuffered
        If .RowHidden(.Row) = False Then .ShowCell .Row, 0
    End With
    FiltrWarning = lngCount
End Function

Private Sub ShowPgbThis(blnShowPgbbar As Boolean)
    If blnShowPgbbar Then
        pgbThis.Visible = True
        vsfSever.Move 45, 2265, 8805, 1845
    Else
        pgbThis.Visible = False
        vsfSever.Move 45, 1875, 8805, 2235
    End If
End Sub

