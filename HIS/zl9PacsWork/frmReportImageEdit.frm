VERSION 5.00
Object = "{555E8FCC-830E-45CC-AF00-A012D5AE7451}#9.60#0"; "Codejock.CommandBars.9600.ocx"
Object = "{F9043C88-F6F2-101A-A3C9-08002B2F49FB}#1.2#0"; "comdlg32.ocx"
Object = "{853AAF94-E49C-11D0-A303-0040C711066C}#4.3#0"; "DicomObjects.ocx"
Begin VB.Form frmReportImageEdit 
   Caption         =   "报告图片编辑"
   ClientHeight    =   7440
   ClientLeft      =   60
   ClientTop       =   450
   ClientWidth     =   12960
   Icon            =   "frmReportImageEdit.frx":0000
   LinkTopic       =   "Form1"
   ScaleHeight     =   7440
   ScaleWidth      =   12960
   StartUpPosition =   3  '窗口缺省
   Begin VB.PictureBox picCboDropDown 
      BorderStyle     =   0  'None
      Height          =   375
      Left            =   5520
      Picture         =   "frmReportImageEdit.frx":0E42
      ScaleHeight     =   375
      ScaleWidth      =   255
      TabIndex        =   3
      Top             =   6600
      Width           =   255
   End
   Begin VB.ListBox lstMemoText 
      BeginProperty Font 
         Name            =   "宋体"
         Size            =   14.25
         Charset         =   134
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   3200
      Left            =   0
      TabIndex        =   2
      Top             =   2400
      Visible         =   0   'False
      Width           =   2055
   End
   Begin VB.Frame frmLabels 
      Height          =   5175
      Left            =   6120
      TabIndex        =   12
      Top             =   0
      Width           =   4215
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "自定义"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   11
         Left            =   2865
         Style           =   1  'Graphical
         TabIndex        =   35
         ToolTipText     =   "自定义文字标注"
         Top             =   4560
         Width           =   1095
      End
      Begin VB.TextBox txtUserLabelText 
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Left            =   960
         TabIndex        =   34
         Top             =   4560
         Width           =   1815
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "Xn=直接活检部位"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   10
         Left            =   960
         Style           =   1  'Graphical
         TabIndex        =   33
         ToolTipText     =   "文字标注"
         Top             =   4020
         Width           =   3000
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "P=点状血管"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   9
         Left            =   960
         Style           =   1  'Graphical
         TabIndex        =   32
         ToolTipText     =   "文字标注"
         Top             =   3480
         Width           =   3000
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "V=非典型血管"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   8
         Left            =   960
         Style           =   1  'Graphical
         TabIndex        =   31
         ToolTipText     =   "文字标注"
         Top             =   2940
         Width           =   3000
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "AT=异常转化区"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   7
         Left            =   960
         Style           =   1  'Graphical
         TabIndex        =   30
         ToolTipText     =   "文字标注"
         Top             =   2400
         Width           =   3000
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "W=醋酸白色上皮"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   6
         Left            =   960
         Style           =   1  'Graphical
         TabIndex        =   29
         ToolTipText     =   "文字标注"
         Top             =   1860
         Width           =   3000
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "I=浸润性癌"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   5
         Left            =   2460
         Style           =   1  'Graphical
         TabIndex        =   28
         ToolTipText     =   "文字标注"
         Top             =   1320
         Width           =   1500
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "C=湿疣"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   4
         Left            =   960
         Style           =   1  'Graphical
         TabIndex        =   27
         ToolTipText     =   "文字标注"
         Top             =   1320
         Width           =   1500
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "L=粘膜白斑"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   3
         Left            =   2460
         Style           =   1  'Graphical
         TabIndex        =   26
         ToolTipText     =   "文字标注"
         Top             =   780
         Width           =   1500
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "M=镶嵌"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   2
         Left            =   960
         Style           =   1  'Graphical
         TabIndex        =   25
         ToolTipText     =   "文字标注"
         Top             =   780
         Width           =   1500
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "E=糜烂区"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   1
         Left            =   2460
         Style           =   1  'Graphical
         TabIndex        =   24
         ToolTipText     =   "文字标注"
         Top             =   240
         Width           =   1500
      End
      Begin VB.CommandButton cmdNum 
         Caption         =   "9"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   14.25
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   9
         Left            =   240
         Style           =   1  'Graphical
         TabIndex        =   23
         ToolTipText     =   "数字编号9"
         Top             =   4560
         Width           =   450
      End
      Begin VB.CommandButton cmdNum 
         Caption         =   "8"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   14.25
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   8
         Left            =   240
         Style           =   1  'Graphical
         TabIndex        =   22
         ToolTipText     =   "数字编号8"
         Top             =   4080
         Width           =   450
      End
      Begin VB.CommandButton cmdNum 
         Caption         =   "7"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   14.25
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   7
         Left            =   240
         Style           =   1  'Graphical
         TabIndex        =   21
         ToolTipText     =   "数字编号7"
         Top             =   3600
         Width           =   450
      End
      Begin VB.CommandButton cmdNum 
         Caption         =   "6"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   14.25
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   6
         Left            =   240
         Style           =   1  'Graphical
         TabIndex        =   20
         ToolTipText     =   "数字编号6"
         Top             =   3120
         Width           =   450
      End
      Begin VB.CommandButton cmdNum 
         Caption         =   "5"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   14.25
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   5
         Left            =   240
         Style           =   1  'Graphical
         TabIndex        =   19
         ToolTipText     =   "数字编号5"
         Top             =   2640
         Width           =   450
      End
      Begin VB.CommandButton cmdNum 
         Caption         =   "4"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   14.25
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   4
         Left            =   240
         Style           =   1  'Graphical
         TabIndex        =   18
         ToolTipText     =   "数字编号4"
         Top             =   2160
         Width           =   450
      End
      Begin VB.CommandButton cmdNum 
         Caption         =   "3"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   14.25
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   3
         Left            =   240
         Style           =   1  'Graphical
         TabIndex        =   17
         ToolTipText     =   "数字编号3"
         Top             =   1680
         Width           =   450
      End
      Begin VB.CommandButton cmdNum 
         Caption         =   "2"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   14.25
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   2
         Left            =   240
         Style           =   1  'Graphical
         TabIndex        =   16
         ToolTipText     =   "数字编号2"
         Top             =   1200
         Width           =   450
      End
      Begin VB.CommandButton cmdNum 
         Caption         =   "1"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   14.25
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   1
         Left            =   240
         Style           =   1  'Graphical
         TabIndex        =   15
         ToolTipText     =   "数字编号1"
         Top             =   720
         Width           =   450
      End
      Begin VB.CommandButton cmdNum 
         Caption         =   "①"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   14.25
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   0
         Left            =   240
         Style           =   1  'Graphical
         TabIndex        =   14
         ToolTipText     =   "自动递增数字编号"
         Top             =   240
         Width           =   450
      End
      Begin VB.CommandButton cmdTextLabel 
         Caption         =   "Po=息肉"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   12
            Charset         =   134
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   450
         Index           =   0
         Left            =   960
         Style           =   1  'Graphical
         TabIndex        =   13
         Tag             =   "文字标注"
         ToolTipText     =   "文字标注"
         Top             =   240
         Width           =   1500
      End
   End
   Begin VB.CommandButton cmdFont 
      Height          =   375
      Left            =   7680
      Picture         =   "frmReportImageEdit.frx":119E
      Style           =   1  'Graphical
      TabIndex        =   10
      ToolTipText     =   "设置当前备注字体。"
      Top             =   5880
      Width           =   375
   End
   Begin VB.CommandButton cmdNext 
      Caption         =   "下一幅"
      Height          =   400
      Left            =   2400
      TabIndex        =   9
      Top             =   6600
      Width           =   1100
   End
   Begin VB.CommandButton cmdCur 
      Caption         =   "上一幅"
      Height          =   400
      Left            =   1080
      TabIndex        =   8
      Top             =   6600
      Width           =   1100
   End
   Begin VB.ComboBox cbxMemoText 
      BeginProperty Font 
         Name            =   "宋体"
         Size            =   14.25
         Charset         =   134
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   405
      Left            =   2280
      TabIndex        =   7
      Top             =   5880
      Width           =   5055
   End
   Begin VB.CommandButton cmdInsert 
      Height          =   375
      Left            =   7320
      Picture         =   "frmReportImageEdit.frx":14E0
      Style           =   1  'Graphical
      TabIndex        =   6
      ToolTipText     =   "将当前备注设置为常用备注"
      Top             =   5880
      Width           =   375
   End
   Begin VB.CommandButton cmdExit 
      Caption         =   "退出"
      Height          =   400
      Left            =   9120
      TabIndex        =   5
      Top             =   6600
      Width           =   1100
   End
   Begin VB.CommandButton cmdAdd 
      Caption         =   "添加"
      Height          =   400
      Left            =   7680
      TabIndex        =   4
      Top             =   6600
      Width           =   1100
   End
   Begin MSComDlg.CommonDialog diaFont 
      Left            =   4680
      Top             =   6600
      _ExtentX        =   847
      _ExtentY        =   847
      _Version        =   393216
   End
   Begin VB.TextBox txtInputText 
      BackColor       =   &H00C0C0FF&
      BorderStyle     =   0  'None
      BeginProperty Font 
         Name            =   "宋体"
         Size            =   10.5
         Charset         =   134
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   4440
      TabIndex        =   1
      Top             =   4800
      Visible         =   0   'False
      Width           =   1095
   End
   Begin DicomObjects.DicomViewer DViewer 
      Height          =   3495
      Left            =   720
      TabIndex        =   0
      Top             =   600
      Width           =   5175
      _Version        =   262147
      _ExtentX        =   9128
      _ExtentY        =   6165
      _StockProps     =   35
      BackColor       =   -2147483638
      UseScrollBars   =   0   'False
   End
   Begin VB.Label lblMemoText 
      AutoSize        =   -1  'True
      Caption         =   "添加备注文字："
      BeginProperty Font 
         Name            =   "宋体"
         Size            =   10.5
         Charset         =   134
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   210
      Left            =   720
      TabIndex        =   11
      Top             =   5955
      Width           =   1470
   End
   Begin XtremeCommandBars.CommandBars cbrMain 
      Left            =   240
      Top             =   120
      _Version        =   589884
      _ExtentX        =   635
      _ExtentY        =   635
      _StockProps     =   0
   End
End
Attribute VB_Name = "frmReportImageEdit"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

Private Type TPoint
  X As Integer
  Y As Integer
End Type

Private mlngModule As Long
Private mImage As DicomImage
Private mintMouseState As TMouseState
Private mblnDcmViewDown As Boolean
Private mMouseDownPoint As TPoint
Private mInitScrollPoint As TPoint
Private mCorpSize As TPoint             '拖动后的相对偏移位置

'调窗和漫游使用的鼠标基准位置
Private mlngBaseXX As Long
Private mlngBaseYY As Long
'移动标注使用的鼠标基准位置
Private mlngBaseX As Long
Private mlngBaseY As Long

Private mdcmSelectLabel As DicomLabel   '当前被选中的标注
Private mMovingLabel As DicomLabel      '当前选中要移动或者删除的标注

Private mblnOK As Boolean
Private mOldImage As DicomImage
Private mintCurImgIndex As Integer      '父窗体选中缩略图的索引
Private mfrmParent As Object            '父窗体模块对象
Private mSelViewerIndex As Integer      '父窗体被选中的报告图象框ID，从1开始计数
Private mblnIsMark As Boolean           '是标记图
Private mintTextIndex As Integer        '文字标注按钮的索引
Private mintNumberIndex As Integer      '数字编号按钮的索引
Private mintAutoNumber As Integer       '自动递增编号的最大号码

Private mrsTmp As ADODB.Recordset       '图像备注记录集

Private Enum TMouseState
    msNone = 0          '无状态
    msWinLevel = 1      '窗宽窗位
    msZoom = 2          '缩放
    msRectangle = 3     '框选缩放
    msArrow = 11        '箭头
    msEllipse = 12      '椭圆
    msText = 13         '文字
    msDrag = 14         '漫游拖动
    msNumber = 15       '数字编号
    msFixText = 16      '文字按钮
    msMove = 17         '移动和删除标注
End Enum

Public Sub zlShowMe(ByVal img As DicomImage, frmParent As frmReportImage, _
    intCurImgIndex As Integer, SelViewerIndex As Integer, ByVal lngModule As Long)
    
    On Error GoTo err
    
    Dim i As Integer
    '去除边框
    For i = 1 To img.Labels.Count
        If img.Labels(i).tag = "SELECT" Or img.Labels(i).tag = "BORDER" Then
            img.Labels(i).Visible = False
        End If
    Next
    
    Set mOldImage = img

    mlngModule = lngModule
    mintCurImgIndex = intCurImgIndex
    mSelViewerIndex = SelViewerIndex
    Set mfrmParent = frmParent
    
    '是图像标注，则处理标记图
    If mintCurImgIndex = 0 Then
        mblnIsMark = True
    Else
        mblnIsMark = False
    End If
    
    cmdNext.Visible = Not mblnIsMark
    cmdCur.Visible = Not mblnIsMark
    Me.lblMemoText.Visible = Not mblnIsMark
    Me.cbxMemoText.Visible = Not mblnIsMark
    Me.picCboDropDown.Visible = Not mblnIsMark
    Me.cmdInsert.Visible = Not mblnIsMark
    Me.cmdFont.Visible = Not mblnIsMark
    
    Me.DViewer.Images.Clear
    Me.DViewer.Images.Add img
    '重建标注之间的关联
    Call subLabelCopyRebuild(img, Me.DViewer.Images(1))
    
    Me.Show 0, frmParent
    SetWindowPos Me.hWnd, -1, Me.CurrentX, Me.CurrentY, Me.ScaleWidth, Me.ScaleHeight, 3  '将窗口置顶
    
    Exit Sub
err:
    If ErrCenter() = 1 Then Resume
End Sub

Private Sub ChangeImage(intType As Integer)
'intType 切换类型 1 --上一幅图；2--下一幅图
    Dim i As Integer
    
    Me.DViewer.Images.Clear
    If intType = 1 Then  '上一幅图
        If mintCurImgIndex <= 1 Then
            Call mfrmParent.MovePage(mtLast)
            mintCurImgIndex = mfrmParent.ImageCount
        Else
            mintCurImgIndex = mintCurImgIndex - 1
        End If
        
        Me.DViewer.Images.Add mfrmParent.dcmImages(mintCurImgIndex)
    ElseIf intType = 2 Then   '下一幅图
        If mintCurImgIndex >= mfrmParent.ImageCount Then
            Call mfrmParent.MovePage(mtNext)
            mintCurImgIndex = 1
        Else
            mintCurImgIndex = mintCurImgIndex + 1
        End If
        
        
        Me.DViewer.Images.Add mfrmParent.dcmImages(mintCurImgIndex)
    End If
    
    '添加选中图形的边框颜色
    Me.DViewer.Images(1).BorderColour = vbRed
    
    '对父窗体缩略图的边框颜色进行处理
    For i = 1 To mfrmParent.ImageCount
        mfrmParent.dcmImages(i).BorderColour = vbWhite
    Next i
    
    Set mfrmParent.mSelMiniImg = mfrmParent.dcmImages(mintCurImgIndex)
    mfrmParent.mSelMiniImg.BorderColour = vbRed
    
    '清空ComboBox文本
    zlControl.CboSetIndex cbxMemoText.hWnd, -1
    
    '关闭下拉框
    If lstMemoText.Visible Then lstMemoText.Visible = False
End Sub

Private Function getListIndex() As Integer
'根据检索条件获取索引
    Dim i As Integer

    getListIndex = -1
    
    If mrsTmp.RecordCount <= 0 Then Exit Function

    mrsTmp.MoveFirst
    
    If cbxMemoText.Text = "" Then Exit Function

    For i = 0 To mrsTmp.RecordCount - 1
        If InStr(Trim(Nvl(mrsTmp!简码)), UCase(cbxMemoText.Text)) > 0 Or InStr(Trim(Nvl(mrsTmp!名称)), UCase(cbxMemoText.Text)) > 0 Then
            getListIndex = i
            
            Exit For
        End If

        mrsTmp.MoveNext
    Next
End Function

Private Sub cbxMemoText_KeyUp(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyUp Or KeyCode = vbKeyDown Then
        If lstMemoText.ListCount > 0 Then lstMemoText.ListIndex = getListIndex
    End If
End Sub

Private Sub cmdNum_Click(Index As Integer)
    mintNumberIndex = Index
    subSetMouseState msNumber
    
    Call setCmdLabelColor
    
    cmdNum(Index).BackColor = &HC0C000
End Sub

Private Sub cmdTextLabel_Click(Index As Integer)
    
    If Index = 11 Then '自定义，先判断是否有输入文字
        If Trim(txtUserLabelText.Text) = "" Then
            MsgBoxD Me, "请输入自定义标注。", vbOKOnly, gstrSysName
            txtUserLabelText.SetFocus
            Exit Sub
        End If
    End If
    mintTextIndex = Index
    subSetMouseState msFixText
    
    Call setCmdLabelColor
    
    cmdTextLabel(Index).BackColor = &HC0C000
End Sub

Private Sub setCmdLabelColor()
    Dim i As Integer
    
    For i = 0 To cmdTextLabel.Count - 1
        cmdTextLabel(i).BackColor = &H8000000F
    Next i
    
    For i = 0 To cmdNum.Count - 1
        cmdNum(i).BackColor = &H8000000F
    Next i
End Sub

Private Sub DViewer_DblClick()
    Dim ls As DicomLabels
    Dim l As DicomLabel
    
    On Error GoTo err
    
    If mintMouseState = msMove Then
        Set ls = DViewer.LabelHits(mlngBaseXX, mlngBaseYY, False, False, True)
        If ls.Count > 0 Then
            If MsgBoxD(Me, "是否删除这个标注？", vbOKCancel, gstrSysName) = vbOK Then
                Set l = ls(1)
                If l.tag <> "" Then
                    '是编号标注，需要同时删除三个标注，先删掉两个
                    If DViewer.Images(1).Labels.IndexOf(l.TagObject.TagObject) <> 0 Then
                        Call DViewer.Images(1).Labels.Remove(DViewer.Images(1).Labels.IndexOf(l.TagObject.TagObject))
                    End If
                    If DViewer.Images(1).Labels.IndexOf(l.TagObject) <> 0 Then
                        Call DViewer.Images(1).Labels.Remove(DViewer.Images(1).Labels.IndexOf(l.TagObject))
                    End If
                End If
                '是普通标注，或者编号的最后一个标注，直接删除即可
                Call DViewer.Images(1).Labels.Remove(DViewer.Images(1).Labels.IndexOf(l))
                DViewer.Refresh
            End If
        End If
    End If
    Exit Sub
err:
    If ErrCenter() = 1 Then Resume
End Sub

Private Sub lstMemoText_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Call zlControl.CboSetText(cbxMemoText, lstMemoText.list(lstMemoText.ListIndex))
End Sub

Private Sub picCboDropDown_Click()
    lstMemoText.Visible = Not lstMemoText.Visible
    If lstMemoText.ListCount > 0 Then lstMemoText.ListIndex = getListIndex

    If lstMemoText.Visible Then lstMemoText.SetFocus
End Sub

Private Sub cbxMemoText_Change()
    If Not lstMemoText.Visible Then lstMemoText.Visible = True
    If lstMemoText.ListCount > 0 Then lstMemoText.ListIndex = getListIndex
End Sub

Private Sub cbxMemoText_KeyPress(KeyAscii As Integer)
    If KeyAscii = vbKeyReturn Then
        cbxMemoText.ListIndex = lstMemoText.ListIndex
        lstMemoText.Visible = False
        
        cbxMemoText.SelStart = 0
        cbxMemoText.SelLength = Len(cbxMemoText.Text)
        cbxMemoText.SetFocus
    End If
    
    If KeyAscii = vbKeyEscape Then lstMemoText.Visible = False
End Sub

Private Sub cmdCur_Click()
'上一幅图像
On Error GoTo errH
 
    Call ChangeImage(1)
 
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmdFont_Click()
On Error GoTo ErrHandle
    diaFont.flags = 1
    diaFont.FontBold = Me.Font.Bold
    diaFont.FontItalic = Me.Font.Italic
    diaFont.FontName = Me.Font.Name
    diaFont.FontSize = Me.Font.Size
    diaFont.FontStrikethru = Me.Font.Strikethrough
    diaFont.FontUnderline = Me.Font.Underline

    
    diaFont.ShowFont
    
    Me.Font.Bold = diaFont.FontBold
    Me.Font.Italic = diaFont.FontItalic
    Me.Font.Name = diaFont.FontName
    Me.Font.Size = diaFont.FontSize
    Me.Font.Strikethrough = diaFont.FontStrikethru
    Me.Font.Underline = diaFont.FontUnderline
Exit Sub
ErrHandle:
    If ErrCenter() = 1 Then Resume
End Sub

Private Sub cmdNext_Click()
'下一幅图像
On Error GoTo errH
 
    Call ChangeImage(2)
 
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmdAdd_Click()
'------------------------------------------------
'功能：添加操作但不关闭窗口
'参数：
'返回：无
'------------------------------------------------
    On Error GoTo err
    
    Dim dcmGlobal As New DicomGlobal
    
    dcmGlobal.RegString("UIDRoot") = "1"
    mblnOK = True
    '拼接方法
    Call subAddMemoText
    
    If mblnOK Then
        If Me.DViewer.Images.Count = 1 Then
            Set mImage = Me.DViewer.Images(1)
            mImage.InstanceUID = dcmGlobal.NewUID   '图像处理创建图像后，就设置新的InstanceUID
        Else
            Set mImage = Nothing
        End If
    Else
        Set mImage = Nothing
    End If
    
    If mblnIsMark = True Then   '标记图处理，添加标记图后直接退出
        Call mfrmParent.DcmAddMarkImage(mImage)
        Unload Me
        Exit Sub
    Else    '采集的图像处理
        '对拼接后的图像的边框进行处理
         If Me.DViewer.Images.Count > 0 Then
             With Me.DViewer.Images(1)
                .BorderWidth = 3
                .BorderStyle = 2
                .BorderColour = vbRed
            End With
        End If
        
        Call mfrmParent.DcmAddImage(mImage, mSelViewerIndex)
    End If
    
    Me.DViewer.Refresh
    
    '清空ComboBox文本
    cbxMemoText.Text = ""
    
    '关闭下拉框
    lstMemoText.Visible = False
    Exit Sub
err:
    If ErrCenter() = 1 Then Resume Next
End Sub

Private Sub cmdExit_Click()
'清空Viewer控件，并卸载窗口
   ' Me.DViewer.Images.Clear
    Unload Me
End Sub

Private Sub cbrMain_Execute(ByVal control As XtremeCommandBars.ICommandBarControl)
  On Error GoTo ErrHandle
    Select Case control.ID
        Case conMenu_Process_Window         '亮度对比度
            subSetMouseState 1
            'Control.Checked = True
            
        Case conMenu_Process_Zoom           '缩放
            subSetMouseState 2
            'Control.Checked = True
            
        Case conMenu_Process_RectZoom       '裁剪缩放
            subSetMouseState msRectangle
            'Control.Checked = True
        
        Case conMenu_Process_RectCapture         '裁剪后采集
            Call CaptureFrameSelectImage
            
        Case conMenu_Process_RRotate        '顺时针旋转
            subSetRotate True
            
        Case conMenu_Process_LRotate        '逆时针旋转
            subSetRotate False
            
        Case conMenu_Process_Sharpness      '锐化
            subSetSharp True
            
        Case conMenu_Process_Filter         '平滑
            subSetSharp False
            
        Case conMenu_Process_Corp          '拖动
           subSetMouseState msDrag
            
        Case conMenu_Process_Arrow          '箭头标注
            subSetMouseState msArrow
            
        Case conMenu_Process_Ellipse        '圆形标注
            subSetMouseState msEllipse
            
        Case conMenu_Process_Text           '文字标注
            subSetMouseState msText
        
        Case conMenu_Process_DelAllLabels   '清除标注
            DViewer.Images(1).Labels.Clear
            DViewer.Refresh
            
        Case conMenu_Process_MoveLabel      '移动标注
            subSetMouseState msMove
            
        Case conMenu_Process_LabelSetUp     '标注设置
            Call subSetTextLabel
            
        Case conMenu_Process_Restore        '恢复
            DViewer.Images.Clear
            DViewer.Images.Add mOldImage
            '重建标注之间的关联
            Call subLabelCopyRebuild(mOldImage, Me.DViewer.Images(1))
            mintAutoNumber = 0  '恢复打开图像时的最大序号
    End Select
    
    If control.ID <> conMenu_Process_LabelSetUp Then
        Call setCmdLabelColor
    End If
    
    Exit Sub
ErrHandle:
    If ErrCenter() = 1 Then Resume Next
    Call SaveErrLog
End Sub

Private Sub subSetSharp(blnSharp As Boolean)
'------------------------------------------------
'功能：dcmView中图像的平滑和锐化
'参数：blnSharp表示图像处理的方向，True=锐化；False=平滑
'返回：无，直接处理dcmView中的图像
'------------------------------------------------
    If DViewer.Images.Count > 0 Then
        If blnSharp = True Then
            '锐化处理
            If DViewer.Images(1).FilterLength <= 0 Then
                DViewer.Images(1).FilterLength = 0
                '先前没有平滑处理，直接进行锐化处理
                DViewer.Images(1).UnsharpEnhancement = DViewer.Images(1).UnsharpEnhancement + 0.1
            Else
                '如果先前已经有平滑处理，则先淡化平滑效果
                DViewer.Images(1).FilterLength = DViewer.Images(1).FilterLength - 1
            End If
        Else
            '平滑处理
            '判断Zoom是否＝1，如果是，则修改为0.9999
            If DViewer.Images(1).ActualZoom = 1 Then
                DViewer.Images(1).Zoom = 0.9999
            End If
            
            If DViewer.Images(1).UnsharpEnhancement <= 0 Then
                DViewer.Images(1).UnsharpEnhancement = 0
                '先前没有锐化处理，直接开始平滑
                '判断FilterLength是否＝0如果是，则在2/ActualZoom和2×FilterLength之间进行调整
                If DViewer.Images(1).FilterLength = 0 Then
                    DViewer.Images(1).FilterLength = 2 / DViewer.Images(1).ActualZoom + 1
                Else    '正常情况下FilterLength＋1
                    DViewer.Images(1).FilterLength = DViewer.Images(1).FilterLength + 1
                End If
            Else
                '先前已经有了锐化处理，先淡化锐化的效果
                DViewer.Images(1).UnsharpEnhancement = DViewer.Images(1).UnsharpEnhancement - 0.1
            End If
        End If
    End If
End Sub

Private Sub subSetRotate(blnClockwise As Boolean)
'------------------------------------------------
'功能：dcmView中图像的旋转
'参数：blnClockwise旋转的方向,True=顺时针旋转；False=逆时针旋转
'返回：无，直接处理dcmView中的图像
'------------------------------------------------
    If DViewer.Images.Count > 0 Then
        Dim iRotateState As Integer
        
        iRotateState = DViewer.Images(1).RotateState
        If blnClockwise = True Then
            iRotateState = iRotateState - 1
        Else
            iRotateState = iRotateState + 1
        End If
        If iRotateState = -1 Then iRotateState = 3
        iRotateState = iRotateState Mod 4
        DViewer.Images(1).RotateState = iRotateState
    End If
End Sub


'DicomViewer裁剪后采集图象
Private Sub CaptureFrameSelectImage()
    Dim imgResult As DicomImage
    Dim imgs As New DicomImages
    Dim iPlane As Integer
    Dim dblZoom As Double
    Dim iLeft As Integer
    Dim iRight As Integer
    Dim iTop As Integer
    Dim iBottom As Integer
    Dim iMax As Integer
    Dim img As DicomImage
    Dim lblFrame As DicomLabel
    
    If Me.DViewer.Images.Count <> 1 Then Exit Sub
    If Me.DViewer.Images(1).Labels.Count < 1 Then Exit Sub
    
    Set img = Me.DViewer.Images(1)
    Set lblFrame = Me.DViewer.Images(1).Labels(Me.DViewer.Images(1).Labels.Count)
    
    If Abs(lblFrame.Width) = 0 Or Abs(lblFrame.Height) = 0 Then
        MsgBoxD Me, "请选择图像区域后再保存", vbExclamation, gstrSysName
        Exit Sub
    End If
    
    '图象最大宽高=300
    iMax = 300
    
    '根据label来提取被框选中的图像
    '图象位数,黑白图像为1，彩色图像为3
    iPlane = 1
    If Not IsNull(img.Attributes(&H28, &H4).value) And img.Attributes(&H28, &H4).Exists Then
        If img.Attributes(&H28, &H4).value = "RGB" Or img.Attributes(&H28, &H4).value = "YBR_FULL_422" Then
            iPlane = 3
        End If
    End If
    
    '图象框的位置
    If lblFrame.Width >= 0 Then
        iLeft = lblFrame.Left
        iRight = iLeft + lblFrame.Width
    Else
        iLeft = lblFrame.Left + lblFrame.Width
        iRight = lblFrame.Left
    End If
    
    If lblFrame.Height >= 0 Then
        iTop = lblFrame.Top
        iBottom = iTop + lblFrame.Height
    Else
        iTop = lblFrame.Top + lblFrame.Height
        iBottom = lblFrame.Top
    End If
    
    '控制结果图象的大小在300*300之内
    If (iRight - iLeft) > iMax Or (iBottom - iTop) > iMax Then
        dblZoom = iMax / (iRight - iLeft)
        If dblZoom > iMax / (iBottom - iTop) Then dblZoom = iMax / (iBottom - iTop)
    Else
        dblZoom = 1
    End If
    
    img.Labels(img.Labels.Count).Visible = False
    If (img.RotateState = doRotateLeft And img.FlipState = doFlipNormal) _
        Or (img.RotateState = doRotateRight And img.FlipState = doFlipBoth) _
        Or (img.RotateState = doRotate180 And img.FlipState = doFlipVertical) _
        Or (img.RotateState = doRotateNormal And img.FlipState = doFlipHorizontal) Then
        'X方向对调
        Set imgResult = img.PrinterImage(8, iPlane, True, dblZoom, img.SizeX - iRight, img.SizeX - iLeft, iTop, iBottom)
    ElseIf (img.RotateState = doRotateLeft And img.FlipState = doFlipBoth) _
        Or (img.RotateState = doRotateRight And img.FlipState = doFlipNormal) _
        Or (img.RotateState = doRotate180 And img.FlipState = doFlipHorizontal) _
        Or (img.RotateState = doRotateNormal And img.FlipState = doFlipVertical) Then
        'Y方向对调
        Set imgResult = img.PrinterImage(8, iPlane, True, dblZoom, iLeft, iRight, img.SizeY - iBottom, img.SizeY - iTop)
    ElseIf (img.RotateState = doRotateRight And img.FlipState = doFlipHorizontal) _
        Or (img.RotateState = doRotateLeft And img.FlipState = doFlipVertical) _
        Or (img.RotateState = doRotate180 And img.FlipState = doFlipNormal) _
        Or (img.RotateState = doRotateNormal And img.FlipState = doFlipBoth) Then
        'X，Y方向对调
        Set imgResult = img.PrinterImage(8, iPlane, True, dblZoom, img.SizeX - iRight, img.SizeX - iLeft, img.SizeY - iBottom, img.SizeY - iTop)
    Else
        Set imgResult = img.PrinterImage(8, iPlane, True, dblZoom, iLeft, iRight, iTop, iBottom)
    End If
    
    DViewer.Images.Clear
    DViewer.Images.Add imgResult
    
End Sub

Private Sub subSetMouseState(intMoustState As TMouseState)
'------------------------------------------------
'功能：设置鼠标状态，同时更新工具栏按钮的选择状态
'参数：intMoustState -- 鼠标状态
'返回：无
'------------------------------------------------
    cbrMain.FindControl(xtpControlButton, conMenu_Process_Window).Checked = False
    cbrMain.FindControl(xtpControlButton, conMenu_Process_Zoom).Checked = False
    cbrMain.FindControl(xtpControlButton, conMenu_Process_RectZoom).Checked = False
    cbrMain.FindControl(xtpControlButton, conMenu_Process_Arrow).Checked = False
    cbrMain.FindControl(xtpControlButton, conMenu_Process_Ellipse).Checked = False
    cbrMain.FindControl(xtpControlButton, conMenu_Process_Text).Checked = False
    cbrMain.FindControl(xtpControlButton, conMenu_Process_Corp).Checked = False
    cbrMain.FindControl(xtpControlButton, conMenu_Process_MoveLabel).Checked = False
        
    '改变当前鼠标状态
    If mintMouseState = intMoustState And ((intMoustState <> msFixText) And _
        (intMoustState <> msNumber) And (intMoustState <> msMove)) Then
        mintMouseState = msNone
    Else
        mintMouseState = intMoustState
        
        Select Case mintMouseState
            Case msWinLevel: cbrMain.FindControl(xtpControlButton, conMenu_Process_Window).Checked = True
            Case msZoom: cbrMain.FindControl(xtpControlButton, conMenu_Process_Zoom).Checked = True
            Case msRectangle: cbrMain.FindControl(xtpControlButton, conMenu_Process_RectZoom).Checked = True
            Case msArrow: cbrMain.FindControl(xtpControlButton, conMenu_Process_Arrow).Checked = True
            Case msEllipse: cbrMain.FindControl(xtpControlButton, conMenu_Process_Ellipse).Checked = True
            Case msText: cbrMain.FindControl(xtpControlButton, conMenu_Process_Text).Checked = True
            Case msDrag: cbrMain.FindControl(xtpControlButton, conMenu_Process_Corp).Checked = True
            Case msMove: cbrMain.FindControl(xtpControlButton, conMenu_Process_MoveLabel).Checked = True
        End Select
    End If
    
End Sub

Private Sub cbrMain_Resize()
    '设置显示的客户区域
    Dim lngLeft As Long, lngTop As Long, lngRight As Long, lngBottom As Long
    
    On Error Resume Next
    
    cbrMain.GetClientRect lngLeft, lngTop, lngRight, lngBottom
    
    '摆放DViewer
    Me.DViewer.Left = lngLeft
    Me.DViewer.Top = lngTop
    Me.DViewer.Width = Abs(lngRight - lngLeft - Me.frmLabels.Width)
    If mblnIsMark = True Then
        Me.DViewer.Height = Abs(lngBottom - lngTop - 800)
    Else
        Me.DViewer.Height = Abs(lngBottom - lngTop - 1300)
    End If
    
    '摆放标注按钮
    Me.frmLabels.Left = Me.DViewer.Width
    Me.frmLabels.Height = Me.DViewer.Height
    Me.frmLabels.Top = Me.DViewer.Top
    
    '摆放备注文字
    Me.lblMemoText.Left = 100
    Me.lblMemoText.Top = Me.ScaleHeight - 1100

    Me.cbxMemoText.Left = Me.lblMemoText.Left + Me.lblMemoText.Width
    Me.cbxMemoText.Top = Me.lblMemoText.Top - 100
    Me.cbxMemoText.Width = Abs(Me.ScaleWidth - Me.cbxMemoText.Left - 250 - cmdInsert.Width - cmdFont.Width)

    Me.lstMemoText.Left = Me.cbxMemoText.Left
    Me.lstMemoText.Top = Me.cbxMemoText.Top - Me.lstMemoText.Height
    Me.lstMemoText.Width = Me.cbxMemoText.Width - 10
    
    Me.picCboDropDown.Left = Me.cbxMemoText.Left + Me.cbxMemoText.Width - 260
    Me.picCboDropDown.Top = Me.cbxMemoText.Top + 30
    
    Me.cmdInsert.Left = Me.cbxMemoText.Left + Me.cbxMemoText.Width
    Me.cmdInsert.Top = Me.cbxMemoText.Top

    Me.cmdFont.Left = Me.cmdInsert.Left + Me.cmdInsert.Width
    Me.cmdFont.Top = Me.cmdInsert.Top

    '摆放“添加”，“退出”按钮
    Me.cmdAdd.Left = Me.ScaleWidth - Me.cmdAdd.Width * 3
    Me.cmdAdd.Top = Me.ScaleHeight - 600

    Me.cmdExit.Left = Me.ScaleWidth - Me.cmdExit.Width * 1.8
    Me.cmdExit.Top = Me.cmdAdd.Top

    '摆放“上一幅”，“下一幅”按钮
    Me.cmdCur.Left = Me.ScaleWidth / 15
    Me.cmdCur.Top = Me.ScaleHeight - 600

    Me.cmdNext.Left = Me.cmdCur.Width + Me.cmdCur.Left + 200
    Me.cmdNext.Top = Me.cmdAdd.Top
    
End Sub



Private Sub cmdInsert_Click()
    Dim strSQL As String, i As Integer
    
    If Trim(cbxMemoText.Text) = "" Then
        MsgBoxD Me, "请输入备注内容。", vbInformation, gstrSysName
        If cbxMemoText.Enabled Then cbxMemoText.SetFocus
        Exit Sub
    End If
    If cbxMemoText.ListIndex <> -1 Then
        MsgBoxD Me, "该备注内容已经在常用备注中。", vbInformation, gstrSysName
        If cbxMemoText.Enabled Then cbxMemoText.SetFocus
        Exit Sub
    Else
        For i = 0 To cbxMemoText.ListCount - 1
            If UCase(Trim(cbxMemoText.list(i))) = UCase(Trim(cbxMemoText.Text)) Then
                MsgBoxD Me, "该备注容已经在常用备注中。", vbInformation, gstrSysName
                If cbxMemoText.Enabled Then cbxMemoText.SetFocus
                Exit Sub
            End If
        Next
    End If
        
    On Error GoTo errH
    
    strSQL = zlCommFun.zlGetSymbol(cbxMemoText.Text)
    strSQL = "zl_影像图像备注_Insert('" & Replace(cbxMemoText.Text, "'", "''") & "','" & strSQL & "','" & UserInfo.姓名 & "')"
    Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
    
    AddComboItem cbxMemoText.hWnd, CB_ADDSTRING, 0, cbxMemoText.Text
    lstMemoText.AddItem cbxMemoText.Text
    MsgBoxD Me, "已设置为常用备注。", vbInformation, gstrSysName
    If cbxMemoText.Enabled Then cbxMemoText.SetFocus
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub subAddMemoText()
'------------------------------------------------
'功能：给图像添加备注文字
'参数：
'返回：无
'------------------------------------------------
    On Error GoTo err
    
    Dim img As DicomImage
    Dim iLeft As Integer
    Dim iWidth As Integer
    Dim iTop As Integer
    Dim iHeight As Integer
    Dim imgResult As New DicomImage
    Dim iPlane As Integer
    Dim lngWhiteX As Long
    Dim lngWhiteY As Long
    Dim lngFontHeight As Long
    
    If Me.DViewer.Images.Count <> 1 Then Exit Sub
    
    If Trim(cbxMemoText.Text) = "" Then Exit Sub
    
    lngFontHeight = ScaleY(TextHeight(cbxMemoText.Text), vbTwips, vbPixels) + 6
    
    '把备注文字添加到图像中
    Set img = Me.DViewer.Images(1)
    
    iLeft = 0
    iTop = 0
    iWidth = img.SizeX
    iHeight = img.SizeY + lngFontHeight

    '使用PrinterImage方法，可以将图像上的标签及标注同时进行绘制
    Set imgResult = img.PrinterImage(8, iPlane, True, 1, 0, iWidth, 0, iHeight - lngFontHeight)
'

    '添加标注
    Dim dlMemoText As New DicomLabel
    
    dlMemoText.LabelType = doLabelText
    dlMemoText.ImageTied = True
    dlMemoText.Transparent = False
    dlMemoText.AutoSize = False
    dlMemoText.Left = 0
    dlMemoText.Top = img.SizeY
    dlMemoText.Width = iWidth
    dlMemoText.Height = lngFontHeight
    
    dlMemoText.BackColour = vbWhite
    dlMemoText.ForeColour = vbBlack
            
    dlMemoText.Font.Name = Me.Font.Name
    dlMemoText.Font.Italic = Me.Font.Italic
    dlMemoText.Font.Strikethrough = Me.Font.Strikethrough
    dlMemoText.Font.Underline = Me.Font.Underline
    dlMemoText.Font.Size = Me.Font.Size
    dlMemoText.Font.Bold = Me.Font.Bold
    dlMemoText.FontName = Me.Font.Name
    dlMemoText.FontSize = Me.Font.Size
    dlMemoText.ShowTextBox = True
    
    dlMemoText.Text = Me.cbxMemoText.Text & "                                                                                                                                 "
    
    imgResult.Labels.Add dlMemoText
    
    Set imgResult = imgResult.PrinterImage(8, iPlane, True, 1, 0, iWidth, 0, iHeight)

    '更新图像
    Me.DViewer.Images.Clear
    Me.DViewer.Images.Add imgResult
    Exit Sub
err:
    If ErrCenter() = 1 Then Resume Next
End Sub

Private Sub DViewer_MouseDown(Button As Integer, Shift As Integer, X As Long, Y As Long)
    Dim ls As DicomLabels
    Dim lngLeftD As Long
    
    If Button = 1 And DViewer.Images.Count > 0 Then
        Dim intLabelType As Integer
        
        mMouseDownPoint.X = DViewer.Images(1).ActualScrollX
        mMouseDownPoint.Y = DViewer.Images(1).ActualScrollY
          
        mInitScrollPoint.X = DViewer.Images(1).ScrollX + X
        mInitScrollPoint.Y = DViewer.Images(1).ScrollY + Y
        
        mblnDcmViewDown = True
        If mintMouseState <> msNone Then
            '记录当前鼠标位置
            mlngBaseXX = X
            mlngBaseYY = Y
            Select Case mintMouseState
                Case msArrow, msEllipse, msText, msRectangle, msFixText, msNumber      '箭头，椭圆，文字，框选，固定文字，顺序编号
                    If mintMouseState = msArrow Then
                        intLabelType = doLabelArrow
                    ElseIf mintMouseState = msEllipse Or mintMouseState = msNumber Then
                        intLabelType = doLabelEllipse
                    ElseIf mintMouseState = msText Or mintMouseState = msFixText Then
                        intLabelType = doLabelText
                    ElseIf mintMouseState = msRectangle Then
                        intLabelType = doLabelRectangle
                    End If
                    
                    If mintMouseState = msFixText Then
                        '如果是单个文字，位移的量要减少
                        If mintTextIndex = 11 Then
                            lngLeftD = IIf(Len(txtUserLabelText.Text) = 1, 3, 7)
                        Else
                            lngLeftD = IIf(Len(Left(cmdTextLabel(mintTextIndex).Caption, InStr(cmdTextLabel(mintTextIndex).Caption, "=") - 1)) = 1, 3, 7)
                        End If
                    Else
                        lngLeftD = 7
                    End If
                    DViewer.Images(1).Labels.Add GetNewLabel(intLabelType, DViewer.ImageXPosition(X, Y) - lngLeftD, DViewer.ImageYPosition(X, Y) - 7, 0, 0)
                    Set mdcmSelectLabel = DViewer.Images(1).Labels(DViewer.Images(1).Labels.Count)
                    If intLabelType = doLabelArrow Then
                        '箭头需要使用线宽=2
                        mdcmSelectLabel.LineWidth = 4
                    ElseIf intLabelType = doLabelText Then
                        mdcmSelectLabel.XOR = False
                        mdcmSelectLabel.ForeColour = vbBlack
                        If mblnIsMark = False Then
                            '不是标记图，则给文字增加背景，标记图不能增加，因为电子病历不支持，打印的时候就不支持
                            mdcmSelectLabel.Transparent = False
                            mdcmSelectLabel.ForeColour = vbWhite
                            mdcmSelectLabel.BackColour = vbBlack
                        End If
                        '设置字体大小
                        If DViewer.Images(1).SizeX <= 256 Then
                            mdcmSelectLabel.FontSize = 10
                        ElseIf DViewer.Images(1).SizeX <= 512 Then
                            mdcmSelectLabel.FontSize = 15
                        Else
                            mdcmSelectLabel.FontSize = 18
                        End If
                        
                    End If
                Case msMove     '移动标注
                    Set ls = DViewer.LabelHits(X, Y, False, False, True)
                    mlngBaseX = DViewer.ImageXPosition(X, Y)
                    mlngBaseY = DViewer.ImageYPosition(X, Y)
                    If ls.Count > 0 Then    '如果选中了任何一个标注
                        '如果Tag=""说明是简单标注，非空说明是数字编号标注，需要找到文字标注
                        Set mMovingLabel = ls(1)
                        If mMovingLabel.tag <> "" Then
                            If mMovingLabel.tag = m_LabelTag_Back Then
                                Set mMovingLabel = mMovingLabel.TagObject
                            ElseIf mMovingLabel.tag = m_LabelTag_Circle Then
                                Set mMovingLabel = mMovingLabel.TagObject.TagObject
                            End If
                        End If
                    End If
            End Select
        End If
    End If
End Sub

Private Sub DViewer_MouseMove(Button As Integer, Shift As Integer, X As Long, Y As Long)
    If mblnDcmViewDown = True And Button = 1 And DViewer.Images.Count > 0 Then
        Select Case mintMouseState
            Case msWinLevel   '亮度对比度
                DViewer.Images(1).Width = DViewer.Images(1).Width + (X - mlngBaseXX)
                DViewer.Images(1).Level = DViewer.Images(1).Level + (Y - mlngBaseYY)
                mlngBaseXX = X
                mlngBaseYY = Y
            Case msZoom   '缩放
                Dim dblZoom As Double
                dblZoom = DViewer.Images(1).ActualZoom
                dblZoom = dblZoom * (1 + (Y - mlngBaseYY) * 0.001)
                If dblZoom < 64 And dblZoom > 0.01 Then
                    subCenterZoom DViewer.Images(1), DViewer, dblZoom, mCorpSize
                End If
                mlngBaseYY = Y
'            Case msRectangle  '裁剪缩放
'                Dim dcmLabel As DicomLabel
'                dcmView.Labels.Clear
'                Set dcmLabel = dcmView.Labels.AddNew
'                dcmLabel.LabelType = doLabelRectangle
'                dcmLabel.Left = mlngBaseXX
'                dcmLabel.Top = mlngBaseYY
'                dcmLabel.Width = x - mlngBaseXX
'                dcmLabel.Height = y - mlngBaseYY
            Case msArrow, msEllipse, msRectangle    '箭头标注'圆形标注,框选
                mdcmSelectLabel.Width = DViewer.ImageXPosition(X, Y) - mdcmSelectLabel.Left
                mdcmSelectLabel.Height = DViewer.ImageYPosition(X, Y) - mdcmSelectLabel.Top
            Case msDrag
                '拖动图像......
                DViewer.Images(1).ScrollX = mInitScrollPoint.X - X
                DViewer.Images(1).ScrollY = mInitScrollPoint.Y - Y
            Case msMove
                '移动标注
                If Not mMovingLabel Is Nothing Then
                    subaCorrectCursor DViewer, DViewer.Images(1), X, Y  '鼠标移动如果超出图像范围，则修正鼠标位置
                    subMoveLable mMovingLabel, DViewer.ImageXPosition(X, Y) - mlngBaseX, DViewer.ImageYPosition(X, Y) - mlngBaseY
                    mlngBaseX = DViewer.ImageXPosition(X, Y)
                    mlngBaseY = DViewer.ImageYPosition(X, Y)
                End If
        End Select
        
        DViewer.Refresh
    End If
End Sub

Private Sub DViewer_MouseUp(Button As Integer, Shift As Integer, X As Long, Y As Long)
    If mblnDcmViewDown = True And Button = 1 And DViewer.Images.Count > 0 Then
        mblnDcmViewDown = False
        If mintMouseState = msText Then      '文字标注
            
            txtInputText.Left = Me.ScaleX(X, vbPixels, vbTwips) + DViewer.Left
            txtInputText.Top = Me.ScaleY(Y, vbPixels, vbTwips) + DViewer.Top
            
            txtInputText.Text = ""
            txtInputText.Visible = True
            txtInputText.SetFocus
        ElseIf mintMouseState = msRectangle Then   '裁剪缩放
            
            '显示图像保存菜单
            Call ShowFrameSelectImagePopup
            '删除框选用的临时标注
            If DViewer.Images(1).Labels.Count > 0 Then
                DViewer.Images(1).Labels.Remove DViewer.Images(1).Labels.Count
            End If
            
            Set mdcmSelectLabel = Nothing
            
'            dcmView.Labels.Clear
'            RectangleZoom dcmView, dcmView.Images(1), mlngBaseXX, mlngBaseYY, x - mlngBaseXX, y - mlngBaseYY
        ElseIf mintMouseState = msDrag Then
            '计算图像漫游的偏移位置
            mCorpSize.X = mCorpSize.X + (DViewer.Images(1).ActualScrollX - mMouseDownPoint.X)
            mCorpSize.Y = mCorpSize.Y + (DViewer.Images(1).ActualScrollY - mMouseDownPoint.Y)
        ElseIf mintMouseState = msFixText Then
            '添加固定文字
            If mintTextIndex = 11 Then  '自定义文字标注
                mdcmSelectLabel.Text = txtUserLabelText.Text
            Else
                mdcmSelectLabel.Text = Left(cmdTextLabel(mintTextIndex).Caption, InStr(cmdTextLabel(mintTextIndex).Caption, "=") - 1)
            End If
        ElseIf mintMouseState = msNumber Then
            Dim intText As Integer
            
            If mintNumberIndex = 0 Then '自动顺序编号
                mintAutoNumber = mintAutoNumber + 1
                intText = mintAutoNumber
            Else
                intText = mintNumberIndex
            End If
            '添加顺序编号
            mdcmSelectLabel.XOR = False
            mdcmSelectLabel.BackColour = glngColor(intText Mod 9 + 1)
            mdcmSelectLabel.Transparent = False
            mdcmSelectLabel.Width = 14
            mdcmSelectLabel.Height = 14
            mdcmSelectLabel.tag = m_LabelTag_Back
            
            '添加顺序编号圆形的两个附加标注，圆形框和数字
            DViewer.Images(1).Labels.Add GetNewLabel(doLabelEllipse, mdcmSelectLabel.Left, mdcmSelectLabel.Top, 14, 14)
            Set mdcmSelectLabel = DViewer.Images(1).Labels(DViewer.Images(1).Labels.Count)
            mdcmSelectLabel.XOR = False
            mdcmSelectLabel.ForeColour = vbBlack
            mdcmSelectLabel.Transparent = True
            mdcmSelectLabel.tag = m_LabelTag_Circle
            mdcmSelectLabel.TagObject = DViewer.Images(1).Labels(DViewer.Images(1).Labels.Count - 1)
            
            DViewer.Images(1).Labels.Add GetNewLabel(doLabelText, mdcmSelectLabel.Left + 1, mdcmSelectLabel.Top, 0, 0)
            Set mdcmSelectLabel = DViewer.Images(1).Labels(DViewer.Images(1).Labels.Count)
            mdcmSelectLabel.ForeColour = vbBlack
            mdcmSelectLabel.Transparent = True
            mdcmSelectLabel.XOR = False
            mdcmSelectLabel.tag = m_LabelTag_Number
            mdcmSelectLabel.FontSize = 8
            mdcmSelectLabel.FontName = "Arial Bold"
            mdcmSelectLabel.AutoSize = True
            mdcmSelectLabel.Text = intText
            If mdcmSelectLabel.Text < 10 Then
                mdcmSelectLabel.Left = mdcmSelectLabel.Left + 3
            End If
            mdcmSelectLabel.TagObject = DViewer.Images(1).Labels(DViewer.Images(1).Labels.Count - 1)
            DViewer.Images(1).Labels(DViewer.Images(1).Labels.Count - 2).TagObject = mdcmSelectLabel    'TagObject形成闭环
        End If
        
        DViewer.Refresh
    End If
End Sub

Public Sub ShowFrameSelectImagePopup()
'------------------------------------------------
'功能：创建框选图象的时候 ，鼠标右键的弹出菜单
'参数：
'返回：无
'------------------------------------------------

Dim cbrControl As CommandBarControl
Dim cbrToolBar As CommandBar
Dim cbrToolPopup As CommandBarPopup
    
    
    '鼠标右键弹出菜单
    Set cbrToolBar = Me.cbrMain.Add("鼠标右键", xtpBarPopup)
    cbrToolBar.EnableDocking xtpFlagStretched
    cbrToolBar.ShowTextBelowIcons = False
    cbrToolBar.Closeable = False
    With cbrToolBar.Controls
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_RectCapture, "确认裁剪")
    End With
    cbrToolBar.Visible = True
    cbrToolBar.ShowPopup
End Sub


Private Sub subCenterZoom(img As DicomImage, Viewer As DicomViewer, dblZoom As Double, corpSize As TPoint)
'------------------------------------------------
'功能：对图像进行缩放。以当前viewer中心点为缩放中心点。
'参数：
'       img -- 进行缩放的图像
'       viewer －－ 图像所在的viewer
'       dblZoom －－图像新的缩放倍数
'返回：无，直接调整图像的缩放倍数
'上级函数或过程：frmViewer.Viewer_MouseMove
'下级函数或过程：无
'引用的外部参数：无
'编制人： 黄捷 2006-2-10
'------------------------------------------------
    img.Zoom = dblZoom
    img.StretchToFit = False

            
    img.ScrollX = (img.SizeX * img.ActualZoom - ScaleX(Viewer.Width, vbTwips, vbPixels) / Viewer.MultiColumns) / 2 + corpSize.X
    img.ScrollY = (img.SizeY * img.ActualZoom - ScaleY(Viewer.Height, vbTwips, vbPixels) / Viewer.MultiRows) / 2 + corpSize.Y
End Sub


Private Sub Form_Load()
    On Error GoTo err

    '恢复窗体位置
    Call RestoreWinState(Me, App.ProductName)
    
    '创建工具栏
    Call InitCommandBars
    
    Call LoadMemoFontStyle
    
    mCorpSize.X = 0
    mCorpSize.Y = 0
    mblnOK = False
    mintAutoNumber = 0
    
    '图像处理，鼠标左键默认是调窗；图像标注，鼠标左键默认是移动标注
    If mblnIsMark = True Then
        Call subSetMouseState(msMove)
    Else
        Call subSetMouseState(msWinLevel)
    End If
    
    Call ReadEnjoin
    
    Call subLoadTextLabel
    
    Exit Sub
err:
    If ErrCenter() = 1 Then Resume
End Sub

'载入备注字体样式
Private Sub LoadMemoFontStyle()
    Dim strFontStyle As String
    Dim aryFontStyle() As String
    
    '“宋体,12,B,U,S,I”
    
    strFontStyle = zlDatabase.GetPara("图像备注字体", glngSys, mlngModule, "")
    
    strFontStyle = strFontStyle & ",,,,,,"
    
    aryFontStyle = Split(strFontStyle, ",")
    
    If aryFontStyle(0) <> "" Then Me.Font.Name = aryFontStyle(0)
    If Val(aryFontStyle(1)) <> 0 Then Me.Font.Size = Val(aryFontStyle(1))
    If UCase(aryFontStyle(2)) = "B" Then Me.Font.Bold = True
    If UCase(aryFontStyle(3)) = "U" Then Me.Font.Underline = True
    If UCase(aryFontStyle(4)) = "S" Then Me.Font.Strikethrough = True
    If UCase(aryFontStyle(5)) = "I" Then Me.Font.Italic = True
End Sub


Private Sub SaveMemoFontStyle()
    Dim strFontStyle As String
    
    strFontStyle = Me.Font.Name & "," & _
        Me.Font.Size & "," & _
        IIf(Me.Font.Bold, "B", "") & "," & _
        IIf(Me.Font.Underline, "U", "") & "," & _
        IIf(Me.Font.Strikethrough, "S", "") & "," & _
        IIf(Me.Font.Italic, "I", "")

    Call zlDatabase.SetPara("图像备注字体", strFontStyle, glngSys, mlngModule)
End Sub


Private Function ReadEnjoin() As Boolean
'功能：读取并加入常用备注
    Dim strSQL As String, strPre As String
        
    On Error GoTo errH
    
    '常用嘱托
    strPre = cbxMemoText.Text '加入后保持原有值
    cbxMemoText.Clear
    
    strSQL = _
        " Select 名称,简码 From 影像图像备注 Where 名称 is Not Null And 人员=[1]" & _
        " Union" & _
        " Select 名称,简码 From 影像图像备注 Where 名称 is Not Null And 人员 is Null" & _
        " Order by 名称"
    Set mrsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, UserInfo.姓名)
    Do While Not mrsTmp.EOF
        AddComboItem cbxMemoText.hWnd, CB_ADDSTRING, 0, mrsTmp!名称
        
        lstMemoText.AddItem mrsTmp!名称
        mrsTmp.MoveNext
    Loop
    cbxMemoText.Text = strPre
    
    ReadEnjoin = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function


Private Sub Form_Unload(Cancel As Integer)
    '保存窗体位置
    Call SaveWinState(Me, App.ProductName)
    
    Call SaveMemoFontStyle
End Sub


Private Sub InitCommandBars()
    '功能创建工具条
    Dim cbrControl As CommandBarControl
    Dim cbrToolBar As CommandBar
    '-----------------------------------------------------
    CommandBarsGlobalSettings.App = App
    CommandBarsGlobalSettings.ResourceFile = CommandBarsGlobalSettings.OcxPath & "\XTPResourceZhCn.dll"
    CommandBarsGlobalSettings.ColorManager.SystemTheme = xtpSystemThemeAuto
    Me.cbrMain.VisualTheme = xtpThemeOffice2003
    Set Me.cbrMain.Icons = zlCommFun.GetPubIcons
    
    With Me.cbrMain.Options
        .ShowExpandButtonAlways = False
        .ToolBarAccelTips = True
        .AlwaysShowFullMenus = False
        .IconsWithShadow = True '放在VisualTheme后有效
        .UseDisabledIcons = True
        .LargeIcons = True
        .SetIconSize True, 32, 32
    End With
    Me.cbrMain.EnableCustomization False
    Me.cbrMain.ActiveMenuBar.Visible = False
    
    '图像操作工具栏定义
    Set cbrToolBar = Me.cbrMain.Add("图像操作栏", xtpBarLeft)
    cbrToolBar.EnableDocking xtpFlagStretched
    cbrToolBar.ShowTextBelowIcons = True '文本显示在图标下方
    cbrToolBar.Closeable = False
    With cbrToolBar.Controls
        
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_Window, "亮度"): cbrControl.ToolTipText = "调节亮度/对比度": cbrControl.Visible = Not mblnIsMark
        cbrControl.Checked = True
        
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_Zoom, "缩放"): cbrControl.ToolTipText = "缩放图像": cbrControl.Visible = Not mblnIsMark
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_Corp, "拖动"): cbrControl.ToolTipText = "拖动图像": cbrControl.Visible = Not mblnIsMark
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_RectZoom, "裁剪"): cbrControl.ToolTipText = "裁剪采集图像": cbrControl.IconId = 3201: cbrControl.Visible = Not mblnIsMark
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_RRotate, "顺时"): cbrControl.ToolTipText = "顺时针旋转": cbrControl.Visible = Not mblnIsMark
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_LRotate, "逆时"): cbrControl.ToolTipText = "逆时针旋转": cbrControl.Visible = Not mblnIsMark
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_Sharpness, "锐化"): cbrControl.ToolTipText = "锐化": cbrControl.Visible = Not mblnIsMark
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_Filter, "平滑"): cbrControl.ToolTipText = "平滑": cbrControl.Visible = Not mblnIsMark
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_Arrow, "箭头"): cbrControl.ToolTipText = "箭头标注": cbrControl.Visible = Not mblnIsMark
        cbrControl.BeginGroup = True
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_Ellipse, "圆形"): cbrControl.ToolTipText = "圆形标注"
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_Text, "文字"): cbrControl.ToolTipText = "文字标注"
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_MoveLabel, "移动标注"): cbrControl.ToolTipText = "鼠标左键拖拽移动标注，双击删除标注"
        cbrControl.BeginGroup = True
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_LabelSetUp, "设置标注"): cbrControl.ToolTipText = "设置文字标注"
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_DelAllLabels, "清除标注"): cbrControl.ToolTipText = "清除全部标注"
        cbrControl.BeginGroup = True
        Set cbrControl = .Add(xtpControlButton, conMenu_Process_Restore, "恢复"): cbrControl.ToolTipText = "恢复图像到初始状态"
        cbrControl.BeginGroup = True
    End With
    For Each cbrControl In cbrToolBar.Controls
         cbrControl.Style = xtpButtonIconAndCaption
         cbrControl.Category = "Main" '设置成主界面菜单
    Next
    cbrToolBar.Position = xtpBarTop
End Sub

Private Sub lstMemoText_DblClick()
    cbxMemoText.Text = lstMemoText.list(lstMemoText.ListIndex)
    lstMemoText.Visible = False
    
    cbxMemoText.SelStart = 0
    cbxMemoText.SelLength = Len(cbxMemoText.Text)
    cbxMemoText.SetFocus
End Sub

Private Sub lstMemoText_KeyUp(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyDown Or KeyCode = vbKeyUp Then
        Call zlControl.CboSetText(cbxMemoText, lstMemoText.list(lstMemoText.ListIndex))
    End If
End Sub

Private Sub lstMemoText_KeyPress(KeyAscii As Integer)
    If KeyAscii = vbKeyReturn Then
        Call zlControl.CboSetText(cbxMemoText, lstMemoText.list(lstMemoText.ListIndex))
    End If
    
    If KeyAscii = vbKeyEscape Or KeyAscii = vbKeyReturn Then lstMemoText.Visible = False
End Sub

Private Sub picCboDropDown_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    picCboDropDown.BorderStyle = 1
End Sub

Private Sub picCboDropDown_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    picCboDropDown.BorderStyle = 0
End Sub

Private Sub txtInputText_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Or KeyAscii = 27 Then  '''ESC和回车键退出输入
        txtInputText.Visible = False
        If Trim(txtInputText.Text) = "" Then
            '删除文字标注
            DViewer.Images(1).Labels.Remove DViewer.Images(1).Labels.Count
            txtInputText = "1 "
        Else
            mdcmSelectLabel.Text = txtInputText.Text
            DViewer.Refresh
        End If
    End If
End Sub

Private Sub subaCorrectCursor(v As DicomViewer, im As DicomImage, xx As Long, Yy As Long)
'------------------------------------------------
'功能：鼠标移动如果超出图像范围则修正其鼠标位置
'参数：v--图像所在的viewer；im--鼠标所在的图像；xx--鼠标所在的x方向位置，如果鼠标超出图像则将此值修改到图像之内；
'      yy--鼠标所在的y方向位置，如果鼠标超出图像则将此值修改到图像之内；
'返回：无
'------------------------------------------------
    Dim X As Integer, Y As Integer, w As Long, h As Long
    Dim i As DicomImage
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    w = v.Width / v.MultiColumns / Screen.TwipsPerPixelX - v.CellSpacing * 2
    h = v.Height / v.MultiRows / Screen.TwipsPerPixelY - v.CellSpacing * 2
    X = im.OriginX + v.CellSpacing
    Y = im.OriginY + v.CellSpacing
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    If xx < X Then xx = X
    If xx > X + w Then xx = X + w
    If Yy < Y Then Yy = Y
    If Yy > Y + h Then Yy = Y + h
End Sub

Public Sub subMoveLable(la As DicomLabel, X As Long, Y As Long)
'------------------------------------------------
'功能：移动一个标注
'参数：la--被移动的标注；x--x方向移动的图像像素距离；y--y方向移动的图像像素距离
'返回：无
'------------------------------------------------
    
    la.Left = la.Left + X
    la.Top = la.Top + Y
    
    '如果是数字编号，需要同时移动三个标注
    If la.tag <> "" And Not la.TagObject Is Nothing Then
        la.TagObject.Left = la.TagObject.Left + X
        la.TagObject.Top = la.TagObject.Top + Y
        la.TagObject.TagObject.Left = la.TagObject.TagObject.Left + X
        la.TagObject.TagObject.Top = la.TagObject.TagObject.Top + Y
    End If
       
End Sub

Private Sub subSetTextLabel()
'------------------------------------------------
'功能：设置文字标注，并保存
'参数：
'返回：无
'------------------------------------------------
    Dim strTemp As String
    Dim i As Integer

    On Error GoTo err
    
    If mintMouseState <> msFixText Or mintTextIndex = 11 Then
        MsgBoxD Me, "请先选择一个文字标注按钮，然后才能设置。", vbOKOnly, gstrSysName
        Exit Sub
    End If
    
    strTemp = InputBox("请输入新的文字标注配置，格式为“简码=说明”。", "文字标注设置", cmdTextLabel(mintTextIndex).Caption)
    
    If strTemp = "" Then Exit Sub
    
    If InStr(strTemp, "=") = 0 Then
        MsgBoxD Me, "输入的格式不正确，应该按照“简码=说明”方式输入，请检查后重新设置。", vbOKOnly, gstrSysName
        Exit Sub
    End If
     
    '输入成功，使用这个新的文字标注，同时保存到注册表中
    cmdTextLabel(mintTextIndex).Caption = strTemp
    
    strTemp = ""
    For i = 0 To cmdTextLabel.Count - 2
        strTemp = strTemp & "[+]" & cmdTextLabel(i).Caption
    Next i
    strTemp = Mid(strTemp, 4)
    Call SaveSetting("ZLSOFT", "公共模块\" & App.ProductName & "\frmReportImageEdit", "简明文字标注", strTemp)
    
    Exit Sub
err:
    If ErrCenter() = 1 Then Resume
End Sub

Private Sub subLoadTextLabel()
'------------------------------------------------
'功能：读取文字标注
'参数：
'返回：无
'------------------------------------------------
    Dim strTemp As String
    Dim strText() As String
    Dim i  As Integer
    
    On Error GoTo err
    
    strTemp = GetSetting("ZLSOFT", "公共模块\" & App.ProductName & "\frmReportImageEdit", "简明文字标注", "")
    
    If strTemp = "" Then
        '使用默认值，不需要设置
        Exit Sub
    End If
    
    strText = Split(strTemp, "[+]")
    If UBound(strText) <> 10 Then
        '数据不符合格式，使用默认值
        Exit Sub
    End If
    
    For i = 0 To 10
        cmdTextLabel(i).Caption = strText(i)
    Next i
    
    Exit Sub
err:
    If ErrCenter() = 1 Then Resume
End Sub

Private Sub subLabelCopyRebuild(Simg As DicomImage, oImg As DicomImage)
'------------------------------------------------
'功能：重建图像的标注关联关系
'参数：sImg--源图像；oImg--目标图像
'返回：无
'------------------------------------------------
    Dim l As DicomLabel
    For Each l In oImg.Labels
        If Not l.TagObject Is Nothing Then
            If Simg.Labels.IndexOf(l.TagObject) <> 0 Then
                Set l.TagObject = oImg.Labels(Simg.Labels.IndexOf(l.TagObject))
            End If
        End If
    Next
End Sub
