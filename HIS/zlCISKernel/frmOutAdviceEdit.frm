VERSION 5.00
Object = "{BEEECC20-4D5F-4F8B-BFDC-5D9B6FBDE09D}#1.0#0"; "vsflex8.ocx"
Object = "{555E8FCC-830E-45CC-AF00-A012D5AE7451}#9.60#0"; "Codejock.CommandBars.9600.ocx"
Object = "{945E8FCC-830E-45CC-AF00-A012D5AE7451}#9.60#0"; "Codejock.DockingPane.9600.ocx"
Object = "{A8E5842E-102B-4289-9D57-3B3F5B5E15D3}#9.60#0"; "Codejock.SuiteCtrls.9600.ocx"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.1#0"; "MSCOMCTL.OCX"
Object = "{86CF1D34-0C5F-11D2-A9FC-0000F8754DA1}#2.0#0"; "MSCOMCT2.OCX"
Object = "{C932BA88-4374-101B-A56C-00AA003668DC}#1.1#0"; "Msmask32.ocx"
Object = "{3B7C8863-D78F-101B-B9B5-04021C009402}#1.2#0"; "RICHTX32.OCX"
Object = "{FBAFE9A8-8B26-4559-9D12-D70E36A97BE3}#2.1#0"; "zlRichEditor.ocx"
Begin VB.Form frmOutAdviceEdit 
   AutoRedraw      =   -1  'True
   Caption         =   "门诊医嘱编辑"
   ClientHeight    =   10230
   ClientLeft      =   225
   ClientTop       =   555
   ClientWidth     =   14880
   Icon            =   "frmOutAdviceEdit.frx":0000
   KeyPreview      =   -1  'True
   LinkTopic       =   "Form1"
   ScaleHeight     =   10230
   ScaleWidth      =   14880
   ShowInTaskbar   =   0   'False
   StartUpPosition =   3  '窗口缺省
   WindowState     =   2  'Maximized
   Begin VB.PictureBox picHwndTab 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   210
      Left            =   14355
      ScaleHeight     =   210
      ScaleWidth      =   240
      TabIndex        =   101
      TabStop         =   0   'False
      Top             =   780
      Visible         =   0   'False
      Width           =   240
   End
   Begin VB.PictureBox picSubMain 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   645
      Left            =   13605
      ScaleHeight     =   645
      ScaleWidth      =   315
      TabIndex        =   99
      TabStop         =   0   'False
      Top             =   705
      Width           =   315
      Begin XtremeSuiteControls.TabControl tbcSub 
         Height          =   675
         Left            =   0
         TabIndex        =   100
         TabStop         =   0   'False
         Top             =   0
         Width           =   255
         _Version        =   589884
         _ExtentX        =   450
         _ExtentY        =   1191
         _StockProps     =   64
      End
   End
   Begin VB.PictureBox picPanel 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   780
      Index           =   28
      Left            =   13380
      ScaleHeight     =   780
      ScaleWidth      =   1620
      TabIndex        =   92
      TabStop         =   0   'False
      Top             =   4590
      Width           =   1620
      Begin VSFlex8Ctl.VSFlexGrid vsDRU 
         Height          =   480
         Left            =   75
         TabIndex        =   93
         TabStop         =   0   'False
         Top             =   60
         Width           =   1140
         _cx             =   2011
         _cy             =   847
         Appearance      =   0
         BorderStyle     =   0
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   16777215
         ForeColorSel    =   -2147483640
         BackColorBkg    =   -2147483643
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483633
         GridColorFixed  =   -2147483632
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483642
         FocusRect       =   1
         HighLight       =   1
         AllowSelection  =   0   'False
         AllowBigSelection=   0   'False
         AllowUserResizing=   0
         SelectionMode   =   0
         GridLines       =   0
         GridLinesFixed  =   0
         GridLineWidth   =   1
         Rows            =   30
         Cols            =   1
         FixedRows       =   1
         FixedCols       =   0
         RowHeightMin    =   250
         RowHeightMax    =   0
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   -1  'True
         FormatString    =   $"frmOutAdviceEdit.frx":058A
         ScrollTrack     =   0   'False
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   -1  'True
         AutoSizeMode    =   0
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   0
         Editable        =   0
         ShowComboButton =   1
         WordWrap        =   0   'False
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         DataMode        =   0
         VirtualData     =   -1  'True
         DataMember      =   ""
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   24
      End
   End
   Begin VB.PictureBox picPanel 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   630
      Index           =   27
      Left            =   13380
      ScaleHeight     =   630
      ScaleWidth      =   1545
      TabIndex        =   90
      TabStop         =   0   'False
      Top             =   3660
      Width           =   1545
      Begin VSFlex8Ctl.VSFlexGrid vsPAC 
         Height          =   375
         Left            =   210
         TabIndex        =   91
         TabStop         =   0   'False
         Top             =   0
         Width           =   1005
         _cx             =   1773
         _cy             =   661
         Appearance      =   0
         BorderStyle     =   0
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   16777215
         ForeColorSel    =   -2147483640
         BackColorBkg    =   -2147483643
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483633
         GridColorFixed  =   -2147483632
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483642
         FocusRect       =   1
         HighLight       =   1
         AllowSelection  =   0   'False
         AllowBigSelection=   0   'False
         AllowUserResizing=   0
         SelectionMode   =   0
         GridLines       =   0
         GridLinesFixed  =   0
         GridLineWidth   =   1
         Rows            =   15
         Cols            =   1
         FixedRows       =   1
         FixedCols       =   0
         RowHeightMin    =   250
         RowHeightMax    =   0
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   -1  'True
         FormatString    =   $"frmOutAdviceEdit.frx":05BE
         ScrollTrack     =   0   'False
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   -1  'True
         AutoSizeMode    =   0
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   0
         Editable        =   0
         ShowComboButton =   1
         WordWrap        =   0   'False
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         DataMode        =   0
         VirtualData     =   -1  'True
         DataMember      =   ""
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   24
      End
   End
   Begin VB.PictureBox picPanel 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   750
      Index           =   26
      Left            =   13380
      ScaleHeight     =   750
      ScaleWidth      =   1560
      TabIndex        =   88
      TabStop         =   0   'False
      Top             =   2790
      Width           =   1560
      Begin VSFlex8Ctl.VSFlexGrid vsLIS 
         Height          =   420
         Left            =   105
         TabIndex        =   89
         TabStop         =   0   'False
         Top             =   15
         Width           =   1065
         _cx             =   1879
         _cy             =   741
         Appearance      =   0
         BorderStyle     =   0
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   16777215
         ForeColorSel    =   -2147483640
         BackColorBkg    =   -2147483643
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483633
         GridColorFixed  =   -2147483632
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483642
         FocusRect       =   1
         HighLight       =   1
         AllowSelection  =   0   'False
         AllowBigSelection=   0   'False
         AllowUserResizing=   0
         SelectionMode   =   0
         GridLines       =   0
         GridLinesFixed  =   0
         GridLineWidth   =   1
         Rows            =   15
         Cols            =   1
         FixedRows       =   1
         FixedCols       =   0
         RowHeightMin    =   250
         RowHeightMax    =   0
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   -1  'True
         FormatString    =   $"frmOutAdviceEdit.frx":05F2
         ScrollTrack     =   0   'False
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   -1  'True
         AutoSizeMode    =   0
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   0
         Editable        =   0
         ShowComboButton =   1
         WordWrap        =   0   'False
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         DataMode        =   0
         VirtualData     =   -1  'True
         DataMember      =   ""
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   24
      End
   End
   Begin VB.PictureBox picPanel 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   780
      Index           =   25
      Left            =   13380
      ScaleHeight     =   780
      ScaleWidth      =   2115
      TabIndex        =   84
      TabStop         =   0   'False
      Top             =   1785
      Width           =   2115
      Begin VSFlex8Ctl.VSFlexGrid vsScheme 
         Height          =   420
         Left            =   195
         TabIndex        =   85
         TabStop         =   0   'False
         Top             =   285
         Width           =   1065
         _cx             =   1879
         _cy             =   741
         Appearance      =   0
         BorderStyle     =   0
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   16777215
         ForeColorSel    =   -2147483640
         BackColorBkg    =   -2147483643
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483633
         GridColorFixed  =   -2147483632
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483642
         FocusRect       =   1
         HighLight       =   1
         AllowSelection  =   0   'False
         AllowBigSelection=   0   'False
         AllowUserResizing=   0
         SelectionMode   =   0
         GridLines       =   0
         GridLinesFixed  =   0
         GridLineWidth   =   1
         Rows            =   5
         Cols            =   1
         FixedRows       =   1
         FixedCols       =   0
         RowHeightMin    =   0
         RowHeightMax    =   0
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   -1  'True
         FormatString    =   $"frmOutAdviceEdit.frx":0626
         ScrollTrack     =   0   'False
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   -1  'True
         AutoSizeMode    =   0
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   0
         Editable        =   0
         ShowComboButton =   1
         WordWrap        =   0   'False
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         DataMode        =   0
         VirtualData     =   -1  'True
         DataMember      =   ""
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   24
      End
      Begin VB.Label lblCTN 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         BackColor       =   &H80000005&
         Caption         =   "一个成套方案"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   -1  'True
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00FF0000&
         Height          =   180
         Left            =   780
         TabIndex        =   87
         Top             =   60
         Width           =   1080
      End
      Begin VB.Label lblCTFW 
         Appearance      =   0  'Flat
         AutoSize        =   -1  'True
         BackColor       =   &H80000005&
         Caption         =   "本人"
         BeginProperty Font 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   -1  'True
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00FF0000&
         Height          =   180
         Left            =   135
         TabIndex        =   86
         Top             =   60
         Width           =   360
      End
   End
   Begin VB.PictureBox picPanel 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   255
      Index           =   70
      Left            =   14160
      ScaleHeight     =   255
      ScaleWidth      =   210
      TabIndex        =   83
      TabStop         =   0   'False
      Top             =   255
      Visible         =   0   'False
      Width           =   210
   End
   Begin VB.PictureBox picPanel 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   255
      Index           =   1
      Left            =   13380
      ScaleHeight     =   255
      ScaleWidth      =   240
      TabIndex        =   82
      TabStop         =   0   'False
      Top             =   255
      Visible         =   0   'False
      Width           =   240
   End
   Begin VB.PictureBox picPanel 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   225
      Index           =   2
      Left            =   13770
      ScaleHeight     =   225
      ScaleWidth      =   255
      TabIndex        =   81
      TabStop         =   0   'False
      Top             =   255
      Visible         =   0   'False
      Width           =   255
   End
   Begin VB.PictureBox picSub 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   8535
      Left            =   285
      ScaleHeight     =   8535
      ScaleWidth      =   13155
      TabIndex        =   73
      TabStop         =   0   'False
      Top             =   90
      Width           =   13155
      Begin VB.PictureBox picEpr 
         Appearance      =   0  'Flat
         BackColor       =   &H00C0FFFF&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   2730
         Left            =   1035
         ScaleHeight     =   2730
         ScaleWidth      =   9930
         TabIndex        =   113
         TabStop         =   0   'False
         Top             =   2025
         Width           =   9930
         Begin VB.PictureBox picOutDoc 
            AutoRedraw      =   -1  'True
            BackColor       =   &H00FDFDFD&
            BorderStyle     =   0  'None
            Height          =   2385
            Left            =   240
            ScaleHeight     =   2385
            ScaleWidth      =   9195
            TabIndex        =   114
            TabStop         =   0   'False
            Top             =   165
            Width           =   9200
            Begin VB.CommandButton cmdImportEPRDemo 
               Caption         =   "导入范文(&I)"
               Height          =   350
               Left            =   6480
               TabIndex        =   120
               TabStop         =   0   'False
               Top             =   2040
               Width           =   1200
            End
            Begin VB.CommandButton cmdUpdate 
               Caption         =   "全文编辑(&U)"
               Height          =   350
               Left            =   7800
               TabIndex        =   119
               TabStop         =   0   'False
               Top             =   2040
               Width           =   1200
            End
            Begin VB.PictureBox picPrompt 
               BackColor       =   &H00FDFDFD&
               BorderStyle     =   0  'None
               Height          =   255
               Left            =   4545
               Picture         =   "frmOutAdviceEdit.frx":065A
               ScaleHeight     =   255
               ScaleWidth      =   255
               TabIndex        =   118
               TabStop         =   0   'False
               Top             =   2078
               Width           =   260
            End
            Begin VB.CommandButton cmdSign 
               Caption         =   "取消签名(&Q)"
               Height          =   350
               Left            =   7820
               TabIndex        =   117
               TabStop         =   0   'False
               Top             =   1677
               Width           =   1200
            End
            Begin VB.PictureBox picSentence 
               Appearance      =   0  'Flat
               AutoRedraw      =   -1  'True
               BackColor       =   &H80000005&
               ForeColor       =   &H80000008&
               Height          =   270
               Left            =   720
               ScaleHeight     =   240
               ScaleWidth      =   1155
               TabIndex        =   115
               TabStop         =   0   'False
               Top             =   120
               Visible         =   0   'False
               Width           =   1185
               Begin VB.TextBox txtSentence 
                  Appearance      =   0  'Flat
                  BorderStyle     =   0  'None
                  Height          =   180
                  Left            =   15
                  TabIndex        =   116
                  TabStop         =   0   'False
                  Top             =   30
                  Width           =   930
               End
               Begin VB.Image imgSentence 
                  Height          =   210
                  Left            =   960
                  Picture         =   "frmOutAdviceEdit.frx":0A5B
                  ToolTipText     =   "请按 * 号键选择"
                  Top             =   15
                  Width           =   180
               End
            End
            Begin RichTextLib.RichTextBox rtfEdit 
               Height          =   795
               Index           =   3
               Left            =   4935
               TabIndex        =   3
               Top             =   780
               Width           =   4095
               _ExtentX        =   7223
               _ExtentY        =   1402
               _Version        =   393217
               BackColor       =   16645629
               ScrollBars      =   2
               MaxLength       =   4000
               Appearance      =   0
               TextRTF         =   $"frmOutAdviceEdit.frx":0F85
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "宋体"
                  Size            =   9
                  Charset         =   134
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
            End
            Begin RichTextLib.RichTextBox rtfEdit 
               Height          =   795
               Index           =   4
               Left            =   375
               TabIndex        =   4
               Top             =   1500
               Width           =   4095
               _ExtentX        =   7223
               _ExtentY        =   1402
               _Version        =   393217
               BackColor       =   16645629
               ScrollBars      =   2
               MaxLength       =   4000
               Appearance      =   0
               TextRTF         =   $"frmOutAdviceEdit.frx":1022
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "宋体"
                  Size            =   9
                  Charset         =   134
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
            End
            Begin RichTextLib.RichTextBox rtfEdit 
               Height          =   795
               Index           =   0
               Left            =   380
               TabIndex        =   0
               Top             =   0
               Width           =   4095
               _ExtentX        =   7223
               _ExtentY        =   1402
               _Version        =   393217
               BackColor       =   16645629
               ScrollBars      =   2
               MaxLength       =   4000
               Appearance      =   0
               TextRTF         =   $"frmOutAdviceEdit.frx":10BF
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "宋体"
                  Size            =   9
                  Charset         =   134
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
            End
            Begin RichTextLib.RichTextBox rtfEdit 
               Height          =   795
               Index           =   2
               Left            =   375
               TabIndex        =   2
               Top             =   780
               Width           =   4095
               _ExtentX        =   7223
               _ExtentY        =   1402
               _Version        =   393217
               BackColor       =   16645629
               ScrollBars      =   2
               MaxLength       =   4000
               Appearance      =   0
               TextRTF         =   $"frmOutAdviceEdit.frx":115C
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "宋体"
                  Size            =   9
                  Charset         =   134
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
            End
            Begin RichTextLib.RichTextBox rtfEdit 
               Height          =   795
               Index           =   1
               Left            =   4935
               TabIndex        =   1
               Top             =   0
               Width           =   4095
               _ExtentX        =   7223
               _ExtentY        =   1402
               _Version        =   393217
               BackColor       =   16645629
               ScrollBars      =   2
               MaxLength       =   4000
               Appearance      =   0
               TextRTF         =   $"frmOutAdviceEdit.frx":11F9
               BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                  Name            =   "宋体"
                  Size            =   9
                  Charset         =   134
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
            End
            Begin VB.Label lblEPRname 
               AutoSize        =   -1  'True
               BackColor       =   &H00C0FFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "(门诊病历)"
               ForeColor       =   &H00800000&
               Height          =   255
               Left            =   4920
               TabIndex        =   129
               Top             =   1780
               Visible         =   0   'False
               Width           =   900
            End
            Begin VB.Label lblTip 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "输入病历时按 ~ 键可提取或选择词句示范."
               ForeColor       =   &H00404040&
               Height          =   180
               Left            =   4920
               TabIndex        =   128
               Top             =   2115
               Width           =   3420
            End
            Begin VB.Label lblDoctor 
               AutoSize        =   -1  'True
               BackColor       =   &H00C0FFC0&
               BackStyle       =   0  'Transparent
               Caption         =   "刘力红"
               ForeColor       =   &H00404040&
               Height          =   180
               Index           =   1
               Left            =   7215
               TabIndex        =   127
               Top             =   1785
               Width           =   540
            End
            Begin VB.Label lblDoc 
               BackStyle       =   0  'Transparent
               Caption         =   "主  诉"
               Height          =   540
               Index           =   0
               Left            =   120
               TabIndex        =   126
               Top             =   0
               Width           =   180
            End
            Begin VB.Label lblDoc 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "家族史"
               Height          =   540
               Index           =   3
               Left            =   4680
               TabIndex        =   125
               Top             =   907
               Width           =   180
               WordWrap        =   -1  'True
            End
            Begin VB.Label lblDoc 
               BackStyle       =   0  'Transparent
               Caption         =   "查  体"
               Height          =   540
               Index           =   4
               Left            =   120
               TabIndex        =   124
               Top             =   1627
               Width           =   180
            End
            Begin VB.Label lblDoc 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "过去史"
               Height          =   540
               Index           =   2
               Left            =   120
               TabIndex        =   123
               Top             =   907
               Width           =   180
               WordWrap        =   -1  'True
            End
            Begin VB.Label lblDoctor 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "医生:"
               ForeColor       =   &H00404040&
               Height          =   255
               Index           =   0
               Left            =   6705
               TabIndex        =   122
               Top             =   1785
               Width           =   450
            End
            Begin VB.Label lblDoc 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "现病史"
               Height          =   540
               Index           =   1
               Left            =   4680
               TabIndex        =   121
               Top             =   0
               Width           =   180
               WordWrap        =   -1  'True
            End
         End
         Begin zlRichEditor.Editor edtEditor 
            Height          =   465
            Left            =   9450
            TabIndex        =   130
            Top             =   315
            Visible         =   0   'False
            Width           =   480
            _ExtentX        =   847
            _ExtentY        =   820
         End
      End
      Begin VB.PictureBox picPanel 
         Appearance      =   0  'Flat
         BackColor       =   &H80000005&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   1545
         Index           =   24
         Left            =   3510
         ScaleHeight     =   1545
         ScaleWidth      =   2385
         TabIndex        =   107
         TabStop         =   0   'False
         Top             =   1710
         Visible         =   0   'False
         Width           =   2385
         Begin VSFlex8Ctl.VSFlexGrid vsDiagComm 
            Height          =   495
            Left            =   180
            TabIndex        =   108
            Top             =   120
            Width           =   2055
            _cx             =   3625
            _cy             =   873
            Appearance      =   2
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "宋体"
               Size            =   9
               Charset         =   134
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   -2147483643
            ForeColorSel    =   -2147483640
            BackColorBkg    =   -2147483643
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   1
            HighLight       =   1
            AllowSelection  =   0   'False
            AllowBigSelection=   0   'False
            AllowUserResizing=   0
            SelectionMode   =   1
            GridLines       =   0
            GridLinesFixed  =   0
            GridLineWidth   =   1
            Rows            =   6
            Cols            =   2
            FixedRows       =   0
            FixedCols       =   0
            RowHeightMin    =   280
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   -1  'True
            FormatString    =   $"frmOutAdviceEdit.frx":1296
            ScrollTrack     =   0   'False
            ScrollBars      =   3
            ScrollTips      =   0   'False
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   0
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   1
            WordWrap        =   -1  'True
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            DataMode        =   0
            VirtualData     =   -1  'True
            DataMember      =   ""
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
            AccessibleName  =   ""
            AccessibleDescription=   ""
            AccessibleValue =   ""
            AccessibleRole  =   24
         End
         Begin VSFlex8Ctl.VSFlexGrid vsDiagBefore 
            Height          =   495
            Left            =   180
            TabIndex        =   109
            Top             =   795
            Width           =   2055
            _cx             =   3625
            _cy             =   873
            Appearance      =   2
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "宋体"
               Size            =   9
               Charset         =   134
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   -2147483643
            ForeColorSel    =   -2147483640
            BackColorBkg    =   -2147483643
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   1
            HighLight       =   1
            AllowSelection  =   0   'False
            AllowBigSelection=   0   'False
            AllowUserResizing=   0
            SelectionMode   =   1
            GridLines       =   0
            GridLinesFixed  =   0
            GridLineWidth   =   1
            Rows            =   6
            Cols            =   2
            FixedRows       =   0
            FixedCols       =   0
            RowHeightMin    =   280
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   -1  'True
            FormatString    =   $"frmOutAdviceEdit.frx":12DC
            ScrollTrack     =   0   'False
            ScrollBars      =   3
            ScrollTips      =   0   'False
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   0
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   1
            WordWrap        =   -1  'True
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            DataMode        =   0
            VirtualData     =   -1  'True
            DataMember      =   ""
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
            AccessibleName  =   ""
            AccessibleDescription=   ""
            AccessibleValue =   ""
            AccessibleRole  =   24
         End
      End
      Begin VB.Frame fra诊断 
         Appearance      =   0  'Flat
         BackColor       =   &H00C0FFC0&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   810
         Left            =   600
         TabIndex        =   102
         Top             =   1050
         Width           =   11060
         Begin VB.OptionButton opt诊断 
            Caption         =   "按疾病编码"
            Height          =   180
            Index           =   1
            Left            =   9820
            TabIndex        =   105
            TabStop         =   0   'False
            Top             =   380
            Width           =   1200
         End
         Begin VB.OptionButton opt诊断 
            Caption         =   "按诊断标准"
            Height          =   180
            Index           =   0
            Left            =   9840
            TabIndex        =   104
            TabStop         =   0   'False
            Top             =   100
            Value           =   -1  'True
            Width           =   1200
         End
         Begin VB.CommandButton cmdLastDiag 
            Caption         =   "上次诊断"
            Height          =   300
            Left            =   50
            TabIndex        =   103
            TabStop         =   0   'False
            Top             =   320
            Width           =   900
         End
         Begin VSFlex8Ctl.VSFlexGrid vsDiag 
            Height          =   630
            Left            =   975
            TabIndex        =   5
            TabStop         =   0   'False
            Top             =   0
            Width           =   8760
            _cx             =   15452
            _cy             =   1111
            Appearance      =   2
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "宋体"
               Size            =   9
               Charset         =   134
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   13684944
            ForeColorSel    =   0
            BackColorBkg    =   -2147483643
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483636
            GridColorFixed  =   -2147483636
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483643
            FocusRect       =   3
            HighLight       =   1
            AllowSelection  =   0   'False
            AllowBigSelection=   0   'False
            AllowUserResizing=   1
            SelectionMode   =   0
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   2
            Cols            =   20
            FixedRows       =   1
            FixedCols       =   0
            RowHeightMin    =   300
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   0   'False
            FormatString    =   $"frmOutAdviceEdit.frx":1322
            ScrollTrack     =   -1  'True
            ScrollBars      =   2
            ScrollTips      =   0   'False
            MergeCells      =   115
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   0
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   2
            ShowComboButton =   1
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            DataMode        =   0
            VirtualData     =   -1  'True
            DataMember      =   ""
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
            AccessibleName  =   ""
            AccessibleDescription=   ""
            AccessibleValue =   ""
            AccessibleRole  =   24
         End
         Begin VB.Label lbl诊断 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "病人诊断"
            Height          =   180
            Left            =   120
            TabIndex        =   106
            Top             =   60
            Width           =   720
         End
      End
      Begin MSComCtl2.MonthView dtpDate 
         Height          =   2220
         Left            =   2220
         TabIndex        =   7
         Top             =   2970
         Visible         =   0   'False
         Width           =   2805
         _ExtentX        =   4948
         _ExtentY        =   3916
         _Version        =   393216
         ForeColor       =   -2147483630
         BackColor       =   -2147483633
         Appearance      =   1
         StartOfWeek     =   175702017
         TitleBackColor  =   -2147483636
         TitleForeColor  =   -2147483634
         TrailingForeColor=   -2147483637
         CurrentDate     =   37904
      End
      Begin VB.PictureBox picPanel 
         Appearance      =   0  'Flat
         BackColor       =   &H80000005&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   4155
         Index           =   3
         Left            =   11520
         ScaleHeight     =   4155
         ScaleWidth      =   930
         TabIndex        =   76
         TabStop         =   0   'False
         Top             =   720
         Width           =   930
         Begin XtremeSuiteControls.TabControl tbcItem 
            Height          =   705
            Index           =   0
            Left            =   60
            TabIndex        =   77
            TabStop         =   0   'False
            Top             =   240
            Width           =   555
            _Version        =   589884
            _ExtentX        =   979
            _ExtentY        =   1244
            _StockProps     =   64
         End
         Begin XtremeSuiteControls.TabControl tbcItem 
            Height          =   705
            Index           =   1
            Left            =   60
            TabIndex        =   78
            TabStop         =   0   'False
            Top             =   1110
            Width           =   555
            _Version        =   589884
            _ExtentX        =   979
            _ExtentY        =   1244
            _StockProps     =   64
         End
         Begin XtremeSuiteControls.TabControl tbcItem 
            Height          =   750
            Index           =   2
            Left            =   60
            TabIndex        =   79
            TabStop         =   0   'False
            Top             =   2055
            Width           =   555
            _Version        =   589884
            _ExtentX        =   979
            _ExtentY        =   1323
            _StockProps     =   64
         End
         Begin XtremeSuiteControls.TabControl tbcItem 
            Height          =   750
            Index           =   3
            Left            =   60
            TabIndex        =   80
            TabStop         =   0   'False
            Top             =   3030
            Width           =   555
            _Version        =   589884
            _ExtentX        =   979
            _ExtentY        =   1323
            _StockProps     =   64
         End
      End
      Begin VB.PictureBox picPanel 
         Appearance      =   0  'Flat
         BackColor       =   &H80000005&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   420
         Index           =   4
         Left            =   240
         ScaleHeight     =   420
         ScaleWidth      =   555
         TabIndex        =   74
         TabStop         =   0   'False
         Top             =   6165
         Width           =   555
         Begin MSComctlLib.Toolbar tbrAdd 
            Height          =   330
            Left            =   0
            TabIndex        =   75
            Top             =   0
            Width           =   480
            _ExtentX        =   847
            _ExtentY        =   582
            ButtonWidth     =   609
            ButtonHeight    =   582
            AllowCustomize  =   0   'False
            Wrappable       =   0   'False
            Style           =   1
            _Version        =   393216
            BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
               NumButtons      =   1
               BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                  Object.ToolTipText     =   "增加(Ctl+A)"
               EndProperty
            EndProperty
         End
      End
      Begin VB.PictureBox pictmp 
         Appearance      =   0  'Flat
         AutoRedraw      =   -1  'True
         BackColor       =   &H80000005&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   240
         Left            =   9720
         ScaleHeight     =   240
         ScaleWidth      =   480
         TabIndex        =   68
         TabStop         =   0   'False
         Top             =   2160
         Visible         =   0   'False
         Width           =   480
      End
      Begin VB.PictureBox pic疑问 
         Appearance      =   0  'Flat
         AutoRedraw      =   -1  'True
         BorderStyle     =   0  'None
         Enabled         =   0   'False
         ForeColor       =   &H80000008&
         Height          =   270
         Left            =   0
         ScaleHeight     =   270
         ScaleWidth      =   11070
         TabIndex        =   61
         TabStop         =   0   'False
         Top             =   5130
         Visible         =   0   'False
         Width           =   11070
         Begin VB.Label lbl疑问 
            BackColor       =   &H00C0C0FF&
            BackStyle       =   0  'Transparent
            ForeColor       =   &H000000C0&
            Height          =   180
            Left            =   495
            TabIndex        =   62
            Top             =   45
            Width           =   1725
         End
         Begin VB.Image Image1 
            Height          =   240
            Left            =   150
            Picture         =   "frmOutAdviceEdit.frx":14EB
            Top             =   0
            Width           =   240
         End
      End
      Begin VB.Frame fraPati 
         Appearance      =   0  'Flat
         BackColor       =   &H00C0E0FF&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   450
         Left            =   0
         TabIndex        =   39
         Top             =   510
         Width           =   10995
         Begin VB.CommandButton cmdAlley 
            Caption         =   "过敏史/病生状态"
            Height          =   350
            Left            =   9240
            TabIndex        =   38
            TabStop         =   0   'False
            Top             =   0
            Visible         =   0   'False
            Width           =   1530
         End
         Begin VB.OptionButton optState 
            BackColor       =   &H00C0E0FF&
            Caption         =   "初诊"
            ForeColor       =   &H00800000&
            Height          =   255
            Index           =   0
            Left            =   7440
            TabIndex        =   72
            TabStop         =   0   'False
            Top             =   120
            Value           =   -1  'True
            Width           =   675
         End
         Begin VB.OptionButton optState 
            BackColor       =   &H00C0E0FF&
            Caption         =   "复诊"
            ForeColor       =   &H00800000&
            Height          =   255
            Index           =   1
            Left            =   8280
            TabIndex        =   71
            TabStop         =   0   'False
            Top             =   120
            Width           =   675
         End
         Begin VB.ComboBox cbo婴儿 
            Height          =   300
            ItemData        =   "frmOutAdviceEdit.frx":1A75
            Left            =   9555
            List            =   "frmOutAdviceEdit.frx":1A8B
            Style           =   2  'Dropdown List
            TabIndex        =   37
            TabStop         =   0   'False
            Top             =   75
            Width           =   1395
         End
         Begin VB.Label lblLink 
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            BackColor       =   &H80000005&
            BackStyle       =   0  'Transparent
            Caption         =   "展开快捷病历"
            BeginProperty Font 
               Name            =   "宋体"
               Size            =   9
               Charset         =   134
               Weight          =   400
               Underline       =   -1  'True
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00C00000&
            Height          =   180
            Left            =   6360
            MouseIcon       =   "frmOutAdviceEdit.frx":1ADA
            MousePointer    =   99  'Custom
            TabIndex        =   112
            Top             =   120
            Visible         =   0   'False
            Width           =   1080
         End
         Begin VB.Label lblMoney 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "新开:0元  需补交:0元"
            ForeColor       =   &H00800000&
            Height          =   180
            Left            =   4440
            TabIndex        =   110
            ToolTipText     =   "需补交：预交余额-新开金额"
            Top             =   120
            Width           =   1800
         End
         Begin VB.Label lblFamilyTmp 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "家属:"
            BeginProperty Font 
               Name            =   "宋体"
               Size            =   9
               Charset         =   134
               Weight          =   400
               Underline       =   -1  'True
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00800000&
            Height          =   180
            Left            =   2985
            MouseIcon       =   "frmOutAdviceEdit.frx":345C
            MousePointer    =   99  'Custom
            TabIndex        =   98
            Top             =   0
            Visible         =   0   'False
            Width           =   450
         End
         Begin VB.Label lblFamily 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "配偶 张三 就诊卡号:432648"
            ForeColor       =   &H00800000&
            Height          =   180
            Left            =   0
            TabIndex        =   97
            Top             =   0
            Visible         =   0   'False
            Width           =   2250
         End
         Begin VB.Label lbl婴儿 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "婴儿"
            Height          =   180
            Left            =   9135
            TabIndex        =   36
            Top             =   135
            Width           =   360
         End
         Begin VB.Label lblPati 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "姓名: 性别: 年龄: 门诊号: 费别: 医疗付款方式:"
            ForeColor       =   &H00800000&
            Height          =   180
            Left            =   210
            TabIndex        =   40
            Top             =   135
            Width           =   4050
         End
      End
      Begin VSFlex8Ctl.VSFlexGrid vsAdvice 
         Height          =   3405
         Left            =   180
         TabIndex        =   6
         Top             =   1875
         Width           =   10995
         _cx             =   19394
         _cy             =   6006
         Appearance      =   1
         BorderStyle     =   1
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   16444122
         ForeColorSel    =   0
         BackColorBkg    =   -2147483643
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483636
         GridColorFixed  =   -2147483636
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483643
         FocusRect       =   2
         HighLight       =   1
         AllowSelection  =   0   'False
         AllowBigSelection=   0   'False
         AllowUserResizing=   1
         SelectionMode   =   1
         GridLines       =   1
         GridLinesFixed  =   1
         GridLineWidth   =   1
         Rows            =   18
         Cols            =   11
         FixedRows       =   1
         FixedCols       =   1
         RowHeightMin    =   250
         RowHeightMax    =   2000
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   0   'False
         FormatString    =   $"frmOutAdviceEdit.frx":4DDE
         ScrollTrack     =   -1  'True
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   0   'False
         AutoSizeMode    =   1
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   1
         Editable        =   0
         ShowComboButton =   1
         WordWrap        =   -1  'True
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         DataMode        =   0
         VirtualData     =   -1  'True
         DataMember      =   ""
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   24
         Begin MSComctlLib.ImageList img16 
            Left            =   1965
            Top             =   450
            _ExtentX        =   1005
            _ExtentY        =   1005
            BackColor       =   -2147483643
            ImageWidth      =   16
            ImageHeight     =   16
            MaskColor       =   16777215
            _Version        =   393216
            BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
               NumListImages   =   4
               BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
                  Picture         =   "frmOutAdviceEdit.frx":4EC6
                  Key             =   "警示"
               EndProperty
               BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
                  Picture         =   "frmOutAdviceEdit.frx":5460
                  Key             =   "诊断"
               EndProperty
               BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
                  Picture         =   "frmOutAdviceEdit.frx":59FA
                  Key             =   "诊断_当前"
               EndProperty
               BeginProperty ListImage4 {2C247F27-8591-11D1-B16A-00C0F0283628} 
                  Picture         =   "frmOutAdviceEdit.frx":5F94
                  Key             =   "诊断_关联"
               EndProperty
            EndProperty
         End
      End
      Begin VB.Frame fraAdvice 
         Height          =   2685
         Left            =   45
         TabIndex        =   41
         Top             =   5340
         Width           =   11040
         Begin VB.CommandButton cmdZYRemark 
            Caption         =   "…"
            Height          =   300
            Left            =   9960
            TabIndex        =   111
            TabStop         =   0   'False
            Top             =   1860
            Visible         =   0   'False
            Width           =   285
         End
         Begin VB.TextBox txtBYZX 
            Height          =   270
            Left            =   9015
            TabIndex        =   96
            Top             =   1545
            Width           =   705
         End
         Begin VB.ComboBox cboDruPur 
            Height          =   300
            Left            =   960
            Style           =   2  'Dropdown List
            TabIndex        =   25
            Top             =   2220
            Width           =   1815
         End
         Begin VB.CommandButton cmdComExcReason 
            Height          =   300
            Left            =   10260
            Picture         =   "frmOutAdviceEdit.frx":652E
            Style           =   1  'Graphical
            TabIndex        =   70
            TabStop         =   0   'False
            ToolTipText     =   "将当前说明设置为常用说明"
            Top             =   1860
            Width           =   315
         End
         Begin VB.CommandButton cmdExcReason 
            Caption         =   "…"
            Height          =   265
            Left            =   9930
            TabIndex        =   69
            TabStop         =   0   'False
            Top             =   1875
            Width           =   285
         End
         Begin VB.TextBox txt超量说明 
            BackColor       =   &H8000000F&
            Enabled         =   0   'False
            Height          =   300
            Left            =   6255
            MaxLength       =   500
            TabIndex        =   24
            Top             =   1875
            Width           =   3945
         End
         Begin VB.CommandButton cmd医生嘱托 
            Caption         =   "…"
            Height          =   265
            Left            =   9960
            TabIndex        =   66
            TabStop         =   0   'False
            Top             =   573
            Width           =   285
         End
         Begin VB.TextBox cbo医生嘱托 
            Height          =   300
            Left            =   6255
            MaxLength       =   100
            TabIndex        =   30
            Top             =   555
            Width           =   4000
         End
         Begin VB.CommandButton cmd收藏用药理由 
            Height          =   300
            Left            =   10275
            Picture         =   "frmOutAdviceEdit.frx":6AB8
            Style           =   1  'Graphical
            TabIndex        =   65
            TabStop         =   0   'False
            ToolTipText     =   "将当前理由设置为常用理由。"
            Top             =   2250
            Width           =   315
         End
         Begin VB.CommandButton cmdReason 
            Caption         =   "…"
            Height          =   265
            Left            =   9930
            TabIndex        =   64
            TabStop         =   0   'False
            Top             =   2250
            Width           =   285
         End
         Begin VB.PictureBox picHelp 
            Appearance      =   0  'Flat
            BorderStyle     =   0  'None
            ForeColor       =   &H80000008&
            Height          =   255
            Left            =   5200
            Picture         =   "frmOutAdviceEdit.frx":7042
            ScaleHeight     =   255
            ScaleWidth      =   255
            TabIndex        =   63
            TabStop         =   0   'False
            Top             =   900
            Visible         =   0   'False
            Width           =   255
         End
         Begin VB.CheckBox chk免试 
            Caption         =   "免试"
            Height          =   180
            Left            =   4560
            TabIndex        =   11
            Top             =   300
            Visible         =   0   'False
            Width           =   660
         End
         Begin VB.TextBox txt用药理由 
            Height          =   300
            Left            =   4860
            MaxLength       =   1000
            TabIndex        =   27
            Top             =   2250
            Width           =   5385
         End
         Begin VB.CheckBox chkZeroBilling 
            Caption         =   "发送为不收费的记帐单(&F)"
            Height          =   225
            Left            =   8280
            TabIndex        =   29
            TabStop         =   0   'False
            Top             =   285
            Width           =   2370
         End
         Begin VB.ComboBox cbo滴速 
            Height          =   300
            Left            =   6255
            TabIndex        =   28
            Top             =   240
            Visible         =   0   'False
            Width           =   1050
         End
         Begin VB.CommandButton cmd安排时间 
            Height          =   240
            Left            =   2490
            Picture         =   "frmOutAdviceEdit.frx":75CC
            Style           =   1  'Graphical
            TabIndex        =   16
            TabStop         =   0   'False
            ToolTipText     =   "选择日期(F4)"
            Top             =   1545
            Visible         =   0   'False
            Width           =   255
         End
         Begin VB.TextBox txt安排时间 
            Height          =   300
            Left            =   960
            TabIndex        =   15
            Top             =   1515
            Visible         =   0   'False
            Width           =   1815
         End
         Begin VB.CommandButton cmd常用嘱托 
            Height          =   300
            Left            =   10275
            Picture         =   "frmOutAdviceEdit.frx":76C2
            Style           =   1  'Graphical
            TabIndex        =   31
            TabStop         =   0   'False
            ToolTipText     =   "将当前嘱托设置为常用嘱托(Ctrl+D)"
            Top             =   555
            Width           =   315
         End
         Begin VB.ComboBox cbo附加执行 
            Height          =   300
            Left            =   6255
            TabIndex        =   35
            Text            =   "cbo附加执行"
            Top             =   1515
            Width           =   1860
         End
         Begin VB.TextBox txt天数 
            Alignment       =   2  'Center
            Height          =   300
            Left            =   2385
            MaxLength       =   3
            TabIndex        =   22
            Top             =   1875
            Visible         =   0   'False
            Width           =   360
         End
         Begin VB.CommandButton cmd频率 
            Height          =   240
            Left            =   4920
            Picture         =   "frmOutAdviceEdit.frx":7C4C
            Style           =   1  'Graphical
            TabIndex        =   20
            TabStop         =   0   'False
            ToolTipText     =   "选择项目(F4)"
            Top             =   1545
            Width           =   270
         End
         Begin VB.TextBox txt频率 
            Height          =   300
            Left            =   3540
            TabIndex        =   19
            Top             =   1515
            Width           =   1665
         End
         Begin VB.TextBox txt单量 
            Alignment       =   1  'Right Justify
            Height          =   300
            Left            =   3540
            MaxLength       =   10
            TabIndex        =   23
            Top             =   1875
            Width           =   1365
         End
         Begin VB.TextBox txt总量 
            Alignment       =   1  'Right Justify
            Height          =   300
            Left            =   960
            MaxLength       =   10
            TabIndex        =   21
            Top             =   1875
            Width           =   1530
         End
         Begin VB.CommandButton cmd用法 
            Height          =   240
            Left            =   2445
            Picture         =   "frmOutAdviceEdit.frx":7D42
            Style           =   1  'Graphical
            TabIndex        =   18
            TabStop         =   0   'False
            ToolTipText     =   "选择项目(F4)"
            Top             =   1545
            Width           =   270
         End
         Begin VB.TextBox txt用法 
            Height          =   300
            Left            =   960
            TabIndex        =   17
            Top             =   1515
            Width           =   1815
         End
         Begin VB.CommandButton cmd开始时间 
            Height          =   240
            Left            =   2475
            Picture         =   "frmOutAdviceEdit.frx":7E38
            Style           =   1  'Graphical
            TabIndex        =   9
            TabStop         =   0   'False
            ToolTipText     =   "选择日期(F4)"
            Top             =   270
            Width           =   255
         End
         Begin VB.CheckBox chk紧急 
            Caption         =   "紧急医嘱(&E)"
            Height          =   225
            Left            =   3000
            TabIndex        =   10
            TabStop         =   0   'False
            Top             =   285
            Width           =   1290
         End
         Begin VB.CommandButton cmdExt 
            Height          =   285
            Left            =   4920
            Picture         =   "frmOutAdviceEdit.frx":7F2E
            Style           =   1  'Graphical
            TabIndex        =   13
            TabStop         =   0   'False
            ToolTipText     =   "编辑(F4)"
            Top             =   552
            Width           =   285
         End
         Begin VB.CommandButton cmdSel 
            Caption         =   "…"
            Height          =   285
            Left            =   4920
            TabIndex        =   14
            TabStop         =   0   'False
            ToolTipText     =   "选择项目(*)"
            Top             =   870
            Width           =   285
         End
         Begin VB.ComboBox cbo执行性质 
            Height          =   300
            ItemData        =   "frmOutAdviceEdit.frx":8024
            Left            =   9015
            List            =   "frmOutAdviceEdit.frx":8031
            Style           =   2  'Dropdown List
            TabIndex        =   34
            Top             =   1200
            Width           =   1590
         End
         Begin VB.ComboBox cbo执行科室 
            Height          =   300
            Left            =   6255
            TabIndex        =   33
            Text            =   "cbo执行科室"
            Top             =   1200
            Width           =   1860
         End
         Begin VB.TextBox txt医嘱内容 
            Height          =   900
            Left            =   960
            MaxLength       =   1000
            MultiLine       =   -1  'True
            TabIndex        =   12
            ToolTipText     =   "按 ~ 键显示成套方案选择器,Ctrl+F1调用医保信息"
            Top             =   552
            Width           =   3945
         End
         Begin VB.ComboBox cbo执行时间 
            Height          =   300
            Left            =   6255
            TabIndex        =   32
            Top             =   877
            Width           =   4350
         End
         Begin MSMask.MaskEdBox msk开始时间 
            Height          =   300
            Left            =   960
            TabIndex        =   8
            Top             =   240
            Width           =   1815
            _ExtentX        =   3201
            _ExtentY        =   529
            _Version        =   393216
            MaxLength       =   16
            Mask            =   "####-##-## ##:##"
            PromptChar      =   "_"
         End
         Begin VB.Label lblBYZXCS 
            AutoSize        =   -1  'True
            Caption         =   "次(共3次)"
            Height          =   180
            Left            =   9795
            TabIndex        =   95
            Top             =   1575
            Width           =   810
         End
         Begin VB.Label lblBYZX 
            AutoSize        =   -1  'True
            Caption         =   "本院执行"
            Height          =   180
            Left            =   8250
            TabIndex        =   94
            Top             =   1575
            Width           =   720
         End
         Begin VB.Label lbl超量说明 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "超量说明"
            Height          =   180
            Left            =   5490
            TabIndex        =   26
            Top             =   1935
            Width           =   720
         End
         Begin VB.Label lbl医嘱内容 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "医嘱内容"
            Height          =   180
            Left            =   180
            TabIndex        =   67
            Top             =   600
            Width           =   720
         End
         Begin VB.Label lbl用药目的 
            AutoSize        =   -1  'True
            Caption         =   "用药目的"
            Height          =   180
            Left            =   165
            TabIndex        =   60
            Top             =   2265
            Width           =   720
         End
         Begin VB.Label lbl用药理由 
            AutoSize        =   -1  'True
            Caption         =   "用药理由"
            Height          =   180
            Left            =   4080
            TabIndex        =   59
            Top             =   2280
            Width           =   720
         End
         Begin VB.Label lbl滴速单位 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "滴/分钟"
            Height          =   180
            Left            =   7335
            TabIndex        =   57
            Top             =   300
            Visible         =   0   'False
            Width           =   630
         End
         Begin VB.Label lbl滴速 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "↓滴速"
            Height          =   180
            Left            =   5670
            TabIndex        =   56
            Top             =   300
            Visible         =   0   'False
            Width           =   540
         End
         Begin VB.Label lbl安排时间 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "安排时间"
            Height          =   180
            Left            =   165
            TabIndex        =   55
            Top             =   1575
            Visible         =   0   'False
            Width           =   720
         End
         Begin VB.Label lbl附加执行 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "附加执行"
            Height          =   180
            Left            =   5490
            TabIndex        =   54
            Top             =   1575
            Width           =   720
         End
         Begin VB.Label lbl天数 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "用    天"
            Height          =   180
            Left            =   2205
            TabIndex        =   53
            Top             =   1935
            Visible         =   0   'False
            Width           =   720
         End
         Begin VB.Label lbl频率 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "频率"
            Height          =   180
            Left            =   3135
            TabIndex        =   48
            Top             =   1575
            Width           =   360
         End
         Begin VB.Label lbl单量单位 
            AutoSize        =   -1  'True
            BackColor       =   &H00C0C0FF&
            BackStyle       =   0  'Transparent
            Caption         =   "单位"
            Height          =   180
            Left            =   4905
            TabIndex        =   44
            Top             =   1935
            Width           =   360
         End
         Begin VB.Label lbl单量 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            BackColor       =   &H00FFFFFF&
            BackStyle       =   0  'Transparent
            Caption         =   "↓单量"
            ForeColor       =   &H80000008&
            Height          =   180
            Left            =   2955
            TabIndex        =   43
            ToolTipText     =   "常用剂量比例(Ctrl+~)"
            Top             =   1935
            Width           =   540
         End
         Begin VB.Label lbl总量单位 
            BackStyle       =   0  'Transparent
            Caption         =   "单位"
            Height          =   180
            Left            =   2505
            TabIndex        =   46
            Top             =   1935
            Width           =   570
         End
         Begin VB.Label lbl总量 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "总量"
            Height          =   180
            Left            =   540
            TabIndex        =   45
            Top             =   1935
            Width           =   360
         End
         Begin VB.Label lbl医生嘱托 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "医生嘱托"
            Height          =   180
            Left            =   5490
            TabIndex        =   52
            Top             =   615
            Width           =   720
         End
         Begin VB.Label lbl执行性质 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "执行性质"
            Height          =   180
            Left            =   8250
            TabIndex        =   51
            Top             =   1260
            Width           =   720
         End
         Begin VB.Label lbl执行科室 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "执行科室"
            Height          =   180
            Left            =   5490
            TabIndex        =   50
            Top             =   1260
            Width           =   720
         End
         Begin VB.Label lbl用法 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "用法"
            Height          =   180
            Left            =   540
            TabIndex        =   47
            Top             =   1575
            Width           =   360
         End
         Begin VB.Label lbl开始时间 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "生效时间"
            Height          =   180
            Left            =   180
            TabIndex        =   42
            Top             =   300
            Width           =   720
         End
         Begin VB.Label lbl执行时间 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "执行时间"
            Height          =   180
            Left            =   5490
            TabIndex        =   49
            Top             =   937
            Width           =   720
         End
      End
      Begin MSComctlLib.StatusBar stbThis 
         Height          =   360
         Left            =   0
         TabIndex        =   58
         Top             =   8025
         Width           =   11130
         _ExtentX        =   19632
         _ExtentY        =   635
         _Version        =   393216
         BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
            NumPanels       =   9
            BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Bevel           =   2
               Object.Width           =   2355
               MinWidth        =   882
               Picture         =   "frmOutAdviceEdit.frx":8053
               Text            =   "中联软件"
               TextSave        =   "中联软件"
               Key             =   "ZLFLAG"
               Object.ToolTipText     =   "欢迎使用中联有限公司软件"
            EndProperty
            BeginProperty Panel2 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   1
               Object.Width           =   12912
            EndProperty
            BeginProperty Panel3 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Object.Width           =   318
               MinWidth        =   2
            EndProperty
            BeginProperty Panel4 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Object.Width           =   318
               MinWidth        =   2
            EndProperty
            BeginProperty Panel5 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Object.Width           =   318
               MinWidth        =   2
            EndProperty
            BeginProperty Panel6 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Object.Width           =   970
               MinWidth        =   970
               Picture         =   "frmOutAdviceEdit.frx":88E7
               Key             =   "KB"
            EndProperty
            BeginProperty Panel7 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Object.Width           =   617
               MinWidth        =   617
               Picture         =   "frmOutAdviceEdit.frx":964D
               Key             =   "PY"
               Object.ToolTipText     =   "拼音(F7)"
            EndProperty
            BeginProperty Panel8 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Bevel           =   2
               Object.Width           =   617
               MinWidth        =   617
               Picture         =   "frmOutAdviceEdit.frx":9C87
               Key             =   "WB"
               Object.ToolTipText     =   "五笔(F7)"
            EndProperty
            BeginProperty Panel9 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Alignment       =   1
               AutoSize        =   2
               Bevel           =   0
               Object.Width           =   953
               MinWidth        =   25
               Text            =   "计价"
               TextSave        =   "计价"
               Key             =   "Price"
               Object.ToolTipText     =   "显示诊疗计价面板(F8)"
            EndProperty
         EndProperty
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin XtremeCommandBars.CommandBars cbsMain 
         Left            =   0
         Top             =   0
         _Version        =   589884
         _ExtentX        =   635
         _ExtentY        =   635
         _StockProps     =   0
      End
      Begin XtremeDockingPane.DockingPane dkpMain 
         Bindings        =   "frmOutAdviceEdit.frx":A2C1
         Left            =   2310
         Top             =   150
         _Version        =   589884
         _ExtentX        =   450
         _ExtentY        =   423
         _StockProps     =   0
         VisualTheme     =   5
      End
      Begin VB.Image imgDiag 
         Height          =   240
         Left            =   2880
         Picture         =   "frmOutAdviceEdit.frx":A2D5
         Top             =   120
         Visible         =   0   'False
         Width           =   240
      End
      Begin VB.Image imgButtonDel 
         Height          =   240
         Left            =   1665
         Picture         =   "frmOutAdviceEdit.frx":10B27
         Top             =   120
         Visible         =   0   'False
         Width           =   240
      End
      Begin VB.Image imgButtonNew 
         Height          =   240
         Left            =   1005
         Picture         =   "frmOutAdviceEdit.frx":17379
         Top             =   105
         Visible         =   0   'False
         Width           =   240
      End
   End
   Begin VB.Menu mnu_replace 
      Caption         =   "替换为其他项目…"
      Visible         =   0   'False
      Begin VB.Menu mnu_replaceItem 
         Caption         =   "替换为其他项目…"
      End
      Begin VB.Menu mnu_DelItem 
         Caption         =   "移除当前项目"
      End
   End
End
Attribute VB_Name = "frmOutAdviceEdit"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Private Const DColor = &HEEEEEE, EColor = &HFDFDFD, HColor = &HFFDFDF
Public Event FormUnload(Cancel As Integer)
Public Event EditDiagnose(ParentForm As Object, ByVal 挂号单 As String, Succeed As Boolean) '编辑门诊诊断
Public Event CheckInfectDisease(ByVal blnOnChek As Boolean, ByVal str疾病ID As String, ByVal str诊断Id As String, ByRef blnNo As Boolean) '根据诊断检查是否书写传染病报告卡

Public mblnOK As Boolean
Private mstr常用 As String '常用项目，检查检验药品，用于去重复。格式：D28291,药2187-5247,C43740,..........
Private mblnTabTmp As Boolean
Private mstrPreTab As String

Private WithEvents mobjReport As clsReport
Attribute mobjReport.VB_VarHelpID = -1
Private mstrBillPrint As String '当前打印的诊疗单据：报表编号、NO、记录性质
Private mobjPati As Object

'入口参数
Private mbytUseType As Byte '0-医嘱下达
                            '1-临床路径项目的医嘱生成
                            '2-临床路径添加路径外项目的医嘱，不允许选择病人

Private mint场合 As Integer '调用场合:0-医生站调用,1-护士站调用,2-医技站调用(PACS/LIS)
Private mint就诊类型 As Integer 'pt候诊 = 0；pt就诊 = 1；pt已诊 = 2；pt转诊 = 3；pt预约 = 4；pt回诊 = 5
Private mblnModal As Boolean
Private mfrmParent As Object
Private mMainPrivs As String
Private mlng病人ID As Long
Private mstr挂号单 As String '病人挂号单据号
Private mlng挂号ID As Long
Private mlng合同单位ID As Long
Private mlng前提ID As Long '医技工作站下医嘱时用
Private mstr前提IDs As String
Private mlng医技科室ID As Long
Private mint婴儿 As Integer '修改时用
Private mlng医嘱ID As Long '修改时用
Private mblnCancle As Boolean   '保存时验证
Private mstr自定义申请单IDs As String 'ID1,名称1|ID2,名称2・・・
Private mlng拖动行 As Long '鼠标拖动设置一并给药起始行号
Private mdbl预交款 As Double '病人预交款

Private mlng路径状态 As Long    '(暂时没有用-1)0-不符合导入条件，1-执行中，2-正常结束，3-变异结束
Private mbln未评估 As Boolean '当前天数未评估
Private mblnPathSend As Boolean '当天（服务器当前时间）是否生成了路径项目
Private mstr当前日期 As String  '路径当前日期
Private mdatSendTime As Date   '路径生成时间
Private mrsPPati As ADODB.Recordset       '当 mlng路径状态=1 and mbytUseType=0 缓存临床路径病人信息 字段:路径记录id,当前阶段id,当前天数,日期
Private mstrAdivceOfPath As String  '临床路径传入，医嘱内容ID:婴儿序号:路径项目ID,...，例：227:0:38,335:1:69
                                    '路径外项目重新进入时，传入之前插入的事务未提交的医嘱ID,你：2314,2315,2316
Private mdat开始时间 As Date        '生成路径项目医嘱的开始时间，可能是生成当天以前的（补录）,添加路径外项目时，传入的是病人路径最后一次生成的当前日期
                                    
Private mrsLastAdvice As ADODB.Recordset    '重新生成医嘱集，字段包括：项目id,病人医嘱ID，组id,诊疗项目id,是按医嘱生成的序号升序排的
Private mrsAdvice调序 As ADODB.Recordset    '医嘱调整顺序时用

'出口参数
Private mstrAdviceOfItem As String  'bytUseType=1时，返回给临床路径的路径项目ID与医嘱ID的串
'                                    bytUseType=2时，传入医嘱ID串,此时事务还没有提交，例：2315,2316
Private marrSQL As Variant          '临床路径调用时返回医嘱保存和校对的SQL集
Private mstr路径项目IDs As String   '路径生成时中医修改了的配方的，且超出了允许修改配方的比例的项目，对应的变异原因：项目ID1|变异编码1,项目2|变异编码2・・・・
Private mdatPathOut As Date         'bytUseType=2时,返回医嘱开始日期,bytUseType=0时,记录路径外项目开始时间

'程序变量
Private mobjVBA As Object
Private mobjScript As clsScript
Private mrsDefine As ADODB.Recordset '医嘱内容定义
Private mrsDrugScale As ADODB.Recordset '常用剂量比例
Private mrsPrice As ADODB.Recordset '医嘱对应的收费项目信息集
Private mrsCommonItem As ADODB.Recordset '项目常用列表
Private mrsCommonDiag As ADODB.Recordset
Private mlngID序列 As Long '假医嘱ID，用负数表示
Private mstrDel输血 As String '记录需要被删除的输血医嘱ID，仅记录主医嘱ID

Private WithEvents mfrmSend As frmOutAdviceSend
Attribute mfrmSend.VB_VarHelpID = -1
Private WithEvents mfrmShortCut As frmClinicShortCut
Attribute mfrmShortCut.VB_VarHelpID = -1
Private WithEvents mfrmPrice As frmAdvicePrice
Attribute mfrmPrice.VB_VarHelpID = -1
Private mobjPatient As Object '病人信息对象
Private mobjKeyBoard As Object '屏幕键盘对象动态创建
Private mcolStock1 As Collection '存放各个药品库房的出库检查方式
Private mcolStock2 As Collection '存放各个卫材库房的出库检查方式
Private mstrDelIDs As String '记录需要被删除的医嘱ID
Private mstrAduitDelIDs As String '处方审查已审查的假删除
Private mstr性别 As String '用于项目输入限制判断
Private mint年龄 As Integer '病人的整数年龄
Private mDat出生日期 As Date '病人出生日期
Private mdbl门诊号 As Double  '病人门诊号 PASS =3-太元通
Private mstr姓名 As String
Private mstr身份证号 As String
Private mstr费别 As String
Private mdat挂号时间 As Date '用于相关判断
Private mlng病人科室id As Long '病人(挂号)科室ID
Private mint险类 As Integer '当前病人险类
Private mstr付款码 As String '当前病人医疗付款方式编码
Private mbln中医 As Boolean
Private mbln性质中医 As Boolean '部门性质"中医科"
Private mbln录中医诊断 As Boolean '参数：门诊西医科允许录入中医诊断
Private mint家属 As Integer  '0－无家属，1－只有一个家属，〉1 多个家属
Private mblnReturn As Boolean
Private mblnIsInHelp As Boolean
Private mclsMipModule As zl9ComLib.clsMipModule
 
Private mlng挂号科室ID As Long
Private mblnMoved As Boolean
Private mbln天数反算 As Boolean
Private msngPre天数 As Single
Private mdblPre总量 As Double
Private mblnNoRefresh As Boolean '不刷新界面
Private mcolSubForm As Collection '扩展页签对象集合
Private mrsSubForm As ADODB.Recordset 'ZLHIS页签对象相关信息
Private mcolDE As Collection '老新病历页签
Private mlngCommonID As Long   '最后点击的常用项目
'PASS
Private mobjPassMap As Object  'PASS 窗体对象映射
Private mblnPass As Boolean  'PASS权限

'本地参数
Private mint简码 As Integer
Private mstrLike As String
Private mbln自动皮试 As Boolean
Private mbln天数 As Boolean
Private msng天数 As Single
Private mbln单量 As Boolean
Private mblnStaKB As Boolean '是否自动启用屏幕键盘
Private mbln提醒对码 As Boolean
Private mblnAutoClose As Boolean
Private mblnAddAgent As Boolean '是否要求登记毒麻药品代办人信息
Private mblnNewLIS As Boolean
Private mstrPurMed As String  '抗菌药物缺省用药目的 "1"-预防，"2"-治疗，"0"-下达时确定
Private mbytSize As Byte
Private mrsDiag  As ADODB.Recordset '西医诊断记录集
Private mblnFreeInput As Boolean
Private mbln复诊 As Boolean  '当前病人是否复诊
Private mrs诊断 As ADODB.Recordset
Private mrsAD As ADODB.Recordset '诊断医嘱对应关系
Private mlngDSeq As Long '模拟诊断的序列
Private mrsComD As ADODB.Recordset '显示出来的几条常用诊断
Private mrsLasD As ADODB.Recordset '上次诊断
Private mstr药品价格等级 As String '病人的药品价格等级
Private mstr卫材价格等级 As String '病人的卫材价格等级
Private mstr普通项目价格等级 As String '病人的普通项目价格等级
Private mlng中药味数 As Long    '中药配方允许修改的中药味数上限比例
Private mlng危急值ID As Long

Private mblnDocInput As Boolean '快捷病历相关
Private mblnSizeTmp As Boolean
Private mblnPatiChange As Boolean
Private mlng病历id As Long '
Private mlng病历文件id As Long
Private mbln是否签名 As Boolean
Private mstr保存人 As String
Private mstr婚姻状况 As String
Private mrsMainInfo As ADODB.Recordset
Private mblnChange As Boolean
Private mclsUnZip As Object
Private mclsZip As Object
Private mcls病历功能 As Object
Private WithEvents mobjEPRDoc As zlRichEPR.cEPRDocument
Attribute mobjEPRDoc.VB_VarHelpID = -1
Private mrsHotPlugIn As ADODB.Recordset '快捷键执行外挂功能

'事件状态控制变量
Private mblnRowMerge As Boolean
Private mblnNoSave As Boolean
Private mblnRunFirst As Boolean
Private mblnRowChange As Boolean
Private mblnDoCheck As Boolean
Private mbytPatiType As Byte  '病人类型，1 普通，2 急诊
'门诊疗程天数，急诊3天，普通7天
Private Const conEmergency = 3
Private Const conOrdinary = 7

'工具栏命令
Private Const conMenu_New = 100
Private Const conMenu_Insert = 101
Private Const conMenu_Delete = 102
Private Const conMenu_Merge = 104
Private Const conMenu_Copy = 105
Private Const conMenu_Scheme = 106
Private Const conMenu_Save = 107
Private Const conMenu_Sign = 108
Private Const conMenu_Reference = 109
Private Const conMenu_Help = 110
Private Const conMenu_Exit = 111
Private Const conMenu_Agent = 112
Private Const conMenu_Send = 205
Private Const conMenu_DrugScale = 300
Private Const conMenu_SchemeInSide = 400
Private Const conMenu_AltAdvice = 500

Private Const conMenu_Blankoff = 3005
Private Const conMenu_AdvicePay = 3006
Private Const BackColorNew = &HD0FFFF   '浅黄色
'执行时间示例
Private Const COL_按周执行 = _
    "每周三次 1/8-3/8-5/8 或 1/8:00-3/8:00-5/8:00" & vbCrLf & _
        vbTab & "表示在每周星期一的8:00,星期三的8:00,星期五的8:00这几个时间执行"
Private Const COL_按天执行 = _
    "每天三次 8-12-16 或 8:00-12:00-16:00" & vbCrLf & _
        vbTab & "表示在每天8:00,12:00,16:00这几个时间执行" & vbCrLf & _
    "两天一次 1/8 或 1/8:00" & vbCrLf & _
        vbTab & "表示在每两天中的第1天8:00这个时间执行"
Private Const COL_按时执行 = _
    "每小时两次 1:20-1:40" & vbCrLf & _
        vbTab & "表示在每小时内的20和40分钟这两个时间执行" & vbCrLf & _
    "两小时一次 2:30 或 1:30 或 1:00" & vbCrLf & _
        vbTab & "表示在每两小时内的第2的个小时的30分钟这个时间执行" & vbCrLf & _
        vbTab & "　或在每两小时内的第1的个小时的30分钟这个时间执行" & vbCrLf & _
        vbTab & "　或在每两小时内的第1的个小时这个时间执行"

'固定列
Private Const COL_F标志 = 0 '自由录入，紧急，补录,抗菌用药审核状态
'可见列索引
Private Const COL_选择 = 1
Private Const COL_警示 = 2 'Pass:以字符串类型处理,空表示没有审查结果
Private Const COL_诊断 = 3
Private Const COL_开始时间 = 4
Private Const COL_并 = 5
Private Const col_医嘱内容 = 6
Private Const COL_总量 = 7
Private Const COL_总量单位 = 8
Private Const COL_单量 = 9
Private Const COL_单量单位 = 10
Private Const COL_天数 = 11
Private Const COL_频率 = 12
Private Const COL_用法 = 13
Private Const COL_医生嘱托 = 14 'Data用于存放摘要(医保)
Private Const COL_执行时间 = 15
Private Const COL_开嘱医生 = 16
Private Const COL_超量说明 = 17  '药品超量说明
Private Const COL_基本药物 = 18

'隐藏列索引
Private Const COL_EDIT = 19 '编辑标志：0-原始的,1-新增的,2-修改了内容,3-修改了序号,它的Data值=新下的成套方案ID
Private Const COL_相关ID = COL_EDIT + 1
Private Const COL_婴儿 = COL_EDIT + 2
Private Const COL_序号 = COL_EDIT + 3  'Pass:Data值用于记录是否更改了审核结果
Private Const COL_状态 = COL_EDIT + 4  '病人医嘱记录.状态，Data值记录该医嘱是否已进行了医保管控检查
Private Const COL_类别 = COL_EDIT + 5  '门诊没有自由录入医嘱(*)，AdviceSet成套项目中Nvl(类别,'*')只是为了预防万一
Private Const COL_诊疗项目ID = COL_EDIT + 6
Private Const COL_名称 = COL_EDIT + 7
Private Const COL_标本部位 = COL_EDIT + 8
    Private Const COL_手术时间 = COL_EDIT + 8
    Private Const COL_输血时间 = COL_EDIT + 8
Private Const COL_检查方法 = COL_EDIT + 9
    Private Const COL_中药形态 = COL_EDIT + 9 '0=散装，1=中药饮片，2=免煎剂
Private Const COL_执行标记 = COL_EDIT + 10
Private Const COL_收费细目ID = COL_EDIT + 11
Private Const COL_频率次数 = COL_EDIT + 12
Private Const COL_频率间隔 = COL_EDIT + 13
Private Const COL_间隔单位 = COL_EDIT + 14
Private Const COL_计价性质 = COL_EDIT + 15
Private Const COL_执行科室ID = COL_EDIT + 16
Private Const COL_执行性质 = COL_EDIT + 17 '病人医嘱记录.执行性质=诊疗项目目录.执行科室
Private Const COL_开嘱科室ID = COL_EDIT + 18
Private Const COL_开嘱时间 = COL_EDIT + 19
Private Const COL_标志 = COL_EDIT + 20     '0-普通,1-紧急，2-补录

Private Const COL_计算方式 = COL_标志 + 1 '诊疗项目目录.计算方式
Private Const COL_频率性质 = COL_标志 + 2 '诊疗项目目录.执行频率
Private Const COL_操作类型 = COL_标志 + 3 '诊疗项目目录.操作类型
Private Const COL_执行分类 = COL_标志 + 4 '诊疗项目目录.执行分类
Private Const COL_库存 = COL_标志 + 5 '按门诊包装存放的可用库存
Private Const COL_可否分零 = COL_标志 + 6 '卫材用于存放是否跟踪在用 flexcpdata用于缓存卫材分零
    Private Const COL_跟踪在用 = COL_标志 + 6
Private Const COL_剂量系数 = COL_标志 + 7
Private Const COL_门诊单位 = COL_标志 + 8
Private Const COL_门诊包装 = COL_标志 + 9
Private Const COL_处方限量 = COL_标志 + 10 '非药诊疗项目为录入限量
Private Const COL_处方职务 = COL_标志 + 11
Private Const COL_毒理分类 = COL_标志 + 12
Private Const COL_药品剂型 = COL_标志 + 13
Private Const COL_单价 = COL_标志 + 14
Private Const COL_签名否 = COL_标志 + 15
Private Const COL_附项 = COL_标志 + 16
Private Const COL_零费记帐 = COL_标志 + 17
Private Const COL_抗菌等级 = COL_标志 + 18 '抗菌药物等级:0-非抗菌药,1-非限制级,2-限制级,3-特殊使用级
Private Const COL_用药目的 = COL_标志 + 19
Private Const COL_用药理由 = COL_标志 + 20
Private Const COL_审核状态 = COL_标志 + 21 '抗菌药物审核状态：Null-无需审核，1-待审核，2-审核通过，3-审核未通过
Private Const COL_免试 = COL_标志 + 22    '是否免试   1-免试，0-不免试
Private Const COL_是否超量 = COL_标志 + 23   '药品是否超量
Private Const COL_是否超期 = COL_标志 + 24
Private Const COL_配方ID = COL_标志 + 25
Private Const COL_临床自管药 = COL_标志 + 26
Private Const COL_高危药品 = COL_标志 + 27
Private Const COL_组合项目ID = COL_标志 + 28
Private Const COL_是否停用 = COL_标志 + 29 '=1标识已停用，=0或NULL标识未停用
Private Const COL_是否溶媒 = COL_标志 + 30 '=1溶媒
Private Const COL_申请序号 = COL_标志 + 31 '.Cell(flexcpData, Row, COL_申请序号) Row－组医嘱行号  存的是申请单的申请信息，手术/输血/检验 记录集rsCard；检查 字符串
Private Const COL_处方审查状态 = COL_标志 + 32
Private Const COL_处方审查结果 = COL_标志 + 33
Private Const COL_禁忌药品说明 = COL_标志 + 34
Private Const COL_路径项目ID = COL_标志 + 35
Private Const COL_路径执行方式 = COL_标志 + 36
Private Const COL_是否备选 = COL_标志 + 37
Private Const COL_医嘱内容ID = COL_标志 + 38
Private Const COL_路径项目分类 = COL_标志 + 39
Private Const COL_原始中药配方 = COL_标志 + 40
Private Const COL_路径执行ID = COL_标志 + 41
Private Const COL_处方序号 = COL_标志 + 42    '合理用药监测用
Private Const COL_危急值ID = COL_标志 + 43
Private Const COL_皮试结果 = COL_标志 + 44 '检验医嘱存的，耐受试验时间ID；皮试医嘱是存的皮试结果，Cell(flexcpData 值提交到数据库
Private Const COL_易跌倒 = COL_标志 + 45

Private Const COL_C_项目名称 = 0
Private Const COL_C_项目ID = 1
Private Const COL_C_药品ID = 2
Private Const COL_C_人员ID = 3
Private Const COL_C_科室ID = 4

Private Const M_LNG_DIAGCOUNT = 10 '最大诊断数


Private Const conMenu_Tool_Diag = 99999   '诊断右键外挂菜单插件
Private Const conMenu_Tool_Diag_items = 999990   '诊断右键外挂菜单插件选项

Private Type AGENT_INFO
    代办人姓名      As String
    代办人身份证号  As String
    代办人性别      As String
    代办人年龄      As String
    代办人电话      As String
    本次就诊已录入  As Boolean
    用药理由        As String
End Type

Private AgentInfo As AGENT_INFO

Private COL中医 As Long
Private COL西医 As Long
Private Enum DCOL_ENUM_诊断
    col标志 = 0
'    COL中医 = 1 '被两个模块变量替换了，表格  中西/西中两种显示方式
'    COL西医 = 2
    col编码 = 3
    col诊断 = 4
    col中医证候 = 5
    col发病时间 = 6
    col疑诊 = 7
    COL增加 = 8
    col诊断ID = 9
    col疾病ID = 10
    col证候ID = 11
    colICD码 = 12
    col医嘱ID = 13
    colDel = 14
    COL诊断编码 = 15
    COL疾病编码 = 16
    COL疾病类别 = 17
    COL疾病附码 = 18
    COL证候编码 = 19
    COL导入诊断 = 20 '用于标记路径导入诊断,不允许编辑
    
'常用诊断表格和上次诊断表格
    COL类型 = 0
    col诊断内容 = 1
    col项目ID = 2
End Enum

Private Enum E_CTL_INDEX
    e医嘱下达 = 0
    e门诊病历 = 1
    e复诊病历 = 2
    e常用项目 = 3
    e临时用 = 70
    
    e新增 = 4
    e诊断表格 = 24
    e成套方案 = 25
    e常用检验 = 26
    e常用检查 = 27
    e常用药品 = 28
    
    c诊断 = 0
    c证候 = 1
    c发病时间 = 2
    
    tbc成套 = 0
    tbc检验 = 1
    tbc检查 = 2
    tbc药品 = 3
    
    Common_项目名称 = 0
    Common_诊疗项目ID = 1
    Common_药品ID = 2
    
    txt主诉 = 0
    txt家族史 = 3
    txt现病史 = 1
    txt查体 = 4
    txt过去史 = 2
End Enum

Public Function ShowMe(ByVal frmParent As Object, ByVal int场合 As Integer, ByVal MainPrivs As String, ByVal lng病人ID As Long, ByVal str挂号单 As String, _
    Optional ByVal lng前提ID As Long, Optional ByVal int婴儿 As Integer, Optional ByVal lng医嘱ID As Long, Optional ByVal blnModal As Boolean, _
    Optional ByVal lng界面科室ID As Long, Optional ByVal str前提IDs As String, Optional ByRef objMip As Object, Optional ByVal lng挂号科室ID As Long, _
    Optional ByVal blnMoved As Boolean, Optional ByVal int就诊类型 As Integer, Optional ByVal lng危急值ID As Long) As Boolean

    Set mfrmParent = frmParent
    mbytUseType = 0
    mint场合 = int场合
    mblnModal = blnModal
    mMainPrivs = MainPrivs
    mlng病人ID = lng病人ID
    mstr挂号单 = str挂号单
    mlng前提ID = lng前提ID
    mstr前提IDs = str前提IDs
    mlng医技科室ID = IIF(mlng前提ID <> 0, lng界面科室ID, 0)
    mint婴儿 = int婴儿
    mlng挂号科室ID = lng挂号科室ID
    mblnMoved = blnMoved
    mlng医嘱ID = lng医嘱ID
    mint就诊类型 = int就诊类型
    mlng危急值ID = lng危急值ID
    If InitObjPublicExpense Then Call gobjPublicExpense.zlGetPriceGrade(gstrNodeNo, mlng病人ID, 0, "", mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级)

    If Not (objMip Is Nothing) Then Set mclsMipModule = objMip
    Me.Show IIF(blnModal, 1, 0), frmParent
    ShowMe = mblnOK
End Function

Public Function ShowMeByPath(frmParent As Object, ByVal int场合 As Integer, ByVal MainPrivs As String, ByVal bytUseType As Byte, ByVal lng病人ID As Long, ByVal str挂号单 As String, _
    ByVal strAdivceOfPath As String, ByVal dat开始时间 As Date, arrSQL As Variant, strAdviceOfItem As String, Optional ByVal rsLastAdvice As ADODB.Recordset, _
   Optional ByVal datSendTime As Date, Optional ByRef str路径项目IDs As String, Optional ByRef objMip As Object, Optional ByRef datPathOut As Date, _
   Optional ByVal lng挂号科室ID As Long) As Boolean
'说明：临床路径生成调用
'参数：
'   注意：此接口传入给模块变量的共用变量，一定要在Form_unload中设置初始值，否则医嘱接口ShowMe调用时会重用这些值
'   bytUseType      =1:路径生成,2=添加路径外项目
'   strAdivceOfPath =bytUseType=1时，传入医嘱内容ID:婴儿序号:路径项目ID,...，例：227:0:38,335:1:69
'                   =bytUseType=2时，传入医嘱ID串,此时事务还没有提交，例：2315,2316
'   arrSQL          =医嘱保存和校对的SQL
'   strAdviceOfItem =bytUseType=1时，路径项目与医嘱ID的对应,例：38:1983,69:1978
'                   =bytUseType=2时，传入医嘱ID串,此时事务还没有提交，例：2315,2316
'   rsLastAdvice    =bytUseType=1时，传入重新生成路径项目首次生成的医嘱记录集，字段包括：项目id,病人医嘱ID，组id,诊疗项目id,是按医嘱生成的序号升序排的
'   datSendTime    =bytUseType=1时，传入路径的生成时间
'      str路径项目IDs   =路径生成时中医修改了的配方的，且超出了允许修改配方的比例的项目，对应的变异原因：项目ID1|变异编码1,项目2|变异编码2・・・・
'   datPathOut       =bytUseType=2时,返回医嘱的开始日期,此日期用于确定该路径外项目添加到路径表单的某一天。
'   lng挂号科室ID    挂号科室ID
    mbytUseType = bytUseType
    
    mblnModal = True
    Set mfrmParent = frmParent
    mint场合 = int场合
    mbytUseType = bytUseType
    mMainPrivs = MainPrivs
    mlng病人ID = lng病人ID
    mstr挂号单 = str挂号单
    mdatSendTime = datSendTime
    mstr路径项目IDs = str路径项目IDs
    If Not (objMip Is Nothing) Then Set mclsMipModule = objMip
    mstrAdivceOfPath = strAdivceOfPath
    Set mrsLastAdvice = rsLastAdvice
    mdat开始时间 = dat开始时间
    mlng挂号科室ID = lng挂号科室ID
    
    mstrAdviceOfItem = ""
    mdatPathOut = datPathOut
    mlng路径状态 = 1
    Set marrSQL = Nothing
    If InitObjPublicExpense Then Call gobjPublicExpense.zlGetPriceGrade(gstrNodeNo, mlng病人ID, 0, "", mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级)
  
    On Error Resume Next
    Me.Show IIF(mblnModal, 1, 0), frmParent
    arrSQL = marrSQL
    
    If mbytUseType = 2 And mstrAdivceOfPath <> "" Then
        strAdviceOfItem = mstrAdivceOfPath      '重新进入后，未做编辑，直接退出，则保持不变,arrSQL不返回
    Else
        strAdviceOfItem = mstrAdviceOfItem
    End If
    datPathOut = mdatPathOut
    str路径项目IDs = mstr路径项目IDs
    ShowMeByPath = mblnOK
End Function

Private Sub InitCommandBar()
'功能：初始化工具栏
    Dim objBar As CommandBar
    Dim objControl As CommandBarControl
    Dim objPopup As CommandBarPopup
    Dim objMenu As CommandBarPopup
    Dim blnTwo As Boolean, lng合同单位ID As Long, bln单位记帐 As Boolean
    
    Dim varArr As Variant
    Dim strTmp As String
    Dim intTmp As Integer
    Dim strName As String
    Dim lngID As Long
    Dim i As Long
    Dim strInsidePrivs As String
    
    strInsidePrivs = GetInsidePrivs(p门诊医嘱下达)
    
    lng合同单位ID = Get合同单位ID
    bln单位记帐 = Val(zlDatabase.GetPara("单位记帐", glngSys, p门诊医嘱下达)) <> 0
    
    blnTwo = Val(zlDatabase.GetPara("发送单据类型", glngSys, p门诊医嘱下达)) <> 2 Or _
             Val(zlDatabase.GetPara("发送单据类型", glngSys, p门诊医嘱下达)) = 2 And _
             (InStr(strInsidePrivs, "发送为记帐单") = 0 Or _
            InStr(strInsidePrivs, "发送为收费单") = 0 Or _
            bln单位记帐 And lng合同单位ID = 0)
            
    If bln单位记帐 And lng合同单位ID = 0 Or _
        InStr(strInsidePrivs, "零费记帐") = 0 Or _
        InStr(strInsidePrivs, "发送为记帐单") = 0 Or _
        Val(zlDatabase.GetPara("发送单据类型", glngSys, p门诊医嘱下达)) = 0 Then
        '是否显示零费记帐
        chkZeroBilling.Visible = False
    End If
    
    CommandBarsGlobalSettings.App = App
    CommandBarsGlobalSettings.ResourceFile = CommandBarsGlobalSettings.OcxPath & "\XTPResourceZhCn.dll"
    CommandBarsGlobalSettings.ColorManager.SystemTheme = xtpSystemThemeAuto
    cbsMain.VisualTheme = xtpThemeOffice2003
    With Me.cbsMain.Options
        .ShowExpandButtonAlways = False
        .ToolBarAccelTips = True
        .AlwaysShowFullMenus = False
        .IconsWithShadow = True '放在VisualTheme后有效
        .UseDisabledIcons = True
        .LargeIcons = True
        .SetIconSize True, 24, 24
        .SetIconSize False, 16, 16
    End With
    cbsMain.EnableCustomization False
    cbsMain.ActiveMenuBar.Visible = False
    Set cbsMain.Icons = frmIcons.imgMain.Icons
    
    '菜单
    Set objMenu = cbsMain.ActiveMenuBar.Controls.Add(xtpControlPopup, conMenu_EditPopup, "药嘱审查", -1, False)
    objMenu.ID = conMenu_EditPopup
    With objMenu.CommandBar.Controls
        '插件扩展功能
        Call CreatePlugInOK(p门诊医嘱下达, mint场合)
        If Not gobjPlugIn Is Nothing Then
            Set objPopup = .Add(xtpControlButtonPopup, conMenu_Tool_PlugIn, "扩展功能")
            objPopup.BeginGroup = True
        End If
           If Not gobjDrugExplain Is Nothing And InStr(strInsidePrivs, ";药品说明书;") > 0 Then
            Set objControl = .Add(xtpControlButton, conMenu_Edit_ViewDrugExplain, "查看药品说明书")
            objControl.IconId = 3205
        End If
    End With
    
    Set objMenu = cbsMain.ActiveMenuBar.Controls.Add(xtpControlPopup, conMenu_ViewPopup, "诊断审查", -1, False)
    objMenu.ID = conMenu_ViewPopup
     '插件扩展功能
    Call CreatePlugInOK(p门诊医嘱下达, mint场合)
    If Not gobjPlugIn Is Nothing Then
        Set objPopup = objMenu.CommandBar.Controls.Add(xtpControlButtonPopup, conMenu_Tool_Diag, "扩展功能")
        objPopup.BeginGroup = True
    End If
    
    
    
    '生成工具栏
    Set objBar = cbsMain.Add("工具栏", xtpBarTop)
    With objBar.Controls
        Set objControl = .Add(xtpControlButton, conMenu_New, "增加")
        Set objControl = .Add(xtpControlButton, conMenu_Insert, "插入")
        Set objControl = .Add(xtpControlButton, conMenu_Delete, "删除")
        Set objControl = .Add(xtpControlButton, conMenu_Blankoff, "作废")
 
        If mint场合 = 0 Then '只有门诊医生工作站调用时才有这几个按钮
            intTmp = Val(Mid(gstrOutUseApp, 1, 1))
            If intTmp = 1 Then strTmp = strTmp & ",检查申请:" & conMenu_Edit_PacsApply
            intTmp = Val(Mid(gstrOutUseApp, 2, 1))
            If intTmp = 1 And Not gobjLIS Is Nothing Then strTmp = strTmp & ",检验申请:" & conMenu_Edit_LISApply
            intTmp = Val(Mid(gstrOutUseApp, 3, 1))
            If intTmp = 1 Then strTmp = strTmp & ",输血申请:" & conMenu_Edit_BloodApply
            intTmp = Val(Mid(gstrOutUseApp, 4, 1))
            If intTmp = 1 Then strTmp = strTmp & ",手术申请:" & conMenu_Edit_OperationApply
            Get自定义申请单 1, mstr自定义申请单IDs
            If mstr自定义申请单IDs <> "" Then
                For i = 0 To UBound(Split(mstr自定义申请单IDs, "|"))
                    strTmp = strTmp & "," & Split(Split(mstr自定义申请单IDs, "|")(i), ",")(1) & ":" & (conMenu_Edit_ApplyCustom * 100# + i) & ":" & Split(Split(mstr自定义申请单IDs, "|")(i), ",")(0)
                Next
            End If
            strTmp = Mid(strTmp, 2)
            
            If strTmp <> "" Then
                If InStr(strTmp, ",") = 0 Then
                    strName = Split(strTmp, ":")(0)
                    lngID = Val(Split(strTmp, ":")(1))
                    Set objControl = .Add(xtpControlButton, lngID, strName)
                        objControl.IconId = conMenu_Edit_PacsApply
                        objControl.ToolTipText = strName
                        objControl.BeginGroup = True
                        If UBound(Split(strTmp, ":")) = 2 Then objControl.Parameter = Val(Split(strTmp, ":")(2))
                Else
                    varArr = Split(strTmp, ",")
                    For i = 0 To UBound(varArr)
                        strTmp = varArr(i)
                        strName = Split(strTmp, ":")(0)
                        lngID = Val(Split(strTmp, ":")(1))
                        
                        If i = 0 Then
                            Set objPopup = .Add(xtpControlSplitButtonPopup, lngID, strName)
                                objPopup.IconId = conMenu_Edit_PacsApply
                                objPopup.BeginGroup = True
                                objPopup.ToolTipText = strName
                                With objPopup.CommandBar.Controls
                                    Set objControl = .Add(xtpControlButton, lngID * 10# + 1, strName)
                                End With
                        Else
                            Set objControl = objPopup.CommandBar.Controls.Add(xtpControlButton, lngID, strName)
                        End If
                        If UBound(Split(strTmp, ":")) = 2 Then objControl.Parameter = Val(Split(strTmp, ":")(2))
                    Next
                End If
            End If
        End If
        
        Set objControl = .Add(xtpControlButton, conMenu_Merge, "一并给药"): objControl.BeginGroup = True
        If InStr(strInsidePrivs, ";复制医嘱;") > 0 Then
            Set objControl = .Add(xtpControlButton, conMenu_Copy, "复制医嘱")
        End If
        Set objPopup = .Add(xtpControlSplitButtonPopup, conMenu_Scheme, "成套方案")
        objPopup.ToolTipText = "保存为成套方案"
        With objPopup.CommandBar.Controls
            .Add xtpControlButton, conMenu_Scheme * 10# + 1, "保存为成套方案"
            .Add xtpControlButton, conMenu_Scheme * 10# + 2, "显示成套方案选择器"
        End With
        
        Set objControl = .Add(xtpControlButton, conMenu_Agent, "代办人")
        Set objControl = .Add(xtpControlButton, conMenu_Save, "保存"): objControl.BeginGroup = True
        Set objControl = .Add(xtpControlButton, conMenu_Sign, "签名")
        '门诊临床路径用
        If mbytUseType = 1 Then Set objControl = .Add(xtpControlButton, conMenu_AltAdvice, "备选"): objControl.BeginGroup = True: objControl.IconId = 205
        If blnTwo Then
            Set objPopup = .Add(xtpControlSplitButtonPopup, conMenu_Send, "发送")
            objPopup.ToolTipText = "自动完成发送(F3)"
            With objPopup.CommandBar.Controls
                .Add xtpControlButton, conMenu_Send * 10# + 1, "自动完成发送"
                .Add xtpControlButton, conMenu_Send * 10# + 2, "医嘱发送处理"
            End With
        Else
            Set objControl = .Add(xtpControlButton, conMenu_Send, "发送")
        End If
        If InStr(GetInsidePrivs(p门诊医嘱下达), ";诊间无卡支付;") > 0 And Not mblnAutoClose Then
            Set objControl = .Add(xtpControlButton, conMenu_AdvicePay, "诊间支付"): objControl.BeginGroup = True
        End If
        If gbln审方系统 And mbytUseType = 0 Then
            Set objControl = .Add(xtpControlButton, conMenu_Edit_ViewRefcom, "审方结果"): objControl.BeginGroup = True
                objControl.IconId = 3333
        End If
        Set objControl = .Add(xtpControlButton, conMenu_Reference, "参考"): objControl.BeginGroup = True
        Set objControl = .Add(xtpControlButton, conMenu_Help, "帮助")
        Set objControl = .Add(xtpControlButton, conMenu_Exit, "退出")
    End With
    objBar.EnableDocking xtpFlagHideWrap
    objBar.ContextMenuPresent = False
    For Each objControl In objBar.Controls
        If objControl.ID = conMenu_Help Or objControl.ID = conMenu_Exit Or objControl.ID = conMenu_Reference Then
            objControl.Style = xtpButtonIcon
        Else
            objControl.Style = xtpButtonIconAndCaption
        End If
    Next
   
    
    '热键绑定:注意不能和系统的文本编辑热键冲突，以及Form_keydown中的冲突
    With cbsMain.KeyBindings
        .Add 0, vbKeyF2, conMenu_Save
        If blnTwo Then
            .Add 0, vbKeyF3, conMenu_Send * 10# + 1
            .Add FCONTROL, vbKeyG, conMenu_Send * 10# + 2
        Else
            .Add 0, vbKeyF3, conMenu_Send
        End If
        .Add 0, vbKeyF6, conMenu_Reference
        .Add 0, vbKeyF9, conMenu_Merge
        .Add 0, vbKeyF1, conMenu_Help
        .Add FCONTROL, vbKeyA, conMenu_New
        .Add FCONTROL, vbKeyI, conMenu_Insert
        .Add FCONTROL, vbKeyK, conMenu_Merge
        .Add FCONTROL, vbKeyY, conMenu_Copy
        .Add FCONTROL, vbKeyT, conMenu_Scheme
        .Add FCONTROL, vbKeyS, conMenu_Save
        .Add FALT, vbKeyX, conMenu_Exit
    End With
End Sub

Private Sub InitAdviceTable()
'功能：初始化表格内容，用在窗体个性化设置恢复之前
    Dim strHead As String, i As Integer
    Dim arrHead As Variant, arrCol As Variant
    
    If mbytUseType = 1 Then
        strHead = "选择,450,4;"
    Else
        strHead = "选择;"
    End If
    strHead = strHead & _
        ",240,4;诊断,2000,1;生效时间,1530,1;,200,7;医嘱内容,3500,1;总量,600,7;单位,450,1;单量,600,7;单位,450,1;" & _
        "天数,450,1;频率,1200,1;用法,1200,1;医生嘱托,1000,1;执行时间;开嘱医生,850,1;超量说明;基本药物,850,1;" & _
        "EDIT;相关ID;婴儿;序号;医嘱状态;诊疗类别;诊疗项目ID;名称;标本部位;检查方法;执行标记;收费细目ID;" & _
        "频率次数;频率间隔;间隔单位;计价性质;执行科室ID;执行性质;开嘱科室ID;开嘱时间;标志;计算方式;" & _
        "频率性质;操作类型;执行分类;库存;可否分零;剂量系数;门诊单位;门诊包装;处方限量;处方职务;" & _
        "毒理分类;药品剂型;单价;签名否;附项;零费记帐;抗菌等级;用药目的;用药理由;审核状态;免试;" & _
        "是否超量;是否超期;配方ID;临床自管药;高危药品;组合项目ID;是否停用;是否溶媒;申请序号;" & _
        "处方审查状态;处方审查结果;禁忌药品说明;路径项目ID;路径执行方式;是否备选;医嘱内容ID;路径项目分类;原始中药配方;路径执行ID;处方序号;危急值ID;皮试结果;易跌倒"
        
    arrHead = Split(strHead, ";")
    With vsAdvice
        .Clear
        .FixedRows = 1: .FixedCols = 1
        .Rows = 2: .Cols = .FixedCols + UBound(arrHead) + 1

        For i = 0 To UBound(arrHead)
            .FixedAlignment(.FixedCols + i) = 4
            arrCol = Split(arrHead(i), ",")
            .TextMatrix(0, .FixedCols + i) = arrCol(0)
            If UBound(arrCol) > 0 Then
                .ColWidth(.FixedCols + i) = Val(arrCol(1))
                .ColAlignment(.FixedCols + i) = Val(arrCol(2))
                .ColHidden(.FixedCols + i) = False
            Else
                .ColHidden(.FixedCols + i) = True
            End If
        Next
        .ColWidth(0) = 14 * Screen.TwipsPerPixelX
        .ColHidden(COL_警示) = True 'Pass
        
        '列头图标
        Set .Cell(flexcpPicture, 0, COL_警示) = img16.ListImages("警示").Picture
        .Cell(flexcpPictureAlignment, 0, 0, 0, .Cols - 1) = 4
        .AllowUserFreezing = flexFreezeNone
        .SheetBorder = vbBlack
        .AutoSizeMouse = True
    End With
    
    
'----------常用诊断和上次诊断表格的初始化
    strHead = "类型,1000,1;诊断内容,3000,1;项目ID"
    arrHead = Split(strHead, ";")

    With vsDiagComm
        .Clear
        .FixedRows = 1: .FixedCols = 0
        .Rows = 1: .Cols = .FixedCols + UBound(arrHead) + 1
        For i = 0 To UBound(arrHead)
            .FixedAlignment(.FixedCols + i) = 4
            arrCol = Split(arrHead(i), ",")
            .TextMatrix(0, .FixedCols + i) = arrCol(0)
            If UBound(arrCol) > 0 Then
                .ColWidth(.FixedCols + i) = Val(arrCol(1))
                .ColAlignment(.FixedCols + i) = Val(arrCol(2))
                .ColHidden(.FixedCols + i) = False
            Else
                .ColHidden(.FixedCols + i) = True
            End If
        Next
        .Cell(flexcpPictureAlignment, 0, 0, 0, .Cols - 1) = 4
        .MergeCol(0) = True
        .MergeCells = flexMergeFree
        .RowHidden(0) = True
        .Rows = 11
        For i = 1 To .Rows - 1
            .TextMatrix(i, COL类型) = "常用诊断"
        Next
    End With
    
    With vsDiagBefore
        .Clear
        .FixedRows = 1: .FixedCols = 0
        .Rows = 1: .Cols = .FixedCols + UBound(arrHead) + 1
        For i = 0 To UBound(arrHead)
            .FixedAlignment(.FixedCols + i) = 4
            arrCol = Split(arrHead(i), ",")
            .TextMatrix(0, .FixedCols + i) = arrCol(0)
            If UBound(arrCol) > 0 Then
                .ColWidth(.FixedCols + i) = Val(arrCol(1))
                .ColAlignment(.FixedCols + i) = Val(arrCol(2))
                .ColHidden(.FixedCols + i) = False
            Else
                .ColHidden(.FixedCols + i) = True
            End If
        Next
        .Cell(flexcpPictureAlignment, 0, 0, 0, .Cols - 1) = 4
        .MergeCol(0) = True
        .MergeCells = flexMergeFree
        .RowHidden(0) = True
        .Rows = 11
        For i = 1 To .Rows - 1
            .TextMatrix(i, COL类型) = "上次诊断"
        Next
    End With
End Sub

Private Sub Set用法Input(rsInput As ADODB.Recordset, ByVal int类型 As Integer)
'功能：输入给药途径或中药用法后调用
'参数：rsInput=输入或选择的返回记录
'      int类型=2-给药途径,4-中药用法
'说明：如果可选频率,则配合给药途径处理可用执行时间方案的变化
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim blnValid As Boolean, sng天数 As Single
    Dim str频率 As String, int频率次数 As Integer, int频率间隔 As Integer, str间隔单位 As String
    Dim vMsg As VbMsgBoxResult, strMsg As String
    Dim bln用法用量 As Boolean, bln用法频率 As Boolean
    Dim strIDs1 As String, strIDs2 As String, str医嘱内容 As String
    Dim lngPre用法ID As Long
    
    On Error GoTo errH
    lngPre用法ID = Val(cmd用法.Tag)
    cmd用法.Tag = rsInput!ID
    txt用法.Text = rsInput!名称
    txt用法.Tag = "1"
    
    With vsAdvice
        If lngPre用法ID <> Val(cmd用法.Tag) Then .TextMatrix(.Row, COL_单价) = ""
        '非输液类清除滴速
        If int类型 = 2 Then
            If NVL(rsInput!执行分类ID, 0) <> 1 And cbo滴速.Text <> "" Then
                cbo滴速.Text = ""
                cbo滴速.Tag = "1"
            End If
        End If
        
        '重新获取可用的缺省时间方案
        If cbo执行时间.Enabled Then '"可选频率"或药品时
            Call Get时间方案(cbo执行时间, Get频率范围(.Row), .TextMatrix(.Row, COL_频率), rsInput!ID)
            If cbo执行时间.ListCount > 0 Then
                cbo执行时间.ListIndex = 0
                cbo执行时间.Tag = "1"
            Else
                '判断当前执行时间是否合法
                If cbo执行时间.Text <> "" Then
                    blnValid = ExeTimeValid(cbo执行时间.Text, Val(.TextMatrix(.Row, COL_频率次数)), Val(.TextMatrix(.Row, COL_频率间隔)), .TextMatrix(.Row, COL_间隔单位))
                    If Not blnValid Then '如果不合法,则另取,否则保持
                        cbo执行时间.Text = ""
                        cbo执行时间.Tag = "1"
                    End If
                End If
            End If
        End If
        
        '根据诊疗用法用量作缺省设置
        If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
            strSQL = "Select 频次,小儿剂量,成人剂量,医生嘱托,疗程" & _
                " From 药品用法用量 Where 药品ID=[1] And 用法ID=[2] And 性质=1"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(.Row, COL_收费细目ID)), Val(rsInput!ID))
            If rsTmp.EOF Then
                '药品没有设置用法用量，则找给药途径的缺省频率（如果只设置了一个可用频率的话）,之前输入医嘱项目时设置的缺省频率是按编码排序取的第一个
                strSQL = "Select 频次 From 诊疗用法用量 Where 性质>0 And 项目ID=[1] Order by 频次"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!ID))
                bln用法频率 = rsTmp.RecordCount > 0
            Else
                bln用法用量 = True
            End If
            
            If bln用法用量 Or bln用法频率 Then
                If Not IsNull(rsTmp!频次) Then
                    Call Get频率信息_编码(rsTmp!频次, str频率, int频率次数, int频率间隔, str间隔单位)
                    txt频率.Text = str频率
                    cmd频率.Tag = str频率
                    txt频率.Tag = "1"
                End If
                
                '根据新的频率重新设置执行时间
                If cbo执行时间.Enabled Then
                    Call Get时间方案(cbo执行时间, Get频率范围(.Row), str频率, rsInput!ID)
                    If cbo执行时间.ListCount > 0 Then
                        cbo执行时间.ListIndex = 0
                        cbo执行时间.Tag = "1"
                    Else
                        '判断当前执行时间是否合法
                        If cbo执行时间.Text <> "" Then
                            blnValid = ExeTimeValid(cbo执行时间.Text, int频率次数, int频率间隔, str间隔单位)
                            If Not blnValid Then '如果不合法,则另取,否则保持
                                cbo执行时间.Text = ""
                                cbo执行时间.Tag = "1"
                            End If
                        End If
                    End If
                End If
                
                If bln用法用量 Then
                    '药品单量
                    If mint年龄 > 12 Then
                        If NVL(rsTmp!成人剂量, 0) <> 0 Then
                            txt单量.Text = FormatEx(rsTmp!成人剂量, 5)
                            txt单量.Tag = "1"
                        End If
                    Else
                        If NVL(rsTmp!小儿剂量, 0) <> 0 Then
                            txt单量.Text = FormatEx(rsTmp!小儿剂量, 5)
                            txt单量.Tag = "1"
                        ElseIf NVL(rsTmp!成人剂量, 0) <> 0 Then
                            txt单量.Text = FormatEx(rsTmp!成人剂量 * (mint年龄 + 2) * 5 / 100, 5)
                            txt单量.Tag = "1"
                        End If
                    End If
                    
                    '取缺省的天数
                    sng天数 = msng天数
                    If mbln天数 Then
                        If str间隔单位 = "周" Then
                            sng天数 = IIF(7 > sng天数, 7, sng天数)
                        ElseIf str间隔单位 = "天" Then
                            sng天数 = IIF(int频率间隔 > sng天数, int频率间隔, sng天数)
                        ElseIf str间隔单位 = "小时" Then
                            sng天数 = IIF(int频率间隔 \ 24 > sng天数, int频率间隔 \ 24, sng天数)
                        ElseIf str间隔单位 = "分钟" Then
                            If sng天数 = 0 Then sng天数 = 1
                        End If
                        If sng天数 = 0 Then sng天数 = 1
                    End If
                    If NVL(rsTmp!疗程, 1) > sng天数 Then
                        sng天数 = NVL(rsTmp!疗程, 1)
                    End If
                    If Val(.TextMatrix(.Row, COL_天数)) > sng天数 Then
                        sng天数 = Val(.TextMatrix(.Row, COL_天数))
                    End If
                    If Val(.TextMatrix(.Row, COL_天数)) <> sng天数 Then
                        txt天数.Text = sng天数
                        txt天数.Tag = "1"
                    End If
                    
                    '药品临嘱总量:门诊包装
                    If str频率 <> "" And Val(txt单量.Text) <> 0 _
                        And Val(.TextMatrix(.Row, COL_剂量系数)) <> 0 _
                        And Val(.TextMatrix(.Row, COL_门诊包装)) <> 0 Then
                        
                        txt总量.Text = FormatEx(Calc缺省药品总量( _
                            Val(txt单量.Text), sng天数, _
                            int频率次数, int频率间隔, str间隔单位, _
                            .TextMatrix(.Row, COL_执行时间), _
                            Val(.TextMatrix(.Row, COL_剂量系数)), _
                            Val(.TextMatrix(.Row, COL_门诊包装)), _
                            Val(.TextMatrix(.Row, COL_可否分零))), 5)
                        If InStr(GetInsidePrivs(p门诊医嘱下达), "药品小数输入") = 0 Then
                            txt总量.Text = IntEx(Val(txt总量.Text))
                        ElseIf Val(.TextMatrix(.Row, COL_可否分零)) <> 0 Then
                            txt总量.Text = IntEx(Val(txt总量.Text))
                        End If
                        txt总量.Tag = "1"
                    End If
                    
                    '医生嘱托
                    If Not IsNull(rsTmp!医生嘱托) Then
                        cbo医生嘱托.Text = rsTmp!医生嘱托
                        cbo医生嘱托.Tag = "1"
                    End If
                End If
            End If
        End If
    End With
    
    '处理当前医嘱给药途径/煎法的变化
    Call AdviceChange
    
    '对保险对码进行检查
    Call GetInsureStr(strIDs1, strIDs2, str医嘱内容, vsAdvice.Row)
    strMsg = CheckAdviceInsure(mint险类, mbln提醒对码, mlng病人ID, 1, strIDs1, strIDs2, str医嘱内容)
    If strMsg <> "" Then
        If gint医保对码 = 2 Then strMsg = strMsg & vbCrLf & vbCrLf & "请先和相关人员联系处理，否则医嘱将不允许保存。"
        vMsg = frmMsgBox.ShowMsgBox(strMsg, Me, True)
        If vMsg = vbIgnore Then mbln提醒对码 = False
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub Set频率Input(rsInput As ADODB.Recordset, ByVal int范围 As Integer)
'功能：输入执行频率后调用
'参数：rsInput=输入或选择的返回记录
'      int范围=1-西医;2-中医;-1-一次性;-2-持续性
'说明：配合用法处理可用执行时间方案的变化
    Dim lng用法ID As Long, blnValid As Boolean
    Dim sng天数 As Single, dbl总量 As Double
    Dim lngRow As Long
    
    cmd频率.Tag = rsInput!名称
    txt频率.Text = rsInput!名称
    txt频率.Tag = "1"
        
    With vsAdvice
        '先设置执行时间的可用性:分钟频率切换
        lngRow = GetBaseRow(.Row)
        If Val(.TextMatrix(lngRow, COL_频率性质)) = 0 Or InStr(",5,6,7,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            If Not cbo执行时间.Enabled Then SetItemEditable , , , , 1
        Else
            If cbo执行时间.Enabled Then SetItemEditable , , , , -1
        End If
        
        If cbo执行时间.Enabled Then '"可选频率"或药品时
            If rsInput!间隔单位 = "分钟" Then
                If cbo执行时间.Text <> "" Then cbo执行时间.Tag = "1"
                cbo执行时间.Text = ""
            Else
                '处理可用执行时间方案的变化
                If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                    '查找给药途径对应的行
                    lng用法ID = .FindRow(CLng(.TextMatrix(.Row, COL_相关ID)), .Row + 1)
                    If lng用法ID <> -1 Then '未找到给药途径的情况,应该不可能
                        lng用法ID = Val(.TextMatrix(lng用法ID, COL_诊疗项目ID))
                    Else
                        lng用法ID = 0
                    End If
                ElseIf RowIn配方行(.Row) Then
                    '得到对应的中药用法ID
                    lng用法ID = Val(.TextMatrix(.Row, COL_诊疗项目ID))
                End If
                
                Call Get时间方案(cbo执行时间, int范围, txt频率.Text, lng用法ID)
                '取新的频率的默认执行时间
                If cbo执行时间.ListCount > 0 Then
                    cbo执行时间.ListIndex = 0
                    cbo执行时间.Tag = "1"
                Else
                    '判断当前执行时间是否合法
                    If cbo执行时间.Text <> "" Then
                        blnValid = ExeTimeValid(cbo执行时间.Text, rsInput!频率次数, rsInput!频率间隔, rsInput!间隔单位)
                        If Not blnValid Then '如果不合法,则另取,否则保持
                            cbo执行时间.Text = ""
                            cbo执行时间.Tag = "1"
                        End If
                    End If
                End If
            End If
            
            '重新计算总量
            If mbln天数 And InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                sng天数 = Val(txt天数.Text)
                If sng天数 = 0 Then sng天数 = 1
                
                If txt频率.Text <> "" And Val(txt单量.Text) <> 0 _
                    And Val(.TextMatrix(.Row, COL_剂量系数)) <> 0 _
                    And Val(.TextMatrix(.Row, COL_门诊包装)) <> 0 Then
                    
                    txt总量.Text = FormatEx(Calc缺省药品总量( _
                        Val(txt单量.Text), sng天数, rsInput!频率次数, _
                        rsInput!频率间隔, rsInput!间隔单位, cbo执行时间.Text, _
                        Val(.TextMatrix(.Row, COL_剂量系数)), _
                        Val(.TextMatrix(.Row, COL_门诊包装)), _
                        Val(.TextMatrix(.Row, COL_可否分零))), 5)
                    If InStr(GetInsidePrivs(p门诊医嘱下达), "药品小数输入") = 0 Then
                        txt总量.Text = IntEx(Val(txt总量.Text))
                    ElseIf Val(.TextMatrix(.Row, COL_可否分零)) <> 0 Then
                        txt总量.Text = IntEx(Val(txt总量.Text))
                    End If
                    txt总量.Tag = "1"
                End If
            End If
        End If
        If rsInput!间隔单位 = "分钟" Then
            If cbo执行时间.Enabled Then SetItemEditable , , , , -1
        End If
    End With
        
    '处理当前医嘱执行频率的变化
    Call AdviceChange
End Sub

Private Function GetBaseRow(ByVal lngRow As Long) As Long
'功能：由当前可见行获取主项目的行
    If RowIn配方行(lngRow) Then
        '获取中药配方第一味中药行
        GetBaseRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_相关ID)
    ElseIf RowIn检验行(lngRow) Then
        '获取一并采样的第一个项目行
        GetBaseRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_相关ID)
    Else
        GetBaseRow = lngRow
    End If
End Function

Private Sub cbo滴速_Change()
    If lbl滴速.Caption = "滴速" Then '输血
        If IsNumeric(cbo滴速.Text) Or cbo滴速 = "" Then
            lbl滴速单位 = "滴/分钟"
        Else
            lbl滴速单位.Caption = ""
        End If
    End If
    cbo滴速.Tag = "1"
End Sub

Private Sub cbo滴速_Click()
    cbo滴速.Tag = "1"
    If lbl滴速.Caption = "滴速" Then
        If cbo滴速.Text = "加压" Or cbo滴速.Text = "快速" Then '只有输血医嘱有这两个
            lbl滴速单位.Caption = ""
        Else
            lbl滴速单位 = "滴/分钟"
        End If
    End If
    Call AdviceChange
End Sub

Private Sub cbo滴速_GotFocus()
    zlControl.TxtSelAll cbo滴速
End Sub

Private Sub cbo滴速_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If SeekNextControl Then Call cbo滴速_Validate(False)
    ElseIf InStr("0123456789-" & Chr(8), Chr(KeyAscii)) = 0 Then
        KeyAscii = 0
    End If
End Sub

Private Sub cbo滴速_Validate(Cancel As Boolean)
    If zlCommFun.ActualLen(cbo滴速.Text) > 10 Then
        MsgBox "滴速输入内容过长，请检查输入是否正确。", vbInformation, gstrSysName
        Call cbo滴速_GotFocus: Cancel = True: Exit Sub
    End If
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub cbo附加执行_Click()
    Dim rsTmp As ADODB.Recordset
    Dim lngRow As Long, strSQL As String
    Dim intIdx As Integer, i As Long
    Dim vRect As RECT, blnCancel As Boolean
        
    If cbo附加执行.ListIndex = -1 Then Exit Sub
    
    If cbo附加执行.ItemData(cbo附加执行.ListIndex) = -1 Then
        strSQL = "Select Distinct A.ID,A.编码,A.名称,A.简码" & _
            " From 部门表 A,部门性质说明 B" & _
            " Where A.ID=B.部门ID And B.服务对象 IN(1,3)" & _
            " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 is NULL)" & _
            " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
            " Order by A.编码"
        vRect = zlControl.GetControlRect(cbo附加执行.hwnd)
        Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, lbl附加执行.Caption, , , , , , True, vRect.Left, vRect.Top, txt用法.Height, blnCancel, , True)
        If Not rsTmp Is Nothing Then
            intIdx = Cbo.FindIndex(cbo附加执行, rsTmp!ID)
            If intIdx <> -1 Then
                cbo附加执行.ListIndex = intIdx
            Else
                cbo附加执行.AddItem rsTmp!编码 & "-" & rsTmp!名称, cbo附加执行.ListCount - 1
                cbo附加执行.ItemData(cbo附加执行.NewIndex) = rsTmp!ID
                cbo附加执行.ListIndex = cbo附加执行.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "没有科室数据，请先到部门管理中设置。", vbInformation, gstrSysName
            End If
            '恢复成现有的科室(不引发Click)
            intIdx = Cbo.FindIndex(cbo附加执行, Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_执行科室ID)))
            Call Cbo.SetIndex(cbo附加执行.hwnd, intIdx)
        End If
    Else
        cbo附加执行.Tag = "1"
        lngRow = vsAdvice.Row
        
        '更新更改了的执行科室医嘱内容
       Call AdviceChange
    End If
End Sub

Private Sub cbo附加执行_GotFocus()
    Call zlControl.TxtSelAll(cbo附加执行)
End Sub

Private Sub cbo附加执行_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo附加执行.ListIndex = -1 Then
            Call cbo附加执行_Validate(blnCancel)
        End If
        If Not blnCancel Then
            If SeekNextControl Then Call cbo附加执行_Validate(False)
        End If
    End If
End Sub

Private Sub cbo附加执行_Validate(Cancel As Boolean)
'功能：根据输入的内容,自动匹配执行科室
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, intIdx As Long, i As Long
    Dim blnLimit As Boolean, strInput As String
    Dim vRect As RECT, blnCancel As Boolean
    
    If cbo附加执行.ListIndex <> -1 Then Exit Sub '已选中
    If cbo附加执行.Text = "" Then '无输入
        With vsAdvice
            If .TextMatrix(.Row, COL_类别) = "E" And .TextMatrix(.Row, COL_操作类型) = "1" And .TextMatrix(.Row, COL_执行分类) = "5" Then
                cbo附加执行.Tag = "1"
                Call AdviceChange
                Exit Sub
            Else
                If cbo附加执行.ListCount > 0 Then Cancel = True
                Exit Sub
            End If
        End With
    End If
    
    On Error GoTo errH
    
    '是否可以任意或选择科室
    blnLimit = True
    If cbo附加执行.ListCount > 0 Then
        If cbo附加执行.ItemData(cbo附加执行.ListCount - 1) = -1 Then
            blnLimit = False
        End If
    End If
    strInput = UCase(zlCommFun.GetNeedName(cbo附加执行.Text))
    strSQL = "Select Distinct A.ID,A.编码,A.名称,A.简码" & _
        " From 部门表 A,部门性质说明 B" & _
        " Where A.ID=B.部门ID And B.服务对象 IN(1,3)" & _
        " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 is NULL)" & _
        " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
        " And (Upper(A.编码) Like [1] Or Upper(A.名称) Like [2] Or Upper(A.简码) Like [2])" & _
        " Order by A.编码"
    If blnLimit Then
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strInput & "%", mstrLike & strInput & "%")
        For i = 1 To rsTmp.RecordCount
            intIdx = Cbo.FindIndex(cbo附加执行, rsTmp!ID)
            If intIdx <> -1 Then cbo附加执行.ListIndex = intIdx: Exit For
            rsTmp.MoveNext
        Next
        If cbo附加执行.ListIndex = -1 Then
            MsgBox "未到对应的科室。", vbInformation, gstrSysName
            Cancel = True: Exit Sub
        End If
    Else
        vRect = zlControl.GetControlRect(cbo附加执行.hwnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl附加执行.Caption, False, "", "", False, False, True, _
            vRect.Left, vRect.Top, txt用法.Height, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%")
        If Not rsTmp Is Nothing Then
            intIdx = Cbo.FindIndex(cbo附加执行, rsTmp!ID)
            If intIdx <> -1 Then
                cbo附加执行.ListIndex = intIdx
            Else
                cbo附加执行.AddItem rsTmp!编码 & "-" & rsTmp!名称, cbo附加执行.ListCount - 1
                cbo附加执行.ItemData(cbo附加执行.NewIndex) = rsTmp!ID
                cbo附加执行.ListIndex = cbo附加执行.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "未到对应的科室。", vbInformation, gstrSysName
            End If
            Cancel = True: Exit Sub
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cbo医生嘱托_LostFocus()
    Call zlCommFun.OpenIme(False)
End Sub

Private Sub cbsMain_GetClientBordersWidth(Left As Long, Top As Long, Right As Long, Bottom As Long)
    Bottom = Me.stbThis.Height
End Sub

Private Sub cbsMain_InitCommandsPopup(ByVal CommandBar As XtremeCommandBars.ICommandBar)
    Dim strTmp As String, arrTmp As Variant
    Dim objControl As CommandBarControl
    Dim i As Long
    
    If CommandBar Is Nothing Then Exit Sub
    If CommandBar.Parent Is Nothing Then Exit Sub
    Select Case CommandBar.Parent.ID
    Case conMenu_Tool_PlugIn
        Call CreatePlugInOK(p门诊医嘱下达, mint场合)
        If Not gobjPlugIn Is Nothing Then
            On Error Resume Next
            strTmp = gobjPlugIn.GetFuncNames(glngSys, p门诊医嘱下达, mint场合)
            Call zlPlugInErrH(err, "GetFuncNames")
            err.Clear: On Error GoTo 0
        End If
        If strTmp <> "" Then
            With CommandBar.Controls
                If .Count = 0 Then
                    strTmp = Replace(strTmp, "Auto:", "")
                    arrTmp = Split(strTmp, ",")
                    For i = 0 To UBound(arrTmp)
                        Set objControl = .Add(xtpControlButton, conMenu_Tool_PlugIn_Item + i + 1, CStr(arrTmp(i)))
                        If i <= 9 Then objControl.Caption = objControl.Caption & "(&" & IIF(i = 9, 0, i + 1) & ")"
                        objControl.IconId = conMenu_Tool_PlugIn_Item
                        objControl.Parameter = arrTmp(i)
                    Next
                End If
            End With
        End If
    Case conMenu_Tool_Diag
        Call CreatePlugInOK(p门诊医嘱下达, mint场合)
        If Not gobjPlugIn Is Nothing Then
            On Error Resume Next
            strTmp = gobjPlugIn.GetFuncNames(glngSys, p门诊医嘱下达, 5)
            Call zlPlugInErrH(err, "GetFuncNames")
            err.Clear: On Error GoTo 0
        End If
        If strTmp <> "" Then
            With CommandBar.Controls
                If .Count = 0 Then
                    strTmp = Replace(strTmp, "Auto:", "")
                    arrTmp = Split(strTmp, ",")
                    For i = 0 To UBound(arrTmp)
                        Set objControl = .Add(xtpControlButton, conMenu_Tool_Diag_items + i + 1, CStr(arrTmp(i)))
                        If i <= 9 Then objControl.Caption = objControl.Caption & "(&" & IIF(i = 9, 0, i + 1) & ")"
                        objControl.IconId = conMenu_Tool_Diag_items
                        objControl.Parameter = arrTmp(i)
                    Next
                End If
            End With
        End If
    End Select
End Sub

Private Sub cbsMain_Resize()
    Dim lngLeft As Long, lngTop  As Long, lngRight  As Long, lngBottom  As Long
    Dim i As Long
    Dim lngColW As Long
    Dim lngCount As Long
    
    On Error Resume Next

    Call Me.cbsMain.GetClientRect(lngLeft, lngTop, lngRight, lngBottom)
    
    fraPati.Left = lngLeft
    fraPati.Top = lngTop
    fraPati.Width = lngRight - lngLeft
    fraPati.Height = cmdAlley.Height + IIF(mint家属 > 0, 230, 30)
    lblPati.Top = 80
    If mint家属 > 0 Then
        lblFamily.Left = lblPati.Left
        lblFamily.Top = lblPati.Top + lblPati.Height + 30
        lblFamilyTmp.Left = lblFamily.Left + lblFamily.Width
        lblFamilyTmp.Top = lblFamily.Top
    End If
    
    '-------
    picEpr.Left = lngLeft
    picEpr.Top = fraPati.Top + fraPati.Height
    picEpr.Width = lngRight - lngLeft
    picOutDoc.Move 0, 0, picEpr.Width, picEpr.Height
    If mblnDocInput Then
        For i = 0 To lblDoc.UBound
            lblDoc(i).Width = Me.TextWidth("字")
            lblDoc(i).Height = Me.TextHeight("字") * 3
        Next
        lblTip.Left = rtfEdit(txt查体).Left
        lblEPRname.Left = rtfEdit(txt查体).Left
        cmdSign.Left = rtfEdit(txt查体).Left + rtfEdit(txt查体).Width - cmdSign.Width
        If picEpr.Width > 4200 Then
            rtfEdit(txt主诉).Width = (picEpr.ScaleWidth - lblDoc(txt主诉).Width * 4 - 100) / 2
        Else
            rtfEdit(txt主诉).Width = 2800
        End If
        
        lngCount = 1
        rtfEdit(txt主诉).Left = lblDoc(txt主诉).Left + lblDoc(txt主诉).Width + 70
        lblDoc(txt主诉).Top = 0
        For i = 1 To rtfEdit.Count - 1
            If rtfEdit(i).Visible Then
                lngCount = lngCount + 1
                lblDoc(i).Left = IIF(lngCount Mod 2 = 1, lblDoc(txt主诉).Left, rtfEdit(txt主诉).Left + rtfEdit(txt主诉).Width + 100)
                rtfEdit(i).Left = lblDoc(i).Left + lblDoc(i).Width + 70
                rtfEdit(i).Width = IIF(lngCount Mod 2 = 1, rtfEdit(txt主诉).Width, picEpr.Width - rtfEdit(i).Left - 100)
                lblDoc(i).Top = ((lngCount - 1) \ 2) * rtfEdit(i).Height - (((lngCount - 1) \ 2) * 15)
                rtfEdit(i).Top = ((lngCount - 1) \ 2) * rtfEdit(i).Height - (((lngCount - 1) \ 2) * 15)
            End If
        Next
        
        cmdSign.Left = picEpr.Width - 100 - cmdSign.Width
        cmdSign.Top = ((lngCount) \ 2) * rtfEdit(txt主诉).Height + 50
        cmdUpdate.Left = cmdSign.Left
        cmdUpdate.Top = cmdSign.Top + cmdSign.Height + 20
        cmdImportEPRDemo.Left = cmdUpdate.Left - cmdImportEPRDemo.Width - 50
        cmdImportEPRDemo.Top = cmdUpdate.Top
        
        lblDoctor(1).Left = cmdSign.Left - lblDoctor(1).Width - 100
        lblDoctor(0).Left = lblDoctor(1).Left - lblDoctor(0).Width - 20
        lblDoctor(0).Top = ((lngCount) \ 2) * rtfEdit(txt主诉).Height + 150
        lblDoctor(1).Top = lblDoctor(0).Top
        
        picPrompt.Left = rtfEdit(txt主诉).Left + rtfEdit(txt主诉).Width + 120
        picPrompt.Top = ((lngCount) \ 2) * rtfEdit(txt主诉).Height + 550
        lblTip.Left = picPrompt.Left + picPrompt.Width + 60
        lblTip.Top = ((lngCount) \ 2) * rtfEdit(txt主诉).Height + 550
        
        lblEPRname.Left = rtfEdit(txt主诉).Left + rtfEdit(txt主诉).Width + 400
        lblEPRname.Top = ((lngCount) \ 2) * rtfEdit(txt主诉).Height + 250
        picOutDoc.Height = cmdUpdate.Top + cmdUpdate.Height + 50
    End If
    picEpr.Height = picOutDoc.Height
    '-------
    
    fra诊断.Left = lngLeft
    fra诊断.Top = fraPati.Top + fraPati.Height + IIF(picEpr.Visible, picEpr.Height, 0)
    fra诊断.Width = lngRight - lngLeft
    
    opt诊断(1).Left = fra诊断.Width - opt诊断(1).Width - 10 * Screen.TwipsPerPixelX
    opt诊断(0).Left = opt诊断(1).Left
    vsDiag.Top = 0
    vsDiag.Width = opt诊断(0).Left - vsDiag.Left - 100
    For i = 0 To vsDiag.Cols - 1
        If Not vsDiag.ColHidden(i) And i <> col诊断 Then
            lngColW = lngColW + vsDiag.ColWidth(i)
        End If
    Next
    vsDiag.ColWidth(col诊断) = vsDiag.Width - lngColW - 2 * Screen.TwipsPerPixelX - IIF(vsDiag.Rows > M_LNG_DIAGCOUNT, 250, 0)
    If vsDiag.ColWidth(col诊断) < 3000 Then
        vsDiag.ColWidth(col诊断) = 3000
    End If
    
    vsAdvice.Left = lngLeft
    vsAdvice.Top = fra诊断.Top + fra诊断.Height
    vsAdvice.Height = lngBottom - fra诊断.Top - fra诊断.Height - (fraAdvice.Height - 80) - IIF(pic疑问.Visible, pic疑问.Height, 0)
    vsAdvice.Width = lngRight - lngLeft
    
    pic疑问.Left = 0
    pic疑问.Top = vsAdvice.Top + vsAdvice.Height
    pic疑问.Width = vsAdvice.Width
    lbl疑问.Width = pic疑问.ScaleWidth - lbl疑问.Left - 45
    
    fraAdvice.Left = lngLeft
    fraAdvice.Top = vsAdvice.Top + vsAdvice.Height - 6 * Screen.TwipsPerPixelX + IIF(pic疑问.Visible, pic疑问.Height, 0)
    fraAdvice.Width = lngRight - lngLeft
    stbThis.Top = lngBottom - 10
    stbThis.Width = picSub.ScaleWidth
    
    picPanel(e新增).Left = fraAdvice.Left + lbl医嘱内容.Left + lbl医嘱内容.Width - 200 - tbrAdd.ButtonWidth
    picPanel(e新增).Top = fraAdvice.Top + lbl医嘱内容.Top + lbl医嘱内容.Height + 100
    picPanel(e新增).Width = tbrAdd.ButtonWidth
    picPanel(e新增).Height = tbrAdd.Height
    
End Sub

Private Sub cbsMain_Update(ByVal Control As XtremeCommandBars.ICommandBarControl)
    Dim blnEnabled As Boolean
    Dim intLoop As Integer
    Dim strTmp As String
    Dim vRect As RECT, vPos As PointAPI
    
    If vsAdvice.Redraw = flexRDNone Then Exit Sub
    
    'PASS二级菜单的可见性与可用性在独立部件中设置，此时需要屏蔽，如不屏蔽，部件中设置值将会被覆盖
    If Between(Control.ID, conMenu_Edit_MediAudit * 10#, conMenu_Edit_MediAudit * 10# + 99) Then
        Exit Sub
    End If
    
    If mbytUseType = 1 And Control.ID <> conMenu_Merge Then
        Select Case Control.ID
            Case conMenu_Save '保存
                Control.Enabled = mblnNoSave
            Case conMenu_Reference
                If mbytUseType = 3 Then Control.Visible = False
            Case conMenu_AltAdvice '备选医嘱
            
            Case conMenu_Edit_ViewRefcom
                If Not gobjPass Is Nothing Then Call gobjPass.ZLPharmReviewResultShow(Me, mlng病人ID, mlng挂号ID)
            Case conMenu_Help, conMenu_Exit
                '只显示帮助和退出
            Case conMenu_DrugScale * 100# + 1 To conMenu_DrugScale * 100# + 99
            Case Else
                Control.Visible = False
        End Select
    Else
        If mbytUseType = 2 Then '添加路径外项目
            Select Case Control.ID
                Case conMenu_Sign, conMenu_Send, conMenu_Scheme
                    Control.Visible = False
                    Exit Sub
            End Select
        End If
        Select Case Control.ID
            Case conMenu_Delete
                With vsAdvice
                    blnEnabled = True
                    If .RowData(.Row) <> 0 Then
                        If Not fraAdvice.Enabled And Val(.TextMatrix(.Row, COL_审核状态)) <> 2 Then blnEnabled = False
                        If Not fraAdvice.Enabled And Val(.TextMatrix(.Row, COL_审核状态)) = 2 And .TextMatrix(.Row, COL_类别) = "K" And gbln血库系统 Then blnEnabled = False
                        If .TextMatrix(.Row, COL_类别) = "K" And Val(.TextMatrix(.Row, COL_检查方法)) = 1 Then blnEnabled = False
                        If Val(.TextMatrix(.Row, COL_状态)) <> 1 Then blnEnabled = False
                        '已签名医嘱不可删除
                        If Val(.TextMatrix(.Row, COL_签名否)) = 1 Then blnEnabled = False
                    End If
                    Control.Enabled = blnEnabled
                End With
            Case conMenu_Edit_Blankoff
                If InStr(GetInsidePrivs(p门诊医嘱下达), ";医嘱作废;") = 0 Then
                    Control.Visible = False
                End If
                Control.Enabled = Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_状态)) > 1
            Case conMenu_Merge
                Control.Checked = mblnRowMerge
            Case conMenu_Scheme, conMenu_Scheme * 10# + 1, conMenu_Scheme * 10# + 2
                If mblnModal Then
                    Control.Visible = False
                Else
                    If InStr(GetInsidePrivs(p门诊医嘱下达), "保存成套方案") = 0 Then
                        Control.Visible = False
                    End If
                    If Control.ID = conMenu_Scheme * 10# + 2 Then
                        Control.Caption = IIF(mfrmShortCut.Visible, "隐藏", "显示") & "成套方案选择器"
                    End If
                End If
            Case conMenu_Agent
                If Not mblnAddAgent Then
                    Control.Visible = False
                Else
                    strTmp = GetTsPrivs(p门诊医嘱下达)
                    Control.Visible = InStr(strTmp, "下达麻醉药嘱") > 0 Or InStr(strTmp, "下达毒性药嘱") > 0 Or InStr(strTmp, "下达精神药嘱") > 0
                End If
            Case conMenu_Save
                Control.Enabled = mblnNoSave
            Case conMenu_Sign
                If mint场合 = 1 Or InStr(UserInfo.性质, "医生") = 0 Or gobjESign Is Nothing _
                    Or InStr(GetInsidePrivs(p门诊医嘱下达), ";医嘱下达;") = 0 Then
                    Control.Visible = False
                ElseIf mint场合 = 0 And Control.Category <> "已判断" Then
                    If CheckSign(0, 0, mlng医技科室ID, mlng病人科室id, 1, False, gobjESign) = False Then
                        Control.Visible = False '不同场合没有设置要使用签名
                    End If
                    Control.Category = "已判断"
                ElseIf mint场合 = 2 And Control.Category <> "已判断" Then
                    If CheckSign(3, 0, mlng医技科室ID, mlng病人科室id, 1, False, gobjESign) = False Then
                        Control.Visible = False '不同场合没有设置要使用签名
                    End If
                    Control.Category = "已判断"
                End If
            Case conMenu_Send, conMenu_Send * 10# + 1, conMenu_Send * 10# + 2
                If InStr(GetInsidePrivs(p门诊医嘱下达), "医嘱发送") = 0 Then
                    Control.Visible = False
                ElseIf InStr(GetInsidePrivs(p门诊医嘱下达), "发送为收费单") = 0 And InStr(GetInsidePrivs(p门诊医嘱下达), "发送为记帐单") = 0 Then
                    Control.Visible = False
                End If
                If Val(zlDatabase.GetPara("发送单据类型", glngSys, p门诊医嘱下达)) = 0 And InStr(GetInsidePrivs(p门诊医嘱下达), "发送为收费单") = 0 Or _
                   Val(zlDatabase.GetPara("发送单据类型", glngSys, p门诊医嘱下达)) = 1 And InStr(GetInsidePrivs(p门诊医嘱下达), "发送为记帐单") = 0 Then
                    Control.Visible = False
                End If
            Case conMenu_Edit_ViewDrugExplain '查看药品说明书
                Control.Enabled = vsAdvice.RowData(vsAdvice.Row) <> 0 And InStr(",5,6,7,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) > 0
            Case conMenu_Reference
                If GetInsidePrivs(p药品诊疗参考) = "" Then
                    Control.Visible = False
                End If
            Case Else
                '单量显示状态
                blnEnabled = False
                If txt单量.Enabled Then
                    If InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) > 0 Then
                        GetCursorPos vPos
                        GetWindowRect fraAdvice.hwnd, vRect
                        If Between(vPos.X * Screen.TwipsPerPixelX, vRect.Left * Screen.TwipsPerPixelX + lbl单量.Left, vRect.Left * Screen.TwipsPerPixelX + lbl单量.Left + lbl单量.Width) Then
                            If Between(vPos.Y * Screen.TwipsPerPixelY, vRect.Top * Screen.TwipsPerPixelY + lbl单量.Top, vRect.Top * Screen.TwipsPerPixelY + lbl单量.Top + lbl单量.Height) Then
                                blnEnabled = True
                            End If
                        End If
                    End If
                End If
                Call Set单量Face(blnEnabled)
                blnEnabled = False
                If lblCTN.Visible And lblCTN.Caption <> "无成套分类" Then
                    GetCursorPos vPos
                    GetWindowRect picPanel(e成套方案).hwnd, vRect
                    If Between(vPos.X * Screen.TwipsPerPixelX, vRect.Left * Screen.TwipsPerPixelX + lblCTN.Left, vRect.Left * Screen.TwipsPerPixelX + lblCTN.Left + lblCTN.Width) Then
                        If Between(vPos.Y * Screen.TwipsPerPixelY, vRect.Top * Screen.TwipsPerPixelY + lblCTN.Top, vRect.Top * Screen.TwipsPerPixelY + lblCTN.Top + lblCTN.Height) Then
                            blnEnabled = True
                        End If
                    End If
                    Call SetLinkLBL(lblCTN, blnEnabled)
                End If
                If Not blnEnabled Then
                    If lblCTFW.Visible Then
                        GetCursorPos vPos
                        GetWindowRect picPanel(e成套方案).hwnd, vRect
                        If Between(vPos.X * Screen.TwipsPerPixelX, vRect.Left * Screen.TwipsPerPixelX + lblCTFW.Left, vRect.Left * Screen.TwipsPerPixelX + lblCTFW.Left + lblCTFW.Width) Then
                            If Between(vPos.Y * Screen.TwipsPerPixelY, vRect.Top * Screen.TwipsPerPixelY + lblCTFW.Top, vRect.Top * Screen.TwipsPerPixelY + lblCTFW.Top + lblCTFW.Height) Then
                                blnEnabled = True
                            End If
                        End If
                        Call SetLinkLBL(lblCTFW, blnEnabled)
                    End If
                End If
                
                blnEnabled = False
                If lblFamilyTmp.Visible Then
                    GetCursorPos vPos
                    GetWindowRect fraPati.hwnd, vRect
                    If Between(vPos.X * Screen.TwipsPerPixelX, vRect.Left * Screen.TwipsPerPixelX + lblFamilyTmp.Left, vRect.Left * Screen.TwipsPerPixelX + lblFamilyTmp.Left + lblFamilyTmp.Width) Then
                        If Between(vPos.Y * Screen.TwipsPerPixelY, vRect.Top * Screen.TwipsPerPixelY + lblFamilyTmp.Top, vRect.Top * Screen.TwipsPerPixelY + lblFamilyTmp.Top + lblFamilyTmp.Height) Then
                            blnEnabled = True
                        End If
                    End If
                    Call SetLinkLBL(lblFamilyTmp, blnEnabled)
                End If
                
                blnEnabled = False
                If lblLink.Visible Then
                    GetCursorPos vPos
                    GetWindowRect fraPati.hwnd, vRect
                    If Between(vPos.X * Screen.TwipsPerPixelX, vRect.Left * Screen.TwipsPerPixelX + lblLink.Left, vRect.Left * Screen.TwipsPerPixelX + lblLink.Left + lblLink.Width) Then
                        If Between(vPos.Y * Screen.TwipsPerPixelY, vRect.Top * Screen.TwipsPerPixelY + lblLink.Top, vRect.Top * Screen.TwipsPerPixelY + lblLink.Top + lblLink.Height) Then
                            blnEnabled = True
                        End If
                    End If
                    Call SetLinkLBL(lblLink, blnEnabled)
                End If
                
        End Select
    End If
End Sub

Private Sub chk免试_Click()
    If Not mblnDoCheck Then Exit Sub
    
    chk免试.Tag = "1"
    '更新数据
    Call AdviceChange
End Sub

Private Sub chk免试_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call SeekNextControl
    End If
End Sub

Private Sub cmdAlley_Click()
'功能：对病人过敏史/病生状态进行管理
    'Pass
    If mblnPass Then
        Call gobjPass.zlPassCmdAlleyManage(mobjPassMap)
    End If
End Sub

Private Sub cmdLastDiag_Click()
'功能：读取上次就诊的诊断信息，追加到现有诊断后
    Dim strSQL As String, rsTmp As Recordset
    Dim i As Long, strTmp As String
    Dim blnDo As Boolean
    
    If MsgBox("是否读取上次诊断信息添加到现有诊断之后？", vbQuestion + vbYesNo + vbDefaultButton2, Me.Caption) = vbYes Then
        On Error GoTo errH
        strSQL = "Select A.ID,A.记录来源,A.诊断类型,A.疾病ID,A.诊断ID,A.证候ID,A.诊断描述,A.是否疑诊,c.编码 as ICD码,D.编码 as 诊断编码,E.编码 as 证候编码,A.发病时间" & vbNewLine & _
            "From 病人诊断记录 A, 病人挂号记录 B,疾病编码目录 C, 疾病诊断目录 D,疾病编码目录 E" & vbNewLine & _
            "Where a.病人id = b.病人id And a.主页id = b.Id And A.疾病ID=C.ID(+)  And a.诊断id = D.Id(+) And  a.证候ID=E.ID(+) And a.病人id = [1] And (诊断类型 = 1 Or 诊断类型 = 11) And" & vbNewLine & _
            "  (d.撤档时间 Is Null Or d.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And (c.撤档时间 Is Null Or c.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And b.登记时间 =" & vbNewLine & _
            "      (Select Max(登记时间)" & vbNewLine & _
            "       From 病人挂号记录 C" & vbNewLine & _
            "       Where c.病人id = [1] And ID <> [2] And Exists (Select 1 From 病人诊断记录 D Where d.病人id = [1] And 主页id = c.Id))"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng挂号ID)
        If rsTmp.RecordCount = 0 Then
            MsgBox "该病人在本次就诊之前未填写过门诊诊断或者填写过的诊断已停用。", vbInformation
        Else
            With vsDiag
                Do While Not rsTmp.EOF
                    i = -1
                    If Val(rsTmp!诊断id & "") <> 0 Then i = .FindRow(Val(rsTmp!诊断id & ""), , col诊断ID)
                    If i = -1 And Val(rsTmp!疾病id & "") <> 0 Then i = .FindRow(Val(rsTmp!疾病id & ""), , col疾病ID)
                    '如果当前已经填写，则只更新发病时间
                    If i <> -1 Then
                        If .TextMatrix(i, col发病时间) = "" Then
                            .TextMatrix(i, col发病时间) = Format(rsTmp!发病时间 & "", "YYYY-MM-DD HH:mm")
                        End If
                    Else
                        If Not (.TextMatrix(1, col诊断) = "" And .Rows = 2) Then
                            .AddItem ""
                        End If
                        i = .Rows - 1
                        Call SetDiagType(i, rsTmp!诊断类型)
                        
                        If IsNull(rsTmp!诊断描述) Then
                            .TextMatrix(i, col编码) = ""
                            .TextMatrix(i, col诊断) = ""
                        Else
                            If Mid(rsTmp!诊断描述, 1, 1) <> "(" Or (Val(rsTmp!诊断id & "") = 0 And Val(rsTmp!疾病id & "") = 0) Then '中医的诊断描述后面加了（候症），所以只判断第一个字符
                                '由于疾病编码和诊断可以对应，如果两个都不为空的时候，先判断疾病编码，先取疾病编码
                                If Val(rsTmp!疾病id & "") <> 0 Then
                                    .TextMatrix(i, col编码) = NVL(rsTmp!ICD码)
                                ElseIf Val(rsTmp!诊断id & "") <> 0 Then
                                    .TextMatrix(i, col编码) = NVL(rsTmp!诊断编码)
                                Else
                                    .TextMatrix(i, col编码) = ""
                                End If
                                .TextMatrix(i, col诊断) = rsTmp!诊断描述
                            Else
                                .TextMatrix(i, col编码) = Mid(rsTmp!诊断描述, 2, InStr(rsTmp!诊断描述, ")") - 2)
                                .TextMatrix(i, col诊断) = Mid(rsTmp!诊断描述, InStr(rsTmp!诊断描述, ")") + 1)
                            End If
                        End If

                        .Cell(flexcpData, i, col疑诊) = Val(NVL(rsTmp!是否疑诊, 0))
                        .Cell(flexcpForeColor, i, col疑诊) = IIF(NVL(rsTmp!是否疑诊, 0) = 1, vbRed, .GridColor)
                        
                        .TextMatrix(i, col诊断ID) = NVL(rsTmp!诊断id, 0)
                        .Cell(flexcpData, i, col诊断ID) = NVL(rsTmp!ID, 0)
                        .TextMatrix(i, col疾病ID) = NVL(rsTmp!疾病id, 0)
                        .TextMatrix(i, col证候ID) = NVL(rsTmp!证候id, 0)
                        .TextMatrix(i, colICD码) = NVL(rsTmp!ICD码)
                        .TextMatrix(i, col发病时间) = Format(rsTmp!发病时间 & "", "YYYY-MM-DD HH:mm")
                        '取证候名称
                        If InStr(.TextMatrix(i, col诊断), "(") > 0 And InStr(.TextMatrix(i, col诊断), ")") > 0 Then
                            strTmp = Mid(.TextMatrix(i, col诊断), InStrRev(.TextMatrix(i, col诊断), "(") + 1)
                            strTmp = Mid(strTmp, 1, Len(strTmp) - 1)
                            '先取证候
                            .TextMatrix(i, col中医证候) = strTmp
                            '去掉诊断描述的证候
                            .TextMatrix(i, col诊断) = Mid(.TextMatrix(i, col诊断), 1, InStrRev(.TextMatrix(i, col诊断), "(") - 1)
                        Else
                           .TextMatrix(i, col中医证候) = ""
                        End If
                        '自由录入诊断的诊断描述，需要去掉证候，因此此句代码后移
                        If Not IsNull(rsTmp!疾病id) Or Not IsNull(rsTmp!诊断id) Then
                            .Cell(flexcpData, i, col诊断) = Get诊断描述(Val("" & rsTmp!诊断id), Val("" & rsTmp!疾病id))    '获取原始名称以便修改时判断
                        Else
                            .Cell(flexcpData, i, col诊断) = .TextMatrix(i, col诊断)
                        End If
                    End If
                    
                    '生成一个ID值
                    If Val(.RowData(i)) = 0 Then
                        mlngDSeq = mlngDSeq + 1
                        .RowData(i) = mlngDSeq
                    End If
                    rsTmp.MoveNext
                Loop
                
                'PASS 诊断录入
                If mblnPass Then
                    zlPassDrugs
                End If
                '将本次录入尚未关联诊断的医嘱与当前诊断关联
                If .TextMatrix(.Row, col诊断) <> "" Then
                    blnDo = False
                    With vsAdvice
                        For i = .FixedRows To .Rows - 1
                            If .RowData(i) <> 0 And Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                                If Val(.TextMatrix(i, COL_状态)) = 1 And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                                    mrsAD.Filter = "医嘱ID=" & Val(.RowData(i))
                                    If mrsAD.EOF Then
                                        Call SetDiagFlag(i, 1, Val(vsDiag.RowData(vsDiag.Row)))
                                        blnDo = True
                                    End If
                                End If
                            End If
                        Next
                    End With
                    If blnDo Then
                        Call ShowDiagFlag(vsAdvice.Row)
                    End If
                End If

                mblnNoSave = True: lbl诊断.Tag = "1"
                Call SetDiagHeight
            End With
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmdReason_Click()
    Call ReasonSelect("", 1)
    Call AdviceChange
End Sub

Private Sub cmdExcReason_Click()
    Call ReasonSelect("", 3)
    Call AdviceChange
End Sub

Private Function ReasonSelect(ByVal strFind As String, ByVal intType As Integer) As Boolean
'常用嘱托和抗菌用药理由超量说明选择器
'intType  1-抗菌用药理由，2-常用嘱托，3-超量说明
    Dim blnCancle As Boolean
    Dim strRetrun As String
    Dim lngLeft As Long, lngTop As Long
    Dim strName As String
    
    If intType = 1 Then
        lngLeft = txt用药理由.Left
        lngTop = txt用药理由.Top
        strName = "抗菌用药理由。"
    ElseIf intType = 2 Then
        lngLeft = cbo医生嘱托.Left
        lngTop = cbo医生嘱托.Top
        strName = "常用嘱托。"
    ElseIf intType = 3 Then
        lngLeft = txt超量说明.Left
        lngTop = txt超量说明.Top
        strName = "超量说明。"
    End If
    
    lngLeft = lngLeft + fraAdvice.Left + Me.Left
    lngTop = lngTop + fraAdvice.Top + Me.Top - 2600
    
    strRetrun = frmKssReasonSelect.ShowMe(Me, strFind, blnCancle, lngLeft, lngTop, intType)
    If Not blnCancle Then
        If strRetrun = "" Then
            If strFind = "" Then
                MsgBox "没有找到可用的" & strName, vbInformation, Me.Caption
            End If
        Else
            If intType = 1 Then
                txt用药理由.Text = strRetrun
            ElseIf intType = 2 Then
                cbo医生嘱托.Text = strRetrun
            ElseIf intType = 3 Then
                txt超量说明.Text = strRetrun
            End If
        End If
    End If
    ReasonSelect = blnCancle
End Function

Private Sub ReasonSave(ByVal intType As Integer)
'功能：抗菌用药理由和超量说明保存
'参数：intType  0-抗菌用药理由，1-超量说明
    Dim strSQL As String, rsTmp As Recordset
    Dim strTmp As String
    Dim strPar As String
    
    If txt用药理由.Text = "" And intType = 0 Then MsgBox "请输入您需要收藏的用药理由。", vbInformation, Me.Caption: txt用药理由.SetFocus: Exit Sub
    If txt超量说明.Text = "" And intType = 1 Then MsgBox "请输入您需要收藏的超量说明。", vbInformation, Me.Caption: txt超量说明.SetFocus: Exit Sub
    
    If intType = 0 Then
        strPar = txt用药理由.Text
        strTmp = "用药理由"
    ElseIf intType = 1 Then
        strPar = txt超量说明.Text
        strTmp = "超量说明"
    End If
    
    On Error GoTo errH
    strSQL = "Select 1 From 医嘱常用原因 Where 名称=[1]"
    If intType = 1 Then strSQL = strSQL & " And 性质=1 And 人员=[2]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strPar, UserInfo.姓名)
    '如果已经有了，提示用户是否继续。
    If rsTmp.RecordCount > 0 Then
        MsgBox "已经存在相同的" & strTmp & "。", vbInformation, Me.Caption
        Exit Sub
    End If
    strSQL = "zl_医嘱常用原因_Update(0,Null,'" & strPar & "',Null" & _
        IIF(intType = 1, ",1,'" & UserInfo.姓名 & "'", "") & ")"
    zlDatabase.ExecuteProcedure strSQL, Me.Caption
    MsgBox strTmp & "收藏成功。", vbInformation, Me.Caption
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmdZYRemark_Click()
    Dim strSQL As String, rsTmp As Recordset
    Dim vRect As RECT, blnCancel As Boolean
    
    If vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_超量说明) <> "" Then
        strSQL = "Select b.名称 as 分类,a.编码 as ID,a.编码,a.名称,a.简码 From 门诊变异常见原因 a,门诊变异常见原因 b" & _
                " Where a.性质=1 And a.末级=1 And a.上级=b.编码 And b.末级=0 " & _
                " Order by 分类,a.编码"
        vRect = zlControl.GetControlRect(txt超量说明.hwnd)
        Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, "门诊变异常见原因", , , , , , True, vRect.Left, vRect.Top, txt超量说明.Height, blnCancel, , True)
        If rsTmp Is Nothing Then
            If Not blnCancel Then
                MsgBox "系统没有初始变异常见原因，请与系统管理员联系。", vbInformation, gstrSysName
                Exit Sub
            End If
        Else
            txt超量说明.Text = rsTmp!名称 & ""
            vsAdvice.TextMatrix(vsAdvice.Row, COL_超量说明) = rsTmp!名称 & ""
            vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_超量说明) = rsTmp!编码 & ""
        End If
        Call AdviceChange
    End If
End Sub

Private Sub cmd常用嘱托_Click()
    Dim strSQL As String, i As Integer
    Dim rsTmp As Recordset
    
    If Trim(cbo医生嘱托.Text) = "" Then
        MsgBox "请输入嘱托内容。", vbInformation, gstrSysName
        If cbo医生嘱托.Enabled Then cbo医生嘱托.SetFocus
        Exit Sub
    End If
    On Error GoTo errH
    strSQL = "Select 1 From 常用嘱托 Where 名称=[1] And (人员=[2] Or 人员 is null)"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Trim(cbo医生嘱托.Text), UserInfo.姓名)
    If rsTmp.RecordCount > 0 Then
        MsgBox "该嘱托内容已经在常用嘱托中。", vbInformation, gstrSysName
        If cbo医生嘱托.Enabled Then cbo医生嘱托.SetFocus
        Exit Sub
    End If
    
    strSQL = zlCommFun.zlGetSymbol(cbo医生嘱托.Text, CByte(mint简码))
    strSQL = "zl_常用嘱托_Insert('" & Replace(cbo医生嘱托.Text, "'", "''") & "','" & strSQL & "','" & UserInfo.姓名 & "')"
    Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
    
    AddComboItem cbo医生嘱托.hwnd, CB_ADDSTRING, 0, cbo医生嘱托.Text
    MsgBox "已设置为常用嘱托。", vbInformation, gstrSysName
    If cbo医生嘱托.Enabled Then cbo医生嘱托.SetFocus
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmd频率_Click()
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim int范围 As Integer, vRect As RECT
    Dim strSeek As String, lng诊疗项目ID As Long, lngFind As Long
    
    On Error GoTo errH
    
    With vsAdvice
        int范围 = Get频率范围(.Row)
        
        If txt频率.Text <> "" Then
            strSQL = "Select 编码 From 诊疗频率项目 Where 名称=[1] And 适用范围=[2]"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, txt频率.Text, int范围)
            If Not rsTmp.EOF Then strSeek = rsTmp!编码
        End If
        
        '可选择频率的常用频率
        lng诊疗项目ID = Val(.TextMatrix(.Row, COL_诊疗项目ID))
        If RowIn检验行(.Row) Then
            lngFind = .FindRow(CStr(.RowData(.Row)), .FixedRows, COL_相关ID)
            If lngFind <> -1 Then
                lng诊疗项目ID = Val(.TextMatrix(lngFind, COL_诊疗项目ID))
            End If
        ElseIf InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
            lngFind = .FindRow(CLng(.TextMatrix(.Row, COL_相关ID)), .Row + 1)
            If lngFind <> -1 Then
                lng诊疗项目ID = Val(.TextMatrix(lngFind, COL_诊疗项目ID))
            End If
        End If
        strSQL = ""
        If int范围 = 1 Then
            strSQL = " And (Exists(Select 1 From 诊疗用法用量 Where 项目ID=[2] And 用法ID is NULL And 频次=A.编码 And A.适用范围=1)" & _
                " Or (Select Count(*) From 诊疗用法用量 Where 项目ID=[2] And 用法ID is NULL And 频次 Is Not NULL)<=1)"
        End If
        strSQL = "Select Rownum as ID,A.编码,A.名称,A.简码," & _
            " A.英文名称,A.频率次数,A.频率间隔,A.间隔单位" & _
            " From 诊疗频率项目 A Where A.适用范围=[1]" & strSQL & _
            " Order by A.编码"
        vRect = zlControl.GetControlRect(txt频率.hwnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, "诊疗频率", False, strSeek, "", False, False, True, _
            vRect.Left, vRect.Top, txt频率.Height, blnCancel, False, True, int范围, lng诊疗项目ID)
        If rsTmp Is Nothing Then
            If Not blnCancel Then
                MsgBox "没有可用的诊疗频率项目，请先到医嘱频率管理中设置。", vbInformation, gstrSysName
            End If
            txt频率.Text = .TextMatrix(.Row, COL_频率)
            Call zlControl.TxtSelAll(txt频率)
            txt频率.SetFocus: Exit Sub
        End If
        Call Set频率Input(rsTmp, int范围)
        txt频率.SetFocus
        Call SeekNextControl
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmd安排时间_Click()
    If IsDate(txt安排时间.Text) Then
        dtpDate.value = CDate(txt安排时间.Text)
    ElseIf IsDate(msk开始时间.Text) Then
        dtpDate.value = CDate(msk开始时间.Text)
    Else
        dtpDate.value = zlDatabase.Currentdate
    End If
    dtpDate.Tag = "安排时间"
    dtpDate.Left = txt安排时间.Left + fraAdvice.Left
    dtpDate.Top = txt安排时间.Top + fraAdvice.Top - dtpDate.Height
    dtpDate.Visible = True
    dtpDate.SetFocus
End Sub

Private Sub cmd收藏用药理由_Click()
    Call ReasonSave(0)
End Sub

Private Sub cmdComExcReason_Click()
    Call ReasonSave(1)
End Sub

Private Sub cmd医生嘱托_Click()
    If ReasonSelect("", 2) Then Exit Sub
    cbo医生嘱托.Tag = "1"
    Call AdviceChange
End Sub

Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
    If mblnNoSave Then
        If MsgBox("当前医嘱内容编辑后尚未保存，确实要退出吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
            Cancel = True
            Exit Sub
        End If
    End If
    If Not mfrmShortCut Is Nothing Then mfrmShortCut.SaveShowState '系统自动卸载该子窗体
End Sub

Private Sub Set单量Face(ByVal blnOver As Boolean)
    If blnOver Then
        If lbl单量.BorderStyle = 0 Then
            lbl单量.BorderStyle = 1
            lbl单量.BackStyle = 1
        End If
    Else
        If lbl单量.BorderStyle = 1 Then
            lbl单量.BorderStyle = 0
            lbl单量.BackStyle = 0
        End If
    End If
End Sub

Private Sub lblFamilyTmp_Click()
'调用接口
    If mobjPatient Is Nothing Then
        On Error Resume Next
        Set mobjPatient = CreateObject("zlPublicPatient.clsPublicPatient")
        err.Clear: On Error GoTo 0
    End If
    If mobjPatient Is Nothing Then
        MsgBox "创建病人信息公共部件（zlPublicPatient.clsPublicPatient）失败！", vbInformation, Me.Caption
        Exit Sub
    End If
    Call mobjPatient.zlInitCommon(gcnOracle, glngSys, UserInfo.用户名)
    Call mobjPatient.MakePatiFamily(Me, mlng病人ID, 1, p门诊医嘱下达)
End Sub

Private Sub lbl单量_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim objPopup As CommandBar
    Dim objControl As CommandBarControl
    Dim vRect As RECT, strSQL As String
    Dim str单位 As String
    Dim rsTmp As Recordset
    
    On Error GoTo errH
    
    If Not (InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) > 0 And txt单量.Enabled) Then Exit Sub
    
    If mrsDrugScale Is Nothing Then
        strSQL = "Select 名称,比例,编码 From 常用剂量比例 Where 名称 is Not NULL And 比例 is Not NULL Order by 编码"
        Set mrsDrugScale = zlDatabase.OpenSQLRecord(strSQL, Me.Caption)
        
        If mrsDrugScale.EOF Then
            MsgBox "没有设置常用剂量比例，请先到字典管理工具进行设置。", vbInformation, gstrSysName
            Exit Sub
        End If
    Else
        mrsDrugScale.Filter = 0
        mrsDrugScale.Sort = "编码"
    End If
    
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_收费细目ID) <> 0 Then
        Set rsTmp = Get收费项目记录(Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_收费细目ID)))
        str单位 = rsTmp!计算单位 & ""
    End If
    
    Set objPopup = cbsMain.Add("Popup", xtpBarPopup)
    With objPopup.Controls
        mrsDrugScale.MoveFirst
        Do While Not mrsDrugScale.EOF
            Set objControl = .Add(xtpControlButton, conMenu_DrugScale * 100# + .Count + 1, mrsDrugScale!名称 & "[" & str单位 & "]")
            objControl.Parameter = mrsDrugScale!比例
            mrsDrugScale.MoveNext
        Loop
    End With
    GetWindowRect fraAdvice.hwnd, vRect
    objPopup.ShowPopup , vRect.Left * Screen.TwipsPerPixelX + lbl单量.Left + lbl单量.Width, vRect.Top * Screen.TwipsPerPixelY + lbl单量.Top
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub lbl滴速_Click()
    If lbl滴速.Caption = "滴速" Then Exit Sub '用血医嘱的滴速不可切换
    Call Load输液滴速(cbo滴速, lbl滴速单位, True)
    cbo滴速.Tag = "1"
    Call AdviceChange
End Sub

Private Sub mfrmPrice_PanelHide()
    Call stbThis_PanelClick(stbThis.Panels("Price"))
End Sub

Private Sub mfrmSend_EditDiagnose(ParentForm As Object, ByVal 挂号单 As String, Succeed As Boolean)
    RaiseEvent EditDiagnose(ParentForm, 挂号单, Succeed)
End Sub

Private Sub mfrmShortCut_ItemClick(ByVal 类型 As Integer, ByVal 分类ID As Long)
    If cmdSel.Enabled And cmdSel.Visible Then
        Call ClinicSelecter(类型, 分类ID)
    End If
End Sub

Private Sub mnu_replaceItem_Click()
    If mlngCommonID <> 0 Then
        SetInputAdvice mlngCommonID, , , 1
    End If
End Sub

Private Sub optState_Click(Index As Integer)
    Dim strSQL As String
    On Error GoTo errH
    mbln复诊 = Index = 1
    If optState(Index).Tag = "" Then '复诊状态切换了
        strSQL = "Zl_病人挂号记录_复诊(" & mlng挂号ID & "," & Index & ")"
        Call zlDatabase.ExecuteProcedure(strSQL, "标记为复诊")
        optState(Index).Tag = "1": optState(1 - Index).Tag = ""
    End If
        optState(0).TabStop = False
    optState(1).TabStop = False
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub picHelp_Click()
    Dim strTip As String
    
    On Error Resume Next
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "周" Then
        strTip = COL_按周执行
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "天" Then
        strTip = COL_按天执行
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "小时" Then
        strTip = COL_按时执行
    End If
    MsgBox strTip, vbInformation, Me.Caption
    cbo执行时间.SetFocus
    mblnIsInHelp = False
End Sub

Private Sub picHelp_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim strTip As String
    
    On Error Resume Next
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "周" Then
        strTip = COL_按周执行
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "天" Then
        strTip = COL_按天执行
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "小时" Then
        strTip = COL_按时执行
    End If
    
    zlCommFun.ShowTipInfo picHelp.hwnd, strTip, True
    
    If X >= 0 And X <= picHelp.Width And Y >= 0 And Y <= picHelp.Height Then
        mblnIsInHelp = True
        SetCapture picHelp.hwnd
    Else
        mblnIsInHelp = False
        ReleaseCapture
    End If
End Sub

Private Sub stbThis_PanelClick(ByVal Panel As MSComctlLib.Panel)
    If Panel.Key = "Price" Then
        If Panel.Bevel <> sbrNoBevel Then
            Panel.Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
            Panel.Tag = IIF(Panel.Bevel = sbrInset, "1", "")
            Call ShowPrice(vsAdvice.Row)
        End If
    ElseIf Panel.Bevel = sbrRaised And (Panel.Key = "PY" Or Panel.Key = "WB") Then
        '切换并保存简码匹配方式
        Panel.Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
        If Panel.Key = "PY" Then
            stbThis.Panels("WB").Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
        Else
            stbThis.Panels("PY").Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
        End If
        Call zlDatabase.SetPara("简码方式", IIF(stbThis.Panels("PY").Bevel = sbrInset And stbThis.Panels("WB").Bevel = sbrInset, 2, IIF(stbThis.Panels("WB").Bevel = sbrInset, 1, 0)))
        mint简码 = IIF(stbThis.Panels("PY").Bevel = sbrInset And stbThis.Panels("WB").Bevel = sbrInset, 2, IIF(stbThis.Panels("WB").Bevel = sbrInset, 1, 0))
    ElseIf Panel.Key = "KB" Then
        On Error Resume Next
        If mobjKeyBoard Is Nothing Then Set mobjKeyBoard = CreateObject("zlScreenKeyboard.clsKeyBoard")
        Call mobjKeyBoard.StartUp
        Call mobjKeyBoard.SetPos
        err.Clear: On Error GoTo 0
    End If
End Sub

Private Sub txt超量说明_GotFocus()
    Call zlControl.TxtSelAll(txt超量说明)
End Sub

Private Sub txt超量说明_Change()
    txt超量说明.Tag = "1"
End Sub

Private Sub txt超量说明_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt超量说明.Text <> "" Then
            If ReasonSelect(txt超量说明.Text, 3) Then Exit Sub
        End If
        If SeekNextControl Then Call txt超量说明_Validate(False)
    End If
End Sub

Private Sub txt超量说明_Validate(Cancel As Boolean)
    Call AdviceChange
End Sub

Private Sub txt单量_KeyDown(KeyCode As Integer, Shift As Integer)
    If Shift = vbCtrlMask And KeyCode = 192 Then '~
        Call lbl单量_MouseDown(1, 0, 0, 0)
    End If
End Sub

Private Sub txt单量_LostFocus()
    mblnReturn = False
    stbThis.Panels(2).Text = ""
End Sub

Private Sub txt频率_GotFocus()
    Call zlControl.TxtSelAll(txt频率)
End Sub

Private Sub txt频率_KeyPress(KeyAscii As Integer)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim int范围 As Integer, vRect As RECT
    Dim lng诊疗项目ID As Long, lngFind As Long
    
    With vsAdvice
        If KeyAscii = 13 Then
            KeyAscii = 0
            If cmd频率.Tag <> "" And txt频率.Text = .TextMatrix(.Row, COL_频率) And txt频率.Text <> "" Then
                Call SeekNextControl
            ElseIf txt频率.Text = "" Then
                If cmd频率.Enabled And cmd频率.Visible Then cmd频率_Click
            Else
                int范围 = Get频率范围(.Row)
                
                '可选择频率的常用频率
                lng诊疗项目ID = Val(.TextMatrix(.Row, COL_诊疗项目ID))
                If RowIn检验行(.Row) Then
                    lngFind = .FindRow(CStr(.RowData(.Row)), .FixedRows, COL_相关ID)
                    If lngFind <> -1 Then
                        lng诊疗项目ID = Val(.TextMatrix(lngFind, COL_诊疗项目ID))
                    End If
                ElseIf InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                    lngFind = .FindRow(CLng(.TextMatrix(.Row, COL_相关ID)), .Row + 1)
                    If lngFind <> -1 Then
                        lng诊疗项目ID = Val(.TextMatrix(lngFind, COL_诊疗项目ID))
                    End If
                End If
                strSQL = ""
                If int范围 = 1 Then
                    strSQL = " And (Exists(Select 1 From 诊疗用法用量 Where 项目ID=[4] And 用法ID is NULL And 频次=A.编码 And A.适用范围=1)" & _
                        " Or (Select Count(*) From 诊疗用法用量 Where 项目ID=[4] And 用法ID is NULL And 频次 Is Not NULL)<=1)"
                End If
                strSQL = "Select Rownum as ID,A.编码,A.名称,A.简码," & _
                    " A.英文名称,A.频率次数,A.频率间隔,A.间隔单位" & _
                    " From 诊疗频率项目 A Where A.适用范围=[3]" & strSQL & _
                    " And (A.编码 Like [1] Or Upper(A.名称) Like [2]" & _
                    " Or Upper(A.简码) Like [2] Or Upper(A.英文名称) Like [2])" & _
                    " Order by A.编码"
                vRect = zlControl.GetControlRect(txt频率.hwnd)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, "诊疗频率", False, "", "", False, False, True, _
                    vRect.Left, vRect.Top, txt频率.Height, blnCancel, False, True, UCase(txt频率.Text) & "%", mstrLike & UCase(txt频率.Text) & "%", int范围, lng诊疗项目ID)
                If rsTmp Is Nothing Then
                    If Not blnCancel Then
                        MsgBox "未找到匹配的诊疗频率项目。", vbInformation, gstrSysName
                    End If
                    txt频率.Text = .TextMatrix(.Row, COL_频率)
                    Call zlControl.TxtSelAll(txt频率)
                    txt频率.SetFocus: Exit Sub
                End If
                Call Set频率Input(rsTmp, int范围)
                Call SeekNextControl
            End If
        End If
    End With
End Sub

Private Sub txt安排时间_Change()
    txt安排时间.Tag = "1"
End Sub

Private Sub txt安排时间_GotFocus()
    If txt安排时间.Text = "" Then txt安排时间.Text = msk开始时间.Text
    zlControl.TxtSelAll txt安排时间
End Sub

Private Sub txt安排时间_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt安排时间.Text <> "" Then
            txt安排时间.Text = zlStr.FullDate(txt安排时间.Text)
            If SeekNextControl Then Call txt安排时间_Validate(False)
        End If
    Else
        If InStr("0123456789 /-:" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txt安排时间_Validate(Cancel As Boolean)
    If txt安排时间.Locked Then Exit Sub
        
    If Not IsDate(txt安排时间.Text) Then
        If txt安排时间.Text <> "" Then
            Cancel = True
            txt安排时间_GotFocus
            Exit Sub
        ElseIf vsAdvice.RowData(vsAdvice.Row) <> 0 Then
            If IsDate(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_开始时间)) Then
                '恢复人为的清除缺省为开始时间
                txt安排时间.Text = vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_开始时间)
            End If
        End If
    Else
        '检查时间合法性
        If Not Check安排时间(txt安排时间.Text, vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_开始时间), vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) Then
            Cancel = True
            txt安排时间_GotFocus
            Exit Sub
        End If
    End If
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub txt天数_Change()
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If Val(.TextMatrix(.Row, COL_天数)) <> Val(txt天数.Text) Then
                txt天数.Tag = "1"
            End If
        Else
            txt天数.Tag = "1"
        End If
    End With
End Sub

Private Sub txt天数_GotFocus()
    Call zlControl.TxtSelAll(txt天数)
End Sub

Private Sub txt天数_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If Val(txt天数.Text) > 0 Then
            Call txt天数_Validate(blnCancel)
            If Not blnCancel Then mblnReturn = True: Call SeekNextControl
        Else
            If Val(txt天数.Text) = 0 Then txt天数.Text = ""
        End If
    Else
        If InStr("0123456789" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txt天数_LostFocus()
    mblnReturn = False
End Sub

Private Sub txt天数_Validate(Cancel As Boolean)
    Dim sng天数 As Single, i As Long
    Dim strSame As String, strMsg As String
    Dim dbl总量 As Double
    Dim strTmpTag As String
    Dim bln计算总量 As Boolean
        
    With vsAdvice
        If Val(txt天数.Text) = 0 Then txt天数.Text = ""
        If mblnReturn Then mblnReturn = False: Exit Sub
        If Val(txt天数.Text) <= 0 Then
            Cancel = True: txt天数_GotFocus: Exit Sub
        End If
        
        '天数至少需要一个频率同期的天数
        If Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 Then
            If .TextMatrix(.Row, COL_间隔单位) = "周" Then
                sng天数 = 7
            ElseIf .TextMatrix(.Row, COL_间隔单位) = "天" Then
                sng天数 = Val(.TextMatrix(.Row, COL_频率间隔))
            ElseIf .TextMatrix(.Row, COL_间隔单位) = "小时" Then
                sng天数 = Val(.TextMatrix(.Row, COL_频率间隔)) \ 24
            ElseIf .TextMatrix(.Row, COL_间隔单位) = "分钟" Then
                sng天数 = Val(.TextMatrix(.Row, COL_频率间隔)) \ (24 * 60)
            End If
            If Val(txt天数.Text) < sng天数 Then
                If MsgBox("按""" & .TextMatrix(.Row, COL_频率) & """执行时，至少需要 " & sng天数 & " 天的用药，要继续吗？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                    Cancel = True: txt天数_GotFocus: Exit Sub
                End If
            End If
        End If
        
        dbl总量 = Val(txt总量.Text)
        mdblPre总量 = dbl总量
        
        If mbln天数反算 Then
            '如果总量为0或者说天数变了则计算下总量
            If dbl总量 = 0 Or Val(txt天数.Text) <> msngPre天数 Then
                bln计算总量 = True
            End If
        Else
            bln计算总量 = True
        End If
        
        If bln计算总量 Then
            txt总量.Text = ReGet药品总量(dbl总量, Val(txt单量.Text), Val(txt天数.Text), .Row) '隐式调用Change事件

            Call txt总量_Validate(Cancel)
            If Cancel Then
                txt总量.Text = dbl总量
                Exit Sub
            End If
        End If
                         
        Call CheckDrugOutOfRange(.Row, Val(txt天数.Text))
        
        msng天数 = Val(txt天数.Text)

    End With
    msngPre天数 = Val(txt天数.Text)
    mdblPre总量 = Val(txt总量.Text)
    Call AdviceChange
    
    '成套方案批量处理
    With vsAdvice
        If CStr(.Cell(flexcpData, .Row, COL_EDIT)) <> "" Then
            strSame = CStr(.Cell(flexcpData, .Row, COL_EDIT))
            If InStr(strSame, ",") > 0 Then
                strMsg = "该次复制的所有的药品都按这个天数执行吗？"
            Else
                strMsg = "该成套方案的所有药品都按这个天数执行吗？"
            End If
            If MsgBox(strMsg, vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbYes Then
                For i = .FixedRows To .Rows - 1
                    If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                        If Not (Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(.Row, COL_相关ID)) _
                            Or .RowData(i) = Val(.TextMatrix(.Row, COL_相关ID)) Or i = .Row) _
                                And CStr(.Cell(flexcpData, i, COL_EDIT)) = strSame Then
                                
                            If .TextMatrix(i, COL_频率) <> "" And Val(.TextMatrix(i, COL_频率次数)) <> 0 And Val(.TextMatrix(i, COL_频率间隔)) <> 0 _
                                And Val(.TextMatrix(i, COL_单量)) <> 0 And Val(.TextMatrix(i, COL_剂量系数)) <> 0 And Val(.TextMatrix(i, COL_门诊包装)) <> 0 Then
                                
                                .TextMatrix(i, COL_天数) = txt天数.Text
                                .TextMatrix(i, COL_总量) = ReGet药品总量(Val(.TextMatrix(i, COL_总量)), Val(.TextMatrix(i, COL_单量)), Val(txt天数.Text), i)
                                If Val(.TextMatrix(i, COL_相关ID)) = Val(.RowData(i + 1)) Then
                                    .TextMatrix(i + 1, COL_天数) = txt天数.Text
                                End If
                            End If
                        End If
                    End If
                Next
            End If
        End If
    End With
End Sub

Private Sub txt用法_KeyPress(KeyAscii As Integer)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim int类型 As Integer, vRect As RECT
    Dim lngBegin As Long, lngEnd As Long
    Dim strLike As String, i As Long
    Dim lng项目id As Long
    Dim blnDrugUseM As Boolean
    
    With vsAdvice
        If KeyAscii = 13 Then
            KeyAscii = 0
            If Val(cmd用法.Tag) <> 0 And txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法)) And txt用法.Text <> "" Then
                Call SeekNextControl
            ElseIf txt用法.Text = "" Then
                If cmd用法.Enabled And cmd用法.Visible Then cmd用法_Click
            Else
                If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                    int类型 = 2 '给药途径
                    blnDrugUseM = CheckDrugUseM(Val(.TextMatrix(.Row, COL_收费细目ID)), Val(.TextMatrix(.Row, COL_诊疗项目ID)))
                ElseIf RowIn检验行(vsAdvice.Row) Then
                    int类型 = 6 '采集方法
                ElseIf .TextMatrix(.Row, COL_类别) = "K" Then
                    int类型 = 8 '输血途径
                Else
                    int类型 = 4 '中药用法
                End If
                lng项目id = Val(.TextMatrix(.Row, COL_诊疗项目ID))
                If int类型 = 2 Then '只取有效范围的给药途径(无设置或仅一个时可任选)
                    lng项目id = Val(.TextMatrix(.Row, COL_收费细目ID))
                    strSQL = " And (A.ID IN(Select 用法ID From 药品用法用量 Where 药品ID=[4] And 性质=1)" & _
                        " Or (Select Count(A.用法ID) From 药品用法用量 A,诊疗项目目录 B" & _
                        " Where A.用法ID=B.ID And B.服务对象 IN(1,3) And A.药品ID=[4] And A.性质=1)<=" & IIF(blnDrugUseM, "0", "1") & ")"
                End If
                
                '优化
                strLike = mstrLike
                If Len(txt用法.Text) < 2 Then strLike = ""
                
                strSQL = "Select Distinct A.ID,A.编码,A.名称,A.执行分类 as 执行分类ID" & _
                    " From 诊疗项目目录 A,诊疗项目别名 B" & _
                    " Where A.ID=B.诊疗项目ID" & _
                    " And A.类别='E' And A.操作类型=[3] And A.服务对象 IN(1,3)" & strSQL & _
                    " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 IS NULL)" & _
                    " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
                    " And (A.编码 Like [1] Or B.名称 Like [2] Or B.简码 Like [2])" & _
                    " And (Exists(Select 1 From 诊疗适用科室 Where 项目ID=A.ID And 科室ID=[6])" & _
                            " Or Not Exists(Select 1 From 诊疗适用科室 Where 项目ID=A.ID))" & _
                    Decode(mint简码, 0, " And B.码类 IN([5],3)", 1, " And B.码类 IN([5],3)", "") & _
                    " Order by A.编码"
                vRect = zlControl.GetControlRect(txt用法.hwnd)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl用法.Caption, False, "", "", False, False, True, _
                    vRect.Left, vRect.Top, txt用法.Height, blnCancel, False, True, UCase(txt用法.Text) & "%", _
                    strLike & UCase(txt用法.Text) & "%", CStr(int类型), lng项目id, mint简码 + 1, mlng病人科室id)
                If rsTmp Is Nothing Then
                    If Not blnCancel Then
                        MsgBox "未找到匹配的" & lbl用法.Caption & "。", vbInformation, gstrSysName
                    End If
                    txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法))
                    Call zlControl.TxtSelAll(txt用法)
                    txt用法.SetFocus: Exit Sub
                End If
                
                '对一并给药的其它药品的可用给药途径进行检查
                If int类型 = 2 Then
                    Call Get一并给药范围(Val(.TextMatrix(.Row, COL_相关ID)), lngBegin, lngEnd)
                    For i = lngBegin To lngEnd
                        If i <> .Row And .RowData(i) <> 0 Then
                            If Not Check适用用法(rsTmp!ID, Val(.TextMatrix(i, COL_诊疗项目ID)), 1, Val(.TextMatrix(i, COL_收费细目ID))) Then
                                .Refresh
                                MsgBox """" & rsTmp!名称 & """不适用于与当前药品一并给药的""" & .TextMatrix(i, col_医嘱内容) & """。", vbInformation, gstrSysName
                                .Refresh
                                txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法))
                                Call zlControl.TxtSelAll(txt用法)
                                txt用法.SetFocus: Exit Sub
                            End If
                        End If
                    Next
                End If
                
                Call Set用法Input(rsTmp, int类型)
                Call SeekNextControl
            End If
        End If
    End With
End Sub

Private Sub cmd用法_Click()
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim int类型 As Integer, vRect As RECT
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim strSeek As String
    Dim lng项目id As Long
    Dim strWhere As String
    Dim blnDrugUseM As Boolean
    
    With vsAdvice
        If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
            int类型 = 2 '给药途径
            lngBegin = .FindRow(CLng(Val(.TextMatrix(.Row, COL_相关ID))), .Row + 1)
            blnDrugUseM = CheckDrugUseM(Val(.TextMatrix(.Row, COL_收费细目ID)), Val(.TextMatrix(.Row, COL_诊疗项目ID)))
        ElseIf RowIn检验行(vsAdvice.Row) Then
            int类型 = 6 '采集方法
            lngBegin = .Row
        ElseIf .TextMatrix(.Row, COL_类别) = "K" Then
            If gbln血库系统 = True Then
                If Val(.TextMatrix(.Row, COL_检查方法)) = 0 Then
                    int类型 = 9 '采集输血途径
                Else
                    int类型 = 8 '输血途径
                    strWhere = " And nvl(A.执行分类,0)=1 "
                End If
            Else
                int类型 = 8 '输血途径
            End If
            lngBegin = .FindRow(CStr(.RowData(.Row)), .Row + 1, COL_相关ID)
        Else
            int类型 = 4 '中药用法
            lngBegin = .Row
        End If
        If txt用法.Text <> "" And lngBegin <> -1 Then
            strSeek = Sys.RowValue("诊疗项目目录", Val(.TextMatrix(lngBegin, COL_诊疗项目ID)), "编码")
        End If
        lng项目id = Val(.TextMatrix(.Row, COL_诊疗项目ID))
        If int类型 = 2 Then '只取有效范围的给药途径(无设置或仅一个时可任选)
            lng项目id = Val(.TextMatrix(.Row, COL_收费细目ID))
            strSQL = " And (A.ID IN(Select 用法ID From 药品用法用量 Where 药品ID=[2] And 性质=1)" & _
                " Or (Select Count(A.用法ID) From 药品用法用量 A,诊疗项目目录 B" & _
                " Where A.用法ID=B.ID And B.服务对象 IN(1,3) And A.药品ID=[2] And A.性质=1)<=" & IIF(blnDrugUseM, "0", "1") & ")"
        End If
        strSQL = "Select Distinct A.ID,A.编码,A.名称,C.名称 as 分类,A.执行分类 as 执行分类ID" & _
            " From 诊疗项目目录 A,诊疗分类目录 C" & _
            " Where A.分类ID=C.ID(+) And A.类别='E' And A.操作类型=[1] And A.服务对象 IN(1,3)" & strWhere & strSQL & _
            " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 IS NULL)" & _
            " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
            " And (Exists(Select 1 From 诊疗适用科室 Where 项目ID=A.ID And 科室ID=[3])" & _
            " Or Not Exists(Select 1 From 诊疗适用科室 Where 项目ID=A.ID))" & _
            " Order by A.编码"
        vRect = zlControl.GetControlRect(txt用法.hwnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl用法.Caption, False, strSeek, "", False, False, True, _
            vRect.Left, vRect.Top, txt用法.Height, blnCancel, False, True, CStr(int类型), lng项目id, mlng病人科室id)
        If rsTmp Is Nothing Then
            If Not blnCancel Then
                MsgBox "没有可用的" & lbl用法.Caption & "，请先到诊疗项目管理中设置。", vbInformation, gstrSysName
            End If
            txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法))
            Call zlControl.TxtSelAll(txt用法)
            txt用法.SetFocus: Exit Sub
        End If
        
        '对一并给药的其它药品的可用给药途径进行检查
        If int类型 = 2 Then
            Call Get一并给药范围(Val(.TextMatrix(.Row, COL_相关ID)), lngBegin, lngEnd)
            For i = lngBegin To lngEnd
                If i <> .Row And .RowData(i) <> 0 Then
                    If Not Check适用用法(rsTmp!ID, Val(.TextMatrix(i, COL_诊疗项目ID)), 1, Val(.TextMatrix(i, COL_收费细目ID))) Then
                        .Refresh
                        MsgBox """" & rsTmp!名称 & """不适用于与当前药品一并给药的""" & .TextMatrix(i, col_医嘱内容) & """。", vbInformation, gstrSysName
                        .Refresh
                        txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法))
                        Call zlControl.TxtSelAll(txt用法)
                        txt用法.SetFocus: Exit Sub
                    End If
                End If
            Next
        End If
        
        Call Set用法Input(rsTmp, int类型)
        txt用法.SetFocus
        Call SeekNextControl
    End With
End Sub

Private Sub txt用法_GotFocus()
    Call zlControl.TxtSelAll(txt用法)
End Sub

Private Sub txt用法_Validate(Cancel As Boolean)
    With vsAdvice
        '恢复人为的清除
        If Val(cmd用法.Tag) <> 0 And txt用法.Text <> IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法)) Then
            txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法))
        End If
    End With
End Sub

Private Sub txt频率_Validate(Cancel As Boolean)
    With vsAdvice
        '恢复人为的清除
        If cmd频率.Tag <> "" And txt频率.Text <> .TextMatrix(.Row, COL_频率) Then
            txt频率.Text = .TextMatrix(.Row, COL_频率)
        End If
    End With
End Sub

Private Sub cbo婴儿_Click()
    If Not Visible Then Exit Sub
    If cbo婴儿.ListIndex = -1 Then Exit Sub
    
    If cbo婴儿.ListIndex = Val(cbo婴儿.Tag) Then Exit Sub
    cbo婴儿.Tag = cbo婴儿.ListIndex
    
    Call ShowAdvice
    'PASS 婴儿发生改变
    If mblnPass Then
        mobjPassMap.PassPati.int婴儿 = cbo婴儿.ListIndex
    End If
    vsAdvice.SetFocus
End Sub

Private Function GetInputRow(ByVal lngRow As Long) As Long
'功能：医嘱输入时的当前行
    Dim i As Long
    
    With vsAdvice
        '修改已有项目时,先删除当前医嘱的内容
        '---------------------------------------------------------------------------------------------------------------
        If .RowData(lngRow) <> 0 Then
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '一并给药的情况已经在前面判断。
                '单个成药删除给药途径行,并清除当前行
                i = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                Call DeleteRow(i)
                Call DeleteRow(lngRow, True)
            ElseIf InStr(",D,F,K,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '检查组合项目，手术项目，输血医嘱
                '删除部位行，或手术附加行(附加手术,麻醉项目)，或输血途径
                Call Delete检查手术输血(lngRow)
                '清除当前行
                Call DeleteRow(lngRow, True)
            ElseIf RowIn配方行(lngRow) Then
                '中药配方：顺序(序号)要求必须严格控制
                '删除组成味药及煎法行:删除之后重新定位的当前行
                lngRow = Delete中药配方(lngRow)
                '清除当前行(中药用法行)
                Call DeleteRow(lngRow, True)
            ElseIf RowIn检验行(lngRow) Then
                '删除检验项目行:删除之后重新定位的当前行
                lngRow = Delete检验组合(lngRow)
                '清除当前行(采集方法行)
                Call DeleteRow(lngRow, True)
            Else
                '其它项目直接清除当前行内容
                Call DeleteRow(lngRow, True)
            End If
        End If
    End With
    GetInputRow = lngRow
End Function

Private Function ApplyBefore() As Boolean
'功能：点工具栏申请单按钮前时调用
    Dim i As Long
    
    With vsAdvice
        If .RowData(.Row) = 0 Then

        ElseIf .RowData(.Rows - 1) = 0 Then
            .Row = .Rows - 1
        Else
            '先删除中间间隔的空行
            mblnRowChange = False
            For i = .Rows - 1 To .FixedRows Step -1
                If .RowData(i) = 0 Then .RemoveItem i
            Next
            mblnRowChange = True
            
            .AddItem "", .Rows
            .Row = .Rows - 1
            .Col = .FixedCols
        End If
        Call .ShowCell(.Row, .Col)
        If Visible And txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
    End With
    ApplyBefore = True
End Function

Private Function ApplySelect() As Integer
'功能：弹出申请单选择器
    Dim strSQL As String, rsTmp As ADODB.Recordset
    Dim intTmp As Integer, blnCancel As Boolean
    Dim vRect As RECT
    
    If mint场合 <> 0 Then Exit Function
     
    intTmp = Val(Mid(gstrOutUseApp, 1, 1))
    If intTmp = 1 Then strSQL = "select 1 as id,'检查申请单' as 申请单 from dual"
    intTmp = Val(Mid(gstrOutUseApp, 2, 1))
    If intTmp = 1 And Not gobjLIS Is Nothing Then strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 2 as id,'检验申请单' as 申请单 from dual"
    intTmp = Val(Mid(gstrOutUseApp, 3, 1))
    If intTmp = 1 Then strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 3 as id,'输血申请单' as 申请单 from dual"
    intTmp = Val(Mid(gstrOutUseApp, 4, 1))
    If intTmp = 1 Then strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 4 as id,'手术申请单' as 申请单 from dual"
    strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 5 as id,'预约入院' as 申请单 from dual"
    strSQL = strSQL & " order by id"

    On Error GoTo errH
    vRect = zlControl.GetControlRect(txt医嘱内容.hwnd)
    Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, Me.Caption, , , , , , True, vRect.Left, vRect.Top, txt医嘱内容.Height, blnCancel, , True)
    If Not rsTmp Is Nothing Then ApplySelect = Val(rsTmp!ID & "")
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function CanUseApply(ByVal str类别 As String, Optional ByVal lng项目id As Long, Optional ByVal str项目编码 As String) As Boolean
'功能：是否可以使用相应的申请单
    '只用在医生工作站
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim blnTmp As Boolean
        Dim str编码 As String
    Dim strEx As String
 
    If mint场合 <> 0 Or mbytUseType <> 0 Then
        Exit Function
    End If
    
    If str类别 = "D" And Val(Mid(gstrOutUseApp, 1, 1)) = 1 Or _
        str类别 = "C" And Val(Mid(gstrOutUseApp, 2, 1)) = 1 Or _
        str类别 = "K" And Val(Mid(gstrOutUseApp, 3, 1)) = 1 Or _
        (str类别 = "F" Or str类别 = "G") And Val(Mid(gstrOutUseApp, 4, 1)) = 1 Then
        blnTmp = True
    End If
    
    If lng项目id <> 0 And blnTmp Then
        If str类别 = "D" Then
            strSQL = "select 1 from 病历单据应用 where 诊疗项目ID=[1] and 应用场合 = [2]"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng项目id, 1)
            If rsTmp.EOF Then blnTmp = False
        ElseIf str类别 = "C" Then
            blnTmp = False
            If Not gobjLIS Is Nothing Then
                If str项目编码 <> "" Then
                    str编码 = str项目编码
                Else
                    str编码 = Sys.RowValue("诊疗项目目录", lng项目id, "编码")
                End If
                On Error Resume Next
                blnTmp = gobjLIS.CanUseLISApp(str编码, strEx)
                err.Clear: On Error GoTo 0
            End If
        End If
    End If
    CanUseApply = blnTmp
End Function

Private Sub AdviceInput申请单(ByVal intType As Integer)
'功能：输入诊疗项目后弹出申请单
    Dim str类别 As String
    Dim lngRow As Long
    Dim blnOK As Boolean
    Dim objAppPages() As clsApplicationData
    Dim rsCard As ADODB.Recordset
    Dim strDiags As String
 
    On Error Resume Next
    '新增
    cbsMain.FindControl(, conMenu_New, True, True).Execute
    lngRow = vsAdvice.Row
    Call AdviceHaveDiag(lngRow - 1, 0, strDiags)
    Select Case intType
    Case 1 '检查申请
        blnOK = ApplyNew检查申请(0, "", objAppPages())
    Case 2 '检验申请
        blnOK = ApplyNew检验申请(0, "", rsCard)
    Case 3 '输血申请
        blnOK = ApplyNew输血申请(0, "", rsCard)
    Case 4 '手术申请
        blnOK = ApplyNew手术申请(0, "", rsCard)
    Case 5
        Call Apply特殊(vsAdvice.Row, 2)
    End Select
    err.Clear
    
    On Error GoTo errH
    '根据选择项目设置缺省医嘱信息
    If blnOK Then
        Select Case intType
        Case 1 '检查申请
            Call AdviceSet检查申请(lngRow, objAppPages(), strDiags)
        Case 2 '检验申请
            Call AdviceSet检验申请(lngRow, rsCard, strDiags)
        Case 3 '输血申请
            Call AdviceSet输血申请(lngRow, rsCard, strDiags)
        Case 4 '手术申请
            Call AdviceSet手术申请(lngRow, rsCard, strDiags)
        End Select
        
        '显示已缺省设置的值
        Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
        Call CalcAdviceMoney '显示新开医嘱金额
        '医保管控实时监测
        If mint险类 <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
            '总量不可输入：缺省并固定总量的医嘱，以及长嘱
            '成套医嘱不在这里检查
            If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) And Not txt总量.Enabled Then
                If MakePriceRecord(vsAdvice.Row) Then
                    If Not gclsInsure.CheckItem(mint险类, 0, 0, mrsPrice) Then
                        Call AdviceCurRowClear: Exit Sub
                    End If
                End If
                '标记为已经作了检查
                vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_状态) = 1
            End If
        End If
        txt医嘱内容.SetFocus: Call SeekNextControl '必须先定位
        mblnNoSave = True
    Else
        '恢复原值(AdviceInput函数中可能处理了一下)
        txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容)
        txt医嘱内容.SetFocus
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub Apply特殊(ByVal lngRow As Long, ByVal intType As Long)
'功能：门诊入院医嘱 申请定位缺省
'参数：intType 2-入院医嘱
    Dim strSQL As String
    Dim strDepts As String
    Dim rsTmp As ADODB.Recordset
    
    strSQL = "Select a.名称,Null As 处方职务id,a.Id As 诊疗项目id, Null As 收费细目id,a.类别 As 类别id,'住院' As 项目特性,Null As 药品剂型,Null As 规格" & _
        " From 诊疗项目目录 A" & _
        " Where a.类别 = 'Z' And a.操作类型 =[1]  And (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And" & _
        " Instr([3], ',' || a.服务对象 || ',') > 0 and (Exists (Select 1 From 诊疗适用科室 Where 项目id = a.Id And Instr([2], ',' || 科室id || ',') > 0) Or Not Exists" & _
        "       (Select 1 From 诊疗适用科室 Where 项目id = a.Id))"
    
    On Error GoTo errH
    
    strDepts = "," & GetUser科室IDs & ","
    
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, intType, strDepts, ",1,3,")
    
    If Not rsTmp.EOF Then
        If AdviceInput(rsTmp, lngRow) Then
            Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
            '医保管控实时监测
            If mint险类 <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
                '总量不可输入：缺省并固定总量的医嘱，以及长嘱
                '成套医嘱不在这里检查
                If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) And Not txt总量.Enabled Then
                    If MakePriceRecord(vsAdvice.Row) Then
                        If Not gclsInsure.CheckItem(mint险类, 1, 0, mrsPrice) Then
                            Call AdviceCurRowClear: Exit Sub
                        End If
                    End If
                    '标记为已经作了检查
                    vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_状态) = 1
                End If
            End If
            Call SeekNextControl
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub Update医嘱序号(ByVal colSQL As Collection)
'提交事务
    Dim blnTrans As Boolean
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    Dim i As Long
    Screen.MousePointer = 11
    
    gcnOracle.BeginTrans: blnTrans = True
    For i = 1 To colSQL.Count
        Call zlDatabase.ExecuteProcedure(CStr(colSQL(i)), Me.Caption)
    Next
    gcnOracle.CommitTrans: blnTrans = False
    
    strSQL = "Select Count(*) as Num From (Select 序号,Count(ID) From 病人医嘱记录 Where 病人ID+0=[1] And 挂号单=[2] Having Count(ID)>1 Group by 序号)"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mstr挂号单)
    If Not rsTmp.EOF Then
        If NVL(rsTmp!Num, 0) <> 0 Then
            strSQL = "ZL_病人医嘱记录_更新序号(NULL,NULL," & mlng病人ID & ",'" & mstr挂号单 & "')"
            Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
        End If
    End If
    Screen.MousePointer = 0
    Exit Sub
errH:
    Screen.MousePointer = 0
    If blnTrans Then gcnOracle.RollbackTrans
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub cbo执行科室_Click()
    Dim rsTmp As ADODB.Recordset
    Dim lngRow As Long, strSQL As String
    Dim intIdx As Integer, i As Long
    Dim vRect As RECT, blnCancel As Boolean
    Dim lng配制中心 As Long, str药房IDs As String
    Dim lngBegin As Long, lngEnd As Long, blnNode As Boolean, bln入院 As Boolean, bln留观 As Boolean
        
    If cbo执行科室.ListIndex = -1 Then Exit Sub
    
    If cbo执行科室.ItemData(cbo执行科室.ListIndex) = -1 Then
        
        blnNode = True
        If vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "Z" Then   '入院或留观
            bln入院 = vsAdvice.TextMatrix(vsAdvice.Row, COL_操作类型) = "2"
            bln留观 = vsAdvice.TextMatrix(vsAdvice.Row, COL_操作类型) = "1" '可以为门诊或住院留观
            blnNode = Not (bln入院 Or bln留观)
        End If
    
        '他科执行，弹出选择执行科室
        strSQL = "Select Distinct A.ID,A.编码,A.名称,A.简码" & _
            " From 部门表 A,部门性质说明 B" & _
            " Where A.ID=B.部门ID And B.服务对象 IN(" & IIF(bln入院, "2", IIF(bln留观, "1,2", "1")) & ",3)" & _
            IIF(blnNode, " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)", "") & _
            IIF(bln入院 Or bln留观, " And B.工作性质='临床'", "") & _
            " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 is NULL)" & _
            " Order by A.编码"
        vRect = zlControl.GetControlRect(cbo执行科室.hwnd)
        Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, lbl执行科室.Caption, , , , , , True, vRect.Left, vRect.Top, cbo执行科室.Height, blnCancel, , True)
        If Not rsTmp Is Nothing Then
            intIdx = Cbo.FindIndex(cbo执行科室, rsTmp!ID)
            If intIdx <> -1 Then
                cbo执行科室.ListIndex = intIdx
            Else
                cbo执行科室.AddItem rsTmp!编码 & "-" & rsTmp!名称, cbo执行科室.ListCount - 1
                cbo执行科室.ItemData(cbo执行科室.NewIndex) = rsTmp!ID
                cbo执行科室.ListIndex = cbo执行科室.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "没有科室数据，请先到部门管理中设置。", vbInformation, gstrSysName
            End If
            '恢复成现有的科室(不引发Click)
            intIdx = Cbo.FindIndex(cbo执行科室, Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_执行科室ID)))
            Call Cbo.SetIndex(cbo执行科室.hwnd, intIdx)
        End If
    Else
        lngRow = vsAdvice.Row
        
        '检查一并给药的配制中心
        With vsAdvice
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 And RowIn一并给药(lngRow) Then
                Call Get一并给药范围(Val(.TextMatrix(lngRow, COL_相关ID)), lngBegin, lngEnd)
                
                '当前行由普通药房或其他配制中心改为配制中心
                If Sys.DeptHaveProperty(cbo执行科室.ItemData(cbo执行科室.ListIndex), "配制中心") Then
                    lng配制中心 = cbo执行科室.ItemData(cbo执行科室.ListIndex)
                End If
                '当前行由配置中心或改为普通药房
                If lng配制中心 = 0 Then
                    For i = lngBegin To lngEnd
                        If i <> lngRow And Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                            '自备药不管它
                            If Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                                If Sys.DeptHaveProperty(Val(.TextMatrix(i, COL_执行科室ID)), "配制中心") Then
                                    lng配制中心 = Val(.TextMatrix(i, COL_执行科室ID)): Exit For
                                End If
                            End If
                        End If
                    Next
                End If
                '这两种情况所有药品都执行科室相同，检查存储设定
                If lng配制中心 <> 0 Then
                    For i = lngBegin To lngEnd
                        If i <> lngRow And Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                            '自备药不管它
                            If Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                                str药房IDs = Get可用药房IDs(.TextMatrix(i, COL_类别), Val(.TextMatrix(i, COL_诊疗项目ID)), Val(.TextMatrix(i, COL_收费细目ID)), mlng病人科室id, 1)
                                If InStr("," & str药房IDs & ",", "," & cbo执行科室.ItemData(cbo执行科室.ListIndex) & ",") = 0 Then
                                    MsgBox "一并给药的药品中，""" & .TextMatrix(i, col_医嘱内容) & """在""" & zlCommFun.GetNeedName(cbo执行科室.Text) & """中没有存储。", vbInformation, gstrSysName
                                    '恢复成现有的科室(不引发Click)
                                    intIdx = Cbo.FindIndex(cbo执行科室, Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_执行科室ID)))
                                    Call Cbo.SetIndex(cbo执行科室.hwnd, intIdx)
                                    Exit Sub
                                End If
                            End If
                        End If
                    Next
                End If
            End If
        End With
        
        cbo执行科室.Tag = "1"
        
        '更新更改了的执行科室医嘱内容
        Call AdviceChange
        
        '重新获取库存并显示：以门诊单位，中药配方不显示
        With vsAdvice
            If (.TextMatrix(lngRow, COL_类别) = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 1 _
                Or InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0) And Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
                Call GetDrugStock(lngRow)
                If InStr(GetInsidePrivs(p门诊医嘱下达), "显示药品库存") = 0 Then
                    stbThis.Panels(3).Text = IIF(Val(.TextMatrix(lngRow, COL_库存)) > 0, "有库存", "无库存")
                Else
                    stbThis.Panels(3).Text = "库存: " & FormatEx(Val(.TextMatrix(lngRow, COL_库存)), 5) & .TextMatrix(lngRow, COL_门诊单位)
                End If
            ElseIf RowIn配方行(lngRow) Then
                Call GetDrugStock(lngRow)
            End If
        End With
    End If
End Sub

Private Sub cbo执行科室_GotFocus()
    Call zlControl.TxtSelAll(cbo执行科室)
End Sub

Private Sub cbo执行科室_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo执行科室.ListIndex = -1 Then
            Call cbo执行科室_Validate(blnCancel)
            cbo执行科室.SetFocus
        Else
            If SeekNextControl Then Call cbo执行科室_Validate(False)
        End If
    End If
End Sub

Private Sub cbo执行科室_Validate(Cancel As Boolean)
'功能：根据输入的内容,自动匹配执行科室
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, intIdx As Long, i As Long
    Dim blnLimit As Boolean, strInput As String, strIDs As String
    Dim vRect As RECT, blnCancel As Boolean
    Dim blnNode As Boolean, bln门诊留观 As Boolean, bln入院 As Boolean
    
    If cbo执行科室.ListIndex <> -1 Then Exit Sub '已选中
    If cbo执行科室.Text = "" Then '无输入
        If cbo执行科室.ListCount > 0 Then Cancel = True
        Exit Sub
    End If
    
    On Error GoTo errH
    
    '是否可以任意或选择科室
    blnLimit = True
    If cbo执行科室.ListCount > 0 Then
        If cbo执行科室.ItemData(cbo执行科室.ListCount - 1) = -1 Then
            blnLimit = False
        End If
    End If
    blnNode = True
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "Z" Then
        If vsAdvice.TextMatrix(vsAdvice.Row, COL_操作类型) = "1" Then
            blnNode = False
            bln门诊留观 = True
        ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_操作类型) = "2" Then
            blnNode = False
            bln入院 = True
        End If
    End If
    
    strInput = UCase(zlCommFun.GetNeedName(cbo执行科室.Text))
    strSQL = "Select Distinct A.ID,A.编码,A.名称,A.简码" & _
        " From 部门表 A,部门性质说明 B" & _
        " Where A.ID=B.部门ID And B.服务对象 IN(" & IIF(bln门诊留观, "1,2", IIF(bln入院, "2", "1")) & ",3)" & _
        IIF(blnNode, " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)", "") & _
        " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 is NULL)" & _
        " And (A.编码 Like [1] Or A.名称 Like [2] Or Upper(A.简码) Like [2])" & _
        " Order by A.编码"
    If blnLimit Then
        'Set rsTmp = New ADODB.Recordset
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strInput & "%", mstrLike & strInput & "%")
        For i = 1 To rsTmp.RecordCount
            intIdx = Cbo.FindIndex(cbo执行科室, rsTmp!ID)
            If intIdx <> -1 Then strIDs = strIDs & "," & rsTmp!ID
            rsTmp.MoveNext
        Next
        
        If strIDs <> "" Then
            strIDs = Mid(strIDs, 2)
            If InStr(strIDs, ",") = 0 Then
                intIdx = Cbo.FindIndex(cbo执行科室, CLng(strIDs))
                If intIdx <> -1 Then cbo执行科室.ListIndex = intIdx
            Else
                strSQL = "Select /*+ rule*/ A.ID,A.编码,A.名称,A.简码 From 部门表 A,Table(f_num2list([1])) B Where A.ID = B.Column_Value"
        
                vRect = zlControl.GetControlRect(cbo执行科室.hwnd)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl执行科室.Caption, False, "", "", False, False, True, _
                    vRect.Left, vRect.Top, txt用法.Height, blnCancel, False, True, strIDs)
                If Not rsTmp Is Nothing Then
                    intIdx = Cbo.FindIndex(cbo执行科室, rsTmp!ID)
                    If intIdx <> -1 Then cbo执行科室.ListIndex = intIdx
                End If
            End If
        End If
        If cbo执行科室.ListIndex = -1 Then
            MsgBox "未到对应的科室。", vbInformation, gstrSysName
            Cancel = True: Exit Sub
        End If
    Else
        vRect = zlControl.GetControlRect(cbo执行科室.hwnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl执行科室.Caption, False, "", "", False, False, True, _
            vRect.Left, vRect.Top, txt用法.Height, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%")
        If Not rsTmp Is Nothing Then
            intIdx = Cbo.FindIndex(cbo执行科室, rsTmp!ID)
            If intIdx <> -1 Then
                cbo执行科室.ListIndex = intIdx
            Else
                cbo执行科室.AddItem rsTmp!编码 & "-" & rsTmp!名称, cbo执行科室.ListCount - 1
                cbo执行科室.ItemData(cbo执行科室.NewIndex) = rsTmp!ID
                cbo执行科室.ListIndex = cbo执行科室.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "未找到对应的科室。", vbInformation, gstrSysName
            End If
            Cancel = True: Exit Sub
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cbo执行时间_Change()
    cbo执行时间.Tag = "1"
End Sub

Private Sub cbo执行时间_LostFocus()
    If Not mblnIsInHelp Then picHelp.Visible = False
    mblnIsInHelp = False
End Sub

Private Sub cbo执行时间_Click()
    'cbo执行时间_Change
    '更新数据
    cbo执行时间.Tag = "1"
    Call AdviceChange
End Sub

Private Sub cbo执行时间_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If SeekNextControl Then Call cbo执行时间_Validate(False)
    Else
        If InStr("0123456789:-/" & Chr(8) & Chr(3) & Chr(22), Chr(KeyAscii)) = 0 Then
            KeyAscii = 0
        End If
    End If
End Sub

Private Sub cbo执行时间_Validate(Cancel As Boolean)
    Dim blnValid As Boolean, lngRow As Long, strTmp As String
    
    lngRow = vsAdvice.Row
        
    With vsAdvice
        If cbo执行时间.Text <> "" Then
            '检查长度
            If Len(cbo执行时间.Text) > 50 Then
                MsgBox "输入内容不能超过 50 个字符。", vbInformation, gstrSysName
                Call cbo执行时间_GotFocus
                Cancel = True: Exit Sub
            End If
            '检查合法性
            If .RowData(lngRow) <> 0 Then
                blnValid = ExeTimeValid(cbo执行时间.Text, Val(.TextMatrix(lngRow, COL_频率次数)), Val(.TextMatrix(lngRow, COL_频率间隔)), .TextMatrix(lngRow, COL_间隔单位))
                If Not blnValid Then
                    If .TextMatrix(lngRow, COL_间隔单位) = "周" Then
                        strTmp = COL_按周执行
                    ElseIf .TextMatrix(lngRow, COL_间隔单位) = "天" Then
                        strTmp = COL_按天执行
                    ElseIf .TextMatrix(lngRow, COL_间隔单位) = "小时" Then
                        strTmp = COL_按时执行
                    End If
                    MsgBox "输入的执行时间方案格式不正确，请检查。" & vbCrLf & vbCrLf & "例：" & vbCrLf & strTmp, vbInformation, gstrSysName
                    Call cbo执行时间_GotFocus
                    Cancel = True: Exit Sub
                End If
            End If
        End If
    End With
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub cbo执行性质_Click()
    cbo执行性质.Tag = "1"
    '更新数据
    Call AdviceChange
End Sub

Private Sub cbo执行性质_KeyPress(KeyAscii As Integer)
    Dim lngIdx As Long
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo执行性质.ListIndex <> -1 Then
            Call SeekNextControl
        End If
    ElseIf KeyAscii >= 32 Then
        lngIdx = Cbo.MatchIndex(cbo执行性质.hwnd, KeyAscii)
        If lngIdx = -1 And cbo执行性质.ListCount > 0 Then lngIdx = 0
        cbo执行性质.ListIndex = lngIdx
    End If
End Sub

Private Sub chk紧急_Click()
    If Not mblnDoCheck Then Exit Sub
    
    chk紧急.Tag = "1"
    '更新数据
    Call AdviceChange
    
    If txt用药理由.Enabled And Trim(txt用药理由.Text) = "" Then
        txt用药理由.SetFocus
    End If
End Sub

Private Sub chkZeroBilling_click()
    If Not mblnDoCheck Then Exit Sub
    
    chkZeroBilling.Tag = "1"
    '更新数据
    Call AdviceChange
End Sub

Private Sub chk紧急_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call SeekNextControl
    End If
End Sub

Private Sub cmdExt_Click()
'功能：修改现有医嘱的扩充内容
    Dim rsCurr As New ADODB.Recordset
    Dim strExtData As String, strAppend As String
    Dim lngRow As Long, lngFirstRow As Long
    Dim lng诊疗项目ID As Long, lng用法ID As Long
    Dim strMsg As String, vMsg As VbMsgBoxResult
    Dim strTmp As String, str诊断IDs As String
    Dim lng配方ID As Long
    Dim t_Pati As TYPE_PatiInfoEx
    Dim lng项目id As Long, intType As Integer
    Dim blnOK As Boolean
    Dim str手术部位 As String, strExtDataHistory As String
    
    Dim vRect As RECT
    Dim lng改动中药味数 As Long, i As Long, dbl中药味数 As Double
    Dim arrTmp As Variant
    Dim blnCancel As Boolean
    Dim lng婴儿 As Long, lng路径项目ID As Long, lng执行方式 As Long, lng选择 As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim str路径项目分类 As String, str选择 As String, str变异原因 As String, str变异编码 As String
    
    Dim strIDs1 As String, strIDs2 As String, str医嘱内容 As String
    Dim lngAppType As Long '申请单应用
    Dim objAppPages()  As clsApplicationData
    Dim rsCard As ADODB.Recordset
    Dim lngNo As Long
    Dim lngTmp As Long
    Dim str摘要 As String '医保摘要 GetItemInfo
    Dim strSQL As String, rsTmp As Recordset
    
    lngRow = vsAdvice.Row
    '读取申请附项内容：不管新录医嘱，在录入、调成套、复制时已读取
    If vsAdvice.TextMatrix(lngRow, COL_附项) = "" And Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
        If Not RowIn配方行(lngRow) Then
            vsAdvice.TextMatrix(lngRow, COL_附项) = Get病人医嘱附件(vsAdvice.RowData(vsAdvice.Row))
        End If
    End If
    strAppend = vsAdvice.TextMatrix(lngRow, COL_附项)
    
    lngNo = Val(vsAdvice.TextMatrix(lngRow, COL_申请序号) & "")
    intType = -1
    lngAppType = -1
    If lngNo <> 0 Then
        strSQL = "Select 文件ID From 医嘱申请单文件 Where 医嘱ID=[1] And RowNum<2"
        On Error GoTo errH
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, IIF(Val(vsAdvice.TextMatrix(lngRow, COL_相关ID)) = 0, Val(vsAdvice.RowData(lngRow)), Val(vsAdvice.TextMatrix(lngRow, COL_相关ID))))
        If rsTmp.RecordCount > 0 Then Call FuncApplyCustom(1, Val(rsTmp!文件ID), lngNo): Exit Sub
    End If
    If vsAdvice.TextMatrix(lngRow, COL_类别) = "D" Then
        If lngNo <> 0 Then
            Call GetData检查申请(lngRow, objAppPages())
            lngAppType = 0
        Else
            strExtData = Get检查部位方法(lngRow)
            If strExtData = "" Then
                MsgBox "该检查医嘱是系统升级以前下达的，与现有方式不兼容。请重新下达该检查医嘱。", vbInformation, gstrSysName
                Exit Sub
            End If
            intType = 0
        End If
    ElseIf vsAdvice.TextMatrix(lngRow, COL_类别) = "F" Then
        If CanUseApply("F") Then '手术申请单不需要用申请序号区分
            Call GetData手术申请(lngRow, rsCard)
            lngAppType = 2
        Else
            strExtData = Get手术附加IDs(lngRow)
            intType = 1
        End If
    ElseIf RowIn配方行(lngRow) Then
        strExtData = Get中药配方IDs(lngRow)
        intType = 2
         '记录下原配方数据
        If mbytUseType = 1 Then
            If vsAdvice.TextMatrix(lngRow, COL_原始中药配方) = "" Then
                strExtDataHistory = strExtData
                 vsAdvice.TextMatrix(lngRow, COL_原始中药配方) = strExtDataHistory
            Else
                strExtDataHistory = vsAdvice.TextMatrix(lngRow, COL_原始中药配方)
            End If
        End If
    ElseIf RowIn检验行(lngRow) Then
        If lngNo <> 0 Then
            lngAppType = 3
            Call GetData检验申请(lngRow, rsCard)
        Else
            strExtData = Get检验组合IDs(lngRow)
            intType = 4
        End If
    ElseIf vsAdvice.TextMatrix(lngRow, COL_类别) = "E" Or vsAdvice.TextMatrix(lngRow, COL_类别) = "K" Or vsAdvice.TextMatrix(lngRow, COL_类别) = "Z" Then
        If CanUseApply(vsAdvice.TextMatrix(lngRow, COL_类别)) Then
            Call GetData输血申请(lngRow, rsCard)
            lngAppType = 1
        Else
            intType = 5
            If vsAdvice.TextMatrix(lngRow, COL_类别) = "K" And Val(vsAdvice.TextMatrix(lngRow, COL_申请序号) & "") <> 0 Then
                Call frmApplyBlood.ShowMe(Me, mlng病人ID, 0, 1, 3, Val(vsAdvice.RowData(lngRow)), mlng病人科室id, , Val(vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID)), , , mrsDefine, mclsMipModule, 1, mstr挂号单)
                Exit Sub
            End If
        End If
    Else
        Exit Sub '兼容以前的检验项目
    End If
    
    If intType = 4 Then
        lngFirstRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_相关ID)
        lng项目id = Val(vsAdvice.TextMatrix(lngFirstRow, COL_诊疗项目ID))
    Else
        lng项目id = Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID))
    End If
    With t_Pati
        .bln医保 = InStr(",1,2,", mstr付款码) > 0 And mstr付款码 <> ""
        .int险类 = mint险类
        .int婴儿 = mint婴儿
        .lng病人ID = mlng病人ID
        .lng病人科室ID = mlng病人科室id
        .str挂号单 = mstr挂号单
        .str性别 = mstr性别
    End With

    On Error Resume Next
    '改造接口：以前int场合传未传，现在传0，bytUseType以前未传，现在传0
    If intType = 2 Then
        blnOK = frmAdviceFormula.ShowMe(Me, gclsInsure, txt医嘱内容.hwnd, t_Pati, 0, mbytUseType, 1, 1, 1, _
                    lng项目id, strExtData, str摘要, , , mstr药品价格等级)
    ElseIf intType <> -1 Then
        blnOK = frmAdviceEditEx.ShowMe(Me, txt医嘱内容.hwnd, t_Pati, 0, intType, mbytUseType, 1, 1, 1, mblnNewLIS, False, _
                    lng项目id, strExtData, strAppend, , GetAdviceDiagnosis, str手术部位)
    End If
    '申请单
    If lngAppType = 0 Then
        blnOK = ApplyNew检查申请(1, "", objAppPages())
    ElseIf lngAppType = 1 Then
        blnOK = ApplyNew输血申请(1, "", rsCard)
    ElseIf lngAppType = 2 Then
        blnOK = ApplyNew手术申请(1, "", rsCard)
    ElseIf lngAppType = 3 Then
        blnOK = ApplyNew检验申请(1, "", rsCard)
    End If
    On Error GoTo 0
    
    '重新设置相关内容
    If blnOK Then
        '获取以前的诊断关联行
        Call AdviceHaveDiag(lngRow, 2, str诊断IDs)
        
        '更新开嘱时间
        vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
        vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
        vsAdvice.TextMatrix(lngRow, COL_单价) = "" '清除重新计算
        
        '记录临床路径的相关数据
        If mlng路径状态 = 1 Then
            lng路径项目ID = Val(vsAdvice.TextMatrix(lngRow, COL_路径项目ID))
            str路径项目分类 = vsAdvice.TextMatrix(lngRow, COL_路径项目分类)
            lng婴儿 = Val(vsAdvice.TextMatrix(lngRow, COL_婴儿))
            lng执行方式 = Val(vsAdvice.TextMatrix(lngRow, COL_路径执行方式))
            lng选择 = Val(vsAdvice.Cell(flexcpChecked, lngRow, COL_选择))
            str选择 = vsAdvice.TextMatrix(lngRow, COL_选择)
        End If
        
        If vsAdvice.TextMatrix(lngRow, COL_类别) = "D" Then
            If lngAppType = 0 Then
                Call Delete检查手术输血(lngRow, True, lngTmp)
                lngRow = lngTmp
                Call AdviceSet检查申请(lngRow, objAppPages(), str诊断IDs)
                strAppend = vsAdvice.TextMatrix(lngRow, COL_附项)
            Else
                '检查组合
                Call AdviceSet检查组合(lngRow, strExtData)
                vsAdvice.TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
            End If
            txt医嘱内容.Text = vsAdvice.TextMatrix(lngRow, col_医嘱内容)
        ElseIf lngAppType = 1 Then
            Call Delete检查手术输血(lngRow)
            Call DeleteRow(lngRow, True)
            Call AdviceSet输血申请(lngRow, rsCard, str诊断IDs)
            txt医嘱内容.Text = vsAdvice.TextMatrix(lngRow, col_医嘱内容)
            strAppend = ""
        ElseIf vsAdvice.TextMatrix(lngRow, COL_类别) = "F" Then
            If lngAppType = 2 Then
                Call Delete检查手术输血(lngRow)
                Call DeleteRow(lngRow, True)
                Call AdviceSet手术申请(lngRow, rsCard, str诊断IDs)
                strAppend = vsAdvice.TextMatrix(lngRow, COL_附项)
            Else
                '一组手术
                Call AdviceSet手术组合(lngRow, strExtData)
                vsAdvice.Cell(flexcpData, lngRow, COL_标本部位) = str手术部位
            End If
            vsAdvice.TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
            txt医嘱内容.Text = vsAdvice.TextMatrix(lngRow, col_医嘱内容)
        ElseIf lngAppType = 3 Then
            Call Delete检验申请单(lngRow, True, lngTmp)
            lngRow = lngTmp
            Call AdviceSet检验申请(lngRow, rsCard, str诊断IDs)
            strAppend = vsAdvice.TextMatrix(lngRow, COL_附项)
            txt医嘱内容.Text = vsAdvice.TextMatrix(lngRow, col_医嘱内容)
            strAppend = ""
        ElseIf RowIn检验行(lngRow) Then
            '检验组合
            lngFirstRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_相关ID)
            lng用法ID = Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID))
            
            '先获取当前已经设置好值
            rsCurr.Fields.Append "Edit", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "医嘱ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "执行科室ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "频率", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "频率次数", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "频率间隔", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "间隔单位", adVarChar, 4, adFldIsNullable
            rsCurr.Fields.Append "总量", adDouble, , adFldIsNullable
            rsCurr.Fields.Append "执行时间", adVarChar, 50, adFldIsNullable
            rsCurr.Fields.Append "开始时间", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "开嘱医生", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "开嘱科室ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "开嘱时间", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "医生嘱托", adVarChar, 100, adFldIsNullable
            rsCurr.Fields.Append "标志", adVarChar, 4, adFldIsNullable
            
            rsCurr.CursorLocation = adUseClient
            rsCurr.LockType = adLockOptimistic
            rsCurr.CursorType = adOpenStatic
            rsCurr.Open
            rsCurr.AddNew
                        
            '采集方法的执行科室可能与检验项目不同
            If Val(vsAdvice.TextMatrix(lngFirstRow, COL_执行科室ID)) <> 0 Then
                rsCurr!执行科室ID = Val(vsAdvice.TextMatrix(lngFirstRow, COL_执行科室ID))
            End If
            If Val(vsAdvice.TextMatrix(lngRow, COL_总量)) <> 0 Then
                rsCurr!总量 = Val(vsAdvice.TextMatrix(lngRow, COL_总量))
            End If
            rsCurr!执行时间 = vsAdvice.TextMatrix(lngRow, COL_执行时间)
            rsCurr!频率 = vsAdvice.TextMatrix(lngRow, COL_频率)
            rsCurr!频率次数 = Val(vsAdvice.TextMatrix(lngRow, COL_频率次数))
            rsCurr!频率间隔 = Val(vsAdvice.TextMatrix(lngRow, COL_频率间隔))
            rsCurr!间隔单位 = vsAdvice.TextMatrix(lngRow, COL_间隔单位)
            rsCurr!开始时间 = vsAdvice.Cell(flexcpData, lngRow, COL_开始时间)
            rsCurr!开嘱医生 = vsAdvice.TextMatrix(lngRow, COL_开嘱医生)
            rsCurr!开嘱科室id = Val(vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID))
            rsCurr!开嘱时间 = vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间)
            rsCurr!医生嘱托 = vsAdvice.TextMatrix(lngRow, COL_医生嘱托)
            rsCurr!标志 = vsAdvice.TextMatrix(lngRow, COL_标志)
            '修改了检验组合内容,采集方法行应标记为修改
            rsCurr!Edit = Val(vsAdvice.TextMatrix(lngRow, COL_EDIT))
            rsCurr!医嘱ID = vsAdvice.RowData(lngRow)
            rsCurr.Update
            
            '完全重新设置该检验组合
            '------------------------
            '删除检验项目行:删除之后重新定位的当前行
            lngRow = Delete检验组合(lngRow)
            '清除当前行(采集方法行)
            Call DeleteRow(lngRow, True, False)
            '重新产生:产生之后重新定位的当前行
            lngRow = AdviceSet检验组合(lngRow, lng用法ID, strExtData, rsCurr)
            If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow, lng路径项目ID, str路径项目分类)
        ElseIf RowIn配方行(lngRow) Then
            '如果是临床路径生成，则检查修改的中药（增删改）是否超过的设定的比例(修改脚注不算修改)
            If mbytUseType = 1 Then
                '先判断参数比例
                If mlng中药味数 > 0 Then
                    '可修改的中药味数是原始配方味数*比例
                    dbl中药味数 = (UBound(Split(Split(strExtDataHistory, "|")(0), ";")) + 1) * mlng中药味数 / 100
                    arrTmp = Split(Split(strExtDataHistory, "|")(0), ";")
                    strExtDataHistory = ""
                    For i = 0 To UBound(arrTmp)
                        If arrTmp(i) <> "" Then
                            strExtDataHistory = strExtDataHistory & ";" & Split(arrTmp(i), ",")(0) & "," & Split(arrTmp(i), ",")(1)
                        End If
                    Next
                    If strExtDataHistory <> "" Then
                        strExtDataHistory = strExtDataHistory & ";"
                        If UBound(arrTmp) > UBound(Split(Split(strExtData, "|")(0), ";")) Then lng改动中药味数 = UBound(arrTmp) - UBound(Split(Split(strExtData, "|")(0), ";"))
                        arrTmp = Split(Split(strExtData, "|")(0), ";")
                        For i = 0 To UBound(arrTmp)
                            If arrTmp(i) <> "" Then
                                If InStr(strExtDataHistory, ";" & Split(arrTmp(i), ",")(0) & "," & Split(arrTmp(i), ",")(1) & ";") = 0 Then
                                    lng改动中药味数 = lng改动中药味数 + 1
                                End If
                            End If
                        Next
                        If lng改动中药味数 > dbl中药味数 Then
                            If vsAdvice.Cell(flexcpData, lngRow, COL_超量说明) = "" Then
                                strSQL = "Select b.名称 as 分类,a.编码 as ID,a.编码,a.名称,a.简码 From 门诊变异常见原因 a,门诊变异常见原因 b" & _
                                        " Where a.性质=1 And a.末级=1 And a.上级=b.编码 And b.末级=0 " & _
                                        " Order by 分类,a.编码"
                                vRect = zlControl.GetControlRect(txt超量说明.hwnd)
ReSelect:
                                Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, "门诊变异常见原因", , , , , , True, vRect.Left, vRect.Top, txt超量说明.Height, blnCancel, , True)
                                If rsTmp Is Nothing Then
                                    If Not blnCancel Then
                                        MsgBox "系统没有初始门诊变异常见原因，请与系统管理员联系。", vbInformation, gstrSysName
                                        Exit Sub
                                    Else
                                        MsgBox "修改的中药配方超出了允许修改的味数，必须填写变异原因。"
                                        GoTo ReSelect
                                    End If
                                Else
                                    str变异原因 = rsTmp!名称 & ""
                                    str变异编码 = rsTmp!编码 & ""
                                End If
                            Else
                                str变异原因 = vsAdvice.TextMatrix(lngRow, COL_超量说明)
                                str变异编码 = vsAdvice.Cell(flexcpData, lngRow, COL_超量说明)
                            End If
                        End If
                    End If
                End If
            End If
        
            '中药配方
            lngFirstRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_相关ID)
            lng诊疗项目ID = Val(vsAdvice.TextMatrix(lngFirstRow, COL_诊疗项目ID))
            lng用法ID = Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID))
            '先获取当前已经设置好值
            rsCurr.Fields.Append "Edit", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "医嘱ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "执行性质", adVarChar, 10, adFldIsNullable
            rsCurr.Fields.Append "执行科室ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "频率", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "频率次数", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "频率间隔", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "间隔单位", adVarChar, 4, adFldIsNullable
            rsCurr.Fields.Append "总量", adDouble, , adFldIsNullable
            rsCurr.Fields.Append "执行时间", adVarChar, 50, adFldIsNullable
            rsCurr.Fields.Append "开始时间", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "开嘱医生", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "开嘱科室ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "开嘱时间", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "医生嘱托", adVarChar, 100, adFldIsNullable
            rsCurr.Fields.Append "标志", adVarChar, 4, adFldIsNullable
            
            rsCurr.CursorLocation = adUseClient
            rsCurr.LockType = adLockOptimistic
            rsCurr.CursorType = adOpenStatic
            rsCurr.Open
            rsCurr.AddNew
            
            rsCurr!执行性质 = zlCommFun.GetNeedName(cbo执行性质.Text) '正常,自备药,离院带药
            
            '取配方界面选择的药房
            rsCurr!执行科室ID = Val(Split(strExtData, "|")(4))
            
            rsCurr!频率 = vsAdvice.TextMatrix(lngFirstRow, COL_频率)
            rsCurr!频率次数 = Val(vsAdvice.TextMatrix(lngFirstRow, COL_频率次数))
            rsCurr!频率间隔 = Val(vsAdvice.TextMatrix(lngFirstRow, COL_频率间隔))
            rsCurr!间隔单位 = vsAdvice.TextMatrix(lngFirstRow, COL_间隔单位)
            
            '取配方界面选择的付数
            rsCurr!总量 = Val(Split(strExtData, "|")(3))
            
            rsCurr!执行时间 = vsAdvice.TextMatrix(lngFirstRow, COL_执行时间)
            rsCurr!开始时间 = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开始时间)
            rsCurr!开嘱医生 = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱医生)
            rsCurr!开嘱科室id = Val(vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID))
            rsCurr!开嘱时间 = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开嘱时间)
            rsCurr!医生嘱托 = vsAdvice.TextMatrix(lngRow, COL_医生嘱托)
            rsCurr!标志 = vsAdvice.TextMatrix(lngRow, COL_标志)
            '修改了配方内容,用法行应标记为修改
            rsCurr!Edit = Val(vsAdvice.TextMatrix(lngRow, COL_EDIT))
            rsCurr!医嘱ID = vsAdvice.RowData(lngRow)
            rsCurr.Update
            '完全重新设置该中药配方行
            '------------------------
            '删除组成味药及煎法行:删除之后重新定位的当前行
            lngRow = Delete中药配方(lngRow)
            '如果当前用法的配方ID不为空，则传入配方ID
            lng配方ID = Val(vsAdvice.TextMatrix(lngRow, COL_配方ID))
            '清除当前行(中药用法行)
            Call DeleteRow(lngRow, True, False)
            '产生配方:产生之后重新定位的当前行
            lngRow = AdviceSet中药配方(lng诊疗项目ID, lngRow, lng用法ID, strExtData, rsCurr, str摘要, lng配方ID)
            If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow, lng路径项目ID, str路径项目分类)
                        If str变异原因 <> "" And str变异编码 <> "" Then
                vsAdvice.TextMatrix(lngRow, COL_超量说明) = str变异原因
                vsAdvice.Cell(flexcpData, lngRow, COL_超量说明) = str变异编码
            End If
        End If
        
        '更新附件内容:以当前可见行为准
        If strAppend <> "" Then
            vsAdvice.TextMatrix(lngRow, COL_附项) = strAppend
            vsAdvice.Cell(flexcpData, lngRow, COL_附项) = 1 '表明需要重新写入(新增或修改)
            Call ReplaceAdviceAppend(lngRow) '缺省替换其他医嘱的申请附项
        End If
        '恢复临床路径相关数据
        If mlng路径状态 = 1 Then
            Call GetRowScope(lngRow, lngBegin, lngEnd)
            For i = lngBegin To lngEnd
                vsAdvice.TextMatrix(i, COL_婴儿) = lng婴儿
                vsAdvice.TextMatrix(i, COL_路径项目ID) = lng路径项目ID
                vsAdvice.TextMatrix(i, COL_路径项目分类) = str路径项目分类
                vsAdvice.TextMatrix(i, COL_路径执行方式) = lng执行方式
                vsAdvice.Cell(flexcpChecked, i, COL_选择) = lng选择
                vsAdvice.TextMatrix(i, COL_选择) = str选择
                If str选择 = "√" Then
                    vsAdvice.Cell(flexcpBackColor, i, COL_选择) = &H8000000F
                End If
                vsAdvice.Cell(flexcpPictureAlignment, i, COL_选择) = flexPicAlignCenterCenter
            Next
        End If
        '修改后关联诊断的标记处理，申请单不用再对应诊断
        If lngAppType = -1 Then Call SetDiagFlag(vsAdvice.Row, 1, str诊断IDs)
        '强行显示当前医嘱卡片
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
        Call CalcAdviceMoney '显示新开医嘱金额
        If InStr(",0,3,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = 2 '标记为被修改
            vsAdvice.TextMatrix(lngRow, COL_状态) = 1 '修改后变为新开
            Call ReSetColor(lngRow)
        End If
 
        mblnNoSave = True '标记为未保存
    End If
    
    Call vsAdvice.AutoSize(col_医嘱内容)
    
    '对保险对码进行检查
    Call GetInsureStr(strIDs1, strIDs2, str医嘱内容, vsAdvice.Row)
    strMsg = CheckAdviceInsure(mint险类, mbln提醒对码, mlng病人ID, 1, strIDs1, strIDs2, str医嘱内容)
    If strMsg <> "" Then
        If gint医保对码 = 2 Then strMsg = strMsg & vbCrLf & vbCrLf & "请先和相关人员联系处理，否则医嘱将不允许保存。"
        vMsg = frmMsgBox.ShowMsgBox(strMsg, Me, True)
        If vMsg = vbIgnore Then mbln提醒对码 = False
    End If
    
    If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub ReplaceAdviceAppend(ByVal lngRow As Long)
'功能：根据指定行的申请附项输入情况，对其他新录医嘱的申请附项进行缺省替换
'参数：lngRow=才新输入或修改的可见医嘱行
    Dim strAppend As String, i As Long
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_附项) = "" Then Exit Sub
        
        For i = .FixedRows To .Rows - 1
            '只针对新录入的医嘱，修改的医嘱修改时已检查
            '".Cell(flexcpData, i, COL_附项) = 1"的可能还没有在输入过程中检查，只是自动替换了
            If .RowData(i) <> 0 And Not .RowHidden(i) And i <> lngRow And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                If .TextMatrix(i, COL_附项) <> "" Then
                    strAppend = ReplaceAppend(.TextMatrix(i, COL_附项), .TextMatrix(lngRow, COL_附项))
                    If .TextMatrix(i, COL_附项) <> strAppend Then
                        .TextMatrix(i, COL_附项) = strAppend
                        .Cell(flexcpData, i, COL_附项) = 1
                    End If
                End If
            End If
        Next
    End With
End Sub

Private Sub ClinicSelecter(Optional ByVal 类型 As Integer, Optional ByVal lng分类ID As Long)
    Dim rsTmp As ADODB.Recordset
    Dim rsInput As ADODB.Recordset
    Dim strSQL As String
    Dim lng药名ID As Long
    Dim intType As Integer
    
    If 类型 = 8 And lng分类ID <> 0 Then
        '直接读取选择的成套项目
        On Error GoTo errH
        strSQL = "Select A.类别 As 类别ID,A.ID as 诊疗项目ID,Null as 收费细目ID,B.名称 As 类别,A.编码,A.名称,A.计算单位,A.标本部位,NULL as 项目特性" & _
            " From 诊疗项目目录 A,诊疗项目类别 B Where A.类别=B.编码 And A.ID=[1]"
        Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng分类ID)
    Else
        '临床路径选择其他规格的药品
        If mbytUseType = 1 Then lng药名ID = vsAdvice.TextMatrix(vsAdvice.Row, COL_诊疗项目ID)
        
        If mbytUseType = 1 And vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "4" Then
            intType = 1
        Else
            intType = 0
        End If
        
        '打开选择器，可能指定了初始分类目录
        Set rsInput = frmClinicSelect.ShowSelect(Me, IIF(mlng前提ID <> 0, 2, 0), 0, mlng病人科室id, 1, mstr性别, , , 1, lng分类ID, mint险类, , lng药名ID, , , , , , , mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, intType)
        If rsInput Is Nothing Then '取消或无数据
            zlControl.TxtSelAll txt医嘱内容
            If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
            Exit Sub
        End If
    End If
    
    If lng药名ID <> 0 Then   '临床路径生成：根据新的规格，重新设置相关列信息
        With vsAdvice
            .Redraw = flexRDNone
            If InStr(",5,6,", rsInput!类别ID) > 0 Then
                strSQL = "Select Nvl(C.名称,A.名称) as 名称," & _
                    " B.剂量系数,B.门诊单位,B.门诊包装,B.门诊可否分零 As 可否分零,B.动态分零,B.基本药物,B.高危药品,B.是否易至跌倒" & _
                    " From 收费项目目录 A,药品规格 B,收费项目别名 C" & _
                    " Where A.ID=B.药品ID And A.ID=[1]" & _
                    " And A.ID=C.收费细目ID(+) And C.码类(+)=1 And C.性质(+)=[2]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val("" & rsInput!收费细目ID), IIF(gbyt药品名称显示 = 0, 1, 3))
                .TextMatrix(.Row, COL_剂量系数) = NVL(rsTmp!剂量系数)
                .TextMatrix(.Row, COL_门诊包装) = NVL(rsTmp!门诊包装)
                .TextMatrix(.Row, COL_门诊单位) = NVL(rsTmp!门诊单位)
                .TextMatrix(.Row, COL_可否分零) = NVL(rsTmp!可否分零, 0)
                .TextMatrix(.Row, COL_高危药品) = NVL(rsTmp!高危药品, 0)
                .TextMatrix(.Row, COL_易跌倒) = NVL(rsTmp!是否易至跌倒, 0)
                .TextMatrix(.Row, COL_基本药物) = rsTmp!基本药物 & ""
                If Val(.TextMatrix(.Row, COL_高危药品)) <> 0 Then
                    MsgBox "当前新开的是" & Decode(Val(.TextMatrix(.Row, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级高危药品，请谨慎使用。", vbInformation, Me.Caption
                End If
           
            ElseIf rsInput!类别 = "4" Then
                strSQL = "Select A.跟踪在用,B.名称,B.计算单位,A.是否分零 From 材料特性 A,收费项目目录 B Where A.材料ID=B.ID And A.材料ID=[1]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val("" & rsInput!收费细目ID))
                .TextMatrix(.Row, COL_门诊单位) = NVL(rsTmp!计算单位) '散装单位
                .TextMatrix(.Row, COL_跟踪在用) = NVL(rsTmp!跟踪在用, 0)
                .TextMatrix(.Row, COL_剂量系数) = 1
                .TextMatrix(.Row, COL_门诊包装) = 1
                .Cell(flexcpData, .Row, COL_可否分零) = NVL(rsTmp!是否分零, 0)
            End If
            .TextMatrix(.Row, COL_名称) = rsTmp!名称 '将别名换成正式规格名称
            .TextMatrix(.Row, COL_收费细目ID) = Val("" & rsInput!收费细目ID)
            .TextMatrix(.Row, col_医嘱内容) = AdviceTextMake(.Row)
            .TextMatrix(.Row, COL_总量单位) = .TextMatrix(.Row, COL_门诊单位)
            .Redraw = flexRDDirect
        End With
        If mblnPass Then
            Call gobjPass.zlPassAdviceInput(mobjPassMap, rsInput!诊疗项目ID, NVL(rsInput!收费细目ID, 0))
        End If
        Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
    Else
        '根据选择项目设置缺省医嘱信息
        If AdviceInput(rsInput, vsAdvice.Row) Then
            '显示已缺省设置的值
            Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
            
            Call CalcAdviceMoney '显示新开医嘱金额
            
            '医保管控实时监测
            If mint险类 <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
                '总量不可输入：缺省并固定总量的医嘱，以及长嘱
                '成套医嘱不在这里检查
                If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) And Not txt总量.Enabled Then
                    If MakePriceRecord(vsAdvice.Row) Then
                        If Not gclsInsure.CheckItem(mint险类, 0, 0, mrsPrice) Then
                            Call AdviceCurRowClear: Exit Sub
                        End If
                    End If
                    '标记为已经作了检查
                    vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_状态) = 1
                End If
            End If
                     
            If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
            Call SeekNextControl '必须先定位
        Else
            '恢复原值(AdviceInput函数中可能处理了一下)
            txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容)
            If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmdSel_Click()
    Call ClinicSelecter
End Sub

Private Sub cmd开始时间_Click()
    If IsDate(msk开始时间.Text) Then
        dtpDate.value = CDate(msk开始时间.Text)
    Else
        dtpDate.value = zlDatabase.Currentdate
    End If
    dtpDate.Tag = "开始时间"
    dtpDate.Left = msk开始时间.Left + fraAdvice.Left
    dtpDate.Top = msk开始时间.Top + fraAdvice.Top - dtpDate.Height
    dtpDate.Visible = True
    dtpDate.SetFocus
End Sub

Private Sub dtpDate_DateClick(ByVal DateClicked As Date)
    Dim strDate As String
    
    If dtpDate.Tag = "开始时间" Then
        '取值
        If IsDate(msk开始时间.Text) Then
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(msk开始时间.Text, "yyyy-MM-dd HH:mm"), 12, 5)
        Else
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm"), 12, 5)
        End If
        
        '判断时间合法性
        If Not Check开始时间(strDate) Then
            dtpDate.SetFocus: Exit Sub
        End If
        
        msk开始时间.Text = strDate
        dtpDate.Tag = ""
        dtpDate.Visible = False
        Call msk开始时间_Validate(False) '更新数据
        msk开始时间.SetFocus
    ElseIf dtpDate.Tag = "安排时间" Then
        '取值
        If IsDate(txt安排时间.Text) Then
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(txt安排时间.Text, "yyyy-MM-dd HH:mm"), 12, 5)
        Else
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm"), 12, 5)
        End If
        
        '判断时间合法性
        If Not Check安排时间(strDate, msk开始时间.Text, vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) Then
            dtpDate.SetFocus: Exit Sub
        End If
        
        txt安排时间.Text = strDate
        dtpDate.Tag = ""
        dtpDate.Visible = False
        Call txt安排时间_Validate(False) '更新数据
        txt安排时间.SetFocus
    End If
End Sub

Private Sub dtpDate_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call dtpDate_DateClick(dtpDate.value)
    End If
End Sub

Private Sub dtpDate_Validate(Cancel As Boolean)
    dtpDate.Visible = False
    dtpDate.Tag = ""
End Sub

Private Sub Form_Activate()
    If mblnRunFirst Then
        mblnRunFirst = False
        If vsDiag.Rows = 2 And vsDiag.TextMatrix(1, col诊断) = "" Then
            If vsDiag.Enabled Then
                Call vsDiag_AfterRowColChange(vsDiag.Row, vsDiag.Col, vsDiag.Row, vsDiag.Col)
                vsDiag.SetFocus
            End If
        Else
            If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
        End If
        '第一次进入时将滚动条移到当前行，因为Load中不能移动滚动条,调用两次才生效。
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
        mblnRowMerge = False
    End If
End Sub

Private Sub Form_KeyDown(KeyCode As Integer, Shift As Integer)
    Dim str摘要 As String
    Dim str中药IDs As String
    Dim lngBaseRow As Long, i As Long
    Dim lng收费细目ID As Long, str诊疗项目ID As String
    Dim objCtl As Object
    
    If Shift = vbAltMask Then
        If Between(Chr(KeyCode), "1", "9") And Not mfrmShortCut Is Nothing Then
            Call mfrmShortCut.ShowShortCut(Val(Chr(KeyCode)))
        End If
    ElseIf Shift = vbCtrlMask And KeyCode = vbKeyD Then
        '保存常用嘱托
        If cmd常用嘱托.Enabled And cmd常用嘱托.Visible Then
            Call cmd常用嘱托_Click
        End If
    ElseIf KeyCode = vbKeyF1 And Shift = vbCtrlMask Then
        '调用医保提示
        With vsAdvice
            If .RowData(.Row) <> 0 Then
                lng收费细目ID = Val(.TextMatrix(.Row, COL_收费细目ID))
                str诊疗项目ID = Val(.TextMatrix(.Row, COL_诊疗项目ID))
                If RowIn配方行(.Row) Then
                    '获取中药配方第一味中药行
                    lngBaseRow = .FindRow(CStr(.RowData(.Row)), , COL_相关ID)
                    For i = lngBaseRow To .Row
                        If i = lngBaseRow Then lng收费细目ID = Val(.TextMatrix(i, COL_收费细目ID))
                        If .TextMatrix(i, COL_类别) = "7" Then
                            str中药IDs = str中药IDs & "," & .TextMatrix(i, COL_诊疗项目ID)
                        End If
                    Next
                    str中药IDs = Mid(str中药IDs, 2)
                    If UBound(Split(str中药IDs, ",")) <> 0 Then
                        lng收费细目ID = 0
                    End If
                    str诊疗项目ID = str中药IDs
                End If
                '医保病人输入内容时的提示：非医保病人也要调(Or And mint险类 <> 0)
                str摘要 = gclsInsure.GetItemInfo(mint险类, mlng病人ID, lng收费细目ID, CStr(.Cell(flexcpData, .Row, COL_医生嘱托)), 0, "", str诊疗项目ID & "||1")
                .Cell(flexcpData, .Row, COL_医生嘱托) = str摘要
            End If
        End With
    Else
        Select Case KeyCode
            Case vbKeyEscape
                If dtpDate.Visible Then
                    dtpDate.Visible = False
                    Select Case dtpDate.Tag
                    Case "开始时间"
                        msk开始时间.SetFocus
                    Case "安排时间"
                        txt安排时间.SetFocus
                    End Select
                    dtpDate.Tag = ""
                End If
            Case vbKeyF4, vbKeyUp, vbKeyDown
                If Me.ActiveControl Is msk开始时间 Then
                    If cmd开始时间.Visible And cmd开始时间.Enabled Then cmd开始时间_Click
                ElseIf Me.ActiveControl Is txt安排时间 Then
                    If cmd安排时间.Enabled And cmd安排时间.Visible Then cmd安排时间_Click
                ElseIf Me.ActiveControl Is txt医嘱内容 Then
                    If cmdExt.Visible And cmdExt.Enabled Then cmdExt_Click
                ElseIf Me.ActiveControl Is txt用法 Then
                    If cmd用法.Visible And cmd用法.Enabled Then cmd用法_Click
                ElseIf Me.ActiveControl Is txt频率 Then
                    If cmd频率.Visible And cmd频率.Enabled Then cmd频率_Click
                End If
            Case vbKeyF7 '切换输入法
                If stbThis.Panels("WB").Visible And stbThis.Panels("PY").Visible Then
                    If stbThis.Panels("WB").Bevel = sbrRaised Then
                        Call stbThis_PanelClick(stbThis.Panels("WB"))
                    Else
                        Call stbThis_PanelClick(stbThis.Panels("PY"))
                    End If
                End If
            Case vbKeyF8 '切换显示计价项目
                If stbThis.Panels("Price").Visible Then
                    Call stbThis_PanelClick(stbThis.Panels("Price"))
                End If
        End Select
    End If
    
    If Not mrsHotPlugIn Is Nothing Then
    '外挂功能快捷键
        mrsHotPlugIn.Filter = "KeyCode=" & KeyCode & " and  Shift=" & Shift
        If Not mrsHotPlugIn.EOF Then
            Call ExePlugIn(mrsHotPlugIn!功能名 & "")
        End If
    End If
    
End Sub

Private Sub Form_KeyPress(KeyAscii As Integer)
    If KeyAscii = Asc("'") Then
        KeyAscii = 0
    ElseIf KeyAscii = Asc("`") Then
        If Me.ActiveControl.Name <> "rtfEdit" And txtSentence.Visible = False Then
            KeyAscii = 0
            If Not mfrmShortCut Is Nothing Then Call mfrmShortCut.ShowMe(Me, mint场合, 1, 0, mlng病人科室id, False, mlng医技科室ID)
        End If
    ElseIf KeyAscii = vbKeySpace Then
        If Me.ActiveControl Is msk开始时间 And msk开始时间.SelLength = Len(msk开始时间.Text) Then
            KeyAscii = 0
            If cmd开始时间.Visible And cmd开始时间.Enabled Then cmd开始时间_Click
        ElseIf Me.ActiveControl Is txt安排时间 And txt安排时间.SelLength = Len(txt安排时间.Text) Then
            KeyAscii = 0
            If cmd安排时间.Enabled And cmd安排时间.Visible Then cmd安排时间_Click
        ElseIf Me.ActiveControl Is txt医嘱内容 Then
            KeyAscii = 0
            If cmdExt.Visible And cmdExt.Enabled Then cmdExt_Click
        ElseIf Me.ActiveControl Is txt用法 Then
            KeyAscii = 0
            If cmd用法.Visible And cmd用法.Enabled Then cmd用法_Click
        ElseIf Me.ActiveControl Is txt频率 Then
            KeyAscii = 0
            If cmd频率.Visible And cmd频率.Enabled Then cmd频率_Click
        ElseIf Me.ActiveControl Is cbo滴速 Then
            KeyAscii = 0
            If cbo滴速.Visible And cbo滴速.Enabled Then zlCommFun.PressKey (vbKeyF4)
        End If
    ElseIf KeyAscii = vbKeyEscape Then
        picPanel(e诊断表格).Visible = False
    End If
End Sub

Private Sub Form_Load()
    Dim arrTmp As Variant, strTmp As String
    Dim objTmp As Object, objPane As Pane
    Dim i As Long, lngIndex As Long
    Dim rsTmp As ADODB.Recordset
    Dim strPar页签  As String
    Dim blnTmp As Boolean
    Dim blnHave As Boolean
    
    Call InitAdviceTable
    '读取病人信息
    Call GetPatiInfo
    Call zlPASSMap
    With tbcSub
        With .PaintManager
            .Appearance = xtpTabAppearancePropertyPage2003
            .ClientFrame = xtpTabFrameSingleLine
            .BoldSelected = True
            .OneNoteColors = True
            .ShowIcons = True
        End With
        
        If 0 = mint场合 Then '门诊医生工作站场合
            Call InitRsSubFrm(mrsSubForm)
            .InsertItem(lngIndex, "病人信息", picHwndTab.hwnd, 0).Tag = "病人信息"
            Call mrsSubForm.AddNew(Array("ID", "标题", "业务ID", "类型"), Array(lngIndex, "病人信息", 0, 1))
            lngIndex = lngIndex + 1
        End If
        
        .InsertItem(lngIndex, "医嘱编辑", picSub.hwnd, 0).Tag = "医嘱编辑"
        lngIndex = lngIndex + 1
        
        If 0 = mint场合 Then '门诊医生工作站场合
            strPar页签 = zlDatabase.GetPara("门诊病历缺省页签", glngSys, p门诊医嘱下达)
            If GetInsidePrivs(p门诊病历管理) <> "" Then
                Set rsTmp = GetEPRFileID(strPar页签)
                For i = 1 To rsTmp.RecordCount
                    .InsertItem(lngIndex, rsTmp!病历名称 & "", picHwndTab.hwnd, 0).Tag = "门诊病历"
                    Call mrsSubForm.AddNew(Array("ID", "标题", "业务ID", "类型"), Array(lngIndex, rsTmp!病历名称 & "", Val(rsTmp!ID & ""), 2))
                    lngIndex = lngIndex + 1
                    rsTmp.MoveNext
                Next
            End If
            If GetInsidePrivs(p新版门诊病历, True) <> "" Then
                Set rsTmp = Nothing
                On Error Resume Next
                Set objTmp = CreateObject("zl9EmrInterface.ClsEmrInterface")
                If Not objTmp Is Nothing Then
                    strTmp = objTmp.GetOutEPRFileRecord(mlng挂号ID & "", rsTmp)
                End If
                err.Clear: On Error GoTo 0
                If Not rsTmp Is Nothing Then
                    For i = 1 To rsTmp.RecordCount
                        If InStr("," & strPar页签 & ",", "," & rsTmp!ID & ",") > 0 Then
                            .InsertItem(lngIndex, rsTmp!Title & "", picHwndTab.hwnd, 0).Tag = "门诊病历"
                            Call mrsSubForm.AddNew(Array("ID", "标题", "业务ID", "类型"), Array(lngIndex, rsTmp!Title & "", rsTmp!ID & "", 3))
                            lngIndex = lngIndex + 1
                        End If
                        rsTmp.MoveNext
                    Next
                End If
            End If
        End If
        
        strTmp = GetPlugInFrms
        
        If strTmp <> "" Then
            arrTmp = Split(strTmp, ",")
            For i = 0 To UBound(arrTmp)
                strTmp = arrTmp(i)
                .InsertItem(lngIndex, strTmp, mcolSubForm("_" & strTmp).hwnd, 0).Tag = strTmp
                lngIndex = lngIndex + 1
            Next
        End If
        
        If 0 = mint场合 Then
            .Item(0).Selected = True
            .Item(1).Selected = True
        End If
    End With
    
    If mbytUseType <> 1 Then
       picPanel(e常用项目).Visible = False
       'DockingPane
       '-----------------------------------------------------
       Me.dkpMain.SetCommandBars Me.cbsMain
       Me.dkpMain.Options.UseSplitterTracker = False '实时拖动
       Me.dkpMain.Options.ThemedFloatingFrames = True
       Me.dkpMain.Options.AlphaDockingContext = True
       Set objPane = Me.dkpMain.CreatePane(1, IIF(mbytSize = 0, 210, 220), 400, DockLeftOf, Nothing)
       objPane.Title = "常用项目列表"
       objPane.Options = PaneNoCloseable Or PaneNoFloatable
    
       If Val(zlDatabase.GetPara("使用个性化风格")) = 1 Then
           dkpMain.LoadStateFromString GetSetting("ZLSOFT", "私有模块\" & gstrDBUser & "\界面设置\" & App.ProductName & "\" & Me.Name & "\" & TypeName(dkpMain), dkpMain.Name & dkpMain.PanesCount, "")
       End If
    End If
    
    Set mobjReport = New clsReport
    
    Call InitObjLis(p门诊医生站)
    If gobjLIS Is Nothing Then
        mblnNewLIS = False
    Else
        On Error Resume Next
        mblnNewLIS = gobjLIS.GetApplicationFormShowType
        err.Clear: On Error GoTo 0
    End If
    Call InitCommandBar
    If mint场合 = 0 Then
        '字体设置
        mbytSize = zlDatabase.GetPara("字体", glngSys, p门诊医生站, "0")
    ElseIf mint场合 = 2 Then
        mbytSize = zlDatabase.GetPara("字体", glngSys, p医技工作站, "0")
    End If
    Call SetFontSize(mbytSize)
    If mbytUseType = 0 Then Call RestoreWinState(Me, App.ProductName)
    Call LoadDiagInfo
    vsAdvice.ColWidth(0) = 14 * Screen.TwipsPerPixelX
    stbThis.Visible = True
    Call Cbo.SetListHeight(cbo滴速, Me.Height)
    Call Cbo.SetListHeight(cbo执行科室, Me.Height)
    Call Cbo.SetListWidth(cbo执行科室.hwnd, cbo执行科室.Width * 1.3)
    fraPati.BackColor = Me.BackColor
    fra诊断.BackColor = Me.BackColor
 
    optState(0).BackColor = Me.BackColor
    optState(1).BackColor = Me.BackColor
    
    mblnOK = False
    mblnNoSave = False
    mblnRowMerge = False
    mblnRunFirst = True
    mblnRowChange = True
    mblnDoCheck = True
    mstrDelIDs = ""
    mstrAduitDelIDs = ""
    mstrPreTab = ""
    mstrDel输血 = ""
    mlngID序列 = 0
    mlng拖动行 = 0
    
    mblnAddAgent = zlDatabase.GetPara("要求登记代办人", glngSys, p门诊医嘱下达, "1") = "1"
    mblnFreeInput = Val(zlDatabase.GetPara("诊断手术名称自由调整", glngSys, 0)) = 1
    
    '快捷病历相关------先读参数，菜单定义中需要判断
    If mbytUseType = 0 And mint场合 = 0 Then
        blnTmp = InStr(GetInsidePrivs(p门诊病历管理), "病历书写") > 0
        lblLink.Visible = blnTmp
        If blnTmp Then
            lblDoctor(1).Tag = IIF(InStr(GetInsidePrivs(p门诊病历管理), "他人病历") > 0, 1, 0)
            mblnDocInput = Val(zlDatabase.GetPara("显示病历快捷输入", glngSys, p门诊医生站, 0)) = 1
            blnHave = IIF(InStr(GetInsidePrivs(1070), "签名权") > 0, True, False)
            lblDoctor(1).Caption = UserInfo.姓名
        Else
            mblnDocInput = False
            blnHave = False
        End If
        cmdSign.Visible = blnHave
        lblDoctor(0).Visible = blnHave
        lblDoctor(1).Visible = blnHave
        picEpr.Visible = mblnDocInput
        Call InitBaseInfo
        If mblnDocInput Then
            lblLink.Caption = "收起快捷病历"
            Call LoadDocData
        Else
            lblLink.Caption = "展开快捷病历"
        End If
        Set mcls病历功能 = CreateObject("zl9CISJob.clsDockPatiInfo")
        Call GetPlugInHot(mrsHotPlugIn)
    Else
        picEpr.Visible = False
        lblLink.Visible = False
        picEpr.Enabled = False
        mblnDocInput = False
    End If
    
    '输入匹配
    mstrLike = IIF(Val(zlDatabase.GetPara("输入匹配")) = 0, "%", "")
    '简码匹配方式：0-拼音,1-五笔
    mint简码 = Val(zlDatabase.GetPara("简码方式"))
    '启用屏幕键盘
    mblnStaKB = Val(zlDatabase.GetPara("启用屏幕键盘", glngSys, p门诊医生站)) <> 0
    If Not mblnStaKB Then
        stbThis.Panels("KB").Visible = False
    End If
    stbThis.Panels("KB").ToolTipText = "点击启用屏幕键盘"
    Select Case mint简码
    Case 0
        stbThis.Panels("PY").Bevel = sbrInset
        stbThis.Panels("WB").Bevel = sbrRaised
    Case 1
        stbThis.Panels("PY").Bevel = sbrRaised
        stbThis.Panels("WB").Bevel = sbrInset
    Case Else
        stbThis.Panels("PY").Bevel = sbrInset
        stbThis.Panels("WB").Bevel = sbrInset
    End Select
    If Not gbln简码匹配方式切换 Then
        stbThis.Panels("PY").Visible = False
        stbThis.Panels("WB").Visible = False
    End If

    'PASS接口初始化
    If mblnPass Then
        '病人过敏史/病生状态可用检测
        Call gobjPass.zlPassCmdAlleyEnable(mobjPassMap)
    End If
    
    '诊断录入方式，0-按照诊断标准输入,1-按照疾病编码输入
    lngIndex = Val(zlDatabase.GetPara("门诊诊断输入", glngSys, p门诊医生站, 0, Array(opt诊断(0), opt诊断(1)), InStr(GetInsidePrivs(p门诊医嘱下达), ";医嘱选项设置;") > 0))
    '诊断输入来源
    If gint诊断来源 > 1 Then
        opt诊断(0).Enabled = False
        opt诊断(1).Enabled = False
        If gint诊断来源 = 2 Then
            lngIndex = 0
        ElseIf gint诊断来源 = 3 Then
            lngIndex = 1
        End If
    End If
    opt诊断(lngIndex).value = True
    opt诊断(0).TabStop = False
    opt诊断(1).TabStop = False

    '计价面板状态
    If mblnModal Then
        stbThis.Panels("Price").Visible = False
    Else
        Set mfrmPrice = New frmAdvicePrice
        stbThis.Panels("Price").Tag = zlDatabase.GetPara("显示医嘱计价面板", glngSys, p门诊医嘱下达)
    End If

    '必须录入药品单量
    mbln单量 = Val(zlDatabase.GetPara("必须录入药品单量", glngSys, p门诊医嘱下达)) <> 0

    '执行天数
    mbln天数 = Val(zlDatabase.GetPara("医嘱执行天数", glngSys, p门诊医嘱下达)) <> 0
    vsAdvice.ColHidden(COL_天数) = Not mbln天数
    mbln天数反算 = (gbln反算天数 And mbln天数)
    '抗菌药物缺省用药目的
    mstrPurMed = zlDatabase.GetPara("抗菌药物缺省用药目的", glngSys, p门诊医嘱下达, "0")

    '自动处理皮试
    mbln自动皮试 = Val(zlDatabase.GetPara("自动增加皮试医嘱", glngSys, p门诊医嘱下达)) <> 0 And mlng前提ID = 0

    '自动关闭窗体
    mblnAutoClose = Val(zlDatabase.GetPara("发送完成后关闭医嘱窗体", glngSys, p门诊医嘱下达)) <> 0
    
    mlng中药味数 = Val(zlDatabase.GetPara("中药配方允许修改的中药味数上限", glngSys, P门诊路径应用, "30"))
    '药品、卫材出库检查方式
    Set mcolStock1 = GetStockCheck(0)
    Set mcolStock2 = GetStockCheck(1)
    
    With cboDruPur
        .Clear
        .AddItem " "
        .AddItem "预防"
        .AddItem "治疗"
    End With
    
    '常用嘱托
    Call ReadEnjoin
    '医嘱内容定义
    If CreateScript(mobjVBA, mobjScript) Then
        Set mrsDefine = InitAdviceDefine
    End If
    
    '--------------------------------------------------
    Call SetBabyVisible(mlng病人科室id)
    '读取代办人信息
    Call GetAgentInfo

    '修改时强行定位婴儿
    If mlng医嘱ID = 0 Then    '新增
        cbo婴儿.ListIndex = 0    '缺省新增病人的医嘱
    Else    '修改
        cbo婴儿.ListIndex = mint婴儿
    End If
    cbo婴儿.Tag = cbo婴儿.ListIndex

    '读取并显示病人医嘱
    If mbytUseType = 1 Then
        msk开始时间.Text = Format(mdat开始时间, "yyyy-MM-DD HH:mm")
        Call AdviceSet成套项目(2, 0, 1, "", mstrAdivceOfPath)
        Call SetPathAdviceDisble
        Call ShowAdvice
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    Else
        Call ReLoadAdvice(mlng医嘱ID)
        Call InitTBCItem
        Call InitDefaultScheme
        Call LoadCommonItem
        tbrAdd.HotImageList = frmIcons.img24
        tbrAdd.ImageList = frmIcons.img24
        tbrAdd.Buttons(1).Image = 3
        tbrAdd.Visible = True
    End If

    vsDiag.AllowUserResizing = flexResizeNone
    
    '处理快捷输入窗体
    If mbytUseType = 0 And mblnModal = False Then
        Set mfrmShortCut = New frmClinicShortCut
        Call mfrmShortCut.ShowMe(Me, mint场合, 1, 0, mlng病人科室id, True, mlng医技科室ID)     '根据上次上否显示
    Else
        txt医嘱内容.ToolTipText = ""
    End If
    If mblnStaKB Then
        On Error Resume Next
        Set mobjKeyBoard = Nothing
        Set mobjKeyBoard = CreateObject("zlScreenKeyboard.clsKeyBoard")
        err.Clear: On Error GoTo 0
        If Not mobjKeyBoard Is Nothing Then
            Call mobjKeyBoard.StartUp
        Else
            stbThis.Panels("KB").Visible = False
            MsgBox "屏幕键盘部件未能正确安装，不能使用！", vbInformation, gstrSysName
        End If
    End If
    
End Sub

Private Sub SetPathAdviceDisble()
'功能：路径项目生成医嘱时设置禁用的功能
    
    txt医嘱内容.Enabled = False
    picPanel(e新增).Visible = False
    picPanel(e常用项目).Visible = False
    cmdSel.ToolTipText = "选择其他规格"
End Sub

Private Sub LoadCommonItem(Optional ByVal blnRefresh As Boolean)
'功能：加载常用项目列表
'参数：blnRefresh=强制从新读取数据
    Dim strSQL As String
    Dim i As Long, j As Long
    Dim strFilterDiag As String, strFilterDept As String
    Dim strNotFilterDiag As String, strNotFilterDept As String
    
    mstr常用 = ""
    If mrsCommonItem Is Nothing Or blnRefresh = True Then
        strSQL = "SELECT A.ID,A.科室ID,NVL(A.诊断名称,'空') as 诊断名称,NVL(A.疾病ID,0) as 疾病ID,NVL(A.诊断ID,0) as 诊断ID,A.诊疗项目ID,A.药品ID,A.诊疗类别,A.使用次数,B.名称 As 项目名称,C.规格,C.产地" & _
            " FROM 医生常用医嘱 A,诊疗项目目录 B,收费项目目录 C Where A.诊疗项目ID=B.ID And A.药品ID=C.ID(+) And (b.撤档时间 Is Null Or b.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And (c.撤档时间 Is Null Or c.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And A.人员ID=[1]"
        Set mrsCommonItem = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, UserInfo.ID)
        Set mrsCommonItem = zlDatabase.CopyNewRec(mrsCommonItem)
    Else
        mrsCommonItem.Filter = 0
    End If
    
    If mrsCommonItem.RecordCount > 0 Then
        mrsCommonItem.Sort = "使用次数 Desc"
        '1、病人诊断
        With vsDiag
            For j = .FixedRows To .Rows - 1
                If Trim(.TextMatrix(j, col诊断)) <> "" Then
                    strFilterDiag = strFilterDiag & " Or 诊断名称 ='" & .TextMatrix(j, col诊断) & "'" & IIF(Val(.TextMatrix(j, col诊断ID)) <> 0, " Or 诊断ID=" & .TextMatrix(j, col诊断ID), "") & _
                                        IIF(Val(.TextMatrix(j, col疾病ID)) <> 0, " Or 疾病ID=" & .TextMatrix(j, col疾病ID), "")
                    strNotFilterDiag = strNotFilterDiag & " And 诊断名称 <>'" & .TextMatrix(j, col诊断) & "'" & IIF(Val(.TextMatrix(j, col诊断ID)) <> 0, " And 诊断ID<>" & .TextMatrix(j, col诊断ID), "") & _
                                        IIF(Val(.TextMatrix(j, col疾病ID)) <> 0, " And 疾病ID<>" & .TextMatrix(j, col疾病ID), "")
                End If
            Next
            If strFilterDiag <> "" Then
                strFilterDiag = "(" & Mid(strFilterDiag, 5) & ")"
                strNotFilterDiag = "(" & Mid(strNotFilterDiag, 6) & ")"
            End If
        End With
        '本科
        strFilterDept = " 科室ID=" & mlng病人科室id
        strNotFilterDept = " 科室ID<>" & mlng病人科室id
           
        vsLIS.Rows = 0: vsLIS.Cols = 3: vsLIS.Rows = 15: vsLIS.ColHidden(Common_诊疗项目ID) = True: vsLIS.ColHidden(Common_药品ID) = True
        vsPAC.Rows = 0: vsPAC.Cols = 3: vsPAC.Rows = 15: vsPAC.ColHidden(Common_诊疗项目ID) = True: vsPAC.ColHidden(Common_药品ID) = True
        vsDRU.Rows = 0: vsDRU.Cols = 3: vsDRU.Rows = 30: vsDRU.ColHidden(Common_诊疗项目ID) = True: vsDRU.ColHidden(Common_药品ID) = True
        
        '1、病人诊断优先
        If strFilterDiag <> "" Then
            mrsCommonItem.Filter = strFilterDiag
            SetCommonItem mrsCommonItem, True
        End If
        
        '2、其次是本科本人的（排除诊断满足的）
        mrsCommonItem.Filter = strFilterDept & IIF(strFilterDiag <> "", " And " & strNotFilterDiag, "")
        SetCommonItem mrsCommonItem
        
        '3、最后是本人其他的科室的
        mrsCommonItem.Filter = strNotFilterDept & IIF(strFilterDiag <> "", " And " & strNotFilterDiag, "")
        SetCommonItem mrsCommonItem
    End If
End Sub

Private Sub SetCommonItem(rsTmp As Recordset, Optional ByVal blnDiagCommon As Boolean)
'参数：j外部传入，默认为0，从第几行开始加载
'      blnDiagCommon=诊断常用的项目
    Dim i As Long
    Dim lngPac As Long, lngLis As Long, lngDru As Long
 
    If rsTmp.RecordCount = 0 Then Exit Sub
    lngPac = 15: lngLis = 15: lngDru = 30
    
    For i = 0 To vsPAC.Rows - 1
        If Val(vsPAC.RowData(i)) = 0 Then
            lngPac = i
            Exit For
        End If
    Next
    For i = 0 To vsLIS.Rows - 1
        If Val(vsLIS.RowData(i)) = 0 Then
            lngLis = i
            Exit For
        End If
    Next
    For i = 0 To vsDRU.Rows - 1
        If Val(vsDRU.RowData(i)) = 0 Then
            lngDru = i
            Exit For
        End If
    Next
    If lngPac > vsPAC.Rows - 1 And lngLis > vsLIS.Rows - 1 And lngDru > vsDRU.Rows - 1 Then Exit Sub
    
    rsTmp.MoveFirst
    Do While Not rsTmp.EOF
        If rsTmp!诊疗类别 & "" = "D" Then
        '检查医嘱
            With vsPAC
                If lngPac < .Rows Then
                    If InStr("," & mstr常用 & ",", ",D" & Val(rsTmp!诊疗项目ID & "") & ",") = 0 Then
                        mstr常用 = mstr常用 & ",D" & Val(rsTmp!诊疗项目ID & "")
                        .TextMatrix(lngPac, Common_项目名称) = rsTmp!项目名称 & ""
                        .TextMatrix(lngPac, Common_诊疗项目ID) = Val(rsTmp!诊疗项目ID & "")
                        .RowData(lngPac) = Val(rsTmp!ID & "")
                        .Cell(flexcpAlignment, lngPac, Common_项目名称) = flexAlignLeftCenter
                        If blnDiagCommon Then .Cell(flexcpPicture, lngPac, Common_项目名称) = imgDiag.Picture
                        lngPac = lngPac + 1
                    End If
                End If
            End With
        ElseIf rsTmp!诊疗类别 & "" = "C" Then
        '检验医嘱
            With vsLIS
                If lngLis < .Rows Then
                    If InStr("," & mstr常用 & ",", ",C" & Val(rsTmp!诊疗项目ID & "") & ",") = 0 Then
                        mstr常用 = mstr常用 & ",C" & Val(rsTmp!诊疗项目ID & "")
                        .TextMatrix(lngLis, Common_项目名称) = rsTmp!项目名称 & ""
                        .TextMatrix(lngLis, Common_诊疗项目ID) = Val(rsTmp!诊疗项目ID & "")
                        .RowData(lngLis) = Val(rsTmp!ID & "")
                        .Cell(flexcpAlignment, lngLis, Common_项目名称) = flexAlignLeftCenter
                        If blnDiagCommon Then .Cell(flexcpPicture, lngLis, Common_项目名称) = imgDiag.Picture
                        lngLis = lngLis + 1
                    End If
                End If
            End With
        ElseIf rsTmp!诊疗类别 & "" = "5" Or rsTmp!诊疗类别 & "" = "6" Then
        '药品医嘱
            With vsDRU
                If lngDru < .Rows Then
                    If InStr("," & mstr常用 & ",", ",药" & Val(rsTmp!诊疗项目ID & "") & "-" & Val(rsTmp!药品ID & "") & ",") = 0 Then
                        mstr常用 = mstr常用 & ",药" & Val(rsTmp!诊疗项目ID & "") & "-" & Val(rsTmp!药品ID & "")
                        
                        If Val(rsTmp!药品ID & "") <> 0 Then
                            .TextMatrix(lngDru, Common_药品ID) = Val(rsTmp!药品ID & "")
                            .TextMatrix(lngDru, Common_项目名称) = rsTmp!项目名称 & " " & rsTmp!规格
                        Else
                            .TextMatrix(lngDru, Common_项目名称) = rsTmp!项目名称 & ""
                        End If
                        .TextMatrix(lngDru, Common_诊疗项目ID) = Val(rsTmp!诊疗项目ID & "")
                        .RowData(lngDru) = Val(rsTmp!ID & "")
                        .Cell(flexcpAlignment, lngDru, Common_项目名称) = flexAlignLeftCenter
                        If blnDiagCommon Then .Cell(flexcpPicture, lngDru, Common_项目名称) = imgDiag.Picture
                        lngDru = lngDru + 1
                    End If
                End If
            End With
        End If
        If lngPac > vsPAC.Rows - 1 And lngLis > vsLIS.Rows - 1 And lngDru > vsDRU.Rows - 1 Then Exit Do
        rsTmp.MoveNext
    Loop
End Sub

Private Function TheStockCheck(ByVal lng库房ID As Long, ByVal str类别 As String) As Integer
'功能：获取指定库房的出库库存检查方式
    Dim intStyle As Integer
    
    On Error Resume Next
    If InStr(",5,6,7,", str类别) > 0 Then
        intStyle = mcolStock1("_" & lng库房ID)
    ElseIf str类别 = "4" Then
        intStyle = mcolStock2("_" & lng库房ID)
    End If
    err.Clear: On Error GoTo 0
    TheStockCheck = intStyle
End Function

Private Sub ReLoadAdvice(Optional ByVal lng医嘱ID As Long)
'功能：重新读取并显示病人的当前医嘱清单
'参数：lng医嘱ID=用于定位
    Dim lngRow As Long
    
    If LoadAdvice Then
        '显示可见的医嘱
        Call ShowAdvice
        Call ShowAdvice诊断
        If lng医嘱ID = 0 Then
            If vsAdvice.RowData(vsAdvice.Row) <> 0 Then
                cbsMain.FindControl(, conMenu_New, True, True).Execute
            End If
        Else
            '修改的医嘱ID应该是显示行
            lngRow = vsAdvice.FindRow(lng医嘱ID)
            If lngRow <> -1 Then
                If Not vsAdvice.RowHidden(lngRow) Then
                    mblnRowChange = False
                    vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngRow
                    Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
                    mblnRowChange = True
                End If
            End If
        End If
        '进入时屏蔽了ShowAdvice中的调用,强行进入
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    End If
End Sub

Private Function ReadEnjoin() As Boolean
'功能：读取并加入常用滴速
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, strPre As String
        
    On Error GoTo errH
    
    '常用滴速
    strPre = cbo滴速.Text '加入后保持原有值
    Call Load输液滴速(cbo滴速, lbl滴速单位, False)
    cbo滴速.Text = strPre
    
    ReadEnjoin = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub Form_Resize()
    On Error Resume Next
    
    If dtpDate.Visible Then
        dtpDate.Visible = False
        dtpDate.Tag = ""
    End If
    
    If tbcSub.ItemCount = 1 Then
        picSubMain.Move 0, -350, Me.ScaleWidth, Me.ScaleHeight + 350
    Else
        picSubMain.Move 0, 0, Me.ScaleWidth, Me.ScaleHeight
    End If
    
    tbcSub.Move 0, 0, picSubMain.ScaleWidth, picSubMain.ScaleHeight
  
    If Me.WindowState = vbMinimized Then Exit Sub
    
    Call cbsMain_Resize
  
    'Pass
    cmdAlley.Left = fraPati.Width - cmdAlley.Width - 2 * Screen.TwipsPerPixelX
    cbo婴儿.Left = fraPati.Width - IIF(cmdAlley.Visible, cmdAlley.Width + 30, 0) - cbo婴儿.Width - 2 * Screen.TwipsPerPixelX
    lbl婴儿.Left = cbo婴儿.Left - lbl婴儿.Width - 2 * Screen.TwipsPerPixelX
    
    cbo婴儿.Top = lblPati.Top - 30
    lbl婴儿.Top = lblPati.Top
    optState(0).Top = lblPati.Top
    optState(1).Top = lblPati.Top
    optState(0).Left = lblPati.Left + lblPati.Width + 30
    optState(1).Left = optState(0).Left + optState(0).Width
    
    If cmdAlley.Visible Or lbl婴儿.Visible Then
        optState(1).Left = IIF(lbl婴儿.Visible, lbl婴儿.Left, cmdAlley.Left) - optState(1).Width
        optState(0).Left = optState(1).Left - optState(0).Width
    Else
        optState(1).Left = fraPati.Width - optState(1).Width - 30
        optState(0).Left = optState(1).Left - optState(0).Width
    End If
    lblMoney.Left = lblPati.Left + lblPati.Width + 180
    lblLink.Left = optState(0).Left - lblLink.Width - 250
End Sub

Private Sub Form_Unload(Cancel As Integer)
    Dim i As Long
    mdat挂号时间 = Empty
    msng天数 = 0
    mint家属 = 0
    mstrPreTab = ""
    mblnTabTmp = False
    Set mobjReport = Nothing
    Set mobjVBA = Nothing
    Set mobjScript = Nothing
    Set mrsDefine = Nothing
    Set mrsDrugScale = Nothing
    Set mfrmSend = Nothing
    Set mrsPrice = Nothing
    Set mobjKeyBoard = Nothing
    Set mclsMipModule = Nothing
    Set mobjPatient = Nothing
    Set mrsPPati = Nothing
    '计价面板状态
    If Not mfrmPrice Is Nothing Then
        Unload mfrmPrice
        Set mfrmPrice = Nothing
        Call zlDatabase.SetPara("显示医嘱计价面板", IIF(Val(stbThis.Panels("Price").Tag) <> 0, 1, 0), glngSys, p门诊医嘱下达)
    End If
    If mbytUseType = 0 Then
        If Val(zlDatabase.GetPara("使用个性化风格")) = 1 Then
            Call SaveSetting("ZLSOFT", "私有模块\" & gstrDBUser & "\界面设置\" & App.ProductName & "\" & Me.Name & "\" & TypeName(dkpMain), dkpMain.Name & dkpMain.PanesCount, dkpMain.SaveStateToString)
        End If
    End If
    
    If mblnPass Then
        Call gobjPass.zlPassClearLight(mobjPassMap)
    End If
    Set mobjPassMap = Nothing
    Call zlDatabase.SetPara("门诊诊断输入", IIF(opt诊断(0).value, 0, 1), glngSys, p门诊医生站, InStr(GetInsidePrivs(p门诊医生站), ";参数设置;") > 0)
    Call SaveWinState(Me, App.ProductName)
    If Not mobjPati Is Nothing Then
        Call mobjPati.zlGetForm.UpdateLastItem
        If Not mblnOK Then mblnOK = mobjPati.zlGetForm.IsDataSaved
    End If
    If Not mcolSubForm Is Nothing Then
        For i = mcolSubForm.Count To 1 Step -1
            Unload mcolSubForm(i)
            Call mcolSubForm.Remove(i)
        Next
        Set mcolSubForm = Nothing
    End If
    If Not mcolDE Is Nothing Then
        For i = mcolDE.Count To 1 Step -1
            Call mcolDE.Remove(i)
        Next
        Set mcolDE = Nothing
    End If
    Set mobjPati = Nothing
    RaiseEvent FormUnload(Cancel)
    mblnNoSave = False
    mlngDSeq = 0
    Set mrsSubForm = Nothing
    Set mrsAD = Nothing
    Set mrsComD = Nothing
    Set mrsLasD = Nothing
    mlng危急值ID = 0
    
    If Not mfrmShortCut Is Nothing Then
        Unload mfrmShortCut
        Set mfrmShortCut = Nothing
    End If
    
    mblnDocInput = False
    mblnSizeTmp = False
    mblnPatiChange = False
    mlng病历id = 0
    mlng病历文件id = 0
    mbln是否签名 = False
    mstr保存人 = ""
    mstr婚姻状况 = ""
    Set mrsMainInfo = Nothing
    mblnChange = False
    Set mclsUnZip = Nothing
    Set mclsZip = Nothing
    Set mcls病历功能 = Nothing
    Set mobjEPRDoc = Nothing
    Set mrsHotPlugIn = Nothing
End Sub

Private Function RowCanMerge(ByVal lngRow1 As Long, ByVal lngRow2 As Long, Optional strMsg As String) As Boolean
'功能：判断两行是否可以一并给药
'参数：lngRow1=前面一条已经输入的药品行
'      lngRow2=当前行(已输入或未输入)
'返回：如果不可以，则strMsg返回提示信息
    Dim lngFind As Long, lngRxCount As Long
    Dim lng配制中心 As Long, str药房IDs As String
    
    With vsAdvice
        strMsg = ""
        If Not Between(lngRow1, .FixedRows, .Rows - 1) Then Exit Function
        If Not Between(lngRow2, .FixedRows, .Rows - 1) Then Exit Function
        If .RowHidden(lngRow1) Or .RowHidden(lngRow2) Then Exit Function
        If .RowData(lngRow1) = 0 Then Exit Function
        
        If mbytUseType = 1 Then
            If .TextMatrix(lngRow1, COL_路径项目ID) <> .TextMatrix(lngRow2, COL_路径项目ID) Then
                strMsg = "一并给药的要求是同一路径项目对应的医嘱。"
                Exit Function
            End If
        End If
        
        If .RowData(lngRow2) = 0 Then
            '必须全部为成药且类别相同
            If InStr(",5,6,", .TextMatrix(lngRow1, COL_类别)) = 0 Then
                strMsg = "一并给药的药品必须都为西成药或都为中成药。"
                Exit Function
            End If
            
            '不能包含已发送的医嘱
            If Val(.TextMatrix(lngRow1, COL_状态)) <> 1 Then
                strMsg = "要设置为一并给药的药品包含已经发送的医嘱。"
                Exit Function
            End If
            '不能包含已签名的医嘱
            If Val(.TextMatrix(lngRow1, COL_签名否)) = 1 Then
                strMsg = "要设置为一并给药的药品包含已经签名的医嘱。"
                Exit Function
            End If
        ElseIf .RowData(lngRow2) <> 0 Then
            If InStr(",5,6,", .TextMatrix(lngRow1, COL_类别)) = 0 _
                Or InStr(",5,6,", .TextMatrix(lngRow2, COL_类别)) = 0 Then
                strMsg = "一并给药的药品必须都为西成药或都为中成药。"
                Exit Function
            End If
            
            '不能包含已发送的医嘱
            If Val(.TextMatrix(lngRow1, COL_状态)) <> 1 Or Val(.TextMatrix(lngRow2, COL_状态)) <> 1 Then
                strMsg = "要设置为一并给药的药品包含已经发送的医嘱。"
                Exit Function
            End If
            '不能包含已签名的医嘱
            If Val(.TextMatrix(lngRow1, COL_签名否)) = 1 Or Val(.TextMatrix(lngRow2, COL_签名否)) = 1 Then
                strMsg = "要设置为一并给药的药品包含已经签名的医嘱。"
                Exit Function
            End If
            
            '一并给药(前面药品)的给药途径是否适用于当前药品
            lngFind = .FindRow(CLng(.TextMatrix(lngRow1, COL_相关ID)), lngRow1 + 1)
            If lngFind <> -1 Then
                If Not Check适用用法(Val(.TextMatrix(lngFind, COL_诊疗项目ID)), Val(.TextMatrix(lngRow2, COL_诊疗项目ID)), 1, Val(.TextMatrix(lngRow2, COL_收费细目ID))) Then
                    strMsg = """" & .TextMatrix(lngRow2, col_医嘱内容) & """不能使用""" & .TextMatrix(lngFind, col_医嘱内容) & """给药途径，" & _
                    vbCrLf & "不能与""" & .TextMatrix(lngRow1, col_医嘱内容) & """设置为一并给药。"
                    Exit Function
                End If
            End If
            
            '检查如果有配制中心，是否都可以存储，自备药不管它
            If Not (Val(.TextMatrix(lngRow1, COL_执行科室ID)) = 0 And Val(.TextMatrix(lngRow1, COL_执行性质)) = 5) Then
                If Sys.DeptHaveProperty(Val(.TextMatrix(lngRow1, COL_执行科室ID)), "配制中心") Then
                    lng配制中心 = Val(.TextMatrix(lngRow1, COL_执行科室ID))
                End If
            End If
            If lng配制中心 = 0 Then
                If Not (Val(.TextMatrix(lngRow2, COL_执行科室ID)) = 0 And Val(.TextMatrix(lngRow2, COL_执行性质)) = 5) Then
                    If Sys.DeptHaveProperty(Val(.TextMatrix(lngRow2, COL_执行科室ID)), "配制中心") Then
                        lng配制中心 = Val(.TextMatrix(lngRow2, COL_执行科室ID))
                    End If
                End If
            End If
            If lng配制中心 <> 0 Then
                If Not (Val(.TextMatrix(lngRow1, COL_执行科室ID)) = 0 And Val(.TextMatrix(lngRow1, COL_执行性质)) = 5) Then
                    str药房IDs = Get可用药房IDs(.TextMatrix(lngRow1, COL_类别), Val(.TextMatrix(lngRow1, COL_诊疗项目ID)), Val(.TextMatrix(lngRow1, COL_收费细目ID)), mlng病人科室id, 1)
                    If InStr("," & str药房IDs & ",", "," & lng配制中心 & ",") = 0 Then
                        strMsg = "药品""" & .TextMatrix(lngRow1, col_医嘱内容) & """在配制中心""" & Sys.RowValue("部门表", lng配制中心, "名称") & """没有存储。"
                        Exit Function
                    End If
                End If
                If Not (Val(.TextMatrix(lngRow2, COL_执行科室ID)) = 0 And Val(.TextMatrix(lngRow2, COL_执行性质)) = 5) Then
                    str药房IDs = Get可用药房IDs(.TextMatrix(lngRow2, COL_类别), Val(.TextMatrix(lngRow2, COL_诊疗项目ID)), Val(.TextMatrix(lngRow2, COL_收费细目ID)), mlng病人科室id, 1)
                    If InStr("," & str药房IDs & ",", "," & lng配制中心 & ",") = 0 Then
                        strMsg = "药品""" & .TextMatrix(lngRow2, col_医嘱内容) & """在配制中心""" & Sys.RowValue("部门表", lng配制中心, "名称") & """没有存储。"
                        Exit Function
                    End If
                End If
            End If
        End If
        
        '检查处方药品种数限制
        If gintRXCount > 0 Then
            lngFind = .FindRow(.TextMatrix(lngRow1, COL_相关ID), , COL_相关ID)
            lngRxCount = GetMergeCount(vsAdvice, lngFind, COL_相关ID, COL_收费细目ID)
            If lngRxCount >= gintRXCount Then
                strMsg = "一并给药的药品种数 " & lngRxCount & " 种已达到或超过药品处方最多允许的种数 " & gintRXCount & " 种。"
                Exit Function
            End If
        End If
    End With
    RowCanMerge = True
End Function

Private Sub cbsMain_Execute(ByVal Control As XtremeCommandBars.ICommandBarControl)
    Dim lng医嘱ID As Long, lng相关ID As Long
    Dim str类别 As String, lngTmp As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim lngPreRow As Long, strMsg As String
    Dim lng诊疗项目ID As Long, i As Long, j As Long
    Dim str诊断IDs As String, lngSeek As Long
    Dim intLoop As Integer
    Dim blnTag As Boolean
    Dim objAppPages() As clsApplicationData
    Dim rsCard As ADODB.Recordset
    Dim strLIS As String
    
    Dim lng病人ID As Long, str挂号单 As String, blnMoved As Boolean
    
    Call AdviceChange '强制更新医嘱内容
    
    picPanel(e诊断表格).Visible = False
    
    With vsAdvice
        Select Case Control.ID
            Case conMenu_New
                If .RowData(.Row) = 0 Then
                ElseIf .RowData(.Rows - 1) = 0 Then
                    .Row = .Rows - 1
                Else
                    '先删除中间间隔的空行
                    mblnRowChange = False
                    For i = .Rows - 1 To .FixedRows Step -1
                        If .RowData(i) = 0 Then .RemoveItem i
                    Next
                    mblnRowChange = True
                    
                    .AddItem "", .Rows
                    .Row = .Rows - 1
                    .Col = .FixedCols
                End If
                
                Call .ShowCell(.Row, .Col)
                If Visible And txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
            Case conMenu_Insert
                If .RowData(.Row) = 0 Then
                    MsgBox "当前行无内容，请先在当前行录入有效医嘱。", vbInformation, gstrSysName
                    Exit Sub
                End If
                            
                lngPreRow = GetPreRow(.Row)
                            
                '插入后成自动成为一并给药:插入在一并给药的中间才行
                If lngPreRow <> -1 Then
                    If Val(.TextMatrix(lngPreRow, COL_相关ID)) = Val(.TextMatrix(.Row, COL_相关ID)) _
                        And Val(.TextMatrix(lngPreRow, COL_相关ID)) <> 0 And InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                        
                        '不能在已发送的一并给药中插入
                        If Val(.TextMatrix(.Row, COL_状态)) <> 1 Then
                            MsgBox "该组一并给药的医嘱已经发送，不能再插入。", vbInformation, gstrSysName
                            Exit Sub
                        End If
                        '不能在已签名的一并给药中插入
                        If Val(.TextMatrix(.Row, COL_签名否)) = 1 Then
                            MsgBox "该组一并给药的医嘱已经签名，不能再插入。", vbInformation, gstrSysName
                            Exit Sub
                        End If
                        
                        lng相关ID = Val(.TextMatrix(lngPreRow, COL_相关ID))
                    End If
                End If
                
                '先删除中间间隔的空行
                mblnRowChange = False
                lng医嘱ID = .RowData(.Row)
                For i = .Rows - 1 To .FixedRows Step -1
                    If .RowData(i) = 0 Then .RemoveItem i
                Next
                .Row = .FindRow(lng医嘱ID)
                mblnRowChange = True
                            
                '当前行之前插入新行
                '--------------------------------------------------------------
                If RowIn配方行(.Row) Or RowIn检验行(.Row) Then
                    '中药配方及检验组合行是前面的行隐藏
                    lngBegin = .FindRow(CStr(.RowData(.Row)), , COL_相关ID)
                Else
                    lngBegin = .Row
                End If
                
                mblnRowChange = False
                .AddItem "", lngBegin
                .Row = lngBegin
                .Col = .FixedCols
                If lng相关ID <> 0 Then .TextMatrix(.Row, COL_并) = "┃"
                mblnRowChange = True
                Call vsAdvice_AfterRowColChange(-1, .Col, .Row, .Col)
                Call .ShowCell(.Row, .Col)
                
                txt医嘱内容.SetFocus '先定位避免光标晃
            Case conMenu_Edit_ViewDrugExplain '查看药品说明书
                Call FuncViewDrugExplain(Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_收费细目ID)), Me)
            Case conMenu_Merge '一并给药
                If Not Control.Checked Then '想按下
                    lngBegin = GetPreRow(.Row)
                    '前面没有行
                    If lngBegin = -1 Then
                        MsgBox "前面没有可以一并给药的医嘱行。", vbInformation, gstrSysName
                        Exit Sub
                    End If
                    '两行不符合条件
                    If Not RowCanMerge(lngBegin, .Row, strMsg) Then
                        MsgBox strMsg, vbInformation, gstrSysName
                        Exit Sub
                    End If
                    If .RowData(.Row) = 0 Then
                        '当前行尚未输入内容的情况
                        If DateDiff("n", CDate(.Cell(flexcpData, lngBegin, COL_开始时间)), zlDatabase.Currentdate) <= gint门诊新开医嘱间隔 Then
                            msk开始时间.Text = .Cell(flexcpData, lngBegin, COL_开始时间)
                        End If
                        mblnRowMerge = True: cbsMain.RecalcLayout '*允许按下
                        If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus: Exit Sub
                    Else
                        '要把当前行与前面行一起一并给药
                        If .TextMatrix(.Row, COL_用法) <> .TextMatrix(lngBegin, COL_用法) Then
                            If MsgBox("当前选择一并给药的药品给药途径不同,是否继续？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                                Exit Sub
                            End If
                        End If
                        Call MergeRow(lngBegin, .Row, False)
                        Call ReSetColor(.Row) '一并之后再一并设置
                    End If
                Else '想弹起
                    If .RowData(.Row) = 0 Then
                        '当前行尚未输入内容的情况
                        If Not RowIn一并给药(.Row) Then
                            mblnRowMerge = False '*允许弹起
                            cbsMain.RecalcLayout
                        End If
                        Exit Sub
                    Else
                        '当前行是一并给药中的行
                        Call Get一并给药范围(Val(.TextMatrix(.Row, COL_相关ID)), lngBegin, lngEnd)
                                                
                        '先判断可否取消一并给药
                        '不能包含已发送的医嘱
                        If Val(.TextMatrix(.Row, COL_状态)) <> 1 Then
                            MsgBox "当前医嘱已经发送。", vbInformation, gstrSysName
                            Exit Sub
                        End If
                        '不能包含已签名的医嘱
                        If Val(.TextMatrix(.Row, COL_签名否)) = 1 Then
                            MsgBox "当前医嘱已经签名。", vbInformation, gstrSysName
                            Exit Sub
                        End If
                                                
                        '先提示
                        If Not (.Row = lngEnd And lngEnd - lngBegin > 1) Then
                            .Redraw = flexRDNone
                            '整个一并给药取消为单独给药
                            If MsgBox("要将该组一并给药的药品全部取消为单独给药吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                                .Redraw = flexRDDirect
                                Exit Sub
                            End If
                            .Redraw = flexRDDirect
                        End If
                        
                        '删除中间的空行
                        lngTmp = .RowData(.Row)
                        For i = lngEnd To lngBegin Step -1
                            If .RowData(i) = 0 Then
                                .RemoveItem i
                                lngEnd = lngEnd - 1
                            End If
                        Next
                        .Row = .FindRow(lngTmp, lngBegin)
                        
                        '记录当前一并时的诊断关联以便恢复
                        Call AdviceHaveDiag(.Row, 0, str诊断IDs)
                        lngSeek = .RowData(lngEnd)
                        If .Row = lngEnd And lngEnd - lngBegin > 1 Then
                            '从一并给药中分离该行
                            Call ReSetColor(.Row) '在取消之前一并设置
                            Call SplitRow(.Row)
                        Else
                            '取消一并给药
                            Call ReSetColor(.Row) '在取消之前一并设置
                            lngTmp = .RowData(.Row) '记录用于恢复行定位
                            Call AdviceSet单独给药(lngBegin, lngEnd)
                            .Row = .FindRow(lngTmp)
                        End If
                        
                        '根据记录的诊断关联进行恢复
                        If str诊断IDs <> "" Then
                            lngSeek = .FindRow(lngSeek, lngBegin)
                            For i = lngBegin To lngSeek
                                If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 _
                                    And Val(.TextMatrix(i, COL_相关ID)) <> Val(.TextMatrix(i - 1, COL_相关ID)) _
                                    And Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                                    Call SetDiagFlag(i, 1, str诊断IDs)
                                End If
                            Next
                        End If
                    End If
                End If
                Call vsAdvice_AfterRowColChange(-1, .Col, .Row, .Col)
            Case conMenu_Delete
                If .RowSel <> .Row Then
                    MsgBox "一次只能删除一条医嘱，请选择要删除的医嘱行。", vbInformation, gstrSysName
                    Exit Sub
                End If
                If .RowData(.Row) <> 0 Then
                    '已发送的医嘱不能删除
                    If Val(.TextMatrix(.Row, COL_状态)) <> 1 Then
                        MsgBox "该条医嘱已经发送，不能删除。", vbInformation, gstrSysName
                        Exit Sub
                    End If
                    '已签名的医嘱不能删除
                    If Val(.TextMatrix(.Row, COL_签名否)) = 1 Then
                        MsgBox "该条医嘱已经签名，不能删除。", vbInformation, gstrSysName
                        Exit Sub
                    End If
                    '已经执行登记的医嘱项目不能删除
                    If mbytUseType = 0 And mlng路径状态 = 1 Then
                        If CheckPathAdviceIsExeOut(.RowData(.Row)) Then
                            MsgBox "该医嘱对应的项目已经执行。" & vbCrLf & "请取消执行登记后再进行删除操作。", vbInformation + vbOKOnly + vbDefaultButton1, gstrSysName
                            Exit Sub
                        End If
                    End If
                    '已保存的路径中的项目只有必要时使用的项目可删除，非必要时的，如果是选择生成医嘱的，允许删除到至少保留一条。
                    If mbytUseType = 0 And Val(.TextMatrix(.Row, COL_路径项目ID)) <> 0 Then
                        If Val(.TextMatrix(.Row, COL_路径执行方式)) <> 2 And Val(.TextMatrix(.Row, COL_路径执行ID)) <> 0 Then
                            lng医嘱ID = Val(.TextMatrix(.Row, COL_相关ID))
                            If lng医嘱ID = 0 Then lng医嘱ID = .RowData(.Row)
    
                            If CheckAdviceOfPathItemOut(Val(.TextMatrix(.Row, COL_路径执行ID)), lng医嘱ID) Then
                                If MsgBox("该路径项目中的医嘱是必须生成的，是否删除？", vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                                    Exit Sub
                                End If
                            End If
                        End If
                    End If
                    
                    If MsgBox("确实要删除医嘱""" & .TextMatrix(.Row, col_医嘱内容) & """吗？", _
                        vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then Exit Sub
                End If
                
                Call AdviceDelete(.Row) '删除当前行
                Call CalcAdviceMoney '显示新开医嘱金额
                
                vsAdvice.SetFocus
            Case conMenu_Blankoff
                '作废之前自动保存
                If mblnNoSave Then
                    If Not CheckAdvice Then Exit Sub
                    If Not SaveAdvice Then .SetFocus: Exit Sub
                End If
                Call AdviceRevoke
            Case conMenu_Edit_PacsApply, conMenu_Edit_PacsApply * 10# + 1 '检查申请
                Call AdviceInput申请单(1)
            Case conMenu_Edit_LISApply, conMenu_Edit_LISApply * 10# + 1 '检验申请
                Call AdviceInput申请单(2)
            Case conMenu_Edit_BloodApply, conMenu_Edit_BloodApply * 10# + 1 '输血申请
                Call AdviceInput申请单(3)
            Case conMenu_Edit_OperationApply, conMenu_Edit_OperationApply * 10# + 1 '手术申请
                Call AdviceInput申请单(4)
            Case conMenu_Edit_ApplyCustom * 100# To conMenu_Edit_ApplyCustom * 101# '自定义申请单
                FuncApplyCustom 0, Control.Parameter
            
            Case conMenu_Reference
                If Val(.TextMatrix(.Row, COL_诊疗项目ID)) <> 0 Then
                    If RowIn配方行(.Row) Or RowIn检验行(.Row) Then
                        i = .FindRow(CStr(.RowData(.Row)), , COL_相关ID)
                        If i <> -1 Then
                            lng诊疗项目ID = Val(.TextMatrix(i, COL_诊疗项目ID))
                        End If
                    Else
                        lng诊疗项目ID = Val(.TextMatrix(.Row, COL_诊疗项目ID))
                    End If
                End If
                '诊疗措施参考
                Call frmClinicHelp.ShowMe(IIF(mblnModal, 1, 0), mfrmParent, lng诊疗项目ID)
            Case conMenu_Copy
                lng病人ID = mlng病人ID: str挂号单 = mstr挂号单: blnMoved = False
                strMsg = frmAdviceCopy.ShowMe(Me, mMainPrivs, lng病人ID, str挂号单, blnMoved, False, mlng前提ID, , mlng病人科室id, , , mstr性别)
                If strMsg <> "" Then
                    cbsMain.FindControl(, conMenu_New, True, True).Execute
                    Call AdviceSet复制医嘱(lng病人ID, str挂号单, strMsg, blnMoved)
                End If
            Case conMenu_Scheme, conMenu_Scheme * 10# + 1
                Call frmAdviceScheme.ShowMe(IIF(mlng前提ID <> 0, 2, 0), 1, mlng病人ID, 0, mstr挂号单, cbo婴儿.ListIndex, Me)
            Case conMenu_Scheme * 10# + 2
                Call mfrmShortCut.ShowMe(Me, mint场合, 1, 0, mlng病人科室id, False, mlng医技科室ID)
            Case conMenu_Agent
                
                For intLoop = 1 To vsAdvice.Rows - 1
                    If (Val(vsAdvice.TextMatrix(intLoop, COL_状态)) = 1 And InStr(",麻醉药,毒性药,精神I类,", "," & Trim(vsAdvice.TextMatrix(intLoop, COL_毒理分类)) & ",") > 0) Then
                        blnTag = True: Exit For
                    End If
                Next
                If Not blnTag Then MsgBox "病人未执行的医嘱中不存在麻醉药、毒性药、精神I类药品医嘱，不需要填写代办人信息！", vbInformation, gstrSysName: Exit Sub
                Call GetPatiInfo
                Call frmAgentInfo.ShowMe(Me, mlng病人ID, mlng挂号ID, mstr姓名, mstr身份证号, AgentInfo.代办人姓名, AgentInfo.代办人身份证号, AgentInfo.代办人性别, AgentInfo.代办人年龄, AgentInfo.代办人电话, AgentInfo.用药理由)
                Call GetAgentInfo
                Screen.MousePointer = 0
            Case conMenu_Save
                If vsDiag.EditText <> "" Then
                    mblnCancle = False
                    Me.SetFocus
                    If mblnCancle = True Then mblnCancle = False: Exit Sub
                End If
                If Not CheckAdvice Then Exit Sub '检查中处理了光标定位
                If Not SaveAdvice Then .SetFocus: Exit Sub
                If mbytUseType = 1 Or mbytUseType = 2 Or mbytUseType = 3 Then Unload Me: Exit Sub
            Case conMenu_Send, conMenu_Send * 10# + 1, conMenu_Send * 10# + 2
                '发送之前自动保存
                If mblnNoSave Then
                    If Not CheckAdvice Then Exit Sub
                    If Not SaveAdvice Then .SetFocus: Exit Sub
                End If
                If mfrmSend Is Nothing Then Set mfrmSend = New frmOutAdviceSend
                If mfrmSend.ShowMe(Me, mMainPrivs, mlng病人ID, mstr挂号单, mstr前提IDs, _
                    Control.ID = conMenu_Send And Control.Type = xtpControlSplitButtonPopup Or Control.ID = conMenu_Send * 10# + 1, mlng医技科室ID, mint场合, mclsMipModule) Then
                    '病人医嘱发送完成后自动关闭窗体
                    If mblnAutoClose Then
                        If Not ExistNoSendAdvice(mlng病人ID, mstr挂号单) Then
                            mblnOK = True: Unload Me: Exit Sub
                        End If
                    End If
                    
                    '重新读取显示医嘱
                    Call ReLoadAdvice
                    mblnOK = True '强行
                    If txt医嘱内容.Enabled Then
                        txt医嘱内容.SetFocus
                    Else
                        .SetFocus
                    End If
                End If
            Case conMenu_AltAdvice
                '备选医嘱
                Call ShowAltAdvice
            Case conMenu_AdvicePay
                Call FuncClinicPay(Me, mlng病人ID, mstr挂号单)
            Case conMenu_Sign
                Call AdviceSign
            Case conMenu_Help
                ShowHelp App.ProductName, Me.hwnd, Me.Name
            Case conMenu_Exit
                Unload Me
            Case conMenu_DrugScale * 100# + 1 To conMenu_DrugScale * 100# + 99
                With vsAdvice
                    txt单量.Text = FormatEx(Val(.TextMatrix(.Row, COL_剂量系数)) * Val(Control.Parameter), 5)
                    Call zlControl.TxtSelAll(txt单量)
                End With
            Case conMenu_Edit_MediAudit * 10# To conMenu_Edit_MediAudit * 10# + 99  'PASS合理用药
                If mblnPass Then
                    Call gobjPass.zlPassCommandBarExe(mobjPassMap, Control.ID - conMenu_Edit_MediAudit * 10#, mblnNoSave)
                End If
            Case conMenu_Tool_PlugIn_Item + 1 To conMenu_Tool_PlugIn_Item + 99 '外挂功能执行
                Call ExePlugIn(Control.Parameter)
            Case conMenu_Tool_Diag_items To conMenu_Tool_Diag_items + 99 '诊断外挂扩展功能执行
                Call ExePlugIn(Control.Parameter, 1)
            Case conMenu_SchemeInSide * 100# + 1 To conMenu_SchemeInSide * 100# + 99
                If conMenu_SchemeInSide * 100# + 4 > Control.ID Then
                    lblCTFW.Caption = Control.Caption
                    lblCTFW.Tag = Control.Parameter
                Else
                    lblCTN.Caption = Control.Caption
                    lblCTN.Tag = Control.Parameter
                End If
                Call GetSchemeClass(Val(lblCTFW.Tag))
                Call ReLoadScheme(Val(lblCTFW.Tag), Val(lblCTN.Tag))
        End Select
    End With
End Sub

Private Function CheckAdviceOfPathItemOut(ByVal lng路径执行ID As Long, ByVal lng医嘱ID As Long) As Boolean
'功能：检查指定的医嘱是否是"选择生成"的医嘱之一(存在其他医嘱)，不含本次界面上已删除的医嘱(mstrDelTempIDs)
'返回：true=该医嘱的路径项目不是选择生成，或者不存在其他医嘱
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    
    strSQL = "Select 1" & vbNewLine & _
            "From 病人门诊路径医嘱 A" & vbNewLine & _
            "Where a.路径执行id = [1] And instr([3],','|| a.病人医嘱id||',') = 0 And Not Exists" & vbNewLine & _
            " (Select 1 From 病人医嘱记录 B Where a.病人医嘱id = b.Id And (b.Id = [2] Or b.相关id = [2])) And Exists" & vbNewLine & _
            " (Select 1 From 病人门诊路径执行 C, 门诊路径项目 D Where c.Id = a.路径执行id And c.项目id = d.Id And d.内容要求 = 1) And Rownum < 2"

    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng路径执行ID, lng医嘱ID, "," & mstrDelIDs & ",")
    CheckAdviceOfPathItemOut = rsTmp.RecordCount = 0
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function ExistNoSendAdvice(ByVal lng病人ID As Long, ByVal str挂号单 As String) As Boolean
'功能：检查当前病人的医嘱是否已经发送完成。
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    
    On Error GoTo errH
    
    '叮嘱、免试皮试、护理等级不发送
    strSQL = "Select 1 From 病人医嘱记录 A,诊疗项目目录 B" & _
        " Where Nvl(A.皮试结果,'无')<>'免试' And Not (A.诊疗类别='H' And B.操作类型='1')" & _
        " And Nvl(A.执行性质,0)<>0 And A.开始执行时间 is Not NULL And A.病人来源<>3" & _
        " And A.诊疗项目ID=B.ID And A.医嘱状态=1 And A.病人ID=[1] And A.挂号单=[2] And Rownum=1"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "ExistNoSendAdvice", lng病人ID, str挂号单)
    If Not rsTmp.EOF Then ExistNoSendAdvice = True
    
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub Get一并给药范围(ByVal lng相关ID As Long, lngBegin As Long, lngEnd As Long)
'功能：根据相关的给药途径医嘱ID,确定一并给药的一组药品的起止行号
'说明：中间可能包含有空行
    Dim i As Long
    lngBegin = vsAdvice.FindRow(CStr(lng相关ID), , COL_相关ID)
    For i = lngBegin To vsAdvice.Rows - 1
        If Not vsAdvice.RowHidden(i) And vsAdvice.RowData(i) <> 0 Then
            If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = lng相关ID Then
                lngEnd = i
            Else
                Exit For
            End If
        End If
    Next
End Sub

Private Sub txt单量_Change()
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If Val(.TextMatrix(.Row, COL_单量)) <> Val(txt单量.Text) Then
                txt单量.Tag = "1"
            End If
        Else
            txt单量.Tag = "1"
        End If
    End With
End Sub

Private Sub txt单量_GotFocus()
    zlControl.TxtSelAll txt单量
    stbThis.Panels(2).Text = "单量输入快捷键：'+'，'-'，空格。"
End Sub

Private Sub txt单量_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    Dim dblTmp As Double
    Dim dbl剂量系数 As Double
    Dim dblCnt As Double
    Dim strSQL As String
    Dim i As Long
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If IsNumeric(txt单量.Text) And Val(txt单量.Text) > 0 _
            Or txt单量.Text = "" And (Not mbln单量 Or InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) = 0) Then
            Call txt单量_Validate(blnCancel)
            If Not blnCancel Then mblnReturn = True: Call SeekNextControl
        End If
    ElseIf KeyAscii = 32 Then
        KeyAscii = 0
        If Val(txt单量.Text) = 0 Then
            txt单量.Text = FormatEx(Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_剂量系数)), 5)
            Call zlControl.TxtSelAll(txt单量)
        End If
    ElseIf KeyAscii = Asc("+") Or KeyAscii = Asc("-") Then
        
        If mrsDrugScale Is Nothing Then
            strSQL = "Select 名称,比例 From 常用剂量比例 Where 名称 is Not NULL And 比例 is Not NULL Order by 编码"
            Set mrsDrugScale = zlDatabase.OpenSQLRecord(strSQL, Me.Caption)
            
            If mrsDrugScale.EOF Then
                MsgBox "没有设置常用剂量比例，请先到字典管理工具进行设置。", vbInformation, gstrSysName
                Exit Sub
            End If
        End If
        
        dbl剂量系数 = Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_剂量系数))
        dblTmp = Val(txt单量.Text)
        dblCnt = dblTmp / dbl剂量系数
        
        If KeyAscii = Asc("-") Then
            mrsDrugScale.Filter = "比例<=" & dblCnt
            mrsDrugScale.Sort = "比例 desc"
        Else
            mrsDrugScale.Filter = "比例>=" & dblCnt
            mrsDrugScale.Sort = "比例"
        End If
        KeyAscii = 0
        If Not mrsDrugScale.EOF Then
            For i = 1 To mrsDrugScale.RecordCount
                If Val(mrsDrugScale!比例 & "") <> Val(dblCnt) Then
                    txt单量.Text = FormatEx(Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_剂量系数)) * Val(mrsDrugScale!比例 & ""), 5)
                    Call zlControl.TxtSelAll(txt单量)
                    Exit For
                End If
                mrsDrugScale.MoveNext
            Next
        End If
    Else
        If vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "4" And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_可否分零)) = 0 Then
            If InStr("0123456789" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
        Else
            If InStr("0123456789." & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
        End If
    End If
End Sub

Private Sub txt单量_Validate(Cancel As Boolean)
    Dim strMsg As String, dbl次数 As Double, sng天数 As Single
    Dim lngFind As Long, blnDo As Boolean
    Dim sng总量 As Single
    
    With vsAdvice
        If Val(txt单量.Text) = 0 Then txt单量.Text = ""
        If mblnReturn Then mblnReturn = False: Exit Sub
        If Not IsNumeric(txt单量.Text) Then
            If txt单量.Text <> "" Then
                Cancel = True: txt单量_GotFocus: Exit Sub
            ElseIf txt单量.Text = "" And mbln单量 And InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) > 0 Then
                txt单量.Text = "": Exit Sub
            End If
        ElseIf CDbl(txt单量.Text) <= 0 Then
            Cancel = True: txt单量_GotFocus: Exit Sub
        ElseIf CDbl(txt单量.Text) > LONG_MAX Then
            Cancel = True: txt单量_GotFocus: Exit Sub
        ElseIf txt单量.Text <> "" Then
            '单量合法性检查
            If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 And Val(.TextMatrix(.Row, COL_收费细目ID)) <> 0 Then
                blnDo = Not txt天数.Visible '给药方法为叮嘱，或输入天数时不检查
                If blnDo Then
                    lngFind = .FindRow(CLng(Val(.TextMatrix(.Row, COL_相关ID))), .Row + 1)
                    If lngFind <> -1 Then blnDo = blnDo And Val(.TextMatrix(lngFind, COL_执行性质)) <> 0
                End If
                If blnDo Then
                    dbl次数 = IIF(Val(.TextMatrix(.Row, COL_总量)) = 0, 1, Val(.TextMatrix(.Row, COL_总量))) * _
                        Val(.TextMatrix(.Row, COL_门诊包装)) * Val(.TextMatrix(.Row, COL_剂量系数)) / Val(txt单量.Text)
                    If dbl次数 > 200 Then
                        If MsgBox("该药品按每次 " & FormatEx(txt单量.Text, 5) & .TextMatrix(.Row, COL_单量单位) & " 使用，" & _
                            IIF(Val(.TextMatrix(.Row, COL_总量)) = 0, "每", Val(.TextMatrix(.Row, COL_总量))) & _
                            .TextMatrix(.Row, COL_门诊单位) & "可以使用 " & FormatEx(dbl次数, 5) & " 次。" & _
                            vbCrLf & vbCrLf & "你确认单量输入正确吗？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                            Cancel = True: txt单量_GotFocus: Exit Sub
                        End If
                    End If
                End If
            End If
            mdblPre总量 = Val(txt总量.Text)
            txt单量.Text = FormatEx(txt单量.Text, 5)
            
            '重新计算药品总量(先输入单量时)
            If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                If mbln天数 Then
                    If mbln天数反算 Then
                        If Val(txt总量.Text) <> 0 Then
                            '开始反算天数
                            '不输天数时，根据总量、单量、频率计算天数，检查是否超期
                            If Val(txt总量.Text) <> 0 And Val(txt单量.Text) <> 0 <> 0 _
                                And .TextMatrix(.Row, COL_频率) <> "" And Val(.TextMatrix(.Row, COL_频率次数)) <> 0 And Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 _
                                And Val(.TextMatrix(.Row, COL_剂量系数)) <> 0 And Val(.TextMatrix(.Row, COL_门诊包装)) <> 0 Then
                                
                                sng天数 = Calc缺省药品天数(Val(txt总量.Text), Val(txt单量.Text), _
                                    Val(.TextMatrix(.Row, COL_频率次数)), Val(.TextMatrix(.Row, COL_频率间隔)), .TextMatrix(.Row, COL_间隔单位), _
                                    Val(.TextMatrix(.Row, COL_剂量系数)), Val(.TextMatrix(.Row, COL_门诊包装)), _
                                    Val(.TextMatrix(.Row, COL_可否分零)))
                                Call CheckDrugOutOfRange(.Row, sng天数)
                            End If
                        End If
                        If sng天数 = 0 Then sng天数 = 1
                        msngPre天数 = sng天数
                        txt天数.Text = sng天数
                    Else
                        sng天数 = Val(.TextMatrix(.Row, COL_天数))
                        If sng天数 = 0 Then sng天数 = 1
                        sng总量 = Val(txt总量.Text)
                        
                        txt总量.Text = ReGet药品总量(sng总量, Val(txt单量.Text), sng天数, .Row)
                        '隐式调用了Change事件
                                               
                        Call txt总量_Validate(Cancel)
                        If Cancel Then
                            txt总量.Text = sng总量
                            Exit Sub
                        End If
                    End If
                Else
                    '不输天数时，根据总量、单量、频率计算天数，检查是否超期
                    If Val(txt总量.Text) <> 0 And Val(txt单量.Text) <> 0 <> 0 _
                        And .TextMatrix(.Row, COL_频率) <> "" And Val(.TextMatrix(.Row, COL_频率次数)) <> 0 And Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 _
                        And Val(.TextMatrix(.Row, COL_剂量系数)) <> 0 And Val(.TextMatrix(.Row, COL_门诊包装)) <> 0 Then
                        
                        sng天数 = Calc缺省药品天数(Val(txt总量.Text), Val(txt单量.Text), _
                            Val(.TextMatrix(.Row, COL_频率次数)), Val(.TextMatrix(.Row, COL_频率间隔)), .TextMatrix(.Row, COL_间隔单位), _
                            Val(.TextMatrix(.Row, COL_剂量系数)), Val(.TextMatrix(.Row, COL_门诊包装)), _
                            Val(.TextMatrix(.Row, COL_可否分零)))
                            
                        Call CheckDrugOutOfRange(.Row, sng天数)
                    End If
                End If
            End If
            mdblPre总量 = Val(txt总量.Text)
            '更新数据
            Call AdviceChange
        End If
    End With
End Sub

Private Sub msk开始时间_Change()
    msk开始时间.Tag = "1"
End Sub

Private Sub msk开始时间_GotFocus()
    If msk开始时间.Text = Replace(msk开始时间.Mask, "#", "_") Then msk开始时间.Text = GetDefaultTime(vsAdvice.Row)
    zlControl.TxtSelAll msk开始时间
End Sub

Private Sub msk开始时间_KeyPress(KeyAscii As Integer)
    Dim strDate As String
    If KeyAscii = 13 Then
        KeyAscii = 0
        If msk开始时间.Text <> Replace(msk开始时间.Mask, "#", "_") Then
            strDate = zlStr.FullDate(Val(Replace(Replace(Replace(Replace(msk开始时间.Text, "-", " "), "_", " "), ":", " "), " ", "")) & "")
            If IsDate(strDate) Then
                msk开始时间.Text = strDate
            End If
            If SeekNextControl Then Call msk开始时间_Validate(False)
        End If
    Else
        If InStr("0123456789 /-:" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub msk开始时间_Validate(Cancel As Boolean)
    If Not msk开始时间.Enabled Then Exit Sub
        
    If Not IsDate(msk开始时间.Text) Then
        If msk开始时间.Text <> Replace(msk开始时间.Mask, "#", "_") Then
            Cancel = True
            msk开始时间_GotFocus
            Exit Sub
        ElseIf vsAdvice.RowData(vsAdvice.Row) <> 0 Then
            If IsDate(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_开始时间)) Then
                '恢复人为的清除
                msk开始时间.Text = vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_开始时间)
            End If
        End If
    Else
        '检查时间合法性
        If Not Check开始时间(msk开始时间.Text) Then
            Cancel = True
            msk开始时间_GotFocus
            Exit Sub
        End If
    End If
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub cbo医生嘱托_Change()
    cbo医生嘱托.Tag = "1"
End Sub

Private Sub cbo医生嘱托_GotFocus()
    zlControl.TxtSelAll cbo医生嘱托
    Call zlCommFun.OpenIme(True)
End Sub

Private Sub cbo医生嘱托_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo医生嘱托.Text <> "" Then
            If ReasonSelect(cbo医生嘱托.Text, 2) Then Exit Sub
        End If
        If SeekNextControl Then Call cbo医生嘱托_Validate(False)
    End If
End Sub

Private Sub cbo医生嘱托_Validate(Cancel As Boolean)
    If zlCommFun.ActualLen(cbo医生嘱托.Text) > 100 Then
        MsgBox "输入内容不过超过 50 个汉字或 100 个字符。", vbInformation, gstrSysName
        cbo医生嘱托_GotFocus
        Cancel = True: Exit Sub
    End If
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub txt医嘱内容_DblClick()
    If cmdExt.Visible And cmdExt.Enabled Then cmdExt_Click
End Sub

Private Sub txt医嘱内容_GotFocus()
    If msk开始时间.Text = Replace(msk开始时间.Mask, "#", "_") Then msk开始时间_GotFocus
    Call zlControl.TxtSelAll(txt医嘱内容)
End Sub

Private Sub txt医嘱内容_KeyDown(KeyCode As Integer, Shift As Integer)
    Dim intTmp As Integer
    If Shift = vbCtrlMask And KeyCode = vbKeyA Then
        Call zlControl.TxtSelAll(txt医嘱内容)
    End If
    
    If KeyCode = vbKeySpace And txt医嘱内容.Text = "" And gblnOut必用 Then
        intTmp = ApplySelect
        If intTmp <> 0 Then Call AdviceInput申请单(intTmp)
    End If
End Sub

Private Sub txt医嘱内容_KeyPress(KeyAscii As Integer)
    Dim rsTmp As ADODB.Recordset
    Dim blnOK As Boolean
    Dim rsTmpOther As ADODB.Recordset
    Dim str输入 As String
    Dim blnBarcode As Boolean '是否置空卫材的 批次 字段
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt医嘱内容.Text = "" Then Exit Sub
        If txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容) Then
            Call SeekNextControl
            Exit Sub
        End If
        
        Set rsTmp = frmClinicSelect.ShowSelect(Me, IIF(mlng前提ID <> 0, 2, 0), 0, mlng病人科室id, 1, mstr性别, txt医嘱内容.Text, txt医嘱内容, 1, , mint险类, , , , , , , , , mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, , mlng医技科室ID)
        If rsTmp Is Nothing Then '取消或无数据
            '恢复原值
            'txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, COL_医嘱内容)
            zlControl.TxtSelAll txt医嘱内容
            txt医嘱内容.SetFocus: Exit Sub
        End If
        '新项目的录入
        '成套项目中如果包含成药,则不能按规格下医嘱
        
        If Val(rsTmp!类别ID & "") = 4 And rsTmp!批次 & "" <> "" Then
            str输入 = txt医嘱内容.Text
            '使用条码匹配的规则：1、全数字或者数字+字母；长度10位数以上；
            If (Not zlCommFun.IsCharChinese(str输入)) And Len(str输入) >= 10 Then
                If InStr("," & rsTmp!编码, "," & str输入) > 0 Then
                    '则匹配的是编码，置空批次
                    blnBarcode = True
                End If
            End If
            If IsNumeric(str输入) Then
                '1X.输入全是数字时只匹配编码
                If Mid(gstrMatchMode, 1, 1) = "1" Then
                    If Len(str输入) >= 10 Then
                        If InStr("," & rsTmp!编码, "," & str输入) > 0 Then
                            '则匹配的是编码，置空批次
                            blnBarcode = True
                        End If
                    End If
                End If
            ElseIf zlCommFun.IsCharAlpha(str输入) Then
                'X1.输入全是字母时只匹配简码
                If Mid(gstrMatchMode, 2, 1) = "1" Then
                    If Len(str输入) >= 10 Then
                        If InStr("," & rsTmp!简码, "," & str输入) > 0 Then
                            '则匹配的是编码，置空批次
                            blnBarcode = True
                        End If
                    End If
                End If
            End If
        End If
        
        '根据选择项目设置缺省医嘱信息
        Me.Refresh
        If blnBarcode Then
            Set rsTmpOther = zlDatabase.CopyNewRec(rsTmp)
            rsTmpOther!批次 = Null
            SetAdviceInput rsTmpOther
        Else
            SetAdviceInput rsTmp
        End If
    End If
End Sub

Private Sub AdviceCurRowClear()
'功能：清除当前医嘱行的内容，清除后可望而保留当前输入行的新输入状态
    Dim str开始时间 As String
    Dim lngPre As Long
    
    zlControl.FormLock Me.hwnd
    
    '记录之前基本的输入内容
    Call GetRowScope(vsAdvice.Row, lngPre, 0)
    str开始时间 = msk开始时间.Text
    
    '删除行
    Call AdviceDelete(vsAdvice.Row)
    
    '在原位置插入新行
    mblnRowChange = False
    vsAdvice.AddItem "", lngPre
    vsAdvice.Row = lngPre: vsAdvice.Col = col_医嘱内容
    mblnRowChange = True
    Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
    
    msk开始时间.Text = str开始时间
    If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
    
    zlControl.FormLock 0
End Sub

Private Sub cbo执行时间_GotFocus()
    zlControl.TxtSelAll cbo执行时间
    If vsAdvice.Row < 1 Then Exit Sub
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "周" Or vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "天" Or vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "小时" Then
        picHelp.Visible = True
    End If
End Sub

Private Sub txtBYZX_GotFocus()
    zlControl.TxtSelAll txtBYZX
End Sub

Private Sub txtBYZX_Change()
    Dim i As Long
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If RowIs输液注射(.Row, i) Then
                If Val(.TextMatrix(i, COL_总量)) <> Val(txtBYZX.Text) Then
                    txtBYZX.Tag = "1"
                End If
            Else
                txtBYZX.Tag = "1"
            End If
        Else
            txtBYZX.Tag = "1"
        End If
    End With
End Sub

Private Sub txtBYZX_KeyPress(KeyAscii As Integer)
    Dim strMask As String
    Dim blnCancel As Boolean
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call txtBYZX_Validate(blnCancel)
        If Not blnCancel Then mblnReturn = True: Call SeekNextControl
    Else
        strMask = "0123456789"
        If InStr(strMask & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txtBYZX_Validate(Cancel As Boolean)
    Dim strTmp As String
    Dim lngBg As Long, lngEd As Long
    If Val(txtBYZX.Text) = 0 Then
        txtBYZX.Text = ""
        Exit Sub
    End If
    If mblnReturn Then mblnReturn = False: Exit Sub
    If Not IsNumeric(txtBYZX.Text) Then
        If txtBYZX.Text <> "" Then
            Cancel = True: txtBYZX_GotFocus: Exit Sub
        End If
    ElseIf CDbl(txtBYZX.Text) <= 0 Then
        Cancel = True: txtBYZX_GotFocus: Exit Sub
    ElseIf CDbl(txtBYZX.Text) > LONG_MAX Then
        Cancel = True: txtBYZX_GotFocus: Exit Sub
    End If
    strTmp = lblBYZXCS.Caption
    If strTmp <> "" Then
        strTmp = Split(strTmp, "(")(1)
        lngBg = InStr(strTmp, "共")
        lngEd = InStr(strTmp, "次")
        strTmp = Mid(strTmp, lngBg + 1, lngEd - lngBg - 1)
        If Val(txtBYZX.Text) > Val(strTmp) Then
            MsgBox "超过最大执行次数" & strTmp & "次", vbInformation, gstrSysName
            Cancel = True: txtBYZX_GotFocus: Exit Sub
            txtBYZX.Text = strTmp
        End If
    End If
    Call AdviceChange
End Sub

Private Sub txt医嘱内容_Validate(Cancel As Boolean)
    '恢复人为的改变
    If txt医嘱内容.Text <> vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容) Then
        txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容)
    End If
End Sub

Private Sub txt总量_Change()
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If Val(.TextMatrix(.Row, COL_总量)) <> Val(txt总量.Text) Then
                txt总量.Tag = "1"
            End If
        Else
            txt总量.Tag = "1"
        End If
    End With
End Sub

Private Sub txt总量_GotFocus()
    zlControl.TxtSelAll txt总量
End Sub

Private Sub txt总量_KeyPress(KeyAscii As Integer)
    Dim strMask As String
    Dim blnCancel As Boolean
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If IsNumeric(txt总量.Text) Or (txt总量.Text = "" And vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "K") Then
            Call txt总量_Validate(blnCancel)
            If Not blnCancel Then mblnReturn = True: Call SeekNextControl
        End If
    Else
        If RowIn配方行(vsAdvice.Row) Then
            strMask = "0123456789" '中药配方只能输入整数
        ElseIf InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) > 0 Then
            If InStr(GetInsidePrivs(p门诊医嘱下达), "药品小数输入") > 0 _
                And Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_可否分零)) = 0 Then
                strMask = "0123456789."
            Else
                strMask = "0123456789"
            End If
        ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "4" And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_可否分零)) = 0 Then
            strMask = "0123456789"
        Else
            strMask = "0123456789."
        End If
        If InStr(strMask & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txt总量_LostFocus()
    mblnReturn = False
End Sub

Private Sub txt总量_Validate(Cancel As Boolean)
    Dim bln配方行 As Boolean
    Dim strMsg, strTmp As String
    Dim dbl总量 As Double, sng天数 As Single
    Dim blnOutTotal As Boolean '药品超量
    Dim blnTmp As Boolean
 
    With vsAdvice
        If Val(txt总量.Text) = 0 Then txt总量.Text = ""
        If mblnReturn Then mblnReturn = False: Exit Sub
        If Not IsNumeric(txt总量.Text) Then
            If txt总量.Text <> "" Then
                Cancel = True: txt总量_GotFocus: Exit Sub
            ElseIf .RowData(.Row) <> 0 Then
                '恢复人为的清除：输血临嘱允许不输入总量
                If .TextMatrix(.Row, COL_类别) <> "K" Then
                    If IsNumeric(.TextMatrix(.Row, COL_总量)) Then
                        txt总量.Text = .TextMatrix(.Row, COL_总量)
                    End If
                End If
            End If
        ElseIf CDbl(txt总量.Text) <= 0 Then
            Cancel = True: txt总量_GotFocus: Exit Sub
        ElseIf CDbl(txt总量.Text) > LONG_MAX Then
            Cancel = True: txt总量_GotFocus: Exit Sub
        Else
            txt总量.Text = FormatEx(txt总量.Text, 5)
        End If
        
        bln配方行 = RowIn配方行(.Row)
        If IsNumeric(txt总量.Text) Then
            If bln配方行 Then
                txt总量.Text = CInt(txt总量.Text)
            ElseIf InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                If InStr(GetInsidePrivs(p门诊医嘱下达), "药品小数输入") = 0 Then
                    txt总量.Text = IntEx(Val(txt总量.Text))
                ElseIf Val(.TextMatrix(.Row, COL_可否分零)) <> 0 Then
                    txt总量.Text = IntEx(Val(txt总量.Text))
                End If
            ElseIf Val(.TextMatrix(.Row, COL_计算方式)) = 3 Then
                '计次项目总量限制为整数。计次项目不输入单量,因此单量不管
                'txt总量.Text = IntEx(Val(txt总量.Text))
            End If
        End If
        
        '检查总量够否
        If InStr(",4,5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
            If .TextMatrix(.Row, COL_频率) <> "" And Val(.TextMatrix(.Row, COL_频率次数)) <> 0 And Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 _
                And Val(txt单量.Text) <> 0 And Val(.TextMatrix(.Row, COL_剂量系数)) <> 0 And Val(.TextMatrix(.Row, COL_门诊包装)) <> 0 Then
                
                sng天数 = Val(txt天数.Text)
                If sng天数 = 0 Then sng天数 = 1
                
                dbl总量 = FormatEx(Calc缺省药品总量( _
                    Val(txt单量.Text), sng天数, _
                    Val(.TextMatrix(.Row, COL_频率次数)), Val(.TextMatrix(.Row, COL_频率间隔)), _
                    .TextMatrix(.Row, COL_间隔单位), .TextMatrix(.Row, COL_执行时间), _
                    Val(.TextMatrix(.Row, COL_剂量系数)), Val(.TextMatrix(.Row, COL_门诊包装)), _
                    Val(.TextMatrix(.Row, COL_可否分零))), 5)
                    
                If Val(txt总量.Text) < dbl总量 Then
                    If MsgBox(.TextMatrix(.Row, COL_名称) & "按每次 " & _
                        txt单量.Text & .TextMatrix(.Row, COL_单量单位) & "," & _
                        .TextMatrix(.Row, COL_频率) & IIF(mbln天数 And .TextMatrix(.Row, COL_类别) <> "4", ",用药 " & sng天数 & " 天", "") & _
                        "执行时,至少需要 " & FormatEx(dbl总量, 5) & .TextMatrix(.Row, COL_总量单位) & ",要继续吗？", _
                        vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                        Cancel = True: txt总量_GotFocus: Exit Sub
                    End If
                End If
            End If
        End If
        
        '检查处方限量
        .TextMatrix(.Row, COL_是否超量) = ""
        If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 And Val(.TextMatrix(.Row, COL_处方限量)) <> 0 Then
           dbl总量 = Val(txt总量.Text) * Val(.TextMatrix(.Row, COL_门诊包装)) * Val(.TextMatrix(.Row, COL_剂量系数))
           If dbl总量 > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
               .TextMatrix(.Row, COL_是否超量) = "1"
           End If
    
        ElseIf bln配方行 Then
            txt总量.Tag = "1" '中药配方药品行被隐藏，通过调用AdviceChange间接设文本框可用性
            blnTmp = CheckCHLimited(.Row, Val(txt总量.Text), blnOutTotal, vsAdvice, COL_相关ID, COL_诊疗项目ID, COL_类别, COL_单量)
            If blnOutTotal Then .TextMatrix(.Row, COL_是否超量) = "1"
            
            '同时检查草药的用药是否超期
            If Val(txt总量.Text) > IIF(mbytPatiType = 1, conOrdinary, conEmergency) Then
                .TextMatrix(.Row, COL_是否超期) = "1"
            End If
            
        ElseIf InStr(",5,6,7,", .TextMatrix(.Row, COL_类别)) = 0 And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
            If Val(txt总量.Text) > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
                .TextMatrix(.Row, COL_是否超量) = "1"
            End If
        End If
                
        '最大金额提示
        If gcurMaxMoney > 0 Then
            If .TextMatrix(.Row, COL_单价) = "" Then .TextMatrix(.Row, COL_单价) = GetItemPrice(.Row) '用""不是零
            If Val(.TextMatrix(.Row, COL_单价)) * Val(txt总量.Text) > gcurMaxMoney Then
                If MsgBox("当前医嘱 " & txt总量.Text & lbl总量单位.Caption & " 的金额达到了：" & Format(Val(.TextMatrix(.Row, COL_单价)) * Val(txt总量.Text), "0.00") & "，要继续吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                    Cancel = True: txt总量_GotFocus: Exit Sub
                End If
            End If
        End If
        
        '医保管控实时监测：首次输入(经过)或者更改时检查
        If mint险类 <> 0 And (.Cell(flexcpData, .Row, COL_状态) = 0 Or txt总量.Tag <> "") Then
            If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) Then
                If MakePriceRecord(.Row) Then
                    If Not gclsInsure.CheckItem(mint险类, 0, 0, mrsPrice) Then
                        Cancel = True: txt总量_GotFocus: Exit Sub
                    End If
                End If
                '标记为已经作了检查
                .Cell(flexcpData, .Row, COL_状态) = 1
            End If
        End If
        
        '反算天数（没有输入天数才反算，中药不会显示天数）
        If mbln天数反算 And txt总量.Tag <> "" Then
            If .TextMatrix(.Row, COL_频率) <> "" And Val(.TextMatrix(.Row, COL_频率次数)) <> 0 And Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 _
                And Val(txt单量.Text) <> 0 And Val(.TextMatrix(.Row, COL_频率次数)) <> 0 And Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 _
                And Val(.TextMatrix(.Row, COL_剂量系数)) <> 0 And Val(.TextMatrix(.Row, COL_门诊包装)) <> 0 Then
                
                sng天数 = Calc缺省药品天数(Val(txt总量.Text), Val(txt单量.Text), _
                    Val(.TextMatrix(.Row, COL_频率次数)), Val(.TextMatrix(.Row, COL_频率间隔)), .TextMatrix(.Row, COL_间隔单位), _
                    Val(.TextMatrix(.Row, COL_剂量系数)), Val(.TextMatrix(.Row, COL_门诊包装)), _
                    Val(.TextMatrix(.Row, COL_可否分零)))
                
                Call CheckDrugOutOfRange(.Row, sng天数)
                If sng天数 = 0 Then sng天数 = 1
                msngPre天数 = sng天数
                If sng天数 <> Val(txt天数.Text) Then
                    txt天数.Text = sng天数
                    txt天数.Tag = "1"
                    msng天数 = sng天数
                End If
            End If
        End If
        
        '更新数据
        Call AdviceChange
        Call CalcAdviceMoney '显示新开医嘱金额
        
        '药品库存检查:只提醒,修改了才提醒
        If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Or bln配方行 _
            Or .TextMatrix(.Row, COL_类别) = "4" And Val(.TextMatrix(.Row, COL_跟踪在用)) = 1 Then
            strMsg = ""
            If Not bln配方行 And mdblPre总量 <> Val(txt总量.Text) Then
                strMsg = CheckStock(.Row)
            End If
            
            If strMsg <> "" Then MsgBox strMsg, vbInformation, gstrSysName
        End If
        
        mdblPre总量 = Val(txt总量.Text)
    End With
End Sub
 
Private Sub ClearAdviceCard()
'功能：清除医嘱显示卡片相关的内容
'参数：bln开始时间=是否清除开始时间
    Call SetCardEditable(True)
    
    msk开始时间.Text = Replace(msk开始时间.Mask, "#", "_")
    txt安排时间.Text = ""
    txt医嘱内容.Text = ""
    cbo医生嘱托.Text = ""
    cbo执行科室.Clear
    cbo附加执行.Clear
    chk紧急.value = 0
    chk紧急.Visible = False '输医嘱内容后才可用
    cbo滴速.Text = ""
    txt超量说明.Text = ""
    txt用药理由.Text = ""
    txtBYZX.Text = ""
    
    mblnDoCheck = False
    chk紧急.value = 0
    chkZeroBilling.value = 0
    mblnDoCheck = True
    
    cmdExt.Enabled = False
    Call SetDayState(-1, -1)
    Call SetItemEditable(-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1)
    Call SetStartTime(True)
    
    stbThis.Panels(3).Text = ""
    stbThis.Panels(4).Text = ""
End Sub

Private Sub SetCardEditable(ByVal Editable As Boolean)
'功能：用颜色标识当前医嘱是否可以编辑
    Dim obj As Object
    
    For Each obj In Controls
        If InStr("Label;TextBox;ComboBox;CheckBox;OptionButton;MaskEdBox", TypeName(obj)) > 0 Then
            If Not obj.Container Is Nothing Then
                If obj.Container Is fraAdvice Then
                    If Editable Then
                        obj.ForeColor = Me.ForeColor
                    Else
                        obj.ForeColor = &H808080
                    End If
                End If
            End If
        End If
    Next
    
    fraAdvice.Enabled = Editable
    cmdSel.Enabled = fraAdvice.Enabled
    cmd常用嘱托.Enabled = fraAdvice.Enabled
    cmd医生嘱托.Enabled = fraAdvice.Enabled
    
    '临床路径生成时，如果定义的为药品品种，且长嘱是按规格下达，则允许通过该按钮选择其他规格
    If Editable And mbytUseType = 1 Then
        With vsAdvice
            If .RowData(.Row) <> 0 Then
                If InStr("4,5,6", .TextMatrix(.Row, COL_类别)) > 0 And Val("" & .Cell(flexcpData, .Row, COL_收费细目ID)) = 0 Then
                    cmdSel.Enabled = True
                Else
                    cmdSel.Enabled = False
                End If
            End If
        End With
    End If
End Sub

Private Function Get频率范围(ByVal lngRow As Long) As Integer
    Dim lngFind As Long
    
    With vsAdvice
        If RowIn配方行(lngRow) Then
            Get频率范围 = 2 '中医
        Else
            If RowIn检验行(lngRow) Then '以检验项目行为准
                lngFind = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
                If lngFind <> -1 Then lngRow = lngFind
            End If
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Or Val(.TextMatrix(lngRow, COL_频率性质)) = 0 Then
                Get频率范围 = 1 '成药或可选频率的项目使用西医频率项目
            ElseIf Val(.TextMatrix(lngRow, COL_频率性质)) = 1 Then
                Get频率范围 = -1 '一次性
            ElseIf Val(.TextMatrix(lngRow, COL_频率性质)) = 2 Then
                Get频率范围 = -2 '持续性
            End If
        End If
    End With
End Function

Private Function SeekVisibleRow() As Boolean
'功能：当前行为隐藏行时，定位到它所属的可见行
    Dim lngRow As Long
    
    With vsAdvice
        If Not .RowHidden(.Row) Then Exit Function
        If InStr(",F,G,C,D,E,", .TextMatrix(.Row, COL_类别)) > 0 And Val(.TextMatrix(.Row, COL_相关ID)) <> 0 Then
            lngRow = .FindRow(CLng(Val(.TextMatrix(.Row, COL_相关ID))))
        ElseIf .TextMatrix(.Row, COL_类别) = "7" Then
            lngRow = .FindRow(CLng(Val(.TextMatrix(.Row, COL_相关ID))))
        ElseIf .TextMatrix(.Row, COL_类别) = "E" And Val(.TextMatrix(.Row, COL_相关ID)) = 0 Then
            lngRow = .Row - 1
        End If
        If lngRow <> -1 Then
            If .RowData(lngRow) <> 0 Then
                .Row = lngRow: SeekVisibleRow = True
            End If
        End If
    End With
End Function

Private Sub vsAdvice_AfterEdit(ByVal Row As Long, ByVal Col As Long)
    Dim lngBegin As Long, lngEnd As Long
    Dim i As Long
    
    If mbytUseType = 1 And Col = COL_选择 Then
        Call GetRowScope(Row, lngBegin, lngEnd)
        '一组医嘱一起选择
        For i = lngBegin To lngEnd
            vsAdvice.Cell(flexcpChecked, i, COL_选择) = vsAdvice.Cell(flexcpChecked, Row, COL_选择)
        Next
    End If
End Sub

Private Sub vsAdvice_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
'功能：当行改变时，更新卡片内容
    Dim rsItem As New ADODB.Recordset
    Dim rsBlood As New ADODB.Recordset
    Dim strSQL As String, lngRow As Long
    Dim lng用法ID As Long, blnEditable As Boolean
    Dim lng药品ID As Long, lngBaseRow As Long '中药配方的第一味组成药行
    Dim dblPrice As Double, strTmp As String, i As Long
    Dim bln显示单量 As Boolean, bln显示抗菌药物 As Boolean
    Dim blnEditableTmp As Boolean
    Dim bln用血 As Boolean
    
    If vsAdvice.Col >= vsAdvice.FixedCols Then
        vsAdvice.ForeColorSel = vsAdvice.Cell(flexcpForeColor, NewRow, COL_开始时间)
    End If
    
    If NewRow = OldRow Then Exit Sub
    If Not mblnRowChange Then Exit Sub
    If SeekVisibleRow Then Exit Sub
    
     'PASS
    If mblnPass And Me.Visible Then
        If NewRow <> OldRow Then
            Call gobjPass.zlPassSetDrug(mobjPassMap)
        End If
    End If
    
    lngRow = NewRow
    
    Call ShowDiagFlag(lngRow)
    
     '当前行是空行时，如果前一行是一并给药行，则缺省按下“一并”按钮
    If vsAdvice.RowData(lngRow) = 0 Then
        i = GetPreRow(lngRow)
        If i = -1 Then
            mblnRowMerge = False
        Else
            mblnRowMerge = RowIn一并给药(i)
        End If
    Else
        mblnRowMerge = RowIn一并给药(lngRow)
    End If
    cbsMain.RecalcLayout '即时刷新
        
    '显示或隐藏审核疑问说明
    Call ShowOrHideQuestion
    '恢复因临床路径禁用的控件
    If mbytUseType = 0 Then
        txt医嘱内容.Enabled = True
        cmdSel.Enabled = True
        cmdExt.Enabled = True
                cmdZYRemark.Visible = False
    End If
    Me.Refresh
    zlControl.FormLock Me.hwnd
    
    chk免试.Visible = False
        
    On Error GoTo errH
    
    With vsAdvice
    
        If Val(.RowData(lngRow)) = 0 Then
            '无效行清除卡片内容
            Call ClearAdviceCard
            '缺省开始时间
            Call msk开始时间_GotFocus
        Else
            '卡片编辑
            blnEditable = True
            '已发送的医嘱不能修改
            If Val(.TextMatrix(lngRow, COL_状态)) <> 1 Then blnEditable = False
            '已签名的医嘱不可修改
            If Val(.TextMatrix(lngRow, COL_签名否)) = 1 Then blnEditable = False
            
            If .TextMatrix(lngRow, COL_类别) = "K" And gbln血库系统 Then
                '血库环节
                If Not (Val(.TextMatrix(lngRow, COL_检查方法)) = 1 And Val(.TextMatrix(lngRow, COL_审核状态)) = 2) Then
                    '旧程 5－血库配血中
                    If Val(.TextMatrix(lngRow, COL_审核状态)) = 5 Or Val(.TextMatrix(lngRow, COL_审核状态)) = 2 Then blnEditable = False
                End If
            Else
                '审核通过的不允许修改
                If Val(.TextMatrix(lngRow, COL_审核状态)) = 2 Then blnEditable = False
            End If
            
            '是输血医嘱时，新开后直接进入4这个状态，这时候是允许编辑的，否则禁止
            If Val(.TextMatrix(lngRow, COL_审核状态)) = 4 And .TextMatrix(lngRow, COL_类别) = "K" Then
                If CanEditBloodAdvice(Val(.RowData(lngRow)), Val(.TextMatrix(lngRow, COL_审核状态)), Val(.TextMatrix(lngRow, COL_标志)) = 1, Val(.TextMatrix(lngRow, COL_检查方法)) = 1, False) = False Then blnEditable = False
            End If
            
            '显示或隐藏免试标记
            If Val(.TextMatrix(lngRow, COL_操作类型)) = 1 And .TextMatrix(lngRow, COL_类别) = "E" Then chk免试.Visible = True
            mblnDoCheck = False
            chk免试.value = Val(.TextMatrix(lngRow, COL_免试))
            mblnDoCheck = True
            Call SetCardEditable(blnEditable)
            
            '获取诊疗项目基本信息
            '---------------------
            If InStr(",4,5,6,7,", Val(.TextMatrix(lngRow, COL_类别))) > 0 Then
                lng药品ID = Val(.TextMatrix(lngRow, COL_收费细目ID))
            End If
            
            If RowIn配方行(lngRow) Then
                txt总量.MaxLength = 3
                '获取中药配方第一味中药行
                lngBaseRow = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
                lng药品ID = Val(.TextMatrix(lngBaseRow, COL_收费细目ID))
            ElseIf RowIn检验行(lngRow) Then
                '获取一并采样的第一个项目行
                lngBaseRow = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
                txt总量.MaxLength = txt单量.MaxLength
            Else
                lngBaseRow = lngRow
                txt总量.MaxLength = txt单量.MaxLength
            End If
            
            Set rsItem = Get诊疗项目记录(Val(.TextMatrix(lngBaseRow, COL_诊疗项目ID)))
  
            '扩展按钮可用状态(检查组合,检验组合,手术,中药配方)
            cmdExt.Enabled = InStr(",7,C,F,D,", rsItem!类别) > 0
            If rsItem!类别 = "E" Or rsItem!类别 = "K" Or rsItem!类别 = "Z" Then
                If rsItem!类别 = "K" And Val(.TextMatrix(lngRow, COL_申请序号) & "") <> 0 Then
                    cmdExt.Enabled = True
                Else
                    cmdExt.Enabled = CheckApplication(Val(.TextMatrix(lngBaseRow, COL_诊疗项目ID)), 1)
                End If
            End If
            
            '临床路径禁止修改的内容
            If mbytUseType = 0 And Val(.TextMatrix(lngRow, COL_路径执行ID)) <> 0 Then
                '已保存的项目，不允许再改扩展项
                If cmdExt.Enabled Then cmdExt.Enabled = False
                '临床路径的项目，禁止改变医嘱内容
                If blnEditable Then
                    txt医嘱内容.Enabled = False
                    cmdSel.Enabled = False
                End If
            End If
            
            '显示当前医嘱卡片内容
            '--------------------------------------------------------------------------------------------
            '开始时间：只有新增医嘱时可以修改开始时间
            msk开始时间.Text = .Cell(flexcpData, lngRow, COL_开始时间)
            Call SetStartTime(Val(.TextMatrix(lngRow, COL_状态)) < 3)
            
            '医嘱内容
            txt医嘱内容.Text = .TextMatrix(lngRow, col_医嘱内容)
            
            '超量说明
            txt超量说明.Text = .TextMatrix(lngRow, COL_超量说明)
            SetItemEditable , , , , , , , , , , , , IIF(.TextMatrix(lngRow, COL_是否超量) = "1" Or .TextMatrix(lngRow, COL_是否超期) = "1", 1, -1)
            
            If txt超量说明.Text <> "" Then
                cmdExcReason.Enabled = blnEditable
                cmdComExcReason.Enabled = blnEditable
            End If
                        
            '单量：临嘱,成药或可选择频率的计时,计量项目可以录入
            '----------------------
            If rsItem!类别 = "7" Then '中药配方(中草药)虽然有单量,但不在这里填写
                SetItemEditable -1
            ElseIf (NVL(rsItem!执行频率, 0) = 0 And InStr(",1,2,", NVL(rsItem!计算方式, 0)) > 0) _
                    Or InStr(",5,6,", rsItem!类别) > 0 Then
                SetItemEditable 1
                bln显示单量 = True
                txt单量.Text = .TextMatrix(lngRow, COL_单量)
                lbl单量单位.Caption = .TextMatrix(lngRow, COL_单量单位)
            Else
                SetItemEditable -1
            End If
            
            '天数：西药，中成药临嘱才使用，用于计算总量
            '一般：临嘱的药品(非中药)或可选择频率的计时,计量项目可以使用天数来自动计算总量
            blnEditableTmp = False
            If InStr(",5,6,", rsItem!类别) > 0 Then
                If mbln天数 Then blnEditableTmp = True
            End If
            If blnEditableTmp Then
                SetDayState 1, 1
            Else
                SetDayState -1, -1
            End If
            txt天数.Text = Val(.TextMatrix(lngRow, COL_天数))
            If Val(txt天数.Text) = 0 Then txt天数.Text = ""
            
            '总量
            '--------------------
            If rsItem!类别 = "7" Then
                '中药配方(中草药)填写为付数
                SetItemEditable , 1
                lbl总量单位.Caption = "付"
                txt总量.Text = .TextMatrix(lngRow, COL_总量) '付数
                If Val(txt总量.Text) > IIF(mbytPatiType = 1, conOrdinary, conEmergency) Then
                    SetItemEditable , , , , , , , , , , , , 1
                End If
                bln显示单量 = True
                
            Else
                '临嘱都需要填写总量:临嘱发送以总量为准
                If rsItem!类别 = "Z" And NVL(rsItem!操作类型) <> "0" Then
                    SetItemEditable , -1 '特殊医嘱不允许修改总量(固定为1次)
                ElseIf NVL(rsItem!执行频率, 0) = 1 And NVL(rsItem!计算方式, 0) = 3 Then
                    SetItemEditable , -1 '一次性计次项目不输入总量
                Else
                    SetItemEditable , 1
                    bln显示单量 = True
                End If
                lbl总量单位.Caption = .TextMatrix(lngRow, COL_总量单位)
                txt总量.Text = .TextMatrix(lngRow, COL_总量)
            End If
            
            '给药途径和中药用法
            '--------------
            If InStr(",5,6,", rsItem!类别) > 0 Then
                SetItemEditable , , 1
                lbl用法.Caption = "给药途径"
                '查找给药途径对应的行:查找的Rowdata(Variant)数据要转为Long型,才能精确匹配
                i = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                lng用法ID = Val(.TextMatrix(i, COL_诊疗项目ID))
                cmd用法.Tag = lng用法ID
                If lng用法ID <> 0 Then
                    txt用法.Text = Sys.RowValue("诊疗项目目录", lng用法ID, "名称")
                End If
                If .TextMatrix(i, COL_操作类型) = "2" And (.TextMatrix(i, COL_执行分类) = "1" Or .TextMatrix(i, COL_执行分类) = "2") Then
                    txtBYZX.Text = IIF(Val(.TextMatrix(i, COL_总量)) = 0, "", Val(.TextMatrix(i, COL_总量)))
                    Call Make本院执行次数(i)
                    SetItemEditable , , , , , , , , , , , , , , 1
                Else
                    .TextMatrix(i, COL_总量) = ""
                    SetItemEditable , , , , , , , , , , , , , , -1
                End If
            ElseIf rsItem!类别 = "K" Then
                '输血医嘱：要兼容以前没有输血途径的情况
                lng用法ID = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_相关ID)
                If lng用法ID <> -1 Then
                    SetItemEditable , , 1, , , , , , , , , , , , -1
                    If Val(.TextMatrix(lngRow, COL_检查方法)) = 0 And gbln血库系统 = True Then
                        lbl用法.Caption = "采集方法"
                    Else
                        lbl用法.Caption = "输血途径"
                    End If
                    lng用法ID = Val(.TextMatrix(lng用法ID, COL_诊疗项目ID))
                    cmd用法.Tag = lng用法ID
                    txt用法.Text = Sys.RowValue("诊疗项目目录", lng用法ID, "名称")
                Else
                    SetItemEditable , , -1, , , , , , , , , , , , -1
                End If
            ElseIf rsItem!类别 = "7" Then
                SetItemEditable , , 1, , , , , , , , , , , , -1
                
                lbl用法.Caption = "中药用法"
                
                '中药配方显示行就是中药用法行
                lng用法ID = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
                cmd用法.Tag = lng用法ID
                txt用法.Text = Sys.RowValue("诊疗项目目录", lng用法ID, "名称")
            ElseIf RowIn检验行(lngRow) Then '不用类别判断,兼容以前的检验
                '检验组合
                SetItemEditable , , 1, , , , , , , , , , , , -1
                lbl用法.Caption = "采集方法"
                
                '检验组合显示行就是采集方法行
                lng用法ID = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
                cmd用法.Tag = lng用法ID
                txt用法.Text = Sys.RowValue("诊疗项目目录", lng用法ID, "名称")
            Else
                SetItemEditable , , -1, , , , , , , , , , , , -1
            End If
            
            '手术时间/输血时间：只有手术/输血可用(隐藏在用法位置)
            If rsItem!类别 = "F" Or rsItem!类别 = "K" Then
                SetItemEditable , , , , , , , , 1
                If IsDate(.TextMatrix(lngRow, COL_手术时间)) Then
                    txt安排时间.Text = .TextMatrix(lngRow, COL_手术时间)
                Else
                    txt安排时间.Text = .Cell(flexcpData, lngRow, COL_开始时间)
                End If
                Call Set安排时间(rsItem!类别)
            Else
                SetItemEditable , , , , , , , , -1
            End If
            
            '频率(临嘱输入用于指导使用)
            If InStr("F,G,H,I", rsItem!类别) > 0 Or rsItem!类别 = "Z" And InStr(",1,2,3,4,5,6,7,8,9,10,11,12,14,", "," & rsItem!操作类型 & ",") > 0 Then
                SetItemEditable , , , -1
            Else
                SetItemEditable , , , 1
            End If
            cmd频率.Tag = .TextMatrix(lngRow, COL_频率)
            txt频率.Text = .TextMatrix(lngRow, COL_频率)
                    
            '执行时间："可选频率"或药品。
            If (NVL(rsItem!执行频率, 0) = 0 Or InStr(",5,6,7,", rsItem!类别) > 0) And .TextMatrix(lngRow, COL_间隔单位) <> "分钟" Then
                SetItemEditable , , , , 1
                Call Get时间方案(cbo执行时间, Get频率范围(lngRow), .TextMatrix(lngRow, COL_频率), lng用法ID)
                cbo执行时间.Text = .TextMatrix(lngRow, COL_执行时间)
            Else
                SetItemEditable , , , , -1
            End If
                    
            '滴速：输液类给药途径的药品可以输入
            lbl滴速.Caption = "↓滴速"
            lbl滴速.Left = chk免试.Left + chk免试.Width + 5 * 180 '先设置滴速的初始位置
            bln用血 = .TextMatrix(lngRow, COL_类别) = "K" And Val(.TextMatrix(lngRow, COL_检查方法)) = 1 And gbln血库系统 = True
            If InStr(",5,6,", rsItem!类别) > 0 Or bln用血 Then
                If bln用血 = True Then
                    i = .FindRow(CLng(.RowData(lngRow)), , COL_相关ID)
                Else
                    i = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                End If
                If Val(.TextMatrix(i, COL_执行分类)) = 1 Then
                    SetItemEditable , , , , , , , , , 1
                    If bln用血 = False Then
                        If InStr(.TextMatrix(i, COL_医生嘱托), "滴/分钟") > 0 Then
                            lbl滴速单位.Caption = "滴/分钟"
                        ElseIf InStr(.TextMatrix(i, COL_医生嘱托), "毫升/小时") > 0 Then
                            lbl滴速单位.Caption = "毫升/小时"
                        End If
                    Else
                        If InStr(.TextMatrix(i, COL_医生嘱托), "滴/分") > 0 Or IsNumeric(.TextMatrix(i, COL_医生嘱托)) Or .TextMatrix(i, COL_医生嘱托) = "" Then
                            lbl滴速单位.Caption = "滴/分钟"
                        Else
                            lbl滴速单位.Caption = ""
                        End If
                    End If
                    Call Load输液滴速(cbo滴速, lbl滴速单位, False, bln用血)
                    cbo滴速.Text = Replace(.TextMatrix(i, COL_医生嘱托), lbl滴速单位.Caption, "")
                Else
                    SetItemEditable , , , , , , , , , -1
                End If
                '设置位置
                If bln用血 = True Then
                    lbl滴速.Caption = "滴速"
                    lbl滴速.Left = txt安排时间.Left + txt安排时间.Width + 180
                End If
            Else
                SetItemEditable , , , , , , , , , -1
            End If
            If bln用血 = True And lbl滴速.Caption = "滴速" Then
                Call zlControl.SetPubCtrlPos(False, 0, lbl滴速, 30, cbo滴速, 30, lbl滴速单位, IIF(lbl滴速单位.Caption <> "", 0, Me.TextWidth("滴/分钟")) + 180, chkZeroBilling)
            Else
                Call zlControl.SetPubCtrlPos(False, 0, lbl滴速, 30, cbo滴速, 30, lbl滴速单位, 180, chkZeroBilling)
            End If
            
            '用药目的和用药理由
            If Val(.TextMatrix(lngRow, COL_抗菌等级)) = 0 Then
                SetItemEditable , , , , , , , , , , -1, -1
            Else
                SetItemEditable , , , , , , , , , , 1, 1
                bln显示抗菌药物 = True
                
                If .TextMatrix(lngRow, COL_用药目的) = "1" Then
                    Call Cbo.SetIndex(cboDruPur.hwnd, 1)
                ElseIf .TextMatrix(lngRow, COL_用药目的) = "2" Then
                    Call Cbo.SetIndex(cboDruPur.hwnd, 2)
                End If
                
                txt用药理由.Text = .TextMatrix(lngRow, COL_用药理由)
            End If
            cboDruPur.Enabled = blnEditable
            cmdReason.Enabled = blnEditable
            cmd收藏用药理由.Enabled = blnEditable
            
            '输血医嘱显示用药目的，将用药目的显示为输血原因
            If (gbln输血分级管理 Or gbln血库系统) And .TextMatrix(lngRow, COL_类别) = "K" Then
                bln显示抗菌药物 = True
                SetItemEditable , , , , , , , , , , , , , 1
                txt用药理由.Width = cmdExcReason.Left + cmdExcReason.Width - txt用药理由.Left
                If .TextMatrix(lngRow, COL_标志) = "1" Then
                    SetItemEditable , , , , , , , , , , , 1
                    txt用药理由.Text = .TextMatrix(lngRow, COL_用药理由)
                Else
                    SetItemEditable , , , , , , , , , , , -1
                End If
            Else
                SetItemEditable , , , , , , , , , , , , , -1
                txt用药理由.Width = cmdExcReason.Left + cmdExcReason.Width - txt用药理由.Left
                cmd收藏用药理由.Left = txt用药理由.Left + txt用药理由.Width + 30
                cmdReason.Left = txt用药理由.Left + txt用药理由.Width - cmdReason.Width
            End If
            
            '医生嘱托
            cbo医生嘱托.Text = .TextMatrix(lngRow, COL_医生嘱托)
                    
            '执行性质
            If InStr(",5,6,7,", rsItem!类别) > 0 Then
                '如果是自管药则固定选择自备药
                If Val(.TextMatrix(lngRow, COL_临床自管药)) = 1 And InStr(",5,6,", rsItem!类别) > 0 Then
                    strTmp = "自备药"
                Else
                    If rsItem!类别 = "7" Then
                        '对于中药配方,根据诊疗项目管理中限制及本程序处理,不可能用法和煎法一个为院外执行,一个不为
                        If Val(.TextMatrix(lngBaseRow, COL_执行性质)) = 5 And Val(.TextMatrix(lngRow, COL_执行性质)) <> 5 Then
                            strTmp = "自备药"
                        ElseIf Val(.TextMatrix(lngBaseRow, COL_执行性质)) <> 5 And Val(.TextMatrix(lngRow, COL_执行性质)) = 5 Then
                            strTmp = "离院带药"
                        Else
                            strTmp = "正常"
                        End If
                    Else
                        i = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                        If Val(.TextMatrix(lngRow, COL_执行性质)) = 5 And Val(.TextMatrix(i, COL_执行性质)) <> 5 Then
                            strTmp = "自备药"
                        ElseIf Val(.TextMatrix(lngRow, COL_执行性质)) <> 5 And Val(.TextMatrix(i, COL_执行性质)) = 5 Then
                            strTmp = "离院带药"
                        Else
                            strTmp = "正常"
                        End If
                    End If
                End If
                Call SetCbo执行性质(gbln抗菌药物使用自备药 Or Not gblnKSSStrict Or Val(.TextMatrix(lngRow, COL_抗菌等级)) = 0, Val(.TextMatrix(lngRow, COL_临床自管药)) = 1 And rsItem!类别 & "" <> "7")
                SetItemEditable , , , , , , 1
                Call Cbo.SetIndex(cbo执行性质.hwnd, Cbo.FindIndex(cbo执行性质, strTmp, True))
            Else
                SetItemEditable , , , , , , -1
            End If
            
            lbl执行科室.Caption = "执行科室"
            '执行科室:留观或住院医嘱用临床科室
            If rsItem!类别 = "Z" And InStr(",1,2,", NVL(rsItem!操作类型, 0)) > 0 Then
                SetItemEditable , , , , , 1
                If NVL(rsItem!操作类型, 0) = 1 Then
                    lbl执行科室.Caption = "留观科室"
                    '留观:包含门诊或住院临床科室,由服务对象决定是门诊留观或住院留观
                    Call Get临床科室(3, , Val(.TextMatrix(lngRow, COL_执行科室ID)), cbo执行科室, True, False, True)
                ElseIf NVL(rsItem!操作类型, 0) = 2 Then
                    lbl执行科室.Caption = "住院科室"
                    '住院:包含住院临床科室
                    Call Get临床科室(2, , Val(.TextMatrix(lngRow, COL_执行科室ID)), cbo执行科室, True, False, True, 1)
                End If
                If Val(.TextMatrix(lngRow, COL_执行科室ID)) <> 0 And cbo执行科室.ListIndex = -1 Then .TextMatrix(lngRow, COL_执行科室ID) = 0
            Else
                '是药品则以药品行为准显示,检验组合以检验项目为准显示
                i = lngRow
                If rsItem!类别 = "7" Then
                    i = lngBaseRow
                ElseIf RowIn检验行(lngRow) Then '不用类别判断,兼容以前的检验
                    i = lngBaseRow
                End If
                
                If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                    '非叮嘱和院外执行时才显示和可以选择(包括药品)
                    SetItemEditable , , , , , 1
                    Call Get诊疗执行科室(mlng病人ID, 0, cbo执行科室, rsItem!类别, rsItem!ID, lng药品ID, NVL(rsItem!执行科室, 0), _
                        mlng病人科室id, Val(.TextMatrix(i, COL_开嘱科室ID)), Val(.TextMatrix(i, COL_执行科室ID)), 1, 1, , blnEditable)
                     
                    '非散装形态，只允许在配方界面选药房
                    If rsItem!类别 = "7" Then
                        If Val(.TextMatrix(lngRow, COL_中药形态)) <> 0 Then
                            cbo执行科室.Enabled = False
                            cbo执行科室.BackColor = Me.BackColor
                        End If
                    End If
                ElseIf InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) > 0 Then
                    SetItemEditable , , , , , -1
                    If Val(.TextMatrix(i, COL_执行性质)) = 0 Then
                        cbo执行科室.AddItem "<无执行叮嘱>"
                    Else
                        cbo执行科室.AddItem "-"
                    End If
                    Call Cbo.SetIndex(cbo执行科室.hwnd, 0)
                End If
                If Val(.TextMatrix(i, COL_执行科室ID)) <> 0 And cbo执行科室.ListIndex = -1 Then .TextMatrix(i, COL_执行科室ID) = 0
                If InStr("5,6,7", rsItem!类别) > 0 Then lbl执行科室.Caption = "发药药房"
            End If

            If cbo执行科室.ListIndex = -1 And cbo执行科室.ListCount = 1 Then
                If Val(.TextMatrix(i, COL_状态)) < 3 Then
                    cbo执行科室.ListIndex = 0
                Else
                    Call zlControl.CboSetIndex(cbo执行科室.hwnd, 0)
                End If
            End If
            
            If cbo执行科室.ListCount = 1 Then
                If cbo执行科室.List(cbo执行科室.ListIndex) <> "[其它...]" Then
                    cbo执行科室.Enabled = False
                Else
                    cbo执行科室.Enabled = True
                End If
            Else
                cbo执行科室.Enabled = True
            End If
            
            '附加执行:指给药途径,中药用法,手术麻醉,采集方式的执行科室，原液皮试项目
            If Should附加执行(lngRow, i, strTmp) Then
                If .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5" Then
                    '对于原液皮试加载药房
                    lng药品ID = Get原液皮试药品(Val(.TextMatrix(i, COL_诊疗项目ID)))
                    If lng药品ID <> 0 Then
                        SetItemEditable , , , , , , , 1
                        Call Get诊疗执行科室(mlng病人ID, 0, cbo附加执行, "5", 0, lng药品ID, 0, mlng病人科室id, 0, Val(.TextMatrix(i, COL_用药理由)), 1, 1, , blnEditable)
                        '如果没有选药房则不加载任何默认值
                        If Val(.TextMatrix(i, COL_用药理由)) = 0 Then cbo附加执行.ListIndex = -1
                    Else
                        cbo附加执行.Clear
                        SetItemEditable , , , , , , , -1
                    End If
                Else
                    SetItemEditable , , , , , , , 1
                    Call Get诊疗执行科室(mlng病人ID, 0, cbo附加执行, .TextMatrix(i, COL_类别), Val(.TextMatrix(i, COL_诊疗项目ID)), lng药品ID, _
                        Val(.TextMatrix(i, COL_执行性质)), mlng病人科室id, Val(.TextMatrix(i, COL_开嘱科室ID)), Val(.TextMatrix(i, COL_执行科室ID)), 1, 1, , blnEditable)
                        
                    If Val(.TextMatrix(i, COL_执行科室ID)) <> 0 And cbo附加执行.ListIndex = -1 Then .TextMatrix(i, COL_执行科室ID) = 0
                    If cbo附加执行.ListIndex = -1 And cbo附加执行.ListCount = 1 Then cbo附加执行.ListIndex = 0
                End If
            Else
                SetItemEditable , , , , , , , -1
                If i <> -1 Then
                    If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) > 0 Then
                        If Val(.TextMatrix(i, COL_执行性质)) = 0 Then
                            cbo附加执行.AddItem "<无执行叮嘱>"
                        ElseIf Val(.TextMatrix(i, COL_执行性质)) = 5 Then
                            cbo附加执行.AddItem "-"
                        End If
                        Call Cbo.SetIndex(cbo附加执行.hwnd, 0)
                    End If
                End If
            End If
            lbl附加执行.Caption = strTmp
            
            '紧急标志
            chk紧急.Visible = True
            mblnDoCheck = False
            chk紧急.value = Val(.TextMatrix(lngRow, COL_标志))
            chkZeroBilling.value = Val(.TextMatrix(lngRow, COL_零费记帐))
            mblnDoCheck = True
                        
            
            '显示药品库存：以门诊单位，中药配方不显示
            '----------------------------------------
            If Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 _
                And (InStr(",5,6,", rsItem!类别) > 0 Or rsItem!类别 = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 1) Then
                If .TextMatrix(lngRow, COL_库存) = "" And Val(.TextMatrix(lngRow, COL_执行科室ID)) <> 0 Then Call GetDrugStock(lngRow)
                If .TextMatrix(lngRow, COL_库存) <> "" And Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then .TextMatrix(lngRow, COL_库存) = ""
                If .TextMatrix(lngRow, COL_库存) <> "" Then
                    If InStr(GetInsidePrivs(p门诊医嘱下达), "显示药品库存") = 0 Then
                        stbThis.Panels(3).Text = IIF(Val(.TextMatrix(lngRow, COL_库存)) > 0, "有库存", "无库存")
                    Else
                        stbThis.Panels(3).Text = "库存:" & FormatEx(Val(.TextMatrix(lngRow, COL_库存)), 5) & .TextMatrix(lngRow, COL_门诊单位)
                    End If
                Else
                    stbThis.Panels(3).Text = ""
                End If
            Else
                If rsItem!类别 = "7" And Val(.TextMatrix(lngRow, COL_状态)) = 1 Then
                    Call GetDrugStock(lngRow)
                End If
                stbThis.Panels(3).Text = ""
            End If
            
            '显示医嘱单价和费用类型
            If .TextMatrix(lngRow, COL_单价) = "" Then '用""不是零
                .TextMatrix(lngRow, COL_单价) = GetItemPrice(lngRow)
            End If
            dblPrice = Val(.TextMatrix(lngRow, COL_单价))
            If dblPrice <> 0 Then
                If InStr(",4,5,6,", rsItem!类别) > 0 Then
                    stbThis.Panels(4).Text = "每" & .TextMatrix(lngRow, COL_门诊单位) & ":" & FormatEx(dblPrice, 5) & "元"
                ElseIf rsItem!类别 = "7" Then
                    stbThis.Panels(4).Text = "每付:" & FormatEx(dblPrice, 5) & "元"
                Else
                    stbThis.Panels(4).Text = IIF(IsNull(rsItem!计算单位), "价格:", "每" & NVL(rsItem!计算单位) & ":") & FormatEx(dblPrice, 5) & "元"
                End If
            Else
                stbThis.Panels(4).Text = ""
            End If
            
            '显示费用类型
            strTmp = Get费用类型(lngRow)
            If strTmp <> "" Then
                stbThis.Panels(4).Text = stbThis.Panels(4).Text & IIF(stbThis.Panels(4).Text <> "", ",", "") & strTmp
            End If
                        '路径生成时，如果是按品种定义的医嘱，自动弹出规格选择器
            If mbytUseType = 1 And mlng路径状态 = 1 Then
                If cmdSel.Visible And cmdSel.Enabled Then
                    If Val(.TextMatrix(lngRow, COL_收费细目ID)) = 0 And Val("" & .Cell(flexcpChecked, lngRow, COL_选择)) = 1 Then
                        Call cmdSel_Click
                    End If
                End If
                If .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "4" Then
                    lbl超量说明.Caption = "变异原因"
                    txt超量说明.BackColor = &H80000018
                    txt超量说明.Enabled = True
                    txt超量说明.Locked = True
                    txt超量说明.TabStop = False
                    cmdZYRemark.Visible = True
                    cmdExcReason.Visible = False
                    cmdComExcReason.Visible = False
                    If .Cell(flexcpData, lngRow, COL_超量说明) <> "" Then
                        cmdZYRemark.Enabled = True
                    Else
                        cmdZYRemark.Enabled = False
                    End If
                    txt超量说明.Width = cmdZYRemark.Width + cmdZYRemark.Left - txt超量说明.Left
                    txt超量说明.Text = .TextMatrix(lngRow, COL_超量说明)
                Else
                    lbl超量说明.Caption = "超量说明"
                    txt超量说明.TabStop = True
                    cmdZYRemark.Visible = False
                    cmdExcReason.Visible = True
                    cmdComExcReason.Visible = True
                    cmdExcReason.Enabled = txt超量说明.Enabled
                    cmdComExcReason.Enabled = txt超量说明.Enabled
                    txt超量说明.Width = cbo医生嘱托.Width + cbo医生嘱托.Left - txt超量说明.Left
                End If
            End If
            '待审核的用血医嘱，则不允许:输血成分、执行科室、预定输血量
            If .TextMatrix(lngRow, COL_类别) = "K" And Val(.TextMatrix(lngRow, COL_检查方法)) = 1 And gbln血库系统 = True And blnEditable Then
                If InitObjBlood = True Then
                    If gobjPublicBlood.GetPrepareBloodRs(Val(.RowData(lngRow)), rsBlood) = True Then
                        If Val(rsBlood!记录性质 & "") = 2 And Val(rsBlood!记录状态 & "") = 1 Then
                            cmdSel.Enabled = False
                            txt医嘱内容.Enabled = False
                            txt总量.Enabled = False
                            cbo执行科室.Enabled = False
                        End If
                    End If
                End If
            End If
        End If
    End With
    
    '清除编辑标志
    Call ClearItemTag
    
    '显示或隐藏药品相关的两行项目
    Call SetMediInfoItem(bln显示单量, bln显示抗菌药物)
    
    '显示计价窗体
    Call ShowPrice(lngRow)
    
    '调用外挂接口
    If CreatePlugInOK(p门诊医嘱下达, mint场合) Then
        If OldRow <> NewRow Then
            Call zlPluginAdviceRowChange(NewRow)
            With vsAdvice
                If OldRow <> -1 Then
                    If Val(.RowData(OldRow)) <> 0 Then
                        If Val(.TextMatrix(OldRow, COL_EDIT)) = 1 Or Val(.TextMatrix(OldRow, COL_EDIT)) = 2 Then
                            Call zlPluginAdviceRowChange(OldRow, 1)
                        End If
                    End If
                End If
            End With
        End If
    End If
    cbsMain.RecalcLayout '即时刷新,有Lock可不要
    zlControl.FormLock 0
    Exit Sub
errH:
    zlControl.FormLock 0
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub ShowPrice(ByVal lngRow As Long)
'根据当前行的情况显示计价窗体
    If mblnModal Then Exit Sub
    
    If vsAdvice.RowData(lngRow) = 0 Or Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID)) = 0 Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf InStr(",1,2,", Val(vsAdvice.TextMatrix(lngRow, COL_状态))) = 0 Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf InStr(",4,5,6,", vsAdvice.TextMatrix(lngRow, COL_类别)) > 0 Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf RowIn配方行(lngRow) Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf stbThis.Panels("Price").Bevel = sbrNoBevel Then
        stbThis.Panels("Price").Visible = True
        If Val(stbThis.Panels("Price").Tag) <> 0 Then
            stbThis.Panels("Price").Bevel = sbrInset
        Else
            stbThis.Panels("Price").Bevel = sbrRaised
        End If
    End If
    
    If stbThis.Panels("Price").Bevel <> sbrInset Then
        '关闭计价窗体
        mfrmPrice.HideMe
    Else
        Call mfrmPrice.ShowMe(Me, vsAdvice, mlng病人ID, 0, mlng病人科室id, 1, mint险类, _
            COL_序号 & "," & COL_相关ID & "," & COL_状态 & "," & COL_类别 & "," & COL_诊疗项目ID & "," & _
            COL_收费细目ID & "," & COL_标本部位 & "," & COL_检查方法 & "," & COL_执行标记 & "," & COL_计价性质 & "," & COL_执行性质 & "," & COL_执行科室ID)
    End If
End Sub

Private Function Get费用类型(ByVal lngRow As Long) As String
'功能：获取指定行的费用类型
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, str类型 As String, str大类 As String, lng收费细目ID As Long
    
    lng收费细目ID = Val(vsAdvice.TextMatrix(lngRow, COL_收费细目ID))
    If lng收费细目ID <> 0 Then
        '取医保的费用类型
        If mint险类 <> 0 Then
            str类型 = gclsInsure.GetItemInsure(mlng病人ID, lng收费细目ID, 0, True, mint险类)
            If str类型 <> "" Then
                If UBound(Split(str类型, ";")) >= 5 Then
                    str类型 = Split(str类型, ";")(5)
                Else
                    str类型 = ""
                End If
            End If
        End If
        '没有则取HIS的费用类型
        strSQL = "Select A.费用类型,N.名称 as 医保大类 From 收费项目目录 A,保险支付项目 M,保险支付大类 N" & _
            " Where A.ID=[1] And A.ID=M.收费细目ID(+) And M.大类ID=N.ID(+) And M.险类(+)=[2]"
        On Error GoTo errH
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng收费细目ID, mint险类)
        If Not rsTmp.EOF Then
            If str类型 = "" Then str类型 = NVL(rsTmp!费用类型)
            str大类 = NVL(rsTmp!医保大类)
        End If
    End If
        
    Get费用类型 = Mid(IIF(str类型 <> "", ",类型:" & str类型, "") & IIF(str大类 <> "", ",大类:" & str大类, ""), 2)
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function Should附加执行(ByVal lngRow As Long, lngRow2 As Long, str执行科室 As String) As Boolean
'功能：判断指定的医嘱行(可见行)是否可以设置附加的执行科室
'参数：lngRow2=返回附加行的医嘱行号
'      str执行科室=附加执行科室类型
    Dim i As Long
    
    lngRow2 = -1
    str执行科室 = "附加执行"
    With vsAdvice
        If lngRow = 0 Or .RowData(lngRow) = 0 Then Exit Function
        
        If RowIn配方行(lngRow) Then
            '中药用法
            lngRow2 = lngRow
            str执行科室 = "用法执行"
            Should附加执行 = True
        ElseIf InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            '给药途径
            lngRow2 = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
            str执行科室 = "给药执行"
            Should附加执行 = True
        ElseIf .TextMatrix(lngRow, COL_类别) = "F" Then
            '手术麻醉
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "G" Then
                        lngRow2 = i: Exit For
                    End If
                Else
                    Exit For
                End If
            Next
            str执行科室 = "麻醉执行"
            If lngRow2 <> -1 Then Should附加执行 = True
        ElseIf .TextMatrix(lngRow, COL_类别) = "K" Then
            '输血途径
            '输血途径
            If Val(.TextMatrix(lngRow, COL_检查方法)) = 0 And gbln血库系统 = True Then
                str执行科室 = "采集执行"
            Else
                str执行科室 = "输血执行"
            End If
            lngRow2 = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_相关ID)
            If lngRow2 <> -1 Then Should附加执行 = True
        ElseIf .TextMatrix(lngRow, COL_类别) = "E" _
            And .TextMatrix(lngRow - 1, COL_类别) = "C" _
            And Val(.TextMatrix(lngRow - 1, COL_相关ID)) = .RowData(lngRow) Then
            '采集方式
            lngRow2 = lngRow
            str执行科室 = "采集执行"
            Should附加执行 = True
        ElseIf .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5" Then
            '原液皮试药房
            lngRow2 = lngRow
            str执行科室 = "原液药房"
            Should附加执行 = True
        End If
        
        '叮嘱或院外执行
        If Should附加执行 Then
            If InStr(",0,5,", Val(.TextMatrix(lngRow2, COL_执行性质))) > 0 Then
                Should附加执行 = False
            End If
        End If
    End With
End Function

Private Function GetItemPrice(ByVal lngRow As Long) As Double
'功能：获取当前医嘱行的价格(药品为一个药房包装的单价,其它根据收费对照)
'说明：药品不包含给药途径及中药用法煎法
    Dim rsTmp As New ADODB.Recordset
    Dim str医嘱IDs As String, str单量s As String, str诊疗收费 As String
    Dim str项目IDs As String, str医嘱 As String, str项目科室 As String, strTmp As String
    Dim strAdviceIDs As String, lng执行科室ID As Long
    Dim dblPrice As Double, dbl数量 As Double
    Dim bln药品 As Boolean, strSQL As String
    Dim str管码项目 As String, i As Long
    
    With vsAdvice
        bln药品 = True
        If InStr(",4,5,6,", .TextMatrix(lngRow, COL_类别)) > 0 And Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
            '西药及中成药按规格下才能计算价格
            If Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
                str项目IDs = str项目IDs & "," & Val(.TextMatrix(lngRow, COL_收费细目ID))
            End If
            lng执行科室ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
        ElseIf RowIn配方行(lngRow) Then
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "7" And Val(.TextMatrix(i, COL_收费细目ID)) <> 0 Then
                        If lng执行科室ID = 0 Then
                            lng执行科室ID = Val(.TextMatrix(i, COL_执行科室ID))
                        End If
                        str项目IDs = str项目IDs & "," & Val(.TextMatrix(i, COL_收费细目ID))
                        str单量s = str单量s & ";" & Val(.TextMatrix(i, COL_单量))
                    End If
                Else
                    Exit For
                End If
            Next
        Else
            bln药品 = False
            '其它医嘱,未校对(计价)的按收费对照计算,否则直接取医嘱计价
            '不包含不计价和手工计价的项目,不包含叮嘱和院外执行的项目
            If Val(.TextMatrix(lngRow, COL_计价性质)) = 0 And InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                If InStr(",1,2,", .TextMatrix(lngRow, COL_状态)) > 0 Then
                    str管码项目 = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
                    If RowIn检验行(lngRow) Then
                        i = .FindRow(CStr(.RowData(lngRow)), .FixedRows, COL_相关ID)
                        If i <> -1 Then
                            str管码项目 = Val(.TextMatrix(i, COL_诊疗项目ID))
                        End If
                    End If
                    
                    str项目科室 = str项目科室 & "," & Val(.TextMatrix(lngRow, COL_诊疗项目ID)) & ":" & Val(.TextMatrix(lngRow, COL_执行科室ID))
                    str项目IDs = str项目IDs & "," & Val(.TextMatrix(lngRow, COL_诊疗项目ID))
                    str医嘱 = str医嘱 & " Union ALL Select " & _
                        IIF(Val(.TextMatrix(lngRow, COL_相关ID)) = 0, "-NULL", Val(.TextMatrix(lngRow, COL_相关ID))) & " as 相关ID," & _
                        Val(.TextMatrix(lngRow, COL_诊疗项目ID)) & " as 诊疗项目ID," & Val(.TextMatrix(lngRow, COL_执行标记)) & " as 执行标记," & _
                        IIF(.TextMatrix(lngRow, COL_标本部位) = "", "NULL", "'" & .TextMatrix(lngRow, COL_标本部位) & "'") & " as 标本部位," & _
                        IIF(.TextMatrix(lngRow, COL_检查方法) = "", "NULL", "'" & .TextMatrix(lngRow, COL_检查方法) & "'") & " as 检查方法," & _
                        str管码项目 & " as 管码项目ID From Dual"
                Else
                    str医嘱IDs = str医嘱IDs & "," & .RowData(lngRow)
                End If
            End If
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If Val(.TextMatrix(i, COL_计价性质)) = 0 And InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                        If InStr(",1,2,", .TextMatrix(i, COL_状态)) > 0 Then
                            strTmp = Val(.TextMatrix(i, COL_诊疗项目ID)) & ":" & Val(.TextMatrix(i, COL_执行科室ID))
                            If InStr("," & str项目科室 & ",", "," & strTmp & ",") = 0 Then str项目科室 = str项目科室 & "," & strTmp
                            
                            str医嘱 = str医嘱 & " Union ALL Select " & _
                                IIF(Val(.TextMatrix(i, COL_相关ID)) = 0, "-NULL", Val(.TextMatrix(i, COL_相关ID))) & " as 相关ID," & _
                                Val(.TextMatrix(i, COL_诊疗项目ID)) & " as 诊疗项目ID," & Val(.TextMatrix(i, COL_执行标记)) & " as 执行标记," & _
                                IIF(.TextMatrix(i, COL_标本部位) = "", "NULL", "'" & .TextMatrix(i, COL_标本部位) & "'") & " as 标本部位," & _
                                IIF(.TextMatrix(i, COL_检查方法) = "", "NULL", "'" & .TextMatrix(i, COL_检查方法) & "'") & " as 检查方法," & _
                                Val(.TextMatrix(i, COL_诊疗项目ID)) & " as 管码项目ID From Dual"
                        Else
                            str医嘱IDs = str医嘱IDs & "," & .RowData(i)
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
            For i = lngRow - 1 To .FixedRows Step -1 '检验组合
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If Val(.TextMatrix(i, COL_计价性质)) = 0 And InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                        If InStr(",1,2,", .TextMatrix(i, COL_状态)) > 0 Then
                            strTmp = Val(.TextMatrix(i, COL_诊疗项目ID)) & ":" & Val(.TextMatrix(i, COL_执行科室ID))
                            If InStr("," & str项目科室 & ",", "," & strTmp & ",") = 0 Then str项目科室 = str项目科室 & "," & strTmp
                            
                            str医嘱 = str医嘱 & " Union ALL Select " & _
                                IIF(Val(.TextMatrix(i, COL_相关ID)) = 0, "-NULL", Val(.TextMatrix(i, COL_相关ID))) & " as 相关ID," & _
                                Val(.TextMatrix(i, COL_诊疗项目ID)) & " as 诊疗项目ID," & Val(.TextMatrix(i, COL_执行标记)) & " as 执行标记," & _
                                IIF(.TextMatrix(i, COL_标本部位) = "", "NULL", "'" & .TextMatrix(i, COL_标本部位) & "'") & " as 标本部位," & _
                                IIF(.TextMatrix(i, COL_检查方法) = "", "NULL", "'" & .TextMatrix(i, COL_检查方法) & "'") & " as 检查方法," & _
                                Val(.TextMatrix(i, COL_诊疗项目ID)) & " as 管码项目ID From Dual"
                        Else
                            str医嘱IDs = str医嘱IDs & "," & .RowData(i)
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
        End If
    End With
    str医嘱IDs = Mid(str医嘱IDs, 2)
    str单量s = Mid(str单量s, 2)
    str项目IDs = Mid(str项目IDs, 2)
    str项目科室 = Mid(str项目科室, 2)
    str医嘱 = Mid(str医嘱, 12)
    
    On Error GoTo errH
    
    If bln药品 Then
        If str项目IDs = "" Then Exit Function
    
        strSQL = "Select Rownum As 序号,Column_Value As ID From Table(f_Num2list([1]))"
        strSQL = "Select /*+ RULE */ A.ID,A.类别,A.是否变价,D.跟踪在用,Nvl(B.门诊包装,1) as 门诊包装,Nvl(B.剂量系数,1) as 剂量系数,B.门诊可否分零 As 可否分零" & _
            " From 收费项目目录 A,药品规格 B,材料特性 D,(" & strSQL & ") C" & _
            " Where A.ID=B.药品ID(+) And A.ID=D.材料ID(+) And A.ID=C.ID Order By C.序号"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str项目IDs)
        For i = 1 To rsTmp.RecordCount
            '售价数量
            If str单量s <> "" Then '中药配方才管每味剂量
                dbl数量 = Val(Split(str单量s, ";")(i - 1))
                
                '售价数量：中药药房单位按不可分零处理:每付
                If NVL(rsTmp!可否分零, 0) = 0 Then
                    dbl数量 = Format(dbl数量 / NVL(rsTmp!剂量系数, 1), "0.00000")
                Else
                    dbl数量 = Format(IntEx(dbl数量 / NVL(rsTmp!剂量系数, 1) / NVL(rsTmp!门诊包装, 1)) * NVL(rsTmp!门诊包装, 1), "0.00000")
                End If
            Else
                dbl数量 = NVL(rsTmp!门诊包装, 1) '1个药房单位的售价数量
            End If
            If NVL(rsTmp!是否变价, 0) = 1 And (rsTmp!类别 = "4" And NVL(rsTmp!跟踪在用, 0) = 1 Or InStr(",5,6,7,", rsTmp!类别) > 0) Then
                dblPrice = dblPrice + Format(Format(CalcDrugPrice(rsTmp!ID, lng执行科室ID, dbl数量, , , 1, mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级), "0.00000") * dbl数量, "0.00000")
            Else
                dblPrice = dblPrice + Format(Format(CalcPrice(rsTmp!ID, , , , , , mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级), "0.00000") * dbl数量, "0.00000")
            End If
            
            rsTmp.MoveNext
        Next
    Else
        If str医嘱 = "" And str医嘱IDs = "" Then Exit Function
    
        If str医嘱IDs <> "" Then
            strSQL = _
                " Select /*+ RULE */B.数量,Decode(C.是否变价,1,B.单价,Sum(D.现价)) as 单价" & _
                " From 病人医嘱计价 B,收费项目目录 C,收费价目 D" & _
                " Where B.收费细目ID=C.ID And B.收费细目ID=D.收费细目ID" & _
                GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "3", "4", "5") & _
                " And ((Sysdate Between D.执行日期 And D.终止日期) Or (Sysdate>=D.执行日期 And D.终止日期 is NULL))" & _
                " And B.医嘱ID IN(Select Column_Value From Table(f_Num2list([1])))" & _
                " Group by B.数量,C.是否变价,B.单价"
        End If
        If str医嘱 <> "" Then
            '由于没有加部位等条件，所以要用Distinct
            str诊疗收费 = "Select * From (" & _
                "Select Distinct C.诊疗项目ID,C.收费项目ID,C.检查部位,C.检查方法,C.费用性质,C.收费数量,C.固有对照,C.从属项目,C.收费方式,C.适用科室id" & _
                " ,Max(Nvl(c.适用科室id, 0)) Over(Partition By c.诊疗项目id, c.检查部位, c.检查方法, c.费用性质) As Top" & _
                " From 诊疗收费关系 C,Table(f_Num2list2([2])) D Where C.诊疗项目ID=D.c1" & _
                "      And (C.适用科室ID is Null or C.适用科室ID = D.c2 And C.病人来源 = 1)" & _
                " ) Where Nvl(适用科室id, 0) = Top"
                
            strSQL = IIF(strSQL = "", "", strSQL & " Union ALL") & _
                " Select " & IIF(strSQL = "", "/*+ RULE */", "") & "B.收费数量 as 数量,Decode(C.是否变价,1,Sum(D.缺省价格),Sum(D.现价)) as 单价" & _
                " From (" & str医嘱 & ") A,(" & str诊疗收费 & ") B,收费项目目录 C,收费价目 D,诊疗项目目录 E,采血管类型 F" & _
                " Where A.诊疗项目ID=B.诊疗项目ID And B.收费项目ID=C.ID And B.收费项目ID=D.收费细目ID" & _
                GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "3", "4", "5") & _
                " And (C.站点='" & gstrNodeNo & "' Or C.站点 is Null) And A.管码项目ID=E.ID And E.试管编码=F.编码(+)" & _
                " And (Nvl(B.收费方式,0)=1 And C.类别='4' And B.收费项目ID=F.材料ID Or Not(Nvl(B.收费方式,0)=1 And C.类别='4' And F.材料ID Is Not NULL))" & _
                " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))" & _
                " And (A.相关ID is Null And A.执行标记 IN(1,2) And B.费用性质=1" & _
                "       Or A.标本部位=B.检查部位 And A.检查方法=B.检查方法 And Nvl(B.费用性质,0)=0" & _
                "       Or (A.检查方法 is Null Or e.类别 = 'E' And e.操作类型='4') And Nvl(B.费用性质,0)=0 And B.检查部位 is Null And B.检查方法 is Null)" & _
                " Group by B.收费数量,C.是否变价"
        End If
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Name, str医嘱IDs, str项目科室, mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级)
        For i = 1 To rsTmp.RecordCount
            dblPrice = dblPrice + Format(NVL(rsTmp!数量, 0) * NVL(rsTmp!单价, 0), "0.00000")
            rsTmp.MoveNext
        Next
    End If
    
    GetItemPrice = Format(dblPrice, gstrDecPrice)
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function MakePriceRecord(ByVal lngRow As Long) As Boolean
'功能：根据当前新开医嘱行内容，生成对应的用于医保的费用明细记录集
'参数：lngRow=当前医嘱行
'返回：有计价数据记录集内容才返回True
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, strAdvice As String, str项目科室 As String, str诊疗收费 As String
    Dim lngBegin As Long, lngEnd As Long
    Dim lng执行科室ID As Long, blnLoad As Boolean
    Dim dbl单价 As Double, dbl金额 As Double, dbl实收 As Double
    Dim str管码项目 As String, i As Long
    Dim str项目 As String, blnDo As Boolean
    Dim lng组ID As Long, lng诊断ID As Long, lng疾病ID As Long
    
    On Error GoTo errH
        
    With vsAdvice
        If .RowData(lngRow) = 0 Then Exit Function
        
        If RowIn检验行(lngRow) Then
            i = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
            If i <> -1 Then str管码项目 = Val(.TextMatrix(i, COL_诊疗项目ID))
        End If
        
        '生成病人医嘱记录临时表
        Call GetRowScope(lngRow, lngBegin, lngEnd)
        For i = lngBegin To lngEnd
            If Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                str项目科室 = str项目科室 & "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & ":" & Val(.TextMatrix(i, COL_执行科室ID))
                strAdvice = strAdvice & " Union ALL " & _
                    "Select " & .RowData(i) & " as ID," & Val(.TextMatrix(i, COL_序号)) & " as 序号," & _
                    ZVal(.TextMatrix(i, COL_相关ID), True) & " as 相关ID,'" & .TextMatrix(i, COL_类别) & "' as 诊疗类别," & _
                    IIF(str管码项目 = "", Val(.TextMatrix(i, COL_诊疗项目ID)), str管码项目) & " as 管码项目ID," & _
                    Val(.TextMatrix(i, COL_诊疗项目ID)) & " as 诊疗项目ID," & ZVal(.TextMatrix(i, COL_收费细目ID), True) & " as 收费细目ID," & _
                    Val(.TextMatrix(i, COL_总量)) & " as 总量," & Val(.TextMatrix(i, COL_单量)) & " as 单量," & _
                    "'" & .TextMatrix(i, COL_标本部位) & "' as 标本部位,'" & .TextMatrix(i, COL_检查方法) & "' as 检查方法," & _
                    Val(.TextMatrix(i, COL_执行标记)) & " as 执行标记," & Val(.TextMatrix(i, COL_计价性质)) & " as 计价特性," & _
                    IIF(.TextMatrix(i, COL_类别) = "F" And Val(.TextMatrix(i, COL_相关ID)) <> 0, 1, 0) & " as 附加手术," & _
                    Val(.TextMatrix(i, COL_执行性质)) & " as 执行性质," & ZVal(.TextMatrix(i, COL_执行科室ID), True) & " as 执行科室ID From Dual"
            End If
        Next
        strAdvice = Mid(strAdvice, 12)
        str项目科室 = Mid(str项目科室, 2)
    End With
    
    blnLoad = True
    
    '药品、卫材的计价：按售价数量、单价计算
    If vsAdvice.TextMatrix(lngRow, COL_类别) = "4" Then
        '卫材：固定按规格下达
        strSQL = "Select A.序号,A.诊疗类别,C.类别 as 收费类别,A.收费细目ID,D.收入项目ID," & _
            " Decode(A.总量,0,1,A.总量) as 数量,Decode(Nvl(C.是否变价,0),1,D.缺省价格,D.现价) as 单价," & _
            " C.是否变价,C.屏蔽费别,B.跟踪在用,A.执行科室ID,A.附加手术,D.附术收费率" & _
            " From (" & strAdvice & ") A,材料特性 B,收费项目目录 C,收费价目 D" & _
            " Where A.ID=[1] And Nvl(A.执行性质,0)<>5 And A.收费细目ID=B.材料ID" & _
            " And A.收费细目ID=C.ID And C.服务对象 IN(1,3) And D.收费细目ID=C.ID" & _
            GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "4", "5", "6") & _
            " And (C.撤档时间 is NULL Or C.撤档时间=To_Date('3000-01-01','YYYY-MM-DD'))" & _
            " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))"
        blnLoad = False
    ElseIf InStr(",5,6,", vsAdvice.TextMatrix(lngRow, COL_类别)) > 0 Then
        '中,西成药:可能按规格下医嘱,计算1个药房包装的单价
        strSQL = "Select A.序号,A.诊疗类别,C.类别 as 收费类别,C.ID as 收费细目ID,D.收入项目ID," & _
            " Decode(A.总量,0,1,A.总量)/Decode(1,1,B.门诊包装,B.住院包装) as 数量," & _
            " Decode(Nvl(C.是否变价,0),1,-NULL,D.现价) as 单价,C.是否变价,C.屏蔽费别," & _
            " 0 as 跟踪在用,A.执行科室ID,A.附加手术,D.附术收费率" & _
            " From (" & strAdvice & ") A,药品规格 B,收费项目目录 C,收费价目 D" & _
            " Where A.ID=[1] And Nvl(A.执行性质,0)<>5 And A.收费细目ID=B.药品ID" & _
            " And B.药品ID=C.ID And C.服务对象 IN(1,3) And D.收费细目ID=C.ID" & _
            GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "4", "5", "6") & _
            " And (C.撤档时间 is NULL Or C.撤档时间=To_Date('3000-01-01','YYYY-MM-DD'))" & _
            " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))"
            
        '仅一并给药(如果是)的第一成药行才显示给药途径的计价
        blnLoad = Val(vsAdvice.TextMatrix(lngRow - 1, COL_相关ID)) <> Val(vsAdvice.TextMatrix(lngRow, COL_相关ID))
    ElseIf RowIn配方行(lngRow) Then
        '中草药:一定对应有规格记录且填写了收费细目ID
        strSQL = "Select A.序号,A.诊疗类别,C.类别 as 收费类别,C.ID as 收费细目ID,D.收入项目ID," & _
            " Decode(A.总量,0,1,A.总量)*A.单量/Nvl(B.剂量系数,1) as 数量," & _
            " Decode(Nvl(C.是否变价,0),1,-NULL,D.现价) as 单价,C.是否变价,C.屏蔽费别," & _
            " 0 as 跟踪在用,A.执行科室ID,A.附加手术,D.附术收费率" & _
            " From (" & strAdvice & ") A,药品规格 B,收费项目目录 C,收费价目 D" & _
            " Where A.诊疗类别='7' And A.相关ID=[1] And A.收费细目ID=B.药品ID And A.收费细目ID=C.ID" & _
            GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "4", "5", "6") & _
            " And C.服务对象 IN(1,3) And D.收费细目ID=C.ID And Nvl(A.执行性质,0)<>5" & _
            " And (C.撤档时间 is NULL Or C.撤档时间=To_Date('3000-01-01','YYYY-MM-DD'))" & _
            " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))"
    End If
    
    '读取计价关系：除药品、卫材医嘱外的计价,包含相关医嘱计价；不计价,手工计价的医嘱不读取
    If blnLoad Then
        '由于没有加部位等条件，所以要用Distinct
        str诊疗收费 = "Select * From (" & _
                "Select Distinct C.诊疗项目ID,C.收费项目ID,C.检查部位,C.检查方法,C.费用性质,C.收费数量,C.固有对照,C.从属项目,C.收费方式,C.适用科室id" & _
                " ,Max(Nvl(c.适用科室id, 0)) Over(Partition By c.诊疗项目id, c.检查部位, c.检查方法, c.费用性质) As Top" & _
                " From 诊疗收费关系 C,Table(f_Num2list2([3])) D Where C.诊疗项目ID=D.c1" & _
                "      And (C.适用科室ID is Null or C.适用科室ID = D.c2 And C.病人来源 = 1)" & _
                " ) Where Nvl(适用科室id, 0) = Top"
                
        strSQL = strSQL & IIF(strSQL = "", "", " Union ALL") & _
            " Select A.序号,A.诊疗类别,C.类别 as 收费类别,B.收费项目ID as 收费细目ID,D.收入项目ID," & _
            " Decode(A.总量,0,1,A.总量)*B.收费数量 as 数量,Decode(C.是否变价,1,D.缺省价格,D.现价) as 单价," & _
            " C.是否变价,C.屏蔽费别,0 as 跟踪在用,A.执行科室ID,A.附加手术,D.附术收费率" & _
            " From (" & strAdvice & ") A,(" & str诊疗收费 & ") B,收费项目目录 C,收费价目 D,诊疗项目目录 E,采血管类型 F" & _
            " Where A.诊疗类别 Not IN('4','5','6','7') And A.诊疗项目ID=B.诊疗项目ID" & _
            GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "4", "5", "6") & _
            " And (A.相关ID is Null And A.执行标记 IN(1,2) And B.费用性质=1" & _
            "       Or A.标本部位=B.检查部位 And A.检查方法=B.检查方法 And Nvl(B.费用性质,0)=0" & _
            "       Or (A.检查方法 is Null Or e.类别 = 'E' And e.操作类型='4') And Nvl(B.费用性质,0)=0 And B.检查部位 is Null And B.检查方法 is Null)" & _
            " And A.管码项目ID=E.ID And E.试管编码=F.编码(+)" & _
            "   And (Nvl(B.收费方式,0)=1 And C.类别='4' And B.收费项目ID=F.材料ID" & _
            "       Or Not(Nvl(B.收费方式,0)=1 And C.类别='4' And F.材料ID Is Not NULL))" & _
            " And Nvl(A.计价特性,0)=0 And Nvl(A.执行性质,0) Not IN(0,5) And B.收费项目ID=C.ID And B.收费项目ID=D.收费细目ID" & _
            " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))" & _
            " And (C.撤档时间 is NULL Or C.撤档时间=To_Date('3000-01-01','YYYY-MM-DD')) And C.服务对象 IN(1,3)" & _
            " And (C.站点='" & gstrNodeNo & "' Or C.站点 is Null) And (A.ID=[1] Or A.ID=[2] Or A.相关ID=[1])"
    End If
    
    strSQL = "Select /*+ RULE */ A.* From (" & strSQL & ") A Order by 序号,收入项目ID"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Name, Val(vsAdvice.RowData(lngRow)), Val(vsAdvice.TextMatrix(lngRow, COL_相关ID)), str项目科室, mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级)
    If Not rsTmp.EOF Then
        '获取疾病ID、诊断ID
        With vsDiag
            lng组ID = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_相关ID)) = 0, vsAdvice.RowData(lngRow), Val(vsAdvice.TextMatrix(lngRow, COL_相关ID)))
            For i = 1 To .Rows - 1
                If InStr("," & .TextMatrix(i, col医嘱ID) & ",", "," & lng组ID & ",") > 0 Then
                    lng疾病ID = Val(.TextMatrix(i, col疾病ID))
                    lng诊断ID = Val(.TextMatrix(i, col诊断ID))
                    Exit For
                End If
            Next
        End With
    
        '初始化记录集
        Set mrsPrice = New ADODB.Recordset
        mrsPrice.Fields.Append "病人ID", adBigInt
        mrsPrice.Fields.Append "主页ID", adBigInt, , adFldIsNullable
        mrsPrice.Fields.Append "收费类别", adVarChar, 1
        mrsPrice.Fields.Append "收费细目ID", adBigInt
        mrsPrice.Fields.Append "数量", adDouble
        mrsPrice.Fields.Append "单价", adDouble
        mrsPrice.Fields.Append "实收金额", adDouble
        mrsPrice.Fields.Append "开单人", adVarChar, 100, adFldIsNullable
        mrsPrice.Fields.Append "开单科室", adVarChar, 100, adFldIsNullable
        mrsPrice.Fields.Append "疾病ID", adBigInt, , adFldIsNullable
        mrsPrice.Fields.Append "诊断ID", adBigInt, , adFldIsNullable
        mrsPrice.CursorLocation = adUseClient
        mrsPrice.LockType = adLockOptimistic
        mrsPrice.CursorType = adOpenStatic
        mrsPrice.Open
        
        '加入费用明细
        dbl实收 = 0: blnDo = True
        Do While Not rsTmp.EOF
            '执行科室
            If blnDo Then
                lng执行科室ID = NVL(rsTmp!执行科室ID, 0)
                If rsTmp!收费类别 = "4" And NVL(rsTmp!跟踪在用, 0) = 1 Or InStr(",5,6,7,", rsTmp!收费类别) > 0 And InStr(",5,6,7,", rsTmp!诊疗类别) = 0 Then
                    lng执行科室ID = Get收费执行科室ID(mlng病人ID, 0, rsTmp!收费类别, rsTmp!收费细目ID, 4, mlng病人科室id, 0, 2, lng执行科室ID)
                End If
            End If
            
            '单价
            If InStr(",5,6,7,", rsTmp!收费类别) > 0 And NVL(rsTmp!是否变价, 0) = 1 Then
                '药品时价
                dbl单价 = Format(CalcDrugPrice(rsTmp!收费细目ID, lng执行科室ID, NVL(rsTmp!数量, 0), , , 1, mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级), gstrDecPrice)
            ElseIf rsTmp!收费类别 = "4" And NVL(rsTmp!跟踪在用, 0) = 1 And NVL(rsTmp!是否变价, 0) = 1 Then
                '跟踪在用卫材时价
                dbl单价 = Format(CalcDrugPrice(rsTmp!收费细目ID, lng执行科室ID, NVL(rsTmp!数量, 0), , , 1, mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级), gstrDecPrice)
            Else
                dbl单价 = Format(NVL(rsTmp!单价, 0), gstrDecPrice) '其他变价取的缺省价格
            End If
            
            '金额
            dbl金额 = CCur(NVL(rsTmp!数量, 0) * dbl单价)
            If NVL(rsTmp!附加手术, 0) = 1 Then
                dbl金额 = dbl金额 * NVL(rsTmp!附术收费率, 100) / 100
            End If
            dbl金额 = Format(dbl金额, gstrDec)
            
            If NVL(rsTmp!屏蔽费别, 0) = 0 And mstr费别 <> "" Then
                dbl金额 = ActualMoney(mstr费别, rsTmp!收入项目ID, dbl金额, rsTmp!收费细目ID, lng执行科室ID, NVL(rsTmp!数量, 0))
            End If
            
            dbl实收 = dbl实收 + dbl金额
            
            '项目变化时加入
            str项目 = rsTmp!序号 & "," & rsTmp!收费细目ID
            blnDo = False: rsTmp.MoveNext
            If Not rsTmp.EOF Then
                If rsTmp!序号 & "," & rsTmp!收费细目ID <> str项目 Then blnDo = True
            Else
                blnDo = True
            End If
            rsTmp.MovePrevious
            
            If blnDo Then
                With vsAdvice
                    mrsPrice.AddNew
                    mrsPrice!病人ID = mlng病人ID
                    mrsPrice!主页ID = Null
                    mrsPrice!收费类别 = rsTmp!收费类别
                    mrsPrice!收费细目ID = rsTmp!收费细目ID
                    mrsPrice!数量 = NVL(rsTmp!数量, 0)
                    mrsPrice!单价 = dbl单价
                    mrsPrice!实收金额 = dbl金额
                    If .TextMatrix(lngRow, COL_开嘱医生) <> "" Then
                        mrsPrice!开单人 = .TextMatrix(lngRow, COL_开嘱医生)
                    End If
                    If Val(.TextMatrix(lngRow, COL_开嘱科室ID)) <> 0 Then
                        mrsPrice!开单科室 = CStr(Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_开嘱科室ID)), "名称"))
                    End If
                    If lng疾病ID <> 0 Then mrsPrice!疾病id = lng疾病ID
                    If lng诊断ID <> 0 Then mrsPrice!诊断id = lng诊断ID
                    mrsPrice.Update
                End With
                dbl实收 = 0
            End If
            
            rsTmp.MoveNext
        Loop
        
        mrsPrice.MoveFirst
        MakePriceRecord = True
    End If
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub GetDrugStock(ByVal lngRow As Long)
'功能：重新获取指定药品行的药品库存
'参数：lngRow=卫材、成药行或中药用法行
'说明：如果是中药配方行,一次性获取整个配方中的所有中药的库存
    Dim i As Long
    
    With vsAdvice
        If InStr(",4,5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            If Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Or Val(.TextMatrix(lngRow, COL_收费细目ID)) = 0 _
                Or .TextMatrix(lngRow, COL_类别) = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 0 Then
                .TextMatrix(lngRow, COL_库存) = ""
            Else
                .TextMatrix(lngRow, COL_库存) = GetStock(Val(.TextMatrix(lngRow, COL_收费细目ID)), Val(.TextMatrix(lngRow, COL_执行科室ID)), 1)
            End If
        ElseIf RowIn配方行(lngRow) Then
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "7" Then
                        If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Or Val(.TextMatrix(i, COL_收费细目ID)) = 0 Then
                            .TextMatrix(i, COL_库存) = ""
                        Else
                            .TextMatrix(i, COL_库存) = GetStock(Val(.TextMatrix(i, COL_收费细目ID)), Val(.TextMatrix(i, COL_执行科室ID)), 1)
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
        End If
    End With
End Sub

Private Sub vsAdvice_AfterUserResize(ByVal Row As Long, ByVal Col As Long)
    Dim lngW As Long
    
    If Row = -1 Then
        lngW = Me.TextWidth(vsAdvice.TextMatrix(0, Col) & "A")
        If vsAdvice.ColWidth(Col) < lngW Then
            vsAdvice.ColWidth(Col) = lngW
        ElseIf vsAdvice.ColWidth(Col) > vsAdvice.Width * 0.5 Then
            vsAdvice.ColWidth(Col) = vsAdvice.Width * 0.5
        End If
        
        If Col = col_医嘱内容 Then Call vsAdvice.AutoSize(col_医嘱内容)
    End If
End Sub

Private Sub vsAdvice_BeforeScroll(ByVal OldTopRow As Long, ByVal OldLeftCol As Long, ByVal NewTopRow As Long, ByVal NewLeftCol As Long, Cancel As Boolean)
    If dtpDate.Visible Then
        Call Form_KeyDown(vbKeyEscape, 0)
        Cancel = True
    End If
    If fraAdvice.Tag <> "" Then
        Cancel = True
    End If
End Sub

Private Sub vsAdvice_BeforeUserResize(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    If Row = -1 Then
        If Col <= vsAdvice.FixedCols - 1 Then
            Cancel = True
        ElseIf Col = COL_警示 Then 'Pass
            Cancel = True
        End If
    End If
End Sub

Private Sub vsAdvice_Click()
    Dim lngPreRow As Long
    Dim str诊断IDs As String
    Dim j As Long
    
    'PASS
    If mblnPass And Me.Visible Then
        Call gobjPass.zlPassAdviceMainPoint(mobjPassMap, 1)
    End If
    With vsAdvice
        If mbytUseType = 1 And .Col = COL_选择 Then
            '勾选医嘱时处理诊断关联
            If .Cell(flexcpChecked, .Row, COL_选择) = flexChecked Then
                For j = 1 To vsDiag.Rows - 1
                    If Val(vsDiag.RowData(j)) <> 0 Then
                        str诊断IDs = str诊断IDs & "," & Val(vsDiag.RowData(j))
                    End If
                Next
                str诊断IDs = Mid(str诊断IDs, 2)
                If Val(.TextMatrix(.Row, COL_相关ID)) = 0 And .Cell(flexcpChecked, .Row, COL_选择) <> 2 Then Call SetDiagFlag(.Row, 1, str诊断IDs)
            ElseIf .Cell(flexcpChecked, .Row, COL_选择) = flexUnchecked Then
                Call SetDiagFlag(.Row, 2)
            End If
        End If
    End With
End Sub

Private Sub vsAdvice_DblClick()
    Dim lngRow As Long, lngCol As Long
    
    With vsAdvice
        lngRow = .MouseRow: lngCol = .MouseCol
        If lngRow >= .FixedRows And lngRow <= .Rows - 1 Then
            If lngCol >= .FixedCols And lngCol <= .Cols - 1 Then
                Call vsAdvice_KeyPress(13)    '定位到对应的编辑控件
                'PASS合理用药检测
                If mblnPass Then
                    Call gobjPass.zlPassAdviceMainPoint(mobjPassMap)
                End If
            ElseIf .MouseCol = COL_F标志 Then
                '填写申请
                '##
            End If
        End If
    End With
End Sub

Private Function RowIsLastVisible(ByVal lngRow As Long) As Boolean
'功能：判断指定行是否最后一可见行
    Dim i As Long
    
    With vsAdvice
        For i = .Rows - 1 To .FixedRows Step -1
            If Not .RowHidden(i) Then Exit For
        Next
        If i >= .FixedRows Then
            RowIsLastVisible = lngRow = i
        End If
    End With
End Function

Private Sub vsAdvice_DrawCell(ByVal hDC As Long, ByVal Row As Long, ByVal Col As Long, ByVal Left As Long, ByVal Top As Long, ByVal Right As Long, ByVal Bottom As Long, Done As Boolean)
'说明：1.OwnerDraw要设置为Over(画出单元所有内容)
'      2.Cell的GridLine从上下左右向内都是从第1根线开始
'      3.Cell的Border从左上是从第2根线开始,右下是从第1根线开始
    Dim lngLeft As Long, lngRight As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim vRect As RECT
    
    With vsAdvice
        If Col <= .FixedCols - 1 Then
            '擦除固定列中的表格线
            SetBkColor hDC, OS.SysColor2RGB(.BackColorFixed)

            '仅左边表格线
            vRect.Left = Left
            vRect.Top = Top
            vRect.Right = Left + 1
            vRect.Bottom = Bottom
            If Row = .Rows - 1 Then vRect.Bottom = vRect.Bottom - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0

            '仅上边表格线
            vRect.Left = Left
            vRect.Top = Top
            vRect.Right = Right
            vRect.Bottom = Top + 1
            If Col = .FixedCols - 1 Then vRect.Right = vRect.Right - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0

            '仅下边表格线
            vRect.Left = Left
            vRect.Top = Bottom - 1
            vRect.Right = Right
            vRect.Bottom = Bottom
            If RowIsLastVisible(Row) Then vRect.Bottom = vRect.Bottom - 1
            If Col = .FixedCols - 1 Then vRect.Right = vRect.Right - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0

            '仅右边表格线
            vRect.Left = Right - 1
            vRect.Top = Top
            vRect.Right = Right
            vRect.Bottom = Bottom
            If Row = .Rows - 1 Then vRect.Bottom = vRect.Bottom - 1
            If Col = .FixedCols - 1 Then vRect.Right = vRect.Right - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0
        Else
            lngLeft = COL_诊断: lngRight = COL_开始时间
            If Not Between(Col, lngLeft, lngRight) Then
                lngLeft = COL_天数: lngRight = COL_用法
                If Not Between(Col, lngLeft, lngRight) Then Exit Sub
            End If
            
            If Not RowIn一并给药(Row) Then Exit Sub
            If .RowData(Row) = 0 Then
                Call Get一并给药范围(Val(.TextMatrix(Row - 1, COL_相关ID)), lngBegin, lngEnd)
            Else
                Call Get一并给药范围(Val(.TextMatrix(Row, COL_相关ID)), lngBegin, lngEnd)
            End If
            
            vRect.Left = Left '擦除左边表格线
            vRect.Right = Right - 1 '保留右边表格线
            If Row = lngBegin Then
                vRect.Top = Bottom - 1 '首行保留文字内容
                vRect.Bottom = Bottom
            Else
                If Row = lngEnd Then
                    vRect.Top = Top
                    vRect.Bottom = Bottom - 1 '底行保留下边线
                Else
                    vRect.Top = Top
                    vRect.Bottom = Bottom
                End If
            End If
            
            If Between(Row, .Row, .RowSel) Then
                SetBkColor hDC, OS.SysColor2RGB(.BackColorSel)
            Else
                SetBkColor hDC, OS.SysColor2RGB(.BackColor)
            End If
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0
        End If
        Done = True
    End With
End Sub

Private Sub vsAdvice_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyDelete Then
        If mbytUseType <> 1 Then
            cbsMain.FindControl(, conMenu_Delete, True, True).Execute
        End If
    End If
End Sub

Private Sub vsAdvice_KeyPress(KeyAscii As Integer)
    Dim objEdit As Object
    Dim lngDiag As Long
    
    If KeyAscii = 13 Then
        '定位到对应的编辑控件
        KeyAscii = 0
        Select Case vsAdvice.Col
            Case COL_开始时间
                If msk开始时间.TabStop Then
                    Set objEdit = msk开始时间 '缺省不定位到开始时间
                Else
                    Set objEdit = txt医嘱内容
                End If
            Case col_医嘱内容
                Set objEdit = txt医嘱内容
            Case COL_标本部位
                Set objEdit = txt安排时间
            Case COL_单量
                Set objEdit = txt单量
            Case COL_天数
                Set objEdit = txt天数
            Case COL_总量
                Set objEdit = txt总量
            Case COL_用法
                Set objEdit = txt用法
            Case COL_频率
                Set objEdit = txt频率
            Case COL_执行时间
                Set objEdit = cbo执行时间
            Case COL_执行科室ID
                Set objEdit = cbo执行科室
            Case COL_医生嘱托
                Set objEdit = cbo医生嘱托
            Case COL_标志
                Set objEdit = chk紧急
            Case COL_超量说明
                Set objEdit = txt超量说明
            Case COL_用药目的
                Set objEdit = cboDruPur
            Case COL_用药理由
                Set objEdit = txt用药理由
        End Select
        If Not objEdit Is Nothing Then
            If objEdit.Enabled And objEdit.Visible Then objEdit.SetFocus
        End If
    End If
End Sub

Private Sub ClearItemTag()
'功能：清除控件编辑标志
    msk开始时间.Tag = ""
    txt安排时间.Tag = ""
    txt单量.Tag = ""
    txt天数.Tag = ""
    txt总量.Tag = ""
    txt用法.Tag = ""
    txt频率.Tag = ""
    cbo执行时间.Tag = ""
    cbo医生嘱托.Tag = ""
    cbo执行科室.Tag = ""
    cbo执行性质.Tag = ""
    cbo附加执行.Tag = ""
    chk紧急.Tag = ""
    chk免试.Tag = ""
    cbo滴速.Tag = ""
    chkZeroBilling.Tag = ""
    lbl用药目的.Tag = ""
    txt用药理由.Tag = ""
    txt超量说明.Tag = ""
    lbl超量说明.Tag = ""
    txtBYZX.Tag = ""
End Sub

Private Sub SetStartTime(ByVal Editable As Boolean)
'功能：设置开始时间是否允许编辑
    'msk开始时间.TabStop = Editable '缺省不定位到开始时间
    msk开始时间.Enabled = Editable
    cmd开始时间.Enabled = Editable
    If Editable Then
        msk开始时间.BackColor = vsAdvice.BackColor
    Else
        msk开始时间.BackColor = &HE0E0E0
    End If
End Sub

Private Sub SetDayState(Optional ByVal intVisible As Integer, Optional ByVal intEnabled As Integer)
'功能：设置执行天数可用和或见状态
'参数：0-保持不变,-1-禁止,1-允许
    If intEnabled = -1 Then
        txt天数.Enabled = False
        txt天数.BackColor = Me.BackColor
        txt天数.Text = ""
    ElseIf intEnabled = 1 Then
        txt天数.TabStop = True
        txt天数.Enabled = True
        txt天数.BackColor = vsAdvice.BackColor
    End If
    
    If intVisible = -1 Then
        lbl天数.Visible = False
        txt天数.Visible = False
        txt天数.Text = ""
        
        lbl总量.Left = lbl用法.Left + lbl用法.Width - lbl总量.Width
        txt总量.Left = txt用法.Left
        txt总量.Width = txt用法.Width - cmd用法.Width - 250
        lbl总量单位.Left = txt总量.Left + txt总量.Width + 30
        
        lbl单量.Left = lbl频率.Left + lbl频率.Width - lbl单量.Width
        txt单量.Left = txt频率.Left
        txt单量.Width = txt频率.Width - cmd频率.Width - 15
        lbl单量单位.Left = txt单量.Left + txt单量.Width + 30
        
        txt总量.TabIndex = cmd频率.TabIndex + 1
        txt天数.TabIndex = txt总量.TabIndex + 1
        txt单量.TabIndex = txt天数.TabIndex + 1
    ElseIf intVisible = 1 Then
        lbl天数.Visible = True
        txt天数.Visible = True
        
        lbl单量.Left = lbl用法.Left + lbl用法.Width - lbl单量.Width
        
        txt总量.Width = txt用法.Width / 2
        txt单量.Width = txt总量.Width
        '解决字重叠问题
        Call zlControl.SetPubCtrlPos(False, 0, lbl单量, 30, txt单量, 30, lbl单量单位, 180, lbl天数, -1 * (txt天数.Width + Me.TextWidth("字")), txt天数, 360, lbl总量, 30, txt总量, 3, lbl总量单位)
        
        txt单量.TabIndex = cmd频率.TabIndex + 1
        txt天数.TabIndex = txt单量.TabIndex + 1
        txt总量.TabIndex = txt天数.TabIndex + 1
    End If
End Sub

Private Sub SetItemEditable(Optional int单量 As Integer, Optional int总量 As Integer, _
    Optional int用法 As Integer, Optional int频率 As Integer, _
    Optional int执行时间 As Integer, Optional int执行科室 As Integer, _
    Optional int执行性质 As Integer, Optional int附加执行 As Integer, _
    Optional int安排时间 As Integer, Optional int滴速 As Integer, _
    Optional int用药目的 As Integer, Optional int用药理由 As Integer, _
    Optional int超量说明 As Integer, Optional int输血原因 As Integer, Optional int本院执行 As Integer)
'功能：设置指定编辑项的可用状态
'参数：0-保持不变,-1-禁止,1-允许,2-锁定
'说明：禁止时,同时清除该项目数据(不是全部)

    '依次设置为禁止时,会引发焦点改变,从而可能引发Validate事件,所以先禁止焦点顺序
    If int单量 = -1 Then txt单量.TabStop = False
    If int总量 = -1 Then txt总量.TabStop = False
    If int用法 = -1 Then txt用法.TabStop = False
    If int频率 = -1 Then txt频率.TabStop = False
    If int执行时间 = -1 Then cbo执行时间.TabStop = False
    If int执行科室 = -1 Then cbo执行科室.TabStop = False
    If int执行性质 = -1 Then cbo执行性质.TabStop = False
    If int附加执行 = -1 Then cbo附加执行.TabStop = False
     
    If int用药目的 = -1 Then cboDruPur.TabStop = False
    If int用药理由 = -1 Then txt用药理由.TabStop = False
    
    If int单量 = -1 Then
        txt单量.Enabled = False
        txt单量.BackColor = Me.BackColor
        txt单量.Text = ""
        lbl单量单位.Caption = "" '"单位"
    ElseIf int单量 = 1 Then
        txt单量.TabStop = True
        txt单量.Enabled = True
        txt单量.BackColor = vsAdvice.BackColor
    End If

    If int总量 = -1 Then
        txt总量.Enabled = False
        txt总量.BackColor = Me.BackColor
        txt总量.Text = ""
        lbl总量单位.Caption = "" '"单位"
    ElseIf int总量 = 1 Then
        txt总量.TabStop = True
        txt总量.Enabled = True
        txt总量.BackColor = vsAdvice.BackColor
    End If
    
    If int用法 = -1 Then
        txt用法.Enabled = False
        txt用法.BackColor = Me.BackColor
        txt用法.Text = ""
        cmd用法.Enabled = False
        lbl用法.Caption = "用法"
    ElseIf int用法 = 1 Then
        txt用法.TabStop = True
        txt用法.Enabled = True
        cmd用法.Enabled = True
        txt用法.BackColor = vsAdvice.BackColor
    End If

    If int频率 = -1 Then
        txt频率.Enabled = False
        cmd频率.Enabled = False
        txt频率.BackColor = Me.BackColor
        txt频率.Text = ""
    ElseIf int频率 = 1 Then
        txt频率.TabStop = True
        txt频率.Enabled = True
        cmd频率.Enabled = True
        txt频率.BackColor = vsAdvice.BackColor
    End If

    If int执行时间 = -1 Then
        cbo执行时间.Text = ""
        cbo执行时间.Enabled = False
        cbo执行时间.BackColor = Me.BackColor
        cbo执行时间.Clear
    ElseIf int执行时间 = 1 Then
        cbo执行时间.TabStop = True
        cbo执行时间.Enabled = True
        cbo执行时间.BackColor = vsAdvice.BackColor
    End If

    If int执行科室 = -1 Then
        lbl执行科室.Caption = "执行科室"
        cbo执行科室.Enabled = False
        cbo执行科室.BackColor = Me.BackColor
        cbo执行科室.Clear
    ElseIf int执行科室 = 1 Then
        lbl执行科室.Caption = "执行科室"
        cbo执行科室.TabStop = True
        cbo执行科室.Enabled = True
        cbo执行科室.BackColor = vsAdvice.BackColor
    End If

    If int执行性质 = -1 Then
        cbo执行性质.Enabled = False
        cbo执行性质.BackColor = Me.BackColor
        Call Cbo.SetIndex(cbo执行性质.hwnd, -1) '不清除
    ElseIf int执行性质 = 1 Then
        cbo执行性质.TabStop = True
        cbo执行性质.Enabled = True
        cbo执行性质.BackColor = vsAdvice.BackColor
    End If
    
    If int附加执行 = -1 Then
        lbl附加执行.Caption = "附加执行"
        cbo附加执行.Enabled = False
        cbo附加执行.BackColor = Me.BackColor
        cbo附加执行.Clear
    ElseIf int附加执行 = 1 Then
        lbl附加执行.Caption = "附加执行"
        cbo附加执行.TabStop = True
        cbo附加执行.Enabled = True
        cbo附加执行.BackColor = vsAdvice.BackColor
    End If
    
    If int安排时间 = -1 Then
        txt安排时间.Text = ""
        lbl安排时间.Visible = False
        txt安排时间.Visible = False
        cmd安排时间.Visible = False
        lbl用法.Visible = True
        txt用法.Visible = True
        cmd用法.Visible = True
    ElseIf int安排时间 = 1 Then
        lbl安排时间.Visible = True
        txt安排时间.Visible = True
        cmd安排时间.Visible = True
        lbl用法.Visible = False
        txt用法.Visible = False
        cmd用法.Visible = False
    End If
    
    If int滴速 = -1 Then
        cbo滴速.Text = ""
        lbl滴速.Visible = False
        cbo滴速.Visible = False
        lbl滴速单位.Visible = False
    ElseIf int滴速 = 1 Then
        lbl滴速.Visible = True
        cbo滴速.Visible = True
        lbl滴速单位.Visible = True
    End If
    
    '缺省不选中
    If int用药目的 = -1 Then
        Call Cbo.SetIndex(cboDruPur.hwnd, 0)
        cboDruPur.Enabled = False
        cboDruPur.Visible = False
    ElseIf int用药目的 = 1 Then
        Call Cbo.SetIndex(cboDruPur.hwnd, 0)
        cboDruPur.Enabled = True
        cboDruPur.TabStop = True
        cboDruPur.Visible = True
    End If
        
    If int用药理由 = -1 Then
        txt用药理由.Text = ""   '没有隐藏，所以需要清空
        txt用药理由.Enabled = False
        txt用药理由.BackColor = Me.BackColor
        cmd收藏用药理由.Enabled = False
        cmdReason.Enabled = False
    ElseIf int用药理由 = 1 Then
        txt用药理由.Enabled = True
        txt用药理由.TabStop = True
        txt用药理由.BackColor = vsAdvice.BackColor
        cmd收藏用药理由.Enabled = True
        cmdReason.Enabled = True
    End If
    
    If int超量说明 = -1 Then
        txt超量说明.Text = ""   '没有隐藏，所以需要清空
        txt超量说明.Enabled = False
        txt超量说明.BackColor = Me.BackColor
        cmdExcReason.Enabled = False
        cmdComExcReason.Enabled = False
    ElseIf int超量说明 = 1 Then
        txt超量说明.Enabled = True
        txt超量说明.TabStop = True
        txt超量说明.BackColor = vsAdvice.BackColor
        cmdExcReason.Enabled = True
        cmdComExcReason.Enabled = True
    End If
    
    '=1输血医嘱，显示输血原因
    If int输血原因 = -1 Then
        lbl用药目的.Visible = True
        cmdReason.Visible = True
        cmd收藏用药理由.Visible = True
        lbl用药理由.Caption = "用药理由"
    ElseIf int输血原因 = 1 Then
        lbl用药目的.Visible = False
        cmdReason.Visible = False
        cmd收藏用药理由.Visible = False
        lbl用药理由.Caption = "输血原因"
    End If
    
    If int本院执行 = -1 Then
        txtBYZX.Visible = False
        lblBYZXCS.Visible = False
        lblBYZX.Visible = False
        txtBYZX.Enabled = False
        txtBYZX.Text = ""
    ElseIf int本院执行 = 1 Then
        txtBYZX.Visible = True
        lblBYZXCS.Visible = True
        lblBYZX.Visible = True
        txtBYZX.Enabled = True
        txtBYZX.TabStop = True
        txtBYZX.BackColor = vsAdvice.BackColor
    End If
End Sub

Private Function Get合同单位ID() As Long
'功能：获取当前病人的合同单位ID
    Dim rsTmp As ADODB.Recordset, strSQL As String
 
    strSQL = "Select Nvl(合同单位ID,0) as 合同单位ID From 病人信息 Where 病人ID = [1]"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID)
    
    If rsTmp.RecordCount > 0 Then Get合同单位ID = rsTmp!合同单位ID
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function Get诊断描述(ByVal lng诊断ID As Long, ByVal lng疾病ID As Long) As String
'功能：根据诊断ID或疾病ID获取字典表中的名称（病人诊断记录中的名称可以是修改后的,允许加前缀或后缀），以便再次修改时判断
    Dim rsTmp As ADODB.Recordset, strSQL As String
    
    On Error GoTo errH
    If lng诊断ID <> 0 Then
        strSQL = "Select 名称 From 疾病诊断目录 Where ID = [1]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, gstrSysName, lng诊断ID)
        If rsTmp.RecordCount > 0 Then Get诊断描述 = "" & rsTmp!名称
    ElseIf lng疾病ID <> 0 Then
        strSQL = "Select 名称 From 疾病编码目录 Where ID = [1]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, gstrSysName, lng疾病ID)
        If rsTmp.RecordCount > 0 Then Get诊断描述 = "" & rsTmp!名称
    End If
    
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function GetPatiInfo() As Boolean
'功能：读取病人信息
    Dim rsTmp As ADODB.Recordset
    Dim rsSub As ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim strTmp As String
    Dim blnMsgOk As Boolean
        Dim rsPath As Recordset
    
    On Error GoTo errH
    
    strSQL = "Select A.ID,a.急诊,a.复诊,A.姓名,A.性别,A.年龄,B.出生日期,B.门诊号,B.费别,B.医疗付款方式," & _
        " Nvl(D.预交余额,0)-Nvl(D.费用余额,0) as 预交款,B.险类,B.就诊诊室,A.登记时间," & _
        " A.执行部门ID as 病人科室ID,b.身份证号,b.就诊卡号,A.路径状态 " & _
        " From 病人挂号记录 A,病人信息 B,病人余额 D" & _
        " Where A.NO=[1] And a.记录性质=1 And a.记录状态=1 And A.病人ID+0=[2]" & _
        " And A.病人ID=B.病人ID And B.病人ID=D.病人ID(+) And D.性质(+)=1 And D.类型(+) = 1"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mstr挂号单, mlng病人ID)
    
    lblPati.Caption = "病人:" & rsTmp!姓名 & " " & NVL(rsTmp!性别) & " " & NVL(rsTmp!年龄) & "  就诊卡号:" & rsTmp!就诊卡号 & _
        "　费别:" & NVL(rsTmp!费别) & "　医疗付款方式:" & NVL(rsTmp!医疗付款方式) & "　预交款:" & Format(NVL(rsTmp!预交款, 0), "0.00")
    
    lblPati.Tag = rsTmp!姓名 '用于医嘱复制提示
    
    '病人的准确年龄:用于判断
    mlng挂号ID = rsTmp!ID
    
    If mblnPass Then
        mdbl门诊号 = NVL(rsTmp!门诊号, 0)
    End If
    
    mint年龄 = GetPatiYear(mlng病人ID)
    If IsNull(rsTmp!出生日期) Then
        mDat出生日期 = DateAdd("yyyy", -mint年龄, zlDatabase.Currentdate)
    Else
        mDat出生日期 = rsTmp!出生日期
    End If
    mstr姓名 = rsTmp!姓名
    mstr身份证号 = "" & rsTmp!身份证号
    
    mdbl预交款 = Format(NVL(rsTmp!预交款, 0), "0.00")
    mstr性别 = NVL(rsTmp!性别)
    mstr费别 = NVL(rsTmp!费别)
    mdat挂号时间 = rsTmp!登记时间
    mlng病人科室id = rsTmp!病人科室id
    mstr付款码 = Get医疗付款码(NVL(rsTmp!医疗付款方式))
    mbln性质中医 = Sys.DeptHaveProperty(rsTmp!病人科室id, "中医科")
    mbln录中医诊断 = Val(zlDatabase.GetPara("门诊西医科允许录入中医诊断", glngSys, p门诊医嘱下达, "0")) = 1
    mbln中医 = mbln性质中医 Or mbln录中医诊断
    If Not mbln性质中医 And mbln录中医诊断 Then
        COL中医 = 2
        COL西医 = 1
    Else
        COL中医 = 1
        COL西医 = 2
    End If
    mbytPatiType = IIF(Val(NVL(rsTmp!急诊)) = 0, 1, 2)
    mbln复诊 = Val(rsTmp!复诊 & "") <> 0
    strSQL = "Select 状态 From 病人门诊路径 Where 病人ID=[1] and 科室ID=[2] order by 导入时间 desc"
    Set rsPath = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng病人科室id)
    If rsPath.RecordCount > 0 Then mlng路径状态 = Val(rsPath!状态 & "")
    optState(IIF(mbln复诊, 1, 0)).Tag = "1"
    optState(IIF(mbln复诊, 1, 0)).value = True
    optState(0).TabStop = False
    optState(1).TabStop = False
    
    '路径病人信息加载
    If mlng路径状态 = 1 And mbytUseType = 0 Then
        Set mrsPPati = GetPatiOutPathInfo(mlng病人ID, mlng病人科室id)
    End If
    'PASS 传人病人信息
    If mblnPass Then
        Call zlPASSPati
    End If
    
    '保险病人用红色显示
    mint险类 = 0
    If Not IsNull(rsTmp!险类) Then
        mint险类 = rsTmp!险类
        lblPati.ForeColor = vbRed
    End If
    mbln提醒对码 = True
    
    strSQL = "select a.关系,b.姓名,b.性别,b.年龄,b.就诊卡号 from 病人家属 a,病人信息 b where a.家属id=b.病人id and a.病人id=[1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID)
    mint家属 = rsTmp.RecordCount
    If mint家属 = 1 Then
        lblFamily.Caption = rsTmp!关系 & ":" & rsTmp!姓名 & " " & rsTmp!性别 & " " & rsTmp!年龄 & "  就诊卡号:" & rsTmp!就诊卡号
    ElseIf mint家属 > 1 Then
        lblFamily.Caption = "家属:"
        lblFamilyTmp.Caption = "家属信息(" & mint家属 & "人)"
    End If
    
    lblFamily.Visible = mint家属 > 0
    lblFamilyTmp.Visible = mint家属 > 1
    
    GetPatiInfo = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub SetDiagType(ByVal lngRow As Long, ByVal int诊断类型 As Integer)
'功能：设置某一诊断行的诊断类型
    With vsDiag
        .TextMatrix(lngRow, COL中医) = "中"
        .TextMatrix(lngRow, COL西医) = "西"
        
        .Cell(flexcpData, lngRow, COL中医) = IIF(int诊断类型 = 11, 1, 0)
        .Cell(flexcpForeColor, lngRow, COL中医) = IIF(int诊断类型 = 11, .ForeColor, .GridColor)
        .Cell(flexcpFontBold, lngRow, COL中医) = IIF(int诊断类型 = 11, True, False)
        
        .Cell(flexcpData, lngRow, COL西医) = IIF(int诊断类型 = 1, 1, 0)
        .Cell(flexcpForeColor, lngRow, COL西医) = IIF(int诊断类型 = 1, .ForeColor, .GridColor)
        .Cell(flexcpFontBold, lngRow, COL西医) = IIF(int诊断类型 = 1, True, False)
    End With
End Sub

Private Sub LoadDiagInfo()
    Dim rsTmp As ADODB.Recordset
    Dim rsSub As ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim strTmp As String
    Dim blnMsgOk As Boolean
    
    On Error GoTo errH
    '诊断对应医嘱
    strSQL = "Select B.诊断ID,B.医嘱ID From 病人诊断记录 A,病人诊断医嘱 B" & _
        " Where A.ID=B.诊断ID And A.记录来源=3 And A.诊断类型 IN(1,11) And A.取消时间 is Null And A.病人ID=[1] And A.主页ID=[2]"
    Set rsSub = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng挂号ID)
    Set mrsAD = zlDatabase.CopyNewRec(rsSub)
    
    '病人诊断信息
    strSQL = "Select A.ID,A.记录来源,A.诊断次序,A.诊断类型,A.疾病ID,A.诊断ID,A.证候ID,A.诊断描述,A.是否疑诊, a.记录日期, a.记录人,B.编码 as ICD码,c.编码 as 诊断编码,d.编码 as 证候编码,A.发病时间," & _
        " b.附码 As 疾病附码, b.类别 As 疾病类别,d.名称 As 证候名称 From 病人诊断记录 A,疾病编码目录 B, 疾病诊断目录 C,疾病编码目录 D" & _
        " Where A.疾病ID=B.ID(+)  And a.诊断id = c.Id(+) And  a.证候ID=d.ID(+)  And A.记录来源 IN(1,3) And A.诊断类型 IN(1,11)" & _
        " And A.取消时间 is Null And A.病人ID=[1] And A.主页ID=[2]" & _
        " Order by A.诊断类型,A.诊断次序,a.编码序号"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng挂号ID)
    If Not mclsMipModule Is Nothing Then
        blnMsgOk = mclsMipModule.IsConnect
    End If
    
    If blnMsgOk Then
        Set mrs诊断 = New ADODB.Recordset
        mrs诊断.Fields.Append "id", adBigInt
        mrs诊断.Fields.Append "显示编码", adVarChar, 120
        mrs诊断.Fields.Append "诊断编码", adVarChar, 120
        mrs诊断.Fields.Append "疾病编码", adVarChar, 120
        mrs诊断.Fields.Append "状态", adBigInt '0-原始记录，1-被修改，2-新增的记录
        mrs诊断.CursorLocation = adUseClient
        mrs诊断.LockType = adLockOptimistic
        mrs诊断.CursorType = adOpenStatic
        mrs诊断.Open
    End If
    
    If Not rsTmp.EOF Then
        '西医诊断
        rsTmp.Filter = "记录来源=3 " & IIF(Not mbln中医, " And 诊断类型=1", "") '首页本身填写的
        If rsTmp.EOF Then rsTmp.Filter = "记录来源<>3" & IIF(Not mbln中医, " And 诊断类型=1", "") '其它来源的作为缺省显示
        With vsDiag
            Set mrsDiag = zlDatabase.CopyNewRec(rsTmp)
            If Not rsTmp.EOF Then
                .Rows = rsTmp.RecordCount + 1
                For i = 1 To rsTmp.RecordCount
                    Call SetDiagType(i, rsTmp!诊断类型)
                    
                    If IsNull(rsTmp!诊断描述) Then
                        .TextMatrix(i, col编码) = ""
                        .TextMatrix(i, col诊断) = ""
                    Else
                        If Mid(rsTmp!诊断描述, 1, 1) <> "(" Or (Val(rsTmp!诊断id & "") = 0 And Val(rsTmp!疾病id & "") = 0) Then '中医的诊断描述后面加了（候症），所以只判断第一个字符
                            '由于疾病编码和诊断可以对应，如果两个都不为空的时候，先判断疾病编码，先取疾病编码
                            If Val(rsTmp!疾病id & "") <> 0 Then
                                .TextMatrix(i, col编码) = NVL(rsTmp!ICD码)
                            ElseIf Val(rsTmp!诊断id & "") <> 0 Then
                                .TextMatrix(i, col编码) = NVL(rsTmp!诊断编码)
                            Else
                                .TextMatrix(i, col编码) = ""
                            End If
                            .TextMatrix(i, col诊断) = rsTmp!诊断描述
                        Else
                            .TextMatrix(i, col编码) = Mid(rsTmp!诊断描述, 2, InStr(rsTmp!诊断描述, ")") - 2)
                            .TextMatrix(i, col诊断) = Mid(rsTmp!诊断描述, InStr(rsTmp!诊断描述, ")") + 1)
                        End If
                    End If
                    
                    '取证候名称
                    If InStr(.TextMatrix(i, col诊断), "(") > 0 And InStr(.TextMatrix(i, col诊断), ")") > 0 And Val(rsTmp!诊断类型 & "") = 11 Then
                        strTmp = Mid(.TextMatrix(i, col诊断), InStrRev(.TextMatrix(i, col诊断), "(") + 1)
                        strTmp = Mid(strTmp, 1, Len(strTmp) - 1)
                        '先取证候
                        .TextMatrix(i, col中医证候) = strTmp
                        '去掉诊断描述的证候
                        .TextMatrix(i, col诊断) = Mid(.TextMatrix(i, col诊断), 1, InStrRev(.TextMatrix(i, col诊断), "(") - 1)
                    Else
                       .TextMatrix(i, col中医证候) = ""
                    End If
                    If Not IsNull(rsTmp!疾病id) Or Not IsNull(rsTmp!诊断id) Then
                        .Cell(flexcpData, i, col诊断) = Get诊断描述(Val("" & rsTmp!诊断id), Val("" & rsTmp!疾病id))    '获取原始名称以便修改时判断
                    Else
                        .Cell(flexcpData, i, col诊断) = .TextMatrix(i, col诊断)
                    End If
                    
                    .Cell(flexcpData, i, col标志) = .Cell(flexcpData, i, col诊断) '存储原始诊断信息
                    .Cell(flexcpData, i, col疑诊) = Val(NVL(rsTmp!是否疑诊, 0))
                    .Cell(flexcpForeColor, i, col疑诊) = IIF(NVL(rsTmp!是否疑诊, 0) = 1, vbRed, .GridColor)
                    .TextMatrix(i, col诊断ID) = NVL(rsTmp!诊断id, 0)
                    .Cell(flexcpData, i, col诊断ID) = NVL(rsTmp!ID, 0)
                    .TextMatrix(i, col疾病ID) = NVL(rsTmp!疾病id, 0)
                    .TextMatrix(i, col证候ID) = NVL(rsTmp!证候id, 0)
                    .TextMatrix(i, colICD码) = NVL(rsTmp!ICD码)
                    .TextMatrix(i, col发病时间) = Format(rsTmp!发病时间 & "", "YYYY-MM-DD HH:mm")
                  
                    .TextMatrix(i, COL诊断编码) = NVL(rsTmp!诊断编码)
                    .TextMatrix(i, COL疾病编码) = NVL(rsTmp!ICD码)
                    .TextMatrix(i, COL疾病类别) = NVL(rsTmp!疾病类别)
                    .TextMatrix(i, COL疾病附码) = NVL(rsTmp!疾病附码)
                    .TextMatrix(i, COL证候编码) = NVL(rsTmp!证候编码)
                    
                    If blnMsgOk Then
                        mrs诊断.AddNew
                        mrs诊断!ID = rsTmp!ID
                        mrs诊断!显示编码 = .TextMatrix(i, col编码)
                        mrs诊断!诊断编码 = .TextMatrix(i, COL诊断编码)
                        mrs诊断!疾病编码 = .TextMatrix(i, COL疾病编码)
                        mrs诊断!状态 = 0
                        mrs诊断.Update
                    End If
                    
                    '填写对应的关联医嘱
                    strSQL = ""
                    rsSub.Filter = "诊断ID=" & rsTmp!ID
                    Do While Not rsSub.EOF
                        strSQL = strSQL & "," & rsSub!医嘱ID
                        rsSub.MoveNext
                    Loop
                    .TextMatrix(i, col医嘱ID) = Mid(strSQL, 2)
                    .RowData(i) = Val(rsTmp!ID)
                    rsTmp.MoveNext
                Next
                Call vsDiag_AfterRowColChange(-1, -1, .Rows - 1, col诊断)
            End If
        End With
        rsTmp.Filter = 0
        rsTmp.Sort = "ID desc"
        mlngDSeq = 1 + rsTmp!ID
    Else
        vsDiag.Rows = vsDiag.FixedRows + 1
        Call SetDiagType(1, IIF(mbln性质中医, 11, 1))
        mlngDSeq = 1
    End If
    
    '西医时只输入西医诊断
    vsDiag.ColHidden(COL中医) = Not mbln中医
    vsDiag.ColHidden(COL西医) = Not mbln中医
    vsDiag.ColHidden(col中医证候) = Not mbln中医
    vsDiag.ColWidth(col诊断) = IIF(mbln中医, 2760, 4360)
    vsDiag.ColHidden(colDel) = False
    vsDiag.ColWidth(colDel) = vsDiag.ColWidth(COL增加)
    
    vsDiag.Col = col诊断: vsDiag.Row = vsDiag.Rows - 1
    Call SetDiagHeight
    'PASS诊断传人
    If mblnPass Then
        zlPassDrugs
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function GetPreRow(ByVal lngRow As Long) As Long
'功能：取上一最近有效可见行
'返回：无有效行时,返回-1
    Dim lngTmp As Long, i As Long
    
    lngTmp = -1
    For i = lngRow - 1 To vsAdvice.FixedRows Step -1
        If vsAdvice.RowData(i) <> 0 And Not vsAdvice.RowHidden(i) Then
            lngTmp = i: Exit For
        End If
    Next
    GetPreRow = lngTmp
End Function

Private Function GetNextRow(ByVal lngRow As Long) As Long
'功能：取下一最近有效可见行
'返回：无有效行时,返回-1
    Dim lngTmp As Long, i As Long
    
    lngTmp = -1
    For i = lngRow + 1 To vsAdvice.Rows - 1
        If vsAdvice.RowData(i) <> 0 And Not vsAdvice.RowHidden(i) Then
            lngTmp = i: Exit For
        End If
    Next
    GetNextRow = lngTmp
End Function

Private Function GetDefaultTime(lngRow As Long) As String
'功能：获取新开医嘱的缺省开始时间
'说明：
'      最近一条有效时间为当天，且间隔现在在补录间隔以内
'      如果没有,则取最近新开一条的时间
'      如果没有,则取当前时间
    Dim curDate As Date, strDate As String, i As Long
    
    curDate = zlDatabase.Currentdate
    
    With vsAdvice
        '先从当前行向回找
        For i = lngRow - 1 To .FixedRows Step -1
            If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_开始时间)) Then
                If Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd") = Format(curDate, "yyyy-MM-dd") Then
                    If DateAdd("n", gint门诊新开医嘱间隔, CDate(.Cell(flexcpData, i, COL_开始时间))) >= curDate Then
                        strDate = Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd HH:mm")
                        Exit For
                    End If
                End If
            End If
        Next
            
        '再从最后行向回找
        If strDate = "" Then
            For i = .Rows - 1 To lngRow + 1 Step -1
                If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_开始时间)) Then
                    If Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd") = Format(curDate, "yyyy-MM-dd") Then
                        If DateAdd("n", gint门诊新开医嘱间隔, CDate(.Cell(flexcpData, i, COL_开始时间))) >= curDate Then
                            strDate = Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd HH:mm")
                            Exit For
                        End If
                    End If
                End If
            Next
        End If
        
        If strDate = "" Then
            '先从当前行向回找
            For i = lngRow - 1 To .FixedRows Step -1
                If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_开始时间)) _
                    And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                    strDate = Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd HH:mm")
                    Exit For
                End If
            Next
            '再从最后行向回找
            If strDate = "" Then
                For i = .Rows - 1 To lngRow + 1 Step -1
                    If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_开始时间)) _
                        And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                        strDate = Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd HH:mm")
                        Exit For
                    End If
                Next
            End If
        End If
    End With
    If strDate = "" Then strDate = Format(curDate, "yyyy-MM-dd HH:mm")
    GetDefaultTime = strDate
End Function

Private Function GetCurRow序号(lngRow As Long, Optional ByVal lngNo As Long) As Long
'功能：获取指定行可用的的序号
'参数：lngRow=要取序号的行
'      lngNo 申请序号，在申请单方式下医嘱时用到
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, lng序号 As Long, i As Long
    Dim lng序号1 As Long, lng序号2 As Long
            
    '取之后最近一个有效序号,直接使用
    For i = lngRow + 1 To vsAdvice.Rows - 1
        If vsAdvice.RowData(i) <> 0 Then
            If Val(vsAdvice.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex _
                And IsNumeric(vsAdvice.TextMatrix(i, COL_序号)) Then
                lng序号 = Val(vsAdvice.TextMatrix(i, COL_序号))
                Exit For
            End If
        End If
    Next
    If lng序号 = 0 Then
        '后面没有,则取数据库之中的最大序号与之前的最大序号比较
        On Error GoTo errH
        strSQL = "Select Max(序号) as 序号 From 病人医嘱记录 Where 病人ID+0=[1] And 挂号单=[2] And Nvl(婴儿,0)=[3]"
        
        If lngNo <> 0 Then strSQL = strSQL & " and nvl(申请序号,0)<>[4]"

        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mstr挂号单, cbo婴儿.ListIndex, lngNo)
        If Not rsTmp.EOF Then lng序号1 = NVL(rsTmp!序号, 0)
        On Error GoTo 0
        
        For i = lngRow - 1 To vsAdvice.FixedRows Step -1
            If vsAdvice.RowData(i) <> 0 Then
                If Val(vsAdvice.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex _
                    And IsNumeric(vsAdvice.TextMatrix(i, COL_序号)) Then
                    lng序号2 = Val(vsAdvice.TextMatrix(i, COL_序号))
                    Exit For
                End If
            End If
        Next
        
        If lng序号1 > lng序号2 Then
            lng序号 = lng序号1
        Else
            lng序号 = lng序号2
        End If

        If lng序号 <> 0 Then lng序号 = lng序号 + 1 '最大序号+1
    End If
    If lng序号 = 0 Then lng序号 = 1
    GetCurRow序号 = lng序号
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub AdviceSet医嘱序号(lngRow As Long, intStep As Integer)
'功能：将当前病人医嘱记录中序号前移或后移
'参数：lngRow=起始调整行,intStep=调整步长,如1或-1
    Dim i As Long
    
    For i = lngRow To vsAdvice.Rows - 1
        If vsAdvice.RowData(i) <> 0 Then
            If Val(vsAdvice.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex _
                And IsNumeric(vsAdvice.TextMatrix(i, COL_序号)) Then
                vsAdvice.TextMatrix(i, COL_序号) = Val(vsAdvice.TextMatrix(i, COL_序号)) + intStep
                If Val(vsAdvice.TextMatrix(i, COL_EDIT)) = 0 Then
                    vsAdvice.TextMatrix(i, COL_EDIT) = 3 '标志修改了序号
                End If
            End If
        End If
    Next
End Sub

Private Sub AdviceDelete(ByVal lngRow As Long)
'功能：指定的医嘱删除处理
    Dim lngBegin As Long, lngEnd As Long
    Dim lng相关ID As Long, blnGroup As Boolean
    Dim lng医嘱ID As Long, i As Integer
    Dim str诊断IDs As String, lng审核状态 As Long
    
    mblnRowChange = False
    vsAdvice.Redraw = flexRDNone
    
    If vsAdvice.RowData(lngRow) <> 0 Then
        '调用删除前外挂接口
        On Error Resume Next
        If Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            If CreatePlugInOK(p门诊医嘱下达, mint场合) Then
                If gobjPlugIn.AdviceDeletBefor(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, Val(vsAdvice.RowData(lngRow)), mint场合) = False Then
                    If err.Number = 0 Then Exit Sub
                End If
                Call zlPlugInErrH(err, "AdviceDeletBefor")
            End If
        End If
        If err.Number <> 0 Then err.Clear
        On Error GoTo 0
        
        If InStr(",5,6,", vsAdvice.TextMatrix(lngRow, COL_类别)) > 0 Then
            lng医嘱ID = vsAdvice.RowData(lngRow)
            lng相关ID = Val(vsAdvice.TextMatrix(lngRow, COL_相关ID))
            blnGroup = RowIn一并给药(lngRow)
            If blnGroup Then
                '先删除一并给药中的空行(一定要删)
                Call Get一并给药范围(lng相关ID, lngBegin, lngEnd)
                For i = lngEnd To lngBegin Step -1 '必须反向
                    If vsAdvice.RowData(i) = 0 Then Call DeleteRow(i)
                Next
                
                '删除之后当前行号可能变了
                lngRow = vsAdvice.FindRow(lng医嘱ID, lngBegin)
                    
                '一并给药只删除当前行
                Call AdviceHaveDiag(lngRow, 0, str诊断IDs) '记录这一行的关联诊断
                lng审核状态 = Val(vsAdvice.TextMatrix(lngRow, COL_审核状态))
                Call DeleteRow(lngRow)
                
                If lng审核状态 <> 0 Then
                    lngRow = vsAdvice.FindRow(lng相关ID, lngBegin)
                    Call ReSet审核状态图标(lngRow)
                End If
            Else
                '单独的成药：删除给药途径行及当前行
                i = vsAdvice.FindRow(CLng(vsAdvice.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                Call DeleteRow(i)
                Call DeleteRow(lngRow)
            End If
        ElseIf InStr(",D,F,K,", vsAdvice.TextMatrix(lngRow, COL_类别)) > 0 Then
            Call Delete检查手术输血(lngRow)
            Call DeleteRow(lngRow)
        ElseIf RowIn配方行(lngRow) Then
            '删除组成味药及煎法行:删除之后重新定位的当前行
            lngRow = Delete中药配方(lngRow)
            '删除当前行(中药用法行)
            Call DeleteRow(lngRow)
        ElseIf RowIn检验行(lngRow) Then
            lngRow = Delete检验组合(lngRow)
            Call DeleteRow(lngRow)
        Else
            Call DeleteRow(lngRow)
        End If
        
        mblnNoSave = True '标记为未保存
    Else
        '空行直接删除
        Call DeleteRow(lngRow)
    End If
    
    '重新定位行
    If vsAdvice.RowHidden(vsAdvice.Row) Then
        i = GetPreRow(vsAdvice.Row)
        If i = -1 Then i = GetNextRow(vsAdvice.Row)
        If i <> -1 Then vsAdvice.Row = i
    End If
    
    '恢复一并给药的诊断关联
    i = vsAdvice.FindRow(lng相关ID)
    If i <> -1 Then
        Call SetDiagFlag(i, 1, str诊断IDs) '当前行也应是恢复在一并给药中的
    End If
 
    If blnGroup Then Call SetTag一并给药(vsAdvice.Row)
    Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
    
    mblnRowChange = True
    vsAdvice.Redraw = flexRDDirect
    Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
End Sub

Private Sub DeleteRow(ByVal lngRow As Long, Optional ByVal blnClear As Boolean, Optional blnDelID As Boolean = True)
'功能：删除表格中的一行,但不改变当前行
'参数：blnClear=是否仅清除该行内容,不删除
'      blnDelID=是否记录要删除的医嘱ID
    Dim lngCol As Long, blnDraw As Boolean, blnChange As Boolean
    Dim lngBegin As Long, lngEnd As Long, k As Long
    Dim strExtData As String
    
    With vsAdvice
        lngCol = .Col
        blnDraw = .Redraw
        blnChange = mblnRowChange
        
        mblnRowChange = False
        .Redraw = flexRDNone
        If mlng路径状态 <> 0 Then
            If Val(.TextMatrix(lngRow, COL_路径项目ID)) = 0 And InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                Call GetRowScope(lngRow, lngBegin, lngEnd)
                If lngBegin < lngRow And Val(.TextMatrix(lngBegin, COL_路径项目ID)) <> 0 Then   '路径外项目只能添加到一并给药的后面
                    For k = lngBegin To lngEnd - 1
                        If Val(.TextMatrix(k, COL_路径项目ID)) = 0 And k <> lngRow Then Exit For
                    Next
                    If k = lngEnd Then  '重设给药途径的路径相关信息
                        .TextMatrix(lngEnd, COL_路径项目ID) = .TextMatrix(lngBegin, COL_路径项目ID)
                        .TextMatrix(lngEnd, COL_路径执行ID) = .TextMatrix(lngBegin, COL_路径执行ID)
                        .TextMatrix(lngEnd, COL_路径执行方式) = .TextMatrix(lngBegin, COL_路径执行方式)
                        .TextMatrix(lngEnd, COL_路径项目分类) = .TextMatrix(lngBegin, COL_路径项目分类)
                    End If
                End If
            End If
        End If
        
        If .RowData(lngRow) <> 0 Then
            '调整序号
            Call AdviceSet医嘱序号(lngRow + 1, -1)
            
            '记录要删除的ID(除了才新增的)
            If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 And blnDelID Then
                If .TextMatrix(lngRow, COL_处方审查状态) = "1" Or .TextMatrix(lngRow, COL_处方审查状态) = "2" Then
                    If InStr("," & mstrAduitDelIDs & ",", "," & .TextMatrix(lngRow, COL_相关ID) & ",") = 0 And .TextMatrix(lngRow, COL_相关ID) <> "" Then
                        mstrAduitDelIDs = mstrAduitDelIDs & "," & .TextMatrix(lngRow, COL_相关ID)
                        mstrDelIDs = Replace(mstrDelIDs, "," & .TextMatrix(lngRow, COL_相关ID), "")
                    End If
                Else
                    mstrDelIDs = mstrDelIDs & "," & .RowData(lngRow)
                End If
                If .TextMatrix(lngRow, COL_类别) = "K" And gbln血库系统 Then
                    mstrDel输血 = mstrDel输血 & "," & .RowData(lngRow)
                End If
            End If
            '删除后关联诊断的标记处理：可能是增改一组医嘱时的部分行删除，没关系，增改后立即会再标记上
            Call SetDiagFlag(lngRow, 2, "")
        End If
            
        '如果为行1且仅剩行1或仅清除,则保留
        If Not (lngRow = .FixedRows And .Rows = .FixedRows + 1) And Not blnClear Then
            .RemoveItem lngRow
        Else
            If blnDelID = False Then strExtData = .TextMatrix(lngRow, COL_原始中药配方)
            '清除该行数据
            .RowData(lngRow) = Empty
            .Cell(flexcpText, lngRow, 0, lngRow, .Cols - 1) = "" '文字
            .Cell(flexcpData, lngRow, 0, lngRow, .Cols - 1) = Empty '数据
            .Cell(flexcpFontBold, lngRow, .FixedCols, lngRow, .Cols - 1) = False '粗体
            .Cell(flexcpForeColor, lngRow, .FixedCols, lngRow, .Cols - 1) = .ForeColor '文字色
            .Cell(flexcpForeColor, lngRow, 0, lngRow, .FixedCols - 1) = .ForeColorFixed '固定列文字色
            .Cell(flexcpBackColor, lngRow, 0, lngRow, .FixedCols - 1) = .BackColorFixed '固定列背景色
            Set .Cell(flexcpPicture, lngRow, 0, lngRow, .Cols - 1) = Nothing '单元图片
            Set .Cell(flexcpPicture, lngRow, COL_警示) = Nothing 'Pass警示灯
            If blnDelID = False Then .TextMatrix(lngRow, COL_原始中药配方) = strExtData
            '单元格边框
            .Select lngRow, .FixedCols, lngRow, COL_标志
            .CellBorder vbRed, 0, 0, 0, 0, 0, 0
        End If
        
        .Col = lngCol '因为有删除行,所以调用程序肯定有行定位,所以不必恢复行
        .Redraw = blnDraw
        mblnRowChange = blnChange
    End With
End Sub

Private Sub Delete检查手术输血(ByVal lngRow As Long, Optional ByVal bln申请序号 As Boolean, Optional ByRef lngTmpRow As Long)
'功能：1.删除检查组合项目的部位行
'      2.删除手术项目的附加手术行及麻醉项目行
'      3.删除输血项目的输血途径行
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim lngNo As Long
    Dim strRows As String
    Dim varArr As Variant
    Dim lngTmp As Long
    On Error GoTo errH
    With vsAdvice
        If bln申请序号 Then
            lngNo = Val(.TextMatrix(lngRow, COL_申请序号))
        End If
        If lngNo = 0 Then
            i = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), lngRow + 1, COL_相关ID) '不一定有,所以用查找
            If i <> -1 Then
                lngBegin = i
                For i = lngBegin To vsAdvice.Rows - 1
                    If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = vsAdvice.RowData(lngRow) Then
                        lngEnd = i
                    Else
                        Exit For
                    End If
                Next
                For i = lngEnd To lngBegin Step -1
                    Call DeleteRow(i)
                Next
            End If
        Else
            lngTmp = -1
            For i = .FixedRows To .Rows - 1
                If Val(.TextMatrix(i, COL_状态)) < 2 Then
                    If lngNo = Val(.TextMatrix(i, COL_申请序号)) Then
                        strRows = i & IIF(strRows = "", "", "," & strRows)
                    End If
                End If
                If i > lngRow Then
                    If lngNo <> Val(.TextMatrix(i, COL_申请序号)) Then
                        If lngTmp = -1 Then
                            lngTmp = vsAdvice.RowData(i)
                        End If
                    End If
                End If
            Next
            varArr = Split(strRows, ",")
            For i = 0 To UBound(varArr)
                Call DeleteRow(Val(varArr(i)))
            Next
            
            If lngTmp = -1 Then
                '先删除中间间隔的空行
                mblnRowChange = False
                For i = .Rows - 1 To .FixedRows Step -1
                    If .RowData(i) = 0 Then .RemoveItem i
                Next
                mblnRowChange = True
                .AddItem "", .Rows
                .Row = .Rows - 1
                .Col = .FixedCols
                lngTmpRow = .Row
            Else
                For i = .FixedRows To .Rows - 1
                    If lngTmp = Val(vsAdvice.RowData(i)) Then
                        lngTmp = i
                        Exit For
                    End If
                Next
                i = lngTmp
                If i <> -1 Then
                    .AddItem "", i
                    .Row = i
                    lngTmpRow = i
                Else
                    '先删除中间间隔的空行
                    mblnRowChange = False
                    For i = .Rows - 1 To .FixedRows Step -1
                        If .RowData(i) = 0 Then .RemoveItem i
                    Next
                    mblnRowChange = True
                    .AddItem "", .Rows
                    .Row = .Rows - 1
                    .Col = .FixedCols
                    lngTmpRow = .Row
                End If
            End If
        End If
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function Delete中药配方(ByVal lngRow As Long) As Long
'功能：删除中药配方的组成味药及煎法行
'参数：lngRow=中药配方用法行(可见)
'返回：删除之后重新定位的当前行(中药用法行)
    Dim lngBegin As Long, lngEnd As Long
    Dim lng医嘱ID As Long, i As Long
    
    lng医嘱ID = vsAdvice.RowData(lngRow)
    
    lngEnd = lngRow - 1
    For i = lngEnd To vsAdvice.FixedRows Step -1
        If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = lng医嘱ID Then
            lngBegin = i
        Else
            Exit For
        End If
    Next
    
    mblnRowChange = False
    For i = lngEnd To lngBegin Step -1
        Call DeleteRow(i)
    Next
    
    '因为是在前面删除,需要重新定位到中药用法行
    i = vsAdvice.FindRow(lng医嘱ID)
    vsAdvice.Row = i '不可能找不到
    
    mblnRowChange = True
    
    Delete中药配方 = vsAdvice.Row
End Function
 
Private Sub Delete检验申请单(ByVal lngRow As Long, Optional ByVal bln申请序号 As Boolean, Optional ByRef lngTmpRow As Long)
'功能：1.删除检查组合项目的部位行
'      2.删除手术项目的附加手术行及麻醉项目行
'      3.删除输血项目的输血途径行
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim lngNo As Long
    Dim strRows As String
    Dim varArr As Variant
    Dim lngTmp As Long
    On Error GoTo errH
    With vsAdvice
        If bln申请序号 Then
            lngNo = Val(.TextMatrix(lngRow, COL_申请序号))
        End If
        If lngNo = 0 Then
            lngTmpRow = Delete检验组合(lngRow)
        Else
            lngTmp = -1
            For i = .FixedRows To .Rows - 1
                If Val(.TextMatrix(i, COL_状态)) < 2 Then
                    If lngNo = Val(.TextMatrix(i, COL_申请序号)) Then
                        strRows = i & IIF(strRows = "", "", "," & strRows)
                    End If
                End If
                If i > lngRow Then
                    If lngNo <> Val(.TextMatrix(i, COL_申请序号)) Then
                        If lngTmp = -1 Then
                            lngTmp = vsAdvice.RowData(i)
                        End If
                    End If
                End If
            Next
            varArr = Split(strRows, ",")
            For i = 0 To UBound(varArr)
                Call DeleteRow(Val(varArr(i)))
            Next
            
            If lngTmp = -1 Then
                '先删除中间间隔的空行
                mblnRowChange = False
                For i = .Rows - 1 To .FixedRows Step -1
                    If .RowData(i) = 0 Then .RemoveItem i
                Next
                mblnRowChange = True
                .AddItem "", .Rows
                .Row = .Rows - 1
                .Col = .FixedCols
                lngTmpRow = .Row
            Else
                For i = .FixedRows To .Rows - 1
                    If lngTmp = Val(vsAdvice.RowData(i)) Then
                        lngTmp = i
                        Exit For
                    End If
                Next
                i = lngTmp
                If i <> -1 Then
                    .AddItem "", i
                    .Row = i
                    lngTmpRow = i
                Else
                    '先删除中间间隔的空行
                    mblnRowChange = False
                    For i = .Rows - 1 To .FixedRows Step -1
                        If .RowData(i) = 0 Then .RemoveItem i
                    Next
                    mblnRowChange = True
                    .AddItem "", .Rows
                    .Row = .Rows - 1
                    .Col = .FixedCols
                    lngTmpRow = .Row
                End If
            End If
        End If
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function Delete检验组合(ByVal lngRow As Long) As Long
'功能：删除一并采集的多个检验项目行
'参数：lngRow=采集方法行(可见)
'返回：删除之后重新定位的当前行(采集方法行)
    Dim lngBegin As Long, lngEnd As Long
    Dim lng医嘱ID As Long, i As Long
    
    lng医嘱ID = vsAdvice.RowData(lngRow)
    
    lngEnd = lngRow - 1
    For i = lngEnd To vsAdvice.FixedRows Step -1
        If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = lng医嘱ID Then
            lngBegin = i
        Else
            Exit For
        End If
    Next
    
    mblnRowChange = False
    For i = lngEnd To lngBegin Step -1
        Call DeleteRow(i)
    Next
    
    '因为是在前面删除,需要重新定位到采集方法行
    i = vsAdvice.FindRow(lng医嘱ID)
    vsAdvice.Row = i '不可能找不到
    mblnRowChange = True
    Delete检验组合 = vsAdvice.Row
End Function

Private Function Get检查部位方法(ByVal lngRow As Long) As String
'功能：获取指定行的检查部位方法串
'参数：lngRow=检查医嘱的可见行
'返回："部位名1;方法名1,方法名2|部位名2;方法名1,方法名2|...<vbTab>0-常规/1-床旁/2-术中"
'      如果是老的检查组合方式，或者是以前的单部位检查，则返回空以便程序识别
    Dim str部位 As String, str部位Last As String
    Dim str方法 As String, i As Long
    
    With vsAdvice
        For i = lngRow + 1 To .Rows - 1
            If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                If Val(.TextMatrix(i, COL_诊疗项目ID)) <> Val(.TextMatrix(lngRow, COL_诊疗项目ID)) Then Exit Function '老的方式
                
                If .TextMatrix(i, COL_标本部位) <> "" Then
                    If .TextMatrix(i, COL_标本部位) <> str部位Last And str部位Last <> "" Then
                        str部位 = str部位 & "|" & str部位Last & IIF(str方法 <> "", ";" & Mid(str方法, 2), "")
                        str方法 = ""
                    End If
                    If .TextMatrix(i, COL_检查方法) <> "" Then
                        str方法 = str方法 & "," & .TextMatrix(i, COL_检查方法)
                    End If
                    
                    str部位Last = .TextMatrix(i, COL_标本部位)
                End If
            Else
                Exit For
            End If
        Next
        If str部位Last <> "" Then
            str部位 = str部位 & "|" & str部位Last & IIF(str方法 <> "", ";" & Mid(str方法, 2), "")
        End If
        Get检查部位方法 = Mid(str部位, 2) & vbTab & Val(.TextMatrix(lngRow, COL_执行标记))
    End With
End Function

Private Function Get手术附加IDs(ByVal lngRow As Long) As String
'功能：获取指定手术行的附加手术及麻醉项目ID串
'返回："手术ID1,手术ID2,...;麻醉ID",其中可能没有附加手术和麻醉
    Dim strTmp As String, lng麻醉ID As Long, i As Long
    
    i = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), lngRow + 1, COL_相关ID)
    If i <> -1 Then
        For i = i To vsAdvice.Rows - 1
            If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = vsAdvice.RowData(lngRow) Then
                If vsAdvice.TextMatrix(i, COL_类别) = "G" Then
                    lng麻醉ID = Val(vsAdvice.TextMatrix(i, COL_诊疗项目ID))
                Else
                    strTmp = strTmp & "," & Val(vsAdvice.TextMatrix(i, COL_诊疗项目ID))
                End If
            Else
                Exit For
            End If
        Next
    End If
    Get手术附加IDs = Mid(strTmp, 2) & ";" & IIF(lng麻醉ID = 0, "", lng麻醉ID)
End Function

Private Function Get中药配方IDs(ByVal lngRow As Long) As String
'功能：获取中药配方的组成味药及煎法ID串
'返回："中药ID1,单量1,脚注1;中药ID2,单量2,脚注2;...|煎法ID"
    Dim lng煎法ID As Long, str中药IDs As String, i As Long, lng形态 As Long
    Dim lng付数 As Long, lng药房ID As Long
    Dim strTmp As String
    
    With vsAdvice
        lng形态 = Val(.TextMatrix(lngRow, COL_中药形态))    '用法行
        For i = lngRow - 1 To .FixedRows Step -1
            If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                If .TextMatrix(i, COL_类别) = "E" Then
                    lng煎法ID = Val(.TextMatrix(i, COL_诊疗项目ID))
                    strTmp = .TextMatrix(i, COL_标本部位) '代表中药的 煎量
                ElseIf .TextMatrix(i, COL_类别) = "7" Then
                    str中药IDs = Val(.TextMatrix(i, COL_收费细目ID)) & "," & _
                        .TextMatrix(i, COL_单量) & "," & .TextMatrix(i, COL_医生嘱托) & _
                        ";" & str中药IDs
                    If lng药房ID = 0 Then
                        lng药房ID = .TextMatrix(i, COL_执行科室ID)
                        lng付数 = .TextMatrix(i, COL_总量)
                    End If
                End If
            Else
                Exit For
            End If
        Next
        Get中药配方IDs = Mid(str中药IDs, 1, Len(str中药IDs) - 1) & "|" & lng煎法ID & "|" & lng形态 & "|" & lng付数 & "|" & lng药房ID & "|" & strTmp
    End With
End Function

Private Function Get检验组合IDs(ByVal lngRow As Long) As String
'功能：获取一并采集的检验组合项目ID及标本
'返回："'      检验组合="项目ID1,项目ID2,...;检验标本" 如果是新版LIS的模式则是："项目ID1|指标1|指标2...,项目ID2|指标1|指标2...,...;检验标本""
    Dim str项目IDs As String, str标本 As String, i As Long
    Dim j As Long
    
    With vsAdvice
        For i = lngRow - 1 To .FixedRows Step -1
            If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                If Val(.TextMatrix(i, COL_组合项目ID)) = 0 And mblnNewLIS Then
                    For j = lngRow - 1 To .FixedRows Step -1
                        If Val(.TextMatrix(j, COL_相关ID)) = .RowData(lngRow) Then
                            If Val(.TextMatrix(j, COL_组合项目ID)) = Val(.TextMatrix(i, COL_诊疗项目ID)) And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                                str项目IDs = "|" & Val(.TextMatrix(j, COL_诊疗项目ID)) & str项目IDs
                            End If
                        Else
                            Exit For
                        End If
                    Next
                    str项目IDs = "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & str项目IDs
                Else
                    If Not mblnNewLIS Then
                        str项目IDs = "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & str项目IDs
                    End If
                End If
                str标本 = .TextMatrix(i, COL_标本部位)
            Else
                Exit For
            End If
        Next
    End With
    Get检验组合IDs = Right(str项目IDs, Len(str项目IDs) - 1) & ";" & str标本
End Function

Private Function RowIn检验行(ByVal lngRow As Long) As Boolean
'功能：判断指定行是否属于检验组合中的一行
'说明：不管行当前是否隐藏
    If lngRow = -1 Then Exit Function
    If vsAdvice.RowData(lngRow) = 0 Then Exit Function
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_类别) = "E" And Val(.TextMatrix(lngRow, COL_相关ID)) = 0 Then
            '采集方法行
            If .TextMatrix(lngRow - 1, COL_类别) = "C" _
                And Val(.TextMatrix(lngRow - 1, COL_相关ID)) = .RowData(lngRow) Then
                RowIn检验行 = True: Exit Function
            End If
        ElseIf .TextMatrix(lngRow, COL_类别) = "C" And Val(.TextMatrix(lngRow, COL_相关ID)) <> 0 Then
            '检验项目行
            RowIn检验行 = True: Exit Function
        End If
    End With
End Function

Private Function RowIn配方行(ByVal lngRow As Long) As Boolean
'功能：判断指定行是否属于中药配方中的一行
'说明：不管行当前是否隐藏
    If lngRow = -1 Then Exit Function
    If vsAdvice.RowData(lngRow) = 0 Then Exit Function
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_类别) = "E" Then
            If Val(.TextMatrix(lngRow, COL_相关ID)) = 0 Then
                '用法行
                If Val(.TextMatrix(lngRow - 1, COL_相关ID)) = .RowData(lngRow) _
                    And .TextMatrix(lngRow - 1, COL_类别) = "E" Then
                    RowIn配方行 = True: Exit Function
                End If
            Else
                '煎法行
                If .TextMatrix(lngRow - 1, COL_类别) = "7" _
                    And Val(.TextMatrix(lngRow - 1, COL_相关ID)) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                    RowIn配方行 = True: Exit Function
                End If
            End If
        ElseIf .TextMatrix(lngRow, COL_类别) = "7" And Val(.TextMatrix(lngRow, COL_相关ID)) <> 0 Then
            '中药行
            RowIn配方行 = True: Exit Function
        End If
    End With
End Function

Private Function RowIn一并给药(ByVal lngRow As Long) As Boolean
'功能：判断指定行是否在一并给药的范围中
'参数：lngRow=可见的行,可能是空行
'说明：一并给药的范围中可能存在空行
    Dim lngPreRow As Long, lngNextRow As Long
    Dim lng相关ID As Long, blnGroup As Boolean, i As Long
    
    lngPreRow = GetPreRow(lngRow)
    lngNextRow = GetNextRow(lngRow)
    
    With vsAdvice
        If .RowData(lngRow) = 0 Then
            If lngPreRow <> -1 And lngNextRow <> -1 Then
                If Val(.TextMatrix(lngPreRow, COL_相关ID)) = Val(.TextMatrix(lngNextRow, COL_相关ID)) _
                    And Val(.TextMatrix(lngPreRow, COL_相关ID)) <> 0 _
                    And InStr(",5,6,", .TextMatrix(lngPreRow, COL_类别)) > 0 _
                    And InStr(",5,6,", .TextMatrix(lngNextRow, COL_类别)) > 0 Then
                    blnGroup = True
                End If
            End If
        ElseIf InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 _
            And Val(.TextMatrix(lngRow, COL_相关ID)) <> 0 Then
            
            lng相关ID = Val(.TextMatrix(lngRow, COL_相关ID))
            If lngPreRow <> -1 Then
                If InStr(",5,6,", .TextMatrix(lngPreRow, COL_类别)) > 0 _
                    And Val(.TextMatrix(lngPreRow, COL_相关ID)) = lng相关ID Then blnGroup = True
            End If
            If Not blnGroup And lngNextRow <> -1 Then
                If InStr(",5,6,", .TextMatrix(lngNextRow, COL_类别)) > 0 _
                    And Val(.TextMatrix(lngNextRow, COL_相关ID)) = lng相关ID Then blnGroup = True
            End If
        End If
    End With
    RowIn一并给药 = blnGroup
End Function

Private Function AdviceSet过敏试验(ByVal lngRow As Long, ByVal lng皮试ID As Long) As Boolean
'功能：自动增加皮试行
'参数：lngRow=当前输入行,已经输入西药或中成药
'      lng皮试ID=要增加的皮试项目ID
'说明：自动增加之后,当前行及光标仍定位在已刚输入的药品行位置
    Dim rsInput As New ADODB.Recordset
    Dim strSQL As String, i As Long
    
    On Error GoTo errH
        
    '类别ID,名称,诊疗项目ID,收费细目ID,规格,产地
    strSQL = "Select 类别 as 类别ID,名称,ID as 诊疗项目ID,NULL as 收费细目ID,NULL as 规格,NULL as 产地,NULL as 项目特性 From 诊疗项目目录 Where ID=[1]"
    Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng皮试ID)
        
    '寻找实际要加入皮试的行:一并给药的情况
    With vsAdvice
        For i = lngRow - 1 To .FixedRows - 1 Step -1 '可能是增加在最前面
            If Val(.TextMatrix(i, COL_相关ID)) <> Val(.TextMatrix(lngRow, COL_相关ID)) Then
                lngRow = i + 1: Exit For '新增行的行号
            End If
        Next
    End With
    
    '加入空行
    vsAdvice.AddItem "", lngRow
    
    '增加皮试
    Call AdviceInput(rsInput, lngRow, True)
    
    '重新定位到输入的药品行
    mblnRowChange = False
    vsAdvice.Row = vsAdvice.Row + 1
    mblnRowChange = True
    
    AdviceSet过敏试验 = True
    Exit Function
errH:
    If ErrCenter = 1 Then Resume
    Call SaveErrLog
End Function

Private Function AdviceInput(rsInput As ADODB.Recordset, ByVal lngRow As Long, Optional ByVal blnBy皮试 As Boolean) As Boolean
'功能：根据新输的诊疗项目(新增或更换)设置缺省的医嘱数据
'参数：rsInput=输入或选择返回的记录集,lngRow=当前输入行,blnBy皮试=是否自动增加皮试输入
'返回：本次录入是否有效
    Dim str过敏 As String, blnGroup As Boolean, i As Long
    Dim lng用法ID As Long, lngGroupRow As Long, lngRowID As Long
    Dim lng皮试ID As Long, bln皮试行 As Boolean
    Dim lngPreRow As Long, lngNextRow As Long
    Dim strExtData As String, strAppend As String
    Dim intType As Integer, str摘要 As String, lng审核状态 As Long, str摘要Out As String
    Dim strMsg As String, vMsg As VbMsgBoxResult
    Dim objControl As CommandBarControl
    Dim lngPreRow中药房 As Long, lng药品ID As Long
    Dim blnOK As Boolean
    Dim t_Pati As TYPE_PatiInfoEx
    Dim str手术部位 As String
    Dim strIDs1 As String, strIDs2 As String, str医嘱内容 As String
    Dim lngBegin As Long, lngEnd As Long, sng天数 As Single
    Dim lngAppType As Long '申请单应用
    Dim objAppPages()  As clsApplicationData
    Dim rsCard As ADODB.Recordset
    Dim lngTmpRow As Long
    Dim str诊断IDs As String
    Dim bln备血 As Boolean '是否为备血医嘱 备血=0，用血=1,存于K类别医嘱行的 检查方法  字段;备血-采集方式 / 用血-输血途径
    Dim strWhere As String
        Dim lngApplyID As Long
    
    On Error GoTo errH
        
    lngPreRow = GetPreRow(lngRow) '取上一有效行,某些内容缺省与上一行相同
    lngNextRow = GetNextRow(lngRow) '取下一有效行
  
    '项目附加数据输入及输入合法性检查
    '---------------------------------------------------------------------------------------------------------------
    txt医嘱内容.Text = rsInput!名称 '暂时显示
    
    '药品处方职务检查(护士站在保存时检查)
    If InStr(",5,6,7,", rsInput!类别ID) > 0 Then
        strMsg = CheckOneDuty(rsInput!名称, NVL(rsInput!处方职务ID), UserInfo.姓名, InStr(",1,2,", mstr付款码) > 0 And mstr付款码 <> "")
        If strMsg <> "" Then
            vsAdvice.Refresh
            MsgBox strMsg, vbInformation, gstrSysName
            vsAdvice.Refresh: Exit Function
        End If
        If mblnPass Then
            Call gobjPass.zlPassAdviceInput(mobjPassMap, rsInput!诊疗项目ID, rsInput!收费细目ID)
        End If
    End If
    With vsAdvice
        '检查是否存在有效的住院医嘱或留观医嘱
        If rsInput!类别ID = "Z" And InStr(",留观,住院,", "," & rsInput!项目特性 & ",") > 0 Then
            If CheckInHosAdvice Then
                Exit Function
            End If
        End If
        
        '医保病人输入内容时的提示：非医保病人也要调(Or And mint险类 <> 0)
        If InStr(",7,8,9,", rsInput!类别ID) = 0 Then '成套，配方，单味中药不在这里提示
             str摘要 = gclsInsure.GetItemInfo(mint险类, mlng病人ID, NVL(rsInput!收费细目ID, 0), "", 0, "", rsInput!诊疗项目ID & "||1")
        End If
    
        '检验项目：采集方法判断
        If rsInput!类别ID = "C" Then
            '所有数据中取一个缺省的采集方法,同时判断是否有采集方法数据
            lng用法ID = Get缺省用法ID(6, 1)
            If lng用法ID = 0 Then
                .Refresh
                MsgBox "没有可用的标本采集方法,请先到诊疗项目管理中设置！", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            '缺省与上一行相同
            If lngPreRow <> -1 Then
                If RowIn检验行(lngPreRow) Then
                    If Val(.TextMatrix(lngPreRow, COL_是否停用)) = 0 Then lng用法ID = Val(.TextMatrix(lngPreRow, COL_诊疗项目ID))
                End If
            End If
        End If
        
        '中药配方：给成与中药用法判断
        If InStr(",7,8,", rsInput!类别ID) > 0 Then
            If rsInput!类别ID = "8" Then
                If GetGroupCount(rsInput!诊疗项目ID, 1, False) = 0 Then
                    .Refresh
                    MsgBox """" & rsInput!名称 & """是一个中药配方，但没有设置有效的组成中药。" & vbCrLf & "请先到诊疗项目管理中设置。", vbInformation, gstrSysName
                    .Refresh: Exit Function
                End If
            
                '部份药无效的提示
                strMsg = GetGroupNone(rsInput!诊疗项目ID, 1)
                If strMsg <> "" Then
                    .Refresh
                    MsgBox "配方""" & rsInput!名称 & """中以下药品已撤档或服务对象不匹配：" & _
                        vbCrLf & vbCrLf & vbTab & strMsg & vbCrLf & vbCrLf & "这些药品将不会出现在配方中。", vbInformation, gstrSysName
                    .Refresh
                End If
            End If
        
            '所有数据中取一个缺省的中药用法,同时判断是否有中药用法数据
            lng用法ID = Get缺省用法ID(4, 1)
            If lng用法ID = 0 Then
                .Refresh
                MsgBox "没有可用的中药用(服)法,请先到诊疗项目管理中设置！", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            '中药用法缺省与上一行相同
            If RowIn配方行(lngPreRow) Then
                If Val(.TextMatrix(lngPreRow, COL_是否停用)) = 0 Then lng用法ID = Val(.TextMatrix(lngPreRow, COL_诊疗项目ID))
            End If
        End If
        
        '输血医嘱：输血途径判断
        If rsInput!类别ID = "K" Then
            If gbln血库系统 Then
                vMsg = frmMsgBox.ShowMsgBox("请选择输血医嘱类型。", Me, , 2)
                If vMsg = vbNo Then
                    bln备血 = True
                ElseIf vMsg = vbCancel Then
                    Exit Function
                End If
            Else
                bln备血 = True
            End If
            strWhere = ""
            If bln备血 = False And gbln血库系统 = True Then
                strWhere = " And NVL(执行分类,0)=1 "
            End If
            '所有数据中取一个缺省的输血途径
            lng用法ID = Get缺省用法ID(IIF(bln备血 And gbln血库系统, 9, 8), 2, strWhere)
            If lng用法ID = 0 Then
                .Refresh
                MsgBox "没有可用的输血" & IIF(bln备血 And gbln血库系统, "采集方法", "途径") & ",请先到诊疗项目管理中设置！", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            '缺省与上一行相同
            If lngPreRow <> -1 Then
                If .TextMatrix(lngPreRow, COL_类别) = "K" And Val(.TextMatrix(lngPreRow, COL_检查方法)) = IIF(bln备血, "0", "1") Then
                    i = .FindRow(CStr(.RowData(lngPreRow)), lngPreRow + 1, COL_相关ID)
                    If i <> -1 Then
                        If Val(.TextMatrix(i, COL_是否停用)) = 0 Then lng用法ID = Val(.TextMatrix(i, COL_诊疗项目ID))
                    End If
                End If
            End If
        End If
        
        '中西成药：给药途径判断
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
'            '所有数据中取一个缺省的给药途径,同时判断是否有给药途径数据
'            lng用法ID = Get缺省用法ID(2, 1)
'            If lng用法ID = 0 Then
'                .Refresh
'                MsgBox "没有可用的给药途径,请先到诊疗项目管理中设置！", vbInformation, gstrSysName
'                .Refresh: Exit Function
'            End If
            '给药途径缺省与上一个行相同剂型的相同
            If lngPreRow <> -1 And Not IsNull(rsInput!药品剂型) Then
                If InStr(",5,6,", .TextMatrix(lngPreRow, COL_类别)) > 0 And .TextMatrix(lngPreRow, COL_药品剂型) = NVL(rsInput!药品剂型) Then
                    i = .FindRow(CLng(.TextMatrix(lngPreRow, COL_相关ID)), lngPreRow + 1)
                    If i <> -1 Then
                        If Val(.TextMatrix(i, COL_是否停用)) = 0 Then lng用法ID = Val(.TextMatrix(i, COL_诊疗项目ID))
                    End If
                End If
            End If
        End If
        
        '中西成药：过敏试验检查
        If InStr(",5,6,", rsInput!类别ID) > 0 And gint过敏登记有效天数 <> 0 Then
            str过敏 = Check过敏试验(Me, txt医嘱内容, mlng病人ID, rsInput!诊疗项目ID, rsInput!名称, mbln自动皮试, lng皮试ID, , Val("" & rsInput!收费细目ID), , msk开始时间.Text, blnOK)
            If str过敏 <> "" Then
                .Refresh
                If blnOK Then
                    MsgBox str过敏, vbInformation, gstrSysName
                    .Refresh: Exit Function
                Else
                    If MsgBox(str过敏, vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                        .Refresh: Exit Function
                    End If
                End If
            End If
            
            '自动添加皮试
            If lng皮试ID <> 0 Then
                '先检查是否已有该皮试(在有效时间内手工或自动添加的,包括免试皮试)
                i = .FixedRows - 1
                Do
                    i = .FindRow(CStr(lng皮试ID), i + 1, COL_诊疗项目ID)
                    If i <> -1 Then
                        If Not .RowHidden(i) Then
                            If Int(CDate(.Cell(flexcpData, i, COL_开始时间))) >= Int(zlDatabase.Currentdate - gint过敏登记有效天数) Then
                                bln皮试行 = True: Exit Do '记录以作标志,当前行输入完成后再增加
                            End If
                        End If
                    End If
                Loop Until i = -1
            End If
        End If
        
        '中西成药：一并给药的判断,新行缺省是按下一并的（如果上一行是一并）
        blnGroup = RowIn一并给药(lngRow) And Not blnBy皮试
        If blnGroup Then
            If rsInput!类别ID = "9" Then
                .Refresh
                MsgBox "不能在一并给药的药品中直接输入成套方案。", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
        
            If .RowData(lngRow) = 0 Then
                '一并给药中的待输入空行：只有插入在一并给药的中间,才能自动成为一并给药
                lngGroupRow = lngPreRow
            Else
                '一并给药中的药品行：可能是第一行或最后一行'取当前行的下一行，避免在操作已有医嘱时重选诊疗项目操作时，当前行的内容被删除，后续过程无法取到其中的值
                If lngPreRow = -1 Then
                    lngGroupRow = vsAdvice.FindRow(.TextMatrix(lngRow, COL_相关ID), lngRow + 1, COL_相关ID)
                Else
                    If InStr(",5,6,", .TextMatrix(lngPreRow, COL_类别)) > 0 _
                        And Val(.TextMatrix(lngPreRow, COL_相关ID)) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                        lngGroupRow = lngPreRow
                    Else
                        lngGroupRow = lngNextRow
                    End If
                End If
            End If
            
            '一并给药的,类别，必须相同
            If Decode(rsInput!类别ID, "5", "Y", "6", "Y", "N") <> Decode(.TextMatrix(lngGroupRow, COL_类别), "5", "Y", "6", "Y", "N") Then
                .Refresh
                MsgBox "该组一并给药的药品必须都为西成药或中成药。", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            
            i = .FindRow(CLng(.TextMatrix(lngGroupRow, COL_相关ID)), lngGroupRow + 1)
            lng用法ID = Val(.TextMatrix(i, COL_诊疗项目ID)) '一并给药的给药途径相同
            
            '检查一并给药的的给药途径是否适合于当前输入药品(非一并给药的缺省用法在输入函数中作了判断处理)
            If Not Check适用用法(lng用法ID, rsInput!诊疗项目ID, 1, NVL(rsInput!收费细目ID, 0)) Then
                .Refresh
                MsgBox "一并的给药途径为""" & .TextMatrix(i, col_医嘱内容) & """，不适用于当前输入药品。", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            
        End If
    
        '成套项目
        If rsInput!类别ID = "9" Then
            If GetGroupCount(rsInput!诊疗项目ID, 1) = 0 Then
                .Refresh
                MsgBox """" & rsInput!名称 & """是一个成套方案，但没有设置有效的组成项目。" & vbCrLf & "请先到诊疗项目管理中设置。", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            strExtData = frmSchemeSelect.ShowMe(Me, rsInput!诊疗项目ID, 1, mlng病人科室id, mstr性别)
            If strExtData = "" Then .Refresh: Exit Function
        End If
    
        '需要输入更多数据的一些项目
        '---------------------------------------------------------------------------------------------------------------
        intType = -1
        lngAppType = -1
        If rsInput!类别ID <> "9" Then strExtData = ""
        If rsInput!类别ID = "D" Then
            '检查项目：都要扩展编辑了，不象以前还有单部位项目
            If gblnOut必用 And CanUseApply("D", Val(rsInput!诊疗项目ID & "")) Then
                lngAppType = 0
            Else
                intType = 0
            End If
        ElseIf rsInput!类别ID = "F" Then
            If gblnOut必用 And CanUseApply("F") Then
                lngAppType = 2
            Else
                '手术：需要输入麻醉项目，及可选择附加手术
                intType = 1
            End If
        ElseIf InStr(",7,8,", rsInput!类别ID) > 0 Then
            '中药配方(单味草药当配方处理)
            intType = 2
        ElseIf rsInput!类别ID = "C" Then
            If gblnOut必用 And CanUseApply("C", Val(rsInput!诊疗项目ID & ""), rsInput!编码 & "") Then
                lngAppType = 3
            Else
                '输入一并采集的多个检验项目及检验标本
                intType = 4
                strExtData = rsInput!诊疗项目ID & ";" & NVL(rsInput!规格) '项目;标本
            End If
        ElseIf rsInput!类别ID = "K" Or rsInput!类别ID = "E" Or rsInput!类别ID = "Z" Then
            If gblnOut必用 And CanUseApply(rsInput!类别ID) Then
                lngAppType = 1
            ElseIf CheckApplication(Val(rsInput!诊疗项目ID & ""), 1) Then
                '治疗和输血类的如果有申请附项则填写
                intType = 5
            End If
        End If
        '判断当前项目是否绑定有自定义申请单，如果有则弹出
        lngApplyID = GetApplyCustom(Val(rsInput!诊疗项目ID & ""))
        If intType <> -1 And lngApplyID = 0 Then
            With t_Pati
                .bln医保 = InStr(",1,2,", mstr付款码) > 0 And mstr付款码 <> ""
                .int险类 = mint险类
                .int婴儿 = mint婴儿
                .lng病人ID = mlng病人ID
                .lng病人科室ID = mlng病人科室id
                .str挂号单 = mstr挂号单
                .str性别 = mstr性别
            End With
            If intType = 2 Then
                lngPreRow中药房 = GetPreRow中药房(lngRow)
                lng药品ID = Val("" & rsInput!收费细目ID)   '一组配方时为空
            End If
            On Error Resume Next
            '改造接口：以前int场合传未传，现在传0，bytUseType以前未传，现在传0
            If intType = 2 Then
                blnOK = frmAdviceFormula.ShowMe(Me, gclsInsure, txt医嘱内容.hwnd, t_Pati, 0, 0, 1, 1, 1, rsInput!诊疗项目ID, strExtData, _
                             str摘要Out, lng药品ID, lngPreRow中药房, mstr药品价格等级)
            Else
                blnOK = frmAdviceEditEx.ShowMe(Me, txt医嘱内容.hwnd, t_Pati, 0, intType, 0, 1, 1, 1, mblnNewLIS, True, rsInput!诊疗项目ID, strExtData, _
                            strAppend, GetAdviceAppendItem, GetAdviceDiagnosis, str手术部位)
            End If
            
            On Error GoTo errH
            If intType = 2 Then str摘要 = str摘要Out
            If Not blnOK Then Exit Function
        End If
        
        If lngAppType <> -1 Or lngApplyID <> 0 Then
            On Error Resume Next
            If lngApplyID <> 0 Then
                FuncApplyCustom 0, lngApplyID, , Val(rsInput!诊疗项目ID & "")
            ElseIf lngAppType = 0 Then
                blnOK = ApplyNew检查申请(0, rsInput!诊疗项目ID & "", objAppPages())
            ElseIf lngAppType = 1 Then
                blnOK = ApplyNew输血申请(0, rsInput!诊疗项目ID & "", rsCard, bln备血)
            ElseIf lngAppType = 2 Then
                blnOK = ApplyNew手术申请(0, rsInput!诊疗项目ID & "", rsCard)
            ElseIf lngAppType = 3 Then
                blnOK = ApplyNew检验申请(0, rsInput!编码 & "", rsCard)
            End If
            On Error GoTo errH
            If Not blnOK Then Exit Function
        End If
        Call AdviceHaveDiag(lngPreRow, 0, str诊断IDs)
        '修改已有项目时,先删除当前医嘱的内容
        '---------------------------------------------------------------------------------------------------------------
        If .RowData(lngRow) <> 0 Then
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '西成药、中成药
                If Not blnGroup Then
                    '单个成药删除给药途径行,并清除当前行
                    i = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    Call DeleteRow(i)
                    Call DeleteRow(lngRow, True)
                Else
                    '一组成药时,只清除当前行
                    lng审核状态 = Val(vsAdvice.TextMatrix(lngRow, COL_审核状态))
                    Call DeleteRow(lngRow, True)
                    If lng审核状态 <> 0 Then Call ReSet审核状态图标(lngGroupRow)
                End If
            ElseIf InStr(",D,F,K,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '这个分支只处理检查申请单，因为检查申请单帮可能产生多组医嘱，检查申请单产生的医嘱加到表格最后
                If .TextMatrix(lngRow, COL_类别) = "D" And 0 <> Val(.TextMatrix(lngRow, COL_申请序号)) Then
                    Call Delete检查手术输血(lngRow, True, lngTmpRow)
                    lngRow = lngTmpRow
                Else
                    '检查组合项目，手术项目，输血医嘱
                    '删除部位行，或手术附加行(附加手术,麻醉项目)，或输血途径
                    Call Delete检查手术输血(lngRow)
                    '清除当前行
                    Call DeleteRow(lngRow, True)
                End If
            ElseIf RowIn配方行(lngRow) Then
                '中药配方：顺序(序号)要求必须严格控制
                '删除组成味药及煎法行:删除之后重新定位的当前行
                lngRow = Delete中药配方(lngRow)
                '清除当前行(中药用法行)
                Call DeleteRow(lngRow, True)
            ElseIf RowIn检验行(lngRow) Then
                If lngAppType = 3 Then
                    Call Delete检验申请单(lngRow, True, lngTmpRow)
                    lngRow = lngTmpRow
                Else
                    '删除检验项目行:删除之后重新定位的当前行
                    lngRow = Delete检验组合(lngRow)
                    '清除当前行(采集方法行)
                    Call DeleteRow(lngRow, True)
                End If
            Else
                '其它项目直接清除当前行内容
                Call DeleteRow(lngRow, True)
            End If
        End If
        
        '当前行新增医嘱
        '---------------------------------------------------------------------------------------------------------------
        If InStr(",7,8,", rsInput!类别ID) > 0 Then
            '中药配方(单味草药当配方处理):处理之后重新定位的当前行
            lngRow = AdviceSet中药配方(rsInput!诊疗项目ID, lngRow, lng用法ID, strExtData, , str摘要)
            If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
            '新增后关联诊断的标记处理
            Call SetDiagFlag(vsAdvice.Row, 1, str诊断IDs)
        ElseIf rsInput!类别ID = "9" Then
            '成套医嘱需要分解为多个项目加入
            Call AdviceSet成套项目(1, rsInput!诊疗项目ID, lngRow, strExtData)
            '新增后关联诊断的标记处理
            '成套和复制时在子过程中批量处理了
        ElseIf rsInput!类别ID = "C" Then
            If lngAppType = 3 Then
                Call AdviceSet检验申请(lngRow, rsCard, str诊断IDs)
            Else
                '检验组合
                lngRow = AdviceSet检验组合(lngRow, lng用法ID, strExtData, , str摘要)
                If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
                '新增后关联诊断的标记处理
                Call SetDiagFlag(vsAdvice.Row, 1, str诊断IDs)
            End If
        ElseIf lngAppType = 0 Then
            '加入检查申请单
            lngRow = AdviceSet检查申请(lngRow, objAppPages(), str诊断IDs)
        ElseIf lngAppType = 1 Then
            lngRow = AdviceSet输血申请(lngRow, rsCard, str诊断IDs)
        ElseIf lngAppType = 2 Then
            lngRow = AdviceSet手术申请(lngRow, rsCard, str诊断IDs)
        Else
            '输血医嘱检查，必须中级及以上专业技术职务的医师才允许下达
            If rsInput!类别ID & "" = "K" And gbln输血申请中级以上 Then
                If UserInfo.专业技术职务 <> "主治医师" And UserInfo.专业技术职务 <> "主任医师" And UserInfo.专业技术职务 <> "副主任医师" Then
                    MsgBox "启用了输血分级管理后，输血医嘱只有中级及以上专业技术职务医师才能下达。", vbInformation, Me.Caption
                    Exit Function
                End If
            End If
            '中、西成药，卫材，检查(组合)，手术(组合)，输血，及其它诊疗项目
            Call AdviceSet诊疗项目(rsInput, lngRow, lng用法ID, lngGroupRow, strExtData, str摘要, str手术部位, bln备血)
            
            If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
            '新增后关联诊断的标记处理
            Call SetDiagFlag(vsAdvice.Row, 1, str诊断IDs)
            
            '自动设置一并给药
            If InStr(",5,6,", rsInput!类别ID) > 0 Then
                i = CheckAutoMerge(lngRow)
                If i = 1 Then
                    mblnRowMerge = True
                ElseIf i = 2 Then
                    mblnRowMerge = False
                    Set objControl = cbsMain.FindControl(, conMenu_Merge, , True)
                    objControl.Checked = False
                End If
                If Not RowIn一并给药(lngRow) Then
                    If mblnRowMerge Then
                        '手工使一并给药
                        lngRowID = .RowData(lngRow)
                        Call SetDiagFlag(vsAdvice.Row, 2, "")
                        Call MergeRow(lngPreRow, lngRow) '本来就是显示当前行的内容,不用再强行RowChange
                        lngRow = .FindRow(lngRowID, lngPreRow + 1)
                        '抗菌药物新增一行时一并给药的，应该缺省与上一行的“用药目的”和“用药理由”相同。
                        If Val(.TextMatrix(lngRow, COL_抗菌等级)) <> 0 Then
                            If lngRow > 1 Then
                                txt用药理由.Text = .TextMatrix(lngRow - 1, COL_用药理由)
                                If Val(.TextMatrix(lngRow - 1, COL_用药目的)) <> 0 Then
                                    cboDruPur.ListIndex = Val(.TextMatrix(lngRow - 1, COL_用药目的))
                                End If
                            End If
                        End If
                        '新录入的药品一并给药时，如果没有启用天数录入参数，但用法用量指定了单量则自动反算总量，根据第一条医嘱的天数来反算
                        If Val(.TextMatrix(lngRow, COL_单量)) > 0 And mbln天数 = False Then
                            Call GetRowScope(lngRow, lngBegin, lngEnd)
                            If Val(.TextMatrix(lngBegin, COL_总量)) > 0 And Val(.TextMatrix(lngBegin, COL_单量)) > 0 And .TextMatrix(lngBegin, COL_频率) <> "" _
                                And Val(.TextMatrix(lngBegin, COL_频率次数)) <> 0 And Val(.TextMatrix(lngBegin, COL_频率间隔)) <> 0 _
                                And Val(.TextMatrix(lngBegin, COL_剂量系数)) <> 0 And Val(.TextMatrix(lngBegin, COL_门诊包装)) <> 0 Then
                                sng天数 = Calc缺省药品天数(Val(.TextMatrix(lngBegin, COL_总量)), Val(.TextMatrix(lngBegin, COL_单量)), _
                                                Val(.TextMatrix(lngBegin, COL_频率次数)), Val(.TextMatrix(lngBegin, COL_频率间隔)), .TextMatrix(lngBegin, COL_间隔单位), _
                                                Val(.TextMatrix(lngBegin, COL_剂量系数)), Val(.TextMatrix(lngBegin, COL_门诊包装)), _
                                                Val(.TextMatrix(lngBegin, COL_可否分零)))
                                .TextMatrix(lngRow, COL_总量) = ReGet药品总量(Val(.TextMatrix(lngRow, COL_总量)), Val(.TextMatrix(lngRow, COL_单量)), sng天数, lngRow)
                            End If
                        End If
                    ElseIf lngPreRow <> -1 Then
                        '自动使一并给药
                        Set objControl = cbsMain.FindControl(, conMenu_Merge, , True)
                        If objControl.Checked = True Then
                            If .TextMatrix(lngPreRow, COL_类别) = rsInput!类别ID Then
                                If RowIn一并给药(lngPreRow) And RowCanMerge(lngPreRow, lngRow) And GetNextRow(lngRow) = -1 Then
                                    mblnRowMerge = True
                                    cbsMain.RecalcLayout '即时刷新
                                    lngRowID = .RowData(lngRow)
                                    Call SetDiagFlag(vsAdvice.Row, 2, "")
                                    Call MergeRow(lngPreRow, lngRow, False)
                                    lngRow = .FindRow(lngRowID, lngPreRow + 1)
                                End If
                            End If
                        End If
                    End If
                Else
                    Call SetTag一并给药(lngRow)
                End If
            End If
        End If
        
        '更新附件内容:以当前可见行为准
        If strAppend <> "" Then
            .TextMatrix(.Row, COL_附项) = strAppend
            .Cell(flexcpData, .Row, COL_附项) = 1 '表明需要重新写入(新增或修改)
            Call ReplaceAdviceAppend(.Row) '缺省替换其他医嘱的申请附项
        End If
        
        '输入西药可成药时自动增加皮试行:增加之后仍定位在当前药品
        If lng皮试ID <> 0 And Not bln皮试行 Then
            Call AdviceSet过敏试验(.Row, lng皮试ID) '注意用当前行,因为一并之后定位改变
        End If
        
        '重新自动调整行高
        Call .AutoSize(col_医嘱内容)
    End With
    
    mblnNoSave = True '标记为未保存
    
    '对保险对码进行检查
    Call GetInsureStr(strIDs1, strIDs2, str医嘱内容, vsAdvice.Row)
    strMsg = CheckAdviceInsure(mint险类, mbln提醒对码, mlng病人ID, 1, strIDs1, strIDs2, str医嘱内容)
    If strMsg <> "" Then
        If gint医保对码 = 2 Then strMsg = strMsg & vbCrLf & vbCrLf & "请先和相关人员联系处理，否则医嘱将不允许保存。"
        vMsg = frmMsgBox.ShowMsgBox(strMsg, Me, True)
        If vMsg = vbIgnore Then mbln提醒对码 = False
    End If
    
    '调用外挂接口
    If CreatePlugInOK(p门诊医嘱下达, mint场合) Then
        If zlPluginAdviceEnter(vsAdvice.Row) = False Then
            vsAdvice.Refresh: Exit Function
        End If
    End If
    
    AdviceInput = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub zlPASSMap()
'功能:设置Pass VsAdvie及列映射
'注意:删除或修改下面列中数据时，请检查合理用药部件中的关联处理。
    If mobjPassMap Is Nothing Then
        Set mobjPassMap = DynamicCreate("zlPassInterface.clsPassMap", "合理用药监测", True)
        mblnPass = Not mobjPassMap Is Nothing And Not gobjPass Is Nothing
    End If
    
    If mblnPass Then
        With mobjPassMap
            .lngModel = PM_门诊编辑
            .int场合 = mint场合
            Set .frmMain = Me
            Set .vsAdvice = vsAdvice
            Set .objCmdBar = cmdAlley
            
            Set .diags = .GetDiags
            
            Set .VSCOL = .GetVSCOL(, COL_相关ID, COL_类别, _
                                COL_诊疗项目ID, COL_收费细目ID, col_医嘱内容, , COL_单量, COL_单量单位, COL_用法, COL_天数, COL_婴儿, COL_开嘱时间, COL_开嘱医生, _
                                COL_开始时间, COL_开嘱科室ID, , COL_频率, COL_频率次数, COL_频率间隔, COL_间隔单位, COL_警示, COL_序号, COL_状态, _
                                COL_EDIT, , , , COL_执行性质, COL_标本部位, , , , , , COL_总量, COL_门诊单位, COL_医生嘱托, COL_用药目的, COL_操作类型, _
                                COL_禁忌药品说明, COL_用药理由, COL_标志, COL_处方序号, COL_执行分类, COL_执行科室ID)
            Set .PassPati = .GetPatient()
            Call zlPASSPati
            mblnPass = gobjPass.zlPassCheck(mobjPassMap)
        End With
    End If
End Sub

Private Sub zlPASSPati()
'功能:设置病人信息
    If Not mobjPassMap Is Nothing Then
        With mobjPassMap.PassPati
            .int婴儿 = IIF(cbo婴儿.ListIndex = -1, 0, cbo婴儿.ListIndex)  '缺省新增病人为0
            .dbl标识号 = mdbl门诊号
            .Dat出生日期 = mDat出生日期
            .lng病人ID = mlng病人ID
            .lng挂号ID = mlng挂号ID
            .str挂号单 = mstr挂号单
            .str性别 = mstr性别
            .str姓名 = mstr姓名
        End With
    End If
End Sub

Private Sub zlPassDrugs()
'功能:设置病人诊断信息
    Dim i As Long
    Dim lng序号 As Long
    
    If Not mobjPassMap Is Nothing Then
        Set mobjPassMap.diags = Nothing '清空重新赋值
        Set mobjPassMap.diags = mobjPassMap.GetDiags
        With vsDiag
            lng序号 = .FixedRows
            For i = .FixedRows To .Rows - 1
                If .TextMatrix(i, col诊断) <> "" Then
                    mobjPassMap.diags.Add .TextMatrix(i, col诊断), .TextMatrix(i, COL诊断编码), .TextMatrix(i, COL疾病编码), "_" & lng序号
                    lng序号 = lng序号 + 1
                End If
            Next
        End With
    End If
End Sub

Private Sub MergeRow(ByVal lngRow1 As Long, ByVal lngRow2 As Long, Optional ByVal blnCheck As Boolean = True)
'功能：将两行设置为一并给药
'参数：lngRow1=前面行,可能本来已经属于一并给药
'      lngRow2=当前行
'说明：设置完成后,表格仍定位在原lngRow2的当前行
    Dim lngBegin As Long, lngEnd As Long
    Dim blnDo As Boolean, lngTmp As Long
    Dim str诊断IDs  As String
    Dim strTmp As String
 
    With vsAdvice
        If blnCheck Then
            blnDo = RowCanMerge(lngRow1, lngRow2)
        Else
            blnDo = True
        End If
        If blnDo Then
            mblnRowChange = False: .Redraw = flexRDNone
            
            '记录当前行的关联诊断,一并后以此为准，诊断也合并
            Call AdviceHaveDiag(lngRow1, 2, str诊断IDs)
            Call AdviceHaveDiag(lngRow2, 2, strTmp)
            
            str诊断IDs = str诊断IDs & IIF(strTmp = "", "", "," & strTmp)
            
            lngTmp = .RowData(lngRow2) '记录以再定位到当前行
            '先取消之前的一并给药
            If RowIn一并给药(lngRow1) Then
                Call Get一并给药范围(Val(.TextMatrix(lngRow1, COL_相关ID)), lngBegin, lngEnd)
                Call AdviceSet单独给药(lngBegin, lngEnd)
                lngRow1 = lngBegin
                lngRow2 = .FindRow(lngTmp, lngBegin + 1)
            End If
            Call AdviceSet一并给药(lngRow1, lngRow2)
            lngRow2 = .FindRow(lngTmp, lngBegin + 1)
            .Row = lngRow2
            
            '以一并之前的当前行为准恢复关联诊断
            '一并过程中前面的药品诊断关联已被DeleteRow移除
            Call SetDiagFlag(.Row, 1, str诊断IDs)
            mblnRowChange = True: .Redraw = flexRDDirect
        End If
    End With
End Sub

Private Sub SplitRow(ByVal lngRow As Long)
'功能：将指定行从一并给药中独立出来(该组一并给药必须至少包含三行)
'参数：lngRow=当前行,且为一并给药中的最后一药品行
'说明：设置完成后,表格仍定位在原lngRow的当前行
    Dim lngBegin As Long, lngEnd As Long, lngTmp As Long
    Dim k As Long
    
    With vsAdvice
        mblnRowChange = False: .Redraw = flexRDNone
        lngTmp = .RowData(lngRow) '记录用于恢复定位当前行
        Call Get一并给药范围(Val(.TextMatrix(lngRow, COL_相关ID)), lngBegin, lngEnd)
        
        '先取消整个的一并给药
        Call AdviceSet单独给药(lngBegin, lngEnd)
        
        '再设置除最后行外的行为一并给药
        lngRow = .FindRow(lngTmp, lngBegin + 1)
        lngEnd = GetPreRow(lngRow)
        Call AdviceSet一并给药(lngBegin, lngEnd)
        
        '恢复当前行
        lngRow = .FindRow(lngTmp, lngBegin + 1)
        .Row = lngRow
        If mlng路径状态 <> 0 Then
            If Val(.TextMatrix(lngRow, COL_路径项目ID)) = 0 And InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                Call GetRowScope(lngBegin, lngBegin, lngEnd)
                If lngBegin < lngRow And Val(.TextMatrix(lngBegin, COL_路径项目ID)) <> 0 Then   '路径外项目只能添加到一并给药的后面
                    For k = lngBegin To lngEnd - 1
                        If Val(.TextMatrix(k, COL_路径项目ID)) = 0 Then Exit For
                    Next
                    If k = lngEnd Then  '重设给药途径的路径相关信息
                        .TextMatrix(lngEnd, COL_路径项目ID) = .TextMatrix(lngBegin, COL_路径项目ID)
                        .TextMatrix(lngEnd, COL_路径执行ID) = .TextMatrix(lngBegin, COL_路径执行ID)
                        .TextMatrix(lngEnd, COL_路径执行方式) = .TextMatrix(lngBegin, COL_路径执行方式)
                        .TextMatrix(lngEnd, COL_路径项目分类) = .TextMatrix(lngBegin, COL_路径项目分类)
                    End If
                End If
            End If
        End If
        mblnRowChange = True: .Redraw = flexRDDirect
    End With
End Sub

Private Sub AdviceSet复制医嘱(ByVal lng病人ID As Long, ByVal str挂号单 As String, ByVal strIDs As String, Optional ByVal blnHistory As Boolean)
'功能：复制指定病人的指定医嘱产生成为新医嘱
'说明：可供外部调用,调用之前处于新增医嘱行
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, bln配方 As Boolean
    Dim lngBegin As Long, lngEnd As Long
    Dim curDate As Date, blnHide As Boolean
    Dim lng开嘱科室ID As Long, dbl相关ID As Double
    Dim lng序号 As Long, intCount As Integer
    Dim lngRow As Long
    Dim i As Long, j As Long
    Dim lng西药房ID As Long, lng成药房ID As Long, lng中药房ID As Long, lng发料部门ID As Long
    Dim str药房IDs As String, str附项 As String
    Dim bln药品小数输入 As Boolean
    Dim str高危药品 As String
    Dim str诊断IDs As String
    
    Screen.MousePointer = 11
    
    On Error GoTo errH
    
    strSQL = _
        " Select a.ID+0.1 As ID,Decode(a.相关id,Null,Null,a.相关id+0.1) As 相关id,Nvl(A.婴儿,0) as 婴儿,A.序号,A.医嘱期效," & _
        " A.医嘱状态,A.诊疗类别,A.诊疗项目ID,B.名称,A.标本部位,A.检查方法,A.执行标记,A.收费细目ID," & _
        " A.开始执行时间,Nvl(B.名称,A.医嘱内容) 医嘱内容,A.医生嘱托,A.单次用量,A.天数,A.总给予量,B.计算单位," & _
        " A.执行频次,A.频率次数,A.频率间隔,A.间隔单位,B.计算方式,B.执行频率,B.操作类型,B.执行分类," & _
        " B.计价性质,A.执行时间方案,Decode(nvl(Instr(',5,6,7,',a.诊疗类别),0),0,b.执行科室,a.执行性质) as 执行性质,A.执行科室ID,A.开嘱科室ID,A.开嘱医生,A.开嘱时间," & _
        " A.紧急标志,C.毒理分类,C.抗生素,C.药品剂型,B.录入限量,C.处方限量,C.处方职务," & _
        " D.剂量系数,D.门诊包装,D.门诊单位,F.计算单位 as 散装单位,E.跟踪在用,E.是否分零 as 卫材分零,D.门诊可否分零 As 可否分零,a.配方ID,c.临床自管药,d.高危药品,a.组合项目ID,c.溶媒,d.基本药物,d.是否易至跌倒" & _
        " From 病人医嘱记录 A,诊疗项目目录 B,药品特性 C,药品规格 D,材料特性 E,收费项目目录 F" & _
        " Where Nvl(A.医嘱期效,0)=1 And A.诊疗项目ID=B.ID" & _
        " And A.诊疗项目ID=C.药名ID(+) And A.收费细目ID=D.药品ID(+)" & _
        " And A.收费细目ID=E.材料ID(+) And E.材料ID=F.ID(+)" & _
        " And A.病人ID+0=[1] And A.挂号单=[2]" & _
        " And Instr([3],','||A.ID||',')>0" & _
        " Order by 婴儿,序号"
    If blnHistory Then
        strSQL = Replace(strSQL, "病人医嘱记录", "H病人医嘱记录")
    End If
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng病人ID, str挂号单, "," & strIDs & ",")
    On Error GoTo 0
    
    If Not rsTmp.EOF Then
        If rsTmp!诊疗类别 = "Z" And (rsTmp!操作类型 = "1" Or rsTmp!操作类型 = "2") Then
            If CheckInHosAdvice Then
                Screen.MousePointer = 0
                Exit Sub
            End If
        End If
        
        lngBegin = vsAdvice.Row '开始新增行
        lng序号 = GetCurRow序号(lngBegin) '起始序号
        intCount = 0 '已经设置的行数
        curDate = zlDatabase.Currentdate
        lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
        '药品总量是否可以输入小数，中药不可以输入小数，因此只检查西药与中成药
        bln药品小数输入 = InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") > 0
            
        mblnRowChange = False
        With vsAdvice
            .Redraw = flexRDNone
            
            Call AdviceHaveDiag(lngBegin - 1, 0, str诊断IDs) '复制医嘱时是添加了空行的
            
            For i = lngBegin To rsTmp.RecordCount + lngBegin - 1
                If i > lngBegin Then .AddItem "", i

                bln配方 = False
                
                .RowData(i) = -1 * rsTmp!ID
                If Not IsNull(rsTmp!相关ID) Then
                    .TextMatrix(i, COL_相关ID) = -1 * rsTmp!相关ID
                End If
                .TextMatrix(i, COL_序号) = lng序号 + intCount
                .TextMatrix(i, COL_EDIT) = 1 '新增
                .Cell(flexcpData, i, COL_EDIT) = CStr(lng病人ID & "," & str挂号单) '记录相关的复制项目
                .TextMatrix(i, COL_状态) = 1 '新开
                .TextMatrix(i, COL_婴儿) = cbo婴儿.ListIndex
                .TextMatrix(i, COL_类别) = rsTmp!诊疗类别
                .TextMatrix(i, COL_诊疗项目ID) = rsTmp!诊疗项目ID
                .TextMatrix(i, COL_名称) = rsTmp!名称
                .TextMatrix(i, COL_标本部位) = NVL(rsTmp!标本部位)
                .TextMatrix(i, COL_检查方法) = NVL(rsTmp!检查方法)
                .TextMatrix(i, COL_执行标记) = NVL(rsTmp!执行标记, 0)
                .TextMatrix(i, COL_收费细目ID) = NVL(rsTmp!收费细目ID)
                .TextMatrix(i, col_医嘱内容) = NVL(rsTmp!医嘱内容)
                .TextMatrix(i, COL_医生嘱托) = NVL(rsTmp!医生嘱托)
                .Cell(flexcpData, i, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, Val(.TextMatrix(i, COL_收费细目ID)), "", 0, "", .TextMatrix(i, COL_诊疗项目ID) & "||1")

                .TextMatrix(i, COL_计价性质) = NVL(rsTmp!计价性质, 0)
                .TextMatrix(i, COL_计算方式) = NVL(rsTmp!计算方式, 0)
                .TextMatrix(i, COL_频率性质) = NVL(rsTmp!执行频率, 0)
                .TextMatrix(i, COL_操作类型) = NVL(rsTmp!操作类型)
                .TextMatrix(i, COL_执行分类) = NVL(rsTmp!执行分类, 0)
                .TextMatrix(i, COL_毒理分类) = NVL(rsTmp!毒理分类)
                .TextMatrix(i, COL_抗菌等级) = Val("" & rsTmp!抗生素)
                .TextMatrix(i, COL_配方ID) = NVL(rsTmp!配方ID)
                .TextMatrix(i, COL_临床自管药) = rsTmp!临床自管药 & ""
                .TextMatrix(i, COL_组合项目ID) = rsTmp!组合项目ID & ""
                .TextMatrix(i, COL_高危药品) = Val(rsTmp!高危药品 & "")
                .TextMatrix(i, COL_易跌倒) = Val(rsTmp!是否易至跌倒 & "")
                .TextMatrix(i, COL_是否溶媒) = Val(rsTmp!溶媒 & "")
                .TextMatrix(i, COL_基本药物) = rsTmp!基本药物 & ""
                If Val(.TextMatrix(i, COL_高危药品)) <> 0 Then
                    str高危药品 = str高危药品 & vbCrLf & .TextMatrix(i, col_医嘱内容) & ":" & Decode(Val(.TextMatrix(i, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级；"
                End If
                
                .TextMatrix(i, COL_药品剂型) = NVL(rsTmp!药品剂型)
                If InStr(",5,6,7,", rsTmp!诊疗类别) > 0 Then
                    .TextMatrix(i, COL_处方限量) = NVL(rsTmp!处方限量)
                Else
                    .TextMatrix(i, COL_处方限量) = NVL(rsTmp!录入限量)
                End If
                .TextMatrix(i, COL_处方职务) = NVL(rsTmp!处方职务)
                
                If InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 Then
                    .TextMatrix(i, COL_剂量系数) = NVL(rsTmp!剂量系数)
                    .TextMatrix(i, COL_门诊包装) = NVL(rsTmp!门诊包装)
                    .TextMatrix(i, COL_门诊单位) = NVL(rsTmp!门诊单位)
                    If Not IsNull(rsTmp!剂量系数) Then
                        .TextMatrix(i, COL_可否分零) = NVL(rsTmp!可否分零, 0)
                    End If
                ElseIf .TextMatrix(i, COL_类别) = "4" Then
                    .TextMatrix(i, COL_剂量系数) = 1
                    .TextMatrix(i, COL_门诊包装) = 1
                    .TextMatrix(i, COL_门诊单位) = NVL(rsTmp!散装单位)
                    .TextMatrix(i, COL_跟踪在用) = NVL(rsTmp!跟踪在用)
                    .Cell(flexcpData, i, COL_可否分零) = NVL(rsTmp!卫材分零, 0)
                End If
                
                If IsDate(msk开始时间.Text) Then
                    .TextMatrix(i, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, i, COL_开始时间) = msk开始时间.Text
                    
                    '手术/输血时间：复制时缺省与开始时间相同,在标本部位处理后
                    If rsTmp!诊疗类别 = "K" Or rsTmp!诊疗类别 = "F" Or rsTmp!诊疗类别 = "G" _
                        And Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(i - 1, COL_相关ID)) Then
                        .TextMatrix(i, COL_手术时间) = msk开始时间.Text
                    End If
                End If
                
                .TextMatrix(i, COL_频率) = NVL(rsTmp!执行频次)
                .TextMatrix(i, COL_频率次数) = NVL(rsTmp!频率次数)
                .TextMatrix(i, COL_频率间隔) = NVL(rsTmp!频率间隔)
                .TextMatrix(i, COL_间隔单位) = NVL(rsTmp!间隔单位)
                .TextMatrix(i, COL_执行时间) = NVL(rsTmp!执行时间方案)
                
                .TextMatrix(i, COL_执行性质) = NVL(rsTmp!执行性质, 0)
                
                '处理执行科室
                If rsTmp!诊疗类别 = "Z" Then
                    .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID)
                ElseIf InStr(",0,5,", NVL(rsTmp!执行性质, 0)) = 0 Then
                    If NVL(rsTmp!执行科室ID, 0) <> 0 Then
                        If InStr(",5,6,7,", rsTmp!诊疗类别) > 0 Then
                            str药房IDs = Get可用药房IDs(rsTmp!诊疗类别, rsTmp!诊疗项目ID, NVL(rsTmp!收费细目ID, 0), mlng病人科室id, 1)
                            If InStr("," & str药房IDs & ",", "," & rsTmp!执行科室ID & ",") > 0 Then
                                .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID, 0)
                            End If
                        ElseIf NVL(rsTmp!诊疗类别) = "4" Then
                            str药房IDs = Get可用发料部门IDs(NVL(rsTmp!收费细目ID, 0), mlng病人科室id, 1)
                            If InStr("," & str药房IDs & ",", "," & rsTmp!执行科室ID & ",") > 0 Then
                                .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID, 0)
                            End If
                        ElseIf Val(.TextMatrix(i, COL_执行性质)) = 4 Then
                            '4-指定科室时才取,其它的固定生成
                            .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID, 0)
                            
                            '检查执行科室的有效性
                            If Val(.TextMatrix(i, COL_执行科室ID)) <> 0 Then
                                If CheckExecDeptValidate(Val(.TextMatrix(i, COL_执行科室ID)), mlng病人科室id, 1, Val(.TextMatrix(i, COL_诊疗项目ID))) = False Then
                                    .TextMatrix(i, COL_执行科室ID) = 0
                                End If
                            End If
                        End If
                    End If
                    If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                        '药品、卫材类的整个成套相同
                        If rsTmp!诊疗类别 = "5" Then
                            If lng西药房ID = 0 Then
                                lng西药房ID = Get诊疗执行科室ID(mlng病人ID, 0, rsTmp!诊疗类别, rsTmp!诊疗项目ID, NVL(rsTmp!收费细目ID, 0), 4, mlng病人科室id, 0, 1, 1, True)
                            End If
                            .TextMatrix(i, COL_执行科室ID) = lng西药房ID
                        ElseIf rsTmp!诊疗类别 = "6" Then
                            If lng成药房ID = 0 Then
                                lng成药房ID = Get诊疗执行科室ID(mlng病人ID, 0, rsTmp!诊疗类别, rsTmp!诊疗项目ID, NVL(rsTmp!收费细目ID, 0), 4, mlng病人科室id, 0, 1, 1, True)
                            End If
                            .TextMatrix(i, COL_执行科室ID) = lng成药房ID
                        ElseIf rsTmp!诊疗类别 = "7" Then
                            If lng中药房ID = 0 Then
                                lng中药房ID = Get诊疗执行科室ID(mlng病人ID, 0, rsTmp!诊疗类别, rsTmp!诊疗项目ID, NVL(rsTmp!收费细目ID, 0), 4, mlng病人科室id, 0, 1, 1, True)
                            End If
                            .TextMatrix(i, COL_执行科室ID) = lng中药房ID
                        ElseIf NVL(rsTmp!诊疗类别) = "4" Then
                            If lng发料部门ID = 0 Then
                                lng发料部门ID = Get收费执行科室ID(mlng病人ID, 0, rsTmp!诊疗类别, NVL(rsTmp!收费细目ID, 0), 4, mlng病人科室id, lng开嘱科室ID, 1, , 1)
                            End If
                            .TextMatrix(i, COL_执行科室ID) = lng发料部门ID
                        Else
                            .TextMatrix(i, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, rsTmp!诊疗类别, rsTmp!诊疗项目ID, 0, NVL(rsTmp!执行性质, 0), mlng病人科室id, lng开嘱科室ID, 1, 1)
                        End If
                    End If
                End If
                
                If rsTmp!诊疗类别 = "E" Then
                    If NVL(rsTmp!相关ID, 0) = 0 And Val(.TextMatrix(i - 1, COL_相关ID)) = -1 * rsTmp!ID Then
                        If InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                            '当前记录是成药的给药途径,可能是一并给药的
                            For j = i - 1 To .FixedRows Step -1
                                If Val(.TextMatrix(j, COL_相关ID)) = -1 * rsTmp!ID Then
                                    '显示给药途径
                                    .TextMatrix(j, COL_用法) = rsTmp!名称 & rsTmp!医生嘱托
                                Else
                                    Exit For
                                End If
                            Next
                        ElseIf InStr(",E,7,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                            '当前记录是中药配方的用法,即配方显示行
                            .TextMatrix(i, COL_用法) = rsTmp!名称
                            bln配方 = True
                        ElseIf .TextMatrix(i - 1, COL_类别) = "C" Then
                            .TextMatrix(i, COL_用法) = rsTmp!名称
                        End If
                    ElseIf Not IsNull(rsTmp!相关ID) And .TextMatrix(i - 1, COL_类别) = "K" And -1 * NVL(rsTmp!相关ID, 0) = .RowData(i - 1) Then
                        '当前记录是输血途径行
                        .TextMatrix(i - 1, COL_用法) = rsTmp!名称
                        If gbln血库系统 Then
                            If Val(rsTmp!操作类型 & "") = 8 And Val(rsTmp!执行分类 & "") = 1 Then
                                 If .TextMatrix(i - 1, COL_检查方法) <> "1" Then
                                     .TextMatrix(i - 1, COL_检查方法) = "1"
                                 End If
                            End If
                        End If
                    ElseIf Not IsNull(rsTmp!相关ID) Then
                        '当前记录是中药配方煎法行
                        bln配方 = True
                    End If
                ElseIf rsTmp!诊疗类别 = "7" Then
                    bln配方 = True
                End If
                
                '单量
                .TextMatrix(i, COL_单量) = FormatEx(NVL(rsTmp!单次用量), 5)
                If NVL(rsTmp!诊疗类别) = "4" Then
                    .TextMatrix(i, COL_单量单位) = NVL(rsTmp!散装单位)
                ElseIf InStr(",5,6,7,", rsTmp!诊疗类别) > 0 _
                    Or (Val(.TextMatrix(i, COL_频率性质)) = 0 And InStr(",1,2,", NVL(rsTmp!计算方式, 0)) > 0) Then
                    .TextMatrix(i, COL_单量单位) = NVL(rsTmp!计算单位)
                End If
                
                '天数
                If mbln天数 Then
                    .TextMatrix(i, COL_天数) = NVL(rsTmp!天数)
                End If

                '总量
                If InStr(",5,6,", rsTmp!诊疗类别) > 0 Then
                    '成药临嘱有总量,以零售单位存放,门诊单位显示
                    If Not IsNull(rsTmp!总给予量) And Not IsNull(rsTmp!门诊包装) Then
                        .TextMatrix(i, COL_总量) = FormatEx(rsTmp!总给予量 / rsTmp!门诊包装, 5)
                    End If
                    .TextMatrix(i, COL_总量单位) = NVL(rsTmp!门诊单位)
                    
                    If Val(.TextMatrix(i, COL_可否分零)) = 0 And Not bln药品小数输入 And InStr(.TextMatrix(i, COL_总量), ".") > 0 Then
                        .TextMatrix(i, COL_总量) = IntEx(Val(.TextMatrix(i, COL_总量)))
                    End If
                    
                    '超量说明不复制
                    Call Set用药天数是否超期(i)
                ElseIf bln配方 Then
                    If Not IsNull(rsTmp!总给予量) Then .TextMatrix(i, COL_总量) = rsTmp!总给予量
                    
                    .TextMatrix(i, COL_总量单位) = "付" '中药配方总量单位为"付"
                    
                    If rsTmp!诊疗类别 = "E" And rsTmp!操作类型 = "4" Then   '中药用法
                        Call Set用药天数是否超期(i)
                    End If
                Else
                    '其它临嘱
                    If Not IsNull(rsTmp!总给予量) Then
                        .TextMatrix(i, COL_总量) = FormatEx(rsTmp!总给予量, 5)
                        '复制时不复制给药执行次数，输液和注射在下达可以指定次数
                        If Val(.TextMatrix(i, COL_相关ID)) = 0 And .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "2" _
                            And (.TextMatrix(i, COL_执行分类) = "1" Or .TextMatrix(i, COL_执行分类) = "2") Then
                            .TextMatrix(i, COL_总量) = ""
                        End If
                    End If
                        
                    If NVL(rsTmp!诊疗类别) = "4" Then
                        .TextMatrix(i, COL_总量单位) = NVL(rsTmp!散装单位)
                    Else
                        .TextMatrix(i, COL_总量单位) = NVL(rsTmp!计算单位)
                    End If
                End If
                
                
                
                '抗菌药物缺省用药目的
                If Val(.TextMatrix(i, COL_抗菌等级)) > 0 Then .TextMatrix(i, COL_用药目的) = mstrPurMed
                
                .TextMatrix(i, COL_标志) = chk紧急.value '可以在界面先统一设置为紧急
                If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And .TextMatrix(i, COL_标志) <> "1" Then
                    .TextMatrix(i, COL_审核状态) = 1
                End If
                '处理输血医嘱审核状态
                If .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "8" And Val(.TextMatrix(i, COL_相关ID)) <> 0 Then
                    strSQL = ""
                    strSQL = GetBloodState(IIF(.TextMatrix(i, COL_标志) = "1", 1, 0), Val(.TextMatrix(i, COL_执行分类)))
                    .TextMatrix(i - 1, COL_审核状态) = strSQL
                    .TextMatrix(i, COL_审核状态) = strSQL
                End If
                .TextMatrix(i, COL_开嘱医生) = UserInfo.姓名
                .TextMatrix(i, COL_开嘱科室ID) = lng开嘱科室ID
                .TextMatrix(i, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, i, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                
                Call SetRow标志图标(i, 1)
                
                '毒麻精药品标识:中药配方及组成味中药不处理
                If InStr(",5,6,", rsTmp!诊疗类别) > 0 And Not IsNull(rsTmp!毒理分类) Then
                    If InStr(",麻醉药,毒性药,精神药,精神I类,精神II类,", rsTmp!毒理分类) > 0 Then
                        .Cell(flexcpFontBold, i, col_医嘱内容) = True
                    End If
                End If
                
                lngEnd = i
                intCount = intCount + 1
                
                rsTmp.MoveNext
            Next
            
            '产生假医嘱ID
            For i = lngBegin To lngEnd
                dbl相关ID = .RowData(i)
                .RowData(i) = GetNext医嘱ID
                For j = i - 1 To lngBegin Step -1
                    If Val(.TextMatrix(j, COL_相关ID)) = dbl相关ID Then
                        .TextMatrix(j, COL_相关ID) = .RowData(i)
                    Else
                        Exit For
                    End If
                Next
                For j = i + 1 To lngEnd
                    If Val(.TextMatrix(j, COL_相关ID)) = dbl相关ID Then
                        .TextMatrix(j, COL_相关ID) = .RowData(i)
                    Else
                        Exit For
                    End If
                Next
            Next
            If gblnOut必用 Then Call MakeAppNo(2, lngBegin, lngEnd)
            
            '一并给药的符号标志
            For i = lngBegin To lngEnd
                If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                    If Val(.TextMatrix(i - 1, COL_相关ID)) = .RowData(i) And InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                        Call SetTag一并给药(i - 1)
                    End If
                End If
            Next
        
            Call Set医嘱超量(lngBegin, lngEnd)
            '调整受影响行的序号
            Call AdviceSet医嘱序号(lngEnd + 1, intCount)
            
            '显示/隐藏行
            lngRow = 0
            For i = lngBegin To lngEnd
                blnHide = False
                If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                    If Val(.TextMatrix(i - 1, COL_相关ID)) = .RowData(i) _
                        And InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                        blnHide = True
                    End If
                End If
                If InStr(",F,G,D,7,E,C,", .TextMatrix(i, COL_类别)) > 0 _
                    And Val(.TextMatrix(i, COL_相关ID)) <> 0 Then
                    blnHide = True
                End If
                                
                .RowHidden(i) = blnHide
                If Not blnHide And lngRow = 0 Then lngRow = i
                
                '处理医嘱内容的变化
                If Not .RowHidden(i) Then
                    .TextMatrix(i, col_医嘱内容) = AdviceTextMake(i)
                End If
                
                '预先计算诊疗单价
                If Not .RowHidden(i) And .TextMatrix(i, COL_单价) = "" Then
                    .TextMatrix(i, COL_单价) = GetItemPrice(i)
                End If
                
                '产生新嘱时，在可见行读取诊疗项目附项串，用于检查，不用于保存
                If Not .RowHidden(i) Then
                    If Not RowIn配方行(i) Then
                        If RowIn检验行(i) Then
                            j = .FindRow(CStr(.RowData(i)), , COL_相关ID)
                            If j <> -1 Then
                                .TextMatrix(i, COL_附项) = Get医嘱项目附件(Val(.TextMatrix(j, COL_诊疗项目ID)), 1)
                            End If
                        Else
                            .TextMatrix(i, COL_附项) = Get医嘱项目附件(Val(.TextMatrix(i, COL_诊疗项目ID)), 1)
                        End If
                        If .TextMatrix(i, COL_附项) <> "" Then
                            str附项 = str附项 & vbCrLf & "●" & .TextMatrix(i, col_医嘱内容)
                        End If
                    End If
                End If
                
                '新增后关联诊断的标记处理
                If Not .RowHidden(i) Then Call SetDiagFlag(i, 1, str诊断IDs)
            Next
            
            '图标对齐:设置为中对齐,不然擦边框时可能有问题
            .Cell(flexcpPictureAlignment, .FixedRows, 0, .Rows - 1, .FixedCols - 1) = 4
            
            .Row = lngRow: .Col = col_医嘱内容
            
            Call .AutoSize(col_医嘱内容)
            .Redraw = flexRDDirect
        End With
        mblnRowChange = True
        mblnNoSave = True '标记为未保存
    End If
    
    Screen.MousePointer = 0
    
    Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    Call CalcAdviceMoney '显示新开医嘱金额
    
    If str附项 <> "" Then
        MsgBox "以下医嘱需要填写申请附项，请注意填写：" & vbCrLf & str附项, vbInformation, gstrSysName
    End If
    If str高危药品 <> "" Then
        MsgBox "以下医嘱是高危药品：" & str高危药品, vbInformation, gstrSysName
    End If
    Exit Sub
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub AdviceSet成套项目(ByVal intType As Integer, ByVal lng成套ID As Long, ByVal lngRow As Long, Optional ByVal str序号 As String, Optional strAltAdivce As String)
'功能：输入成套项目(包括一并给药,检查组合,手术附加,中药配方)
'参数：lngRow=空的输入行(可能是插入的新行,但不位于一并给药中间)
    Dim rsItems As New ADODB.Recordset
    Dim rs规格 As New ADODB.Recordset
    Dim rs材料 As New ADODB.Recordset
    Dim rs疗程 As New ADODB.Recordset
    Dim strSQL As String, i As Long, j As Long
    
    Dim lngCurRow As Long, intCount As Integer, lng序号 As Long
    Dim lngPreRow As Long, vCurDate As Date, lngTmp As Long
    Dim int频率次数 As Integer, int频率间隔 As Integer, str间隔单位 As String
    Dim bln给药途径 As Boolean, bln采集方法 As Boolean, bln输血途径 As Boolean
    Dim bln中药用法 As Boolean, bln中药煎法 As Boolean, bln配方 As Boolean
    Dim lng西药房ID As Long, lng成药房ID As Long, lng中药房ID As Long
    Dim dbl相关ID As Double, int适用范围 As Integer, str频率 As String
    Dim str医生 As String, lng医生ID As Long
    Dim lng倍数 As Long, vBookMark As Variant, str药房IDs As String
    Dim sng天数 As Single, strSQL序号 As String, str附项 As String
    Dim int频率性质 As Integer, lng发料部门ID As Long, blnAdd As Boolean
    Dim str高危药品 As String
    Dim rsTmp As ADODB.Recordset
    Dim str诊断IDs As String
    Dim strAdivceOfPath As String, strTmp As String, lngPar As Long, lngPos As Long, strList As String
    Dim str证候IDs As String, strValues(0 To 10) As String, strTab As String, strTabTwo As String, lngRecord As Long
    Dim bln允许选择 As Boolean, lngPre路径项目id As Long, lngPre选择生成 As Long, lngPre As Long
    
    On Error GoTo errH
    Screen.MousePointer = 11
    Me.Refresh
    
    If mbytUseType = 1 Then
        strAdivceOfPath = strAltAdivce
        lngPar = 0
        strList = ""
        str证候IDs = Get证候IDs(mlng病人ID, mlng挂号ID)
        Do While strAdivceOfPath <> ""
            If Len(strAdivceOfPath) > 4000 And lngPar < 10 Then
                strTmp = Mid(strAdivceOfPath, 1, 4000)
                lngPos = InStrRev(strTmp, ",")
                If lngPos > 0 Then
                    strTmp = Mid(strTmp, 1, lngPos - 1)
                Else
                    lngPos = Len(strTmp)
                End If
            Else
                strTmp = strAdivceOfPath
                lngPos = Len(strTmp)
            End If
            strValues(lngPar) = strTmp
            strAdivceOfPath = Mid(strAdivceOfPath, lngPos + 1)
            lngPar = lngPar + 1    '参数是从1开始
            If strList <> "" Then strList = strList & " Union All "
            strList = strList & "Select To_Number(Substr(Column_Value, 1, Instr(Column_Value, ':') - 1)) As 医嘱内容id," & vbNewLine & _
                      "       To_Number(Substr(Column_Value, Instr(Column_Value, ':') + 1," & vbNewLine & _
                      "                         Instr(Column_Value, ':', -1) - (Instr(Column_Value, ':') + 1))) As 婴儿," & vbNewLine & _
                      "       To_Number(Substr(Column_Value, Instr(Column_Value, ':', -1) + 1)) As 路径项目id" & vbNewLine & _
                      "From Table(f_Str2list([" & lngPar & "]))"
        Loop
        strTab = "(Select distinct a.路径项目id,c.婴儿,e.序号 as 分类序号,d.项目序号, b.序号 as 医嘱序号," & vbNewLine & _
                 " b.Id 序号, b.相关id 相关序号, b.期效, b.诊疗项目id, b.收费细目id, b.医嘱内容, b.单次用量, b.总给予量, b.标本部位, b.检查方法, b.医生嘱托, b.执行频次," & vbNewLine & _
                 " b.频率次数, b.频率间隔, b.间隔单位, b.执行性质, b.执行标记,b.执行科室id, b.时间方案,d.内容要求,d.执行方式,b.是否缺省,b.是否备选,d.路径id,B.配方ID, b.组合项目id" & vbNewLine & _
                 "From 门诊路径医嘱 A, 门诊路径医嘱内容 B,门诊路径项目 D,门诊路径分类 E, (" & strList & ") C" & vbNewLine & _
                 "Where a.医嘱内容id = b.Id And a.路径项目ID = c.路径项目ID And a.医嘱内容ID = c.医嘱内容ID And a.路径项目ID = d.ID  " & vbNewLine & _
                 " And d.分类 = e.名称 And d.路径id = e.路径id And d.版本号 = e.版本号 " & IIF(intType = 2, " And NVL(b.是否备选,0)=0", "") & ")"
        strTabTwo = Replace(strTab, ",c.婴儿,", ",") '避免勾选多个婴儿情况下,规格返回多条相同数据
        strSQL = "Select /*+ rule*/A.序号,B.药名ID,B.药品ID,B.剂量系数,B.门诊包装,B.门诊单位,b.基本药物," & _
                 " B.门诊可否分零 As 可否分零,B.动态分零,C.编码,Nvl(D.名称,C.名称) as 名称,C.规格,C.产地,A.是否备选,b.高危药品,b.是否易至跌倒" & _
                 " From " & strTabTwo & " A,药品规格 B,收费项目目录 C,收费项目别名 D" & _
                 " Where A.诊疗项目ID=B.药名ID And B.药品ID=C.ID" & _
                 " And C.ID=D.收费细目ID(+) And D.码类(+)=1 And D.性质(+)=" & IIF(gbyt药品名称显示 = 0, 1, 3) & _
                 " Order by a.路径项目id,a.医嘱序号"
        Set rs规格 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strValues(0), strValues(1), strValues(2), strValues(3), strValues(4), strValues(5), strValues(6), strValues(7), strValues(8), strValues(9), strValues(10))
        strSQL = "Select /*+ rule*/A.序号,B.材料ID,B.跟踪在用,B.是否分零 as 卫材分零,C.名称,C.计算单位,a.是否备选" & _
                 " From " & strTabTwo & " A,材料特性 B,收费项目目录 C" & _
                 " Where A.收费细目ID=B.材料ID And B.材料ID=C.ID" & _
                 " Order by a.路径项目id,a.医嘱序号"
        Set rs材料 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strValues(0), strValues(1), strValues(2), strValues(3), strValues(4), strValues(5), strValues(6), strValues(7), strValues(8), strValues(9), strValues(10))
        strSQL = "Select /*+ rule*/Distinct A.诊疗项目ID,C.疗程,A.是否备选" & _
                 " From " & strTabTwo & " A,诊疗项目目录 B,诊疗用法用量 C" & _
                 " Where A.诊疗项目ID=B.ID And B.类别 IN('5','6')" & _
                 " And A.诊疗项目ID=C.项目ID"
        Set rs疗程 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strValues(0), strValues(1), strValues(2), strValues(3), strValues(4), strValues(5), strValues(6), strValues(7), strValues(8), strValues(9), strValues(10))
        strSQL = "Select /*+ rule*/A.路径项目id,a.婴儿,1 as 期效,a.序号+0.01 As 序号,Decode(a.相关序号,Null,Null,a.相关序号+0.01) As 相关序号,A.诊疗项目ID,A.收费细目ID,A.医嘱内容,Null 天数,A.总给予量,A.单次用量," & _
                 " A.医生嘱托,A.执行频次,A.频率次数,A.频率间隔,A.间隔单位,A.执行科室ID,Nvl(B.类别,'*') 类别,B.名称," & _
                 " B.计算单位,Decode(B.类别,'D',A.标本部位,Nvl(A.标本部位,B.标本部位)) as 标本部位,A.检查方法," & _
                 " A.时间方案,Nvl(A.执行性质,B.执行科室) as 执行性质,A.执行标记,B.计价性质,B.操作类型,B.执行分类,B.计算方式," & _
                 " B.执行频率,B.录入限量,C.处方限量,C.处方职务,C.毒理分类,C.抗生素,C.药品剂型,C.品种医嘱,A.内容要求,A.分类序号,A.项目序号,A.医嘱序号,A.执行方式,A.是否缺省,A.是否备选,A.路径id,A.配方ID,C.临床自管药,A.组合项目ID,b.单独应用,C.溶媒" & _
                 " From " & strTab & " A,诊疗项目目录 B,药品特性 C,收费项目目录 D" & _
                 " Where A.诊疗项目ID=B.ID(+) And B.ID=C.药名ID(+) And d.id(+)=a.收费细目ID And (NVL(d.撤档时间,b.撤档时间) = To_Date('3000/1/1', 'yyyy/mm/dd') or NVL(d.撤档时间,b.撤档时间) is null) And (Nvl(d.服务对象, b.服务对象) In (1, 3) or Nvl(d.服务对象, b.服务对象) is null) " & _
                 IIF(str证候IDs <> "", " And (instr(',' || [12] || ',',',' || a.组合项目ID || ',')>0 or a.组合项目ID is null or Not (b.类别 = '7' or (b.类别 = 'E' and b.操作类型='4') or (b.类别 = 'E' and b.操作类型='3')))", "") & _
                 " Order by 婴儿,分类序号,项目序号,路径id,医嘱序号"
        Set rsItems = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strValues(0), strValues(1), strValues(2), strValues(3), strValues(4), strValues(5), strValues(6), strValues(7), strValues(8), strValues(9), strValues(10), str证候IDs)
        mblnNoSave = rsItems.RecordCount > 0
        If rsItems.RecordCount > 0 Then
            Set rsItems = zlDatabase.CopyNewRec(rsItems)
            If rsItems.RecordCount > 0 Then rsItems.MoveFirst
            Do While Not rsItems.EOF
                If rsItems!相关序号 & "" <> "" Then
                    lngRecord = rsItems.AbsolutePosition
                    rsItems.Filter = "序号=" & rsItems!相关序号
                    If rsItems.RecordCount = 0 Then
                        rsItems.Filter = 0
                        rsItems.AbsolutePosition = lngRecord
                        rsItems.Delete
                    Else
                        rsItems.Filter = 0
                        rsItems.AbsolutePosition = lngRecord
                    End If
                Else
                    If Val(rsItems!诊疗项目ID & "") <> 0 Then
                        lngRecord = rsItems.AbsolutePosition
                        rsItems.Filter = "相关序号=" & rsItems!序号
                        If rsItems.RecordCount = 0 Then
                            rsItems.Filter = 0
                            rsItems.AbsolutePosition = lngRecord
                            If Val(rsItems!单独应用 & "") = 0 Then rsItems.Delete
                        Else
                            rsItems.Filter = 0
                            rsItems.AbsolutePosition = lngRecord
                        End If
                    End If
                End If
                rsItems.MoveNext
            Loop
            If rsItems.RecordCount > 0 Then rsItems.MoveFirst
        End If
    Else
    '产生序号过滤串
    If str序号 <> "" Then
        If Left(str序号, 1) = "+" Then
            strSQL序号 = " And Instr([2],','||A.序号||',')>0"
        ElseIf Left(str序号, 1) = "-" Then
            strSQL序号 = " And Instr([2],','||A.序号||',')=0"
        End If
    End If
    
    '药品规格信息:虽然存了收费细目ID,但以前的数据没存
    strSQL = "Select A.序号,B.药名ID,B.药品ID,B.剂量系数,B.门诊包装,B.门诊单位,b.基本药物," & _
        " B.门诊可否分零 As 可否分零,C.编码,Nvl(D.名称,C.名称) as 名称,C.规格,C.产地,b.高危药品,b.是否易至跌倒" & _
        " From 诊疗项目组合 A,药品规格 B,收费项目目录 C,收费项目别名 D" & _
        " Where A.诊疗项目ID=B.药名ID And B.药品ID=C.ID" & _
        " And C.ID=D.收费细目ID(+) And D.码类(+)=1 And D.性质(+)=[3]" & _
        " And A.诊疗组合ID=[1]" & strSQL序号 & _
        " Order by A.序号,C.编码"
    Set rs规格 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng成套ID, "," & Mid(str序号, 2) & ",", IIF(gbyt药品名称显示 = 0, 1, 3))
    
    '卫材信息
    strSQL = "Select A.序号,B.材料ID,B.跟踪在用,B.是否分零 as 卫材分零,C.名称,C.计算单位" & _
        " From 诊疗项目组合 A,材料特性 B,收费项目目录 C" & _
        " Where A.收费细目ID=B.材料ID And B.材料ID=C.ID" & _
        " And A.诊疗组合ID=[1]" & strSQL序号 & _
        " Order by A.序号,C.编码"
    Set rs材料 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng成套ID, "," & Mid(str序号, 2) & ",")
    
    '成药疗程信息(因成套中无直接对应配方,中药取不到疗程)
    strSQL = "Select Distinct A.诊疗项目ID,C.疗程" & _
        " From 诊疗项目组合 A,诊疗项目目录 B,诊疗用法用量 C" & _
        " Where A.诊疗项目ID=B.ID And B.类别 IN('5','6')" & _
        " And A.诊疗项目ID=C.项目ID And A.诊疗组合ID=[1]" & strSQL序号
    Set rs疗程 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng成套ID, "," & Mid(str序号, 2) & ",")
    
    '按序号排列后应该与医嘱编辑时的次序一致
    '排开执行频率为持续性的长嘱(这种方法不对,只取临嘱),所有方案转为临嘱处理
    strSQL = "Select 1 as 期效,a.序号+0.1 As 序号,Decode(a.相关序号,Null,Null,a.相关序号+0.1) As 相关序号,A.诊疗项目ID,A.收费细目ID,A.医嘱内容,A.天数,A.总给予量,A.单次用量," & _
        " A.医生嘱托,A.执行频次,A.频率次数,A.频率间隔,A.间隔单位,A.执行科室ID,Nvl(B.类别,'*') 类别,B.名称," & _
        " B.计算单位,Decode(B.类别,'D',A.标本部位,Nvl(A.标本部位,B.标本部位)) as 标本部位,A.检查方法," & _
        " A.时间方案,Nvl(A.执行性质,B.执行科室) as 执行性质,B.计价性质,B.操作类型,B.执行分类,B.计算方式," & _
        " B.执行频率,B.录入限量,C.处方限量,C.处方职务,C.毒理分类,C.抗生素,C.药品剂型,A.配方ID,C.临床自管药,A.组合项目ID,C.溶媒" & _
        " From 诊疗项目组合 A,诊疗项目目录 B,药品特性 C,收费项目目录 D" & _
        " Where A.诊疗项目ID=B.ID(+) And A.诊疗项目ID=C.药名ID(+)  And d.id(+)=a.收费细目ID " & _
        " And A.期效=1 And A.诊疗组合ID=[1]" & strSQL序号 & _
        " And (NVL(d.撤档时间,b.撤档时间) is null or NVL(d.撤档时间,b.撤档时间) = To_Date('3000/1/1', 'yyyy/mm/dd') Or Not (b.类别 = '7' Or b.类别 = 'E' And b.执行分类 = 0 And b.操作类型 = '3'))" & _
        " Order by A.序号"
    Set rsItems = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng成套ID, "," & Mid(str序号, 2) & ",")
    End If
    With vsAdvice
        mblnRowChange = False
        .Redraw = flexRDNone
        
        lngPreRow = GetPreRow(lngRow) '前一参照行
        intCount = 0 '已经设置的行数
        lng序号 = GetCurRow序号(lngRow) '起始序号
        If intType = 3 Then intCount = 1
        vCurDate = zlDatabase.Currentdate
        If mbytUseType = 0 Then
            Call AdviceHaveDiag(lngPreRow, 0, str诊断IDs)
        ElseIf intType = 3 Then
            str诊断IDs = ""
        End If
        For i = 1 To rsItems.RecordCount
            blnAdd = True
            
            '检查是否存在有效的住院医嘱或留观医嘱
            If rsItems!类别 = "Z" And InStr(",1,2,", "," & rsItems!操作类型 & ",") > 0 Then
                If CheckInHosAdvice Then
                    blnAdd = False
                End If
            End If
            
            If blnAdd Then
                lngCurRow = lngRow + intCount
                If lngCurRow > lngRow Then .AddItem "", lngCurRow
                 
                '记录相对ID
                .RowData(lngCurRow) = -1 * rsItems!序号
                If Not IsNull(rsItems!相关序号) Then
                    .TextMatrix(lngCurRow, COL_相关ID) = -1 * rsItems!相关序号
                End If
                
                .TextMatrix(lngCurRow, COL_EDIT) = 1 '新增
                
                .Cell(flexcpData, lngCurRow, COL_EDIT) = lng成套ID '记录相关的成套项目
                
                .TextMatrix(lngCurRow, COL_婴儿) = cbo婴儿.ListIndex
                .TextMatrix(lngCurRow, COL_序号) = lng序号 + intCount - IIF(intType = 3, 1, 0)
                .TextMatrix(lngCurRow, COL_状态) = 1 '新开
                .TextMatrix(lngCurRow, COL_类别) = rsItems!类别
                .TextMatrix(lngCurRow, COL_诊疗项目ID) = NVL(rsItems!诊疗项目ID, 0)
                .TextMatrix(lngCurRow, COL_名称) = NVL(rsItems!名称)
                .TextMatrix(lngCurRow, COL_标本部位) = NVL(rsItems!标本部位)
                .TextMatrix(lngCurRow, COL_检查方法) = NVL(rsItems!检查方法)
                If mbytUseType = 1 Then
                    .RowData(lngCurRow) = -1 * (rsItems!序号 * 10 + rsItems!婴儿)   '避免多个婴儿医嘱ID相同
                    If Not IsNull(rsItems!相关序号) Then
                        .TextMatrix(lngCurRow, COL_相关ID) = -1 * (rsItems!相关序号 * 10 + rsItems!婴儿)
                    End If
                    .TextMatrix(lngCurRow, COL_婴儿) = Val(rsItems!婴儿)
                    .TextMatrix(lngCurRow, COL_路径项目ID) = Val(rsItems!路径项目ID)
                    .TextMatrix(lngCurRow, COL_路径执行方式) = Val("" & rsItems!执行方式)    '0-无须执行，1-每天执行，2-必要时执行
                    If Val("" & rsItems!内容要求) = 1 Then  '允许选择生成
                        .Cell(flexcpChecked, lngCurRow, COL_选择) = IIF(rsItems!是否缺省 = 1, 1, 2)    '1表示选择
                        .Cell(flexcpPictureAlignment, lngCurRow, COL_选择) = flexPicAlignCenterCenter
                        If bln允许选择 = False Then bln允许选择 = True
                    Else
                        .TextMatrix(lngCurRow, COL_选择) = "√"    '未设置.Cell(flexcpChecked, lngCurRow, COL_选择)时值为0
                        .Cell(flexcpBackColor, lngCurRow, COL_选择) = &H8000000F
                    End If
                    If lngPre路径项目id <> Val(rsItems!路径项目ID) And lngCurRow <> .FixedRows Then
                        If lngPre选择生成 = 1 Or Val("" & rsItems!内容要求) = 1 Then
                            If .RowHidden(lngCurRow - 1) Then   '找到前一非隐藏行
                                For lngPre = lngCurRow - 2 To .FixedRows Step -1
                                    If .RowHidden(lngPre) = False Then
                                        .CellBorderRange lngPre, .FixedCols, lngPre, .Cols - 1, &H808080, 0, 0, 0, 2, 0, 0
                                        Exit For
                                    End If
                                Next
                            Else
                                .CellBorderRange lngCurRow - 1, .FixedCols, lngCurRow - 1, .Cols - 1, &H808080, 0, 0, 0, 2, 0, 0
                            End If
                        End If
                    End If
                    lngPre路径项目id = Val(rsItems!路径项目ID)
                    lngPre选择生成 = Val("" & rsItems!内容要求)
                End If
                
                If IsDate(msk开始时间.Text) Then
                    .TextMatrix(lngCurRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, lngCurRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    
                    '手术/输血时间：复制时缺省与开始时间相同,在标本部位处理后
                    If rsItems!类别 = "K" Or rsItems!类别 = "F" Or rsItems!类别 = "G" _
                        And Val(.TextMatrix(lngCurRow, COL_相关ID)) = Val(.TextMatrix(lngCurRow - 1, COL_相关ID)) Then
                        .TextMatrix(lngCurRow, COL_手术时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    End If
                End If
                
                '其它
                .TextMatrix(lngCurRow, COL_计价性质) = NVL(rsItems!计价性质, 0)
                .TextMatrix(lngCurRow, COL_计算方式) = NVL(rsItems!计算方式, 0)
                .TextMatrix(lngCurRow, COL_操作类型) = NVL(rsItems!操作类型)
                .TextMatrix(lngCurRow, COL_执行分类) = NVL(rsItems!执行分类, 0)
                .TextMatrix(lngCurRow, COL_毒理分类) = NVL(rsItems!毒理分类)
                .TextMatrix(lngCurRow, COL_抗菌等级) = Val("" & rsItems!抗生素)
                .TextMatrix(lngCurRow, COL_配方ID) = NVL(rsItems!配方ID)
                .TextMatrix(lngCurRow, COL_临床自管药) = rsItems!临床自管药 & ""
                .TextMatrix(lngCurRow, COL_组合项目ID) = rsItems!组合项目ID & ""
                .TextMatrix(lngCurRow, COL_是否溶媒) = Val(rsItems!溶媒 & "")
                
                .TextMatrix(lngCurRow, COL_药品剂型) = NVL(rsItems!药品剂型)
                If InStr(",5,6,7,", rsItems!类别) > 0 Then
                    .TextMatrix(lngCurRow, COL_处方限量) = NVL(rsItems!处方限量)
                Else
                    .TextMatrix(lngCurRow, COL_处方限量) = NVL(rsItems!录入限量)
                End If
                .TextMatrix(lngCurRow, COL_处方职务) = NVL(rsItems!处方职务)
                
                '药品规格信息:中草药肯定有,成药按单量与剂量单位自动匹配
                lng倍数 = 0: vBookMark = 0
                If rsItems!类别 = "7" Or (InStr(",5,6,", rsItems!类别) > 0) Then
                    If Not IsNull(rsItems!收费细目ID) Then '可能以前未保存收费细目ID
                        rs规格.Filter = "药品ID=" & rsItems!收费细目ID
                    Else
                        rs规格.Filter = "药名ID=0"
                    End If
                    If Not rs规格.EOF Then
                        If IsNull(rsItems!收费细目ID) Then
                            '取剂量系数为单量的最小整倍数的那一个规格
                            If CInt(NVL(rsItems!单次用量, 0)) <> 0 Then
                                Do While Not rs规格.EOF
                                    If rs规格!剂量系数 / rsItems!单次用量 = Int(rs规格!剂量系数 / rsItems!单次用量) Then
                                        If rs规格!剂量系数 / rsItems!单次用量 < lng倍数 Or lng倍数 = 0 Then
                                            vBookMark = rs规格.Bookmark
                                            lng倍数 = rs规格!剂量系数 / rsItems!单次用量
                                        End If
                                    End If
                                    rs规格.MoveNext
                                Loop
                                If vBookMark <> 0 Then rs规格.Bookmark = vBookMark
                            End If
                            If rs规格.EOF Then rs规格.MoveFirst
                        End If
                        .TextMatrix(lngCurRow, COL_名称) = NVL(rs规格!名称)
                        .TextMatrix(lngCurRow, COL_收费细目ID) = rs规格!药品ID
                        .Cell(flexcpData, lngCurRow, COL_收费细目ID) = Val("" & rs规格!药品ID)
                        .TextMatrix(lngCurRow, COL_剂量系数) = NVL(rs规格!剂量系数)
                        .TextMatrix(lngCurRow, COL_门诊包装) = NVL(rs规格!门诊包装)
                        .TextMatrix(lngCurRow, COL_门诊单位) = NVL(rs规格!门诊单位)
                        .TextMatrix(lngCurRow, COL_可否分零) = NVL(rs规格!可否分零, 0)
                        .TextMatrix(lngCurRow, COL_高危药品) = NVL(rs规格!高危药品, 0)
                        .TextMatrix(lngCurRow, COL_易跌倒) = NVL(rs规格!是否易至跌倒, 0)
                        .TextMatrix(lngCurRow, COL_基本药物) = rs规格!基本药物 & ""
                        If Val(.TextMatrix(lngCurRow, COL_高危药品)) <> 0 Then
                            str高危药品 = str高危药品 & vbCrLf & rsItems!名称 & ":" & Decode(Val(.TextMatrix(lngCurRow, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级；"
                        End If
                    End If
                ElseIf rsItems!类别 = "4" Then
                    rs材料.Filter = "材料ID=" & NVL(rsItems!收费细目ID, 0)
                    If Not rs材料.EOF Then
                        .TextMatrix(lngCurRow, COL_名称) = NVL(rs材料!名称)
                        .TextMatrix(lngCurRow, COL_门诊单位) = NVL(rs材料!计算单位) '散装单位
                        .TextMatrix(lngCurRow, COL_跟踪在用) = NVL(rs材料!跟踪在用, 0)
                    End If
                    .TextMatrix(lngCurRow, COL_剂量系数) = 1
                    .TextMatrix(lngCurRow, COL_门诊包装) = 1
                    .TextMatrix(lngCurRow, COL_收费细目ID) = NVL(rsItems!收费细目ID, 0)
                    .Cell(flexcpData, lngCurRow, COL_收费细目ID) = NVL(rsItems!收费细目ID, 0)
                    .Cell(flexcpData, lngCurRow, COL_可否分零) = NVL(rs材料!卫材分零, 0)
                End If
                                    
                '判断是否特定行
                bln给药途径 = False: bln采集方法 = False: bln输血途径 = False
                bln中药用法 = False: bln中药煎法 = False: bln配方 = False
                If rsItems!类别 = "E" Then
                    If IsNull(rsItems!相关序号) Then
                        If Val(.TextMatrix(lngCurRow - 1, COL_相关ID)) = .RowData(lngCurRow) Then
                            If InStr(",5,6,", .TextMatrix(lngCurRow - 1, COL_类别)) > 0 Then
                                bln给药途径 = True
                            ElseIf .TextMatrix(lngCurRow - 1, COL_类别) = "C" Then
                                bln采集方法 = True
                            Else
                                bln中药用法 = True
                            End If
                        End If
                    ElseIf .TextMatrix(lngCurRow - 1, COL_类别) = "K" And .RowData(lngCurRow - 1) = Val(.TextMatrix(lngCurRow, COL_相关ID)) Then
                        bln输血途径 = True
                    Else
                        bln中药煎法 = True
                    End If
                End If
                If rsItems!类别 = "7" Or bln中药煎法 Or bln中药用法 Then bln配方 = True
                        
                '获取当前项目的适用范围
                If bln采集方法 Then
                    '采集方法以检验项目的为准
                    lngTmp = .FindRow(CStr(.RowData(lngCurRow)), , COL_相关ID)
                    int频率性质 = .TextMatrix(lngTmp, COL_频率性质)
                Else
                    int频率性质 = NVL(rsItems!执行频率, 0)
                End If
                If bln配方 Then
                    int适用范围 = 2 '中药配方(包括煎法,用法)用中医
    '            ElseIf bln采集方法 Then
    '                int适用范围 = -1 '设置与检验项目相同:一次性
                ElseIf int频率性质 = 0 Or bln给药途径 _
                    Or InStr(",5,6,", .TextMatrix(lngCurRow, COL_类别)) > 0 Then
                    int适用范围 = 1 '"可选频率"或成药(包括给药途径)用西医
                ElseIf int频率性质 = 1 Then
                    int适用范围 = -1 '一次性
                ElseIf int频率性质 = 2 Then
                    int适用范围 = -2 '持续性
                End If
                        
                '频率,频率次数,频率间隔,间隔单位
                .TextMatrix(lngCurRow, COL_频率性质) = int频率性质
                If Not IsNull(rsItems!执行频次) Then
                    If Check频率可用(NVL(rsItems!诊疗项目ID, 0), int适用范围, NVL(rsItems!执行频次)) Then
                        If Get频率信息_名称(rsItems!执行频次, int频率次数, int频率间隔, str间隔单位, CStr(int适用范围)) Then
                            .TextMatrix(lngCurRow, COL_频率) = rsItems!执行频次
                            .TextMatrix(lngCurRow, COL_频率次数) = int频率次数
                            .TextMatrix(lngCurRow, COL_频率间隔) = int频率间隔
                            .TextMatrix(lngCurRow, COL_间隔单位) = str间隔单位
                        End If
                    End If
                End If
                If .TextMatrix(lngCurRow, COL_频率) = "" And Not IsNull(rsItems!诊疗项目ID) Then '取缺省的
                    Call Get缺省频率(NVL(rsItems!诊疗项目ID, 0), int适用范围, str频率, int频率次数, int频率间隔, str间隔单位)
                    .TextMatrix(lngCurRow, COL_频率) = str频率
                    .TextMatrix(lngCurRow, COL_频率次数) = int频率次数
                    .TextMatrix(lngCurRow, COL_频率间隔) = int频率间隔
                    .TextMatrix(lngCurRow, COL_间隔单位) = str间隔单位
                End If
                
                '单量
                .TextMatrix(lngCurRow, COL_单量) = FormatEx(NVL(rsItems!单次用量), 5)
                If rsItems!类别 = "4" Then
                    .TextMatrix(lngCurRow, COL_单量单位) = .TextMatrix(lngCurRow, COL_门诊单位) '散装单位
                ElseIf bln中药用法 Then
                    .TextMatrix(lngCurRow, COL_单量单位) = ""
                Else
                    If InStr(",5,6,7,", rsItems!类别) > 0 Or (int频率性质 = 0 And InStr(",1,2,", NVL(rsItems!计算方式, 0)) > 0) Then
                        .TextMatrix(lngCurRow, COL_单量单位) = NVL(rsItems!计算单位)
                    End If
                End If
                
                '总量
                If InStr(",5,6,", rsItems!类别) > 0 Then
                    '成药临嘱(有对应规格)
                    .TextMatrix(lngCurRow, COL_总量单位) = .TextMatrix(lngCurRow, COL_门诊单位)
                                        
                    sng天数 = NVL(rsItems!天数, msng天数)
                    If mbln天数 Then
                        If .TextMatrix(lngCurRow, COL_间隔单位) = "周" Then
                            If 7 > sng天数 Then sng天数 = 7
                        ElseIf .TextMatrix(lngCurRow, COL_间隔单位) = "天" Then
                            If Val(.TextMatrix(lngCurRow, COL_频率间隔)) > sng天数 Then
                                sng天数 = Val(.TextMatrix(lngCurRow, COL_频率间隔))
                            End If
                        ElseIf .TextMatrix(lngCurRow, COL_间隔单位) = "小时" Then
                            If Val(.TextMatrix(lngCurRow, COL_频率间隔)) \ 24 > sng天数 Then
                                sng天数 = Val(.TextMatrix(lngCurRow, COL_频率间隔)) \ 24
                            End If
                        ElseIf .TextMatrix(lngCurRow, COL_间隔单位) = "分钟" Then
                            If sng天数 = 0 Then sng天数 = 1
                        End If
                        If sng天数 = 0 Then sng天数 = 1
                    End If
                    
                    If Not IsNull(rsItems!总给予量) Then
                        '转换为门诊单位
                        .TextMatrix(lngCurRow, COL_总量) = FormatEx(rsItems!总给予量 / Val(.TextMatrix(lngCurRow, COL_门诊包装)), 5)
                    ElseIf .TextMatrix(lngCurRow, COL_频率) <> "" Then
                        '计算缺省总量
                        rs疗程.Filter = "诊疗项目ID=" & rsItems!诊疗项目ID
                        If Not rs疗程.EOF Then
                            If NVL(rs疗程!疗程, 1) > sng天数 Then sng天数 = NVL(rs疗程!疗程, 1)
                        End If
                    
                        If (Val(.TextMatrix(lngCurRow, COL_单量)) <> 0 _
                            And Val(.TextMatrix(lngCurRow, COL_门诊包装)) <> 0 _
                            And Val(.TextMatrix(lngCurRow, COL_剂量系数)) <> 0) Then
                            
                            .TextMatrix(lngCurRow, COL_总量) = FormatEx(Calc缺省药品总量( _
                                    Val(.TextMatrix(lngCurRow, COL_单量)), sng天数, _
                                    Val(.TextMatrix(lngCurRow, COL_频率次数)), _
                                    Val(.TextMatrix(lngCurRow, COL_频率间隔)), _
                                    .TextMatrix(lngCurRow, COL_间隔单位), _
                                    .TextMatrix(lngCurRow, COL_执行时间), _
                                    Val(.TextMatrix(lngCurRow, COL_剂量系数)), _
                                    Val(.TextMatrix(lngCurRow, COL_门诊包装)), _
                                    Val(.TextMatrix(lngCurRow, COL_可否分零))), 5)
                            If Val(.TextMatrix(lngCurRow, COL_可否分零)) <> 0 Then
                                .TextMatrix(lngCurRow, COL_总量) = IntEx(Val(.TextMatrix(lngCurRow, COL_总量)))
                            End If
                        End If
                    End If
                    
                    If InStr(GetInsidePrivs(p门诊医嘱下达), "药品小数输入") = 0 Then
                        .TextMatrix(lngCurRow, COL_总量) = IntEx(Val(.TextMatrix(lngCurRow, COL_总量)))
                    End If
                    
                    '处方限量
                    If Val(.TextMatrix(lngCurRow, COL_处方限量)) <> 0 Then
                        If Val(.TextMatrix(lngCurRow, COL_总量)) > FormatEx(Val(.TextMatrix(lngCurRow, COL_处方限量)) / Val(.TextMatrix(lngCurRow, COL_剂量系数)) / Val(.TextMatrix(lngCurRow, COL_门诊包装)), 5) Then
                            .TextMatrix(lngCurRow, COL_是否超量) = "1"
                        End If
                    End If
                     
                    If mbln天数 Then
                        .TextMatrix(lngCurRow, COL_天数) = IIF(sng天数 = 0, "", sng天数)
                    End If
                    Call Set用药天数是否超期(lngCurRow)
                    
                ElseIf bln配方 Then
                    If rsItems!类别 = "7" Then
                        .TextMatrix(lngCurRow, COL_总量单位) = "付"
                                                
                        If Not IsNull(rsItems!总给予量) Then
                            .TextMatrix(lngCurRow, COL_总量) = rsItems!总给予量
                        ElseIf .TextMatrix(lngCurRow, COL_频率) <> "" Then
                             .TextMatrix(lngCurRow, COL_总量) = Calc缺省药品总量(1, 1, Val(.TextMatrix(lngCurRow, COL_频率次数)), _
                                        Val(.TextMatrix(lngCurRow, COL_频率间隔)), .TextMatrix(lngCurRow, COL_间隔单位))
                        End If
                    Else
                        '中药煎法,用法的总量与组成药相同(为了显示)
                        .TextMatrix(lngCurRow, COL_总量) = .TextMatrix(lngCurRow - 1, COL_总量)
                        .TextMatrix(lngCurRow, COL_总量单位) = .TextMatrix(lngCurRow - 1, COL_总量单位)
                         
                    End If
                Else
                    '其它临嘱都需要总量
                    '如果为一次性或计次临嘱缺省总量为1
                    If Not IsNull(rsItems!总给予量) Then
                        vsAdvice.TextMatrix(lngCurRow, COL_总量) = rsItems!总给予量
                    ElseIf int频率性质 = 1 Or NVL(rsItems!计算方式, 0) = 3 Then
                        vsAdvice.TextMatrix(lngCurRow, COL_总量) = 1
                    End If
                    If rsItems!类别 = "4" Then
                        .TextMatrix(lngCurRow, COL_总量单位) = .TextMatrix(lngCurRow, COL_门诊单位) '散装单位
                    Else
                        .TextMatrix(lngCurRow, COL_总量单位) = NVL(rsItems!计算单位)
                    End If
                    If rsItems!类别 = "E" Then
                        If .TextMatrix(lngCurRow, COL_操作类型) = "2" And (.TextMatrix(lngCurRow, COL_执行分类) = "1" Or .TextMatrix(lngCurRow, COL_执行分类) = "2") Then
                            vsAdvice.TextMatrix(lngCurRow, COL_总量) = ""
                        End If
                    End If
                End If
                
                '抗菌药物缺省用药目的
                If Val(.TextMatrix(lngCurRow, COL_抗菌等级)) > 0 Then .TextMatrix(lngCurRow, COL_用药目的) = mstrPurMed
                        
                '执行时间(总量,频率,执行时间之后)
                If .TextMatrix(lngCurRow, COL_频率) <> "" Then
                    '可能求出缺省执行时间方案
                    If bln给药途径 Or bln中药用法 Then
                        If Not IsNull(rsItems!时间方案) Then
                            If ExeTimeValid(rsItems!时间方案, Val(.TextMatrix(lngCurRow, COL_频率次数)), _
                                Val(.TextMatrix(lngCurRow, COL_频率间隔)), .TextMatrix(lngCurRow, COL_间隔单位)) Then
                                .TextMatrix(lngCurRow, COL_执行时间) = rsItems!时间方案
                            End If
                        End If
                        If .TextMatrix(lngCurRow, COL_执行时间) = "" Then
                            .TextMatrix(lngCurRow, COL_执行时间) = Get缺省时间(int适用范围, .TextMatrix(lngCurRow, COL_频率), rsItems!诊疗项目ID)
                        End If
                    ElseIf int频率性质 = 0 Then
                        If Not IsNull(rsItems!时间方案) Then
                            If ExeTimeValid(rsItems!时间方案, Val(.TextMatrix(lngCurRow, COL_频率次数)), _
                                Val(.TextMatrix(lngCurRow, COL_频率间隔)), .TextMatrix(lngCurRow, COL_间隔单位)) Then
                                .TextMatrix(lngCurRow, COL_执行时间) = rsItems!时间方案
                            End If
                        End If
                        If .TextMatrix(lngCurRow, COL_执行时间) = "" Then
                            .TextMatrix(lngCurRow, COL_执行时间) = Get缺省时间(int适用范围, .TextMatrix(lngCurRow, COL_频率))
                        End If
                    End If
                    If bln采集方法 Then
                        .TextMatrix(lngCurRow, COL_用法) = rsItems!名称
                    ElseIf bln给药途径 Or bln中药用法 Then
                        '成药和中药配方的用法,执行时间
                        If bln中药用法 Then
                            .TextMatrix(lngCurRow, COL_用法) = rsItems!名称
                        End If
                        For j = lngCurRow - 1 To lngRow Step -1
                            If Val(.TextMatrix(j, COL_相关ID)) = .RowData(lngCurRow) Then
                                If bln给药途径 Then .TextMatrix(j, COL_用法) = rsItems!名称 & rsItems!医生嘱托
                                .TextMatrix(j, COL_执行时间) = .TextMatrix(lngCurRow, COL_执行时间)
                            Else
                                Exit For
                            End If
                        Next
                    ElseIf bln输血途径 Then
                        .TextMatrix(lngCurRow - 1, COL_用法) = rsItems!名称
                        If gbln血库系统 Then
                            If Val(rsItems!操作类型 & "") = 8 And Val(rsItems!执行分类 & "") = 1 Then
                                 If .TextMatrix(lngCurRow - 1, COL_检查方法) <> "1" Then
                                     .TextMatrix(lngCurRow - 1, COL_检查方法) = "1"
                                 End If
                            End If
                        End If
                    End If
                End If
                
                '开嘱医生和开嘱科室
                .TextMatrix(lngCurRow, COL_开嘱医生) = UserInfo.姓名
                .TextMatrix(lngCurRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
                                    
                '执行性质
                If InStr(",5,6,7,", rsItems!类别) > 0 Then
                    If NVL(rsItems!执行性质, 0) = 5 Then
                        .TextMatrix(lngCurRow, COL_执行性质) = 5
                    Else
                        .TextMatrix(lngCurRow, COL_执行性质) = 4
                    End If
                ElseIf rsItems!类别 = "4" Then
                    .TextMatrix(lngCurRow, COL_执行性质) = 4
                ElseIf bln给药途径 Or bln中药煎法 Or bln中药用法 Or bln采集方法 Then
                    .TextMatrix(lngCurRow, COL_执行性质) = NVL(rsItems!执行性质, 0)
                Else
                    .TextMatrix(lngCurRow, COL_执行性质) = NVL(rsItems!执行性质, 0)
                End If
                
                '执行科室ID:为0-叮嘱,5-院外执行时取出为0
                If rsItems!类别 = "Z" And InStr(",1,2,", NVL(rsItems!操作类型, 0)) > 0 Then
                    If NVL(rsItems!执行科室ID, 0) <> 0 Then
                        .TextMatrix(lngCurRow, COL_执行科室ID) = NVL(rsItems!执行科室ID, 0)
                    Else
                        '留观或住院医嘱取临床科室(不管执行性质)
                        If NVL(rsItems!操作类型, 0) = 1 Then
                            '留观:包含门诊或住院临床科室
                            Call Get临床科室(3, , lngTmp, , True, False, True)
                        ElseIf NVL(rsItems!操作类型, 0) = 2 Then
                            '住院:包含住院临床科室
                            Call Get临床科室(2, , lngTmp, , True, False, True)
                        End If
                        .TextMatrix(lngCurRow, COL_执行科室ID) = lngTmp
                    End If
                ElseIf InStr(",0,5,", Val(.TextMatrix(lngCurRow, COL_执行性质))) = 0 Then
                    If NVL(rsItems!执行科室ID, 0) <> 0 Then
                        If InStr(",5,6,7,", rsItems!类别) > 0 Then
                            str药房IDs = Get可用药房IDs(rsItems!类别, rsItems!诊疗项目ID, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), mlng病人科室id, 1)
                            If InStr("," & str药房IDs & ",", "," & rsItems!执行科室ID & ",") > 0 Then
                                .TextMatrix(lngCurRow, COL_执行科室ID) = NVL(rsItems!执行科室ID, 0)
                            End If
                        ElseIf rsItems!类别 = "4" Then
                            str药房IDs = Get可用发料部门IDs(Val(.TextMatrix(lngCurRow, COL_收费细目ID)), mlng病人科室id, 1)
                            If InStr("," & str药房IDs & ",", "," & rsItems!执行科室ID & ",") > 0 Then
                                .TextMatrix(lngCurRow, COL_执行科室ID) = NVL(rsItems!执行科室ID, 0)
                            End If
                        ElseIf Val(.TextMatrix(lngCurRow, COL_执行性质)) = 4 Then
                            '4-指定科室时才取,其它的固定生成
                            .TextMatrix(lngCurRow, COL_执行科室ID) = NVL(rsItems!执行科室ID, 0)
                            
                            '检查执行科室的有效性
                            If Val(.TextMatrix(lngCurRow, COL_执行科室ID)) <> 0 Then
                                If CheckExecDeptValidate(Val(.TextMatrix(lngCurRow, COL_执行科室ID)), mlng病人科室id, 1, Val(.TextMatrix(lngCurRow, COL_诊疗项目ID))) = False Then
                                    .TextMatrix(lngCurRow, COL_执行科室ID) = 0
                                End If
                            End If
                        End If
                    End If
                    If Val(.TextMatrix(lngCurRow, COL_执行科室ID)) = 0 Then
                        '药品类的整个成套相同
                        If rsItems!类别 = "5" Then
                            If lng西药房ID = 0 Then
                                lng西药房ID = Get诊疗执行科室ID(mlng病人ID, 0, rsItems!类别, rsItems!诊疗项目ID, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), 4, mlng病人科室id, 0, 1, 1, True)
                            End If
                            .TextMatrix(lngCurRow, COL_执行科室ID) = lng西药房ID
                        ElseIf rsItems!类别 = "6" Then
                            If lng成药房ID = 0 Then
                                lng成药房ID = Get诊疗执行科室ID(mlng病人ID, 0, rsItems!类别, rsItems!诊疗项目ID, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), 4, mlng病人科室id, 0, 1, 1, True)
                            End If
                            .TextMatrix(lngCurRow, COL_执行科室ID) = lng成药房ID
                        ElseIf rsItems!类别 = "7" Then
                            If lng中药房ID = 0 Then
                                lng中药房ID = Get诊疗执行科室ID(mlng病人ID, 0, rsItems!类别, rsItems!诊疗项目ID, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), 4, mlng病人科室id, 0, 1, 1, True)
                            End If
                            .TextMatrix(lngCurRow, COL_执行科室ID) = lng中药房ID
                        ElseIf rsItems!类别 = "4" Then
                            If lng发料部门ID = 0 Then
                                lng发料部门ID = Get收费执行科室ID(mlng病人ID, 0, rsItems!类别, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), 4, mlng病人科室id, 0, 1, , 1)
                            End If
                            .TextMatrix(lngCurRow, COL_执行科室ID) = lng发料部门ID
                        Else
                            '之前先求开嘱科室ID
                            .TextMatrix(lngCurRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, rsItems!类别, rsItems!诊疗项目ID, 0, _
                                Val(.TextMatrix(lngCurRow, COL_执行性质)), mlng病人科室id, Val(.TextMatrix(lngCurRow, COL_开嘱科室ID)), 1, 1)
                        End If
                    End If
                End If
                
                '医生嘱托
                .TextMatrix(lngCurRow, COL_医生嘱托) = NVL(rsItems!医生嘱托)
                .Cell(flexcpData, lngCurRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), "", 0, "", .TextMatrix(lngCurRow, COL_诊疗项目ID) & "|1|1")
                
                
                '开嘱时间
                .TextMatrix(lngCurRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngCurRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
                
                '紧急标志
                .TextMatrix(lngCurRow, COL_标志) = chk紧急.value '可以在界面先统一设置为紧急
                If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(lngCurRow, COL_抗菌等级)) And .TextMatrix(lngCurRow, COL_标志) <> "1" Then
                    .TextMatrix(lngCurRow, COL_审核状态) = 1
                End If
                If .TextMatrix(lngCurRow, COL_类别) = "E" And .TextMatrix(lngCurRow, COL_操作类型) = "8" And Val(.TextMatrix(lngCurRow, COL_相关ID)) <> 0 Then
                    strSQL = ""
                    strSQL = GetBloodState(IIF(.TextMatrix(lngCurRow, COL_标志) = "1", 1, 0), Val(.TextMatrix(lngCurRow, COL_执行分类)))
                    .TextMatrix(lngCurRow - 1, COL_审核状态) = strSQL
                    .TextMatrix(lngCurRow, COL_审核状态) = strSQL
                End If
                Call SetRow标志图标(lngCurRow, 1)
                
                '读取药品库存
                If InStr(",5,6,7,", .TextMatrix(lngCurRow, COL_类别)) > 0 Or .TextMatrix(lngCurRow, COL_类别) = "4" And Val(.TextMatrix(lngCurRow, COL_跟踪在用)) = 1 Then
                    If Val(.TextMatrix(lngCurRow, COL_收费细目ID)) <> 0 And Val(.TextMatrix(lngCurRow, COL_执行科室ID)) <> 0 Then
                        .TextMatrix(lngCurRow, COL_库存) = GetStock(Val(.TextMatrix(lngCurRow, COL_收费细目ID)), Val(.TextMatrix(lngCurRow, COL_执行科室ID)), 1)
                    End If
                End If
                
                If mbytUseType = 1 Then
                    .TextMatrix(lngCurRow, COL_是否备选) = Val("" & rsItems!是否备选)
                End If
                '----------------------
                '毒麻精药品标识:中药配方及组成味中药不处理
                If InStr(",5,6,", .TextMatrix(lngCurRow, COL_类别)) > 0 And .TextMatrix(lngCurRow, COL_毒理分类) <> "" Then
                    If InStr(",麻醉药,毒性药,精神药,精神I类,精神II类,", .TextMatrix(lngCurRow, COL_毒理分类)) > 0 Then
                        .Cell(flexcpFontBold, lngCurRow, col_医嘱内容) = True
                    End If
                End If
                
                '隐蔽一些附加行
                If (InStr(",F,G,D,7,E,C,", rsItems!类别) > 0 And Not IsNull(rsItems!相关序号)) Or bln给药途径 Then
                    .RowHidden(lngCurRow) = True
                End If
                
                '医嘱内容
                If Not .RowHidden(lngCurRow) Then
                    If IsNull(rsItems!诊疗项目ID) Then
                        .TextMatrix(lngCurRow, col_医嘱内容) = rsItems!医嘱内容 '自由录入医嘱
                    ElseIf InStr(",F,D,", rsItems!类别) > 0 And IsNull(rsItems!相关序号) Then
                        .TextMatrix(lngCurRow, col_医嘱内容) = rsItems!名称 '临时
                    Else
                        .TextMatrix(lngCurRow, col_医嘱内容) = AdviceTextMake(lngCurRow)
                    End If
                Else
                    .TextMatrix(lngCurRow, col_医嘱内容) = rsItems!名称
                End If
                
                '产生新嘱时，在可见行读取诊疗项目附项串，用于检查，不用于保存
                If Not .RowHidden(lngCurRow) Then
                    If Not bln中药用法 Then
                        If bln采集方法 Then
                            j = .FindRow(CStr(.RowData(lngCurRow)), , COL_相关ID)
                            If j <> -1 Then
                                .TextMatrix(lngCurRow, COL_附项) = Get医嘱项目附件(Val(.TextMatrix(j, COL_诊疗项目ID)), 1)
                            End If
                        Else
                            .TextMatrix(lngCurRow, COL_附项) = Get医嘱项目附件(Val(.TextMatrix(lngCurRow, COL_诊疗项目ID)), 1)
                        End If
                        If .TextMatrix(lngCurRow, COL_附项) <> "" Then
                            str附项 = str附项 & vbCrLf & "●" & .TextMatrix(lngCurRow, col_医嘱内容)
                        End If
                    End If
                End If
                
                If lngPreRow = -1 And Not .RowHidden(lngCurRow) Then lngPreRow = lngCurRow
                            
                '----------------------
                intCount = intCount + 1
            End If
            rsItems.MoveNext
        Next
        
        lngRow = lngRow + IIF(intType = 3, 1, 0)
        '--------------------------------------------------
        '其它附加处理
        For i = lngRow To lngCurRow
            '取检查和手术的医嘱内容
            If InStr(",F,D,", .TextMatrix(i, COL_类别)) > 0 And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                .TextMatrix(i, col_医嘱内容) = AdviceTextMake(i)
            End If
            
            '计算诊疗单价
            If Not .RowHidden(i) And .TextMatrix(i, COL_单价) = "" Then
                .TextMatrix(i, COL_单价) = GetItemPrice(i)
            End If
        Next
        
        '调整受影响行的序号
        Call AdviceSet医嘱序号(lngCurRow + 1, intCount - IIF(intType = 3, 1, 0))
        '产生假医嘱ID
        For i = lngRow To lngCurRow
            dbl相关ID = .RowData(i)
            If mbytUseType = 1 Then .TextMatrix(i, COL_医嘱内容ID) = CLng(dbl相关ID)
            .RowData(i) = GetNext医嘱ID
            For j = i - 1 To lngRow Step -1
                If Val(.TextMatrix(j, COL_相关ID)) = dbl相关ID Then
                    .TextMatrix(j, COL_相关ID) = .RowData(i)
                Else
                    Exit For
                End If
            Next
            For j = i + 1 To lngCurRow
                If Val(.TextMatrix(j, COL_相关ID)) = dbl相关ID Then
                    .TextMatrix(j, COL_相关ID) = .RowData(i)
                Else
                    Exit For
                End If
            Next
            
            If intType = 3 Then .Cell(flexcpChecked, i, COL_选择) = flexChecked
            '新增后关联诊断的标记处理
            If mbytUseType = 1 Or mbytUseType = 2 Then
                If str诊断IDs = "" Then
                    For j = 1 To vsDiag.Rows - 1
                        If Val(vsDiag.RowData(j)) <> 0 Then
                            str诊断IDs = str诊断IDs & "," & Val(vsDiag.RowData(j))
                        End If
                    Next
                    str诊断IDs = Mid(str诊断IDs, 2)
                End If
                If Val(.TextMatrix(i, COL_相关ID)) = 0 And .Cell(flexcpChecked, i, COL_选择) <> 2 Then Call SetDiagFlag(i, 1, str诊断IDs)
            Else
                If Val(.TextMatrix(i, COL_相关ID)) = 0 Then Call SetDiagFlag(i, 1, str诊断IDs)
            End If
        Next
        
        If gblnOut必用 Then Call MakeAppNo(2, lngRow, lngCurRow)
        
        '一并给药的符号标志
        For i = lngRow To lngCurRow
            If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                If Val(.TextMatrix(i - 1, COL_相关ID)) = .RowData(i) And InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                    Call SetTag一并给药(i - 1)
                End If
            End If
        Next
        
        Call Set医嘱超量(lngRow, lngCurRow)
        If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngCurRow)
        If mbytUseType = 1 Then
            .ColHidden(COL_选择) = bln允许选择 = False
            If bln允许选择 Then
                .Editable = flexEDKbdMouse
            End If
            Call .AutoSize(col_医嘱内容)
        End If
        
        '--------------------------------------------------
        If .RowHidden(lngRow) Then '寻找可见行(如配方和检验之后)
            For i = lngRow + 1 To .Rows - 1
                If Not .RowHidden(i) And .RowData(i) <> 0 Then
                    lngRow = i: Exit For
                End If
            Next
        End If
        '定位到成套方案的第一行，是因为医生调用成套后会检查或修改医嘱，第一行之后的医嘱为成套方案调用的医嘱
        .Row = lngRow: .Col = col_医嘱内容
        Call .ShowCell(.Row, .Col)
        .Redraw = flexRDDirect
        mblnRowChange = True
    End With
    Screen.MousePointer = 0
    
    If str附项 <> "" Then
        MsgBox "以下医嘱需要填写申请附项，请注意填写：" & vbCrLf & str附项, vbInformation, gstrSysName
    End If
    If str高危药品 <> "" Then
        MsgBox "以下医嘱是高危药品：" & str高危药品, vbInformation, gstrSysName
    End If
    Exit Sub
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function GetPreRow中药房(lngRow As Long) As Long
'功能：获取上一或下一中药行的执行科室
    Dim lngDrugRow As Long, lngCopyRow As Long
    
    lngDrugRow = -1
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
    If lngCopyRow <> -1 Then
        If RowIn配方行(lngCopyRow) Then
            '如果上一有效行是中药配方的,则取它的第一中药行
            lngDrugRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngCopyRow)), , COL_相关ID)
        End If
    End If
    
    If lngDrugRow <> -1 Then '缺省与上一配方行相同
        GetPreRow中药房 = Val("" & vsAdvice.TextMatrix(lngDrugRow, COL_执行科室ID))
    End If
End Function

Private Function AdviceSet中药配方(lng诊疗项目ID As Long, ByVal lngRow As Long, ByVal lng用法ID As Long, _
    ByVal strExtData As String, Optional rsCurr As ADODB.Recordset, Optional ByVal str摘要 As String, Optional ByVal lng配方ID As Long) As Long
'功能：(重新)处理中药配方的缺省医嘱数据
'参数：lng诊疗项目ID=输入的中药配方ID或单味中药ID
'      lngRow=当前输入行
'      lng用法ID=缺省中药用法ID
'      strExtData=包含配方组成味药及煎法数据:规格ID1,数量,脚注;规格ID2,数量,脚注...|中药煎法|中药形态|付数|药房ID|煎量"
'      rsCurr=如果是修改了配方内容后调用,则包含要保持的一些当前值
'      str摘要=医保摘要
'返回：处理后的中药配方的当前显示行号
    Dim rsItems As New ADODB.Recordset '中药详细信息
    Dim rsUse As New ADODB.Recordset '中药用法信息
    Dim rs煎法 As New ADODB.Recordset '中药煎法项目信息
    Dim rs用法 As New ADODB.Recordset '中药用法项目信息
    Dim rsTmp As ADODB.Recordset
    Dim arr中药s As Variant, str中药IDs As String, lng相关ID As Long
    Dim lngCopyRow As Long '缺省参照行
    Dim lngDrugRow As Long '如果缺省参照行是中药配方,则为该配方的第一个中药行
    Dim lngFirstRow As Long '当前配方的第一个中药行
    Dim strSQL As String, i As Long
    Dim blnOutOfRange As Boolean
    
    Dim str频率 As String, int频率次数 As Integer, int频率间隔 As Integer, str间隔单位 As String
    Dim lng煎法ID As Long, int疗程 As Integer
    Dim str医生 As String, lng医生ID As Long
    Dim lng形态 As Long
    Dim str高危药品 As String, str煎量 As String
    Dim str配方名称 As String
    Dim str医嘱内容 As String
        
    On Error GoTo errH
    
    '取上一或下一有效行,某些内容缺省与该行相同
    lngDrugRow = -1
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
    If lngCopyRow <> -1 Then
        If RowIn配方行(lngCopyRow) Then
            '如果上一有效行是中药配方的,则取它的第一中药行
            lngDrugRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngCopyRow)), , COL_相关ID)
        End If
    End If
    
    '获取相关数据库信息
    '------------------
    arr中药s = Split(Split(strExtData, "|")(0), ";")
    For i = 0 To UBound(arr中药s)
        str中药IDs = str中药IDs & "," & CStr(Split(arr中药s(i), ",")(0))
    Next
    str中药IDs = Mid(str中药IDs, 2)
    lng煎法ID = Val(Split(strExtData, "|")(1))
    lng形态 = Val(Split(strExtData, "|")(2))
    str煎量 = Split(strExtData, "|")(5)

    
    '配方用法信息:直接输入配方时才有可能有,输入单味中药无
    strSQL = "Select A.用法ID,A.频次,A.疗程,A.医生嘱托" & _
        " From 诊疗用法用量 A,诊疗项目目录 B" & _
        " Where A.用法ID=B.ID And B.服务对象 IN(1,3)" & _
        " And Nvl(A.性质,0)=0 And A.项目ID=[1]" & _
        " And (B.站点='" & gstrNodeNo & "' Or B.站点 is Null)" & _
        " And (b.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or b.撤档时间 is NULL)"
    Set rsUse = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng诊疗项目ID)
    If Not rsUse.EOF Then lng用法ID = rsUse!用法ID '缺省设置的中药配方用法优先
    
    '配方组成味中药信息:中药无规格概念,对应的的规格记录一定有且只有一条
    strSQL = "Select /*+ rule*/A.计算规则,A.站点,A.类别,A.分类ID,A.ID,A.编码,A.名称,A.标本部位,A.计算单位,A.计算方式,A.执行频率,A.适用性别," & _
        "A.单独应用,A.组合项目,A.操作类型,A.执行安排,A.执行科室,A.服务对象,A.计价性质,A.参考目录ID,A.人员ID,A.建档时间,A.撤档时间," & _
        "A.录入限量,A.试管编码,A.执行分类,A.执行标记,B.药品ID,B.剂量系数,B.门诊包装,B.门诊单位,B.门诊可否分零 As 可否分零,C.处方限量,C.处方职务,c.临床自管药,b.高危药品,b.是否易至跌倒" & _
        " From 诊疗项目目录 A,药品规格 B,药品特性 C" & _
        " Where A.ID=B.药名ID And A.ID=C.药名ID And B.药品ID IN(Select Column_Value From Table(f_Num2list([1])))"
    Set rsItems = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str中药IDs)
    
    '配方煎法项目信息
    Set rs煎法 = Get诊疗项目记录(lng煎法ID)
    
    '配方用法项目信息
    Set rs用法 = Get诊疗项目记录(lng用法ID)
    
    '加入配方组成味中药行:按照用户输入顺序
    '--------------------------------------------------------------------------------------
    '--------------------------------------------------------------------------------------
    mblnRowChange = False
    
    '中药用法的医嘱ID,ID顺序与序号不一定一致
    If Not rsCurr Is Nothing Then
        '修改了配方中的内容,用法行标记为修改,医嘱ID不变
        lng相关ID = rsCurr!医嘱ID
    Else
        '新输入的中药配方
        lng相关ID = GetNext医嘱ID
    End If
    
    For i = 0 To UBound(arr中药s)
        rsItems.Filter = "药品ID=" & CStr(Split(arr中药s(i), ",")(0)) '应该肯定有
        
        vsAdvice.AddItem "", lngRow
        
        vsAdvice.RowHidden(lngRow) = True
        vsAdvice.RowData(lngRow) = GetNext医嘱ID
        vsAdvice.TextMatrix(lngRow, COL_相关ID) = lng相关ID '对应到后面的中药用法行
        vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1 '新增
        vsAdvice.TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
        vsAdvice.TextMatrix(lngRow, COL_状态) = 1 '新开
        vsAdvice.TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
        Call AdviceSet医嘱序号(lngRow + 1, 1) '调整序号
        
        vsAdvice.TextMatrix(lngRow, COL_类别) = rsItems!类别
        vsAdvice.TextMatrix(lngRow, col_医嘱内容) = rsItems!名称
        vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) = rsItems!ID
        vsAdvice.TextMatrix(lngRow, COL_计算方式) = NVL(rsItems!计算方式, 0)
        vsAdvice.TextMatrix(lngRow, COL_频率性质) = NVL(rsItems!执行频率, 0)
        vsAdvice.TextMatrix(lngRow, COL_操作类型) = NVL(rsItems!操作类型)
        vsAdvice.TextMatrix(lngRow, COL_执行分类) = NVL(rsItems!执行分类, 0)
        
        vsAdvice.TextMatrix(lngRow, COL_单量) = FormatEx(Val(Split(arr中药s(i), ",")(1)), 5) '单味药的单次用量
        vsAdvice.TextMatrix(lngRow, COL_单量单位) = NVL(rsItems!计算单位)
        vsAdvice.TextMatrix(lngRow, COL_医生嘱托) = CStr(Split(arr中药s(i), ",")(2)) '单味药的脚注
        vsAdvice.Cell(flexcpData, lngRow, COL_医生嘱托) = str摘要
        
        '规格信息:中药不存在规格概念,一定有
        vsAdvice.TextMatrix(lngRow, COL_收费细目ID) = rsItems!药品ID
        vsAdvice.TextMatrix(lngRow, COL_处方限量) = NVL(rsItems!处方限量)
        vsAdvice.TextMatrix(lngRow, COL_剂量系数) = rsItems!剂量系数
        vsAdvice.TextMatrix(lngRow, COL_门诊单位) = rsItems!门诊单位
        vsAdvice.TextMatrix(lngRow, COL_门诊包装) = rsItems!门诊包装
        vsAdvice.TextMatrix(lngRow, COL_可否分零) = NVL(rsItems!可否分零, 0) '对中药实际上无用
        vsAdvice.TextMatrix(lngRow, COL_处方职务) = NVL(rsItems!处方职务)
        vsAdvice.TextMatrix(lngRow, COL_临床自管药) = rsItems!临床自管药 & ""
        vsAdvice.TextMatrix(lngRow, COL_高危药品) = rsItems!高危药品 & ""
        vsAdvice.TextMatrix(lngRow, COL_易跌倒) = rsItems!是否易至跌倒 & ""
        If Val(vsAdvice.TextMatrix(lngRow, COL_高危药品)) <> 0 Then
            str高危药品 = str高危药品 & vbCrLf & vsAdvice.TextMatrix(lngRow, col_医嘱内容) & ":" & Decode(Val(vsAdvice.TextMatrix(lngRow, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级；"
        End If
        vsAdvice.Cell(flexcpData, lngRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, Val(vsAdvice.TextMatrix(lngRow, COL_收费细目ID)), "", 0, "", vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) & "||1")
        '计价性质:各自独立
        vsAdvice.TextMatrix(lngRow, COL_计价性质) = NVL(rsItems!计价性质, 0)
        
        If lngFirstRow <> 0 Then
            '与上一行已设置的组成中药相同
            vsAdvice.TextMatrix(lngRow, COL_执行性质) = vsAdvice.TextMatrix(lngFirstRow, COL_执行性质)
            vsAdvice.TextMatrix(lngRow, COL_执行科室ID) = vsAdvice.TextMatrix(lngFirstRow, COL_执行科室ID)
            vsAdvice.TextMatrix(lngRow, COL_频率) = vsAdvice.TextMatrix(lngFirstRow, COL_频率)
            vsAdvice.TextMatrix(lngRow, COL_频率次数) = vsAdvice.TextMatrix(lngFirstRow, COL_频率次数)
            vsAdvice.TextMatrix(lngRow, COL_频率间隔) = vsAdvice.TextMatrix(lngFirstRow, COL_频率间隔)
            vsAdvice.TextMatrix(lngRow, COL_间隔单位) = vsAdvice.TextMatrix(lngFirstRow, COL_间隔单位)
            vsAdvice.TextMatrix(lngRow, COL_总量) = vsAdvice.TextMatrix(lngFirstRow, COL_总量)
            vsAdvice.TextMatrix(lngRow, COL_执行时间) = vsAdvice.TextMatrix(lngFirstRow, COL_执行时间)
            
            vsAdvice.TextMatrix(lngRow, COL_开始时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开始时间)
            vsAdvice.Cell(flexcpData, lngRow, COL_开始时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开始时间)
            
            vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱医生)
            vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID)
            
            vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱时间)
            vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开嘱时间)
            
            vsAdvice.TextMatrix(lngRow, COL_标志) = vsAdvice.TextMatrix(lngFirstRow, COL_标志)
        ElseIf Not rsCurr Is Nothing Then
            '修改了配方内容后重新设置,保持与当前的值
            
            '执行性质:修改时根据当前界面设置决定
            vsAdvice.TextMatrix(lngRow, COL_执行性质) = Decode(NVL(rsCurr!执行性质), "自备药", 5, 4)
            '执行科室
            vsAdvice.TextMatrix(lngRow, COL_执行科室ID) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_执行性质)) = 5, 0, Val("" & rsCurr!执行科室ID))
            
            vsAdvice.TextMatrix(lngRow, COL_频率) = NVL(rsCurr!频率)
            vsAdvice.TextMatrix(lngRow, COL_频率次数) = NVL(rsCurr!频率次数)
            vsAdvice.TextMatrix(lngRow, COL_频率间隔) = NVL(rsCurr!频率间隔)
            vsAdvice.TextMatrix(lngRow, COL_间隔单位) = NVL(rsCurr!间隔单位)
            vsAdvice.TextMatrix(lngRow, COL_总量) = NVL(rsCurr!总量)
            vsAdvice.TextMatrix(lngRow, COL_执行时间) = NVL(rsCurr!执行时间)
            
            vsAdvice.TextMatrix(lngRow, COL_开始时间) = Format(NVL(rsCurr!开始时间), "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_开始时间) = CStr(NVL(rsCurr!开始时间))
            
            vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = NVL(rsCurr!开嘱医生)
            vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = NVL(rsCurr!开嘱科室id)
            
            vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = Format(NVL(rsCurr!开嘱时间), "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = CStr(NVL(rsCurr!开嘱时间))
            
            vsAdvice.TextMatrix(lngRow, COL_标志) = NVL(rsCurr!标志)
        Else
            '执行性质:中药配方组成中药相同,缺省=4-指定科室,5-自备药
            vsAdvice.TextMatrix(lngRow, COL_执行性质) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_临床自管药)) = 1, 5, 4)
        
            '执行科室(先在配方界面选择)
            vsAdvice.TextMatrix(lngRow, COL_执行科室ID) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_执行性质)) = 5, 0, Val(Split(strExtData, "|")(4)))
            
            '执行频率
            '根据用法里面设置的优先
            If Not rsUse.EOF Then
                If Not IsNull(rsUse!频次) Then
                    Call Get频率信息_编码(rsUse!频次, str频率, int频率次数, int频率间隔, str间隔单位)
                    vsAdvice.TextMatrix(lngRow, COL_频率) = str频率
                    vsAdvice.TextMatrix(lngRow, COL_频率次数) = int频率次数
                    vsAdvice.TextMatrix(lngRow, COL_频率间隔) = int频率间隔
                    vsAdvice.TextMatrix(lngRow, COL_间隔单位) = str间隔单位
                End If
            End If
            '或缺省与上一行相同
            If vsAdvice.TextMatrix(lngRow, COL_频率) = "" And lngDrugRow <> -1 Then
                If Val(vsAdvice.TextMatrix(lngDrugRow, COL_EDIT)) = 1 And vsAdvice.TextMatrix(lngDrugRow, COL_频率) <> "" Then
                    vsAdvice.TextMatrix(lngRow, COL_频率) = vsAdvice.TextMatrix(lngDrugRow, COL_频率)
                    vsAdvice.TextMatrix(lngRow, COL_频率次数) = vsAdvice.TextMatrix(lngDrugRow, COL_频率次数)
                    vsAdvice.TextMatrix(lngRow, COL_频率间隔) = vsAdvice.TextMatrix(lngDrugRow, COL_频率间隔)
                    vsAdvice.TextMatrix(lngRow, COL_间隔单位) = vsAdvice.TextMatrix(lngDrugRow, COL_间隔单位)
                End If
            End If
            '或取缺省值
            If vsAdvice.TextMatrix(lngRow, COL_频率) = "" Then
                Call Get缺省频率(NVL(rsItems!ID, 0), 2, str频率, int频率次数, int频率间隔, str间隔单位)
                vsAdvice.TextMatrix(lngRow, COL_频率) = str频率
                vsAdvice.TextMatrix(lngRow, COL_频率次数) = int频率次数
                vsAdvice.TextMatrix(lngRow, COL_频率间隔) = int频率间隔
                vsAdvice.TextMatrix(lngRow, COL_间隔单位) = str间隔单位
            End If
            
            '总量(付数):非散装形态已确定付数
            If Val(Split(strExtData, "|")(3)) > 1 Or lng形态 <> 0 Then
                vsAdvice.TextMatrix(lngRow, COL_总量) = Val(Split(strExtData, "|")(3))
            Else
                If vsAdvice.TextMatrix(lngRow, COL_频率) <> "" Then
                    int疗程 = 1
                    If Not rsUse.EOF Then int疗程 = NVL(rsUse!疗程, 1)
                    '配方付数
                    vsAdvice.TextMatrix(lngRow, COL_总量) = Calc缺省药品总量(1, int疗程, _
                            Val(vsAdvice.TextMatrix(lngRow, COL_频率次数)), _
                            Val(vsAdvice.TextMatrix(lngRow, COL_频率间隔)), _
                            vsAdvice.TextMatrix(lngRow, COL_间隔单位))
                End If
            End If
            
            '执行时间
            If lngDrugRow <> -1 Then '缺省与上一行相同
                If vsAdvice.TextMatrix(lngRow, COL_频率) = vsAdvice.TextMatrix(lngDrugRow, COL_频率) Then
                    vsAdvice.TextMatrix(lngRow, COL_执行时间) = vsAdvice.TextMatrix(lngDrugRow, COL_执行时间)
                End If
            End If
            If vsAdvice.TextMatrix(lngRow, COL_执行时间) = "" Then '缺省时间方案
                vsAdvice.TextMatrix(lngRow, COL_执行时间) = Get缺省时间(2, vsAdvice.TextMatrix(lngRow, COL_频率), lng用法ID)
            End If
            
            '开始时间
            If IsDate(msk开始时间.Text) Then
                vsAdvice.TextMatrix(lngRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                vsAdvice.Cell(flexcpData, lngRow, COL_开始时间) = msk开始时间.Text
            End If
            
            '开嘱医生
            vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
            vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
            
            vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
            vsAdvice.TextMatrix(lngRow, COL_标志) = chk紧急.value
        End If
        
        '---------------------------------------
        If lngFirstRow = 0 Then lngFirstRow = lngRow '该中药配方的第一个组成中药行
        
        lngRow = lngRow + 1 '保持当前输入行位置
    Next
    
    '加入中药配方煎法行
    '--------------------------------------------------------------------------------------
    '--------------------------------------------------------------------------------------
    vsAdvice.AddItem "", lngRow
    vsAdvice.RowHidden(lngRow) = True
    vsAdvice.RowData(lngRow) = GetNext医嘱ID
    vsAdvice.TextMatrix(lngRow, COL_相关ID) = lng相关ID
    vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1 '新增
    vsAdvice.TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
    vsAdvice.TextMatrix(lngRow, COL_状态) = 1 '新开
    vsAdvice.TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
    Call AdviceSet医嘱序号(lngRow + 1, 1) '调整序号
    vsAdvice.TextMatrix(lngRow, COL_类别) = rs煎法!类别
    vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) = lng煎法ID
    vsAdvice.TextMatrix(lngRow, COL_标本部位) = str煎量
    vsAdvice.Cell(flexcpData, lngRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) & "||1")
    
    vsAdvice.TextMatrix(lngRow, COL_计算方式) = NVL(rs煎法!计算方式, 0)
    vsAdvice.TextMatrix(lngRow, COL_频率性质) = NVL(rs煎法!执行频率, 0)
    vsAdvice.TextMatrix(lngRow, COL_操作类型) = NVL(rs煎法!操作类型)
    vsAdvice.TextMatrix(lngRow, COL_执行分类) = NVL(rs煎法!执行分类, 0)
    
    '!中药煎法中也存放中药的付数
    vsAdvice.TextMatrix(lngRow, COL_总量) = vsAdvice.TextMatrix(lngFirstRow, COL_总量)
    
    vsAdvice.TextMatrix(lngRow, col_医嘱内容) = rs煎法!名称
    
    vsAdvice.TextMatrix(lngRow, COL_开始时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开始时间)
    vsAdvice.Cell(flexcpData, lngRow, COL_开始时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开始时间)
    
    vsAdvice.TextMatrix(lngRow, COL_频率) = vsAdvice.TextMatrix(lngFirstRow, COL_频率)
    vsAdvice.TextMatrix(lngRow, COL_频率次数) = vsAdvice.TextMatrix(lngFirstRow, COL_频率次数)
    vsAdvice.TextMatrix(lngRow, COL_频率间隔) = vsAdvice.TextMatrix(lngFirstRow, COL_频率间隔)
    vsAdvice.TextMatrix(lngRow, COL_间隔单位) = vsAdvice.TextMatrix(lngFirstRow, COL_间隔单位)
    vsAdvice.TextMatrix(lngRow, COL_执行时间) = vsAdvice.TextMatrix(lngFirstRow, COL_执行时间)
    
    '执行性质:缺省根据项目设置(不可能为院外执行),修改时根据当前界面设置
    If rsCurr Is Nothing Then
        vsAdvice.TextMatrix(lngRow, COL_执行性质) = NVL(rs煎法!执行科室, 0)
    Else
        vsAdvice.TextMatrix(lngRow, COL_执行性质) = Decode(NVL(rsCurr!执行性质), "离院带药", 5, NVL(rs煎法!执行科室, 0))
    End If
    
    '中药煎法如果未设置执行科室,则缺省为病人所在病区(门诊要改为病人所在科室!!)
    If InStr(",0,5,", Val(vsAdvice.TextMatrix(lngRow, COL_执行性质))) = 0 Then
        vsAdvice.TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, rs煎法!类别, lng煎法ID, 0, _
            NVL(rs煎法!执行科室, 0), mlng病人科室id, Val(vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID)), 1, 1)
    End If
    
    vsAdvice.TextMatrix(lngRow, COL_计价性质) = NVL(rs煎法!计价性质, 0)
    vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID)
    vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱医生)
    
    vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱时间)
    vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开嘱时间)
    
    vsAdvice.TextMatrix(lngRow, COL_标志) = vsAdvice.TextMatrix(lngFirstRow, COL_标志)
    
    '保持当前输入行位置
    lngRow = lngRow + 1
    
    '设置中药配方用法行:中药配方的显示行
    '--------------------------------------------------------------------------------------
    '--------------------------------------------------------------------------------------
    vsAdvice.RowData(lngRow) = lng相关ID
    Set rsTmp = Get诊疗项目记录(lng诊疗项目ID)
    If rsTmp!类别 & "" = "8" Then
        vsAdvice.TextMatrix(lngRow, COL_配方ID) = lng诊疗项目ID
        str配方名称 = rsTmp!名称 & ":"
    End If
    If lng配方ID <> 0 Then
        vsAdvice.TextMatrix(lngRow, COL_配方ID) = lng配方ID
    End If
    
    If Not rsCurr Is Nothing Then
        '修改了配方内容,标记为修改
        If InStr(",0,3,", rsCurr!Edit) > 0 Then
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = 2 '标记为被修改
        Else
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = rsCurr!Edit '本来就是新增或修改
        End If
    Else
        '新输入的中药配方,为新增
        vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1
    End If
    
    vsAdvice.TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
    vsAdvice.TextMatrix(lngRow, COL_状态) = 1 '新开
    vsAdvice.TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
    Call AdviceSet医嘱序号(lngRow + 1, 1) '调整序号
    vsAdvice.TextMatrix(lngRow, COL_类别) = rs用法!类别
    vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) = lng用法ID
    vsAdvice.Cell(flexcpData, lngRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) & "||1")
    
    vsAdvice.TextMatrix(lngRow, COL_计算方式) = NVL(rs用法!计算方式, 0)
    vsAdvice.TextMatrix(lngRow, COL_频率性质) = NVL(rs用法!执行频率, 0)
    vsAdvice.TextMatrix(lngRow, COL_操作类型) = NVL(rs用法!操作类型)
    vsAdvice.TextMatrix(lngRow, COL_执行分类) = NVL(rs用法!执行分类, 0)
    
    '!中药用法中也存放中药的付数
    vsAdvice.TextMatrix(lngRow, COL_总量) = vsAdvice.TextMatrix(lngFirstRow, COL_总量)
    vsAdvice.TextMatrix(lngRow, COL_总量单位) = "付"
    
    vsAdvice.TextMatrix(lngRow, COL_开始时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开始时间)
    vsAdvice.Cell(flexcpData, lngRow, COL_开始时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开始时间)
    
    vsAdvice.TextMatrix(lngRow, COL_名称) = rs用法!名称
    vsAdvice.TextMatrix(lngRow, COL_用法) = rs用法!名称
    vsAdvice.TextMatrix(lngRow, COL_频率) = vsAdvice.TextMatrix(lngFirstRow, COL_频率)
    vsAdvice.TextMatrix(lngRow, COL_频率次数) = vsAdvice.TextMatrix(lngFirstRow, COL_频率次数)
    vsAdvice.TextMatrix(lngRow, COL_频率间隔) = vsAdvice.TextMatrix(lngFirstRow, COL_频率间隔)
    vsAdvice.TextMatrix(lngRow, COL_间隔单位) = vsAdvice.TextMatrix(lngFirstRow, COL_间隔单位)
    vsAdvice.TextMatrix(lngRow, COL_执行时间) = vsAdvice.TextMatrix(lngFirstRow, COL_执行时间)
    
    '执行性质:缺省根据项目设置(不可能为院外执行),修改时根据当前界面设置
    If rsCurr Is Nothing Then
        vsAdvice.TextMatrix(lngRow, COL_执行性质) = NVL(rs用法!执行科室, 0)
    Else
        vsAdvice.TextMatrix(lngRow, COL_执行性质) = Decode(NVL(rsCurr!执行性质), "离院带药", 5, NVL(rs用法!执行科室, 0))
    End If
    
    '中药用法如果未设置执行科室,则缺省为病人所在病区(门诊要改为病人所在科室!!)
    If InStr(",0,5,", Val(vsAdvice.TextMatrix(lngRow, COL_执行性质))) = 0 Then
        vsAdvice.TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, rs用法!类别, lng用法ID, 0, _
            NVL(rs用法!执行科室, 0), mlng病人科室id, Val(vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID)), 1, 1)
    End If
    
    vsAdvice.TextMatrix(lngRow, COL_计价性质) = NVL(rs用法!计价性质, 0)
    vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID)
    vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱医生)
    
    vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱时间)
    vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开嘱时间)
    
    vsAdvice.TextMatrix(lngRow, COL_标志) = vsAdvice.TextMatrix(lngFirstRow, COL_标志)
    Call SetRow标志图标(lngRow)
        
    If Not rsCurr Is Nothing Then
        vsAdvice.TextMatrix(lngRow, COL_医生嘱托) = NVL(rsCurr!医生嘱托)
    ElseIf Not rsUse.EOF Then
        vsAdvice.TextMatrix(lngRow, COL_医生嘱托) = NVL(rsUse!医生嘱托)
    End If
    '中药形态(用于AdviceTextMake中)
    vsAdvice.TextMatrix(lngRow, COL_中药形态) = lng形态
    '处方限量检查
    Call CheckCHLimited(lngRow, vsAdvice.TextMatrix(lngRow, COL_总量), blnOutOfRange, vsAdvice, COL_相关ID, COL_诊疗项目ID, COL_类别, COL_单量)
    If blnOutOfRange Then vsAdvice.TextMatrix(lngRow, COL_是否超量) = "1"
    '中药配方的中药库存
    Call GetDrugStock(lngRow)
    
    '中药配方医嘱内容
    str医嘱内容 = AdviceTextMake(lngRow)
    
    If Val(Split(strExtData, "|")(6)) = 0 Then
        str医嘱内容 = "中药配方:" & str医嘱内容
    Else
        str医嘱内容 = str配方名称 & str医嘱内容
    End If
    
    vsAdvice.TextMatrix(lngRow, col_医嘱内容) = str医嘱内容
    
    '-------------------
    vsAdvice.Row = lngRow
    mblnRowChange = True
    
    If str高危药品 <> "" Then
        MsgBox "以下医嘱是高危药品：" & str高危药品, vbInformation, gstrSysName
    End If
        
    AdviceSet中药配方 = lngRow
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function AdviceSet检验组合(ByVal lngRow As Long, ByVal lng采集方法ID As Long, ByVal strExtData As String, Optional rsCurr As ADODB.Recordset, Optional ByVal str摘要 As String, Optional ByVal bln申请单 As Boolean) As Long
'功能：处理新增的检验(组合)
'参数：rsItems=输入或选择返回的记录集
'      lngRow=当前输入行
'      lng采集方法ID=缺省的采集方法
'      strExtData=检查:"项目ID1,项目ID2,...;检验标本"如果是新版LIS的模式则是："项目ID1|指标1|指标2...,项目ID2|指标1|指标2...,...;检验标本"
'      rsCurr=修改检验项目时用
'      str摘要=医保摘要
'      bln申请单 申请单保存后调用
'返回：处理之后的当前显示行号
    Dim rsMore As New ADODB.Recordset '采集方法信息
    Dim rsItems As New ADODB.Recordset '检验项目信息
    Dim arrItems As Variant, strItems As String
    Dim strSQL As String, curDate As Date
    Dim str医生 As String, lng医生ID As Long
    Dim str频率 As String, int频率次数 As Integer
    Dim int频率间隔 As Integer, str间隔单位 As String
    Dim lng相关ID As Long, str医嘱内容 As String
    Dim lngCopyRow As Long, lngFirstRow As Long, i As Long
    Dim rsLIS As New ADODB.Recordset
    Dim strTmp As String
    Dim Y As Long
    Dim blnLis As Boolean
    
    On Error GoTo errH
    
    '取上一或下一有效行,某些内容缺省与该行相同
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
    '当前时间
    curDate = zlDatabase.Currentdate
    
    '检验项目信息
    '----------------------------------------------------------------------------
    '各个检验项目信息:按输入顺序
    arrItems = Split(Split(strExtData, ";")(0), ",")
    For i = UBound(arrItems) To 0 Step -1
        If mblnNewLIS Then
            strTmp = arrItems(i)
            If InStr(strTmp, "|") > 0 Then
                For Y = 0 To UBound(Split(strTmp, "|"))
                    strItems = strItems & "," & Val(Split(strTmp, "|")(Y))
                    If Y > 0 Then
                        strSQL = strSQL & " Union All " & " Select '" & Val(Split(strTmp, "|")(Y)) & "' as 子项,'" & Val(Split(strTmp, "|")(0)) & "' as 父项 From Dual "
                    End If
                Next
            Else
                strItems = strItems & "," & Val(strTmp)
            End If
        Else
            strItems = strItems & "," & Val(arrItems(i))
        End If
    Next
    If strSQL <> "" Then
        Set rsLIS = zlDatabase.OpenSQLRecord(Mid(strSQL, 11), Me.Caption)
        blnLis = True
    End If
    Set rsItems = Get诊疗项目记录(0, Mid(strItems, 2))
    
    If Not bln申请单 Then
        '取某个检验项目的采集方法
        strSQL = "Select /*+ RULE */ A.项目ID,Nvl(A.性质,0) as 序号,A.用法ID" & _
            " From 诊疗用法用量 A,诊疗项目目录 B" & _
            " Where A.用法ID=B.ID And B.服务对象 IN(1,3)" & _
            " And A.项目ID IN(Select Column_Value From Table(f_Num2list([1])))" & _
            " And (B.站点='" & gstrNodeNo & "' Or B.站点 is Null)" & _
            " And (b.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or b.撤档时间 is NULL)" & _
            " Order by A.项目ID,Nvl(A.性质,0)"
        Set rsMore = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Mid(strItems, 2))
        If Not rsMore.EOF Then
            If rsCurr Is Nothing Or lng采集方法ID = 0 Then
                lng采集方法ID = rsMore!用法ID '修改时不变
            End If
        End If
    End If
    
    Set rsMore = Get诊疗项目记录(lng采集方法ID)
    
    mblnRowChange = False
    
    '设置各行检验项目
    '----------------------------------------------------------------------------
    '采集方法医嘱ID,ID顺序与序号不一定一致
    If Not rsCurr Is Nothing Then
        '修改了检验组合中的内容,采集方法行标记为修改,医嘱ID不变
        lng相关ID = rsCurr!医嘱ID
    Else
        '新输入的
        lng相关ID = GetNext医嘱ID
    End If
    With vsAdvice
        For i = 1 To rsItems.RecordCount
            .AddItem "", lngRow
            
            .RowHidden(lngRow) = True
            .RowData(lngRow) = GetNext医嘱ID
            .TextMatrix(lngRow, COL_相关ID) = lng相关ID '对应到采集方法行
            .TextMatrix(lngRow, COL_EDIT) = 1 '新增
            .TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
            .TextMatrix(lngRow, COL_状态) = 1 '新开
            
            .TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
            Call AdviceSet医嘱序号(lngRow + 1, 1) '调整序号
            
            .TextMatrix(lngRow, COL_类别) = rsItems!类别
            .TextMatrix(lngRow, col_医嘱内容) = rsItems!名称
            .TextMatrix(lngRow, COL_诊疗项目ID) = rsItems!ID
            .TextMatrix(lngRow, COL_计算方式) = NVL(rsItems!计算方式, 0)
            .TextMatrix(lngRow, COL_频率性质) = NVL(rsItems!执行频率, 0)
            .TextMatrix(lngRow, COL_操作类型) = NVL(rsItems!操作类型)
            .TextMatrix(lngRow, COL_执行分类) = NVL(rsItems!执行分类, 0)
            .TextMatrix(lngRow, COL_处方限量) = NVL(rsItems!录入限量)
            .TextMatrix(lngRow, COL_计价性质) = NVL(rsItems!计价性质, 0)
            .TextMatrix(lngRow, COL_执行性质) = NVL(rsItems!执行科室, 0)
            '检验标本
            .TextMatrix(lngRow, COL_标本部位) = Split(strExtData, ";")(1)
            If mblnNewLIS And rsItems!ID & "" <> "" And blnLis Then
                rsLIS.Filter = "子项=" & rsItems!ID
                If rsLIS.EOF = False Then
                    .TextMatrix(lngRow, COL_组合项目ID) = rsLIS!父项 & ""
                End If
            End If
            
            .Cell(flexcpData, lngRow, COL_医生嘱托) = str摘要
            
            '部份内容一并采集的检验项目相同
            If lngFirstRow <> 0 Then
                .TextMatrix(lngRow, COL_总量) = .TextMatrix(lngFirstRow, COL_总量)
                
                '一并采集的检验项目应该相同
                If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                    .TextMatrix(lngRow, COL_执行科室ID) = .TextMatrix(lngFirstRow, COL_执行科室ID)
                End If
                .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngFirstRow, COL_频率)
                .TextMatrix(lngRow, COL_频率次数) = .TextMatrix(lngFirstRow, COL_频率次数)
                .TextMatrix(lngRow, COL_频率间隔) = .TextMatrix(lngFirstRow, COL_频率间隔)
                .TextMatrix(lngRow, COL_间隔单位) = .TextMatrix(lngFirstRow, COL_间隔单位)
                .TextMatrix(lngRow, COL_执行时间) = .TextMatrix(lngFirstRow, COL_执行时间)
                
                .TextMatrix(lngRow, COL_开始时间) = .TextMatrix(lngFirstRow, COL_开始时间)
                .Cell(flexcpData, lngRow, COL_开始时间) = .Cell(flexcpData, lngFirstRow, COL_开始时间)
                
                .TextMatrix(lngRow, COL_开嘱医生) = .TextMatrix(lngFirstRow, COL_开嘱医生)
                .TextMatrix(lngRow, COL_开嘱科室ID) = .TextMatrix(lngFirstRow, COL_开嘱科室ID)
                
                .TextMatrix(lngRow, COL_开嘱时间) = .TextMatrix(lngFirstRow, COL_开嘱时间)
                .Cell(flexcpData, lngRow, COL_开嘱时间) = .Cell(flexcpData, lngFirstRow, COL_开嘱时间)
                
                .TextMatrix(lngRow, COL_标志) = .TextMatrix(lngFirstRow, COL_标志)
            ElseIf Not rsCurr Is Nothing Then
                .TextMatrix(lngRow, COL_总量) = NVL(rsCurr!总量, 1)
                
                '执行科室:执行性质为(0-叮嘱,5-院外执行)无执行科室
                If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                    If NVL(rsCurr!执行科室ID, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_执行科室ID) = rsCurr!执行科室ID
                    Else
                        .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, rsItems!类别, rsItems!ID, 0, _
                            NVL(rsItems!执行科室, 0), mlng病人科室id, NVL(rsCurr!开嘱科室id, 0), 1, 1)
                    End If
                End If
                
                '执行频率
                .TextMatrix(lngRow, COL_频率) = NVL(rsCurr!频率)
                .TextMatrix(lngRow, COL_频率次数) = NVL(rsCurr!频率次数)
                .TextMatrix(lngRow, COL_频率间隔) = NVL(rsCurr!频率间隔)
                .TextMatrix(lngRow, COL_间隔单位) = NVL(rsCurr!间隔单位)
                .TextMatrix(lngRow, COL_执行时间) = NVL(rsCurr!执行时间)
                
                '时间/科室/医生
                .TextMatrix(lngRow, COL_开始时间) = Format(NVL(rsCurr!开始时间), "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开始时间) = CStr(NVL(rsCurr!开始时间))
                
                .TextMatrix(lngRow, COL_开嘱时间) = Format(NVL(rsCurr!开嘱时间), "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开嘱时间) = CStr(NVL(rsCurr!开嘱时间))
                
                .TextMatrix(lngRow, COL_开嘱医生) = NVL(rsCurr!开嘱医生)
                .TextMatrix(lngRow, COL_开嘱科室ID) = NVL(rsCurr!开嘱科室id)
                
                .TextMatrix(lngRow, COL_标志) = NVL(rsCurr!标志)
            Else
                .TextMatrix(lngRow, COL_总量) = 1 '缺省为1(次)
                
                '开嘱医生
                .TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
                .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
                
                '执行科室:执行性质为(0-叮嘱,5-院外执行)无执行科室
                If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                    '之前要求出开嘱科室ID
                    .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, rsItems!类别, rsItems!ID, 0, _
                        NVL(rsItems!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), 1, 1)
                End If
                
                '执行频率
                Call Get缺省频率(NVL(rsItems!ID, 0), Get频率范围(lngRow), str频率, int频率次数, int频率间隔, str间隔单位)
                .TextMatrix(lngRow, COL_频率) = str频率
                .TextMatrix(lngRow, COL_频率次数) = int频率次数
                .TextMatrix(lngRow, COL_频率间隔) = int频率间隔
                .TextMatrix(lngRow, COL_间隔单位) = str间隔单位
                
                '执行时间:"可选频率"(药品是可选频率,但可能设置为一次性)
                If Val(.TextMatrix(lngRow, COL_频率性质)) = 0 Then
                    If lngCopyRow <> -1 Then '与上一行相同
                        If .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngCopyRow, COL_频率) Then
                            .TextMatrix(lngRow, COL_执行时间) = .TextMatrix(lngCopyRow, COL_执行时间)
                        End If
                    End If
                    If .TextMatrix(lngRow, COL_执行时间) = "" Then  '缺省时间方案
                        .TextMatrix(lngRow, COL_执行时间) = Get缺省时间(1, .TextMatrix(lngRow, COL_频率))
                    End If
                End If
            
                '开始时间
                If IsDate(msk开始时间.Text) Then
                    .TextMatrix(lngRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, lngRow, COL_开始时间) = msk开始时间.Text
                End If
                
                '开嘱时间
                .TextMatrix(lngRow, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                
                '紧急标志
                .TextMatrix(lngRow, COL_标志) = chk紧急.value
            End If
            
            str医嘱内容 = str医嘱内容 & "," & rsItems!名称 '医嘱内容
            If lngFirstRow = 0 Then lngFirstRow = lngRow '第一项目行
            lngRow = lngRow + 1 '保持当前输入行位置
            
            rsItems.MoveNext
        Next
        
        '设置标本的采集方法
        '----------------------------------------------------------------------------
        rsItems.MoveFirst
        .RowData(lngRow) = lng相关ID
        
        If Not rsCurr Is Nothing Then
            '修改了检验组合内容,标记为修改
            If InStr(",0,3,", rsCurr!Edit) > 0 Then
                vsAdvice.TextMatrix(lngRow, COL_EDIT) = 2 '标记为被修改
            Else
                vsAdvice.TextMatrix(lngRow, COL_EDIT) = rsCurr!Edit '本来就是新增或修改
            End If
        Else
            '新输入的检验组合,为新增
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1
        End If
        
        .TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
        .TextMatrix(lngRow, COL_状态) = 1 '新开
        
        .TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
        Call AdviceSet医嘱序号(lngRow + 1, 1) '调整序号
        
        .TextMatrix(lngRow, COL_类别) = rsMore!类别
        .TextMatrix(lngRow, COL_名称) = rsMore!名称
        .TextMatrix(lngRow, COL_用法) = rsMore!名称
        .TextMatrix(lngRow, COL_诊疗项目ID) = rsMore!ID
        .TextMatrix(lngRow, COL_计算方式) = NVL(rsMore!计算方式, 0)
        .TextMatrix(lngRow, COL_频率性质) = NVL(rsMore!执行频率, 0)
        .TextMatrix(lngRow, COL_操作类型) = NVL(rsMore!操作类型)
        .TextMatrix(lngRow, COL_执行分类) = NVL(rsMore!执行分类, 0)
        .TextMatrix(lngRow, COL_计价性质) = NVL(rsMore!计价性质, 0)
        .TextMatrix(lngRow, COL_标本部位) = .TextMatrix(lngFirstRow, COL_标本部位)
        
        '总量为检验项目的,与检验项目相同
        .TextMatrix(lngRow, COL_总量) = .TextMatrix(lngFirstRow, COL_总量)
        .TextMatrix(lngRow, COL_总量单位) = NVL(rsMore!计算单位)
        
        '执行频率
        .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngFirstRow, COL_频率)
        .TextMatrix(lngRow, COL_频率次数) = .TextMatrix(lngFirstRow, COL_频率次数)
        .TextMatrix(lngRow, COL_频率间隔) = .TextMatrix(lngFirstRow, COL_频率间隔)
        .TextMatrix(lngRow, COL_间隔单位) = .TextMatrix(lngFirstRow, COL_间隔单位)
        .TextMatrix(lngRow, COL_执行时间) = .TextMatrix(lngFirstRow, COL_执行时间)
        .TextMatrix(lngRow, COL_执行性质) = NVL(rsMore!执行科室, 0)
        
        '执行科室:执行性质为(0-叮嘱,5-院外执行)无执行科室
        If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
            .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, rsMore!类别, rsMore!ID, 0, _
                NVL(rsMore!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngFirstRow, COL_开嘱科室ID)), 1, 1)
        End If
        
        '时间/科室/医生
        .TextMatrix(lngRow, COL_开始时间) = .TextMatrix(lngFirstRow, COL_开始时间)
        .Cell(flexcpData, lngRow, COL_开始时间) = .Cell(flexcpData, lngFirstRow, COL_开始时间)
        .TextMatrix(lngRow, COL_开嘱时间) = .TextMatrix(lngFirstRow, COL_开嘱时间)
        .Cell(flexcpData, lngRow, COL_开嘱时间) = .Cell(flexcpData, lngFirstRow, COL_开嘱时间)
        .TextMatrix(lngRow, COL_开嘱科室ID) = .TextMatrix(lngFirstRow, COL_开嘱科室ID)
        .TextMatrix(lngRow, COL_开嘱医生) = .TextMatrix(lngFirstRow, COL_开嘱医生)
        
        '显示紧急标志
        .TextMatrix(lngRow, COL_标志) = .TextMatrix(lngFirstRow, COL_标志)
        Call SetRow标志图标(lngRow)
                
        If Not rsCurr Is Nothing Then
            .TextMatrix(lngRow, COL_医生嘱托) = NVL(rsCurr!医生嘱托)
        End If
        .Cell(flexcpData, lngRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", .TextMatrix(lngRow, COL_诊疗项目ID) & "||1")
        
        '医嘱内容:检验1,检验2(标本 采集方法)
        .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
        
        .Row = lngRow
    End With
    mblnRowChange = True
    AdviceSet检验组合 = lngRow
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub AdviceSet诊疗项目(rsInput As ADODB.Recordset, ByVal lngRow As Long, ByVal lng给药途径ID As Long, ByVal lngGroupRow As Long, _
        ByVal strExtData As String, ByVal str摘要 As String, Optional ByVal str手术部位 As String, Optional ByVal bln备血 As Boolean = True)
'功能：处理新增(插入)的中、西成药，检查(组合)，手术(组合)，卫材，输血，及其它诊疗项目的缺省医嘱数据
'参数：rsInput=输入或选择返回的记录集
'      lngRow=当前输入行
'      lng给药途径ID=缺省给药途径ID,或一并给药时的给药途径ID
'      lngGroupRow=在一并给药的一组成药中插入新的成药行时,对应一并给药的一行行号
'      strExtData=检查:包含检查部位信息,手术:包含附加手术及麻醉的信息,可能无附加手术
'      str摘要=医保摘要
'      str手术部位=申请附项中的手术部位
'      bln备血 当前的输血医嘱为备血医嘱，仅对类别为K的诊疗项目

    Dim rsTmp As New ADODB.Recordset
    Dim rsMore As New ADODB.Recordset '诊疗项目详细信息
    Dim strSQL As String, lngCopyRow As Long
    Dim lngTmp As Long, i As Long
    Dim str医生 As String, lng医生ID As Long
    Dim str药房IDs As String, sng天数 As Single
    Dim lng执行科室ID As Long, vCurDate As Date
    
    Dim str频率 As String, int频率次数 As Integer, int频率间隔 As Integer, str间隔单位 As String
        
    On Error GoTo errH
    
    '取上一或下一有效行,某些内容缺省与该行相同
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
                
    With vsAdvice
        '开始设置医嘱缺省内容
        .RowData(lngRow) = GetNext医嘱ID
        .TextMatrix(lngRow, COL_EDIT) = 1 '新增
        .TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
        .TextMatrix(lngRow, COL_状态) = 1 '新开
        
        '序号:保持连续,当前行占用新序号后,后面的序号向后移
        .TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
        Call AdviceSet医嘱序号(lngRow + 1, 1)
        
        .TextMatrix(lngRow, COL_类别) = rsInput!类别ID
        .TextMatrix(lngRow, COL_名称) = rsInput!名称 '该名称可能是别名
        .TextMatrix(lngRow, COL_诊疗项目ID) = rsInput!诊疗项目ID
        .TextMatrix(lngRow, COL_收费细目ID) = NVL(rsInput!收费细目ID)
        .Cell(flexcpData, lngRow, COL_医生嘱托) = str摘要
        '药品、卫材的规格信息
        If Not IsNull(rsInput!收费细目ID) Then
            If InStr(",5,6,", rsInput!类别ID) > 0 Then
                strSQL = "Select Nvl(C.名称,A.名称) as 名称,b.基本药物," & _
                    " B.剂量系数,B.门诊单位,B.门诊包装,B.门诊可否分零 As 可否分零,b.高危药品,b.是否易至跌倒" & _
                    " From 收费项目目录 A,药品规格 B,收费项目别名 C" & _
                    " Where A.ID=B.药品ID And A.ID=[1]" & _
                    " And A.ID=C.收费细目ID(+) And C.码类(+)=1 And C.性质(+)=[2]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!收费细目ID), IIF(gbyt药品名称显示 = 0, 1, 3))
                .TextMatrix(lngRow, COL_名称) = rsTmp!名称 '将别名换成正式规格名称
                .TextMatrix(lngRow, COL_剂量系数) = rsTmp!剂量系数
                .TextMatrix(lngRow, COL_门诊单位) = rsTmp!门诊单位
                .TextMatrix(lngRow, COL_门诊包装) = rsTmp!门诊包装
                .TextMatrix(lngRow, COL_可否分零) = NVL(rsTmp!可否分零, 0)
                .TextMatrix(lngRow, COL_高危药品) = NVL(rsTmp!高危药品, 0)
                .TextMatrix(lngRow, COL_易跌倒) = NVL(rsTmp!是否易至跌倒, 0)
                .TextMatrix(lngRow, COL_基本药物) = rsTmp!基本药物 & ""
                If Val(.TextMatrix(lngRow, COL_高危药品)) <> 0 Then
                    MsgBox "当前新开的是" & Decode(Val(.TextMatrix(lngRow, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级高危药品，请谨慎使用。", vbInformation, Me.Caption
                End If
            ElseIf rsInput!类别ID = "4" Then
                strSQL = "Select A.跟踪在用,B.名称,B.计算单位,A.是否分零 as 卫材分零 From 材料特性 A,收费项目目录 B Where A.材料ID=B.ID And A.材料ID=[1]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!收费细目ID))
                .TextMatrix(lngRow, COL_名称) = rsTmp!名称 '将别名换成正式规格名称
                .TextMatrix(lngRow, COL_剂量系数) = 1
                .TextMatrix(lngRow, COL_门诊包装) = 1
                .TextMatrix(lngRow, COL_门诊单位) = NVL(rsTmp!计算单位) '散装单位
                .TextMatrix(lngRow, COL_跟踪在用) = NVL(rsTmp!跟踪在用, 0)
                .TextMatrix(lngRow, COL_检查方法) = rsInput!批次 & ""
                .Cell(flexcpData, lngRow, COL_可否分零) = NVL(rsTmp!卫材分零, 0)
            End If
        End If
        
        '药品特性
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            strSQL = "Select 毒理分类,抗生素,药品剂型,处方限量,处方职务,临床自管药,溶媒 From 药品特性 Where 药名ID=[1]"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!诊疗项目ID))
            If Not rsTmp.EOF Then
                .TextMatrix(lngRow, COL_毒理分类) = NVL(rsTmp!毒理分类)
                .TextMatrix(lngRow, COL_抗菌等级) = Val("" & rsTmp!抗生素)
                .TextMatrix(lngRow, COL_药品剂型) = NVL(rsTmp!药品剂型)
                .TextMatrix(lngRow, COL_处方限量) = NVL(rsTmp!处方限量)
                .TextMatrix(lngRow, COL_处方职务) = NVL(rsTmp!处方职务)
                .TextMatrix(lngRow, COL_临床自管药) = rsTmp!临床自管药 & ""
                .TextMatrix(lngRow, COL_是否溶媒) = Val(rsTmp!溶媒 & "")
                
                If gblnKSSStrict And UserInfo.用药级别 < Val("" & rsTmp!抗生素) Then
                    .TextMatrix(lngRow, COL_审核状态) = 1
                End If
            End If
        End If
        
        If rsInput!类别ID & "" <> "K" Then
            If chk紧急.value = 1 Then
                If Val(.TextMatrix(lngRow, COL_审核状态)) = 1 Then .TextMatrix(lngRow, COL_审核状态) = ""
            Else
                If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(lngRow, COL_抗菌等级)) Then .TextMatrix(lngRow, COL_审核状态) = 1
            End If
        End If
        
        '获取更多诊疗项目信息
        '----------------------------------------------------------------------------
        If InStr(",5,6,", rsInput!类别ID) > 0 And Val(rsInput!收费细目ID & "") <> 0 Then
            strSQL = "Select a.用法id,a.频次,a.成人剂量,a.小儿剂量,a.医生嘱托,a.疗程,c.药名id as 项目ID " & _
                " From 药品用法用量 A,诊疗项目目录 B,药品规格 C " & _
                " Where A.用法ID=B.ID and a.药品ID=c.药品id And B.服务对象 IN(1,3)" & _
                " And A.药品ID=[2] And A.性质=1"
            strSQL = "Select A.*,1 as 性质,B.用法ID," & _
                " B.频次,B.成人剂量,B.小儿剂量,B.医生嘱托,B.疗程" & _
                " From 诊疗项目目录 A,(" & strSQL & ") B" & _
                " Where A.ID=b.项目id(+) And A.ID=[1]"
        Else
            strSQL = "Select A.*" & _
                " From 诊疗用法用量 A,诊疗项目目录 B" & _
                " Where A.用法ID=B.ID And (Nvl(A.性质,0)=0 Or B.服务对象 IN(1,3))" & _
                " And (B.站点='" & gstrNodeNo & "' Or B.站点 is Null)" & _
                " And A.项目ID=[1]"
            strSQL = "Select A.*,Nvl(B.性质,0) as 性质,B.用法ID," & _
                " B.频次,B.成人剂量,B.小儿剂量,B.医生嘱托,B.疗程" & _
                " From 诊疗项目目录 A,(" & strSQL & ") B" & _
                " Where A.ID=B.项目ID(+) And A.ID=[1]" & _
                " Order by 性质"
        End If
        Set rsMore = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!诊疗项目ID), Val(rsInput!收费细目ID & ""))
                
        If IsNull(rsInput!收费细目ID) Then '将别名换成正式诊疗名称
            .TextMatrix(lngRow, COL_名称) = rsMore!名称
        End If
                
        If rsInput!类别ID = "4" Then
            .TextMatrix(lngRow, COL_单量单位) = .TextMatrix(lngRow, COL_门诊单位) '散装单位
        ElseIf InStr(",5,6,", rsInput!类别ID) > 0 Or (NVL(rsMore!执行频率, 0) = 0 And InStr(",1,2,", NVL(rsMore!计算方式, 0)) > 0) Then
            .TextMatrix(lngRow, COL_单量单位) = NVL(rsMore!计算单位) '药品为剂量单位
        End If
        
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            '中、西成药临嘱的总量单位就是门诊单位
            .TextMatrix(lngRow, COL_总量单位) = .TextMatrix(lngRow, COL_门诊单位)
        ElseIf rsInput!类别ID = "4" Then
            .TextMatrix(lngRow, COL_总量单位) = .TextMatrix(lngRow, COL_门诊单位) '散装单位
        Else
            '其它临嘱要输入总量(计算单位)
            '如果为一次性或计次临嘱缺省总量为1
            If NVL(rsMore!执行频率, 0) = 1 Or NVL(rsMore!计算方式, 0) = 3 Then
                .TextMatrix(lngRow, COL_总量) = 1
            End If
            .TextMatrix(lngRow, COL_总量单位) = NVL(rsMore!计算单位)
        End If
        
        '抗菌药物缺省用药目的
        If Val(.TextMatrix(lngRow, COL_抗菌等级)) > 0 Then .TextMatrix(lngRow, COL_用药目的) = mstrPurMed
        
        .TextMatrix(lngRow, COL_计算方式) = NVL(rsMore!计算方式, 0)
        .TextMatrix(lngRow, COL_频率性质) = NVL(rsMore!执行频率, 0)
        .TextMatrix(lngRow, COL_操作类型) = NVL(rsMore!操作类型)
        .TextMatrix(lngRow, COL_执行分类) = NVL(rsMore!执行分类, 0)
        If InStr(",5,6,7,", rsInput!类别ID) = 0 Then
            .TextMatrix(lngRow, COL_处方限量) = NVL(rsMore!录入限量)
        End If
        
        '标本部位
        If InStr(",4,5,6,", rsInput!类别ID) > 0 Then
            .TextMatrix(lngRow, COL_标本部位) = rsInput!名称 '记录药品、卫材输入时选择的名称
        ElseIf rsInput!类别ID = "F" Or rsInput!类别ID = "K" Then
            .TextMatrix(lngRow, COL_手术时间) = "" '记录手术/输血时间
        ElseIf rsInput!类别ID <> "D" Then
            .TextMatrix(lngRow, COL_标本部位) = NVL(rsMore!标本部位)
        End If
        
        '计价性质
        .TextMatrix(lngRow, COL_计价性质) = NVL(rsMore!计价性质, 0)
    
        '执行性质:新增项目时根据项目设置,药品、卫材=4-指定科室,一并给药的相同
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            If lngGroupRow <> 0 Then
                .TextMatrix(lngRow, COL_执行性质) = .TextMatrix(lngGroupRow, COL_执行性质)
            Else
                .TextMatrix(lngRow, COL_执行性质) = IIF(Val(.TextMatrix(lngRow, COL_临床自管药)) = 1, 5, 4) '自备药设为院外执行
            End If
        ElseIf rsInput!类别ID = "4" Then
            .TextMatrix(lngRow, COL_执行性质) = 4
        Else
            .TextMatrix(lngRow, COL_执行性质) = NVL(rsMore!执行科室, 0)
        End If
            
        '开嘱医生和科室
        If lngGroupRow = 0 Then
            .TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
            .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
        Else
            .TextMatrix(lngRow, COL_开嘱医生) = .TextMatrix(lngGroupRow, COL_开嘱医生)
            .TextMatrix(lngRow, COL_开嘱科室ID) = .TextMatrix(lngGroupRow, COL_开嘱科室ID)
        End If
    
        '执行科室:药品缺省与上一行相同,一并给药的相同
        lng执行科室ID = 0
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            '如果启用了用法严格控制,则清除与上一行相同
            If CheckDrugUseM(NVL(rsInput!收费细目ID, 0), rsInput!诊疗项目ID) And lngGroupRow = 0 Then lng给药途径ID = 0
            
            If Val(.TextMatrix(lngRow, COL_执行性质)) = 5 Then
                .TextMatrix(lngRow, COL_执行科室ID) = 0
            Else
                If lngGroupRow <> 0 Then
                    str药房IDs = Get可用药房IDs(rsInput!类别ID, rsInput!诊疗项目ID, NVL(rsInput!收费细目ID, 0), mlng病人科室id, 1)
                    If InStr("," & str药房IDs & ",", "," & .TextMatrix(lngGroupRow, COL_执行科室ID) & ",") > 0 Then
                        .TextMatrix(lngRow, COL_执行科室ID) = .TextMatrix(lngGroupRow, COL_执行科室ID)
                    End If
                ElseIf lngCopyRow <> -1 Then
                    If rsInput!类别ID = .TextMatrix(lngCopyRow, COL_类别) Then
                        lng执行科室ID = Val(.TextMatrix(lngCopyRow, COL_执行科室ID))
                    End If
                End If
            End If
        End If
        If Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then
            If rsInput!类别ID = "Z" And InStr(",1,2,", NVL(rsMore!操作类型, 0)) > 0 Then
                '留观或住院医嘱不缺省
                If NVL(rsMore!操作类型, 0) = 1 Then
                    '留观:包含门诊或住院的临床科室
                    Call Get临床科室(3, , lngTmp, , True, False, True)
                ElseIf NVL(rsMore!操作类型, 0) = 2 Then
                    '住院:住院临床科室
                    Call Get临床科室(2, , lngTmp, , True, False, True)
                End If
                .TextMatrix(lngRow, COL_执行科室ID) = lngTmp
            ElseIf InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                '执行性质为(0-叮嘱,5-院外执行)无执行科室
                '之前先求出开嘱科室ID
                If rsInput!类别ID = "4" Then
                    .TextMatrix(lngRow, COL_执行科室ID) = Get收费执行科室ID(mlng病人ID, 0, _
                        rsInput!类别ID, NVL(rsInput!收费细目ID, 0), 4, mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), 1, , 1)
                Else
                    .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, rsInput!类别ID, rsInput!诊疗项目ID, _
                        NVL(rsInput!收费细目ID, 0), NVL(rsMore!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), 1, 1, InStr(",5,6,", rsInput!类别ID) > 0, lng执行科室ID)
                End If
            End If
        End If
        
        '药品库存
        If (InStr(",5,6,", rsInput!类别ID) > 0 Or rsInput!类别ID = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 1) And NVL(rsInput!收费细目ID, 0) <> 0 Then
            Call GetDrugStock(lngRow)
        End If
        
        '执行频率:可选频率,一次性或持续性
        
        '缺省与上一新增行相同
        If lngCopyRow <> -1 Then
            If Get频率范围(lngRow) = Get频率范围(lngCopyRow) Then
                If Val(.TextMatrix(lngCopyRow, COL_EDIT)) = 1 And .TextMatrix(lngCopyRow, COL_频率) <> "" _
                    And Not (.TextMatrix(lngRow, COL_类别) = "7" And Not RowIn配方行(lngCopyRow)) _
                    And Not (.TextMatrix(lngRow, COL_类别) <> "7" And RowIn配方行(lngCopyRow)) _
                    And Check频率可用(NVL(rsInput!诊疗项目ID, 0), Get频率范围(lngRow), .TextMatrix(lngCopyRow, COL_频率)) Then
                    .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngCopyRow, COL_频率)
                    .TextMatrix(lngRow, COL_频率次数) = .TextMatrix(lngCopyRow, COL_频率次数)
                    .TextMatrix(lngRow, COL_频率间隔) = .TextMatrix(lngCopyRow, COL_频率间隔)
                    .TextMatrix(lngRow, COL_间隔单位) = .TextMatrix(lngCopyRow, COL_间隔单位)
                End If
            End If
        End If
        '或取缺省频率
        If .TextMatrix(lngRow, COL_频率) = "" Then
            Call Get缺省频率(NVL(rsInput!诊疗项目ID, 0), Get频率范围(lngRow), str频率, int频率次数, int频率间隔, str间隔单位)
            .TextMatrix(lngRow, COL_频率) = str频率
            .TextMatrix(lngRow, COL_频率次数) = int频率次数
            .TextMatrix(lngRow, COL_频率间隔) = int频率间隔
            .TextMatrix(lngRow, COL_间隔单位) = str间隔单位
        End If
        
        
        '中，西成药的一些缺省信息
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            '执行频率
            If lngGroupRow <> 0 Then
                '一并给药的相同
                .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngGroupRow, COL_频率)
                .TextMatrix(lngRow, COL_频率次数) = .TextMatrix(lngGroupRow, COL_频率次数)
                .TextMatrix(lngRow, COL_频率间隔) = .TextMatrix(lngGroupRow, COL_频率间隔)
                .TextMatrix(lngRow, COL_间隔单位) = .TextMatrix(lngGroupRow, COL_间隔单位)
                .TextMatrix(lngRow, COL_执行时间) = .TextMatrix(lngGroupRow, COL_执行时间)
                
                If Val(.TextMatrix(lngRow, COL_抗菌等级)) > 0 Then
                    .TextMatrix(lngRow, COL_用药目的) = .TextMatrix(lngGroupRow, COL_用药目的)
                    .TextMatrix(lngRow, COL_用药理由) = .TextMatrix(lngGroupRow, COL_用药理由)
                End If
            End If
            
            '确定临嘱用药天数：
            '1.最少为一个频率周期天数
            '2-有疗程则为疗程天数(应大于一个频率周期天数)
            sng天数 = msng天数
            If mbln天数 Then
                If .TextMatrix(lngRow, COL_间隔单位) = "周" Then
                    If 7 > sng天数 Then sng天数 = 7
                ElseIf .TextMatrix(lngRow, COL_间隔单位) = "天" Then
                    If Val(.TextMatrix(lngRow, COL_频率间隔)) > sng天数 Then
                        sng天数 = Val(.TextMatrix(lngRow, COL_频率间隔))
                    End If
                ElseIf .TextMatrix(lngRow, COL_间隔单位) = "小时" Then
                    If Val(.TextMatrix(lngRow, COL_频率间隔)) \ 24 > sng天数 Then
                        sng天数 = Val(.TextMatrix(lngRow, COL_频率间隔)) \ 24
                    End If
                ElseIf .TextMatrix(lngRow, COL_间隔单位) = "分钟" Then
                    If sng天数 = 0 Then sng天数 = 1
                End If
                If sng天数 = 0 Then sng天数 = 1
            End If
            
            rsMore.Filter = "性质>0" '取第一种给药途径用为缺省设置
            If Not rsMore.EOF Then
                '不是一并给药时,设置的缺省用法频率优先
                If lngGroupRow = 0 Then
                    If Not IsNull(rsMore!用法ID) Then lng给药途径ID = rsMore!用法ID
                    If Not IsNull(rsMore!频次) Then
                        Call Get频率信息_编码(rsMore!频次, str频率, int频率次数, int频率间隔, str间隔单位)
                        .TextMatrix(lngRow, COL_频率) = str频率
                        .TextMatrix(lngRow, COL_频率次数) = int频率次数
                        .TextMatrix(lngRow, COL_频率间隔) = int频率间隔
                        .TextMatrix(lngRow, COL_间隔单位) = str间隔单位
                        If str频率 = "一次性" Then .TextMatrix(lngRow, COL_频率性质) = 1
                    End If
                End If
                
                '医生嘱托
                .TextMatrix(lngRow, COL_医生嘱托) = NVL(rsMore!医生嘱托) '一般为给药途径的说明
                
                '药品单量
                If mint年龄 > 12 Then
                    If NVL(rsMore!成人剂量, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_单量) = FormatEx(rsMore!成人剂量, 5)
                    End If
                Else
                    If NVL(rsMore!小儿剂量, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_单量) = FormatEx(rsMore!小儿剂量, 5)
                    ElseIf NVL(rsMore!成人剂量, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_单量) = FormatEx(rsMore!成人剂量 * (mint年龄 + 2) * 5 / 100, 5)
                    End If
                End If
                If Val(.TextMatrix(lngRow, COL_单量)) = 0 Then .TextMatrix(lngRow, COL_单量) = ""
                
                '药品临嘱总量:门诊包装
                If NVL(rsMore!疗程, 1) > sng天数 Then sng天数 = NVL(rsMore!疗程, 1)
                If .TextMatrix(lngRow, COL_频率) <> "" And Val(.TextMatrix(lngRow, COL_单量)) <> 0 _
                    And Val(.TextMatrix(lngRow, COL_剂量系数)) <> 0 And Val(.TextMatrix(lngRow, COL_门诊包装)) <> 0 Then
                    '仅按疗程算改为按最少用药天数算
                    .TextMatrix(lngRow, COL_总量) = FormatEx(Calc缺省药品总量( _
                            Val(.TextMatrix(lngRow, COL_单量)), sng天数, _
                            Val(.TextMatrix(lngRow, COL_频率次数)), _
                            Val(.TextMatrix(lngRow, COL_频率间隔)), _
                            .TextMatrix(lngRow, COL_间隔单位), _
                            .TextMatrix(lngRow, COL_执行时间), _
                            Val(.TextMatrix(lngRow, COL_剂量系数)), _
                            Val(.TextMatrix(lngRow, COL_门诊包装)), _
                            Val(.TextMatrix(lngRow, COL_可否分零))), 5)
                    If InStr(GetInsidePrivs(p门诊医嘱下达), "药品小数输入") = 0 Then
                        .TextMatrix(lngRow, COL_总量) = IntEx(Val(.TextMatrix(lngRow, COL_总量)))
                    ElseIf Val(.TextMatrix(lngRow, COL_可否分零)) <> 0 Then
                        .TextMatrix(lngRow, COL_总量) = IntEx(Val(.TextMatrix(lngRow, COL_总量)))
                    End If
                End If
            End If
            
            '记录缺省天数
            If mbln天数 Then .TextMatrix(lngRow, COL_天数) = IIF(sng天数 = 0, "", sng天数)
            '当总量，（天数），单量，可能被程序自动（不是手动录入）设值，如设置了用法用量，则不会执行超量检查的代码（控件Validate事件）
            Call Set用药天数是否超期(lngRow)
            If Val(.TextMatrix(lngRow, COL_处方限量)) <> 0 And Val(.TextMatrix(lngRow, COL_总量)) <> 0 Then
                If Val(.TextMatrix(lngRow, COL_总量)) * Val(.TextMatrix(lngRow, COL_门诊包装)) * Val(.TextMatrix(lngRow, COL_剂量系数)) > Val(.TextMatrix(lngRow, COL_处方限量)) Then
                    .TextMatrix(lngRow, COL_是否超量) = "1"
                End If
            End If
        End If
        
        If rsMore.Filter <> 0 Then rsMore.Filter = 0
        
        '执行时间:"可选频率"或药品
        If NVL(rsMore!执行频率, 0) = 0 Or InStr(",5,6,", rsInput!类别ID) > 0 Then
            If .TextMatrix(lngRow, COL_执行时间) = "" Then
                If lngCopyRow <> -1 Then '与上一行相同
                    If .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngCopyRow, COL_频率) Then
                        .TextMatrix(lngRow, COL_执行时间) = .TextMatrix(lngCopyRow, COL_执行时间)
                    End If
                End If
                If .TextMatrix(lngRow, COL_执行时间) = "" Then '缺省时间方案
                    .TextMatrix(lngRow, COL_执行时间) = Get缺省时间(1, .TextMatrix(lngRow, COL_频率), lng给药途径ID)
                End If
            End If
        End If
        
        '其它(与项目无关)
        '---------------------------------------------------------------------
        If lngGroupRow = 0 Then
            vCurDate = zlDatabase.Currentdate
            If IsDate(msk开始时间.Text) Then
                .TextMatrix(lngRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开始时间) = msk开始时间.Text
            
                '手术/输血时间缺省为开始时间
                If rsInput!类别ID = "F" Or rsInput!类别ID = "K" Then
                    .TextMatrix(lngRow, COL_手术时间) = msk开始时间.Text
                End If
            End If
            
            .TextMatrix(lngRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
            .Cell(flexcpData, lngRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
    
            .TextMatrix(lngRow, COL_标志) = chk紧急.value
        Else
            .TextMatrix(lngRow, COL_开始时间) = .TextMatrix(lngGroupRow, COL_开始时间)
            .Cell(flexcpData, lngRow, COL_开始时间) = .Cell(flexcpData, lngGroupRow, COL_开始时间)
            
            .TextMatrix(lngRow, COL_开嘱时间) = .TextMatrix(lngGroupRow, COL_开嘱时间)
            .Cell(flexcpData, lngRow, COL_开嘱时间) = .Cell(flexcpData, lngGroupRow, COL_开嘱时间)
            
            .TextMatrix(lngRow, COL_标志) = .TextMatrix(lngGroupRow, COL_标志)
        End If
                        
        
        '在主行处理完成之后处理附加行,并组合医嘱内容
        '-------------------------------------------------------------------------
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            '新增一个给药途径项目,并设置相关
            If lng给药途径ID <> 0 Then
                .TextMatrix(lngRow, COL_用法) = Sys.RowValue("诊疗项目目录", lng给药途径ID, "名称")
            End If
            If lngGroupRow <> 0 Then
                '一并给药的关联相同的给药途径行
                lngTmp = .FindRow(CLng(.TextMatrix(lngGroupRow, COL_相关ID)), lngGroupRow + 1)
                If lngTmp > lngRow Then
                    .TextMatrix(lngRow, COL_相关ID) = .TextMatrix(lngGroupRow, COL_相关ID)
                Else
                    '这种情况是仅为了使用一并给药的相同设置
                    .TextMatrix(lngRow, COL_相关ID) = AdviceSet给药途径(lngRow, lng给药途径ID)
                End If
            Else '独立新增的成药关联独立的给药途径行
                .TextMatrix(lngRow, COL_相关ID) = AdviceSet给药途径(lngRow, lng给药途径ID)
            End If
            
            '毒麻精的颜色标识
            If InStr(",麻醉药,毒性药,精神药,精神I类,精神II类,", .TextMatrix(lngRow, COL_毒理分类)) > 0 _
                And .TextMatrix(lngRow, COL_毒理分类) <> "" Then
                .Cell(flexcpFontBold, lngRow, col_医嘱内容) = True
            End If
        ElseIf rsInput!类别ID = "D" And strExtData <> "" Then
            '检查的组合部位行
            Call AdviceSet检查组合(lngRow, strExtData)
        ElseIf rsInput!类别ID = "F" And strExtData <> "" Then
            '手术的附加手术及麻醉项目行
            Call AdviceSet手术组合(lngRow, strExtData)
            vsAdvice.Cell(flexcpData, lngRow, COL_标本部位) = str手术部位
        ElseIf rsInput!类别ID = "K" Then
            If bln备血 Then
                .TextMatrix(lngRow, COL_检查方法) = ""
            Else
                .TextMatrix(lngRow, COL_检查方法) = 1
            End If
            '输血的途径行
            If lng给药途径ID <> 0 Then
                If gbln血库系统 = True Then
                    strSQL = "Select a.名称,a.操作类型,a.执行分类 From 诊疗项目目录 A where a.id=[1]"
                    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng给药途径ID)
                    .TextMatrix(lngRow, COL_用法) = rsTmp!名称 & ""
                    If Val(rsTmp!操作类型 & "") = 8 And Val(rsTmp!执行分类 & "") = 1 Then '如果是编辑界面用申请单时需要重设一次
                        .TextMatrix(lngRow, COL_检查方法) = 1
                    Else
                        .TextMatrix(lngRow, COL_检查方法) = ""
                    End If
                Else
                    .TextMatrix(lngRow, COL_用法) = Sys.RowValue("诊疗项目目录", lng给药途径ID, "名称")
                End If
                Call AdviceSet输血途径(lngRow, lng给药途径ID)
            End If
        End If
        
        '紧急标志
        If lngGroupRow <> 0 And .TextMatrix(lngRow, COL_审核状态) <> "" Then
            Call SetRow标志图标(lngRow, 0)
        Else
            Call SetRow标志图标(lngRow, 1)
        End If
        
        .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub AdviceSet检查组合(ByVal lngRow As Long, ByVal strExData As String)
'功能：重新设置指定检查组合项目的部位方法行,用于新输入检查组合项目或修改部位方法
'参数：lngRow=当前输入行
'      strExData=包含检查部位方法等信息,格式为:"部位名1;方法名1,方法名2|部位名2;方法名1,方法名2|...<vbTab>0-常规/1-床旁/2-术中"
    Dim arrItems As Variant, arrMethod As Variant
    Dim int执行标记 As Integer, str检查部位 As String
    Dim i As Integer, j As Integer, k As Integer
    On Error GoTo errH
    '删除现有的检查部位方法行
    Call Delete检查手术输血(lngRow)
    
    '重新加入部位方法行
    If strExData <> "" Then
        '执行标记
        If UBound(Split(strExData, vbTab)) >= 1 Then
            int执行标记 = Val(Split(strExData, vbTab)(1))
        End If
        vsAdvice.TextMatrix(lngRow, COL_执行标记) = int执行标记 '在这里统一更新主行的执行标记
        
        arrItems = Split(Split(strExData, vbTab)(0), "|")
        For i = 0 To UBound(arrItems)
            str检查部位 = Split(arrItems(i), ";")(0)
            arrMethod = Split(Split(arrItems(i), ";")(1), ",")
            For j = 0 To UBound(arrMethod)
                k = k + 1
                With vsAdvice
                    .AddItem "", lngRow + k
                    .RowHidden(lngRow + k) = True
                    
                    .RowData(lngRow + k) = GetNext医嘱ID
                    .TextMatrix(lngRow + k, COL_相关ID) = .RowData(lngRow)
                    
                    .TextMatrix(lngRow + k, COL_EDIT) = 1 '新增
                    
                    .TextMatrix(lngRow + k, COL_婴儿) = cbo婴儿.ListIndex
                    .TextMatrix(lngRow + k, COL_序号) = Val(.TextMatrix(lngRow, COL_序号)) + k
                    .TextMatrix(lngRow + k, COL_状态) = 1 '新开
                    
                    .TextMatrix(lngRow + k, COL_类别) = .TextMatrix(lngRow, COL_类别)
                    .TextMatrix(lngRow + k, COL_诊疗项目ID) = .TextMatrix(lngRow, COL_诊疗项目ID) '为同一个检查项目
                    
                    .TextMatrix(lngRow + k, COL_计算方式) = .TextMatrix(lngRow, COL_计算方式)
                    .TextMatrix(lngRow + k, COL_频率性质) = .TextMatrix(lngRow, COL_频率性质)
                    .TextMatrix(lngRow + k, COL_操作类型) = .TextMatrix(lngRow, COL_操作类型)
                    .TextMatrix(lngRow + k, COL_执行分类) = .TextMatrix(lngRow, COL_执行分类)
                    .TextMatrix(lngRow + k, COL_处方限量) = .TextMatrix(lngRow, COL_处方限量)
                    
                    .TextMatrix(lngRow + k, col_医嘱内容) = .TextMatrix(lngRow, COL_名称) '记录为检查项目名称
                    .TextMatrix(lngRow + k, COL_标本部位) = str检查部位
                    .TextMatrix(lngRow + k, COL_检查方法) = arrMethod(j)
                    .TextMatrix(lngRow + k, COL_执行标记) = int执行标记
                    
                    .TextMatrix(lngRow + k, COL_计价性质) = .TextMatrix(lngRow, COL_计价性质)
                    
                    .TextMatrix(lngRow + k, COL_单量) = .TextMatrix(lngRow, COL_单量)
                    .TextMatrix(lngRow + k, COL_总量) = .TextMatrix(lngRow, COL_总量)
                    
                    .TextMatrix(lngRow + k, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
                    .TextMatrix(lngRow + k, COL_频率) = .TextMatrix(lngRow, COL_频率)
                    .TextMatrix(lngRow + k, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
                    .TextMatrix(lngRow + k, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
                    .TextMatrix(lngRow + k, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
                    
                    .TextMatrix(lngRow + k, COL_执行性质) = .TextMatrix(lngRow, COL_执行性质)
                    .TextMatrix(lngRow + k, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                    
                    .TextMatrix(lngRow + k, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                    .Cell(flexcpData, lngRow + k, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
                    
                    .TextMatrix(lngRow + k, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                    .TextMatrix(lngRow + k, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                    
                    .TextMatrix(lngRow + k, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                    .Cell(flexcpData, lngRow + k, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                    
                    .TextMatrix(lngRow + k, COL_标志) = .TextMatrix(lngRow, COL_标志)
                End With
            Next
        Next
                
        '调整后面医嘱的序号
        Call AdviceSet医嘱序号(lngRow + k + 1, k)
    End If
    Exit Sub
errH:
    If 2 = 1 Then
        Resume
    End If
End Sub

Private Sub AdviceSet手术组合(ByVal lngRow As Long, ByVal strDataIDs As String)
'功能：重新设置指定手术项目的附加手术及麻醉项目行,用于新输入手术项目或手术项目的附加手术及麻醉项目
'参数：lngRow=当前输入行
'      strDataIDs=包含附加手术及麻醉项目信息,其中可能没有附加手术和麻醉
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim arrIDs As Variant
    
    On Error GoTo errH
            
    '删除现有的附加手术及麻醉项目行
    Call Delete检查手术输血(lngRow)
    
    '重新加入附加手术行及麻醉项目行
    strDataIDs = Trim(Replace(strDataIDs, ";", ","))
    If Left(strDataIDs, 1) = "," Then strDataIDs = Mid(strDataIDs, 2)
    If Right(strDataIDs, 1) = "," Then strDataIDs = Mid(strDataIDs, 1, Len(strDataIDs) - 1)
    
    If strDataIDs <> "" Then
        Set rsTmp = Get诊疗项目记录(0, strDataIDs)
        If Not rsTmp.EOF Then
            arrIDs = Split(strDataIDs, ",")
            For i = 0 To UBound(arrIDs) '按用户输入项目顺序
                rsTmp.Filter = "ID=" & CStr(arrIDs(i)) '不可能EOF
                
                With vsAdvice
                    .AddItem "", lngRow + i + 1
                    .RowHidden(lngRow + i + 1) = True
                    
                    .RowData(lngRow + i + 1) = GetNext医嘱ID
                    .TextMatrix(lngRow + i + 1, COL_相关ID) = .RowData(lngRow)
                    
                    .TextMatrix(lngRow + i + 1, COL_EDIT) = 1 '新增
                    
                    .TextMatrix(lngRow + i + 1, COL_婴儿) = cbo婴儿.ListIndex
                    .TextMatrix(lngRow + i + 1, COL_序号) = Val(.TextMatrix(lngRow, COL_序号)) + i + 1
                    .TextMatrix(lngRow + i + 1, COL_状态) = 1 '新开
                    
                    .TextMatrix(lngRow + i + 1, COL_类别) = rsTmp!类别
                    .TextMatrix(lngRow + i + 1, COL_诊疗项目ID) = rsTmp!ID
                    .Cell(flexcpData, lngRow + i + 1, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", .TextMatrix(lngRow + i + 1, COL_诊疗项目ID) & "||1")
                    
                    .TextMatrix(lngRow + i + 1, COL_计算方式) = NVL(rsTmp!计算方式, 0)
                    .TextMatrix(lngRow + i + 1, COL_频率性质) = NVL(rsTmp!执行频率, 0)
                    .TextMatrix(lngRow + i + 1, COL_操作类型) = NVL(rsTmp!操作类型)
                    .TextMatrix(lngRow + i + 1, COL_执行分类) = NVL(rsTmp!执行分类, 0)
                    .TextMatrix(lngRow + i + 1, COL_处方限量) = NVL(rsTmp!录入限量)
                    
                    .TextMatrix(lngRow + i + 1, COL_手术时间) = .TextMatrix(lngRow, COL_手术时间) '手术/输血时间
                    .TextMatrix(lngRow + i + 1, col_医嘱内容) = rsTmp!名称
                    
                    .TextMatrix(lngRow + i + 1, COL_计价性质) = NVL(rsTmp!计价性质, 0)
                    
                    .TextMatrix(lngRow + i + 1, COL_单量) = .TextMatrix(lngRow, COL_单量)
                    .TextMatrix(lngRow + i + 1, COL_总量) = .TextMatrix(lngRow, COL_总量)
    
                    .TextMatrix(lngRow + i + 1, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
                    .TextMatrix(lngRow + i + 1, COL_频率) = .TextMatrix(lngRow, COL_频率)
                    .TextMatrix(lngRow + i + 1, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
                    .TextMatrix(lngRow + i + 1, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
                    .TextMatrix(lngRow + i + 1, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
                    
                    '执行性质:根据项目自身设置
                    .TextMatrix(lngRow + i + 1, COL_执行性质) = NVL(rsTmp!执行科室, 0)
                    
                    '叮嘱和院外执行无执行科室,手术麻醉单独执行科室
                    '否则不管其执行科室设置,一个手术组合应该相同
                    If InStr(",0,5,", NVL(rsTmp!执行科室, 0)) > 0 Then
                        .TextMatrix(lngRow + i + 1, COL_执行科室ID) = 0
                    Else
                        If rsTmp!类别 = "G" Then
                            .TextMatrix(lngRow + i + 1, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, rsTmp!类别, rsTmp!ID, 0, _
                                NVL(rsTmp!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), 1, 1)
                        Else
                            .TextMatrix(lngRow + i + 1, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                        End If
                    End If
                    
                    .TextMatrix(lngRow + i + 1, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                    .Cell(flexcpData, lngRow + i + 1, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
                    
                    .TextMatrix(lngRow + i + 1, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                    .TextMatrix(lngRow + i + 1, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                    
                    .TextMatrix(lngRow + i + 1, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                    .Cell(flexcpData, lngRow + i + 1, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                    
                    .TextMatrix(lngRow + i + 1, COL_标志) = .TextMatrix(lngRow, COL_标志)
                End With
            Next
                
            '调整序号
            Call AdviceSet医嘱序号(lngRow + UBound(arrIDs) + 2, UBound(arrIDs) + 1)
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function AdviceSet给药途径(ByVal lngRow As Long, ByVal lng给药途径ID As Long, _
    Optional ByVal str执行性质 As String, Optional ByVal lng给药执行ID As Long, Optional ByVal str滴速 As String) As Long
'功能：为录入的中，西成药设置对应的给药途径行(新增或修改)
'参数：lngRow=要处理给药途径的药品行
'      lng给药途径ID=给药途径ID
'      str执行性质=修改给药途径时,当前界面设置的执行性质
'      lng给药执行ID=修改给药途径时,当前界面设置的执行科室
'      str滴速=修改给药途径时,当前界面设置的滴速
'返回：被设置的给药途径行的医嘱ID
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, lngNewRow As Long
    Dim blnNew As Boolean
    
    On Error GoTo errH
    Set rsTmp = Get诊疗项目记录(lng给药途径ID)
    If rsTmp.EOF Then lng给药途径ID = 0 '没有数据，先设置以保持关系
        
    With vsAdvice
        If Val(.TextMatrix(lngRow, COL_相关ID)) = 0 Then '未设置"相关ID"时
            blnNew = True
            lngNewRow = lngRow + 1
            .AddItem "", lngNewRow
            .RowHidden(lngNewRow) = True
        Else
            '修改医嘱的内容时重新设置给药途径内容(不是更换诊疗项目)
            blnNew = False
            lngNewRow = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
        End If
        
        '无效内容：名称,收费细目ID,剂量系数,门诊单位,门诊包装,标本部位,医生嘱托,单量,总量,用法
        If blnNew Then
            .RowData(lngNewRow) = GetNext医嘱ID
            .TextMatrix(lngNewRow, COL_EDIT) = 1 '新增
            .TextMatrix(lngNewRow, COL_序号) = Val(.TextMatrix(lngRow, COL_序号)) + 1
            If mlng路径状态 <> 0 Then
                .TextMatrix(lngNewRow, COL_路径项目ID) = .TextMatrix(lngRow, COL_路径项目ID)
                .TextMatrix(lngNewRow, COL_路径执行方式) = .TextMatrix(lngRow, COL_路径执行方式)
                If mbytUseType = 1 Then '生成路径时
                    .Cell(flexcpChecked, lngNewRow, COL_选择) = .Cell(flexcpChecked, lngRow, COL_选择)
                    .TextMatrix(lngNewRow, COL_选择) = .TextMatrix(lngRow, COL_选择)
                Else
                    .TextMatrix(lngNewRow, COL_路径执行ID) = .TextMatrix(lngRow, COL_路径执行ID)
                    .TextMatrix(lngNewRow, COL_路径项目分类) = .TextMatrix(lngRow, COL_路径项目分类)
                End If
            End If
        Else
            '医嘱ID(RowData),序号:保持不变
            If InStr(",0,3,", .TextMatrix(lngNewRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngNewRow, COL_EDIT) = 2 '标志为内容修改
                .TextMatrix(lngNewRow, COL_状态) = 1 '修改后变为新开
            End If
        End If
        
        .TextMatrix(lngNewRow, COL_婴儿) = cbo婴儿.ListIndex
        .TextMatrix(lngNewRow, COL_状态) = 1 '新开
        
        .TextMatrix(lngNewRow, COL_类别) = "E" '给药途径属于治疗
        .TextMatrix(lngNewRow, COL_诊疗项目ID) = lng给药途径ID
        '如果没有确定给药途径，暂时不设置的内容
        If Not rsTmp.EOF Then
            .TextMatrix(lngNewRow, COL_计算方式) = NVL(rsTmp!计算方式, 0)
            .TextMatrix(lngNewRow, COL_频率性质) = NVL(rsTmp!执行频率, 0)
            .TextMatrix(lngNewRow, COL_操作类型) = NVL(rsTmp!操作类型)
            .TextMatrix(lngNewRow, COL_执行分类) = NVL(rsTmp!执行分类, 0)
            .TextMatrix(lngNewRow, col_医嘱内容) = rsTmp!名称
            
            .TextMatrix(lngNewRow, COL_计价性质) = NVL(rsTmp!计价性质, 0)
            
            '滴速
            If str滴速 <> "" Then
                .TextMatrix(lngNewRow, COL_医生嘱托) = str滴速
            End If
            .Cell(flexcpData, lngNewRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", .TextMatrix(lngNewRow, COL_诊疗项目ID) & "||1")
            
            '执行性质:缺省根据项目设置,修改时根据当前界面设置
            If str执行性质 = "" Then
                .TextMatrix(lngNewRow, COL_执行性质) = NVL(rsTmp!执行科室, 0)
            Else
                .TextMatrix(lngNewRow, COL_执行性质) = Decode(str执行性质, "离院带药", 5, NVL(rsTmp!执行科室, 0))
            End If
            
            '给药途径如果未设置执行科室,则缺省为病人所在病区(门诊要改为病人所在科室!!)
            If InStr(",0,5,", Val(.TextMatrix(lngNewRow, COL_执行性质))) = 0 Then
                If lng给药执行ID <> 0 Then
                    .TextMatrix(lngNewRow, COL_执行科室ID) = lng给药执行ID
                Else
                    .TextMatrix(lngNewRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, "E", lng给药途径ID, 0, _
                        NVL(rsTmp!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), 1, 1)
                End If
            Else
                .TextMatrix(lngNewRow, COL_执行科室ID) = 0
            End If
        End If
        
        '给药途径天数与药品相同
        .TextMatrix(lngNewRow, COL_天数) = .TextMatrix(lngRow, COL_天数)
        
        .TextMatrix(lngNewRow, COL_频率) = .TextMatrix(lngRow, COL_频率)
        .TextMatrix(lngNewRow, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
        .TextMatrix(lngNewRow, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
        .TextMatrix(lngNewRow, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
        .TextMatrix(lngNewRow, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
        
        .TextMatrix(lngNewRow, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
        .Cell(flexcpData, lngNewRow, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
        
        .TextMatrix(lngNewRow, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
        .TextMatrix(lngNewRow, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
        
        .TextMatrix(lngNewRow, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
        .Cell(flexcpData, lngNewRow, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
        
        .TextMatrix(lngNewRow, COL_标志) = .TextMatrix(lngRow, COL_标志)
        .TextMatrix(lngNewRow, COL_审核状态) = .TextMatrix(lngRow, COL_审核状态)
            
        '往后调整序号
        If blnNew Then Call AdviceSet医嘱序号(lngNewRow + 1, 1)
        
        AdviceSet给药途径 = .RowData(lngNewRow)
    End With
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet输血途径(ByVal lngRow As Long, ByVal lng输血途径ID As Long, Optional ByVal lng输血执行ID As Long) As Long
'功能：为录入的中，西成药设置对应的给药途径行(新增或修改)
'参数：lngRow=要处理输血途径的输血医嘱行
'      lng输血途径ID=输血途径ID
'      lng输血执行ID=修改输血途径时,当前界面设置的执行科室
'返回：被设置的输血途径行的医嘱ID
    Dim rsTmp As New ADODB.Recordset
    Dim strTmp As String, lngNewRow As Long
    Dim blnNew As Boolean
    
    On Error GoTo errH
    Set rsTmp = Get诊疗项目记录(lng输血途径ID)
    
    With vsAdvice
        lngNewRow = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_相关ID)
        If lngNewRow = -1 Then '尚未设置输血途径时
            blnNew = True
            lngNewRow = lngRow + 1
            .AddItem "", lngNewRow
            .RowHidden(lngNewRow) = True
        End If
        
        '无效内容：名称,收费细目ID,剂量系数,门诊单位,门诊包装,标本部位,医生嘱托,单量,总量,用法
        If blnNew Then
            .RowData(lngNewRow) = GetNext医嘱ID
            .TextMatrix(lngNewRow, COL_相关ID) = .RowData(lngRow)
            .TextMatrix(lngNewRow, COL_EDIT) = 1 '新增
            .TextMatrix(lngNewRow, COL_序号) = Val(.TextMatrix(lngRow, COL_序号)) + 1
        Else
            '医嘱ID(RowData),序号:保持不变
            If InStr(",0,3,", .TextMatrix(lngNewRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngNewRow, COL_EDIT) = 2 '标志为内容修改
                .TextMatrix(lngNewRow, COL_状态) = 1 '修改后变为新开
            End If
        End If
        
        .TextMatrix(lngNewRow, COL_婴儿) = cbo婴儿.ListIndex
        .TextMatrix(lngNewRow, COL_状态) = 1 '新开
        
        .TextMatrix(lngNewRow, COL_类别) = "E" '输血途径属于治疗
        .TextMatrix(lngNewRow, COL_诊疗项目ID) = lng输血途径ID
        .Cell(flexcpData, lngNewRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", .TextMatrix(lngNewRow, COL_诊疗项目ID) & "||1")
        
        .TextMatrix(lngNewRow, COL_计算方式) = NVL(rsTmp!计算方式, 0)
        .TextMatrix(lngNewRow, COL_操作类型) = NVL(rsTmp!操作类型)
        .TextMatrix(lngNewRow, COL_执行分类) = NVL(rsTmp!执行分类, 0)
        .TextMatrix(lngNewRow, col_医嘱内容) = rsTmp!名称
        
        .TextMatrix(lngNewRow, COL_计价性质) = NVL(rsTmp!计价性质, 0)
        .TextMatrix(lngNewRow, COL_执行性质) = NVL(rsTmp!执行科室, 0)
        
        If InStr(",0,5,", Val(.TextMatrix(lngNewRow, COL_执行性质))) = 0 Then
            If lng输血执行ID <> 0 Then
                .TextMatrix(lngNewRow, COL_执行科室ID) = lng输血执行ID
            Else
                .TextMatrix(lngNewRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, "E", lng输血途径ID, 0, _
                    NVL(rsTmp!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), 1, 1)
            End If
        Else
            .TextMatrix(lngNewRow, COL_执行科室ID) = 0
        End If
        
        .TextMatrix(lngNewRow, COL_频率性质) = .TextMatrix(lngRow, COL_频率性质) '以药品的为准
        .TextMatrix(lngNewRow, COL_频率) = .TextMatrix(lngRow, COL_频率)
        .TextMatrix(lngNewRow, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
        .TextMatrix(lngNewRow, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
        .TextMatrix(lngNewRow, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
        .TextMatrix(lngNewRow, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
        .TextMatrix(lngNewRow, COL_审核状态) = .TextMatrix(lngRow, COL_审核状态)
        
        .TextMatrix(lngNewRow, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
        .Cell(flexcpData, lngNewRow, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
        
        .TextMatrix(lngNewRow, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
        .TextMatrix(lngNewRow, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
        
        .TextMatrix(lngNewRow, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
        .Cell(flexcpData, lngNewRow, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
        
        .TextMatrix(lngNewRow, COL_标志) = .TextMatrix(lngRow, COL_标志)
            
        '往后调整序号
        If blnNew Then Call AdviceSet医嘱序号(lngNewRow + 1, 1)
        
        AdviceSet输血途径 = .RowData(lngNewRow)
        '跟据输血途径来重设输血医嘱的审核状态
        strTmp = GetBloodState(IIF(Val(.TextMatrix(lngNewRow, COL_标志)) = 1, 1, 0), Val(.TextMatrix(lngNewRow, COL_执行分类)))
        .TextMatrix(lngNewRow, COL_审核状态) = strTmp
        .TextMatrix(lngRow, COL_审核状态) = strTmp
        Call SetRow标志图标(lngRow, 2)
    End With
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub AdviceChange()
'功能：根据当前医嘱卡片中的内容，更新当前医嘱内容
'说明：对于ListIndex=-1而对应医嘱项又有内容的，保持原内容不更新
    Dim lngRow As Long, lngBeginRow As Long, lngEndRow As Long
    Dim int频率次数 As Integer, int频率间隔 As Integer, str间隔单位 As String
    Dim blnCurDo As Boolean, blnOtherDo As Boolean
    Dim lngTmp As Long, strTmp As String, blnTmp As Boolean
    Dim strCurDate As String, lng开嘱科室ID As Long
    Dim blnReInRow As Boolean, i As Long, j As Long
    Dim lng执行科室ID As Long, lngBegin As Long, lngEnd As Long
    Dim blnReSet超量说明 As Boolean
    Dim dbl总量 As Double
    
    With vsAdvice
        lngRow = .Row
        
        If .RowData(lngRow) = 0 Then Call ClearItemTag: Exit Sub '清除编辑标志
        
        If RowIn配方行(lngRow) Then
            '中药配方
            lngBeginRow = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
            For i = lngBeginRow To lngRow
                '修改处理配方的所有行内容(包括煎法和用法)
                If IsDate(msk开始时间.Text) And msk开始时间.Tag <> "" Then
                    .TextMatrix(i, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, i, COL_开始时间) = msk开始时间.Text
                    blnCurDo = True
                End If
                If chk紧急.Visible And chk紧急.Tag <> "" Then
                    .TextMatrix(i, COL_标志) = chk紧急.value
                    If i = lngRow Then '用法行显示紧急标志
                         Call SetRow标志图标(i, 0)
                    End If
                    blnCurDo = True
                End If
                If txt总量.Enabled And txt总量.Tag <> "" Then
                    .TextMatrix(i, COL_总量) = FormatEx(IIF(Val(txt总量.Text) = 0, "", Val(txt总量.Text)), 5)
                    
                    '总量变了，需要根据是否超量设置超量说明的可用性
                    blnReSet超量说明 = True
                    blnCurDo = True
                End If
                If txt频率.Enabled And cmd频率.Tag <> "" And txt频率.Tag <> "" Then
                    .TextMatrix(i, COL_频率) = txt频率.Text
                    Call Get频率信息_名称(txt频率.Text, int频率次数, int频率间隔, str间隔单位, 2) '中医范围
                    .TextMatrix(i, COL_频率次数) = int频率次数
                    .TextMatrix(i, COL_频率间隔) = int频率间隔
                    .TextMatrix(i, COL_间隔单位) = str间隔单位
                    blnCurDo = True
                End If
                If cbo执行时间.Tag <> "" Then
                    .TextMatrix(i, COL_执行时间) = cbo执行时间.Text
                    blnCurDo = True
                End If
                
                If .TextMatrix(i, COL_类别) = "7" Then
                    '更改的是组成中药的执行科室(用法煎法的改不到)
                    If cbo执行科室.ListIndex <> -1 And cbo执行科室.Tag <> "" Then
                        .TextMatrix(i, COL_执行科室ID) = cbo执行科室.ItemData(cbo执行科室.ListIndex)
                        blnCurDo = True
                    End If
                    
                    '执行性质:配方中所有组成的中药相同
                    If cbo执行性质.Tag <> "" Then
                        .TextMatrix(i, COL_执行性质) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "自备药", 5, 4)
                        If Val(.TextMatrix(i, COL_执行性质)) = 5 Then
                            .TextMatrix(i, COL_执行科室ID) = 0
                        ElseIf Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                            '恢复缺省执行科室,缺省与前面相同
                            If i = lngBeginRow Then
                                For j = i - 1 To .FixedRows Step -1
                                    If .TextMatrix(j, COL_类别) = "7" And Val(.TextMatrix(j, COL_执行科室ID)) <> 0 Then
                                        .TextMatrix(i, COL_执行科室ID) = .TextMatrix(j, COL_执行科室ID)
                                        Exit For
                                    End If
                                Next
                                If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                                    .TextMatrix(i, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, .TextMatrix(i, COL_类别), Val(.TextMatrix(i, COL_诊疗项目ID)), Val(.TextMatrix(i, COL_收费细目ID)), 4, mlng病人科室id, 0, 1, 1, True)
                                End If
                            Else
                                .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngBeginRow, COL_执行科室ID)
                            End If
                        End If
                        blnReInRow = True '界面执行科室编辑性变化
                        blnCurDo = True
                    End If
                End If
                
                '修改时自动更新部份内容
                blnTmp = False
                If cbo医生嘱托.Tag <> "" Or cbo执行性质.Tag <> "" _
                    Or (Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "") Then
                    blnTmp = True
                End If
                If blnCurDo Or blnTmp Then
                    '修改了内容则更新开嘱时间
                    If strCurDate = "" Then
                        strCurDate = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
                    End If
                    .TextMatrix(i, COL_开嘱时间) = Format(strCurDate, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, i, COL_开嘱时间) = strCurDate
                    
                    '检查开嘱医生
                    If .TextMatrix(i, COL_开嘱医生) <> UserInfo.姓名 Then
                        .TextMatrix(i, COL_开嘱医生) = UserInfo.姓名
                        If lng开嘱科室ID = 0 Then
                            lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
                        End If
                        .TextMatrix(i, COL_开嘱科室ID) = lng开嘱科室ID
                    End If
                End If
                                                    
                If .TextMatrix(i, COL_类别) = "E" And i <> lngRow Then lngTmp = i '煎法行号
                                                    
                '---------------
                If blnCurDo Then '标记为修改:0-原始的,1-新增的,2-修改了内容,3-修改了序号
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2
                        .TextMatrix(i, COL_状态) = 1 '修改后变为新开
                        If Not .RowHidden(i) Then Call ReSetColor(i) '用法行才设置
                    End If
                    mblnNoSave = True '标记为未保存
                End If
            Next
            
            '涉及中药用法行的内容:直接更改当前行的内容(煎法行在配方编辑中才能改)
            '-----------------------------------------------------------
            blnCurDo = False
                    
            '医生嘱托:是放在中药用法行(显示行)中的
            If cbo医生嘱托.Tag <> "" Then
                .TextMatrix(lngRow, COL_医生嘱托) = cbo医生嘱托.Text
                blnCurDo = True
            End If
        
            '中药用法
            If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then
                .TextMatrix(lngRow, COL_诊疗项目ID) = Val(cmd用法.Tag)
                .TextMatrix(lngRow, COL_用法) = txt用法.Text
                
                '同时更改计价性质和执行性质
                .TextMatrix(lngRow, COL_计价性质) = NVL(Sys.RowValue("诊疗项目目录", Val(cmd用法.Tag), "计价性质"), 0)
                i = NVL(Sys.RowValue("诊疗项目目录", Val(cmd用法.Tag), "执行科室"), 0)
                .TextMatrix(lngRow, COL_执行性质) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "离院带药", 5, i)
                If Val(.TextMatrix(lngRow, COL_执行性质)) = 5 Then
                    .TextMatrix(lngRow, COL_执行科室ID) = 0
                Else
                    .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, "E", Val(cmd用法.Tag), 0, _
                        Val(.TextMatrix(lngRow, COL_执行性质)), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), 1, 1)
                End If
                
                blnReInRow = True '需要刷新中药用法执行科室
                blnCurDo = True
            End If
            
            '用法和煎法的执行性质
            If cbo执行性质.Tag <> "" Then
                '用法
                i = NVL(Sys.RowValue("诊疗项目目录", Val(.TextMatrix(lngRow, COL_诊疗项目ID)), "执行科室"), 0)
                .TextMatrix(lngRow, COL_执行性质) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "离院带药", 5, i)
                If Val(.TextMatrix(lngRow, COL_执行性质)) = 5 Then
                    .TextMatrix(lngRow, COL_执行科室ID) = 0
                Else
                    .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, .TextMatrix(lngRow, COL_类别), _
                        Val(.TextMatrix(lngRow, COL_诊疗项目ID)), 0, Val(.TextMatrix(lngRow, COL_执行性质)), _
                        mlng病人科室id, Val(Val(.TextMatrix(lngRow, COL_开嘱科室ID))), 1, 1)
                End If
                
                '煎法
                i = NVL(Sys.RowValue("诊疗项目目录", Val(.TextMatrix(lngTmp, COL_诊疗项目ID)), "执行科室"), 0)
                .TextMatrix(lngTmp, COL_执行性质) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "离院带药", 5, i)
                If Val(.TextMatrix(lngTmp, COL_执行性质)) = 5 Then
                    .TextMatrix(lngTmp, COL_执行科室ID) = 0
                Else
                    .TextMatrix(lngTmp, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, .TextMatrix(lngTmp, COL_类别), _
                        Val(.TextMatrix(lngTmp, COL_诊疗项目ID)), 0, Val(.TextMatrix(lngTmp, COL_执行性质)), _
                        mlng病人科室id, Val(.TextMatrix(lngTmp, COL_开嘱科室ID)), 1, 1)
                End If
                
                If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                    .TextMatrix(lngTmp, COL_EDIT) = 2
                    .TextMatrix(lngTmp, COL_状态) = 1 '修改后变为新开
                End If
                mblnNoSave = True '标记为未保存
                
                blnCurDo = True
            End If
            
            '中药用法执行科室:即配方当前显示行的执行科室
            If cbo附加执行.ListIndex <> -1 And cbo附加执行.Tag <> "" Then
                .TextMatrix(lngRow, COL_执行科室ID) = cbo附加执行.ItemData(cbo附加执行.ListIndex)
                blnCurDo = True
            End If
            
            Call Set用药天数是否超期(lngRow)
            
        Else '其它诊疗项目
            If IsDate(msk开始时间.Text) And msk开始时间.Tag <> "" Then
                .TextMatrix(lngRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开始时间) = msk开始时间.Text
                blnCurDo = True
            End If
            If IsDate(txt安排时间.Text) And txt安排时间.Tag <> "" Then
                .TextMatrix(lngRow, COL_手术时间) = txt安排时间.Text
                blnCurDo = True
            End If
            '免试标记
            If chk免试.Visible And chk免试.Tag <> "" Then
                .TextMatrix(lngRow, COL_免试) = chk免试.value
                blnCurDo = True
            End If
            
            If chk紧急.Visible And chk紧急.Tag <> "" Then
                .TextMatrix(lngRow, COL_标志) = chk紧急.value
                
                '后面处理一并给药中的其他行，待审核的改为无需审核
                If Not (.TextMatrix(lngRow, COL_类别) = "K") Then
                    If chk紧急.value = 1 Then
                        If Val(.TextMatrix(lngRow, COL_审核状态)) = 1 Then .TextMatrix(lngRow, COL_审核状态) = ""
                    Else
                        If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(lngRow, COL_抗菌等级)) Then .TextMatrix(lngRow, COL_审核状态) = 1
                    End If
                End If
                If (gbln输血分级管理 Or gbln血库系统) And .TextMatrix(lngRow, COL_类别) = "K" Then
                    blnReInRow = True
                End If
                
                '显示紧急标志,一并给药显示在第一行
                Call SetRow标志图标(lngRow, 0)
                                
                blnCurDo = True
            End If
            
            If txt单量.Enabled And (IsNumeric(txt单量.Text) Or txt单量.Text = "") And txt单量.Tag <> "" Then
                .TextMatrix(lngRow, COL_单量) = FormatEx(txt单量.Text, 5)
                If Not mbln天数 Then Call Set用药天数是否超期(lngRow): blnReSet超量说明 = True
                               
                blnCurDo = True
            End If
            
            If txt天数.Visible And txt天数.Enabled And txt天数.Tag <> "" Then
                .TextMatrix(lngRow, COL_天数) = txt天数.Text
                
                If Val(txt天数.Text) > IIF(mbytPatiType = 1, conOrdinary, conEmergency) Then
                    .TextMatrix(lngRow, COL_是否超期) = "1"
                Else
                    .TextMatrix(lngRow, COL_是否超期) = ""
                End If
                blnReSet超量说明 = True
                
                blnCurDo = True
            End If
            
            If txt总量.Enabled And (IsNumeric(txt总量.Text) Or txt总量.Text = "") And txt总量.Tag <> "" Then
                .TextMatrix(lngRow, COL_总量) = FormatEx(txt总量.Text, 5)
                If Not mbln天数 Then Call Set用药天数是否超期(lngRow)
                
                '总量变化需设置超量说明的可用性
                blnReSet超量说明 = True
                               
                blnCurDo = True
            End If
            
            If txt频率.Enabled And cmd频率.Tag <> "" And txt频率.Tag <> "" Then
                .TextMatrix(lngRow, COL_频率) = txt频率.Text
                Call Get频率信息_名称(txt频率.Text, int频率次数, int频率间隔, str间隔单位, Get频率范围(lngRow))
                .TextMatrix(lngRow, COL_频率次数) = int频率次数
                .TextMatrix(lngRow, COL_频率间隔) = int频率间隔
                .TextMatrix(lngRow, COL_间隔单位) = str间隔单位
                
                If Not mbln天数 Then Call Set用药天数是否超期(lngRow): blnReSet超量说明 = True
                
                blnCurDo = True
            End If
            
            If cbo执行时间.Tag <> "" Then
                .TextMatrix(lngRow, COL_执行时间) = cbo执行时间.Text
                blnCurDo = True
            End If
            If cbo医生嘱托.Tag <> "" Then
                .TextMatrix(lngRow, COL_医生嘱托) = cbo医生嘱托.Text
                blnCurDo = True
            End If
            
            If cbo执行科室.ListIndex <> -1 And cbo执行科室.Tag <> "" Then
                If Not RowIn检验行(lngRow) Then '采集方法的执行科室不同
                    .TextMatrix(lngRow, COL_执行科室ID) = cbo执行科室.ItemData(cbo执行科室.ListIndex)
                End If
                blnCurDo = True
            End If
            
            '用药目的和理由
            If lbl用药目的.Tag <> "" Then
                .TextMatrix(lngRow, COL_用药目的) = cboDruPur.ListIndex
                blnCurDo = True
            End If
            If txt用药理由.Tag <> "" Then
                .TextMatrix(lngRow, COL_用药理由) = Trim(txt用药理由.Text)
                blnCurDo = True
            End If
            
            '滴速：输液药品
            If cbo滴速.Tag <> "" Then
                If .TextMatrix(lngRow, COL_类别) = "K" Then
                    lngTmp = .FindRow(CLng(.RowData(lngRow)), , COL_相关ID)
                Else
                    lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                End If
                If lngTmp <> -1 Then
                    If cbo滴速.Text <> "" Then
                        .TextMatrix(lngTmp, COL_医生嘱托) = cbo滴速.Text & lbl滴速单位.Caption
                    Else
                        .TextMatrix(lngTmp, COL_医生嘱托) = ""
                    End If
                    If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                        .TextMatrix(lngTmp, COL_EDIT) = 2
                        .TextMatrix(lngTmp, COL_状态) = 1 '修改后变为新开
                    End If
                    mblnNoSave = True '标记为未保存
                End If
                '显示给药途径
                If cbo滴速.Text <> "" Then
                    .TextMatrix(lngRow, COL_用法) = txt用法.Text & cbo滴速.Text & lbl滴速单位.Caption
                Else
                    .TextMatrix(lngRow, COL_用法) = txt用法.Text
                End If
            End If
            
            '输液和注射药品医嘱的本院执行次数
            If txtBYZX.Tag <> "" Then
                lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                If lngTmp <> -1 Then
                    If txtBYZX.Text <> "" Then
                        .TextMatrix(lngTmp, COL_总量) = txtBYZX.Text
                    Else
                        .TextMatrix(lngTmp, COL_总量) = ""
                    End If
                    If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                        .TextMatrix(lngTmp, COL_EDIT) = 2
                        .TextMatrix(lngTmp, COL_状态) = 1 '修改后变为新开
                    End If
                    mblnNoSave = True '标记为未保存
                End If
            End If
            
            '附加执行科室：给药途径,手术麻醉,采集方法，原液皮试项目
            If cbo附加执行.ListIndex <> -1 And cbo附加执行.Tag <> "" Then
                lngTmp = -1
                If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                    lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                ElseIf .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5" Then
                    lngTmp = lngRow
                ElseIf .TextMatrix(lngRow, COL_类别) = "F" Then
                    For i = lngRow + 1 To .Rows - 1
                        If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                            If .TextMatrix(i, COL_类别) = "G" Then
                                lngTmp = i: Exit For
                            End If
                        Else
                            Exit For
                        End If
                    Next
                ElseIf .TextMatrix(lngRow, COL_类别) = "E" _
                    And .TextMatrix(lngRow - 1, COL_类别) = "C" _
                    And Val(.TextMatrix(lngRow - 1, COL_相关ID)) = .RowData(lngRow) Then
                    lngTmp = lngRow
                ElseIf .TextMatrix(lngRow, COL_类别) = "K" _
                    And .TextMatrix(lngRow + 1, COL_类别) = "E" _
                    And Val(.TextMatrix(lngRow + 1, COL_相关ID)) = .RowData(lngRow) Then
                    lngTmp = lngRow + 1
                End If
                
                '只更新对应行,不影响其它行
                If lngTmp <> -1 Then
                    If Not (.TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5") Then
                        .TextMatrix(lngTmp, COL_执行科室ID) = cbo附加执行.ItemData(cbo附加执行.ListIndex)
                    End If
                    If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                        .TextMatrix(lngTmp, COL_EDIT) = 2
                        .TextMatrix(lngTmp, COL_状态) = 1 '修改后变为新开
                    End If
                    'mblnNoSave = True '标记为未保存
                    blnCurDo = True
                End If
            End If
            
            '原液皮试项目可以不指定附加的药房科室
            If cbo附加执行.Tag <> "" Then
                If .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5" Then
                    lngTmp = lngRow
                    If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                        .TextMatrix(lngTmp, COL_EDIT) = 2
                        .TextMatrix(lngTmp, COL_状态) = 1 '修改后变为新开
                    End If
                    'mblnNoSave = True '标记为未保存
                    blnCurDo = True
                End If
            End If
            
            '执行性质,给药途径:为更新开嘱时间(包括给药途径的同步更改),先判断是否改变
            If InStr(",5,6,K,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                If cbo执行性质.Tag <> "" Then blnCurDo = True
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then blnCurDo = True
            End If
                                    
            '修改时自动更新部份内容
            blnTmp = False
            If cbo执行性质.Tag <> "" Or (Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "") Then
                blnReInRow = True '需要刷新给药途径,采集方式的执行科室
                blnTmp = True
            End If
            If blnCurDo Or blnTmp Then
                '修改了内容则更新开嘱时间
                strCurDate = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
                .TextMatrix(lngRow, COL_开嘱时间) = Format(strCurDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开嘱时间) = strCurDate
                
                '检查开嘱医生
                If .TextMatrix(lngRow, COL_开嘱医生) <> UserInfo.姓名 Then
                    .TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
                    If lng开嘱科室ID = 0 Then
                        lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
                    End If
                    .TextMatrix(lngRow, COL_开嘱科室ID) = lng开嘱科室ID
                End If
            End If
                                    
            '其它需要同步处理的关联行
            '----------------------------------------------------------------
            If RowIn检验行(lngRow) Then
                '采集方法
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then
                    .TextMatrix(lngRow, COL_诊疗项目ID) = Val(cmd用法.Tag)
                    .TextMatrix(lngRow, COL_用法) = txt用法.Text
                    .TextMatrix(lngRow, COL_名称) = txt用法.Text
                    
                    '同时更改计价性质和执行性质
                    .TextMatrix(lngRow, COL_计价性质) = NVL(Sys.RowValue("诊疗项目目录", Val(cmd用法.Tag), "计价性质"), 0)
                    .TextMatrix(lngRow, COL_执行性质) = NVL(Sys.RowValue("诊疗项目目录", Val(cmd用法.Tag), "执行科室"), 0)
                    If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                        .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, "E", Val(cmd用法.Tag), 0, _
                            Val(.TextMatrix(lngRow, COL_执行性质)), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), 1, 1)
                    Else
                        .TextMatrix(lngRow, COL_执行科室ID) = 0
                    End If

                    blnCurDo = True
                End If
                
                '设置一并采集的各个检验项目
                If blnCurDo Then
                    For i = lngRow - 1 To .FixedRows Step -1
                        If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                            If txt总量.Tag <> "" Then
                                .TextMatrix(i, COL_总量) = .TextMatrix(lngRow, COL_总量)
                                blnOtherDo = True
                            End If
                            If txt频率.Tag <> "" Then
                                .TextMatrix(i, COL_频率) = .TextMatrix(lngRow, COL_频率)
                                .TextMatrix(i, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
                                .TextMatrix(i, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
                                .TextMatrix(i, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
                                blnOtherDo = True
                            End If
                            If cbo执行科室.Tag <> "" And cbo执行科室.ListIndex <> -1 Then
                                If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) > 0 Then
                                    .TextMatrix(i, COL_执行科室ID) = 0
                                Else
                                    .TextMatrix(i, COL_执行科室ID) = cbo执行科室.ItemData(cbo执行科室.ListIndex)
                                End If
                                blnOtherDo = True
                            End If
                            If cbo执行时间.Tag <> "" Then
                                .TextMatrix(i, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
                                blnOtherDo = True
                            End If
                            If msk开始时间.Tag <> "" Then
                                .TextMatrix(i, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                                .Cell(flexcpData, i, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
                                blnOtherDo = True
                            End If
                            If chk紧急.Tag <> "" Then
                                .TextMatrix(i, COL_标志) = .TextMatrix(lngRow, COL_标志)
                                blnOtherDo = True
                            End If
                                            
                            '开嘱时间
                            If .TextMatrix(i, COL_开嘱时间) <> .TextMatrix(lngRow, COL_开嘱时间) Then
                                .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                blnOtherDo = True
                            End If
                            
                            '开嘱医生
                            If .TextMatrix(i, COL_开嘱医生) <> .TextMatrix(lngRow, COL_开嘱医生) Then
                                .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                                blnOtherDo = True
                            End If
                                            
                            '开嘱科室ID
                            If .TextMatrix(i, COL_开嘱科室ID) <> .TextMatrix(lngRow, COL_开嘱科室ID) Then
                                .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                                blnOtherDo = True
                            End If
                            
                            '标记为修改
                            If blnOtherDo And InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                .TextMatrix(i, COL_EDIT) = 2
                                .TextMatrix(i, COL_状态) = 1 '修改后变为新开
                            End If
                        Else
                            Exit For
                        End If
                    Next
                End If
            ElseIf InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '中、西成药处理给药途径及一并给药的情况
                
                '执行性质
                If cbo执行性质.Tag <> "" Then
                    .TextMatrix(lngRow, COL_执行性质) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "自备药", 5, 4)
                    If Val(.TextMatrix(lngRow, COL_执行性质)) = 5 Then
                        .TextMatrix(lngRow, COL_执行科室ID) = 0
                    ElseIf Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then
                        '恢复缺省药房,缺省与前面的成药相同
                        strTmp = Get可用药房IDs(.TextMatrix(lngRow, COL_类别), Val(.TextMatrix(lngRow, COL_诊疗项目ID)), Val(.TextMatrix(lngRow, COL_收费细目ID)), mlng病人科室id, 1)
                        For i = lngRow - 1 To .FixedRows Step -1
                            '西成药和中成药的药房可能不同,所以类别要相同
                            If .TextMatrix(i, COL_类别) = .TextMatrix(lngRow, COL_类别) And Val(.TextMatrix(i, COL_执行科室ID)) <> 0 Then
                                If InStr("," & strTmp & ",", "," & Val(.TextMatrix(i, COL_执行科室ID)) & ",") > 0 Then
                                    .TextMatrix(lngRow, COL_执行科室ID) = Val(.TextMatrix(i, COL_执行科室ID))
                                    Exit For
                                End If
                            End If
                        Next
                        If Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then
                            .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, 0, .TextMatrix(lngRow, COL_类别), Val(.TextMatrix(lngRow, COL_诊疗项目ID)), Val(.TextMatrix(lngRow, COL_收费细目ID)), 4, mlng病人科室id, 0, 1, 1, True)
                        End If
                    End If
                    cbo执行科室.Tag = "1" '标明执行科室一并给药的要同步变
                    blnReInRow = True '界面执行科室编辑性变化
                End If
                
                '给药途径本身及其它相关数据同步更改
                lng执行科室ID = 0
                If cbo附加执行.ListIndex <> -1 Then
                    lng执行科室ID = cbo附加执行.ItemData(cbo附加执行.ListIndex)
                End If
                strTmp = ""
                If Trim(cbo滴速.Text) <> "" Then
                    strTmp = cbo滴速.Text & lbl滴速单位.Caption
                End If
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then
                    .TextMatrix(lngRow, COL_用法) = txt用法.Text & strTmp
                    
                    If CheckExecDeptValidate(lng执行科室ID, mlng病人科室id, 1, Val(cmd用法.Tag)) = False Then
                        lng执行科室ID = 0
                    End If
                    
                    Call AdviceSet给药途径(lngRow, Val(cmd用法.Tag), zlCommFun.GetNeedName(cbo执行性质.Text), lng执行科室ID, strTmp)
                    blnReInRow = True
                ElseIf blnCurDo Then 'cbo执行性质.Tag <> "" Then
                    '如果执行性质更改了,需要强行修改对应的给药途径的执行性质和执行科室
                    lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    Call AdviceSet给药途径(lngRow, Val(.TextMatrix(lngTmp, COL_诊疗项目ID)), zlCommFun.GetNeedName(cbo执行性质.Text), lng执行科室ID, strTmp)
                End If
                
                '一并给药:不处理给药途径,前面已单独设置
                If blnCurDo Then
                    lngBeginRow = .FindRow(.TextMatrix(lngRow, COL_相关ID), , COL_相关ID)
                    For i = lngBeginRow To .Rows - 1
                        If .TextMatrix(i, COL_相关ID) = "" Then
                            lngTmp = i: Exit For
                        End If
                    Next
                    For i = lngBeginRow To .Rows - 1
                        If i <> lngRow And .RowData(i) <> 0 _
                            And Val(.TextMatrix(i, COL_婴儿)) = Val(.TextMatrix(lngRow, COL_婴儿)) Then '可能现在中间有空行
                            If Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                                If msk开始时间.Tag <> "" Then
                                    .TextMatrix(i, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                                    .Cell(flexcpData, i, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
                                    blnOtherDo = True
                                End If
                                If txt用法.Tag <> "" Then
                                    .TextMatrix(i, COL_用法) = .TextMatrix(lngRow, COL_用法)
                                    blnOtherDo = True
                                End If
                                If txt频率.Tag <> "" Then
                                    .TextMatrix(i, COL_频率) = .TextMatrix(lngRow, COL_频率)
                                    .TextMatrix(i, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
                                    .TextMatrix(i, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
                                    .TextMatrix(i, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
                                    blnOtherDo = True
                                End If
                                
                                '将滴速补填到一并给药的其他行中
                                If cbo滴速.Tag <> "" Then
                                    .TextMatrix(i, COL_用法) = txt用法.Text & strTmp
                                    blnOtherDo = True
                                End If
                                
                                '一并给药的,天数相同变化,总量重新计算
                                If txt天数.Tag <> "" Then
                                    .TextMatrix(i, COL_天数) = .TextMatrix(lngRow, COL_天数)
                                    If .TextMatrix(i, COL_频率) <> "" _
                                        And Val(.TextMatrix(i, COL_单量)) <> 0 _
                                        And Val(.TextMatrix(i, COL_剂量系数)) <> 0 _
                                        And Val(.TextMatrix(i, COL_门诊包装)) <> 0 Then
                                        
                                        .TextMatrix(i, COL_总量) = FormatEx(Calc缺省药品总量( _
                                            Val(.TextMatrix(i, COL_单量)), Val(.TextMatrix(i, COL_天数)), _
                                            Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), _
                                            .TextMatrix(i, COL_间隔单位), .TextMatrix(i, COL_执行时间), _
                                            Val(.TextMatrix(i, COL_剂量系数)), Val(.TextMatrix(i, COL_门诊包装)), _
                                            Val(.TextMatrix(i, COL_可否分零))), 5)
                                        If InStr(GetInsidePrivs(p门诊医嘱下达), "药品小数输入") = 0 Then
                                            .TextMatrix(i, COL_总量) = IntEx(Val(.TextMatrix(i, COL_总量)))
                                        ElseIf Val(.TextMatrix(i, COL_可否分零)) <> 0 Then
                                            .TextMatrix(i, COL_总量) = IntEx(Val(.TextMatrix(i, COL_总量)))
                                        End If
                                    End If
                                    '重新检查处方限量超天
                                    .TextMatrix(i, COL_是否超期) = "": .TextMatrix(i, COL_是否超量) = ""
                                    If Val(.TextMatrix(i, COL_处方限量)) <> 0 Then
                                        dbl总量 = Val(.TextMatrix(i, COL_总量)) * Val(.TextMatrix(i, COL_门诊包装)) * Val(.TextMatrix(i, COL_剂量系数))
                                        If dbl总量 > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
                                    End If
                                    
                                    If Val(.TextMatrix(i, COL_天数)) > IIF(mbytPatiType = 1, conOrdinary, conEmergency) Then
                                        .TextMatrix(i, COL_是否超期) = "1"
                                    End If
                                    
                                    If .TextMatrix(i, COL_是否超期) = "" And .TextMatrix(i, COL_是否超量) = "" Then .TextMatrix(i, COL_超量说明) = ""
                                    
                                    blnOtherDo = True
                                End If
                                
                                If cbo执行时间.Tag <> "" Then
                                    .TextMatrix(i, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
                                    blnOtherDo = True
                                End If
                                
                                '执行性质:离院带药在一并给药中需一致，其它可单独设置
                                If cbo执行性质.Tag <> "" And zlCommFun.GetNeedName(cbo执行性质.Text) = "离院带药" Then
                                    .TextMatrix(i, COL_执行性质) = .TextMatrix(lngRow, COL_执行性质)
                                    '由自备药转过来时需要重新设置执行科室
                                    If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                                        .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                                    End If
                                    blnOtherDo = True
                                End If
                                
                                '执行科室:执行科室(药房)可以不同,除非是配制中心
                                If cbo执行科室.Tag <> "" Then
                                    '输入行改为自备药，或某行为自备药的情况不管它
                                    If Not (Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 And Val(.TextMatrix(lngRow, COL_执行性质)) = 5) _
                                        And Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                                        If .TextMatrix(lngTmp, COL_类别) = "E" And .TextMatrix(lngTmp, COL_操作类型) = "2" And .TextMatrix(lngTmp, COL_执行分类) = "1" Then
                                            If Sys.DeptHaveProperty(Val(.TextMatrix(lngRow, COL_执行科室ID)), "配制中心") Then
                                                '输入行药品由普通药房或其他配制中心改为新的配制中心,则该组药都改为该配制中心
                                                .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                                                blnOtherDo = True
                                            ElseIf Sys.DeptHaveProperty(Val(.TextMatrix(i, COL_执行科室ID)), "配制中心") Then
                                                '输入行药品由配制中心改成普通药房,则该组药都改为该普通药房
                                                .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                                                blnOtherDo = True
                                            End If
                                        End If
                                    End If
                                End If
                                
                                '紧急标志
                                If chk紧急.Tag <> "" Then
                                    .TextMatrix(i, COL_标志) = .TextMatrix(lngRow, COL_标志)
                                    .TextMatrix(i, COL_审核状态) = .TextMatrix(lngRow, COL_审核状态)
                                    blnOtherDo = True
                                End If
                                
                                '开嘱时间
                                If .TextMatrix(i, COL_开嘱时间) <> .TextMatrix(lngRow, COL_开嘱时间) Then
                                    .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                    .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                    blnOtherDo = True
                                End If
                                
                                '开嘱医生
                                If .TextMatrix(i, COL_开嘱医生) <> .TextMatrix(lngRow, COL_开嘱医生) Then
                                    .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                                    blnOtherDo = True
                                End If
                                
                                '开嘱科室ID
                                If .TextMatrix(i, COL_开嘱科室ID) <> .TextMatrix(lngRow, COL_开嘱科室ID) Then
                                    .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                                    blnOtherDo = True
                                End If
                                
                                '标记为修改
                                If blnOtherDo And InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                    .TextMatrix(i, COL_EDIT) = 2
                                    .TextMatrix(i, COL_状态) = 1 '修改后变为新开
                                End If
                            Else
                                Exit For
                            End If
                        End If
                    Next
                    If .TextMatrix(lngTmp, COL_操作类型) = "2" And (.TextMatrix(lngTmp, COL_执行分类) = "1" Or .TextMatrix(lngTmp, COL_执行分类) = "2") Then
                        i = Make本院执行次数(lngTmp)
                        If i < Val(.TextMatrix(lngTmp, COL_总量)) Then
                            .TextMatrix(lngTmp, COL_总量) = ""
                            blnReInRow = True
                        End If
                    End If
                End If
            ElseIf .TextMatrix(lngRow, COL_类别) = "K" Then
                '输血医嘱的处理(前面已处理输血时间(安排时间)的修改)
                
                lng执行科室ID = 0
                If cbo附加执行.ListIndex <> -1 Then
                    lng执行科室ID = cbo附加执行.ItemData(cbo附加执行.ListIndex)
                End If
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then
                    .TextMatrix(lngRow, COL_用法) = txt用法.Text
                    Call AdviceSet输血途径(lngRow, Val(cmd用法.Tag), lng执行科室ID)
                ElseIf blnCurDo Then
                    lngTmp = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_相关ID)
                    If lngTmp <> -1 Then
                        Call AdviceSet输血途径(lngRow, Val(.TextMatrix(lngTmp, COL_诊疗项目ID)), lng执行科室ID)
                    End If
                End If
            ElseIf InStr(",D,F,", .TextMatrix(lngRow, COL_类别)) > 0 And blnCurDo Then
                '检查组合项目行或手术附加行
                lngBeginRow = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_相关ID)
                If lngBeginRow <> -1 Then
                    For i = lngBeginRow To .Rows - 1
                        If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                            If txt单量.Tag <> "" Then
                                .TextMatrix(i, COL_单量) = .TextMatrix(lngRow, COL_单量)
                                blnOtherDo = True
                            End If
                            If txt总量.Tag <> "" Then
                                .TextMatrix(i, COL_总量) = .TextMatrix(lngRow, COL_总量)
                                blnOtherDo = True
                            End If
                            
                            If cbo执行时间.Tag <> "" Then
                                .TextMatrix(i, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
                                blnOtherDo = True
                            End If
                            If txt频率.Tag <> "" Then
                                .TextMatrix(i, COL_频率) = .TextMatrix(lngRow, COL_频率)
                                .TextMatrix(i, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
                                .TextMatrix(i, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
                                .TextMatrix(i, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
                                blnOtherDo = True
                            End If
                            If cbo执行科室.Tag <> "" Then
                                If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) > 0 Then
                                    .TextMatrix(i, COL_执行科室ID) = 0
                                ElseIf .TextMatrix(i, COL_类别) <> "G" Then '手术麻醉的执行科室为单独
                                    .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                                End If
                                blnOtherDo = True
                            End If
                            If msk开始时间.Tag <> "" Then
                                .TextMatrix(i, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                                .Cell(flexcpData, i, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
                                blnOtherDo = True
                            End If
                            If txt安排时间.Tag <> "" Then
                                .TextMatrix(i, COL_手术时间) = .TextMatrix(lngRow, COL_手术时间)
                                blnOtherDo = True
                            End If
                            If chk紧急.Tag <> "" Then
                                .TextMatrix(i, COL_标志) = .TextMatrix(lngRow, COL_标志)
                                blnOtherDo = True
                            End If
                            
                            '开嘱时间
                            If .TextMatrix(i, COL_开嘱时间) <> .TextMatrix(lngRow, COL_开嘱时间) Then
                                .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                blnOtherDo = True
                            End If
                            
                            '开嘱医生
                            If .TextMatrix(i, COL_开嘱医生) <> .TextMatrix(lngRow, COL_开嘱医生) Then
                                .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                                blnOtherDo = True
                            End If
                            
                            '开嘱科室ID
                            If .TextMatrix(i, COL_开嘱科室ID) <> .TextMatrix(lngRow, COL_开嘱科室ID) Then
                                .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                                blnOtherDo = True
                            End If
                            
                            '标记为修改
                            If blnOtherDo And InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                .TextMatrix(i, COL_EDIT) = 2
                                .TextMatrix(i, COL_状态) = 1 '修改后变为新开
                            End If
                        Else
                            Exit For
                        End If
                    Next
                End If
            ElseIf .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5" Then
                If cbo附加执行.Tag <> "" Then
                    lng执行科室ID = 0
                    If cbo附加执行.ListIndex <> -1 Then
                        lng执行科室ID = cbo附加执行.ItemData(cbo附加执行.ListIndex)
                    End If
                    .TextMatrix(lngRow, COL_用药理由) = lng执行科室ID
                End If
            End If
        End If
        
        '配方和其他诊疗项目都可能存在超期
        If txt超量说明.Enabled And txt超量说明.Tag <> "" Then
            .TextMatrix(lngRow, COL_超量说明) = txt超量说明.Text
            blnCurDo = True
        End If
        If lbl超量说明.Tag <> "" Then
            blnReSet超量说明 = True
        End If
        '统一处理相关行的属性变化
        If chkZeroBilling.Tag <> "" Then
            Call GetRowScope(lngRow, lngBegin, lngEnd)
            For i = lngBegin To lngEnd
                .TextMatrix(i, COL_零费记帐) = chkZeroBilling.value
            Next
            blnCurDo = True
        End If
                    
        '---------------
        If blnCurDo Then '标记为修改:0-原始的,1-新增的,2-修改了内容,3-修改了序号
            If InStr(",0,2,3,", .TextMatrix(lngRow, COL_EDIT)) > 0 Then
                 '审核未通过的是一组药品,则需要改变组内其他行的审核状态为未审核或无需审核
                If Val(.TextMatrix(lngRow, COL_审核状态)) <> 2 And .TextMatrix(lngRow, COL_类别) <> "K" Then
                    Call GetRowScope(lngRow, lngBeginRow, lngEndRow)
                    For i = lngBeginRow To lngEndRow
                        '如果是紧急医嘱，则无须审核
                        If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And .TextMatrix(i, COL_标志) <> 1 Then
                            .TextMatrix(i, COL_审核状态) = 1
                        Else
                            .TextMatrix(i, COL_审核状态) = ""
                        End If
                        Call SetRow标志图标(i, 2)
                    Next
                End If
                
                .TextMatrix(lngRow, COL_EDIT) = 2
                .TextMatrix(lngRow, COL_状态) = 1 '修改后变为新开
                Call ReSetColor(lngRow)
            End If
            mblnNoSave = True '标记为未保存
        End If
        
        '更新医嘱内容
        If AdviceTextChange(lngRow) Then
            .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
            txt医嘱内容.Text = .TextMatrix(lngRow, col_医嘱内容)
        End If
    End With
        
    '清除编辑标志
    Call ClearItemTag
    
    '某些情况下需要重新设置卡片的项目编辑性(如修改了执行性质时)
    If blnReInRow Then
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
        If vsAdvice.TextMatrix(lngRow, COL_是否超量) = "" And vsAdvice.TextMatrix(lngRow, COL_是否超期) = "" Then vsAdvice.TextMatrix(lngRow, COL_超量说明) = ""
    ElseIf blnReSet超量说明 Then
        SetItemEditable , , , , , , , , , , , , IIF(vsAdvice.TextMatrix(lngRow, COL_是否超量) = "1" Or vsAdvice.TextMatrix(lngRow, COL_是否超期) = "1", 1, -1)
        If vsAdvice.TextMatrix(lngRow, COL_是否超量) = "" And vsAdvice.TextMatrix(lngRow, COL_是否超期) = "" Then vsAdvice.TextMatrix(lngRow, COL_超量说明) = ""
    End If
End Sub

Private Sub ReSetColor(ByVal lngRow As Long)
'功能：重新设置指定行的颜色
'说明：
    Dim lngBegin As Long, lngEnd As Long, i As Long
    
    With vsAdvice
        '一并给药范围
        lngBegin = lngRow: lngEnd = lngRow
        If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            If RowIn一并给药(lngRow) Then
                Call Get一并给药范围(Val(.TextMatrix(lngRow, COL_相关ID)), lngBegin, lngEnd)
            End If
        End If
        '恢复成正常色
        For i = lngBegin To lngEnd
            .Cell(flexcpForeColor, i, .FixedCols, i, COL_开嘱医生) = .ForeColor
            '毒麻精的颜色标识
            If InStr(",麻醉药,毒性药,精神药,精神I类,精神II类,", .TextMatrix(i, COL_毒理分类)) > 0 _
                And .TextMatrix(i, COL_毒理分类) <> "" Then
                .Cell(flexcpFontBold, i, col_医嘱内容) = True
            End If
        Next
        .ForeColorSel = .Cell(flexcpForeColor, lngRow, COL_开始时间)
    End With
End Sub

Private Sub AdviceSet一并给药(ByVal lngBegin As Long, ByVal lngEnd As Long)
'功能：将选择范围内的药品设置为一并给药
'参数：起止行号,中间不包含空行,不包含最后一行药品的给药途径行
'说明：以第一行药品的给药途径为准,但位置放在最后一行药品之后
    Dim varTmp1 As Variant, varTmp2 As Variant
    Dim lngRow1 As Long, lngRow2 As Long
    Dim lng相关ID As Long, i As Long
    Dim strStart As String, curDate As Date
    Dim lng配制中心 As Long
    
    With vsAdvice
        lngRow1 = .FindRow(CLng(.TextMatrix(lngBegin, COL_相关ID)), lngBegin + 1) '第一给药途径行
        lngRow2 = .FindRow(CLng(.TextMatrix(lngEnd, COL_相关ID)), lngEnd + 1) '最后给药途径行
        '删除给药途径行之前记录执行性质,以便后面作判断
        For i = lngRow2 To lngRow1 Step -1
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex And .RowHidden(i) Then
                .Cell(flexcpData, i - 1, COL_执行性质) = Val(.TextMatrix(i, COL_执行性质))
            End If
        Next
        
        '复制第一行的给药途径到最后一行的给药途径
        For i = .FixedCols To .Cols - 1
            If i <> COL_EDIT And i <> COL_相关ID And i <> COL_序号 And i <> COL_状态 Then
                .TextMatrix(lngRow2, i) = .TextMatrix(lngRow1, i)
            End If
        Next
        .Cell(flexcpData, lngRow2, COL_开始时间) = .TextMatrix(lngRow2, COL_开始时间)
        
        '编辑标志：0-原始的,1-新增的,2-修改了内容,3-修改了序号
        If InStr(",0,3,", .TextMatrix(lngRow2, COL_EDIT)) > 0 Then
            .TextMatrix(lngRow2, COL_EDIT) = 2 '标记为已修改
            .TextMatrix(lngRow2, COL_状态) = 1 '修改后变为新开
        End If
        lng相关ID = .RowData(lngRow2)
        
        varTmp1 = mblnRowChange: varTmp2 = .Redraw
        mblnRowChange = False: .Redraw = flexRDNone
        
        '删除除最后一行给药途径外的其它给药途径
        For i = lngEnd To lngBegin Step -1
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                If .RowHidden(i) Then
                    Call DeleteRow(i)
                Else
                    .TextMatrix(i, COL_相关ID) = lng相关ID
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2 '标记为已修改
                        .TextMatrix(i, COL_状态) = 1 '修改后变为新开
                    End If
                End If
            End If
        Next
        
        '行号已变更
        lngRow1 = lngBegin '开始一并给药行
        curDate = zlDatabase.Currentdate
        
        '检查医生是否变更
        If .TextMatrix(lngRow1, COL_开嘱医生) <> UserInfo.姓名 Then
            '更新相关信息:前面已标记为修改,且手工操作完成时已有进入界面刷新
            .TextMatrix(lngRow1, COL_开嘱医生) = UserInfo.姓名
            .TextMatrix(lngRow1, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
            
            .TextMatrix(lngRow1, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
            .Cell(flexcpData, lngRow1, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
        End If
        
        '处理一并给药其他行的相同信息
        For i = lngRow1 + 1 To .Rows - 1
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                If Val(.TextMatrix(i, COL_相关ID)) = lng相关ID Then
                    lngRow2 = i '记录新的结束行号
                    
                    '一并给药的部分信息相同
                    .TextMatrix(i, COL_开始时间) = .TextMatrix(lngRow1, COL_开始时间)
                    .Cell(flexcpData, i, COL_开始时间) = .Cell(flexcpData, lngRow1, COL_开始时间)
                    
                    .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow1, COL_开嘱医生)
                    .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow1, COL_开嘱科室ID)
                    
                    .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow1, COL_开嘱时间) '一并给药的开嘱时间相同
                    .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow1, COL_开嘱时间)
                    
                    .TextMatrix(i, COL_天数) = .TextMatrix(lngRow1, COL_天数)
                    
                    .TextMatrix(i, COL_用法) = .TextMatrix(lngRow1, COL_用法)
                    
                    .TextMatrix(i, COL_频率) = .TextMatrix(lngRow1, COL_频率)
                    .TextMatrix(i, COL_频率次数) = .TextMatrix(lngRow1, COL_频率次数)
                    .TextMatrix(i, COL_频率间隔) = .TextMatrix(lngRow1, COL_频率间隔)
                    .TextMatrix(i, COL_间隔单位) = .TextMatrix(lngRow1, COL_间隔单位)
                    .TextMatrix(i, COL_执行时间) = .TextMatrix(lngRow1, COL_执行时间)
                    
                    '启用了天数控制才反算（71152）
                    If mbln天数 Then .TextMatrix(i, COL_总量) = ReGet药品总量(Val(.TextMatrix(i, COL_总量)), Val(.TextMatrix(i, COL_单量)), Val(.TextMatrix(i, COL_天数)), i)
                    
                    
                    '处方限量
                    .TextMatrix(i, COL_是否超量) = ""
                    If Val(.TextMatrix(i, COL_处方限量)) <> 0 Then
                        If Val(.TextMatrix(i, COL_总量)) > FormatEx(Val(.TextMatrix(i, COL_处方限量)) / Val(.TextMatrix(i, COL_剂量系数)) / Val(.TextMatrix(i, COL_门诊包装)), 5) Then
                            .TextMatrix(i, COL_是否超量) = "1"
                        End If
                    End If
                    
                    .TextMatrix(i, COL_是否超期) = ""
                    Call Set用药天数是否超期(i)
                    
                    .TextMatrix(i, COL_标志) = .TextMatrix(lngRow1, COL_标志)
                    Set .Cell(flexcpPicture, i, COL_F标志) = Nothing '在开始行显示
                    
                    '离院带药一组相同
                    If Val(.TextMatrix(lngRow1, COL_执行性质)) <> 5 And Val(.Cell(flexcpData, lngRow1, COL_执行性质)) = 5 Then
                        '第一行是离院带药,全部设置为离院带药
                        .TextMatrix(i, COL_执行性质) = .TextMatrix(lngRow1, COL_执行性质)
                        If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then '执行科室可以不同,没有时才缺省相同
                            .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow1, COL_执行科室ID)
                        End If
                    ElseIf Val(.TextMatrix(i, COL_执行性质)) <> 5 And Val(.Cell(flexcpData, i, COL_执行性质)) = 5 Then
                        '当前行是离院带药,则设置为与第一行相同
                        .TextMatrix(i, COL_执行性质) = .TextMatrix(lngRow1, COL_执行性质)
                        If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                            .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow1, COL_执行科室ID)
                        End If
                    Else
                        '否则保持不变
                    End If
                    
                    '标记为修改:0-原始的,1-新增的,2-修改了内容,3-修改了序号
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2
                        .TextMatrix(i, COL_状态) = 1 '修改后变为新开
                    End If
                Else
                    Exit For
                End If
            End If
        Next
    
        '检查这些药品中是否存在配制中心拿药的，以第一个为准
        For i = lngRow1 To .Rows - 1
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                If Val(.TextMatrix(i, COL_相关ID)) = lng相关ID Then
                    '自备药的情况不管它
                    If Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                        If Sys.DeptHaveProperty(Val(.TextMatrix(i, COL_执行科室ID)), "配制中心") Then
                            lng配制中心 = Val(.TextMatrix(i, COL_执行科室ID)): Exit For
                        End If
                    End If
                Else
                    Exit For
                End If
            End If
        Next
        '配制中心一组相同
        If lng配制中心 <> 0 Then
            For i = lngRow1 To .Rows - 1
                If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                    If Val(.TextMatrix(i, COL_相关ID)) = lng相关ID Then
                        '自备药的情况不管它
                        If Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                            .TextMatrix(i, COL_执行科室ID) = lng配制中心
                            
                            '标记为修改:0-原始的,1-新增的,2-修改了内容,3-修改了序号
                            If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                .TextMatrix(i, COL_EDIT) = 2
                                .TextMatrix(i, COL_状态) = 1 '修改后变为新开
                            End If
                        End If
                    Else
                        Exit For
                    End If
                End If
            Next
        End If
        
        '开始执行时间处理(新开的不能太早)
        strStart = ""
        For i = lngRow1 To lngRow2
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                If Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                    If DateDiff("n", CDate(.Cell(flexcpData, i, COL_开始时间)), curDate) > gint门诊新开医嘱间隔 Then
                        strStart = GetDefaultTime(i): Exit For
                    End If
                End If
            End If
        Next
        If strStart <> "" Then
            For i = lngRow1 To lngRow2 + 1
                If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                    .Cell(flexcpData, i, COL_开始时间) = strStart
                    .TextMatrix(i, COL_开始时间) = Format(strStart, "yyyy-MM-dd HH:mm")
                End If
            Next
        End If
        
        Call ReSet审核状态图标(lngBegin)
        Call SetTag一并给药(lngBegin)
        mblnRowChange = varTmp1: .Redraw = varTmp2
        mblnNoSave = True '标记为未保存
    End With
End Sub

Private Sub AdviceSet单独给药(ByVal lngBegin As Long, ByVal lngEnd As Long)
'功能：取消一组药品的一并给药
'参数：起止行号,中间不包含空行,不包含最后一行药品的给药途径行
    Dim varTmp1 As Variant, varTmp2 As Variant
    Dim lng给药途径ID As Long, lng给药执行ID As Long, i As Long
    Dim int执行性质 As Integer, str执行性质 As String, str滴速 As String
    Dim lngRow As Long, curDate As Date, blnUpdate As Boolean
    
    With vsAdvice
        varTmp1 = mblnRowChange: varTmp2 = .Redraw
        mblnRowChange = False: .Redraw = flexRDNone
        
        '一并给药途径
        lngRow = .FindRow(CLng(.TextMatrix(lngEnd, COL_相关ID)), lngEnd + 1)
        lng给药途径ID = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
        lng给药执行ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
        int执行性质 = Val(.TextMatrix(lngRow, COL_执行性质))
        str滴速 = .TextMatrix(lngRow, COL_医生嘱托)
                
        '检查医生变更:以给药途径行为准变化
        If .TextMatrix(lngRow, COL_开嘱医生) <> UserInfo.姓名 Then
            '更新相关信息:手工操作完成时有进入界面刷新
            .TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
            .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
            curDate = zlDatabase.Currentdate
            .TextMatrix(lngRow, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
            .Cell(flexcpData, lngRow, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
            
            If InStr(",0,3,", .TextMatrix(lngRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngRow, COL_EDIT) = 2 '标记为已修改
                .TextMatrix(lngRow, COL_状态) = 1 '修改后变为新开
            End If
            blnUpdate = True
        End If
                
        '显示紧急标志:每一行
        For i = lngBegin To lngEnd
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                '药品行相应变化
                If blnUpdate Then
                    .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                    .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                    .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                    .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2 '标记为已修改
                        .TextMatrix(i, COL_状态) = 1 '修改后变为新开
                    End If
                End If
                If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And .TextMatrix(i, COL_标志) <> "1" Then
                    .TextMatrix(i, COL_审核状态) = 1
                Else
                    .TextMatrix(i, COL_审核状态) = ""
                End If
                Call SetRow标志图标(i, 2)
            End If
        Next
        
        For i = lngEnd - 1 To lngBegin Step -1 '必须反向
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                '设置给药途径行
                If Val(.TextMatrix(i, COL_执行性质)) = 5 And int执行性质 <> 5 Then
                    str执行性质 = "自备药"
                ElseIf Val(.TextMatrix(i, COL_执行性质)) <> 5 And int执行性质 = 5 Then
                    str执行性质 = "离院带药"
                Else
                    str执行性质 = ""
                End If
                .TextMatrix(i, COL_相关ID) = "" '必须清除作为标志
                .TextMatrix(i, COL_相关ID) = AdviceSet给药途径(i, lng给药途径ID, str执行性质, lng给药执行ID, str滴速)
                
                If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                    .TextMatrix(i, COL_EDIT) = 2 '标记为已修改
                    .TextMatrix(i, COL_状态) = 1 '修改后变为新开
                End If
            End If
        Next
        lngRow = lngEnd + (lngEnd - lngBegin)
        For i = lngBegin To lngRow Step 2
            .TextMatrix(i, COL_并) = ""
        Next
        mblnRowChange = varTmp1: .Redraw = varTmp2
        mblnNoSave = True '标记为未保存
    End With
End Sub

Private Sub ShowAdvice()
'功能：显示当前界面条件下的医嘱记录
'说明：1.根据程序编辑方式,相关的数据行是按序号严格排列在一在的。
'      2.这里不处理一并给药的边框及配方行高，状态颜色等格式内容,它们已在读取或编辑时设置
    Dim lngRow As Long, blnHide As Boolean, i As Long
    
    Screen.MousePointer = 11
    mblnRowChange = False
    vsAdvice.Redraw = flexRDNone
        
    '先删除无效行
    For i = vsAdvice.Rows - 1 To vsAdvice.FixedRows Step -1
        If vsAdvice.RowData(i) = 0 Then vsAdvice.RemoveItem i
    Next
    
    '根据当前期效,婴儿显示
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                blnHide = False
                '隐藏以下数据行：
                '1.成药的给药途径行
                '2.手术的附加手术及麻醉项目行
                '3.检查组合的部位行
                '4.中药配方的组成味中药及中药煎法行
                '5.(一并采集的)检验项目
                '6.输血项目的输血途径
                If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                    If Val(.TextMatrix(i - 1, COL_相关ID)) = .RowData(i) _
                        And InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                        blnHide = True
                    End If
                End If
                If InStr(",F,G,D,7,E,C,", .TextMatrix(i, COL_类别)) > 0 _
                    And Val(.TextMatrix(i, COL_相关ID)) <> 0 Then
                    blnHide = True
                End If
                                
                .RowHidden(i) = blnHide
                If Not blnHide And lngRow = 0 Then lngRow = i
                
                '计算诊疗单价:这里为加快速度,只读取新开的,其它的进入再读
                If Not .RowHidden(i) _
                    And Val(.TextMatrix(i, COL_状态)) = 1 And .TextMatrix(i, COL_单价) = "" Then
                    .TextMatrix(i, COL_单价) = GetItemPrice(i)
                End If
            Else
                .RowHidden(i) = True
            End If
        Next
    End With
    
    '没有数据行,添加一行空
    If lngRow = 0 Then
        vsAdvice.AddItem ""
        lngRow = vsAdvice.Rows - 1
    End If
    
    vsAdvice.Row = lngRow
    If vsAdvice.RowData(lngRow) = 0 Then
        vsAdvice.Col = vsAdvice.FixedCols
    Else
        vsAdvice.Col = col_医嘱内容
    End If
    vsAdvice.Redraw = flexRDDirect
    mblnRowChange = True
 
    '显示当前行:进入时在FormLoad中处理,以加快速度
    If Me.Visible Then Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    
    Call CalcAdviceMoney '显示新开医嘱金额
    
    Screen.MousePointer = 0
End Sub

Private Function SaveAdvice() As Boolean
'功能：保存当前病人的医嘱记录
    Dim arrSQL As Variant, arrDelID() As String
    Dim strSQL As String, dbl总量 As Double
    Dim arrAppend As Variant, i As Long, j As Long, lngTmp As Long, lng执行ID As Long
    Dim blnChecked As Boolean
    Dim curDate As Date
    Dim blnTrans As Boolean
    Dim blnDiagChange As Boolean, blnRecipeNo As Boolean
    Dim strFilter As String, strTmp As String
    Dim rsMsg As ADODB.Recordset
    Dim str记录人 As String
    Dim str给药IDs As String
    Dim lng相关ID As Long
    Dim str撤销给药IDs As String
    Dim rsPass As ADODB.Recordset
    Dim rsCard As ADODB.Recordset
    Dim rsBlood As ADODB.Recordset, intBloodState As Integer
    Dim varTmp As Variant
    Dim blnRis As Boolean 'RIS接口
    Dim strNewAdvice As String '新增和修改后的医嘱,格式 医嘱ID:诊疗项目ID,....
    Dim str本次变动 As String '本次删除和修改的医嘱，用于判断RIS预约的医嘱是否已经被预约，已经被预约的医嘱不能删
    Dim rsTmp As ADODB.Recordset
    Dim blnMsgOk As Boolean
    Dim lng诊断记录ID As Long
    Dim rsPathAdvice As ADODB.Recordset, blnDo As Boolean
    Dim strAdivcePathOut As String, rsPath As ADODB.Recordset
    Dim lng阶段Id As Long, lng天数 As Long
    Dim byt生成时间性质 As Byte, dat日期 As Date, strAddDate As String
    Dim str路径项目分类 As String, str路径项目IDs As String
    Dim rs输血 As ADODB.Recordset '输血医嘱血库接口调用时的参数信息
    Dim bln血库 As Boolean        '是否需要进行血库接口调用
    Dim strAdvices输血 As String
    Dim strErr As String
    Dim bln用血审核 As Boolean
    Dim blnNewDrug As Boolean 'T-存在新开或修改的药嘱
    
    On Error GoTo errH
    
    If HaveRIS And gbln启用影像信息系统预约 Then
        blnRis = mbytUseType = 0
    ElseIf gbln启用影像信息系统接口 = True And gbln启用影像信息系统预约 = True Then
        MsgBox "RIS接口创建失败，不能继续当前操作。可能是接口文件安装或注册不正常，请与系统管理员联系。", vbInformation, gstrSysName
        Exit Function
    End If
    
    '替换成真实的医嘱ID，包括诊断医嘱对应
    Call MakeRealID
    
    'Pass自动用药审查
    If mblnPass Then
        blnNewDrug = IsNewDrug
        If blnNewDrug Then
            If gobjPass.PassType = G_PASS_TYPE.HZYY Then
                Call UpdateRecipeNo '杭州逸曜
                blnRecipeNo = True
            End If
            If Not gobjPass.zlPassAdviceSave(mobjPassMap, mblnNoSave, rsPass) Then Exit Function
            '填写禁忌药品说明
            With vsAdvice
                If Not rsPass Is Nothing Then
                    For i = .FixedRows To .Rows - 1
                        If .RowData(i) <> 0 Then
                            rsPass.Filter = "医嘱ID=" & CLng(.RowData(i) & "") & " And 是否禁忌=1"
                            If rsPass.RecordCount > 0 Then
                                .TextMatrix(i, COL_禁忌药品说明) = rsPass!禁忌药品说明
                                .Cell(flexcpData, i, COL_序号) = 1 '标记
                            End If
                        End If
                    Next
                End If
            End With
        End If
    End If
    '调用外挂接口
    If CreatePlugInOK(p门诊医嘱下达, mint场合) Then
        If zlPluginAdviceSave = False Then Exit Function
    End If
    Screen.MousePointer = 11
    
    If gbln血库系统 Then bln血库 = InitObjBlood()
    Set rs输血 = New ADODB.Recordset
    With rs输血
        .Fields.Append "医嘱ID", adBigInt
        .Fields.Append "类型", adInteger '0－新开，1－修改，2－删除
        .Fields.Append "状态", adInteger '0-调用血库接口,1-不掉用血库接口(用血医嘱审核)
        .CursorLocation = adUseClient
        .LockType = adLockOptimistic
        .CursorType = adOpenStatic
        .Open
    End With
    If mstrDel输血 <> "" Then
        arrDelID = Split(mstrDel输血, ",")
        For i = 0 To UBound(arrDelID)
            If Val(arrDelID(i)) <> 0 Then
                Call rs输血.AddNew(Array("医嘱ID", "类型"), Array(Val(arrDelID(i)), 2))
            End If
        Next
    End If
    
    If Not (mclsMipModule Is Nothing) Then
        blnMsgOk = mclsMipModule.IsConnect
    Else
        blnMsgOk = False
    End If
    
    '生成SQL
    arrSQL = Array()
    curDate = zlDatabase.Currentdate
    
    '处方审查系统
    If InitObjRecipeAudit(p门诊医嘱下达) Then
        For i = vsAdvice.FixedRows To vsAdvice.Rows - 1
            If Val(vsAdvice.TextMatrix(i, COL_EDIT)) = 2 Then
                If vsAdvice.TextMatrix(i, COL_类别) = "5" Or vsAdvice.TextMatrix(i, COL_类别) = "6" Or vsAdvice.TextMatrix(i, COL_类别) = "7" Then
                    If vsAdvice.TextMatrix(i, COL_处方审查状态) = "1" Or vsAdvice.TextMatrix(i, COL_处方审查状态) = "2" Then
                        If InStr("," & mstrAduitDelIDs & ",", "," & vsAdvice.TextMatrix(i, COL_相关ID) & ",") = 0 And vsAdvice.TextMatrix(i, COL_相关ID) <> "" Then
                            mstrAduitDelIDs = mstrAduitDelIDs & "," & vsAdvice.TextMatrix(i, COL_相关ID)
                        End If
                    End If
                    If vsAdvice.TextMatrix(i, COL_处方审查状态) <> "" Then
                        If InStr("," & str撤销给药IDs & ",", "," & vsAdvice.TextMatrix(i, COL_相关ID) & ",") = 0 And vsAdvice.TextMatrix(i, COL_相关ID) <> "" Then
                            str撤销给药IDs = str撤销给药IDs & "," & vsAdvice.TextMatrix(i, COL_相关ID)
                        End If
                    End If
                End If
            End If
        Next
        mstrAduitDelIDs = Mid(mstrAduitDelIDs, 2)
        For i = 0 To UBound(Split(mstrAduitDelIDs, ","))
            If InStr("," & str撤销给药IDs & ",", "," & Split(mstrAduitDelIDs, ",")(i) & ",") = 0 Then
                str撤销给药IDs = str撤销给药IDs & "," & Split(mstrAduitDelIDs, ",")(i)
            End If
        Next
        str撤销给药IDs = Mid(str撤销给药IDs, 2)
        '如果有一个被假删除，则整组假删除
        If mstrAduitDelIDs <> "" Then
            For i = vsAdvice.FixedRows To vsAdvice.Rows - 1
                If InStr("," & mstrAduitDelIDs & ",", "," & vsAdvice.RowData(i) & ",") > 0 And mstrAduitDelIDs <> "" Then
                    lng相关ID = vsAdvice.RowData(i)
                    vsAdvice.RowData(i) = zlDatabase.GetNextID("病人医嘱记录")
                    vsAdvice.TextMatrix(i, COL_EDIT) = 1
                    For j = i - 1 To vsAdvice.FixedRows Step -1
                        If Val(vsAdvice.TextMatrix(j, COL_相关ID)) <> lng相关ID Then Exit For
                        vsAdvice.TextMatrix(j, COL_相关ID) = vsAdvice.RowData(i)
                        vsAdvice.RowData(j) = zlDatabase.GetNextID("病人医嘱记录")
                        vsAdvice.TextMatrix(j, COL_EDIT) = 1
                    Next
                End If
            Next
            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
            arrSQL(UBound(arrSQL)) = "Zl_病人医嘱记录_处方审查删除('" & mstrAduitDelIDs & "')"
        End If
        If str撤销给药IDs <> "" Then
            '产生了处方审查数据的都要撤销
            Call gobjRecipeAudit.CancelData(str撤销给药IDs, "")
        End If
    End If
    
    '删除了的记录
    If mbytUseType = 2 And mstrAdivceOfPath <> "" Then
        mstrAdivceOfPath = ""
        gcnOracle.RollbackTrans    '之前插入后没有提交
    Else
    arrDelID = Split(mstrDelIDs, ",")
    For i = 0 To UBound(arrDelID)
        If Val(arrDelID(i)) <> 0 Then
            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
            arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_Delete(" & Val(arrDelID(i)) & ")"
            If blnRis Then str本次变动 = str本次变动 & "," & Val(arrDelID(i))
        End If
    Next
    End If
    If mbytUseType = 0 And mlng路径状态 = 1 Then
        Set rsPath = GetPatiOutPathInfo(mlng病人ID, mlng病人科室id, str路径项目分类)
        Set rsPathAdvice = MakePathAdivceRS
        strAddDate = "To_Date('" & Format(curDate, "yyyy-MM-dd HH:mm:ss") & "','YYYY-MM-DD HH24:MI:SS')"
    End If

    '编辑标志：0-原始的,1-新增的,2-修改了内容,3-修改了序号
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If .RowData(i) <> 0 And (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2)) Then     '所有医嘱记录
                '检验采集医嘱标本部位的处理
                If .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_标本部位) = "" Then
                    If RowIn检验行(i) Then .TextMatrix(i, COL_标本部位) = .TextMatrix(i - 1, COL_标本部位)
                End If
                
                '总量转换
                dbl总量 = 0
                If InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                    If Val(.TextMatrix(i, COL_总量)) <> 0 Then
                        If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                            '成药转换成零售单位
                            dbl总量 = Format(Val(.TextMatrix(i, COL_总量)) * Val(.TextMatrix(i, COL_门诊包装)), "0.00000")
                        Else
                            '中药配方付数或非药临嘱总量,不转换
                            dbl总量 = Val(.TextMatrix(i, COL_总量))
                        End If
                    End If
                End If

                '33629
                '麻醉药品和第一类精神药品处方还应当包括患者身份证明编号，代办人姓名、身份证明编号。
                If blnChecked = False And mblnAddAgent Then
                    If .RowHidden(i) = False And AgentInfo.本次就诊已录入 = False Then
                        If Val(.TextMatrix(i, COL_状态)) = 1 And InStr(",麻醉药,毒性药,精神I类,", "," & Trim(.TextMatrix(i, COL_毒理分类)) & ",") > 0 Then
                            blnChecked = frmAgentInfo.ShowMe(Me, mlng病人ID, mlng挂号ID, mstr姓名, mstr身份证号, AgentInfo.代办人姓名, AgentInfo.代办人身份证号, AgentInfo.代办人性别, AgentInfo.代办人年龄, AgentInfo.代办人电话, AgentInfo.用药理由)
                            If blnChecked Then
                                Call GetAgentInfo
                            Else
                                Screen.MousePointer = 0
                                Exit Function
                            End If
                        End If
                    End If
                End If
                
                If .TextMatrix(i, COL_类别) = "K" And bln血库 Then
                    If Val(.TextMatrix(i, COL_EDIT)) = 2 Then
                        intBloodState = 0
                        '用血医嘱已经发血，则修改医嘱审核状态为2
                        If Val(.TextMatrix(i, COL_检查方法)) = 1 Then
                            If gobjPublicBlood.GetPrepareBloodRs(Val(.RowData(i)), rsBlood) = True Then
                                If Val(rsBlood!记录性质 & "") = 2 And Val(rsBlood!记录状态 & "") = 1 Then
                                    .TextMatrix(i, COL_审核状态) = 2
                                    intBloodState = 1
                                    bln用血审核 = True
                                End If
                            End If
                        End If
                        Call rs输血.AddNew(Array("医嘱ID", "类型", "状态"), Array(Val(.RowData(i)), 1, intBloodState))
                    ElseIf Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                        Call rs输血.AddNew(Array("医嘱ID", "类型"), Array(Val(.RowData(i)), 0))
                    End If
                End If

                If Val(.TextMatrix(i, COL_EDIT)) = 3 Then    '修改了序号的记录
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_更新序号(" & .RowData(i) & "," & Val(.TextMatrix(i, COL_序号)) & ")"
                ElseIf Val(.TextMatrix(i, COL_EDIT)) = 2 Then    '修改了内容的记录
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_Update(" & _
                                             .RowData(i) & "," & ZVal(.TextMatrix(i, COL_相关ID)) & "," & _
                                             Val(.TextMatrix(i, COL_序号)) & "," & Val(.TextMatrix(i, COL_状态)) & ",1," & _
                                             Val(.TextMatrix(i, COL_诊疗项目ID)) & "," & ZVal(.TextMatrix(i, COL_收费细目ID)) & "," & _
                                             ZVal(.TextMatrix(i, COL_天数)) & "," & ZVal(.TextMatrix(i, COL_单量)) & "," & ZVal(dbl总量) & "," & _
                                             "'" & Replace(.TextMatrix(i, col_医嘱内容), "'", "''") & "','" & Replace(.TextMatrix(i, COL_医生嘱托), "'", "''") & "'," & _
                                             "'" & .TextMatrix(i, COL_标本部位) & "','" & .TextMatrix(i, COL_频率) & "'," & _
                                             ZVal(.TextMatrix(i, COL_频率次数)) & "," & ZVal(.TextMatrix(i, COL_频率间隔)) & "," & _
                                             "'" & .TextMatrix(i, COL_间隔单位) & "','" & .TextMatrix(i, COL_执行时间) & "'," & _
                                             Val(.TextMatrix(i, COL_计价性质)) & "," & ZVal(.TextMatrix(i, COL_执行科室ID)) & "," & _
                                             Val(.TextMatrix(i, COL_执行性质)) & "," & Val(.TextMatrix(i, COL_标志)) & "," & _
                                             "To_Date('" & Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI'),NULL," & _
                                             mlng病人科室id & "," & Val(.TextMatrix(i, COL_开嘱科室ID)) & ",'" & .TextMatrix(i, COL_开嘱医生) & "'," & _
                                             "To_Date('" & Format(.Cell(flexcpData, i, COL_开嘱时间), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI')," & _
                                             "'" & .TextMatrix(i, COL_检查方法) & "'," & Val(.TextMatrix(i, COL_执行标记)) & "," & _
                                             "NULL,'" & .Cell(flexcpData, i, COL_医生嘱托) & "','" & UserInfo.姓名 & "'," & ZVal(.TextMatrix(i, COL_零费记帐)) & "," & _
                                             ZVal(Val(.TextMatrix(i, COL_用药目的))) & ",'" & .TextMatrix(i, COL_用药理由) & "'," & ZVal(Val(.TextMatrix(i, COL_审核状态))) & ",'" & .TextMatrix(i, COL_超量说明) & "'" & _
                                             ",'',Null," & ZVal(Val(.TextMatrix(i, COL_组合项目ID))) & ",'" & .Cell(flexcpData, i, COL_皮试结果) & "'," & IIF(blnRecipeNo, Val(.TextMatrix(i, COL_处方序号)), "NULL") & ")"
                ElseIf Val(.TextMatrix(i, COL_EDIT)) = 1 Then    '新增的记录
                    
                    If .TextMatrix(i, COL_类别) = "K" Then
                        '输血类医嘱从新获取医嘱审核状态
                        If TypeName(.Cell(flexcpData, i, COL_申请序号)) = "Recordset" Then
                            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, i, COL_申请序号))
                            If Not rsCard.EOF Then
                                rsCard.MoveFirst
                                strTmp = NVL(rsCard!申请项目 & "", .TextMatrix(i, COL_诊疗项目ID) & "," & dbl总量)
                                .TextMatrix(i, COL_审核状态) = GetBloodVerifyState(1, mlng病人ID, mlng挂号ID, .TextMatrix(i, COL_标本部位), GetBloodTotalByML(strTmp), Val(.TextMatrix(i, COL_标志)), Val(.TextMatrix(i, COL_检查方法)), Val(.TextMatrix(i, COL_婴儿)), .RowData(i))
                                If i < .Rows - 1 Then
                                    If Val(.TextMatrix(i + 1, COL_相关ID)) = .RowData(i) Then
                                        .TextMatrix(i + 1, COL_审核状态) = .TextMatrix(i, COL_审核状态)
                                    End If
                                End If
                                Call SetRow标志图标(i, 2)
                            End If
                        Else
                            '非申请单下达的医嘱
                            If bln血库 Then
                                strTmp = .TextMatrix(i, COL_诊疗项目ID) & "," & dbl总量
                                .TextMatrix(i, COL_审核状态) = GetBloodVerifyState(1, mlng病人ID, mlng挂号ID, .TextMatrix(i, COL_标本部位), GetBloodTotalByML(strTmp), Val(.TextMatrix(i, COL_标志)), Val(.TextMatrix(i, COL_检查方法)), Val(.TextMatrix(i, COL_婴儿)), .RowData(i))
                                If i < .Rows - 1 Then
                                    If Val(.TextMatrix(i + 1, COL_相关ID)) = .RowData(i) Then
                                        .TextMatrix(i + 1, COL_审核状态) = .TextMatrix(i, COL_审核状态)
                                    End If
                                End If
                                Call SetRow标志图标(i, 2)
                            End If
                        End If
                    End If
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_Insert(" & _
                                             .RowData(i) & "," & ZVal(.TextMatrix(i, COL_相关ID)) & "," & _
                                             Val(.TextMatrix(i, COL_序号)) & ",1," & mlng病人ID & ",NULL," & _
                                             Val(.TextMatrix(i, COL_婴儿)) & "," & Val(.TextMatrix(i, COL_状态)) & ",1," & _
                                             "'" & IIF(.TextMatrix(i, COL_类别) = "*", "", .TextMatrix(i, COL_类别)) & "'," & Val(.TextMatrix(i, COL_诊疗项目ID)) & "," & _
                                             ZVal(.TextMatrix(i, COL_收费细目ID)) & "," & _
                                             ZVal(.TextMatrix(i, COL_天数)) & "," & ZVal(.TextMatrix(i, COL_单量)) & "," & ZVal(dbl总量) & "," & _
                                             "'" & Replace(.TextMatrix(i, col_医嘱内容), "'", "''") & "','" & Replace(.TextMatrix(i, COL_医生嘱托), "'", "''") & "'," & _
                                             "'" & .TextMatrix(i, COL_标本部位) & "','" & .TextMatrix(i, COL_频率) & "'," & _
                                             ZVal(.TextMatrix(i, COL_频率次数)) & "," & ZVal(.TextMatrix(i, COL_频率间隔)) & "," & _
                                             "'" & .TextMatrix(i, COL_间隔单位) & "','" & .TextMatrix(i, COL_执行时间) & "'," & _
                                             Val(.TextMatrix(i, COL_计价性质)) & "," & ZVal(.TextMatrix(i, COL_执行科室ID)) & "," & _
                                             Val(.TextMatrix(i, COL_执行性质)) & "," & Val(.TextMatrix(i, COL_标志)) & "," & _
                                             "To_Date('" & Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI'),NULL," & _
                                             mlng病人科室id & "," & Val(.TextMatrix(i, COL_开嘱科室ID)) & ",'" & .TextMatrix(i, COL_开嘱医生) & "'," & _
                                             "To_Date('" & Format(.Cell(flexcpData, i, COL_开嘱时间), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI')," & _
                                             "'" & mstr挂号单 & "'," & ZVal(mlng前提ID) & ",'" & .TextMatrix(i, COL_检查方法) & "'," & _
                                             Val(.TextMatrix(i, COL_执行标记)) & ",NULL,'" & .Cell(flexcpData, i, COL_医生嘱托) & "','" & UserInfo.姓名 & "'," & ZVal(.TextMatrix(i, COL_零费记帐)) & "," & _
                                             ZVal(Val(.TextMatrix(i, COL_用药目的))) & ",'" & .TextMatrix(i, COL_用药理由) & "'," & ZVal(Val(.TextMatrix(i, COL_审核状态))) & "," & ZVal(Val(.TextMatrix(i, COL_申请序号))) & ",'" & IIF(.Cell(flexcpData, i, COL_超量说明) <> "", "", .TextMatrix(i, COL_超量说明)) & _
                                             "',Null," & ZVal(Val(.TextMatrix(i, COL_配方ID))) & ",Null," & ZVal(Val(.TextMatrix(i, COL_组合项目ID))) & ",'" & .Cell(flexcpData, i, COL_皮试结果) & "'," & IIF(blnRecipeNo, Val(.TextMatrix(i, COL_处方序号)), "NULL") & ")"
                    If mbytUseType = 1 Then    '路径项目ID与医嘱ID的对应
                        mstrAdviceOfItem = mstrAdviceOfItem & "," & .TextMatrix(i, COL_路径项目ID) & ":" & .RowData(i)
                        If .Cell(flexcpData, i, COL_超量说明) <> "" And .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "4" Then
                            str路径项目IDs = str路径项目IDs & "," & .TextMatrix(i, COL_路径项目ID) & "|" & .Cell(flexcpData, i, COL_超量说明)
                        End If
                    ElseIf mbytUseType = 2 Then
                        mstrAdviceOfItem = mstrAdviceOfItem & "," & .RowData(i)
                        mdatPathOut = Format(.TextMatrix(i, COL_开始时间), "YYYY-MM-DD")
                    End If
                    
                    '收集本次新增的医嘱用于关联病人危急值记录
                    If mlng危急值ID <> 0 Then
                        If Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                            arrSQL(UBound(arrSQL)) = "Zl_病人危急值医嘱_Update(1," & mlng危急值ID & "," & .RowData(i) & ")"
                        End If
                    End If
                    
                    '输血申请单的额外数据保存
                    If .TextMatrix(i, COL_类别) = "K" Then
                        If TypeName(.Cell(flexcpData, i, COL_申请序号)) = "Recordset" Then
                            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, i, COL_申请序号))
                            If Not rsCard.EOF Then
                                rsCard.MoveFirst
                                strTmp = rsCard!申请其他项目SQL & ""
                                If strTmp <> "" Then
                                    strTmp = Replace(strTmp, "[相关ID]", .RowData(i))
                                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                    arrSQL(UBound(arrSQL)) = strTmp
                                End If
                                strTmp = rsCard!检验项目SQL & ""
                                If strTmp <> "" Then
                                    strTmp = Replace(strTmp, "[相关ID]", .RowData(i))
                                    varTmp = Split(strTmp, "<splitSQL>")
                                    For j = 0 To UBound(varTmp)
                                        If varTmp(j) <> "" Then
                                            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                            arrSQL(UBound(arrSQL)) = varTmp(j)
                                        End If
                                    Next
                                End If
                                strTmp = rsCard!临床诊断IDs & ""
                                strTmp = rsCard!诊断关联信息SQL & ""
                                If strTmp <> "" Then
                                    strTmp = Replace(strTmp, "[相关ID]", .RowData(i))
                                    varTmp = Split(strTmp, "<splitSQL>")
                                    For j = 0 To UBound(varTmp)
                                        If j = 1 Then
                                            If varTmp(j) <> "" Then
                                                ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                                arrSQL(UBound(arrSQL)) = varTmp(j)
                                            End If
                                        End If
                                    Next
                                End If
                                strTmp = rsCard!申请项目SQL & ""
                                If strTmp <> "" Then
                                    strTmp = Replace(strTmp, "[相关ID]", .RowData(i))
                                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                    arrSQL(UBound(arrSQL)) = strTmp
                                End If
                            End If
                        End If
                    End If
                End If
                                
                If mbytUseType = 0 And mlng路径状态 = 1 Then
                    If Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_状态)) = -1 Then
                        If Val(.TextMatrix(i, COL_路径项目ID)) = 0 Then
                            If Val(.TextMatrix(i, COL_婴儿)) = 0 And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                                strAdivcePathOut = strAdivcePathOut & "," & .RowData(i)
                            End If
                        Else
                            rsPathAdvice.Filter = "路径项目ID = " & .TextMatrix(i, COL_路径项目ID)
                            If rsPathAdvice.RecordCount = 0 Then
                                rsPathAdvice.AddNew
                                rsPathAdvice!路径项目ID = .TextMatrix(i, COL_路径项目ID)
                                rsPathAdvice!路径项目分类 = .TextMatrix(i, COL_路径项目分类)
                                rsPathAdvice!医嘱ids = .RowData(i)
                                rsPathAdvice!开始时间 = .TextMatrix(i, COL_开始时间)
                            Else
                                rsPathAdvice!医嘱ids = rsPathAdvice!医嘱ids & "," & .RowData(i)
                            End If
                            rsPathAdvice.Update
                        End If
                    End If
                End If
                
                If blnRis Then
                    If InStr(",F,D,", .TextMatrix(i, COL_类别)) > 0 Or InStr(",0,5,", Val(.TextMatrix(i, COL_操作类型))) > 0 And .TextMatrix(i, COL_类别) = "E" Then
                        If Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                            If Val(.TextMatrix(i, COL_EDIT)) = 2 Then
                                str本次变动 = str本次变动 & "," & .RowData(i)
                            End If
                            If InStr(",1,2,", Val(.TextMatrix(i, COL_EDIT))) > 0 And Val(.TextMatrix(i, COL_标志)) <> 1 Then
                                strNewAdvice = strNewAdvice & "," & .RowData(i) & ":" & Val(.TextMatrix(i, COL_诊疗项目ID))
                            End If
                        End If
                    End If
                End If
                
                '医生常用医嘱
                If Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_EDIT)) = 2 Then
                    With vsDiag
                        For j = 1 To .Rows - 1
                            If Trim(.TextMatrix(j, col诊断)) <> "" Then
                                If InStr("," & .TextMatrix(j, col医嘱ID) & ",", "," & IIF(Val(vsAdvice.TextMatrix(i, COL_相关ID)) = 0, Val(vsAdvice.RowData(i)), Val(vsAdvice.TextMatrix(i, COL_相关ID))) & ",") > 0 Then
                                    Exit For
                                End If
                            End If
                        Next
                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                        If j > .Rows - 1 Then
                            '没有绑定诊断
                            arrSQL(UBound(arrSQL)) = "Zl_医生常用医嘱_Update(" & UserInfo.ID & "," & mlng病人科室id & "," & Val(vsAdvice.TextMatrix(i, COL_诊疗项目ID)) & _
                                                    "," & ZVal(vsAdvice.TextMatrix(i, COL_收费细目ID)) & ",'" & vsAdvice.TextMatrix(i, COL_类别) & "','" & vsAdvice.TextMatrix(i, COL_标本部位) & "'," & _
                                                    ZVal(Val(vsAdvice.TextMatrix(i, COL_组合项目ID))) & ",NULL,NULL,NULL)"
                        Else
                            arrSQL(UBound(arrSQL)) = "Zl_医生常用医嘱_Update(" & UserInfo.ID & "," & mlng病人科室id & "," & Val(vsAdvice.TextMatrix(i, COL_诊疗项目ID)) & _
                                                    "," & ZVal(vsAdvice.TextMatrix(i, COL_收费细目ID)) & ",'" & vsAdvice.TextMatrix(i, COL_类别) & "','" & vsAdvice.TextMatrix(i, COL_标本部位) & "'," & _
                                                    ZVal(Val(vsAdvice.TextMatrix(i, COL_组合项目ID))) & ",'" & .TextMatrix(j, col诊断) & "'," & ZVal(Val(.TextMatrix(j, col疾病ID))) & "," & ZVal(Val(.TextMatrix(j, col诊断ID))) & ")"
                        End If
                    End With
                End If
                
                '标记免试的
                If .Cell(flexcpData, i, COL_免试) & "" <> "" & .TextMatrix(i, COL_免试) Then
                    If .TextMatrix(i, COL_免试) = "1" Then
                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                        arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_皮试(" & Val(.RowData(i)) & ",'免试',NULL)"
                    ElseIf .TextMatrix(i, COL_免试) = "0" Then
                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                        arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_皮试(" & Val(.RowData(i)) & ",'',NULL)"
                    End If
                End If
                '单据申请附项
                If .TextMatrix(i, COL_附项) <> "" And .Cell(flexcpData, i, COL_附项) = 1 Then
                    arrAppend = Split(.TextMatrix(i, COL_附项), "<Split1>")
                    For j = 0 To UBound(arrAppend)
                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                        arrSQL(UBound(arrSQL)) = "Zl_病人医嘱附件_Insert(" & .RowData(i) & "," & _
                                                 "'" & Split(arrAppend(j), "<Split2>")(0) & "'," & Val(Split(arrAppend(j), "<Split2>")(1)) & "," & _
                                                 j + 1 & "," & ZVal(Split(arrAppend(j), "<Split2>")(2)) & ",'" & Replace(Split(arrAppend(j), "<Split2>")(3), "'", "''") & "'" & _
                                                 IIF(j = 0, ",1", "") & ")"
                    Next
                End If

                'Pass:更新审查结果
                If Val(.Cell(flexcpData, i, COL_序号)) = 1 Then
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_更新审查(" & .RowData(i) & "," & _
                                             IIF(CStr(.Cell(flexcpData, i, COL_警示)) = "", "NULL", Val(.Cell(flexcpData, i, COL_警示))) & _
                                             IIF(.TextMatrix(i, COL_禁忌药品说明) = "", ",NULL", ",'" & .TextMatrix(i, COL_禁忌药品说明) & "'") & ")"
                End If
            End If
        Next
        If mbytUseType = 0 And mlng路径状态 = 1 Then
            If rsPath.RecordCount > 0 Then
                rsPathAdvice.Filter = ""
                For i = 1 To rsPathAdvice.RecordCount
                    lng阶段Id = rsPath!当前阶段ID
                    lng天数 = rsPath!当前天数
                    dat日期 = rsPath!日期
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = _
                        "Zl_病人门诊路径生成_Insert(0," & mlng病人ID & "," & mlng挂号ID & ",Null,0," & rsPath!路径记录id & "," & lng阶段Id & _
                        ",To_Date('" & Format(dat日期, "yyyy-MM-dd") & "','YYYY-MM-DD')," & lng天数 & _
                        ",'" & rsPathAdvice!路径项目分类 & "'," & rsPathAdvice!路径项目ID & ",'" & rsPathAdvice!医嘱ids & "',Null,Null" & _
                        ",'" & UserInfo.姓名 & "'," & strAddDate & ")"
                    rsPathAdvice.MoveNext
                Next
            End If
            If strAdivcePathOut <> "" And rsPath.RecordCount > 0 Then
                lng阶段Id = rsPath!当前阶段ID
                lng天数 = rsPath!当前天数
                dat日期 = rsPath!日期
                strAdivcePathOut = Mid(strAdivcePathOut, 2)
                ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                arrSQL(UBound(arrSQL)) = "Zl_病人门诊路径生成_Insert(0," & mlng病人ID & "," & mlng挂号ID & ",Null,0," & _
                                          rsPath!路径记录id & "," & lng阶段Id & _
                                          ",To_Date('" & Format(dat日期, "yyyy-MM-dd") & "','YYYY-MM-DD')," & lng天数 & _
                                          ",'" & str路径项目分类 & "',Null" & ",'" & strAdivcePathOut & "',Null,Null" & _
                                          ",'" & UserInfo.姓名 & "'," & strAddDate & ",'路径外项目')"
            End If
        End If
    End With
 
    '诊断部分内容(先要保存医嘱ID数据)
    If lbl诊断.Tag = "1" Then
        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
        arrSQL(UBound(arrSQL)) = "ZL_病人诊断记录_Delete(" & mlng病人ID & "," & mlng挂号ID & ",3,Null,'1,11')"
        If blnMsgOk Then Call InitRsMsg(rsMsg)
        With vsDiag
            j = 0
            For i = 1 To .Rows - 1
                If Trim(.TextMatrix(i, col诊断)) <> "" Then
                    blnDiagChange = True
                    If Val(.Cell(flexcpData, i, col诊断ID)) > 0 And Not mrsDiag Is Nothing Then
                        strFilter = "诊断类型=" & IIF(.Cell(flexcpData, i, COL中医) = 1, "11", "1") & " And 记录来源=3 And 疾病id=" & ZVal(.TextMatrix(i, col疾病ID)) & " And 诊断id=" & ZVal(.TextMatrix(i, col诊断ID))
                        strTmp = IIF(.TextMatrix(i, col编码) <> "", "(" & .TextMatrix(i, col编码) & ")", "") & .TextMatrix(i, col诊断) & IIF(.TextMatrix(i, col中医证候) <> "", "(" & .TextMatrix(i, col中医证候) & ")", "")
                        strFilter = strFilter & " And 诊断描述= '" & strTmp & "'"
                        If IsDate(.TextMatrix(i, col发病时间)) Then
                            strFilter = strFilter & " And  发病时间= '" & Format(.TextMatrix(i, col发病时间), "yyyy-MM-dd HH:mm") & "'"
                        Else
                            strFilter = strFilter & " And  发病时间= Null "
                        End If

                        strFilter = strFilter & " And  证候ID= " & ZVal(.TextMatrix(i, col证候ID))
                        
                        If .TextMatrix(i, col中医证候) <> "" And Val(.TextMatrix(i, col证候ID)) = 0 Then
                            strFilter = strFilter & " And  证候名称= '" & .TextMatrix(i, col中医证候) & "'"
                        End If
                        
                        strFilter = strFilter & " And 是否疑诊=" & Val(.Cell(flexcpData, i, col疑诊))
                        mrsDiag.Filter = strFilter
                        blnDiagChange = mrsDiag.EOF
                    End If
                    lng诊断记录ID = zlDatabase.GetNextID("病人诊断记录")
                    strTmp = .TextMatrix(i, col医嘱ID)
                    If Len(strTmp) > 4000 Then
                        strTmp = ""
                    End If
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1): j = j + 1
                    If blnDiagChange Then
                        str记录人 = UserInfo.姓名
                        arrSQL(UBound(arrSQL)) = "ZL_病人诊断记录_INSERT(" & mlng病人ID & "," & mlng挂号ID & ",3," & _
                                                 "Null," & IIF(.Cell(flexcpData, i, COL中医) = 1, "11", "1") & "," & ZVal(.TextMatrix(i, col疾病ID)) & "," & _
                                                 ZVal(.TextMatrix(i, col诊断ID)) & "," & ZVal(.TextMatrix(i, col证候ID)) & "," & _
                                                 "'" & IIF(.TextMatrix(i, col编码) <> "", "(" & .TextMatrix(i, col编码) & ")", "") & .TextMatrix(i, col诊断) & IIF(.TextMatrix(i, col中医证候) <> "", "(" & .TextMatrix(i, col中医证候) & ")", "") & "',Null,Null," & Val(.Cell(flexcpData, i, col疑诊)) & "," & _
                                                 "To_Date('" & Format(curDate, "yyyy-MM-dd HH:mm:ss") & "','YYYY-MM-DD HH24:MI:SS')," & _
                                                 IIF(strTmp = "", "null", "'" & strTmp & "'") & "," & j & ",Null,Null,To_date('" & Format(.TextMatrix(i, col发病时间), "yyyy-MM-dd HH:mm") & "','yyyy-MM-dd HH24:mi'),'" & UserInfo.姓名 & "'," & lng诊断记录ID & ")"
                        
                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                        arrSQL(UBound(arrSQL)) = "Zl_医生常用诊断_Update(" & UserInfo.ID & "," & mlng病人科室id & ",'" & .TextMatrix(i, col诊断) & "'," & ZVal(Val(.TextMatrix(i, col疾病ID))) & "," & ZVal(Val(.TextMatrix(i, col诊断ID))) & "," & IIF(.Cell(flexcpData, i, COL中医) = 1, "11", "1") & ")"
                    Else
                        str记录人 = mrsDiag!记录人
                        arrSQL(UBound(arrSQL)) = "ZL_病人诊断记录_INSERT(" & mlng病人ID & "," & mlng挂号ID & ",3," & _
                                                 "Null," & IIF(.Cell(flexcpData, i, COL中医) = 1, "11", "1") & "," & ZVal(.TextMatrix(i, col疾病ID)) & "," & _
                                                 ZVal(.TextMatrix(i, col诊断ID)) & "," & ZVal(.TextMatrix(i, col证候ID)) & "," & _
                                                 "'" & IIF(.TextMatrix(i, col编码) <> "", "(" & .TextMatrix(i, col编码) & ")", "") & .TextMatrix(i, col诊断) & IIF(.TextMatrix(i, col中医证候) <> "", "(" & .TextMatrix(i, col中医证候) & ")", "") & "',Null,Null," & Val(.Cell(flexcpData, i, col疑诊)) & "," & _
                                                 "To_Date('" & Format(CDate(mrsDiag!记录日期), "yyyy-MM-dd HH:mm:ss") & "','YYYY-MM-DD HH24:MI:SS')," & _
                                                 IIF(strTmp = "", "null", "'" & strTmp & "'") & "," & j & ",Null,Null,To_date('" & Format(.TextMatrix(i, col发病时间), "yyyy-MM-dd HH:mm") & "','yyyy-MM-dd HH24:mi'),'" & mrsDiag!记录人 & "'," & lng诊断记录ID & ")"
                    End If
                    strTmp = .TextMatrix(i, col医嘱ID)
                    If Len(strTmp) > 4000 Then Call Make诊断医嘱对应(arrSQL, strTmp, lng诊断记录ID)
                    If blnMsgOk Then
                        Call SendMsg诊断(i, j, lng诊断记录ID, str记录人, rsMsg)
                    End If
                End If
            Next
        End With
    End If
    
    If mbytUseType = 1 Or mbytUseType = 2 Then
        If mbytUseType = 1 Then
            marrSQL = arrSQL
            mstrAdviceOfItem = Mid(mstrAdviceOfItem, 2)
            mstr路径项目IDs = Mid(str路径项目IDs, 2)
        Else
            marrSQL = Array()
            mstrAdviceOfItem = Mid(mstrAdviceOfItem, 2)
            gcnOracle.BeginTrans    '不提交事务，以便返回时重新读取
            For i = 0 To UBound(arrSQL)
                zlDatabase.ExecuteProcedure CStr(arrSQL(i)), Me.Caption
            Next
        End If
        mblnNoSave = False
        Screen.MousePointer = 0
        SaveAdvice = True
        mblnOK = True
    Else
        If bln血库 Then
            bln血库 = rs输血.RecordCount > 0
            If bln血库 Then rs输血.MoveFirst
        End If
        If blnRis Then
            If str本次变动 <> "" Then
                str本次变动 = Mid(str本次变动, 2)
                Set rsTmp = GetDataRIS预约(str本次变动)
                If rsTmp.RecordCount > 0 Then
                    str本次变动 = "有数据"
                Else
                    str本次变动 = ""
                End If
            End If
        Else
            str本次变动 = ""
        End If
        '处理RIS的取消预约
        If str本次变动 <> "" Then
            On Error Resume Next
            For i = 1 To rsTmp.RecordCount
                If 0 <> gobjRis.HISSchedulingEx(Val(rsTmp!ID & ""), Val(rsTmp!预约id & "")) Then
                    MsgBox "当前启用了影像信息系统接口，本次操作删除或修改了已经预约医嘱，但由于影像信息系统接口(HISSchedulingEx)取消息预约未调用成功，请与系统管理员联系。", vbInformation, gstrSysName
                End If
                rsTmp.MoveNext
            Next
            On Error GoTo errH
        End If
        '提交数据
        gcnOracle.BeginTrans: blnTrans = True
        For i = 0 To UBound(arrSQL)
            zlDatabase.ExecuteProcedure CStr(arrSQL(i)), Me.Caption
        Next
        '处理血库的接口
        If bln血库 Then
            For i = 1 To rs输血.RecordCount
                If Val("" & rs输血!状态) <> 1 Then
                    If gobjPublicBlood.AdviceOperation(p门诊医嘱下达, Val(rs输血!医嘱ID & ""), Val(rs输血!类型 & ""), , strErr) = False Then
                        gcnOracle.RollbackTrans: blnTrans = False
                        Screen.MousePointer = 0
                        MsgBox "血库系统接口调用失败：" & strErr, vbInformation, gstrSysName
                        Exit Function
                    End If
                End If
                rs输血.MoveNext
            Next
        End If
        gcnOracle.CommitTrans: blnTrans = False
 
        If mbytUseType = 0 And mlng路径状态 = 1 And mint场合 = 0 Then
            If strAdivcePathOut <> "" And rsPath.RecordCount > 0 Then
                lng执行ID = GetPathOutItemID(Val(rsPath!路径记录id), curDate, 1)
                Call gobjPathOut.zlRefresh(mlng病人ID, mlng挂号ID, mstr挂号单, mlng病人科室id, mint就诊类型, mblnMoved, True)
                Call gobjPathOut.zlExePathAppendItem(str路径项目分类, strAdivcePathOut, lng执行ID, mdatPathOut)
            End If
        End If
    
        'Pass自动用药审查上传处方
        If mblnPass And blnNewDrug Then
            Call gobjPass.zlPassUpLoad(mobjPassMap)
        End If
    
        If blnMsgOk Then
            If Not (mrs诊断 Is Nothing) Then
                mrs诊断.Filter = "状态 = 0"
                If Not mrs诊断.EOF Then
                    For i = 1 To mrs诊断.RecordCount
                        Call ZLHIS_CIS_011(mclsMipModule, mlng病人ID, mstr姓名, 1, mlng挂号ID, mlng病人科室id, mrs诊断!ID, mrs诊断!诊断编码, mrs诊断!疾病编码)
                        mrs诊断.Delete
                        mrs诊断.MoveNext
                    Next
                End If
                mrs诊断.Filter = "状态 <> 0"
                If Not mrs诊断.EOF Then
                    For i = 1 To mrs诊断.RecordCount
                        mrs诊断!状态 = 0
                        mrs诊断.MoveNext
                    Next
                End If
                mrs诊断.Filter = 0
            End If
            If Not (rsMsg Is Nothing) Then
                rsMsg.Filter = "状态 = 1"
                If Not rsMsg.EOF Then
                    For i = 1 To rsMsg.RecordCount
                        Call ZLHIS_CIS_010(mclsMipModule, mlng病人ID, mstr姓名, 1, mlng挂号ID, mlng病人科室id, _
                            rsMsg!诊断id, rsMsg!诊断类型, rsMsg!是否疑诊, rsMsg!诊断次序, rsMsg!诊断编码, rsMsg!疾病编码, rsMsg!疾病附码, rsMsg!疾病类别, rsMsg!证候编码, rsMsg!证候名称, rsMsg!记录日期, rsMsg!记录人员)
                        rsMsg.MoveNext
                    Next
                End If
            End If
        End If

        If bln用血审核 Then Call ReadMsg
    
        Call CreatePlugInOK(p门诊医嘱下达, mint场合)
        If Not gobjPlugIn Is Nothing Then
            '调用删除后外挂接口
            On Error Resume Next
            For i = 0 To UBound(arrDelID)
                If Val(arrDelID(i)) <> 0 Then
                    If Not gobjPlugIn Is Nothing Then
                        Call gobjPlugIn.AdviceDeleted(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, Val(arrDelID(i)), mint场合)
                        Call zlPlugInErrH(err, "AdviceDeleted")
                    End If
                End If
            Next
            On Error GoTo errH
        End If
        mlngID序列 = 0
        '调用处方审查系统检查
        If InitObjRecipeAudit(p门诊医嘱下达) And mblnNoSave Then
            For i = vsAdvice.FixedRows To vsAdvice.Rows - 1
                If vsAdvice.TextMatrix(i, COL_类别) = "E" And vsAdvice.TextMatrix(i, COL_操作类型) = "2" Then
                    '当前新开状态的医嘱带需要传入
                    If Val(vsAdvice.TextMatrix(i, COL_状态)) = 1 Then
                        str给药IDs = str给药IDs & "," & vsAdvice.RowData(i)
                    End If
                End If
            Next
            If Mid(str给药IDs, 2) <> "" Then
                Call gobjRecipeAudit.AutoAudit(Me, 1, Mid(str给药IDs, 2), mlng病人科室id, 0, mlng病人ID, mlng挂号ID)
            End If
        End If
    
        '保存成功后,所有记录变成原始记录
        With vsAdvice
            For i = vsAdvice.FixedRows To vsAdvice.Rows - 1
                If .RowData(i) <> 0 Then
                    .TextMatrix(i, COL_EDIT) = 0
                    .Cell(flexcpData, i, COL_序号) = Empty    'Pass:保存后清除标志
                    .Cell(flexcpData, i, COL_附项) = 0    '附项:保存后清除标志
                End If
            Next
        End With
        
        Call LoadDiagInfo
    
        '保存后重新进入行(比如开始时间不准改了)
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    
        Screen.MousePointer = 0
        mblnNoSave = False
        lbl诊断.Tag = ""
        mstrDelIDs = ""
        mstrAduitDelIDs = ""
        mstrDel输血 = ""
        SaveAdvice = True
        mblnOK = True
        mlng危急值ID = 0
        
        '医嘱数据保存提交后，再RIS预约，只有普能病人才预约
        If blnRis And mbytPatiType = 1 Then
            If strNewAdvice <> "" Then
                strTmp = Mid(strNewAdvice, 2)
                varTmp = Split(strTmp, ",")
                On Error Resume Next
                For i = 0 To UBound(varTmp)
                    strTmp = varTmp(i)
                    Call gobjRis.HISScheduling(1, Val(Split(strTmp, ":")(0)), Val(Split(strTmp, ":")(1)))
                Next
                On Error GoTo errH
            End If
        End If
    End If
    Exit Function
errH:
    Screen.MousePointer = 0
    If blnTrans Then gcnOracle.RollbackTrans
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function MakePathAdivceRS() As ADODB.Recordset
    Set MakePathAdivceRS = New ADODB.Recordset
    MakePathAdivceRS.Fields.Append "行号", adBigInt
    MakePathAdivceRS.Fields.Append "路径项目ID", adBigInt
    MakePathAdivceRS.Fields.Append "原医嘱ID", adBigInt
    MakePathAdivceRS.Fields.Append "路径项目分类", adVarChar, 50, adFldIsNullable
    MakePathAdivceRS.Fields.Append "医嘱IDS", adLongVarWChar, 4000, adFldIsNullable
    MakePathAdivceRS.Fields.Append "开始时间", adVarChar, 20, adFldIsNullable
    MakePathAdivceRS.CursorLocation = adUseClient
    MakePathAdivceRS.LockType = adLockOptimistic
    MakePathAdivceRS.CursorType = adOpenStatic
    MakePathAdivceRS.Open
End Function
Private Function GetRs疾病编码目录(ByVal lngID As Long) As ADODB.Recordset
    Dim strSQL As String, rsTmp As ADODB.Recordset
    On Error GoTo errH
    strSQL = "select 编码,附码,类别 from 疾病编码目录 where id=[1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lngID)
    Set GetRs疾病编码目录 = rsTmp
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function LoadAdvice() As Boolean
''功能：读取当前病人的医嘱记录
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, bln配方 As Boolean
    Dim i As Long, j As Long, lng相关ID As Long
    Dim strTable As String
    Dim blnHaveData As Boolean

    Screen.MousePointer = 11

    On Error GoTo errH

    '下医嘱缺省的天数
    If msng天数 = 0 Then msng天数 = 1
    If mbytUseType = 2 Then '临床路径添加路径外项目的医嘱(病人医嘱记录数据还未提交)
        strTable = "(Select * From 病人医嘱记录  Where ID IN(Select /*+cardinality(A,10)*/ Column_Value From Table(f_Num2list([3])) A))"
    Else
        strTable = "病人医嘱记录"
    '临床和医技不互相编辑
    strSQL = " And Nvl(A.前提ID,0) in (Select /*+cardinality(x,10)*/ x.Column_Value From Table(Cast(f_Num2list([3]) As zlTools.t_Numlist)) X)"
    End If
    
   If mbytUseType = 0 And mlng路径状态 <> 0 Then
        strSQL = _
            "Select a.*, g.项目id As 路径项目id, k.执行方式 As 路径执行方式" & vbNewLine & _
            "From (Select A.ID,A.相关ID,Nvl(A.婴儿,0) as 婴儿,A.序号,A.医嘱期效,A.医嘱状态,A.诊疗类别,A.诊疗项目ID,B.名称,A.标本部位,A.检查方法," & _
            " A.执行标记,A.收费细目ID,A.开始执行时间,A.医嘱内容,A.医生嘱托,A.单次用量,A.天数,A.总给予量,B.计算单位,A.执行频次," & _
            " A.频率次数,A.频率间隔,A.间隔单位,B.计算方式,B.执行频率,B.操作类型,B.执行分类,A.计价特性,A.执行时间方案,A.执行性质," & _
            " A.执行科室ID,A.开嘱科室ID,A.开嘱医生,A.开嘱时间,A.紧急标志,C.处方限量,C.处方职务,C.毒理分类,C.抗生素,C.药品剂型," & _
            " D.剂量系数,D.门诊包装,D.门诊单位,F.计算单位 as 散装单位,E.跟踪在用,E.是否分零 as 卫材分零,D.门诊可否分零 As 可否分零,A.审查结果," & _
            " Decode(A.新开签名ID,NULL,0,1) as 签名否,A.摘要,A.零费记帐,A.用药目的,A.用药理由,A.审核状态,A.皮试结果,A.超量说明," & _
            " a.配方ID,c.临床自管药,d.高危药品,a.组合项目ID,b.撤档时间,C.溶媒,a.申请序号,'' as 处方审查状态,'' as 处方审查结果,禁忌药品说明,d.基本药物," & _
            " H.路径执行id, A.处方序号,-null as 危急值ID, Row_Number() Over(Partition By a.Id Order By h.路径执行id) As Top,d.是否易至跌倒 " & _
            " From " & strTable & " A,诊疗项目目录 B,药品特性 C,药品规格 D,材料特性 E,收费项目目录 F, 病人门诊路径医嘱 H" & _
            " Where Nvl(A.医嘱期效,0)=1 And A.诊疗项目ID=B.ID And A.诊疗项目ID=C.药名ID(+) And a.Id = h.病人医嘱id(+)" & _
            " And A.收费细目ID=D.药品ID(+) And A.收费细目ID=E.材料ID(+) And E.材料ID=F.ID(+) And A.医嘱状态 IN(1,8)" & strSQL & _
            " And A.病人ID+0=[1] And A.挂号单=[2] And A.开始执行时间 is Not NULL And A.病人来源<>3 And Nvl(A.执行标记,0)<>-1" & ") A, 病人门诊路径执行 G, 门诊路径项目 K" & vbNewLine & _
            " Where a.Top = 1 And a.路径执行id = g.Id(+) And g.项目id = k.Id(+)" & vbNewLine & _
            " Order By 婴儿, 序号"
    Else
        '读取"1-新开,8-已停止(已发送)"的医嘱
        strSQL = _
            " Select A.ID,A.相关ID,Nvl(A.婴儿,0) as 婴儿,A.序号,A.医嘱期效,A.医嘱状态,A.诊疗类别,A.诊疗项目ID,B.名称,A.标本部位,A.检查方法," & _
            " A.执行标记,A.收费细目ID,A.开始执行时间,A.医嘱内容,A.医生嘱托,A.单次用量,A.天数,A.总给予量,B.计算单位,A.执行频次," & _
            " A.频率次数,A.频率间隔,A.间隔单位,B.计算方式,B.执行频率,B.操作类型,B.执行分类,A.计价特性,A.执行时间方案,A.执行性质," & _
            " A.执行科室ID,A.开嘱科室ID,A.开嘱医生,A.开嘱时间,A.紧急标志,C.处方限量,C.处方职务,C.毒理分类,C.抗生素,C.药品剂型," & _
            " D.剂量系数,D.门诊包装,D.门诊单位,F.计算单位 as 散装单位,E.跟踪在用,E.是否分零 as 卫材分零,D.门诊可否分零 As 可否分零,A.审查结果," & _
            " Decode(A.新开签名ID,NULL,0,1) as 签名否,A.摘要,A.零费记帐,A.用药目的,A.用药理由,A.审核状态,A.皮试结果,A.超量说明," & _
            " a.配方ID,c.临床自管药,d.高危药品,a.组合项目ID,b.撤档时间,C.溶媒,a.申请序号,J.状态 as 处方审查状态,J.审查结果 as 处方审查结果,a.禁忌药品说明,d.基本药物," & _
            " 0 as 路径项目ID,0 as 路径执行方式,0 as 路径执行ID, A.处方序号,nvl(Max(g.危急值id),Max(h.危急值id)) As 危急值ID,d.是否易至跌倒  " & _
            " From " & strTable & " A,诊疗项目目录 B,药品特性 C,药品规格 D,材料特性 E,收费项目目录 F, 处方审查明细 I, 处方审查记录 J, 病人危急值医嘱 G,病人危急值医嘱 H" & _
            " Where Nvl(A.医嘱期效,0)=1 And A.诊疗项目ID=B.ID And A.诊疗项目ID=C.药名ID(+) And a.ID = i.医嘱ID(+) And a.ID = h.医嘱ID(+) and a.相关ID=g.医嘱ID(+) And I.审方ID = J.ID(+) and (I.最后提交 =1 Or I.审方ID is NULL)" & _
            " And A.收费细目ID=D.药品ID(+) And A.收费细目ID=E.材料ID(+) And E.材料ID=F.ID(+) And A.医嘱状态 IN(1,8)" & strSQL & _
            " And A.病人ID+0=[1] And A.挂号单=[2] And A.开始执行时间 is Not NULL And A.病人来源<>3"
        strSQL = strSQL & " " & _
            "Group By a.Id, a.相关id, a.婴儿, a.序号, a.医嘱期效, a.医嘱状态, a.诊疗类别, a.诊疗项目id, b.名称, a.标本部位, a.检查方法, a.执行标记, a.收费细目id, a.开始执行时间," & vbNewLine & _
            "         a.医嘱内容, a.医生嘱托, a.单次用量, a.天数, a.总给予量, b.计算单位, a.执行频次, a.频率次数, a.频率间隔, a.间隔单位, b.计算方式, b.执行频率, b.操作类型, b.执行分类," & vbNewLine & _
            "         a.计价特性, a.执行时间方案, a.执行性质, a.执行科室id, a.开嘱科室id, a.开嘱医生, a.开嘱时间, a.紧急标志, c.处方限量, c.处方职务, c.毒理分类, c.抗生素, c.药品剂型," & vbNewLine & _
            "         d.剂量系数, d.门诊包装, d.门诊单位, f.计算单位, e.跟踪在用, d.门诊可否分零, a.审查结果, a.新开签名id, a.摘要, a.零费记帐, a.用药目的, a.用药理由, a.审核状态," & vbNewLine & _
            "         a.皮试结果, a.超量说明, a.配方id, c.临床自管药, d.高危药品, a.组合项目id, b.撤档时间, c.溶媒, a.申请序号, j.状态, j.审查结果, a.禁忌药品说明, d.基本药物, a.处方序号,E.是否分零,d.是否易至跌倒" & vbNewLine & _
            "Order By 婴儿, 序号"

    End If
    If mbytUseType = 2 Then
        If mstrAdivceOfPath <> "" Then
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mstr挂号单, mstrAdivceOfPath)
            blnHaveData = Not rsTmp.EOF
        Else
            blnHaveData = False
        End If
    Else
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mstr挂号单, IIF(mstr前提IDs = "", "0", mstr前提IDs))
        blnHaveData = Not rsTmp.EOF
    End If
    On Error GoTo 0

    If blnHaveData Then
        mblnRowChange = False
        With vsAdvice
            .Redraw = flexRDNone
            .Rows = .FixedRows + rsTmp.RecordCount
            For i = 1 To rsTmp.RecordCount
                bln配方 = False

                .RowData(i) = CLng(rsTmp!ID)
                .TextMatrix(i, COL_EDIT) = IIF(mbytUseType = 2, 1, 0)      '本为原始记录,审核时表示更改了。添加路径外项目，再次进入时，因为保存之前会回退事务，所以当成新的来产生。
                .TextMatrix(i, COL_相关ID) = NVL(rsTmp!相关ID)
                .TextMatrix(i, COL_婴儿) = NVL(rsTmp!婴儿, 0)
                .TextMatrix(i, COL_序号) = rsTmp!序号
                .TextMatrix(i, COL_状态) = NVL(rsTmp!医嘱状态, 0)

                .TextMatrix(i, COL_类别) = rsTmp!诊疗类别
                .TextMatrix(i, COL_诊疗项目ID) = rsTmp!诊疗项目ID
                .TextMatrix(i, COL_名称) = rsTmp!名称
                .TextMatrix(i, COL_标本部位) = NVL(rsTmp!标本部位)
                .TextMatrix(i, COL_检查方法) = NVL(rsTmp!检查方法)
                .TextMatrix(i, COL_执行标记) = NVL(rsTmp!执行标记, 0)
                .TextMatrix(i, COL_收费细目ID) = NVL(rsTmp!收费细目ID)
                .TextMatrix(i, col_医嘱内容) = NVL(rsTmp!医嘱内容)
                .TextMatrix(i, COL_医生嘱托) = NVL(rsTmp!医生嘱托)
                .Cell(flexcpData, i, COL_医生嘱托) = CStr(NVL(rsTmp!摘要))

                .TextMatrix(i, COL_计价性质) = NVL(rsTmp!计价特性, 0)
                .TextMatrix(i, COL_计算方式) = NVL(rsTmp!计算方式, 0)
                .TextMatrix(i, COL_频率性质) = NVL(rsTmp!执行频率, 0)
                .TextMatrix(i, COL_操作类型) = NVL(rsTmp!操作类型)
                .TextMatrix(i, COL_执行分类) = NVL(rsTmp!执行分类, 0)
                .TextMatrix(i, COL_毒理分类) = NVL(rsTmp!毒理分类)
                .TextMatrix(i, COL_抗菌等级) = Val("" & rsTmp!抗生素)
                .TextMatrix(i, COL_药品剂型) = NVL(rsTmp!药品剂型)
                .TextMatrix(i, COL_处方限量) = NVL(rsTmp!处方限量)
                .TextMatrix(i, COL_处方职务) = NVL(rsTmp!处方职务)
                If gblnKSSStrict Or gbln输血分级管理 Or gbln血库系统 Then
                    .TextMatrix(i, COL_审核状态) = Val("" & rsTmp!审核状态)
                End If
                .TextMatrix(i, COL_用药目的) = "" & rsTmp!用药目的
                .TextMatrix(i, COL_用药理由) = "" & rsTmp!用药理由
                .TextMatrix(i, COL_配方ID) = NVL(rsTmp!配方ID)
                .TextMatrix(i, COL_临床自管药) = rsTmp!临床自管药 & ""
                .TextMatrix(i, COL_高危药品) = NVL(rsTmp!高危药品, 0)
                .TextMatrix(i, COL_易跌倒) = NVL(rsTmp!是否易至跌倒, 0)
                .TextMatrix(i, COL_组合项目ID) = "" & rsTmp!组合项目ID
                If Format(NVL(rsTmp!撤档时间, "3000/1/1"), "yyyy-MM-dd") <> "3000-01-01" Then
                    .TextMatrix(i, COL_是否停用) = 1
                End If
                If InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 Then
                    .TextMatrix(i, COL_剂量系数) = NVL(rsTmp!剂量系数)
                    .TextMatrix(i, COL_门诊包装) = NVL(rsTmp!门诊包装)
                    .TextMatrix(i, COL_门诊单位) = NVL(rsTmp!门诊单位)
                    If Not IsNull(rsTmp!剂量系数) Then
                        .TextMatrix(i, COL_可否分零) = NVL(rsTmp!可否分零, 0)
                    End If
                ElseIf .TextMatrix(i, COL_类别) = "4" Then
                    .TextMatrix(i, COL_剂量系数) = 1
                    .TextMatrix(i, COL_门诊包装) = 1
                    .TextMatrix(i, COL_门诊单位) = NVL(rsTmp!散装单位)
                    .TextMatrix(i, COL_跟踪在用) = NVL(rsTmp!跟踪在用, 0)
                    .Cell(flexcpData, i, COL_可否分零) = NVL(rsTmp!卫材分零, 0)
                End If

                .TextMatrix(i, COL_开始时间) = Format(rsTmp!开始执行时间, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, i, COL_开始时间) = Format(rsTmp!开始执行时间, "yyyy-MM-dd HH:mm")

                .TextMatrix(i, COL_频率) = NVL(rsTmp!执行频次)
                .TextMatrix(i, COL_频率次数) = NVL(rsTmp!频率次数)
                .TextMatrix(i, COL_频率间隔) = NVL(rsTmp!频率间隔)
                .TextMatrix(i, COL_间隔单位) = NVL(rsTmp!间隔单位)
                .TextMatrix(i, COL_执行时间) = NVL(rsTmp!执行时间方案)

                .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID)
                .TextMatrix(i, COL_执行性质) = NVL(rsTmp!执行性质, 0)
                .TextMatrix(i, COL_免试) = IIF(NVL(rsTmp!皮试结果, "") = "免试", "1", "0")
                .Cell(flexcpData, i, COL_免试) = .TextMatrix(i, COL_免试)
                .TextMatrix(i, COL_皮试结果) = rsTmp!皮试结果 & ""
                .Cell(flexcpData, i, COL_皮试结果) = .TextMatrix(i, COL_皮试结果)
                If Not (.TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "1") Then
                    .TextMatrix(i, COL_皮试结果) = "" '对于非皮试医嘱不显示皮试结果到界上
                End If
                .TextMatrix(i, COL_是否溶媒) = Val(rsTmp!溶媒 & "")
                .TextMatrix(i, COL_申请序号) = rsTmp!申请序号 & ""
                .TextMatrix(i, COL_处方审查状态) = rsTmp!处方审查状态 & ""
                .TextMatrix(i, COL_处方审查结果) = rsTmp!处方审查结果 & ""
                .TextMatrix(i, COL_禁忌药品说明) = rsTmp!禁忌药品说明 & ""
                .TextMatrix(i, COL_基本药物) = rsTmp!基本药物 & ""
                
                .TextMatrix(i, COL_路径项目ID) = Val("" & rsTmp!路径项目ID)
                .TextMatrix(i, COL_路径执行方式) = Val("" & rsTmp!路径执行方式)
                .TextMatrix(i, COL_路径执行ID) = Val("" & rsTmp!路径执行id)
                .TextMatrix(i, COL_处方序号) = Val("" & rsTmp!处方序号)
                .TextMatrix(i, COL_危急值ID) = Val("" & rsTmp!危急值ID)
                
                If mbytUseType = 0 And mlng路径状态 <> 0 Then
                    If Val("" & rsTmp!路径执行id) <> 0 And Val("" & rsTmp!路径项目ID) = 0 And Val("" & rsTmp!婴儿) = 0 Then
                        .Cell(flexcpBackColor, i, 0, i, .Cols - 1) = BackColorNew         '路径外项目，浅黄色
                    End If
                End If
                If rsTmp!诊疗类别 = "E" Then
                    If NVL(rsTmp!相关ID, 0) = 0 And Val(.TextMatrix(i - 1, COL_相关ID)) = rsTmp!ID Then
                        If InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                            '当前记录是成药的给药途径,可能是一并给药的
                            For j = i - 1 To .FixedRows Step -1
                                If Val(.TextMatrix(j, COL_相关ID)) = rsTmp!ID Then
                                    '显示给药途径
                                    .TextMatrix(j, COL_用法) = rsTmp!名称 & rsTmp!医生嘱托
                                Else
                                    Exit For
                                End If
                            Next
                            Call SetTag一并给药(i - 1)
                        ElseIf InStr(",E,7,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                            '当前记录是中药配方的用法,即配方显示行
                            .TextMatrix(i, COL_用法) = rsTmp!名称
                            .TextMatrix(i, COL_中药形态) = Val("" & rsTmp!检查方法)    '中药用法行的检查方法字段存储了中药形态
                            bln配方 = True
                        ElseIf .TextMatrix(i - 1, COL_类别) = "C" Then
                            .TextMatrix(i, COL_用法) = rsTmp!名称
                        End If
                    ElseIf Not IsNull(rsTmp!相关ID) And .TextMatrix(i - 1, COL_类别) = "K" And NVL(rsTmp!相关ID, 0) = .RowData(i - 1) Then
                        '当前记录是输血途径行
                        .TextMatrix(i - 1, COL_用法) = rsTmp!名称 & rsTmp!医生嘱托
                    ElseIf Not IsNull(rsTmp!相关ID) Then
                        '当前记录是中药配方煎法行
                        bln配方 = True
                    End If
                ElseIf rsTmp!诊疗类别 = "7" Then
                    bln配方 = True
                End If

                '单量
                .TextMatrix(i, COL_单量) = FormatEx(NVL(rsTmp!单次用量), 5)
                If .TextMatrix(i, COL_类别) = "4" Then
                    .TextMatrix(i, COL_单量单位) = NVL(rsTmp!散装单位)
                ElseIf InStr(",5,6,7,", rsTmp!诊疗类别) > 0 _
                       Or (Val(.TextMatrix(i, COL_频率性质)) = 0 And InStr(",1,2,", NVL(rsTmp!计算方式, 0)) > 0) Then
                    .TextMatrix(i, COL_单量单位) = NVL(rsTmp!计算单位)
                End If

                '天数
                .TextMatrix(i, COL_天数) = NVL(rsTmp!天数)
                '取最近新开医嘱的开数作为缺省天数
                If InStr(",1,2,", NVL(rsTmp!医嘱状态, 0)) > 0 _
                   And InStr(",5,6,", rsTmp!诊疗类别) > 0 And NVL(rsTmp!天数, 0) <> 0 Then
                    msng天数 = NVL(rsTmp!天数, 1)
                End If

                '总量
                If InStr(",5,6,", rsTmp!诊疗类别) > 0 Then
                    '成药临嘱有总量,以零售单位存放,门诊单位显示
                    If Not IsNull(rsTmp!总给予量) And Not IsNull(rsTmp!门诊包装) Then
                        .TextMatrix(i, COL_总量) = FormatEx(rsTmp!总给予量 / rsTmp!门诊包装, 5)
                    End If
                    .TextMatrix(i, COL_总量单位) = NVL(rsTmp!门诊单位)

                    Call Set用药天数是否超期(i)

                ElseIf bln配方 Then
                    If Not IsNull(rsTmp!总给予量) Then .TextMatrix(i, COL_总量) = rsTmp!总给予量
                    .TextMatrix(i, COL_总量单位) = "付"    '中药配方总量单位为"付"
                    Call Set用药天数是否超期(i)
                Else
                    '其它情况有中药和其它临嘱
                    If Not IsNull(rsTmp!总给予量) Then .TextMatrix(i, COL_总量) = FormatEx(rsTmp!总给予量, 5)

                    If .TextMatrix(i, COL_类别) = "4" Then
                        .TextMatrix(i, COL_总量单位) = NVL(rsTmp!散装单位)
                    Else
                        .TextMatrix(i, COL_总量单位) = NVL(rsTmp!计算单位)
                    End If
                End If

                .TextMatrix(i, COL_超量说明) = rsTmp!超量说明 & ""

                .TextMatrix(i, COL_开嘱科室ID) = rsTmp!开嘱科室id
                .TextMatrix(i, COL_开嘱医生) = rsTmp!开嘱医生

                .TextMatrix(i, COL_开嘱时间) = Format(rsTmp!开嘱时间, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, i, COL_开嘱时间) = Format(rsTmp!开嘱时间, "yyyy-MM-dd HH:mm")

                .TextMatrix(i, COL_零费记帐) = Val("" & rsTmp!零费记帐)

                '显示紧急标志:一并给药只显示在第一行
                .TextMatrix(i, COL_标志) = NVL(rsTmp!紧急标志, 0)
                .TextMatrix(i, COL_签名否) = NVL(rsTmp!签名否)
                
                Call SetRow标志图标(i, 1)


                '根据医嘱状态,药品毒理设置颜色
                '-------------------------------------------------------------------
                .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = .ForeColor
                If rsTmp!医嘱状态 = 8 Then
                    '已停止(已发送)
                    .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &HC00000    '深蓝
                End If

                '毒麻精药品标识:中药配方及组成味中药不处理
                If InStr(",5,6,", rsTmp!诊疗类别) > 0 And Not IsNull(rsTmp!毒理分类) Then
                    If InStr(",麻醉药,毒性药,精神药,精神I类,精神II类,", rsTmp!毒理分类) > 0 Then
                        .Cell(flexcpFontBold, i, col_医嘱内容) = True
                    End If
                End If

                'Pass根据审查结果显示警示灯
                If mblnPass Then
                    If Not IsNull(rsTmp!审查结果) Then
                        Call gobjPass.zlPassSetWarnLight(mobjPassMap, i, rsTmp!审查结果)
                    End If
                End If
                Call Set医嘱超量(i, i)
                rsTmp.MoveNext
            Next

            '固定列图标对齐:设置为中对齐,不然擦边框时可能有问题
            .Cell(flexcpPictureAlignment, .FixedRows, 0, .Rows - 1, .FixedCols - 1) = 4
            '电子签名图标对齐
            .Cell(flexcpPictureAlignment, .FixedRows, col_医嘱内容, .Rows - 1, col_医嘱内容) = 0

            Call .AutoSize(col_医嘱内容)
            .Redraw = flexRDDirect
        End With
        mblnRowChange = True
    Else
        mblnRowChange = False
        vsAdvice.Rows = vsAdvice.FixedRows
        vsAdvice.Rows = vsAdvice.FixedRows + 1
        mblnRowChange = True
    End If
    Screen.MousePointer = 0
    LoadAdvice = True
    Exit Function
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub SetTag一并给药(ByVal lngRow As Long)
'功能：对于药品医嘱添加标志
'参数：lngRow  一组药医嘱中的任意一行药品行行号
    Dim lngBg As Long, lngEd As Long
    Dim i As Long
     
    Call GetRowScope(lngRow, lngBg, lngEd)
    lngEd = lngEd - 1
    With vsAdvice
        If lngBg = lngEd Then
            .TextMatrix(lngBg, COL_并) = ""
        Else
            For i = lngBg To lngEd
                If i = lngBg Then
                    .TextMatrix(i, COL_并) = "┏"
                ElseIf i = lngEd Then
                    .TextMatrix(i, COL_并) = "┗"
                Else
                    .TextMatrix(i, COL_并) = "┃"
                End If
            Next
        End If
    End With
End Sub

Private Function Check开始时间(ByVal strStart As String, Optional ByVal blnMsg As Boolean = True, Optional strMsg As String) As Boolean
'功能：检查输入的开始时间是否合法
'说明：
'1.开始时间不能小于病人的挂号时间
'2.正常录入时,开始时间不能小于当前时间之前30分钟(从而可能造成开嘱时间大于开始时间30分钟)
    If Not IsDate(strStart) Then
        MsgBox "输入的医嘱开始执行时间无效。", vbInformation, gstrSysName
        Exit Function
    End If
        
    If Format(strStart, "yyyy-MM-dd HH:mm") < Format(mdat挂号时间, "yyyy-MM-dd HH:mm") And mbytPatiType <> 2 Then
        strMsg = "医嘱的开始执行时间不能小于病人的挂号时间 " & Format(mdat挂号时间, "yyyy-MM-dd HH:mm") & " 。"
        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
        Exit Function
    End If
    
    Check开始时间 = True
End Function

Private Function Check安排时间(ByVal strDate As String, ByVal strStart As String, ByVal strType As String, Optional ByVal blnMsg As Boolean = True, Optional strMsg As String) As Boolean
'功能：检查输入的手术/输血时间是否合法
'说明：
'1.手术/输血时间不能小于医嘱的开始时间
    Dim strInDate As String, strDateType As String
    
    If strType = "F" Then
        strDateType = "手术"
    ElseIf strType = "K" Then
        strDateType = "输血"
    End If
    
    If Not IsDate(strDate) Then
        strMsg = "输入的" & strDateType & "时间无效。"
        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
        Exit Function
    ElseIf IsDate(strStart) Then
        If Format(strDate, "yyyy-MM-dd HH:mm") < Format(strStart, "yyyy-MM-dd HH:mm") Then
            strMsg = strDateType & "时间不能小于医嘱开始时间。"
            If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    Check安排时间 = True
End Function

Private Function Check开嘱时间(ByVal strDate As String, ByVal strStart As String, _
    Optional ByVal blnMsg As Boolean = True, Optional strMsg As String) As Boolean
'功能：检查开嘱时间是否有效
'说明：不应小于病人挂号时间
    If Not IsDate(strDate) Then
        strMsg = "输入的开嘱时间无效。"
        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
        Exit Function
    End If
        
'    If Format(strDate, "yyyy-MM-dd HH:mm") < Format(mdat挂号时间, "yyyy-MM-dd HH:mm") Then
'        strMsg = "开嘱时间不能小于病人的挂号时间 " & Format(mdat挂号时间, "yyyy-MM-dd HH:mm") & " 。"
'        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
'        Exit Function
'    End If
    Check开嘱时间 = True
End Function

Private Function Check配伍禁忌(ByVal str药品IDs As String) As Boolean
'功能：检查西成药,中成药的配伍禁忌;中药配方不在这里检查
'参数：str药品IDs="1,2,3,..."
    Dim rsTmp As New ADODB.Recordset
    Dim rsMain As New ADODB.Recordset
    Dim strSQL As String, i As Long, j As Long, k As Long
    Dim arr慎用 As Variant, arr禁用 As Variant
    Dim arrItems As Variant, strMsg As String, strTmp As String
    Dim lng项目id As Long, str名称 As String, bln未编辑 As Boolean
    Dim lng组编号 As Long, lngRow As Long, lngSeekRow As Long
    
    On Error GoTo errH
        
    arr慎用 = Array(): arr禁用 = Array()
        
    strSQL = "Select /*+ rule*/ 组编号 From 诊疗互斥项目" & _
        " Where 项目ID IN(Select Column_Value From Table(f_Num2list([1]))) Group by 组编号 Having Count(*)>1"
    Set rsMain = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str药品IDs)
    For k = 1 To rsMain.RecordCount
        strSQL = "Select /*+ RULE */ A.组编号,A.类型,A.项目ID,B.名称" & _
            " From 诊疗互斥项目 A,诊疗项目目录 B" & _
            " Where A.项目ID=B.ID And A.组编号=[2]" & _
            " And A.项目ID IN(Select Column_Value From Table(f_Num2list([1])))" & _
            " Order by A.组编号,B.编码"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str药品IDs, Val(rsMain!组编号))
        For i = 1 To rsTmp.RecordCount
            If rsTmp!组编号 <> lng组编号 Then
                If rsTmp!类型 = 1 Then
                    ReDim Preserve arr慎用(UBound(arr慎用) + 1)
                Else
                    ReDim Preserve arr禁用(UBound(arr禁用) + 1)
                End If
                lng组编号 = rsTmp!组编号
            End If
            If rsTmp!类型 = 1 Then
                arr慎用(UBound(arr慎用)) = arr慎用(UBound(arr慎用)) & Chr(234) & rsTmp!项目ID & Chr(8) & rsTmp!名称
            Else
                arr禁用(UBound(arr禁用)) = arr禁用(UBound(arr禁用)) & Chr(234) & rsTmp!项目ID & Chr(8) & rsTmp!名称
            End If
            rsTmp.MoveNext
        Next
        rsMain.MoveNext
    Next
    
    '先检查禁用部份(禁止继续)
    If UBound(arr禁用) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr禁用) '每组
            strTmp = "": bln未编辑 = True
            arrItems = Split(Mid(arr禁用(i), 2), Chr(234))
            For j = 0 To UBound(arrItems) '每项目
                lng项目id = Split(arrItems(j), Chr(8))(0)
                str名称 = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & "，" & str名称
                
                '为了定位,在医嘱中查找本次新增或修改的该项目(可能有多个)所在行
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lng项目id), lngRow + 1, COL_诊疗项目ID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '编辑过的最小行优先定位
                        bln未编辑 = False: Exit Do
                    End If
                Loop
            Next
            If Not bln未编辑 Then '如果一组中的项目在本次都未编辑过,则不管
                strMsg = strMsg & vbCrLf & "● " & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            MsgBox "在病人医嘱中发现以下药品互相禁用：" & strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    '再检查慎用部份(提醒是否继续)
    If UBound(arr慎用) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr慎用) '每组
            strTmp = "": bln未编辑 = True
            arrItems = Split(Mid(arr慎用(i), 2), Chr(234))
            For j = 0 To UBound(arrItems) '每项目
                lng项目id = Split(arrItems(j), Chr(8))(0)
                str名称 = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & "，" & str名称
                
                '为了定位,在医嘱中查找本次新增或修改的该项目(可能有多个)所在行
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lng项目id), lngRow + 1, COL_诊疗项目ID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '编辑过的最小行优先定位
                        bln未编辑 = False: Exit Do
                    End If
                Loop
            Next
            If Not bln未编辑 Then '如果一组中的项目在本次都未编辑过,则不管
                strMsg = strMsg & vbCrLf & "● " & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            If MsgBox("在病人医嘱中发现以下药品互相慎用：" & strMsg & vbCrLf & vbCrLf & "要继续吗？", _
                vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                Exit Function
            End If
        End If
    End If
    
    Check配伍禁忌 = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function Check诊疗互斥(ByVal str诊疗IDs As String) As Boolean
'功能：检查非药品(成药,中药)的互斥
'参数：str诊疗IDs="1,2,3,..."
    Dim rsTmp As New ADODB.Recordset
    Dim rsMain As New ADODB.Recordset
    Dim strSQL As String, i As Long, j As Long, k As Long
    Dim arr提醒 As Variant, arr禁止 As Variant, arr停止 As Variant
    Dim arrItems As Variant, strMsg As String, strTmp As String
    Dim lng项目id As Long, str名称 As String, bln未编辑 As Boolean
    Dim lng组编号 As Long, lngRow As Long, lngSeekRow As Long
    
    On Error GoTo errH
        
    arr提醒 = Array(): arr禁止 = Array(): arr停止 = Array()
    
    strSQL = "Select /*+ rule*/ 组编号 From 诊疗互斥项目" & _
        " Where 项目ID IN(Select Column_Value From Table(f_Num2list([1]))) Group by 组编号 Having Count(*)>1"
    Set rsMain = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str诊疗IDs)
    For k = 1 To rsMain.RecordCount
        strSQL = "Select /*+ RULE */ A.组编号,A.组名称,A.类型,A.项目ID,B.名称" & _
            " From 诊疗互斥项目 A,诊疗项目目录 B" & _
            " Where A.项目ID=B.ID And A.组编号=[2]" & _
            " And A.项目ID IN(Select Column_Value From Table(f_Num2list([1])))" & _
            " Order by A.组编号,B.编码"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str诊疗IDs, Val(rsMain!组编号))
        For i = 1 To rsTmp.RecordCount
            If rsTmp!组编号 <> lng组编号 Then
                If rsTmp!类型 = 1 Then
                    ReDim Preserve arr提醒(UBound(arr提醒) + 1)
                    arr提醒(UBound(arr提醒)) = rsTmp!组名称
                ElseIf rsTmp!类型 = 2 Then
                    ReDim Preserve arr禁止(UBound(arr禁止) + 1)
                    arr禁止(UBound(arr禁止)) = rsTmp!组名称
                Else
                    ReDim Preserve arr停止(UBound(arr停止) + 1)
                    arr停止(UBound(arr停止)) = rsTmp!组名称
                End If
                lng组编号 = rsTmp!组编号
            End If
            If rsTmp!类型 = 1 Then
                arr提醒(UBound(arr提醒)) = arr提醒(UBound(arr提醒)) & Chr(234) & rsTmp!项目ID & Chr(8) & rsTmp!名称
            ElseIf rsTmp!类型 = 2 Then
                arr禁止(UBound(arr禁止)) = arr禁止(UBound(arr禁止)) & Chr(234) & rsTmp!项目ID & Chr(8) & rsTmp!名称
            Else
                arr停止(UBound(arr停止)) = arr停止(UBound(arr停止)) & Chr(234) & rsTmp!项目ID & Chr(8) & rsTmp!名称
            End If
            rsTmp.MoveNext
        Next
        rsMain.MoveNext
    Next
    '先检查禁止继续部份
    If UBound(arr禁止) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr禁止) '每组
            strTmp = "": bln未编辑 = True
            arrItems = Split(arr禁止(i), Chr(234))
            For j = 1 To UBound(arrItems) '每项目
                lng项目id = Split(arrItems(j), Chr(8))(0)
                str名称 = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & vbCrLf & vbTab & str名称
                
                '为了定位,在医嘱中查找本次新增或修改的该项目(可能有多个)所在行
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lng项目id), lngRow + 1, COL_诊疗项目ID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) = 1 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '编辑过的最小行优先定位
                        bln未编辑 = False: Exit Do
                    End If
                Loop
            Next
            If Not bln未编辑 Then '如果一组中的项目在本次都未编辑过,则不管
                strMsg = strMsg & vbCrLf & vbCrLf & arrItems(0) & "：" & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            MsgBox "在病人医嘱中发现以下内容互相排斥：" & strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    '再检查自动停止部份,门诊处理为禁止(临嘱)
    If UBound(arr停止) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr停止) '每组
            strTmp = "": bln未编辑 = True
            arrItems = Split(arr停止(i), Chr(234))
            For j = 1 To UBound(arrItems) '每项目
                lng项目id = Split(arrItems(j), Chr(8))(0)
                str名称 = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & vbCrLf & vbTab & str名称
                
                '为了定位,在医嘱中查找本次新增或修改的该项目(可能有多个)所在行
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lng项目id), lngRow + 1, COL_诊疗项目ID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '编辑过的最小行优先定位
                        bln未编辑 = False ': Exit Do
                    End If
                Loop
            Next
            If Not bln未编辑 Then '如果一组中的项目在本次都未编辑过,则不管
                strMsg = strMsg & vbCrLf & vbCrLf & arrItems(0) & "：" & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            MsgBox "在病人医嘱中发现以下内容互相排斥：" & strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    '再检查提醒是否继续部份
    If UBound(arr提醒) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr提醒) '每组
            strTmp = "": bln未编辑 = True
            arrItems = Split(arr提醒(i), Chr(234))
            For j = 1 To UBound(arrItems) '每项目
                lng项目id = Split(arrItems(j), Chr(8))(0)
                str名称 = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & vbCrLf & vbTab & str名称
                
                '为了定位,在医嘱中查找本次新增或修改的该项目(可能有多个)所在行
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lng项目id), lngRow + 1, COL_诊疗项目ID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '编辑过的最小行优先定位
                        bln未编辑 = False: Exit Do
                    End If
                Loop
            Next
            If Not bln未编辑 Then '如果一组中的项目在本次都未编辑过,则不管
                strMsg = strMsg & vbCrLf & vbCrLf & arrItems(0) & "：" & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            If MsgBox("在病人医嘱中发现以下内容互相排斥：" & strMsg & vbCrLf & vbCrLf & "要继续吗？", _
                vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                Exit Function
            End If
        End If
    End If
    
    Check诊疗互斥 = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function CheckStock(ByVal lngRow As Long) As String
'功能：检查指定药品行的库存情况
'返回：空=表示通过
    Dim dbl总量 As Double, strMsg As String
    Dim lng执行科室ID As Long, i As Integer
    
    With vsAdvice
        If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Or .TextMatrix(lngRow, COL_类别) = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 1 Then
            If TheStockCheck(Val(.TextMatrix(lngRow, COL_执行科室ID)), .TextMatrix(lngRow, COL_类别)) <> 0 Then
                If .TextMatrix(lngRow, COL_库存) <> "" Then
                    '成药临嘱直接检查总量
                    dbl总量 = Val(.TextMatrix(lngRow, COL_总量))
                    If dbl总量 > 0 Then
                        If dbl总量 > Val(.TextMatrix(lngRow, COL_库存)) Then
                            strMsg = """" & .TextMatrix(lngRow, col_医嘱内容) & """库存提醒：" & _
                                vbCrLf & vbCrLf & Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称") & _
                                IIF(InStr(GetInsidePrivs(p门诊医嘱下达), "显示药品库存") = 0, _
                                "当前可用库存不足 " & FormatEx(dbl总量, 5) & .TextMatrix(lngRow, COL_门诊单位) & "。", _
                                "当前可用库存为 " & FormatEx(Val(.TextMatrix(lngRow, COL_库存)), 5) & .TextMatrix(lngRow, COL_门诊单位) & "，不足 " & FormatEx(dbl总量, 5) & .TextMatrix(lngRow, COL_门诊单位) & "。")
                        End If
                    End If
                End If
            End If
        ElseIf RowIn配方行(lngRow) And Val(.TextMatrix(lngRow, COL_总量)) <> 0 Then
            '根据付数计算总量
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "7" And .TextMatrix(i, COL_库存) <> "" Then
                        '总量=门诊包装(单味剂量*付数)
                        '中药药房单位按不可分零处理:每付
                        If Val(.TextMatrix(i, COL_可否分零)) = 0 Then
                            dbl总量 = Val(.TextMatrix(i, COL_总量)) * Val(.TextMatrix(i, COL_单量)) / Val(.TextMatrix(i, COL_剂量系数)) / Val(.TextMatrix(i, COL_门诊包装))
                        Else
                            dbl总量 = Val(.TextMatrix(i, COL_总量)) * IntEx(Val(.TextMatrix(i, COL_单量)) / Val(.TextMatrix(i, COL_剂量系数)) / Val(.TextMatrix(i, COL_门诊包装)))
                        End If
                        If dbl总量 > Val(.TextMatrix(i, COL_库存)) Then
                            lng执行科室ID = Val(.TextMatrix(i, COL_执行科室ID))
                            If TheStockCheck(lng执行科室ID, .TextMatrix(i, COL_类别)) = 0 Then Exit For
                            
                            strMsg = strMsg & vbCrLf & .TextMatrix(i, col_医嘱内容) & _
                                "：所需总量 " & FormatEx(dbl总量, 5) & .TextMatrix(i, COL_门诊单位) & _
                                "，可用库存" & IIF(InStr(GetInsidePrivs(p门诊医嘱下达), "显示药品库存") = 0, _
                                    "不足", " " & FormatEx(Val(.TextMatrix(i, COL_库存)), 5) & .TextMatrix(i, COL_门诊单位))
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
            If strMsg <> "" Then
                strMsg = "中药配方库存提醒，" & Sys.RowValue("部门表", lng执行科室ID, "名称") & "中以下味药库存不足：" & vbCrLf & strMsg
            End If
        End If
    End With
    CheckStock = strMsg
End Function

Private Function CheckMoney() As Boolean
'功能：费用报警检查
'说明：病区有累计费用报警方式时,只提醒。
    Dim rsTmp As New ADODB.Recordset
    Dim str适用病人 As String, strSQL As String
    Dim cur预交 As Currency, cur余额 As Currency
    Dim cur担保额 As Currency
    
    On Error GoTo errH
    '费用余额
    strSQL = "Select 预交余额,Nvl(预交余额,0)-Nvl(费用余额,0) as 余额 From 病人余额 Where 性质=1 And 类型 = 1 And 病人ID=[1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID)
    If Not rsTmp.EOF Then
        cur预交 = NVL(rsTmp!预交余额, 0)
        cur余额 = NVL(rsTmp!余额, 0)
    End If
    
    '担保额
    strSQL = "Select 担保额 From 病人信息 Where 病人ID=[1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID)
    If Not rsTmp.EOF Then cur担保额 = NVL(rsTmp!担保额, 0)
    
    '有预交款的病人才判断
    If cur预交 <> 0 Then
        '是否医保
        strSQL = "Select zl_PatiWarnScheme([1]) as 适用病人 From Dual"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID)
        If Not rsTmp.EOF Then str适用病人 = NVL(rsTmp!适用病人)
            
        '报警值:NULL与0当作不同意义处理
        strSQL = "Select 报警值 From 记帐报警线 Where 报警方法=1 And Nvl(病区ID,0)=0 And 报警值 is Not NULL And 适用病人=[1]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str适用病人)
        If Not rsTmp.EOF Then
            If cur余额 + cur担保额 < NVL(rsTmp!报警值, 0) Then
                If MsgBox("病人当前可用剩余款 " & FormatEx(cur余额 + cur担保额, 2) & IIF(cur担保额 <> 0, "(含担保额:" & FormatEx(cur担保额, 2) & ")", "") & " 低于报警值 " & FormatEx(NVL(rsTmp!报警值, 0), 2) & "，要继续吗？", _
                    vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                    Exit Function
                End If
            End If
        End If
    End If
    CheckMoney = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub GetRowScope(ByVal lngRow As Long, lngBegin As Long, lngEnd As Long)
'功能：获取组ID相同的一组医嘱行号范围(注意考虑一并给药中的空行)
    Dim lngS组ID As Long, lngO组ID As Long, i As Long
    With vsAdvice
        lngBegin = lngRow: lngEnd = lngRow
        lngS组ID = IIF(Val(.TextMatrix(lngRow, COL_相关ID)) = 0, .RowData(lngRow), Val(.TextMatrix(lngRow, COL_相关ID)))
        For i = lngRow - 1 To .FixedRows Step -1
            lngO组ID = IIF(Val(.TextMatrix(i, COL_相关ID)) = 0, .RowData(i), Val(.TextMatrix(i, COL_相关ID)))
            If Not (.RowData(i) = 0 And i >= .FixedRows) Then '跳过空行
                If lngO组ID = lngS组ID Then
                    lngBegin = i
                Else
                    Exit For
                End If
            End If
        Next
        For i = lngRow + 1 To .Rows - 1
            lngO组ID = IIF(Val(.TextMatrix(i, COL_相关ID)) = 0, .RowData(i), Val(.TextMatrix(i, COL_相关ID)))
            If Not (.RowData(i) = 0 And i >= .FixedRows) Then '跳过空行
                If lngO组ID = lngS组ID Then
                    lngEnd = i
                Else
                    Exit For
                End If
            End If
        Next
    End With
End Sub

Private Function CheckApply() As Boolean
'功能：判断申请单的填写情况
    Dim i As Long
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If Not .RowHidden(i) Then
                If Val(.TextMatrix(i, COL_申请序号)) < 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                    .Row = i
                    Call cmdExt_Click
                End If
            End If
        Next
        For i = .FixedRows To .Rows - 1
            If Not .RowHidden(i) Then
                If Val(.TextMatrix(i, COL_申请序号)) < 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                    Exit Function
                End If
            End If
        Next
    End With
    CheckApply = True
End Function

Private Function CheckAdvice() As Boolean
'功能：检查当前病人(婴儿)的医嘱输入是否合法
'说明：如果有不合法的地方，在本函数中提示及定位
    Dim rsTmp As ADODB.Recordset, strSQL As String
    Dim bln配方行 As Boolean, bln检验行 As Boolean
    Dim dbl总量 As Double, strMsg As String
    Dim str药品IDs As String, str诊疗IDs As String
    Dim lngCount As Long, lngRow As Long
    Dim blnSkipStock As Boolean, blnSkipTotal As Boolean
    Dim vMsg As VbMsgBoxResult, sng天数 As Single
    Dim blnValid As Boolean, lngRxCount As Long
    Dim blnAppend As Boolean, i As Long, j As Long, k As Long
    Dim str疾病IDs As String, str诊断IDs As String
    Dim str中药名 As String, strExtra As String, lng主ID As Long
    Dim lng麻醉诊疗ID As Long, lng给药执行性质 As Long, str部位方法 As String
    Dim lngBegin As Long, lngEnd As Long
    Dim blnExists As Boolean, strTmp As String
    Dim dblOneDay As Double
    Dim datCur As Date
    Dim blnNo As Boolean, blnCheck超量 As Boolean, blnOut As Boolean
    Dim strIDs1 As String, strIDs2 As String, str医嘱内容 As String
    Dim blnTmp As Boolean
    Dim lngSame As Long
    Dim lng皮试ID As Long, Y As Long, bln皮试行 As Boolean
    Dim bln选择 As Boolean, lng路径项目ID As Long, lngThis主ID As Long
    Dim int诊断输入 As Integer
    Dim str项目IDs As String
    
    On Error GoTo errH
    If Not (mbytUseType = 1 Or mbytUseType = 2) Then
    If Not CheckApply Then Exit Function
    End If

    int诊断输入 = Val(Mid(gstr诊断输入, 1, 1))
    If vsAdvice.Enabled = True And Not Me.ActiveControl Is Nothing Then
        If Me.ActiveControl.Name = "txt总量" Then
            Call txt总量_Validate(False)
        ElseIf Me.ActiveControl.Name = "txt单量" Then
            Call txt单量_Validate(False)
        ElseIf Me.ActiveControl.Name = "txt天数" Then
            Call txt天数_Validate(False)
        End If
        vsAdvice.SetFocus  '处理光标定位，如果光标还没离开输入框，则还未更新数据。
    End If
    
    datCur = zlDatabase.Currentdate
    
    '诊断的检查
    '-----------------------------------------------------------------------------------------
    With vsDiag
        For i = .FixedRows To .Rows - 1
            If Trim(.TextMatrix(i, col诊断)) <> "" Then
                If mint险类 = 920 Then '北京医保无理要求
                    If zlCommFun.ActualLen(.TextMatrix(i, col诊断)) > 82 Then
                        .Row = i: .Col = col诊断
                        MsgBox "诊断内容太长，只允许82个字符或41个汉字。", vbInformation, gstrSysName
                        vsDiag.SetFocus: Exit Function
                    End If
                End If
                If zlCommFun.ActualLen(.TextMatrix(i, col诊断)) > 200 Then
                    .Row = i: .Col = col诊断
                    MsgBox "诊断内容太长，只允许200个字符或100个汉字。", vbInformation, gstrSysName
                    vsDiag.SetFocus: Exit Function
                End If
                If .TextMatrix(i, col发病时间) <> "" Then
                    If Format(datCur, "YYYY-MM-DD HH:mm") < Format(.TextMatrix(i, col发病时间), "YYYY-MM-DD HH:mm") Then
                         .Row = i: .Col = col发病时间
                        MsgBox "发病时间应该早于当前时间。", vbInformation, gstrSysName
                        vsDiag.SetFocus: Exit Function
                    End If
                End If
                lngSame = 0
                For j = i + 1 To .Rows - 1
                    If Trim(.TextMatrix(j, col诊断)) <> "" And .Cell(flexcpData, i, COL中医) = .Cell(flexcpData, j, COL中医) Then '同类型诊断
                        If .TextMatrix(j, col诊断) & "|" & .TextMatrix(j, col中医证候) = .TextMatrix(i, col诊断) & "|" & .TextMatrix(i, col中医证候) Then
                            .Row = i: .Col = col诊断
                            MsgBox "发现存在两行相同的诊断信息。", vbInformation, gstrSysName
                            vsDiag.SetFocus: Exit Function
                        ElseIf Val(.TextMatrix(i, col疾病ID)) <> 0 Then
                            If Val(.TextMatrix(j, col疾病ID)) & "|" & .TextMatrix(j, col中医证候) = Val(.TextMatrix(i, col疾病ID)) & "|" & .TextMatrix(i, col中医证候) Then
                                .Row = i: .Col = col诊断
                                MsgBox "发现存在两行相同的疾病信息。", vbInformation, gstrSysName
                                vsDiag.SetFocus: Exit Function
                            End If
                        ElseIf Val(.TextMatrix(i, col诊断ID)) <> 0 And .Cell(flexcpData, i, COL中医) = 0 Then
                            '因中医诊断带证候,可能无对应证候ID,诊断ID又相同
                            If Val(.TextMatrix(j, col诊断ID)) = Val(.TextMatrix(i, col诊断ID)) Then
                                .Row = i: .Col = col诊断
                                MsgBox "发现存在两行相同的诊断信息。", vbInformation, gstrSysName
                                vsDiag.SetFocus: Exit Function
                            End If
                        End If
                        If .Cell(flexcpData, i, COL中医) <> 0 Then '中医诊断
                             If .TextMatrix(j, col诊断) = .TextMatrix(i, col诊断) Then
                                lngSame = lngSame + 1
                             ElseIf Val(.TextMatrix(i, col疾病ID)) <> 0 Then
                                If Val(.TextMatrix(j, col疾病ID)) = Val(.TextMatrix(i, col疾病ID)) Then
                                    lngSame = lngSame + 1
                                End If
                             End If
                            If lngSame >= 2 Then
                                .Row = i: .Col = col诊断
                                MsgBox "存在两条以上的诊断相同且证候不同的诊断，诊断不明确。", vbInformation, gstrSysName
                                vsDiag.SetFocus: Exit Function
                            End If
                        End If
                    End If
                Next
                If Val(.TextMatrix(i, col疾病ID)) <> 0 Then str疾病IDs = str疾病IDs & "," & Val(.TextMatrix(i, col疾病ID))
                If Val(.TextMatrix(i, col诊断ID)) <> 0 Then str诊断IDs = str诊断IDs & "," & Val(.TextMatrix(i, col诊断ID))
                If (int诊断输入 = 2 Or (int诊断输入 = 3 And mint险类 <> 0)) Then
                    If Val(.TextMatrix(i, col疾病ID)) = 0 And Val(.TextMatrix(i, col诊断ID)) = 0 Then
                        If .Cell(flexcpData, i, col标志) & "" <> .TextMatrix(i, col诊断) Then
                            .Row = i: .Col = col诊断
                            MsgBox "发现存在新增的自由录入诊断", vbInformation, gstrSysName
                            vsDiag.SetFocus: Exit Function
                        End If
                    End If
                End If
            End If
        Next
    End With
    
    '-----------------------------------------------------
    strIDs1 = ""
    strIDs2 = ""
    strMsg = ""
    
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            bln配方行 = False: bln检验行 = False
            If mbytUseType = 1 And bln选择 = False Then
                If .RowData(i) <> 0 Then
                    If .Cell(flexcpChecked, i, COL_选择) <> 2 Then
                        bln选择 = True
                    End If
                End If
            End If
            If mbytUseType = 1 Then
                If lng路径项目ID <> Val(.TextMatrix(i, COL_路径项目ID)) Then
                    lng路径项目ID = Val(.TextMatrix(i, COL_路径项目ID))
                    If .Cell(flexcpChecked, i, COL_选择) = 2 Then   '相同路径项目的，可能因为自定义的排序导致不是挨着的
                        lng主ID = Val(.TextMatrix(i, COL_相关ID))
                        If lng主ID = 0 Then lng主ID = .RowData(i)
                        For k = .FixedRows To .Rows - 1
                            If lng路径项目ID = .TextMatrix(k, COL_路径项目ID) Then
                                lngThis主ID = Val(.TextMatrix(k, COL_相关ID))
                                If lngThis主ID = 0 Then lngThis主ID = .RowData(k)
                                If lng主ID <> lngThis主ID Then
                                    If .Cell(flexcpChecked, k, COL_选择) = 1 Then k = 0: Exit For
                                End If
                            End If
                        Next
                        If k = .Rows Then
                            strMsg = "是路径项目的一组可选医嘱之一，至少应选择一行。"
                            .Col = COL_选择: Exit For
                        End If
                    End If
                End If
            End If
            '本次新增或修改药品行的处方职务检查
            If .RowData(i) <> 0 And (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2)) And InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                strMsg = CheckOneDuty(.TextMatrix(i, col_医嘱内容), .TextMatrix(i, COL_处方职务), .TextMatrix(i, COL_开嘱医生), InStr(",1,2,", mstr付款码) > 0 And mstr付款码 <> "")
                If strMsg <> "" Then
                    .Col = col_医嘱内容
                    If .TextMatrix(i, COL_类别) = "7" Then
                        lngRow = .FindRow(CLng(.TextMatrix(i, COL_相关ID)), i + 1)
                        If lngRow <> -1 Then .Row = lngRow
                    Else
                        .Row = i
                    End If
                    Call .ShowCell(.Row, .Col)
                    MsgBox strMsg, vbInformation, gstrSysName
                    .Refresh
                    Call vsAdvice_KeyPress(13)
                    Exit Function
                End If
                
                '抗菌用药检查
                If gblnKSSStrict Then
                    If Val(.TextMatrix(i, COL_抗菌等级)) > 0 Then
                        If Val(.TextMatrix(i, COL_用药目的)) = 0 Then
                            strMsg = ",抗菌用药要求登记用药目的。"
                            .Col = COL_用药目的: Exit For
                        End If
                        
                        If Val(.TextMatrix(i, COL_抗菌等级)) = 3 And mbytPatiType <> 2 Then
                            strMsg = ",门诊非急诊挂号不能使用特殊使用级的抗菌药物。"
                            .Col = col_医嘱内容: Exit For
                        End If
                        
                        '如果操作员没有抗菌用药处方权，则禁止保存
                        If UserInfo.用药级别 = 0 Then
                            strMsg = ",您没有抗菌用药权限，请联系管理员。"
                            .Col = col_医嘱内容: Exit For
                        End If
                        
                        If Val(.TextMatrix(i, COL_EDIT)) = 2 Then
                            If UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And Val(.TextMatrix(i, COL_标志)) <> 1 Then
                                .TextMatrix(i, COL_审核状态) = 1
                            End If
                        End If
                    
                        '一组药品中，只要有一个为待审核或未审核通过，则整组更改(没在输入时处理，是因为可能给药途径是后续才加上的，处理的点较多)
                        If Val(.TextMatrix(i, COL_审核状态)) > 0 Then
                            Call GetRowScope(i, lngBegin, lngEnd)
                            For j = lngBegin To lngEnd
                                If j <> i Then
                                    .TextMatrix(j, COL_审核状态) = .TextMatrix(i, COL_审核状态)
                                End If
                            Next
                        End If
                        
                        
                        '紧急医嘱检查
                        If Val(.TextMatrix(i, COL_标志)) = 1 Then
                            If .TextMatrix(i, COL_用药理由) = "" Then
                                strMsg = ",紧急使用的抗菌用药要求输入用药理由。"
                                .Col = COL_用药理由: Exit For
                            End If
                            If Val(.TextMatrix(i, COL_天数)) > 1 Then
                                strMsg = ",紧急使用的抗菌用药要求仅限一天。"
                                .Col = COL_天数: Exit For
                            ElseIf Val(.TextMatrix(i, COL_天数)) = 0 Then
                                '未输入天数时进行反算天数：总量/单量/频率
                                If .TextMatrix(i, COL_剂量系数) <> "" And .TextMatrix(i, COL_门诊包装) <> "" Then
                                    '计算出一天的总量
                                    dblOneDay = FormatEx(Calc缺省药品总量( _
                                    Val(.TextMatrix(i, COL_单量)), 1, _
                                    Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), _
                                    .TextMatrix(i, COL_间隔单位), .TextMatrix(i, COL_执行时间), _
                                    Val(.TextMatrix(i, COL_剂量系数)), Val(.TextMatrix(i, COL_门诊包装)), _
                                    Val(.TextMatrix(i, COL_可否分零))), 5)
                                    If Val(.TextMatrix(i, COL_总量)) > dblOneDay Then
                                        strMsg = ",紧急使用的抗菌用药总量超出了一天的使用量：" & dblOneDay & "。"
                                        .Col = COL_天数: Exit For
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
                '药品公共方法调用
                If Val(.TextMatrix(i, COL_收费细目ID)) <> 0 And Val(.TextMatrix(i, COL_执行科室ID)) <> 0 Then
                    If InitObjPublicDrug Then
                        blnTmp = gobjPublicDrug.zlCheckPriceAdjustBySell(Val(.TextMatrix(i, COL_收费细目ID)), Val(.TextMatrix(i, COL_执行科室ID)), False)
                        If Not blnTmp Then
                            strMsg = "在(" & Sys.RowValue("部门表", Val(.TextMatrix(i, COL_执行科室ID)), "名称") & ")中药品""" & .TextMatrix(i, col_医嘱内容) & """" & vbCrLf & vbCrLf & _
                                    "不满足零差价管理的要求：成本价和售价不一致，不能销售出库。" & vbCrLf & vbCrLf & _
                                    "请联系药房或药剂科进行调价处理。"
                            .Col = col_医嘱内容
                            If .TextMatrix(i, COL_类别) = "7" Then
                                lngRow = .FindRow(CLng(.TextMatrix(i, COL_相关ID)), i + 1)
                                If lngRow <> -1 Then .Row = lngRow
                            Else
                                .Row = i
                            End If
                            Call .ShowCell(.Row, .Col)
                            MsgBox strMsg, vbInformation, gstrSysName
                            .Refresh
                            Call vsAdvice_KeyPress(13)
                            Exit Function
                        End If
                    End If
                End If
            End If
            
            
            '调用自定义的医嘱检查函数
            If .RowData(i) <> 0 And (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2)) And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                
                strExtra = CStr(.Cell(flexcpData, i, COL_医生嘱托))
                lng麻醉诊疗ID = 0
                lng给药执行性质 = 0
                str部位方法 = ""
                If .TextMatrix(i, COL_类别) = "F" Then
                    lng主ID = Val(.TextMatrix(i, COL_相关ID))
                    If lng主ID = 0 Then lng主ID = .RowData(i)
                    For k = i + 1 To .Rows - 1
                        If Val(.TextMatrix(k, COL_相关ID)) <> lng主ID Then Exit For
                        If .TextMatrix(k, COL_类别) = "G" Then
                            lng麻醉诊疗ID = .TextMatrix(k, COL_诊疗项目ID)
                        End If
                    Next
                ElseIf InStr("4,5,6,7", .TextMatrix(i, COL_类别)) > 0 Then
                    k = .FindRow(CLng(Val(.TextMatrix(i, COL_相关ID))), i + 1)
                    If k > 0 Then lng给药执行性质 = Val(.TextMatrix(k, COL_执行性质))
                
                ElseIf .TextMatrix(i, COL_类别) = "D" And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                    lng主ID = .RowData(i)
                    For k = i + 1 To .Rows - 1
                        If Val(.TextMatrix(k, COL_相关ID)) <> lng主ID Then Exit For
                        str部位方法 = str部位方法 & "," & .TextMatrix(k, COL_标本部位) & ":" & .TextMatrix(k, COL_检查方法)
                    Next
                    str部位方法 = Mid(str部位方法, 2)
                End If
                
                strExtra = strExtra & "||" & lng给药执行性质 & "||" & lng麻醉诊疗ID & "||" & IIF(str部位方法 = "", " ", str部位方法) & "||" & Val(.TextMatrix(i, COL_收费细目ID))
                
                strSQL = "Select zl_AdviceCheck([1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11],[12],[13],[14],[15]) as 结果 From Dual"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "zl_AdviceCheck", 1, mlng病人ID, mlng挂号ID, mint险类, 1, _
                     .TextMatrix(i, COL_类别), Val(.TextMatrix(i, COL_诊疗项目ID)), _
                    Val(.TextMatrix(i, COL_开嘱科室ID)), CStr(.TextMatrix(i, COL_开嘱医生)), _
                    Val(.TextMatrix(i, COL_执行科室ID)), Val(.TextMatrix(i, COL_执行性质)), Val(.TextMatrix(i, COL_执行标记)), _
                    Val(.TextMatrix(i, COL_单量)), strExtra, Val(.TextMatrix(i, COL_收费细目ID)))
                
                If Not rsTmp.EOF Then
                    strMsg = NVL(rsTmp!结果)
                    If strMsg <> "" Then
                        Select Case Val(Split(strMsg, "|")(0))
                        Case 1 '提示
                            If MsgBox(Split(strMsg, "|")(1), vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                                strMsg = "": Exit For
                            End If
                        Case 2 '禁止
                            MsgBox Split(strMsg, "|")(1), vbInformation, gstrSysName
                            strMsg = "": Exit For
                        End Select
                        strMsg = ""
                    End If
                End If
            End If
            
            '其它输入合法性检查
            If .RowData(i) <> 0 And (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2)) Then
            
                '有性别限制项目的检查（只针对：检验、检查、手术）
                If InStr(",C,D,F,5,6,7,", .TextMatrix(i, COL_类别)) > 0 And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 And (mstr性别 = "男" Or mstr性别 = "女") And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                    If .TextMatrix(i, COL_类别) = "F" Or .TextMatrix(i, COL_类别) = "D" And Not .RowHidden(i) Or .TextMatrix(i, COL_类别) = "C" And .RowHidden(i) Or InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 Then
                        strSQL = "Select Decode(a.适用性别, 1, '男', 2, '女', '未知') As 性别 From 诊疗项目目录 A Where a.Id = [1]"
                        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(i, COL_诊疗项目ID)))
                        
                        If rsTmp!性别 <> mstr性别 And rsTmp!性别 <> "未知" Then
                            If .TextMatrix(i, COL_类别) = "D" Then
                                strMsg = "手术，对性别""" & mstr性别 & """不适用。"
                            Else
                                strMsg = Decode(.TextMatrix(i, COL_类别), "C", "检验项目", "F", "附加手术", "D", "检查项目", "药品") & "，对性别""" & mstr性别 & """不适用。"
                            End If
                            .Col = col_医嘱内容: Exit For
                        End If
                    End If
                End If
                
                If .RowHidden(i) Then
                    
                    '本次新增或修改的行
                    '---------------------------------------------------
                    If InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        '检查执行科室
                        If Val(.TextMatrix(i, COL_执行科室ID)) = 0 And InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                            strMsg = "没有确定执行科室。"
                            .Col = COL_执行科室ID: Exit For
                        End If
                        
                        If .TextMatrix(i, COL_类别) = "D" And .TextMatrix(i, COL_标本部位) <> "" Then
                            If Check检查部位Enable(.TextMatrix(i, COL_诊疗项目ID), .TextMatrix(i, COL_标本部位), mstr性别, .TextMatrix(i, COL_检查方法), blnExists) = False Then
                                If blnExists = True Then
                                    strMsg = "中的部位：" & .TextMatrix(i, COL_标本部位) & "，对性别""" & mstr性别 & """不适用。"
                                Else
                                    Call cmdExt_Click
                                End If
                                .Col = col_医嘱内容: Exit For
                            End If
                        End If
                    End If
                Else
                    bln配方行 = RowIn配方行(i)
                    bln检验行 = RowIn检验行(i)
                    lngRow = i
                    If bln配方行 Then '得到配方的第一药品行
                        lngRow = .FindRow(CStr(.RowData(i)), , COL_相关ID)
                        '自备药不检查药房
                        If Not (Val(.TextMatrix(lngRow, COL_执行性质)) = 5 And Val(.TextMatrix(i, COL_执行性质)) <> 5) And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                            str中药名 = ""
                            If Check中药存储库房(lngRow, i, str中药名, vsAdvice, 1, mlng病人科室id, COL_类别, col_医嘱内容, COL_收费细目ID, COL_执行科室ID) = False Then
                                strMsg = "中的[" & str中药名 & "]没有存储在当前选择的药房，或该药房不是服务于当前病人科室的，不能使用该药品。"
                                Exit For
                            End If
                        End If
                    ElseIf bln检验行 Then '得到检验医嘱行
                        lngRow = .FindRow(CStr(.RowData(i)), , COL_相关ID)
                    End If
                    
                    '未发送的医嘱行
                    '------------------------------------
                    If Val(.TextMatrix(i, COL_状态)) = 1 Then
                        lngCount = lngCount + 1
                        
                        '临嘱规格判断,由于临床路径定义时，药品卫材可以只定义品种，生成时再选择，所以这里要检查
                        If InStr(",4,5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                            If Val(.TextMatrix(i, COL_收费细目ID)) = 0 Then
                                strMsg = "没有确定" & IIF(.TextMatrix(i, COL_类别) = "4", "卫材", "药品") & "的规格信息。"
                                .Col = col_医嘱内容: Exit For
                            End If
                        End If
                        
                        '必须录入单量:临嘱:成药或可选择频率的计时,计量项目可以录入(也可不录)
                        If (Val(.TextMatrix(lngRow, COL_频率性质)) = 0 And InStr(",1,2,", Val(.TextMatrix(lngRow, COL_计算方式))) > 0) _
                            Or InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                            '药品必须录入单量
                            If .TextMatrix(lngRow, COL_单量) <> "" Or mbln单量 And InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                                If Not IsNumeric(.TextMatrix(lngRow, COL_单量)) Or Val(.TextMatrix(lngRow, COL_单量)) <= 0 Then
                                    strMsg = "没有录入正确的单次用量。"
                                    .Col = COL_单量: Exit For
                                End If
                            End If
                        End If
                        
                        '必须录入天数：对临嘱药品，如果指定了要录入
                        If mbln天数 And InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                            If Val(.TextMatrix(i, COL_天数)) <= 0 Then
                                strMsg = "请录入正确的用药天数。"
                                .Col = COL_天数: Exit For
                            End If
                        End If
                        
                        '过敏药物要求皮试的，未下达皮试检查
                        If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 And gint过敏登记有效天数 <> 0 And mbln自动皮试 Then
                            strMsg = Check过敏试验(Me, txt医嘱内容, mlng病人ID, Val(.TextMatrix(i, COL_诊疗项目ID)), .TextMatrix(i, COL_名称), mbln自动皮试, lng皮试ID, , Val(.TextMatrix(i, COL_收费细目ID)), , msk开始时间.Text)
                            '自动添加皮试
                            If lng皮试ID <> 0 Then
                                '先检查是否已有该皮试(在有效时间内手工或自动添加的,包括免试皮试)
                                Y = .FixedRows - 1
                                bln皮试行 = False
                                Do
                                    Y = .FindRow(CStr(lng皮试ID), Y + 1, COL_诊疗项目ID)
                                    If Y <> -1 Then
                                        If Not .RowHidden(Y) Then
                                            If Int(CDate(.Cell(flexcpData, Y, COL_开始时间))) >= Int(zlDatabase.Currentdate - gint过敏登记有效天数) Then
                                                bln皮试行 = True: Exit Do '记录以作标志,当前行输入完成后再增加
                                            End If
                                        End If
                                    End If
                                Loop Until Y = -1
                                If bln皮试行 = False Then
                                    strMsg = "需要进行皮试，请先下达皮试医嘱。"
                                    .Col = col_医嘱内容: Exit For
                                End If
                            End If
                        End If
                        
                        '必须录入总量:配方,临嘱(药品或其它)
                        If Not IsNumeric(.TextMatrix(i, COL_总量)) Or Val(.TextMatrix(i, COL_总量)) <= 0 Then
                            '输血医嘱允许不输入总量
                            If Not (.TextMatrix(i, COL_类别) = "K" And .TextMatrix(i, COL_总量) = "") Then
                                If bln配方行 Then
                                    strMsg = "没有录入正确的中药配方付数。"
                                ElseIf InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                                    strMsg = "没有录入正确的药品总给予量。"
                                Else
                                    strMsg = "没有录入正确的总量。"
                                End If
                                .Col = COL_总量: Exit For
                            End If
                        End If
                                            
                        '必须录入频率:临嘱也要检查,用于指导使用,可以不录入执行时间
                        If Val(.TextMatrix(lngRow, COL_频率性质)) = 0 Or InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Or bln配方行 Then
                            If .TextMatrix(lngRow, COL_频率) = "" Then
                                strMsg = "没有确定执行频率。"
                                .Col = COL_频率: Exit For
                            End If
                            '执行时间判断:可选频率的必须输入(对临嘱将来可能允许不录入,要注意发送等地方的处理)
                            If .TextMatrix(lngRow, COL_执行时间) = "" And .TextMatrix(lngRow, COL_间隔单位) <> "分钟" And .TextMatrix(lngRow, COL_频率) <> "必要时" And .TextMatrix(lngRow, COL_频率) <> "需要时" Then
                                If Not bln检验行 Then '检验组合显示行的采集方法为可选频率,但检验项目为一次性
                                    If Val(.TextMatrix(lngRow, COL_频率性质)) <> 1 Then
                                        strMsg = "没有录入执行时间方案。"
                                        .Col = COL_执行时间: Exit For
                                    End If
                                End If
                            End If
                        End If
                        
                        '必须录入执行科室:非叮嘱和院外执行时(配方以药品行进行判断)
                        If Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then
                            If .TextMatrix(lngRow, COL_类别) = "Z" And InStr(",1,2,", Val(.TextMatrix(lngRow, COL_操作类型))) > 0 Then
                                If Val(.TextMatrix(lngRow, COL_操作类型)) = 1 Then
                                    strMsg = "没有确定留观医嘱的留观科室。"
                                ElseIf Val(.TextMatrix(lngRow, COL_操作类型)) = 2 Then
                                    strMsg = "没有确定住院医嘱的住院科室。"
                                End If
                                .Col = COL_执行科室ID: Exit For
                            ElseIf InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                                strMsg = "没有确定执行科室。"
                                .Col = COL_执行科室ID: Exit For
                            End If
                        End If
                        If lngRow <> i And Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                            If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                                strMsg = "没有确定执行科室。"
                                .Col = COL_执行科室ID: Exit For
                            End If
                        End If
                        
                        '开嘱时间判断
                        If Not Check开嘱时间(.Cell(flexcpData, i, COL_开嘱时间), .Cell(flexcpData, i, COL_开始时间), False, strMsg) Then
                            .Col = COL_开嘱时间: Exit For
                        End If
                        
                        '处方条数限制检查
                        If gintRXCount > 0 And InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 _
                            And Val(.TextMatrix(i, COL_相关ID)) <> Val(.TextMatrix(i - 1, COL_相关ID)) Then
                            lngRxCount = GetMergeCount(vsAdvice, i, COL_相关ID, COL_收费细目ID)
                            If lngRxCount > gintRXCount Then
                                strMsg = "一并给药的药品种数 " & lngRxCount & " 种已达到或超过药品处方最多允许的种数 " & gintRXCount & " 种。"
                                .Col = col_医嘱内容: Exit For
                            End If
                        End If
                    End If
                    
                    '本次新增或修改的行
                    '---------------------------------------------------
                    If InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        '开始时间判断:只对新增的医嘱进行判断,因为否则是不准修改开始时间的(不好判断被修改的医嘱开始时间的相对有效性)
                        If .TextMatrix(i, COL_EDIT) = "1" Then
                            If Not Check开始时间(.Cell(flexcpData, i, COL_开始时间), False, strMsg) Then
                                .Col = COL_开始时间: Exit For
                            End If
                        End If
                        '手术/输血医嘱的手术/输血时间判断
                        If .TextMatrix(i, COL_类别) = "F" Or .TextMatrix(i, COL_类别) = "K" Then
                            If Not Check安排时间(.TextMatrix(i, COL_手术时间), .Cell(flexcpData, i, COL_开始时间), .TextMatrix(.Row, COL_类别), False, strMsg) Then
                                .Col = COL_手术时间: Exit For
                            End If
                            If .TextMatrix(i, COL_类别) = "K" Then
                                '只有紧急医嘱保存输血原因
                                If .TextMatrix(i, COL_用药理由) = "" And .TextMatrix(i, COL_标志) = "1" Then
'                                    .TextMatrix(i, COL_用药理由) = ""
'                                Else
                                    If gbln输血分级管理 And .TextMatrix(i, COL_标志) = "1" And .TextMatrix(i, COL_用药理由) = "" Then
                                        strMsg = "启用了输血分级管理后，紧急输血医嘱必须填写输血原因。"
                                        .Col = COL_用药理由: Exit For
                                    End If
                                End If
                            End If
                        End If
                        
                        '给药途径，中药用法，采集方法设置检查
                        If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                            If Val(.TextMatrix(i, COL_相关ID)) = .RowData(i + 1) And Val(.TextMatrix(i + 1, COL_诊疗项目ID)) = 0 Then
                                strMsg = "没有设置对应的给药途径。"
                                .Col = COL_用法: Exit For
                            End If
                        End If
                        If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_诊疗项目ID)) = 0 Then
                            If .RowData(i) = Val(.TextMatrix(i - 1, COL_相关ID)) Then
                                If InStr(",7,E,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                                    strMsg = "中药配方没有设置对应的用法。"
                                ElseIf .TextMatrix(i - 1, COL_类别) = "C" Then
                                    strMsg = "没有设置对应的标本采集方法。"
                                End If
                                .Col = COL_用法: Exit For
                            End If
                        End If

                        '检验医嘱一并采集检查
                        str项目IDs = ""
                        If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_操作类型)) = 6 Then
                            If .RowData(i) = Val(.TextMatrix(i - 1, COL_相关ID)) And .TextMatrix(i - 1, COL_类别) = "C" And i - 2 >= .FixedRows Then
                                If .RowData(i) = Val(.TextMatrix(i - 2, COL_相关ID)) And .TextMatrix(i - 2, COL_类别) = "C" Then
                                    Call GetRowScope(i, lngBegin, lngEnd)
                                    For j = lngBegin To lngEnd
                                        If j <> i And .TextMatrix(j, COL_类别) = "C" Then
                                            str项目IDs = str项目IDs & "," & .TextMatrix(j, COL_诊疗项目ID)
                                            If Val(.Cell(flexcpData, j, COL_皮试结果)) = 0 Or Val(.TextMatrix(j, COL_申请序号)) = 0 Then
                                             
                                                    blnTmp = IsLis耐受项目(p门诊医嘱下达, Val(.TextMatrix(j, COL_诊疗项目ID)), str中药名)
                                                    If Not blnTmp Then
                                                        If str中药名 <> "" Then
                                                            strMsg = "耐受试验判断出错:" & str中药名: .Col = col_医嘱内容: Exit For
                                                        End If
                                                    Else
                                                        '耐受试验判断
                                                        strMsg = "当前为耐受试验必须用申请单方式下达。": .Col = col_医嘱内容: Exit For
                                                    End If
                                                 
                                            End If
                                        End If
                                    Next
                                    str项目IDs = Mid(str项目IDs, 2)
                                    If str项目IDs <> "" Then
                                        strSQL = "Select distinct 试管编码 ,操作类型 From 诊疗项目目录 Where ID IN (Select /*+cardinality(x,10)*/ x.Column_Value From Table(f_Num2list([1])) X) And 试管编码 is Not Null"
                                        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str项目IDs)
                                        If rsTmp.RecordCount > 1 Then strMsg = "当前一并采集检验医嘱的试管编码或检验类型不相同。": .Col = col_医嘱内容: Exit For
                                    End If
                                End If
                            End If
                            
                            '耐受试验判断
                            If Val(.RowData(i)) = Val(.TextMatrix(i - 1, COL_相关ID)) And .TextMatrix(i - 1, COL_类别) = "C" And (Val(.Cell(flexcpData, i - 1, COL_皮试结果)) = 0 Or Val(.TextMatrix(i - 1, COL_申请序号)) = 0) Then
                                
                                    blnTmp = IsLis耐受项目(p门诊医嘱下达, Val(.TextMatrix(i - 1, COL_诊疗项目ID)), str中药名)
                                    If Not blnTmp Then
                                        If str中药名 <> "" Then
                                            strMsg = "耐受试验判断出错:" & str中药名: .Col = col_医嘱内容: Exit For
                                        End If
                                    Else
                                        '耐受试验判断
                                        strMsg = "当前为耐受试验必须用申请单方式下达。": .Col = col_医嘱内容: Exit For
                                    End If
                        
                            End If
                        End If
                                                
                        '最少总量检查:至少要满足一个频次周期的用量
                        If InStr(",4,5,6,", .TextMatrix(i, COL_类别)) > 0 Or bln配方行 Then
                            If Not blnSkipTotal And .TextMatrix(i, COL_频率) <> "" And Val(.TextMatrix(i, COL_频率次数)) <> 0 And Val(.TextMatrix(i, COL_频率间隔)) <> 0 Then
                                strMsg = ""
                                If bln配方行 Then '判断
                                    dbl总量 = Calc缺省药品总量(1, 1, Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), .TextMatrix(i, COL_间隔单位))
                                    If Val(.TextMatrix(i, COL_总量)) < dbl总量 Then
                                        strMsg = .TextMatrix(i, col_医嘱内容) & vbCrLf & vbCrLf & _
                                            "在按""" & .TextMatrix(i, COL_频率) & """执行时,至少需要 " & dbl总量 & "付。"
                                    End If
                                ElseIf Val(.TextMatrix(i, COL_剂量系数)) <> 0 And Val(.TextMatrix(i, COL_单量)) <> 0 Then
                                    sng天数 = Val(.TextMatrix(i, COL_天数))
                                    If sng天数 = 0 Then sng天数 = 1
                                    dbl总量 = Calc缺省药品总量(Val(.TextMatrix(i, COL_单量)), sng天数, Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), .TextMatrix(i, COL_间隔单位), .TextMatrix(i, COL_执行时间), Val(.TextMatrix(i, COL_剂量系数)), Val(.TextMatrix(i, COL_门诊包装)), Val(.TextMatrix(i, COL_可否分零)))
                                    If Val(.TextMatrix(i, COL_总量)) < dbl总量 Then
                                        strMsg = .TextMatrix(i, col_医嘱内容) & vbCrLf & vbCrLf & _
                                            "在按每次 " & .TextMatrix(i, COL_单量) & .TextMatrix(i, COL_单量单位) & "," & _
                                            .TextMatrix(i, COL_频率) & IIF(mbln天数 And .TextMatrix(i, COL_类别) <> "4", ",用药 " & sng天数 & " 天", "") & _
                                            "执行时,至少需要 " & dbl总量 & .TextMatrix(i, COL_总量单位) & "。"
                                    End If
                                End If
                                If strMsg <> "" And False Then '提示
                                    .Row = i: .Col = COL_总量: Call .ShowCell(.Row, .Col)
                                    vMsg = frmMsgBox.ShowMsgBox(strMsg & "^^要继续吗？", Me)
                                    If vMsg = vbNo Or vMsg = vbCancel Then
                                        If txt总量.Enabled And txt总量.Visible Then txt总量.SetFocus
                                        Exit Function
                                    ElseIf vMsg = vbIgnore Then
                                        blnSkipTotal = True
                                    End If
                                End If
                            End If
                        End If
                        
                        '检查药品是否超量和超期，遍历时应从第一条没有填写超量说明的行开始
                        If (gbyt超量原因 = 1 And InStr(gstr不录超量科室, "," & mlng病人科室id & ",") = 0) And Not blnCheck超量 _
                            And (.TextMatrix(i, COL_是否超量) = "1" Or .TextMatrix(i, COL_是否超期) = "1") And .TextMatrix(i, COL_超量说明) = "" Then
                            blnCheck超量 = SetAll超量说明(i, blnOut) '超量的检查只要这个方法执行了一次就算是所有都已经检查了不用再遍历了
                            If blnOut Then
                                strMsg = "Not Null" '这里应该赋值确保 strMsg 不为空即可
                                .Col = COL_超量说明: Exit For
                            End If
                        End If
                        
                        '药品库存检查:只提醒,所以也只对本次编辑的才判断
                        If (InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Or bln配方行 _
                            Or .TextMatrix(i, COL_类别) = "4" And Val(.TextMatrix(i, COL_跟踪在用)) = 1) And Not blnSkipStock Then
                            strMsg = CheckStock(i)
                            If strMsg <> "" Then
                                .Row = i: .Col = col_医嘱内容: Call .ShowCell(.Row, .Col)
                                vMsg = frmMsgBox.ShowMsgBox(strMsg & "^^要继续吗？", Me)
                                If vMsg = vbNo Or vMsg = vbCancel Then
                                    Exit Function
                                ElseIf vMsg = vbIgnore Then
                                    blnSkipStock = True
                                End If
                            End If
                        End If
                        
                        '执行时间合法性检查
                        If .TextMatrix(i, COL_执行时间) <> "" And .TextMatrix(i, COL_频率) <> "" Then
                            blnValid = ExeTimeValid(.TextMatrix(i, COL_执行时间), Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), .TextMatrix(i, COL_间隔单位))
                            If Not blnValid Then
                                If .TextMatrix(i, COL_间隔单位) = "周" Then
                                    strMsg = COL_按周执行
                                ElseIf .TextMatrix(i, COL_间隔单位) = "天" Then
                                    strMsg = COL_按天执行
                                ElseIf .TextMatrix(i, COL_间隔单位) = "小时" Then
                                    strMsg = COL_按时执行
                                End If
                                strMsg = "录入的执行时间方案格式不正确，请检查。" & vbCrLf & vbCrLf & "例：" & vbCrLf & strMsg
                                .Col = COL_执行时间: Exit For
                            End If
                        End If
                        
                        '医保对码检查:以一组医保第一可见行为准
                        If InStr(",5,6,", .TextMatrix(i, COL_类别)) = 0 _
                            Or Val(.TextMatrix(i - 1, COL_相关ID)) <> Val(.TextMatrix(i, COL_相关ID)) Then
                            If gint医保对码 = 2 Then mbln提醒对码 = True
                            Call GetInsureStr(strIDs1, strIDs2, str医嘱内容, i)
                            strMsg = CheckAdviceInsure(mint险类, mbln提醒对码, mlng病人ID, 1, strIDs1, strIDs2, str医嘱内容)
                            If strMsg <> "" Then
                                .Row = i: .Col = col_医嘱内容: Call .ShowCell(.Row, .Col)
                                If gint医保对码 = 1 Then
                                    vMsg = frmMsgBox.ShowMsgBox(strMsg & vbCrLf & vbCrLf & "要继续保存医嘱吗？", Me)
                                    If vMsg = vbNo Or vMsg = vbCancel Then Exit Function
                                    If vMsg = vbIgnore Then mbln提醒对码 = False
                                ElseIf gint医保对码 = 2 Then
                                    MsgBox strMsg & vbCrLf & vbCrLf & "请先和相关人员联系处理，否则医嘱将不允许保存。", vbInformation, gstrSysName
                                    Exit Function
                                End If
                                strMsg = "" '防止后面再作处理
                            End If
                        End If
                        
                        '医保管控实时监测：首次输入(经过)或者更改时检查
                        If mint险类 <> 0 And .Cell(flexcpData, i, COL_状态) = 0 Then
                            If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) Then
                                If MakePriceRecord(i) Then
                                    If Not gclsInsure.CheckItem(mint险类, 0, 0, mrsPrice) Then
                                        .Row = i: .Col = col_医嘱内容
                                        Call .ShowCell(.Row, .Col)
                                        If txt总量.Enabled Then
                                            txt总量.SetFocus
                                        ElseIf txt医嘱内容.Enabled Then
                                            txt医嘱内容.SetFocus
                                        End If
                                        Exit Function
                                    End If
                                End If
                                '标记为已经作了检查
                                .Cell(flexcpData, .Row, COL_状态) = 1
                            End If
                        End If
                    End If
                                    
                    '医嘱申请附项填写检查：
                    '只针对新录入的医嘱，修改的医嘱修改时已检查
                    '".Cell(flexcpData, i, COL_附项) = 1"的可能还没有在输入过程中检查，只是自动替换了
                    If Val(.TextMatrix(i, COL_EDIT)) = 1 And .TextMatrix(i, COL_附项) <> "" Then
                        strMsg = CheckAdviceAppend(.TextMatrix(i, COL_附项))
                        If strMsg <> "" Then
                            strMsg = "申请附项""" & strMsg & """没有录入，请确认系统默认填写的信息是否正确。"
                            .Col = col_医嘱内容: blnAppend = True: Exit For
                        End If
                    End If
                                    
                    '互斥数据收集:在所有有效医嘱中,因为可能已发送的与未发送的互斥
                    If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                        '用于药品配伍禁忌检查:不分期效
                        str药品IDs = str药品IDs & "," & Val(.TextMatrix(i, COL_诊疗项目ID))
                    ElseIf Not bln配方行 Then
                        '不管检查组合与手术附加内部之间及内部与其它项目之间
                        str诊疗IDs = str诊疗IDs & "," & Val(.TextMatrix(i, COL_诊疗项目ID))
                    End If
                End If
            End If
        Next
        
        '--------------------------------------------------------------------------
        '中间退出的错误提示
        If i <= .Rows - 1 Then
            .Row = i: Call .ShowCell(.Row, .Col)
            If strMsg <> "" Then
                If bln配方行 Then
                    strMsg = "该中药配方" & strMsg
                Else
                    strMsg = """" & .TextMatrix(i, col_医嘱内容) & """" & strMsg
                End If
                If Not blnOut Then '超量说明提示特殊处理
                    MsgBox strMsg, vbInformation, gstrSysName
                End If
                blnOut = False
                .Refresh
            End If
            Call vsAdvice_KeyPress(13)
            If blnAppend Then '是否弹出申请附项编辑
                If cmdExt.Enabled And cmdExt.Visible Then Call cmdExt_Click
            End If
            Exit Function
        End If
        
        '检查药品配伍禁忌
        If str药品IDs <> "" Then
            If Not Check配伍禁忌(Mid(str药品IDs, 2)) Then Exit Function
        End If
        '检查诊疗项目互斥
        If str诊疗IDs <> "" Then
            If Not Check诊疗互斥(Mid(str诊疗IDs, 2)) Then Exit Function
        End If
    End With
    
    '费用报警:有未发送医嘱时
    If lngCount > 0 Then
        If Not CheckMoney Then Exit Function
    End If


    '复诊不弹出传染病报告卡

    Call MsgDis(Mid(str疾病IDs, 2), Mid(str诊断IDs, 2))
    If Not mbln复诊 Then
        '根据诊断判断是否应该书写传染病报告卡
        RaiseEvent CheckInfectDisease(False, Mid(str疾病IDs, 2), Mid(str诊断IDs, 2), blnNo)
    End If
    If blnNo Then Exit Function
    
    '--检查病人是否退号，是否取消了接诊
    If Not CheckBackNo(mstr挂号单) Then Exit Function
    
    '生成路径时检查
    If mbytUseType = 1 Then
        '允许一个都不选择，但给予提示
        If bln选择 = False Then
            If MsgBox("你没有选择生成任何医嘱，确定要继续吗？", vbQuestion + vbYesNo + vbDefaultButton1) = vbNo Then
                Exit Function
            End If
        End If
    End If
    
    CheckAdvice = True
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function SeekNextControl() As Boolean
'功能：定位到下一个焦点的控件上,并根据情况决定是否自动新增一行医嘱
'返回：如果通过SetFocus强制定位的,则返回True
    Dim objActive As Object, objNext As Object
    Dim blnDo As Boolean, i As Long
    Dim strSkip As String
    
    Set objActive = Me.ActiveControl
    
    If Not objActive Is Nothing Then
        If TypeName(objActive) = "TextBox" Or TypeName(objActive) = "ComboBox" Then
            If objActive.Container Is fraAdvice Then
                strSkip = GetInputSkip(vsAdvice.Row)
                Set objNext = zlControl.GetNextControl(objActive.TabIndex, Me, strSkip)
                If Not objNext Is Nothing Then
                    If objNext Is vsAdvice Then
                        For i = vsAdvice.Row + 1 To vsAdvice.Rows - 1
                            If Not vsAdvice.RowHidden(i) Then
                                Call AdviceChange '强制更新医嘱内容
                                vsAdvice.Row = i
                                
                                '可能已在其他事件中被定位了，不用重复移动定位表格
                                If Not Me.ActiveControl Is Nothing Then
                                    If Not Me.ActiveControl Is vsAdvice Then
                                        Call zlCommFun.PressKey(vbKeyTab)
                                    End If
                                End If
                                '表格行无内容则再移动定位到医嘱输入框
                                blnDo = vsAdvice.RowData(i) <> 0
                                
                                Exit For
                            End If
                        Next
                        If i > vsAdvice.Rows - 1 And (mbytUseType = 0 Or mbytUseType = 2) Then
                            blnDo = True
                            cbsMain.FindControl(, conMenu_New, True, True).Execute
                        End If
                    ElseIf strSkip <> "" And InStr(";" & strSkip & ";", objNext.Name) = 0 Then
                        '有要跳过的控件时，需要强行定位
                        If objNext.Enabled And objNext.Visible Then
                            blnDo = True
                            objNext.SetFocus
                        End If
                    End If
                End If
            End If
        End If
    End If
    If Not blnDo Then
        Call zlCommFun.PressKey(vbKeyTab) '自然定位
    Else
        SeekNextControl = True
    End If
End Function

Private Function GetInputSkip(ByVal lngRow As Long) As String
'功能：获取输入医嘱过程中，回车光标应跳过的控件
    Dim strSkip As String, lngFind As Long
    
    With vsAdvice
        '一并给药中的药品输入时应跳过的内容
        If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 And .RowData(lngRow) <> 0 Then
            If Val(.TextMatrix(lngRow, COL_相关ID)) = Val(.TextMatrix(lngRow - 1, COL_相关ID)) Then
                '给药途径,附加执行
                If Val(.TextMatrix(lngRow, COL_相关ID)) <> 0 Then
                    lngFind = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    If lngFind <> -1 Then
                        If Val(.TextMatrix(lngFind, COL_诊疗项目ID)) <> 0 Then
                            strSkip = strSkip & ";" & Me.txt用法.Name
                        End If
                        If Val(.TextMatrix(lngFind, COL_执行科室ID)) <> 0 Then
                            strSkip = strSkip & ";" & Me.cbo附加执行.Name
                        End If
                    End If
                End If
                '频率
                If .TextMatrix(lngRow, COL_频率) <> "" Then strSkip = strSkip & ";" & Me.txt频率.Name
                '执行时间
                If .TextMatrix(lngRow, COL_执行时间) <> "" Then strSkip = strSkip & ";" & Me.cbo执行时间.Name
            End If
        ElseIf InStr(",C,D,F,G,Z", .TextMatrix(lngRow, COL_类别)) > 0 And .RowData(lngRow) <> 0 And .TextMatrix(lngRow, COL_频率) = "一次性" Then
            strSkip = strSkip & ";" & Me.txt频率.Name
        End If
    End With
    strSkip = strSkip & ";" & vsScheme.Name & ";" & vsLIS.Name & ";" & vsPAC.Name & ";" & vsDRU.Name
    GetInputSkip = Mid(strSkip, 2)
End Function

Private Sub SetBabyVisible(ByVal lng科室id As Long)
'功能：根据科室性质设置婴儿医嘱是否可以选择
'说明：产科才有婴儿医嘱
    If mbytUseType = 0 Then
    If DeptIsWoman(lng科室id) Then
        lbl婴儿.Visible = True
        cbo婴儿.Visible = True
    Else
        Call Cbo.SetIndex(cbo婴儿.hwnd, 0)
            cbo婴儿.Tag = 0
            lbl婴儿.Visible = False
            cbo婴儿.Visible = False
        End If
    Else
        cbo婴儿.Tag = 0
        lbl婴儿.Visible = False
        cbo婴儿.Visible = False
    End If
End Sub

Private Sub CalcAdviceMoney()
'功能：计算新开医嘱金额
'说明：只管当前显示出的部份新开医嘱
    Dim dblMoney As Double, i As Long
    
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If Not .RowHidden(i) And Val(.TextMatrix(i, COL_状态)) = 1 Then
                dblMoney = dblMoney + Format(CCur(Val(.TextMatrix(i, COL_总量)) * Val(.TextMatrix(i, COL_单价))), gstrDec)
            End If
        Next
        stbThis.Panels(5).Text = "新开:" & FormatEx(dblMoney, 5) & "元"
        lblMoney.Caption = "新开:" & FormatEx(dblMoney, 5) & "元" & IIF(mdbl预交款 - FormatEx(dblMoney, 5) < 0, " 需补交:" & FormatEx(Abs(mdbl预交款 - FormatEx(dblMoney, 5)), 5) & "元", "")
        lblMoney.ForeColor = IIF(mdbl预交款 - FormatEx(dblMoney, 5) < 0, vbRed, 8388608)
    End With
End Sub

Private Sub AdviceSign()
'功能：对医嘱进行电子签名
    Dim strSQL As String, strIDs As String, i As Long
    Dim strSource As String, strSign As String
    Dim lng签名id As Long, lng证书ID As Long
    Dim intRule As Integer, strTimeStamp As String, strTimeStampCode As String
    Dim ColIDs As Collection, ColSource As Collection
    
    If gobjESign Is Nothing Then Exit Sub
    If gobjESign.CertificateStoped(UserInfo.姓名) Then
        MsgBox "您的签名证书已被停用，请联系信息科。", vbInformation, gstrSysName
        Exit Sub
    End If
    
    '自动保存
    If mblnNoSave Then
        If Not CheckAdvice Then Exit Sub
        If Not SaveAdvice Then vsAdvice.SetFocus: Exit Sub
    End If
    
    '获取签名医嘱源文
    intRule = ReadAdviceSignSource(1, mlng病人ID, mstr挂号单, strIDs, 0, False, strSource, mstr前提IDs, , ColIDs, ColSource)
    If intRule = 0 Then Exit Sub
    If strSource = "" Then
        MsgBox "该病人目前没有可以签名的医嘱。", vbInformation, gstrSysName
        Exit Sub
    End If
    For i = 1 To ColIDs.Count
        strSign = gobjESign.Signature(ColSource(i), gstrDBUser, lng证书ID, strTimeStamp, Nothing, strTimeStampCode, (i <> 1))
        If strSign <> "" Then
            If strTimeStamp <> "" Then
                strTimeStamp = "To_Date('" & strTimeStamp & "','YYYY-MM-DD HH24:MI:SS')"
            Else
                strTimeStamp = "NULL"
            End If
            lng签名id = zlDatabase.GetNextID("医嘱签名记录")
            strSQL = "zl_医嘱签名记录_Insert(" & lng签名id & ",1," & intRule & ",'" & Replace(strSign, "'", "''") & "'," & lng证书ID & ",'" & ColIDs(i) & "'," & strTimeStamp & ",'" & UserInfo.姓名 & "','" & strTimeStampCode & "')"
            On Error GoTo errH
            Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
            On Error GoTo 0
        End If
    Next
    If strSign <> "" Then
        '重新读取显示医嘱
        Call ReLoadAdvice(vsAdvice.RowData(vsAdvice.Row))
        mblnOK = True
        If txt医嘱内容.Enabled Then
            txt医嘱内容.SetFocus
        Else
            vsAdvice.SetFocus
        End If

        MsgBox "已完成电子签名。", vbInformation, gstrSysName
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function AdviceTextChange(ByVal lngRow As Long) As Boolean
'功能：当医嘱卡片输入内容变化时，判断医嘱内容文本是否应该重新组织
    Dim str类别 As String, strText As String, blnDefine As Boolean
    
    With vsAdvice
        '确定医嘱类别
        str类别 = .TextMatrix(lngRow, COL_类别)
        If str类别 = "E" And Val(.TextMatrix(lngRow, COL_相关ID)) = 0 Then '中药配方或一组检验
            lngRow = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
            If lngRow <> -1 Then str类别 = .TextMatrix(lngRow, COL_类别)
        End If
        If str类别 = "7" Then str类别 = "8"
                
        '确定是否定义
        blnDefine = Not mrsDefine Is Nothing And Not mobjVBA Is Nothing
        If blnDefine Then
            mrsDefine.Filter = "诊疗类别='" & str类别 & "'"
            If mrsDefine.EOF Then
                blnDefine = False
            ElseIf Trim(NVL(mrsDefine!医嘱内容)) = "" Then
                blnDefine = False
            End If
        End If
        If blnDefine Then strText = mrsDefine!医嘱内容
        
        '检查内容变动
        If blnDefine Then '公共字段部份或可以公共处理的部份
            If IsDate(msk开始时间.Text) And msk开始时间.Tag <> "" And InStr(strText, "[开始时间]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If IsDate(txt安排时间.Text) And txt安排时间.Tag <> "" Then
                If InStr(strText, "[手术时间]") > 0 Or InStr(strText, "[输血时间]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
            If cbo医生嘱托.Tag <> "" And InStr(strText, "[医生嘱托]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If cmd频率.Tag <> "" And txt频率.Tag <> "" Then
                If InStr(strText, "[中文频率]") > 0 Or InStr(strText, "[英文频率]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
            If cbo执行时间.Tag <> "" And InStr(strText, "[执行时间]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If (IsNumeric(txt单量.Text) Or txt单量.Text = "") And txt单量.Tag <> "" And InStr(strText, "[单量]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If IsNumeric(txt总量.Text) And txt总量.Tag <> "" And InStr(strText, "[总量]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
        End If
        
        Select Case str类别 '不同的类别检查
        Case "5", "6" '中西成药
            If Not blnDefine Then
                
            Else
                '[输入名][通用名][商品名][英文名][规格][产地]是输入或修改整个药品时变化
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" And InStr(strText, "[给药途径]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case "8" '中药配方
            If Not blnDefine Then
                If IsNumeric(txt总量.Text) And txt总量.Tag <> "" Then AdviceTextChange = True: Exit Function
                If cmd频率.Tag <> "" And txt频率.Tag <> "" Then AdviceTextChange = True: Exit Function
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[配方组成][煎法]是输入或修改整个配方时变化
                If IsNumeric(txt总量.Text) And txt总量.Tag <> "" And InStr(strText, "[付数]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" And InStr(strText, "[用法]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case "C" '检验
            If Not blnDefine Then
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[检验项目][检验标本]是输入或修改整个项目时变化
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" And InStr(strText, "[采集方法]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case "D" '检查
            If Not blnDefine Then
                
            Else
                '[检查项目][检查部位]是输入或修改整个项目时变化
            End If
        Case "F" '手术
            If Not blnDefine Then
                If IsDate(txt安排时间.Text) And txt安排时间.Tag <> "" Then AdviceTextChange = True: Exit Function
                If IsDate(msk开始时间.Text) And msk开始时间.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[主要手术][附加手术][麻醉方法]是输入或修改整个项目时变化
            End If
        Case "K" '输血
            If Not blnDefine Then
                If IsDate(txt安排时间.Text) And txt安排时间.Tag <> "" Then AdviceTextChange = True: Exit Function
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[输血途径]
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" And InStr(strText, "[输血途径]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case Else '其他
            If Not blnDefine Then
                
            Else
                '[诊疗项目]是输入或修改整个项目时变化
            End If
        End Select
    End With
End Function

Private Function AdviceTextMake(ByVal lngRow As Long) As String
'功能：获取医嘱内容文本
'参数：lngRow=已有医嘱数据的可见行
    Dim rsTmp As New ADODB.Recordset
    Dim rsCard As New ADODB.Recordset
    Dim blnDefine As Boolean, str类别 As String
    Dim strText As String, strSQL As String
    Dim strField As String, int频率范围 As Integer
    Dim i As Long, k As Long
    Dim blnDo As Boolean
    Dim str中药名称 As String
    
    Dim str中药 As String, str煎法 As String, str形态 As String
    Dim str麻醉 As String, str附术 As String
    Dim str检验 As String, str标本 As String
    Dim str部位 As String, str部位Last As String, str方法 As String
    Dim dbl数量 As Double
    Dim str中药诊疗项目IDS As String, strSame As String
    
    On Error GoTo errH
    
    With vsAdvice
        '确定医嘱类别
        str类别 = .TextMatrix(lngRow, COL_类别)
        If str类别 = "E" Then '中药配方或一组检验
            k = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
            If k <> -1 Then str类别 = .TextMatrix(k, COL_类别)
        End If
        If str类别 = "7" Then str类别 = "8"
                
        '确定是否定义
        blnDefine = Not mrsDefine Is Nothing And Not mobjVBA Is Nothing
        If blnDefine Then
            mrsDefine.Filter = "诊疗类别='" & str类别 & "'"
            If mrsDefine.EOF Then
                blnDefine = False
            ElseIf Trim(NVL(mrsDefine!医嘱内容)) = "" Then
                blnDefine = False
            End If
        End If
        
ReDoDefault: '用于按定义公式计算失败，重新按缺省规则进行组织
        strText = ""
        If blnDefine Then strText = mrsDefine!医嘱内容
        
        '产生医嘱内容
        Select Case str类别
        Case "C" '检验-------------------------------------------------------------
            str检验 = "": str标本 = ""
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If Val(.TextMatrix(i, COL_组合项目ID)) = 0 And mblnNewLIS Or Not mblnNewLIS Then
                        str检验 = .TextMatrix(i, col_医嘱内容) & "," & str检验
                    End If
                    str标本 = .TextMatrix(i, COL_标本部位)
                Else
                    Exit For
                End If
            Next
            If str检验 = "" Then '老的方式
                str检验 = .TextMatrix(lngRow, COL_名称)
            Else
                str检验 = Left(str检验, Len(str检验) - 1)
            End If
            
            If Not blnDefine Then
                strText = str检验 & IIF(str标本 <> "", "(" & str标本 & ")", "")
            Else
                If InStr(strText, "[检验项目]") > 0 Then
                    strField = str检验
                    strText = Replace(strText, "[检验项目]", """" & strField & """")
                End If
                If InStr(strText, "[检验标本]") > 0 Then
                    strField = str标本
                    strText = Replace(strText, "[检验标本]", """" & strField & """")
                End If
                If InStr(strText, "[采集方法]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_用法)
                    strText = Replace(strText, "[采集方法]", """" & strField & """")
                End If
            End If
        Case "D" '检查-------------------------------------------------------------
            str部位 = "": str方法 = ""
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_标本部位) <> "" Then
                        If .TextMatrix(i, COL_标本部位) <> str部位Last And str部位Last <> "" Then
                            str部位 = str部位 & "," & str部位Last & IIF(str方法 <> "", "(" & Mid(str方法, 2) & ")", "")
                            str方法 = ""
                        End If
                        If .TextMatrix(i, COL_检查方法) <> "" Then
                            str方法 = str方法 & "," & .TextMatrix(i, COL_检查方法)
                        End If
                        
                        str部位Last = .TextMatrix(i, COL_标本部位)
                    End If
                Else
                    Exit For
                End If
            Next
            If str部位Last <> "" Then
                str部位 = str部位 & "," & str部位Last & IIF(str方法 <> "", "(" & Mid(str方法, 2) & ")", "")
            End If
            str部位 = Mid(str部位, 2) '检查组合项目的部位
            
            If Not blnDefine Then
                strText = .TextMatrix(lngRow, COL_名称) & _
                    Decode(Val(.TextMatrix(lngRow, COL_执行标记)), 1, ",床旁执行", 2, ",术中执行", "") & IIF(str部位 <> "", ":" & str部位, "")
            Else
                If InStr(strText, "[检查项目]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_名称) & _
                        Decode(Val(.TextMatrix(lngRow, COL_执行标记)), 1, ",床旁执行", 2, ",术中执行", "")
                    strText = Replace(strText, "[检查项目]", """" & strField & """")
                End If
                If InStr(strText, "[检查部位]") > 0 Then
                    strField = str部位
                    strText = Replace(strText, "[检查部位]", """" & strField & """")
                End If
            End If
        Case "F" '手术-------------------------------------------------------------
            str麻醉 = "": str附术 = ""
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "G" Then
                        str麻醉 = .TextMatrix(i, col_医嘱内容)
                    Else
                        str附术 = str附术 & "," & .TextMatrix(i, col_医嘱内容) & IIF(.TextMatrix(i, COL_执行标记) = "1", "(必要时)", "")
                    End If
                Else
                    Exit For
                End If
            Next
            str附术 = Mid(str附术, 2)
            
            If Not blnDefine Then
                If IsDate(.TextMatrix(lngRow, COL_标本部位)) Then
                    strText = Format(.TextMatrix(lngRow, COL_标本部位), "MM月dd日HH:mm")
                Else
                    strText = Format(.Cell(flexcpData, lngRow, COL_开始时间), "MM月dd日HH:mm")
                End If
                If str麻醉 <> "" Then
                    strText = strText & IIF(str麻醉 <> "", " 在 " & str麻醉 & " 下行 ", " 行 ")
                End If
                strText = strText & .TextMatrix(lngRow, COL_名称) & IIF(.Cell(flexcpData, lngRow, COL_标本部位) = "", "", "(部位:" & .Cell(flexcpData, lngRow, COL_标本部位) & ")")
                If str附术 <> "" Then
                    strText = strText & " 及 " & str附术
                End If
            Else
                If InStr(strText, "[手术时间]") > 0 Then
                    If IsDate(.TextMatrix(lngRow, COL_手术时间)) Then
                        strField = .TextMatrix(lngRow, COL_手术时间)
                    Else
                        strField = .Cell(flexcpData, lngRow, COL_开始时间)
                    End If
                    strText = Replace(strText, "[手术时间]", """" & strField & """")
                End If
                If InStr(strText, "[主要手术]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_名称) & IIF(.Cell(flexcpData, lngRow, COL_标本部位) = "", "", "(部位:" & .Cell(flexcpData, lngRow, COL_标本部位) & ")")
                    strText = Replace(strText, "[主要手术]", """" & strField & """")
                End If
                If InStr(strText, "[附加手术]") > 0 Then
                    strField = str附术
                    strText = Replace(strText, "[附加手术]", """" & strField & """")
                End If
                If InStr(strText, "[麻醉方法]") > 0 Then
                    strField = str麻醉
                    strText = Replace(strText, "[麻醉方法]", """" & strField & """")
                End If
            End If
        Case "8" '中药配方---------------------------------------------------------
            str中药 = "": str煎法 = "": str中药诊疗项目IDS = "": strSame = ""
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "7" Then
                        If InStr("," & str中药诊疗项目IDS & ",", "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & ",") > 0 Then
                            strSame = strSame & "," & Val(.TextMatrix(i, COL_诊疗项目ID))
                        End If
                        str中药诊疗项目IDS = str中药诊疗项目IDS & "," & Val(.TextMatrix(i, COL_诊疗项目ID))
                    End If
                Else
                    Exit For
                End If
            Next
            strSame = Mid(strSame, 2)
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "7" Then
                        dbl数量 = dbl数量 + Val(.TextMatrix(i, COL_单量))
                        
                        If Val(.TextMatrix(lngRow, COL_中药形态)) = 0 Then
                            blnDo = .TextMatrix(i, COL_收费细目ID) <> .TextMatrix(i - 1, COL_收费细目ID)
                        Else
                            blnDo = .TextMatrix(i, COL_诊疗项目ID) <> .TextMatrix(i - 1, COL_诊疗项目ID)
                        End If
                        
                        If blnDo Then
                            str中药名称 = .TextMatrix(i, col_医嘱内容)
                            
                            If Val(.TextMatrix(lngRow, COL_中药形态)) = 0 And InStr("," & strSame & ",", "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & ",") > 0 Then
                                strSQL = "Select 规格 as 名称 From 收费项目目录 Where ID=[1] And Exists(Select 1 From 药品规格 Where 药品ID<>[1] And 药名ID=[2])"
                                Set rsTmp = New ADODB.Recordset '清除Filter
                                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(i, COL_收费细目ID)), Val(.TextMatrix(i, COL_诊疗项目ID)))
                                If rsTmp.RecordCount > 0 Then
                                    If Not IsNull(rsTmp!名称) Then str中药名称 = str中药名称 & "(" & rsTmp!名称 & ")"
                                End If
                            End If
                        
                            str中药 = RTrim(str中药名称 & _
                                " " & FormatEx(dbl数量, 5) & .TextMatrix(i, COL_单量单位) & _
                                " " & .TextMatrix(i, COL_医生嘱托)) & "," & str中药
                            dbl数量 = 0
                        End If
                    ElseIf .TextMatrix(i, COL_类别) = "E" Then
                        str煎法 = .TextMatrix(i, col_医嘱内容) & .TextMatrix(i, COL_标本部位)
                    End If
                Else
                    Exit For
                End If
            Next
            If str中药 <> "" Then
                str中药 = Mid(str中药, 1, Len(str中药) - 1)
            End If
            If Not blnDefine Then
                If .TextMatrix(lngRow, COL_中药形态) = "1" Then
                    str形态 = "[饮片]"
                ElseIf .TextMatrix(lngRow, COL_中药形态) = "2" Then
                    str形态 = "[免煎剂]"
                End If
                '数字后加了空格在文本框中会自动换行
                strText = "中药" & str形态 & .TextMatrix(lngRow, COL_总量) & "付," & _
                    .TextMatrix(lngRow, COL_频率) & "," & str煎法 & "," & _
                    .TextMatrix(lngRow, COL_用法) & ":" & str中药
            Else
                If InStr(strText, "[付数]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_总量)
                    strText = Replace(strText, "[付数]", """" & strField & """")
                End If
                If InStr(strText, "[配方组成]") > 0 Then
                    strField = str中药
                    strText = Replace(strText, "[配方组成]", """" & strField & """")
                End If
                If InStr(strText, "[用法]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_用法)
                    strText = Replace(strText, "[用法]", """" & strField & """")
                End If
                If InStr(strText, "[煎法]") > 0 Then
                    strField = str煎法
                    strText = Replace(strText, "[煎法]", """" & strField & """")
                End If
            End If
        Case "4" '卫材------------------------------------------------------------
                strSQL = "Select 名称,规格,产地 From 收费项目目录 Where ID=[1]"
                Set rsTmp = New ADODB.Recordset '清除Filter
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_收费细目ID)))
                
                If Not blnDefine Then
                    strText = .TextMatrix(lngRow, COL_名称)
                    If Not IsNull(rsTmp!规格) Then
                        strText = strText & " " & rsTmp!规格
                    End If
                Else
                    If InStr(strText, "[卫生材料]") > 0 Then
                        strField = rsTmp!名称
                        strText = Replace(strText, "[卫生材料]", """" & strField & """")
                    End If
                    If InStr(strText, "[规格]") > 0 Then
                        strField = NVL(rsTmp!规格)
                        strText = Replace(strText, "[规格]", """" & strField & """")
                    End If
                    If InStr(strText, "[产地]") > 0 Then
                        strField = NVL(rsTmp!产地)
                        strText = Replace(strText, "[产地]", """" & strField & """")
                    End If
                End If
        Case "5", "6" '西成药，中成药---------------------------------------------
            If Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
                '性质:0-正名,1-英文名,3-商品名
                strSQL = "Select Nvl(B.名称,A.名称) as 名称,A.规格,A.产地,B.性质" & _
                    " From 收费项目目录 A,收费项目别名 B Where A.ID=B.收费细目ID(+) And A.ID=[1] Order by B.性质,B.码类"
                Set rsTmp = New ADODB.Recordset '清除Filter
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_收费细目ID)))
            ElseIf blnDefine Then
                '性质:0-正名,1-英文名
                strSQL = "Select Nvl(B.名称,A.名称) as 名称,Null as 规格,Null as 产地,B.性质" & _
                    " From 诊疗项目目录 A,诊疗项目别名 B Where A.ID=B.诊疗项目ID(+) And A.ID=[1] Order by B.性质,B.码类"
                Set rsTmp = New ADODB.Recordset '清除Filter
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_诊疗项目ID)))
            End If
            If Not blnDefine Then
                strText = .TextMatrix(lngRow, COL_标本部位)
                If Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
                    If strText = "" Then
                        If gbyt药品名称显示 <> 0 Then rsTmp.Filter = "性质=3"
                        If rsTmp.EOF Then rsTmp.Filter = 0
                        strText = rsTmp!名称
                    End If
                    If Not IsNull(rsTmp!产地) Then
                        strText = strText & "(" & rsTmp!产地 & ")"
                    End If
                    If Not IsNull(rsTmp!规格) Then
                        strText = strText & " " & rsTmp!规格
                    End If
                Else
                    If strText = "" Then
                        strText = .TextMatrix(lngRow, COL_名称)
                    End If
                End If
            Else
                If InStr(strText, "[输入名]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_标本部位)
                    If strField = "" Then
                        If gbyt药品名称显示 <> 0 Then rsTmp.Filter = "性质=3"
                        If rsTmp.EOF Then rsTmp.Filter = 0
                        strField = rsTmp!名称
                    End If
                    strText = Replace(strText, "[输入名]", """" & strField & """")
                End If
                If InStr(strText, "[通用名]") > 0 Then
                    rsTmp.Filter = 0
                    strField = rsTmp!名称
                    strText = Replace(strText, "[通用名]", """" & strField & """")
                End If
                If InStr(strText, "[商品名]") > 0 Then
                    rsTmp.Filter = "性质=3"
                    If rsTmp.EOF Then
                        strField = ""
                    Else
                        strField = rsTmp!名称
                    End If
                    strText = Replace(strText, "[商品名]", """" & strField & """")
                End If
                If InStr(strText, "[英文名]") > 0 Then
                    rsTmp.Filter = "性质=2"
                    If rsTmp.EOF Then
                        strField = ""
                    Else
                        strField = rsTmp!名称
                    End If
                    strText = Replace(strText, "[英文名]", """" & strField & """")
                End If
                If InStr(strText, "[规格]") > 0 Then
                    If rsTmp.EOF Then rsTmp.Filter = 0
                    strField = NVL(rsTmp!规格)
                    strText = Replace(strText, "[规格]", """" & strField & """")
                End If
                If InStr(strText, "[产地]") > 0 Then
                    If rsTmp.EOF Then rsTmp.Filter = 0
                    strField = NVL(rsTmp!产地)
                    strText = Replace(strText, "[产地]", """" & strField & """")
                End If
                If InStr(strText, "[给药途径]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_用法)
                    strText = Replace(strText, "[给药途径]", """" & strField & """")
                End If
            End If
        Case "K" '输血医嘱
            If Not blnDefine Then
                If IsDate(.TextMatrix(lngRow, COL_输血时间)) Then
                    strText = Format(.TextMatrix(lngRow, COL_输血时间), "MM月dd日HH:mm")
                Else
                    strText = Format(.Cell(flexcpData, lngRow, COL_开始时间), "MM月dd日HH:mm")
                End If
            
                strText = "于" & strText & "输" & .TextMatrix(lngRow, COL_名称)
                If .TextMatrix(lngRow, COL_用法) <> "" Then
                    strText = strText & "(" & .TextMatrix(lngRow, COL_用法) & ")"
                End If
            Else
                If InStr(strText, "[输血时间]") > 0 Then
                    If IsDate(.TextMatrix(lngRow, COL_输血时间)) Then
                        strField = .TextMatrix(lngRow, COL_输血时间)
                    Else
                        strField = .Cell(flexcpData, lngRow, COL_开始时间)
                    End If
                    strText = Replace(strText, "[输血时间]", """" & strField & """")
                End If
                If InStr(strText, "[诊疗项目]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_名称)
                    strText = Replace(strText, "[诊疗项目]", """" & strField & """")
                End If
                If InStr(strText, "[输血项目]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_名称)
                    strText = Replace(strText, "[输血项目]", """" & strField & """")
                End If
                If InStr(strText, "[输血途径]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_用法)
                    strText = Replace(strText, "[输血途径]", """" & strField & """")
                End If
                If TypeName(.Cell(flexcpData, lngRow, COL_申请序号)) = "Recordset" Then
                    Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_申请序号))
                    If InStr(strText, "[血型]") > 0 Then
                        If rsCard.EOF Then
                            strField = ""
                        Else
                            strField = Decode(Val("" & rsCard!血型), 1, "A", 2, "B", 3, "O", 4, "AB", "")
                        End If
                        strText = Replace(strText, "[血型]", """" & strField & """")
                    End If
                    If InStr(strText, "[RH]") > 0 Then
                        If rsCard.EOF Then
                            strField = ""
                        Else
                            strField = Decode(Val("" & rsCard!RHD), 1, "-", 2, "+", "")
                        End If
                        strText = Replace(strText, "[RH]", """" & strField & """")
                    End If
                End If
                If InStr(strText, "[执行分类]") > 0 Then
                    strField = Val(.TextMatrix(lngRow + 1, COL_执行分类))
                    strText = Replace(strText, "[执行分类]", """" & strField & """")
                End If
            End If
        Case Else '其它所有类别-----------------------------------------------------
            If Not blnDefine Then
                strText = .TextMatrix(lngRow, COL_名称)
            Else
                If InStr(strText, "[诊疗项目]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_名称)
                    strText = Replace(strText, "[诊疗项目]", """" & strField & """")
                End If
            End If
            '术后医嘱特殊显示
            If .TextMatrix(lngRow, COL_类别) = "Z" And (Val(.TextMatrix(lngRow, COL_操作类型)) = 4 Or Val(.TextMatrix(lngRow, COL_操作类型)) = 14) Then
                strText = "━━━" & strText & "━━━"
            End If
        End Select
        
        '公共字段或可以公共处理的字段-------------------------------------------
        If blnDefine Then
            If InStr(strText, "[开始时间]") > 0 Then
                strField = .Cell(flexcpData, lngRow, COL_开始时间)
                strText = Replace(strText, "[开始时间]", """" & strField & """")
            End If
            If InStr(strText, "[医生嘱托]") > 0 Then
                strField = .Cell(flexcpData, lngRow, COL_医生嘱托)
                If .TextMatrix(lngRow, COL_医生嘱托) <> "" Then
                    If strField <> "" Then
                        strField = strField & "," & .TextMatrix(lngRow, COL_医生嘱托)
                    Else
                        strField = .TextMatrix(lngRow, COL_医生嘱托)
                    End If
                End If
                strText = Replace(strText, "[医生嘱托]", """" & strField & """")
            End If
            If InStr(strText, "[中文频率]") > 0 Then
                strField = .TextMatrix(lngRow, COL_频率)
                strText = Replace(strText, "[中文频率]", """" & strField & """")
            End If
            If InStr(strText, "[英文频率]") > 0 Then
                strField = ""
                If .TextMatrix(lngRow, COL_频率) <> "" Then
                    int频率范围 = Get频率范围(lngRow)
                    strSQL = "Select 英文名称 From 诊疗频率项目 Where 名称=[1] And 适用范围=[2]"
                    Set rsTmp = New ADODB.Recordset '清除Filter
                    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, .TextMatrix(lngRow, COL_频率), int频率范围)
                    If Not rsTmp.EOF Then strField = NVL(rsTmp!英文名称)
                End If
                strText = Replace(strText, "[英文频率]", """" & strField & """")
            End If
            If InStr(strText, "[单量]") > 0 Then
                strField = ""
                If .TextMatrix(lngRow, COL_单量) <> "" Then
                    strField = .TextMatrix(lngRow, COL_单量) & .TextMatrix(lngRow, COL_单量单位)
                End If
                strText = Replace(strText, "[单量]", """" & strField & """")
            End If
            If InStr(strText, "[总量]") > 0 Then
                strField = ""
                If .TextMatrix(lngRow, COL_总量) <> "" Then
                    strField = .TextMatrix(lngRow, COL_总量) & .TextMatrix(lngRow, COL_总量单位)
                End If
                strText = Replace(strText, "[总量]", """" & strField & """")
            End If
            If InStr(strText, "[执行时间]") > 0 Then
                strField = .TextMatrix(lngRow, COL_执行时间)
                strText = Replace(strText, "[执行时间]", """" & strField & """")
            End If
        End If
                
        '计算医嘱内容
        If blnDefine Then
            On Error Resume Next
            strText = mobjVBA.Eval(strText)
            If mobjVBA.Error.Number <> 0 Then
                err.Clear: On Error GoTo errH
                blnDefine = False: GoTo ReDoDefault
            End If
        End If
    End With
    AdviceTextMake = strText
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function GetAdviceAppendItem() As String
'功能：获取未保存医嘱(新开或修改的)的最新单据附项
'返回：项目名1<Split2>内容1<Split1>项目名2<Split2>内容2<Split1>...
    Dim arrAppend As Variant, i As Long, j As Long
    Dim strName As String, strText As String
    Dim strResult As String
    
    With vsAdvice
        For i = .Rows - 1 To .FixedRows Step -1
            If .RowData(i) <> 0 And .TextMatrix(i, COL_附项) <> "" And .Cell(flexcpData, i, COL_附项) = 1 Then
                arrAppend = Split(.TextMatrix(i, COL_附项), "<Split1>")
                For j = 0 To UBound(arrAppend)
                    strName = Split(arrAppend(j), "<Split2>")(0)
                    strText = Split(arrAppend(j), "<Split2>")(3)
                    
                    If InStr(strResult, "<Split1>" & strName & "<Split2>") = 0 Then
                        strResult = strResult & "<Split1>" & strName & "<Split2>" & strText
                    End If
                Next
            End If
        Next
    End With
    
    GetAdviceAppendItem = Mid(strResult, Len("<Split1>") + 1)
End Function

Private Function GetAdviceDiagnosis() As String
'功能：获取当前已录入的未保存的诊断
'返回："1、诊断名一 2、诊断名二"
    Dim strText As String, i As Long, j As Long
    
    With vsDiag
        For i = 1 To .Rows - 1
            If Trim(.TextMatrix(i, col诊断)) <> "" Then
                j = j + 1
                strText = strText & "  " & j & "、" & .TextMatrix(i, col诊断) & IIF(Val(.Cell(flexcpData, i, col疑诊)) = 1, "(？)", "")
            End If
        Next
    End With
    
    strText = Mid(strText, 3)
    If j = 1 Then strText = Mid(strText, 3)
    GetAdviceDiagnosis = strText
End Function

Private Function GetDiagSQL(ByVal Row As Long, ByRef strInput As String, ByRef strSQL As String, ByRef str性别 As String, Optional ByVal strType As String) As String
'功能：获得查询诊断的SQL
'参数：strInput-查询条件,strsql--返回的SQL，str性别--病人的性别  ,strType疾病编码种类。
'返回：strsql--查询中医诊断的SQL
    If vsDiag.Cell(flexcpData, Row, COL中医) = 1 Then
        If opt诊断(0).value And strType <> "Z" Then
            '按诊断输入:中医部份，一个诊断可能属于多个分类
            If zlCommFun.IsCharChinese(strInput) Then
                strSQL = "B.名称 Like [2]" '输入汉字时只匹配名称
            Else
                strSQL = "A.编码 Like [1] Or B.名称 Like [2] Or B.简码 Like [2]"
            End If
            strSQL = _
                " Select Distinct A.ID,A.ID as 项目ID,A.编码,Null as 类别,A.名称,A.说明,A.编者," & vbNewLine & _
                " Decode(b.名称, [5], 1, Decode(b.简码,[5],1,decode(a.编码,[5],1,NULL))) As 排序1ID,Decode(d.诊断id, Null, Decode(c.诊断id, Null, Null, 2), 1) As 排序2ID," & vbNewLine & _
                " Decode(Substr(b.名称, 1, Length([5])), [5], 1, Decode(Substr(b.简码, 1, Length([5])),[5],1,decode(Substr(a.编码, 1, Length([5])),[5],1,NULL))) As 排序3ID" & _
                " From 疾病诊断目录 A,疾病诊断别名 B, 疾病诊断科室 C, 疾病诊断科室 D" & _
                " Where A.ID=B.诊断ID And c.诊断id(+) = a.Id And d.诊断id(+) = a.Id And A.类别=2" & _
                " And B.码类=[4] And d.人员id(+) = [6] And c.科室id(+)=[7] And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD'))" & _
                " And (" & strSQL & ")" & _
                " Order by 排序1ID, 排序2ID, 排序3ID,A.编码"
                '排序顺序：先是完全匹配(名称、简码、编码）、个人收藏、其次是科室收藏、然后是左匹配(名称、简码、编码）、最后是双向匹配
        Else
            'B-中医疾病编码
            If zlCommFun.IsCharChinese(strInput) Then
                strSQL = "A.名称 Like [2]" '输入汉字时只匹配名称
            Else
                strSQL = "A.编码 Like [1] Or A.名称 Like [2] Or " & IIF(mint简码 = 0, "A.简码", "A.五笔码") & " Like [2]"
            End If
            strSQL = _
                "Select Distinct a.Id, a.Id As 项目id, a.编码, a.类别, a.附码, a.名称," & IIF(mint简码 = 0, "A.简码", "A.五笔码 as 简码") & ", a.说明," & _
                " Decode(a.名称, [5], 1, Decode(" & IIF(mint简码 = 0, "A.简码", "A.五笔码") & ",[5],1,decode(a.编码,[5],1,NULL))) As 排序1ID," & vbNewLine & _
                " Decode(d.疾病id, Null, Decode(c.疾病id, Null, Null, 2), 1) As 排序2ID," & vbNewLine & _
                " Decode(Substr(a.名称, 1, Length([5])), [5], 1, Decode(Substr(" & IIF(mint简码 = 0, "A.简码", "A.五笔码") & ", 1, Length([5])),[5],1,decode(Substr(a.编码, 1, Length([5])),[5],1,NULL))) As 排序3ID" & vbNewLine & _
                "From 疾病编码目录 A, 疾病编码科室 C, 疾病编码科室 D" & vbNewLine & _
                "Where a.类别 = '" & IIF(strType = "", "B", strType) & "' And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And c.疾病id(+) = a.Id And" & vbNewLine & _
                " d.疾病id(+) = a.Id And c.科室id(+)=[7] And d.人员id(+) = [6]" & vbNewLine & _
                IIF(str性别 <> "", " And (A.性别限制=[3] Or A.性别限制 is NULL)", "") & _
                " And (" & strSQL & ")" & _
                "Order By 排序1ID, 排序2ID, 排序3ID, 编码"
        End If
    Else
        If opt诊断(0).value Then
            '按诊断输入:西医部份，一个诊断可能属于多个分类
            If zlCommFun.IsCharChinese(strInput) Then
                strSQL = "B.名称 Like [2]" '输入汉字时,只匹配名称
            Else
                strSQL = "A.编码 Like [1] Or B.名称 Like [2] Or B.简码 Like [2]"
            End If
            strSQL = _
                " Select Distinct A.ID,A.ID as 项目ID,A.编码,Null as 类别,A.名称,A.说明,A.编者," & vbNewLine & _
                " Decode(b.名称, [5], 1, Decode(b.简码,[5],1,decode(a.编码,[5],1,NULL))) As 排序1ID,Decode(d.诊断id, Null, Decode(c.诊断id, Null, Null, 2), 1) As 排序2ID," & vbNewLine & _
                " Decode(Substr(b.名称, 1, Length([5])), [5], 1, Decode(Substr(b.简码, 1, Length([5])),[5],1,decode(Substr(a.编码, 1, Length([5])),[5],1,NULL))) As 排序3ID" & _
                " From 疾病诊断目录 A,疾病诊断别名 B, 疾病诊断科室 C, 疾病诊断科室 D" & _
                " Where A.ID=B.诊断ID And c.诊断id(+) = a.Id And d.诊断id(+) = a.Id And A.类别=1" & _
                " And B.码类=[4] And d.人员id(+) = [6] And c.科室id(+)=[7] And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) " & _
                " And (" & strSQL & ")" & _
                " Order by 排序1ID, 排序2ID, 排序3ID,A.编码"
                '排序顺序：先是完全匹配(名称、简码、编码）、个人收藏、其次是科室收藏、然后是左匹配(名称、简码、编码）、最后是双向匹配
        Else
            'D-ICD-10疾病编码
            If zlCommFun.IsCharChinese(strInput) Then
                strSQL = "A.名称 Like [2]" '输入汉字时,只匹配名称
            Else
                strSQL = "A.编码 Like [1] Or A.名称 Like [2] Or " & IIF(mint简码 = 0, "A.简码", "A.五笔码") & " Like [2]"
            End If
            strSQL = _
                "Select Distinct a.Id, a.Id As 项目id, a.编码, a.类别, a.附码, a.名称," & IIF(mint简码 = 0, "A.简码", "A.五笔码 as 简码") & ", a.说明," & _
                " Decode(a.名称, [5], 1, Decode(" & IIF(mint简码 = 0, "A.简码", "A.五笔码") & ",[5],1,decode(a.编码,[5],1,NULL))) As 排序1ID," & vbNewLine & _
                " Decode(d.疾病id, Null, Decode(c.疾病id, Null, Null, 2), 1) As 排序2ID," & vbNewLine & _
                " Decode(Substr(a.名称, 1, Length([5])), [5], 1, Decode(Substr(" & IIF(mint简码 = 0, "A.简码", "A.五笔码") & ", 1, Length([5])),[5],1,decode(Substr(a.编码, 1, Length([5])),[5],1,NULL))) As 排序3ID" & vbNewLine & _
                "From 疾病编码目录 A, 疾病编码科室 C, 疾病编码科室 D" & vbNewLine & _
                "Where a.类别 = 'D' And (a.撤档时间 Is Null Or a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And c.疾病id(+) = a.Id And" & vbNewLine & _
                "      d.疾病id(+) = a.Id And c.科室id(+)=[7] And d.人员id(+) = [6]" & vbNewLine & _
                IIF(str性别 <> "", " And (A.性别限制=[3] Or A.性别限制 is NULL)", "") & _
                " And (" & strSQL & ")" & _
                "Order By 排序1ID, 排序2ID, 排序3ID, 编码"
        End If
    End If
    GetDiagSQL = strSQL
End Function

Private Sub GetAgentInfo()
'功能：读取代办人信息
    Dim rsTmp As ADODB.Recordset
    
    gstrSQL = "Select c.信息名, c.信息值" & vbNewLine & _
        "  From 病人信息从表 C" & vbNewLine & _
        "  Where c.就诊id = [2] And c.病人id = [1] And Instr(',代办人姓名,代办人身份证号,代办人性别,代办人年龄,代办人电话,病人身份证号,用药理由,',','||c.信息名||',')>0"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(gstrSQL, Me.Caption, mlng病人ID, mlng挂号ID)
    
    AgentInfo.本次就诊已录入 = False
    AgentInfo.代办人姓名 = ""
    AgentInfo.代办人身份证号 = ""
    AgentInfo.代办人性别 = ""
    AgentInfo.代办人年龄 = ""
    AgentInfo.代办人电话 = ""
    AgentInfo.用药理由 = ""
    
    If rsTmp.EOF Then Exit Sub
    
    AgentInfo.本次就诊已录入 = True
    While Not rsTmp.EOF
        Select Case NVL(rsTmp!信息名)
            Case "代办人姓名"
                AgentInfo.代办人姓名 = NVL(rsTmp!信息值)
            Case "代办人身份证号"
                AgentInfo.代办人身份证号 = NVL(rsTmp!信息值)
            Case "代办人性别"
                AgentInfo.代办人性别 = NVL(rsTmp!信息值)
            Case "代办人年龄"
                AgentInfo.代办人年龄 = NVL(rsTmp!信息值)
            Case "代办人电话"
                AgentInfo.代办人电话 = NVL(rsTmp!信息值)
            Case "用药理由"
                AgentInfo.用药理由 = NVL(rsTmp!信息值)
        End Select
        rsTmp.MoveNext
    Wend
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub vsAdvice_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim lngRow As Long
    
    With vsAdvice
        'Pass
        If Button = 2 Then
            lngRow = .MouseRow
            If lngRow >= .FixedRows And lngRow <= .Rows - 1 Then
                If Not .RowHidden(lngRow) Then .Row = lngRow
            End If
        End If
        
        If Button = 1 Then
            If .Col = COL_并 And .MouseRow > .FixedRows - 1 Then
                mlng拖动行 = .MouseRow
            Else
                mlng拖动行 = 0
                .Cell(flexcpBackColor, .FixedRows, COL_并, .Rows - 1, COL_并) = .BackColor
            End If
        End If
    
    End With
End Sub

Private Sub vsAdvice_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim lngPreRow As Long
    
    With vsAdvice
        If Button = 1 Then
            If .Col = COL_并 And .MouseRow > .FixedRows - 1 Then
                lngPreRow = Val(.Tag)
                If mlng拖动行 > 0 Then
                    If lngPreRow <> .MouseRow Then
                        .Cell(flexcpBackColor, .FixedRows, COL_并, .Rows - 1, COL_并) = .BackColor
                        .Cell(flexcpBackColor, .MouseRow, COL_并, mlng拖动行, COL_并) = .BackColorSel
                    End If
                End If
            Else
                .Cell(flexcpBackColor, .FixedRows, COL_并, .Rows - 1, COL_并) = .BackColor
                mlng拖动行 = 0
                .Tag = ""
            End If
            .Tag = .MouseRow
        End If
    End With
End Sub

Private Sub vsAdvice_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim objPopup As CommandBarPopup
    Dim blnDo As Boolean

    If Button = 2 Then
        If cbsMain Is Nothing Then Exit Sub
        Set objPopup = cbsMain.ActiveMenuBar.FindControl(, conMenu_EditPopup)
        If mblnPass = False Then
            blnDo = True
        Else
            '门诊编辑界面菜单级数比医生站少一级
            Call gobjPass.zlPASSPopupCommandBars(mobjPassMap, objPopup.CommandBar, conMenu_Edit_MediAudit, blnDo)
        End If
        If gobjPlugIn Is Nothing And blnDo And gobjDrugExplain Is Nothing Then Exit Sub '当弹出没有菜单项目时会显示一个空白小方块
        If Not objPopup Is Nothing Then
            objPopup.CommandBar.ShowPopup
        End If
    End If
    
    If Button = 1 Then
        If vsAdvice.Col = COL_并 And mlng拖动行 <> 0 Then
            Call SetAll一并给药(mlng拖动行, vsAdvice.MouseRow)
        Else
            mlng拖动行 = 0
        End If
        vsAdvice.Cell(flexcpBackColor, vsAdvice.FixedRows, COL_并, vsAdvice.Rows - 1, COL_并) = vsAdvice.BackColor
    End If
End Sub

Private Sub ExePlugIn(ByVal strName As String, Optional ByVal int诊断 As Integer = 0)
'功能：执行外挂功能
'int诊断：是否执行诊断功能
    Dim lngID As String
    Dim strXML As String
    If CreatePlugInOK(p门诊医嘱下达, mint场合) Then
        If int诊断 = 0 Then
            With vsAdvice
                lngID = .RowData(.Row)
                If InStr(",1,2,", Val(.TextMatrix(.Row, COL_EDIT))) > 0 Then
                    If MsgBox("当前选中的医嘱未保存，是否先保存？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                        Exit Sub
                    End If
                    cbsMain.FindControl(, conMenu_Save, True, True).Execute: Exit Sub
                End If
            End With
            On Error Resume Next
            If PlugExeNew(strName) = False Then
                Call gobjPlugIn.ExecuteFunc(glngSys, p门诊医嘱下达, strName, mlng病人ID, mlng挂号ID, lngID, mlng前提ID, mint场合)
                Call zlPlugInErrH(err, "ExecuteFunc")
                err.Clear: On Error GoTo 0
            End If
        Else
            With vsDiag
                lngID = Val(.RowData(.Row))
                strXML = "<ROOT><诊断ID>" & .TextMatrix(.Row, col诊断ID) & "</诊断ID><疾病ID>" & .TextMatrix(.Row, col疾病ID) & "</疾病ID></ROOT>"
                On Error Resume Next
                Call gobjPlugIn.ExecuteFunc(glngSys, p门诊医嘱下达, strName, mlng病人ID, mlng挂号ID, lngID, .TextMatrix(.Row, col诊断), 5, strXML)
                Call zlPlugInErrH(err, "ExecuteFunc")
                err.Clear: On Error GoTo 0
            End With
        End If
    End If
End Sub

Private Function PlugExeNew(ByVal strName As String) As Boolean
'功能：向下兼容外挂部件的ExecuteFunc过程
    Dim lngID As Long
    Dim strXML As String
On Error GoTo errH
    If CreatePlugInOK(p门诊医嘱下达, mint场合) Then
        With vsAdvice
            lngID = .RowData(.Row)
            strXML = "<ROOT><诊疗项目名称>" & .TextMatrix(.Row, COL_名称) & "</诊疗项目名称></ROOT>"
            Call gobjPlugIn.ExecuteFunc(glngSys, p门诊医嘱下达, strName, mlng病人ID, mlng挂号ID, lngID, mlng前提ID, mint场合, strXML)
        End With
    End If
   PlugExeNew = True
   Exit Function
errH:
    If err.Number = 450 Then
        PlugExeNew = False
        err.Clear
    Else
        PlugExeNew = True
        Call zlPlugInErrH(err, "ExecuteFunc")
        err.Clear: On Error GoTo 0
    End If
End Function

Private Function CheckInHosAdvice() As Boolean
'功能：检查当前病人是否存在有效的留观或住院医嘱
'参数：
    Dim strSQL As String, rsTmp As ADODB.Recordset
    Dim i As Long, intDays As Integer
    
    On Error GoTo errH
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If .RowData(i) <> 0 And Not .RowHidden(i) Then
                If .TextMatrix(i, COL_EDIT) = "1" And i <> .Row Then
                    If .TextMatrix(i, COL_操作类型) = "1" Or .TextMatrix(i, COL_操作类型) = "2" Then
                        CheckInHosAdvice = True
                        Exit Function
                    End If
                End If
            End If
        Next
    End With
     
    If Sys.NewSystemSvr("预约中心", "住院申请", "", "") Then
        '启用预约中心用医嘱进行判断
        strSQL = "Select Trunc(Sysdate-a.开始执行时间) 天数 From 病人医嘱记录 a,诊疗项目目录 b Where a.诊疗项目id=b.id and a.诊疗类别='Z' and b.操作类型 in ('1','2') and a.医嘱状态=8 and a.挂号单=[2] and rownum<2"
    Else
        strSQL = "Select Trunc(Sysdate - 入院日期) 天数 From 病案主页 Where 病人id = [1] And 主页id = 0"
    End If
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mstr挂号单)
    If rsTmp.RecordCount > 0 Then
        intDays = IIF(gint普通挂号天数 > gint急诊挂号天数, gint普通挂号天数, gint急诊挂号天数)
        If intDays = 0 Then intDays = 1
        If rsTmp!天数 <= intDays Then   '医嘱发送时再删除预约登记（71009）
            If MsgBox("存在旧的预约申请，产生新的预约申请时必须要删除旧的，是否继续？", vbQuestion + vbYesNo + vbDefaultButton1, Me.Caption) = vbNo Then
                CheckInHosAdvice = True
                Exit Function
            End If
        End If
    End If
    
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub AdviceRSAddRow(ByRef rsAdvice As ADODB.Recordset, ByVal i As Long)
'功能：根据指定行的信息复制产生医嘱记录集的一行数据
    Dim lng组ID As Long, lng疾病ID As Long, j As Long
    On Error GoTo errH
    '获取疾病ID
    With vsDiag
        lng组ID = IIF(Val(vsAdvice.TextMatrix(i, COL_相关ID)) = 0, vsAdvice.RowData(i), Val(vsAdvice.TextMatrix(i, COL_相关ID)))
        For j = .FixedRows To .Rows - 1
            If InStr("," & .TextMatrix(j, col医嘱ID) & ",", "," & lng组ID & ",") > 0 Then
                lng疾病ID = Val(.TextMatrix(j, col疾病ID))
                Exit For
            End If
        Next
    End With
    
    With vsAdvice
        rsAdvice.AddNew
        rsAdvice!ID = .RowData(i)
        rsAdvice!相关ID = Val("" & .TextMatrix(i, COL_相关ID))
        rsAdvice!前提ID = mlng前提ID
        rsAdvice!病人来源 = 1
        rsAdvice!病人ID = mlng病人ID
        rsAdvice!挂号单 = mstr挂号单

        rsAdvice!婴儿 = Val("" & .TextMatrix(i, COL_婴儿))
        rsAdvice!姓名 = mstr姓名
        rsAdvice!性别 = mstr性别
        rsAdvice!年龄 = mint年龄
        rsAdvice!病人科室id = mlng病人科室id

        rsAdvice!序号 = .TextMatrix(i, COL_序号)
        rsAdvice!医嘱状态 = .TextMatrix(i, COL_状态)
        rsAdvice!医嘱期效 = 1
        rsAdvice!诊疗类别 = .TextMatrix(i, COL_类别)
        rsAdvice!诊疗项目ID = Val("" & .TextMatrix(i, COL_诊疗项目ID))
        rsAdvice!标本部位 = .TextMatrix(i, COL_标本部位)
        rsAdvice!检查方法 = .TextMatrix(i, COL_检查方法)

        rsAdvice!收费细目ID = Val("" & .TextMatrix(i, COL_收费细目ID))
        rsAdvice!天数 = Val("" & .TextMatrix(i, COL_天数))
        rsAdvice!单次用量 = Val("" & .TextMatrix(i, COL_单量))
        rsAdvice!总给予量 = Val("" & .TextMatrix(i, COL_总量))
        rsAdvice!医嘱内容 = .TextMatrix(i, col_医嘱内容)
        rsAdvice!医生嘱托 = .TextMatrix(i, COL_医生嘱托)
        rsAdvice!执行科室ID = Val("" & .TextMatrix(i, COL_执行科室ID))
        rsAdvice!执行频次 = .TextMatrix(i, COL_频率)
        rsAdvice!频率次数 = Val("" & .TextMatrix(i, COL_频率次数))
        rsAdvice!频率间隔 = Val("" & .TextMatrix(i, COL_频率间隔))
        rsAdvice!间隔单位 = .TextMatrix(i, COL_间隔单位)
        rsAdvice!执行时间方案 = .TextMatrix(i, COL_执行时间)
        rsAdvice!计价特性 = Val("" & .TextMatrix(i, COL_计价性质))
        rsAdvice!执行性质 = Val("" & .TextMatrix(i, COL_执行性质))
        rsAdvice!执行标记 = Val("" & .TextMatrix(i, COL_执行标记))

        rsAdvice!可否分零 = Val("" & .TextMatrix(i, COL_可否分零))
        rsAdvice!紧急标志 = Val("" & .TextMatrix(i, COL_标志))
        rsAdvice!开始执行时间 = .TextMatrix(i, COL_开始时间)
        rsAdvice!开嘱科室id = Val("" & .TextMatrix(i, COL_开嘱科室ID))
        rsAdvice!开嘱医生 = .TextMatrix(i, COL_开嘱医生)
        rsAdvice!开嘱时间 = CDate(.TextMatrix(i, COL_开嘱时间))
        rsAdvice!摘要 = .Cell(flexcpData, i, COL_医生嘱托)
        rsAdvice!疾病id = lng疾病ID
        rsAdvice!EditState = Val(.TextMatrix(i, COL_EDIT)) '1-新增，2－修改
        rsAdvice!用药目的 = Val("" & .TextMatrix(i, COL_用药目的))     '1-预防,2-治疗
        rsAdvice!用药理由 = .TextMatrix(i, COL_用药理由)
        rsAdvice.Update
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function zlPluginAdviceEnter(ByVal lngRow As Long) As Boolean
'功能：输入医嘱完成后调用外挂接口
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim rsAdvice As ADODB.Recordset
    
    Set rsAdvice = GetAdviceRs
    
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    For i = lngBegin To lngEnd
        If Val(vsAdvice.RowData(i)) <> 0 Then
            Call AdviceRSAddRow(rsAdvice, i)
        End If
    Next
    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
    Call CreatePlugInOK(p门诊医嘱下达, mint场合)
    On Error Resume Next
    zlPluginAdviceEnter = gobjPlugIn.AdviceEnter(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, rsAdvice, mint场合)
    If err.Number <> 0 And zlPluginAdviceEnter = False Then zlPluginAdviceEnter = True
    Call zlPlugInErrH(err, "AdviceEnter")
    err.Clear: On Error GoTo 0
End Function

Private Function zlPluginAdviceSave() As Boolean
'功能：医嘱保存前调用外挂接口
    Dim i As Long
    Dim rsAdvice As ADODB.Recordset
    Dim lngBegin As Long, lngEnd As Long
    Dim rsTmp As ADODB.Recordset
    
    Set rsAdvice = GetAdviceRs
    With vsAdvice
        '医嘱录入完成之后直接保存可能导到当前这行医嘱没有调用到外挂 AdviceEditAfter此处再调用一次。
        i = .Row
        If .RowData(i) <> 0 And (Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_EDIT)) = 2) Then
            Set rsTmp = zlDatabase.zlCopyDataStructure(rsAdvice)
            Call GetRowScope(i, lngBegin, lngEnd)
            For i = lngBegin To lngEnd
                If Val(vsAdvice.RowData(i)) <> 0 Then
                    Call AdviceRSAddRow(rsTmp, i)
                End If
            Next
            If rsTmp.RecordCount > 0 Then rsTmp.MoveFirst
        End If
            
        For i = .FixedRows To .Rows - 1
            '新增或修改的有效行(非空行)
            If .RowData(i) <> 0 And (.TextMatrix(i, COL_EDIT) = "2" Or .TextMatrix(i, COL_EDIT) = "1") Then
                Call AdviceRSAddRow(rsAdvice, i)
            End If
        Next
    End With
    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
    Call CreatePlugInOK(p门诊医嘱下达, mint场合)
    On Error Resume Next
    If Not (rsTmp Is Nothing) Then
        If rsTmp.RecordCount > 0 Then
            Call gobjPlugIn.AdviceEditAfter(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, rsTmp, mint场合)
            Call zlPlugInErrH(err, "AdviceEditAfter")
        End If
    End If
    zlPluginAdviceSave = gobjPlugIn.AdviceSave(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, rsAdvice, mint场合)
    If err.Number <> 0 And zlPluginAdviceSave = False Then zlPluginAdviceSave = True
    Call zlPlugInErrH(err, "AdviceSave")
    err.Clear: On Error GoTo 0
End Function

Private Sub zlPluginAdviceRowChange(ByVal lngRow As Long, Optional ByVal intType As Integer)
'功能：医嘱切换行后调用外挂接口
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim rsAdvice As ADODB.Recordset
    
    If Val(vsAdvice.RowData(lngRow)) = 0 Then Exit Sub
    Set rsAdvice = GetAdviceRs
    
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    For i = lngBegin To lngEnd
        If Val(vsAdvice.RowData(i)) <> 0 Then
            Call AdviceRSAddRow(rsAdvice, i)
        End If
    Next
    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
    Call CreatePlugInOK(p门诊医嘱下达, mint场合)
    On Error Resume Next
    
    If intType = 0 Then
        Call gobjPlugIn.AdviceRowChange(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, rsAdvice, mint场合)
        Call zlPlugInErrH(err, "AdviceRowChange")
    Else
        Call gobjPlugIn.AdviceEditAfter(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, rsAdvice, mint场合)
        Call zlPlugInErrH(err, "AdviceEditAfter")
    End If
    If err.Number <> 0 Then err.Clear
End Sub

Private Function CheckBackNo(ByVal str挂号单 As String) As Boolean
'功能：检查是否已经退号，或者是否已经取消接诊
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    
    strSQL = "Select ID From 病人挂号记录 Where 执行状态 In (0, -1) And NO = [1] And 记录性质=1 And 记录状态=1"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "zl_AdviceSendCheck", str挂号单)
    If rsTmp.RecordCount > 0 Then
        MsgBox "不能操作没有就诊的病人。", vbInformation, "门诊医嘱编辑"
        Exit Function
    End If
    
    strSQL = "Select ID From 门诊费用记录 Where 记录性质=4 And 记录状态=2 And NO = [1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "zl_AdviceSendCheck", str挂号单)
    If rsTmp.RecordCount > 0 Then
        MsgBox "不能操作已经退号的病人。", vbInformation, "门诊医嘱编辑"
        Exit Function
    End If
    CheckBackNo = True
    
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function


Private Sub Set安排时间(ByVal strType As String)
'功能：设置手术或输血医嘱的安排时间位置
'参数：strType=F-手术,K-输血

    If strType = "F" Then
        lbl安排时间.Caption = "手术时间"
        lbl安排时间.Top = lbl用法.Top
        txt安排时间.Top = txt用法.Top
    
        lbl安排时间.Left = lbl医嘱内容.Left
        txt安排时间.Left = txt用法.Left
    Else
        lbl安排时间.Caption = "输血时间"
        lbl安排时间.Top = lbl开始时间.Top
        txt安排时间.Top = msk开始时间.Top
    
        lbl安排时间.Left = lbl医生嘱托.Left
        txt安排时间.Left = cbo医生嘱托.Left
        
        'SetItemEditable中设置了显示“安排时间”就不显示“用法”
        lbl用法.Visible = True
        txt用法.Visible = True
        cmd用法.Visible = True
    End If
    
    cmd安排时间.Top = txt安排时间.Top + 30
    cmd安排时间.Left = txt安排时间.Left + txt安排时间.Width - cmd安排时间.Width - 30
End Sub


Private Sub SetCbo执行性质(ByVal bln含自备药 As Boolean, ByVal bln临床自管药 As Boolean)
    cbo执行性质.Clear
    
    If bln临床自管药 Then
        cbo执行性质.AddItem "1-自备药"
    Else
        cbo执行性质.AddItem "0-正常"
        If bln含自备药 Then cbo执行性质.AddItem "1-自备药"
        cbo执行性质.AddItem "2-离院带药"
    End If
End Sub


Private Sub txt用药理由_GotFocus()
    zlControl.TxtSelAll txt用药理由
    Call zlCommFun.OpenIme(True)
End Sub

Private Sub txt用药理由_LostFocus()
    Call zlCommFun.OpenIme(False)
End Sub

Private Sub txt用药理由_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt用药理由.Text <> "" And vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) <> "K" Then
            If ReasonSelect(txt用药理由.Text, 1) Then Exit Sub
        End If
        If SeekNextControl Then Call txt用药理由_Validate(False)
    End If
End Sub

Private Sub txt用药理由_Change()
    txt用药理由.Tag = "1"
End Sub

Private Sub txt用药理由_Validate(Cancel As Boolean)
    If zlCommFun.ActualLen(txt用药理由.Text) > 1000 Then
        MsgBox "输入内容不过超过 500 个汉字或 1000 个字符。", vbInformation, gstrSysName
        txt用药理由_GotFocus
        Cancel = True: Exit Sub
    End If
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub cboDruPur_Click()
    lbl用药目的.Tag = "1"
    Call AdviceChange
End Sub

Private Sub cboDruPur_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        SeekNextControl
    End If
End Sub

Private Sub SetRow标志图标(ByVal i As Long, Optional ByVal bytMode As Byte)
'功能：根据当前行的状态，设置标志列的图标显示
'参数：i=当前行
'      bytMode=一并给药时传入，0-根据传入行的状态处理组内首行，1-传入行是组内首行时才处理,2-只处理传入行
    Dim blnFirst As Boolean, lngRow As Long
    Dim int图标数 As Integer '医嘱内容上面的图标个数
    
    With vsAdvice
        '自由录入
        If Val(.TextMatrix(i, COL_诊疗项目ID)) = 0 Then
             Set .Cell(flexcpPicture, i, COL_F标志) = frmIcons.imgFlag.ListImages("自由").Picture
             .Cell(flexcpPictureAlignment, i, COL_F标志) = 4
        Else
            blnFirst = True
            lngRow = i
            '一并给药的图标只显示在第一行(审核状态除外)
            If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                If bytMode > 0 Then
                    If bytMode = 1 Then
                        '判断传入行是组内首行时才处理(可能还没有设置给药途径)
                        If Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(i - 1, COL_相关ID)) And Val(.TextMatrix(i, COL_相关ID)) <> 0 Then blnFirst = False
                    Else
                        '只处理传入的行(取消一并时)
                    End If
                Else
                    '根据传入行的状态处理组内首行
                    lngRow = .FindRow(.TextMatrix(i, COL_相关ID), , COL_相关ID)
                End If
            End If
        
            If blnFirst Then
                If .TextMatrix(i, COL_标志) = "2" Then
                    Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("补录").Picture
                ElseIf .TextMatrix(i, COL_标志) = "1" Then
                    Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("紧急").Picture
                Else
                    Set .Cell(flexcpPicture, lngRow, COL_F标志) = Nothing
                End If
            
                '一并给药显示在第一行
                If Val(.TextMatrix(i, COL_状态)) < 2 Then   '新开或暂存的医嘱
                    Select Case Val(.TextMatrix(i, COL_审核状态))
                    '0-无需审核，1-待审核，2-审核通过，3-审核未通过
                        Case 1
                            If .TextMatrix(i, COL_类别) = "K" And Val(.TextMatrix(i, COL_检查方法)) = 1 Then
                                '用血医嘱审核图标单独显示(表明是有医生核对)
                                Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("核对").Picture
                            Else
                                Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("待审核").Picture
                            End If
                        Case 2
                            If Not (.TextMatrix(i, COL_类别) = "K" And Val(.TextMatrix(i, COL_检查方法)) = 1) Then
                                Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("审核通过").Picture
                            End If
                        Case 3
                            Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("审核未通过").Picture
                        Case 4, 5
                            If gbln血库系统 = False Then Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("待审核").Picture
                        Case 7
                            Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("待签发").Picture
                    End Select
                End If
                '处方审查系统
                If .TextMatrix(i, COL_处方审查状态) = "0" Then
                    Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("待审核").Picture
                ElseIf .TextMatrix(i, COL_处方审查状态) = "2" Or .TextMatrix(i, COL_处方审查结果) = "1" Then
                    '超时免审当作合格处理
                    Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("审核通过").Picture
                ElseIf .TextMatrix(i, COL_处方审查结果) = "2" Then
                    ' 不合格
                    Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("审核未通过").Picture
                End If
                .Cell(flexcpPictureAlignment, lngRow, COL_F标志) = 4
            End If
            
            If Val(.TextMatrix(i, COL_签名否)) = 1 Then
                Set .Cell(flexcpPicture, i, col_医嘱内容) = frmIcons.imgSign.ListImages("签名").Picture
                int图标数 = 1
            End If
            
            If Val(.TextMatrix(i, COL_高危药品)) > 0 Then
                If .Cell(flexcpPicture, i, col_医嘱内容) Is Nothing Then
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = frmIcons.imgQuestion.ListImages("高危药品").Picture
                    int图标数 = 1
                Else
                    If .Cell(flexcpPicture, i, col_医嘱内容) <> frmIcons.imgQuestion.ListImages("高危药品").Picture Then
                        pictmp.PaintPicture vsAdvice.Cell(flexcpPicture, i, col_医嘱内容), 0, 0, pictmp.Width / 2, pictmp.Height
                        pictmp.PaintPicture frmIcons.imgQuestion.ListImages("高危药品").Picture, pictmp.Width / 2, 0, pictmp.Width / 2, pictmp.Height
                        Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                        int图标数 = 2
                    End If
                End If
            End If
            '危急值图标
            If mlng危急值ID > 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_危急值ID)) > 0 Then
                If int图标数 = 0 Then
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = frmIcons.imgQuestion.ListImages("危急值").Picture
                ElseIf int图标数 = 1 Then
                    pictmp.Cls
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, pictmp.Width / 2, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("危急值").Picture, pictmp.Width / 2, 0, pictmp.Width / 2, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    int图标数 = 2
                ElseIf int图标数 = 2 Then
                    pictmp.Cls
                    pictmp.Width = 720
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, 480, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("危急值").Picture, 480, 0, 240, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    pictmp.Width = 480
                    int图标数 = 3
                End If
            End If
            
            '易跌倒图标
            If Val(.TextMatrix(i, COL_易跌倒)) > 0 Then
                If int图标数 = 0 Then
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = frmIcons.imgQuestion.ListImages("易跌倒").Picture
                ElseIf int图标数 = 1 Then
                    pictmp.Cls
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, pictmp.Width / 2, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("易跌倒").Picture, pictmp.Width / 2, 0, pictmp.Width / 2, pictmp.Height
                    Set vsAdvice.Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    int图标数 = 2
                ElseIf int图标数 = 2 Then
                    pictmp.Cls
                    pictmp.Width = 720
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, 480, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("易跌倒").Picture, 480, 0, 240, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    pictmp.Width = 480
                    int图标数 = 3
                ElseIf int图标数 = 3 Then
                    pictmp.Cls
                    pictmp.Width = 960
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, 720, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("易跌倒").Picture, 720, 0, 240, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    pictmp.Width = 480
                    int图标数 = 4
                End If
            End If
            
        End If
    End With
End Sub

Private Sub ShowOrHideQuestion()
'功能：显示或隐藏抗菌用药审核未通过的说明
    Dim strMsg As String
    
    If lbl疑问.Caption <> "" Then lbl疑问.Caption = ""
    
    If Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_审核状态)) = 3 Then
        strMsg = GetKSSAuditQuestion(Val(vsAdvice.RowData(vsAdvice.Row)))
        If strMsg <> "" Then lbl疑问.Caption = "审核反馈：" & strMsg
        
    End If
    pic疑问.Visible = lbl疑问.Caption <> ""
    
    Call Form_Resize
End Sub

Private Sub ReSet审核状态图标(ByVal lngRow As Long)
'功能：删除或修改一并给药中的一行医嘱后，重设组中首行的图标和抗菌药嘱行的审核状态
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim blnDo As Boolean
    
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    
    '如果有审核未通过的，删除后变为待审核
    With vsAdvice
        For i = lngBegin To lngEnd
            If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And .TextMatrix(i, COL_标志) <> "1" Then
                .TextMatrix(i, COL_审核状态) = 1
            Else
                .TextMatrix(i, COL_审核状态) = ""   'CheckAdvice中会将一组的设置为相同
            End If
            If .TextMatrix(i, COL_审核状态) <> "" Then
                Set .Cell(flexcpPicture, lngBegin, COL_F标志) = frmIcons.imgFlag.ListImages("待审核").Picture
                .Cell(flexcpPictureAlignment, lngBegin, COL_F标志) = 4
                blnDo = True
            End If
        Next
        If blnDo = False Then Set .Cell(flexcpPicture, lngBegin, COL_F标志) = Nothing
    End With
End Sub

Private Sub SetMediInfoItem(ByVal bln显示单量 As Boolean, ByVal bln显示抗菌药物 As Boolean)
'功能：隐藏或显示药品相关的信息项目：首次用量，超量说明，用药目的，用药理由
    Dim lngHeight As Long, lngHeightOld As Long
    Dim bytHideType As Byte
        
    lngHeightOld = fraAdvice.Height
    lngHeight = cbo附加执行.Top + cbo附加执行.Height + 60
    
    If bln显示单量 Or bln显示抗菌药物 Then
        If bln显示抗菌药物 = False Then
            lngHeight = lngHeight + txt超量说明.Height + 90
        Else
            lngHeight = lngHeight + txt超量说明.Height + 90 + txt用药理由.Height + 90
        End If
    End If
    
    If lngHeightOld <> lngHeight Then
        fraAdvice.Height = lngHeight
        '处理滚动条bug
        fraAdvice.Tag = "不滚动"
        Call cbsMain_Resize
        '需要调用两次才能生效
        fraAdvice.Tag = ""
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
    End If
End Sub

Private Sub SetFontSize(ByVal bytSize As Byte)
'功能：进行界面字体的统一设置
'参数：bytSize  0-9号字体，1-12号字体
    mblnSizeTmp = True
    Call zlControl.SetPubFontSize(Me, bytSize)
    mblnSizeTmp = False
    Call SetCtrlPos
End Sub

Private Sub SetCtrlPos()
'功能：设置控件位置,请注意所有控件位置的设置尽可能在此函数中设置
    Dim lngDistance1 As Long, lngDistance2 As Long
    Dim lngHeight As Long

    lngDistance1 = 30: lngDistance2 = 180
    Call zlControl.SetPubCtrlPos(False, 0, lblPati, lngDistance2, lblMoney, lngDistance1, lblLink, lngDistance1, optState(0), lngDistance1, optState(1))
 
    cmdLastDiag.Top = lbl诊断.Top + lbl诊断.Height + 60
    Call zlControl.SetPubCtrlPos(True, -1, lbl诊断, 60, cmdLastDiag)
    vsDiag.Left = cmdLastDiag.Left + cmdLastDiag.Width + lngDistance1
    opt诊断(0).Left = vsDiag.Left + vsDiag.Width + lngDistance1 * 2
    opt诊断(1).Left = opt诊断(0).Left
    fra诊断.Height = vsDiag.Top + vsDiag.Height + 120
    
    '垂直设置控件位置
    lbl开始时间.Left = 120
    lbl开始时间.Top = 225
    lbl滴速.Top = 225
    '先设置左边第一行控件，其次设置右边控件位置，最后设置左边控件位置，目的为了设置医嘱内容高度
    '左边第一排，为了地位第一排右边控件位置
    Call zlControl.SetPubCtrlPos(False, 0, lbl开始时间, lngDistance1, msk开始时间, -1 * cmd开始时间.Width, cmd开始时间, lngDistance2, chk紧急, lngDistance2, chk免试)
    lbl滴速.Left = chk免试.Left + chk免试.Width + 5 * lngDistance2
    
    '设置右边控件位置
    Call zlControl.SetPubCtrlPos(True, 1, lbl滴速, lngDistance2, lbl医生嘱托, lngDistance2, lbl执行时间, lngDistance2, lbl执行科室, lngDistance2, lbl附加执行, lngDistance2, lbl超量说明)
    Call zlControl.SetPubCtrlPos(False, 0, lbl滴速, lngDistance1, cbo滴速, lngDistance1, lbl滴速单位, lngDistance2, chkZeroBilling)
    Call zlControl.SetPubCtrlPos(False, 0, lbl医生嘱托, lngDistance1, cbo医生嘱托, -1 * cmd医生嘱托.Width, cmd医生嘱托, lngDistance1, cmd常用嘱托)
    Call zlControl.SetPubCtrlPos(False, 0, lbl执行时间, lngDistance1, cbo执行时间)
    Call zlControl.SetPubCtrlPos(False, 0, lbl执行科室, lngDistance1, cbo执行科室, lngDistance2, lbl执行性质, lngDistance1, cbo执行性质)
    Call zlControl.SetPubCtrlPos(False, 0, lbl附加执行, lngDistance1, cbo附加执行, lngDistance2, lblBYZX, lngDistance1, txtBYZX, lngDistance1, lblBYZXCS)
    Call zlControl.SetPubCtrlPos(False, 0, lbl超量说明, lngDistance1, txt超量说明, -1 * cmdExcReason.Width, cmdExcReason, lngDistance1, cmdComExcReason, -1 * cmdZYRemark.Width, cmdZYRemark)
    cbo执行时间.Width = cmd常用嘱托.Left + cmd常用嘱托.Width - cbo执行时间.Left
    cbo执行性质.Width = cmd常用嘱托.Left + cmd常用嘱托.Width - cbo执行性质.Left
    txt超量说明.Width = cmd医生嘱托.Left + cmd医生嘱托.Width - txt超量说明.Left - 80
    
    '设置左边控件位置
    txt医嘱内容.Height = msk开始时间.Height '为了中部对齐
    Call zlControl.SetPubCtrlPos(True, 1, lbl开始时间, lngDistance2, lbl医嘱内容, lbl执行科室.Top - lbl医生嘱托.Top - lbl医生嘱托.Height + lngDistance2 + 180, lbl用法, -1 * lbl安排时间.Height, lbl安排时间, lngDistance2, lbl总量, lngDistance2 + 10, lbl用药目的)
    Call zlControl.SetPubCtrlPos(False, 0, lbl医嘱内容, lngDistance1, txt医嘱内容, lngDistance1, cmdExt)
    cmdSel.Top = cmdExt.Top + cmdExt.Height + 120
    cmdSel.Left = cmdExt.Left
    Call zlControl.SetPubCtrlPos(False, 0, cmdSel, lngDistance1, picHelp)
    txt医嘱内容.Height = cbo执行科室.Top + cbo执行科室.Height - txt医嘱内容.Top
    lbl安排时间.Top = IIF(mbytSize = 0, lbl安排时间.Top, lbl安排时间.Top + 100)
    Call zlControl.SetPubCtrlPos(False, 0, lbl安排时间, -1 * lbl用法.Width, lbl用法, lngDistance1, txt安排时间, -1 * cmd安排时间.Width, cmd安排时间, -1 * txt用法.Width, txt用法, -1 * cmd用法.Width, cmd用法, lngDistance2, lbl频率, lngDistance1, txt频率, -1 * cmd频率.Width, cmd频率)
    txt频率.Width = txt医嘱内容.Width + txt医嘱内容.Left - txt频率.Left
    cmd频率.Left = txt医嘱内容.Width + txt医嘱内容.Left - cmd频率.Width
    lbl总量.Top = IIF(mbytSize = 0, lbl总量.Top, lbl总量.Top + 100)
    Call zlControl.SetPubCtrlPos(False, 0, lbl总量, lngDistance1, txt总量, lngDistance1, lbl总量单位, -1 * lbl天数.Width, lbl天数, -1 * (txt天数.Width + Me.TextWidth("字")), txt天数, lngDistance2, lbl单量, lngDistance1, txt单量, lngDistance1, lbl单量单位)
    lbl用药目的.Top = IIF(mbytSize = 0, lbl用药目的.Top - 50, lbl用药目的.Top + 100)
    Call zlControl.SetPubCtrlPos(False, 0, lbl用药目的, lngDistance1, cboDruPur, lngDistance2, lbl用药理由, lngDistance1, txt用药理由, -1 * cmdReason.Width, cmdReason, 0.5 * lngDistance1, cmd收藏用药理由)
    lbl单量单位.Left = txt医嘱内容.Width + txt医嘱内容.Left - lbl单量单位.Width
    txt单量.Width = lbl单量单位.Left - lngDistance1 - txt单量.Left
    
    If Me.WindowState <> vbMaximized And Me.WindowState <> vbMinimized Then
        fraAdvice.Width = cmd常用嘱托.Left + cmd常用嘱托.Width + 1000
    End If
    
End Sub

Private Sub CheckDrugOutOfRange(ByVal lngRow As Long, ByVal sngDays As Single)
'功能：检查药品用量或天数是否超过允许的范围,并且弹出选择提示
'返回：选择是否继续
    Dim blnReturn As Boolean
    Dim strOld As String
    
    strOld = vsAdvice.TextMatrix(lngRow, COL_是否超期)

    If sngDays > IIF(mbytPatiType = 1, conOrdinary, conEmergency) And vsAdvice.TextMatrix(lngRow, COL_超量说明) = "" Then
        vsAdvice.TextMatrix(lngRow, COL_是否超期) = "1"
    Else
        vsAdvice.TextMatrix(lngRow, COL_是否超期) = ""
    End If
    If strOld <> vsAdvice.TextMatrix(lngRow, COL_是否超期) Then
        lbl超量说明.Tag = "1"
    End If
End Sub


Private Sub Set用药天数是否超期(ByVal lngRow As Long)
'功能：根据给定医嘱行的总量、单量和频率信息计算天数，并且设置“是否超期”列的值
    Dim sng天数 As Single
    
    With vsAdvice
        If RowIn配方行(lngRow) And Val(.TextMatrix(lngRow, COL_总量)) > 0 Then
            sng天数 = Val(.TextMatrix(lngRow, COL_总量))
        Else
            If mbln天数 Then
                sng天数 = Val(.TextMatrix(lngRow, COL_天数))
            ElseIf Val(.TextMatrix(lngRow, COL_总量)) <> 0 And Val(.TextMatrix(lngRow, COL_单量)) <> 0 _
                And .TextMatrix(lngRow, COL_频率) <> "" And Val(.TextMatrix(lngRow, COL_频率次数)) <> 0 And Val(.TextMatrix(lngRow, COL_频率间隔)) <> 0 _
                And Val(.TextMatrix(lngRow, COL_剂量系数)) <> 0 And Val(.TextMatrix(lngRow, COL_门诊包装)) <> 0 Then
                
                sng天数 = Calc缺省药品天数(Val(.TextMatrix(lngRow, COL_总量)), Val(.TextMatrix(lngRow, COL_单量)), _
                    Val(.TextMatrix(lngRow, COL_频率次数)), Val(.TextMatrix(lngRow, COL_频率间隔)), .TextMatrix(lngRow, COL_间隔单位), _
                    Val(.TextMatrix(lngRow, COL_剂量系数)), Val(.TextMatrix(lngRow, COL_门诊包装)), _
                    Val(.TextMatrix(lngRow, COL_可否分零)))
            End If
        End If
        
        If sng天数 > IIF(mbytPatiType = 1, conOrdinary, conEmergency) Then
            .TextMatrix(lngRow, COL_是否超期) = "1"
        Else
            .TextMatrix(lngRow, COL_是否超期) = ""
        End If
        
    End With
End Sub

Private Function ReGet药品总量(ByVal dbl原总量 As Double, ByVal dbl单量 As Double, ByVal sng天数 As Long, ByVal lngRow As Long) As Double
'功能：重新根据单量、天数及当前行的频率信息等计算总量
'返回：计算的总量
    Dim dbl总量 As Double
    
    ReGet药品总量 = dbl原总量
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_频率) <> "" And Val(.TextMatrix(lngRow, COL_频率次数)) <> 0 And Val(.TextMatrix(lngRow, COL_频率间隔)) <> 0 _
            And dbl单量 <> 0 And Val(.TextMatrix(lngRow, COL_剂量系数)) <> 0 And Val(.TextMatrix(lngRow, COL_门诊包装)) <> 0 Then
            
            dbl总量 = FormatEx(Calc缺省药品总量(dbl单量, sng天数, _
                Val(.TextMatrix(lngRow, COL_频率次数)), Val(.TextMatrix(lngRow, COL_频率间隔)), _
                .TextMatrix(lngRow, COL_间隔单位), .TextMatrix(lngRow, COL_执行时间), _
                Val(.TextMatrix(lngRow, COL_剂量系数)), Val(.TextMatrix(lngRow, COL_门诊包装)), _
                Val(.TextMatrix(lngRow, COL_可否分零))), 5)
                
            
            If InStr(GetInsidePrivs(p门诊医嘱下达), "药品小数输入") = 0 Then
                dbl总量 = IntEx(dbl总量)
            ElseIf Val(.TextMatrix(lngRow, COL_可否分零)) <> 0 Then
                dbl总量 = IntEx(dbl总量)
            End If
        End If
    End With
    ReGet药品总量 = dbl总量
End Function

Private Sub Set医嘱超量(ByVal lngBegin As Long, ByVal lngEnd As Long)
'功能：为指定范围内的医嘱设置超标记 .TextMatrix(i, COL_是否超量) .TextMatrix(i, COL_超量说明)
    Dim dbl总量 As Double
    Dim lng相关ID As Long
    Dim i As Long
    Dim j As Long
    
    With vsAdvice
        For i = lngBegin To lngEnd
            If .RowData(i) = 0 Then Exit Sub
            .TextMatrix(i, COL_是否超量) = ""
            If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 And Val(.TextMatrix(i, COL_处方限量)) > 0 Then
                dbl总量 = Val(.TextMatrix(i, COL_总量)) * Val(.TextMatrix(i, COL_门诊包装)) * Val(.TextMatrix(i, COL_剂量系数))
                If dbl总量 > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
                If .TextMatrix(i, COL_是否超量) = "" And .TextMatrix(i, COL_是否超期) = "" Then .TextMatrix(i, COL_超量说明) = ""
            ElseIf Val(.TextMatrix(i, COL_类别)) = 7 And Val(.TextMatrix(i, COL_处方限量)) > 0 Then  '中药
                dbl总量 = Val(.TextMatrix(i, COL_单量)) * Val(.TextMatrix(i, COL_总量))
                If dbl总量 > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
            ElseIf .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "4" Then
                lng相关ID = .RowData(i)
                For j = i - 1 To .FixedRows Step -1
                    If Val(.TextMatrix(j, COL_相关ID)) = lng相关ID Then
                        If .TextMatrix(j, COL_是否超量) = "1" Then
                            .TextMatrix(i, COL_是否超量) = "1"
                            .TextMatrix(j, COL_是否超量) = ""
                        End If
                    Else
                        Exit For
                    End If
                Next
            ElseIf Val(.TextMatrix(i, COL_处方限量)) > 0 Then '其他诊疗项目
                If Val(.TextMatrix(i, COL_总量)) > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
            End If
            If .TextMatrix(i, COL_是否超量) = "" And .TextMatrix(i, COL_是否超期) = "" Then .TextMatrix(i, COL_超量说明) = ""
        Next
    End With
End Sub

Private Function GetInsureStr(ByRef strIDs1 As String, ByRef strIDs2 As String, ByRef str医嘱内容 As String, ByVal lngRow As Long) As Boolean
'功能：获取医保对码的字符串
'   strIDs1:药品卫材的收费细目ID字符串，strIDs2 ：其他诊疗项目的诊疗项目ID:执行科室字符串
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    With vsAdvice
        '为利用索引,用Union方式
        For i = lngBegin To lngEnd
            If Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                If InStr(",4,5,6,7,", .TextMatrix(i, COL_类别)) > 0 Then
                    '药品、卫材无对应关系,药品只处理按规格下达时
                    If Val(.TextMatrix(i, COL_收费细目ID)) <> 0 And InStr("," & strIDs1 & ",", "," & Val(.TextMatrix(i, COL_收费细目ID)) & ",") = 0 Then
                        strIDs1 = strIDs1 & "," & .TextMatrix(i, COL_收费细目ID)
                    End If
                ElseIf InStr("," & strIDs2 & ",", "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & ",") = 0 Then
                    '包含了收费数量为0的
                    strIDs2 = strIDs2 & "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & ":" & Val(.TextMatrix(i, COL_执行科室ID))
                End If
            End If
        Next
        str医嘱内容 = Left(vsAdvice.TextMatrix(lngRow, col_医嘱内容), 50)
    End With
End Function

Private Function SetAll超量说明(ByVal lngRow As Long, ByRef blnOut As Boolean) As Boolean
'功能：检查没有写超量说明的医嘱然后为其添加超量说明
'参数：lngRow开始行号
'      blnOut 表示弹出了输入界面但没填写任何内容
    Dim i As Long
    Dim strTmp As String
    Dim str配方 As String
    Dim str行IDs As String '需要填写超量说明的医嘱行号
    Dim str超量说明 As String
    Dim strMsg As String
    Dim varArr As Variant
    
    With vsAdvice
        For i = lngRow To .Rows - 1
            If (.TextMatrix(i, COL_是否超量) = "1" Or .TextMatrix(i, COL_是否超期) = "1") And .TextMatrix(i, COL_超量说明) = "" Then
                Select Case (Val(.TextMatrix(i, COL_是否超量)) - Val(.TextMatrix(i, COL_是否超期)))
                    Case 1
                        strTmp = "超出了处方限量，请填写超量说明。"
                    Case -1
                        strTmp = "超出了用药疗程(" & IIF(mbytPatiType = 1, conOrdinary, conEmergency) & "天)，请填写超量说明。"
                    Case 0
                        strTmp = "超出了处方限量和用药疗程(" & IIF(mbytPatiType = 1, conOrdinary, conEmergency) & "天)，请填写超量说明。"
                End Select
                If .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "4" Then '中草药的超量标志放到了显示行，只能大概提示
                    str配方 = .TextMatrix(i, col_医嘱内容)
                    str配方 = "中草药配方：" & Mid(str配方, InStr(str配方, ":") + 1)
                    strMsg = strMsg & """" & str配方 & """" & strTmp
                Else
                    strMsg = strMsg & """" & .TextMatrix(i, col_医嘱内容) & """" & strTmp
                End If
                str行IDs = str行IDs & "," & i
            End If
        Next
    End With
    str行IDs = Mid(str行IDs, 2)
    
    If strMsg <> "" And str行IDs <> "" Then
        Call frmMsgDruExcess.ShowMe(Me, 0, strMsg, str超量说明)
    Else
        SetAll超量说明 = True
        Exit Function
    End If
    
    If str超量说明 = "*NULL*" Then 'str超量说明 = "*NULL*" 表示没有填写任何东西
        blnOut = True
    ElseIf str超量说明 <> "" Then  'str超量说明 = "" 表示没有执行 frmMsgDruExcess.ShowMe(Me, strMsg, str超量说明)
        varArr = Split(str行IDs, ",")
        For i = 0 To UBound(varArr)
            vsAdvice.TextMatrix(Val(varArr(i)), COL_超量说明) = str超量说明
        Next
    End If
    SetAll超量说明 = True
End Function

Private Function CheckAutoMerge(ByVal lngRow As Long) As Integer
'功能：自动判断溶媒进行自动一并给药和取消一并
        '判断溶媒，自动一并/取消一并
        '如果上一行医嘱是输液药品，当前输入的也是输液药品时：
        '1、如果当前录入的是药品，如果前面一组液体中，溶媒是第一个，那么自动为“一并”状态。
        '2、如果当前录入的是药品，如果前面一组液体中，溶媒是最后一个（上一条医嘱），那么自动取消“一并”状态（后输入溶媒的情况）。
        '3、如果当前行录入的溶媒（药品特性.溶媒），则判断如果一组液体中已经存在一个溶媒时，则自动取消“一并”状态（先输入溶媒的情况）。
'参数：lngRow=当前行
'返回：0-不做处理，1-一并给药，2-取消一并给药
    Dim i As Long, j As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim lngPreRow As Long
    
    With vsAdvice
        lngPreRow = GetPreRow(lngRow) '取上一有效行,某些内容缺省与上一行相同
        If lngPreRow <> -1 Then
            If InStr(",5,6,", .TextMatrix(lngPreRow, COL_类别)) > 0 Then
                i = .FindRow(CLng(.TextMatrix(lngPreRow, COL_相关ID)), lngPreRow + 1)
                If .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "2" And .TextMatrix(i, COL_执行分类) = "1" Then
                    j = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    If .TextMatrix(j, COL_类别) = "E" And .TextMatrix(j, COL_操作类型) = "2" And .TextMatrix(j, COL_执行分类) = "1" Then
                        If RowCanMerge(lngPreRow, lngRow) Then
                            '获取上一条医嘱的开始行号
                            Call GetRowScope(i, lngBegin, lngEnd)
                            If mblnRowMerge = False Then
                                '第一行是溶媒(1)
                                If Val(.TextMatrix(lngBegin, COL_是否溶媒)) = 1 And Val(.TextMatrix(lngRow, COL_是否溶媒)) <> 1 Then
                                    CheckAutoMerge = 1
                                End If
                            Else
                                '当前行是溶媒，前面已经存在溶媒了(3)
                                If Val(.TextMatrix(lngRow, COL_是否溶媒)) = 1 Then
                                    For i = lngBegin To lngEnd
                                        If Val(.TextMatrix(i, COL_是否溶媒)) = 1 Then
                                            CheckAutoMerge = 2
                                            Exit For
                                        End If
                                    Next
                                Else
                                    '当前是药品，上一行是溶媒，但又不是第一行时(2)
                                    If Val(.TextMatrix(lngPreRow, COL_是否溶媒)) = 1 And lngPreRow <> lngBegin Then
                                        CheckAutoMerge = 2
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
    End With
End Function

Private Sub SetCtlBkc()
'功能：设置控件背景色
    vsLIS.BackColor = vbWindowBackground
    vsPAC.BackColor = vbWindowBackground
    vsDRU.BackColor = vbWindowBackground
End Sub

Private Sub tbrAdd_Click()
'功能：触发医嘱新增功能
    cbsMain.FindControl(, conMenu_New, True, True).Execute
End Sub

Private Sub picPanel_Resize(Index As Integer)
    Dim objPic As Object
    Dim lngTmp As Long
    
    On Error Resume Next
    
    Set objPic = picPanel(Index)
    Select Case Index
    Case e医嘱下达
    Case e门诊病历
    Case e复诊病历
    Case e常用项目
        tbcItem(tbc成套).Top = 0
        tbcItem(tbc成套).Left = 0
        tbcItem(tbc成套).Width = objPic.Width
        tbcItem(tbc成套).Height = 1600
        
        tbcItem(tbc检验).Top = tbcItem(tbc成套).Height
        tbcItem(tbc检验).Left = 0
        tbcItem(tbc检验).Width = objPic.Width
        tbcItem(tbc检验).Height = 2000
        
        
        tbcItem(tbc检查).Top = tbcItem(tbc成套).Height + tbcItem(tbc检验).Height
        tbcItem(tbc检查).Left = 0
        tbcItem(tbc检查).Width = objPic.Width
        tbcItem(tbc检查).Height = 2000
        
        tbcItem(tbc药品).Top = tbcItem(tbc成套).Height + tbcItem(tbc检验).Height + tbcItem(tbc检查).Height
        tbcItem(tbc药品).Left = 0
        tbcItem(tbc药品).Width = objPic.Width
        tbcItem(tbc药品).Height = objPic.Height - tbcItem(tbc药品).Top
        
        Call picPanel_Resize(e成套方案)
        Call picPanel_Resize(e常用检验)
        Call picPanel_Resize(e常用检查)
        Call picPanel_Resize(e常用药品)
    Case e诊断表格
        objPic.Width = IIF(mbytSize = 0, 4800, 6800)
        objPic.Height = 2700
        objPic.Top = fra诊断.Top + fra诊断.Height
        objPic.Left = fra诊断.Left + IIF(mbytSize = 0, 2800, 3050)

        vsDiagComm.Top = 0
        vsDiagComm.Height = 1500
        vsDiagComm.Left = 0
        vsDiagComm.Width = objPic.Width
        
        vsDiagBefore.Top = vsDiagComm.Height
        vsDiagBefore.Height = 1200
        vsDiagBefore.Left = 0
        vsDiagBefore.Width = objPic.Width
            
    Case e成套方案
        lblCTFW.Move 50, 10, lblCTFW.Width, lblCTFW.Height
        lblCTN.Move lblCTFW.Left + lblCTFW.Width + 500, 10, lblCTN.Width, lblCTN.Height
        With vsScheme
            .Top = lblCTFW.Height + 45
            .Left = 0
            .Width = objPic.Width
            .Height = objPic.Height - .Top
        End With
    Case e常用检验
        vsLIS.Move 0, 0, objPic.Width, objPic.Height
    Case e常用检查
        vsPAC.Move 0, 0, objPic.Width, objPic.Height
    Case e常用药品
        vsDRU.Move 0, 0, objPic.Width, objPic.Height
    End Select
End Sub

Private Sub InitTBCItem()
'功能：初始化常用项目卡片TabControl
    Dim i As Long, j As Long
    
    For i = 0 To 3
        '初始化选项卡
        With tbcItem(i)
            With .PaintManager
                .Appearance = xtpTabAppearanceVisio
                .ClientFrame = xtpTabFrameNone
                
                .Color = xtpTabColorOffice2003
                .OneNoteColors = True
                
                .Layout = xtpTabLayoutAutoSize
                .BoldSelected = True
                .HotTracking = True
            End With
            
            For j = 0 To i
                Call .InsertItem(j, "-", picPanel(e临时用).hwnd, 0)
            Next
            
            Call .RemoveAll
        End With
    Next
    
    Call tbcItem(tbc成套).InsertItem(0, "成套方案", picPanel(e成套方案).hwnd, 0)
    Call tbcItem(tbc检验).InsertItem(0, "常用检验", picPanel(e常用检验).hwnd, 0)
    Call tbcItem(tbc检查).InsertItem(0, "常用检查", picPanel(e常用检查).hwnd, 0)
    Call tbcItem(tbc药品).InsertItem(0, "常用药品", picPanel(e常用药品).hwnd, 0)
End Sub

Private Sub InitDefaultScheme()
'功能：窗体加载时显示一个可用的成套方案
    Dim rsTmp As ADODB.Recordset
    Dim i As Long
    
    On Error GoTo errH
    
    vsScheme.Cols = 1
    vsScheme.ColAlignment(0) = flexAlignLeftCenter
 
    Set rsTmp = GetSchemeClass(0)
 
    lblCTFW.Caption = "本人"
    If rsTmp.EOF Then
        Set rsTmp = GetSchemeClass(1)
        i = 1
        lblCTFW.Caption = "本科"
        If rsTmp.EOF Then
            i = 2
            lblCTFW.Caption = "全院"
            Set rsTmp = GetSchemeClass(2)
        End If
    End If
    
    If rsTmp.EOF Then
        lblCTN.Caption = "无成套分类"
        vsScheme.Rows = 0
        vsScheme.Rows = 1
    Else
        lblCTN.Caption = rsTmp!成套分类
        Call ReLoadScheme(i, Val(rsTmp!ID))
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub lblCTFW_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim objPopup As CommandBar
    Dim objControl As CommandBarControl
    Dim vRect As RECT
    
    On Error GoTo errH
    
    Set objPopup = cbsMain.Add("Popup", xtpBarPopup)
    
    With objPopup.Controls
         
        Set objControl = .Add(xtpControlButton, conMenu_SchemeInSide * 100# + 1, "本人")
        objControl.Parameter = 0
        
        Set objControl = .Add(xtpControlButton, conMenu_SchemeInSide * 100# + 2, "本科")
        objControl.Parameter = 1
        
        Set objControl = .Add(xtpControlButton, conMenu_SchemeInSide * 100# + 3, "全院")
        objControl.Parameter = 2
         
    End With
    
    GetWindowRect picPanel(e成套方案).hwnd, vRect
    objPopup.ShowPopup , vRect.Left * Screen.TwipsPerPixelX + lblCTFW.Left + lblCTFW.Width, vRect.Top * Screen.TwipsPerPixelY + lblCTFW.Top
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub lblCTN_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim objPopup As CommandBar
    Dim objControl As CommandBarControl
    Dim vRect As RECT
    Dim rsTmp As ADODB.Recordset
    Dim intType As Integer
    Dim i As Long
    Dim strTmp As String
    
    On Error GoTo errH
    
    Select Case lblCTFW.Caption
    Case "本人"
        intType = 0
    Case "本科"
        intType = 1
    Case "全院"
        intType = 2
    End Select
    
    Set rsTmp = GetSchemeClass(intType)
    
    If rsTmp.EOF Then
        lblCTN.Caption = "无成套分类"
        vsScheme.Clear
    Else
        Set objPopup = cbsMain.Add("Popup", xtpBarPopup)
        
        With objPopup.Controls
            For i = 1 To rsTmp.RecordCount
                Set objControl = .Add(xtpControlButton, conMenu_SchemeInSide * 100# + (3 + i), rsTmp!成套分类 & "")
                objControl.Parameter = rsTmp!ID
                rsTmp.MoveNext
            Next
        End With
        
        GetWindowRect picPanel(e成套方案).hwnd, vRect
        objPopup.ShowPopup , vRect.Left * Screen.TwipsPerPixelX + lblCTN.Left + lblCTN.Width, vRect.Top * Screen.TwipsPerPixelY + lblCTN.Top
    End If
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function GetSchemeClass(ByVal intType As Integer) As ADODB.Recordset
'功能：获取成套方案的记录集
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    On Error GoTo errH
    If intType = 0 Then '个人
        strSQL = " And c.人员ID=[2]"
    ElseIf intType = 1 Then '本科
        strSQL = " And Exists(Select 1 From 诊疗适用科室 Where 项目ID=c.ID And 科室ID=[3]) "
    ElseIf intType = 2 Then '全院
        strSQL = " And c.人员ID is NULL And Not Exists(Select 1 From 诊疗适用科室 Where 项目ID=c.ID)"
    End If
    strSQL = "Select Decode(a.上级id, Null, '', '  ') || a.名称 as 成套分类, a.Id" & vbNewLine & _
            " From 诊疗分类目录 A" & vbNewLine & _
            " Where a.类型 = 6 And Exists" & vbNewLine & _
            " (Select 1" & vbNewLine & _
            "       From 诊疗项目目录 C" & vbNewLine & _
            "       Where c.类别 = '9' And c.服务对象 IN([1],3) And c.分类id = a.Id" & strSQL & vbNewLine & _
            "             And (c.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or c.撤档时间 Is Null)" & vbNewLine & _
            "             And (c.站点='" & gstrNodeNo & "' Or c.站点 is Null))" & _
            " Order By 编码"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, 1, UserInfo.ID, mlng病人科室id)
    If Not rsTmp.EOF Then
        rsTmp.Filter = "ID=" & Val(lblCTN.Tag)
        If rsTmp.EOF Then
            rsTmp.Filter = 0
            lblCTN.Caption = rsTmp!成套分类 & ""
            lblCTN.Tag = rsTmp!ID
        End If
        rsTmp.Filter = 0
    Else
        lblCTN.Caption = "无成套分类"
        lblCTN.Tag = ""
    End If
    Set GetSchemeClass = rsTmp
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub ReLoadScheme(ByVal intRange As Integer, ByVal lng分类ID As Long)
'功能：加载成套方案
'参数：intRange 0－个人，1－本科，2－全院
'      lng分类ID  分类ID
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    Dim i As Long
    
    On Error GoTo errH
    lblCTFW.Tag = intRange
    lblCTN.Tag = lng分类ID
    If intRange = 0 Then '个人
        strSQL = " And 人员ID=[2]"
    ElseIf intRange = 1 Then '本科
        strSQL = " And Exists(Select 1 From 诊疗适用科室 Where 项目ID=A.ID And 科室ID=[3])"
    Else '全院
        strSQL = " And 人员ID is NULL And Not Exists(Select 1 From 诊疗适用科室 Where 项目ID=A.ID)"
    End If
    strSQL = strSQL & " And A.分类ID = [4]"
    strSQL = "Select ID,8 as 类型,编码,名称 From 诊疗项目目录 A" & _
        " Where 类别='9' And A.服务对象 IN([1],3) " & strSQL & _
        " And (撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or 撤档时间 is Null)" & _
        " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
        " Order by 编码"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "读取成套分类", 1, UserInfo.ID, mlng病人科室id, lng分类ID)
    
    With vsScheme
        .Redraw = flexRDNone
        .Rows = 0
        .Rows = rsTmp.RecordCount
        If .Rows = 0 Then .Rows = 1
        For i = 1 To rsTmp.RecordCount
            .TextMatrix(i - 1, 0) = "" & rsTmp!名称
            .Cell(flexcpData, i - 1, 0) = CLng(rsTmp!ID)
            rsTmp.MoveNext
        Next
        .Redraw = flexRDDirect
    End With
    lblCTN.Caption = Sys.RowValue("诊疗分类目录", lng分类ID, "名称")
    If lblCTN.Caption = "" Then
         lblCTN.Caption = "无成套分类"
    End If
    lblCTN.Tag = lng分类ID
'    诊疗项目目录
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub vsAdvice_StartEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    If mbytUseType = 1 Then
        If Col = COL_选择 Then
            If vsAdvice.TextMatrix(Row, Col) = "√" Then Cancel = True
        Else
            Cancel = True
        End If
    End If
End Sub

Private Sub vsDiag_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim lngRow As Long
    If Button = 2 Then
        lngRow = vsDiag.MouseRow
        If lngRow >= vsDiag.FixedRows And lngRow <= vsDiag.Rows - 1 Then
            If Not vsDiag.RowHidden(lngRow) Then vsDiag.Row = lngRow
        End If
    End If
End Sub

Private Sub vsDiag_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim objPopup As CommandBarPopup
    Dim blnDo As Boolean

    If Button = 2 Then
        If cbsMain Is Nothing Then Exit Sub
        Set objPopup = cbsMain.ActiveMenuBar.FindControl(, conMenu_ViewPopup)
        If gobjPlugIn Is Nothing And blnDo And gobjDrugExplain Is Nothing Then Exit Sub '当弹出没有菜单项目时会显示一个空白小方块
        If Not objPopup Is Nothing Then
            objPopup.CommandBar.ShowPopup
        End If
    End If
End Sub

Private Sub vsDRU_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    SetVsListBorder vsDRU
End Sub

Private Sub vsDRU_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If vsDRU.MouseRow <> -1 Then
        If Button = 1 Then
            If Val(vsDRU.RowData(vsDRU.MouseRow)) <> 0 Then
                Call SetInputAdvice(Val(vsDRU.RowData(vsDRU.MouseRow)), Val(vsDRU.TextMatrix(vsDRU.MouseRow, Common_诊疗项目ID)), Val(vsDRU.TextMatrix(vsDRU.MouseRow, Common_药品ID)))
            End If
        ElseIf Button = 2 Then
            mlngCommonID = Val(vsDRU.RowData(vsDRU.MouseRow))
            PopupMenu mnu_replace
        End If
    End If
End Sub

Private Sub vsLIS_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    SetVsListBorder vsLIS
End Sub

Private Sub vsLIS_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If vsLIS.MouseRow <> -1 Then
        If Button = 1 Then
            If Val(vsLIS.RowData(vsLIS.MouseRow)) <> 0 Then
                Call SetInputAdvice(Val(vsLIS.RowData(vsLIS.MouseRow)), Val(vsLIS.TextMatrix(vsLIS.MouseRow, Common_诊疗项目ID)), Val(vsLIS.TextMatrix(vsLIS.MouseRow, Common_药品ID)))
            End If
        ElseIf Button = 2 Then
            mlngCommonID = Val(vsLIS.RowData(vsLIS.MouseRow))
            PopupMenu mnu_replace
        End If
    End If
End Sub

Private Sub SetInputAdvice(ByVal lngID As Long, Optional ByVal lng诊疗项目ID As Long, Optional ByVal lng收费细目ID As Long, Optional ByVal intType As Integer)
'功能：选择常用项目
'参数：intType 1=手动替换项目时调用,2=删除项目时调用
    Dim strSQL As String, rsTmp As Recordset
    Dim rsTmpSelect As Recordset
    Dim strMsg As String
    Dim strDepartments As String
    
    If lngID <> 0 And intType <> 0 Then
        strSQL = "Select 诊疗项目ID,药品ID From 医生常用医嘱 Where ID=[1]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lngID)
        If rsTmp.RecordCount > 0 Then
            lng诊疗项目ID = Val(rsTmp!诊疗项目ID & "")
            lng收费细目ID = Val(rsTmp!药品ID & "")
        End If
    End If
    
    strSQL = "Select a.类别 As 类别id, " & lng诊疗项目ID & " As 诊疗项目id, " & lng收费细目ID & " As 收费细目id, a.类别, Null As 基本, a.编码, a.名称, Null As 商品名, Null As 简码, a.计算单位,decode(a.类别,'C',a.标本部位,'D',a.标本部位,b.规格) as 规格," & vbNewLine & _
            "       Null As 库存, b.产地, d.药品剂型, Null As 项目特性, Null As 费用类型, Null As 医保大类, Null As 说明, d.处方职务 As 处方职务id, Null As 价格," & vbNewLine & _
            "       Decode(d.抗生素, 0, '', 1, '非限制使用', 2, '限制使用', 3, '特殊使用') As 抗菌等级, d.临床自管药 As 临床自管药id,A.撤档时间 ,B.撤档时间 As 收费撤档时间,A.分类ID" & vbNewLine & _
            "From 诊疗项目目录 A, 药品特性 D, 收费项目目录 B, 药品规格 C" & vbNewLine & _
            "Where a.Id = d.药名id(+) And a.Id = c.药名id(+) And c.药品id = b.Id(+) "
    If lng收费细目ID = 0 Then
        strSQL = strSQL & "And a.Id = [1] "
    Else
        strSQL = strSQL & "And a.Id = [1] And B.ID=[2]"
    End If
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng诊疗项目ID, lng收费细目ID)
    
    If rsTmp.RecordCount > 0 Then
        '手动替换时不检查
        If intType = 0 Then
            '检查是否停用
            If Format(NVL(rsTmp!收费撤档时间, "3000/1/1"), "yyyy-MM-dd") <> "3000-01-01" Or Format(NVL(rsTmp!撤档时间, "3000/1/1"), "yyyy-MM-dd") <> "3000-01-01" Then
                strMsg = "您选择的项目""" & rsTmp!名称 & IIF(rsTmp!产地 & "" <> "", "(" & rsTmp!产地 & ")", "") & IIF(rsTmp!规格 & "" <> "", " " & rsTmp!规格, "") & """已停用，是否替换为其他项目？"
            End If
            '检查是否有库存
            If (rsTmp!类别 & "" = "5" Or rsTmp!类别 & "" = "6") And Val(rsTmp!收费细目ID & "") <> 0 And gblnStock Then
                strDepartments = Get可用药房IDs(rsTmp!类别 & "", NVL(rsTmp!诊疗项目ID), Val(rsTmp!收费细目ID & ""), mlng病人科室id, 1)
                If strDepartments <> "" Then
                    If GetStock(Val(rsTmp!收费细目ID & ""), , 1, strDepartments) = 0 Then
                        strMsg = "您选择的药品""" & rsTmp!名称 & IIF(rsTmp!产地 & "" <> "", "(" & rsTmp!产地 & ")", "") & IIF(rsTmp!规格 & "" <> "", " " & rsTmp!规格, "") & """已无库存，是否替换为其他药品？"
                    End If
                End If
            End If
        ElseIf intType = 1 Then
            strMsg = "是否要将项目""" & rsTmp!名称 & IIF(rsTmp!产地 & "" <> "", "(" & rsTmp!产地 & ")", "") & IIF(rsTmp!规格 & "" <> "", " " & rsTmp!规格, "") & """替换为其他项目？"
        ElseIf intType = 2 Then
            strMsg = "是否要将常用项目""" & rsTmp!名称 & IIF(rsTmp!产地 & "" <> "", "(" & rsTmp!产地 & ")", "") & IIF(rsTmp!规格 & "" <> "", " " & rsTmp!规格, "") & """移除？"
        End If
        
        If strMsg <> "" Then
            If MsgBox(strMsg, vbQuestion + vbYesNo + vbDefaultButton1) = vbYes Then
                If intType <> 2 Then
                    '替换
                    '打开选择器，可能指定了初始分类目录
                    Set rsTmpSelect = frmClinicSelect.ShowSelect(Me, IIF(mlng前提ID <> 0, 2, 0), 0, mlng病人科室id, 1, mstr性别, , , 1, 0, mint险类, , , , , rsTmp!类别 & "", , , Val(rsTmp!分类ID & ""), mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, , mlng医技科室ID)
                    
                    If rsTmpSelect Is Nothing Then Exit Sub
                    
                    '替换诊疗项目ID和药品ID
                    strSQL = "Zl_医生常用医嘱_替换(" & lngID & "," & Val(rsTmpSelect!诊疗项目ID & "") & "," & ZVal(Val(rsTmpSelect!收费细目ID & "")) & ")"
                    zlDatabase.ExecuteProcedure strSQL, Me.Caption
                    Set rsTmp = rsTmpSelect
                    Call LoadCommonItem(True)
                Else
                    '移除常用项目
                    strSQL = "Zl_医生常用医嘱_替换(" & lngID & ",-1 ,-1)"
                    zlDatabase.ExecuteProcedure strSQL, Me.Caption
                    Call LoadCommonItem(True)
                End If
            Else
                Exit Sub
            End If
        End If
        
        If intType = 0 Then
            cbsMain.FindControl(, conMenu_New, True, True).Execute
            SetAdviceInput rsTmp
        End If
    End If
End Sub

Private Sub SetAdviceInput(rsTmp As Recordset)
    If AdviceInput(rsTmp, vsAdvice.Row) Then
        '显示已缺省设置的值
        Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
                    
        Call CalcAdviceMoney '显示新开医嘱金额
        
        '医保管控实时监测
        If mint险类 <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
            '总量不可输入：缺省并固定总量的医嘱，以及长嘱
            '成套医嘱不在这里检查
            If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) And Not txt总量.Enabled Then
                If MakePriceRecord(vsAdvice.Row) Then
                    If Not gclsInsure.CheckItem(mint险类, 0, 0, mrsPrice) Then
                        Call AdviceCurRowClear: Exit Sub
                    End If
                End If
                '标记为已经作了检查
                vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_状态) = 1
            End If
        End If
        
        Call SeekNextControl
    Else
        zlControl.TxtSelAll txt医嘱内容
        txt医嘱内容.SetFocus: Exit Sub
    End If
End Sub

Private Sub vsPAC_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    SetVsListBorder vsPAC
End Sub

Private Sub SetLinkLBL(ByRef objLBL As Object, ByVal blnIn As Boolean)
'功能：设置颜色
    objLBL.ForeColor = IIF(blnIn, vbRed, &HFF0000)
End Sub

Private Function Check发病时间(ByVal strDate As String)
'功能：检查诊断录入的发病时间合法性
    Dim datCur As Date
    datCur = zlDatabase.Currentdate
    If Format(datCur, "YYYY-MM-DD HH:mm") < Format(strDate, "YYYY-MM-DD HH:mm") Then
        MsgBox "发病时间应该早于当前时间。", vbInformation, gstrSysName
        Exit Function
    End If
    Check发病时间 = True
End Function

Private Sub SetVsListBorder(objVsList As VSFlexGrid, Optional ByVal intType As Integer)
    Dim lngRow As Long
    
    With objVsList
        lngRow = .MouseRow
        If lngRow >= 0 And Val(objVsList.Tag) <> lngRow Or objVsList.Rows = 1 And lngRow = 0 Then
            Call ClearListSel
            If intType = 0 Then
                .Cell(flexcpForeColor, lngRow, 0) = .ForeColorSel
                .Cell(flexcpBackColor, lngRow, 0) = &HFAFAFA
                .CellBorderRange lngRow, 0, lngRow, 0, 1, 1, 1, 1, 1, 1, 1
                objVsList.Tag = lngRow
                .ToolTipText = .Cell(flexcpText, lngRow, 0)
            Else
                If .Cell(flexcpText, lngRow, col诊断内容) <> "" Then
                    .Cell(flexcpForeColor, lngRow, col诊断内容) = .ForeColorSel
                    .Cell(flexcpBackColor, lngRow, col诊断内容) = &HFAFAFA
                    .CellBorderRange lngRow, col诊断内容, lngRow, col诊断内容, 1, 1, 1, 1, 1, 1, 1
                    objVsList.Tag = lngRow
                    .ToolTipText = .Cell(flexcpText, lngRow, col诊断内容)
                End If
            End If
        End If
    End With
End Sub

Private Sub ClearListSel()
    Dim lngCol As Long
    On Error Resume Next
    With vsScheme
        If Val(.Tag) >= 0 Then
            .Row = -1
            .Cell(flexcpForeColor, Val(.Tag), 0) = .ForeColor
            .Cell(flexcpBackColor, Val(.Tag), 0) = .BackColor
            .CellBorderRange Val(.Tag), 0, Val(.Tag), 0, 0, 0, 0, 0, 0, 0, 0
            .Tag = -1
        End If
    End With
    With vsPAC
        If Val(.Tag) >= 0 Then
            .Row = -1
            .Cell(flexcpForeColor, Val(.Tag), 0) = .ForeColor
            .Cell(flexcpBackColor, Val(.Tag), 0) = .BackColor
            .CellBorderRange Val(.Tag), 0, Val(.Tag), 0, 0, 0, 0, 0, 0, 0, 0
            .Tag = -1
        End If
    End With
    With vsLIS
        If Val(.Tag) >= 0 Then
            .Row = -1
            .Cell(flexcpForeColor, Val(.Tag), 0) = .ForeColor
            .Cell(flexcpBackColor, Val(.Tag), 0) = .BackColor
            .CellBorderRange Val(.Tag), 0, Val(.Tag), 0, 0, 0, 0, 0, 0, 0, 0
            .Tag = -1
        End If
    End With
    With vsDRU
        If Val(.Tag) >= 0 Then
            .Row = -1
            .Cell(flexcpForeColor, Val(.Tag), 0) = .ForeColor
            .Cell(flexcpBackColor, Val(.Tag), 0) = .BackColor
            .CellBorderRange Val(.Tag), 0, Val(.Tag), 0, 0, 0, 0, 0, 0, 0, 0
            .Tag = -1
        End If
    End With
    
    lngCol = col诊断内容
    With vsDiagComm
        If Val(.Tag) >= 0 Then
            .Row = -1
            .Cell(flexcpForeColor, Val(.Tag), lngCol) = .ForeColor
            .Cell(flexcpBackColor, Val(.Tag), lngCol) = .BackColor
            .CellBorderRange Val(.Tag), lngCol, Val(.Tag), lngCol, 0, 0, 0, 0, 0, 0, 0
            .Tag = -1
        End If
    End With
    
    If vsDiagBefore.Visible Then
        With vsDiagBefore
            If Val(.Tag) >= 0 Then
                .Row = -1
                .Cell(flexcpForeColor, Val(.Tag), lngCol) = .ForeColor
                .Cell(flexcpBackColor, Val(.Tag), lngCol) = .BackColor
                .CellBorderRange Val(.Tag), lngCol, Val(.Tag), lngCol, 0, 0, 0, 0, 0, 0, 0
                .Tag = -1
            End If
        End With
    End If
    err.Clear
End Sub

Private Sub vsPAC_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If vsPAC.MouseRow <> -1 Then
        If Button = 1 Then
            If Val(vsPAC.RowData(vsPAC.MouseRow)) <> 0 Then
                Call SetInputAdvice(Val(vsPAC.RowData(vsPAC.MouseRow)), Val(vsPAC.TextMatrix(vsPAC.MouseRow, Common_诊疗项目ID)), Val(vsPAC.TextMatrix(vsPAC.MouseRow, Common_药品ID)))
            End If
        ElseIf Button = 2 Then
            mlngCommonID = Val(vsPAC.RowData(vsPAC.MouseRow))
            PopupMenu mnu_replace
        End If
    End If
End Sub

Private Sub vsScheme_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim lng分类ID As Long

    With vsScheme
        If .MouseRow < 0 Then Exit Sub
        If Button <> 1 Then Exit Sub
        lng分类ID = Val(.Cell(flexcpData, .Row, .Col))
    End With
    If lng分类ID = 0 Then Exit Sub
    If Not (cmdSel.Enabled And cmdSel.Visible) Then
        cbsMain.FindControl(, conMenu_New, True, True).Execute
    End If
    Call ClinicSelecter(8, lng分类ID)
End Sub

Private Sub mobjReport_AfterPrint(ByVal ReportNum As String)
    Dim strSQL As String
    
    '申请单据打印之后的处理
    If mstrBillPrint <> "" Then
        If Split(mstrBillPrint, ",")(0) = ReportNum Then
            strSQL = "Zl_诊疗单据打印_Insert('" & Split(mstrBillPrint, ",")(1) & "'," & Val(Split(mstrBillPrint, ",")(2)) & ",1,'" & UserInfo.姓名 & "')"
        End If
    End If
    
    On Error GoTo errH
    If strSQL <> "" Then
        zlDatabase.ExecuteProcedure strSQL, Me.Name
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub AdviceRevoke()
'删除：当前医嘱作废(一组医嘱作废)
    Dim strSQL As String, lng医嘱ID As Long
    Dim strNO As String
    Dim lngType As Long
    Dim rsTmp As ADODB.Recordset
    Dim str发送时间 As String
    
    On Error GoTo errH
    
    With vsAdvice
        '检查是否可以作废
        If Val(.TextMatrix(.Row, COL_相关ID)) <> 0 Then
            lng医嘱ID = Val(.TextMatrix(.Row, COL_相关ID))
        Else
            lng医嘱ID = Val(.RowData(.Row))
        End If
        
        If RowIn一并给药(.Row) Then
            lngType = 1
        End If
        
        If .TextMatrix(.Row, COL_类别) = "E" And Val(.TextMatrix(.Row, COL_操作类型)) = 6 Then
            lngType = 2
        End If
        
        '取发送号和发送时间
        strSQL = "select No,发送时间 from 病人医嘱发送 where 医嘱ID=[1]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Name, lng医嘱ID)
        
        If Not rsTmp.EOF Then
            If .TextMatrix(.Row, COL_类别) = "5" Or .TextMatrix(.Row, COL_类别) = "6" Then
                strNO = rsTmp!NO & ""
            End If
            str发送时间 = Format(rsTmp!发送时间 & "", "YYYY-MM-DD HH:MM:SS")
        End If
        
        If RevokeOutAdvice(mlng病人ID, mlng挂号ID, mstr挂号单, mstr姓名, CStr(mdbl门诊号), mlng挂号科室ID, lng医嘱ID, Val(.TextMatrix(.Row, COL_状态)), .TextMatrix(.Row, COL_类别), .TextMatrix(.Row, COL_操作类型), Val(.TextMatrix(.Row, COL_审核状态)), _
            str发送时间, Val(.TextMatrix(.Row, COL_签名否)), lngType, .TextMatrix(.Row, col_医嘱内容), mblnMoved, mclsMipModule, mint场合) = False Then Exit Sub
        
    End With
    
    '重新读取显示医嘱
    Call ReLoadAdvice(vsAdvice.RowData(vsAdvice.Row))
    mblnOK = True
    If txt医嘱内容.Enabled Then
        txt医嘱内容.SetFocus
    Else
        vsAdvice.SetFocus
    End If
    
    'PASS医嘱作废后自动调用审查功能
    If mblnPass Then
        Call gobjPass.zlPassAdviceSave(mobjPassMap, , , 3)
    End If
    
    '药品医嘱用废后判断是不是要重打
    If strNO <> "" Then
        strSQL = "Select Distinct D.编号,D.名称,D.说明,B.NO,B.记录性质" & _
            " From 病人医嘱记录 A,病人医嘱发送 B,病历单据应用 C,病历文件列表 D" & _
            " Where C.诊疗项目ID = A.诊疗项目ID And a.ID=b.医嘱ID " & _
            " And C.应用场合=1 And C.病历文件ID=D.ID And D.种类=7 And b.NO=[1] and a.诊疗类别 in ('5','6')" & _
            " Order by D.编号"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Name, strNO)
        If Not rsTmp.EOF Then
            If MsgBox("您作废的药品处方签已经打印，是否重打？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbYes Then
                '调用打印
                SwitchPrintSet glngSys & "\" & p门诊医嘱下达
                If mobjReport.ReportPrintSet(gcnOracle, glngSys, "ZLCISBILL" & Format(rsTmp!编号, "00000") & "-1", mfrmParent) Then
                    mstrBillPrint = "ZLCISBILL" & Format(rsTmp!编号, "00000") & "-1" & "," & rsTmp!NO & "," & rsTmp!记录性质
                    Call mobjReport.ReportOpen(gcnOracle, glngSys, "ZLCISBILL" & Format(rsTmp!编号, "00000") & "-1", mfrmParent, "NO=" & rsTmp!NO, "性质=" & rsTmp!记录性质, 2)
                    mstrBillPrint = ""
                End If
                SwitchPrintSet glngSys & "\" & p门诊医嘱下达, True
            End If
        End If
    End If
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function Get本院执行次数(ByVal lngRow As Long) As String
'功能：获取输液或注射医嘱在本院的执行次数，文本格式0为空串
    Dim i As Long
    Dim lng次数 As Long
    Dim lng组ID As Long
    With vsAdvice
        If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            lng组ID = Val(.TextMatrix(lngRow, COL_相关ID))
            For i = lngRow + 1 To .Rows - 1
                If lng组ID = Val(.TextMatrix(i, COL_相关ID)) Or lng组ID = Val(.RowData(i)) Then
                    If lng组ID = Val(.RowData(i)) And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                        Exit For
                    End If
                Else
                    Exit For
                End If
            Next
        Else
            i = lngRow
        End If
        
        If i < .Rows And i >= .FixedRows Then
            If Val(.TextMatrix(i, COL_相关ID)) = 0 And .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "2" _
                And (.TextMatrix(i, COL_执行分类) = "1" Or .TextMatrix(i, COL_执行分类) = "2") Then
                lng次数 = Val(.TextMatrix(i, COL_总量))
                lblBYZXCS.Caption = "次(共" & Val(.Cell(flexcpData, i, COL_总量)) & "次)"
            End If
        End If
    End With
    Get本院执行次数 = IIF(lng次数 = 0, "", lng次数)
End Function

Private Function RowIs输液注射(ByVal lngRow As Long, ByRef lngOut As Long) As Boolean
'功能：当前医嘱是否是 输液注射 医嘱，并返回给药途径行号 lngOut
    Dim i As Long
    Dim lng次数 As Long
    Dim lng组ID As Long
    With vsAdvice
        If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            lng组ID = Val(.TextMatrix(lngRow, COL_相关ID))
            For i = lngRow + 1 To .Rows - 1
                If lng组ID = Val(.TextMatrix(i, COL_相关ID)) Or lng组ID = Val(.RowData(i)) Then
                    If lng组ID = Val(.RowData(i)) And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                        Exit For
                    End If
                Else
                    Exit For
                End If
            Next
        Else
            i = lngRow
        End If
        If i < .Rows And i >= .FixedRows Then
            If Val(.TextMatrix(i, COL_相关ID)) = 0 And .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "2" _
                And (.TextMatrix(i, COL_执行分类) = "1" Or .TextMatrix(i, COL_执行分类) = "2") Then
                RowIs输液注射 = True
                lngOut = i
            End If
        End If
    End With
End Function

Private Function Make本院执行次数(ByVal lngRow As Long) As Long
'功能：计算输液或注射医嘱在本院的执行次数
'参数：lngRow  给药途径行
    '一并给药的按最小次数发送(影响给药途径计费)
    Dim i As Long
    Dim lngBg As Long, lngEd As Long
    Dim lng次数 As Long, lngMin As Long
    
    Call GetRowScope(lngRow, lngBg, lngEd)
    lngEd = lngEd - 1
    With vsAdvice
        For i = lngBg To lngEd
            If Val(.RowData(i)) <> 0 Then
                '计算临嘱用药次数
                If Val(.TextMatrix(i, COL_天数)) <> 0 And .TextMatrix(i, COL_频率) <> "" Then
                    '一个频率周期的次数
                    If .TextMatrix(i, COL_间隔单位) = "周" Then
                        lng次数 = IntEx(Val(.TextMatrix(i, COL_天数)) * (Val(.TextMatrix(i, COL_频率次数)) / 7))
                    ElseIf .TextMatrix(i, COL_间隔单位) = "天" Then
                        lng次数 = IntEx(Val(.TextMatrix(i, COL_天数)) * (Val(.TextMatrix(i, COL_频率次数)) / Val(.TextMatrix(i, COL_频率间隔))))
                    ElseIf .TextMatrix(i, COL_间隔单位) = "小时" Then
                        lng次数 = IntEx(Val(.TextMatrix(i, COL_天数)) * (Val(.TextMatrix(i, COL_频率次数)) / Val(.TextMatrix(i, COL_频率间隔))) * 24)
                    ElseIf .TextMatrix(i, COL_间隔单位) = "分钟" Then
                        lng次数 = IntEx(Val(.TextMatrix(i, COL_天数)) * (Val(.TextMatrix(i, COL_频率次数)) / Val(.TextMatrix(i, COL_频率间隔))) * (24 * 60))
                    End If
                Else
                    '可分零药品时,按总量对单量的倍数计算给药途径的次数,不可分零与一次性使用药品时，按总量对（单量与剂量系数比值取整）的倍数计算给药途径的次数，
                    '否则按一个频率周期的次数计算
                    If Val(.TextMatrix(i, COL_可否分零)) = 0 And Val(.TextMatrix(i, COL_单量)) <> 0 Then
                        lng次数 = IntEx(Val(.TextMatrix(i, COL_总量)) * Val(.TextMatrix(i, COL_剂量系数)) / Val(.TextMatrix(i, COL_单量)))
                    ElseIf (Val(.TextMatrix(i, COL_可否分零)) = 1 Or Val(.TextMatrix(i, COL_可否分零)) = 2) And Val(.TextMatrix(i, COL_单量)) <> 0 Then
                        lng次数 = IntEx(Val(.TextMatrix(i, COL_总量)) / IntEx(Val(.TextMatrix(i, COL_单量)) / Val(.TextMatrix(i, COL_剂量系数))))
                    Else
                        lng次数 = Val(.TextMatrix(i, COL_频率次数))
                    End If
                End If
                If lng次数 < lngMin And lngMin <> 0 Then
                    lngMin = lng次数
                ElseIf lngMin = 0 Then
                    lngMin = lng次数
                End If
            End If
        Next
    End With
    lblBYZXCS.Caption = "次(共" & lngMin & "次)"
    Make本院执行次数 = lngMin
End Function

Private Function GetEPRFileID(ByVal strPar As String) As ADODB.Recordset
'功能：获取一个病历文件ID
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim strTmp As String
    Dim varTmp As Variant
    Dim i As Long
    
    On Error GoTo errH
    
    strTmp = strPar
    If strTmp <> "" Then
        varTmp = Split(strTmp, ",")
        strTmp = ""
        For i = 0 To UBound(varTmp)
            If IsNumeric(varTmp(i)) Then
                strTmp = strTmp & "," & Val(varTmp(i))
            End If
        Next
        strTmp = Mid(strTmp, 2)
    End If
    
    If strTmp <> "" Then
        strSQL = "Select F.ID,F.名称 as 病历名称" & _
            " From 病历文件列表 F,病历应用科室 A" & _
            " Where F.ID=A.文件id(+) And f.种类 In (1,5,6) And f.保留 <> 4 " & _
            " And (f.通用 = 1 Or f.通用 = 2 and A.科室id =[1]) " & _
            " And f.ID IN (Select Column_Value From Table(f_Num2list([2]))) Order By f.种类,f.编号"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strTmp, mlng病人科室id)
    Else
        strSQL = "Select F.ID, F.名称 as 病历名称" & vbNewLine & _
            "From (Select F.ID, F.通用, A.科室id, F.名称,Decode(R.事件,Null,2,1) 事件" & vbNewLine & _
            "       From 病历文件列表 F, 病历应用科室 A, 病历时限要求 R" & vbNewLine & _
            "       Where F.ID = A.文件id(+) And F.ID = R.文件id(+) And F.种类 = 1 And F.保留= '3') F" & vbNewLine & _
            "Where F.通用 = 1 Or F.通用 = 2 And F.科室id = [1]" & vbNewLine & _
            "Order By F.事件,F.通用 Desc,F.id"
    End If
    
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人科室id, strTmp)
    Set GetEPRFileID = rsTmp
 
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub GetData检查申请(ByVal lngRow As Long, ByRef objAppPages() As clsApplicationData)
'功能：从医嘱表格中获取数据生成对象只传新开状态的医嘱和未保存的医嘱数据
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim strAppend As String, strExtData As String
    Dim lng申请序号 As Long
    Dim lng相关ID As Long
    Dim i As Long, j As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim objTmp As clsApplicationData
    Dim varArr As Variant
    Dim strTmp As String
    Dim lngObjIndex As Long
    Dim str诊断 As String, str诊断IDs As String
 
    On Error GoTo errH
    With vsAdvice
        lngEnd = -1
        lngObjIndex = -1
        lng申请序号 = Val(.TextMatrix(lngRow, COL_申请序号))
        For i = .FixedRows To .Rows - 1
            If Val(.TextMatrix(i, COL_申请序号)) = lng申请序号 And i > lngEnd Then
                lng相关ID = Val(.RowData(i))
                lngBegin = i
                lngRow = i
                Set objTmp = New clsApplicationData
                objTmp.blnIsModify = True
                objTmp.blnAllowUpdate = True
                objTmp.blnIsAdditionalRec = False
                objTmp.lngProjectId = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
                objTmp.blnIsPriority = Val(.TextMatrix(lngRow, COL_标志)) = 1
                objTmp.strStartExeTime = .TextMatrix(lngRow, COL_开始时间)
                objTmp.lngExeRoomId = Val(.TextMatrix(lngRow, COL_执行科室ID))
                objTmp.strExeRoomName = Sys.RowValue("部门表", objTmp.lngExeRoomId, "名称")
                objTmp.lngExeRoomType = Val(.TextMatrix(lngRow, COL_执行性质))
                objTmp.strRequestTime = .TextMatrix(lngRow, COL_开嘱时间)
                objTmp.lngRequestRoomId = Val(.TextMatrix(lngRow, COL_开嘱科室ID))
                
                If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
                    str诊断IDs = GetAdviceDiag(.RowData(lngRow), str诊断)
                    objTmp.strDiagnoseId = str诊断IDs
                End If
                
                strTmp = objTmp.Get申请单信息(objTmp.lngProjectId, 1)
                If strTmp <> "" Then
                    objTmp.lngApplicationPageId = Val(Split(strTmp, "<Split>")(0))
                    objTmp.strApplicationPageName = Split(strTmp, "<Split>")(1)
                    objTmp.strRequestAffixCfg = objTmp.Get申请附项目配置(objTmp.lngApplicationPageId)
                End If
                
                strExtData = Get检查部位方法(lngRow)
                If InStr(strExtData, vbTab) > 0 Then
                    objTmp.strPartMethod = Split(strExtData, vbTab)(0)
                    objTmp.lngExeType = Val(Split(strExtData, vbTab)(1))
                End If
                
                strAppend = .TextMatrix(lngRow, COL_附项)
                If strAppend <> "" Then
                    varArr = Split(strAppend, "<Split1>")
                    strAppend = ""
                    For j = 0 To UBound(varArr)
                        strTmp = varArr(j)
                        If strTmp <> "" Then
                            strAppend = strAppend & "|" & Split(strTmp, "<Split2>")(0) & ":" & Split(strTmp, "<Split2>")(3)
                        End If
                    Next
                    objTmp.strRequestAffix = Mid(strAppend, 2)
                End If
                
                For j = i + 1 To .Rows - 1
                    If Val(.TextMatrix(j, COL_相关ID)) = lng相关ID Then
                        lngEnd = j
                    Else
                        Exit For
                    End If
                Next
                lngObjIndex = lngObjIndex + 1
                ReDim Preserve objAppPages(lngObjIndex)
                Set objAppPages(lngObjIndex) = objTmp
            End If
        Next
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNew检查申请(ByVal intType As Integer, ByVal str项目IDs As String, ByRef objAppPages() As clsApplicationData) As Boolean
'功能：调用申请单
'参数：intType 0-新增,1-修改
    Dim objPacspplication As New clsPacsApplication
    Dim lng项目id As Long
    Dim strSQL As String
    Dim rsPati As ADODB.Recordset

    On Error GoTo errH

    lng项目id = Val(str项目IDs)
    '初始化检查申请单对象
    Call objPacspplication.InitComponents(mlng挂号科室ID, Me)
    ApplyNew检查申请 = objPacspplication.ShowApplicationForm(mlng病人ID, 1, mlng挂号ID, 0, intType, objAppPages(), mint婴儿, , lng项目id)
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet检查申请(ByVal lngRow As Long, ByRef objAppPages() As clsApplicationData, ByVal strDiags As String) As Long
'功能：把检查申请单数据加载到表格中
    Dim objTmp As clsApplicationData
    Dim i As Long, j As Long, k As Long
    Dim lngCnt As Long, lng申请序号 As Long, lngCurRow As Long
    Dim strSQL As String, strAppend As String
    Dim varTmp As Variant, strTmp As String
    Dim rsInput As ADODB.Recordset
    Dim rsAppend As ADODB.Recordset
    Dim lngBegin As Long, lngEnd As Long
    Dim str诊断IDs As String
    Dim str附项内容 As String
    
    On Error GoTo errH
    lng申请序号 = Get申请序号
    mblnRowChange = False
    For i = 0 To UBound(objAppPages)
        Set objTmp = objAppPages(i)
        strSQL = "Select a.名称,a.Id As 诊疗项目id, Null As 收费细目id,a.类别 As 类别ID From 诊疗项目目录 A where a.id=[1]"
        Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, objTmp.lngProjectId)
        strAppend = ""
        If objTmp.strRequestAffix <> "" Then
            strSQL = "Select C.项目,C.内容,C.要素ID,C.必填,d.中文名,decode(D.表示法,4,D.数值域,NULL) as 数值域" & _
                " From 病历单据应用 A,病历文件列表 B,病历单据附项 C,诊治所见项目 D" & _
                " Where A.诊疗项目ID=[1] And A.应用场合=[2]" & _
                " And A.病历文件ID=B.ID And B.种类=7 And B.ID=C.文件ID And c.要素id=d.id(+)" & _
                " Order by C.排列"
            Set rsAppend = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, objTmp.lngProjectId, 1)
            varTmp = Split(objTmp.strRequestAffix, "|")
            For j = 0 To UBound(varTmp)
                If InStr(varTmp(j), ":") > 0 Then
                    rsAppend.Filter = "项目='" & Split(varTmp(j), ":")(0) & "'"
                    If Not rsAppend.EOF Then
                        strSQL = varTmp(j)
                        str附项内容 = Replace(strSQL, Mid(strSQL, 1, InStr(strSQL, ":")), "")
                        strAppend = IIF(strAppend = "", "", strAppend & "<Split1>") & rsAppend!项目 & "<Split2>" & Val(rsAppend!必填 & "") & _
                            "<Split2>" & rsAppend!要素ID & "<Split2>" & str附项内容
                    End If
                End If
            Next
        End If
        If i <> 0 Then
            vsAdvice.AddItem "", lngEnd + 1
            lngRow = lngEnd + 1
        End If
        
        str诊断IDs = objTmp.strDiagnoseId
        varTmp = Split(str诊断IDs, ",")
        For j = 0 To UBound(varTmp)
            If Val(varTmp(j)) > 0 Then
                Call Add申请单诊断(Val(varTmp(j)))
            End If
        Next
        
        strTmp = objTmp.strPartMethod & vbTab & objTmp.lngExeType
        Call AdviceSet诊疗项目(rsInput, lngRow, 0, 0, strTmp, "")
        lngBegin = lngRow
        With vsAdvice
            For j = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(j, COL_相关ID)) = Val(.RowData(lngRow)) Then
                    lngEnd = j
                Else
                    Exit For
                End If
            Next
            If lngEnd < lngBegin Then lngEnd = lngBegin
            For j = lngBegin To lngEnd
                '更新一些项目
                .TextMatrix(j, COL_标志) = IIF(objTmp.blnIsPriority, 1, 0) '门诊无补录
                .TextMatrix(j, COL_开始时间) = Format(objTmp.strStartExeTime, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, j, COL_开始时间) = .TextMatrix(j, COL_开始时间)
                .TextMatrix(j, COL_执行科室ID) = IIF(objTmp.lngExeRoomId <= 0, 0, objTmp.lngExeRoomId)
                .TextMatrix(j, COL_执行性质) = objTmp.lngExeRoomType
                .TextMatrix(j, COL_开嘱时间) = Format(objTmp.strRequestTime, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, j, COL_开嘱时间) = .TextMatrix(j, COL_开嘱时间)
                .TextMatrix(j, COL_开嘱科室ID) = objTmp.lngRequestRoomId
                .TextMatrix(j, COL_申请序号) = lng申请序号
            Next
            
            '更新附件内容:以当前可见行为准
            If strAppend <> "" Then
                .TextMatrix(lngRow, COL_附项) = strAppend
                .Cell(flexcpData, lngRow, COL_附项) = 1 '表明需要重新写入(新增或修改)
                Call ReplaceAdviceAppend(lngRow) '缺省替换其他医嘱的申请附项
            End If
            .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
            .TextMatrix(lngRow, COL_单价) = GetItemPrice(lngRow)
            '重新自动调整行高
            Call .AutoSize(col_医嘱内容)
            If str诊断IDs = "" Then
                Call SetDiagFlag(lngRow, 1, strDiags)
            Else
                Call SetDiagFlag(lngRow, 1, str诊断IDs)
            End If
            Call SetRow标志图标(lngRow, 0)
        End With
    Next
    vsAdvice.Row = lngRow
    Call CalcAdviceMoney '显示新开医嘱金额
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub GetData输血申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset)
'功能：从医嘱表格中获取数据生成对象只传新开状态的医嘱和未保存的医嘱数据
    Dim rsCardBak As ADODB.Recordset
    Dim rsTmp As ADODB.Recordset
    Dim rsTmpOther As ADODB.Recordset
    Dim blnTmp As Boolean
    Dim lng医嘱ID As Long
    Dim strSQL As String
    Dim str诊断 As String
    Dim str诊断IDs As String
    Dim strTmp As String
    Dim var1 As Variant
    Dim var2 As Variant
    Dim i As Long, j As Long
    Dim str申请项目 As String, str输血目的 As String
    
    On Error GoTo errH
    With vsAdvice
        If TypeName(.Cell(flexcpData, lngRow, COL_申请序号)) = "Recordset" Then
            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_申请序号))
        Else
            Call InitCardRsBlood(rsCard)
            rsCard.AddNew
        End If
        If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            lng医嘱ID = Val(.RowData(lngRow))
            If gbln血库系统 = True Then
                strSQL = "Select 诊疗项目id, 申请量, 申请血型, 申请rh,血液信息 From 输血申请项目 Where 医嘱id = [1]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "输血申请项目", lng医嘱ID)
                Do While Not rsTmp.EOF
                    str申请项目 = str申请项目 & ";" & rsTmp!诊疗项目ID & "," & rsTmp!申请量 & "," & rsTmp!申请血型 & "," & rsTmp!申请rh & IIF(rsTmp!血液信息 & "" <> "", "," & rsTmp!血液信息, "")
                rsTmp.MoveNext
                Loop
                If Left(str申请项目, 1) = ";" Then str申请项目 = Mid(str申请项目, 2)
                
                strSQL = "Select 是否待诊 as 待诊,输血类型,输血目的, 输血性质, 即往输血史, 既往输血反应史, 输血禁忌及过敏史, 孕产情况, 受血者属地, 是否签订同意书, 是否已评估, 输血血型 as 血型, RHD" & vbNewLine & _
                    " From 输血申请记录" & vbNewLine & _
                    " Where 医嘱id = [1]"
            Else
                strSQL = "Select 是否待诊 as 待诊, 输血性质, 即往输血史, 孕产情况, 受血者属地, 输血血型 as 血型, RHD" & vbNewLine & _
                    " From 输血申请记录" & vbNewLine & _
                    " Where 医嘱id = [1]"
            End If
            
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng医嘱ID)
            If Not rsTmp.EOF Then
                If Val(rsTmp!待诊 & "") = 0 Then
                   str诊断IDs = GetAdviceDiag(lng医嘱ID, str诊断)
                   '从附项中获取诊断如果附项中有以附项为准
                    strSQL = "select 内容 from 病人医嘱附件 where 医嘱ID=[1] and 项目='申请单诊断'"
                    Set rsTmpOther = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng医嘱ID)
                    If Not rsTmpOther.EOF Then str诊断 = rsTmpOther!内容 & ""
                End If
                rsCard!临床诊断IDs = str诊断IDs
                rsCard!临床诊断描述 = str诊断
                rsCard!血型 = Val(rsTmp!血型 & "")
                rsCard!RHD = Val(rsTmp!RHD & "")
                rsCard!待诊 = Val(rsTmp!待诊 & "")
                rsCard!输血性质 = Val(rsTmp!输血性质 & "")
                rsCard!即往输血史 = Val(rsTmp!即往输血史 & "")
                If gbln血库系统 = True Then
                    rsCard!既往输血反应史 = Val(rsTmp!既往输血反应史 & "")
                    rsCard!输血禁忌及过敏史 = Val(rsTmp!输血禁忌及过敏史 & "")
                    rsCard!输血类型 = rsTmp!输血类型 & ""
                    rsCard!输血目的 = rsTmp!输血目的 & ""
                    str输血目的 = rsTmp!输血目的 & ""
                    rsCard!是否签订同意书 = rsTmp!是否签订同意书
                    rsCard!是否已评估 = rsTmp!是否已评估
                End If
                rsCard!孕产情况 = Val(rsTmp!孕产情况 & "")
                rsCard!受血者属地 = Val(rsTmp!受血者属地 & "")
            End If
            var2 = Array()
            strSQL = "select 序号,检验项目ID,指标代码,指标中文名,指标英文名,指标结果,结果单位,结果标志,结果参考,取值序列,是否人工填写 from 输血检验结果 Where 医嘱ID=[1] order by 序号"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng医嘱ID)
            For i = 1 To rsTmp.RecordCount
                var1 = Array()
                For j = 0 To rsTmp.Fields.Count - 1
                    ReDim Preserve var1(j)
                    var1(j) = rsTmp.Fields(j).value & ""
                Next
                strTmp = Join(var1, "<SplitCol>")
                ReDim Preserve var2(UBound(var2) + 1)
                var2(UBound(var2)) = strTmp
                rsTmp.MoveNext
            Next
            rsCard!检查结果 = Join(var2, "<SplitRow>")
        End If
        
        rsCard!申请项目 = str申请项目
        If str输血目的 = "" Then rsCard!输血目的 = .TextMatrix(lngRow, COL_用药理由)
        rsCard!用血安排 = Val(.TextMatrix(lngRow, COL_标志))
        rsCard!预定输血日期 = .TextMatrix(lngRow, COL_输血时间)
        rsCard!输血项目ID = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
        rsCard!输血执行科室ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
        rsCard!预定输血量 = Val(.TextMatrix(lngRow, COL_总量))
        rsCard!输血途径项目ID = Val(.TextMatrix(lngRow + 1, COL_诊疗项目ID))
        rsCard!输血途径执行科室ID = Val(.TextMatrix(lngRow + 1, COL_执行科室ID))
        rsCard!备注 = .TextMatrix(lngRow, COL_医生嘱托)
        rsCard!输血申请日期 = .TextMatrix(lngRow, COL_开始时间)
        rsCard!申请科室id = .TextMatrix(lngRow, COL_开嘱科室ID)
        rsCard!滴速 = .TextMatrix(lngRow + 1, COL_医生嘱托)
        rsCard.Update
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNew输血申请(ByVal intType As Integer, ByVal str项目IDs As String, ByRef rsCard As ADODB.Recordset, Optional ByVal bln备血 As Boolean = True) As Boolean
'功能：调用申请单
'参数：intType 0-新增,1-修改
    Dim lng项目id As Long
    Dim lng开嘱科室ID As Long
    
    On Error GoTo errH
   
    lng项目id = Val(str项目IDs)
 
    '输血医嘱检查，必须中级及以上专业技术职务的医师才允许下达
    If gbln输血申请中级以上 Then
        If UserInfo.专业技术职务 <> "主治医师" And UserInfo.专业技术职务 <> "主任医师" And UserInfo.专业技术职务 <> "副主任医师" Then
            MsgBox "启用了输血分级管理后，输血医嘱只有中级及以上专业技术职务医师才能下达。", vbInformation, Me.Caption
            Exit Function
        End If
    End If
    
    lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
    
    If Not rsCard Is Nothing Then
        If Not rsCard.EOF Then
            If Val(rsCard!申请科室id & "") <> 0 Then
                lng开嘱科室ID = Val(rsCard!申请科室id & "")
            End If
        End If
    End If
    
    If gbln血库系统 = True Then
        ApplyNew输血申请 = frmApplyBloodNew.ShowMe(Me, mlng病人ID, 0, 1, intType, 0, mlng病人科室id, _
         , lng开嘱科室ID, , , mrsDefine, , 1, mstr挂号单, lng项目id, rsCard, mint婴儿, 1, mlng前提ID, IIF(bln备血 = True, 0, 1))
    Else
        ApplyNew输血申请 = frmApplyBlood.ShowMe(Me, mlng病人ID, 0, 1, intType, 0, mlng病人科室id, _
         , lng开嘱科室ID, , , mrsDefine, , 1, mstr挂号单, lng项目id, rsCard, mint婴儿, 1, mlng前提ID)
    End If
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet输血申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset, ByVal strDiags As String) As Long
'功能：把输血申请单数据加载到表格中
    Dim i As Long, j As Long, k As Long
    Dim lng申请序号 As Long
    Dim strSQL As String
    Dim varTmp As Variant, strTmp As String
    Dim rsInput As ADODB.Recordset
    Dim str诊断IDs As String
    Dim arrItem As Variant
    Dim strIDs As String
    
    On Error GoTo errH
    lng申请序号 = Get申请序号
    mblnRowChange = False
    
    strSQL = "Select a.名称,a.Id As 诊疗项目id, Null As 收费细目id,a.类别 As 类别ID From 诊疗项目目录 A where a.id=[1]"
    Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsCard!输血项目ID & ""))
    Call AdviceSet诊疗项目(rsInput, lngRow, Val(rsCard!输血途径项目ID & ""), 0, "", "")
    
    str诊断IDs = rsCard!临床诊断IDs & ""
    varTmp = Split(str诊断IDs, ",")
    For j = 0 To UBound(varTmp)
        If Val(varTmp(j)) > 0 Then
            Call Add申请单诊断(Val(varTmp(j)))
        End If
    Next
    
    '备血申请可能申请多个品种，此处重新设置名称列
    If gbln血库系统 = True Then
        arrItem = Split(rsCard!申请项目 & "", ";")
        strIDs = ""
        If UBound(arrItem) > 0 Then
            For i = 0 To UBound(arrItem)
                strIDs = strIDs & "," & Val(arrItem(i))
            Next
            strIDs = Mid(strIDs, 2)
            strSQL = "Select /*+ CARDINALITY(C 10) */" & vbNewLine & _
                "  f_List2str(Cast(Collect(a.名称) As t_Strlist)) 名称" & vbNewLine & _
                " From 诊疗项目目录 a, Table(f_Num2list([1])) b" & vbNewLine & _
                " Where a.Id = b.Column_Value"
            Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strIDs)
            If rsInput.EOF = False Then
                vsAdvice.TextMatrix(lngRow, COL_名称) = rsInput!名称
            End If
        End If
    End If
    
    With vsAdvice
        For j = lngRow To lngRow + 1
            '更新一些项目
            .TextMatrix(j, COL_标志) = rsCard!用血安排
            .TextMatrix(j, COL_开嘱时间) = rsCard!输血申请日期 '", adVarChar, 500
            .TextMatrix(j, COL_开始时间) = rsCard!输血申请日期
            .Cell(flexcpData, j, COL_开始时间) = .TextMatrix(j, COL_开始时间)
            .Cell(flexcpData, j, COL_开嘱时间) = .TextMatrix(j, COL_开嘱时间)
            .TextMatrix(j, COL_开嘱科室ID) = Val(rsCard!申请科室id & "")
            .TextMatrix(j, COL_申请序号) = lng申请序号
        Next
        .TextMatrix(lngRow, COL_输血时间) = rsCard!预定输血日期
        .TextMatrix(lngRow, COL_总量) = rsCard!预定输血量
        .TextMatrix(lngRow, COL_医生嘱托) = rsCard!备注
        .TextMatrix(lngRow, COL_用药理由) = rsCard!输血目的
        .TextMatrix(lngRow, COL_执行科室ID) = Val(rsCard!输血执行科室ID & "")
        .TextMatrix(lngRow + 1, COL_执行科室ID) = Val(rsCard!输血途径执行科室ID & "")
        .TextMatrix(lngRow + 1, COL_医生嘱托) = rsCard!滴速 & ""
        Set .Cell(flexcpData, lngRow, COL_申请序号) = zlDatabase.CopyNewRec(rsCard)
        .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
        .TextMatrix(lngRow, COL_用法) = .TextMatrix(lngRow, COL_用法) & rsCard!滴速
        '重新自动调整行高
        Call .AutoSize(col_医嘱内容)
    End With
    If str诊断IDs = "" Then
        Call SetDiagFlag(lngRow, 1, strDiags)
    Else
        Call SetDiagFlag(lngRow, 1, str诊断IDs)
    End If
    vsAdvice.Row = lngRow
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function Get手术附加必要时(ByVal lngRow As Long) As String
'功能：获取指定手术行的附加手术和是否必要时
'返回：手术ID1:必要时,手术ID2:必要时,...
    Dim strTmp As String, i As Long
    
    i = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), lngRow + 1, COL_相关ID)
    If i <> -1 Then
        For i = i To vsAdvice.Rows - 1
            If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = vsAdvice.RowData(lngRow) Then
                If vsAdvice.TextMatrix(i, COL_类别) <> "G" Then
                    strTmp = strTmp & "," & Val(vsAdvice.TextMatrix(i, COL_诊疗项目ID)) & ":" & Val(vsAdvice.TextMatrix(i, COL_执行标记))
                End If
            Else
                Exit For
            End If
        Next
    End If
    Get手术附加必要时 = Mid(strTmp, 2)
End Function


Private Sub GetData手术申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset)
'功能：从医嘱表格中获取数据生成对象只传新开状态的医嘱和未保存的医嘱数据
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    Dim str诊断 As String
    Dim str诊断IDs As String
    Dim strTmp As String
    Dim i As Long, j As Long
    Dim strExtData As String
    Dim strAppend As String
    
    On Error GoTo errH
    With vsAdvice
        If TypeName(.Cell(flexcpData, lngRow, COL_申请序号)) = "Recordset" Then
            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_申请序号))
        Else
            Call InitCardRsOperate(rsCard)
            rsCard.AddNew
        End If
        
        If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            str诊断IDs = GetAdviceDiag(.RowData(lngRow), str诊断)
            rsCard!临床诊断IDs = str诊断IDs
            rsCard!临床诊断描述 = str诊断
                
            .TextMatrix(lngRow, COL_附项) = Get病人医嘱附件(.RowData(lngRow))
            strAppend = .TextMatrix(lngRow, COL_附项)
            rsCard!申请附项 = strAppend
        End If
        
        rsCard!主手术项目ID = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
        
        strExtData = Get手术附加IDs(lngRow)
        
        rsCard!附手术必要时 = Get手术附加必要时(lngRow)
        
        If strExtData <> "" Then
            If InStr(strExtData, ";") > 0 Then
                rsCard!附手术项目IDs = Split(strExtData, ";")(0)
                rsCard!麻醉项目ID = Val(Split(strExtData, ";")(1))
                
                For j = lngRow + 1 To .Rows - 1
                    If Val(.TextMatrix(j, COL_相关ID)) = Val(.RowData(lngRow)) Then
                        If .TextMatrix(j, COL_类别) = "G" Then
                            rsCard!麻醉执行科室ID = Val(.TextMatrix(j, COL_执行科室ID))
                        End If
                    Else
                        Exit For
                    End If
                Next
            Else
                rsCard!附手术项目IDs = strExtData
            End If
        End If
        '手术情况 '门诊没有用到这个东西
        '申请附项
        '生效时间
        '手术时间
        rsCard!手术执行科室ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
        rsCard!手术时间 = .TextMatrix(lngRow, COL_手术时间)
        rsCard!生效时间 = .TextMatrix(lngRow, COL_开始时间)
        rsCard!申请科室id = Val(.TextMatrix(lngRow, COL_开嘱科室ID))
        rsCard.Update
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNew手术申请(ByVal intType As Integer, ByVal str项目IDs As String, ByRef rsCard As ADODB.Recordset) As Boolean
'功能：调用申请单
'参数：intType 0-新增,1-修改
    Dim lng项目id As Long
    Dim lng开嘱科室ID As Long
    
    On Error GoTo errH
 
    lng项目id = Val(str项目IDs)
    
    lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 1)
    
    If Not rsCard Is Nothing Then
        If Not rsCard.EOF Then
            If Val(rsCard!申请科室id & "") <> 0 Then
                lng开嘱科室ID = Val(rsCard!申请科室id & "")
            End If
        End If
    End If
    
    ApplyNew手术申请 = frmApplyOperation.ShowMe(Me, 1, intType, mlng病人ID, mstr挂号单, 1, 0, mlng病人科室id, lng开嘱科室ID, "", , , , 1, , lng项目id, rsCard, mlng前提ID)
      
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet手术申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset, ByVal strDiags As String) As Long
'功能：把检查申请单数据加载到表格中
    Dim objTmp As clsApplicationData
    Dim i As Long, j As Long, k As Long
    Dim lngCnt As Long, lng申请序号 As Long, lngCurRow As Long
    Dim strSQL As String, strAppend As String
    Dim varTmp As Variant, strTmp As String
    Dim rsInput As ADODB.Recordset
    Dim rsAppend As ADODB.Recordset
    Dim lngBegin As Long, lngEnd As Long
    Dim strExtData As String
    Dim bln麻醉 As Boolean
    Dim str附加必要时 As String
    Dim str诊断IDs As String
    
    On Error GoTo errH
    lng申请序号 = Get申请序号
    mblnRowChange = False
    lngBegin = lngRow
    
    strSQL = "Select a.名称,a.Id As 诊疗项目id, Null As 收费细目id,a.类别 As 类别ID From 诊疗项目目录 A where a.id=[1]"
    Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsCard!主手术项目ID & ""))
    
    If rsCard!附手术项目IDs & "" <> "" Then
        strExtData = rsCard!附手术项目IDs
        lngEnd = UBound(Split(strExtData, ",")) + 1
    End If
    
    str附加必要时 = rsCard!附手术必要时 & ""
    
    If Val(rsCard!麻醉项目ID & "") <> 0 Then
        If strExtData <> "" Then
            strExtData = strExtData & ";" & rsCard!麻醉项目ID
        Else
            strExtData = rsCard!麻醉项目ID
        End If
        lngEnd = lngEnd + 1
        bln麻醉 = True
    End If
    
    str诊断IDs = rsCard!临床诊断IDs & ""
    varTmp = Split(str诊断IDs, ",")
    For j = 0 To UBound(varTmp)
        If Val(varTmp(j)) > 0 Then
            Call Add申请单诊断(Val(varTmp(j)))
        End If
    Next
    
    
    lngEnd = lngBegin + lngEnd
    
    Call AdviceSet诊疗项目(rsInput, lngRow, 0, 0, strExtData, "")
    
    With vsAdvice
        For j = lngBegin To lngEnd
            .TextMatrix(j, COL_手术时间) = rsCard!手术时间
            .TextMatrix(j, COL_开始时间) = rsCard!生效时间
            .TextMatrix(j, COL_开嘱时间) = rsCard!生效时间
            .Cell(flexcpData, j, COL_开始时间) = .TextMatrix(j, COL_开始时间)
            .Cell(flexcpData, j, COL_开嘱时间) = .TextMatrix(j, COL_开嘱时间)
            .TextMatrix(j, COL_开嘱科室ID) = Val(rsCard!申请科室id & "")
            .TextMatrix(j, COL_执行科室ID) = Val(rsCard!手术执行科室ID & "")
            .TextMatrix(j, COL_申请序号) = lng申请序号
            If str附加必要时 <> "" Then
                .TextMatrix(j, COL_执行标记) = IIF(InStr(str附加必要时, .TextMatrix(j, COL_诊疗项目ID) & ":1") > 0, "1", "0")
            End If
        Next
        
        If bln麻醉 Then
            .TextMatrix(lngEnd, COL_执行科室ID) = Val(rsCard!麻醉执行科室ID & "")
        End If
        If rsCard!申请附项 & "" <> "" Then
            strAppend = rsCard!申请附项 & ""
        End If
        
        '更新附件内容:以当前可见行为准
        If strAppend <> "" Then
            .TextMatrix(lngRow, COL_附项) = strAppend
            .Cell(flexcpData, lngRow, COL_附项) = 1 '表明需要重新写入(新增或修改)
            Call ReplaceAdviceAppend(lngRow) '缺省替换其他医嘱的申请附项
        End If
        Set .Cell(flexcpData, lngRow, COL_申请序号) = zlDatabase.CopyNewRec(rsCard)
        .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
        '重新自动调整行高
        Call .AutoSize(col_医嘱内容)
        Call SetRow标志图标(lngRow, 0)
    End With
    If str诊断IDs = "" Then
        Call SetDiagFlag(lngRow, 1, strDiags)
    Else
        Call SetDiagFlag(lngRow, 1, str诊断IDs)
    End If
    vsAdvice.Row = lngRow
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub GetData检验申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset)
'功能：从医嘱表格中获取数据生成对象只传新开状态的医嘱和未保存的医嘱数据
    Dim rsCardBak As ADODB.Recordset
    Dim rsTmp As ADODB.Recordset
    Dim blnTmp As Boolean
    Dim strSQL As String
    Dim str诊断 As String
    Dim str诊断IDs As String
    Dim strTmp As String
    Dim var1 As Variant
    Dim var2 As Variant
    Dim i As Long, j As Long
    Dim strLIS As String
    Dim strResult As String
    Dim lng申请序号 As Long
    Dim strAppend As String
    
    On Error GoTo errH
    With vsAdvice
    
        If TypeName(.Cell(flexcpData, lngRow, COL_申请序号)) = "Recordset" Then
            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_申请序号))
        Else
            Call InitCardRsLIS(rsCard)
            rsCard.AddNew
        End If
        If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            str诊断IDs = GetAdviceDiag(Val(.RowData(lngRow)), str诊断)
            rsCard!临床诊断IDs = str诊断IDs
        End If
     
        lng申请序号 = Val(.TextMatrix(lngRow, COL_申请序号))
        For i = .FixedRows To .Rows - 1
            '检验医嘱显示行是采集方式
            If Val(.TextMatrix(i, COL_申请序号)) = lng申请序号 And Not .RowHidden(i) Then
         
                lngRow = i
                '采诊科室id , 执行科室id, 申请时间1, 标本1, 附项, 嘱托, 是否急症, 采集id, 诊疗项目id1
                strLIS = .TextMatrix(lngRow, COL_执行科室ID) & "<Split A>" & .TextMatrix(lngRow - 1, COL_执行科室ID) & "<Split A>" & .TextMatrix(lngRow, COL_开始时间) & _
                      "<Split A>" & .TextMatrix(lngRow, COL_标本部位)
                strAppend = .TextMatrix(lngRow, COL_附项)
                If strAppend = "" And Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
                     strAppend = Get病人医嘱附件(.RowData(lngRow))
                End If
                strLIS = strLIS & "<Split A>" & strAppend & "<Split A>" & .TextMatrix(lngRow, COL_医生嘱托) & "<Split A>" & Val(.TextMatrix(lngRow, COL_标志)) & "<Split A>" & .TextMatrix(lngRow, COL_诊疗项目ID) & "<Split A>" & .TextMatrix(lngRow - 1, COL_诊疗项目ID)
                If strLIS <> "" Then
                    strResult = strLIS & IIF(strResult = "", "", "<Split B>" & strResult)
                End If
            End If
        Next
        rsCard!申请信息 = strResult
        rsCard.Update
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNew检验申请(ByVal intType As Integer, ByVal str项目编码 As String, ByRef rsCard As ADODB.Recordset) As Boolean
'功能：调用申请单
'参数：intType 0-新增,1-修改
    Dim lng开嘱科室ID As Long
    Dim strSQL As String
    Dim rsPati As ADODB.Recordset
    Dim strResult As String
    Dim strDept As String
    Dim lng申请序号 As String
    Dim strDiag As String
    Dim blnCancel As Boolean
    Dim strErr As String
    Dim strLIS As String

    On Error GoTo errH

  
    '执行部门(号别科室)即病人科室
    strSQL = "Select A.姓名,A.性别,A.年龄,B.门诊号,B.住院号,B.健康号,a.ID as 挂号ID," & _
        " B.险类,B.就诊诊室,C.名称 as 执行部门,A.登记时间" & _
        " From 病人挂号记录 A,病人信息 B,部门表 C" & _
        " Where A.NO(+)=[2] And a.记录性质(+)=1 And a.记录状态(+)=1 And B.病人ID=[1]" & _
        " And A.病人ID(+)=B.病人ID And A.执行部门ID=C.ID(+)"
    If mblnMoved Then
        strSQL = Replace(strSQL, "病人挂号记录", "H病人挂号记录")
    End If
    Set rsPati = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mstr挂号单)
    
    If rsPati.RecordCount = 0 Then
        MsgBox "未能正确读取病人信息！", vbInformation, gstrSysName
        Exit Function
    End If
    
    strDept = Sys.RowValue("部门表", mlng挂号科室ID, "名称")
    Call InitObjLis(p门诊医嘱下达)
    If gobjLIS Is Nothing Then Exit Function
    Call CreatePlugInOK(p门诊医嘱下达, mint场合)
    On Error GoTo errH
    If Not rsCard Is Nothing Then
        If Not rsCard.EOF Then
            strLIS = rsCard!申请信息 & ""
            strDiag = rsCard!临床诊断IDs & ""
        End If
    End If
    strResult = gobjLIS.ShowLisApplicationForm(mfrmParent, 0, mlng病人ID, CByte(mint婴儿), Val("" & rsPati!挂号ID), rsPati!姓名, "" & rsPati!性别, "" & rsPati!年龄, 1, _
        Val("" & rsPati!门诊号), Val("" & rsPati!住院号), Val("" & rsPati!健康号), strDiag, UserInfo.姓名, UserInfo.部门ID, UserInfo.部门名, mlng挂号科室ID, strDept, blnCancel, strErr, strLIS, str项目编码)
    
    If strErr <> "" Then
        MsgBox "检验接口内部错误：" & strErr, vbInformation, gstrSysName
        Exit Function
    ElseIf blnCancel Then
        Exit Function
    ElseIf strResult = "" Then
        Exit Function
    End If
    
    Call InitCardRsLIS(rsCard)
    rsCard.AddNew Array("临床诊断IDs", "申请信息"), Array(strDiag, strResult)
    ApplyNew检验申请 = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet检验申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset, ByVal strDiags As String) As Long
'功能：把检查申请单数据加载到表格中
    Dim i As Long, j As Long
    Dim varTmp As Variant
    Dim lng申请序号 As Long
    Dim strLIS As String
    Dim str诊断 As String
    Dim str附项 As String
    Dim str附项诊断 As String
    Dim rsLISInfo As ADODB.Recordset
    Dim rsTmp As ADODB.Recordset
    Dim lng检验项目ID As Long
    Dim lng申请组号 As Long '一组一个申请序号,可以一次申请多个申请,如果是耐受试验,一个项目就是一个申请序号
    Dim lng数量 As Long
    
    On Error GoTo errH

    mblnRowChange = False
    lng申请组号 = -1
    str诊断 = rsCard!临床诊断IDs & ""
    If str诊断 <> "" Then
        str附项诊断 = GetDiag诊断描述(str诊断)
        If str附项诊断 <> "" Then
            str附项诊断 = "申请单诊断<Split2>0<Split2><Split2>" & str附项诊断
        End If
        varTmp = Split(str诊断, ",")
        For j = 0 To UBound(varTmp)
            If Val(varTmp(j)) > 0 Then
                Call Add申请单诊断(Val(varTmp(j)))
            End If
        Next
    End If
    
    strLIS = rsCard!申请信息 & ""
    varTmp = Split(strLIS, "<Split B>")

     '在该方法中对rsLISInfo, rsTmp赋值
    Call LisInfoTrans(strLIS, rsLISInfo, rsTmp)
    For i = 1 To rsLISInfo.RecordCount
        If i <> 1 Then
            vsAdvice.AddItem "", lngRow + 1
            lngRow = lngRow + 1
        End If
        If lng申请组号 <> Val(rsLISInfo!组号 & "") Then
            lng申请组号 = Val(rsLISInfo!组号 & "")
            lng申请序号 = Get申请序号
        End If
    
        Call AdviceSet检验组合(lngRow, Val(rsLISInfo!采集项目ID & ""), rsLISInfo!检验项目ID & ";" & rsLISInfo!标本, , , True)
        lng检验项目ID = Val(rsLISInfo!检验项目ID & "")
        lng数量 = 1 '检验医嘱行的数量
        lngRow = lngRow + lng数量
        With vsAdvice
            For j = lngRow - lng数量 To lngRow
                .TextMatrix(j, COL_标志) = Val(rsLISInfo!紧急 & "")
                .TextMatrix(j, COL_开嘱时间) = Format(CDate(rsLISInfo!开始执行时间 & ""), "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, j, COL_开嘱时间) = .TextMatrix(j, COL_开嘱时间)
                .TextMatrix(j, COL_申请序号) = lng申请序号
                .TextMatrix(j, COL_执行科室ID) = Val(rsLISInfo!执行科室ID & "")   '检验执行科室ID,采集执行科室ID后续会重新赋值
                .TextMatrix(j, COL_皮试结果) = ""
                    .Cell(flexcpData, j, COL_皮试结果) = rsLISInfo!时间ID & "" '耐受试验时间ID
            Next
            .TextMatrix(lngRow, COL_执行科室ID) = Val(rsLISInfo!采集科室ID & "") '更新采集执行科室ID
            .TextMatrix(lngRow, COL_医生嘱托) = rsLISInfo!嘱托 & ""
            .TextMatrix(lngRow, COL_诊疗项目ID) = Val(rsLISInfo!采集项目ID & "")
            str附项 = rsLISInfo!附项 & ""
            If str附项 <> "" And str附项诊断 <> "" Then
                str附项 = str附项诊断 & "<Split1>" & str附项
            ElseIf str附项 = "" And str附项诊断 <> "" Then
                str附项 = str附项诊断
            End If
            If str附项 <> "" Then
                .TextMatrix(lngRow, COL_附项) = str附项
                .Cell(flexcpData, lngRow, COL_附项) = 1
            End If
            Set .Cell(flexcpData, lngRow, COL_申请序号) = zlDatabase.CopyNewRec(rsCard)
            .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow) & rsLISInfo!时间内容 & ""
            .TextMatrix(lngRow, COL_单价) = GetItemPrice(lngRow)
            Call .AutoSize(col_医嘱内容)
        End With
        If str诊断 = "" Then
            Call SetDiagFlag(lngRow, 1, strDiags)
        Else
            Call SetDiagFlag(lngRow, 1, str诊断)
        End If
        Call SetRow标志图标(lngRow, 0)
        rsLISInfo.MoveNext
    Next
    vsAdvice.Row = lngRow
    Call CalcAdviceMoney '显示新开医嘱金额
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub dkpMain_AttachPane(ByVal Item As XtremeDockingPane.IPane)
    If Item.ID = 1 Then
        Item.Handle = picPanel(e常用项目).hwnd
    End If
End Sub

Private Sub MakeAppNo(ByVal intType As Integer, ByVal lngBegin As Long, ByVal lngEnd As Long)
'功能：给表格上的医嘱数据产生申请序号
'参数：lngBegin - lngEnd 表格行的范围，intType －1 单组医嘱，2－多组医嘱
    Dim str类别 As String
    Dim lngNo As Long
    Dim lng项目id As Long
    Dim i As Long, j As Long
    Dim lng组ID As Long
    Dim lngPre组ID As Long
    Dim lngStart As Long
    Dim lngStop As Long
    
    On Error GoTo errH
    With vsAdvice
        If intType = 1 Then
            str类别 = .TextMatrix(lngBegin, COL_类别)
            lng项目id = Val(.TextMatrix(lngBegin, COL_诊疗项目ID))
            Select Case str类别
            Case "D", "F", "C"
                If CanUseApply(str类别, lng项目id) Then
                    lngNo = -1 * Get申请序号
                End If
            Case "K"
                If CanUseApply("K", lng项目id) Then
                    lngNo = -1 * Get申请序号
                End If
            End Select
            If lngNo <> 0 Then
                For i = lngBegin To lngEnd
                    .TextMatrix(i, COL_申请序号) = lngNo
                Next
            End If
        Else
            For i = lngBegin To lngEnd
                If Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                    lng组ID = .RowData(i)
                Else
                    lng组ID = Val(.TextMatrix(i, COL_相关ID))
                End If
                
                lngStop = -1
                lngStart = i
                For j = i + 1 To lngEnd
                    If lng组ID = IIF(Val(.TextMatrix(j, COL_相关ID)) = 0, Val(.RowData(j)), Val(.TextMatrix(j, COL_相关ID))) Then
                        lngStop = j
                    Else
                        Exit For
                    End If
                Next
                If lngStop = -1 Then lngStop = lngStart
                
                Call MakeAppNo(1, lngStart, lngStop)
                
                If lngStop = lngEnd Then
                    Exit Sub
                Else
                    i = lngStop
                End If
            Next
        End If
    End With
    Exit Sub
errH:
    If ErrCenter = 1 Then
        Resume
    End If
End Sub

Private Sub tbcSub_SelectedChanged(ByVal Item As XtremeSuiteControls.ITabControlItem)
'功能：刷新子窗体界面及数据
'说明：仅在人为切换界面卡片激活
    Dim objControl As CommandBarControl
    Dim Index As Long, objItem As TabControlItem
    Dim lng类型 As Long, objTmp As Object
    Dim lngHwnd As Long, rsTmp As ADODB.Recordset
    Dim strCurTag As String
    
    If mblnTabTmp Then Exit Sub
    If Item.Tag = "" Then Exit Sub '初始添卡时,还没赋值
    If Item.Handle = picHwndTab.hwnd Then
        Index = Item.Index
        mblnTabTmp = True
        Screen.MousePointer = 11
        
        If mcolDE Is Nothing Then Set mcolDE = New Collection
         
        mrsSubForm.Filter = "ID=" & Index
        lng类型 = Val(mrsSubForm!类型 & "")
        Select Case lng类型
        Case 1
            Set mobjPati = CreateObject("zl9CISJob.clsDockPatiInfo")
            Set objItem = tbcSub.InsertItem(Index, "病人信息", mobjPati.zlGetForm.hwnd, 0)
                objItem.Tag = "病人信息"
                
            Call tbcSub.RemoveItem(Index + 1)
            Call mobjPati.zlRefresh(mlng病人ID, mlng挂号ID, False, mblnMoved, mclsMipModule, 1)
            Call mobjPati.SetFontSize(mbytSize)
        Case 2
            Set objTmp = New zlRichEPR.cDockEdit
            lngHwnd = objTmp.GetOutEPREditForm(Me, Val(mrsSubForm!业务ID & ""), mlng病人ID, mlng挂号ID, mlng病人科室id)
            
            Set objItem = tbcSub.InsertItem(Index, mrsSubForm!标题 & "", lngHwnd, 0)
                objItem.Tag = "_" & Index & "_" & mrsSubForm!业务ID & "_<老>" & mrsSubForm!标题
            Call tbcSub.RemoveItem(Index + 1)
            mcolDE.Add objTmp, "_" & Index & "_" & mrsSubForm!业务ID & "_<老>" & mrsSubForm!标题
        Case 3
            Set objTmp = CreateObject("zl9EmrInterface.ClsEmrInterface")
            Call objTmp.GetOutEPRFileRecord(mlng挂号ID & "", rsTmp)
            Call objTmp.GetOutEPREditForm(mrsSubForm!业务ID & "", mlng挂号ID & "", lngHwnd)
            Set objItem = tbcSub.InsertItem(Index, mrsSubForm!标题 & "", lngHwnd, 0)
                objItem.Tag = mrsSubForm!标题 & ""
            Call tbcSub.RemoveItem(Index + 1)
            mcolDE.Add objTmp, "_" & mrsSubForm!业务ID & "_<新>" & mrsSubForm!标题
        End Select
        objItem.Selected = True
        strCurTag = objItem.Tag
        Set objItem = Nothing
        Screen.MousePointer = 0
        mblnTabTmp = False
        tbcSub.Height = tbcSub.Height - 10
    Else
        strCurTag = Item.Tag
    End If
    
    '对于老版病历每次都重新加载
    If InStr(mstrPreTab, "_<老>") > 0 Then
        Index = Split(mstrPreTab, "_")(1)
        mblnTabTmp = True
        Set objTmp = mcolDE(mstrPreTab)
        If objTmp.DocModified Then
            If MsgBox("您刚才书写的病历【" & Split(mstrPreTab, "_<老>")(1) & "】内容已修改，是否保存？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbYes Then
                '是否修改判断
                Call objTmp.SaveDoc
            End If
        End If
        Set objTmp = Nothing
        Set objItem = tbcSub.InsertItem(Index, Split(mstrPreTab, "_<老>")(1), picHwndTab.hwnd, 0)
        objItem.Tag = "老病历"
        Call tbcSub.RemoveItem(Index + 1)
        Call mcolDE.Remove(mstrPreTab)
        mblnTabTmp = False
    End If
    
    If mstrPreTab = "病人信息" And Not mobjPati Is Nothing Then
        Call mobjPati.zlGetForm.UpdateLastItem
        If Not mblnOK Then mblnOK = mobjPati.zlGetForm.IsDataSaved
    End If
    
    If mstrPreTab = "病人信息" And Not mblnNoSave Then
        If Item.Tag = "医嘱编辑" And Me.Visible Then
            Call LoadDiagInfo
            Call ReLoadAdvice(mlng医嘱ID)
        End If
    End If
    
    If strCurTag = "病人信息" Then
        If Not mobjPati Is Nothing Then Call mobjPati.zlRefresh(mlng病人ID, mlng挂号ID, False, mblnMoved, mclsMipModule, 1)
    End If
    Call Form_Resize
    mstrPreTab = strCurTag
    Exit Sub
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub InitRsSubFrm(ByRef rsSFrm As ADODB.Recordset)
'功能：初始化页签相关信息
    Set rsSFrm = New ADODB.Recordset
    rsSFrm.Fields.Append "ID", adBigInt
    rsSFrm.Fields.Append "标题", adVarChar, 3000
    rsSFrm.Fields.Append "业务ID", adVarChar, 1000
    rsSFrm.Fields.Append "类型", adBigInt '1-病人信息，2－老版病历，3－新版病历
    rsSFrm.CursorLocation = adUseClient
    rsSFrm.LockType = adLockOptimistic
    rsSFrm.CursorType = adOpenStatic
    rsSFrm.Open
End Sub

Private Function GetPlugInFrms() As String
'功能：获取外挂页签相关信息
    Dim strTmp As String, arrTmp As Variant
    Dim i As Long, objForm As Object, strNames As String
    
    Call CreatePlugInOK(p门诊医嘱下达, mint场合)
    
    If Not gobjPlugIn Is Nothing Then
        Set mcolSubForm = New Collection
        On Error Resume Next
        strTmp = gobjPlugIn.GetFormCaption(glngSys, p门诊医嘱下达)
        Call zlPlugInErrH(err, "GetFormCaption")
        If strTmp <> "" Then
            arrTmp = Split(strTmp, ",")
            For i = 0 To UBound(arrTmp)
                strTmp = arrTmp(i)
                Set objForm = gobjPlugIn.GetForm(glngSys, p门诊医嘱下达, strTmp)
                Call zlPlugInErrH(err, "GetForm")
                If Not objForm Is Nothing Then
                    mcolSubForm.Add objForm, "_" & strTmp
                    strNames = strNames & "," & strTmp
                End If
                Set objForm = Nothing
            Next
        End If
        err.Clear: On Error GoTo 0
    End If
    GetPlugInFrms = Mid(strNames, 2)
End Function

Private Function GetNext医嘱ID() As Long
'功能：生成临时的医嘱ID
    mlngID序列 = mlngID序列 - 1
    GetNext医嘱ID = mlngID序列
End Function

Private Function GetID指定值(ByRef colIn As Collection, ByVal strKey As String) As Long
'功能：获取指定的真实医嘱ID，用集合方式生成键值对
    Dim strID As String
    
    On Error Resume Next
    
    strID = colIn(strKey)
    If err.Number <> 0 Then
        strID = zlDatabase.GetNextID("病人医嘱记录")
        colIn.Add strID, strKey
    End If
    err.Clear
    
    GetID指定值 = Val(strID)
End Function

Private Sub MakeRealID()
'功能：将医嘱表格中的医嘱ID生成为真实的医嘱ID，包含诊断医嘱对应中的医嘱ID
'说明：提交数据时可能失败，可能会被重复执行，可以用当前值是否大于0进行判断，只有本次新的医嘱才需要重新产生
    Dim i As Long, j As Long
    Dim colID As New Collection
    Dim varTmp As Variant
    Dim str医嘱IDs As String
    Screen.MousePointer = 11
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If InStr("1,2", Val(.TextMatrix(i, COL_EDIT))) > 0 Then   '所有医嘱记录
                If Val(.RowData(i)) < 0 Then
                    .RowData(i) = GetID指定值(colID, CStr(.RowData(i)))
                End If
                If Val(.TextMatrix(i, COL_相关ID)) < 0 Then
                    .TextMatrix(i, COL_相关ID) = GetID指定值(colID, CStr(Val(.TextMatrix(i, COL_相关ID))))
                End If
            End If
        Next
    End With
    
    With vsDiag
        For i = .FixedRows To .Rows - 1
            If Trim(.TextMatrix(i, col诊断)) <> "" Then
                If "" <> .TextMatrix(i, col医嘱ID) Then
                    varTmp = Split(.TextMatrix(i, col医嘱ID), ",")
                    str医嘱IDs = ""
                    For j = 0 To UBound(varTmp)
                        If Val(varTmp(j)) < 0 Then
                            str医嘱IDs = str医嘱IDs & "," & GetID指定值(colID, CStr(Val(varTmp(j))))
                        Else
                            str医嘱IDs = str医嘱IDs & "," & Val(varTmp(j))
                        End If
                    Next
                    .TextMatrix(i, col医嘱ID) = Mid(str医嘱IDs, 2)
                End If
            End If
        Next
    End With
    
    '替换 mrsAD 诊断对应中的假医嘱ID
    mrsAD.Filter = 0
    For i = 1 To mrsAD.RecordCount
        str医嘱IDs = mrsAD!医嘱ID
        If Val(str医嘱IDs) < 0 Then
            mrsAD!医嘱ID = GetID指定值(colID, str医嘱IDs)
        End If
        mrsAD.MoveNext
    Next
    Screen.MousePointer = 0
End Sub
        
Private Sub SetDiagInputLast(ByVal lngRow As Long, ByRef rsTmp As ADODB.Recordset)
'功能：添加一条上次诊断
    Dim i As Long
    Dim strTmp As String
    Dim blnDo As Boolean
    
    With vsDiag
        i = lngRow
        If Val(.RowData(i)) = 0 Then
            mlngDSeq = mlngDSeq + 1
            .RowData(i) = mlngDSeq
        End If
        
        Call SetDiagType(i, rsTmp!诊断类型)
    
        If IsNull(rsTmp!诊断描述) Then
            .TextMatrix(i, col编码) = ""
            .TextMatrix(i, col诊断) = ""
        Else
            If Mid(rsTmp!诊断描述, 1, 1) <> "(" Or (Val(rsTmp!诊断id & "") = 0 And Val(rsTmp!疾病id & "") = 0) Then '中医的诊断描述后面加了（候症），所以只判断第一个字符
                '由于疾病编码和诊断可以对应，如果两个都不为空的时候，先判断疾病编码，先取疾病编码
                If Val(rsTmp!疾病id & "") <> 0 Then
                    .TextMatrix(i, col编码) = NVL(rsTmp!ICD码)
                ElseIf Val(rsTmp!诊断id & "") <> 0 Then
                    .TextMatrix(i, col编码) = NVL(rsTmp!诊断编码)
                Else
                    .TextMatrix(i, col编码) = ""
                End If
                .TextMatrix(i, col诊断) = rsTmp!诊断描述
            Else
                .TextMatrix(i, col编码) = Mid(rsTmp!诊断描述, 2, InStr(rsTmp!诊断描述, ")") - 2)
                .TextMatrix(i, col诊断) = Mid(rsTmp!诊断描述, InStr(rsTmp!诊断描述, ")") + 1)
            End If
        End If
    
        .Cell(flexcpData, i, col疑诊) = Val(NVL(rsTmp!是否疑诊, 0))
        .Cell(flexcpForeColor, i, col疑诊) = IIF(NVL(rsTmp!是否疑诊, 0) = 1, vbRed, .GridColor)
    
        .TextMatrix(i, col诊断ID) = NVL(rsTmp!诊断id, 0)
        .Cell(flexcpData, i, col诊断ID) = NVL(rsTmp!ID, 0)
        .TextMatrix(i, col疾病ID) = NVL(rsTmp!疾病id, 0)
        .TextMatrix(i, col证候ID) = NVL(rsTmp!证候id, 0)
        .TextMatrix(i, colICD码) = NVL(rsTmp!ICD码)
        .TextMatrix(i, col发病时间) = Format(rsTmp!发病时间 & "", "YYYY-MM-DD HH:mm")
        '取证候名称
        If InStr(.TextMatrix(i, col诊断), "(") > 0 And InStr(.TextMatrix(i, col诊断), ")") > 0 Then
            strTmp = Mid(.TextMatrix(i, col诊断), InStrRev(.TextMatrix(i, col诊断), "(") + 1)
            strTmp = Mid(strTmp, 1, Len(strTmp) - 1)
            '先取证候
            .TextMatrix(i, col中医证候) = strTmp
            '去掉诊断描述的证候
            .TextMatrix(i, col诊断) = Mid(.TextMatrix(i, col诊断), 1, InStrRev(.TextMatrix(i, col诊断), "(") - 1)
        Else
           .TextMatrix(i, col中医证候) = ""
        End If
        '自由录入诊断的诊断描述，需要去掉证候，因此此句代码后移
        If Not IsNull(rsTmp!疾病id) Or Not IsNull(rsTmp!诊断id) Then
            .Cell(flexcpData, i, col诊断) = Get诊断描述(Val("" & rsTmp!诊断id), Val("" & rsTmp!疾病id))    '获取原始名称以便修改时判断
        Else
            .Cell(flexcpData, i, col诊断) = .TextMatrix(i, col诊断)
        End If
        
        If optState(1).value = False Then '不为复诊，则检查
           Call PatiReSeeDoctor(lngRow)
        End If
        'PASS 诊断录入
        If mblnPass Then
            zlPassDrugs
        End If
        '将本次录入尚未关联诊断的医嘱与当前诊断关联
        If vsDiag.TextMatrix(lngRow, col诊断) <> "" Then
            blnDo = False
            With vsAdvice
                For i = .FixedRows To .Rows - 1
                    If .RowData(i) <> 0 And Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                        If Val(.TextMatrix(i, COL_状态)) = 1 And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                            mrsAD.Filter = "医嘱ID=" & Val(.RowData(i))
                            If mrsAD.EOF Then
                                Call SetDiagFlag(i, 1, Val(vsDiag.RowData(lngRow)))
                                blnDo = True
                            End If
                        End If
                    End If
                Next
            End With
            If blnDo Then
                Call ShowDiagFlag(vsAdvice.Row)
            End If
        End If

        mblnNoSave = True: lbl诊断.Tag = "1"
        Call SetDiagHeight
    End With
End Sub

Private Sub SetDiagHeight()
    Dim i As Long
    Dim lngTmp As Long
    
    lngTmp = IIF(mbytSize = 0, 300, 375)
    For i = 0 To vsDiag.Rows - 1
        vsDiag.RowHeight(i) = lngTmp
    Next
    lngTmp = lngTmp * IIF(vsDiag.Rows > M_LNG_DIAGCOUNT, M_LNG_DIAGCOUNT, vsDiag.Rows)
    vsDiag.Height = lngTmp + 2 * Screen.TwipsPerPixelY
    fra诊断.Height = vsDiag.Height + 4 * Screen.TwipsPerPixelY
    Call Form_Resize
End Sub

Private Sub vsDiag_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
    Dim i As Long
    
    With vsDiag
        If NewCol <> col诊断 Or OldRow <> NewRow Then picPanel(e诊断表格).Visible = False
        '清除图片
        For i = .FixedRows To .Rows - 1
            If Not .Cell(flexcpPicture, i, COL增加) Is Nothing Then
                Set .Cell(flexcpPicture, i, COL增加) = Nothing
            End If
            If Not .Cell(flexcpPicture, i, colDel) Is Nothing Then
               Set .Cell(flexcpPicture, i, colDel) = Nothing
            End If
        Next
        
        If NewCol = col标志 Then
            .FocusRect = flexFocusLight
        End If
        '设置编辑可见特性
        If Not DiagCellEditable(NewRow, NewCol) Then
            .ComboList = ""
            .FocusRect = flexFocusLight
        Else
            .FocusRect = flexFocusSolid
            Set .CellButtonPicture = Nothing
            If NewCol = col诊断 Then
                .ComboList = "..."
            ElseIf NewCol = COL增加 Then
                .ComboList = "..."
                .FocusRect = flexFocusNone
                Set .CellButtonPicture = imgButtonNew.Picture
            ElseIf NewCol = colDel Then
                .ComboList = "..."
                .FocusRect = flexFocusNone
                Set .CellButtonPicture = imgButtonDel.Picture
            ElseIf NewCol = col中医证候 Then
                If .TextMatrix(NewRow, col诊断) = "" Then
                    .ComboList = ""
                    .FocusRect = flexFocusLight
                Else
                    .ComboList = "..."
                End If
            Else
                .ComboList = ""
            End If
        End If
        If NewRow >= .FixedRows Then
            '显示图片
            If NewCol <> COL增加 And .TextMatrix(NewRow, col诊断) <> "" Then
                Set .Cell(flexcpPicture, NewRow, COL增加) = imgButtonNew.Picture
            End If
            '显示图片
            If NewCol <> colDel Then
                Set .Cell(flexcpPicture, NewRow, colDel) = imgButtonDel.Picture
            End If
        End If
    End With
End Sub

Private Sub vsDiag_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    '在StartEdit事件中处理会显示出前一列的按钮
    If Col = col疑诊 Then Cancel = True
End Sub

Private Sub vsDiag_Click()
    With vsDiag
        If (.MouseCol = COL增加 Or .MouseCol = colDel) And .MouseRow >= .FixedRows Then
            If .MouseCol = COL增加 Then
                If .TextMatrix(.MouseRow, col诊断) = "" Then Exit Sub
            End If
            
            .Select .MouseRow, .MouseCol
            Call vsDiag_CellButtonClick(.MouseRow, .MouseCol)
        End If
    End With
End Sub

Private Sub vsDiag_BeforeRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long, Cancel As Boolean)
    If (NewCol = COL中医 Or NewCol = COL西医) And vsDiag.TextMatrix(NewRow, col诊断) <> "" Then
        Cancel = True
    End If
End Sub

Private Sub vsDiag_AfterEdit(ByVal Row As Long, ByVal Col As Long)
    With vsDiag
        If Col = col诊断 Then
            ' .EditText = "" 排除单元格有内容并按回车的状况
            If .EditText = "" And .Cell(flexcpData, Row, Col) <> "" Then
                '在调用vsDiagXY_KeyDown(vbKeyDelete, 0)点是可以删除当前行，点否则恢复原始数据
                .TextMatrix(Row, Col) = .Cell(flexcpData, Row, Col)
                Call vsDiag_KeyDown(vbKeyDelete, 0)
            End If
        End If
        If .Col = Col Then Call vsDiag_AfterRowColChange(Row, -1, Row, Col)
    End With
End Sub

Private Function DiagCellEditable(ByVal lngRow As Long, ByVal lngCol As Long) As Boolean
    Dim i As Long
    
    With vsDiag
        If .ColHidden(lngCol) Then Exit Function
        If .TextMatrix(lngRow, col医嘱ID) <> "" Then
            If lngCol = col诊断 Then
                For i = 1 To vsAdvice.Rows - 1
                    If InStr("," & .TextMatrix(lngRow, col医嘱ID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_状态) = "8" Then
                        Exit Function
                    End If
                    '医技工作站调用,若诊断关联医嘱,存在医嘱的开嘱医生非当前操作员,则不允许删除诊断
                    If mint场合 = 2 And InStr("," & .TextMatrix(lngRow, col医嘱ID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_开嘱医生) <> UserInfo.姓名 Then
                        Exit Function
                    End If
                Next
            End If
        End If
        '必须先输入诊断
        If .TextMatrix(lngRow, col诊断) = "" Then
            If lngCol = col疑诊 Or lngCol = COL增加 Or lngCol = col发病时间 Then
                Exit Function
            End If
        End If
        If lngCol = col编码 Then Exit Function
        '必须先输诊断再输证候
        If lngCol = col中医证候 Then
            If .TextMatrix(lngRow, col诊断) = "" Then Exit Function
            If .Cell(flexcpData, lngRow, COL中医) <> 1 Then Exit Function
        End If
    End With
    DiagCellEditable = True
End Function

Private Sub vsDiag_CellChanged(ByVal Row As Long, ByVal Col As Long)
    With vsDiag
        If Col = col诊断 Then
            .TextMatrix(Row, col疑诊) = IIF(.TextMatrix(Row, Col) <> "", "？", "")
        End If
    End With
End Sub

Private Sub vsDiag_DblClick()
    Call vsDiag_KeyPress(32)
End Sub

Private Sub vsDiag_GotFocus()
    If Me.Visible Then vsDiag_AfterRowColChange -1, -1, vsDiag.Row, vsDiag.Col
End Sub

Private Sub vsDiag_KeyDown(KeyCode As Integer, Shift As Integer)
    Dim blnDo As Boolean, i As Long
    Dim int诊断类型 As Integer
    
    With vsDiag
        If KeyCode = vbKeyF4 Then
            If .Col = col诊断 Then
                Call zlCommFun.PressKey(vbKeySpace)
            End If
        ElseIf KeyCode = vbKeyDelete Then
            '检查是否允许删除
            For i = 1 To vsAdvice.Rows - 1
                If InStr("," & .TextMatrix(.Row, col医嘱ID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_状态) = "8" Then
                    MsgBox "该诊断对应的处方已发送，不能删除。", vbInformation, Me.Caption
                    Exit Sub
                End If
                '医技工作站调用,若诊断关联医嘱,存在医嘱的开嘱医生非当前操作员,则不允许删除诊断
                If mint场合 = 2 And InStr("," & .TextMatrix(.Row, col医嘱ID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_开嘱医生) <> UserInfo.姓名 Then
                    MsgBox "该诊断存在关联医嘱,且该医嘱非您下达，不能删除。", vbInformation, Me.Caption
                    Exit Sub
                End If
            Next
            blnDo = True
            If .TextMatrix(.Row, col诊断) <> "" Then
                If MsgBox("确实要删除该行诊断信息吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then blnDo = False
            End If
            If blnDo Then
                If .TextMatrix(.Row, col诊断) <> "" Then
                    lbl诊断.Tag = "1"
                    mblnNoSave = True
                    '删除主/次要诊断后调用外挂接口
                    If CreatePlugInOK(p门诊医嘱下达, mint场合) Then
                        On Error Resume Next
                        Call gobjPlugIn.DiagnosisDeleted(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, IIF(opt诊断(0).value, Val(.TextMatrix(.Row, col诊断ID)), Val(.TextMatrix(.Row, col疾病ID))), .TextMatrix(.Row, col诊断), mint场合)
                        Call zlPlugInErrH(err, "DiagnosisDeleted")
                        err.Clear: On Error GoTo 0
                    End If
                    If mblnPass Then
                        zlPassDrugs
                    End If
                    '删除对应关系
                    mrsAD.Filter = "诊断ID=" & Val(.RowData(.Row))
                    If Not mrsAD.EOF Then
                        Do While Not mrsAD.EOF
                            mrsAD.Delete
                            mrsAD.MoveNext
                        Loop
                    End If
                End If
                
                If .Rows = 2 And .Row = 1 Then
                    int诊断类型 = IIF(.Cell(flexcpData, .Row, COL中医) = 1, 11, 1)
                    .Cell(flexcpText, .Row, 0, .Row, .Cols - 1) = ""
                    .Cell(flexcpData, .Row, 0, .Row, .Cols - 1) = Empty
                    Set .Cell(flexcpPicture, .Row, 0, .Row, .Cols - 1) = Nothing
                    Call SetDiagType(.Row, int诊断类型)
                Else
                    .RemoveItem .Row
                    Call SetDiagHeight
                End If
            End If
            .SetFocus
        ElseIf KeyCode > 127 Then
            '解决直接输入汉字的问题
            Call vsDiag_KeyPress(KeyCode)
        End If
    End With
End Sub

Private Sub vsDiag_KeyPress(KeyAscii As Integer)
    Dim i As Long
    Dim strTmp As String
    Dim lng组ID As Long
    
    With vsDiag
        If KeyAscii = 13 Then
            KeyAscii = 0
            Call DiagEnterNextCell
        ElseIf KeyAscii = 32 And (.Col = col疑诊 Or .Col = COL中医 Or .Col = COL西医 Or .Col = col标志) Then
            KeyAscii = 0
            If .Col = col标志 And Val(.RowData(.Row)) <> 0 Then
                '设置诊断和旗标
                strTmp = .RowData(.Row)
                i = AdviceHaveDiag(vsAdvice.Row, 1, strTmp)
                Call SetDiagFlag(vsAdvice.Row, IIF(0 = i, 3, 0), strTmp)
                .Col = col诊断
                i = vsAdvice.Row
                lng组ID = IIF(Val(vsAdvice.TextMatrix(i, COL_相关ID)) <> 0, Val(vsAdvice.TextMatrix(i, COL_相关ID)), vsAdvice.RowData(i))
                i = .Row
                mrsAD.Filter = "诊断ID=" & strTmp & " and 医嘱ID=" & lng组ID
                If Not mrsAD.EOF Then
                    Set .Cell(flexcpPicture, i, col标志) = img16.ListImages("诊断_当前").Picture
                     .Cell(flexcpPictureAlignment, i, col标志) = 4
                Else
                    mrsAD.Filter = "诊断ID=" & strTmp
                    If Not mrsAD.EOF Then
                        Set vsDiag.Cell(flexcpPicture, i, col标志) = img16.ListImages("诊断_关联").Picture
                         .Cell(flexcpPictureAlignment, i, col标志) = 4
                    Else
                        Set .Cell(flexcpPicture, i, col标志) = Nothing
                    End If
                End If
            End If
            If .Col = COL中医 Then
                If .Cell(flexcpData, .Row, COL中医) = 0 Then
                    Call SetDiagType(.Row, 11): .Col = col诊断
                End If
            ElseIf .Col = COL西医 Then
                If .Cell(flexcpData, .Row, COL西医) = 0 Then
                    Call SetDiagType(.Row, 1): .Col = col诊断
                End If
            ElseIf .Col = col疑诊 Then
                If DiagCellEditable(.Row, .Col) Then
                    KeyAscii = 0
                    .Cell(flexcpData, .Row, .Col) = IIF(.Cell(flexcpData, .Row, .Col) = 1, 0, 1)
                    .Cell(flexcpForeColor, .Row, .Col) = IIF(.Cell(flexcpData, .Row, .Col) = 1, vbRed, .GridColor)
                    
                    lbl诊断.Tag = "1"
                    mblnNoSave = True
                End If
            End If
        Else
            If .Col = col诊断 Or .Col = col中医证候 Then
                If KeyAscii = Asc("*") Then
                    KeyAscii = 0
                    Call vsDiag_CellButtonClick(.Row, .Col)
                Else
                    .ComboList = "" '使按钮状态进入输入状态
                End If
            End If
        End If
    End With
    If KeyAscii = vbKeyEscape Then
        picPanel(e诊断表格).Visible = False
    End If
End Sub

Private Sub DiagEnterNextCell()
    Dim i As Long, j As Long
    
    With vsDiag
        '从下一单元开始循环搜索
        For i = .Row To .Rows - 1
            For j = IIF(i = .Row, .Col + 1, col诊断) To COL增加
                If DiagCellEditable(i, j) And .ColWidth(j) <> 0 Then Exit For
            Next
            If j <= COL增加 Then Exit For
        Next
        If i <= .Rows - 1 Then
            .Row = i: .Col = j
        Else
            If txt医嘱内容.Enabled And txt医嘱内容.Visible Then
                txt医嘱内容.SetFocus
            Else
                Call zlCommFun.PressKey(vbKeyTab)
            End If
        End If
    End With
End Sub

Private Sub vsDiag_CellButtonClick(ByVal Row As Long, ByVal Col As Long)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, str性别 As String
    Dim lngRow As Long, int诊断类型 As Integer
    Dim blnCancle As Boolean
    Dim str类别 As String

    With vsDiag
        If Col = col诊断 Then
            picPanel(e诊断表格).Visible = False
            If .Cell(flexcpData, Row, COL中医) = 1 Then
                If opt诊断(0).value Then
                    '按诊断输入:中医部份，一个诊断可能属于多个分类
                    Set rsTmp = zlDatabase.ShowILLSelect(Me, "2", mlng病人科室id, , True, False)
                    str类别 = "2"
                Else
                    'B-中医疾病编码
                    Set rsTmp = zlDatabase.ShowILLSelect(Me, "B", mlng病人科室id, mstr性别, True)
                    str类别 = "B"
                End If
            Else
                If opt诊断(0).value Then
                    '按诊断输入:西医部份，一个诊断可能属于多个分类
                    Set rsTmp = zlDatabase.ShowILLSelect(Me, "1", mlng病人科室id, , True, False)
                    str类别 = "1"
                Else
                    'D-ICD-10疾病编码
                    Set rsTmp = zlDatabase.ShowILLSelect(Me, "D", mlng病人科室id, mstr性别, True)
                    str类别 = "D"
                End If
            End If
            If rsTmp Is Nothing Then
                If opt诊断(0).value Then
                    MsgBox "没有疾病诊断数据可以选择。", vbInformation, gstrSysName
                End If
            Else
                Call SetDiagInput(Row, rsTmp, str类别)
                Call DiagEnterNextCell
            End If
        ElseIf Col = col中医证候 Then
            If opt诊断(0).value Then
                '按诊断输入:先查是否有对应
                If Not Set中医证候(Row, Val(.TextMatrix(Row, col诊断ID))) Then
                    Set rsTmp = zlDatabase.ShowILLSelect(Me, "Z", mlng病人科室id, mstr性别, True)
                Else
                    Exit Sub
                End If
            Else
                'Z-中医疾病编码
                Set rsTmp = zlDatabase.ShowILLSelect(Me, "Z", mlng病人科室id, mstr性别, True)
            End If
            If Not rsTmp Is Nothing Then
                Call Set中医证候(Row, 0, rsTmp)
                Call DiagEnterNextCell
            End If
        ElseIf Col = COL增加 Then
            lngRow = Row + 1: .AddItem "", lngRow
            .Row = lngRow: .Col = col诊断
            
            int诊断类型 = IIF(mbln性质中医, 11, 1)
            If lngRow - 1 >= .FixedRows Then
                int诊断类型 = IIF(.Cell(flexcpData, lngRow - 1, COL中医) = 1, 11, 1)
            End If
            Call SetDiagType(lngRow, int诊断类型)
            Call SetDiagHeight
            .ShowCell .Row, .Col
        ElseIf Col = colDel Then
            Call vsDiag_KeyDown(vbKeyDelete, 0)
        End If
    End With
End Sub

Private Sub SetDiagInput(ByVal lngRow As Long, rsInput As ADODB.Recordset, ByVal str类别 As String, Optional ByVal str诊断 As String)
'功能：处理诊断项目的输入
'参数：str诊断 自由录入诊断名称，使用常用项目时才调用
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim vPoint As PointAPI, i As Long
    Dim blnDo As Boolean
    Dim strTmp As String
    Dim lng原诊断id As Long '0 表示新添加的诊断， 不为0表示修改诊断，lng原诊断id 的值就是修改前的 诊断ID或疾病ID
    Dim int诊断类型 As Long
    
    On Error GoTo errH
    With vsDiag
        '检查是否允许修改
        For i = 1 To vsAdvice.Rows - 1
            If InStr("," & .TextMatrix(.Row, col医嘱ID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_状态) = "8" Then
                MsgBox "该诊断对应的处方已发送，不能修改。", vbInformation, Me.Caption
                Exit Sub
            End If
            
            '医技工作站调用,若诊断关联医嘱,存在医嘱的开嘱医生非当前操作员,则不允许修改诊断
            If mint场合 = 2 And InStr("," & .TextMatrix(.Row, col医嘱ID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_开嘱医生) <> UserInfo.姓名 Then
                MsgBox "该诊断存在关联医嘱,且该医嘱非您下达，不能修改。", vbInformation, Me.Caption
                Exit Sub
            End If
        Next
        If Not rsInput Is Nothing Then
            int诊断类型 = IIF(.Cell(flexcpFontBold, lngRow, COL西医), 1, 11)
            For i = 1 To rsInput.RecordCount
                If i > 1 Then
                    If .Rows > M_LNG_DIAGCOUNT Then Exit For
                    .AddItem "", lngRow + 1: lngRow = lngRow + 1
                    lng原诊断id = 0
                Else
                    lng原诊断id = Val(.TextMatrix(lngRow, col诊断ID))
                End If
                
                If InStr(.TextMatrix(lngRow, col诊断), "(") > 0 And InStr(.TextMatrix(lngRow, col诊断), ")") > 0 Then
                    strTmp = Mid(.TextMatrix(lngRow, col诊断), InStrRev(.TextMatrix(lngRow, col诊断), "("))
                End If
                .TextMatrix(lngRow, col诊断) = NVL(rsInput!名称) & strTmp
                If Val(.RowData(lngRow)) = 0 Then
                    mlngDSeq = mlngDSeq + 1
                    .RowData(lngRow) = mlngDSeq
                End If
                '根据诊断确定疾病,或根据疾病确定诊断
                If opt诊断(0).value Then
                    .TextMatrix(lngRow, col诊断ID) = rsInput!项目ID
                    .TextMatrix(lngRow, COL诊断编码) = rsInput!编码 & ""
                    .TextMatrix(lngRow, col疾病ID) = ""
                    strSQL = "Select 疾病ID as ID From 疾病诊断对照 Where 诊断ID=[1]"
                Else
                    .TextMatrix(lngRow, col疾病ID) = rsInput!项目ID
                    .TextMatrix(lngRow, COL疾病编码) = rsInput!编码 & ""
                    .TextMatrix(lngRow, COL疾病类别) = str类别
                    .TextMatrix(lngRow, COL疾病附码) = rsInput!附码 & ""
                    .TextMatrix(lngRow, col诊断ID) = ""
                    strSQL = "Select 诊断ID as ID From 疾病诊断对照 Where 疾病ID=[1]"
                End If
                Set rsTmp = New ADODB.Recordset
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!项目ID))
                If Not rsTmp.EOF Then
                    If opt诊断(0).value Then
                        .TextMatrix(lngRow, col疾病ID) = NVL(rsTmp!ID)
                        strSQL = "Select 编码,附码,类别 From 疾病编码目录 where id=[1]"
                        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(NVL(rsTmp!ID)))
                        If Not rsTmp.EOF Then
                            .TextMatrix(lngRow, COL疾病编码) = rsTmp!编码 & ""
                            .TextMatrix(lngRow, COL疾病类别) = rsTmp!类别 & ""
                            .TextMatrix(lngRow, COL疾病附码) = rsTmp!附码 & ""
                        End If
                    Else
                        .TextMatrix(lngRow, col诊断ID) = NVL(rsTmp!ID)
                        strSQL = "Select 编码 From 疾病诊断目录 where id=[1]"
                        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(NVL(rsTmp!ID)))
                        If Not rsTmp.EOF Then .TextMatrix(lngRow, COL诊断编码) = rsTmp!编码 & ""
                    End If
                End If
                
                '中医根据疾病诊断参考取证候
                If .Cell(flexcpData, lngRow, COL中医) = 1 Then
                    Call Set中医证候(lngRow, Val(.TextMatrix(lngRow, col诊断ID)))
                End If
                
                .TextMatrix(lngRow, col编码) = IIF(Not IsNull(rsInput!编码), rsInput!编码, "")
                .Cell(flexcpData, lngRow, col诊断) = .TextMatrix(lngRow, col诊断)
                
                .Cell(flexcpData, lngRow, col疑诊) = 0
                .Cell(flexcpForeColor, lngRow, col疑诊) = .GridColor
                
                .TextMatrix(lngRow, colICD码) = NVL(rsInput!编码)
                
                '输入主/次要诊断后调用外挂接口
                If CreatePlugInOK(p门诊医嘱下达, mint场合) Then
                    On Error Resume Next
                    If lngRow = .FixedRows Then
                        Call gobjPlugIn.DiagnosisEnter(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, Val(rsInput!项目ID & ""), .TextMatrix(lngRow, col诊断), lng原诊断id, mint场合)
                        Call zlPlugInErrH(err, "DiagnosisEnter")
                    Else
                        Call gobjPlugIn.DiagnosisOtherEnter(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, Val(rsInput!项目ID & ""), .TextMatrix(lngRow, col诊断), lng原诊断id, mint场合)
                        Call zlPlugInErrH(err, "DiagnosisOtherEnter")
                    End If
                    err.Clear: On Error GoTo 0
                End If
                Call SetDiagType(lngRow, int诊断类型)
                
                If optState(1).value = False Then '不为复诊，则检查
                   Call PatiReSeeDoctor(lngRow)
                End If
                
                rsInput.MoveNext
            Next
            Call SetDiagHeight
        Else
            If Val(.RowData(lngRow)) = 0 Then
                mlngDSeq = mlngDSeq + 1
                .RowData(lngRow) = mlngDSeq
            End If
            If str诊断 = "" Then
                .TextMatrix(lngRow, col诊断) = .EditText
            Else
                .TextMatrix(lngRow, col诊断) = str诊断
            End If
            .Cell(flexcpData, lngRow, col诊断) = .TextMatrix(lngRow, col诊断)
            
            .Cell(flexcpData, lngRow, col疑诊) = 0
            .Cell(flexcpForeColor, lngRow, col疑诊) = .GridColor
            
            .TextMatrix(lngRow, col编码) = ""
            .TextMatrix(lngRow, col诊断ID) = ""
            .TextMatrix(lngRow, col疾病ID) = ""
            .TextMatrix(lngRow, colICD码) = ""
        End If
        
        lbl诊断.Tag = "1"
        mblnNoSave = True
    End With
    'PASS 诊断录入
    If mblnPass Then
        zlPassDrugs
    End If
    '将本次录入尚未关联诊断的医嘱与当前诊断关联
    If vsDiag.TextMatrix(lngRow, col诊断) <> "" Then
        blnDo = False
        With vsAdvice
            For i = .FixedRows To .Rows - 1
                If .RowData(i) <> 0 And Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                    If Val(.TextMatrix(i, COL_状态)) = 1 And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                        mrsAD.Filter = "医嘱ID=" & Val(.RowData(i))
                        If mrsAD.EOF Then
                            Call SetDiagFlag(i, 1, Val(vsDiag.RowData(lngRow)))
                            blnDo = True
                        End If
                    End If
                End If
            Next
        End With
        If blnDo Then
            Call ShowDiagFlag(vsAdvice.Row)
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function Set中医证候(ByVal lngRow As Long, ByVal lng诊断ID As Long, Optional ByVal rsInput As Recordset, Optional ByVal blnFreeInput As Boolean) As Boolean
'功能：中医根据疾病诊断参考取证候
'参数：rsInput-如果不为空，则输出指定的中药证候记录集
'      blnFreeInput  true - 自由录入
'返回：是否有对应关系
    Dim rsTmp As Recordset
    Dim strSQL As String
    Dim blnCancel As Boolean
    Dim vPoint As PointAPI
    Dim strTmp As String
    
    With vsDiag
        '去掉已有的证候
        If InStr(.TextMatrix(lngRow, col诊断), "(") > 0 And InStr(.TextMatrix(lngRow, col诊断), ")") > 0 Then
            strTmp = Mid(.TextMatrix(lngRow, col诊断), 1, InStrRev(.TextMatrix(lngRow, col诊断), "(") - 1)
        Else
            strTmp = .TextMatrix(lngRow, col诊断)
        End If
        If blnFreeInput Then
            .TextMatrix(lngRow, col证候ID) = ""
            .TextMatrix(lngRow, COL证候编码) = ""
            .TextMatrix(lngRow, col中医证候) = .EditText
            .Cell(flexcpData, lngRow, col中医证候) = .TextMatrix(lngRow, col中医证候)
            lbl诊断.Tag = "1"
            mblnNoSave = True
            Exit Function
        Else
            If rsInput Is Nothing Then
                If lng诊断ID <> 0 Then
                    strSQL = "Select Distinct a.证候序号 as ID,a.证候ID,a.证候名称,b.编码 as 证候编码" & _
                        " From 疾病诊断参考 A,疾病编码目录 B" & _
                        " Where a.证候ID=b.ID(+) And a.诊断ID=[1] And a.证候名称 is Not NULL" & _
                        " Order by a.证候序号"
                    vPoint = zlControl.GetCoordPos(.hwnd, .CellLeft + 15, .CellTop)
 
                    Set rsTmp = Nothing
                    Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, "中医证候", False, "", "", False, False, True, _
                        vPoint.X, vPoint.Y, .CellHeight, blnCancel, False, True, lng诊断ID)
                    If Not rsTmp Is Nothing Then
                        .TextMatrix(lngRow, col证候ID) = NVL(rsTmp!证候id)
                        .TextMatrix(lngRow, COL证候编码) = NVL(rsTmp!证候编码)
                        If Not IsNull(rsTmp!证候名称) Then
                            .TextMatrix(lngRow, col诊断) = strTmp
                            .Cell(flexcpData, lngRow, col诊断) = .TextMatrix(lngRow, col诊断)
                            .TextMatrix(lngRow, col中医证候) = NVL(rsTmp!证候名称)
                            .Cell(flexcpData, lngRow, col中医证候) = .TextMatrix(lngRow, col中医证候)
                            If .EditText <> "" Then .EditText = .TextMatrix(lngRow, col中医证候)
                            lbl诊断.Tag = "1"
                            mblnNoSave = True
                        End If
                        Set中医证候 = True
                    Else
                        If blnCancel Then
                            Set中医证候 = True
                            If .EditText <> "" Then .EditText = .Cell(flexcpData, lngRow, col中医证候)
                        Else
                            Set中医证候 = False
                        End If
                    End If
                Else
                    Set中医证候 = False
                End If
            Else
                .TextMatrix(lngRow, col证候ID) = NVL(rsInput!项目ID)
                .TextMatrix(lngRow, COL证候编码) = NVL(rsInput!编码)
                .TextMatrix(lngRow, col诊断) = strTmp
                .Cell(flexcpData, lngRow, col诊断) = .TextMatrix(lngRow, col诊断)
                .TextMatrix(lngRow, col中医证候) = NVL(rsInput!名称)
                .Cell(flexcpData, lngRow, col中医证候) = .TextMatrix(lngRow, col中医证候)
                If .EditText <> "" Then .EditText = .TextMatrix(lngRow, col中医证候)
                lbl诊断.Tag = "1"
                mblnNoSave = True
            End If
        End If
    End With
End Function

Private Sub vsDiag_KeyPressEdit(ByVal Row As Long, ByVal Col As Long, KeyAscii As Integer)
    If KeyAscii = 13 Then
        mblnReturn = True
    Else
        mblnReturn = False
    End If
    If KeyAscii = vbKeyEscape Then
        picPanel(e诊断表格).Visible = False
    End If
End Sub

Private Sub vsDiag_LostFocus()
    If vsDiag.Col <> col发病时间 Then vsDiag.Col = IIF(vsDiag.Col = col中医证候, col中医证候, col诊断)
End Sub

Private Sub vsDiag_SetupEditWindow(ByVal Row As Long, ByVal Col As Long, ByVal EditWindow As Long, ByVal IsCombo As Boolean)
    vsDiag.EditSelStart = 0
    vsDiag.EditSelLength = zlCommFun.ActualLen(vsDiag.EditText)
    
End Sub

Private Sub vsDiag_StartEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    If Not DiagCellEditable(Row, Col) Then
        Cancel = True
    ElseIf Col = col疑诊 Or Col = COL中医 Or Col = COL西医 Then
        Cancel = True '不直接编辑
    ElseIf Col = col标志 And Val(vsDiag.RowData(Row)) = 0 Then
        Cancel = True
    Else
        picPanel(e诊断表格).Visible = Col = col诊断
        If Col = col诊断 Then
            Call Get常用诊断
            Call picPanel_Resize(e诊断表格)
        End If
    End If
End Sub

Private Sub vsDiag_ValidateEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim strInput As String, vPoint As PointAPI
    Dim str性别 As String, int诊断输入 As Integer
    Dim str类别 As String
    
    On Error GoTo errH
    
    With vsDiag
        If Col = col诊断 Or Col = col中医证候 Then
            If .EditText = "" Then
                If .TextMatrix(Row, col编码) <> "" And Col = col诊断 Then
                    .EditText = .Cell(flexcpData, Row, Col)
                Else
                    '中医证候则清除备份数据
                    If Col = col中医证候 Then
                        .Cell(flexcpData, Row, Col) = ""
                    End If
                    If .TextMatrix(Row, col中医证候) <> "" Then
                        lbl诊断.Tag = "1"
                        mblnNoSave = True
                    End If
                End If
                If mblnReturn Then Call DiagEnterNextCell
            ElseIf .EditText = .Cell(flexcpData, Row, Col) Then
                If mblnReturn Then Call DiagEnterNextCell
            ElseIf Col = col诊断 And .TextMatrix(Row, col编码) <> "" And .Cell(flexcpData, Row, Col) <> "" And .EditText Like "*" & .Cell(flexcpData, Row, Col) & "*" Then
                strInput = UCase(.EditText)
                strSQL = GetDiagSQL(Row, strInput, strSQL, str性别)
                On Error GoTo errH
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strInput, strInput, str性别, mint简码 + 1, strInput, UserInfo.ID, mlng病人科室id)
                If rsTmp.RecordCount = 1 Then
                    Call SetDiagInput(Row, rsTmp, rsTmp!类别 & ""): .EditText = .Text
                Else
                    '允许在标准的名称前后输入附加信息
                    .TextMatrix(Row, col诊断) = .EditText
                    lbl诊断.Tag = "1"
                    mblnNoSave = True
                End If
            ElseIf Col = col诊断 And .TextMatrix(Row, col编码) <> "" And .Cell(flexcpData, Row, Col) <> "" And mblnFreeInput Then
                strInput = UCase(.EditText)
                strSQL = GetDiagSQL(Row, strInput, strSQL, str性别)
                On Error GoTo errH
                vPoint = zlControl.GetCoordPos(.hwnd, .CellLeft + 15, .CellTop)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, IIF(opt诊断(0).value, "疾病诊断", "疾病编码"), False, "", "", False, False, True, _
                    vPoint.X, vPoint.Y, .CellHeight, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%", str性别, mint简码 + 1, strInput, UserInfo.ID, mlng病人科室id, "ColSet:列宽设置|说明,2400|悬浮提示|说明")
                If blnCancel Then '无匹配输入时,按任意输入处理,取消不同
                    Cancel = True
                Else
                    If rsTmp Is Nothing Then
                        .TextMatrix(Row, col诊断) = .EditText
                        lbl诊断.Tag = "1"
                        mblnNoSave = True
                    Else
                         Call SetDiagInput(Row, rsTmp, rsTmp!类别 & ""): .EditText = .Text
                    End If
                End If
            Else
                int诊断输入 = Val(Mid(gstr诊断输入, 1, 1))
                If int诊断输入 = 0 Then int诊断输入 = 1
                
                If mstr性别 Like "*男*" Then
                    str性别 = "男"
                ElseIf mstr性别 Like "*女*" Then
                    str性别 = "女"
                End If
                strInput = UCase(.EditText)
                strSQL = GetDiagSQL(Row, strInput, strSQL, str性别, IIF(Col = col诊断, "B", "Z"))
                If Col = col诊断 Then
                        vPoint = zlControl.GetCoordPos(.hwnd, .CellLeft + 15, .CellTop)
                        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, IIF(opt诊断(0).value, "疾病诊断", "疾病编码"), False, "", "", False, False, True, _
                            vPoint.X, vPoint.Y, .CellHeight, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%", str性别, mint简码 + 1, strInput, UserInfo.ID, mlng病人科室id, "ColSet:列宽设置|说明,2400|悬浮提示|说明")
                        If blnCancel Then '无匹配输入时,按任意输入处理,取消不同
                            Cancel = True
                        Else
                            '检查诊断输入方式
                            If rsTmp Is Nothing And (int诊断输入 = 2 Or int诊断输入 = 3 And mint险类 <> 0) Then
                                MsgBox "没有找到与输入匹配的内容。", vbInformation, gstrSysName
                                Cancel = True
                            ElseIf Not (rsTmp Is Nothing) Then
                                Call SetDiagInput(Row, rsTmp, rsTmp!类别 & ""): .EditText = .Text
                                If mblnReturn Then Call DiagEnterNextCell
                            Else
                                '没有匹配成功再次当成自由录入
                                If int诊断输入 = 1 Or (int诊断输入 = 3 And (rsTmp Is Nothing) And mint险类 = 0) Then
                                    Call SetDiagInput(Row, Nothing, str类别): .EditText = .Text
                                    If mblnReturn Then Call DiagEnterNextCell
                                Else
                                    Cancel = True
                                End If
                            End If
                        End If
                ElseIf Col = col中医证候 Then
                    If opt诊断(0).value Then
                        '按诊断输入:先查是否有对应
                        If Set中医证候(Row, Val(.TextMatrix(Row, col诊断ID))) Then
                            mblnReturn = False
                            Exit Sub
                        End If
                    End If
                    vPoint = zlControl.GetCoordPos(.hwnd, .CellLeft + 15, .CellTop)
                    Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, "中医证候", False, "", "", False, False, True, _
                        vPoint.X, vPoint.Y, .CellHeight, blnCancel, False, True, strInput & "%", gstrLike & strInput & "%", str性别, mint简码 + 1, strInput, UserInfo.ID, mlng病人科室id, "ColSet:列宽设置|说明,2400|悬浮提示|说明")
                    If blnCancel Then '无匹配输入时,按任意输入处理,取消不同
                        Cancel = True
                    Else
                        '检查诊断输入方式
                        If rsTmp Is Nothing And (int诊断输入 = 2 Or int诊断输入 = 3 And mint险类 <> 0) Then
                            MsgBox "没有找到与输入匹配的内容。", vbInformation, gstrSysName
                            Cancel = True
                        Else
                            Call Set中医证候(Row, 0, rsTmp, rsTmp Is Nothing)
                        End If
                    End If
                End If
            End If
            mblnReturn = False
        ElseIf Col = col发病时间 Then
            If .EditText <> "" Then
                strInput = GetFullDate(.EditText)
                If IsDate(strInput) Then
                    .EditText = Format(strInput, "yyyy-MM-dd HH:mm")
                    mblnCancle = False
                Else
                    MsgBox "请输入正确的发病时间，例如：""2012-12-21 00:00""。"
                    Cancel = True
                End If
            End If
            If .EditText <> .TextMatrix(Row, Col) Then mblnNoSave = True: lbl诊断.Tag = "1"
        End If
        mblnCancle = Cancel
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function GetFullDate(ByVal strText As String, Optional blnTime As Boolean = True) As String
'功能：根据输入的日期简串,返回完整的日期串(yyyy-MM-dd[ HH:mm])
'参数：blnTime=是否处理时间部份
    Dim curDate As Date, strTmp As String
    
    If strText = "" Then Exit Function
    curDate = zlDatabase.Currentdate
    strTmp = strText
    
    If InStr(strTmp, "-") > 0 Or InStr(strTmp, "/") Or InStr(strTmp, ":") > 0 Then
        '输入串中包含日期分隔符
        If IsDate(strTmp) Then
            strTmp = Format(strTmp, "yyyy-MM-dd HH:mm")
            If Right(strTmp, 5) = "00:00" And InStr(strText, ":") = 0 Then
                '只输入了日期部份
                strTmp = Mid(strTmp, 1, 11) & Format(curDate, "HH:mm")
            ElseIf Left(strTmp, 10) = "1899-12-30" Then
                '只输入了时间部份
                strTmp = Format(curDate, "yyyy-MM-dd") & Right(strTmp, 6)
            End If
        Else
            '输入非法日期,返回原内容
            strTmp = strText
        End If
    Else
        '不包含日期分隔符
        If Len(strTmp) <= 2 Then
            '当作输入dd
            strTmp = Format(strTmp, "00")
            strTmp = Format(curDate, "yyyy-MM") & "-" & strTmp & " " & Format(curDate, "HH:mm")
        ElseIf Len(strTmp) <= 4 Then
            '当作输入MMdd
            strTmp = Format(strTmp, "0000")
            strTmp = Format(curDate, "yyyy") & "-" & Left(strTmp, 2) & "-" & Right(strTmp, 2) & " " & Format(curDate, "HH:mm")
        ElseIf Len(strTmp) <= 6 Then
            '当作输入yyMMdd
            strTmp = Format(strTmp, "000000")
            strTmp = Format(Left(strTmp, 2) & "-" & Mid(strTmp, 3, 2) & "-" & Right(strTmp, 2), "yyyy-MM-dd") & " " & Format(curDate, "HH:mm")
        ElseIf Len(strTmp) <= 8 Then
            '当作输入MMddHHmm
            strTmp = Format(strTmp, "00000000")
            strTmp = Format(curDate, "yyyy") & "-" & Left(strTmp, 2) & "-" & Mid(strTmp, 3, 2) & " " & Mid(strTmp, 5, 2) & ":" & Right(strTmp, 2)
            If Not IsDate(strTmp) Then
                '当作输入yyyyMMdd
                strTmp = Format(strText, "00000000")
                strTmp = Left(strTmp, 4) & "-" & Mid(strTmp, 5, 2) & "-" & Right(strTmp, 2) & " " & Format(curDate, "HH:mm")
            End If
        Else
            '当作输入yyyyMMddHHmm
            strTmp = Format(strTmp, "000000000000")
            strTmp = Left(strTmp, 4) & "-" & Mid(strTmp, 5, 2) & "-" & Mid(strTmp, 7, 2) & " " & Mid(strTmp, 9, 2) & ":" & Right(strTmp, 2)
        End If
    End If
    
    If IsDate(strTmp) And Not blnTime Then
        strTmp = Format(strTmp, "yyyy-MM-dd")
    End If
    GetFullDate = strTmp
End Function

Private Sub InitRsMsg(ByRef rsMsg As ADODB.Recordset)
'功能：初始化消息记录集
    Set rsMsg = New ADODB.Recordset
    rsMsg.Fields.Append "诊断id", adBigInt
    rsMsg.Fields.Append "诊断类型", adVarChar, 6
    rsMsg.Fields.Append "是否疑诊", adVarChar, 6
    rsMsg.Fields.Append "诊断次序", adBigInt
    rsMsg.Fields.Append "诊断编码", adVarChar, 60
    rsMsg.Fields.Append "疾病编码", adVarChar, 60
    rsMsg.Fields.Append "疾病附码", adVarChar, 60
    rsMsg.Fields.Append "疾病类别", adVarChar, 60
    rsMsg.Fields.Append "证候编码", adVarChar, 60
    rsMsg.Fields.Append "证候名称", adVarChar, 120
    rsMsg.Fields.Append "记录日期", adVarChar, 60
    rsMsg.Fields.Append "记录人员", adVarChar, 120
    rsMsg.Fields.Append "状态", adBigInt '1 －新增
    rsMsg.CursorLocation = adUseClient
    rsMsg.LockType = adLockOptimistic
    rsMsg.CursorType = adOpenStatic
    rsMsg.Open
End Sub

Private Sub SendMsg诊断(ByVal lngRow As Long, ByVal lng次序 As Long, ByVal lngID As Long, ByVal str记录人 As String, ByRef rsMsg As ADODB.Recordset)
    Dim i As Long
    With vsDiag
        rsMsg.AddNew
        rsMsg!诊断id = lngID
        rsMsg!诊断类型 = IIF(.Cell(flexcpData, lngRow, COL中医) = 1, "11", "1")
        rsMsg!是否疑诊 = Val(.Cell(flexcpData, lngRow, col疑诊))
        rsMsg!诊断次序 = lng次序
        rsMsg!诊断编码 = .TextMatrix(lngRow, COL诊断编码)
        rsMsg!疾病编码 = .TextMatrix(lngRow, COL疾病编码)
        rsMsg!疾病附码 = .TextMatrix(lngRow, COL疾病附码)
        rsMsg!疾病类别 = .TextMatrix(lngRow, COL疾病类别)
        rsMsg!证候编码 = .TextMatrix(lngRow, COL证候编码)
        rsMsg!证候名称 = .TextMatrix(lngRow, col中医证候)
        rsMsg!记录日期 = Format(.TextMatrix(lngRow, col发病时间), "yyyy-MM-dd HH:mm:ss")
        rsMsg!记录人员 = str记录人
        rsMsg!状态 = 1
        
        mrs诊断.Filter = "显示编码='" & .TextMatrix(lngRow, col编码) & "'"
        
        If mrs诊断.EOF Then
            mrs诊断.AddNew
            mrs诊断!ID = lngID
            mrs诊断!显示编码 = .TextMatrix(lngRow, col编码)
            mrs诊断!诊断编码 = .TextMatrix(lngRow, COL诊断编码)
            mrs诊断!疾病编码 = .TextMatrix(lngRow, COL疾病编码)
            mrs诊断!状态 = 2
            mrs诊断.Update
        Else
            rsMsg!状态 = 0
            mrs诊断!状态 = 1
            mrs诊断!ID = lngID
        End If
        rsMsg.Update
    End With
End Sub

Private Sub Make诊断医嘱对应(ByRef arrSQL As Variant, ByVal str医嘱IDs As String, ByVal lng诊断ID As Long)
'功能：生成诊断医嘱对应的可执行SQL问题号102666
    Dim varTmp As Variant
    Dim i As Long
    Dim strTmp As String
    Dim strIDs As String
    varTmp = Array()
    strIDs = str医嘱IDs
    
    Do While Len(strIDs) > 4000
        strTmp = Mid(strIDs, 1, 3980)
        strTmp = Mid(strTmp, 1, InStrRev(strTmp, ",") - 1)
        ReDim Preserve varTmp(UBound(varTmp) + 1)
        varTmp(UBound(varTmp)) = strTmp
        strIDs = Replace(strIDs, strTmp & ",", "")
    Loop
    If strIDs <> "" Then
        ReDim Preserve varTmp(UBound(varTmp) + 1)
        varTmp(UBound(varTmp)) = strIDs
    End If
    For i = 0 To UBound(varTmp)
        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
        arrSQL(UBound(arrSQL)) = "Zl_病人诊断医嘱_Insert(NULL,NULL," & lng诊断ID & ",'" & varTmp(i) & "')"
    Next
End Sub

Private Sub GetLastDiag()
'功能：读取上次就诊的诊断信息
    Dim strSQL As String, rsTmp As Recordset
    Dim i As Long, strTmp As String
    
    On Error GoTo errH
    
    strSQL = "Select A.ID,A.记录来源,A.诊断类型,A.疾病ID,A.诊断ID,A.证候ID,A.诊断描述,A.是否疑诊,c.编码 as ICD码,D.编码 as 诊断编码,E.编码 as 证候编码,A.发病时间" & vbNewLine & _
        "From 病人诊断记录 A, 病人挂号记录 B,疾病编码目录 C, 疾病诊断目录 D,疾病编码目录 E" & vbNewLine & _
        "Where a.病人id = b.病人id And a.主页id = b.Id And A.疾病ID=C.ID(+)  And a.诊断id = D.Id(+) And  a.证候ID=E.ID(+) And a.病人id = [1] And (诊断类型 = 1 Or 诊断类型 = 11) And" & vbNewLine & _
        "      b.登记时间 =" & vbNewLine & _
        "      (Select Max(登记时间)" & vbNewLine & _
        "       From 病人挂号记录 C" & vbNewLine & _
        "       Where c.病人id = [1] And ID <> [2] And Exists (Select 1 From 病人诊断记录 D Where d.病人id = [1] And 主页id = c.Id)) " & _
        " And (d.撤档时间 Is Null Or d.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And (c.撤档时间 Is Null Or c.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD'))"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng挂号ID)
    Set mrsLasD = zlDatabase.CopyNewRec(rsTmp)
    If Not rsTmp.EOF Then
        With vsDiagBefore
            For i = 1 To rsTmp.RecordCount
                .TextMatrix(i, col诊断内容) = rsTmp!诊断描述 & ""
                .TextMatrix(i, col项目ID) = Val(rsTmp!ID & "")
                rsTmp.MoveNext
            Next
        End With
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub Get常用诊断()
'功能：弹出常用诊断项目选择器
    Dim lngRow As Long
    Dim strIDs As String
    Dim i As Long
    Dim rsTmp As ADODB.Recordset
    Dim str诊断 As String
    Dim str常用诊断 As String
    Dim vPoint As PointAPI
    Dim strSQL As String
    Dim blnCancel As Boolean
    
    On Error GoTo errH
    
    '上次诊断
    If mrsLasD Is Nothing Then
        Call GetLastDiag
    End If
    
    '常用诊断
    If mrsCommonDiag Is Nothing Then
        strSQL = "Select a.Id,a.人员id,a.科室id,a.诊断名称 As 诊断,nvl(a.疾病id,0) as 疾病ID,nvl(a.诊断id,0) as 诊断ID,a.使用次数,a.诊断类型" & vbNewLine & _
            " From 医生常用诊断 A,疾病编码目录 B,疾病诊断目录 C where a.疾病id=b.id(+) and a.诊断id=c.id(+) And a.人员ID=[1]" & vbNewLine & _
            " And (b.撤档时间 Is Null Or b.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And (c.撤档时间 Is Null Or c.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD'))"
        Set mrsCommonDiag = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, UserInfo.ID)
        Set mrsCommonDiag = zlDatabase.CopyNewRec(mrsCommonDiag)
    Else
        mrsCommonDiag.Filter = 0
    End If
    
    Set rsTmp = zlDatabase.CopyNewRec(mrsCommonDiag)
    lngRow = 0
    
    If Not rsTmp.EOF Then
        '常用诊断最多加10条
        '1.本科室常用
        rsTmp.Filter = "科室id=" & mlng挂号科室ID & " and 诊断类型=" & IIF(Val(vsDiag.Cell(flexcpData, vsDiag.Row, COL中医)) = 1, "11", "1")
        If Not rsTmp.EOF Then
            rsTmp.Sort = "使用次数 Desc"
            For i = 1 To rsTmp.RecordCount
                If Val(rsTmp!疾病id & "") = 0 And Val(rsTmp!诊断id & "") = 0 Then
                    str诊断 = rsTmp!诊断 & ""
                Else
                    str诊断 = Val(rsTmp!疾病id & "") & "," & Val(rsTmp!诊断id & "")
                    If opt诊断(0).value Then
                        If Val(rsTmp!诊断id & "") = 0 Then
                            str诊断 = ""
                        End If
                    Else
                        If Val(rsTmp!疾病id & "") = 0 Then
                            str诊断 = ""
                        End If
                    End If
                End If
                If str诊断 <> "" Then
                    If InStr("<Tab>" & str常用诊断 & "<Tab>", "<Tab>" & str诊断 & "<Tab>") = 0 Then
                        lngRow = lngRow + 1
                        strIDs = strIDs & "," & rsTmp!ID
                        str常用诊断 = str常用诊断 & "<Tab>" & str诊断
                    End If
                End If
                If lngRow = 10 Then
                    Exit For
                End If
                rsTmp.MoveNext
            Next
        End If
        
        If lngRow < 10 Then
            '人员常用
            rsTmp.Filter = "人员id=" & UserInfo.ID & " and 诊断类型=" & IIF(Val(vsDiag.Cell(flexcpData, vsDiag.Row, COL中医)) = 1, "11", "1")
            If Not rsTmp.EOF Then
                rsTmp.Sort = "使用次数 Desc"
                For i = 1 To rsTmp.RecordCount
                    If Val(rsTmp!疾病id & "") = 0 And Val(rsTmp!诊断id & "") = 0 Then
                        str诊断 = rsTmp!诊断 & ""
                    Else
                        str诊断 = Val(rsTmp!疾病id & "") & "," & Val(rsTmp!诊断id & "")
                        If opt诊断(0).value Then
                            If Val(rsTmp!诊断id & "") = 0 Then
                                str诊断 = ""
                            End If
                        Else
                            If Val(rsTmp!疾病id & "") = 0 Then
                                str诊断 = ""
                            End If
                        End If
                    End If
                    If str诊断 <> "" Then
                        If InStr("<Tab>" & str常用诊断 & "<Tab>", "<Tab>" & str诊断 & "<Tab>") = 0 Then
                            lngRow = lngRow + 1
                            strIDs = strIDs & "," & rsTmp!ID
                            str常用诊断 = str常用诊断 & "<Tab>" & str诊断
                        End If
                    End If
                    If lngRow = 10 Then
                        Exit For
                    End If
                    rsTmp.MoveNext
                Next
            End If
        End If
    End If
    If strIDs <> "" Then
        If opt诊断(0).value Then
            strSQL = "select a.id,b.id as 项目ID,b.编码,Null as 类别,nvl(b.名称,a.诊断名称) as 名称" & vbNewLine & _
                "from 医生常用诊断 a,疾病诊断目录 b where a.诊断id=b.id(+) " & _
                " and a.id  in (Select /*+cardinality(x,10)*/ x.Column_Value From Table(Cast(f_Num2list([1]) As zlTools.t_Numlist)) X)" & _
                " order by a.使用次数 Desc"
        Else
            strSQL = "select a.id,b.id as 项目ID,b.编码,b.附码,b.类别,nvl(b.名称,a.诊断名称) as 名称" & vbNewLine & _
                "from 医生常用诊断 a,疾病编码目录 b where a.疾病id=b.id(+) " & _
                " and a.id  in (Select /*+cardinality(x,10)*/ x.Column_Value From Table(Cast(f_Num2list([1]) As zlTools.t_Numlist)) X)" & _
                " order by a.使用次数 Desc"
        End If
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Mid(strIDs, 2))
        vsDiagComm.Rows = vsDiagComm.FixedRows
        vsDiagComm.Rows = 11
        Set mrsComD = Nothing
        If Not rsTmp.EOF Then
            With vsDiagComm
                For i = 1 To rsTmp.RecordCount
                    .TextMatrix(i, col诊断内容) = IIF(rsTmp!编码 & "" <> "", "(" & rsTmp!编码 & ")", "") & rsTmp!名称 & ""
                    .TextMatrix(i, col项目ID) = Val(rsTmp!ID & "")
                    rsTmp.MoveNext
                Next
                rsTmp.MoveFirst
                Set mrsComD = zlDatabase.CopyNewRec(rsTmp)
                
                For i = 1 To .Rows - 1
                    .TextMatrix(i, COL类型) = "常用诊断"
                Next
            End With
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function AdviceHaveDiag(ByVal lngRow As Long, Optional ByVal intType As Integer, Optional ByRef strDiags As String) As Long
'功能：判断指定行的医嘱和指定行的诊断是不是有对应关系
'      intType 0-取缺省诊断，取诊断表格的当前选择行当前行可能没录入诊断这不影响，放入strDiags中
'              1-判断strDiags这个诊断是不是在医嘱行中，有则返回1，否则返回0
'              2-只取本行医嘱的诊断，不要缺省值
    Dim lng组ID As Long, i As Long
    Dim str诊断IDs As String
    Dim strDiagIn As String
    
    If intType = 0 Then
        If vsDiag.Row >= vsDiag.FixedRows Then
            If vsDiag.TextMatrix(vsDiag.Row, col诊断) <> "" And Val(vsDiag.RowData(vsDiag.Row)) <> 0 Then
                Call AdviceHaveDiag(lngRow, 2, str诊断IDs)
                If InStr(str诊断IDs, ",") > 0 Then
                    strDiags = str诊断IDs
                Else
                    strDiags = vsDiag.RowData(vsDiag.Row)
                End If
            End If
        End If
        Exit Function
    End If
    
    With vsAdvice
        If lngRow >= .FixedRows Then
            If Val(.RowData(lngRow)) <> 0 Then
                lng组ID = IIF(Val(.TextMatrix(lngRow, COL_相关ID)) <> 0, Val(.TextMatrix(lngRow, COL_相关ID)), .RowData(lngRow))
                mrsAD.Filter = "医嘱ID=" & lng组ID
                If Not mrsAD.EOF Then
                    str诊断IDs = ""
                    mrsAD.MoveFirst
                    Do While Not mrsAD.EOF
                        str诊断IDs = str诊断IDs & "," & mrsAD!诊断id
                        mrsAD.MoveNext
                    Loop
                End If
            End If
        End If
    End With
    
    If intType = 1 Then
        If InStr("," & str诊断IDs & ",", "," & strDiags & ",") > 0 Then
            AdviceHaveDiag = 1
            Exit Function
        End If
    ElseIf intType = 2 Then
        strDiags = Mid(str诊断IDs, 2)
    End If
End Function

Private Sub SetDiagFlag(ByVal lngRow As Long, ByVal intFlag As Integer, Optional ByVal strDiags As String)
'功能：设置指定医嘱行的诊断
'参数：lngRow=医嘱表格当前行
'      intFlag  0-清除strDiags诊断(strDiags只有一个值)
'               1-关联strDiags中的诊断(strDiags只有一个/多个值)
'               2-清除本医嘱所有诊断;strDiags允许为空
'               3-添加strDiags诊断(strDiags只有一个值)
    Dim lng组ID As Long
    Dim blnDo As Boolean, i As Long
    Dim strFilter As String
    Dim strTmp As String
    Dim varTmp As Variant
    
    With vsAdvice
        If Val(.RowData(lngRow)) = 0 Or (InStr(",0,1,3,", intFlag) > 0 And strDiags = "") Then Exit Sub
    
        '如果是已经发送的医嘱，只准关联，不准取消关联
        If (intFlag = 0 Or intFlag = 2) And .TextMatrix(lngRow, COL_状态) = "8" Then Exit Sub
    
        '关联数据设置
        lng组ID = IIF(Val(.TextMatrix(lngRow, COL_相关ID)) <> 0, Val(.TextMatrix(lngRow, COL_相关ID)), .RowData(lngRow))
    End With
    
    '先删原数据
    If intFlag = 1 Or intFlag = 2 Then
        strFilter = "医嘱ID=" & lng组ID
    ElseIf intFlag = 0 Then
        strFilter = "医嘱ID=" & lng组ID & " and 诊断ID=" & strDiags
    End If
    If strFilter <> "" Then
        mrsAD.Filter = strFilter
        If Not mrsAD.EOF Then
            Do While Not mrsAD.EOF
                mrsAD.Delete
                mrsAD.MoveNext
            Loop
            blnDo = True
        End If
    End If
    
    '添加数据
    If intFlag = 1 Or intFlag = 3 Then
        varTmp = Split(strDiags, ",")
        strTmp = ""
        For i = 0 To UBound(varTmp)
            If Val(varTmp(i)) > 0 Then
                If InStr("," & strTmp & ",", "," & varTmp(i) & ",") = 0 Then
                    strTmp = strTmp & "," & varTmp(i)
                    mrsAD.AddNew
                    mrsAD!医嘱ID = lng组ID
                    mrsAD!诊断id = Val(varTmp(i))
                    mrsAD.Update
                    blnDo = True
                End If
            End If
        Next
    End If
    
    If blnDo Then
        lbl诊断.Tag = "1"
        mblnNoSave = True
    End If
    
    '重新生成 vsDiag中COL医嘱ID
    With vsDiag
        For i = .FixedRows To .Rows - 1
            strTmp = ""
            mrsAD.Filter = "诊断ID=" & Val(.RowData(i))
            If Not mrsAD.EOF Then
                Do While Not mrsAD.EOF
                    strTmp = strTmp & "," & mrsAD!医嘱ID
                    mrsAD.MoveNext
                Loop
            End If
            .TextMatrix(i, col医嘱ID) = Mid(strTmp, 2)
        Next
    End With
    mrsAD.Filter = 0
    
    Call ShowAdvice诊断
End Sub
    
Private Sub ShowDiagFlag(ByVal lngRow As Long)
'功能：显示诊断行所对应关联的医嘱标记
'参数：lngRow=医嘱行
    Dim strALL As String, strCurr As String
    Dim lng组ID As Long, i As Long
    Dim lng诊断ID As Long
    
    mrsAD.Filter = 0
    lng组ID = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_相关ID)) <> 0, Val(vsAdvice.TextMatrix(lngRow, COL_相关ID)), vsAdvice.RowData(lngRow))
    If Not mrsAD.EOF Then
        mrsAD.MoveFirst
        Do While Not mrsAD.EOF
            If Val(mrsAD!医嘱ID) = lng组ID Then
                strCurr = strCurr & "," & mrsAD!诊断id
            Else
                strALL = strALL & "," & mrsAD!诊断id
            End If
            mrsAD.MoveNext
        Loop
    End If

    With vsDiag
        .Redraw = flexRDNone
        Set .Cell(flexcpPicture, .FixedRows, 0, .Rows - 1, 0) = Nothing
        For i = .FixedRows To .Rows - 1
            lng组ID = Val(.RowData(i))
            If InStr("," & strCurr & ",", "," & lng组ID & ",") > 0 Then
                Set .Cell(flexcpPicture, i, 0) = img16.ListImages("诊断_当前").Picture
            ElseIf InStr("," & strALL & ",", "," & lng组ID & ",") > 0 Then
                Set .Cell(flexcpPicture, i, 0) = img16.ListImages("诊断_关联").Picture
            End If
        Next
        .Cell(flexcpPictureAlignment, .FixedRows, 0, .Rows - 1, 0) = 4
        .Redraw = flexRDDirect
    End With
End Sub

Private Sub vsDiagComm_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim rsTmp As ADODB.Recordset
    With vsDiagComm
        If .MouseRow <> -1 Then
            If Button = 1 Then
                .Row = .MouseRow
                If .TextMatrix(.Row, col诊断内容) <> "" Then
                    picPanel(e诊断表格).Visible = False
                    If Not mrsComD Is Nothing Then
                        mrsComD.Filter = "ID=" & .TextMatrix(.Row, col项目ID)
                        If Not mrsComD.EOF Then
                            Set rsTmp = zlDatabase.CopyNewRec(mrsComD)
                            If Not IsNull(rsTmp!项目ID) Then
                                Call SetDiagInput(vsDiag.Row, rsTmp, rsTmp!类别 & "")
                            Else
                                Call SetDiagInput(vsDiag.Row, Nothing, "", rsTmp!名称 & "")
                            End If
                        End If
                    End If
                End If
            End If
        End If
    End With
End Sub

Private Sub vsDiagBefore_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim rsTmp As ADODB.Recordset
 
    With vsDiagBefore
        If .MouseRow <> -1 Then
            If Button = 1 Then
                .Row = .MouseRow
                If .TextMatrix(.Row, col诊断内容) <> "" Then
                    picPanel(e诊断表格).Visible = False
                    If Not mrsLasD Is Nothing Then
                        mrsLasD.Filter = "ID=" & .TextMatrix(.Row, col项目ID)
                        If Not mrsLasD.EOF Then
                            Set rsTmp = zlDatabase.CopyNewRec(mrsLasD)
                            Call SetDiagInputLast(vsDiag.Row, rsTmp)
                        End If
                    End If
                End If
            End If
        End If
    End With
End Sub

Private Sub vsDiagComm_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    SetVsListBorder vsDiagComm, 1
End Sub

Private Sub vsDiagBefore_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    SetVsListBorder vsDiagBefore, 1
End Sub

Private Sub vsAdvice_GotFocus()
    picPanel(e诊断表格).Visible = False
End Sub

Private Function PatiReSeeDoctor(ByVal lngRow As Long) As Boolean
'功能：判断病人本次是否复诊
    Dim rsTmp As ADODB.Recordset
    Dim strSQL1 As String, strSQL2 As String
    Dim strSQL As String
    Dim lngFirstZY As Long, lngFirstXY As Long, i As Long
    
    On Error GoTo errH
    
    '医生、科室与上次相同：没有转诊、续诊的
    strSQL1 = "Select 病人ID,执行人 as 医生,执行部门ID as 科室ID From 病人挂号记录 Where ID=[2] And 转诊科室ID Is Null And 续诊科室ID Is Null"
    
    strSQL2 = "Select Max(ID) as ID From 病人挂号记录 Where 病人ID=[1] And 记录性质=1 And 记录状态=1" & _
            " And 登记时间 =(Select Max(a.登记时间) From 病人挂号记录 A Where a.病人id=[1] And a.记录性质=1 And a.记录状态=1 And a.登记时间<(Select 登记时间 From 病人挂号记录 Where ID=[2])) "
    strSQL2 = "Select 病人ID,执行人 as 医生,执行部门ID as 科室ID From 病人挂号记录 Where ID=(" & strSQL2 & ") And 转诊科室ID Is Null And 续诊科室ID Is Null"
    
    strSQL = "Select 1 From (" & strSQL1 & ") A,(" & strSQL2 & ") B Where A.病人ID=B.病人ID And A.医生=B.医生 And A.科室ID=B.科室ID"
    
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng挂号ID)
    If rsTmp.EOF Then Exit Function
    lngFirstZY = 0: lngFirstXY = 0
    With vsDiag
        For i = .FixedRows To .Rows - 1
            If Trim(.TextMatrix(i, col诊断)) <> "" Then
                If .Cell(flexcpFontBold, i, COL中医) Then
                    If lngFirstZY = 0 Then
                        lngFirstZY = i
                    End If
                Else
                    If lngFirstXY = 0 Then
                        lngFirstXY = i
                    End If
                End If
            End If
            If lngFirstXY <> 0 And lngFirstZY <> 0 Then
                Exit For
            End If
        Next
        '当前输入的诊断是首要西医诊断，则判断西医诊断是否符合复诊
        If lngFirstXY <> 0 And .Cell(flexcpFontBold, lngRow, COL西医) And lngRow = lngFirstXY Then
            strSQL = "Select Max(ID) as 主页ID From 病人挂号记录 Where 病人ID=[1] And 记录性质=1 And 记录状态=1" & _
                    " And 登记时间 =(Select Max(a.登记时间) From 病人挂号记录 A Where a.病人id=[1] And a.记录性质=1 And a.记录状态=1 And a.登记时间<(Select 登记时间 From 病人挂号记录 Where ID=[2])) "
            strSQL = "Select 1 From 病人诊断记录" & _
                " Where 病人ID=[1] And 主页ID=(" & strSQL & ")" & _
                " And 诊断类型=1 And 记录来源 IN(1,3) And 诊断次序=1" & _
                " And (疾病ID=[3] And 疾病ID<>0 Or 诊断ID=[4] And 诊断ID<>0 Or 诊断描述=[5])"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng挂号ID, _
                Val(.TextMatrix(lngFirstXY, col疾病ID)), Val(.TextMatrix(lngFirstXY, col诊断ID)), .TextMatrix(lngFirstXY, col诊断))
            If Not rsTmp.EOF Then
                If MsgBox("病人就诊科室、医生、诊断与上次相同，要标记为复诊吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbYes Then
                    optState(1).value = True
                End If
                Exit Function
            End If
        End If
        '当前输入的诊断是首要中医诊断，则判断中医诊断是否符合复诊
        If mbln中医 And lngFirstZY <> 0 And .Cell(flexcpFontBold, lngRow, COL中医) And lngRow = lngFirstZY Then
            strSQL = "Select Max(ID) as 主页ID From 病人挂号记录 Where 病人ID=[1] And 记录性质=1 And 记录状态=1" & _
                   " And 登记时间 =(Select Max(a.登记时间) From 病人挂号记录 A Where a.病人id=[1] And a.记录性质=1 And a.记录状态=1 And a.登记时间<(Select 登记时间 From 病人挂号记录 Where ID=[2])) "
            strSQL = "Select 1 From 病人诊断记录" & _
                " Where 病人ID=[1] And 主页ID=(" & strSQL & ")" & _
                " And 诊断类型=11 And 记录来源 IN(1,3) And 诊断次序=1" & _
                " And (疾病ID=[3] And 疾病ID<>0 Or 诊断ID=[4] And 诊断ID<>0 Or 诊断描述=[5])"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng挂号ID, _
                Val(.TextMatrix(lngFirstZY, col疾病ID)), Val(.TextMatrix(lngFirstZY, col诊断ID)), .TextMatrix(lngFirstZY, col诊断))
            If Not rsTmp.EOF Then
                If MsgBox("病人就诊科室、医生、诊断与上次相同，要标记为复诊吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbYes Then
                    optState(1).value = True
                End If
                Exit Function
            End If
        End If
    End With
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub FuncApplyCustom(ByVal intType As Integer, ByVal lng文件ID As Long, Optional ByVal lng申请序号 As Long, Optional ByVal lng项目id As Long)
'功能：自定义申请单
    Dim objApplyCustom As New frmApplyCustom
    Dim lngOut医嘱ID As Long

    If mblnNoSave Then
        If Not CheckAdvice Then Exit Sub
        If Not SaveAdvice Then vsAdvice.SetFocus: Exit Sub
    End If
    
    If objApplyCustom.ShowMe(Me, 1, intType, mlng病人ID, mstr挂号单, 1, lng文件ID, lng申请序号, mlng挂号科室ID, mlng挂号科室ID, , mrsDefine, , , 1, mclsMipModule, mlng前提ID, , mint险类, lngOut医嘱ID, lng项目id) Then
         '重新读取显示医嘱
        LoadDiagInfo
        Call ReLoadAdvice(lngOut医嘱ID)
        mblnOK = True '强行
        If txt医嘱内容.Enabled Then
            txt医嘱内容.SetFocus
        Else
            vsAdvice.SetFocus
        End If
    End If
End Sub

Private Sub ShowAltAdvice()
'功能：显示备选医嘱以供用户选择
    Dim strAdvice As String, strTmp As String
    Dim i As Long, lngBegin As Long, lngEnd As Long, j As Long
    Dim lng相关ID As Long
    Dim lngItemID As Long
    Dim strRemove As String  '取消选择的医嘱,删除
    Dim strAltAdvice As String '动态加载备选医嘱，医嘱内容ID:婴儿序号:路径项目ID,...，例：227:0:38,335:1:69
    Dim str诊断IDs  As String
    Dim lng婴儿 As Integer
    Dim strHave As String   '界面上存在的医嘱
    Dim arrTmp As Variant
    Dim lngRow As Long
    
    With vsAdvice
        If Not CheckItemAltAdvice(Val(.TextMatrix(.Row, COL_路径项目ID))) Then
            MsgBox "当前选择的医嘱没有可用的备选医嘱。", vbInformation, "备选医嘱选择"
            Exit Sub
        End If
        lngItemID = Val(.TextMatrix(.Row, COL_路径项目ID))
        lng婴儿 = Val(.TextMatrix(.Row, COL_婴儿))
        For i = .FixedRows To .Rows - 1
            If .Cell(flexcpChecked, i, COL_选择) = 1 And lngItemID = Val(.TextMatrix(i, COL_路径项目ID)) And Val(.TextMatrix(i, COL_婴儿)) = lng婴儿 And .RowData(i) <> 0 Then
                strTmp = strTmp & "," & Abs(Val(.TextMatrix(i, COL_医嘱内容ID)))
            End If
        Next
        strTmp = Mid(strTmp, 2)
        strAdvice = gobjPathOut.zlShowAltAdvice(Me, Val(.TextMatrix(.Row, COL_路径项目ID)), strTmp, lng婴儿)
        For i = .FixedRows To .Rows - 1
            If lngItemID = Val(.TextMatrix(i, COL_路径项目ID)) And Val(.TextMatrix(i, COL_婴儿)) = lng婴儿 And .RowData(i) <> 0 Then
                If InStr("," & strAdvice & ",", "," & Abs(Val(.TextMatrix(i, COL_医嘱内容ID))) & ",") = 0 Then
                    '取消选择，并删除,不删除非备选医嘱
                    If .TextMatrix(i, COL_是否备选) = "1" Then
                        strRemove = strRemove & "," & i
                    Else
                        .Cell(flexcpChecked, i, COL_选择) = flexUnchecked
                        Call SetDiagFlag(i, 2)   '删除备选医嘱前同时删除医嘱诊断关联关系
                    End If
                Else
                    '医嘱关联诊断 121450
                    .Cell(flexcpChecked, i, COL_选择) = flexChecked
                    If str诊断IDs = "" Then
                        For j = 1 To vsDiag.Rows - 1
                            If Val(vsDiag.RowData(j)) <> 0 Then
                                str诊断IDs = str诊断IDs & "," & Val(vsDiag.RowData(j))
                            End If
                        Next
                        str诊断IDs = Mid(str诊断IDs, 2)
                    End If
                    If Val(.TextMatrix(i, COL_相关ID)) = 0 And .Cell(flexcpChecked, i, COL_选择) <> 2 Then Call SetDiagFlag(i, 1, str诊断IDs)
                End If
                strHave = strHave & "," & Abs(Val(.TextMatrix(i, COL_医嘱内容ID)))
            End If
        Next
        strHave = Mid(strHave, 2)
        strRemove = Mid(strRemove, 2)
        '生成医嘱对应医嘱内容
        arrTmp = Split(strAdvice, ",")
        For i = 0 To UBound(arrTmp)
            If InStr("," & strHave & ",", "," & arrTmp(i) & ",") = 0 Then
                '新勾选的医嘱
                If strAltAdvice = "" Then
                    strAltAdvice = Mid(arrTmp(i), 1, Len(arrTmp(i)) - 1) & ":" & lng婴儿 & ":" & lngItemID
                Else
                    strAltAdvice = strAltAdvice & "," & Mid(arrTmp(i), 1, Len(arrTmp(i)) - 1) & ":" & lng婴儿 & ":" & lngItemID
                End If
            End If
        Next
        lngRow = .Row
        '删除取消勾选的备选医嘱
        arrTmp = Split(strRemove, ",")
        For i = UBound(arrTmp) To 0 Step -1
            If arrTmp(i) <= lngRow Then lngRow = lngRow - 1
            '调整受影响行的序号(每删除一行就调整一次，因为有可能删除的行不是连续的。)
            Call AdviceSet医嘱序号(arrTmp(i) + 1, -1)
            Call SetDiagFlag(arrTmp(i), 2)   '删除备选医嘱前同时删除医嘱诊断关联关系
            .RemoveItem arrTmp(i)
        Next
        If lngRow > 0 Then .Row = lngRow
        '插入新增的备选医嘱
        If strAltAdvice <> "" Then
            Call GetRowScope(.Row, lngBegin, lngEnd)
            Call AdviceSet成套项目(3, 0, lngEnd, "", strAltAdvice)
        End If
    End With
End Sub

Private Function CheckItemAltAdvice(ByVal lng路径项目ID As Long) As Boolean
'功能：检查当前路径项目是否有备选医嘱
    Dim strSQL As String, rsTmp As Recordset
    
    strSQL = "Select Count(*) as 记录数 From 门诊路径医嘱内容 A ,门诊路径医嘱 B Where a.Id = b.医嘱内容id  And a.是否备选=1 And b.路径项目ID=[1] "
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng路径项目ID)
    CheckItemAltAdvice = Val(rsTmp!记录数 & "") > 0
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub SetPathRows(ByVal lngTop As Long, ByVal lngBottom As Long, Optional ByRef lng项目id As Long, Optional ByRef str路径项目分类 As String)
'功能：设置临床路径行及相关行的信息和显示
'     lng项目ID,str路径项目分类中药配方再次编辑时保存对应的项目ID和分类
    Dim k As Long, lngBegin As Long, lngEnd As Long, lngRow As Long
    Dim str诊疗项目IDs As String, lng路径项目ID As Long, str分类 As String
    Dim blnOut As Boolean
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim rsAdvice As ADODB.Recordset
    
    With vsAdvice
        lngRow = lngTop
        While lngRow <= lngBottom
            '一并给药时，只检查和设置当前行，因为路径外项目可能和路径内项目一并给药
            If RowIn一并给药(lngRow) Then
               lngBegin = lngRow
               lngEnd = lngRow
            Else
                Call GetRowScope(lngRow, lngBegin, lngEnd)
            End If
            If mrsPPati.RecordCount = 0 Then Exit Sub
            '自由录入的医嘱，不在路径表上体现,给药途径排除，因为药品单独一条一条判断
            If Val(.TextMatrix(lngRow, COL_婴儿)) = 0 And Val(.TextMatrix(lngRow, COL_诊疗项目ID)) <> 0 And Not (.TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "2") Then
                str诊疗项目IDs = ""
                For k = lngBegin To lngEnd
                    '药品不含给药途径、用法、煎法，输血不含途径,检验不含采集方式，手术不含附加手术、麻醉，检查不含部位方法
                    '含单独应用的输血途径
                    If (Not (.TextMatrix(k, COL_类别) = "E" And InStr(",2,3,4,6,8,", "," & .TextMatrix(k, COL_操作类型) & ",") > 0) _
                        Or (.TextMatrix(k, COL_类别) = "E" And .TextMatrix(k, COL_操作类型) & "" = "8")) _
                        And Not (InStr(",G,F,D,", "," & .TextMatrix(k, COL_类别) & ",") > 0 And Val(.TextMatrix(k, COL_相关ID)) <> 0) _
                        And Val(.TextMatrix(k, COL_诊疗项目ID)) <> 0 Then
                        str诊疗项目IDs = str诊疗项目IDs & "," & .TextMatrix(k, COL_诊疗项目ID)
                    End If
                Next
                str诊疗项目IDs = Mid(str诊疗项目IDs, 2)
                On Error GoTo errH
                
                lng路径项目ID = CheckPathInItemOut(Val(mrsPPati!当前阶段ID & ""), str诊疗项目IDs, str分类, RowIn配方行(.Row))
                
                '调用外挂接口进行判断，对于已匹配的外挂可以设置为不匹配
                If CreatePlugInOK(p门诊医嘱下达, mint场合) Then
                    Set rsAdvice = GetAdviceRs
                    For k = lngBegin To lngEnd
                        If Val(vsAdvice.RowData(k)) <> 0 Then
                            Call AdviceRSAddRow(rsAdvice, k)
                        End If
                    Next
                    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
                    On Error Resume Next
                    Call gobjPlugIn.CheckPathInItem(glngSys, p门诊医嘱下达, mlng病人ID, mlng挂号ID, rsAdvice, lng路径项目ID, str分类, mint场合)
                    Call zlPlugInErrH(err, "CheckPathInItem")
                    err.Clear: On Error GoTo 0
                    On Error GoTo errH
                End If
                
                For k = lngBegin To lngEnd
                    If lng路径项目ID = 0 Then
                        blnOut = True
                        If .RowHidden(k) = False Then
                            .Cell(flexcpBackColor, k, 0, k, .Cols - 1) = BackColorNew         '路径外项目，浅黄色
                        End If
                        .TextMatrix(k, COL_路径项目ID) = 0
                        .TextMatrix(k, COL_路径项目分类) = ""
                        If lng项目id <> 0 Then lng项目id = 0
                        If str路径项目分类 <> "" Then str路径项目分类 = ""
                    Else
                        .TextMatrix(k, COL_路径项目ID) = lng路径项目ID
                        .TextMatrix(k, COL_路径项目分类) = str分类
                        If lng项目id = 0 Then lng项目id = lng路径项目ID
                        If str路径项目分类 = "" Then str路径项目分类 = str分类
                        .Cell(flexcpBackColor, k, 0, k, .Cols - 1) = .BackColor
                    End If
                Next
                '如果是一并给药的，则同步更新给药途径
                If RowIn一并给药(lngRow) Then
                    k = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    If k <> -1 Then
                        .TextMatrix(k, COL_路径项目ID) = .TextMatrix(lngRow, COL_路径项目ID)
                        .TextMatrix(k, COL_路径项目分类) = .TextMatrix(lngRow, COL_路径项目分类)
                    End If
                End If
            End If
            lngRow = lngEnd + 1
        Wend
        If blnOut Then
            If InStr(GetInsidePrivs(P门诊路径应用), ";路径外项目;") = 0 Then
                MsgBox "你没有添加路径外项目的权限，请删除黄色背景的医嘱，否则不能保存医嘱。", vbExclamation, gstrSysName
            End If
        End If
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub
Private Function CheckPathInItemOut(ByVal lng阶段Id As Long, ByVal str诊疗项目IDs As String, ByRef str分类 As String, ByVal bln中药配方 As Boolean) As Long
'功能：检查临床路径病人，当前输入的医嘱（一组诊疗项目）是否是当前阶段的路径内项目，如果是，则返回项目ID
'      必须且仅执行一次的项目，生成时必定已产生，再添加就当成路径外项目。
'参数：str诊疗项目IDs= '药品不含给药途径、用法、煎法，输血不含途径,检验不含采集方式，手术不含附加手术、麻醉，检查不含部位方法
'      lng阶段ID=用于检查合并路径的项目是否匹配
'      bln中药配方=中药配方单独处理，根据参数设置的允许修改的中药比例来算
'      byt期效 =医嘱期效
'返回：路径项目ID和分类名称
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim str证候IDs As String
    Dim lng改动中药味数 As Long, dbl中药味数 As Double, lng中药味数 As Long
    Dim i As Long
    Dim arrTmp As Variant, blnTmp As Boolean
    
    str分类 = ""
    If str诊疗项目IDs = "0" Then
    '自由录入的医嘱固定当成路径外项目
        CheckPathInItemOut = 0
    Else
        lng中药味数 = Val(zlDatabase.GetPara("中药配方允许修改的中药味数上限", glngSys, P门诊路径应用, "30"))
        '给药途径可能因为收取不同费用的原因，实际使用时不是定义的给药途径，所以只判断药品相同即可
        If Not bln中药配方 Then
            strSQL = "Select 分类, 路径项目id,诊疗项目ids" & vbNewLine & _
                    "From (Select 分类, 路径项目id, 组id,f_List2str(Cast(Collect(To_Char(诊疗项目id)) As t_Strlist)) As 诊疗项目ids" & vbNewLine & _
                    "       From (Select c.路径项目id, b.分类, d.诊疗项目id, Nvl(d.相关id, d.Id) 组id,d.序号" & vbNewLine & _
                    "              From 门诊路径项目 B, 门诊路径医嘱 C, 门诊路径医嘱内容 D " & vbNewLine & _
                    "              Where b.Id = c.路径项目id And c.医嘱内容id = d.Id " & vbNewLine & _
                    "                    And Not Exists(Select 1 From 诊疗项目目录 E Where D.诊疗项目ID = E.ID And E.类别 = 'E' And  E.操作类型 In('2','3','4','6'))" & vbNewLine & _
                    "                    And Not Exists(Select 1 From 诊疗项目目录 E Where D.诊疗项目ID = E.ID And E.类别 In('G','F','D') And D.相关ID<>0 )" & vbNewLine & _
                    "                    And b.阶段id = [1] " & vbNewLine & _
                    "              Order By b.分类, b.项目序号, d.序号)" & vbNewLine & _
                    "       Group By 分类, 路径项目id, 组id)" & vbNewLine & _
                    IIF(InStr(str诊疗项目IDs, ",") > 0, " Where instr(诊疗项目ids,',')>0 ", "Where (诊疗项目ids = [2] or instr(','||诊疗项目ids||',',','||[2]||',')>0)")
        
            On Error GoTo errH
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "CheckPathInItemOut", lng阶段Id, str诊疗项目IDs)
            
            If InStr(str诊疗项目IDs, ",") > 0 Then
                '多个项目判断时，如检验项目，忽略顺序，如果其中有一个是路径外的那么一组就是路径外的
                arrTmp = Split(str诊疗项目IDs, ",")
                Do While Not rsTmp.EOF
                    blnTmp = True
                    For i = 0 To UBound(arrTmp)
                        If InStr("," & rsTmp!诊疗项目ids & ",", "," & arrTmp(i) & ",") = 0 Then
                            blnTmp = False
                            Exit For
                        End If
                    Next
                    If blnTmp Then
                        CheckPathInItemOut = rsTmp!路径项目ID
                        str分类 = rsTmp!分类
                        Exit Function
                    End If
                    
                    rsTmp.MoveNext
                Loop
            Else
                '如果有多个路径项目，则只取第一个
                If rsTmp.RecordCount > 0 Then
                    CheckPathInItemOut = rsTmp!路径项目ID
                    str分类 = rsTmp!分类
                    Exit Function
                End If
            End If
        Else
            '匹配时排开不符合的证候
            str证候IDs = Get证候IDs(mlng病人ID, mlng挂号ID)
            strSQL = "Select  分类, 路径项目id, 组id, f_List2str(Cast(Collect(To_Char(诊疗项目id)) As t_Strlist)) As 诊疗项目ids" & vbNewLine & _
                    "From (Select c.路径项目id, b.分类, d.诊疗项目id, Nvl(d.相关id, d.Id) 组id, d.序号" & vbNewLine & _
                    "       From 门诊路径项目 B, 门诊路径医嘱 C, 门诊路径医嘱内容 D" & vbNewLine & _
                    "       Where b.Id = c.路径项目id And c.医嘱内容id = d.Id And Exists(Select 1 From 诊疗项目目录 E Where d.诊疗项目id = e.Id And e.类别 = '7') " & vbNewLine & _
                    IIF(str证候IDs <> "", " And (Instr(',' || [2] || ',', ',' || d.组合项目id || ',') > 0 Or d.组合项目id Is Null)", "") & vbNewLine & _
                    "       And b.阶段id = [1]" & vbNewLine & _
                    "       Order By b.分类, b.项目序号, d.序号)" & vbNewLine & _
                    "Group By 分类, 路径项目id, 组id"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "CheckPathInItemOut", lng阶段Id, str证候IDs)
            Do While Not rsTmp.EOF
                If rsTmp!诊疗项目ids & "" <> "" Then
                    '允许改动的中药
                    dbl中药味数 = (UBound(Split(rsTmp!诊疗项目ids & "", ",")) + 1) * lng中药味数 / 100
                    lng改动中药味数 = 0
                    '先找，配方外的中药
                    For i = 0 To UBound(Split(str诊疗项目IDs, ","))
                        If InStr("," & rsTmp!诊疗项目ids & ",", "," & Split(str诊疗项目IDs, ",")(i) & ",") = 0 Then
                            lng改动中药味数 = lng改动中药味数 + 1
                        End If
                    Next
                    '再找配方中的中药，当且缺少的
                    If rsTmp!诊疗项目ids & "" <> "" Then
                        For i = 0 To UBound(Split(rsTmp!诊疗项目ids & "", ","))
                            If InStr("," & str诊疗项目IDs & ",", "," & Split(rsTmp!诊疗项目ids & "", ",")(i) & ",") = 0 Then
                                lng改动中药味数 = lng改动中药味数 + 1
                            End If
                        Next
                    End If
                    '如果在允许的范围之内，则匹配成功，否则继续匹配
                    If lng改动中药味数 <= dbl中药味数 Then
                        CheckPathInItemOut = rsTmp!路径项目ID
                        str分类 = rsTmp!分类
                        Exit Do
                    End If
                End If
                rsTmp.MoveNext
            Loop
        End If
    End If
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub SetAll一并给药(ByVal OldRow As Long, ByVal NewRow As Long)
'功能：将一定范围的医嘱行合并为一并给药
    Dim i As Long
    Dim strIDs As String
    Dim lngS As Long, lngE As Long
    Dim strMsg As String
    Dim lngTmp As Long, lngTmp1 As Long, lngTmp2 As Long
    Dim lngIDS As Long, lngIDE As Long
    Dim lng组ID As Long
    Dim str诊断IDs As String
    Dim strTmp As String
     
    lngS = OldRow
    lngE = NewRow
    
    If lngS = lngE Then Exit Sub
    
    If lngS > lngE Then
        lngS = lngS + lngE
        lngE = lngS - lngE
        lngS = lngS - lngE
    End If
    
    With vsAdvice
        If lngS < .FixedRows Then Exit Sub
        
        If RowIn一并给药(lngS) Then
            lng组ID = Val(.TextMatrix(lngS, COL_相关ID))
        End If
        
        If RowIn一并给药(lngE) Then
            If lng组ID = Val(.TextMatrix(lngE, COL_相关ID)) Then
                .Row = lngE
                cbsMain.FindControl(, conMenu_Merge, True, True).Execute
                Exit Sub
            End If
        End If
        
        For i = lngS To lngE
            If Not .RowHidden(i) Then
                If Val(.RowData(i)) = 0 Then
                    .Redraw = flexRDNone
                    MsgBox "您本次的鼠标拖选行中有空白行，不设置能一并给药", vbInformation, gstrSysName
                    .Redraw = flexRDDirect
                    Exit Sub
                End If
                '两行不符合条件
                strMsg = ""
                If i > lngS And Not .RowHidden(i) Then
                    If Not RowCanMerge(lngS, i, strMsg) Then
                        .Redraw = flexRDNone
                        MsgBox strMsg, vbInformation, gstrSysName
                        .Redraw = flexRDDirect
                        Exit Sub
                    End If
                End If
            End If
        Next
        
        '一并给药的取消一并约药，同时收集诊断
        lngIDS = Val(.RowData(lngS))
        lngIDE = Val(.RowData(lngE))
        mblnRowChange = False: .Redraw = flexRDNone
        For i = lngE To lngS Step -1
            If Not .RowHidden(i) Then
                If RowIn一并给药(i) Then
                    Call AdviceHaveDiag(i, 2, strTmp)
                    Call Get一并给药范围(Val(.TextMatrix(i, COL_相关ID)), lngTmp1, lngTmp2)
                    If i = lngE Then
                        lngIDE = Val(.RowData(lngTmp2))
                    ElseIf i = lngS Then
                        lngIDS = Val(.RowData(lngTmp1))
                    End If
                    i = lngTmp1
                    Call AdviceSet单独给药(lngTmp1, lngTmp2)
                Else
                    Call AdviceHaveDiag(i, 2, strTmp)
                End If
                str诊断IDs = str诊断IDs & IIF(strTmp = "", "", "," & strTmp)
                strTmp = ""
            End If
        Next
        
        '合并找到起始行和结束
        lngS = .FindRow(lngIDS)
        lngE = .FindRow(lngIDE)
        Call AdviceSet一并给药(lngS, lngE)
        .Row = lngS: .Col = col_医嘱内容
        
        '关联诊断
        str诊断IDs = Mid(str诊断IDs, 2)
        Call SetDiagFlag(.Row, 1, str诊断IDs)
        mblnRowChange = True: .Redraw = flexRDDirect
        Call vsAdvice_AfterRowColChange(-1, .Col, .Row, .Col)
    End With
End Sub

Private Sub ShowAdvice诊断()
'功能：显示医嘱表格上的诊断
    Dim i As Long
    Dim lng组ID As Long
    Dim lngPre组ID As Long
    Dim strTmp As String
    Dim rsDiag As ADODB.Recordset
    Dim str诊断 As String
    
    With vsAdvice
        .Redraw = flexRDNone
        For i = .FixedRows To .Rows - 1
            .TextMatrix(i, COL_诊断) = ""
        Next
        .Redraw = flexRDDirect
    End With
    
    mrsAD.Filter = 0
    If mrsAD.EOF Then Exit Sub
    
    Set rsDiag = New ADODB.Recordset
    rsDiag.Fields.Append "诊断id", adBigInt
    rsDiag.Fields.Append "内容", adVarChar, 40000
    rsDiag.CursorLocation = adUseClient
    rsDiag.LockType = adLockOptimistic
    rsDiag.CursorType = adOpenStatic
    rsDiag.Open
    
    With vsDiag
        For i = .FixedRows To .Rows - 1
            If .TextMatrix(i, col诊断) <> "" Then
                strTmp = IIF(.TextMatrix(i, col编码) <> "", "(" & .TextMatrix(i, col编码) & ")", "") & .TextMatrix(i, col诊断) & IIF(.TextMatrix(i, col中医证候) <> "", "(" & .TextMatrix(i, col中医证候) & ")", "")
                rsDiag.AddNew
                rsDiag!诊断id = Val(.RowData(i))
                rsDiag!内容 = strTmp
                rsDiag.Update
            End If
        Next
    End With
    
    With vsAdvice
        .Redraw = flexRDNone
        For i = .FixedRows To .Rows - 1
            If .RowData(i) <> 0 Then
                '每行都处理：隐藏行不会显示，一并给药非首行被OwnerDraw
                lng组ID = IIF(Val(.TextMatrix(i, COL_相关ID)) <> 0, Val(.TextMatrix(i, COL_相关ID)), .RowData(i))
                If lngPre组ID <> lng组ID Then
                    str诊断 = ""
                    mrsAD.Filter = "医嘱ID=" & lng组ID
                    Do While Not mrsAD.EOF
                        rsDiag.Filter = "诊断ID=" & mrsAD!诊断id
                        If Not rsDiag.EOF Then str诊断 = str诊断 & "," & rsDiag!内容
                        
                        mrsAD.MoveNext
                    Loop
                    str诊断 = Mid(str诊断, 2)
                    lngPre组ID = lng组ID
                End If
                .TextMatrix(i, COL_诊断) = str诊断
            End If
        Next
        .Redraw = flexRDDirect
    End With
End Sub

Private Sub UpdateRecipeNo()
'功能:获取处方序号
'说明:处方序号生成规则
'1-西药和中成药产生一个处方序号，中药饮片应当单独产生处方序号。
'2-西药和中成药每张处方不得超过5种药品（一并给药算一种药品）。
'
    Dim i               As Long
    Dim j               As Long
    Dim rsRecipe        As ADODB.Recordset
    Dim lng医嘱ID       As Long
    Dim lngSumCount     As Long
    Dim lngCount        As Long
    Dim lngNo           As Long
    Dim lngTemp         As Long
    Dim lngRecipeCount  As Long    '处方条数 =5
    
    lngRecipeCount = 5
    '构造缓存医嘱ID与处方序号的记录集缓存
    Set rsRecipe = New ADODB.Recordset
    With rsRecipe
        .Fields.Append "医嘱ID", adBigInt '一组医嘱的ID
        .Fields.Append "RecipeNo", adBigInt
        .Fields.Append "Type", adInteger    '1-西药和中成药;2-中药饮片
        .Fields.Append "Tag", adInteger    '1-已经产生处方序号;2-需要新增处方序号
        .CursorLocation = adUseClient
        .LockType = adLockOptimistic
        .CursorType = adOpenStatic
        .Open
    End With
    
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If Val(.TextMatrix(i, COL_状态)) = 1 And InStr(",5,6,7,", "," & .TextMatrix(i, COL_类别) & ",") > 0 And lng医嘱ID <> Val(.TextMatrix(i, COL_相关ID)) Then
                lng医嘱ID = Val(.TextMatrix(i, COL_相关ID))
                rsRecipe.AddNew
                rsRecipe!医嘱ID = Val(.TextMatrix(i, COL_相关ID))
                rsRecipe!RecipeNo = Val(.TextMatrix(i, COL_处方序号))
                rsRecipe!Tag = IIF(Val(.TextMatrix(i, COL_处方序号)) = 0, 2, 1)
                rsRecipe!Type = IIF(InStr(",5,6,", "," & .TextMatrix(i, COL_类别) & ",") > 0, 1, 2)
            End If
        Next
        If rsRecipe.RecordCount > 0 Then rsRecipe.UpdateBatch
        '西药中成药处方序号
        rsRecipe.Filter = "Type = 1"
        lngSumCount = rsRecipe.RecordCount
        If lngSumCount > 0 Then
            rsRecipe.Filter = "Type = 1 And RecipeNo = 0"
            lngCount = rsRecipe.RecordCount
        End If
        If lngSumCount = lngCount And lngCount > 0 Then
            For i = 1 To rsRecipe.RecordCount
                If i Mod lngRecipeCount = 1 Then
                    lngNo = GetRecipeNo()
                End If
                rsRecipe!RecipeNo = lngNo
                rsRecipe.MoveNext
            Next
        ElseIf lngCount > 0 And lngSumCount - lngCount > 0 Then
            rsRecipe.Filter = "Type = 1 And RecipeNo > 0"
            rsRecipe.Sort = "RecipeNo"
            '遍历获取处方序号及需要新添加到该处方序号的医嘱条数
            lngTemp = 0: lngNo = 0
            For i = 1 To rsRecipe.RecordCount
                If lngNo <> rsRecipe!RecipeNo Then
                    If lngTemp > 0 Then Exit For
                    lngNo = rsRecipe!RecipeNo
                    lngTemp = lngRecipeCount
                End If
                If lngNo = rsRecipe!RecipeNo Then lngTemp = lngTemp - 1
                rsRecipe.MoveNext
            Next
            rsRecipe.Filter = "Type = 1 And RecipeNo = 0"
            rsRecipe.Sort = ""
            For i = 1 To rsRecipe.RecordCount
                If i <= lngTemp Then
                    rsRecipe!RecipeNo = lngNo
                Else
                    Exit For
                End If
                rsRecipe.MoveNext
            Next
            '需要新产生处方序号
            rsRecipe.Filter = "Type = 1 And RecipeNo = 0"
            For i = 1 To rsRecipe.RecordCount
                If i Mod lngRecipeCount = 1 Then lngNo = GetRecipeNo()
                rsRecipe!RecipeNo = lngNo
                rsRecipe.MoveNext
            Next
        End If
        
        '中药饮片生成处方序号
        rsRecipe.Filter = "Type = 2"
        lngSumCount = rsRecipe.RecordCount
        If lngSumCount > 0 Then
            rsRecipe.Filter = "Type = 2 And RecipeNo = 0"
            lngCount = rsRecipe.RecordCount
        End If
        If lngSumCount = lngCount And lngCount > 0 Then
            lngNo = GetRecipeNo()
            For i = 1 To rsRecipe.RecordCount
                rsRecipe!RecipeNo = lngNo
                rsRecipe.MoveNext
            Next
        ElseIf lngCount > 0 And lngSumCount - lngCount > 0 Then
            rsRecipe.Filter = "Type = 2 And RecipeNo > 0"
            If Not rsRecipe.EOF Then lngNo = rsRecipe!RecipeNo
            rsRecipe.Filter = "Type = 2 And RecipeNo = 0"
            For i = 1 To rsRecipe.RecordCount
                rsRecipe!RecipeNo = lngNo
                rsRecipe.MoveNext
            Next
        End If
        rsRecipe.Filter = "Tag=2"
        rsRecipe.Sort = ""
        '将处方序号追加到表格
        For i = 1 To rsRecipe.RecordCount
            lng医嘱ID = rsRecipe!医嘱ID
            lngCount = .FindRow(lng医嘱ID, , COL_相关ID)
            If lngCount <> -1 Then
                For j = lngCount To .Rows - 1
                    If Val(.TextMatrix(j, COL_相关ID)) = lng医嘱ID Or CLng(.RowData(j)) = lng医嘱ID Then
                        .TextMatrix(j, COL_处方序号) = rsRecipe!RecipeNo & ""
                    Else
                        Exit For
                    End If
                Next
            End If
            rsRecipe.MoveNext
        Next
    End With
End Sub

Private Function GetRecipeNo() As Long
'功能:获取处方序号
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    
    On Error GoTo errH
    
    strSQL = "Select 病人医嘱记录_处方序号.Nextval as 处方序号 From Dual"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption)
    GetRecipeNo = Val(rsTmp!处方序号)
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub mnu_DelItem_Click()
    If mlngCommonID <> 0 Then
        SetInputAdvice mlngCommonID, , , 2
    End If
End Sub

Private Sub Add申请单诊断(ByVal lngDiagId As Long)
'功能：打开申请单后在申请单内部录入的诊断，退出申请单后将此诊断当成新增的诊断加到界面的表格中
    Dim i As Long
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim strTmp As String
    
    On Error GoTo errH
    
    '判断该诊断是否已经存在
    With vsDiag
        For i = .FixedRows To .Rows - 1
            If lngDiagId = Val(.RowData(i)) Then
                Exit Sub
            End If
        Next
    End With

    strSQL = "Select A.ID,A.记录来源,A.诊断次序,A.诊断类型,A.疾病ID,A.诊断ID,A.证候ID,A.诊断描述,A.是否疑诊, a.记录日期, a.记录人,B.编码 as ICD码,c.编码 as 诊断编码,d.编码 as 证候编码,A.发病时间," & _
        " b.附码 As 疾病附码, b.类别 As 疾病类别,d.名称 As 证候名称 From 病人诊断记录 A,疾病编码目录 B, 疾病诊断目录 C,疾病编码目录 D" & _
        " Where A.疾病ID=B.ID(+)  And a.诊断id = c.Id(+) And  a.证候ID=d.ID(+) And A.记录来源 IN(1,3) And A.诊断类型 IN(1,11)" & _
        " And A.取消时间 is Null And a.id=[1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lngDiagId)
    
    If Not rsTmp.EOF Then
        With vsDiag
            If .RowData(.Row) = 0 Then
                i = .Row
            Else
                .Rows = .Rows + 1
                i = .Rows - 1
            End If
            
            Call SetDiagType(i, rsTmp!诊断类型)
                 
            If IsNull(rsTmp!诊断描述) Then
                .TextMatrix(i, col编码) = ""
                .TextMatrix(i, col诊断) = ""
            Else
                If Mid(rsTmp!诊断描述, 1, 1) <> "(" Or (Val(rsTmp!诊断id & "") = 0 And Val(rsTmp!疾病id & "") = 0) Then '中医的诊断描述后面加了（候症），所以只判断第一个字符
                    '由于疾病编码和诊断可以对应，如果两个都不为空的时候，先判断疾病编码，先取疾病编码
                    If Val(rsTmp!疾病id & "") <> 0 Then
                        .TextMatrix(i, col编码) = NVL(rsTmp!ICD码)
                    ElseIf Val(rsTmp!诊断id & "") <> 0 Then
                        .TextMatrix(i, col编码) = NVL(rsTmp!诊断编码)
                    Else
                        .TextMatrix(i, col编码) = ""
                    End If
                    .TextMatrix(i, col诊断) = rsTmp!诊断描述
                Else
                    .TextMatrix(i, col编码) = Mid(rsTmp!诊断描述, 2, InStr(rsTmp!诊断描述, ")") - 2)
                    .TextMatrix(i, col诊断) = Mid(rsTmp!诊断描述, InStr(rsTmp!诊断描述, ")") + 1)
                End If
            End If
                 
            '取证候名称
            If InStr(.TextMatrix(i, col诊断), "(") > 0 And InStr(.TextMatrix(i, col诊断), ")") > 0 And Val(rsTmp!诊断类型 & "") = 11 Then
                strTmp = Mid(.TextMatrix(i, col诊断), InStrRev(.TextMatrix(i, col诊断), "(") + 1)
                strTmp = Mid(strTmp, 1, Len(strTmp) - 1)
                '先取证候
                .TextMatrix(i, col中医证候) = strTmp
                '去掉诊断描述的证候
                .TextMatrix(i, col诊断) = Mid(.TextMatrix(i, col诊断), 1, InStrRev(.TextMatrix(i, col诊断), "(") - 1)
            Else
                .TextMatrix(i, col中医证候) = ""
            End If
            If Not IsNull(rsTmp!疾病id) Or Not IsNull(rsTmp!诊断id) Then
                .Cell(flexcpData, i, col诊断) = Get诊断描述(Val("" & rsTmp!诊断id), Val("" & rsTmp!疾病id))    '获取原始名称以便修改时判断
            Else
                .Cell(flexcpData, i, col诊断) = .TextMatrix(i, col诊断)
            End If
          
            .Cell(flexcpData, i, col标志) = .Cell(flexcpData, i, col诊断) '存储原始诊断信息
            .Cell(flexcpData, i, col疑诊) = Val(NVL(rsTmp!是否疑诊, 0))
            .Cell(flexcpForeColor, i, col疑诊) = IIF(NVL(rsTmp!是否疑诊, 0) = 1, vbRed, .GridColor)
            .TextMatrix(i, col诊断ID) = NVL(rsTmp!诊断id, 0)
            .Cell(flexcpData, i, col诊断ID) = NVL(rsTmp!ID, 0)
            .TextMatrix(i, col疾病ID) = NVL(rsTmp!疾病id, 0)
            .TextMatrix(i, col证候ID) = NVL(rsTmp!证候id, 0)
            .TextMatrix(i, colICD码) = NVL(rsTmp!ICD码)
            .TextMatrix(i, col发病时间) = Format(rsTmp!发病时间 & "", "YYYY-MM-DD HH:mm")
            
            .TextMatrix(i, COL诊断编码) = NVL(rsTmp!诊断编码)
            .TextMatrix(i, COL疾病编码) = NVL(rsTmp!ICD码)
            .TextMatrix(i, COL疾病类别) = NVL(rsTmp!疾病类别)
            .TextMatrix(i, COL疾病附码) = NVL(rsTmp!疾病附码)
            .TextMatrix(i, COL证候编码) = NVL(rsTmp!证候编码)
            .RowData(i) = Val(rsTmp!ID)
            
             Call vsDiag_AfterRowColChange(-1, -1, .Rows - 1, col诊断)
             
             Call SetDiagHeight
            'PASS诊断传人
            If mblnPass Then
                zlPassDrugs
            End If
        End With
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub ReadMsg()
'功能：消息阅读 目前暂时处理ZLHIS_BLOOD_004消息
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    On Error GoTo errH
        
    strSQL = "select 1 from 病人医嘱记录 a where a.挂号单=[1] and a.医嘱状态=1 and a.诊疗类别='K' and a.检查方法='1' and a.审核状态=1 and rownum<2"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mstr挂号单)
    
    If rsTmp.EOF Then '没有这类数据了，将消息设为已阅
        strSQL = "select 1 from 业务消息清单 a where a.病人id=[1] and a.就诊id=[2] and a.类型编码='ZLHIS_BLOOD_004' and nvl(a.是否已阅,0)=0"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng挂号ID)
        If Not rsTmp.EOF Then
            strSQL = "Zl_业务消息清单_Read(" & mlng病人ID & "," & mlng挂号ID & ",'ZLHIS_BLOOD_004',1,'" & UserInfo.姓名 & "'," & mlng病人科室id & ")"
            Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
        End If
    End If
        
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub


Private Sub lblLink_Click()
'功能: 设置快捷病历的可见性
    mblnDocInput = Not mblnDocInput
    Call zlDatabase.SetPara("显示病历快捷输入", IIF(mblnDocInput, 1, 0), glngSys, p门诊医生站, InStr(";" & mMainPrivs & ";", ";参数设置;") > 0)

    picEpr.Visible = mblnDocInput
    
    If mblnDocInput Then
        lblLink.Caption = "收起快捷病历"
        Call LoadDocData
    Else
        lblLink.Caption = "展开快捷病历"
    End If

    Call Form_Resize
End Sub

Private Sub rtfEdit_Validate(Index As Integer, Cancel As Boolean)
    Call UpDate病历(Index)
End Sub

Private Sub rtfEdit_Change(Index As Integer)
    If mblnSizeTmp = True Then Exit Sub
    If picEpr.Tag = "" Then
        Call SetPermitEscape(False)
        If picOutDoc.Tag <> "2" Then picOutDoc.Tag = "2"
    Else
        picEpr.Tag = ""
    End If
    mblnChange = True
End Sub

Private Sub rtfEdit_GotFocus(Index As Integer)
    Call zlCommFun.OpenIme(True)
End Sub

Private Sub rtfEdit_KeyPress(Index As Integer, KeyAscii As Integer)
    If KeyAscii = 13 Then
        If Not mblnPatiChange Then
            KeyAscii = 0
            Call zlCommFun.PressKey(vbKeyTab)
        Else
            '连续两次回车光标跳转
            With rtfEdit(Index)
                If Trim(.Text) = "" Then
                    KeyAscii = 0
                    Call zlCommFun.PressKey(vbKeyTab)
                ElseIf .SelStart - 1 > 0 Then
                    If Mid(.Text, .SelStart - 1, 2) = vbCrLf Then
                        KeyAscii = 0
                        Call zlCommFun.PressKey(vbKeyBack)
                        Call zlCommFun.PressKey(vbKeyTab)
                    End If
                End If
            End With
        End If
    End If
End Sub

Private Sub rtfEdit_LostFocus(Index As Integer)
    Call zlCommFun.OpenIme
End Sub

Private Sub rtfEdit_SelChange(Index As Integer)
    With rtfEdit(Index)
        If .SelLength = 0 And .SelStart > 0 Then
            If Mid(.Text, .SelStart, 1) = "`" Or Mid(.Text, .SelStart, 1) = "・" Then
                picEpr.Tag = "UnChange"
                .SelStart = .SelStart - 1
                .SelLength = 1
                .SelText = ""
                Call ShowWordInput(rtfEdit(Index))
                picEpr.Tag = "UnChange"
            End If
        End If
    End With
End Sub

Private Sub txtSentence_GotFocus()
    Call zlCommFun.OpenIme(True)
    Call zlControl.TxtSelAll(txtSentence)
End Sub

Private Sub txtSentence_KeyPress(KeyAscii As Integer)
    Dim strSentence As String, blnCancel As Boolean, strType As String
       
    If KeyAscii = 13 Then
        KeyAscii = 0
        
        Select Case Val(picSentence.Tag)
        Case txt主诉
            strType = "病人主诉"
        Case txt家族史
            strType = "家族史"
        Case txt现病史
            strType = "现病史"
        Case txt查体
            strType = "体格一般检查"
        Case txt过去史
            strType = "既往史"
        End Select
                
'        strSentence = frmSentenceSel.ShowMe(Me, mlng病历文件id, mstr性别, mstr婚姻状况, strType, txtSentence.Text, picSentence.hwnd, blnCancel)
        
        strSentence = mcls病历功能.ShowSentenceSel(Me, mlng病历文件id, mstr性别, mstr婚姻状况, strType, txtSentence.Text, picSentence.hwnd, blnCancel)
        
        If strSentence <> "" Then
            rtfEdit(Val(picSentence.Tag)).SelText = strSentence
            Call HideWordInput
        Else
            If Not blnCancel Then
                MsgBox "没有找到匹配的词句。", vbInformation, gstrSysName
            End If
            Call zlControl.TxtSelAll(txtSentence)
        End If
    ElseIf KeyAscii = Asc("*") Then
        KeyAscii = 0
        Call imgSentence_Click
    ElseIf KeyAscii = Asc("`") Then
        KeyAscii = 0
        Call HideWordInput
    End If
End Sub

Private Sub imgSentence_Click()
    Dim strSentence As String, strType As String
    
    Select Case Val(picSentence.Tag)
    Case txt主诉
        strType = "病人主诉"
    Case txt家族史
        strType = "家族史"
    Case txt现病史
        strType = "现病史"
    Case txt查体
        strType = "体格一般检查"
    Case txt过去史
        strType = "既往史"
    End Select
    
'    strSentence = frmSentenceSel.ShowMe(Me, mlng病历文件id, mstr性别, mstr婚姻状况, strType)
    strSentence = mcls病历功能.ShowSentenceSel(Me, mlng病历文件id, mstr性别, mstr婚姻状况, strType)
    If strSentence <> "" Then
        rtfEdit(Val(picSentence.Tag)).SelText = strSentence
        Call HideWordInput
    End If
End Sub

Private Sub txtSentence_LostFocus()
    If Not frmSentenceSel.mblnShow Then
        Call HideWordInput   '隐藏词句输入
    End If
End Sub

Private Sub cmdImportEPRDemo_Click()
    Dim rsDemo As New Recordset
    If mlng病历id <> 0 Then
        MsgBox "该病人已经产生了病历文件，不能再导入范文。", vbInformation, Me.Caption
        Exit Sub
    End If
    
    If mcls病历功能.ShowImportEPRDemo(Me, mlng病历文件id, mlng病人ID, mlng挂号ID, rsDemo) > 0 Then
        Call SetDocData(rsDemo, 1)
    End If
End Sub

Private Sub SetDocData(ByVal rsTmp As Recordset, ByVal intType As Integer)
'功能：设置快捷面板的内容
'参数：intType=0病历读取，intType=1范文导入，不清空病历ID
    Dim i As Long, j As Long, arrTmp As Variant
    Dim strContent As String
    
    With rsTmp
        If .RecordCount > 0 Then
            arrTmp = Split("-10,2,3,5,6", ",") '病人主诉,现病史,既往史,家族史,体格检查
            For i = 0 To UBound(arrTmp)
                .Filter = "预制提纲id=" & arrTmp(i)
                rtfEdit(i).Text = ""
                If intType = 1 Then
                    '导入范文后所有都可用。
                    rtfEdit(i).Locked = False
                    rtfEdit(i).BackColor = EColor
                End If
                For j = 1 To .RecordCount
                    If j = 1 Then
                        strContent = "" & !内容文本
                        If InStr(strContent, lblDoc(i).Tag) = 1 Then strContent = Mid(strContent, Len(lblDoc(i).Tag) + 1)
                        rtfEdit(i).Text = strContent
                        If intType = 0 Then rtfEdit(i).Tag = !ID
                    Else
                        rtfEdit(i).Text = rtfEdit(i).Text & vbCrLf & !内容文本
                        If intType = 0 Then rtfEdit(i).Tag = rtfEdit(i).Tag & "," & !ID
                    End If
                    .MoveNext
                Next
            Next
        End If
    End With
End Sub

Private Sub cmdSign_Click()
    Dim i As Long, str对象属性 As String, strSource As String, strSQL As String
    Dim arrSQL As Variant, blnTrans As Boolean
    Dim patiSign As cEPRSign, objEPRDoc As cEPRDocument
    
    If mbln是否签名 = False Then
        For i = 0 To rtfEdit.UBound
            If Trim(rtfEdit(i).Text) <> "" Then Exit For
        Next
        If i > rtfEdit.UBound Then
            MsgBox "请先输入病历信息后再进行签名。", vbInformation, gstrSysName
            Exit Sub    '新增时，如果没有填内容，则不保存
        End If
                                         
        If edtEditor.Text = "" Then
            If ReadRTFData(mlng病历id) = False Then Exit Sub
        End If
        
        strSource = edtEditor.Text
        If cmdSign.Visible And cmdSign.Enabled Then cmdSign.SetFocus
        Set patiSign = mcls病历功能.ShowOutDocterSign(Me, strSource, mlng病人ID, mlng挂号ID)
        If patiSign Is Nothing Then Exit Sub
        With patiSign
            .Key = "1"
            str对象属性 = .签名方式 & ";" & .签名规则 & ";" & .证书ID & ";" & IIF(.显示手签, 1, 0) & ";" & _
                    Format(.签名时间, "yyyy-mm-dd hh:mm:ss") & ";" & .显示时间 & ";" & .签名要素
                    
            strSQL = "Zl_简单门诊病历_签名(1," & mlng病历id & ",'" & str对象属性 & "','" & UserInfo.姓名 & "','" & _
                    .前置文字 & "','" & .时间戳 & "','" & .签名级别 & "','" & .签名信息 & "')"
        End With
        
        Set objEPRDoc = GetEPRDoc()
        If objEPRDoc Is Nothing Then Exit Sub
        Call patiSign.InsertIntoEditor(edtEditor, Len(edtEditor.Text), , objEPRDoc)
        Set objEPRDoc = Nothing
        Set patiSign = Nothing
    Else
        If MsgBox("你确定要取消签名吗？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
            Exit Sub
        End If
        
        Set patiSign = GetSign(mlng病历id)
        If patiSign Is Nothing Then Exit Sub
        
        Set objEPRDoc = GetEPRDoc()
        If objEPRDoc Is Nothing Then Exit Sub
        Call patiSign.DeleteFromEditor(edtEditor, objEPRDoc)
        Set objEPRDoc = Nothing
        Set patiSign = Nothing
        
        strSQL = "Zl_简单门诊病历_签名(0," & mlng病历id & ")"
    End If
   
    On Error GoTo errH
    gcnOracle.BeginTrans: blnTrans = True
    Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
    
    If SaveRTFData(mlng病历id, True) = False Then GoTo errH
    gcnOracle.CommitTrans: blnTrans = False
    Call LoadDocData
    Exit Sub
errH:
    If blnTrans Then gcnOracle.RollbackTrans
    If ErrCenter() = 1 Then
        Resume
    End If
    Set objEPRDoc = Nothing: Set patiSign = Nothing
    Call SaveErrLog
End Sub

Private Function GetEPRDoc() As zlRichEPR.cEPRDocument
'功能：读取病历文件的RTF数据到editor控件中，并返回文档对象
    Dim objDoc As New zlRichEPR.cEPRDocument
    objDoc.InitEPRDoc cprEM_修改, cprET_单病历编辑, mlng病历id, cprPF_门诊, mlng病人ID, mlng挂号ID, , mlng病人科室id
    If objDoc.ReadFileStructure(edtEditor) = True Then
        Set GetEPRDoc = objDoc
    End If
End Function

Private Function GetSign(ByVal lng病历ID As Long) As cEPRSign
'功能：获取当前用户的签名对象
    Dim rsTemp As ADODB.Recordset, strSQL As String
    Dim OneSign As New cEPRSign, intSign As Integer, strUserName As String
    
    strUserName = UserInfo.姓名
    intSign = zlDatabase.GetPara("SignShow", glngSys, 1070, 0)
    If intSign = 1 Then
        strSQL = "Select 签名 From 人员表 Where ID = [1]"
        Set rsTemp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, UserInfo.ID)
        If rsTemp.RecordCount > 0 Then
            If Not IsNull(rsTemp!签名) Then strUserName = rsTemp!签名
        End If
    End If
    strSQL = "Select Id,对象标记 From 电子病历内容 Where 文件id= [1] And 对象类型=8 And Instr(';'||内容文本||';',[2])>0 Order By 对象标记"
    Set rsTemp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng病历ID, ";" & strUserName & ";")
    If rsTemp.RecordCount > 0 Then
        OneSign.Key = NVL(rsTemp!对象标记, 0)
        If OneSign.GetSignFromDB(rsTemp!ID) = True Then Set GetSign = OneSign
    End If
End Function

Private Sub ShowWordInput(ByRef txtThis As RichTextBox)
'功能：显示词句输入
    Dim vPos As PointAPI
    
    If txtThis.Visible And txtThis.Enabled And Not txtThis.Locked Then
        picSentence.Tag = txtThis.Index '记下以便隐藏返回后定位
        
        If txtThis.Text = "" Then picEpr.Tag = "UnChange": txtThis.Text = " " '必须要有一个空字符才能返回其坐标
        vPos = zlControl.GetCaretPos(txtThis.hwnd)
        If txtThis.Text = " " Then picEpr.Tag = "UnChange": txtThis.Text = ""
        
        If vPos.X <> -1 And vPos.Y <> -1 Then
            If txtThis.Left + vPos.X + Screen.TwipsPerPixelX * 2 < txtThis.Left + txtThis.Width - picSentence.Width - 2 * Screen.TwipsPerPixelX Then
                picSentence.Left = txtThis.Left + vPos.X + Screen.TwipsPerPixelX * 2
            Else
                picSentence.Left = txtThis.Left + txtThis.Width - picSentence.Width - 2 * Screen.TwipsPerPixelX
            End If
            picSentence.Top = txtThis.Top + vPos.Y + Screen.TwipsPerPixelY
            txtSentence.Text = ""
            picSentence.Visible = True
            txtSentence.SetFocus
        End If
    End If
End Sub

Private Sub HideWordInput()
'功能：隐藏词句输入
    Dim idx As Long
    
    If picSentence.Visible Then
        picSentence.Visible = False
        txtSentence.Text = ""
        
        idx = Val(picSentence.Tag)
        picSentence.Tag = ""
        
        If rtfEdit(idx).Visible And rtfEdit(idx).Enabled And Not rtfEdit(idx).Locked Then
            rtfEdit(idx).SetFocus
        End If
    End If
End Sub

Private Sub SetPermitEscape(ByVal blnOK As Boolean)
    Dim i As Long
    If blnOK Then
        mblnPatiChange = False
    Else
        If Visible And mblnPatiChange = False Then
            mblnPatiChange = True
            For i = 0 To rtfEdit.Count - 1
                If rtfEdit(i).Locked = False And rtfEdit(i).Visible Then
                    rtfEdit(i).BackColor = EColor
                End If
            Next
        End If
    End If
End Sub

Private Sub SetDocEditable()
    Dim i As Long, blnDo As Boolean, blnBasis As Boolean, blnDoc As Boolean
    Dim k As Long
        
    If mblnDocInput Then
        blnDoc = (mlng病历id = 0 And mlng病历文件id <> 0 Or mlng病历id <> 0 And mbln是否签名 = False)
        If blnDoc And mlng病历id <> 0 And lblDoctor(1).Tag = "0" Then   '没有修改他人病历的权限
            blnDoc = mstr保存人 = UserInfo.姓名
        End If
       
        k = 0
        For i = 0 To rtfEdit.Count - 1
            rtfEdit(i).Locked = Not blnDoc Or InStr(rtfEdit(i).Tag, ",") > 0   '存在多行内容时(进行了全文编辑保存)，不允许再修改
            If rtfEdit(i).Locked = False Then
                rtfEdit(i).BackColor = EColor
                k = k + 1
            Else
                rtfEdit(i).BackColor = DColor
            End If
        Next
        If k > 0 Then
            picOutDoc.BackColor = EColor
            picPrompt.BackColor = EColor
        Else
            picOutDoc.BackColor = DColor
            picPrompt.BackColor = DColor
        End If

        If mlng病历id = 0 Or mlng病历id <> 0 And mbln是否签名 = False Then
            cmdSign.Caption = "签名(&S)"
        Else
            cmdSign.Caption = "取消签名(&S)"
        End If
        cmdSign.Enabled = (mlng病历id = 0 And mlng病历文件id <> 0 Or mlng病历id <> 0)

        If cmdSign.Enabled And mlng病历id <> 0 And lblDoctor(1).Tag = "0" Then   '没有修改他人病历的权限
            cmdSign.Enabled = mstr保存人 = UserInfo.姓名
        End If
        cmdUpdate.Enabled = cmdSign.Enabled
    End If
End Sub

Private Sub LoadDocData()
    Dim rsTmp As ADODB.Recordset, strSQL As String, strContent As String
    Dim i As Long, j As Long, arrTmp  As Variant, blnLoading As Boolean
   
    For i = 0 To rtfEdit.UBound
        rtfEdit(i).Text = ""
        rtfEdit(i).Tag = ""
    Next
    lblEPRname.Caption = ""    '仅用于技术人员查原因，例如：选择提纲词句时，没有列出预计的词句，可根据病历文件名称查是否设置了提纲词句对应
    
    '只显示简单病历模式下产生的文件
    strSQL = "Select id,文件id,签名级别,病历名称,保存人 From 电子病历记录 A Where 病人id = [1] And 主页id = [2] And 病历种类 = 1" & vbNewLine & _
        " And Exists(Select 1 From 病历文件列表 B Where A.文件ID = B.ID And B.保留 = '3')"

    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng挂号ID)
    If rsTmp.RecordCount > 0 Then
        If SetCompendsTag(Val("" & rsTmp!文件ID)) Then
            mlng病历文件id = Val("" & rsTmp!文件ID)
            mbln是否签名 = IIF(Val("" & rsTmp!签名级别) > 0, True, False)
            mlng病历id = rsTmp!ID
            mstr保存人 = "" & rsTmp!保存人
            lblEPRname.Caption = "" & rsTmp!病历名称
            '读取提纲下的段落文本,对象属性为-1表示提纲标题文本
            strSQL = "Select A.预制提纲id, B.内容文本, B.ID" & vbNewLine & _
                    "From 电子病历内容 A, 电子病历内容 B" & vbNewLine & _
                    "Where A.文件id = [1] And A.对象类型 = 1 And A.预制提纲id+0 In(-10,5,2,6,3)" & vbNewLine & _
                    "      And B.父id = A.ID And B.对象类型 = 2 Order By A.预制提纲id, B.对象序号"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病历id)
            With rsTmp
                If .RecordCount > 0 Then
                    arrTmp = Split("-10,2,3,5,6", ",") '病人主诉,现病史,既往史,家族史,体格检查
                    For i = 0 To UBound(arrTmp)
                        .Filter = "预制提纲id=" & arrTmp(i)
                        For j = 1 To .RecordCount
                            If j = 1 Then
                                strContent = "" & !内容文本
                                If InStr(strContent, lblDoc(i).Tag) = 1 Then strContent = Mid(strContent, Len(lblDoc(i).Tag) + 1)
                                rtfEdit(i).Text = strContent
                                rtfEdit(i).Tag = !ID
                            Else
                                rtfEdit(i).Text = rtfEdit(i).Text & vbCrLf & !内容文本
                                rtfEdit(i).Tag = rtfEdit(i).Tag & "," & !ID
                            End If
                            .MoveNext
                        Next
                    Next
                End If
            End With
        End If
    Else
        If mbytPatiType = 2 Then
            strSQL = " And (R.事件 = '急诊'  OR R.事件 IS NUll)"
        Else
            If mbln复诊 Then
                strSQL = " And (R.事件 = '门诊' Or R.事件 = '复诊'  OR R.事件 IS NUll)"
            Else
                strSQL = " And (R.事件 = '门诊' Or R.事件 = '初诊'  OR R.事件 IS NUll )"
            End If
        End If
        '系统定义了门(急)诊病历且对当前病人适用，具有5个固定预制提纲,才显示病历录入面板.
        strSQL = "Select F.ID, F.名称 as 病历名称" & vbNewLine & _
                "From (Select F.ID, F.通用, A.科室id, F.名称,Decode(R.事件,Null,2,1) 事件" & vbNewLine & _
                "       From 病历文件列表 F, 病历应用科室 A, 病历时限要求 R" & vbNewLine & _
                "       Where F.ID = A.文件id(+) And F.ID = R.文件id(+) And F.种类 = 1 And F.保留= '3'" & strSQL & ") F" & vbNewLine & _
                "Where F.通用 = 1 Or F.通用 = 2 And F.科室id = [2]" & vbNewLine & _
                "Order By F.事件,F.通用 Desc,F.id"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng挂号ID, mlng病人科室id)
        If rsTmp.RecordCount > 0 Then
            mlng病历文件id = rsTmp!ID
            lblEPRname.Caption = "" & rsTmp!病历名称
            If SetCompendsTag(mlng病历文件id) = False Then
                mlng病历文件id = 0: lblEPRname.Caption = ""
            End If
        Else
            mlng病历文件id = 0: lblEPRname.Caption = ""
        End If
        
        mlng病历id = 0
        mbln是否签名 = False
    End If
    
    mrsMainInfo.Filter = "控件名='rtfEdit'"

    For i = 1 To mrsMainInfo.RecordCount
        mrsMainInfo!信息原值 = rtfEdit(mrsMainInfo!Index).Text
        mrsMainInfo.Update
        mrsMainInfo.MoveNext
    Next
    mblnNoSave = False
    '记录原信息用于判断是否保存
    cmdImportEPRDemo.Visible = mlng病历文件id <> 0
    Call SetDocEditable
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function SetCompendsTag(ByVal lng病历文件id As Long) As Boolean
    Dim rsTmp As ADODB.Recordset, strSQL As String, i As Long
    
    strSQL = "Select Decode(A.预制提纲id, -10, 0, 5, 3, 2, 1, 6, 4, 3, 2) As 序号, B.内容文本" & vbNewLine & _
            "From 病历文件结构 A, 病历文件结构 B" & vbNewLine & _
            "Where A.文件id = [1] And A.预制提纲id+0 In (-10,5,2,6,3) And A.Id = B.父id And B.对象类型 = 2" & vbNewLine & _
            "Order By 序号"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng病历文件id)
    If rsTmp.RecordCount > 0 And rsTmp.RecordCount <= 5 Then
        If rsTmp!序号 & "" = "0" Then  '必须包含主诉
            For i = 0 To rsTmp.RecordCount - 1
                lblDoc(Val(rsTmp!序号 & "")).Tag = rsTmp!内容文本       '用于保存Rtf文件替换内容时定位
                rsTmp.MoveNext
            Next
            For i = 1 To lblDoc.Count - 1
                If lblDoc(i).Tag = "" Then
                    lblDoc(i).Visible = False
                    rtfEdit(i).Visible = False
                Else
                    lblDoc(i).Visible = True
                    rtfEdit(i).Visible = True
                End If
            Next
            SetCompendsTag = True
        End If
    End If
End Function

Private Sub GetSQLOutDoc(ByRef arrSQL As Variant, ByVal lng病历ID As Long)
'功能：组织快捷病历的数据保存SQL
'参数：lng病历ID-新增时传入新取的病历ID
    Dim i As Long, k As Long
    Dim strTmp(5) As String
    
    If mlng病历id = 0 Then
        For i = 0 To rtfEdit.UBound
            If Trim(rtfEdit(i).Text) <> "" Then Exit For
        Next
        If i > rtfEdit.UBound Then Exit Sub     '新增时，如果没有填内容，则不保存
    End If
    
    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
     
    If mlng病历id = 0 Then
        If rtfEdit(txt主诉).Locked Then Exit Sub
        arrSQL(UBound(arrSQL)) = "Zl_简单门诊病历_Update(1," & mlng病人ID & "," & _
            mlng挂号ID & "," & mlng病人科室id & "," & mlng病历文件id & "," & lng病历ID & ",'" & UserInfo.姓名 & "','" & _
            Replace(Trim(rtfEdit(txt主诉).Text), "'", "’") & "','" & Replace(Trim(rtfEdit(txt家族史).Text), "'", "’") & "','" & Replace(Trim(rtfEdit(txt现病史).Text), "'", "’") & "','" & _
            Replace(Trim(rtfEdit(txt查体).Text), "'", "’") & "','" & Replace(Trim(rtfEdit(txt过去史).Text), "'", "’") & "')"
    Else
        k = 0
        For i = 0 To rtfEdit.UBound
            If rtfEdit(i).Locked = False Then
                strTmp(i) = rtfEdit(i).Tag & "|" & Replace(Trim(rtfEdit(i).Text), "'", "’")
                k = k + 1
            End If
        Next
        If k = 0 Then Exit Sub
        arrSQL(UBound(arrSQL)) = "Zl_简单门诊病历_Update(2," & mlng病人ID & "," & _
            mlng挂号ID & "," & mlng病人科室id & ",0," & mlng病历id & ",'" & UserInfo.姓名 & "','" & _
            strTmp(0) & "','" & strTmp(3) & "','" & strTmp(1) & "','" & strTmp(4) & "','" & strTmp(2) & "')"
    End If
End Sub

Private Sub UpDate病历(ByVal intIdx As Integer)
'功能：保存病历
    Dim arrSQL As Variant, i As Long, blnTrans As Boolean
    Dim lng病历ID As Long
    Dim strValue As String
    Dim strTmp As String
 
    On Error GoTo errH
    If Not mblnChange Then Exit Sub
    If rtfEdit(intIdx).BackColor = DColor Then
        Exit Sub
    End If
    strValue = Trim(rtfEdit(intIdx).Text)
 
    mrsMainInfo.Filter = "控件名='rtfEdit' and Index=" & intIdx
    
    strValue = Replace(strValue, "'", "’")
    If zlCommFun.ActualLen(strValue) > 4000 Then
        rtfEdit(intIdx).BackColor = &HC0C0FF
        strTmp = mrsMainInfo!信息名 & "-内容太长(允许录入4000个字符或2000个汉字)。"
        mrsMainInfo.Update "ErrInfo", strTmp
        Exit Sub
    Else
        rtfEdit(intIdx).BackColor = vbWindowBackground
        mrsMainInfo.Update "ErrInfo", ""
    End If
    
    If mrsMainInfo!信息原值 & "" = strValue Then
        Exit Sub
    End If

    arrSQL = Array()
    If mlng病历id = 0 Then lng病历ID = zlDatabase.GetNextID("电子病历记录")
    
    Call GetSQLOutDoc(arrSQL, lng病历ID)
    If UBound(arrSQL) = -1 Then Exit Sub
    
    '提交数据
    On Error GoTo errH
    gcnOracle.BeginTrans: blnTrans = True
    For i = 0 To UBound(arrSQL)
        Call zlDatabase.ExecuteProcedure(CStr(arrSQL(i)), Me.Caption)
    Next
  
    If ReadRTFData(lng病历ID) = False Then GoTo errH
    If SaveRTFData(lng病历ID) = False Then GoTo errH
      
    gcnOracle.CommitTrans: blnTrans = False
    
    mrsMainInfo!信息原值 = strValue
    mrsMainInfo.Update
 
    If mlng病历id = 0 Then Call LoadDocData
    Exit Sub
errH:
    If blnTrans Then gcnOracle.RollbackTrans
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ReadRTFData(ByVal lng病历ID As Long) As Boolean
'功能：读取病历文件的RTF数据到editor控件中
    Dim strZipFile As String, strTempFile As String
    Dim lngRecID As Long
    
    If mlng病历id = 0 Then
        lngRecID = lng病历ID
    Else
        lngRecID = mlng病历id
    End If
    
    On Error GoTo errH
        
    '判断本次是不是新增的病历
    If mlng病历id = 0 Then
        strZipFile = Sys.ReadLob(glngSys, 1, mlng病历文件id)
    Else
        strZipFile = Sys.ReadLob(glngSys, 5, lngRecID)
    End If
    
    strTempFile = zlFileUnzip(strZipFile)
    edtEditor.OpenDoc strTempFile
     '删除临时文件
    If strTempFile <> "" Then Kill strTempFile
    If strZipFile <> "" Then Kill strZipFile
   
    ReadRTFData = True
    Exit Function
errH:
    ReadRTFData = False
End Function

Private Function SaveRTFData(ByVal lng病历ID As Long, Optional blnSign As Boolean) As Boolean
'功能：保存病人病历格式RTF数据
'参数：
    Dim strZipFile As String, strTempFile As String, i As Long
    Dim bFinded As Boolean, lngStartPos As Long, lngEndPos As Long, arrTmp As Variant
    Dim strContent As String, lngRecID As Long
    
    If mlng病历id = 0 Then
        lngRecID = lng病历ID
    Else
        lngRecID = mlng病历id
    End If

    If blnSign = False Then
        '替换提纲内容
        edtEditor.Freeze
        edtEditor.ForceEdit = True

        For i = 0 To lblDoc.UBound
            bFinded = FindOutLinePosition(edtEditor, CStr(lblDoc(i).Tag), lngStartPos, lngEndPos)
            If bFinded Then
                strContent = rtfEdit(i).Text    '去掉尾部的回车或换行
                Do While Len(strContent) > 2
                    If Mid(strContent, Len(strContent) - 1) = vbLf Or Mid(strContent, Len(strContent) - 1) = vbCr Then
                        strContent = Mid(strContent, Len(strContent) - 1)
                    Else
                        Exit Do
                    End If
                Loop
                edtEditor.Range(lngStartPos, lngEndPos).Text = strContent
            End If
        Next

        edtEditor.UnFreeze
        edtEditor.ForceEdit = False
        '要素内容更新
        If mlng病历id = 0 Then Call ElementsUpdate(lngRecID)
    End If

    On Error GoTo errH
    strTempFile = App.Path & "\TMP.rtf"
    If Dir(strTempFile) <> "" Then Kill strTempFile
    edtEditor.SaveDoc strTempFile
    '压缩文件
    strZipFile = zlFileZip(strTempFile)
    '保存格式
    Call Sys.SaveLob(glngSys, 5, lngRecID, strZipFile)

    '删除临时文件
    If strTempFile <> "" Then Kill strTempFile
    If strZipFile <> "" Then Kill strZipFile

    SaveRTFData = True
    Exit Function
errH:
    SaveRTFData = False
End Function

Private Function ElementsUpdate(ByVal lng病历ID As Long) As Boolean
'功能：更新Editor控件中的替换要素内容，以便保存为RTF文件
    Dim ThisElements As New zlRichEPR.cEPRElements
    Dim rsTmp As ADODB.Recordset, strSQL As String
    Dim i As Long, lngKey As Long
    Dim bFinded As Boolean, bNeeded As Boolean, lKSS As Long, lKSE As Long, lKES As Long, lKEE As Long

    strSQL = "Select 对象标记,ID From 电子病历内容 Where 文件ID= [1] And 对象类型 = 4 And 终止版=0 and 保留对象 =0 And 替换域 =1 order by 对象标记 "
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng病历ID)
    For i = 1 To rsTmp.RecordCount
        lngKey = ThisElements.Add(NVL(rsTmp("对象标记"), 0))
        ThisElements("K" & lngKey).GetElementFromDB cprET_单病历编辑, rsTmp("ID"), True
        rsTmp.MoveNext
    Next

     For i = 1 To ThisElements.Count
        If ThisElements(i).替换域 = 1 Then
            ThisElements(i).内容文本 = GetReplaceEleValue(ThisElements(i).要素名称, mlng病人ID, mlng挂号ID, 1, 0)
            bFinded = FindNextKey(edtEditor, 0, "E", ThisElements(i).Key, lKSS, lKSE, lKES, lKEE, bNeeded)
            ThisElements(i).Refresh edtEditor
        End If
        If ThisElements(i).替换域 = 1 And ThisElements(i).自动转文本 Then
            EleToString edtEditor, ThisElements(i)     '自动转化为纯文本（暂时不删除该要素）
        End If
    Next
    Set ThisElements = Nothing
End Function

Private Sub EleToString(ByRef edtThis As Object, Ele As cEPRElement)
    Dim sKeyType As String, lKSS As Long, lKSE As Long, lKES As Long, lKEE As Long, lKey As Long, bNeeded As Boolean, bBeteenKeys As Boolean
    Dim bForce As Boolean, strOldTag As String
    
    bBeteenKeys = FindNextKey(edtThis, 0, "E", Ele.Key, lKSS, lKSE, lKES, lKEE, bNeeded)
    If bBeteenKeys Then
        Dim lngLen As Long, str内容 As String
        str内容 = Ele.内容文本
        lngLen = Len(str内容)
        With edtThis
            .Freeze
            strOldTag = .Tag
            .Tag = "EleToString"
            bForce = .ForceEdit
            .ForceEdit = True
            .Range(lKSS, lKEE) = str内容
            .Range(lKSS, lKSS + lngLen).Font.Protected = False
            .Range(lKSS, lKSS + lngLen).Font.Hidden = False
            .Range(lKSS, lKSS + lngLen).Font.BackColor = tomAutoColor
            .Range(lKSS, lKSS + lngLen).Font.Underline = cprNone
            .ForceEdit = bForce
            .UnFreeze
            .Tag = strOldTag
        End With
    End If
End Sub

Private Function GetReplaceEleValue(ByVal ElementName As String, _
    ByVal sPatientID As String, _
    ByVal sPageID As String, _
    ByVal iPatientType As PatiFromEnum, _
    ByVal lng医嘱ID As Long) As String

    Dim rsTmp As ADODB.Recordset, strSQL As String
    
    strSQL = "Select Zl_Replace_Element_Value([1],[2],[3],[4],[5]) From Dual"
    err = 0: On Error GoTo DBError
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "读取替换项", ElementName, CLng(sPatientID), _
        CLng(sPageID), CLng(iPatientType), lng医嘱ID)
    If rsTmp.EOF Or rsTmp.BOF Then
        GetReplaceEleValue = ""
    Else
        GetReplaceEleValue = Trim(IIF(IsNull(rsTmp.Fields(0).value), "", rsTmp.Fields(0).value))
    End If
    Exit Function

DBError:
    If ErrCenter = 1 Then Resume
    SaveErrLog
End Function

Private Function FindOutLinePosition(ByRef edtThis As Object, ByVal strOName As String, ByRef lngS As Long, lngE As Long) As Boolean
'功能：根据指定的提纲名称，返回提纲内容文本的起止位置
    Dim blnFindedNext As Boolean, lngCur As Long
    Dim lKSS As Long, lKSE As Long, lKES As Long, lKEE As Long, bFinded As Boolean, bNeeded As Boolean
    Dim strTmp As String
    
    bFinded = True
    While bFinded
        bFinded = FindNextKey(edtThis, lngCur, "O", 0, lKSS, lKSE, lKES, lKEE, bNeeded)
        If bFinded Then
            strTmp = edtThis.Range(lKEE, lKEE + Len(strOName))
            If strOName = strTmp Then
                lngS = lKEE + Len(strOName)
                blnFindedNext = FindNextAnyKey(edtThis, lngS, strTmp, lKSS, lKSE, lKES, lKEE, 0, bNeeded)
                If blnFindedNext Then
                    lngE = lKSS
                Else
                    lngE = Len(edtThis.Text)
                End If
                Do While lngE > lngS + 1    '去掉尾部的回车或换行
                    If edtThis.Range(lngE - 1, lngE) = vbLf Or edtThis.Range(lngE - 1, lngE) = vbCr Then
                        lngE = lngE - 1
                    Else
                        Exit Do
                    End If
                Loop
                FindOutLinePosition = True
                Exit Function
            Else
                lngCur = lKEE
            End If
        End If
    Wend
End Function

Private Function zlFileZip(ByVal strFile As String) As String
    Dim strZipFile As String, lngCount As Long
    If strFile = "" Then Exit Function
    If Dir(strFile) = "" Then zlFileZip = "": Exit Function
    
    lngCount = 0
    Do While True
        strZipFile = Left(strFile, Len(strFile) - Len(Dir(strFile))) & "ZLZIP" & lngCount & ".ZIP"
        If Dir(strZipFile) = "" Then Exit Do
        lngCount = lngCount + 1
    Loop

    Set mclsZip = New zlRichEPR.cZip

    With mclsZip
        .Encrypt = False: .AddComment = False
        .ZipFile = strZipFile
        .StoreFolderNames = False
        .RecurseSubDirs = False
        .ClearFileSpecs
        .AddFileSpec strFile
        .Zip
        If (.Success) Then
            zlFileZip = .ZipFile
        Else
            zlFileZip = ""
        End If
    End With
    Set mclsZip = Nothing
End Function

Private Function zlFileUnzip(ByVal strZipFile As String) As String
    Dim objFSO As New Scripting.FileSystemObject    'FSO对象
    
    Dim strZipPath As String
    If strZipFile = "" Then Exit Function
    If Dir(strZipFile) = "" Then zlFileUnzip = "": Exit Function
    strZipPath = Left(strZipFile, Len(strZipFile) - Len(Dir(strZipFile)))
    If objFSO.FileExists(strZipPath & "TMP.RTF") Then objFSO.DeleteFile strZipPath & "TMP.RTF"
    
    Set mclsUnZip = New zlRichEPR.cUnzip
    With mclsUnZip
        .ZipFile = strZipFile
        .UnzipFolder = strZipPath
        .Unzip
    End With
    If Dir(strZipPath & "TMP.RTF") <> "" Then
        zlFileUnzip = strZipPath & "TMP.RTF"
    Else
        zlFileUnzip = ""
    End If
    Set mclsUnZip = Nothing
End Function

Private Function FindNextKey(ByRef edtThis As Object, _
    ByVal lngCurPosition As Long, _
    ByVal strKeyType As String, _
    ByRef lngKey As Long, _
    ByRef lngKSS As Long, _
    ByRef lngKSE As Long, _
    ByRef lngKES As Long, _
    ByRef lngKEE As Long, _
    ByRef blnNeeded As Boolean) As Boolean
        
    Dim i As Long, j As Long
    Dim sTMP As String
    Dim sText As String     '尽量少用.Text属性，因此用一个字符串变量来减少时间开支！
    
    sTMP = strKeyType & "S("
    With edtThis
        sText = .Text   '只读取.Text属性1次！！！
        i = IIF(lngCurPosition = 0, 1, lngCurPosition)
LL1:
        i = InStr(i, sText, sTMP)
        If i <> 0 Then
            '看是否是关键字
            If .TOM.TextDocument.Range(i - 1, i).Font.Hidden = False Then   '若为关键字，必须是隐藏且受保护的。
                i = i + 1
                GoTo LL1
            End If
            '已找到起始关键字
            
            '查找结束关键字
            j = i + 16
LL2:
            sTMP = strKeyType & "E("
            j = InStr(j, sText, sTMP)
            If j <> 0 Then
                '看是否是关键字
                If .TOM.TextDocument.Range(j - 1, j).Font.Hidden = False Then
                    j = j + 1
                    GoTo LL2
                End If
                '找到结束关键字
                strKeyType = strKeyType
                lngKSS = i - 1 '转换为0开始的坐标位置。
                lngKSE = i + 15
                lngKES = j - 1
                lngKEE = j + 15
                lngKey = Val(.Range(i + 2, i + 10))
                blnNeeded = -Val(.TOM.TextDocument.Range(i + 11, i + 12))
                FindNextKey = True
            End If
        End If
    End With
End Function

Private Function FindNextAnyKey(ByRef edtThis As Object, _
    ByRef lngCurPosition As Long, _
    ByRef strKeyType As String, _
    ByRef lngKSS As Long, _
    ByRef lngKSE As Long, _
    ByRef lngKES As Long, _
    ByRef lngKEE As Long, _
    ByRef lngKey As Long, _
    ByRef blnNeeded As Boolean) As Boolean
        
    Dim i As Long, j As Long
    Dim sTMP As String
    Dim sText As String     '尽量少用.Text属性，因此用一个字符串变量来减少时间开支！
    
    sTMP = "S("
    With edtThis
        sText = .Text   '只读取.Text属性1次！！！
        i = IIF(lngCurPosition = 0, 1, lngCurPosition)
LL1:
        i = InStr(i, sText, sTMP)
        If i <> 0 Then
            '看是否是关键字
            If .TOM.TextDocument.Range(i - 1, i).Font.Hidden = False Then   '若为关键字，必须是隐藏且受保护的。
                i = i + 1
                GoTo LL1
            End If
            '已找到起始关键字
            
            '查找结束关键字
            j = i + 16
LL2:
            sTMP = "E("
            j = InStr(j, sText, sTMP)
            If j <> 0 Then
                '看是否是关键字
                If .TOM.TextDocument.Range(j - 1, j).Font.Hidden = False Then
                    j = j + 1
                    GoTo LL2
                End If
                '找到结束关键字
                strKeyType = .TOM.TextDocument.Range(i - 2, i - 1)
                lngKSS = i - 2 '转换为0开始的坐标位置。
                lngKSE = i + 14
                lngKES = j - 2
                lngKEE = j + 14
                lngKey = Val(.TOM.TextDocument.Range(i + 1, i + 9))
                blnNeeded = -Val(.TOM.TextDocument.Range(i + 10, i + 11))
                FindNextAnyKey = True
            End If
        End If
    End With
End Function

Private Sub InitBaseInfo()
    Dim arrMainFileds() As Variant, arrSecdFileds() As Variant

    '首页标准改变，初始化记录集
    '1、主记录结构定义
    Set mrsMainInfo = New ADODB.Recordset
    With mrsMainInfo
        .Fields.Append "序号", adInteger, , adFldKeyColumn              '主键，标识信息
        .Fields.Append "信息名", adVarChar, 100, adFldKeyColumn   '信息名称
        '该记录集仅记录一个信息对应一个控件的情况或多个信息对应一个控件，其他情况不填写
        .Fields.Append "控件名", adVarChar, 100, adFldIsNullable      '展示信息的控件名称
        .Fields.Append "Index", adInteger, , adFldIsNullable                '为空时表示不是控件数组
        .Fields.Append "ExpState", adInteger                                        '信息扩展状态，0-不扩展，1-初始扩展，2-加载扩展
        .Fields.Append "页码", adInteger                                                '信息所在的页码
        .Fields.Append "信息原值", adVarChar, 2000, adFldIsNullable  '信息在首页加载时的值
        .Fields.Append "信息现值", adVarChar, 2000, adFldIsNullable  '信息在首页检查时的值
        .Fields.Append "ErrInfo", adVarChar, 4000, adFldIsNullable  '控件录入信息不合法提示信息，
        .Fields.Append "Edit", adInteger                                                 '0-可编辑,1-不可编辑，只用于展示,2-不可编辑不保存
        .Fields.Append "是否改变", adInteger                                          '信息是否有改变0-未改变，1-改变了
        .Fields.Append "来源", adInteger  '信息来至于那张表0－病人信息，1－病人信息从表,-1额外的表
        .CursorLocation = adUseClient
        .LockType = adLockOptimistic
        .CursorType = adOpenStatic
        .Open
    End With
    
    With mrsMainInfo
        arrMainFileds = Array("信息名", "控件名", "Index", "来源")
        .AddNew arrMainFileds, Array("主诉", "rtfEdit", txt主诉, -1)
        .AddNew arrMainFileds, Array("现病史", "rtfEdit", txt现病史, -1)
        .AddNew arrMainFileds, Array("过去史", "rtfEdit", txt过去史, -1)
        .AddNew arrMainFileds, Array("家族史", "rtfEdit", txt家族史, -1)
        .AddNew arrMainFileds, Array("查体", "rtfEdit", txt查体, -1)
    End With
     
End Sub

Private Function GetPlugInHot(ByRef rsIn As ADODB.Recordset) As String
'功能：获取外挂页签相关信息
    Dim strTmp As String, varItem As Variant
    Dim i As Long
    Dim strXML As String
    Dim varTmp1 As Variant
    
    On Error GoTo errH
    
    Call CreatePlugInOK(p门诊医嘱下达, mint场合)
    If Not gobjPlugIn Is Nothing Then
        If Not gobjPlugIn Is Nothing Then
            On Error Resume Next
            strTmp = gobjPlugIn.GetFuncNames(glngSys, p门诊医嘱下达, mint场合, strXML)
            Call zlPlugInErrH(err, "GetFuncNames")
            err.Clear: On Error GoTo 0
        End If
    End If
    
    If InStr(strXML, "<hotkey>") > 0 Then
        Set rsIn = New ADODB.Recordset
        With rsIn
            .Fields.Append "功能名", adVarChar, 1000
            .Fields.Append "KeyCode", adInteger '对应于窗体的KeyDown事件的两个参数
            .Fields.Append "Shift", adInteger
            .CursorLocation = adUseClient
            .LockType = adLockOptimistic
            .CursorType = adOpenStatic
            .Open
        End With
        varItem = Split(strXML, "<hotkey>")
        For i = 0 To UBound(varItem)
            If InStr(varItem(i), "</hotkey>") > 0 Then
                strTmp = Split(varItem(i), "</hotkey>")(0)
                varTmp1 = Split(strTmp, "|")
                rsIn.AddNew
                rsIn!功能名 = varTmp1(0)
                rsIn!KeyCode = Val(varTmp1(1))
                rsIn!Shift = Val(varTmp1(2))
                rsIn.Update
            End If
        Next
    End If
    Exit Function
errH:
    err.Clear
End Function

Private Sub dkpMain_Resize()
    Call Form_Resize
End Sub

Private Sub cmdUpdate_Click()
'功能：病历全文编辑
    Dim blnDoc As Boolean
    Dim lngEPRFileID As Long
    Dim lngFileID As Long
    Dim strDoctor As String
    Dim strIn As String

    lngEPRFileID = mlng病历文件id
    lngFileID = mlng病历id
    strDoctor = mstr保存人
    strIn = lblDoctor(1).Tag
    
    If InStr(";" & GetPrivFunc(glngSys, p门诊病历管理) & ";", ";病历书写;") > 0 Then
        blnDoc = (lngFileID = 0 And lngEPRFileID <> 0 Or lngFileID <> 0)
        If blnDoc And lngFileID <> 0 And strIn = "0" Then  '没有修改他人病历的权限
            blnDoc = strDoctor = UserInfo.姓名
        End If
        
        If blnDoc Then
            If mobjEPRDoc Is Nothing Then
                Set mobjEPRDoc = New zlRichEPR.cEPRDocument
            End If
            If lngFileID = 0 And lngEPRFileID <> 0 Then '如果没有新建则新建
                Call mobjEPRDoc.InitEPRDoc(0, 2, lngEPRFileID, 1, mlng病人ID, mlng挂号ID, , mlng病人科室id, , False)
            Else
                Call mobjEPRDoc.InitEPRDoc(1, 2, lngFileID, 1, mlng病人ID, mlng挂号ID, , mlng病人科室id, , False)
            End If
            Call mobjEPRDoc.ShowEPREditor(Me)
        Else
            MsgBox "当前病历不能修改。", vbInformation, Me.Caption
        End If
    Else
        MsgBox "您没有病历书写的权限。", vbInformation, Me.Caption
    End If
End Sub

Private Sub mobjEPRDoc_AfterSaved(lngRecordId As Long)
    Call LoadDocData
End Sub

Private Sub rtfEdit_MouseMove(Index As Integer, Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim strTmp As String
    mrsMainInfo.Filter = "控件名='rtfEdit' and Index=" & Index
    strTmp = mrsMainInfo!ErrInfo & ""
    Call zlCommFun.ShowTipInfo(rtfEdit(Index).hwnd, strTmp, True, True)
End Sub

Private Sub MsgDis(str疾病IDs As String, str诊断IDs As String)
    Dim rsTmp As ADODB.Recordset
    Dim i As Long, strSQL As String
    On Error GoTo ErrHand
    '判断当前病人是否填写传染病报告卡
    strSQL = "Select 文件ID From 电子病历记录 Where 病人ID=[1] And 主页ID=[2] And 病历种类=5 and 创建人=[3]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "MsgDis", mlng病人ID, mlng挂号ID, UserInfo.姓名)
    If rsTmp.RecordCount > 0 Then
        '判断用户是否修改或删除诊断
        strSQL = ""
        If str疾病IDs <> "" Then
            strSQL = " Union Select 疾病id,诊断id From 疾病报告前提 Where 疾病ID IN (Select Column_Value From Table(f_Num2list([3])))"
        End If
        If str诊断IDs <> "" Then
            strSQL = strSQL & " Union Select 疾病id,诊断id From 疾病报告前提 Where 诊断ID IN (Select Column_Value From Table(f_Num2list([4])))"
        End If
        strSQL = "Select a.疾病id, a.诊断id From 病人诊断记录 A, 疾病报告前提 B Where a.病人id = [1] And a.主页id = [2] And a.编码序号 = 1 And (a.疾病id = b.疾病id Or a.诊断id = b.诊断id) " & IIF(strSQL = "", "", "Minus (" & Mid(strSQL, 8) & ") ")
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "MsgDis", mlng病人ID, mlng挂号ID, str疾病IDs, str诊断IDs)
        If rsTmp.RecordCount > 0 Then
            MsgBox "当前病人传染病诊断数据发生了改变,请修改传染病报告卡！", vbInformation, gstrSysName
        End If
    End If
    Exit Sub
ErrHand:
    If ErrCenter = 1 Then
        Resume
    End If
    SaveErrLog
End Sub

Private Function IsNewDrug() As Boolean
'功能:是否存在新增或修改的药品医嘱
    Dim i As Long
    Dim blnHvae As Boolean
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If .RowData(i) <> 0 Then
                If InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 And InStr(",1,2,", "," & .TextMatrix(i, COL_EDIT) & ",") > 0 Then
                    blnHvae = True
                    Exit For
                End If
            End If
        Next
    End With
    IsNewDrug = blnHvae
End Function


