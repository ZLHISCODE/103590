VERSION 5.00
Object = "{BEEECC20-4D5F-4F8B-BFDC-5D9B6FBDE09D}#1.0#0"; "vsflex8.ocx"
Object = "{555E8FCC-830E-45CC-AF00-A012D5AE7451}#9.60#0"; "Codejock.CommandBars.9600.ocx"
Object = "{A8E5842E-102B-4289-9D57-3B3F5B5E15D3}#9.60#0"; "Codejock.SuiteCtrls.9600.ocx"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.1#0"; "MSCOMCTL.OCX"
Object = "{86CF1D34-0C5F-11D2-A9FC-0000F8754DA1}#2.0#0"; "MSCOMCT2.OCX"
Object = "{C932BA88-4374-101B-A56C-00AA003668DC}#1.1#0"; "Msmask32.ocx"
Begin VB.Form frmInAdviceEdit 
   AutoRedraw      =   -1  'True
   Caption         =   "住院医嘱编辑"
   ClientHeight    =   8475
   ClientLeft      =   225
   ClientTop       =   555
   ClientWidth     =   13140
   Icon            =   "frmInAdviceEdit.frx":0000
   KeyPreview      =   -1  'True
   LinkTopic       =   "Form1"
   ScaleHeight     =   8475
   ScaleWidth      =   13140
   ShowInTaskbar   =   0   'False
   StartUpPosition =   3  '窗口缺省
   WindowState     =   2  'Maximized
   Begin XtremeSuiteControls.TabControl tbcSub 
      Height          =   990
      Left            =   12240
      TabIndex        =   108
      Top             =   780
      Width           =   195
      _Version        =   589884
      _ExtentX        =   344
      _ExtentY        =   1746
      _StockProps     =   64
   End
   Begin VB.PictureBox picSub 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   9000
      Left            =   0
      ScaleHeight     =   9000
      ScaleWidth      =   11505
      TabIndex        =   109
      TabStop         =   0   'False
      Top             =   0
      Width           =   11505
      Begin VB.Frame fraColSel 
         Appearance      =   0  'Flat
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   195
         Left            =   1755
         TabIndex        =   111
         Top             =   225
         Width           =   195
         Begin VB.Image imgColSel 
            Height          =   195
            Left            =   0
            Picture         =   "frmInAdviceEdit.frx":058A
            ToolTipText     =   "选择需要显示的列(ALT+C)"
            Top             =   0
            Width           =   195
         End
      End
      Begin VSFlex8Ctl.VSFlexGrid vsColumn 
         Height          =   3270
         Left            =   2160
         TabIndex        =   110
         Top             =   210
         Visible         =   0   'False
         Width           =   1470
         _cx             =   2593
         _cy             =   5768
         Appearance      =   0
         BorderStyle     =   1
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   8421504
         ForeColorFixed  =   16777215
         BackColorSel    =   14737632
         ForeColorSel    =   -2147483640
         BackColorBkg    =   -2147483643
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483636
         GridColorFixed  =   -2147483636
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483643
         FocusRect       =   0
         HighLight       =   1
         AllowSelection  =   0   'False
         AllowBigSelection=   -1  'True
         AllowUserResizing=   0
         SelectionMode   =   1
         GridLines       =   0
         GridLinesFixed  =   0
         GridLineWidth   =   1
         Rows            =   2
         Cols            =   2
         FixedRows       =   1
         FixedCols       =   0
         RowHeightMin    =   250
         RowHeightMax    =   0
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   -1  'True
         FormatString    =   $"frmInAdviceEdit.frx":0AD8
         ScrollTrack     =   -1  'True
         ScrollBars      =   2
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   -1  'True
         AutoSizeMode    =   0
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   0
         Editable        =   2
         ShowComboButton =   1
         WordWrap        =   0   'False
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         DataMode        =   0
         VirtualData     =   -1  'True
         DataMember      =   ""
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   24
      End
      Begin MSComCtl2.MonthView dtpDate 
         Height          =   2220
         Left            =   4995
         TabIndex        =   3
         Top             =   3015
         Visible         =   0   'False
         Width           =   2805
         _ExtentX        =   4948
         _ExtentY        =   3916
         _Version        =   393216
         ForeColor       =   -2147483630
         BackColor       =   -2147483633
         Appearance      =   1
         StartOfWeek     =   175702017
         TitleBackColor  =   -2147483636
         TitleForeColor  =   -2147483634
         TrailingForeColor=   -2147483637
         CurrentDate     =   37904
      End
      Begin VB.PictureBox pic疑问 
         Appearance      =   0  'Flat
         AutoRedraw      =   -1  'True
         BorderStyle     =   0  'None
         Enabled         =   0   'False
         ForeColor       =   &H80000008&
         Height          =   270
         Left            =   60
         ScaleHeight     =   270
         ScaleWidth      =   11070
         TabIndex        =   86
         TabStop         =   0   'False
         Top             =   4785
         Visible         =   0   'False
         Width           =   11070
         Begin VB.Image Image1 
            Height          =   240
            Left            =   150
            Picture         =   "frmInAdviceEdit.frx":0B26
            Top             =   0
            Width           =   240
         End
         Begin VB.Label lbl疑问 
            BackColor       =   &H00C0C0FF&
            BackStyle       =   0  'Transparent
            ForeColor       =   &H000000C0&
            Height          =   180
            Left            =   495
            TabIndex        =   87
            Top             =   45
            Width           =   1725
         End
      End
      Begin MSComctlLib.ListView lvwPati 
         Height          =   2655
         Left            =   120
         TabIndex        =   41
         Top             =   960
         Visible         =   0   'False
         Width           =   10740
         _ExtentX        =   18944
         _ExtentY        =   4683
         View            =   3
         Arrange         =   2
         LabelEdit       =   1
         LabelWrap       =   -1  'True
         HideSelection   =   0   'False
         AllowReorder    =   -1  'True
         FullRowSelect   =   -1  'True
         GridLines       =   -1  'True
         _Version        =   393217
         Icons           =   "img32"
         ForeColor       =   -2147483640
         BackColor       =   -2147483643
         Appearance      =   1
         NumItems        =   17
         BeginProperty ColumnHeader(1) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            Key             =   "_病人"
            Text            =   "病人"
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(2) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   1
            Key             =   "_住院号"
            Text            =   "住院号"
            Object.Width           =   2117
         EndProperty
         BeginProperty ColumnHeader(3) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   2
            Key             =   "_床号"
            Text            =   "床号"
            Object.Width           =   1111
         EndProperty
         BeginProperty ColumnHeader(4) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   3
            Key             =   "_住院医师"
            Text            =   "住院医师"
            Object.Width           =   1764
         EndProperty
         BeginProperty ColumnHeader(5) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   4
            Key             =   "_性别"
            Text            =   "性别"
            Object.Width           =   1058
         EndProperty
         BeginProperty ColumnHeader(6) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   5
            Key             =   "_年龄"
            Text            =   "年龄"
            Object.Width           =   1058
         EndProperty
         BeginProperty ColumnHeader(7) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   6
            Key             =   "_费别"
            Text            =   "费别"
            Object.Width           =   1499
         EndProperty
         BeginProperty ColumnHeader(8) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   7
            Key             =   "_护理等级"
            Text            =   "护理等级"
            Object.Width           =   2028
         EndProperty
         BeginProperty ColumnHeader(9) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   8
            Key             =   $"frmInAdviceEdit.frx":10B0
            Text            =   $"frmInAdviceEdit.frx":10BE
            Object.Width           =   2857
         EndProperty
         BeginProperty ColumnHeader(10) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   9
            Key             =   "_出院日期"
            Text            =   "出院日期"
            Object.Width           =   2857
         EndProperty
         BeginProperty ColumnHeader(11) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   10
            Key             =   "_付款方式"
            Text            =   "付款方式"
            Object.Width           =   2646
         EndProperty
         BeginProperty ColumnHeader(12) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   11
            Key             =   "_病人类型"
            Text            =   "病人类型"
            Object.Width           =   2540
         EndProperty
         BeginProperty ColumnHeader(13) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   12
            Key             =   "_病人性质"
            Text            =   "病人性质"
            Object.Width           =   2540
         EndProperty
         BeginProperty ColumnHeader(14) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   13
            Key             =   "_体重"
            Text            =   "体重"
            Object.Width           =   1499
         EndProperty
         BeginProperty ColumnHeader(15) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   14
            Text            =   "留观号"
            Object.Width           =   2117
         EndProperty
         BeginProperty ColumnHeader(16) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   15
            Text            =   "婴儿科室ID"
            Object.Width           =   0
         EndProperty
         BeginProperty ColumnHeader(17) {BDD1F052-858B-11D1-B16A-00C0F0283628} 
            SubItemIndex    =   16
            Text            =   "婴儿病区ID"
            Object.Width           =   0
         EndProperty
      End
      Begin MSComctlLib.StatusBar stbThis 
         Height          =   360
         Left            =   0
         TabIndex        =   64
         Top             =   8115
         Width           =   13140
         _ExtentX        =   23178
         _ExtentY        =   635
         _Version        =   393216
         BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
            NumPanels       =   7
            BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Bevel           =   2
               Object.Width           =   2355
               MinWidth        =   882
               Picture         =   "frmInAdviceEdit.frx":10CB
               Text            =   "中联软件"
               TextSave        =   "中联软件"
               Key             =   "ZLFLAG"
               Object.ToolTipText     =   "欢迎使用中联有限公司软件"
            EndProperty
            BeginProperty Panel2 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   1
               Object.Width           =   17806
            EndProperty
            BeginProperty Panel3 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Object.Width           =   318
               MinWidth        =   2
            EndProperty
            BeginProperty Panel4 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Object.Width           =   318
               MinWidth        =   25
            EndProperty
            BeginProperty Panel5 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Object.Width           =   617
               MinWidth        =   617
               Picture         =   "frmInAdviceEdit.frx":195F
               Key             =   "PY"
               Object.ToolTipText     =   "拼音(F7)"
            EndProperty
            BeginProperty Panel6 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Bevel           =   2
               Object.Width           =   617
               MinWidth        =   617
               Picture         =   "frmInAdviceEdit.frx":1F99
               Key             =   "WB"
               Object.ToolTipText     =   "五笔(F7)"
            EndProperty
            BeginProperty Panel7 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Alignment       =   1
               AutoSize        =   2
               Bevel           =   0
               Object.Width           =   953
               MinWidth        =   26
               Text            =   "计价"
               TextSave        =   "计价"
               Key             =   "Price"
               Object.ToolTipText     =   "显示计价面板(F8)"
            EndProperty
         EndProperty
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin VB.Frame fraPati 
         Appearance      =   0  'Flat
         BackColor       =   &H00C0E0FF&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   450
         Left            =   0
         TabIndex        =   48
         Top             =   510
         Width           =   11025
         Begin VB.CommandButton cmdAlley 
            Caption         =   "过敏史/病生状态"
            Height          =   350
            Left            =   9480
            TabIndex        =   47
            TabStop         =   0   'False
            Top             =   0
            Visible         =   0   'False
            Width           =   1530
         End
         Begin VB.CommandButton cmdPati 
            Height          =   240
            Left            =   1620
            Picture         =   "frmInAdviceEdit.frx":25D3
            Style           =   1  'Graphical
            TabIndex        =   44
            TabStop         =   0   'False
            ToolTipText     =   "选择病人(F4)"
            Top             =   105
            Width           =   255
         End
         Begin VB.ComboBox cbo婴儿 
            Height          =   300
            ItemData        =   "frmInAdviceEdit.frx":26C9
            Left            =   9570
            List            =   "frmInAdviceEdit.frx":26D0
            Style           =   2  'Dropdown List
            TabIndex        =   46
            TabStop         =   0   'False
            Top             =   75
            Width           =   1395
         End
         Begin VB.TextBox txtPati 
            Height          =   300
            Left            =   570
            TabIndex        =   43
            TabStop         =   0   'False
            Top             =   75
            Width           =   1335
         End
         Begin VB.Frame fraInfo 
            Appearance      =   0  'Flat
            BorderStyle     =   0  'None
            ForeColor       =   &H80000008&
            Height          =   270
            Left            =   1935
            TabIndex        =   70
            Top             =   90
            Width           =   8865
            Begin VB.Label lblCaption 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "体重:"
               Height          =   180
               Index           =   8
               Left            =   8040
               TabIndex        =   94
               Top             =   45
               Width           =   450
            End
            Begin VB.Label lblText 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "内容"
               Height          =   180
               Index           =   8
               Left            =   8490
               TabIndex        =   93
               Top             =   45
               Width           =   360
            End
            Begin VB.Label lblCaption 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "付款方式:"
               Height          =   180
               Index           =   7
               Left            =   6750
               TabIndex        =   89
               Top             =   45
               Width           =   810
            End
            Begin VB.Label lblText 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "内容"
               Height          =   180
               Index           =   7
               Left            =   7545
               TabIndex        =   88
               Top             =   45
               Width           =   360
            End
            Begin VB.Label lblText 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "内容"
               Height          =   180
               Index           =   6
               Left            =   6300
               TabIndex        =   84
               Top             =   45
               Width           =   360
            End
            Begin VB.Label lblCaption 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "类型:"
               Height          =   180
               Index           =   6
               Left            =   5820
               TabIndex        =   83
               Top             =   45
               Width           =   450
            End
            Begin VB.Label lblText 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "内容"
               Height          =   180
               Index           =   5
               Left            =   5325
               TabIndex        =   82
               Top             =   45
               Width           =   360
            End
            Begin VB.Label lblCaption 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "费别:"
               Height          =   180
               Index           =   5
               Left            =   4875
               TabIndex        =   81
               Top             =   45
               Width           =   450
            End
            Begin VB.Label lblText 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "内容"
               Height          =   180
               Index           =   4
               Left            =   4380
               TabIndex        =   80
               Top             =   45
               Width           =   360
            End
            Begin VB.Label lblCaption 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "年龄:"
               Height          =   180
               Index           =   4
               Left            =   3930
               TabIndex        =   79
               Top             =   45
               Width           =   450
            End
            Begin VB.Label lblText 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "内容"
               Height          =   180
               Index           =   3
               Left            =   3405
               TabIndex        =   78
               Top             =   45
               Width           =   360
            End
            Begin VB.Label lblCaption 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "性别:"
               Height          =   180
               Index           =   3
               Left            =   2955
               TabIndex        =   77
               Top             =   45
               Width           =   450
            End
            Begin VB.Label lblText 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "内容"
               Height          =   180
               Index           =   2
               Left            =   2505
               TabIndex        =   76
               Top             =   45
               Width           =   360
            End
            Begin VB.Label lblCaption 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "科室:"
               Height          =   180
               Index           =   2
               Left            =   2070
               TabIndex        =   75
               Top             =   45
               Width           =   450
            End
            Begin VB.Label lblText 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "内容"
               Height          =   180
               Index           =   1
               Left            =   1620
               TabIndex        =   74
               Top             =   45
               Width           =   360
            End
            Begin VB.Label lblCaption 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "住院号:"
               Height          =   180
               Index           =   1
               Left            =   1005
               TabIndex        =   73
               Top             =   45
               Width           =   630
            End
            Begin VB.Label lblText 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "内容"
               BeginProperty Font 
                  Name            =   "宋体"
                  Size            =   9
                  Charset         =   134
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   180
               Index           =   0
               Left            =   510
               TabIndex        =   72
               Top             =   45
               Width           =   390
            End
            Begin VB.Label lblCaption 
               AutoSize        =   -1  'True
               BackStyle       =   0  'Transparent
               Caption         =   "床号:"
               BeginProperty Font 
                  Name            =   "宋体"
                  Size            =   9
                  Charset         =   134
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   180
               Index           =   0
               Left            =   60
               TabIndex        =   71
               Top             =   45
               Width           =   495
            End
         End
         Begin VB.Label lbl婴儿 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "婴儿"
            Height          =   180
            Left            =   9150
            TabIndex        =   45
            Top             =   135
            Width           =   360
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "病人"
            Height          =   180
            Left            =   135
            TabIndex        =   42
            Top             =   135
            Width           =   360
         End
      End
      Begin VSFlex8Ctl.VSFlexGrid vsAdvice 
         Height          =   3795
         Left            =   60
         TabIndex        =   0
         Top             =   960
         Width           =   10965
         _cx             =   19341
         _cy             =   6694
         Appearance      =   1
         BorderStyle     =   1
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "宋体"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   16764057
         ForeColorSel    =   0
         BackColorBkg    =   -2147483643
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483636
         GridColorFixed  =   -2147483636
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483643
         FocusRect       =   2
         HighLight       =   1
         AllowSelection  =   0   'False
         AllowBigSelection=   0   'False
         AllowUserResizing=   1
         SelectionMode   =   1
         GridLines       =   1
         GridLinesFixed  =   1
         GridLineWidth   =   1
         Rows            =   18
         Cols            =   11
         FixedRows       =   1
         FixedCols       =   1
         RowHeightMin    =   250
         RowHeightMax    =   2000
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   0   'False
         FormatString    =   $"frmInAdviceEdit.frx":26DE
         ScrollTrack     =   -1  'True
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   0   'False
         AutoSizeMode    =   1
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   1
         Editable        =   0
         ShowComboButton =   1
         WordWrap        =   -1  'True
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         DataMode        =   0
         VirtualData     =   -1  'True
         DataMember      =   ""
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   24
         Begin VB.PictureBox pictmp 
            Appearance      =   0  'Flat
            AutoRedraw      =   -1  'True
            BackColor       =   &H80000005&
            BorderStyle     =   0  'None
            ForeColor       =   &H80000008&
            Height          =   240
            Left            =   0
            ScaleHeight     =   240
            ScaleWidth      =   480
            TabIndex        =   103
            Top             =   0
            Visible         =   0   'False
            Width           =   480
         End
      End
      Begin VB.Frame fraAdvice 
         Height          =   3120
         Left            =   45
         TabIndex        =   49
         Top             =   4995
         Width           =   11010
         Begin VB.ComboBox cboDruPur 
            Height          =   300
            Left            =   960
            Style           =   2  'Dropdown List
            TabIndex        =   23
            Top             =   2715
            Width           =   1935
         End
         Begin VB.CommandButton cmdComExcReason 
            Height          =   300
            Left            =   10560
            Picture         =   "frmInAdviceEdit.frx":27C6
            Style           =   1  'Graphical
            TabIndex        =   107
            TabStop         =   0   'False
            ToolTipText     =   "将当前说明设置为常用说明。"
            Top             =   2400
            Width           =   315
         End
         Begin VB.CommandButton cmdExcReason 
            Caption         =   "…"
            Height          =   265
            Left            =   10200
            TabIndex        =   106
            TabStop         =   0   'False
            Top             =   2385
            Width           =   285
         End
         Begin VB.CommandButton cmd输血原因 
            Height          =   240
            Left            =   10560
            Picture         =   "frmInAdviceEdit.frx":2D50
            Style           =   1  'Graphical
            TabIndex        =   105
            TabStop         =   0   'False
            ToolTipText     =   "选择日期(F4)"
            Top             =   2760
            Visible         =   0   'False
            Width           =   255
         End
         Begin VB.CommandButton cmdZYRemark 
            Caption         =   "…"
            Height          =   265
            Left            =   10560
            TabIndex        =   104
            TabStop         =   0   'False
            Top             =   2373
            Visible         =   0   'False
            Width           =   285
         End
         Begin VB.TextBox txt超量说明 
            BackColor       =   &H8000000F&
            Enabled         =   0   'False
            Height          =   300
            Left            =   4800
            MaxLength       =   500
            TabIndex        =   24
            Top             =   2280
            Width           =   5650
         End
         Begin VB.ComboBox cbo手术情况 
            Height          =   300
            Left            =   3480
            Style           =   2  'Dropdown List
            TabIndex        =   14
            Top             =   1680
            Width           =   1665
         End
         Begin VB.TextBox txt首次用量 
            Alignment       =   1  'Right Justify
            Height          =   300
            Left            =   960
            MaxLength       =   10
            TabIndex        =   20
            Top             =   2355
            Width           =   1515
         End
         Begin VB.CommandButton cmd医生嘱托 
            Caption         =   "…"
            Height          =   265
            Left            =   10200
            TabIndex        =   100
            TabStop         =   0   'False
            Top             =   573
            Width           =   285
         End
         Begin VB.TextBox cbo医生嘱托 
            Height          =   300
            Left            =   6255
            MaxLength       =   100
            TabIndex        =   28
            Top             =   555
            Width           =   4260
         End
         Begin VB.CommandButton cmd收藏用药理由 
            Height          =   300
            Left            =   10530
            Picture         =   "frmInAdviceEdit.frx":2E46
            Style           =   1  'Graphical
            TabIndex        =   99
            TabStop         =   0   'False
            ToolTipText     =   "将当前嘱托设置为常用嘱托(Ctrl+D)"
            Top             =   2730
            Width           =   315
         End
         Begin VB.CommandButton cmdReason 
            Caption         =   "…"
            Height          =   265
            Left            =   10200
            TabIndex        =   98
            TabStop         =   0   'False
            Top             =   2748
            Width           =   285
         End
         Begin VB.PictureBox picHelp 
            Appearance      =   0  'Flat
            BorderStyle     =   0  'None
            ForeColor       =   &H80000008&
            Height          =   255
            Left            =   5200
            Picture         =   "frmInAdviceEdit.frx":33D0
            ScaleHeight     =   255
            ScaleWidth      =   255
            TabIndex        =   97
            Top             =   960
            Visible         =   0   'False
            Width           =   255
         End
         Begin VB.TextBox txt用药理由 
            Height          =   300
            Left            =   4800
            MaxLength       =   100
            TabIndex        =   25
            Top             =   2640
            Width           =   5660
         End
         Begin VB.CheckBox chkStop 
            Caption         =   "停止所有长嘱(&T)"
            Height          =   225
            Left            =   7500
            TabIndex        =   27
            TabStop         =   0   'False
            Top             =   240
            Width           =   1650
         End
         Begin VB.ComboBox cbo执行时间 
            Height          =   300
            Left            =   6255
            TabIndex        =   31
            Top             =   915
            Width           =   4590
         End
         Begin VB.TextBox txt首日时间 
            Height          =   300
            Left            =   9045
            MaxLength       =   50
            TabIndex        =   32
            Top             =   915
            Visible         =   0   'False
            Width           =   1800
         End
         Begin VB.CommandButton cmd安排时间 
            Height          =   240
            Left            =   2400
            Picture         =   "frmInAdviceEdit.frx":395A
            Style           =   1  'Graphical
            TabIndex        =   10
            TabStop         =   0   'False
            ToolTipText     =   "选择日期(F4)"
            Top             =   1680
            Visible         =   0   'False
            Width           =   255
         End
         Begin VB.TextBox txt安排时间 
            Height          =   300
            Left            =   960
            TabIndex        =   9
            Top             =   1680
            Visible         =   0   'False
            Width           =   1800
         End
         Begin VB.CommandButton cmd常用嘱托 
            Height          =   300
            Left            =   10560
            Picture         =   "frmInAdviceEdit.frx":3A50
            Style           =   1  'Graphical
            TabIndex        =   30
            TabStop         =   0   'False
            ToolTipText     =   "将当前嘱托设置为常用嘱托(Ctrl+D)"
            Top             =   480
            Width           =   315
         End
         Begin MSComctlLib.Toolbar tbrFree 
            Height          =   330
            Left            =   300
            TabIndex        =   69
            Top             =   810
            Width           =   480
            _ExtentX        =   847
            _ExtentY        =   582
            ButtonWidth     =   609
            ButtonHeight    =   582
            AllowCustomize  =   0   'False
            Wrappable       =   0   'False
            Style           =   1
            _Version        =   393216
            BeginProperty Buttons {66833FE8-8583-11D1-B16A-00C0F0283628} 
               NumButtons      =   1
               BeginProperty Button1 {66833FEA-8583-11D1-B16A-00C0F0283628} 
                  Object.ToolTipText     =   "自由录入医嘱(F3)"
                  ImageIndex      =   1
                  Style           =   1
               EndProperty
            EndProperty
         End
         Begin VB.ComboBox cbo附加执行 
            Height          =   300
            Left            =   6255
            TabIndex        =   35
            Text            =   "cbo附加执行"
            Top             =   1635
            Width           =   1965
         End
         Begin VB.TextBox txt天数 
            Alignment       =   2  'Center
            Height          =   300
            Left            =   2400
            MaxLength       =   3
            TabIndex        =   17
            Top             =   1995
            Visible         =   0   'False
            Width           =   360
         End
         Begin VB.CommandButton cmd频率 
            Height          =   240
            Left            =   4860
            Picture         =   "frmInAdviceEdit.frx":3FDA
            Style           =   1  'Graphical
            TabIndex        =   15
            TabStop         =   0   'False
            ToolTipText     =   "选择项目(F4)"
            Top             =   1665
            Width           =   270
         End
         Begin VB.TextBox txt频率 
            Height          =   300
            Left            =   3480
            TabIndex        =   13
            Top             =   1635
            Width           =   1665
         End
         Begin VB.TextBox txt单量 
            Alignment       =   1  'Right Justify
            Height          =   300
            Left            =   3495
            MaxLength       =   10
            TabIndex        =   18
            Top             =   1995
            Width           =   1380
         End
         Begin VB.TextBox txt总量 
            Alignment       =   1  'Right Justify
            Height          =   300
            Left            =   930
            MaxLength       =   10
            TabIndex        =   16
            Top             =   1995
            Width           =   1515
         End
         Begin VB.CommandButton cmd用法 
            Height          =   240
            Left            =   2445
            Picture         =   "frmInAdviceEdit.frx":40D0
            Style           =   1  'Graphical
            TabIndex        =   12
            TabStop         =   0   'False
            ToolTipText     =   "选择项目(F4)"
            Top             =   1665
            Width           =   270
         End
         Begin VB.TextBox txt用法 
            Height          =   300
            Left            =   930
            TabIndex        =   11
            Top             =   1635
            Width           =   1815
         End
         Begin VB.CommandButton cmd开嘱时间 
            Height          =   240
            Left            =   10560
            Picture         =   "frmInAdviceEdit.frx":41C6
            Style           =   1  'Graphical
            TabIndex        =   40
            TabStop         =   0   'False
            ToolTipText     =   "选择日期(F4)"
            Top             =   2025
            Width           =   255
         End
         Begin VB.ComboBox cbo期效 
            Height          =   300
            ItemData        =   "frmInAdviceEdit.frx":42BC
            Left            =   930
            List            =   "frmInAdviceEdit.frx":42C6
            Style           =   2  'Dropdown List
            TabIndex        =   1
            Top             =   195
            Width           =   1005
         End
         Begin VB.CommandButton cmd终止时间 
            Height          =   240
            Left            =   10560
            Picture         =   "frmInAdviceEdit.frx":42DA
            Style           =   1  'Graphical
            TabIndex        =   37
            TabStop         =   0   'False
            ToolTipText     =   "选择日期(F4)"
            Top             =   1665
            Width           =   255
         End
         Begin VB.CommandButton cmd开始时间 
            Height          =   240
            Left            =   4590
            Picture         =   "frmInAdviceEdit.frx":43D0
            Style           =   1  'Graphical
            TabIndex        =   4
            TabStop         =   0   'False
            ToolTipText     =   "选择日期(F4)"
            Top             =   225
            Width           =   255
         End
         Begin VB.CheckBox chk紧急 
            Caption         =   "紧急医嘱(&E)"
            Height          =   225
            Left            =   9195
            TabIndex        =   29
            TabStop         =   0   'False
            Top             =   233
            Width           =   1290
         End
         Begin VB.CommandButton cmdExt 
            Height          =   285
            Left            =   4890
            Picture         =   "frmInAdviceEdit.frx":44C6
            Style           =   1  'Graphical
            TabIndex        =   6
            TabStop         =   0   'False
            ToolTipText     =   "编辑(F4)"
            Top             =   555
            Width           =   285
         End
         Begin VB.CommandButton cmdSel 
            Caption         =   "…"
            Height          =   285
            Left            =   4890
            TabIndex        =   7
            TabStop         =   0   'False
            ToolTipText     =   "选择项目(*)"
            Top             =   870
            Width           =   285
         End
         Begin VB.ComboBox cbo执行科室 
            Height          =   300
            Left            =   6255
            TabIndex        =   33
            Text            =   "cbo执行科室"
            Top             =   1275
            Width           =   1965
         End
         Begin VB.TextBox txt终止时间 
            Height          =   300
            Left            =   9045
            TabIndex        =   36
            Top             =   1635
            Width           =   1800
         End
         Begin VB.ComboBox cbo医生 
            Height          =   300
            Left            =   6255
            TabIndex        =   38
            Top             =   1995
            Width           =   1965
         End
         Begin VB.TextBox txt开嘱时间 
            Height          =   300
            Left            =   9045
            TabIndex        =   39
            Top             =   1995
            Width           =   1800
         End
         Begin VB.ComboBox cbo执行性质 
            Height          =   300
            ItemData        =   "frmInAdviceEdit.frx":45BC
            Left            =   9045
            List            =   "frmInAdviceEdit.frx":45CC
            Style           =   2  'Dropdown List
            TabIndex        =   34
            Top             =   1275
            Width           =   1800
         End
         Begin VB.ComboBox cbo分零 
            Height          =   300
            Left            =   930
            Style           =   2  'Dropdown List
            TabIndex        =   8
            Top             =   1275
            Visible         =   0   'False
            Width           =   4230
         End
         Begin VB.ComboBox cbo滴速 
            Height          =   300
            Left            =   6255
            TabIndex        =   26
            Top             =   195
            Visible         =   0   'False
            Width           =   1050
         End
         Begin VB.TextBox txt医嘱内容 
            Height          =   1020
            Left            =   930
            MaxLength       =   1000
            MultiLine       =   -1  'True
            TabIndex        =   5
            ToolTipText     =   "按 ~ 键显示成套方案选择器,Ctrl+F1调用医保信息"
            Top             =   555
            Width           =   3945
         End
         Begin MSMask.MaskEdBox msk开始时间 
            Height          =   300
            Left            =   3075
            TabIndex        =   2
            Top             =   195
            Width           =   1800
            _ExtentX        =   3175
            _ExtentY        =   529
            _Version        =   393216
            MaxLength       =   16
            Mask            =   "####-##-## ##:##"
            PromptChar      =   "_"
         End
         Begin VB.Label lbl手术情况 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "手术情况"
            Height          =   180
            Left            =   2760
            TabIndex        =   102
            Top             =   1680
            Width           =   720
         End
         Begin VB.Label lbl安排时间 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "安排时间"
            Height          =   180
            Left            =   180
            TabIndex        =   101
            Top             =   1680
            Visible         =   0   'False
            Width           =   720
         End
         Begin VB.Label lbl首次用量 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            BackColor       =   &H80000005&
            BackStyle       =   0  'Transparent
            Caption         =   "首次用量"
            ForeColor       =   &H80000008&
            Height          =   180
            Left            =   180
            TabIndex        =   19
            ToolTipText     =   "常用剂量比例(Ctrl+~)"
            Top             =   2415
            Width           =   720
         End
         Begin VB.Label lbl单量单位 
            AutoSize        =   -1  'True
            BackColor       =   &H00C0C0FF&
            BackStyle       =   0  'Transparent
            Caption         =   "单位"
            Height          =   180
            Index           =   1
            Left            =   2490
            TabIndex        =   21
            Top             =   2415
            Width           =   360
         End
         Begin VB.Label lbl超量说明 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "超量说明"
            Height          =   180
            Left            =   4050
            TabIndex        =   22
            Top             =   2415
            Width           =   720
         End
         Begin VB.Label lbl用药理由 
            AutoSize        =   -1  'True
            Caption         =   "用药理由"
            Height          =   180
            Left            =   4080
            TabIndex        =   96
            Top             =   2760
            Width           =   720
         End
         Begin VB.Label lbl用药目的 
            AutoSize        =   -1  'True
            Caption         =   "用药目的"
            Height          =   180
            Left            =   150
            TabIndex        =   95
            Top             =   2760
            Width           =   720
         End
         Begin VB.Label lbl首日时间 
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            BackColor       =   &H80000005&
            BackStyle       =   0  'Transparent
            Caption         =   "↓首日"
            ForeColor       =   &H80000008&
            Height          =   180
            Left            =   8640
            TabIndex        =   92
            Top             =   975
            Visible         =   0   'False
            Width           =   540
         End
         Begin VB.Label lbl分零 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "分零方式"
            Height          =   180
            Left            =   165
            TabIndex        =   85
            Top             =   1335
            Visible         =   0   'False
            Width           =   720
         End
         Begin VB.Label lbl附加执行 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "附加执行"
            Height          =   180
            Left            =   5490
            TabIndex        =   68
            Top             =   1695
            Width           =   720
         End
         Begin VB.Label lbl天数 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "用    天"
            Height          =   180
            Left            =   2205
            TabIndex        =   67
            Top             =   2055
            Visible         =   0   'False
            Width           =   720
         End
         Begin VB.Label lbl频率 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "频率"
            Height          =   180
            Left            =   3105
            TabIndex        =   58
            Top             =   1695
            Width           =   360
         End
         Begin VB.Label lbl单量单位 
            BackColor       =   &H00C0C0FF&
            BackStyle       =   0  'Transparent
            Caption         =   "单位"
            Height          =   180
            Index           =   0
            Left            =   4905
            TabIndex        =   54
            Top             =   2055
            Width           =   570
         End
         Begin VB.Label lbl单量 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            BackColor       =   &H80000005&
            BackStyle       =   0  'Transparent
            Caption         =   "↓单量"
            ForeColor       =   &H80000008&
            Height          =   180
            Left            =   2925
            TabIndex        =   53
            ToolTipText     =   "常用剂量比例(Ctrl+~)"
            Top             =   2055
            Width           =   540
         End
         Begin VB.Label lbl总量单位 
            BackStyle       =   0  'Transparent
            Caption         =   "单位"
            Height          =   180
            Left            =   2490
            TabIndex        =   56
            Top             =   2055
            Width           =   570
         End
         Begin VB.Label lbl总量 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "总量"
            Height          =   180
            Left            =   525
            TabIndex        =   55
            Top             =   2055
            Width           =   360
         End
         Begin VB.Label lbl开嘱时间 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "开嘱时间"
            Height          =   180
            Left            =   8295
            TabIndex        =   66
            Top             =   2055
            Width           =   720
         End
         Begin VB.Label lbl期效 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "医嘱期效"
            Height          =   180
            Left            =   165
            TabIndex        =   65
            Top             =   255
            Width           =   720
         End
         Begin VB.Label lbl医生嘱托 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "医生嘱托"
            Height          =   180
            Left            =   5490
            TabIndex        =   63
            Top             =   615
            Width           =   720
         End
         Begin VB.Label lbl执行科室 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "执行科室"
            Height          =   180
            Left            =   5490
            TabIndex        =   61
            Top             =   1335
            Width           =   720
         End
         Begin VB.Label lbl终止时间 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "终止时间"
            Height          =   180
            Left            =   8295
            TabIndex        =   60
            Top             =   1695
            Width           =   720
         End
         Begin VB.Label lbl用法 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "用法"
            Height          =   180
            Left            =   525
            TabIndex        =   57
            Top             =   1695
            Width           =   360
         End
         Begin VB.Label lbl医嘱内容 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "医嘱内容"
            Height          =   180
            Left            =   165
            TabIndex        =   52
            Top             =   600
            Width           =   720
         End
         Begin VB.Label lbl开嘱医生 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "开嘱医生"
            Height          =   180
            Left            =   5490
            TabIndex        =   51
            Top             =   2055
            Width           =   720
         End
         Begin VB.Label lbl开始时间 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "生效时间"
            Height          =   180
            Left            =   2325
            TabIndex        =   50
            Top             =   255
            Width           =   720
         End
         Begin VB.Label lbl执行时间 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "执行时间"
            Height          =   180
            Left            =   5490
            TabIndex        =   59
            Top             =   975
            Width           =   720
         End
         Begin VB.Label lbl执行性质 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "执行性质"
            Height          =   180
            Left            =   8295
            TabIndex        =   62
            Top             =   1335
            Width           =   720
         End
         Begin VB.Label lbl滴速单位 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "滴/分钟"
            Height          =   180
            Left            =   7350
            TabIndex        =   91
            Top             =   255
            Visible         =   0   'False
            Width           =   630
         End
         Begin VB.Label lbl滴速 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "↓滴速"
            Height          =   180
            Left            =   5670
            TabIndex        =   90
            Top             =   255
            Visible         =   0   'False
            Width           =   540
         End
      End
      Begin XtremeCommandBars.CommandBars cbsMain 
         Left            =   435
         Top             =   75
         _Version        =   589884
         _ExtentX        =   635
         _ExtentY        =   635
         _StockProps     =   0
      End
   End
End
Attribute VB_Name = "frmInAdviceEdit"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Public Event FormUnload(Cancel As Integer)
Public Event EditDiagnose(ParentForm As Object, ByVal 病人ID As Long, ByVal 主页ID As Long, ByVal 科室ID As Long, ByVal str类型 As String, Succeed As Boolean) '编辑住院诊断

Public mblnOK As Boolean
        
'入口参数
Private mbytUseType As Byte '0-医嘱下达
                            '1-临床路径项目的医嘱生成
                            '2-临床路径添加路径外项目的医嘱，不允许选择病人
                            '3-医嘱顺序调整(必须显示已停止的医嘱，因为移动时经过那些医嘱，序号要一起调整)
Private mintPState As TYPE_PATI_State
Private mlng路径状态 As Long    '(暂时没有用-1)0-不符合导入条件，1-执行中，2-正常结束，3-变异结束
Private mbln未评估 As Boolean '当前天数未评估
Private mblnPathSend As Boolean '当天（服务器当前时间）是否生成了路径项目
Private mstr当前日期 As String  '路径当前日期
Private mdatSendTime As Date   '路径生成时间
Private mrsPPati As ADODB.Recordset       '当 mlng路径状态=1 and mbytUseType=0 缓存临床路径病人信息
                                          '当 mbytUseType=2 缓存临床路径病人信息

Private mblnModal As Boolean
Private mfrmParent As Object
Private mMainPrivs As String '调用主界面所具有的权限,以便新增的医嘱关联路径阶段注意非内部模块权限
Private mint场合 As Integer '0-医生站调用,1-护士站调用,2-医技站调用(PACS/LIS)
Private mdatTurn As Date '补录时才传入
Private mbln刚录入 As Boolean   '刚录入医嘱
Private mstr自定义申请单IDs As String 'ID1,名称1|ID2,名称2・・・
Private mlng拖动行 As Long '鼠标拖动设置一并给药起始行号

Private mlng病人ID As Long
Private mlng主页ID As Long
Private mint婴儿 As Integer '新增，修改时传入,0=表示病人本人
Private mstr药品价格等级 As String '病人的药品价格等级
Private mstr卫材价格等级 As String '病人的卫材价格等级
Private mstr普通项目价格等级 As String '病人的普通项目价格等级

Private mlng病人性质 As Long    '0-普通住院病人,1-门诊留观病人,2-住院留观病人
Private mlng病人科室id As Long '病人当前科室ID，补录时传入原科室ID
Private mlng病人病区ID As Long '病人当前病区ID，补录时传入原病区ID
Private mstr性别 As String '用于项目输入限制判断，当前性别，如果是婴儿则是婴儿性别，如果不是婴儿则是病人性别
Private mstr病人性别 As String '建档病人的性别，即婴儿母新的性别或者当前病人的性别
Private mint年龄 As Integer '病人的整数年龄
Private mint病人状态  As Integer
Private mint险类 As Integer '当前病人险类
Private mstr付款码 As String '当前病人医疗付款方式编码
Private mstr身份证号 As String
Private mstr姓名 As String

Private mlng前提ID As Long  '医技工作站下医嘱时用
Private mlng会诊医嘱ID As Long
Private mstr前提IDs As String
Private mlng医技科室ID As Long
Private mlng会诊科室ID As Long '如果是给会诊病人下医嘱，则传入当前会诊科室ID
Private mlng婴儿科室ID As Long
Private mlng婴儿病区ID As Long

Private mlng医嘱ID As Long '修改时用
Private mbln审核 As Boolean '是否审核医嘱模式(仅医生使用)
Private mbln暂存 As Boolean '是否暂存模式(仅医生使用)
Private mblnRefresh As Boolean   '=false代表还未加载病区其他病人

Private mstrAdivceOfPath As String  '临床路径传入，医嘱内容ID:婴儿序号:路径项目ID,...，例：227:0:38,335:1:69
                                    '路径外项目重新进入时，传入之前插入的事务未提交的医嘱ID,你：2314,2315,2316
Private mdat开始时间 As Date        '生成路径项目医嘱的开始时间，可能是生成当天以前的（补录）,添加路径外项目时，传入的是病人路径最后一次生成的当前日期
                                    
Private mrsLastAdvice As ADODB.Recordset    '重选项目的医嘱集，字段包括：项目id,病人医嘱ID，组id,诊疗项目id,是按医嘱生成的序号升序排的
Private mrsAdvice调序 As ADODB.Recordset    '医嘱调整顺序时用

'出口参数
Private mstrAdviceOfItem As String  'bytUseType=1时，返回给临床路径的路径项目ID与医嘱ID的串
'                                    bytUseType=2时，传入医嘱ID串,此时事务还没有提交，例：2315,2316
Private marrSQL As Variant          '临床路径调用时返回医嘱保存和校对的SQL集
Private mstr路径项目IDs As String   '路径生成时中医修改了的配方的，且超出了允许修改配方的比例的项目，对应的变异原因：项目ID1|变异编码1,项目2|变异编码2・・・・
Private mdatPathOut As Date         'bytUseType=2时,返回医嘱开始日期,bytUseType=0时,记录路径外项目开始时间
'Pass
Private mobjPassMap As Object  'PASS 窗体对象映射
Private mblnPass As Boolean  'PASS权限

'程序变量
Private mobjVBA As Object
Private mobjScript As clsScript
Private mrsDefine As ADODB.Recordset '医嘱内容定义
Private mrsDrugScale As ADODB.Recordset '常用剂量比例
Private mrsPrice As ADODB.Recordset '医嘱对应的收费项目信息集
Private mrsBaby As ADODB.Recordset '婴儿信息

Private WithEvents mfrmShortCut As frmClinicShortCut
Attribute mfrmShortCut.VB_VarHelpID = -1
Private WithEvents mfrmPrice As frmAdvicePrice
Attribute mfrmPrice.VB_VarHelpID = -1
Private mcolStock1 As Collection '存放各个药品库房的出库检查方式
Private mcolStock2 As Collection '存放各个卫材库房的出库检查方式
Private mstrDelIDs As String '记录需要被删除的医嘱ID
Private mstrDelTempIDs As String '记录需要被删除的暂存医嘱ID
Private mstrLastTime As String '上一个病人最后补录医嘱的开始时间
Private mblnHaveAuditPriv As Boolean '是否具有"执业医师"的资格
Private mblnShowStop As Boolean '是否显示停止医嘱
Private mdatCurr As Date '进入窗体时的当前系统时间
Private mblnIsInHelp As Boolean
Private mblnChecking As Boolean   '正在检查
Private mclsMipModule As zl9ComLib.clsMipModule
Private mbln天数反算 As Boolean
Private msngPre天数 As Single
Private mbln扩展页签 As Boolean '是否支持扩展页签
Private mblnNoRefresh As Boolean '不刷新界面
Private mcolSubForm As Collection '扩展页签对象集合
Private mlngID序列 As Long '假医嘱ID，用负数表示
Private mbytSize As Byte
Private mstrDel输血 As String '记录需要被删除的输血医嘱ID，仅记录主医嘱ID
Private mstr备血医嘱时间 As String '最早的备血医嘱的生效时间   开始执行时间，格式 YYYY-MM-DD HH:MM:SS

'本地参数
Private mint简码 As Integer
Private mstrLike As String
Private mbln一次性 As Boolean '临嘱缺省为一次性
Private mbln天数 As Boolean
Private msng天数 As Single
Private mbln先输单量 As Boolean
Private mbln提醒对码 As Boolean
Private mbln检查出院诊断 As Boolean
Private mstr检查入院诊断 As String
Private mblnAdviceSort As Boolean
Private mblnOutPathTable As Boolean '医技科室调用时，不记录到路径表上
Private mlngPrintPos As Long    '医嘱打印时，转科和出院医嘱打印在：0-长期医嘱单上，1-临时医嘱单上，2-两者都打印。
Private mlngPrintType As Long '医嘱打印模式
Private mlng路径医嘱天数 As Long   '路径医嘱生成超前天数
Private mbln自动打印 As Boolean '自动进入医嘱打印
Private mlng中药味数 As Long    '中药配方允许修改的中药味数上限比例
Private mbln匹配期效 As Boolean '自动匹配时期效不一致算作路径外项目
Private mstrPurMed As String  '抗菌药物缺省用药目的  "1"-预防，"2"-治疗，"0"-下达时确定
Private mblnPrivsNar As Boolean '麻醉权限
Private mblnPrivsPoi As Boolean '毒性权限
Private mblnPrivsMin As Boolean '精神权限
Private mblnPrivsPre As Boolean '贵重权限
Private mbln自动皮试 As Boolean
Private mlng医护科室ID As Long
Private mblnReturn As Boolean
Private mblnDateCheck As Boolean
Private mbln接收自备药 As Boolean '特殊性质药品允许发送到配制中心
Private mbln医技后续 As Boolean   '是否允许对医技医嘱进行后续处理
Private mblnAddAgent As Boolean '是否要求登记毒麻药品代办人信息
Private mlng危急值ID As Long
Private mblnHave疑问医嘱 As Boolean '用于处理校对疑问消息

'事件状态控制变量
Private mblnNoSave As Boolean
Private mblnRowMerge As Boolean
Private mblnRunFirst As Boolean
Private mblnClickItem As Boolean
Private mblnRowChange As Boolean
Private mblnDoCheck As Boolean
Private mblnNewLIS As Boolean

'工具栏命令
Private Const conMenu_New = 100
Private Const conMenu_Insert = 101
Private Const conMenu_Delete = 102
Private Const conMenu_Stop = 103
Private Const conMenu_Merge = 104
Private Const conMenu_Copy = 105
Private Const conMenu_Scheme = 106
Private Const conMenu_Save = 107
Private Const conMenu_Sign = 108
Private Const conMenu_Reference = 109
Private Const conMenu_Help = 110
Private Const conMenu_Exit = 111
Private Const conMenu_Temp = 112
Private Const conMenu_Agent = 113
Private Const conMenu_Previous = 200
Private Const conMenu_Next = 201
Private Const conMenu_ShowStop = 202
Private Const conMenu_MoveDown = 203
Private Const conMenu_MoveUp = 204
Private Const conMenu_Send = 205
Private Const conMenu_SendBilling = 206
Private Const conMenu_SendCharge = 207
Private Const conMenu_DrugScale = 300
Private Const conMenu_AltAdvice = 400
Private Const conMenu_FirstDay = 500
Private Const conMenu_Sort = 3073


'执行时间示例
Private Const COL_按周执行 = _
    "每周三次 1/8-3/8-5/8 或 1/8:00-3/8:00-5/8:00" & vbCrLf & _
        vbTab & "表示在每周星期一的8:00,星期三的8:00,星期五的8:00这几个时间执行"
Private Const COL_按周执行首周 = _
    "每周三次正常情况 1/8-3/8-5/8 或 1/8:00-3/8:00-5/8:00" & vbCrLf & _
        vbTab & "表示在每周星期一的8:00,星期三的8:00,星期五的8:00这几个时间执行" & vbCrLf & _
    "首周执行情况 3/12-5/8 或 3/12:00-5/8:00" & _
        vbTab & "表示在医嘱下达首周星期三的12:00,星期五的8:00这两个时间执行"

Private Const COL_按天执行 = _
    "每天三次 8-12-16 或 8:00-12:00-16:00" & vbCrLf & _
        vbTab & "表示在每天8:00,12:00,16:00这几个时间执行" & vbCrLf & _
    "两天一次 1/8 或 1/8:00" & vbCrLf & _
        vbTab & "表示在每两天中的第1天8:00这个时间执行"
Private Const COL_按天执行首日 = _
    "每天三次正常情况 8-12-16 或 8:00-12:00-16:00" & vbCrLf & _
        vbTab & "表示在每天8:00,12:00,16:00这几个时间执行" & vbCrLf & _
    "首日执行情况 15-19 或 15:00-19:00" & vbCrLf & _
        vbTab & "表示在医嘱下达首日这天按15:00,19:00这两个时间执行"

Private Const COL_按时执行 = _
    "每小时两次 1:20-1:40" & vbCrLf & _
        vbTab & "表示在每小时内的20和40分钟这两个时间执行" & vbCrLf & _
    "两小时一次 2:30 或 1:30 或 1:00" & vbCrLf & _
        vbTab & "表示在每两小时内的第2的个小时的30分钟这个时间执行" & vbCrLf & _
        vbTab & "　或在每两小时内的第1的个小时的30分钟这个时间执行" & vbCrLf & _
        vbTab & "　或在每两小时内的第1的个小时这个时间执行"
Private Const COL_F标志 = 0 '自由录入，紧急，补录,抗菌用药审核状态
'可见列索引
Private Const COL_选择 = 1  '临床路径生成,2=未选择,1=选择,0=单元格不是flexcpChecked型
Private Const COL_警示 = 2 'Pass:以字符串类型处理,空表示没有审查结果
Private Const COL_期效 = 3
Private Const COL_开始时间 = 4
Private Const COL_并 = 5
Private Const col_医嘱内容 = 6
Private Const COL_总量 = 7
Private Const COL_总量单位 = 8
Private Const COL_单量 = 9
Private Const COL_单量单位 = 10
Private Const COL_天数 = 11
Private Const COL_频率 = 12 'Data值用于存放临时数据 是否为双击复制数据,=1时为复制医嘱
Private Const COL_用法 = 13
Private Const COL_医生嘱托 = 14 'Data用于存放摘要(医保)
Private Const COL_执行时间 = 15
Private Const COL_终止时间 = 16
Private Const COL_执行科室 = 17
Private Const COL_医嘱执行性质 = 18
Private Const COL_开嘱医生 = 19
Private Const COL_开嘱时间 = 20
Private Const COL_校对护士 = 21
Private Const COL_基本药物 = 22

'隐藏列索引
Private Const COL_EDIT = 23   '编辑标志：0-原始的,1-新增的,2-修改了内容,3-修改了序号,它的Data值=新下的成套方案ID(复制时为病人id,主页id)
Private Const COL_相关ID = COL_EDIT + 1
Private Const COL_婴儿 = COL_EDIT + 2
Private Const COL_序号 = COL_EDIT + 3 'Pass:Data值用于记录是否更改了审核结果
Private Const COL_状态 = COL_EDIT + 4 '病人医嘱记录.状态，Data值记录该医嘱是否已进行了医保管控检查
Private Const COL_类别 = COL_EDIT + 5  '自由录入的医嘱，记录为*，保存时转换为空
Private Const COL_诊疗项目ID = COL_EDIT + 6
Private Const COL_名称 = COL_EDIT + 7
Private Const COL_标本部位 = COL_EDIT + 8
    Private Const COL_手术时间 = COL_EDIT + 8
    Private Const COL_输血时间 = COL_EDIT + 8
Private Const COL_检查方法 = COL_EDIT + 9
    Private Const COL_中药形态 = COL_EDIT + 9 '0=散装，1=中药饮片，2=免煎剂
Private Const COL_执行标记 = COL_EDIT + 10
Private Const COL_收费细目ID = COL_EDIT + 11   'flexcpData中存储的是成套方案或临床路径生成时原始的收费细目id,以便选择其他规格时判断
Private Const COL_频率次数 = COL_EDIT + 12
Private Const COL_频率间隔 = COL_EDIT + 13
Private Const COL_间隔单位 = COL_EDIT + 14
Private Const COL_计价性质 = COL_EDIT + 15
Private Const COL_执行科室ID = COL_EDIT + 16
Private Const COL_执行性质 = COL_EDIT + 17 '病人医嘱记录.执行性质=诊疗项目目录.执行科室
Private Const COL_开嘱科室ID = COL_EDIT + 18
Private Const COL_标志 = COL_EDIT + 19     '0-普通,1-紧急，2-补录
Private Const COL_计算方式 = COL_EDIT + 20 '诊疗项目目录.计算方式
Private Const COL_频率性质 = COL_EDIT + 21 '诊疗项目目录.执行频率
Private Const COL_操作类型 = COL_EDIT + 22 '诊疗项目目录.操作类型
Private Const COL_执行分类 = COL_EDIT + 23 '诊疗项目目录.执行分类
Private Const COL_库存 = COL_EDIT + 24 '按住院包装存放的可用库存
Private Const COL_可否分零 = COL_EDIT + 25 '卫材用于存放是否跟踪在用
    Private Const COL_跟踪在用 = COL_EDIT + 25
Private Const COL_动态分零 = COL_EDIT + 26
Private Const COL_剂量系数 = COL_EDIT + 27
Private Const COL_住院单位 = COL_EDIT + 28
Private Const COL_住院包装 = COL_EDIT + 29
Private Const COL_处方限量 = COL_EDIT + 30 '非药诊疗项目为录入限量
Private Const COL_处方职务 = COL_EDIT + 31
Private Const COL_毒理分类 = COL_EDIT + 32
Private Const COL_药品剂型 = COL_EDIT + 33
Private Const COL_签名否 = COL_EDIT + 34
Private Const COL_操作时间 = COL_EDIT + 35 '已保存医嘱读入时有，为空表示新的医嘱，仅用于时间判断
Private Const COL_附项 = COL_EDIT + 36 '在需要时才读取
Private Const COL_单价 = COL_EDIT + 37
Private Const COL_上次执行 = COL_EDIT + 38
Private Const COL_品种医嘱 = COL_EDIT + 39 '按品种下达长嘱的药品

Private Const COL_路径项目ID = COL_EDIT + 40 '路径项目ID
Private Const COL_路径执行方式 = COL_EDIT + 41 '0-无须执行，1-每天执行，2-至少执行一次，3-必要时执行,4-必须且仅执行一次
Private Const COL_路径执行ID = COL_EDIT + 42
Private Const COL_路径项目分类 = COL_EDIT + 43
Private Const COL_抗菌等级 = COL_EDIT + 44 '抗菌药物等级:0-非抗菌药,1-非限制级,2-限制级,3-特殊使用级
Private Const COL_用药目的 = COL_EDIT + 45 '1-预防,2-治疗
Private Const COL_用药理由 = COL_EDIT + 46
Private Const COL_审核状态 = COL_EDIT + 47 '抗菌药物审核状态：Null-无需审核，1-待审核，2-审核通过，3-审核未通过
Private Const COL_是否超量 = COL_EDIT + 48  '药品是否超量
Private Const COL_超量说明 = COL_EDIT + 49  '药品超量说明，如果是临床路径生成时，选择中药配方时，显示变异原因
Private Const COL_首次用量 = COL_EDIT + 50  '首次用量
Private Const COL_医嘱内容ID = COL_EDIT + 51 '临床路径医嘱内容ID
Private Const Col_备选医嘱显示行 = COL_EDIT + 52 '判断是否是备选医嘱隐藏的行,以排除已经隐藏了的行:如给药方式
Private Const COL_是否备选 = COL_EDIT + 53  '判断是否是备选医嘱
Private Const COL_配方ID = COL_EDIT + 54    '统计用
Private Const COL_手术情况 = COL_EDIT + 55
Private Const COL_临床自管药 = COL_EDIT + 56
Private Const COL_高危药品 = COL_EDIT + 57
Private Const COL_组合项目ID = COL_EDIT + 58
Private Const COL_原始中药配方 = COL_EDIT + 59
Private Const COL_申请序号 = COL_EDIT + 60 '病人医嘱记录.申请序号
Private Const COL_是否停用 = COL_EDIT + 61 '=1标识已停用，=0或NULL标识未停用
Private Const COL_是否溶媒 = COL_EDIT + 62 '=1溶媒
Private Const COL_采集时间 = COL_EDIT + 63
Private Const COL_皮试结果 = COL_EDIT + 64 '检验医嘱存的，耐受试验时间ID；皮试医嘱是存的皮试结果，Cell(flexcpData 值提交到数据库
Private Const COL_处方审查状态 = COL_EDIT + 65
Private Const COL_处方审查结果 = COL_EDIT + 66
Private Const COL_禁忌药品说明 = COL_EDIT + 67
Private Const COL_单独应用 = COL_EDIT + 68
Private Const COL_危急值ID = COL_EDIT + 69
Private Const COL_易跌倒 = COL_EDIT + 70

Private AgentInfo As AGENT_INFO

Private Type AGENT_INFO
    代办人姓名      As String
    代办人身份证号  As String
    代办人性别      As String
    代办人年龄      As String
    代办人电话      As String
    本次就诊已录入  As Boolean
    用药理由        As String
End Type


'病人清单列
Private Enum EPati
    Item_标识号 = 1
    Item_床号 = 2
    Item_住院医师 = 3
    Item_性别 = 4
    Item_年龄 = 5
    Item_费别 = 6
    Item_护理等级 = 7
    Item_入院日期 = 8
    Item_出院日期 = 9
    Item_医疗付款方式 = 10
    Item_病人类型 = 11
    Item_病人性质 = 12
    Item_体重 = 13
    Item_留观号 = 14
    Item_婴儿科室ID = 15
    Item_婴儿病区ID = 16
    
    Itag_路径状态 = 1
    Itag_科室ID = 2
    Itag_险类 = 3
    Itag_入院日期 = 4
    Itag_出院日期 = 5
    Itag_状态 = 6
    Itag_科室 = 7
    Itag_病区ID = 8
    Itag_数据转出 = 9
    Itag_出生日期 = 10
    Itag_转科时间 = 11
    Itag_病人性质 = 12
End Enum


Private Const BackColorNew = &HD0FFFF   '浅黄色

Public Function ShowMe(frmParent As Object, ByVal int场合 As Integer, ByVal MainPrivs As String, ByVal lng病人ID As Long, ByVal lng主页ID As Long, Optional ByVal lng前提ID As Long, _
    Optional ByVal int婴儿 As Integer, Optional ByVal lng医嘱ID As Long, Optional ByVal blnModal As Boolean, Optional ByVal lng界面科室ID As Long, Optional bln审核 As Boolean, _
    Optional ByVal bytUseType As Byte = 0, Optional ByVal intPState As TYPE_PATI_State = ps在院, Optional ByVal lng病区ID As Long, Optional ByVal lng科室id As Long, _
    Optional ByVal datTurn As Date, Optional ByVal lng医护科室ID As Long, Optional ByVal str前提IDs As String, Optional ByRef objMip As Object, Optional ByVal lng危急值ID As Long, Optional ByVal lng会诊医嘱ID As Long) As Boolean
'说明：医嘱窗口调用
'   注意：此接口传入给模块变量的共用变量，一定要在Form_unload中设置初始值，否则临床路径接口ShowMeByPath调用时会重用这些值

'   bytUseType:'0-医嘱下达
'               1-临床路径项目的医嘱生成，不允许选择病人,不允许新增医嘱，并且限制部分医嘱属性的修改
'               2-临床路径添加路径外项目的医嘱，不允许选择病人，允许新增最多一条医嘱（一并给药算一条）
'               3-医嘱顺序调整(必须显示已停止的医嘱，因为移动时经过那些医嘱，序号要一起调整)

'   lng病区ID,lng科室ID,补录时传入才有效，否则在LoadPatient中会重新读取
'   datTurn=最近转出或出院、预出院时间，补录时才传入
'   str前提IDs医技站中在当前科室执行的所有医嘱
'   lng危急值ID  危急值记录ID

    mbytUseType = bytUseType
    mintPState = intPState
    mdatTurn = datTurn
    
    If mintPState = ps最近转出 Then
        mlng病人科室id = lng科室id
        mlng病人病区ID = lng病区ID
    End If
    If Not (objMip Is Nothing) Then Set mclsMipModule = objMip
    Set mfrmParent = frmParent
    mint场合 = int场合
    mblnModal = blnModal
    mMainPrivs = MainPrivs
    mlng病人ID = lng病人ID
    mlng主页ID = lng主页ID
    mint婴儿 = int婴儿
    If InitObjPublicExpense Then Call gobjPublicExpense.zlGetPriceGrade(gstrNodeNo, mlng病人ID, mlng主页ID, "", mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级)


    mlng前提ID = lng前提ID
    mstr前提IDs = str前提IDs
    mlng医技科室ID = IIF(mlng前提ID <> 0, lng界面科室ID, 0)
    mlng会诊科室ID = IIF(mlng前提ID <> 0, 0, lng界面科室ID)
    mlng医护科室ID = lng医护科室ID
    mlng医嘱ID = lng医嘱ID
    mbln审核 = bln审核
    mlng危急值ID = lng危急值ID
    mlng会诊医嘱ID = lng会诊医嘱ID
   
    On Error Resume Next
    Me.Show IIF(blnModal, 1, 0), frmParent
    ShowMe = mblnOK
End Function

Public Function ShowMeByPath(frmParent As Object, ByVal int场合 As Integer, ByVal MainPrivs As String, ByVal bytUseType As Byte, ByVal lng病人ID As Long, ByVal lng主页ID As Long, _
    ByVal strAdivceOfPath As String, ByVal dat开始时间 As Date, arrSQL As Variant, strAdviceOfItem As String, Optional ByVal rsLastAdvice As ADODB.Recordset, _
   Optional ByVal datSendTime As Date, Optional ByRef str路径项目IDs As String, Optional ByRef objMip As Object, Optional ByRef datPathOut As Date) As Boolean
'说明：临床路径生成调用
'参数：
'   注意：此接口传入给模块变量的共用变量，一定要在Form_unload中设置初始值，否则医嘱接口ShowMe调用时会重用这些值
'   bytUseType      =1:路径生成,2=添加路径外项目
'   strAdivceOfPath =bytUseType=1时，传入医嘱内容ID:婴儿序号:路径项目ID,...，例：227:0:38,335:1:69
'                   =bytUseType=2时，传入医嘱ID串,此时事务还没有提交，例：2315,2316
'   arrSQL          =医嘱保存和校对的SQL
'   strAdviceOfItem =bytUseType=1时，路径项目与医嘱ID的对应,例：38:1983,69:1978
'                   =bytUseType=2时，传入医嘱ID串,此时事务还没有提交，例：2315,2316
'   rsLastAdvice    =bytUseType=1时，传入重选项目的医嘱集，字段包括：项目id,病人医嘱ID，组id,诊疗项目id,是按医嘱生成的序号升序排的
'   datSendTime    =bytUseType=1时，传入路径的生成时间
'      str路径项目IDs   =路径生成时中医修改了的配方的，且超出了允许修改配方的比例的项目，对应的变异原因：项目ID1|变异编码1,项目2|变异编码2・・・・
'   datPathOut       =bytUseType=2时,返回医嘱的开始日期,此日期用于确定该路径外项目添加到路径表单的某一天。

    mbytUseType = bytUseType
    
    mblnModal = True
    Set mfrmParent = frmParent
    mint场合 = int场合
    mbytUseType = bytUseType
    mMainPrivs = MainPrivs
    mlng病人ID = lng病人ID
    mlng主页ID = lng主页ID
    mdatSendTime = datSendTime
    mstr路径项目IDs = str路径项目IDs
    If Not (objMip Is Nothing) Then Set mclsMipModule = objMip
    mstrAdivceOfPath = strAdivceOfPath
    Set mrsLastAdvice = rsLastAdvice
    mdat开始时间 = dat开始时间
    mstrAdviceOfItem = ""
    mdatPathOut = datPathOut
    Set marrSQL = Nothing
    If gblnKSSStrict Then Call CheckKSSPrivilege(1)     '77467 临床进入编辑界面重新赋值UserInfo.用药级别 避免未进入医嘱信息而直接进入路径应用界面造成程序赋值不成功
    If mbytUseType = 2 Then Set mrsPPati = GetPatiPathInfo(mlng病人ID, mlng主页ID)
    
    On Error Resume Next
    Me.Show IIF(mblnModal, 1, 0), frmParent
    arrSQL = marrSQL
    
    If mbytUseType = 2 And mstrAdivceOfPath <> "" Then
        strAdviceOfItem = mstrAdivceOfPath      '重新进入后，未做编辑，直接退出，则保持不变,arrSQL不返回
    Else
        strAdviceOfItem = mstrAdviceOfItem
    End If
    datPathOut = mdatPathOut
    str路径项目IDs = mstr路径项目IDs
    ShowMeByPath = mblnOK
End Function

Private Sub InitCommandBar()
'功能：初始化工具栏
    Dim objBar As CommandBar
    Dim objControl As CommandBarControl
    Dim objMenu As CommandBarPopup
    Dim objPopup As CommandBarPopup
    
    Dim varArr As Variant
    Dim strTmp As String
    Dim intTmp As Integer
    Dim strName As String
    Dim lngID As Long
    Dim i As Long
    Dim strInsidePrivs As String
    
    strInsidePrivs = GetInsidePrivs(p住院医嘱下达)

    CommandBarsGlobalSettings.App = App
    CommandBarsGlobalSettings.ResourceFile = CommandBarsGlobalSettings.OcxPath & "\XTPResourceZhCn.dll"
    CommandBarsGlobalSettings.ColorManager.SystemTheme = xtpSystemThemeAuto
    cbsMain.VisualTheme = xtpThemeOffice2003
    With Me.cbsMain.Options
        .ShowExpandButtonAlways = False
        .ToolBarAccelTips = True
        .AlwaysShowFullMenus = False
        .IconsWithShadow = True '放在VisualTheme后有效
        .UseDisabledIcons = True
        .LargeIcons = True
        .SetIconSize True, 24, 24
        .SetIconSize False, 16, 16
    End With
    cbsMain.EnableCustomization False
    cbsMain.ActiveMenuBar.Visible = False
    Set cbsMain.Icons = frmIcons.imgMain.Icons
    
   
    Set objMenu = cbsMain.ActiveMenuBar.Controls.Add(xtpControlPopup, conMenu_EditPopup, "药嘱审查", -1, False)
    objMenu.ID = conMenu_EditPopup


    With objMenu.CommandBar.Controls
        'PASS弹出菜单是在第一次点击鼠标右键时加载的cbsMain_InitCommandsPopup
        
        '插件扩展功能
        Call CreatePlugInOK(IIF(mint场合 = 1, p住院医嘱发送, p住院医嘱下达), mint场合)
        If Not gobjPlugIn Is Nothing Then
            Set objPopup = .Add(xtpControlButtonPopup, conMenu_Tool_PlugIn, "扩展功能")
            objPopup.BeginGroup = True
        End If
        If Not gobjDrugExplain Is Nothing And InStr(strInsidePrivs, ";药品说明书;") > 0 Then
            Set objControl = .Add(xtpControlButton, conMenu_Edit_ViewDrugExplain, "查看药品说明书")
            objControl.IconId = 3205
        End If
    End With
    
    '生成工具栏
    Set objBar = cbsMain.Add("工具栏", xtpBarTop)
    With objBar.Controls
        If mbytUseType = 1 Or mbytUseType = 3 Then
            Set objControl = .Add(xtpControlButton, conMenu_MoveUp, "上移")
            Set objControl = .Add(xtpControlButton, conMenu_MoveDown, "下移")
        End If
        
        If mbytUseType = 3 Then
            Set objControl = .Add(xtpControlButton, conMenu_Sort, "按生效时间排序")
        End If
        
        Set objControl = .Add(xtpControlButton, conMenu_Previous, "上一个病人")
        Set objControl = .Add(xtpControlButton, conMenu_Next, "下一个病人")
        Set objControl = .Add(xtpControlButton, conMenu_ShowStop, "显示停止医嘱")
        Set objControl = .Add(xtpControlButton, conMenu_New, "增加"): objControl.BeginGroup = True
        Set objControl = .Add(xtpControlButton, conMenu_Insert, "插入")
        Set objControl = .Add(xtpControlButton, conMenu_Delete, "删除")
        
        If mint场合 = 0 Then '只有住院医生工作站调用时才有这几个按钮
            intTmp = Val(Mid(gstrInUseApp, 1, 1))
            If intTmp = 1 Then strTmp = strTmp & ",检查申请:" & conMenu_Edit_PacsApply
            intTmp = Val(Mid(gstrInUseApp, 2, 1))
            If intTmp = 1 And Not gobjLIS Is Nothing Then strTmp = strTmp & ",检验申请:" & conMenu_Edit_LISApply
            intTmp = Val(Mid(gstrInUseApp, 3, 1))
            If intTmp = 1 Then strTmp = strTmp & ",输血申请:" & conMenu_Edit_BloodApply
            intTmp = Val(Mid(gstrInUseApp, 4, 1))
            If intTmp = 1 Then strTmp = strTmp & ",手术申请:" & conMenu_Edit_OperationApply
            intTmp = Val(Mid(gstrInUseApp, 5, 1))
            If intTmp = 1 Then strTmp = strTmp & ",会诊申请:" & conMenu_Edit_ConsultationApply
            Get自定义申请单 1, mstr自定义申请单IDs
            If mstr自定义申请单IDs <> "" Then
                For i = 0 To UBound(Split(mstr自定义申请单IDs, "|"))
                    strTmp = strTmp & "," & Split(Split(mstr自定义申请单IDs, "|")(i), ",")(1) & ":" & (conMenu_Edit_ApplyCustom * 100# + i) & ":" & Split(Split(mstr自定义申请单IDs, "|")(i), ",")(0)
                Next
            End If
            strTmp = Mid(strTmp, 2)
            
            If strTmp <> "" Then
                If InStr(strTmp, ",") = 0 Then
                    strName = Split(strTmp, ":")(0)
                    lngID = Val(Split(strTmp, ":")(1))
                    Set objControl = .Add(xtpControlButton, lngID, strName)
                        objControl.IconId = conMenu_Edit_PacsApply
                        objControl.ToolTipText = strName
                        objControl.BeginGroup = True
                                                If UBound(Split(strTmp, ":")) = 2 Then objControl.Parameter = Val(Split(strTmp, ":")(2))
                Else
                    varArr = Split(strTmp, ",")
                    For i = 0 To UBound(varArr)
                        strTmp = varArr(i)
                        strName = Split(strTmp, ":")(0)
                        lngID = Val(Split(strTmp, ":")(1))
                        
                        If i = 0 Then
                            Set objPopup = .Add(xtpControlSplitButtonPopup, lngID, strName)
                                objPopup.IconId = conMenu_Edit_PacsApply
                                objPopup.BeginGroup = True
                                objPopup.ToolTipText = strName
                                With objPopup.CommandBar.Controls
                                    Set objControl = .Add(xtpControlButton, lngID * 10# + 1, strName)
                                End With
                        Else
                            Set objControl = objPopup.CommandBar.Controls.Add(xtpControlButton, lngID, strName)
                        End If
                        If UBound(Split(strTmp, ":")) = 2 Then objControl.Parameter = Val(Split(strTmp, ":")(2))
                    Next
                End If
            End If
        End If
        
        Set objControl = .Add(xtpControlButton, conMenu_Stop, "停止"): objControl.BeginGroup = True
        Set objControl = .Add(xtpControlButton, conMenu_Merge, "一并给药"): objControl.BeginGroup = True
        If InStr(strInsidePrivs, ";复制医嘱;") > 0 Then
            Set objControl = .Add(xtpControlButton, conMenu_Copy, "复制"): objControl.BeginGroup = True
        End If
        
        Set objPopup = .Add(xtpControlSplitButtonPopup, conMenu_Scheme, "成套方案")
        objPopup.ToolTipText = "保存为成套方案"
        With objPopup.CommandBar.Controls
            .Add xtpControlButton, conMenu_Scheme * 10# + 1, "保存为成套方案"
            .Add xtpControlButton, conMenu_Scheme * 10# + 2, "显示成套方案选择器"
        End With
        
        Set objControl = .Add(xtpControlButton, conMenu_AltAdvice, "备选"): objControl.BeginGroup = True: objControl.IconId = 205
        
        Set objControl = .Add(xtpControlButton, conMenu_Agent, "代办人")
        Set objControl = .Add(xtpControlButton, conMenu_Save, "保存"): objControl.BeginGroup = True
        Set objControl = .Add(xtpControlButton, conMenu_Temp, "暂存")
        
        If InStr(strInsidePrivs, "发送门诊费用") = 0 Then
            Set objControl = .Add(xtpControlButton, conMenu_SendBilling, "发送(&G)"): objControl.BeginGroup = True
            objControl.IconId = conMenu_Send
        Else
            Set objPopup = .Add(xtpControlSplitButtonPopup, conMenu_Send, "发送"): objPopup.BeginGroup = True
            With objPopup.CommandBar.Controls
                Set objControl = .Add(xtpControlButton, conMenu_SendBilling, "住院记帐")     'update事件中根据当前是否留观病人再决定显示门诊记帐还是住院记帐
                .Add xtpControlButton, conMenu_SendCharge, "门诊收费"
            End With
        End If
        Set objControl = .Add(xtpControlButton, conMenu_Report_AdviceBill1, "打印"): objControl.BeginGroup = True
        Set objControl = .Add(xtpControlButton, conMenu_Sign, "签名"): objControl.BeginGroup = True
        If gbln审方系统 And mbytUseType = 0 Then
            Set objControl = .Add(xtpControlButton, conMenu_Edit_ViewRefcom, "审方结果"): objControl.BeginGroup = True
                objControl.IconId = 3333
        End If
        Set objControl = .Add(xtpControlButton, conMenu_Reference, "参考"): objControl.BeginGroup = True
        Set objControl = .Add(xtpControlButton, conMenu_Help, "帮助")
        Set objControl = .Add(xtpControlButton, conMenu_Exit, "退出")
    End With
    objBar.EnableDocking xtpFlagHideWrap
    objBar.ContextMenuPresent = False
    For Each objControl In objBar.Controls
        If objControl.ID = conMenu_Help Or objControl.ID = conMenu_Exit Or objControl.ID = conMenu_Reference _
            Or objControl.ID = conMenu_Previous Or objControl.ID = conMenu_Next Or objControl.ID = conMenu_ShowStop Then
            objControl.Style = xtpButtonIcon
        Else
            objControl.Style = xtpButtonIconAndCaption
        End If
    Next
    
    '热键绑定:注意不能和系统的文本编辑热键冲突，以及Form_keydown中的冲突
    With cbsMain.KeyBindings
        .Add 0, vbKeyF2, conMenu_Save
        .Add 0, vbKeyF6, conMenu_Reference
        .Add 0, vbKeyF1, conMenu_Help
        .Add 0, vbKeyF9, conMenu_Merge
        .Add 0, vbKeyF11, conMenu_Temp
        .Add FCONTROL, vbKeyPageUp, conMenu_Previous
        .Add FCONTROL, vbKeyPageDown, conMenu_Next
        .Add FCONTROL, vbKeyA, conMenu_New
        .Add FCONTROL, vbKeyI, conMenu_Insert
        .Add FCONTROL, vbKeyW, conMenu_Stop
        .Add FCONTROL, vbKeyK, conMenu_Merge
        .Add FCONTROL, vbKeyY, conMenu_Copy
        .Add FCONTROL, vbKeyT, conMenu_Scheme
        .Add FCONTROL, vbKeyS, conMenu_Save
        .Add FALT, vbKeyX, conMenu_Exit
    End With
End Sub
Private Sub InitAdviceTable()
'功能：初始化表格内容，用在窗体个性化设置恢复之前
    Dim strHead As String, i As Integer
    Dim arrHead As Variant, arrCol As Variant
    
    If mbytUseType = 1 Then
        strHead = "选择,450,4;"
    Else
        strHead = "选择;"
    End If
    
    strHead = strHead & _
        ",280,4;期效,500,4;生效时间,1530,1;,200,7;医嘱内容,3500,1;总量,600,7;单位,450,1;单量,600,7;单位,450,1;天数,450,1;频率,1200,1;用法,1200,1;" & _
        "医生嘱托,1000,1;执行时间,1000,1;终止时间,1530,1;执行科室,1000,1;执行性质,850,1;开嘱医生,850,1;开嘱时间,1530,1;校对护士,850,1;基本药物,850,1;" & _
        "EDIT;相关ID;婴儿;序号;医嘱状态;诊疗类别;诊疗项目ID;名称;标本部位;检查方法;执行标记;收费细目ID;频率次数;频率间隔;间隔单位;计价性质;执行科室ID;执行性质;开嘱科室ID;标志;" & _
        "计算方式;频率性质;操作类型;执行分类;库存;可否分零;动态分零;剂量系数;住院单位;住院包装;处方限量;处方职务;毒理分类;药品剂型;签名否;操作时间;附项;单价;上次执行;品种医嘱;" & _
        "路径项目ID;路径执行方式;路径执行ID;路径项目分类;抗菌等级;用药目的;用药理由;审核状态;是否超量;超量说明;首次用量;医嘱内容ID;备选医嘱显示行;是否备选;配方ID;手术情况;" & _
        "临床自管药;高危药品;组合项目ID;原始中药配方;申请序号;是否停用;是否溶媒;采集时间;皮试结果;处方审查状态;处方审查结果;禁忌药品说明;单独应用;危急值ID;易跌倒"
        
    arrHead = Split(strHead, ";")
    With vsAdvice
        .Clear
        .FixedRows = 1: .FixedCols = 1
        .Rows = 2: .Cols = .FixedCols + UBound(arrHead) + 1
        
        For i = 0 To UBound(arrHead)
            .FixedAlignment(.FixedCols + i) = 4
            arrCol = Split(arrHead(i), ",")
            .TextMatrix(0, .FixedCols + i) = arrCol(0)
            If UBound(arrCol) > 0 Then
                .ColWidth(.FixedCols + i) = Val(arrCol(1))
                .ColData(.FixedCols + i) = Val(arrCol(1))
                .ColAlignment(.FixedCols + i) = Val(arrCol(2))
                .ColHidden(.FixedCols + i) = False
            Else
                .ColHidden(.FixedCols + i) = True
            End If
        Next
        .ColHidden(COL_警示) = True 'Pass
    End With
End Sub

Private Sub cbo滴速_Change()
    If lbl滴速.Caption = "滴速" Then '输血
        If IsNumeric(cbo滴速.Text) Or cbo滴速 = "" Then
            lbl滴速单位 = "滴/分钟"
        Else
            lbl滴速单位.Caption = ""
        End If
    End If
    cbo滴速.Tag = "1"
End Sub

Private Sub cbo滴速_Click()
    cbo滴速.Tag = "1"
    If lbl滴速.Caption = "滴速" Then
        If cbo滴速.Text = "加压" Or cbo滴速.Text = "快速" Then '只有输血医嘱有这两个
            lbl滴速单位.Caption = ""
        Else
            lbl滴速单位 = "滴/分钟"
        End If
    End If
    Call AdviceChange
End Sub

Private Sub cbo滴速_GotFocus()
    zlControl.TxtSelAll cbo滴速
End Sub

Private Sub cbo滴速_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If SeekNextControl Then Call cbo滴速_Validate(False)
    ElseIf InStr("0123456789-" & Chr(8), Chr(KeyAscii)) = 0 Then
        KeyAscii = 0
    End If
End Sub

Private Sub cbo滴速_Validate(Cancel As Boolean)
    If zlCommFun.ActualLen(cbo滴速.Text) > 10 Then
        MsgBox "滴速输入内容过长，请检查输入是否正确。", vbInformation, gstrSysName
        Call cbo滴速_GotFocus: Cancel = True: Exit Sub
    End If
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub cbo分零_Click()
    If cbo分零.ListIndex = -1 Then Exit Sub
    If cbo分零.ItemData(cbo分零.ListIndex) = Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_可否分零)) Then Exit Sub
    
    cbo分零.Tag = "1"
    Call AdviceChange
End Sub

Private Sub cbo分零_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call SeekNextControl
    End If
End Sub

Private Sub cbo附加执行_Click()
    Dim rsTmp As ADODB.Recordset
    Dim lngRow As Long, strSQL As String
    Dim intIdx As Integer, i As Long
    Dim vRect As RECT, blnCancel As Boolean
        
    If cbo附加执行.ListIndex = -1 Then Exit Sub
    
    If cbo附加执行.ItemData(cbo附加执行.ListIndex) = -1 Then
        strSQL = "Select Distinct A.ID,A.编码,A.名称,A.简码" & _
            " From 部门表 A,部门性质说明 B" & _
            " Where A.ID=B.部门ID And B.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3)" & _
            " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
            " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 is NULL)" & _
            " Order by A.编码"
        vRect = zlControl.GetControlRect(cbo附加执行.hwnd)
        Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, lbl附加执行.Caption, , , , , , True, vRect.Left, vRect.Top, txt用法.Height, blnCancel, , True)
        If Not rsTmp Is Nothing Then
            intIdx = Cbo.FindIndex(cbo附加执行, rsTmp!ID)
            If intIdx <> -1 Then
                cbo附加执行.ListIndex = intIdx
            Else
                cbo附加执行.AddItem rsTmp!编码 & "-" & rsTmp!名称, cbo附加执行.ListCount - 1
                cbo附加执行.ItemData(cbo附加执行.NewIndex) = rsTmp!ID
                cbo附加执行.ListIndex = cbo附加执行.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "没有科室数据，请先到部门管理中设置。", vbInformation, gstrSysName
            End If
            '恢复成现有的科室(不引发Click)
            intIdx = Cbo.FindIndex(cbo附加执行, Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_执行科室ID)))
            Call Cbo.SetIndex(cbo附加执行.hwnd, intIdx)
        End If
    Else
        cbo附加执行.Tag = "1"
        lngRow = vsAdvice.Row
        
        '更新更改了的执行科室医嘱内容
       Call AdviceChange
    End If
End Sub

Private Sub cbo附加执行_GotFocus()
    Call zlControl.TxtSelAll(cbo附加执行)
End Sub

Private Sub cbo附加执行_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo附加执行.ListIndex = -1 Then
            Call cbo附加执行_Validate(blnCancel)
        End If
        If Not blnCancel Then
            If SeekNextControl Then Call cbo附加执行_Validate(False)
        End If
    End If
End Sub

Private Sub cbo附加执行_Validate(Cancel As Boolean)
'功能：根据输入的内容,自动匹配执行科室
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, intIdx As Long, i As Long
    Dim blnLimit As Boolean, strInput As String
    Dim vRect As RECT, blnCancel As Boolean
    
    If cbo附加执行.ListIndex <> -1 Then Exit Sub '已选中
    If cbo附加执行.Text = "" Then '无输入
        With vsAdvice
            If .TextMatrix(.Row, COL_类别) = "E" And .TextMatrix(.Row, COL_操作类型) = "1" And .TextMatrix(.Row, COL_执行分类) = "5" Then
                cbo附加执行.Tag = "1"
                Call AdviceChange
                Exit Sub
            Else
                If cbo附加执行.ListCount > 0 Then Cancel = True
                Exit Sub
            End If
        End With
    End If
    
    On Error GoTo errH
    
    '是否可以任意或选择科室
    blnLimit = True
    If cbo附加执行.ListCount > 0 Then
        If cbo附加执行.ItemData(cbo附加执行.ListCount - 1) = -1 Then
            blnLimit = False
        End If
    End If
    strInput = UCase(zlCommFun.GetNeedName(cbo附加执行.Text))
    strSQL = "Select Distinct A.ID,A.编码,A.名称,A.简码" & _
        " From 部门表 A,部门性质说明 B" & _
        " Where A.ID=B.部门ID And B.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3)" & _
        " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
        " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 is NULL)" & _
        " And (Upper(A.编码) Like [1] Or Upper(A.名称) Like [2] Or Upper(A.简码) Like [2])" & _
        " Order by A.编码"
    If blnLimit Then
        'Set rsTmp = New ADODB.Recordset
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strInput & "%", mstrLike & strInput & "%")
        For i = 1 To rsTmp.RecordCount
            intIdx = Cbo.FindIndex(cbo附加执行, rsTmp!ID)
            If intIdx <> -1 Then cbo附加执行.ListIndex = intIdx: Exit For
            rsTmp.MoveNext
        Next
        If cbo附加执行.ListIndex = -1 Then
            MsgBox "未到对应的科室。", vbInformation, gstrSysName
            Cancel = True: Exit Sub
        End If
    Else
        vRect = zlControl.GetControlRect(cbo附加执行.hwnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl附加执行.Caption, False, "", "", False, False, True, _
            vRect.Left, vRect.Top, txt用法.Height, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%")
        If Not rsTmp Is Nothing Then
            intIdx = Cbo.FindIndex(cbo附加执行, rsTmp!ID)
            If intIdx <> -1 Then
                cbo附加执行.ListIndex = intIdx
            Else
                cbo附加执行.AddItem rsTmp!编码 & "-" & rsTmp!名称, cbo附加执行.ListCount - 1
                cbo附加执行.ItemData(cbo附加执行.NewIndex) = rsTmp!ID
                cbo附加执行.ListIndex = cbo附加执行.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "未到对应的科室。", vbInformation, gstrSysName
            End If
            Cancel = True: Exit Sub
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub Refresh开始时间(ByVal lngRow As Long)
'功能：根据参数设置，重新刷新正确的开始时间
    If Not IsDate(msk开始时间.Text) Then
        msk开始时间.Text = GetDefaultTime(lngRow)
    Else
        If cbo期效.ListIndex = 0 Then
            '长嘱
            If gbln长期医嘱次日生效 And Format(msk开始时间.Text, "HH:mm") <> "00:00" Then
                msk开始时间.Text = GetDefaultTime(lngRow)
            End If
        ElseIf cbo期效.ListIndex = 1 Then
            '临嘱
            If gbln长期医嘱次日生效 And Format(msk开始时间.Text, "HH:mm") = "00:00" Then
                If Abs(DateDiff("n", msk开始时间.Text, zlDatabase.Currentdate)) > gint补录间隔 Then
                    msk开始时间.Text = GetDefaultTime(lngRow)
                End If
            End If
        End If
    End If
End Sub

Private Sub cbo期效_Click()
'功能：更改项目期效时,清空当前行的数据
    Dim lngRow As Long, i As Long
    Dim strTime As String
    Dim lngBegin As Long, lngEnd As Long
    Dim blnNeedSpec As Boolean
    Dim strSpec As String
    
    With vsAdvice
        lngRow = .Row
        If .RowData(lngRow) = 0 Then
            Call Refresh开始时间(lngRow): Exit Sub
        End If
        
        If zlCommFun.GetNeedName(cbo期效.Text) = .TextMatrix(lngRow, COL_期效) Then Exit Sub
        
        '自由录入医嘱直接更改期效
        If Val(.TextMatrix(lngRow, COL_诊疗项目ID)) = 0 Then
            .TextMatrix(lngRow, COL_期效) = zlCommFun.GetNeedName(cbo期效.Text)
            
            Call Refresh开始时间(lngRow)
            
            If InStr(",0,3,", .TextMatrix(lngRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngRow, COL_EDIT) = 2
                .TextMatrix(lngRow, COL_状态) = IIF(Val(.TextMatrix(lngRow, COL_状态)) = -1, -1, 1)
                Call ReSetColor(lngRow)
            End If
            mblnNoSave = True: Exit Sub
        End If
        
        
        If CanAlterType(lngRow, blnNeedSpec) Then
            '确定药品规格
            If blnNeedSpec Then
                Call GetRowScope(lngRow, lngBegin, lngEnd)
                For i = lngBegin To lngEnd
                    If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                        strSpec = strSpec & "<Split1>" & .TextMatrix(i, col_医嘱内容) & "<Split2>" & _
                            Val(.TextMatrix(i, COL_单量)) & "<Split2>" & .RowData(i) & "<Split2>" & _
                            Val(.TextMatrix(i, COL_收费细目ID)) & "<Split2>" & _
                            Val(.TextMatrix(i, COL_诊疗项目ID)) & "<Split2>" & _
                            Val(.TextMatrix(i, COL_执行科室ID))
                    End If
                Next
                strSpec = Mid(strSpec, Len("<Split1>") + 1)
                If Not frmAdviceDrugSpec.ShowMe(Me, strSpec) Then
                    Call Cbo.SetIndex(cbo期效.hwnd, IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1))
                    Exit Sub
                End If
            End If
                        
            Call AdviceAlterType(lngRow, strSpec)
            
            Call vsAdvice_AfterRowColChange(-1, -1, .Row, col_医嘱内容)

        Else
            '一并给药中某一个不准改(因为规格等原因),则当前行内容不能清除，整体不允许更改
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                If RowIn一并给药(lngRow) Then
                    MsgBox "一并给药的药品中存在未按规格下达的药品，不能更改为临嘱。", vbInformation, gstrSysName
                    Call Cbo.SetIndex(cbo期效.hwnd, IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1))
                    Exit Sub
                End If
            End If
        
            If MsgBox("更改医嘱期效后需要重新输入医嘱内容,要更改吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                Call Cbo.SetIndex(cbo期效.hwnd, IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1))
                Exit Sub
            End If
            
            '清除医嘱数据行
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '西成药、中成药:只可能是单独给药的,删除给药途径行,并清除当前行
                i = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                Call DeleteRow(i)
                Call DeleteRow(lngRow, True)
            ElseIf InStr(",D,F,K,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '检查组合项目、手术项目、输血项目
                '删除部位行、手术附加行(附加手术,麻醉项目)、输血途径
                Call Delete检查手术输血(lngRow)
                '清除当前行
                Call DeleteRow(.Row, True)
            ElseIf RowIn配方行(lngRow) Then
                '中药配方：顺序(序号)要求必须严格控制
                '删除组成味药及煎法行:删除之后重新定位的当前行
                lngRow = Delete中药配方(lngRow)
                '清除当前行(中药用法行)
                Call DeleteRow(.Row, True)
            ElseIf RowIn检验行(lngRow) Then
                Call Delete检验组合(lngRow)
                '清除当前行
                Call DeleteRow(.Row, True)
            Else
                '其它项目直接清除当前行内容
                Call DeleteRow(lngRow, True)
            End If
            
            '重新进入行
            strTime = msk开始时间.Text '保留开始时间
            i = cbo期效.ListIndex '保留当前选择的期效
            Call vsAdvice_AfterRowColChange(-1, -1, .Row, col_医嘱内容)
            msk开始时间.Text = strTime
            cbo期效.ListIndex = i '就是需要再激活以设置开始时间值
            
            Call Refresh开始时间(.Row)
            
            mblnNoSave = True
        End If
        If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(.Row, .Row)
    End With
End Sub

Private Sub cbo期效_KeyPress(KeyAscii As Integer)
    Dim lngIdx As Long
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo期效.ListIndex <> -1 Then
            Call SeekNextControl
        End If
    ElseIf KeyAscii >= 32 Then
        lngIdx = Cbo.MatchIndex(cbo期效.hwnd, KeyAscii)
        If lngIdx = -1 And cbo期效.ListCount > 0 Then lngIdx = 0
        cbo期效.ListIndex = lngIdx
    End If
End Sub

Private Sub cbo手术情况_Click()
    If cbo手术情况.ListIndex = -1 Then Exit Sub
    If cbo手术情况.ItemData(cbo手术情况.ListIndex) = Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_手术情况)) Then Exit Sub
    
    cbo手术情况.Tag = "1"
    Call AdviceChange
End Sub

Private Sub cbo手术情况_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call SeekNextControl
    End If
End Sub

Private Sub cbo医生_Click()
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, intIdx As Integer, i As Long
    Dim vRect As RECT, blnCancel As Boolean
        
    If cbo医生.ListIndex = -1 Then Exit Sub
    
    If cbo医生.ItemData(cbo医生.ListIndex) = -1 Then
        If vsAdvice.RowData(vsAdvice.Row) = 0 Then
            cbo医生.Text = "": Exit Sub
        End If
        
        '全院住院科室的医生
        strSQL = "Select Distinct 部门ID From 部门性质说明 Where 服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3)"
        strSQL = "Select Distinct A.ID,A.编号,A.姓名,A.简码" & _
            " From 人员表 A,部门人员 B,人员性质说明 C" & _
            " Where A.ID=B.人员ID And A.ID=C.人员ID And C.人员性质='医生'" & _
            " And (A.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or A.撤档时间 Is Null)" & _
            " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
            " And B.部门ID IN(" & strSQL & ")" & _
            " Order by A.简码"
        vRect = zlControl.GetControlRect(cbo医生.hwnd)
        Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, lbl开嘱医生.Caption, , , , , , True, vRect.Left, vRect.Top, cbo医生.Height, blnCancel, , True)
        If Not rsTmp Is Nothing Then
            intIdx = Cbo.FindIndex(cbo医生, rsTmp!ID)
            If intIdx <> -1 Then
                cbo医生.ListIndex = intIdx
            Else
                cbo医生.AddItem NVL(rsTmp!简码) & "-" & Chr(13) & rsTmp!姓名, cbo医生.ListCount - 1
                cbo医生.ItemData(cbo医生.NewIndex) = rsTmp!ID
                cbo医生.ListIndex = cbo医生.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "没有住院医生数据，请先到部门管理中设置。", vbInformation, gstrSysName
            End If
            '恢复成现有的医生(不引发Click)
            intIdx = Cbo.FindIndex(cbo医生, vsAdvice.TextMatrix(vsAdvice.Row, COL_开嘱医生))
            Call Cbo.SetIndex(cbo医生.hwnd, intIdx)
        End If
    Else
        cbo医生.Tag = "1"
        Call AdviceChange
    End If
End Sub

Private Sub Set用法Input(rsInput As ADODB.Recordset, ByVal int类型 As Integer)
'功能：输入给药途径或中药用法后调用
'参数：rsInput=输入或选择的返回记录
'      int类型=2-给药途径,4-中药用法
'说明：如果可选频率,则配合给药途径处理可用执行时间方案的变化
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim blnValid As Boolean, sng天数 As Single
    Dim str频率 As String, int频率次数 As Integer, int频率间隔 As Integer, str间隔单位 As String
    Dim vMsg As VbMsgBoxResult, strMsg As String
    Dim bln用法用量 As Boolean, bln用法频率 As Boolean
    Dim strIDs1 As String, strIDs2 As String, str医嘱内容 As String
    Dim lngPre用法ID As Long
    Dim lng项目id As Long
    Dim lngRow As Long, lngBegin As Long, lngEnd As Long, j As Long
    Dim lngCnt As Long, lng科室id As Long
    Dim str药房IDs As String
    Dim arrTmp As Variant
    Dim arrTmp1 As Variant
    
    lngPre用法ID = Val(cmd用法.Tag)
    cmd用法.Tag = rsInput!ID
    txt用法.Text = rsInput!名称
    txt用法.Tag = "1"
    
    With vsAdvice
        If lngPre用法ID <> Val(cmd用法.Tag) Then .TextMatrix(.Row, COL_单价) = ""
        '非输液类清除滴速
        If int类型 = 2 Then
            If NVL(rsInput!执行分类ID, 0) <> 1 And cbo滴速.Text <> "" Then
                cbo滴速.Text = ""
                cbo滴速.Tag = "1"
            End If
        End If
        
        '重新获取可用的缺省时间方案
        If cbo执行时间.Enabled Then '"可选频率"或药品时
            Call Get时间方案(cbo执行时间, Get频率范围(.Row), .TextMatrix(.Row, COL_频率), rsInput!ID)
            If cbo执行时间.ListCount > 0 Then
                Call Cbo.SetIndex(cbo执行时间.hwnd, 0)
                cbo执行时间.Tag = "1"
                
                If txt首日时间.Visible Then
                    txt首日时间.Text = "": txt首日时间.Tag = "1"
                End If
            Else
                '判断当前执行时间是否合法
                If cbo执行时间.Text <> "" Then
                    blnValid = ExeTimeValid(cbo执行时间.Text, Val(.TextMatrix(.Row, COL_频率次数)), Val(.TextMatrix(.Row, COL_频率间隔)), .TextMatrix(.Row, COL_间隔单位))
                    If Not blnValid Then '如果不合法,则另取,否则保持
                        cbo执行时间.Text = "": cbo执行时间.Tag = "1"
                        
                        If txt首日时间.Visible Then
                            txt首日时间.Text = "": txt首日时间.Tag = "1"
                        End If
                    End If
                ElseIf txt首日时间.Visible Then
                    txt首日时间.Text = "": txt首日时间.Tag = "1"
                End If
            End If
        End If
        
        '根据诊疗用法用量作缺省设置
        If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
            lng项目id = Val(.TextMatrix(.Row, COL_诊疗项目ID))
            If Val(.TextMatrix(.Row, COL_收费细目ID)) = 0 Then
                strSQL = "Select 频次,小儿剂量,成人剂量,医生嘱托,疗程 From 诊疗用法用量 Where 性质>0 And 项目ID=[1] And 用法ID=[2]"
            Else
                lng项目id = Val(.TextMatrix(.Row, COL_收费细目ID))
                strSQL = "Select 频次,小儿剂量,成人剂量,医生嘱托,疗程 From 药品用法用量 Where 药品ID=[1] And 用法ID=[2] And 性质=1"
            End If
            On Error GoTo errH
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng项目id, Val(rsInput!ID))
            If rsTmp.EOF Then
                '药品没有设置用法用量，则找给药途径的缺省频率（如果只设置了一个可用频率的话）,之前输入医嘱项目时设置的缺省频率是按编码排序取的第一个
                strSQL = "Select 频次 From 诊疗用法用量 Where 性质>0 And 项目ID=[1] Order by 频次"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!ID))
                bln用法频率 = rsTmp.RecordCount > 0
            Else
                bln用法用量 = True
            End If
            
            If bln用法用量 Or bln用法频率 Then
                If Not IsNull(rsTmp!频次) And Val(.TextMatrix(.Row, COL_频率性质)) <> 1 Then '已为一次性时不管
                    Call Get频率信息_编码(rsTmp!频次, str频率, int频率次数, int频率间隔, str间隔单位)
                    txt频率.Text = str频率
                    cmd频率.Tag = str频率
                    txt频率.Tag = "1"
                End If
                
                '根据新的频率重新设置执行时间
                If cbo执行时间.Enabled Then
                    Call Get时间方案(cbo执行时间, Get频率范围(.Row), str频率, rsInput!ID)
                    If cbo执行时间.ListCount > 0 Then
                        Call Cbo.SetIndex(cbo执行时间.hwnd, 0)
                        cbo执行时间.Tag = "1"
                        
                        If txt首日时间.Visible Then
                            txt首日时间.Text = "": txt首日时间.Tag = "1"
                        End If
                    Else
                        '判断当前执行时间是否合法
                        If cbo执行时间.Text <> "" Then
                            blnValid = ExeTimeValid(cbo执行时间.Text, int频率次数, int频率间隔, str间隔单位)
                            If Not blnValid Then '如果不合法,则另取,否则保持
                                cbo执行时间.Text = "": cbo执行时间.Tag = "1"
                                
                                If txt首日时间.Visible Then
                                    txt首日时间.Text = "": txt首日时间.Tag = "1"
                                End If
                            End If
                        ElseIf txt首日时间.Visible Then
                            txt首日时间.Text = "": txt首日时间.Tag = "1"
                        End If
                    End If
                End If
                
                If bln用法用量 Then
                    '药品单量
                    If mint年龄 > 12 Then
                        If NVL(rsTmp!成人剂量, 0) <> 0 Then
                            txt单量.Text = FormatEx(rsTmp!成人剂量, 5)
                            txt单量.Tag = "1"
                        End If
                    Else
                        If NVL(rsTmp!小儿剂量, 0) <> 0 Then
                            txt单量.Text = FormatEx(rsTmp!小儿剂量, 5)
                            txt单量.Tag = "1"
                        ElseIf NVL(rsTmp!成人剂量, 0) <> 0 Then
                            txt单量.Text = FormatEx(rsTmp!成人剂量 * (mint年龄 + 2) * 5 / 100, 5)
                            txt单量.Tag = "1"
                        End If
                    End If
                    
                    '药品临嘱总量:住院包装
                    If .TextMatrix(.Row, COL_期效) = "临嘱" And Val(.TextMatrix(.Row, COL_频率性质)) <> 1 Then
                        '取缺省的天数
                        sng天数 = msng天数
                        If mbln天数 Then
                            If str间隔单位 = "周" Then
                                sng天数 = IIF(7 > sng天数, 7, sng天数)
                            ElseIf str间隔单位 = "天" Then
                                sng天数 = IIF(int频率间隔 > sng天数, int频率间隔, sng天数)
                            ElseIf str间隔单位 = "小时" Then
                                sng天数 = IIF(int频率间隔 \ 24 > sng天数, int频率间隔 \ 24, sng天数)
                            ElseIf str间隔单位 = "分钟" Then
                                If sng天数 = 0 Then sng天数 = 1
                            End If
                            If sng天数 = 0 Then sng天数 = 1
                        End If
                        If NVL(rsTmp!疗程, 1) > sng天数 Then
                            sng天数 = NVL(rsTmp!疗程, 1)
                        End If
                        If Val(.TextMatrix(.Row, COL_天数)) > sng天数 Then
                            sng天数 = Val(.TextMatrix(.Row, COL_天数))
                        End If
                        If Val(.TextMatrix(.Row, COL_天数)) <> sng天数 Then
                            txt天数.Text = sng天数
                            txt天数.Tag = "1"
                        End If
                        
                        If str频率 <> "" And Val(txt单量.Text) <> 0 _
                            And Val(.TextMatrix(.Row, COL_剂量系数)) <> 0 _
                            And Val(.TextMatrix(.Row, COL_住院包装)) <> 0 Then
                                                    
                            txt总量.Text = FormatEx(Calc缺省药品总量( _
                                Val(txt单量.Text), sng天数, _
                                int频率次数, int频率间隔, str间隔单位, _
                                .TextMatrix(.Row, COL_执行时间), _
                                Val(.TextMatrix(.Row, COL_剂量系数)), _
                                Val(.TextMatrix(.Row, COL_住院包装)), _
                                Val(.TextMatrix(.Row, COL_可否分零))), 5)
                            If InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") = 0 Then
                                txt总量.Text = IntEx(Val(txt总量.Text))
                            ElseIf Val(.TextMatrix(.Row, COL_可否分零)) <> 0 Then
                                txt总量.Text = IntEx(Val(txt总量.Text))
                            End If
                            txt总量.Tag = "1"
                        End If
                    End If
                    
                    '医生嘱托
                    If Not IsNull(rsTmp!医生嘱托) Then
                        cbo医生嘱托.Text = rsTmp!医生嘱托
                        cbo医生嘱托.Tag = "1"
                    End If
                End If
            End If
        End If
    End With
    
    '处理当前医嘱给药途径/煎法的变化
    Call AdviceChange
    
    '改变了给药途径，可能以前选择的执行科室不可用了（如：输液配置中心）
    If cbo执行科室.ListCount > 0 And cbo执行科室.ListIndex = -1 Then cbo执行科室.ListIndex = 0 '引发click事件
    
    '对保险对码进行检查
    Call GetInsureStr(strIDs1, strIDs2, str医嘱内容, vsAdvice.Row)
    strMsg = CheckAdviceInsure(mint险类, mbln提醒对码, mlng病人ID, mlng病人性质, strIDs1, strIDs2, str医嘱内容, mlng病人病区ID)
    If strMsg <> "" Then
        If gint医保对码 = 2 Then strMsg = strMsg & vbCrLf & vbCrLf & "请先和相关人员联系处理，否则医嘱将不允许保存。"
        vMsg = frmMsgBox.ShowMsgBox(strMsg, Me, True)
        If vMsg = vbIgnore Then mbln提醒对码 = False
    End If
    If int类型 = 2 Then mbln刚录入 = True
 
    '如果将一并给药的给药途径设为的输液则设置默认药房
    With vsAdvice
        lngRow = .Row
        If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 And RowIn一并给药(lngRow) And cbo滴速.Visible And gstr输液配置中心 <> "" Then
            Call Get一并给药范围(Val(.TextMatrix(lngRow, COL_相关ID)), lngBegin, lngEnd)
            If .TextMatrix(lngEnd + 1, COL_操作类型) = "2" And Val(.TextMatrix(lngEnd + 1, COL_执行分类)) = 1 Then
                arrTmp = Array()
                For i = lngBegin To lngEnd
                    '自备药不管它
                    If Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                        str药房IDs = Get可用药房IDs(.TextMatrix(i, COL_类别), Val(.TextMatrix(i, COL_诊疗项目ID)), Val(.TextMatrix(i, COL_收费细目ID)), mlng病人科室id, 2)
                        ReDim Preserve arrTmp(UBound(arrTmp) + 1)
                        arrTmp(UBound(arrTmp)) = str药房IDs
                    End If
                Next
                arrTmp1 = Split(gstr输液配置中心, ",")
                For i = 0 To UBound(arrTmp1)
                    lngCnt = 0
                    For j = 0 To UBound(arrTmp)
                        If InStr("," & arrTmp(j) & ",", "," & arrTmp1(i) & ",") > 0 Then
                            lngCnt = lngCnt + 1
                        End If
                    Next
                    If lngCnt = UBound(arrTmp) + 1 Then
                        lng科室id = arrTmp1(i)
                        Exit For
                    End If
                Next
                If lng科室id <> 0 Then
                    For i = lngBegin To lngEnd
                        '自备药不管它
                        If Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                            .TextMatrix(i, COL_执行科室ID) = lng科室id
                            .TextMatrix(i, COL_执行科室) = Sys.RowValue("部门表", lng科室id, "名称")
                        End If
                    Next
                    Call vsAdvice_AfterRowColChange(-1, -1, lngRow, vsAdvice.Col)
                End If
            End If
        End If
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub Set频率Input(rsInput As ADODB.Recordset, ByVal int范围 As Integer, ByVal int项目频率 As Integer)
'功能：输入执行频率后调用
'参数：rsInput=输入或选择的返回记录
'      int范围=1-西医;2-中医;-1-一次性;-2-持续性,-3-必要时，-5-需要时
'      int项目频率=项目本身的执行频率属性
'说明：配合用法处理可用执行时间方案的变化
    Dim lng用法ID As Long, blnValid As Boolean
    Dim sng天数 As Single, str原总量 As String
    Dim str原执行时间 As String, str原天数 As String
    Dim str原首日时间 As String, blnTemp As Boolean, i As Long
    
    str原执行时间 = cbo执行时间.Text
    str原首日时间 = txt首日时间.Text
    str原天数 = txt天数.Text
    str原总量 = txt总量.Text
    With vsAdvice

        '备用医嘱的执行频率和已执行一致。
        .TextMatrix(.Row, COL_频率性质) = Decode(int范围, 1, 0, 2, 0, -1, 1, -2, 2, -3, 1, -5, 1)
        If RowIn检验行(.Row) Or int范围 = -3 Or int范围 = -5 Then '同步赋值,因为后续以检验项目的执行性质作判断
            For i = .Row - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(.Row) Then
                    .TextMatrix(i, COL_频率性质) = .TextMatrix(.Row, COL_频率性质)
                Else
                    Exit For
                End If
            Next
        End If
        
        '当项目频率为 一次性或持续性时 清空执行时间
        If int项目频率 = 1 Or int项目频率 = 2 Then
            .TextMatrix(.Row, COL_执行时间) = ""
        End If
        
        cmd频率.Tag = rsInput!名称
        txt频率.Text = rsInput!名称
        txt频率.Tag = "1"
        
        '先设置临嘱药品天数的可用性
        If mbln天数 And cbo期效.ListIndex = 1 And InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
            If Val(.TextMatrix(.Row, COL_频率性质)) = 1 Then
                If txt天数.Enabled Then SetDayState -1, -1
            Else
                If Not txt天数.Enabled Then SetDayState 1, 1
            End If
        End If
        
        '先设置总量的可用性:临嘱"计次"可选频率的设置为一次性后不输入总量(除药品外)
        If cbo期效.ListIndex = 1 And InStr(",5,6,", .TextMatrix(.Row, COL_类别)) = 0 And Not RowIn配方行(.Row) Then
            If Val(.TextMatrix(.Row, COL_计算方式)) = 3 And int项目频率 = 0 Then
                If txt总量.Enabled And Val(.TextMatrix(.Row, COL_频率性质)) = 1 Then
                    SetItemEditable , -1
                    txt总量.Text = "1"
                ElseIf Not txt总量.Enabled And Val(.TextMatrix(.Row, COL_频率性质)) = 0 Then
                    SetItemEditable , 1
                End If
                lbl总量单位.Caption = .TextMatrix(.Row, COL_总量单位)
            End If
        End If
        
        '先设置执行时间的可用性(临嘱可选频率项目可能在一次性之间切换,及分钟频率切换)
        If int项目频率 = 0 And Decode(int范围, 1, 0, 2, 0, -1, 1, -2, 2, -3, 1, -5, 1) <> 1 Then
            If Not cbo执行时间.Enabled Then SetItemEditable , , , , 1
            
            '首日时间：按天、周频率的长期医嘱
            blnTemp = False
            If cbo期效.ListIndex = 0 And (rsInput!间隔单位 & "" = "周" Or rsInput!间隔单位 & "" = "天") And rsInput!频率间隔 = 1 Then
                blnTemp = True
            End If
        
            If blnTemp And Not txt首日时间.Visible Then
                SetItemEditable , , , , , , , , , , , , 1
            ElseIf Not blnTemp And txt首日时间.Visible Then
                SetItemEditable , , , , , , , , , , , , -1
                txt首日时间.Tag = "1" '内容被清除
            End If
            lbl首日时间.Caption = Decode(rsInput!间隔单位 & "", "周", "↓首周", "↓首日")
        Else
            If cbo执行时间.Enabled Then SetItemEditable , , , , -1
        End If
        If cbo执行时间.Enabled Then '"可选频率"或药品时
            If rsInput!间隔单位 & "" = "分钟" Then
                cbo执行时间.Text = ""
            Else
                '处理可用执行时间方案的变化
                If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                    '查找给药途径对应的行
                    lng用法ID = .FindRow(CLng(.TextMatrix(.Row, COL_相关ID)), .Row + 1)
                    If lng用法ID <> -1 Then '未找到给药途径的情况,应该不可能
                        lng用法ID = .TextMatrix(lng用法ID, COL_诊疗项目ID)
                    Else
                        lng用法ID = 0
                    End If
                ElseIf RowIn配方行(.Row) Then
                    '得到对应的中药用法ID
                    lng用法ID = Val(.TextMatrix(.Row, COL_诊疗项目ID))
                End If
                
                Call Get时间方案(cbo执行时间, int范围, txt频率.Text, lng用法ID)
                '取新的频率的默认执行时间
                If cbo执行时间.ListCount > 0 Then
                    Call Cbo.SetIndex(cbo执行时间.hwnd, 0)
                    cbo执行时间.Tag = "1"
                    
                    If txt首日时间.Visible Then
                        txt首日时间.Text = "": txt首日时间.Tag = "1"
                    End If
                Else
                    '判断当前执行时间是否合法
                    If cbo执行时间.Text <> "" Then
                        blnValid = ExeTimeValid(cbo执行时间.Text, rsInput!频率次数, rsInput!频率间隔, rsInput!间隔单位 & "")
                        If Not blnValid Then '如果不合法,则另取,否则保持
                            cbo执行时间.Text = "": cbo执行时间.Tag = "1"
                            
                            If txt首日时间.Visible Then
                                txt首日时间.Text = "": txt首日时间.Tag = "1"
                            End If
                        End If
                    ElseIf txt首日时间.Visible Then
                        txt首日时间.Text = "": txt首日时间.Tag = "1"
                    End If
                End If
            End If
            
            '重新计算总量
            If mbln天数 And InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 _
                And .TextMatrix(.Row, COL_期效) = "临嘱" And Val(.TextMatrix(.Row, COL_频率性质)) <> 1 Then
                sng天数 = Val(txt天数.Text)
                If sng天数 = 0 Then sng天数 = 1
                
                If txt频率.Text <> "" And Val(txt单量.Text) <> 0 _
                    And Val(.TextMatrix(.Row, COL_剂量系数)) <> 0 _
                    And Val(.TextMatrix(.Row, COL_住院包装)) <> 0 Then
                    
                    txt总量.Text = FormatEx(Calc缺省药品总量( _
                        Val(txt单量.Text), sng天数, rsInput!频率次数, _
                        rsInput!频率间隔, rsInput!间隔单位 & "", cbo执行时间.Text, _
                        Val(.TextMatrix(.Row, COL_剂量系数)), _
                        Val(.TextMatrix(.Row, COL_住院包装)), _
                        Val(.TextMatrix(.Row, COL_可否分零))), 5)
                    If InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") = 0 Then
                        txt总量.Text = IntEx(Val(txt总量.Text))
                    ElseIf Val(.TextMatrix(.Row, COL_可否分零)) <> 0 Then
                        txt总量.Text = IntEx(Val(txt总量.Text))
                    End If
                    txt总量.Tag = "1"
                End If
            End If
        End If
        If rsInput!间隔单位 & "" = "分钟" Then
            If cbo执行时间.Enabled Then SetItemEditable , , , , -1
        End If
    
    
        '检查总量,天数,执行时间是否变化
        If txt总量.Text <> str原总量 Then txt总量.Tag = "1"
        If txt天数.Text <> str原天数 Then txt天数.Tag = "1"
        If cbo执行时间.Text <> str原执行时间 Then cbo执行时间.Tag = "1"
        If txt首日时间.Text <> str原首日时间 Then txt首日时间.Tag = "1"
        
        '处理当前医嘱执行频率的变化
        Call AdviceChange
    End With
End Sub

Private Sub cbo医生_GotFocus()
    Call zlControl.TxtSelAll(cbo医生)
End Sub

Private Sub cbo医生_Validate(Cancel As Boolean)
'功能：根据输入的内容,自动匹配执行科室
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, intIdx As Long, i As Long
    Dim strInput As String
    Dim vRect As RECT, blnCancel As Boolean
        
    If cbo医生.ListIndex <> -1 Then Exit Sub '已选中
    If vsAdvice.RowData(vsAdvice.Row) = 0 Then '无医嘱
        cbo医生.Text = "": Exit Sub
    End If
    If cbo医生.Text = "" Then '无输入
        If vsAdvice.TextMatrix(vsAdvice.Row, COL_开嘱医生) = "" Then Cancel = True
        Exit Sub
    End If
    
    strInput = UCase(zlCommFun.GetNeedName(cbo医生.Text))
    '全院住院科室的医生
    strSQL = "Select Distinct 部门ID From 部门性质说明 Where 服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3)"
    strSQL = "Select Distinct A.ID,A.编号,A.姓名,A.简码" & _
        " From 人员表 A,部门人员 B,人员性质说明 C" & _
        " Where A.ID=B.人员ID And A.ID=C.人员ID And C.人员性质='医生'" & _
        " And (A.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or A.撤档时间 Is Null)" & _
        " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
        " And B.部门ID IN(" & strSQL & ")" & _
        " And (A.编号 Like [1] Or A.姓名 Like [2] Or A.简码 Like [2])" & _
        " Order by A.简码"
    
    On Error GoTo errH
    vRect = zlControl.GetControlRect(cbo医生.hwnd)
    Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl开嘱医生.Caption, False, "", "", False, False, _
        True, vRect.Left, vRect.Top, cbo医生.Height, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%")
    If Not rsTmp Is Nothing Then
        intIdx = Cbo.FindIndex(cbo医生, rsTmp!ID)
        If intIdx <> -1 Then
            cbo医生.ListIndex = intIdx
        Else
            cbo医生.AddItem NVL(rsTmp!简码) & "-" & Chr(13) & rsTmp!姓名, cbo医生.ListCount - 1
            cbo医生.ItemData(cbo医生.NewIndex) = rsTmp!ID
            cbo医生.ListIndex = cbo医生.NewIndex
        End If
    Else
        If Not blnCancel Then
            MsgBox "未找到对应的医生。", vbInformation, gstrSysName
        End If
        Cancel = True: Exit Sub
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cbo执行时间_LostFocus()
    If Not mblnIsInHelp Then picHelp.Visible = False
    mblnIsInHelp = False
End Sub

Private Sub cbsMain_GetClientBordersWidth(Left As Long, Top As Long, Right As Long, Bottom As Long)
    If Me.stbThis.Visible Then Bottom = Me.stbThis.Height
End Sub

Private Sub cbsMain_InitCommandsPopup(ByVal CommandBar As XtremeCommandBars.ICommandBar)
    Dim strTmp As String
    Dim arrTmp As Variant
    Dim i As Long
    Dim objControl As CommandBarControl
    Dim blnDo As Boolean
    
    If CommandBar Is Nothing Then Exit Sub
    If CommandBar.Parent Is Nothing Then Exit Sub
    Select Case CommandBar.Parent.ID
    Case conMenu_Tool_PlugIn
        Call CreatePlugInOK(IIF(mint场合 = 1, p住院医嘱发送, p住院医嘱下达), mint场合)
        If Not gobjPlugIn Is Nothing Then
            On Error Resume Next
            If mint场合 = 0 Then '医生站调用
                strTmp = gobjPlugIn.GetFuncNames(glngSys, p住院医嘱下达, 0)
            ElseIf mint场合 = 1 Then '护士站调用
                strTmp = gobjPlugIn.GetFuncNames(glngSys, p住院医嘱发送, 1)
            ElseIf mint场合 = 2 Then '医技站调用
                strTmp = gobjPlugIn.GetFuncNames(glngSys, p住院医嘱下达, 2)
            End If
            Call zlPlugInErrH(err, "GetFuncNames")
            err.Clear: On Error GoTo 0
        End If
        If strTmp <> "" Then
            With CommandBar.Controls
                If .Count = 0 Then
                    strTmp = Replace(strTmp, "Auto:", "")
                    arrTmp = Split(strTmp, ",")
                    For i = 0 To UBound(arrTmp)
                        Set objControl = .Add(xtpControlButton, conMenu_Tool_PlugIn_Item + i + 1, CStr(arrTmp(i)))
                        If i <= 9 Then objControl.Caption = objControl.Caption & "(&" & IIF(i = 9, 0, i + 1) & ")"
                        objControl.IconId = conMenu_Tool_PlugIn_Item
                        objControl.Parameter = arrTmp(i)
                    Next
                End If
            End With
        End If
    End Select
End Sub

Private Sub cbsMain_Resize()
    Dim lngLeft As Long, lngTop  As Long, lngRight  As Long, lngBottom  As Long
    Call Me.cbsMain.GetClientRect(lngLeft, lngTop, lngRight, lngBottom)
    
    On Error Resume Next
    
    fraPati.Left = lngLeft
    fraPati.Top = lngTop
    fraPati.Width = lngRight - lngLeft
    fraPati.Height = cmdAlley.Top + cmdAlley.Height + 60
    
    vsAdvice.Left = lngLeft
    vsAdvice.Top = fraPati.Top + fraPati.Height
    vsAdvice.Height = lngBottom - lngTop - fraPati.Height - (fraAdvice.Height - 80) - IIF(pic疑问.Visible, pic疑问.Height, 0)
    vsAdvice.Width = lngRight - lngLeft
    
    pic疑问.Left = 0
    pic疑问.Top = vsAdvice.Top + vsAdvice.Height
    pic疑问.Width = vsAdvice.Width
    lbl疑问.Width = pic疑问.ScaleWidth - lbl疑问.Left - 45
    
    fraAdvice.Left = lngLeft
    fraAdvice.Top = vsAdvice.Top + (vsAdvice.Height - 80) + IIF(pic疑问.Visible, pic疑问.Height, 0)
    fraAdvice.Width = lngRight - lngLeft
    
    stbThis.Top = lngBottom
    stbThis.Width = picSub.ScaleWidth
    
    fraColSel.Left = vsAdvice.Left + 70
    fraColSel.Top = vsAdvice.Top + 60
    
    tbrFree.Left = lbl医嘱内容.Left + lbl医嘱内容.Width - 200 - tbrFree.ButtonWidth
    tbrFree.Top = lbl医嘱内容.Top + lbl医嘱内容.Height + 100
End Sub

Private Sub SetControlVisible(ByVal Control As CommandBarControl)
'功能：根据权限设置菜单和工具栏的可见状态
    Dim blnVisible As Boolean
    Dim strTmp As String
    
    '权限只需判断一次,已经判断过的命令不用再判断
    If Control.Category = "已判断" And Control.ID <> conMenu_SendBilling Then Exit Sub
    blnVisible = True
        
    '------------------------------------------------------------------------------
    Select Case Control.ID
    Case conMenu_Stop
        '显示停止医嘱
        If InStr(GetInsidePrivs(p住院医嘱下达), "医嘱停止") = 0 Then blnVisible = False
        
    Case conMenu_Send  '没有临嘱发送权限时（也就没有发送门诊收费权限），是创建的conMenu_Edit_SendBilling
        If mint场合 = 1 Then blnVisible = False '护士站不可用
    Case conMenu_SendBilling '门诊记帐或住院记帐
        If mint场合 = 1 Then blnVisible = False '护士站不可用
        
        If blnVisible Then
            If mlng病人性质 = 1 Then  '发送住院记帐没有单独控制权限
                If InStr(GetInsidePrivs(p住院医嘱下达), ";发送门诊记帐;") = 0 Then blnVisible = False
            Else
                If InStr(GetInsidePrivs(p住院医嘱下达), ";临嘱发送;") = 0 Then blnVisible = False
            End If
        End If
    Case conMenu_Report_AdviceBill1
        blnVisible = False
        If mlngPrintType = 1 Then
            If InStr(UserInfo.性质, "医生") > 0 Then
                If InStr(GetInsidePrivs(p住院医嘱下达), "长期医嘱单") > 0 Or InStr(GetInsidePrivs(p住院医嘱下达), "临时医嘱单") > 0 Then
                    blnVisible = True
                End If
            End If
            If Not blnVisible Then
                If InStr(UserInfo.性质, "护士") > 0 Then
                    If InStr(GetInsidePrivs(p住院医嘱发送), "长期医嘱单") > 0 Or InStr(GetInsidePrivs(p住院医嘱发送), "临时医嘱单") > 0 Then
                        blnVisible = True
                    End If
                End If
            End If
        End If
    Case conMenu_SendCharge
        If mint场合 = 1 Then blnVisible = False '护士站不可用
        If blnVisible Then
            If InStr(GetInsidePrivs(p住院医嘱下达), ";发送门诊费用;") = 0 Then blnVisible = False
        End If
    
    Case conMenu_Sign
        If mint场合 = 1 Or InStr(UserInfo.性质, "医生") = 0 Or gobjESign Is Nothing _
            Or InStr(GetInsidePrivs(p住院医嘱下达), ";医嘱下达;") = 0 Or Not mblnHaveAuditPriv Then
            blnVisible = False
        ElseIf mint场合 = 0 Then
            If CheckSign(1, 0, mlng医技科室ID, mlng病人科室id, 2, False, gobjESign) = False Then
                blnVisible = False '不同场合没有设置要使用签名
            End If
        ElseIf mint场合 = 2 Then
            If CheckSign(3, 0, mlng医技科室ID, mlng病人科室id, 2, False, gobjESign) = False Then
                blnVisible = False '不同场合没有设置要使用签名
            End If
        End If
    Case conMenu_Reference
        If GetInsidePrivs(p药品诊疗参考) = "" Then blnVisible = False
      
    Case conMenu_Scheme, conMenu_Scheme * 10# + 1, conMenu_Scheme * 10# + 2
        If InStr(GetInsidePrivs(p住院医嘱下达), "保存成套方案") = 0 Then blnVisible = False
    Case conMenu_AltAdvice
        If mbytUseType = 1 Then
            blnVisible = True
        Else
            blnVisible = False
        End If
    Case conMenu_Agent
        If (Not mblnAddAgent) Or (mbytUseType = 3) Then
            blnVisible = False
        Else
            strTmp = GetTsPrivs(p住院医嘱下达)
            blnVisible = InStr(strTmp, "下达麻醉药嘱") > 0 Or InStr(strTmp, "下达毒性药嘱") > 0 Or InStr(strTmp, "下达精神药嘱") > 0
        End If
    End Select

    Control.Visible = blnVisible
    Control.Category = "已判断"
End Sub

Private Sub cbsMain_Update(ByVal Control As XtremeCommandBars.ICommandBarControl)
    Dim blnEnabled As Boolean, lngRow As Long
    Dim vRect As RECT, vPos As PointAPI, blnOther As Boolean
    
    If vsAdvice.Redraw = flexRDNone Then Exit Sub
    
    'PASS 可用性 在独立部件中设置
    If Between(Control.ID, conMenu_Edit_MediAudit * 10#, conMenu_Edit_MediAudit * 10# + 99) Then
        Exit Sub
    End If
     '根据权限设置按钮可见状态
    Call SetControlVisible(Control)
    If Not Control.Visible Then Exit Sub
    
    
     '临床路径调用(允许使用一并),调整顺序
    If mbytUseType = 1 And Control.ID <> conMenu_Merge Or mbytUseType = 3 Then
        Select Case Control.ID
            Case conMenu_Save '保存
                Control.Enabled = mblnNoSave
            Case conMenu_Reference
                If mbytUseType = 3 Then Control.Visible = False
            Case conMenu_Help, conMenu_Exit, conMenu_MoveUp, conMenu_MoveDown
                '只显示帮助和退出
            Case conMenu_DrugScale * 100# + 1 To conMenu_DrugScale * 100# + 99
            Case conMenu_AltAdvice
            '调整顺序时，固定显示停止的医嘱(按钮不显示)，因为那些医嘱序号要一起调整
'            Case conMenu_ShowStop   '显示停止的医嘱
'                Control.Visible = mbytUseType = 3
            Case conMenu_Sort
                Control.Visible = mbytUseType = 3
            Case Else
                Control.Visible = False
                blnOther = True
        End Select
    Else
        If mbytUseType = 2 Then '添加路径外项目
            Select Case Control.ID
                Case conMenu_Temp, conMenu_Sign, conMenu_Previous, conMenu_Next, conMenu_ShowStop, conMenu_Stop, conMenu_Send, conMenu_Scheme
                    Control.Visible = False
                    Exit Sub
            End Select
        End If
        
        Select Case Control.ID
            Case conMenu_Previous
                If txtPati.Locked Then
                    Control.Visible = False
                ElseIf Not lvwPati.Visible And lvwPati.ListItems.Count > 0 Then
                    '未读取病区其他人员之前可用
                    Control.Enabled = lvwPati.SelectedItem.Index > 1 Or mblnRefresh = False
                End If
            Case conMenu_Next
                If txtPati.Locked Then
                    Control.Visible = False
                    If cbsMain(2).Controls(Control.Index + 1).BeginGroup Then
                        cbsMain(2).Controls(Control.Index + 1).BeginGroup = False
                    End If
                ElseIf Not lvwPati.Visible And lvwPati.ListItems.Count > 0 Then
                    Control.Enabled = lvwPati.SelectedItem.Index < lvwPati.ListItems.Count Or mblnRefresh = False
                End If
            Case conMenu_ShowStop
                Control.Checked = mblnShowStop
            Case conMenu_Insert
                blnEnabled = True
                With vsAdvice
                    If Not fraAdvice.Enabled Then
                        If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 _
                            And Val(.TextMatrix(.Row, COL_相关ID)) = Val(.TextMatrix(.Row - 1, COL_相关ID)) Then
                            blnEnabled = False
                        End If
                    End If
                    
                    '临床路径生成的项目，不允许在一并给药的中间插入行
                    If mbytUseType = 0 And blnEnabled Then
                        If blnEnabled And Val(.TextMatrix(.Row, COL_路径执行ID)) <> 0 Then
                            If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 _
                                And Val(.TextMatrix(.Row, COL_相关ID)) = Val(.TextMatrix(.Row - 1, COL_相关ID)) Then
                                blnEnabled = False
                            End If
                        End If
                    End If
                End With
                
                Control.Enabled = blnEnabled
            Case conMenu_Delete
                With vsAdvice
                    blnEnabled = True
                    If .RowData(.Row) <> 0 Then
                        If Not fraAdvice.Enabled And Val(.TextMatrix(.Row, COL_审核状态)) <> 2 Then blnEnabled = False
                        If Not fraAdvice.Enabled And Val(.TextMatrix(.Row, COL_审核状态)) = 2 And .TextMatrix(.Row, COL_类别) = "K" And gbln血库系统 Then blnEnabled = False
                        If .TextMatrix(.Row, COL_类别) = "K" And Val(.TextMatrix(.Row, COL_检查方法)) = 1 Then blnEnabled = False
                        If InStr(",1,2,-1,", .TextMatrix(.Row, COL_状态)) = 0 Then blnEnabled = False
                        '已签名医嘱不可删除
                        If Val(.TextMatrix(.Row, COL_签名否)) = 1 Then blnEnabled = False
                    End If
                    Control.Enabled = blnEnabled
                End With
            Case conMenu_Report_AdviceBill1
                Control.Enabled = True
            Case conMenu_Stop
                With vsAdvice
                    blnEnabled = True
                    If .RowData(.Row) = 0 Then blnEnabled = False
                    If InStr(",-1,1,2,4,8,9,", Val(.TextMatrix(.Row, COL_状态))) > 0 Then blnEnabled = False
                    If .TextMatrix(.Row, COL_期效) <> "长嘱" Then blnEnabled = False
                    'If RowIn配方行(.Row) Then blnEnabled = False
                    Control.Enabled = blnEnabled
                End With
                        Case conMenu_Edit_ViewDrugExplain '查看药品说明书
                Control.Enabled = vsAdvice.RowData(vsAdvice.Row) <> 0 And InStr(",5,6,7,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) > 0
            Case conMenu_Merge
                Control.Checked = mblnRowMerge
                blnEnabled = True
                If Not fraAdvice.Enabled Then blnEnabled = False
                
                '临床路径生成的项目（包括添加的路径外项目），不允许再改变一并给药的状态
                If mbytUseType = 0 And blnEnabled Then
                    If Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_路径执行ID)) <> 0 Then
                        blnEnabled = False
                    End If
                End If
                
                Control.Enabled = blnEnabled
            Case conMenu_Scheme, conMenu_Scheme * 10# + 1, conMenu_Scheme * 10# + 2
                                If mblnModal Then
                        Control.Visible = False
                Else
                If Control.ID = conMenu_Scheme * 10# + 2 Then
                    Control.Caption = IIF(mfrmShortCut.Visible, "隐藏", "显示") & "成套方案选择器"
                End If
                End If
            Case conMenu_SendBilling   '发送
                If InStr(GetInsidePrivs(p住院医嘱下达), "发送门诊费用") > 0 Then
                    If mlng病人性质 = 1 Then    '门诊留观病人，只能发送为门诊记帐单
                        Control.Caption = "门诊记帐"
                    Else
                        Control.Caption = "住院记帐"
                    End If
                End If
            Case conMenu_Save '保存：有暂存的医嘱，或者有变动的医嘱(已保存或暂存的)
                Control.Enabled = vsAdvice.FindRow("-1", , COL_状态) <> -1 Or mblnNoSave
            Case conMenu_Temp '暂存：暂存记录有增、删、改
                If mbln暂存 Then
                    lngRow = vsAdvice.FindRow("-1", , COL_状态)
                    blnEnabled = (lngRow <> -1 Or mstrDelTempIDs <> "") And mblnNoSave
                    If blnEnabled And mstrDelTempIDs = "" Then
                        blnEnabled = False
                        Do While lngRow <> -1
                            If Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) <> 0 Then blnEnabled = True: Exit Do
                            lngRow = vsAdvice.FindRow("-1", lngRow + 1, COL_状态)
                        Loop
                    End If
                    Control.Enabled = blnEnabled
                Else
                    Control.Visible = False
                End If
            Case Else
                blnOther = True
        End Select
        
        '审核时的设置
        If mbln审核 Then
            If Control.ID = conMenu_Save Then
                Control.Caption = "完成审核"
                Control.ToolTipText = "完成审核并退出"
            ElseIf Control.ID = conMenu_Previous Or Control.ID = conMenu_Next _
                Or Control.ID = conMenu_ShowStop Or Control.ID = conMenu_Stop Then
                Control.Visible = False
            End If
        ElseIf mint场合 <> 1 Then
            If Control.ID = conMenu_Stop Or Control.ID = conMenu_Sign Then
                If Not mblnHaveAuditPriv Then Control.Visible = False
            End If
        End If
    End If
    
    If blnOther Then
        '单量显示状态
        blnEnabled = False
        If txt单量.Enabled Then
            If InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) > 0 Then
                GetCursorPos vPos
                GetWindowRect fraAdvice.hwnd, vRect
                If Between(vPos.X * Screen.TwipsPerPixelX, vRect.Left * Screen.TwipsPerPixelX + lbl单量.Left, vRect.Left * Screen.TwipsPerPixelX + lbl单量.Left + lbl单量.Width) Then
                    If Between(vPos.Y * Screen.TwipsPerPixelY, vRect.Top * Screen.TwipsPerPixelY + lbl单量.Top, vRect.Top * Screen.TwipsPerPixelY + lbl单量.Top + lbl单量.Height) Then
                        blnEnabled = True
                    End If
                End If
            End If
        End If
        Call SetLBLFace(lbl单量, blnEnabled)
        
        
        '首日显示状态
        blnEnabled = False
        If txt首日时间.Visible Then
            If InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) > 0 Then
                GetCursorPos vPos
                GetWindowRect fraAdvice.hwnd, vRect
                If Between(vPos.X * Screen.TwipsPerPixelX, vRect.Left * Screen.TwipsPerPixelX + lbl首日时间.Left, vRect.Left * Screen.TwipsPerPixelX + lbl首日时间.Left + lbl首日时间.Width) Then
                    If Between(vPos.Y * Screen.TwipsPerPixelY, vRect.Top * Screen.TwipsPerPixelY + lbl首日时间.Top, vRect.Top * Screen.TwipsPerPixelY + lbl首日时间.Top + lbl首日时间.Height) Then
                        blnEnabled = True
                    End If
                End If
            End If
        End If
        Call SetLBLFace(lbl首日时间, blnEnabled)
    End If
End Sub

Private Sub chkStop_Click()
    If Not mblnDoCheck Then Exit Sub
    
    '更新数据
    chkStop.Tag = "1"
    Call AdviceChange
End Sub

Private Sub chkStop_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call SeekNextControl
    End If
End Sub

Private Sub cmdAlley_Click()
'功能：对病人过敏史/病生状态进行管理
    'Pass
    If mblnPass Then
        Call gobjPass.zlPassCmdAlleyManage(mobjPassMap)
    End If
End Sub

Private Sub cmdReason_Click()
    Call ReasonSelect("", 1)
    Call AdviceChange
End Sub

Private Sub cmdExcReason_Click()
    Call ReasonSelect("", 3)
    Call AdviceChange
End Sub

Private Function ReasonSelect(ByVal strFind As String, ByVal intType As Integer) As Boolean
'常用嘱托和抗菌用药理由选择器
'intType  1-抗菌用药理由，2-常用嘱托，3-超量说明
    Dim blnCancle As Boolean
    Dim strRetrun As String
    Dim lngLeft As Long, lngTop As Long
    Dim strName As String
    
    If intType = 1 Then
        lngLeft = txt用药理由.Left
        lngTop = txt用药理由.Top
        strName = "抗菌用药理由。"
    ElseIf intType = 2 Then
        lngLeft = cbo医生嘱托.Left
        lngTop = cbo医生嘱托.Top
        strName = "常用嘱托。"
    ElseIf intType = 3 Then
        lngLeft = txt超量说明.Left
        lngTop = txt超量说明.Top
        strName = "超量说明。"
    End If
    
    lngLeft = lngLeft + fraAdvice.Left + Me.Left
    lngTop = lngTop + fraAdvice.Top + Me.Top - 2600
    
    strRetrun = frmKssReasonSelect.ShowMe(Me, strFind, blnCancle, lngLeft, lngTop, intType)
    If Not blnCancle Then
        If strRetrun = "" Then
            If strFind = "" Then
                MsgBox "没有找到可用的" & strName, vbInformation, Me.Caption
            End If
        Else
            If intType = 1 Then
                txt用药理由.Text = strRetrun
            ElseIf intType = 2 Then
                cbo医生嘱托.Text = strRetrun
            ElseIf intType = 3 Then
                txt超量说明.Text = strRetrun
            End If
        End If
    End If
    ReasonSelect = blnCancle
End Function

Private Sub ReasonSave(ByVal intType As Integer)
'功能：抗菌用药理由和超量说明保存
'参数：intType  0-抗菌用药理由，1-超量说明
    Dim strSQL As String, rsTmp As Recordset
    Dim strTmp As String
    Dim strPar As String
    
    If txt用药理由.Text = "" And intType = 0 Then MsgBox "请输入您需要收藏的用药理由。", vbInformation, Me.Caption: txt用药理由.SetFocus: Exit Sub
    If txt超量说明.Text = "" And intType = 1 Then MsgBox "请输入您需要收藏的超量说明。", vbInformation, Me.Caption: txt超量说明.SetFocus: Exit Sub
    
    If intType = 0 Then
        strPar = txt用药理由.Text
        strTmp = "用药理由"
    ElseIf intType = 1 Then
        strPar = txt超量说明.Text
        strTmp = "超量说明"
    End If
    
    On Error GoTo errH
    strSQL = "Select 1 From 医嘱常用原因 Where 名称=[1]"
    If intType = 1 Then strSQL = strSQL & " And 性质=1 And 人员=[2]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strPar, UserInfo.姓名)
    '如果已经有了，提示用户是否继续。
    If rsTmp.RecordCount > 0 Then
        MsgBox "已经存在相同的" & strTmp & "。", vbInformation, Me.Caption
        Exit Sub
    End If
    strSQL = "zl_医嘱常用原因_Update(0,Null,'" & strPar & "',Null" & _
        IIF(intType = 1, ",1,'" & UserInfo.姓名 & "'", "") & ")"
    zlDatabase.ExecuteProcedure strSQL, Me.Caption
    MsgBox strTmp & "收藏成功。", vbInformation, Me.Caption
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmd常用嘱托_Click()
    Dim strSQL As String, i As Integer
    Dim rsTmp As Recordset
    
    If Trim(cbo医生嘱托.Text) = "" Then
        MsgBox "请输入嘱托内容。", vbInformation, gstrSysName
        If cbo医生嘱托.Enabled Then cbo医生嘱托.SetFocus
        Exit Sub
    End If
    On Error GoTo errH
    strSQL = "Select 1 From 常用嘱托 Where 名称=[1] And (人员=[2] Or 人员 is null)"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Trim(cbo医生嘱托.Text), UserInfo.姓名)
    If rsTmp.RecordCount > 0 Then
        MsgBox "该嘱托内容已经在常用嘱托中。", vbInformation, gstrSysName
        If cbo医生嘱托.Enabled Then cbo医生嘱托.SetFocus
        Exit Sub
    End If
    
    
    strSQL = zlCommFun.zlGetSymbol(cbo医生嘱托.Text, CByte(mint简码))
    strSQL = "zl_常用嘱托_Insert('" & Replace(cbo医生嘱托.Text, "'", "''") & "','" & strSQL & "','" & UserInfo.姓名 & "')"
    Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
    
    MsgBox "已设置为常用嘱托。", vbInformation, gstrSysName
    If cbo医生嘱托.Enabled Then cbo医生嘱托.SetFocus
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmdZYRemark_Click()
    Dim strSQL As String, rsTmp As Recordset
    Dim vRect As RECT, blnCancel As Boolean
    
    If vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_超量说明) <> "" Then
        strSQL = "Select b.名称 as 分类,a.编码 as ID,a.编码,a.名称,a.简码 From 变异常见原因 a,变异常见原因 b" & _
                " Where a.性质=1 And a.末级=1 And a.上级=b.编码 And b.末级=0 " & _
                " Order by 分类,a.编码"
        vRect = zlControl.GetControlRect(txt超量说明.hwnd)
        Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, "变异常见原因", , , , , , True, vRect.Left, vRect.Top, txt超量说明.Height, blnCancel, , True)
        If rsTmp Is Nothing Then
            If Not blnCancel Then
                MsgBox "系统没有初始变异常见原因，请与系统管理员联系。", vbInformation, gstrSysName
                Exit Sub
            End If
        Else
            txt超量说明.Text = rsTmp!名称 & ""
            vsAdvice.TextMatrix(vsAdvice.Row, COL_超量说明) = rsTmp!名称 & ""
            vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_超量说明) = rsTmp!编码 & ""
        End If
        Call AdviceChange
    End If
End Sub

Private Sub cmd频率_Click()
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim str范围 As String, int频率 As Integer, vRect As RECT
    Dim strSeek As String, lng诊疗项目ID As Long, lngFind As Long
    
    On Error GoTo errH
    
    With vsAdvice
        If cbo期效.ListIndex = 1 Then
            int频率 = Get项目频率(.Row)
            If Not RowIn配方行(.Row) And int频率 = 0 Then
                str范围 = "1,-1" '临嘱可以为一次性
            Else
                str范围 = Get频率范围(.Row)
            End If
        Else
            str范围 = Get频率范围(.Row)
            int频率 = Decode(str范围, "1", 0, "2", 0, "-1", 1, "-2", 2, "-3", 1, "-5", 1)
        End If
        str范围 = str范围 & "," & IIF(cbo期效.ListIndex = 1, "-5", "-3")
        
        If txt频率.Text <> "" Then
            strSQL = "Select 编码 From 诊疗频率项目 Where 名称=[1] And Instr([2],','||适用范围||',')>0"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, txt频率.Text, "," & str范围 & ",")
            If Not rsTmp.EOF Then strSeek = rsTmp!编码
        End If
        
        '可选择频率的常用频率
        lng诊疗项目ID = Val(.TextMatrix(.Row, COL_诊疗项目ID))
        If RowIn检验行(.Row) Then
            lngFind = .FindRow(CStr(.RowData(.Row)), .FixedRows, COL_相关ID)
            If lngFind <> -1 Then
                lng诊疗项目ID = Val(.TextMatrix(lngFind, COL_诊疗项目ID))
            End If
        ElseIf InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
            lngFind = .FindRow(CLng(.TextMatrix(.Row, COL_相关ID)), .Row + 1)
            If lngFind <> -1 Then
                lng诊疗项目ID = Val(.TextMatrix(lngFind, COL_诊疗项目ID))
            End If
        End If
        strSQL = ""
        If InStr("," & str范围 & ",", ",1,") > 0 Then
            strSQL = " And (Exists(Select 1 From 诊疗用法用量 Where 项目ID=[2] And 用法ID is NULL And 频次=A.编码 And A.适用范围=1)" & _
                " Or (Select Count(*) From 诊疗用法用量 Where 项目ID=[2] And 用法ID is NULL And 频次 Is Not NULL)<=1)"
        End If
        strSQL = _
            " Select Rownum as ID,A.编码,A.名称,A.简码," & _
            " A.英文名称,A.频率次数,A.频率间隔,A.间隔单位,A.适用范围 as 范围ID" & _
            " From 诊疗频率项目 A" & _
            " Where Instr([1],','||A.适用范围||',')>0" & strSQL & _
            " Order by A.适用范围,A.编码"
        vRect = zlControl.GetControlRect(txt频率.hwnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, "诊疗频率", False, strSeek, "", False, False, True, _
            vRect.Left, vRect.Top, txt频率.Height, blnCancel, False, True, "," & str范围 & ",", lng诊疗项目ID)
        If rsTmp Is Nothing Then
            If Not blnCancel Then
                MsgBox "没有可用的诊疗频率项目，请先到医嘱频率管理中设置。", vbInformation, gstrSysName
            End If
            txt频率.Text = .TextMatrix(.Row, COL_频率)
            Call zlControl.TxtSelAll(txt频率)
            txt频率.SetFocus: Exit Sub
        End If
        Call Set频率Input(rsTmp, rsTmp!范围ID, int频率)
        txt频率.SetFocus
        Call SeekNextControl
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub cmd安排时间_Click()
    If IsDate(txt安排时间.Text) Then
        dtpDate.value = CDate(txt安排时间.Text)
    ElseIf IsDate(msk开始时间.Text) Then
        dtpDate.value = CDate(msk开始时间.Text)
    Else
        dtpDate.value = zlDatabase.Currentdate
    End If
    dtpDate.Tag = "安排时间"
    dtpDate.Left = txt安排时间.Left + fraAdvice.Left
    dtpDate.Top = txt安排时间.Top + fraAdvice.Top - dtpDate.Height
    dtpDate.Visible = True
    dtpDate.SetFocus
End Sub

Private Sub cmd收藏用药理由_Click()
    Call ReasonSave(0)
End Sub

Private Sub cmdComExcReason_Click()
    Call ReasonSave(1)
End Sub

Private Sub cmd输血原因_Click()
    Dim strSQL As String, rsTmp As Recordset
    Dim vRect As RECT
    
    strSQL = "Select '01' as ID, '手术' as 名称 from dual " & _
            " Union All Select '02','术前' from dual" & _
            " Union All Select '03','术中' from dual" & _
            " Union All Select '04','常规' from dual" & _
            " Union All Select '05','体外循环' from dual"
    vRect = zlControl.GetControlRect(txt用药理由.hwnd)
    On Error GoTo errH
    Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, "输血原因", , , , , , True, vRect.Left + txt用药理由.Width - 1800, vRect.Top, txt用药理由.Height, , , True)
    If Not rsTmp Is Nothing Then
        txt用药理由.Text = rsTmp!名称
        txt用药理由.Tag = "1"
        Call AdviceChange
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmd医生嘱托_Click()
    If ReasonSelect("", 2) Then Exit Sub
    cbo医生嘱托.Tag = "1"
    Call AdviceChange
End Sub

Private Sub ShowAltAdvice()
'功能：显示备选医嘱以供用户选择
    Dim strAdvice As String, strTmp As String
    Dim i As Long, lngBegin As Long, lngEnd As Long, j As Long
    Dim lng相关ID As Long
    Dim lngItemID As Long
    Dim strRemove As String  '取消选择的医嘱,删除
    Dim strAltAdvice As String '动态加载备选医嘱，医嘱内容ID:婴儿序号:路径项目ID,...，例：227:0:38,335:1:69
    Dim lng婴儿 As Integer
    Dim strHave As String   '界面上存在的医嘱
    Dim arrTmp As Variant
    Dim lngRow As Long
    
    With vsAdvice
        If Not CheckItemAltAdvice(Val(.TextMatrix(.Row, COL_路径项目ID))) Then
            MsgBox "当前选择的医嘱没有可用的备选医嘱。", vbInformation, "备选医嘱选择"
            Exit Sub
        End If
        lngItemID = Val(.TextMatrix(.Row, COL_路径项目ID))
        lng婴儿 = Val(.TextMatrix(.Row, COL_婴儿))
        For i = .FixedRows To .Rows - 1
            If .Cell(flexcpChecked, i, COL_选择) = 1 And lngItemID = Val(.TextMatrix(i, COL_路径项目ID)) And Val(.TextMatrix(i, COL_婴儿)) = lng婴儿 And .RowData(i) <> 0 Then
                strTmp = strTmp & "," & Abs(Val(.TextMatrix(i, COL_医嘱内容ID)))
            End If
        Next
        strTmp = Mid(strTmp, 2)
        strAdvice = gobjPath.zlShowAltAdvice(Me, Val(.TextMatrix(.Row, COL_路径项目ID)), strTmp, lng婴儿)
        For i = .FixedRows To .Rows - 1
            If lngItemID = Val(.TextMatrix(i, COL_路径项目ID)) And Val(.TextMatrix(i, COL_婴儿)) = lng婴儿 And .RowData(i) <> 0 Then
                If InStr("," & strAdvice & ",", "," & Abs(Val(.TextMatrix(i, COL_医嘱内容ID))) & ",") = 0 Then
                    '取消选择，并删除,不删除非备选医嘱
                    If .TextMatrix(i, COL_是否备选) = "1" Then
                        strRemove = strRemove & "," & i
                    Else
                        .Cell(flexcpChecked, i, COL_选择) = 2
                    End If
                Else
                    .Cell(flexcpChecked, i, COL_选择) = 1
                End If
                strHave = strHave & "," & Abs(Val(.TextMatrix(i, COL_医嘱内容ID)))
            End If
        Next
        strHave = Mid(strHave, 2)
        strRemove = Mid(strRemove, 2)
        '生成医嘱对应医嘱内容
        arrTmp = Split(strAdvice, ",")
        For i = 0 To UBound(arrTmp)
            If InStr("," & strHave & ",", "," & arrTmp(i) & ",") = 0 Then
                '新勾选的医嘱
                If strAltAdvice = "" Then
                    strAltAdvice = Mid(arrTmp(i), 1, Len(arrTmp(i)) - 1) & ":" & lng婴儿 & ":" & lngItemID
                Else
                    strAltAdvice = strAltAdvice & "," & Mid(arrTmp(i), 1, Len(arrTmp(i)) - 1) & ":" & lng婴儿 & ":" & lngItemID
                End If
            End If
        Next
        lngRow = .Row
        '删除取消勾选的备选医嘱
        arrTmp = Split(strRemove, ",")
        For i = UBound(arrTmp) To 0 Step -1
            If arrTmp(i) <= lngRow Then lngRow = lngRow - 1
            '调整受影响行的序号(每删除一行就调整一次，因为有可能删除的行不是连续的。)
            Call AdviceSet医嘱序号(arrTmp(i) + 1, -1)
            .RemoveItem arrTmp(i)
        Next
        If lngRow > 0 Then .Row = lngRow
        '插入新增的备选医嘱
        If strAltAdvice <> "" Then
            Call GetRowScope(.Row, lngBegin, lngEnd)
            Call AdviceSet成套项目(3, 0, lngEnd, "", strAltAdvice)
        End If
    End With
End Sub

Private Function CheckItemAltAdvice(ByVal lng路径项目ID As Long) As Boolean
'功能：检查当前路径项目是否有备选医嘱
    Dim strSQL As String, rsTmp As Recordset
    
    strSQL = "Select Count(*) as 记录数 From 路径医嘱内容 A ,临床路径医嘱 B Where a.Id = b.医嘱内容id  And a.是否备选=1 And b.路径项目ID=[1] "
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng路径项目ID)
    CheckItemAltAdvice = Val(rsTmp!记录数 & "") > 0
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
    Dim strMsg As String
    
    If mblnNoSave Then
        If mbln审核 Then
            strMsg = "确实要放弃审核当前这些医嘱而退出吗？"
        Else
            strMsg = "当前医嘱内容编辑后尚未保存，确实要退出吗？"

        End If
        If MsgBox(strMsg, vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
            Cancel = True
            Exit Sub
        End If
    End If
    If Not mfrmShortCut Is Nothing Then
        mfrmShortCut.SaveShowState    '系统自动卸载该子窗体
    End If
End Sub

Private Sub lbl滴速_Click()
    If lbl滴速.Caption = "滴速" Then Exit Sub '用血医嘱的滴速不可切换
    Call Load输液滴速(cbo滴速, lbl滴速单位, True)
    cbo滴速.Tag = "1"
    Call AdviceChange
End Sub

Private Sub lvwPati_LostFocus()
    lvwPati.ListItems("_" & mlng病人ID & "_" & mlng主页ID).Selected = True
    lvwPati.Visible = False
End Sub

Private Sub mfrmPrice_PanelHide()
    Call stbThis_PanelClick(stbThis.Panels("Price"))
End Sub

Private Sub mfrmShortCut_ItemClick(ByVal 类型 As Integer, ByVal 分类ID As Long)
    Dim lngBabyEdit As Long
    If cmdSel.Enabled And cmdSel.Visible Then
        If CheckedPathSended = False Then Exit Sub
        lngBabyEdit = CheckBabyEdit
        If lngBabyEdit = 1 Then
            MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
            Exit Sub
        ElseIf lngBabyEdit = 2 Then
            MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
            Exit Sub
        End If
        Call ClinicSelecter(类型, 分类ID)
    End If
End Sub

Private Sub picHelp_Click()
    Dim strTip As String
    
    On Error Resume Next
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "周" Then
        strTip = COL_按周执行
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "天" Then
        strTip = COL_按天执行
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "小时" Then
        strTip = COL_按时执行
    End If
    MsgBox strTip, vbInformation, Me.Caption
    cbo执行时间.SetFocus
    mblnIsInHelp = False
End Sub

Private Sub picHelp_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim strTip As String
    
    On Error Resume Next
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "周" Then
        strTip = COL_按周执行
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "天" Then
        strTip = COL_按天执行
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "小时" Then
        strTip = COL_按时执行
    End If
    
    zlCommFun.ShowTipInfo picHelp.hwnd, strTip, True
    
    If X >= 0 And X <= picHelp.Width And Y >= 0 And Y <= picHelp.Height Then
        mblnIsInHelp = True
        SetCapture picHelp.hwnd
    Else
        mblnIsInHelp = False
        ReleaseCapture
    End If
End Sub

Private Sub stbThis_PanelClick(ByVal Panel As MSComctlLib.Panel)
    If Panel.Key = "Price" Then
        If Panel.Bevel <> sbrNoBevel Then
            Panel.Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
            Panel.Tag = IIF(Panel.Bevel = sbrInset, "1", "")
            Call ShowPrice(vsAdvice.Row)
        End If
    ElseIf Panel.Bevel = sbrRaised And (Panel.Key = "PY" Or Panel.Key = "WB") Then
        '切换并保存简码匹配方式
        Panel.Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
        If Panel.Key = "PY" Then
            stbThis.Panels("WB").Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
        Else
            stbThis.Panels("PY").Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
        End If
        Call zlDatabase.SetPara("简码方式", IIF(stbThis.Panels("PY").Bevel = sbrInset And stbThis.Panels("WB").Bevel = sbrInset, 2, IIF(stbThis.Panels("WB").Bevel = sbrInset, 1, 0)))
        mint简码 = IIF(stbThis.Panels("PY").Bevel = sbrInset And stbThis.Panels("WB").Bevel = sbrInset, 2, IIF(stbThis.Panels("WB").Bevel = sbrInset, 1, 0))
    End If
End Sub

Private Sub tbrFree_ButtonClick(ByVal Button As MSComctlLib.Button)
    If Button.value = 0 Then
        If vsAdvice.RowData(vsAdvice.Row) <> 0 Then
            If MsgBox("取消自由录入状态将清除已录入的医嘱内容，要继续吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                Button.value = 1
                Call zlControl.TxtSelAll(txt医嘱内容)
                If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
                Exit Sub
            End If
            Call DeleteRow(vsAdvice.Row, True)
            mblnNoSave = True
            Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
        End If
        txt医嘱内容.Text = ""
    Else
        txt医嘱内容.Text = ""
        If txt医嘱内容.Tag <> "" Then
            If MsgBox("是否清除已录入的医嘱内容？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                txt医嘱内容.Text = txt医嘱内容.Tag
                Call zlControl.TxtSelAll(txt医嘱内容)
            End If
        End If
    End If
    
    If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
End Sub

Private Sub SetLBLFace(ByRef objCtl As Object, ByVal blnOver As Boolean)
    If blnOver Then
        If objCtl.BorderStyle = 0 Then
            objCtl.BorderStyle = 1
            objCtl.BackStyle = 1
        End If
    Else
        If objCtl.BorderStyle = 1 Then
            objCtl.BorderStyle = 0
            objCtl.BackStyle = 0
        End If
    End If
End Sub

Private Sub lbl单量_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim objPopup As CommandBar
    Dim objControl As CommandBarControl
    Dim vRect As RECT, strSQL As String
    Dim str单位 As String
    Dim rsTmp As Recordset
    
    On Error GoTo errH
    
    If Not (InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) > 0 And txt单量.Enabled) Then Exit Sub
    '品种下达的药品，不进行转换（因为无法确定包装）
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_收费细目ID) = 0 Then Exit Sub
    
    If mrsDrugScale Is Nothing Then
        strSQL = "Select 名称,比例 From 常用剂量比例 Where 名称 is Not NULL And 比例 is Not NULL Order by 编码"
        Set mrsDrugScale = zlDatabase.OpenSQLRecord(strSQL, Me.Caption)
        
        If mrsDrugScale.EOF Then
            MsgBox "没有设置常用剂量比例，请先到字典管理工具进行设置。", vbInformation, gstrSysName
            Exit Sub
        End If
    End If
    
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_收费细目ID) <> 0 Then
        Set rsTmp = Get收费项目记录(Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_收费细目ID)))
        str单位 = rsTmp!计算单位 & ""
    End If
    
    Set objPopup = cbsMain.Add("Popup", xtpBarPopup)
    With objPopup.Controls
        mrsDrugScale.MoveFirst
        Do While Not mrsDrugScale.EOF
            Set objControl = .Add(xtpControlButton, conMenu_DrugScale * 100# + .Count + 1, mrsDrugScale!名称 & "[" & str单位 & "]")
            objControl.Parameter = mrsDrugScale!比例
            mrsDrugScale.MoveNext
        Loop
    End With
    GetWindowRect fraAdvice.hwnd, vRect
    objPopup.ShowPopup , vRect.Left * Screen.TwipsPerPixelX + lbl单量.Left + lbl单量.Width, vRect.Top * Screen.TwipsPerPixelY + lbl单量.Top
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub lbl首日时间_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim objPopup As CommandBar
    Dim objControl As CommandBarControl
    Dim vRect As RECT
    Dim str单位 As String
    Dim int次数 As Integer
    Dim i As Long
     
    With vsAdvice
    
        If Not (InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 And txt首日时间.Visible) Then Exit Sub
        If Not (.TextMatrix(.Row, COL_期效) = "长嘱" And Val(.TextMatrix(.Row, COL_频率间隔)) = 1 And (.TextMatrix(.Row, COL_间隔单位) = "周" Or .TextMatrix(.Row, COL_间隔单位) = "天")) Then
            Exit Sub
        End If
        
        int次数 = .TextMatrix(.Row, COL_频率次数)
        
        If int次数 < 1 Then Exit Sub
        
        str单位 = Mid(lbl首日时间.Caption, 2)
        
    End With
     
    
    Set objPopup = cbsMain.Add("Popup", xtpBarPopup)
    With objPopup.Controls
        For i = 0 To int次数
            Set objControl = .Add(xtpControlButton, conMenu_FirstDay * 100# + .Count + 1, "执行" & .Count & "次")
            objControl.Parameter = .Count - 1
            If i = 0 Then
                objControl.Caption = "清空"
            End If
        Next
    End With
    GetWindowRect fraAdvice.hwnd, vRect
    objPopup.ShowPopup , vRect.Left * Screen.TwipsPerPixelX + lbl首日时间.Left + lbl首日时间.Width, vRect.Top * Screen.TwipsPerPixelY + lbl首日时间.Top
    
 
End Sub

Private Sub txt超量说明_GotFocus()
    Call zlControl.TxtSelAll(txt超量说明)
End Sub

Private Sub txt超量说明_KeyPress(KeyAscii As Integer)
    If KeyAscii = vbKeyReturn Then
        KeyAscii = 0
        If txt超量说明.Text <> "" And lbl超量说明.Caption = "超量说明" Then
            If ReasonSelect(txt超量说明.Text, 3) Then Exit Sub
        End If
        SeekNextControl
    End If
End Sub

Private Sub txt单量_KeyDown(KeyCode As Integer, Shift As Integer)
    If Shift = vbCtrlMask And KeyCode = 192 Then '~
        Call lbl单量_MouseDown(1, 0, 0, 0)
    End If
End Sub

Private Sub txt单量_LostFocus()
    mblnReturn = False
End Sub

Private Sub txt频率_GotFocus()
    Call zlControl.TxtSelAll(txt频率)
End Sub

Private Sub txt频率_KeyPress(KeyAscii As Integer)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim str范围 As String, int频率 As Integer, vRect As RECT
    Dim lng诊疗项目ID As Long, lngFind As Long
    
    With vsAdvice
        If KeyAscii = 13 Then
            KeyAscii = 0
            If cmd频率.Tag <> "" And txt频率.Text = .TextMatrix(.Row, COL_频率) And txt频率.Text <> "" Then
                Call SeekNextControl
            ElseIf txt频率.Text = "" Then
                If cmd频率.Enabled And cmd频率.Visible Then cmd频率_Click
            Else
                If cbo期效.ListIndex = 1 Then
                    int频率 = Get项目频率(.Row)
                    If Not RowIn配方行(.Row) And int频率 = 0 Then
                        str范围 = "1,-1" '临嘱可以为一次性
                    Else
                        str范围 = Get频率范围(.Row)
                    End If
                Else
                    str范围 = Get频率范围(.Row)
                    int频率 = Decode(str范围, "1", 0, "2", 0, "-1", 1, "-2", 2, "-3", 1, "-5", 1)
                End If
                str范围 = str范围 & "," & IIF(cbo期效.ListIndex = 1, "-5", "-3")
                
                '可选择频率的常用频率
                lng诊疗项目ID = Val(.TextMatrix(.Row, COL_诊疗项目ID))
                If RowIn检验行(.Row) Then
                    lngFind = .FindRow(CStr(.RowData(.Row)), .FixedRows, COL_相关ID)
                    If lngFind <> -1 Then
                        lng诊疗项目ID = Val(.TextMatrix(lngFind, COL_诊疗项目ID))
                    End If
                ElseIf InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                    lngFind = .FindRow(CLng(.TextMatrix(.Row, COL_相关ID)), .Row + 1)
                    If lngFind <> -1 Then
                        lng诊疗项目ID = Val(.TextMatrix(lngFind, COL_诊疗项目ID))
                    End If
                End If
                strSQL = ""
                If InStr("," & str范围 & ",", ",1,") > 0 Then
                    strSQL = " And (Exists(Select 1 From 诊疗用法用量 Where 项目ID=[4] And 用法ID is NULL And 频次=A.编码 And A.适用范围=1)" & _
                        " Or (Select Count(*) From 诊疗用法用量 Where 项目ID=[4] And 用法ID is NULL And 频次 Is Not NULL)<=1)"
                End If
                strSQL = _
                    " Select Rownum as ID,A.编码,A.名称,A.简码," & _
                    " A.英文名称,A.频率次数,A.频率间隔,A.间隔单位,A.适用范围 as 范围ID" & _
                    " From 诊疗频率项目 A" & _
                    " Where Instr([3],','||A.适用范围||',')>0" & strSQL & _
                    " And (A.编码 Like [1] Or Upper(A.名称) Like [2]" & _
                    " Or Upper(A.简码) Like [2] Or Upper(A.英文名称) Like [2])" & _
                    " Order by A.适用范围,A.编码"
                vRect = zlControl.GetControlRect(txt频率.hwnd)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, "诊疗频率", False, "", "", False, False, True, _
                    vRect.Left, vRect.Top, txt频率.Height, blnCancel, False, True, UCase(txt频率.Text) & "%", _
                    mstrLike & UCase(txt频率.Text) & "%", "," & str范围 & ",", lng诊疗项目ID)
                If rsTmp Is Nothing Then
                    If Not blnCancel Then
                        MsgBox "未找到匹配的诊疗频率项目。", vbInformation, gstrSysName
                    End If
                    txt频率.Text = .TextMatrix(.Row, COL_频率)
                    Call zlControl.TxtSelAll(txt频率)
                    txt频率.SetFocus: Exit Sub
                End If
                Call Set频率Input(rsTmp, rsTmp!范围ID, int频率)
                Call SeekNextControl
            End If
        End If
    End With
End Sub

Private Function GetBaseRow(ByVal lngRow As Long) As Long
'功能：由当前可见行获取主项目的行
    If RowIn配方行(lngRow) Then
        '获取中药配方第一味中药行
        GetBaseRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_相关ID)
    ElseIf RowIn检验行(lngRow) Then
        '获取一并采样的第一个项目行
        GetBaseRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_相关ID)
    Else
        GetBaseRow = lngRow
    End If
End Function

Private Function Get项目频率(ByVal lngRow As Long) As Integer
'功能：获取指定项目的原始执行频率属性
'参数：lngRow=当前可见行
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String
    
    On Error GoTo errH
    lngRow = GetBaseRow(lngRow)
    strSQL = "Select 执行频率 From 诊疗项目目录 Where ID=[1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID)))
    If Not rsTmp.EOF Then Get项目频率 = NVL(rsTmp!执行频率, 0)
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub txt首次用量_Change()
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If Val(.TextMatrix(.Row, COL_首次用量)) <> Val(txt首次用量.Text) Then
                txt首次用量.Tag = "1"
            End If
        Else
            txt首次用量.Tag = "1"
        End If
    End With
End Sub

Private Sub txt首次用量_GotFocus()
    zlControl.TxtSelAll txt首次用量
End Sub

Private Sub txt首次用量_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        With vsAdvice
            If IsNumeric(txt首次用量.Text) Or txt首次用量.Text = "" Then
                Call txt首次用量_Validate(blnCancel)
                If Not blnCancel Then mblnReturn = True: Call SeekNextControl
            End If
        End With
    Else
        If InStr("0123456789." & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txt首次用量_LostFocus()
    mblnReturn = False
End Sub

Private Sub txt首次用量_Validate(Cancel As Boolean)
    Dim strMsg As String, blnTag As Boolean
    Dim dbl次数 As Double, sng天数 As Single
    Dim dbl总量 As Double, dbl总剂量 As Double
    Dim lngFind As Long, blnDo As Boolean
    Dim lng总量 As Long
    
    With vsAdvice
        If Val(txt首次用量.Text) = 0 Then txt首次用量.Text = ""
        If mblnReturn Then mblnReturn = False: Exit Sub
        If Not IsNumeric(txt首次用量.Text) Then
            If txt首次用量.Text <> "" Then
                Cancel = True: txt首次用量_GotFocus: Exit Sub
            ElseIf .RowData(.Row) <> 0 And .TextMatrix(.Row, COL_期效) = "长嘱" Then
                '恢复人为的清除
                If IsNumeric(.TextMatrix(.Row, COL_首次用量)) Then
                    txt首次用量.Text = .TextMatrix(.Row, COL_首次用量)
                End If
            End If
        ElseIf CDbl(txt首次用量.Text) <= 0 Then
            Cancel = True: txt首次用量_GotFocus: Exit Sub
        ElseIf CDbl(txt首次用量.Text) > LONG_MAX Then
            Cancel = True: txt首次用量_GotFocus: Exit Sub
        ElseIf .RowData(.Row) <> 0 Then
            '处方限量的检查 ---- 临嘱  txt总量  检查总量；长嘱  txt单量和txt首次用量  取两者中较大值检查
            .TextMatrix(.Row, COL_是否超量) = ""
            If .TextMatrix(.Row, COL_期效) = "长嘱" And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
                If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 And Val(txt首次用量.Text) <> 0 Then
                    If Val(.TextMatrix(.Row, COL_收费细目ID)) = 0 Then '长嘱按品种下达时，单纯比较首次用量或单量
                        dbl总量 = IIF(Val(txt首次用量.Text) > Val(txt单量.Text), Val(txt首次用量.Text), Val(txt单量.Text))
                        If dbl总量 > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then .TextMatrix(.Row, COL_是否超量) = "1"
                        
                        If Val(txt首次用量.Text) > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 And Val(txt首次用量.Text) > Val(txt单量.Text) Then
                            .TextMatrix(.Row, COL_是否超量) = "1"
                        End If
                    ElseIf Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 Then '成药长嘱按规格下达时，按一个频率周期的缺省总量比较
                        dbl总量 = Calc缺省药品总量(Val(txt单量.Text), 1, _
                            Val(.TextMatrix(.Row, COL_频率次数)), _
                            Val(.TextMatrix(.Row, COL_频率间隔)), _
                            .TextMatrix(.Row, COL_间隔单位), _
                            .TextMatrix(.Row, COL_执行时间), _
                            Val(.TextMatrix(.Row, COL_剂量系数)), _
                            Val(.TextMatrix(.Row, COL_住院包装)), _
                            Val(.TextMatrix(.Row, COL_可否分零)), _
                            Val(txt首次用量.Text))
                        dbl总剂量 = dbl总量 * Val(.TextMatrix(.Row, COL_住院包装)) * Val(.TextMatrix(.Row, COL_剂量系数))
                        If dbl总剂量 > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
                            .TextMatrix(.Row, COL_是否超量) = "1"
                        End If
                    End If
'                ElseIf Val(txt首次用量.Text) <> 0 And InStr(",5,6,7,", .TextMatrix(.Row, COL_类别)) = 0 Then
                    '按一个频率周期的缺省总量进行检查(这里非药品的首次用量暂不考虑超量的问题。)
                End If
            End If
            
            '最大金额提示
            If gcurMaxMoney > 0 Then
                If .TextMatrix(.Row, COL_单价) = "" Then .TextMatrix(.Row, COL_单价) = GetItemPrice(.Row) '用""不是零
                If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                    If Val(.TextMatrix(.Row, COL_收费细目ID)) <> 0 Then
                        dbl总量 = Val(txt首次用量.Text) / Val(.TextMatrix(.Row, COL_住院包装)) / Val(.TextMatrix(.Row, COL_剂量系数))
                    End If
                Else
                    dbl总量 = Val(txt首次用量.Text)
                End If
                If Val(.TextMatrix(.Row, COL_单价)) * dbl总量 > gcurMaxMoney Then
                    If MsgBox("当前医嘱 " & txt首次用量.Text & lbl单量单位(0).Caption & " 的金额达到了：" & Format(Val(.TextMatrix(.Row, COL_单价)) * dbl总量, "0.00") & "，要继续吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                        Cancel = True: txt首次用量_GotFocus: Exit Sub
                    End If
                End If
            End If
            
            txt首次用量.Text = FormatEx(txt首次用量.Text, 5)
        End If
        
        '更新数据
        blnTag = txt首次用量.Tag <> ""
        Call AdviceChange
        
        '药品库存检查:仅对成药长嘱(其它的用总量),只提醒,按一个频率周期算总量
        If blnTag Then
            If .TextMatrix(.Row, COL_期效) = "长嘱" And (InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 _
                Or .TextMatrix(.Row, COL_类别) = "4" And Val(.TextMatrix(.Row, COL_跟踪在用)) = 1) Then
                strMsg = CheckStock(.Row)
                If strMsg <> "" Then MsgBox strMsg, vbInformation, gstrSysName
            End If
        End If
    End With
End Sub

Private Sub txt首日时间_Change()
    txt首日时间.Tag = "1"
End Sub

Private Sub txt首日时间_GotFocus()
    zlControl.TxtSelAll txt首日时间
End Sub

Private Sub txt首日时间_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If SeekNextControl Then Call txt首日时间_Validate(False)
    Else
        If InStr("0123456789:-/" & Chr(8) & Chr(3) & Chr(22), Chr(KeyAscii)) = 0 Then
            KeyAscii = 0
        End If
    End If
End Sub

Private Sub txt首日时间_Validate(Cancel As Boolean)
    Dim blnValid As Boolean, lngRow As Long, strTmp As String
    
    lngRow = vsAdvice.Row
        
    With vsAdvice
        If txt首日时间.Text <> "" Then
            '检查长度
            If Len(txt首日时间.Text) > 50 Then
                MsgBox "输入内容不能超过 50 个字符。", vbInformation, gstrSysName
                Call txt首日时间_GotFocus
                Cancel = True: Exit Sub
            End If
            '检查合法性
            If .RowData(lngRow) <> 0 Then
                blnValid = ExeTimeValid(txt首日时间.Text, Val(.TextMatrix(lngRow, COL_频率次数)), Val(.TextMatrix(lngRow, COL_频率间隔)), .TextMatrix(lngRow, COL_间隔单位), True)
                If Not blnValid Then
                    If .TextMatrix(lngRow, COL_间隔单位) = "周" Then
                        strTmp = COL_按周执行首周
                    ElseIf .TextMatrix(lngRow, COL_间隔单位) = "天" Then
                        strTmp = COL_按天执行首日
                    End If
                    MsgBox "输入的" & Mid(lbl首日时间.Caption, 2) & "执行时间方案格式不正确，请检查。" & vbCrLf & vbCrLf & "例：" & vbCrLf & strTmp, vbInformation, gstrSysName
                    Call txt首日时间_GotFocus
                    Cancel = True: Exit Sub
                End If
            End If
        End If
    End With
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub txt安排时间_Change()
    txt安排时间.Tag = "1"
End Sub

Private Sub txt安排时间_GotFocus()
    If txt安排时间.Text = "" Then txt安排时间.Text = msk开始时间.Text
    zlControl.TxtSelAll txt安排时间
End Sub

Private Sub txt安排时间_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt安排时间.Text <> "" Then
            txt安排时间.Text = zlStr.FullDate(txt安排时间.Text)
            If SeekNextControl Then Call txt安排时间_Validate(False)
        End If
    Else
        If InStr("0123456789 /-:" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txt安排时间_Validate(Cancel As Boolean)
    If txt安排时间.Locked Then Exit Sub
        
    If Not IsDate(txt安排时间.Text) Then
        If txt安排时间.Text <> "" Then
            Cancel = True
            txt安排时间_GotFocus
            Exit Sub
        ElseIf vsAdvice.RowData(vsAdvice.Row) <> 0 Then
            If IsDate(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_开始时间)) Then
                '恢复人为的清除缺省为开始时间
                txt安排时间.Text = vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_开始时间)
            End If
        End If
    Else
        '检查时间合法性
        If Not Check安排时间(txt安排时间.Text, vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_开始时间), vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) Then
            Cancel = True
            txt安排时间_GotFocus
            Exit Sub
        End If
    End If
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub txt天数_Change()
    txt天数.Tag = "1"
End Sub

Private Sub txt天数_GotFocus()
    Call zlControl.TxtSelAll(txt天数)
End Sub

Private Sub txt天数_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If Val(txt天数.Text) > 0 Then
            If SeekNextControl Then Call txt天数_Validate(False)
        Else
            If Val(txt天数.Text) = 0 Then txt天数.Text = ""
        End If
    Else
        If InStr("0123456789" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Function ReSetTotalamount(Cancel As Boolean, ByVal str总量 As String, ByVal str天数 As String, ByVal lngRow As Long, Optional blnExit As Boolean) As String
'功能：重新根据天数计算总量
    '重新计算总量
    Dim lng总量 As Long
    Dim strReturn As String
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_频率) <> "" _
            And Val(.TextMatrix(lngRow, COL_单量)) <> 0 _
            And Val(.TextMatrix(lngRow, COL_剂量系数)) <> 0 _
            And Val(.TextMatrix(lngRow, COL_住院包装)) <> 0 Then
            lng总量 = Val(str总量)
            If .TextMatrix(lngRow, COL_频率性质) = "1" Then
                strReturn = FormatEx(Calc缺省药品总量( _
                    Val(.TextMatrix(lngRow, COL_单量)), 1, _
                    1, 1, _
                    "天", .TextMatrix(lngRow, COL_执行时间), _
                    Val(.TextMatrix(lngRow, COL_剂量系数)), Val(.TextMatrix(lngRow, COL_住院包装)), _
                    Val(.TextMatrix(lngRow, COL_可否分零))), 5)
            Else
                strReturn = FormatEx(Calc缺省药品总量( _
                    Val(.TextMatrix(lngRow, COL_单量)), Val(str天数), _
                    Val(.TextMatrix(lngRow, COL_频率次数)), Val(.TextMatrix(lngRow, COL_频率间隔)), _
                    .TextMatrix(lngRow, COL_间隔单位), .TextMatrix(lngRow, COL_执行时间), _
                    Val(.TextMatrix(lngRow, COL_剂量系数)), Val(.TextMatrix(lngRow, COL_住院包装)), _
                    Val(.TextMatrix(lngRow, COL_可否分零))), 5)
            End If
            ReSetTotalamount = strReturn
            If InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") = 0 Then
                ReSetTotalamount = IntEx(Val(strReturn))
            ElseIf Val(.TextMatrix(lngRow, COL_可否分零)) <> 0 Then
                ReSetTotalamount = IntEx(Val(strReturn))
            End If
            txt总量.Tag = "1"
             '检查总量
            Call txt总量_Validate(Cancel)
            If Cancel Then
                Cancel = True
                ReSetTotalamount = lng总量
                blnExit = True
            End If
        End If
    End With
End Function

Private Sub txt天数_Validate(Cancel As Boolean)
    Dim sng天数 As Single, i As Long
    Dim strSame As String, strMsg As String
    Dim lng总量 As Long, blnExit As Boolean
    Dim bln计算总量 As Boolean
    
    With vsAdvice
        If Val(txt天数.Text) = 0 Then txt天数.Text = ""
        If Val(txt天数.Text) <= 0 Then
            Cancel = True: txt天数_GotFocus: Exit Sub
        End If
    
        '天数至少需要一个频率同期的天数
        If Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 Then
            If .TextMatrix(.Row, COL_间隔单位) = "周" Then
                sng天数 = 7
            ElseIf .TextMatrix(.Row, COL_间隔单位) = "天" Then
                sng天数 = Val(.TextMatrix(.Row, COL_频率间隔))
            ElseIf .TextMatrix(.Row, COL_间隔单位) = "小时" Then
                sng天数 = Val(.TextMatrix(.Row, COL_频率间隔)) \ 24
            ElseIf .TextMatrix(.Row, COL_间隔单位) = "分钟" Then
                sng天数 = Val(.TextMatrix(.Row, COL_频率间隔)) \ (24 * 60)
            End If
            If Val(txt天数.Text) < sng天数 Then
                If MsgBox("按""" & .TextMatrix(.Row, COL_频率) & """执行时，至少需要 " & sng天数 & " 天的用药，要继续吗？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                    Cancel = True: txt天数_GotFocus: Exit Sub
                End If
            End If
        End If

        If mbln天数反算 Then
            '如果总量为0或者说天数变了则计算下总量
            If Val(txt总量.Text) = 0 Or Val(txt天数.Text) <> msngPre天数 Then
                bln计算总量 = True
            End If
        Else
            bln计算总量 = True
        End If
        
        If bln计算总量 Then
            '重新计算总量
            txt总量.Text = ReSetTotalamount(Cancel, txt总量.Text, txt天数.Text, .Row, blnExit)
            '要重新判断下是否超量，不然有问题
            If Val(.TextMatrix(.Row, COL_处方限量)) <> 0 Then
                lng总量 = Val(txt总量.Text) * Val(.TextMatrix(.Row, COL_住院包装)) * Val(.TextMatrix(.Row, COL_剂量系数))
                If lng总量 > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
                    .TextMatrix(.Row, COL_是否超量) = "1"
                End If
            End If
        End If
        If blnExit Then Exit Sub
    End With
    
    '每次输入天数后，作为下次的缺省
    If txt天数.Tag = "1" Then
        msng天数 = Val(txt天数.Text)
    End If
    msngPre天数 = Val(txt天数.Text)
    Call AdviceChange
    
    '成套方案批量处理
    With vsAdvice
        If Val(.Cell(flexcpData, .Row, COL_EDIT)) <> 0 Then
            strSame = CStr(.Cell(flexcpData, .Row, COL_EDIT))
            If InStr(strSame, ",") > 0 Then
                strMsg = "该次复制的所有的药品都按这个天数执行吗？"
            Else
                strMsg = "该成套方案的所有药品都按这个天数执行吗？"
            End If
            If MsgBox(strMsg, vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbYes Then
                For i = .FixedRows To .Rows - 1
                    If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 And .TextMatrix(i, COL_期效) = "临嘱" Then
                        If Not (Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(.Row, COL_相关ID)) _
                            Or .RowData(i) = Val(.TextMatrix(.Row, COL_相关ID)) Or i = .Row) _
                                And CStr(.Cell(flexcpData, i, COL_EDIT)) = strSame Then
                            If .TextMatrix(i, COL_频率) <> "" _
                                And Val(.TextMatrix(i, COL_单量)) <> 0 _
                                And Val(.TextMatrix(i, COL_剂量系数)) <> 0 _
                                And Val(.TextMatrix(i, COL_住院包装)) <> 0 _
                                And Val(.TextMatrix(i, COL_频率性质)) <> 1 Then
                                .TextMatrix(i, COL_天数) = txt天数.Text
                                .TextMatrix(i, COL_总量) = FormatEx(Calc缺省药品总量( _
                                    Val(.TextMatrix(i, COL_单量)), Val(txt天数.Text), _
                                    Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), _
                                    .TextMatrix(i, COL_间隔单位), .TextMatrix(i, COL_执行时间), _
                                    Val(.TextMatrix(i, COL_剂量系数)), Val(.TextMatrix(i, COL_住院包装)), _
                                    Val(.TextMatrix(i, COL_可否分零))), 5)
                                If InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") = 0 Then
                                    .TextMatrix(i, COL_总量) = IntEx(Val(.TextMatrix(i, COL_总量)))
                                ElseIf Val(.TextMatrix(i, COL_可否分零)) <> 0 Then
                                    .TextMatrix(i, COL_总量) = IntEx(Val(.TextMatrix(i, COL_总量)))
                                End If
                                If Val(.TextMatrix(i, COL_相关ID)) = Val(.RowData(i + 1)) Then
                                    .TextMatrix(i + 1, COL_天数) = txt天数.Text
                                End If
                            End If
                        End If
                    End If
                Next
            End If
        End If
    End With
End Sub

Private Sub txt用法_KeyPress(KeyAscii As Integer)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim int类型 As Integer, vRect As RECT
    Dim lngBegin As Long, lngEnd As Long
    Dim strLike As String, i As Long
    Dim lng项目id As Long
    Dim blnDrugUseM As Boolean
    
    With vsAdvice
        If KeyAscii = 13 Then
            KeyAscii = 0
            If Val(cmd用法.Tag) <> 0 And txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法)) And txt用法.Text <> "" Then
                Call SeekNextControl
            ElseIf txt用法.Text = "" Then
                If cmd用法.Enabled And cmd用法.Visible Then cmd用法_Click
            Else
                If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                    int类型 = 2 '给药途径
                    blnDrugUseM = CheckDrugUseM(Val(.TextMatrix(.Row, COL_收费细目ID)), Val(.TextMatrix(.Row, COL_诊疗项目ID)))
                ElseIf RowIn检验行(vsAdvice.Row) Then
                    int类型 = 6 '采集方法
                ElseIf .TextMatrix(.Row, COL_类别) = "K" Then
                    int类型 = 8 '输血途径
                Else
                    int类型 = 4 '中药用法
                End If
                lng项目id = Val(.TextMatrix(.Row, COL_诊疗项目ID))
                If int类型 = 2 Then '只取有效范围的给药途径(无设置或仅一个时可任选)
                    If Val(.TextMatrix(.Row, COL_收费细目ID)) = 0 Then
                        strSQL = " And (A.ID IN(Select 用法ID From 诊疗用法用量 Where 项目ID=[4] And 性质>0)" & _
                            " Or (Select Count(A.用法ID) From 诊疗用法用量 A,诊疗项目目录 B" & _
                            " Where A.用法ID=B.ID And B.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3) And A.项目ID=[4] And A.性质>0)<=1)"
                    Else
                        lng项目id = Val(.TextMatrix(.Row, COL_收费细目ID))
                        strSQL = " And (A.ID IN(Select 用法ID From 药品用法用量 Where 药品ID=[4] And 性质=1)" & _
                            " Or (Select Count(A.用法ID) From 药品用法用量 A,诊疗项目目录 B" & _
                            " Where A.用法ID=B.ID And B.服务对象 IN(1,3) And A.药品ID=[4] And A.性质=1)<=" & IIF(blnDrugUseM, "0", "1") & ")"
                    End If
                End If
                
                '优化
                strLike = mstrLike
                If Len(txt用法.Text) < 2 Then strLike = ""
                
                strSQL = "Select Distinct A.ID,A.编码,A.名称,A.执行分类 as 执行分类ID" & _
                    " From 诊疗项目目录 A,诊疗项目别名 B" & _
                    " Where A.ID=B.诊疗项目ID" & _
                    " And A.类别='E' And A.操作类型=[3] And A.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3)" & strSQL & _
                    " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 IS NULL)" & _
                    " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
                    " And (A.编码 Like [1] Or B.名称 Like [2] Or B.简码 Like [2])" & _
                    IIF(mlng病人性质 = 1, "", " And (Exists(Select 1 From 诊疗适用科室 Where 项目ID=A.ID And 科室ID=[6])  Or Not Exists(Select 1 From 诊疗适用科室 Where 项目ID=A.ID))") & _
                    Decode(mint简码, 0, " And B.码类 IN([5],3)", 1, " And B.码类 IN([5],3)", "") & _
                    " Order by A.编码"
                vRect = zlControl.GetControlRect(txt用法.hwnd)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl用法.Caption, False, "", "", False, False, True, _
                    vRect.Left, vRect.Top, txt用法.Height, blnCancel, False, True, UCase(txt用法.Text) & "%", _
                    strLike & UCase(txt用法.Text) & "%", CStr(int类型), lng项目id, mint简码 + 1, mlng病人科室id)
                If rsTmp Is Nothing Then
                    If Not blnCancel Then
                        MsgBox "未找到匹配的" & lbl用法.Caption & "。", vbInformation, gstrSysName
                    End If
                    txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法))
                    Call zlControl.TxtSelAll(txt用法)
                    txt用法.SetFocus: Exit Sub
                End If
                
                '对一并给药的其它药品的可用给药途径进行检查
                If int类型 = 2 Then
                    Call Get一并给药范围(Val(.TextMatrix(.Row, COL_相关ID)), lngBegin, lngEnd)
                    For i = lngBegin To lngEnd
                        If i <> .Row And .RowData(i) <> 0 Then
                            If Not Check适用用法(rsTmp!ID, Val(.TextMatrix(i, COL_诊疗项目ID)), 2, Val(.TextMatrix(i, COL_收费细目ID)), mlng病人性质) Then
                                .Refresh
                                MsgBox """" & rsTmp!名称 & """不适用于与当前药品一并给药的""" & .TextMatrix(i, col_医嘱内容) & """。", vbInformation, gstrSysName
                                .Refresh
                                txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法))
                                Call zlControl.TxtSelAll(txt用法)
                                txt用法.SetFocus: Exit Sub
                            End If
                        End If
                    Next
                End If
                Call Set用法Input(rsTmp, int类型)
                Call SeekNextControl
            End If
        End If
    End With
End Sub

Private Sub cmd用法_Click()
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim int类型 As Integer, vRect As RECT
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim strSeek As String
    Dim lng项目id As Long
    Dim strWhere As String
    Dim blnDrugUseM As Boolean
    
    With vsAdvice
        If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
            int类型 = 2 '给药途径
            lngBegin = .FindRow(CLng(Val(.TextMatrix(.Row, COL_相关ID))), .Row + 1)
            blnDrugUseM = CheckDrugUseM(Val(.TextMatrix(.Row, COL_收费细目ID)), Val(.TextMatrix(.Row, COL_诊疗项目ID)))
        ElseIf RowIn检验行(vsAdvice.Row) Then
            int类型 = 6 '采集方法
            lngBegin = .Row
        ElseIf .TextMatrix(.Row, COL_类别) = "K" Then
            If gbln血库系统 = True Then
                If Val(.TextMatrix(.Row, COL_检查方法)) = 0 Then
                    int类型 = 9 '采集输血途径
                Else
                    int类型 = 8 '输血途径
                    strWhere = " And nvl(A.执行分类,0)=1 "
                End If
            Else
                int类型 = 8 '输血途径
            End If
            lngBegin = .FindRow(CStr(.RowData(.Row)), .Row + 1, COL_相关ID)
        Else
            int类型 = 4 '中药用法
            lngBegin = .Row
        End If
        If txt用法.Text <> "" And lngBegin <> -1 Then
            strSeek = Sys.RowValue("诊疗项目目录", Val(.TextMatrix(lngBegin, COL_诊疗项目ID)), "编码")
        End If
        lng项目id = Val(.TextMatrix(.Row, COL_诊疗项目ID))
        If int类型 = 2 Then '只取有效范围的给药途径(无设置或仅一个时可任选)
            If Val(.TextMatrix(.Row, COL_收费细目ID)) = 0 Then
                strSQL = " And (A.ID IN(Select 用法ID From 诊疗用法用量 Where 项目ID=[2] And 性质>0)" & _
                    " Or (Select Count(A.用法ID) From 诊疗用法用量 A,诊疗项目目录 B" & _
              " Where A.用法ID=B.ID And B.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3) And A.项目ID=[2] And A.性质>0)<=" & IIF(blnDrugUseM, "0", "1") & ")"
            Else
                lng项目id = Val(.TextMatrix(.Row, COL_收费细目ID))
                strSQL = " And (A.ID IN(Select 用法ID From 药品用法用量 Where 药品ID=[2] And 性质=1)" & _
                    " Or (Select Count(A.用法ID) From 药品用法用量 A,诊疗项目目录 B" & _
                    " Where A.用法ID=B.ID And B.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3) And A.药品ID=[2] And A.性质=1)<=" & IIF(blnDrugUseM, "0", "1") & ")"
            End If
        End If
        strSQL = "Select Distinct A.ID,A.编码,A.名称,C.名称 as 分类,A.执行分类 as 执行分类ID" & _
            " From 诊疗项目目录 A,诊疗分类目录 C" & _
            " Where A.分类ID=C.ID(+) And A.类别='E' And A.操作类型=[1] And A.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3)" & strWhere & strSQL & _
            " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 IS NULL)" & _
            " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)" & _
           IIF(mlng病人性质 = 1, "", " And (Exists(Select 1 From 诊疗适用科室 Where 项目ID=A.ID And 科室ID=[3]) Or Not Exists(Select 1 From 诊疗适用科室 Where 项目ID=A.ID))") & _
            " Order by A.编码"
        vRect = zlControl.GetControlRect(txt用法.hwnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl用法.Caption, False, strSeek, "", False, False, True, _
            vRect.Left, vRect.Top, txt用法.Height, blnCancel, False, True, CStr(int类型), lng项目id, mlng病人科室id)
        If rsTmp Is Nothing Then
            If Not blnCancel Then
                MsgBox "没有可用的" & lbl用法.Caption & "，请先到诊疗项目管理中设置。", vbInformation, gstrSysName
            End If
            txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法))
            Call zlControl.TxtSelAll(txt用法)
            txt用法.SetFocus: Exit Sub
        End If
        
        '对一并给药的其它药品的可用给药途径进行检查
        If int类型 = 2 Then
            Call Get一并给药范围(Val(.TextMatrix(.Row, COL_相关ID)), lngBegin, lngEnd)
            For i = lngBegin To lngEnd
                If i <> .Row And .RowData(i) <> 0 Then
                    If Not Check适用用法(rsTmp!ID, Val(.TextMatrix(i, COL_诊疗项目ID)), 2, Val(.TextMatrix(i, COL_收费细目ID)), mlng病人性质) Then
                        .Refresh
                        MsgBox """" & rsTmp!名称 & """不适用于与当前药品一并给药的""" & .TextMatrix(i, col_医嘱内容) & """。", vbInformation, gstrSysName
                        .Refresh
                        txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法))
                        Call zlControl.TxtSelAll(txt用法)
                        txt用法.SetFocus: Exit Sub
                    End If
                End If
            Next
        End If
        Call Set用法Input(rsTmp, int类型)
        If txt用法.Enabled Then txt用法.SetFocus
        Call SeekNextControl
    End With
End Sub

Private Sub txt用法_GotFocus()
    Call zlControl.TxtSelAll(txt用法)
End Sub

Private Sub txt用法_Validate(Cancel As Boolean)
    With vsAdvice
        '恢复人为的清除
        If Val(cmd用法.Tag) <> 0 And txt用法.Text <> IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法)) Then
            txt用法.Text = IIF(cbo滴速.Text <> "", Replace(.TextMatrix(.Row, COL_用法), cbo滴速.Text & lbl滴速单位.Caption, ""), .TextMatrix(.Row, COL_用法))
        End If
    End With
End Sub

Private Sub txt频率_Validate(Cancel As Boolean)
    With vsAdvice
        '恢复人为的清除
        If cmd频率.Tag <> "" And txt频率.Text <> .TextMatrix(.Row, COL_频率) Then
            txt频率.Text = .TextMatrix(.Row, COL_频率)
        End If
    End With
End Sub

Private Sub cbo医生_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo医生.ListIndex = -1 Then
            Call cbo医生_Validate(blnCancel)
        End If
        If Not blnCancel Then
            If SeekNextControl Then Call cbo医生_Validate(False)
        End If
    End If
End Sub

Private Sub cbo婴儿_Click()
    If Not Visible Then Exit Sub
    If cbo婴儿.ListIndex = -1 Then mint婴儿 = 0: Exit Sub
    
    If cbo婴儿.ListIndex = Val(cbo婴儿.Tag) Then Exit Sub
    cbo婴儿.Tag = cbo婴儿.ListIndex
    mint婴儿 = cbo婴儿.ListIndex
    mstr性别 = GetBabySex(mint婴儿)
    
    'PASS 婴儿发生改变
    If mblnPass Then
        mobjPassMap.PassPati.int婴儿 = cbo婴儿.ListIndex
    End If
    
    Call ShowAdvice
    
    vsAdvice.SetFocus
End Sub

Private Sub cbo执行科室_Click()
    Dim rsTmp As ADODB.Recordset
    Dim lngRow As Long, strSQL As String
    Dim intIdx As Integer, i As Long
    Dim vRect As RECT, blnCancel As Boolean
    Dim lng配制中心 As Long, str药房IDs As String
    Dim lngBegin As Long, lngEnd As Long, blnNode As Boolean, bln留观病人入院 As Boolean
    Dim str服务对象 As String
           
    If cbo执行科室.ListIndex = -1 Then Exit Sub
    
    If cbo执行科室.ItemData(cbo执行科室.ListIndex) = -1 Then
        
        blnNode = True
        If vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "Z" Then '门诊留观病人入院
            bln留观病人入院 = vsAdvice.TextMatrix(vsAdvice.Row, COL_操作类型) = "2" And mlng病人性质 = 1
            blnNode = Not bln留观病人入院
        End If
        
        If bln留观病人入院 Then
            str服务对象 = " And B.服务对象 IN (2,3)"
        ElseIf mlng病人性质 = 1 Then
            str服务对象 = " And B.服务对象 IN (1,2,3)"
        Else
            str服务对象 = " And B.服务对象 IN (2,3)"
        End If
        
        '他科执行，弹出选择执行科室
        strSQL = "Select Distinct A.ID,A.编码,A.名称,A.简码" & _
            " From 部门表 A,部门性质说明 B" & _
            " Where A.ID=B.部门ID " & str服务对象 & _
            IIF(blnNode, " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)", "") & _
            IIF(bln留观病人入院, " And B.工作性质='临床'", "") & _
            " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 is NULL)" & _
            " Order by A.编码"
        vRect = zlControl.GetControlRect(cbo执行科室.hwnd)
        Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, lbl执行科室.Caption, , , , , , True, vRect.Left, vRect.Top, cbo执行科室.Height, blnCancel, , True)
        If Not rsTmp Is Nothing Then
            intIdx = Cbo.FindIndex(cbo执行科室, rsTmp!ID)
            If intIdx <> -1 Then
                cbo执行科室.ListIndex = intIdx
            Else
                cbo执行科室.AddItem rsTmp!编码 & "-" & rsTmp!名称, cbo执行科室.ListCount - 1
                cbo执行科室.ItemData(cbo执行科室.NewIndex) = rsTmp!ID
                cbo执行科室.ListIndex = cbo执行科室.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "没有科室数据，请先到部门管理中设置。", vbInformation, gstrSysName
            End If
            '恢复成现有的科室(不引发Click)
            intIdx = Cbo.FindIndex(cbo执行科室, Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_执行科室ID)))
            Call Cbo.SetIndex(cbo执行科室.hwnd, intIdx)
        End If
    Else
        lngRow = vsAdvice.Row
        
        '检查一并给药的配制中心
        With vsAdvice
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 And RowIn一并给药(lngRow) Then
                Call Get一并给药范围(Val(.TextMatrix(lngRow, COL_相关ID)), lngBegin, lngEnd)
                
                '当前行由普通药房或其他配制中心改为配制中心
                If Sys.DeptHaveProperty(cbo执行科室.ItemData(cbo执行科室.ListIndex), "配制中心") Then
                    lng配制中心 = cbo执行科室.ItemData(cbo执行科室.ListIndex)
                End If
                '当前行由配置中心或改为普通药房
                If lng配制中心 = 0 Then
                    For i = lngBegin To lngEnd
                        If i <> lngRow And Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                            '自备药不管它
                            If Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                                If Sys.DeptHaveProperty(Val(.TextMatrix(i, COL_执行科室ID)), "配制中心") Then
                                    lng配制中心 = Val(.TextMatrix(i, COL_执行科室ID)): Exit For
                                End If
                            End If
                        End If
                    Next
                End If
                '这两种情况所有药品都执行科室相同，检查存储设定
                If lng配制中心 <> 0 Then
                    For i = lngBegin To lngEnd
                        If i <> lngRow And Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                            '自备药不管它
                            If Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                                str药房IDs = Get可用药房IDs(.TextMatrix(i, COL_类别), Val(.TextMatrix(i, COL_诊疗项目ID)), Val(.TextMatrix(i, COL_收费细目ID)), mlng病人科室id, 2)
                                If InStr("," & str药房IDs & ",", "," & cbo执行科室.ItemData(cbo执行科室.ListIndex) & ",") = 0 Then
                                    If mblnChecking = False Then
                                        MsgBox "一并给药的药品中，""" & .TextMatrix(i, col_医嘱内容) & """在""" & zlCommFun.GetNeedName(cbo执行科室.Text) & """中没有存储。", vbInformation, gstrSysName
                                    End If
                                    '恢复成现有的科室(不引发Click)
                                    intIdx = Cbo.FindIndex(cbo执行科室, Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_执行科室ID)))
                                    Call Cbo.SetIndex(cbo执行科室.hwnd, intIdx)
                                    Exit Sub
                                End If
                            End If
                        End If
                    Next
                End If
            End If
        End With
        

        cbo执行科室.Tag = "1"
        
        '更新更改了的执行科室医嘱内容
        Call AdviceChange
        
        '重新获取库存并显示：以住院单位，中药配方不显示
        With vsAdvice
            If (.TextMatrix(lngRow, COL_类别) = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 1 _
                Or InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0) And Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
                Call GetDrugStock(lngRow)
                If InStr(GetInsidePrivs(p住院医嘱下达), "显示药品库存") = 0 Then
                    stbThis.Panels(3).Text = IIF(Val(.TextMatrix(lngRow, COL_库存)) > 0, "有库存", "无库存")
                Else
                    stbThis.Panels(3).Text = "库存: " & FormatEx(Val(.TextMatrix(lngRow, COL_库存)), 5) & .TextMatrix(lngRow, COL_住院单位)
                End If
            ElseIf RowIn配方行(lngRow) Then
                Call GetDrugStock(lngRow)
            End If
        End With
    End If
End Sub

Private Sub cbo执行科室_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo执行科室.ListIndex = -1 Then
            Call cbo执行科室_Validate(blnCancel)
        End If
        If Not blnCancel Then
            If SeekNextControl Then Call cbo执行科室_Validate(False)
        End If
    End If
End Sub

Private Sub cbo执行科室_GotFocus()
    Call zlControl.TxtSelAll(cbo执行科室)
End Sub

Private Sub cbo执行科室_Validate(Cancel As Boolean)
'功能：根据输入的内容,自动匹配执行科室
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, intIdx As Long, i As Long
    Dim blnLimit As Boolean, strInput As String, strIDs As String
    Dim vRect As RECT, blnCancel As Boolean, blnNode As Boolean, bln留观入院 As Boolean
    Dim str服务对象 As String
    
    On Error GoTo errH
    
    If cbo执行科室.ListIndex <> -1 Then Exit Sub '已选中
    If cbo执行科室.Text = "" Then '无输入
        If tbrFree.Buttons(1).value = 0 And cbo执行科室.ListCount > 0 Then Cancel = True
        Exit Sub
    End If
    
    '是否可以任意或选择科室
    blnLimit = True
    If cbo执行科室.ListCount > 0 Then
        If cbo执行科室.ItemData(cbo执行科室.ListCount - 1) = -1 Then
            blnLimit = False
        End If
    End If
    
    If bln留观入院 Then
        str服务对象 = " And B.服务对象 IN (2,3)"
    ElseIf mlng病人性质 = 1 Then
        str服务对象 = " And B.服务对象 IN (1,2,3)"
    Else
        str服务对象 = " And B.服务对象 IN (2,3)"
    End If
    
    '1-留观;2-住院;3-转科,7-会诊
    '转科和会诊、或留观病人入院，可输其他节点的科室
    blnNode = True
    With vsAdvice
        If .TextMatrix(.Row, COL_类别) = "Z" Then
            bln留观入院 = .TextMatrix(.Row, COL_操作类型) = "2" And mlng病人性质 = 1
            
            If InStr(",3,7,", "," & .TextMatrix(.Row, COL_操作类型) & ",") > 0 Or bln留观入院 Then
                blnNode = False
            End If
        End If
    End With
    
    strInput = UCase(zlCommFun.GetNeedName(cbo执行科室.Text))
    strSQL = "Select Distinct A.ID,A.编码,A.名称,A.简码" & _
        " From 部门表 A,部门性质说明 B" & _
        " Where A.ID=B.部门ID " & str服务对象 & _
        IIF(blnNode, " And (A.站点='" & gstrNodeNo & "' Or A.站点 is Null)", "") & _
        " And (A.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or A.撤档时间 is NULL)" & _
        " And (A.编码 Like [1] Or A.名称 Like [2] Or Upper(A.简码) Like [2])" & _
        " Order by A.编码"
    If blnLimit Then
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strInput & "%", mstrLike & strInput & "%")
        For i = 1 To rsTmp.RecordCount
            intIdx = Cbo.FindIndex(cbo执行科室, rsTmp!ID)
            If intIdx <> -1 Then strIDs = strIDs & "," & rsTmp!ID
            rsTmp.MoveNext
        Next
        
        If strIDs <> "" Then
            strIDs = Mid(strIDs, 2)
            If InStr(strIDs, ",") = 0 Then
                intIdx = Cbo.FindIndex(cbo执行科室, CLng(strIDs))
                If intIdx <> -1 Then cbo执行科室.ListIndex = intIdx
            Else
                strSQL = "Select A.ID,A.编码,A.名称,A.简码 From 部门表 A Where a.Id IN (Select /*+cardinality(x,10)*/ x.Column_Value From Table(Cast(f_Num2list([1]) As zlTools.t_Numlist)) X)"
                vRect = zlControl.GetControlRect(cbo执行科室.hwnd)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl执行科室.Caption, False, "", "", False, False, True, _
                    vRect.Left, vRect.Top, txt用法.Height, blnCancel, False, True, strIDs)
                If Not rsTmp Is Nothing Then
                    intIdx = Cbo.FindIndex(cbo执行科室, rsTmp!ID)
                    If intIdx <> -1 Then cbo执行科室.ListIndex = intIdx
                End If
            End If
        End If
        If cbo执行科室.ListIndex = -1 Then
            MsgBox "未到对应的科室。", vbInformation, gstrSysName
            Cancel = True: Exit Sub
        End If
    Else
        vRect = zlControl.GetControlRect(cbo执行科室.hwnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl执行科室.Caption, False, "", "", False, False, _
            True, vRect.Left, vRect.Top, txt用法.Height, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%")
        If Not rsTmp Is Nothing Then
            intIdx = Cbo.FindIndex(cbo执行科室, rsTmp!ID)
            If intIdx <> -1 Then
                cbo执行科室.ListIndex = intIdx
            Else
                cbo执行科室.AddItem rsTmp!编码 & "-" & rsTmp!名称, cbo执行科室.ListCount - 1
                cbo执行科室.ItemData(cbo执行科室.NewIndex) = rsTmp!ID
                cbo执行科室.ListIndex = cbo执行科室.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "未找到对应的科室。", vbInformation, gstrSysName
            End If
            Cancel = True: Exit Sub
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cbo执行时间_Change()
    cbo执行时间.Tag = "1"
End Sub

Private Sub cbo执行时间_Click()
    'cbo执行时间_Change
    '更新数据
    cbo执行时间.Tag = "1"
    Call AdviceChange
End Sub

Private Sub cbo执行时间_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo执行时间.ListIndex <> -1 Or cbo执行时间.Text <> "" Then
            If SeekNextControl Then Call cbo执行时间_Validate(False)
        End If
    Else
        If InStr("0123456789:-/" & Chr(8) & Chr(3) & Chr(22), Chr(KeyAscii)) = 0 Then
            KeyAscii = 0
        End If
    End If
End Sub

Private Sub cbo执行时间_Validate(Cancel As Boolean)
    Dim blnValid As Boolean, lngRow As Long, strTmp As String
    
    lngRow = vsAdvice.Row
        
    With vsAdvice
        If cbo执行时间.Text <> "" Then
            '检查长度
            If Len(cbo执行时间.Text) > 50 Then
                MsgBox "输入内容不能超过 50 个字符。", vbInformation, gstrSysName
                Call cbo执行时间_GotFocus
                Cancel = True: Exit Sub
            End If
            '检查合法性
            If .RowData(lngRow) <> 0 Then
                blnValid = ExeTimeValid(cbo执行时间.Text, Val(.TextMatrix(lngRow, COL_频率次数)), Val(.TextMatrix(lngRow, COL_频率间隔)), .TextMatrix(lngRow, COL_间隔单位))
                If Not blnValid Then
                    If .TextMatrix(lngRow, COL_间隔单位) = "周" Then
                        strTmp = COL_按周执行
                    ElseIf .TextMatrix(lngRow, COL_间隔单位) = "天" Then
                        strTmp = COL_按天执行
                    ElseIf .TextMatrix(lngRow, COL_间隔单位) = "小时" Then
                        strTmp = COL_按时执行
                    End If
                    MsgBox "输入的执行时间方案格式不正确，请检查。" & vbCrLf & vbCrLf & "例：" & vbCrLf & strTmp, vbInformation, gstrSysName
                    Call cbo执行时间_GotFocus
                    Cancel = True: Exit Sub
                End If
            End If
        Else
            '可选频率的长嘱必须输入执行时间
            If .TextMatrix(lngRow, COL_期效) = "长嘱" And .TextMatrix(lngRow, COL_频率) <> "" Then
                MsgBox "可选频率的长期医嘱必须输入执行时间方案。", vbInformation, gstrSysName
                Call cbo执行时间_GotFocus
                Cancel = True: Exit Sub
            End If
        End If
    End With
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub cbo执行性质_Click()
    cbo执行性质.Tag = "1"
    '更新数据
    Call AdviceChange
End Sub

Private Sub cbo执行性质_KeyPress(KeyAscii As Integer)
    Dim lngIdx As Long
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo执行性质.ListIndex <> -1 Then
            Call SeekNextControl
        End If
    ElseIf KeyAscii >= 32 Then
        lngIdx = Cbo.MatchIndex(cbo执行性质.hwnd, KeyAscii)
        If lngIdx = -1 And cbo执行性质.ListCount > 0 Then lngIdx = 0
        cbo执行性质.ListIndex = lngIdx
    End If
End Sub

Private Sub chk紧急_Click()
    If Not mblnDoCheck Then Exit Sub
        
    '未录入项目时：紧急不能同时是补录
    If vsAdvice.RowData(vsAdvice.Row) = 0 Then
        If IsDate(msk开始时间.Text) Then
            If DateDiff("n", CDate(msk开始时间.Text), zlDatabase.Currentdate) > gint补录间隔 Then
                msk开始时间.Text = GetDefaultTime(vsAdvice.Row, True)
            End If
        End If
    End If
        
    chk紧急.Tag = "1"
    '更新数据
    Call AdviceChange
    
    If txt用药理由.Enabled And Trim(txt用药理由.Text) = "" Then
        txt用药理由.SetFocus
    End If
End Sub

Private Sub chk紧急_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call SeekNextControl
    End If
End Sub

Private Sub cmdExt_Click()
'功能：修改现有医嘱的扩充内容
    Dim rsCurr As New ADODB.Recordset
    Dim strExtData As String, strAppend As String
    Dim lngRow As Long, lngFirstRow As Long
    Dim lng诊疗项目ID As Long, lng用法ID As Long
    Dim strMsg As String, vMsg As VbMsgBoxResult
    Dim strTmp As String, datCurr As Date
    
    Dim lng婴儿 As Long, lng路径项目ID As Long, lng执行方式 As Long, str路径项目分类 As String
    Dim lng选择 As Long, str选择 As String
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim lng配方ID As Long
    Dim strExtDataHistory As String
    Dim lng改动中药味数 As Long, dbl中药味数 As Double
    Dim arrTmp As Variant, strSQL As String, rsTmp As Recordset
    Dim vRect As RECT, blnCancel As Boolean
    Dim str变异原因 As String, str变异编码 As String
    Dim t_Pati As TYPE_PatiInfoEx
    Dim intType As Integer, lng项目id As Long
    Dim blnOK As Boolean
    Dim str手术部位 As String
    Dim strIDs1 As String, strIDs2 As String, str医嘱内容 As String
    Dim lngAppType As Long '申请单应用
    Dim objAppPages()  As clsApplicationData
    Dim rsCard As ADODB.Recordset
    Dim lngNo As Long
    Dim lngTmp As Long
    Dim str摘要 As String '医保摘要 GetItemInfo
    Dim j As Long
    
    If mlng路径状态 = 1 And mbytUseType = 0 And cbo婴儿.ListIndex <= 0 Then
        Set rsTmp = GetPatiPathInfo(mlng病人ID, mlng主页ID)
        If rsTmp.RecordCount = 0 Then
            MsgBox "必须先生成第一天的内容后再修改和调整医嘱。", vbInformation, gstrSysName
            Exit Sub
        End If
    End If
    
    lngRow = vsAdvice.Row
    '读取申请附项内容：不管新录医嘱，在录入、调成套、复制时已读取
    If vsAdvice.TextMatrix(lngRow, COL_附项) = "" And Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
        If Not RowIn配方行(lngRow) Then
            vsAdvice.TextMatrix(lngRow, COL_附项) = Get病人医嘱附件(vsAdvice.RowData(vsAdvice.Row))
        End If
    End If
    strAppend = vsAdvice.TextMatrix(lngRow, COL_附项)
    
    lngNo = Val(vsAdvice.TextMatrix(lngRow, COL_申请序号) & "")
    
    If lngNo <> 0 Then
        strSQL = "Select 文件ID From 医嘱申请单文件 Where 医嘱ID=[1] And RowNum<2"
        On Error GoTo errH
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, IIF(Val(vsAdvice.TextMatrix(lngRow, COL_相关ID)) = 0, Val(vsAdvice.RowData(lngRow)), Val(vsAdvice.TextMatrix(lngRow, COL_相关ID))))
        If rsTmp.RecordCount > 0 Then Call FuncApplyCustom(1, Val(rsTmp!文件ID), lngNo): Exit Sub
    End If
    
    intType = -1
    lngAppType = -1
    
    If Val(vsAdvice.TextMatrix(lngRow, COL_申请序号) & "") <> 0 Then
        If vsAdvice.TextMatrix(lngRow, COL_类别) = "Z" Then
            If vsAdvice.TextMatrix(lngRow, COL_操作类型) = "7" Then
                strTmp = "会诊"
                If lngNo > 0 Then
                    Call Apply会诊(lngRow, 2, Val(vsAdvice.RowData(vsAdvice.Row)), Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID)), lngNo)
                Else
                    Call Apply会诊(lngRow, 1, 0, Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID)))
                End If
                Exit Sub
            End If
        End If
    End If
        
    If vsAdvice.TextMatrix(lngRow, COL_类别) = "D" Then
        If lngNo <> 0 Then
            Call GetData检查申请(lngRow, objAppPages())
            lngAppType = 0
        Else
            strExtData = Get检查部位方法(lngRow)
            If strExtData = "" Then
                MsgBox "该检查医嘱是系统升级以前下达的，与现有方式不兼容。请重新下达该检查医嘱。", vbInformation, gstrSysName
                Exit Sub
            End If
            intType = 0
        End If
    ElseIf vsAdvice.TextMatrix(lngRow, COL_类别) = "F" Then
        If CanUseApply("F") Then '手术申请单不需要用申请序号区分
            Call GetData手术申请(lngRow, rsCard)
            lngAppType = 2
        Else
            strExtData = Get手术附加IDs(lngRow)
            intType = 1
        End If
    ElseIf RowIn配方行(lngRow) Then
        strExtData = Get中药配方IDs(lngRow)
        intType = 2
         '记录下原配方数据
        If mbytUseType = 1 Then
            If vsAdvice.TextMatrix(lngRow, COL_原始中药配方) = "" Then
                strExtDataHistory = strExtData
                 vsAdvice.TextMatrix(lngRow, COL_原始中药配方) = strExtDataHistory
            Else
                strExtDataHistory = vsAdvice.TextMatrix(lngRow, COL_原始中药配方)
            End If
        End If
    ElseIf RowIn检验行(lngRow) Then
        If lngNo <> 0 Then
            lngAppType = 3
            Call GetData检验申请(lngRow, rsCard)
        Else
            strExtData = Get检验组合IDs(lngRow)
            intType = 4
        End If
    ElseIf vsAdvice.TextMatrix(lngRow, COL_类别) = "E" Or vsAdvice.TextMatrix(lngRow, COL_类别) = "K" Or vsAdvice.TextMatrix(lngRow, COL_类别) = "Z" Then
        If CanUseApply(vsAdvice.TextMatrix(lngRow, COL_类别)) And vsAdvice.TextMatrix(lngRow, COL_类别) = "K" Then
            Call GetData输血申请(lngRow, rsCard)
            lngAppType = 1
        Else
            intType = 5
            If vsAdvice.TextMatrix(lngRow, COL_类别) = "K" Then
                If Val(vsAdvice.TextMatrix(lngRow, COL_申请序号) & "") <> 0 Then
                    Call frmApplyBlood.ShowMe(Me, mlng病人ID, mlng主页ID, IIF(mlng病人性质 = 1, 1, 0), 3, Val(vsAdvice.RowData(lngRow)), mlng病人科室id, mlng病人病区ID, Val(vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID)), mintPState, , , mclsMipModule, , , , , mint婴儿)
                    Exit Sub
                End If
            End If
        End If
    Else
        Exit Sub '兼容以前的检验项目
    End If
    
    If intType = 4 Then
        lngFirstRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_相关ID)
        lng项目id = Val(vsAdvice.TextMatrix(lngFirstRow, COL_诊疗项目ID))
    Else
        lng项目id = Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID))
    End If
    With t_Pati
        .bln医保 = InStr(",1,2,", mstr付款码) > 0 And mstr付款码 <> ""
        .int险类 = mint险类
        .int婴儿 = mint婴儿
        .lng病人ID = mlng病人ID
        .lng主页ID = mlng主页ID
        .lng病人科室ID = mlng病人科室id
        .str性别 = mstr性别
    End With

    On Error Resume Next
    '改造接口：添加了mbytUseType的传入
    If intType = 2 Then
        blnOK = frmAdviceFormula.ShowMe(Me, gclsInsure, txt医嘱内容.hwnd, t_Pati, mint场合, mbytUseType, cbo期效.ListIndex, _
                    IIF(mlng病人性质 = 1, 1, 2), 2, lng项目id, strExtData, str摘要, , , mstr药品价格等级)
    ElseIf intType <> -1 Then
        blnOK = frmAdviceEditEx.ShowMe(Me, txt医嘱内容.hwnd, t_Pati, mint场合, intType, mbytUseType, cbo期效.ListIndex, _
                    IIF(mlng病人性质 = 1, 1, 2), 2, mblnNewLIS, False, lng项目id, strExtData, strAppend, , , str手术部位)
    End If
    
    '申请单
    If lngAppType = 0 Then
        blnOK = ApplyNew检查申请(1, "", objAppPages())
    ElseIf lngAppType = 1 Then
        blnOK = ApplyNew输血申请(1, "", rsCard)
    ElseIf lngAppType = 2 Then
        blnOK = ApplyNew手术申请(1, "", rsCard)
    ElseIf lngAppType = 3 Then
        blnOK = ApplyNew检验申请(1, "", rsCard)
    End If
    
    On Error GoTo 0
    
    If blnOK Then
        '非补录医嘱更新开嘱时间
        If Val(vsAdvice.TextMatrix(lngRow, COL_标志)) <> 2 Then
            datCurr = zlDatabase.Currentdate
            vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = Format(datCurr, "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = Format(datCurr, "yyyy-MM-dd HH:mm")
            txt开嘱时间.Text = vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间)
        End If
        
        vsAdvice.TextMatrix(lngRow, COL_单价) = "" '清除重新计算
        
        '记录临床路径的相关数据
        If mlng路径状态 = 1 Then
            lng路径项目ID = Val(vsAdvice.TextMatrix(lngRow, COL_路径项目ID))
            str路径项目分类 = vsAdvice.TextMatrix(lngRow, COL_路径项目分类)
            lng婴儿 = Val(vsAdvice.TextMatrix(lngRow, COL_婴儿))
            lng执行方式 = Val(vsAdvice.TextMatrix(lngRow, COL_路径执行方式))
            lng选择 = Val(vsAdvice.Cell(flexcpChecked, lngRow, COL_选择))
            str选择 = vsAdvice.TextMatrix(lngRow, COL_选择)
        End If
        
        If vsAdvice.TextMatrix(lngRow, COL_类别) = "D" Then
            If lngAppType = 0 Then
                Call Delete检查手术输血(lngRow, True, lngTmp)
                lngRow = lngTmp
                Call AdviceSet检查申请(lngRow, objAppPages())
                strAppend = vsAdvice.TextMatrix(lngRow, COL_附项)
            Else
                '检查组合
                Call AdviceSet检查组合(lngRow, strExtData)
                vsAdvice.TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
            End If
            txt医嘱内容.Text = vsAdvice.TextMatrix(lngRow, col_医嘱内容)
        ElseIf vsAdvice.TextMatrix(lngRow, COL_类别) = "F" Then
            If lngAppType = 2 Then
                Call Delete检查手术输血(lngRow)
                Call DeleteRow(lngRow, True)
                Call AdviceSet手术申请(lngRow, rsCard)
                strAppend = vsAdvice.TextMatrix(lngRow, COL_附项)
            Else
                '一组手术
                Call AdviceSet手术组合(lngRow, strExtData)
                vsAdvice.Cell(flexcpData, lngRow, COL_标本部位) = str手术部位
            End If
            vsAdvice.TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
            txt医嘱内容.Text = vsAdvice.TextMatrix(lngRow, col_医嘱内容)
        ElseIf lngAppType = 1 Then
            Call Delete检查手术输血(lngRow)
            Call DeleteRow(lngRow, True)
            Call AdviceSet输血申请(lngRow, rsCard)
            txt医嘱内容.Text = vsAdvice.TextMatrix(lngRow, col_医嘱内容)
            strAppend = ""
        ElseIf lngAppType = 3 Then
            Call Delete检验申请单(lngRow, True, lngTmp)
            lngRow = lngTmp
            Call AdviceSet检验申请(lngRow, rsCard)
            strAppend = vsAdvice.TextMatrix(lngRow, COL_附项)
            txt医嘱内容.Text = vsAdvice.TextMatrix(lngRow, col_医嘱内容)
        ElseIf RowIn检验行(lngRow) Then
            '检验组合
            lngFirstRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_相关ID)
            lng用法ID = Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID))
            
            '先获取当前已经设置好值
            rsCurr.Fields.Append "Edit", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "医嘱ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "执行科室ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "频率", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "频率次数", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "频率间隔", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "间隔单位", adVarChar, 4, adFldIsNullable
            rsCurr.Fields.Append "总量", adDouble, , adFldIsNullable
            rsCurr.Fields.Append "执行时间", adVarChar, 50, adFldIsNullable
            rsCurr.Fields.Append "开始时间", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "开嘱医生", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "开嘱科室ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "开嘱时间", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "医生嘱托", adVarChar, 100, adFldIsNullable
            rsCurr.Fields.Append "标志", adVarChar, 4, adFldIsNullable
            
            rsCurr.CursorLocation = adUseClient
            rsCurr.LockType = adLockOptimistic
            rsCurr.CursorType = adOpenStatic
            rsCurr.Open
            rsCurr.AddNew
                        
            '采集方法的执行科室可能与检验项目不同
            If Val(vsAdvice.TextMatrix(lngFirstRow, COL_执行科室ID)) <> 0 Then
                rsCurr!执行科室ID = Val(vsAdvice.TextMatrix(lngFirstRow, COL_执行科室ID))
            End If
            If Val(vsAdvice.TextMatrix(lngRow, COL_总量)) <> 0 Then
                rsCurr!总量 = Val(vsAdvice.TextMatrix(lngRow, COL_总量))
            End If
            rsCurr!执行时间 = vsAdvice.TextMatrix(lngRow, COL_执行时间)
            rsCurr!频率 = vsAdvice.TextMatrix(lngRow, COL_频率)
            rsCurr!频率次数 = Val(vsAdvice.TextMatrix(lngRow, COL_频率次数))
            rsCurr!频率间隔 = Val(vsAdvice.TextMatrix(lngRow, COL_频率间隔))
            rsCurr!间隔单位 = vsAdvice.TextMatrix(lngRow, COL_间隔单位)
            rsCurr!开始时间 = vsAdvice.Cell(flexcpData, lngRow, COL_开始时间)
            rsCurr!开嘱医生 = vsAdvice.TextMatrix(lngRow, COL_开嘱医生)
            rsCurr!开嘱科室id = Val(vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID))
            rsCurr!开嘱时间 = vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间)
            rsCurr!医生嘱托 = vsAdvice.TextMatrix(lngRow, COL_医生嘱托)
            rsCurr!标志 = vsAdvice.TextMatrix(lngRow, COL_标志)
            '修改了检验组合内容,采集方法行应标记为修改
            rsCurr!Edit = Val(vsAdvice.TextMatrix(lngRow, COL_EDIT))
            rsCurr!医嘱ID = vsAdvice.RowData(lngRow)
            rsCurr.Update
            
            '完全重新设置该检验组合
            '------------------------
            '删除检验项目行:删除之后重新定位的当前行
            lngRow = Delete检验组合(lngRow)
            '清除当前行(采集方法行)
            Call DeleteRow(lngRow, True, False)
            '重新产生:产生之后重新定位的当前行
            lngRow = AdviceSet检验组合(lngRow, lng用法ID, strExtData, rsCurr)
            If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow, lng路径项目ID, str路径项目分类)
        ElseIf RowIn配方行(lngRow) Then
            '如果是临床路径生成，则检查修改的中药（增删改）是否超过的设定的比例(修改脚注不算修改)
            If mbytUseType = 1 Then
                '先判断参数比例
                If mlng中药味数 > 0 Then
                    '可修改的中药味数是原始配方味数*比例
                    dbl中药味数 = (UBound(Split(Split(strExtDataHistory, "|")(0), ";")) + 1) * mlng中药味数 / 100
                    arrTmp = Split(Split(strExtDataHistory, "|")(0), ";")
                    strExtDataHistory = ""
                    For i = 0 To UBound(arrTmp)
                        If arrTmp(i) <> "" Then
                            strExtDataHistory = strExtDataHistory & ";" & Split(arrTmp(i), ",")(0) & "," & Split(arrTmp(i), ",")(1)
                        End If
                    Next
                    If strExtDataHistory <> "" Then
                        strExtDataHistory = strExtDataHistory & ";"
                        If UBound(arrTmp) > UBound(Split(Split(strExtData, "|")(0), ";")) Then lng改动中药味数 = UBound(arrTmp) - UBound(Split(Split(strExtData, "|")(0), ";"))
                        arrTmp = Split(Split(strExtData, "|")(0), ";")
                        For i = 0 To UBound(arrTmp)
                            If arrTmp(i) <> "" Then
                                If InStr(strExtDataHistory, ";" & Split(arrTmp(i), ",")(0) & "," & Split(arrTmp(i), ",")(1) & ";") = 0 Then
                                    lng改动中药味数 = lng改动中药味数 + 1
                                End If
                            End If
                        Next
                        If lng改动中药味数 > dbl中药味数 Then
                            If vsAdvice.Cell(flexcpData, lngRow, COL_超量说明) = "" Then
                                strSQL = "Select b.名称 as 分类,a.编码 as ID,a.编码,a.名称,a.简码 From 变异常见原因 a,变异常见原因 b" & _
                                        " Where a.性质=1 And a.末级=1 And a.上级=b.编码 And b.末级=0 " & _
                                        " Order by 分类,a.编码"
                                vRect = zlControl.GetControlRect(txt超量说明.hwnd)
ReSelect:
                                Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, "变异常见原因", , , , , , True, vRect.Left, vRect.Top, txt超量说明.Height, blnCancel, , True)
                                If rsTmp Is Nothing Then
                                    If Not blnCancel Then
                                        MsgBox "系统没有初始变异常见原因，请与系统管理员联系。", vbInformation, gstrSysName
                                        Exit Sub
                                    Else
                                        MsgBox "修改的中药配方超出了允许修改的味数，必须填写变异原因。"
                                        GoTo ReSelect
                                    End If
                                Else
                                    str变异原因 = rsTmp!名称 & ""
                                    str变异编码 = rsTmp!编码 & ""
                                End If
                            Else
                                str变异原因 = vsAdvice.TextMatrix(lngRow, COL_超量说明)
                                str变异编码 = vsAdvice.Cell(flexcpData, lngRow, COL_超量说明)
                            End If
                        End If
                    End If
                End If
            End If
            '中药配方
            lngFirstRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_相关ID)
            lng诊疗项目ID = Val(vsAdvice.TextMatrix(lngFirstRow, COL_诊疗项目ID))
            lng用法ID = Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID))
            
            '先获取当前已经设置好值
            rsCurr.Fields.Append "Edit", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "医嘱ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "执行性质", adVarChar, 10, adFldIsNullable
            rsCurr.Fields.Append "执行科室ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "频率", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "频率次数", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "频率间隔", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "间隔单位", adVarChar, 4, adFldIsNullable
            rsCurr.Fields.Append "总量", adDouble, , adFldIsNullable
            rsCurr.Fields.Append "执行时间", adVarChar, 50, adFldIsNullable
            rsCurr.Fields.Append "开始时间", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "终止时间", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "开嘱医生", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "开嘱科室ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "开嘱时间", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "医生嘱托", adVarChar, 100, adFldIsNullable
            rsCurr.Fields.Append "标志", adVarChar, 4, adFldIsNullable
            
            rsCurr.CursorLocation = adUseClient
            rsCurr.LockType = adLockOptimistic
            rsCurr.CursorType = adOpenStatic
            rsCurr.Open
            rsCurr.AddNew
            
            rsCurr!执行性质 = zlCommFun.GetNeedName(cbo执行性质.Text) '正常,自备药,离院带药
            
            '取配方界面选择的药房
            rsCurr!执行科室ID = Val(Split(strExtData, "|")(4))
            
            rsCurr!频率 = vsAdvice.TextMatrix(lngFirstRow, COL_频率)
            rsCurr!频率次数 = Val(vsAdvice.TextMatrix(lngFirstRow, COL_频率次数))
            rsCurr!频率间隔 = Val(vsAdvice.TextMatrix(lngFirstRow, COL_频率间隔))
            rsCurr!间隔单位 = vsAdvice.TextMatrix(lngFirstRow, COL_间隔单位)
            
            '取配方界面选择的付数
            rsCurr!总量 = Val(Split(strExtData, "|")(3))
            
            rsCurr!执行时间 = vsAdvice.TextMatrix(lngFirstRow, COL_执行时间)
            rsCurr!开始时间 = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开始时间)
            rsCurr!终止时间 = vsAdvice.Cell(flexcpData, lngFirstRow, COL_终止时间)
            rsCurr!开嘱医生 = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱医生)
            rsCurr!开嘱科室id = Val(vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID))
            rsCurr!开嘱时间 = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开嘱时间)
            rsCurr!医生嘱托 = vsAdvice.TextMatrix(lngRow, COL_医生嘱托)
            rsCurr!标志 = vsAdvice.TextMatrix(lngRow, COL_标志)
            '修改了配方内容,用法行应标记为修改
            rsCurr!Edit = Val(vsAdvice.TextMatrix(lngRow, COL_EDIT))
            rsCurr!医嘱ID = vsAdvice.RowData(lngRow)
            
            rsCurr.Update
            
            '完全重新设置该中药配方行
            '------------------------
            '删除组成味药及煎法行:删除之后重新定位的当前行
            lngRow = Delete中药配方(lngRow)
            '如果当前用法的配方ID不为空，则传入配方ID
            lng配方ID = Val(vsAdvice.TextMatrix(lngRow, COL_配方ID))
            '清除当前行(中药用法行)
            Call DeleteRow(lngRow, True, False)
            '产生配方:产生之后重新定位的当前行
            lngRow = AdviceSet中药配方(lng诊疗项目ID, lngRow, lng用法ID, strExtData, rsCurr, str摘要, lng配方ID)
            If str变异原因 <> "" And str变异编码 <> "" Then
                vsAdvice.TextMatrix(lngRow, COL_超量说明) = str变异原因
                vsAdvice.Cell(flexcpData, lngRow, COL_超量说明) = str变异编码
            End If
            If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow, lng路径项目ID, str路径项目分类)
        End If
        
        '更新附件内容:以当前可见行为准
        If strAppend <> "" Then
            vsAdvice.TextMatrix(lngRow, COL_附项) = strAppend
            vsAdvice.Cell(flexcpData, lngRow, COL_附项) = 1 '表明需要重新写入(新增或修改)
            Call ReplaceAdviceAppend(lngRow) '缺省替换其他医嘱的申请附项
        End If
        
        '如果是手术医嘱要判断主刀医生
        If gbln手术等级管理 Then
            With vsAdvice
                If .TextMatrix(lngRow, COL_类别) = "F" Then
                    .TextMatrix(lngRow, COL_审核状态) = IIF(gbln手术分级管理 And Val(.TextMatrix(lngRow, COL_标志)) <> 1, "1", "")
                    If Val(.TextMatrix(lngRow, COL_审核状态)) = 1 Then
                        If gbln手术授权管理 Then
                            If gbln手术等级管理 Then
                                If CheckDocEmpower(.TextMatrix(lngRow, COL_诊疗项目ID), .TextMatrix(lngRow, COL_附项)) Then
                                    .TextMatrix(lngRow, COL_审核状态) = ""
                                End If
                            End If
                        Else
                            If gbln手术等级管理 Then
                                If CheckDoc手术等级(Val(.TextMatrix(lngRow, COL_诊疗项目ID)), .TextMatrix(lngRow, COL_附项)) Then
                                    .TextMatrix(lngRow, COL_审核状态) = ""
                                End If
                            End If
                        End If
                    End If
                    Call GetRowScope(lngRow, lngBegin, lngEnd)
                    For j = lngBegin To lngEnd
                        If j <> lngRow Then
                            .TextMatrix(j, COL_审核状态) = .TextMatrix(lngRow, COL_审核状态)
                        End If
                    Next
                End If
                Call SetRow标志图标(lngRow)
            End With
        End If
        
        '恢复临床路径相关数据
        If mlng路径状态 = 1 Then
            Call GetRowScope(lngRow, lngBegin, lngEnd)
            For i = lngBegin To lngEnd
                vsAdvice.TextMatrix(i, COL_婴儿) = lng婴儿
                vsAdvice.TextMatrix(i, COL_路径项目ID) = lng路径项目ID
                vsAdvice.TextMatrix(i, COL_路径项目分类) = str路径项目分类
                vsAdvice.TextMatrix(i, COL_路径执行方式) = lng执行方式
                vsAdvice.Cell(flexcpChecked, i, COL_选择) = lng选择
                vsAdvice.TextMatrix(i, COL_选择) = str选择
                If str选择 = "√" Then
                    vsAdvice.Cell(flexcpBackColor, i, COL_选择) = &H8000000F
                End If
                vsAdvice.Cell(flexcpPictureAlignment, i, COL_选择) = flexPicAlignCenterCenter
            Next
        End If
        
        '强行显示当前医嘱卡片
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
        
        If InStr(",0,3,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = 2 '标记为被修改
            vsAdvice.TextMatrix(lngRow, COL_状态) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_状态)) = -1, -1, 1) '修改后变为新开
            Call ReSetColor(lngRow)
        End If
        
        mblnNoSave = True '标记为未保存
    End If
    
    Call vsAdvice.AutoSize(col_医嘱内容)
    
    '对保险对码进行检查
    Call GetInsureStr(strIDs1, strIDs2, str医嘱内容, vsAdvice.Row)
    strMsg = CheckAdviceInsure(mint险类, mbln提醒对码, mlng病人ID, mlng病人性质, strIDs1, strIDs2, str医嘱内容, mlng病人病区ID)
    If strMsg <> "" Then
        If gint医保对码 = 2 Then strMsg = strMsg & vbCrLf & vbCrLf & "请先和相关人员联系处理，否则医嘱将不允许保存。"
        vMsg = frmMsgBox.ShowMsgBox(strMsg, Me, True)
        If vMsg = vbIgnore Then mbln提醒对码 = False
    End If
    
    If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub ReplaceAdviceAppend(ByVal lngRow As Long)
'功能：根据指定行的申请附项输入情况，对其他新录医嘱的申请附项进行缺省替换
'参数：lngRow=才新输入或修改的可见医嘱行
    Dim strAppend As String, i As Long
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_附项) = "" Then Exit Sub
        
        For i = .FixedRows To .Rows - 1
            '只针对新录入的医嘱，修改的医嘱修改时已检查
            '".Cell(flexcpData, i, COL_附项) = 1"的可能还没有在输入过程中检查，只是自动替换了
            If .RowData(i) <> 0 And Not .RowHidden(i) And i <> lngRow And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                If .TextMatrix(i, COL_附项) <> "" Then
                    strAppend = ReplaceAppend(.TextMatrix(i, COL_附项), .TextMatrix(lngRow, COL_附项))
                    If .TextMatrix(i, COL_附项) <> strAppend Then
                        .TextMatrix(i, COL_附项) = strAppend
                        .Cell(flexcpData, i, COL_附项) = 1
                    End If
                End If
            End If
        Next
    End With
End Sub

Private Sub cmdPati_Click()
    If mblnRefresh = False Then Call LoadPatients(1)
    lvwPati.ListItems("_" & mlng病人ID & "_" & mlng主页ID).Selected = True
    lvwPati.SelectedItem.EnsureVisible
    lvwPati.Left = txtPati.Left + fraPati.Left
    lvwPati.Top = txtPati.Top + txtPati.Height + fraPati.Top
    
    lvwPati.Height = (lvwPati.ListItems.Count + 1) * 350 + 120
    lvwPati.Width = Me.Width - lvwPati.Left - 400
    If lvwPati.Height > vsAdvice.Height - 300 Then
        lvwPati.Height = vsAdvice.Height - 350
    End If
    lvwPati.Visible = True
    lvwPati.SetFocus
End Sub

Private Sub ClinicSelecter(Optional ByVal 类型 As Integer, Optional ByVal lng分类ID As Long)
    Dim rsTmp As ADODB.Recordset, rsInput As ADODB.Recordset
    Dim strSQL As String, lng药名ID As Long, lngRow As Long, str摘要 As String
    Dim intType As Integer
    Dim lng成套ID As Long, strMsg As String
    
    
    With vsAdvice
        lngRow = .Row
        
        If InStr(",4,5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            '成套定义为品种的药品和卫材提供选择其他规格的功能;复制其他病人的时，COL_EDIT中存储的是病人ID,主页ID
            '固定按品种下达的药品(药品特性.品种医嘱)
            If .TextMatrix(lngRow, COL_期效) = "临嘱" Or .TextMatrix(lngRow, COL_期效) = "长嘱" And gbln药品按规格下医嘱 And Val(.TextMatrix(lngRow, COL_品种医嘱)) = 0 Then
                If Val("" & .Cell(flexcpData, lngRow, COL_收费细目ID)) = 0 And InStr(CStr(.Cell(flexcpData, lngRow, COL_EDIT)), ",") = 0 Then
                    lng成套ID = Val("" & .Cell(flexcpData, lngRow, COL_EDIT))
                End If
            End If
        End If
    End With
    
    On Error GoTo errH
    If 类型 = 8 And lng分类ID <> 0 Then
        '直接读取选择的成套项目
        strSQL = "Select A.类别 As 类别ID,A.ID as 诊疗项目ID,Null as 收费细目ID,B.名称 As 类别,A.编码,A.名称,A.计算单位,A.标本部位,NULL as 项目特性" & _
            " From 诊疗项目目录 A,诊疗项目类别 B Where A.类别=B.编码 And A.ID=[1]"
        Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng分类ID)
    Else
        '成套医嘱，临床路径选择其他规格的药品
        If mbytUseType = 1 Or lng成套ID <> 0 Then lng药名ID = vsAdvice.TextMatrix(vsAdvice.Row, COL_诊疗项目ID)
        If mbytUseType = 1 And vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "4" Then
            intType = 1
        Else
            intType = 0
        End If
        
        '打开选择器，可能指定了初始分类目录
        Set rsInput = frmClinicSelect.ShowSelect(Me, mint场合, IIF(mlng会诊科室ID <> 0, 0, mlng病人病区ID), IIF(mlng会诊科室ID <> 0, mlng会诊科室ID, mlng病人科室id), _
            cbo期效.ListIndex, mstr性别, , , IIF(mlng病人性质 = 1, 1, 2), lng分类ID, mint险类, mlng病人性质, lng药名ID, , , , , , , mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, intType, mlng医技科室ID)
    End If
    If rsInput Is Nothing Then '取消或无数据
        zlControl.TxtSelAll txt医嘱内容
        If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
        Exit Sub
    End If
    
    If lng药名ID <> 0 Then
        '根据新的规格，重新设置相关列信息
        With vsAdvice
            .Redraw = flexRDNone
            If InStr(",5,6,", rsInput!类别ID) > 0 Then
                strSQL = "Select Nvl(C.名称,A.名称) as 名称," & _
                    " B.剂量系数,B.住院单位,B.住院包装,B.住院可否分零 As 可否分零,B.动态分零,b.高危药品,B.是否易至跌倒" & _
                    " From 收费项目目录 A,药品规格 B,收费项目别名 C" & _
                    " Where A.ID=B.药品ID And A.ID=[1]" & _
                    " And A.ID=C.收费细目ID(+) And C.码类(+)=1 And C.性质(+)=[2]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val("" & rsInput!收费细目ID), IIF(gbyt药品名称显示 = 0, 1, 3))
                .TextMatrix(lngRow, COL_剂量系数) = rsTmp!剂量系数
                .TextMatrix(lngRow, COL_住院单位) = rsTmp!住院单位
                .TextMatrix(lngRow, COL_总量单位) = rsTmp!住院单位
                .TextMatrix(lngRow, COL_住院包装) = rsTmp!住院包装
                .TextMatrix(lngRow, COL_可否分零) = NVL(rsTmp!可否分零, 0)
                .TextMatrix(lngRow, COL_动态分零) = NVL(rsTmp!动态分零, 0)
                .TextMatrix(lngRow, COL_高危药品) = NVL(rsTmp!高危药品, 0)
                .TextMatrix(lngRow, COL_易跌倒) = Val(rsTmp!是否易至跌倒 & "")
                If Val(.TextMatrix(lngRow, COL_高危药品)) <> 0 Then
                    MsgBox "当前新开的是" & Decode(Val(.TextMatrix(lngRow, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级高危药品，请谨慎使用。", vbInformation, Me.Caption
                End If
            ElseIf rsInput!类别ID = "4" Then
                strSQL = "Select A.跟踪在用,B.名称,B.计算单位,A.是否分零 From 材料特性 A,收费项目目录 B Where A.材料ID=B.ID And A.材料ID=[1]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val("" & rsInput!收费细目ID))
                .TextMatrix(lngRow, COL_剂量系数) = 1
                .TextMatrix(lngRow, COL_住院包装) = 1
                .TextMatrix(lngRow, COL_住院单位) = NVL(rsTmp!计算单位) '散装单位
                .TextMatrix(lngRow, COL_总量单位) = NVL(rsTmp!计算单位)
                .TextMatrix(lngRow, COL_跟踪在用) = NVL(rsTmp!跟踪在用, 0)
                .Cell(flexcpData, lngRow, COL_可否分零) = NVL(rsTmp!是否分零, 0)
            End If
            .TextMatrix(lngRow, COL_名称) = rsTmp!名称 '将别名换成正式规格名称
            .TextMatrix(lngRow, COL_收费细目ID) = Val("" & rsInput!收费细目ID)
            .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)

            str摘要 = gclsInsure.GetItemInfo(mint险类, mlng病人ID, NVL(rsInput!收费细目ID, 0), "", 0, "", rsInput!诊疗项目ID & "||2")
            .Cell(flexcpData, lngRow, COL_医生嘱托) = str摘要
            
            If (InStr(",5,6,", rsInput!类别ID) > 0 Or rsInput!类别ID = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 1) Then
                Call GetDrugStock(lngRow)
            End If
            .Redraw = flexRDDirect
        End With
        If mblnPass Then
            Call gobjPass.zlPassAdviceInput(mobjPassMap, rsInput!诊疗项目ID, NVL(rsInput!收费细目ID, 0))
        End If
        Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
    Else
        '根据选择项目设置缺省医嘱信息
        If AdviceInput(rsInput, vsAdvice.Row) Then
            '显示已缺省设置的值
            Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
            mbln刚录入 = True
            '医保管控实时监测
            If mint险类 <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
                '总量不可输入：缺省并固定总量的医嘱，以及长嘱
                '成套医嘱不在这里检查
                If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) And Not txt总量.Enabled Then
                    If MakePriceRecord(vsAdvice.Row) Then
                        If Not gclsInsure.CheckItem(mint险类, 1, 0, mrsPrice) Then
                            Call AdviceCurRowClear: Exit Sub
                        End If
                    End If
                    '标记为已经作了检查
                    vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_状态) = 1
                End If
            End If
                    
            If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
            Call SeekNextControl '必须先定位
        Else
            '恢复原值(AdviceInput函数中可能处理了一下)
            txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容)
            If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub cmdSel_Click()
    ClinicSelecter
End Sub

Private Sub cmd开始时间_Click()
    If IsDate(msk开始时间.Text) Then
        dtpDate.value = CDate(msk开始时间.Text)
    Else
        dtpDate.value = zlDatabase.Currentdate
    End If
    dtpDate.Tag = "开始时间"
    dtpDate.Left = msk开始时间.Left + fraAdvice.Left
    dtpDate.Top = msk开始时间.Top + fraAdvice.Top - dtpDate.Height
    dtpDate.Visible = True
    dtpDate.SetFocus
End Sub


Private Sub cmd终止时间_Click()
    If IsDate(txt终止时间.Text) Then
        dtpDate.value = CDate(txt终止时间.Text)
    Else
        dtpDate.value = zlDatabase.Currentdate
    End If
    dtpDate.Tag = lbl终止时间.Caption
    dtpDate.Left = txt终止时间.Left + txt终止时间.Width - dtpDate.Width + fraAdvice.Left
    dtpDate.Top = txt终止时间.Top + fraAdvice.Top - dtpDate.Height
    dtpDate.Visible = True
    dtpDate.SetFocus
End Sub

Private Sub dtpDate_DateClick(ByVal DateClicked As Date)
    Dim strDate As String
    
    If dtpDate.Tag = "开始时间" Then
        '取值
        If IsDate(msk开始时间.Text) Then
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(msk开始时间.Text, "yyyy-MM-dd HH:mm"), 12, 5)
        Else
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm"), 12, 5)
        End If
        
        '判断时间合法性
        If Not Check开始时间(strDate, txt终止时间.Text, , , vsAdvice.Row) Then
            dtpDate.SetFocus: Exit Sub
        End If
        
        msk开始时间.Text = strDate
        dtpDate.Tag = ""
        dtpDate.Visible = False
        Call msk开始时间_Validate(False) '更新数据
        msk开始时间.SetFocus
    ElseIf dtpDate.Tag = "安排时间" Then
        '取值
        If IsDate(txt安排时间.Text) Then
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(txt安排时间.Text, "yyyy-MM-dd HH:mm"), 12, 5)
        Else
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm"), 12, 5)
        End If
        
        '判断时间合法性
        If Not Check安排时间(strDate, msk开始时间.Text, vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) Then
            dtpDate.SetFocus: Exit Sub
        End If
        
        txt安排时间.Text = strDate
        dtpDate.Tag = ""
        dtpDate.Visible = False
        Call txt安排时间_Validate(False) '更新数据
        txt安排时间.SetFocus
    ElseIf dtpDate.Tag = "终止时间" Then
        '取值
        If IsDate(txt终止时间.Text) Then
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(msk开始时间.Text, "yyyy-MM-dd HH:mm"), 12, 5)
        Else
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm"), 12, 5)
        End If
                
        '判断时间合法性
        If Not Check终止时间(txt开嘱时间.Text, msk开始时间.Text, strDate) Then
            dtpDate.SetFocus: Exit Sub
        End If
        
        txt终止时间.Text = strDate
        dtpDate.Tag = ""
        dtpDate.Visible = False
        Call txt终止时间_Validate(False) '更新数据
        txt终止时间.SetFocus
    ElseIf dtpDate.Tag = "采集时间" Then
        '取值
        If IsDate(txt终止时间.Text) Then
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(txt终止时间.Text, "yyyy-MM-dd HH:mm"), 12, 5)
        Else
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm"), 12, 5)
        End If
        
        '判断时间合法性
        If Not Check开始时间(strDate, txt终止时间.Text, , , vsAdvice.Row, 2) Then
            dtpDate.SetFocus: Exit Sub
        End If
        
        txt终止时间.Text = strDate
        dtpDate.Tag = ""
        dtpDate.Visible = False
        Call txt终止时间_Validate(False) '更新数据
        msk开始时间.SetFocus
    End If
End Sub

Private Sub dtpDate_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call dtpDate_DateClick(dtpDate.value)
    End If
End Sub

Private Sub dtpDate_Validate(Cancel As Boolean)
    dtpDate.Visible = False
    If dtpDate.Tag = "终止时间" And ActiveControl Is msk开始时间 Then
        If txt终止时间.Enabled And txt终止时间.Visible Then txt终止时间.SetFocus
    ElseIf dtpDate.Tag = "安排时间" And ActiveControl Is msk开始时间 Then
        If txt安排时间.Enabled And txt安排时间.Visible Then txt安排时间.SetFocus
    End If
    dtpDate.Tag = ""
End Sub

Private Sub Form_Activate()
    If mblnRunFirst Then
        mblnRunFirst = False
        If mlng医嘱ID = 0 Then
            If cbo期效.Enabled And cbo期效.Visible Then
                cbo期效.SetFocus  '新增
            ElseIf txt医嘱内容.Enabled Then
                txt医嘱内容.SetFocus
            End If
        Else
            If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus '修改
        End If
        
        '第一次进入时将滚动条移到当前行，因为Load中不能移动滚动条。
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
        Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
        mblnRowMerge = False
    End If
End Sub

Private Sub Form_KeyDown(KeyCode As Integer, Shift As Integer)
    Dim str摘要 As String
    Dim str中药IDs As String
    Dim lngBaseRow As Long, i As Long
    Dim lng收费细目ID As Long, str诊疗项目ID As String
        
    If Shift = vbAltMask Then
        If Between(Chr(KeyCode), "1", "9") And Not mfrmShortCut Is Nothing Then
            Call mfrmShortCut.ShowShortCut(Val(Chr(KeyCode)))
        End If
        If KeyCode = vbKeyC Then  '打开列选择器
            Call imgColSel_MouseUp(1, 0, 0, 0)
        End If
    ElseIf Shift = vbCtrlMask And KeyCode = vbKeyD Then
        '保存常用嘱托
        If cmd常用嘱托.Enabled And cmd常用嘱托.Visible Then
            Call cmd常用嘱托_Click
        End If
    ElseIf KeyCode = vbKeyF1 And Shift = vbCtrlMask Then
        '调用医保提示
        With vsAdvice
            If .RowData(.Row) <> 0 Then
                lng收费细目ID = Val(.TextMatrix(.Row, COL_收费细目ID))
                str诊疗项目ID = Val(.TextMatrix(.Row, COL_诊疗项目ID))
                If RowIn配方行(.Row) Then
                    '获取中药配方第一味中药行
                    lngBaseRow = .FindRow(CStr(.RowData(.Row)), , COL_相关ID)
                    For i = lngBaseRow To .Row
                        If i = lngBaseRow Then lng收费细目ID = Val(.TextMatrix(i, COL_收费细目ID))
                        If .TextMatrix(i, COL_类别) = "7" Then
                            str中药IDs = str中药IDs & "," & .TextMatrix(i, COL_诊疗项目ID)
                        End If
                    Next
                    str中药IDs = Mid(str中药IDs, 2)
                    If UBound(Split(str中药IDs, ",")) <> 0 Then
                        lng收费细目ID = 0
                    End If
                    str诊疗项目ID = str中药IDs
                End If
                '医保病人输入内容时的提示：非医保病人也要调(Or And mint险类 <> 0)
                str摘要 = gclsInsure.GetItemInfo(mint险类, mlng病人ID, lng收费细目ID, CStr(.Cell(flexcpData, .Row, COL_医生嘱托)), 0, "", str诊疗项目ID & "||2")
                .Cell(flexcpData, .Row, COL_医生嘱托) = str摘要
            End If
        End With
    Else
        Select Case KeyCode
            Case vbKeyEscape
                If dtpDate.Visible Then
                    dtpDate.Visible = False
                    If dtpDate.Tag = "终止时间" Then
                        If txt终止时间.Visible And txt终止时间.Enabled Then txt终止时间.SetFocus
                    End If
                    dtpDate.Tag = ""
                ElseIf lvwPati.Visible Then
                    lvwPati.ListItems("_" & mlng病人ID & "_" & mlng主页ID).Selected = True
                    lvwPati.Visible = False
                End If
                If vsColumn.Visible Then '关闭列选择器
                    vsColumn.Visible = False
                    If vsAdvice.Enabled Then vsAdvice.SetFocus
                End If
            Case vbKeyF3
                If tbrFree.Buttons(1).Enabled And tbrFree.Buttons(1).Visible Then
                    tbrFree.Buttons(1).value = IIF(tbrFree.Buttons(1).value = 1, 0, 1)
                    Call tbrFree_ButtonClick(tbrFree.Buttons(1))
                End If
            Case vbKeyF4, vbKeyUp, vbKeyDown
                If Me.ActiveControl Is msk开始时间 Then
                    If cmd开始时间.Visible And cmd开始时间.Enabled Then cmd开始时间_Click
                ElseIf Me.ActiveControl Is txt安排时间 Then
                    If cmd安排时间.Enabled And cmd安排时间.Visible Then cmd安排时间_Click
                ElseIf Me.ActiveControl Is txt终止时间 Then
                    If cmd终止时间.Enabled And cmd终止时间.Visible Then cmd终止时间_Click
                ElseIf Me.ActiveControl Is txt医嘱内容 Then
                    If cmdExt.Visible And cmdExt.Enabled Then cmdExt_Click
                ElseIf Me.ActiveControl Is txt用法 Then
                    If cmd用法.Visible And cmd用法.Enabled Then cmd用法_Click
                ElseIf Me.ActiveControl Is txt频率 Then
                    If cmd频率.Visible And cmd频率.Enabled Then cmd频率_Click
                ElseIf Me.ActiveControl Is txtPati Then
                    If cmdPati.Visible And cmdPati.Enabled Then cmdPati_Click
                End If
            Case vbKeyF7 '切换输入法
                If stbThis.Panels("WB").Visible And stbThis.Panels("PY").Visible Then
                    If stbThis.Panels("WB").Bevel = sbrRaised Then
                        Call stbThis_PanelClick(stbThis.Panels("WB"))
                    Else
                        Call stbThis_PanelClick(stbThis.Panels("PY"))
                    End If
                End If
            Case vbKeyF8 '切换显示计价项目
                If stbThis.Panels("Price").Visible Then
                    Call stbThis_PanelClick(stbThis.Panels("Price"))
                End If
        End Select
    End If
End Sub

Private Sub Form_KeyPress(KeyAscii As Integer)
    If KeyAscii = Asc("'") Then
        KeyAscii = 0
    ElseIf KeyAscii = Asc("`") Then
        KeyAscii = 0
        If Not mfrmShortCut Is Nothing Then
            Call mfrmShortCut.ShowMe(Me, mint场合, IIF(mlng病人性质 = 1, 3, 2), mlng病人病区ID, mlng病人科室id, False, mlng医技科室ID)
        End If
    ElseIf KeyAscii = vbKeySpace Then
        If Me.ActiveControl Is msk开始时间 And msk开始时间.SelLength = Len(msk开始时间.Text) Then
            KeyAscii = 0
            If cmd开始时间.Visible And cmd开始时间.Enabled Then cmd开始时间_Click
        ElseIf Me.ActiveControl Is txt安排时间 And txt安排时间.SelLength = Len(txt安排时间.Text) Then
            KeyAscii = 0
            If cmd安排时间.Enabled And cmd安排时间.Visible Then cmd安排时间_Click
        ElseIf Me.ActiveControl Is txt终止时间 And txt终止时间.SelLength = Len(txt终止时间.Text) Then
            KeyAscii = 0
            If cmd终止时间.Enabled And cmd终止时间.Visible Then cmd终止时间_Click
        ElseIf Me.ActiveControl Is txt医嘱内容 Then
            If tbrFree.Buttons(1).value = 0 Then
                KeyAscii = 0
                If cmdExt.Visible And cmdExt.Enabled Then cmdExt_Click
            End If
        ElseIf Me.ActiveControl Is txt用法 Then
            KeyAscii = 0
            If cmd用法.Visible And cmd用法.Enabled Then cmd用法_Click
        ElseIf Me.ActiveControl Is txt频率 Then
            KeyAscii = 0
            If cmd频率.Visible And cmd频率.Enabled Then cmd频率_Click
        ElseIf Me.ActiveControl Is cbo滴速 Then
            KeyAscii = 0
            If cbo滴速.Visible And cbo滴速.Enabled Then zlCommFun.PressKey (vbKeyF4)
        ElseIf Me.ActiveControl Is txtPati Then
            KeyAscii = 0
            If cmdPati.Visible And cmdPati.Enabled Then cmdPati_Click
        End If
    End If
End Sub

Private Sub Form_Load()
    Dim lngRow As Long
    Dim strErr As String
    Dim arrTmp As Variant
    Dim strTmp As String
    Dim objForm As Object
    Dim strNames As String
    Dim i As Long
    
    mbln扩展页签 = False
    
    Call SetWriteTime(False)
    '外挂提供的卡片
    Call CreatePlugInOK(p住院医嘱下达, mint场合)
    If Not gobjPlugIn Is Nothing Then
        Set mcolSubForm = New Collection
        On Error Resume Next
        strTmp = gobjPlugIn.GetFormCaption(glngSys, p住院医嘱下达)
        Call zlPlugInErrH(err, "GetFormCaption")
        If strTmp <> "" Then
            arrTmp = Split(strTmp, ",")
            For i = 0 To UBound(arrTmp)
                strTmp = arrTmp(i)
                Set objForm = gobjPlugIn.GetForm(glngSys, p住院医嘱下达, strTmp)
                Call zlPlugInErrH(err, "GetForm")
                If Not objForm Is Nothing Then
                    mcolSubForm.Add objForm, "_" & strTmp
                    strNames = strNames & "," & strTmp
                End If
                Set objForm = Nothing
            Next
        End If
        err.Clear: On Error GoTo 0
    End If

    If mint场合 = 0 Then
        '字体设置
        mbytSize = zlDatabase.GetPara("字体", glngSys, p住院医生站, "0")
    ElseIf mint场合 = 1 Then
        mbytSize = zlDatabase.GetPara("字体", glngSys, p住院护士站, "0")
    ElseIf mint场合 = 2 Then
        mbytSize = zlDatabase.GetPara("字体", glngSys, p医技工作站, "0")
    End If
    
    mblnAddAgent = zlDatabase.GetPara("要求登记代办人", glngSys, p住院医嘱下达, "1") = "1"
    
    '读取代办人信息
    Call GetAgentInfo
    '读取病人身份证号
    Call Get身份证号
    
    If strNames <> "" Then
        mbln扩展页签 = True
        strNames = Mid(strNames, 2)
    End If
    
    If mbln扩展页签 Then
        arrTmp = Split(strNames, ",")
        With tbcSub
            With .PaintManager
                .Appearance = xtpTabAppearancePropertyPage2003
                .ClientFrame = xtpTabFrameSingleLine
                .BoldSelected = True
                .OneNoteColors = True
                .ShowIcons = True
            End With
            
            .InsertItem(0, "医嘱编辑", picSub.hwnd, 0).Tag = "医嘱编辑"
            For i = 0 To UBound(arrTmp)
                strTmp = arrTmp(i)
                .InsertItem(i + 1, strTmp, mcolSubForm("_" & strTmp).hwnd, 0).Tag = strTmp
            Next
        End With
    Else
        tbcSub.Visible = False
    End If
    
    Call InitObjLis(p住院医嘱下达)
    If gobjLIS Is Nothing Then
        mblnNewLIS = False
    Else
        On Error Resume Next
        mblnNewLIS = gobjLIS.GetApplicationFormShowType
        err.Clear: On Error GoTo 0
    End If
    Call InitCommandBar
    Call SetFontSize(mbytSize)
    Call InitAdviceTable
    Call InitColumnSelect '初始化列选择器
    
    If mbytUseType = 0 Then Call RestoreWinState(Me, App.ProductName)
    stbThis.Visible = True
    vsAdvice.ColWidth(0) = 18 * Screen.TwipsPerPixelX
    '图标
    lvwPati.SmallIcons = frmIcons.imgPati
    tbrFree.HotImageList = frmIcons.img24
    tbrFree.ImageList = frmIcons.img24
    tbrFree.Buttons(1).Image = 1
    Call Cbo.SetListHeight(cbo滴速, Me.Height)
    Call Cbo.SetListHeight(cbo执行科室, Me.Height)
    Call Cbo.SetListWidth(cbo执行科室.hwnd, cbo执行科室.Width * 1.3)
    Call Cbo.SetListWidth(cbo婴儿.hwnd, cbo婴儿.Width * 1.5)
    fraPati.BackColor = Me.BackColor

    mblnOK = False
    mblnNoSave = False
    mblnRowMerge = False
    mblnRunFirst = True
    mblnRowChange = True
    mblnPathSend = True
    mblnDoCheck = True
    mblnShowStop = mbytUseType = 3  '调整顺序时必须显示停止的医嘱
    mstrDelIDs = "": mstrDelTempIDs = "": mstrDel输血 = ""
    mlngID序列 = 0
    mlng拖动行 = 0
    
    '医生输入允许状态
    If mint场合 <> 1 Then cbo医生.Locked = True

    '是否具有资格
    If mint场合 <> 1 Then mblnHaveAuditPriv = HaveAuditPriv

    '输入匹配
    mstrLike = IIF(Val(zlDatabase.GetPara("输入匹配")) = 0, "%", "")
    '简码匹配方式：0-拼音,1-五笔
    mint简码 = Val(zlDatabase.GetPara("简码方式"))
    Select Case mint简码
    Case 0
        stbThis.Panels("PY").Bevel = sbrInset
        stbThis.Panels("WB").Bevel = sbrRaised
    Case 1
        stbThis.Panels("PY").Bevel = sbrRaised
        stbThis.Panels("WB").Bevel = sbrInset
    Case Else
        stbThis.Panels("PY").Bevel = sbrInset
        stbThis.Panels("WB").Bevel = sbrInset
    End Select
    If Not gbln简码匹配方式切换 Then
        stbThis.Panels("PY").Visible = False
        stbThis.Panels("WB").Visible = False
    End If

    '计价面板状态
    If mblnModal Then
        stbThis.Panels("Price").Visible = False
    Else
        Set mfrmPrice = New frmAdvicePrice
        stbThis.Panels("Price").Tag = zlDatabase.GetPara("显示医嘱计价面板", glngSys, p住院医嘱下达)
    End If

    '医保先临时保存：医生使用；审核模式下不暂存
    mbln暂存 = True And mint场合 <> 1 And Not mbln审核 And mbytUseType = 0

    '临嘱缺省一次性
    mbln一次性 = Val(zlDatabase.GetPara("临嘱缺省一次性", glngSys, p住院医嘱下达)) <> 0
    mbln医技后续 = Val(zlDatabase.GetPara("医技医嘱后续处理", glngSys, p住院医嘱发送)) <> 0

    '执行天数
    mbln天数 = Val(zlDatabase.GetPara("医嘱执行天数", glngSys, p住院医嘱下达)) <> 0
    vsAdvice.ColHidden(COL_天数) = Not mbln天数
    mbln天数反算 = (gbln反算天数 And mbln天数)
    
    '自动处理皮试
    mbln自动皮试 = Val(zlDatabase.GetPara("自动增加皮试医嘱", glngSys, p住院医嘱下达)) <> 0 And mlng前提ID = 0

    '抗菌药物缺省用药目的
    mstrPurMed = zlDatabase.GetPara("抗菌药物缺省用药目的", glngSys, p住院医嘱下达, "0")

    '特殊药品权限
    mblnPrivsNar = InStr(GetTsPrivs(p住院医嘱下达), ";下达麻醉药嘱;") > 0
    mblnPrivsPoi = InStr(GetTsPrivs(p住院医嘱下达), ";下达毒性药嘱;") > 0
    mblnPrivsMin = InStr(GetTsPrivs(p住院医嘱下达), ";下达精神药嘱;") > 0
    mblnPrivsPre = InStr(GetTsPrivs(p住院医嘱下达), ";下达贵重药嘱;") > 0

    '先输单量
    mbln先输单量 = Val(zlDatabase.GetPara("临嘱先输入单量", glngSys, p住院医嘱下达)) <> 0

    '转科出院打印
    mlngPrintPos = Val(zlDatabase.GetPara("转科和出院打印", glngSys, p住院医嘱发送, 1))

    '医嘱打印模式
    mlngPrintType = Val(zlDatabase.GetPara("医嘱单打印模式", glngSys, p住院医嘱下达))
    '检查诊断
    mstr检查入院诊断 = zlDatabase.GetPara("要求输入入院诊断", glngSys, p住院医嘱下达)
    If mlng前提ID <> 0 Then mstr检查入院诊断 = ""
    mbln检查出院诊断 = Val(zlDatabase.GetPara("要求输入出院诊断", glngSys, p住院医嘱下达)) <> 0 And mlng前提ID = 0
    
    '自备、不取、离院带 当3个参数不启用时为不启用，否则为启用
    strTmp = ""
    mbln接收自备药 = Val(zlDatabase.GetPara("自备药允许发往静配中心", glngSys, p输液配置中心, "0")) = 1
    strTmp = strTmp & IIF(mbln接收自备药, "1", "0")
    mbln接收自备药 = Val(zlDatabase.GetPara("不取药允许发往静配中心", glngSys, p输液配置中心, "0")) = 1
    strTmp = strTmp & IIF(mbln接收自备药, "1", "0")
    mbln接收自备药 = Val(zlDatabase.GetPara("离院带药允许发往静配中心", glngSys, p输液配置中心, "0")) = 1
    strTmp = strTmp & IIF(mbln接收自备药, "1", "0")
    
    mbln接收自备药 = strTmp <> "000"
 
    '自动打印
    If mint场合 = 1 Then mbln自动打印 = IIF(zlDatabase.GetPara("自动进入医嘱打印", glngSys, p住院医嘱发送) = 1, True, False)

    mblnAdviceSort = zlDatabase.GetPara("医嘱自动排序", glngSys, p住院医嘱下达) = "1"


    mlng中药味数 = Val(zlDatabase.GetPara("中药配方允许修改的中药味数上限", glngSys, p临床路径应用, "30"))
    mbln匹配期效 = CBool(zlDatabase.GetPara("匹配时期效不同算路径外项目", glngSys, p临床路径应用, "0"))

    If mint场合 = 2 Then
        mblnOutPathTable = zlDatabase.GetPara("医技医嘱在路径表外", glngSys, p临床路径应用, 0) = 1
    Else
        mblnOutPathTable = False
    End If

    If mbytUseType = 1 Then
        mlng路径医嘱天数 = Val(zlDatabase.GetPara("路径医嘱生成超前天数", glngSys, p临床路径应用, "1"))
    End If
    
    mdatCurr = zlDatabase.Currentdate

    '药品、卫材出库检查方式
    Set mcolStock1 = GetStockCheck(0)
    Set mcolStock2 = GetStockCheck(1)
    
    With cboDruPur
        .Clear
        .AddItem " "
        .AddItem "预防"
        .AddItem "治疗"
    End With
    
    '常用嘱托
    Call ReadEnjoin

    '医嘱内容定义
    If CreateScript(mobjVBA, mobjScript) Then
        Set mrsDefine = InitAdviceDefine
    End If

    Call Init药品分零方式
    Call Init手术情况
    
    Call zlPASSMap    '映射对象都完成初始化
    If mblnPass Then
        'And mint场合 <> 1 Then 'Pass
        '病人过敏史/病生状态可用检测
        Call gobjPass.zlPassCmdAlleyEnable(mobjPassMap)
    End If
    
    '--------------------------------------------
    '读取病人清单
    mblnRefresh = False
    Call LoadPatients(0)

    cbo婴儿.ListIndex = mint婴儿    '新增时，医嘱清单中选择的婴儿；修改时，当前医嘱的婴儿
    cbo婴儿.Tag = cbo婴儿.ListIndex
    
    If mint婴儿 <> 0 Then
        mstr性别 = GetBabySex(mint婴儿)
    End If
    
    '读取并显示病人医嘱
    If mbytUseType = 1 Then
        Call Refresh开始时间(1)

        Call AdviceSet成套项目(2, 0, 1, "", mstrAdivceOfPath)
        Call SetPathAdviceDisble
        Call ShowAdvice

        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    Else
        Call ReLoadAdvice(mlng医嘱ID)
    End If

    '医嘱审核设置
    If mbln审核 Then
        '没有需要审核的医嘱
        If vsAdvice.Rows = vsAdvice.FixedRows + 1 And vsAdvice.RowData(vsAdvice.FixedRows) = 0 Then
            MsgBox "该病人没有需要审核的医嘱。", vbInformation, gstrSysName
            Unload Me: Exit Sub
        End If

        Me.Caption = "住院医嘱审核"
        vsAdvice.BackColor = BackColorNew
        vsAdvice.BackColorBkg = BackColorNew
    End If

    '处理快捷输入窗体
    If mbytUseType = 0 And mblnModal = False Then
        Set mfrmShortCut = New frmClinicShortCut
        Call mfrmShortCut.ShowMe(Me, mint场合, IIF(mlng病人性质 = 1, 3, 2), mlng病人病区ID, mlng病人科室id, True, mlng医技科室ID)    '根据上次上否显示
    Else
        txt医嘱内容.ToolTipText = ""
    End If
    
    If Not mbln医技后续 And mlng前提ID <> 0 Then
        cbo期效.Enabled = False
        lbl期效.Visible = False
        cbo期效.Visible = False
        Call Cbo.SetIndex(cbo期效.hwnd, 1)
        lbl开始时间.Left = lbl期效.Left
        cmd开始时间.Left = cmd开始时间.Left - (msk开始时间.Left - cbo期效.Left)
        msk开始时间.Left = cbo期效.Left
    End If
End Sub

Private Sub SetFontSize(ByVal bytSize As Byte)
'功能：进行界面字体的统一设置
'参数：bytSize  0-9号字体，1-12号字体
    Call zlControl.SetPubFontSize(Me, bytSize)
    Call SetCtrlPos
End Sub

Private Sub SetCtrlPos()
'功能: 设置控件位置 , 请注意所有控件位置的设置尽可能在此函数中设置
    Dim lngDistance1 As Long, lngDistance2 As Long
    Dim lngHeight As Long

    lngDistance1 = 30: lngDistance2 = 180
    
    Call zlControl.SetPubCtrlPos(False, 0, Label1, lngDistance1, txtPati, -1 * cmdPati.Width, cmdPati, lngDistance1, fraInfo)

    '垂直设置控件位置
    lbl期效.Left = 120
    lbl期效.Top = 225
    lbl滴速.Top = 225
    '先设置左边第一行控件，其次设置右边控件位置，最后设置左边控件位置，目的为了设置医嘱内容高度
    '左边第一排，为了地位第一排右边控件位置
    Call zlControl.SetPubCtrlPos(False, 0, lbl期效, lngDistance1, cbo期效, lngDistance2, lbl开始时间, lngDistance1, msk开始时间, -1 * cmd开始时间.Width, cmd开始时间)
    lbl滴速.Left = cmd开始时间.Left + cmd开始时间.Width + IIF(mbytSize = 0, 5, 10) * lngDistance2

    '设置右边控件位置
    Call zlControl.SetPubCtrlPos(True, 1, lbl滴速, lngDistance2, lbl医生嘱托, lngDistance2, lbl执行时间, lngDistance2, lbl执行科室, lngDistance2, lbl附加执行, lngDistance2, lbl开嘱医生)
    Call zlControl.SetPubCtrlPos(False, 0, lbl滴速, lngDistance1, cbo滴速, lngDistance1, lbl滴速单位, lngDistance2, chkStop, lngDistance2, chk紧急)
    Call zlControl.SetPubCtrlPos(False, 0, lbl医生嘱托, lngDistance1, cbo医生嘱托, -1 * cmd医生嘱托.Width, cmd医生嘱托, lngDistance1, cmd常用嘱托)
    Call zlControl.SetPubCtrlPos(False, 0, lbl执行时间, lngDistance1, cbo执行时间)
    Call zlControl.SetPubCtrlPos(False, 0, lbl执行科室, lngDistance1, cbo执行科室, lngDistance2, lbl执行性质, lngDistance1, cbo执行性质)
    Call zlControl.SetPubCtrlPos(False, 0, lbl附加执行, lngDistance1, cbo附加执行, lngDistance2, lbl终止时间, lngDistance1, txt终止时间, -1 * cmd终止时间.Width, cmd终止时间)
    Call zlControl.SetPubCtrlPos(False, 0, lbl开嘱医生, lngDistance1, cbo医生, lngDistance2, lbl开嘱时间, lngDistance1, txt开嘱时间, -1 * cmd开嘱时间.Width, cmd开嘱时间)
    Call zlControl.SetPubCtrlPos(False, 0, lbl超量说明, lngDistance1, txt超量说明, -1 * cmdExcReason.Width, cmdExcReason, lngDistance1, cmdComExcReason)
    
    cbo执行时间.Width = cmd常用嘱托.Left + cmd常用嘱托.Width - cbo执行时间.Left
    txt超量说明.Width = cmd医生嘱托.Left + cmd医生嘱托.Width - txt超量说明.Left - 80
    txt首日时间.Left = txt终止时间.Left: txt首日时间.Top = cbo执行时间.Top
    lbl首日时间.Left = txt终止时间.Left - lbl首日时间.Width - lngDistance1: lbl首日时间.Top = cbo执行时间.Top


'    '设置左边控件位置
    txt医嘱内容.Height = msk开始时间.Height '为了中部对齐
    Call zlControl.SetPubCtrlPos(True, 1, lbl期效, lngDistance2, lbl医嘱内容, lbl执行科室.Top - lbl医生嘱托.Top - lbl医生嘱托.Height + lngDistance2 + 180, lbl用法, -1 * lbl安排时间.Height, lbl安排时间, lngDistance2, lbl总量, lngDistance2 + 10, lbl首次用量, lngDistance2, lbl用药目的)
    Call zlControl.SetPubCtrlPos(False, 0, lbl医嘱内容, lngDistance1, txt医嘱内容, lngDistance1, cmdExt)
    cmdSel.Top = cmdExt.Top + cmdExt.Height + 120: cmdSel.Left = cmdExt.Left
    Call zlControl.SetPubCtrlPos(False, 0, cmdSel, lngDistance1, picHelp)
    txt医嘱内容.Height = cbo执行科室.Top + cbo执行科室.Height - txt医嘱内容.Top
    lbl分零.Left = lbl医嘱内容.Left: lbl分零.Top = lbl执行科室.Top
    Call zlControl.SetPubCtrlPos(False, 0, lbl分零, lngDistance1, cbo分零)
    lbl安排时间.Top = IIF(mbytSize = 0, lbl安排时间.Top, lbl安排时间.Top + 100)
    Call zlControl.SetPubCtrlPos(False, 0, lbl安排时间, -1 * lbl用法.Width, lbl用法, lngDistance1, txt安排时间, -1 * cmd安排时间.Width, cmd安排时间, -1 * txt用法.Width, txt用法, -1 * cmd用法.Width, cmd用法, lngDistance2, lbl手术情况, -1 * lbl频率.Width, lbl频率, lngDistance1, txt频率, -1 * cbo手术情况.Width, cbo手术情况, -1 * cmd频率.Width, cmd频率)
    txt频率.Width = txt医嘱内容.Width + txt医嘱内容.Left - txt频率.Left: cmd频率.Left = txt医嘱内容.Width + txt医嘱内容.Left - cmd频率.Width
    lbl总量.Top = IIF(mbytSize = 0, lbl总量.Top, lbl总量.Top + 100)
    Call zlControl.SetPubCtrlPos(False, 0, lbl总量, lngDistance1, txt总量, lngDistance1, lbl总量单位, -1 * lbl天数.Width, lbl天数, -1 * (txt天数.Width + Me.TextWidth("字")), txt天数, lngDistance2, lbl单量, lngDistance1, txt单量, lngDistance1, lbl单量单位(0))
    
    
    lbl首次用量.Top = IIF(mbytSize = 0, lbl首次用量.Top - 50, lbl首次用量.Top + 100)
    Call zlControl.SetPubCtrlPos(False, 0, lbl首次用量, lngDistance1, txt首次用量, lngDistance1, lbl单量单位(1), lngDistance2)
    lbl超量说明.Top = lbl首次用量.Top: lbl超量说明.Left = lbl单量单位(0).Left - lbl超量说明.Width
    txt超量说明.Width = cmd医生嘱托.Left + cmd医生嘱托.Width - lbl单量单位(0).Left
    Call zlControl.SetPubCtrlPos(False, 0, lbl超量说明, lngDistance1, txt超量说明, -1 * cmdExcReason.Width, cmdExcReason, 0.5 * lngDistance1, cmdComExcReason, -1 * cmdZYRemark.Width, cmdZYRemark)
    

    lbl用药目的.Top = IIF(mbytSize = 0, lbl用药目的.Top - 50, lbl用药目的.Top + 100)
    Call zlControl.SetPubCtrlPos(False, 0, lbl用药目的, lngDistance1, cboDruPur, lngDistance2)
    lbl用药理由.Top = lbl用药目的.Top: lbl用药理由.Left = lbl超量说明.Left
    txt用药理由.Width = txt超量说明.Width
    Call zlControl.SetPubCtrlPos(False, 0, lbl用药理由, lngDistance1, txt用药理由, -1 * cmdReason.Width, cmdReason, 0.5 * lngDistance1, cmd收藏用药理由, -1 * cmd收藏用药理由.Width, cmd输血原因)
    
    lbl单量单位(0).Left = txt医嘱内容.Width + txt医嘱内容.Left - lbl单量单位(0).Width
    txt单量.Width = lbl单量单位(0).Left - lngDistance1 - txt单量.Left

    If Me.WindowState <> vbMaximized And Me.WindowState <> vbMinimized Then
        fraAdvice.Width = cmd常用嘱托.Left + cmd常用嘱托.Width + 1000
    End If
End Sub

Private Sub SetPathAdviceDisble()
'功能：路径项目生成医嘱时设置禁用的功能
    tbrFree.Visible = False
    cbo期效.Enabled = False
    txt医嘱内容.Enabled = False
        
   ' lbl婴儿.Visible = False
   ' cbo婴儿.Visible = False
    cmdSel.ToolTipText = "选择其他规格"
End Sub

Private Function TheStockCheck(ByVal lng库房ID As Long, ByVal str类别 As String) As Integer
'功能：获取指定库房的出库库存检查方式
    Dim intStyle As Integer
    
    On Error Resume Next
    If InStr(",5,6,7,", str类别) > 0 Then
        intStyle = mcolStock1("_" & lng库房ID)
    ElseIf str类别 = "4" Then
        intStyle = mcolStock2("_" & lng库房ID)
    End If
    err.Clear: On Error GoTo 0
    TheStockCheck = intStyle
End Function

Private Sub Init药品分零方式()
    With cbo分零
        .AddItem "1-不可分零": .ItemData(.NewIndex) = 1
        .AddItem "2-一次性使用": .ItemData(.NewIndex) = 2
        .AddItem "3-一天内分零使用有效": .ItemData(.NewIndex) = -1
        .AddItem "4-二天内分零使用有效": .ItemData(.NewIndex) = -2
        .AddItem "5-三天内分零使用有效": .ItemData(.NewIndex) = -3
    End With
End Sub

Private Sub Init手术情况()
    With cbo手术情况
        .AddItem "择期"
        .ItemData(.NewIndex) = 0
        .AddItem "急诊"
        .ItemData(.NewIndex) = 1
        .AddItem "限期"
        .ItemData(.NewIndex) = 2
    End With
End Sub

Private Sub ReLoadAdvice(Optional ByVal lng医嘱ID As Long)
'功能：重新读取并显示病人的当前医嘱清单
'参数：lng医嘱ID=用于定位
    Dim lngRow As Long
    
    If LoadAdvice Then
        '显示医嘱
        Call ShowAdvice
        
        If lng医嘱ID = 0 Then
            If vsAdvice.RowData(vsAdvice.Row) <> 0 And Not mbln审核 Then
                '路径病人，正常结束时，不新增行
                If mbytUseType = 0 And (mlng路径状态 = 0 Or mlng路径状态 = 3 Or mlng路径状态 = 1 And mbln未评估) Or mbytUseType = 2 Then
                    On Error Resume Next
                    '编译部件后启用美康3.0测试桩模块偶尔会报错程序卡死，无法进行后续合理用药相关测试
                    cbsMain.FindControl(, conMenu_New, True, True).Execute
                    err.Clear: On Error GoTo 0
                End If
            End If
        Else
            '修改的医嘱ID应该是显示行
            lngRow = vsAdvice.FindRow(lng医嘱ID)
            If lngRow <> -1 Then
                If Not vsAdvice.RowHidden(lngRow) Then
                    mblnRowChange = False
                    vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngRow
                    Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
                    mblnRowChange = True
                End If
            End If
        End If
        '进入时屏蔽了ShowAdvice中的调用,强行进入
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    End If
End Sub

Private Function ReadEnjoin() As Boolean
'功能：读取并加入常用滴速
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, strPre As String
        
    On Error GoTo errH
    
    '常用滴速
    strPre = cbo滴速.Text '加入后保持原有值
    Call Load输液滴速(cbo滴速, lbl滴速单位, False)
    cbo滴速.Text = strPre
    ReadEnjoin = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub Form_Resize()
    On Error Resume Next
    
    If dtpDate.Visible Then
        dtpDate.Visible = False
        dtpDate.Tag = ""
    ElseIf lvwPati.Visible Then
        lvwPati.ListItems("_" & mlng病人ID & "_" & mlng主页ID).Selected = True
        lvwPati.Visible = False
    End If
    If mbln扩展页签 Then
        tbcSub.Move 0, 0, Me.ScaleWidth, Me.ScaleHeight
    Else
        picSub.Move 0, 0, Me.ScaleWidth, Me.ScaleHeight
    End If
    If Me.WindowState = vbMinimized Then Exit Sub
    Call cbsMain_Resize
    'Pass
    cmdAlley.Left = Me.ScaleWidth - cmdAlley.Width - 30
    cbo婴儿.Left = Me.ScaleWidth - IIF(cmdAlley.Visible, cmdAlley.Width + 30, 0) - cbo婴儿.Width - 30
    lbl婴儿.Left = cbo婴儿.Left - lbl婴儿.Width - 30
    
    If cmdAlley.Visible Or lbl婴儿.Visible Then
        fraInfo.Width = IIF(lbl婴儿.Visible, lbl婴儿.Left, cmdAlley.Left) - fraInfo.Left - 90
    Else
        fraInfo.Width = fraPati.Width - fraInfo.Left - 90
    End If
    fraInfo.Height = txtPati.Height
End Sub

Private Sub Form_Unload(Cancel As Integer)
    Dim i As Long
    
    mblnNoSave = False
    mlng前提ID = 0
    mlng医技科室ID = 0
    mlng会诊科室ID = 0
    mint婴儿 = 0
    mlng医嘱ID = 0
    mbln审核 = False
    msng天数 = 0

    mintPState = ps在院
    mdatTurn = CDate(0)
    mlng病人科室id = 0
    mlng病人病区ID = 0
    mbln自动打印 = False

    mblnHaveAuditPriv = False
    Set mobjVBA = Nothing
    Set mobjScript = Nothing
    Set mrsDefine = Nothing
    Set mrsDrugScale = Nothing
    Set mrsPrice = Nothing
    Set mrsLastAdvice = Nothing
    Set mrsPPati = Nothing
    Set mrsBaby = Nothing
    '计价面板状态
    If Not mfrmPrice Is Nothing Then
        Unload mfrmPrice
        Set mfrmPrice = Nothing
        Call zlDatabase.SetPara("显示医嘱计价面板", IIF(Val(stbThis.Panels("Price").Tag) <> 0, 1, 0), glngSys, p住院医嘱下达)
    End If

    'PASS 卸载
    If mblnPass Then
        Call gobjPass.zlPassClearLight(mobjPassMap)
    End If
    Set mobjPassMap = Nothing
    Set mclsMipModule = Nothing
    
    '临床路径生成时，自由录入图标:tbrFree，不可见
    If mbytUseType = 0 Then Call SaveWinState(Me, App.ProductName)
    If mbln扩展页签 Then
        For i = 1 To mcolSubForm.Count
            Unload mcolSubForm(i)
        Next
        Set mcolSubForm = Nothing
    End If
    mlng危急值ID = 0
    mstr备血医嘱时间 = ""
    RaiseEvent FormUnload(Cancel)
End Sub

Private Sub lvwPati_ColumnClick(ByVal ColumnHeader As MSComctlLib.ColumnHeader)
    Call zlControl.LvwSortColumn(lvwPati, ColumnHeader.Index)
End Sub

Private Sub lvwPati_DblClick()
    If mblnClickItem Then Call lvwPati_KeyPress(13)
End Sub

Private Sub lvwPati_ItemClick(ByVal Item As MSComctlLib.ListItem)
    mblnClickItem = True
End Sub

Private Sub lvwPati_KeyPress(KeyAscii As Integer)
    Dim strMsg As String, strTmp As String
    Dim lngBabyEdit As Long
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If Not lvwPati.SelectedItem Is Nothing Then
            If lvwPati.SelectedItem.Key = "_" & mlng病人ID & "_" & mlng主页ID Then
                lvwPati.Visible = False
                txtPati.Text = lvwPati.SelectedItem.Text
                txtPati.ForeColor = lvwPati.SelectedItem.ForeColor
                vsAdvice.SetFocus: Exit Sub
            End If

            '已经转出的病人是不允许下医嘱的
            If Val(lvwPati.SelectedItem.ListSubItems(Itag_数据转出).Tag) = 1 Then
                MsgBox "该病人的本次住院数据已经转出到后备数据库，不允许操作。" & vbCrLf & _
                       "您可以与系统管理员联系，将相应数据抽选返回。", vbInformation, gstrSysName
                Exit Sub
            End If

            If mblnNoSave Then
                If MsgBox("当前病人的医嘱编辑后尚未保存，确实要更换病人吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                    Exit Sub
                End If
            End If

            mblnShowStop = False

            With lvwPati.SelectedItem
                mlng病人ID = Val(Mid(.Key, 2))
                mlng主页ID = Val(Split(.Key, "_")(2))
                mint婴儿 = 0

                mlng病人科室id = Val(.ListSubItems(Itag_科室ID).Tag)
                mlng病人病区ID = Val(.ListSubItems(Itag_病区ID).Tag)
                mlng病人性质 = Val(.ListSubItems(Itag_病人性质).Tag)
                mint险类 = Val(.ListSubItems(Itag_险类).Tag)
                mint病人状态 = Val(.ListSubItems(Itag_状态).Tag)
                mstr付款码 = Get医疗付款码(.SubItems(Item_医疗付款方式))
                mstr性别 = .SubItems(Item_性别)
                mstr病人性别 = mstr性别
                mlng路径状态 = Val(.ListSubItems(Itag_路径状态).Tag)
                mlng婴儿科室ID = Val(.SubItems(Item_婴儿科室ID))
                mlng婴儿病区ID = Val(.SubItems(Item_婴儿病区ID))
                If mblnOutPathTable Then mlng路径状态 = 0

                If mlng路径状态 = 1 Then
                    mbln未评估 = CheckPathNotEvaluete(mlng病人ID, mlng主页ID, mblnPathSend, mstr当前日期)
                    If mbytUseType = 0 Then Set mrsPPati = GetPatiPathInfo(mlng病人ID, mlng主页ID)
                Else
                    mbln未评估 = False
                    mstr当前日期 = ""
                    mblnPathSend = False
                End If

                txtPati.Text = .Text
                txtPati.ForeColor = .ForeColor

                Call GetPatiLastChange(mlng病人ID, mlng主页ID, 0, 0, mint场合, strTmp)
                .ListSubItems(Itag_转科时间).Tag = strTmp

                Call ShowPatiInfo(lvwPati.SelectedItem)

                mbln提醒对码 = True
            End With
            mint年龄 = GetPatiYear(mlng病人ID)
            Call Show费用信息

            lvwPati.Visible = False
            mblnNoSave = False
            mstrDelIDs = "": mstrDelTempIDs = "": mstrDel输血 = ""
            mlngID序列 = 0
            '当前病人最后补录医嘱的开始时间
            mstrLastTime = GetPatiLastTime

            '清除当前医嘱内容
            mblnRowChange = False
            With vsAdvice
                .Redraw = flexRDNone
                Call .Select(.FixedRows, 0, .Rows - 1, .Cols - 1)
                Call .Clear(flexClearSelection)
                .Rows = .FixedRows + 1    '相当于删除行

                'Clear不会清除RowData,RowHidden,需要额外处理
                .RowData(.FixedRows) = Empty
                .RowHidden(.FixedRows) = False

                .Row = .FixedRows: .Col = .FixedCols
                .Redraw = flexRDDirect
            End With
            mblnRowChange = True

            '产科才有婴儿医嘱
            Call SetBabyVisible(mlng病人ID, mlng主页ID)
            'PASS 合理用药监测
            If mblnPass Then
                '更新病人信息
                Call zlPASSPati
                On Error Resume Next
                Call gobjPass.zlPassClearLight(mobjPassMap)
                On Error GoTo 0
            End If
            '读取并显示病人医嘱
            If LoadAdvice Then Call ShowAdvice
            

            '如果一条医嘱都没有，则视为添加路径外项目
            If vsAdvice.Rows = 2 And vsAdvice.RowData(1) = "" Then
                If CheckedPathSended = False Then Exit Sub
                lngBabyEdit = CheckBabyEdit
                If lngBabyEdit = 1 Then
                    MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
                    Exit Sub
                ElseIf lngBabyEdit = 2 Then
                    MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
                    Exit Sub
                End If
            End If

            vsAdvice.SetFocus

            '特殊医嘱提醒
            strMsg = ExistsSpecAdvice(mlng病人ID, mlng主页ID)
            If strMsg <> "" Then MsgBox strMsg, vbInformation, gstrSysName
        End If
    End If
End Sub

Private Sub lvwPati_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    mblnClickItem = False
End Sub

Private Sub lvwPati_Validate(Cancel As Boolean)
    lvwPati.ListItems("_" & mlng病人ID & "_" & mlng主页ID).Selected = True
    lvwPati.Visible = False
End Sub

Private Function GetPatiLastTime() As String
'功能：取当前病人最后补录医嘱的开始时间,以备下个病人使用
    Dim strTime As String, i As Long
    Dim curDate As Date
    
    curDate = zlDatabase.Currentdate
    
    With vsAdvice
        '才输入的
        For i = .Rows - 1 To .FixedRows Step -1
            If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_开始时间)) Then
                If InStr(",1,2,", Val(.TextMatrix(i, COL_EDIT))) > 0 And Val(.TextMatrix(i, COL_标志)) = 2 _
                    And Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd") = Format(curDate, "yyyy-MM-dd") Then
                    strTime = .Cell(flexcpData, i, COL_开始时间): Exit For
                End If
            End If
        Next
        '新开的
        If strTime = "" Then
            For i = .Rows - 1 To .FixedRows Step -1
                If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_开始时间)) Then
                    If InStr(",1,2,-1,", Val(.TextMatrix(i, COL_状态))) > 0 And Val(.TextMatrix(i, COL_标志)) = 2 _
                        And Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd") = Format(curDate, "yyyy-MM-dd") Then
                        strTime = .Cell(flexcpData, i, COL_开始时间): Exit For
                    End If
                End If
            Next
        End If
    End With
    
    GetPatiLastTime = strTime
End Function

Private Function RowCanMerge(ByVal lngRow1 As Long, ByVal lngRow2 As Long, Optional strMsg As String) As Boolean
'功能：判断两行是否可以一并给药
'参数：lngRow1=前面一条已经输入的药品行
'      lngRow2=当前行(已输入或未输入)
'返回：如果不可以，则strMsg返回提示信息
    Dim lngFind As Long, lngRxCount As Long
    Dim lng配制中心 As Long
    Dim str药房IDs As String
    
    With vsAdvice
        strMsg = ""
        If Not Between(lngRow1, .FixedRows, .Rows - 1) Then Exit Function
        If Not Between(lngRow2, .FixedRows, .Rows - 1) Then Exit Function
        If .RowHidden(lngRow1) Or .RowHidden(lngRow2) Then Exit Function
        If .RowData(lngRow1) = 0 Then Exit Function
        
        If mbytUseType = 1 Then
            If .TextMatrix(lngRow1, COL_路径项目ID) <> .TextMatrix(lngRow2, COL_路径项目ID) Then
                strMsg = "一并给药的要求是同一路径项目对应的医嘱。"
                Exit Function
            End If
        End If
        
        If .RowData(lngRow2) = 0 Then
            '必须全部为成药且类别相同
            If InStr(",5,6,", .TextMatrix(lngRow1, COL_类别)) = 0 Then
                strMsg = "一并给药的药品必须都为西成药或都为中成药。"
                Exit Function
            End If
            
            '不能包含已校对的医嘱
            If InStr(",1,2,-1,", .TextMatrix(lngRow1, COL_状态)) = 0 Then
                strMsg = "要设置为一并给药的药品包含已经校对的医嘱。"
                Exit Function
            End If

            '不能包含已签名的医嘱
            If Val(.TextMatrix(lngRow1, COL_签名否)) = 1 Then
                strMsg = "要设置为一并给药的药品包含已经签名的医嘱。"
                Exit Function
            End If
        ElseIf .RowData(lngRow2) <> 0 Then
            If InStr(",5,6,", .TextMatrix(lngRow1, COL_类别)) = 0 _
                Or InStr(",5,6,", .TextMatrix(lngRow2, COL_类别)) = 0 Then
                strMsg = "一并给药的药品必须都为西成药或都为中成药。"
                Exit Function
            End If
            
            '期效必须相同
            If .TextMatrix(lngRow1, COL_期效) <> .TextMatrix(lngRow2, COL_期效) Then
                strMsg = "一并给药的药品医嘱期效必须相同。"
                Exit Function
            End If
            
            '不能包含已校对的医嘱
            If InStr(",1,2,-1,", .TextMatrix(lngRow1, COL_状态)) = 0 _
                Or InStr(",1,2,-1,", .TextMatrix(lngRow2, COL_状态)) = 0 Then
                strMsg = "要设置为一并给药的药品包含已经校对的医嘱。"
                Exit Function
            End If
                
            '不能将补录的医嘱与其它医嘱一起设置为一并给药
            If Val(.TextMatrix(lngRow1, COL_标志)) = 2 And Val(.TextMatrix(lngRow2, COL_标志)) <> 2 _
                Or Val(.TextMatrix(lngRow1, COL_标志)) <> 2 And Val(.TextMatrix(lngRow2, COL_标志)) = 2 Then
                strMsg = "不能将补录医嘱与其它医嘱一起设置为一并给药。"
                Exit Function
            End If
            
            '不能包含已签名的医嘱
            If Val(.TextMatrix(lngRow1, COL_签名否)) = 1 Or Val(.TextMatrix(lngRow2, COL_签名否)) = 1 Then
                strMsg = "要设置为一并给药的药品包含已经签名的医嘱。"
                Exit Function
            End If
            
            '一并给药(前面药品)的给药途径是否适用于当前药品
            lngFind = .FindRow(CLng(.TextMatrix(lngRow1, COL_相关ID)), lngRow1 + 1)
            If lngFind <> -1 Then
                If Not Check适用用法(Val(.TextMatrix(lngFind, COL_诊疗项目ID)), Val(.TextMatrix(lngRow2, COL_诊疗项目ID)), 2, Val(.TextMatrix(lngRow2, COL_收费细目ID)), mlng病人性质) Then
                    strMsg = """" & .TextMatrix(lngRow2, col_医嘱内容) & """不能使用""" & .TextMatrix(lngFind, col_医嘱内容) & """给药途径，" & _
                    vbCrLf & "不能与""" & .TextMatrix(lngRow1, col_医嘱内容) & """设置为一并给药。"
                    Exit Function
                End If
            End If
        End If
                
        '检查处方药品种数限制
        If gintRXCount > 0 And mlng病人性质 = 1 Then
            lngFind = .FindRow(.TextMatrix(lngRow1, COL_相关ID), , COL_相关ID)
            lngRxCount = GetMergeCount(vsAdvice, lngFind, COL_相关ID, COL_收费细目ID)
            If lngRxCount >= gintRXCount Then
                strMsg = "一并给药的药品种数 " & lngRxCount & " 种已达到或超过药品处方最多允许的种数 " & gintRXCount & " 种。"
                Exit Function
            End If
        End If
    End With
    RowCanMerge = True
End Function

'按生效时间进行排序
Private Sub MoveRowAll()
    Dim i As Long, j As Long
    Dim lngNewRow As Long
    On Error GoTo errH
    With vsAdvice
        For i = 2 To .Rows - 1
            lngNewRow = i
            For j = i - 1 To 1 Step -1
                If j < lngNewRow Then
                    If .TextMatrix(lngNewRow, COL_开始时间) >= .TextMatrix(j, COL_开始时间) Then
                        Exit For
                    End If
                    lngNewRow = lngNewRow - MoveCurrRow(lngNewRow, 1)
                End If
            Next
        Next
    End With
    Exit Sub
errH:
    err.Clear
End Sub


Private Function MoveCurrRow(ByVal lngRow As Long, ByVal lngWay As Long) As Long
'功能：将当前行上移或下移一行
'参数：lngRow=当前行
'      lngWay=1上移一行,-1下移一行(相当于下一行上移一行)
    Dim lngPreRow As Long, lngNextRow As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim lngUpBegin As Long, lngUpEnd As Long
    Dim lngDownBegin As Long, lngDownEnd As Long
    Dim i As Long, j As Long
    Dim lngMoveRows As Long, blnRedraw As Boolean
   
    With vsAdvice
        If .RowData(lngRow) = 0 Then Exit Function '空白行排除
        '当前行可能是一并给药中间的行
        Call GetRowScope(lngRow, lngBegin, lngEnd)
                
        If lngWay = 1 Then
            lngPreRow = GetPreRow(lngBegin)
            If lngPreRow = -1 Then Exit Function
          
            lngDownBegin = lngBegin
            lngDownEnd = lngEnd
            Call GetRowScope(lngPreRow, lngUpBegin, lngUpEnd)
            lngMoveRows = lngDownBegin - lngUpBegin
        Else
            lngNextRow = GetNextRow(lngEnd)
            If lngNextRow = -1 Then Exit Function
            
            lngUpBegin = lngBegin
            lngUpEnd = lngEnd
            Call GetRowScope(lngNextRow, lngDownBegin, lngDownEnd)
            lngMoveRows = lngDownEnd - lngUpEnd
        End If
        
        MoveCurrRow = lngMoveRows
        blnRedraw = .Redraw
        .Redraw = False
        '两组医嘱行是不同婴儿时，移动后序号不变
        '必须显示已停止的医嘱，因为移动时经过那些医嘱，序号要一起调整
        If Val(vsAdvice.TextMatrix(lngUpBegin, COL_婴儿)) = Val(vsAdvice.TextMatrix(lngDownBegin, COL_婴儿)) Then
            For i = lngUpBegin To lngUpEnd
                .TextMatrix(i, COL_序号) = .TextMatrix(i, COL_序号) + (lngDownEnd - lngUpEnd)
                If mbytUseType = 3 Then .TextMatrix(i, COL_EDIT) = 3
            Next
            For i = lngDownBegin To lngDownEnd
                .TextMatrix(i, COL_序号) = .TextMatrix(i, COL_序号) - (lngDownBegin - lngUpBegin)
                If mbytUseType = 3 Then .TextMatrix(i, COL_EDIT) = 3
            Next
        End If
        j = 0
        For i = lngDownBegin To lngDownEnd
            .RowPosition(i) = lngUpBegin + j
            j = j + 1
        Next
               
        mblnRowChange = False
        lngRow = lngRow - lngWay * lngMoveRows
        .Row = lngRow
        If .RowIsVisible(.Row) = False Then Call .ShowCell(.Row, .Col): .TopRow = .Row
        mblnRowChange = True
         
        If mbytUseType = 3 Then mblnNoSave = True '标记为未保存
         .Redraw = blnRedraw
    End With
End Function

Private Function ApplyBefore() As Boolean
'功能：点工具栏申请单按钮前时调用
    Dim lngBabyEdit As Long
    Dim i As Long
    
    With vsAdvice
        If CheckedPathSended = False Then Exit Function
        lngBabyEdit = CheckBabyEdit
        If lngBabyEdit = 1 Then
            MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
            Exit Function
        ElseIf lngBabyEdit = 2 Then
            MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
            Exit Function
        End If
        If .RowData(.Row) = 0 Then
            '无
        ElseIf .RowData(.Rows - 1) = 0 Then
            .Row = .Rows - 1
        Else
            '先删除中间间隔的空行
            mblnRowChange = False
            For i = .Rows - 1 To .FixedRows Step -1
                If .RowData(i) = 0 Then .RemoveItem i
            Next
            mblnRowChange = True

            .AddItem "", .Rows
            .Row = .Rows - 1
            .Col = .FixedCols
        End If

        Call .ShowCell(.Row, .Col)
        If Visible And cbo期效.Enabled And cbo期效.Visible Then
            cbo期效.SetFocus
        ElseIf Visible And txt医嘱内容.Enabled Then
            txt医嘱内容.SetFocus
        End If
    End With
    ApplyBefore = True
End Function

Private Sub cbsMain_Execute(ByVal Control As XtremeCommandBars.ICommandBarControl)
    Dim lng医嘱ID As Long, lng相关ID As Long
    Dim str类别 As String, str补录 As String
    Dim lngBegin As Long, lngEnd As Long
    Dim lngPreRow As Long, strMsg As String
    Dim str期效 As String, lng诊疗项目ID As Long, lng主ID As Long
    Dim lngTmp As Long, i As Long, j As Long
    Dim lng病人ID As Long, lng主页ID As Long
    Dim blnMoved As Boolean, strAlter As String
    Dim blnRefresh As Boolean
    Dim lngBabyEdit As Long
    Dim lngLoop As Long, blnTag As Boolean

    If Not Control.Visible Then Exit Sub    'Visible=False时通过热键居然也会执行
    
    Call AdviceChange    '强制更新医嘱内容

    With vsAdvice
        Select Case Control.ID
        Case conMenu_MoveUp
            lngBabyEdit = CheckBabyEdit
            If lngBabyEdit = 1 Then
                MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
                Exit Sub
            ElseIf lngBabyEdit = 2 Then
                MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
                Exit Sub
            End If
            Call MoveCurrRow(.Row, 1)
        Case conMenu_MoveDown
            lngBabyEdit = CheckBabyEdit
            If lngBabyEdit = 1 Then
                MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
                Exit Sub
            ElseIf lngBabyEdit = 2 Then
                MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
                Exit Sub
            End If
            Call MoveCurrRow(.Row, -1)
        Case conMenu_Sort
            lngBabyEdit = CheckBabyEdit
            If lngBabyEdit = 1 Then
                MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
                Exit Sub
            ElseIf lngBabyEdit = 2 Then
                MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
                Exit Sub
            End If
            Call MoveRowAll
        Case conMenu_Previous
            If mblnRefresh = False Then Call LoadPatients(1)
            If lvwPati.SelectedItem.Index <= 1 Then Exit Sub
            lvwPati.ListItems(lvwPati.SelectedItem.Index - 1).Selected = True
            Call lvwPati_KeyPress(13)
            lvwPati.ListItems("_" & mlng病人ID & "_" & mlng主页ID).Selected = True
        Case conMenu_Next
            If mblnRefresh = False Then Call LoadPatients(1)
            If lvwPati.SelectedItem.Index >= lvwPati.ListItems.Count Then Exit Sub
            lvwPati.ListItems(lvwPati.SelectedItem.Index + 1).Selected = True
            Call lvwPati_KeyPress(13)
            lvwPati.ListItems("_" & mlng病人ID & "_" & mlng主页ID).Selected = True
        Case conMenu_ShowStop
            If mblnNoSave Then
                MsgBox "当前医嘱内容编辑后尚未保存，请先保存或暂存。", vbInformation, gstrSysName
                Exit Sub
            End If

            mblnShowStop = Not mblnShowStop
            cbsMain.RecalcLayout

            Call ReLoadAdvice(vsAdvice.RowData(vsAdvice.Row))
        Case conMenu_New
            If CheckedPathSended = False Then Exit Sub
            lngBabyEdit = CheckBabyEdit
            If lngBabyEdit = 1 Then
                MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
                Exit Sub
            ElseIf lngBabyEdit = 2 Then
                MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
                Exit Sub
            End If
            If .RowData(.Row) = 0 Then
                '无
            ElseIf .RowData(.Rows - 1) = 0 Then
                .Row = .Rows - 1
            Else
                '先删除中间间隔的空行
                mblnRowChange = False
                For i = .Rows - 1 To .FixedRows Step -1
                    If .RowData(i) = 0 Then .RemoveItem i
                Next
                mblnRowChange = True

                .AddItem "", .Rows
                .Row = .Rows - 1
                .Col = .FixedCols
            End If

            Call .ShowCell(.Row, .Col)
            If Not mbln医技后续 And mlng前提ID <> 0 Then
                Call Cbo.SetIndex(cbo期效.hwnd, 1)
            End If
    
            If Visible And cbo期效.Enabled And cbo期效.Visible Then
                cbo期效.SetFocus
            ElseIf Visible And txt医嘱内容.Enabled Then
                txt医嘱内容.SetFocus
            End If
        Case conMenu_Edit_ViewDrugExplain '查看药品说明书
            Call FuncViewDrugExplain(Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_收费细目ID)), Me)
        Case conMenu_Insert
            If CheckedPathSended = False Then Exit Sub
            lngBabyEdit = CheckBabyEdit
            If lngBabyEdit = 1 Then
                MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
                Exit Sub
            ElseIf lngBabyEdit = 2 Then
                MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
                Exit Sub
            End If
            If .RowData(.Row) = 0 Then
                MsgBox "当前行无内容，请先在当前行录入有效医嘱。", vbInformation, gstrSysName
                Exit Sub
            End If
 
            lngPreRow = GetPreRow(.Row)

            '插入后成自动成为一并给药:插入在一并给药的中间才行
            If lngPreRow <> -1 Then
                If Val(.TextMatrix(lngPreRow, COL_相关ID)) = Val(.TextMatrix(.Row, COL_相关ID)) _
                   And Val(.TextMatrix(lngPreRow, COL_相关ID)) <> 0 And InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then

                    '不能在已校对的一并给药中插入
                    If InStr(",1,2,-1,", .TextMatrix(.Row, COL_状态)) = 0 Then
                        MsgBox "该组一并给药的医嘱已经过校对，不能再插入。", vbInformation, gstrSysName
                        Exit Sub
                    End If

                    '不能在已签名的一并给药中插入
                    If Val(.TextMatrix(.Row, COL_签名否)) = 1 Then
                        MsgBox "该组一并给药的医嘱已经签名，不能再插入。", vbInformation, gstrSysName
                        Exit Sub
                    End If

                    lng相关ID = Val(.TextMatrix(lngPreRow, COL_相关ID))
                End If
            End If

            '先删除中间间隔的空行
            mblnRowChange = False
            lng医嘱ID = .RowData(.Row)
            For i = .Rows - 1 To .FixedRows Step -1
                If .RowData(i) = 0 Then .RemoveItem i
            Next
            .Row = .FindRow(lng医嘱ID)
            mblnRowChange = True

            '当前行之前插入新行
            '--------------------------------------------------------------
            If RowIn配方行(.Row) Or RowIn检验行(.Row) Then
                '中药配方及检验组合行是前面的行隐藏
                lngBegin = .FindRow(CStr(.RowData(.Row)), , COL_相关ID)
            Else
                lngBegin = .Row
            End If

            mblnRowChange = False
            .AddItem "", lngBegin
            .Row = lngBegin
            .Col = .FixedCols
            If lng相关ID <> 0 Then .TextMatrix(.Row, COL_并) = "┃"
            mblnRowChange = True
            Call vsAdvice_AfterRowColChange(-1, .Col, .Row, .Col)
            Call .ShowCell(.Row, .Col)

            If Not mbln医技后续 And mlng前提ID <> 0 Then
                Call Cbo.SetIndex(cbo期效.hwnd, 1)
            End If
            If cbo期效.Enabled And cbo期效.Visible Then
                cbo期效.SetFocus  '先定位避免光标晃
            ElseIf txt医嘱内容.Enabled Then
                txt医嘱内容.SetFocus
            End If
        Case conMenu_Merge    '一并给药
            If Not Control.Checked Then    '想按下
                lngBegin = GetPreRow(.Row)
                '前面没有行
                If lngBegin = -1 Then
                    MsgBox "前面没有可以一并给药的医嘱行。", vbInformation, gstrSysName
                    Exit Sub
                End If
                '两行不符合条件
                If Not RowCanMerge(lngBegin, .Row, strMsg) Then
                    MsgBox strMsg, vbInformation, gstrSysName
                    Exit Sub
                End If
                If .RowData(.Row) = 0 Then
                    '当前行尚未输入内容的情况
                    cbo期效.ListIndex = IIF(.TextMatrix(lngBegin, COL_期效) = "临嘱", 1, 0)

                    If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                        msk开始时间.Text = .Cell(flexcpData, lngBegin, COL_开始时间)
                    ElseIf DateDiff("n", CDate(.Cell(flexcpData, lngBegin, COL_开始时间)), zlDatabase.Currentdate) <= gint补录间隔 Then
                        msk开始时间.Text = .Cell(flexcpData, lngBegin, COL_开始时间)
                    End If

                    mblnRowMerge = True: cbsMain.RecalcLayout    '*允许按下
                    If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
                    Exit Sub
                Else
                    '要把当前行与前面行一起一并给药
                    If .TextMatrix(.Row, COL_用法) <> .TextMatrix(lngBegin, COL_用法) Then
                        If MsgBox("当前选择一并给药的药品给药途径不同,是否继续？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                            Exit Sub
                        End If
                    End If
                    Call MergeRow(lngBegin, .Row, False)
                    Call ReSetColor(.Row)    '一并之后再一并设置
                End If
            Else    '想弹起
                If .RowData(.Row) = 0 Then
                    '是否当前行尚未输入内容的情况
                    If Not RowIn一并给药(.Row) Then
                        mblnRowMerge = False    '*允许弹起
                        cbsMain.RecalcLayout
                    End If
                    Exit Sub
                Else
                    '当前行是一并给药中的行
                    Call Get一并给药范围(Val(.TextMatrix(.Row, COL_相关ID)), lngBegin, lngEnd)

                    '先判断可否取消一并给药
                    '不能包含已校对的医嘱
                    If InStr(",1,2,-1,", .TextMatrix(.Row, COL_状态)) = 0 Then
                        MsgBox "当前医嘱已经过校对。", vbInformation, gstrSysName
                        Exit Sub
                    End If

                    '不能包含已签名的医嘱
                    If Val(.TextMatrix(.Row, COL_签名否)) = 1 Then
                        MsgBox "当前医嘱已经签名。", vbInformation, gstrSysName
                        Exit Sub
                    End If

                    '先提示
                    If Not (.Row = lngEnd And lngEnd - lngBegin > 1) Then
                        .Redraw = flexRDNone
                        If Val(.TextMatrix(lngBegin, COL_路径执行ID)) <> 0 And Val(.TextMatrix(lngBegin, COL_EDIT)) <> 1 Then
                            Call MsgBox("一并给药中包括已生成的路径内项目，不能全部取消为单独给药。" & vbCrLf & _
                                        "如果要取消一并，请从该组药品的最后一行开始进行。", vbInformation, gstrSysName)
                            .Redraw = flexRDDirect
                            Exit Sub
                        Else
                            '整个一并给药取消为单独给药
                            If MsgBox("要将该组一并给药的药品全部取消为单独给药吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                                .Redraw = flexRDDirect
                                Exit Sub
                            End If
                        End If
                        .Redraw = flexRDDirect
                    End If

                    '删除中间的空行
                    lngTmp = .RowData(.Row)
                    For i = lngEnd To lngBegin Step -1
                        If .RowData(i) = 0 Then
                            .RemoveItem i
                            lngEnd = lngEnd - 1
                        End If
                    Next
                    .Row = .FindRow(lngTmp, lngBegin)

                    If .Row = lngEnd And lngEnd - lngBegin > 1 Then
                        '从一并给药中分离该行
                        Call ReSetColor(.Row)    '在取消之前一并设置
                        Call SplitRow(.Row)
                    Else
                        '取消一并给药
                        Call ReSetColor(.Row)    '在取消之前一并设置
                        lngTmp = .RowData(.Row)    '记录用于恢复行定位
                        Call AdviceSet单独给药(lngBegin, lngEnd)
                        .Row = .FindRow(lngTmp)
                    End If
                End If
            End If
            Call vsAdvice_AfterRowColChange(-1, .Col, .Row, .Col)
        Case conMenu_Delete
            If .RowSel <> .Row Then
                MsgBox "一次只能删除一条医嘱，请选择要删除的医嘱行。", vbInformation, gstrSysName
                Exit Sub
            End If
            If .RowData(.Row) <> 0 Then
                '已校对的医嘱不能删除
                If InStr(",1,2,-1,", .TextMatrix(.Row, COL_状态)) = 0 Then
                    MsgBox "该条医嘱已经过校对，不能删除。", vbInformation, gstrSysName
                    Exit Sub
                End If

                If mintPState = ps最近转出 Then
                    If Val(.TextMatrix(.Row, COL_开嘱科室ID)) <> mlng病人科室id Then
                        MsgBox "该条医嘱不是最近转出前的科室下达的，不允许删除。", vbInformation, gstrSysName
                        Exit Sub
                    End If
                End If

                '已签名的医嘱不能删除
                If Val(.TextMatrix(.Row, COL_签名否)) = 1 Then
                    MsgBox "该条医嘱已经签名，不能删除。", vbInformation, gstrSysName
                    Exit Sub
                End If
                '已经执行登记的医嘱项目不能删除
                If mbytUseType = 0 And mlng路径状态 = 1 Then
                    If CheckPathAdviceIsExe(.RowData(.Row)) Then
                        MsgBox "该医嘱对应的项目已经执行。" & vbCrLf & "请取消执行登记后再进行删除操作。", vbInformation + vbOKOnly + vbDefaultButton1, gstrSysName
                        Exit Sub
                    End If
                End If
                '已保存的路径中的项目只有必要时使用的项目可删除，非必要时的，如果是选择生成医嘱的，允许删除到至少保留一条。
                If mbytUseType = 0 And Val(.TextMatrix(.Row, COL_路径项目ID)) <> 0 Then
                    If Val(.TextMatrix(.Row, COL_路径执行方式)) <> 3 And Val(.TextMatrix(.Row, COL_路径执行ID)) <> 0 Then
                        lng主ID = Val(.TextMatrix(.Row, COL_相关ID))
                        If lng主ID = 0 Then lng主ID = .RowData(.Row)

                        If CheckAdviceOfPathItem(Val(.TextMatrix(.Row, COL_路径执行ID)), lng主ID) Then
                            If MsgBox("该路径项目中的医嘱是必须生成的，是否删除？", vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                                Exit Sub
                            End If
                        End If
                    End If
                End If
                
                If MsgBox("确实要删除医嘱""" & .TextMatrix(.Row, col_医嘱内容) & """吗？", _
                          vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then Exit Sub

            End If
          
            '删除当前行
            Call AdviceDelete(.Row)
            .SetFocus
            
        Case conMenu_Edit_PacsApply, conMenu_Edit_PacsApply * 10# + 1 '检查申请
            Call AdviceInput申请单(1)
        Case conMenu_Edit_LISApply, conMenu_Edit_LISApply * 10# + 1 '检验申请
            Call AdviceInput申请单(2)
        Case conMenu_Edit_BloodApply, conMenu_Edit_BloodApply * 10# + 1 '输血申请
            Call AdviceInput申请单(3)
        Case conMenu_Edit_OperationApply, conMenu_Edit_OperationApply * 10# + 1 '手术申请
            Call AdviceInput申请单(4)
        Case conMenu_Edit_ConsultationApply, conMenu_Edit_ConsultationApply * 10# + 1 '会诊申请
            If ApplyBefore Then Call Apply会诊(vsAdvice.Row, 0)
        Case conMenu_Edit_ApplyCustom * 100# To conMenu_Edit_ApplyCustom * 101# '自定义申请单
                FuncApplyCustom 0, Control.Parameter
            
        Case conMenu_Stop
            Call AdviceStop
        Case conMenu_Reference
            If Val(.TextMatrix(.Row, COL_诊疗项目ID)) <> 0 Then
                If RowIn配方行(.Row) Or RowIn检验行(.Row) Then
                    i = .FindRow(CStr(.RowData(.Row)), , COL_相关ID)
                    If i <> -1 Then
                        lng诊疗项目ID = Val(.TextMatrix(i, COL_诊疗项目ID))
                    End If
                Else
                    lng诊疗项目ID = Val(.TextMatrix(.Row, COL_诊疗项目ID))
                End If
            End If
            '显示诊疗参考
            Call frmClinicHelp.ShowMe(IIF(mblnModal, 1, 0), mfrmParent, lng诊疗项目ID)
        Case conMenu_Copy
            If CheckedPathSended = False Then Exit Sub
            lngBabyEdit = CheckBabyEdit
            If lngBabyEdit = 1 Then
                MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
                Exit Sub
            ElseIf lngBabyEdit = 2 Then
                MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
                Exit Sub
            End If
            lng病人ID = mlng病人ID: lng主页ID = mlng主页ID: blnMoved = False
            strMsg = frmAdviceCopy.ShowMe(Me, mMainPrivs, lng病人ID, lng主页ID, blnMoved, mint场合 = 1, mlng前提ID, strAlter, mlng病人科室id, cbo婴儿.ListIndex, mlng婴儿科室ID, mstr性别)
            If strMsg <> "" Then
                cbsMain.FindControl(, conMenu_New, True, True).Execute
                Call AdviceSet复制医嘱(lng病人ID, lng主页ID, strMsg, blnMoved, strAlter)
            End If
        Case conMenu_AltAdvice
            '备选医嘱
            Call ShowAltAdvice
        Case conMenu_Scheme, conMenu_Scheme * 10# + 1
            '病人选择时已限制了住院数据未转出
            Call frmAdviceScheme.ShowMe(mint场合, IIF(mlng病人性质 = 1, 1, 2), mlng病人ID, mlng主页ID, "", cbo婴儿.ListIndex, Me)
        Case conMenu_Scheme * 10# + 2
            Call mfrmShortCut.ShowMe(Me, mint场合, IIF(mlng病人性质 = 1, 3, 2), mlng病人病区ID, mlng病人科室id, False, mlng医技科室ID)
        Case conMenu_Edit_MediAudit * 10# To conMenu_Edit_MediAudit * 10# + 99
            'PASS 执行
            If mblnPass Then
                Call gobjPass.zlPassCommandBarExe(mobjPassMap, Control.ID - conMenu_Edit_MediAudit * 10, mblnNoSave)
            End If
        Case conMenu_Agent '代办人信息录入
            For lngLoop = 1 To vsAdvice.Rows - 1
                If ((Val(vsAdvice.TextMatrix(lngLoop, COL_状态)) = 1 Or Val(vsAdvice.TextMatrix(lngLoop, COL_状态)) = -1) And InStr(",麻醉药,毒性药,精神I类,", "," & Trim(vsAdvice.TextMatrix(lngLoop, COL_毒理分类)) & ",") > 0) Then
                    blnTag = True: Exit For
                End If
            Next
            If Not blnTag Then MsgBox "病人未执行的医嘱中不存在麻醉药、毒性药、精神I类药品医嘱，不需要填写代办人信息！", vbInformation, gstrSysName: Exit Sub
            Call Get身份证号
            Call frmAgentInfo.ShowMe(Me, mlng病人ID, mlng主页ID, mstr姓名, mstr身份证号, AgentInfo.代办人姓名, AgentInfo.代办人身份证号, AgentInfo.代办人性别, AgentInfo.代办人年龄, AgentInfo.代办人电话, AgentInfo.用药理由)
            Call GetAgentInfo
            Screen.MousePointer = 0
        Case conMenu_Save    '保存
             mblnChecking = True
            If Not CheckAdvice Then mblnChecking = False: Exit Sub    '检查中处理了光标定位
            mblnChecking = False
            If Not SaveAdvice(False) Then .SetFocus: Exit Sub
            If mbln审核 Or mbytUseType = 1 Or mbytUseType = 2 Or mbytUseType = 3 Then Unload Me: Exit Sub
        Case conMenu_Report_AdviceBill1    '打印
            Call frmAdvicePrint.ShowMe(mfrmParent, mlng病人ID, mlng主页ID, "")
        Case conMenu_SendBilling, conMenu_SendCharge, conMenu_Send    '保存并发送临嘱，不退出
            mblnChecking = True
            If Not CheckAdvice Then mblnChecking = False: Exit Sub    '检查中处理了光标定位
            mblnChecking = False
            If Not SaveAdvice(False) Then
                .SetFocus: Exit Sub
            Else
                If Control.ID = conMenu_SendCharge Then
                    lngTmp = 1  '门诊收费
                Else
                    If mlng病人性质 = 1 Then
                        If InStr(GetInsidePrivs(p住院医嘱下达), ";发送门诊记帐;") > 0 Then
                            lngTmp = 2  '门诊记帐
                        Else
                            lngTmp = 1  '门诊收费
                        End If
                    Else
                        lngTmp = 0  '住院记帐
                        If mintPState = ps预出 Or mintPState = ps出院 Then
                            Call MsgBox("该病人已" & IIF(mintPState = ps预出, "预", "") & "出院，不允许进行医嘱发送！", vbInformation, gstrSysName)
                            Exit Sub
                        End If
                    End If
                End If

                If frmInAdviceSend.ShowMe(Me, mlng病人ID, mlng主页ID, mstr前提IDs, mlng病人病区ID, mlng病人科室id, mlng医技科室ID, blnRefresh, lngTmp, mlng病人性质, mlng医护科室ID, mclsMipModule) Then
                    If Val(zlDatabase.GetPara("发送完成后关闭医嘱窗体", glngSys, p住院医嘱下达, "0")) = 0 Then
                        Call ReLoadAdvice(vsAdvice.RowData(vsAdvice.Row))
                    Else
                        Unload Me
                    End If
                End If
            End If

        Case conMenu_Temp    '暂存
            mblnChecking = True
            If Not CheckAdvice(True) Then mblnChecking = False: Exit Sub    '检查中处理了光标定位
            mblnChecking = False
            If Not SaveAdvice(True) Then .SetFocus: Exit Sub
        Case conMenu_Sign    '签名
            Call AdviceSign
        Case conMenu_Edit_ViewRefcom
            If Not gobjPass Is Nothing Then Call gobjPass.ZLPharmReviewResultShow(Me, mlng病人ID, mlng主页ID)
        Case conMenu_Help
            ShowHelp App.ProductName, Me.hwnd, Me.Name
        Case conMenu_Exit
            Unload Me
        Case conMenu_DrugScale * 100# + 1 To conMenu_DrugScale * 100# + 99
            With vsAdvice
                txt单量.Text = FormatEx(Val(.TextMatrix(.Row, COL_剂量系数)) * Val(Control.Parameter), 5)
                Call zlControl.TxtSelAll(txt单量)
            End With
        Case conMenu_FirstDay * 100# + 1 To conMenu_FirstDay * 100# + 99
            txt首日时间.Text = Get缺省首日(vsAdvice.Row, Val(Control.Parameter))
            Call txt首日时间_Validate(False)
            Call zlControl.TxtSelAll(txt首日时间)
        Case conMenu_Tool_PlugIn_Item + 1 To conMenu_Tool_PlugIn_Item + 99 '外挂功能执行
            Call ExePlugIn(Control.Parameter)
        End Select
    End With
End Sub

Private Sub AdviceSign()
'功能：对医嘱进行电子签名
'       临床路径调用时禁用了签名功能，因为医嘱保存的SQL是用来返回的，不能调自动保存
    Dim strSQL As String, strIDs As String, i As Long
    Dim strSource As String, strSign As String
    Dim lng签名id As Long, lng证书ID As Long
    Dim intRule As Integer, strTimeStamp As String, strTimeStampCode As String
    Dim objControl As CommandBarControl
    Dim ColIDs As Collection, ColSource As Collection
    
    If gobjESign Is Nothing Then Exit Sub
    If gobjESign.CertificateStoped(UserInfo.姓名) Then
        MsgBox "您的签名证书已被停用，请联系信息科。", vbInformation, gstrSysName
        Exit Sub
    End If
    
    '自动保存
    Set objControl = cbsMain.FindControl(, conMenu_Save)
    If Not objControl Is Nothing Then
        If objControl.Enabled Then
            mblnChecking = True
            If Not CheckAdvice Then mblnChecking = False: Exit Sub    '检查中处理了光标定位
            mblnChecking = False
            If Not SaveAdvice(False) Then vsAdvice.SetFocus: Exit Sub
        End If
    End If
    
    '获取签名医嘱源文
    intRule = ReadAdviceSignSource(1, mlng病人ID, mlng主页ID, strIDs, 0, False, strSource, mstr前提IDs, , ColIDs, ColSource)
    If intRule = 0 Then Exit Sub
    If strSource = "" Then
        MsgBox "该病人目前没有可以签名的医嘱。", vbInformation, gstrSysName
        Exit Sub
    End If
    For i = 1 To ColIDs.Count
        strSign = gobjESign.Signature(ColSource(i), gstrDBUser, lng证书ID, strTimeStamp, Nothing, strTimeStampCode, (i <> 1))
        If strSign <> "" Then
            If strTimeStamp <> "" Then
                strTimeStamp = "To_Date('" & strTimeStamp & "','YYYY-MM-DD HH24:MI:SS')"
            Else
                strTimeStamp = "NULL"
            End If
            lng签名id = zlDatabase.GetNextID("医嘱签名记录")
            strSQL = "zl_医嘱签名记录_Insert(" & lng签名id & ",1," & intRule & ",'" & Replace(strSign, "'", "''") & "'," & lng证书ID & ",'" & ColIDs(i) & "'," & strTimeStamp & ",'" & UserInfo.姓名 & "','" & strTimeStampCode & "')"
            On Error GoTo errH
            Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
            On Error GoTo 0
        End If
    Next
    If strSign <> "" Then
        '重新读取显示医嘱
        Call ReLoadAdvice(vsAdvice.RowData(vsAdvice.Row))
        mblnOK = True
        If txt医嘱内容.Enabled Then
            txt医嘱内容.SetFocus
        Else
            vsAdvice.SetFocus
        End If

        MsgBox "已完成电子签名。", vbInformation, gstrSysName
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function AdviceStop() As Boolean
'功能：当前医嘱停止
    Dim strSQL As String, lng医嘱ID As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim lngCur As Long, i As Long, j As Long
    Dim strStop As String, datCurr As Date
    Dim str医嘱ID As String, intRule As Integer
    Dim lng签名id As Long, lng证书ID As Long
    Dim strSource As String, strSign As String
    Dim colSomeTime As New Collection
    Dim arrSQL As Variant, strTimeStamp As String, strTimeStampCode As String
    Dim strAdvicesTmp As String
    Dim lngPatiID As Long
    Dim lngPageId As Long
    Dim blnTrans As Boolean
    Dim rsTmp As Recordset
    Dim str终止原因 As String
    
    With vsAdvice
        arrSQL = Array()
        '判断：单独停止护理等级的参数是否启用
        If .TextMatrix(.Row, COL_类别) = "H" And .TextMatrix(.Row, COL_操作类型) = "1" And .TextMatrix(.Row, COL_频率性质) = "2" Then
            MsgBox "当前系统不允许单独停止护理等级医嘱。", vbInformation, Me.Caption
            Exit Function
        End If
        If Val(.TextMatrix(.Row, COL_相关ID)) <> 0 Then
            lng医嘱ID = Val(.TextMatrix(.Row, COL_相关ID))
        Else
            lng医嘱ID = .RowData(.Row)
        End If
 
        '停嘱时缺省的医嘱终止时间
        strStop = frmAdviceStopTime.ShowMe(Me, lng医嘱ID, mlng病人科室id, 0, , str终止原因)
        If strStop = "" Then Exit Function
        '医生停止医嘱电子签名
        If Val(.TextMatrix(.Row, COL_签名否)) <> 0 Then
            str医嘱ID = str医嘱ID & "," & lng医嘱ID
            '记录停止医嘱的执行终止时间：由于是在执行过程之前取签名源文,这时还未写入数据库
            colSomeTime.Add Format(strStop, "yyyy-MM-dd HH:mm:00"), "_" & lng医嘱ID
        End If
        
        '医生在当前时间停止
        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
        arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_停止(" & lng医嘱ID & ",To_Date('" & strStop & "','YYYY-MM-DD HH24:MI'),'" & UserInfo.姓名 & "',0,0,0,null,null,'" & str终止原因 & "')"
    End With
    
    '作废或停止时的电子签名
    If str医嘱ID <> "" Then
        strAdvicesTmp = str医嘱ID
        lngPatiID = mlng病人ID
        lngPageId = mlng主页ID
        
        '护士不能作废、停止医生已签名的医嘱
        If mint场合 = 1 Then
            MsgBox "你要停止的医嘱中包含医生已签名的医嘱，只能由医生来停止并签名。", vbInformation, gstrSysName
            Screen.MousePointer = 0: Exit Function
        End If
        
        '医生停止,作废时必须要签名
        If gobjESign Is Nothing Then
            If gintCA = 0 Then
                MsgBox "停止已签名医嘱时需要再次签名，但系统没有设置签名认证中心，不能停止。", vbInformation, gstrSysName
            Else
                MsgBox "停止已签名医嘱时需要再次签名，但电子签名部件未能正确安装，不能停止。", vbInformation, gstrSysName
            End If
            Screen.MousePointer = 0: Exit Function
        End If
        
        '获取签名医嘱源文
        strAdvicesTmp = Mid(strAdvicesTmp, 2) '组ID,返回为明细ID
        intRule = ReadAdviceSignSource(8, lngPatiID, lngPageId, strAdvicesTmp, 0, False, strSource, IIF("" = mstr前提IDs, 0, mlng医技科室ID), colSomeTime)
        If intRule = 0 Then Screen.MousePointer = 0: Exit Function
        If strSource = "" Then
            Screen.MousePointer = 0
            MsgBox "不能读取需要停止的已签名医嘱源文内容。", vbInformation, gstrSysName
            Exit Function
        End If
        
        strSign = gobjESign.Signature(strSource, gstrDBUser, lng证书ID, strTimeStamp, Nothing, strTimeStampCode)
        If strSign <> "" Then
            If strTimeStamp <> "" Then
                strTimeStamp = "To_Date('" & strTimeStamp & "','YYYY-MM-DD HH24:MI:SS')"
            Else
                strTimeStamp = "NULL"
            End If
            lng签名id = zlDatabase.GetNextID("医嘱签名记录")
            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
            arrSQL(UBound(arrSQL)) = "zl_医嘱签名记录_Insert(" & lng签名id & ",8," & intRule & ",'" & Replace(strSign, "'", "''") & "'," & lng证书ID & ",'" & strAdvicesTmp & "'," & strTimeStamp & ",'" & UserInfo.姓名 & "','" & strTimeStampCode & "')"
        Else
            Screen.MousePointer = 0: Exit Function
        End If
    End If
    
    On Error GoTo errH
    '检查输液配液记录
    If gstr输液配置中心 <> "" And (vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "5" Or vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "6") Then
        strSQL = "Select Max(Decode(Instr(',4,5,6,7,8,', ',' || B.操作类型 || ','), 0, Null, To_Char(A.执行时间, 'yyyy-MM-dd HH24:MI'))) As 允许执行时间," & _
            " Max(Decode(A.操作状态, 1, Null, To_Char(A.执行时间, 'yyyy-MM-dd HH24:MI'))) As 提示执行时间, Min(A.是否打包) As 打包" & _
            " From 输液配药记录 A,输液配药状态 B Where A.医嘱id = [1] and A.ID=B.配药ID And A.执行时间 > [2] and A.操作状态<>10"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng医嘱ID, CDate(Format(strStop, "yyyy-MM-dd HH:mm")))
        If rsTmp.RecordCount > 0 Then
            If rsTmp!允许执行时间 & "" <> "" Then
                If Val(rsTmp!打包 & "") = 1 Then
                    If MsgBox("停止时间之后（" & rsTmp!允许执行时间 & "）存在已经配药或发送，但已经打包的记录，是否继续停止医嘱？", vbQuestion + vbYesNo + vbDefaultButton2, "医嘱停止") = vbNo Then
                        Exit Function
                    End If
                Else
                    If MsgBox("停止时间之后（" & rsTmp!允许执行时间 & "）存在已经配药或发送的记录，是否继续停止医嘱？", vbQuestion + vbYesNo + vbDefaultButton2, "医嘱停止") = vbNo Then
                        Exit Function
                    End If
                End If
            End If
            If rsTmp!提示执行时间 & "" <> "" Then
                If MsgBox("停止时间之后（" & rsTmp!提示执行时间 & "）存在已经摆药、但未配药的记录，是否继续停止医嘱？", vbQuestion + vbYesNo + vbDefaultButton2, "医嘱停止") = vbNo Then
                    Exit Function
                End If
            End If
        End If
    End If
    
    gcnOracle.BeginTrans: blnTrans = True
    For i = 0 To UBound(arrSQL)
        zlDatabase.ExecuteProcedure CStr(arrSQL(i)), Me.Name
    Next
    gcnOracle.CommitTrans: blnTrans = False
    On Error GoTo 0
    Call ZLHIS_CIS_002(mclsMipModule, mlng病人ID, Trim(txtPati.Text), Trim(lblText(1).Caption), , IIF(mlng病人性质 = 1, 1, 2), mlng主页ID, mlng病人病区ID, , mlng病人科室id, "", , Trim(lblText(0).Caption), _
    lng医嘱ID, 0, vsAdvice.TextMatrix(vsAdvice.Row, COL_类别), vsAdvice.TextMatrix(vsAdvice.Row, COL_操作类型), UserInfo.姓名, strStop, vsAdvice.TextMatrix(vsAdvice.Row, COL_标志))
 
    '已停止的医嘱显示
    With vsAdvice
        lngBegin = .Row: lngEnd = .Row
        For i = .Row To .FixedRows Step -1
            If Val(.TextMatrix(i, COL_相关ID)) = lng医嘱ID Or .RowData(i) = lng医嘱ID Then
                lngBegin = i
            Else
                Exit For
            End If
        Next
        For i = .Row + 1 To .Rows - 1
            If Val(.TextMatrix(i, COL_相关ID)) = lng医嘱ID Or .RowData(i) = lng医嘱ID Then
                lngEnd = i
            Else
                Exit For
            End If
        Next
        
        If mblnShowStop Then
            '改变颜色
            datCurr = zlDatabase.Currentdate
            For i = lngBegin To lngEnd
                .TextMatrix(i, COL_状态) = 8
                .TextMatrix(i, COL_终止时间) = strStop
                .Cell(flexcpData, i, COL_终止时间) = strStop
                
                If Format(datCurr, "yyyy-MM-dd HH:mm") >= strStop Then
                    .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &H808080 '灰色
                ElseIf Format(datCurr, "yyyy-MM-dd HH:mm") < strStop Then
                    .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &HFF8080 '浅蓝
                End If
            Next
        Else
            '删除显示
            '记录下一条有效显示的医嘱
            lngCur = GetNextRow(lngEnd)
            If lngCur <> -1 Then lngCur = .RowData(lngCur)
    
            mblnRowChange = False
            '反序删除行
            For i = lngEnd To lngBegin Step -1
                .RemoveItem i
            Next
    
            '重新定位新的行
            If lngCur <> -1 Then
                lngCur = .FindRow(lngCur)
                .Row = lngCur
            Else
                cbsMain.FindControl(, conMenu_New, True, True).Execute
            End If
            .Col = col_医嘱内容
            Call .ShowCell(.Row, .Col)
            mblnRowChange = True
        End If
        Call vsAdvice_AfterRowColChange(-1, -1, .Row, .Col)
    End With
    
    If txt医嘱内容.Enabled Then
        txt医嘱内容.SetFocus
    Else
        vsAdvice.SetFocus
    End If
    
    mblnOK = True
    AdviceStop = True
    
    'PASS医嘱作废后自动调用审查功能
    If mblnPass And mint场合 = 0 Then
        Call gobjPass.zlPassAdviceSave(mobjPassMap, , , 1)
    End If
    
    Exit Function
errH:
    If blnTrans Then gcnOracle.RollbackTrans
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub Get一并给药范围(ByVal lng相关ID As Long, lngBegin As Long, lngEnd As Long)
'功能：根据相关的给药途径医嘱ID,确定一并给药的一组药品的起止行号
'说明：中间可能包含有空行
    Dim i As Long
    lngBegin = vsAdvice.FindRow(CStr(lng相关ID), , COL_相关ID)
    For i = lngBegin To vsAdvice.Rows - 1
        If Not vsAdvice.RowHidden(i) And vsAdvice.RowData(i) <> 0 Then
            If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = lng相关ID Then
                lngEnd = i
            Else
                Exit For
            End If
        End If
    Next
End Sub

Private Sub txtPati_GotFocus()
    zlControl.TxtSelAll txtPati
End Sub

Private Sub txtPati_KeyPress(KeyAscii As Integer)
    Dim i As Long
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If mblnRefresh = False Then Call LoadPatients(1)
        '根据输入定位病人
        If Not txtPati.Locked And txtPati.Text <> "" Then
            For i = 1 To lvwPati.ListItems.Count
                With lvwPati.ListItems(i)
                    If Left(txtPati.Text, 1) = "-" And IsNumeric(Mid(txtPati.Text, 2)) Then '-病人ID
                        If Val(Mid(.Key, 2)) = Val(Mid(txtPati.Text, 2)) Then Exit For
                    ElseIf Left(txtPati.Text, 1) = "*" And IsNumeric(Mid(txtPati.Text, 2)) Then '*门诊号
                        If .SubItems(Item_标识号) <> "" And Val(.SubItems(Item_标识号)) = Val(Mid(txtPati.Text, 2)) Then Exit For
                    ElseIf Left(txtPati.Text, 1) = "+" And IsNumeric(Mid(txtPati.Text, 2)) Then '+住院号
                        If .SubItems(Item_标识号) <> "" And Val(.SubItems(Item_标识号)) = Val(Mid(txtPati.Text, 2)) Then Exit For
                    ElseIf Left(txtPati.Text, 1) = "/" Then  '/床号
                        If Trim(.SubItems(Item_床号)) <> "" And UCase(Trim(.SubItems(Item_床号))) = UCase(Mid(txtPati.Text, 2)) Then Exit For
                    Else '当作姓名
                        If .Text <> "" And UCase(.Text) Like "*" & UCase(txtPati.Text) & "*" Then Exit For
                    End If
                End With
            Next
            If i <= lvwPati.ListItems.Count Then
                lvwPati.ListItems(i).EnsureVisible
                lvwPati.ListItems(i).Selected = True
                Call lvwPati_KeyPress(13)
            Else
                MsgBox "没有找到指定的病人，请重新输入。", vbInformation, gstrSysName
                txtPati.Text = lvwPati.SelectedItem.Text
                txtPati.ForeColor = lvwPati.SelectedItem.ForeColor
                txtPati.SetFocus: Exit Sub
            End If
        ElseIf txtPati.Locked Then
            Call SeekNextControl
        End If
    ElseIf Not txtPati.Locked Then
        txtPati.ForeColor = Me.ForeColor
    End If
End Sub

Private Sub txtPati_Validate(Cancel As Boolean)
    If Not lvwPati.SelectedItem Is Nothing Then
        If lvwPati.SelectedItem.Key = "_" & mlng病人ID & "_" & mlng主页ID Then
            txtPati.Text = lvwPati.SelectedItem.Text
            txtPati.ForeColor = lvwPati.SelectedItem.ForeColor
        End If
    End If
End Sub

Private Sub txt超量说明_Change()
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If .TextMatrix(.Row, COL_超量说明) <> txt超量说明.Text Then
                txt超量说明.Tag = "1"
            End If
        Else
            txt超量说明.Tag = "1"
        End If
    End With

End Sub

Private Sub txt超量说明_Validate(Cancel As Boolean)
    Call AdviceChange
End Sub

Private Sub txt单量_Change()
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If Val(.TextMatrix(.Row, COL_单量)) <> Val(txt单量.Text) Then
                txt单量.Tag = "1"
            End If
        Else
            txt单量.Tag = "1"
        End If
    End With
End Sub

Private Sub txt单量_GotFocus()
    Call zlControl.TxtSelAll(txt单量)
End Sub

Private Sub txt单量_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        With vsAdvice
            If IsNumeric(txt单量.Text) Or txt单量.Text = "" And (cbo期效.ListIndex = 1 Or .TextMatrix(.Row, COL_频率) Like "*持续*" And InStr(",5,6,", .TextMatrix(.Row, COL_类别)) = 0) Then
                Call txt单量_Validate(blnCancel)
                If Not blnCancel Then mblnReturn = True: Call SeekNextControl
            End If
        End With
    Else
        If vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "4" And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_可否分零)) = 0 Then
            If InStr("0123456789" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
        Else
            If InStr("0123456789." & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
        End If
    End If
End Sub

Private Sub txt单量_Validate(Cancel As Boolean)
    Dim strMsg As String, blnTag As Boolean
    Dim dbl次数 As Double, sng天数 As Single
    Dim dbl总量 As Double, dbl总剂量 As Double
    Dim lngFind As Long, blnDo As Boolean
    Dim lng总量 As Long
    Dim lngBegin As Long, lngEnd As Long
    
    With vsAdvice
        If Val(txt单量.Text) = 0 Then txt单量.Text = ""
        If mblnReturn Then mblnReturn = False: Exit Sub
        If Not IsNumeric(txt单量.Text) Then
            If txt单量.Text <> "" Then
                Cancel = True: txt单量_GotFocus: Exit Sub
            ElseIf .RowData(.Row) <> 0 And .TextMatrix(.Row, COL_期效) = "长嘱" Then
                '恢复人为的清除
                If IsNumeric(.TextMatrix(.Row, COL_单量)) Then
                    txt单量.Text = .TextMatrix(.Row, COL_单量)
                End If
            End If
        ElseIf CDbl(txt单量.Text) <= 0 Then
            Cancel = True: txt单量_GotFocus: Exit Sub
        ElseIf CDbl(txt单量.Text) > LONG_MAX Then
            Cancel = True: txt单量_GotFocus: Exit Sub
        ElseIf .RowData(.Row) <> 0 Then
            '单量合法性检查
            If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 And Val(.TextMatrix(.Row, COL_收费细目ID)) <> 0 Then
                blnDo = Not txt天数.Visible '给药方法为叮嘱，或输入天数时不检查
                If blnDo Then
                    lngFind = .FindRow(CLng(Val(.TextMatrix(.Row, COL_相关ID))), .Row + 1)
                    If lngFind <> -1 Then blnDo = blnDo And Val(.TextMatrix(lngFind, COL_执行性质)) <> 0
                End If
                If blnDo Then
                    dbl次数 = IIF(Val(.TextMatrix(.Row, COL_总量)) = 0, 1, Val(.TextMatrix(.Row, COL_总量))) * _
                        Val(.TextMatrix(.Row, COL_住院包装)) * Val(.TextMatrix(.Row, COL_剂量系数)) / Val(txt单量.Text)
                    If dbl次数 > 200 Then
                        If MsgBox("该药品按每次 " & FormatEx(txt单量.Text, 5) & .TextMatrix(.Row, COL_单量单位) & " 使用，" & _
                            IIF(Val(.TextMatrix(.Row, COL_总量)) = 0, "每", Val(.TextMatrix(.Row, COL_总量))) & _
                            .TextMatrix(.Row, COL_住院单位) & "可以使用 " & FormatEx(dbl次数, 5) & " 次。" & _
                            vbCrLf & vbCrLf & "你确认单量输入正确吗？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                            Cancel = True: txt单量_GotFocus: Exit Sub
                        End If
                    End If
                End If
            End If
            '处方限量的检查 ---- 临嘱  txt总量  检查总量；长嘱  txt单量和txt首次用量  取两者中较大值检查
            If .TextMatrix(.Row, COL_期效) = "长嘱" Then
                .TextMatrix(.Row, COL_是否超量) = ""
                If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 And Val(txt单量.Text) <> 0 And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
                    If Val(.TextMatrix(.Row, COL_收费细目ID)) = 0 Then '长嘱按品种下达时，只单纯比较单量或首次用量
                        dbl总量 = IIF(Val(txt首次用量.Text) > Val(txt单量.Text), Val(txt首次用量.Text), Val(txt单量.Text))
                        If dbl总量 > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then .TextMatrix(.Row, COL_是否超量) = "1"
                        
                        If Val(txt单量.Text) > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 And Val(txt首次用量.Text) < Val(txt单量.Text) Then
                            .TextMatrix(.Row, COL_是否超量) = "1"
                        End If
                    ElseIf Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 Then '成药长嘱按规格下达时，按一个频率周期的缺省总量比较
                        dbl总量 = Calc缺省药品总量(Val(txt单量.Text), 1, _
                            Val(.TextMatrix(.Row, COL_频率次数)), _
                            Val(.TextMatrix(.Row, COL_频率间隔)), _
                            .TextMatrix(.Row, COL_间隔单位), _
                            .TextMatrix(.Row, COL_执行时间), _
                            Val(.TextMatrix(.Row, COL_剂量系数)), _
                            Val(.TextMatrix(.Row, COL_住院包装)), _
                            Val(.TextMatrix(.Row, COL_可否分零)), _
                            Val(txt首次用量.Text))
                        dbl总剂量 = dbl总量 * Val(.TextMatrix(.Row, COL_住院包装)) * Val(.TextMatrix(.Row, COL_剂量系数))
                        If dbl总剂量 > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
                            .TextMatrix(.Row, COL_是否超量) = "1"
                        End If
                    End If
                ElseIf InStr(",5,6,7,", .TextMatrix(.Row, COL_类别)) = 0 Then '按一个频率周期的缺省总量进行检查
                    If Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 Then
                        If .TextMatrix(.Row, COL_间隔单位) = "周" Then
                            dbl总量 = Val(txt单量.Text) * Val(.TextMatrix(.Row, COL_频率次数)) / 7
                        ElseIf .TextMatrix(.Row, COL_间隔单位) = "天" Then
                            dbl总量 = Val(txt单量.Text) * Val(.TextMatrix(.Row, COL_频率次数)) / Val(.TextMatrix(.Row, COL_频率间隔))
                        ElseIf .TextMatrix(.Row, COL_间隔单位) = "小时" Then
                            dbl总量 = Val(txt单量.Text) * (Val(.TextMatrix(.Row, COL_频率次数)) / Val(.TextMatrix(.Row, COL_频率间隔))) * 24
                        ElseIf .TextMatrix(.Row, COL_间隔单位) = "分钟" Then
                            dbl总量 = Val(txt单量.Text) * (Val(.TextMatrix(.Row, COL_频率次数)) / Val(.TextMatrix(.Row, COL_频率间隔))) * (24 * 60)
                        End If
                    Else
                        dbl总量 = Val(txt单量.Text) '持续性长嘱
                    End If
                    If dbl总量 > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
                        .TextMatrix(.Row, COL_是否超量) = "1"
                    End If
                End If
            End If
            
            '最大金额提示
            If gcurMaxMoney > 0 Then
                If .TextMatrix(.Row, COL_单价) = "" Then .TextMatrix(.Row, COL_单价) = GetItemPrice(.Row) '用""不是零
                If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                    If Val(.TextMatrix(.Row, COL_收费细目ID)) <> 0 Then
                        dbl总量 = Val(txt单量.Text) / Val(.TextMatrix(.Row, COL_住院包装)) / Val(.TextMatrix(.Row, COL_剂量系数))
                    End If
                Else
                    dbl总量 = Val(txt单量.Text)
                End If
                If Val(.TextMatrix(.Row, COL_单价)) * dbl总量 > gcurMaxMoney Then
                    If MsgBox("当前医嘱 " & txt单量.Text & lbl单量单位(0).Caption & " 的金额达到了：" & Format(Val(.TextMatrix(.Row, COL_单价)) * dbl总量, "0.00") & "，要继续吗？", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                        Cancel = True: txt单量_GotFocus: Exit Sub
                    End If
                End If
            End If
            
            txt单量.Text = FormatEx(txt单量.Text, 5)
            
            '更改单量后，先输入单量时重新计算药品总量，如果可以录入总量
            '药品按药品特性计算(包括一次性药品)，非药品直接等于单量
            If txt单量.Tag <> "" And .TextMatrix(.Row, COL_期效) = "临嘱" And txt总量.Enabled _
                And (mbln天数 And InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Or mbln先输单量) Then
                sng天数 = Val(.TextMatrix(.Row, COL_天数))
                If sng天数 = 0 Then sng天数 = 1
                lngBegin = .Row
                If RowIn一并给药(.Row) Then
                    Call GetRowScope(.Row, lngBegin, lngEnd)
                    If Val(.TextMatrix(lngBegin, COL_总量)) > 0 And Val(.TextMatrix(lngBegin, COL_单量)) > 0 And .TextMatrix(lngBegin, COL_频率) <> "" _
                    And Val(.TextMatrix(lngBegin, COL_频率次数)) <> 0 And Val(.TextMatrix(lngBegin, COL_频率间隔)) <> 0 _
                    And Val(.TextMatrix(lngBegin, COL_剂量系数)) <> 0 And Val(.TextMatrix(lngBegin, COL_住院包装)) <> 0 Then
                        sng天数 = Calc缺省药品天数(Val(.TextMatrix(lngBegin, COL_总量)), Val(.TextMatrix(lngBegin, COL_单量)), _
                                        Val(.TextMatrix(lngBegin, COL_频率次数)), Val(.TextMatrix(lngBegin, COL_频率间隔)), .TextMatrix(lngBegin, COL_间隔单位), _
                                        Val(.TextMatrix(lngBegin, COL_剂量系数)), Val(.TextMatrix(lngBegin, COL_住院包装)), _
                                        Val(.TextMatrix(lngBegin, COL_可否分零)))
                    End If
                End If
                lng总量 = Val(txt总量.Text)
                If lng总量 = 0 Or Not mbln天数反算 Then
                    txt总量.Text = FormatEx(Calc缺省药品总量( _
                        Val(txt单量.Text), sng天数, _
                        IIF(Val(.TextMatrix(.Row, COL_频率次数)) = 0, 1, Val(.TextMatrix(.Row, COL_频率次数))), _
                        IIF(Val(.TextMatrix(.Row, COL_频率间隔)) = 0, 1, Val(.TextMatrix(.Row, COL_频率间隔))), _
                        IIF(.TextMatrix(.Row, COL_间隔单位) = "", "天", .TextMatrix(.Row, COL_间隔单位)), _
                        .TextMatrix(.Row, COL_执行时间), _
                        IIF(Val(.TextMatrix(.Row, COL_剂量系数)) = 0, 1, Val(.TextMatrix(.Row, COL_剂量系数))), _
                        IIF(Val(.TextMatrix(.Row, COL_住院包装)) = 0, 1, Val(.TextMatrix(.Row, COL_住院包装))), _
                        Val(.TextMatrix(.Row, COL_可否分零))), 5)
                    If InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") = 0 Then
                        txt总量.Text = IntEx(Val(txt总量.Text))
                    ElseIf Val(.TextMatrix(.Row, COL_可否分零)) <> 0 Then
                        txt总量.Text = IntEx(Val(txt总量.Text))
                    End If
                    txt总量.Tag = "1"
                     '检查总量
                    Call txt总量_Validate(Cancel)
                    If Cancel Then
                        Cancel = True
                        txt总量.Text = lng总量
                        Exit Sub
                    End If
                Else
                    If mbln天数反算 And lng总量 <> 0 Then
                        '计算一个天数
                        If Val(txt单量.Text) > 0 And .TextMatrix(lngBegin, COL_频率) <> "" _
                            And Val(.TextMatrix(lngBegin, COL_频率次数)) <> 0 And Val(.TextMatrix(lngBegin, COL_频率间隔)) <> 0 _
                            And Val(.TextMatrix(lngBegin, COL_剂量系数)) <> 0 And Val(.TextMatrix(lngBegin, COL_住院包装)) <> 0 Then
                                sng天数 = Calc缺省药品天数(lng总量, Val(txt单量.Text), _
                                    Val(.TextMatrix(lngBegin, COL_频率次数)), Val(.TextMatrix(lngBegin, COL_频率间隔)), .TextMatrix(lngBegin, COL_间隔单位), _
                                    Val(.TextMatrix(lngBegin, COL_剂量系数)), Val(.TextMatrix(lngBegin, COL_住院包装)), _
                                    Val(.TextMatrix(lngBegin, COL_可否分零)))
                            End If
                    End If
                End If
                
                If mbln天数反算 And InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                    If sng天数 = 0 Then sng天数 = 1
                    msngPre天数 = sng天数
                    txt天数.Text = sng天数
                End If
            End If
        End If
        
        '更新数据
        blnTag = txt单量.Tag <> ""
        Call AdviceChange
        If cbo期效.ListIndex = 0 And Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_单量)) > 0 And InStr(",5,6,", "," & vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) & ",") > 0 Then
            txt首次用量.TabStop = True
            txt首次用量.Enabled = True
            txt首次用量.BackColor = lvwPati.BackColor
        Else
            txt首次用量.Enabled = False
            txt首次用量.BackColor = Me.BackColor
        End If
        '药品库存检查:仅对成药长嘱(其它的用总量),只提醒,按一个频率周期算总量
        If blnTag Then
            If .TextMatrix(.Row, COL_期效) = "长嘱" And (InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 _
                Or .TextMatrix(.Row, COL_类别) = "4" And Val(.TextMatrix(.Row, COL_跟踪在用)) = 1) Then
                strMsg = CheckStock(.Row)
                If strMsg <> "" Then MsgBox strMsg, vbInformation, gstrSysName
            End If
        End If
    End With
End Sub

Private Sub msk开始时间_Change()
    msk开始时间.Tag = "1"
End Sub

Private Sub msk开始时间_GotFocus()
    If msk开始时间.Text = Replace(msk开始时间.Mask, "#", "_") Then msk开始时间.Text = GetDefaultTime(vsAdvice.Row, mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院)
    zlControl.TxtSelAll msk开始时间
End Sub

Private Sub msk开始时间_KeyPress(KeyAscii As Integer)
    Dim strDate As String
    If KeyAscii = 13 Then
        KeyAscii = 0
        If msk开始时间.Text <> Replace(msk开始时间.Mask, "#", "_") Then
            strDate = zlStr.FullDate(Val(Replace(Replace(Replace(Replace(msk开始时间.Text, "-", " "), "_", " "), ":", " "), " ", "")) & "")
            If IsDate(strDate) Then
                msk开始时间.Text = strDate
            End If
            If SeekNextControl Then Call msk开始时间_Validate(False)
        End If
    Else
        If InStr("0123456789 /-:" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub msk开始时间_Validate(Cancel As Boolean)
    Dim bln补录 As Boolean
    Dim strOldDate As String
    
    If Not msk开始时间.Enabled Then Exit Sub
    With vsAdvice
        If Not IsDate(msk开始时间.Text) Then
            If msk开始时间.Text <> Replace(msk开始时间.Mask, "#", "_") Then
                Cancel = True
                msk开始时间.SetFocus
                Exit Sub
            ElseIf .RowData(.Row) <> 0 Then
                If IsDate(.Cell(flexcpData, .Row, COL_开始时间)) Then
                    '恢复人为的清除
                    msk开始时间.Text = .Cell(flexcpData, .Row, COL_开始时间)
                End If
            End If
        Else
            '检查时间合法性
            If Not Check开始时间(msk开始时间.Text, txt终止时间.Text, , , .Row) Then
                Cancel = True
                msk开始时间.SetFocus
                Exit Sub
            End If
        End If
        strOldDate = .Cell(flexcpData, .Row, COL_开始时间)
        Call AdviceChange '更新数据
        If mbytUseType = 0 And mlng路径状态 = 1 And Val(.TextMatrix(.Row, COL_EDIT)) = 1 And Val(.TextMatrix(.Row, COL_诊疗项目ID)) <> 0 Then
            If Format(msk开始时间.Text, "YYYY-MM-DD") <> Format(strOldDate, "YYYY-MM-DD") Then
                Call SetPathRows(.Row, .Row)
            End If
        End If
    End With

End Sub

Private Sub cbo医生嘱托_Change()
    cbo医生嘱托.Tag = "1"
End Sub

Private Sub cbo医生嘱托_GotFocus()
    zlControl.TxtSelAll cbo医生嘱托
    Call zlCommFun.OpenIme(True)
End Sub

Private Sub cbo医生嘱托_LostFocus()
    Call zlCommFun.OpenIme(False)
End Sub

Private Sub cbo医生嘱托_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo医生嘱托.Text <> "" Then
            If ReasonSelect(cbo医生嘱托.Text, 2) Then Exit Sub
        End If
        If SeekNextControl Then Call cbo医生嘱托_Validate(False)
    End If
End Sub

Private Sub cbo医生嘱托_Validate(Cancel As Boolean)
    If zlCommFun.ActualLen(cbo医生嘱托.Text) > 100 Then
        MsgBox "输入内容不过超过 50 个汉字或 100 个字符。", vbInformation, gstrSysName
        cbo医生嘱托_GotFocus
        Cancel = True: Exit Sub
    End If
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub txt医嘱内容_DblClick()
    If cmdExt.Visible And cmdExt.Enabled Then cmdExt_Click
End Sub

Private Sub txt医嘱内容_GotFocus()
    If msk开始时间.Text = Replace(msk开始时间.Mask, "#", "_") Then msk开始时间_GotFocus
    Call zlControl.TxtSelAll(txt医嘱内容)
End Sub

Private Sub txt医嘱内容_KeyDown(KeyCode As Integer, Shift As Integer)
    Dim intTmp As Integer
    If Shift = vbCtrlMask And KeyCode = vbKeyA Then
        Call zlControl.TxtSelAll(txt医嘱内容)
    End If
    If KeyCode = vbKeySpace And txt医嘱内容.Text = "" And gblnIn必用 Then
        intTmp = ApplySelect
        If intTmp <> 0 Then Call AdviceInput申请单(intTmp)
    End If
End Sub

Private Sub Apply特殊(ByVal lngRow As Long, ByVal intType As Long, Optional ByRef rsIn As ADODB.Recordset)
'功能：转科/出院 申请定位缺省
'参数：intType 3-转科，5－出院
    Dim strSQL As String
    Dim strDepts As String
    Dim rsTmp As ADODB.Recordset
    
    
    On Error GoTo errH
    
    If rsIn Is Nothing Then
        strSQL = "Select a.名称,Null As 处方职务id,a.Id As 诊疗项目id, Null As 收费细目id,a.类别 As 类别id,decode(a.操作类型,'3','转科','5','出院',null) As 项目特性,Null As 药品剂型,Null As 规格" & _
            " From 诊疗项目目录 A" & _
            " Where a.类别 = 'Z' And a.操作类型 =[1]  And (a.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or a.撤档时间 Is Null) And" & _
            " Instr([3], ','|| a.服务对象||',')> 0 and (Exists (Select 1 From 诊疗适用科室 Where 项目id = a.Id And Instr([2], ',' || 科室id || ',') > 0) Or Not Exists" & _
            "       (Select 1 From 诊疗适用科室 Where 项目id = a.Id))"
        strDepts = "," & GetUser科室IDs & ","
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, intType, strDepts, ",2,3,")
    Else
        Set rsTmp = rsIn
    End If
    
    If Not rsTmp.EOF Then
        If AdviceInput(rsTmp, lngRow) Then
            Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
            '医保管控实时监测
            If mint险类 <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
                '总量不可输入：缺省并固定总量的医嘱，以及长嘱
                '成套医嘱不在这里检查
                If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) And Not txt总量.Enabled Then
                    If MakePriceRecord(vsAdvice.Row) Then
                        If Not gclsInsure.CheckItem(mint险类, 1, 0, mrsPrice) Then
                            Call AdviceCurRowClear: Exit Sub
                        End If
                    End If
                    '标记为已经作了检查
                    vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_状态) = 1
                End If
            End If
            Call SeekNextControl
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub txt医嘱内容_KeyPress(KeyAscii As Integer)
    Dim rsTmp As ADODB.Recordset
    Dim byt匹配 As Byte
    Dim blnOK As Boolean
    Dim rsTmpOther As ADODB.Recordset
    Dim str输入 As String
    Dim blnBarcode As Boolean '是否置空卫材的 批次 字段
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt医嘱内容.Text = "" Then Exit Sub
        If txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容) Then
            Call SeekNextControl
            Exit Sub
        End If
        
        If tbrFree.Buttons(1).value = 0 Then
            Set rsTmp = frmClinicSelect.ShowSelect(Me, mint场合, IIF(mlng会诊科室ID <> 0, 0, mlng病人病区ID), _
                    IIF(mlng会诊科室ID <> 0, mlng会诊科室ID, mlng病人科室id), cbo期效.ListIndex, mstr性别, txt医嘱内容.Text, txt医嘱内容, IIF(mlng病人性质 = 1, 1, 2), , mint险类, mlng病人性质, , , byt匹配, , , , , mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, , mlng医技科室ID)
            If rsTmp Is Nothing Then '取消或无数据
                '恢复原值
                'txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, COL_医嘱内容)
                zlControl.TxtSelAll txt医嘱内容
                If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
                Exit Sub
            ElseIf byt匹配 = 1 Then
                Call Cbo.SetIndex(cbo期效.hwnd, IIF(cbo期效.ListIndex = 0, 1, 0))
            End If
            '新项目的录入
            '成套项目中如果包含成药,则不能按规格下医嘱
            
            If Val(rsTmp!类别ID & "") = 4 And rsTmp!批次 & "" <> "" Then
                str输入 = txt医嘱内容.Text
                '使用条码匹配的规则：1、全数字或者数字+字母；长度10位数以上；
                If (Not zlCommFun.IsCharChinese(str输入)) And Len(str输入) >= 10 Then
                    If InStr("," & rsTmp!编码, "," & str输入) > 0 Then
                        '则匹配的是编码，置空批次
                        blnBarcode = True
                    End If
                End If
                If IsNumeric(str输入) Then
                    '1X.输入全是数字时只匹配编码
                    If Mid(gstrMatchMode, 1, 1) = "1" Then
                        If Len(str输入) >= 10 Then
                            If InStr("," & rsTmp!编码, "," & str输入) > 0 Then
                                '则匹配的是编码，置空批次
                                blnBarcode = True
                            End If
                        End If
                    End If
                ElseIf zlCommFun.IsCharAlpha(str输入) Then
                    'X1.输入全是字母时只匹配简码
                    If Mid(gstrMatchMode, 2, 1) = "1" Then
                        If Len(str输入) >= 10 Then
                            If InStr("," & rsTmp!简码, "," & str输入) > 0 Then
                                '则匹配的是编码，置空批次
                                blnBarcode = True
                            End If
                        End If
                    End If
                End If
            End If
            
            If blnBarcode Then
                Set rsTmpOther = zlDatabase.CopyNewRec(rsTmp)
                rsTmpOther!批次 = Null
                Set rsTmp = Nothing
                Set rsTmp = rsTmpOther
            End If
            
            '根据选择项目设置缺省医嘱信息
            Me.Refresh

            If AdviceInput(rsTmp, vsAdvice.Row) Then
                Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
                mbln刚录入 = True
                '医保管控实时监测
                If mint险类 <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
                    '总量不可输入：缺省并固定总量的医嘱，以及长嘱
                    '成套医嘱不在这里检查
                    If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) And Not txt总量.Enabled Then
                        If MakePriceRecord(vsAdvice.Row) Then
                            If Not gclsInsure.CheckItem(mint险类, 1, 0, mrsPrice) Then
                                Call AdviceCurRowClear: Exit Sub
                            End If
                        End If
                        '标记为已经作了检查
                        vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_状态) = 1
                    End If
                End If
                
                Call SeekNextControl
            Else
                '恢复原值
                'txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, COL_医嘱内容)
                zlControl.TxtSelAll txt医嘱内容
                If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
                Exit Sub
            End If
        ElseIf tbrFree.Buttons(1).value = 1 Then
            If txt医嘱内容.Text <> "" Then
                If zlCommFun.ActualLen(txt医嘱内容.Text) > txt医嘱内容.MaxLength Then
                    MsgBox "输入内容不过超过 " & txt医嘱内容.MaxLength \ 2 & " 个汉字或 " & txt医嘱内容.MaxLength & " 个字符。", vbInformation, gstrSysName
                    Call txt医嘱内容_GotFocus: Exit Sub
                End If
                Call AdviceInputFree(vsAdvice.Row)
                Call SeekNextControl
            End If
        End If
    End If
End Sub

Private Sub AdviceCurRowClear()
'功能：清除当前医嘱行的内容，清除后可望而保留当前输入行的新输入状态
    Dim int期效 As Integer, str开始时间 As String
    Dim lngPre As Long
    
    zlControl.FormLock Me.hwnd
    
    '记录之前基本的输入内容
    Call GetRowScope(vsAdvice.Row, lngPre, 0)
    int期效 = cbo期效.ListIndex: str开始时间 = msk开始时间.Text
    
    '删除行
    Call AdviceDelete(vsAdvice.Row)
    
    '在原位置插入新行
    mblnRowChange = False
    vsAdvice.AddItem "", lngPre
    vsAdvice.Row = lngPre: vsAdvice.Col = col_医嘱内容
    mblnRowChange = True
    Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
    
    cbo期效.ListIndex = int期效
    msk开始时间.Text = str开始时间
    If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
    
    zlControl.FormLock 0
End Sub

Private Sub cbo执行时间_GotFocus()
    zlControl.TxtSelAll cbo执行时间
    If vsAdvice.Row < 1 Then Exit Sub
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "周" Or vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "天" Or vsAdvice.TextMatrix(vsAdvice.Row, COL_间隔单位) = "小时" Then
        picHelp.Visible = True
    End If
End Sub

Private Sub txt医嘱内容_Validate(Cancel As Boolean)
    txt医嘱内容.Tag = txt医嘱内容.Text
    If tbrFree.Buttons(1).value = 0 Then
        '恢复人为的改变
        If txt医嘱内容.Text <> vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容) Then
            txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容)
        End If
    ElseIf tbrFree.Buttons(1).value = 1 Then
        If vsAdvice.RowData(vsAdvice.Row) <> 0 And txt医嘱内容.Text = "" Then
            '因为必须录入,所以自动恢复
            txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容)
            Exit Sub
        End If
        
        If txt医嘱内容.Text <> "" Then
            If zlCommFun.ActualLen(txt医嘱内容.Text) > txt医嘱内容.MaxLength Then
                MsgBox "输入内容不过超过 " & txt医嘱内容.MaxLength \ 2 & " 个汉字或 " & txt医嘱内容.MaxLength & " 个字符。", vbInformation, gstrSysName
                Call txt医嘱内容_GotFocus: Cancel = True: Exit Sub
            End If
            Call AdviceInputFree(vsAdvice.Row)
        End If
    End If
End Sub

Private Sub txt终止时间_Change()
    txt终止时间.Tag = "1"
End Sub

Private Sub txt终止时间_GotFocus()
    zlControl.TxtSelAll txt终止时间
End Sub

Private Sub txt终止时间_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt终止时间.Text <> "" Then
            txt终止时间.Text = zlStr.FullDate(txt终止时间.Text)
        End If
        Call txt终止时间_Validate(False)
        If mblnDateCheck = False Then
            SeekNextControl
        Else
            mblnDateCheck = False
        End If
    Else
        If InStr("0123456789 /-:" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txt终止时间_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If Button = 2 And txt终止时间.Locked Then
        glngTXTProc = GetWindowLong(txt终止时间.hwnd, GWL_WNDPROC)
        Call SetWindowLong(txt终止时间.hwnd, GWL_WNDPROC, AddressOf WndMessage)
    End If
End Sub

Private Sub txt终止时间_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If Button = 2 And txt终止时间.Locked Then
        Call SetWindowLong(txt终止时间.hwnd, GWL_WNDPROC, glngTXTProc)
    End If
End Sub

Private Sub txt终止时间_Validate(Cancel As Boolean)
    If txt终止时间.Locked Then Exit Sub
    
    If Not IsDate(txt终止时间.Text) And txt终止时间.Text <> "" Then
        mblnDateCheck = True
        Cancel = True
        txt终止时间_GotFocus
        Exit Sub
    ElseIf txt终止时间.Text <> "" Then
        '检查时间合法性
        If lbl终止时间.Caption = "终止时间" Then
            If Not Check终止时间(txt开嘱时间.Text, msk开始时间.Text, txt终止时间.Text) Then
                mblnDateCheck = True
                Cancel = True
                txt终止时间_GotFocus
                Exit Sub
            End If
        Else
            If Not Check开始时间(txt终止时间.Text, "", , , , 2) Then
                mblnDateCheck = True
                Cancel = True
                txt终止时间_GotFocus
                Exit Sub
            End If
        End If
    End If
    mblnDateCheck = False
    '更新数据
    Call AdviceChange
End Sub

Private Sub txt开嘱时间_Change()
    txt开嘱时间.Tag = "1"
End Sub

Private Sub txt开嘱时间_GotFocus()
    zlControl.TxtSelAll txt开嘱时间
End Sub


Private Sub txt开嘱时间_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If Button = 2 And txt开嘱时间.Locked Then
        glngTXTProc = GetWindowLong(txt开嘱时间.hwnd, GWL_WNDPROC)
        Call SetWindowLong(txt开嘱时间.hwnd, GWL_WNDPROC, AddressOf WndMessage)
    End If
End Sub

Private Sub txt开嘱时间_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If Button = 2 And txt开嘱时间.Locked Then
        Call SetWindowLong(txt开嘱时间.hwnd, GWL_WNDPROC, glngTXTProc)
    End If
End Sub


Private Sub txt总量_Change()
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If Val(.TextMatrix(.Row, COL_总量)) <> Val(txt总量.Text) Then
                txt总量.Tag = "1"
            End If
        Else
            txt总量.Tag = "1"
        End If
    End With
End Sub

Private Sub txt总量_GotFocus()
    zlControl.TxtSelAll txt总量
End Sub

Private Sub txt总量_KeyPress(KeyAscii As Integer)
    Dim strMask As String
    Dim blnCancel As Boolean
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If IsNumeric(txt总量.Text) Or (txt总量.Text = "" And vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "K") Then
            Call txt总量_Validate(blnCancel)
            If Not blnCancel Then mblnReturn = True: Call SeekNextControl
        End If
    Else
        If RowIn配方行(vsAdvice.Row) Then
            strMask = "0123456789" '中药配方只能输入整数
        ElseIf InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_类别)) > 0 Then
            If InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") > 0 _
                And Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_可否分零)) = 0 Then
                strMask = "0123456789."
            Else
                strMask = "0123456789"
            End If
        ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) = "4" And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_可否分零)) = 0 Then
            strMask = "0123456789"
        Else
            strMask = "0123456789."
        End If
        If InStr(strMask & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txt总量_LostFocus()
    mblnReturn = False
End Sub

Private Sub txt总量_Validate(Cancel As Boolean)
    Dim blnTag As Boolean, strMsg As String
    Dim dbl总量 As Double, sng天数 As Single, bln配方行 As Boolean
    Dim blnOutTotal As Boolean
    Dim blnMsg As Boolean
    Dim blnTmp As Boolean
    
    blnMsg = Me.ActiveControl Is txt总量
    
    With vsAdvice
        If Val(txt总量.Text) = 0 Then txt总量.Text = ""
        If mblnReturn Then mblnReturn = False: Exit Sub
        If Not IsNumeric(txt总量.Text) Then
            If txt总量.Text <> "" Then
                Cancel = True: txt总量_GotFocus: Exit Sub
            ElseIf .RowData(.Row) <> 0 Then
                '恢复人为的清除：输血临嘱允许不输入总量
                If .TextMatrix(.Row, COL_类别) <> "K" Then
                    If IsNumeric(.TextMatrix(.Row, COL_总量)) Then
                        txt总量.Text = .TextMatrix(.Row, COL_总量)
                    End If
                End If
            End If
        ElseIf CDbl(txt总量.Text) <= 0 Then
            Cancel = True: txt总量_GotFocus: Exit Sub
        ElseIf CDbl(txt总量.Text) > LONG_MAX Then
            Cancel = True: txt总量_GotFocus: Exit Sub
        Else
            txt总量.Text = FormatEx(txt总量.Text, 5)
        End If
        
        bln配方行 = RowIn配方行(.Row)
        
        If IsNumeric(txt总量.Text) Then
            If bln配方行 Then
                txt总量.Text = CInt(txt总量.Text)
            ElseIf InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                If InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") = 0 Then
                    txt总量.Text = IntEx(Val(txt总量.Text))
                ElseIf Val(.TextMatrix(.Row, COL_可否分零)) <> 0 Then
                    txt总量.Text = IntEx(Val(txt总量.Text))
                End If
            ElseIf Val(.TextMatrix(.Row, COL_计算方式)) = 3 Then
                '计次项目总量限制为整数。计次项目不输入单量,因此单量不管
                'txt总量.Text = IntEx(Val(txt总量.Text))
            End If
        End If
        
        '检查总量够否
        If InStr(",4,5,6,", .TextMatrix(.Row, COL_类别)) > 0 And .TextMatrix(.Row, COL_期效) = "临嘱" Then
            If .TextMatrix(.Row, COL_频率) <> "" _
                And Val(txt单量.Text) <> 0 _
                And Val(.TextMatrix(.Row, COL_剂量系数)) <> 0 _
                And Val(.TextMatrix(.Row, COL_住院包装)) <> 0 Then
                
                If Val(.TextMatrix(.Row, COL_频率性质)) = 1 Then
                    dbl总量 = FormatEx(Calc缺省药品总量( _
                        Val(txt单量.Text), 1, 1, 1, "天", "", _
                        Val(.TextMatrix(.Row, COL_剂量系数)), Val(.TextMatrix(.Row, COL_住院包装)), _
                        Val(.TextMatrix(.Row, COL_可否分零))), 5)
                Else
                    sng天数 = Val(txt天数.Text)
                    If sng天数 = 0 Then sng天数 = 1
                    
                    dbl总量 = FormatEx(Calc缺省药品总量( _
                        Val(txt单量.Text), sng天数, _
                        Val(.TextMatrix(.Row, COL_频率次数)), Val(.TextMatrix(.Row, COL_频率间隔)), _
                        .TextMatrix(.Row, COL_间隔单位), .TextMatrix(.Row, COL_执行时间), _
                        Val(.TextMatrix(.Row, COL_剂量系数)), Val(.TextMatrix(.Row, COL_住院包装)), _
                        Val(.TextMatrix(.Row, COL_可否分零))), 5)
                End If
                If Val(txt总量.Text) < dbl总量 Then
                    If mbln刚录入 = False Then
                        If MsgBox(.TextMatrix(.Row, COL_名称) & "按每次 " & _
                            txt单量.Text & .TextMatrix(.Row, COL_单量单位) & "," & _
                            .TextMatrix(.Row, COL_频率) & IIF(mbln天数 And .TextMatrix(.Row, COL_类别) <> "4", ",用药 " & sng天数 & " 天", "") & _
                            "执行时,至少需要 " & FormatEx(dbl总量, 5) & .TextMatrix(.Row, COL_总量单位) & ",要继续吗？", _
                            vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                            Cancel = True: txt总量_GotFocus: Exit Sub
                        End If
                    Else
                        '首次不提醒，直接反算；
                        mbln刚录入 = False
                    End If
                End If
            End If
        End If
        
        '处方限量的检查
        '临嘱只需要在 txt总量_Validate 中检查
        '长嘱只需要在 txt单量_Validate和txt首次用量_Validate中检查
        If .TextMatrix(.Row, COL_期效) = "临嘱" Then
            .TextMatrix(.Row, COL_是否超量) = ""
            If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Then
                If Val(.TextMatrix(.Row, COL_处方限量)) <> 0 Then
                    dbl总量 = Val(txt总量.Text) * Val(.TextMatrix(.Row, COL_住院包装)) * Val(.TextMatrix(.Row, COL_剂量系数))
                    If dbl总量 > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
                        .TextMatrix(.Row, COL_是否超量) = "1"
                    End If
                End If
            ElseIf RowIn配方行(.Row) Then
                txt总量.Tag = "1" '中药配方药品行被隐藏，通过调用AdviceChange间接设文本框可用性
                blnTmp = CheckCHLimited(.Row, Val(txt总量.Text), blnOutTotal, vsAdvice, COL_相关ID, COL_诊疗项目ID, COL_类别, COL_单量)
                If blnOutTotal Then .TextMatrix(.Row, COL_是否超量) = "1"
                 
            ElseIf InStr(",5,6,7,", .TextMatrix(.Row, COL_类别)) = 0 And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
                If Val(txt总量.Text) > Val(.TextMatrix(.Row, COL_处方限量)) And Val(.TextMatrix(.Row, COL_处方限量)) > 0 Then
                    .TextMatrix(.Row, COL_是否超量) = "1"
                End If
            End If
        End If
        
        '最大金额提示
        If gcurMaxMoney > 0 Then
            If .TextMatrix(.Row, COL_单价) = "" Then .TextMatrix(.Row, COL_单价) = GetItemPrice(.Row) '用""不是零
            If Val(.TextMatrix(.Row, COL_单价)) * Val(txt总量.Text) > gcurMaxMoney Then
                If MsgBox("当前医嘱 " & txt总量.Text & lbl总量单位.Caption & " 的金额达到了：" & Format(Val(.TextMatrix(.Row, COL_单价)) * Val(txt总量.Text), "0.00") & "，要继续吗？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                    Cancel = True: txt总量_GotFocus: Exit Sub
                End If
            End If
        End If
        
        '医保管控实时监测：首次输入(经过)或者更改时检查
        If mint险类 <> 0 And (.Cell(flexcpData, .Row, COL_状态) = 0 Or txt总量.Tag <> "") Then
            If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) Then
                If MakePriceRecord(.Row) Then
                    If Not gclsInsure.CheckItem(mint险类, 1, 0, mrsPrice) Then
                        Cancel = True: txt总量_GotFocus: Exit Sub
                    End If
                End If
                '标记为已经作了检查
                .Cell(flexcpData, .Row, COL_状态) = 1
            End If
        End If
        
        '反算天数（没有输入天数才反算）
        If mbln天数反算 And txt总量.Tag <> "" Then
            If .TextMatrix(.Row, COL_频率) <> "" _
                And Val(txt单量.Text) <> 0 And Val(.TextMatrix(.Row, COL_频率次数)) <> 0 And Val(.TextMatrix(.Row, COL_频率间隔)) <> 0 _
                And Val(.TextMatrix(.Row, COL_剂量系数)) <> 0 And Val(.TextMatrix(.Row, COL_住院包装)) <> 0 Then
                sng天数 = Calc缺省药品天数(Val(txt总量.Text), Val(txt单量.Text), _
                    Val(.TextMatrix(.Row, COL_频率次数)), Val(.TextMatrix(.Row, COL_频率间隔)), .TextMatrix(.Row, COL_间隔单位), _
                    Val(.TextMatrix(.Row, COL_剂量系数)), Val(.TextMatrix(.Row, COL_住院包装)), _
                    Val(.TextMatrix(.Row, COL_可否分零)))
                If sng天数 = 0 Then sng天数 = 1
                msngPre天数 = sng天数
                If sng天数 <> Val(txt天数.Text) Then
                    txt天数.Text = sng天数
                    txt天数.Tag = "1"
                    msng天数 = sng天数
                End If
            End If
        End If
        
        '更新数据
        blnTag = txt总量.Tag <> ""
        Call AdviceChange
        
        '药品库存检查:只提醒,修改了才提醒
        If blnTag Then
            If InStr(",5,6,", .TextMatrix(.Row, COL_类别)) > 0 Or bln配方行 _
                Or .TextMatrix(.Row, COL_类别) = "4" And Val(.TextMatrix(.Row, COL_跟踪在用)) = 1 Then
                strMsg = CheckStock(.Row)
                If strMsg <> "" Then MsgBox strMsg, vbInformation, gstrSysName
            End If
        End If
    End With
End Sub

Private Sub ClearAdviceCard()
'功能：清除医嘱显示卡片相关的内容
'参数：bln开始时间=是否清除开始时间
    Call SetCardEditable(True)
    
    msk开始时间.Text = Replace(msk开始时间.Mask, "#", "_")
    txt医嘱内容.Text = ""
    txt安排时间.Text = ""
    Cbo.SetIndex cbo分零.hwnd, -1
    cbo医生嘱托.Text = ""
    cbo执行科室.Clear
    cbo附加执行.Clear
    cbo医生.Text = "" '不清除以保留
    chk紧急.value = 0
    chk紧急.Visible = False '输医嘱内容后才可用
    cbo滴速.Text = ""
    txt超量说明.Text = ""
    
    mblnDoCheck = False
    chk紧急.value = 0
    chkStop.value = 0
    mblnDoCheck = True
    chkStop.Visible = False
    
    txt开嘱时间.Text = ""
    
    cmdExt.Enabled = False
    Call SetDayState(-1, -1)
    Call SetItemEditable(-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1)
    Call SetStartTime(True)
    
    stbThis.Panels(3).Text = ""
    stbThis.Panels(4).Text = ""
End Sub

Private Sub SetCardEditable(ByVal Editable As Boolean)
'功能：用颜色标识当前医嘱是否可以编辑
    Dim obj As Object, lngRow As Long

    For Each obj In Controls
        If InStr("Label;TextBox;ComboBox;CheckBox;OptionButton;MaskEdBox", TypeName(obj)) > 0 Then
            If Not obj.Container Is Nothing Then
                If obj.Container Is fraAdvice Then
                    If Editable Then
                        obj.ForeColor = Me.ForeColor
                    Else
                        obj.ForeColor = &H808080
                    End If
                End If
            End If
        End If
    Next
    fraAdvice.Enabled = Editable
    cmdSel.Enabled = fraAdvice.Enabled
    cmd常用嘱托.Enabled = fraAdvice.Enabled
    cmd医生嘱托.Enabled = fraAdvice.Enabled
    
    '临床路径生成时，如果定义的为药品品种，且长嘱是按规格下达，则允许通过该按钮选择其他规格
    If Editable And mbytUseType = 1 Then
        With vsAdvice
            lngRow = .Row
            If .RowData(lngRow) <> 0 Then
                If InStr("4,5,6", .TextMatrix(lngRow, COL_类别)) > 0 And Val("" & .Cell(flexcpData, lngRow, COL_收费细目ID)) = 0 Then
                    cmdSel.Enabled = .TextMatrix(lngRow, COL_期效) = "临嘱" Or .TextMatrix(lngRow, COL_期效) = "长嘱" And gbln药品按规格下医嘱 And Val(.TextMatrix(lngRow, COL_品种医嘱)) = 0
                Else
                    cmdSel.Enabled = False
                End If
            End If
        End With
    End If
End Sub

Private Function Get频率范围(ByVal lngRow As Long) As Integer
    Dim lngFind As Long
    Dim strSQL As String
    Dim rsTmp As Recordset
    Dim int频率 As Integer
    
    With vsAdvice
        If RowIn配方行(lngRow) Then
            Get频率范围 = 2 '中医
        Else
            If RowIn检验行(lngRow) Then '以检验项目行为准
                lngFind = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
                If lngFind <> -1 Then lngRow = lngFind
            End If
            '如果是备用医嘱，则取诊疗项目的频率
            int频率 = Val(.TextMatrix(lngRow, COL_频率性质))
            If .TextMatrix(lngRow, COL_频率) = "必要时" Or .TextMatrix(lngRow, COL_频率) = "需要时" Or .Cell(flexcpData, lngRow, COL_频率) = "1" Then
                strSQL = " Select 执行频率  from 诊疗项目目录 Where ID=[1]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_诊疗项目ID)))
                If rsTmp.RecordCount > 0 Then
                   int频率 = Val(rsTmp!执行频率 & "")
                End If
            End If
            If int频率 = 0 Then
                Get频率范围 = 1 '可选频率的项目使用西医频率项目
            ElseIf int频率 = 1 Then
                Get频率范围 = -1 '一次性
            ElseIf int频率 = 2 Then
                Get频率范围 = -2 '持续性
            End If
        End If
    End With
End Function

Private Function SeekVisibleRow() As Boolean
'功能：当前行为隐藏行时，定位到它所属的可见行
    Dim lngRow As Long
    
    With vsAdvice
        If Not .RowHidden(.Row) Then Exit Function
        If InStr(",F,G,C,D,E,", .TextMatrix(.Row, COL_类别)) > 0 And Val(.TextMatrix(.Row, COL_相关ID)) <> 0 Then
            lngRow = .FindRow(CLng(Val(.TextMatrix(.Row, COL_相关ID))))
        ElseIf .TextMatrix(.Row, COL_类别) = "7" Then
            lngRow = .FindRow(CLng(Val(.TextMatrix(.Row, COL_相关ID))))
        ElseIf .TextMatrix(.Row, COL_类别) = "E" And Val(.TextMatrix(.Row, COL_相关ID)) = 0 Then
            lngRow = .Row - 1
        End If
        If lngRow <> -1 Then
            If .RowData(lngRow) <> 0 Then
                .Row = lngRow: SeekVisibleRow = True
            End If
        End If
    End With
End Function

Private Sub SetCbo执行性质(ByVal bln临嘱 As Boolean, ByVal bln含自备药 As Boolean, ByVal bln临床自管药 As Boolean)
    cbo执行性质.Clear
    
    If bln临床自管药 Then
        cbo执行性质.AddItem "1-自备药"
    Else
        If bln临嘱 Then
            cbo执行性质.AddItem "0-正常"
            If bln含自备药 Then cbo执行性质.AddItem "1-自备药"
            cbo执行性质.AddItem "2-离院带药"
            cbo执行性质.AddItem "3-自取药"
            cbo执行性质.AddItem "4-不取药"
        Else
            cbo执行性质.AddItem "0-正常"
            If bln含自备药 Then cbo执行性质.AddItem "1-自备药"
            cbo执行性质.AddItem "4-不取药"
        End If
    End If
End Sub

Private Sub ShowOrHideQuestion()
'功能：显示或隐藏校对疑问说明
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, strMsg As String

    If lbl疑问.Caption <> "" Then lbl疑问.Caption = ""
    
    If Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_审核状态)) = 3 Then
        strMsg = GetKSSAuditQuestion(Val(vsAdvice.RowData(vsAdvice.Row)))
        If strMsg <> "" Then lbl疑问.Caption = "审核反馈：" & strMsg
        
    ElseIf Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_状态)) = 2 Then
            strSQL = "Select 操作说明 From 病人医嘱状态 Where 医嘱ID=[1] And 操作类型=2 Order by 操作时间 Desc"
            On Error GoTo errH
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, vsAdvice.RowData(vsAdvice.Row))
            If Not rsTmp.EOF Then lbl疑问.Caption = "校对疑问：" & rsTmp!操作说明
    End If
    pic疑问.Visible = lbl疑问.Caption <> ""
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub vsAdvice_AfterEdit(ByVal Row As Long, ByVal Col As Long)
    If mbytUseType = 1 And Col = COL_选择 Then
        Dim lngBegin As Long, lngEnd As Long
        Dim i As Long
        
        Call GetRowScope(Row, lngBegin, lngEnd)
        '一组医嘱一起选择
        For i = lngBegin To lngEnd
            vsAdvice.Cell(flexcpChecked, i, COL_选择) = vsAdvice.Cell(flexcpChecked, Row, COL_选择)
        Next
    End If
End Sub

Private Sub vsAdvice_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
'功能：当行改变时，更新卡片内容
    Dim rsItem As New ADODB.Recordset
    Dim strSQL As String, lngRow As Long
    Dim lng用法ID As Long, blnEditable As Boolean
    Dim lng药品ID As Long, lngBaseRow As Long '中药配方的第一味组成药行
    Dim dblPrice As Double, strTmp As String, i As Long
    Dim blnTemp As Boolean
    Dim bln显示单量 As Boolean, bln显示抗菌药物 As Boolean
    Dim blnEditableTmp As Boolean
    Dim Y As Long, lngBegin As Long, lngEnd As Long, bln屏蔽输液中心 As Boolean
    Dim bln静脉营养 As Boolean, rsTmp As Recordset
    Dim bln用血 As Boolean
     
    If vsAdvice.Col >= vsAdvice.FixedCols Then
        vsAdvice.ForeColorSel = vsAdvice.Cell(flexcpForeColor, NewRow, COL_开始时间)
    End If
   
    If NewRow = OldRow Then Exit Sub
    If Not mblnRowChange Then Exit Sub
    If SeekVisibleRow Then Exit Sub
    
     'PASS
    If mblnPass And Me.Visible Then
        If NewRow <> OldRow Then
            Call gobjPass.zlPassSetDrug(mobjPassMap)
        End If
    End If
    
    lngRow = NewRow
    '当前行是空行时，如果前一行是一并给药行，则缺省按下“一并”按钮
    If vsAdvice.RowData(lngRow) = 0 Then
        i = GetPreRow(lngRow)
        If i = -1 Then
            mblnRowMerge = False
        Else
            mblnRowMerge = RowIn一并给药(i)
        End If
    Else
        mblnRowMerge = RowIn一并给药(lngRow)
    End If
    cbsMain.RecalcLayout '*即时刷新
        
    zlControl.FormLock Me.hwnd
        
    On Error GoTo errH
    
    '显示或隐藏校对疑问说明
    Call ShowOrHideQuestion
    
    '恢复因临床路径禁用的控件
    If mbytUseType = 0 Then
        If lbl期效.Visible Then cbo期效.Enabled = True
        txt医嘱内容.Enabled = True
        cmdSel.Enabled = True
        cmdExt.Enabled = True
        cmdZYRemark.Visible = False
    End If
    
    With vsAdvice
        mbln刚录入 = False
        If .RowData(lngRow) = 0 Then
            '无效行清除卡片内容
            Call ClearAdviceCard
            
            '缺省为非自由录入
            tbrFree.Buttons(1).value = 0
            tbrFree.Buttons(1).Enabled = Not RowIn一并给药(lngRow)
            tbrFree.Buttons(1).Image = IIF(tbrFree.Buttons(1).Enabled, 1, 2)
                        
            '缺省期效根据上一行的显示
            If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Or mlng病人性质 = 1 Then
                Call Cbo.SetIndex(cbo期效.hwnd, 1) '缺省为临嘱 '留观病人缺省开临嘱
            Else
                i = GetPreRow(lngRow)
                If i = -1 Or Not Visible Then
                    If mlng前提ID <> 0 Then
                        Call Cbo.SetIndex(cbo期效.hwnd, 1) '缺省为临嘱
                    Else
                        Call Cbo.SetIndex(cbo期效.hwnd, 0) '缺省为长嘱
                    End If
                Else
                    If Not mbln医技后续 And mlng前提ID <> 0 Then
                        Call Cbo.SetIndex(cbo期效.hwnd, 1) '缺省为临嘱
                    Else
                        Call Cbo.SetIndex(cbo期效.hwnd, IIF(.TextMatrix(i, COL_期效) = "长嘱", 0, 1))
                    End If
                End If
            End If
            
            '缺省开始时间
            Call msk开始时间_GotFocus
        ElseIf Val(.TextMatrix(lngRow, COL_诊疗项目ID)) = 0 Then
            '自由录入医嘱
            blnEditable = True
            If InStr(",1,2,-1,", .TextMatrix(lngRow, COL_状态)) = 0 Then blnEditable = False
            
            '已签名的医嘱不可修改
            If Val(.TextMatrix(lngRow, COL_签名否)) = 1 Then blnEditable = False
            
            If mintPState = ps最近转出 Then
                If Val(.TextMatrix(lngRow, COL_开嘱科室ID)) <> mlng病人科室id Then blnEditable = False
            End If
            
            '母婴分离后，母亲科室不允许编辑新生儿医嘱，新生儿科室不允许编辑母亲医嘱。
            If blnEditable Then
                blnEditable = (CheckBabyEdit = 0)
            End If
            
            '修改资格判断
            If blnEditable Then
                If mint场合 <> 1 Then
                    '无资格的医生不能修改有资格的医生下达或审核了的医嘱
                    If Not mblnHaveAuditPriv Then
                        If HaveAuditPriv(GetAuditName(.TextMatrix(lngRow, COL_开嘱医生))) Then
                            blnEditable = False
                        End If
                    End If
                Else
                    '护士不能修改医生经过审核的医嘱
                    If .TextMatrix(lngRow, COL_开嘱医生) Like "*/*" Then blnEditable = False
                End If
            End If
            
            Call SetCardEditable(blnEditable)
            
            tbrFree.Buttons(1).value = 1
            tbrFree.Buttons(1).Enabled = blnEditable
            tbrFree.Buttons(1).Image = IIF(blnEditable, 1, 2)
            cmdExt.Enabled = False
            cmdSel.Enabled = False
            
            '临床路径的项目，禁止改变医嘱内容
            If blnEditable And mbytUseType = 0 And Val(.TextMatrix(lngRow, COL_路径执行ID)) <> 0 Then
                tbrFree.Buttons(1).Enabled = False
                tbrFree.Buttons(1).Image = 2
                cbo期效.Enabled = False
                txt医嘱内容.Enabled = False
            End If
            
            '其它输入项禁用
            Call SetDayState(-1, -1)
            SetItemEditable -1, -1, -1, -1, -1, , -1, -1, -1, -1, -1, -1, -1, -1, -1
            stbThis.Panels(3).Text = "": stbThis.Panels(4).Text = ""
            
            '显示当前医嘱卡片内容
            '--------------------------------------------------------------------------------------------
            Call Cbo.SetIndex(cbo期效.hwnd, IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1))
            
            '开始时间：没校对的医嘱都可以修改开始时间
            msk开始时间.Text = .Cell(flexcpData, lngRow, COL_开始时间)
            Call SetStartTime(Val(.TextMatrix(lngRow, COL_状态)) < 3)

            '医嘱内容
            txt医嘱内容.Text = .TextMatrix(lngRow, col_医嘱内容)
            
            
            '医生嘱托
            cbo医生嘱托.Text = .TextMatrix(lngRow, COL_医生嘱托)
            
            '紧急标志
            If Val(.TextMatrix(lngRow, COL_标志)) <> 2 Then
                chk紧急.Visible = True
                mblnDoCheck = False
                chk紧急.value = Val(.TextMatrix(lngRow, COL_标志))
                mblnDoCheck = True
            Else
                chk紧急.Visible = False
            End If
            
            '可选执行科室
            SetItemEditable , , , , , 1
            Call Get诊疗执行科室(mlng病人ID, mlng主页ID, cbo执行科室, "*", 0, 0, 4, mlng病人科室id, 0, Val(.TextMatrix(lngRow, COL_执行科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), cbo滴速.Visible)
            
            '开嘱医生
            If .TextMatrix(lngRow, COL_开嘱医生) Like "*/*" Then
                cbo医生.Clear: cbo医生.Locked = True
                cbo医生.AddItem .TextMatrix(lngRow, COL_开嘱医生)
                Call Cbo.SetIndex(cbo医生.hwnd, cbo医生.NewIndex)
            Else
                cbo医生.Locked = mint场合 <> 1
                If mint场合 = 1 Then
                    '加入当前医生:不清除历史选择
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, .TextMatrix(lngRow, COL_开嘱医生), 0, cbo医生, IIF(mlng病人性质 = 1, 1, 2), True)
                Else
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, .TextMatrix(lngRow, COL_开嘱医生), 0, cbo医生)
                End If
            End If
            
            '开嘱时间
            txt开嘱时间.Text = .Cell(flexcpData, lngRow, COL_开嘱时间)
        Else
            '卡片编辑：已校对的医嘱不能修改,补录医嘱时不能更改非补录的内容
            blnEditable = True
            If InStr(",-1,1,2,", "," & .TextMatrix(lngRow, COL_状态) & ",") = 0 Then blnEditable = False
            
            '已签名的医嘱不可修改
            If Val(.TextMatrix(lngRow, COL_签名否)) = 1 Then blnEditable = False
            
            '母婴分离后，母亲科室不允许编辑新生儿医嘱，新生儿科室不允许编辑母亲医嘱。
            If blnEditable Then
                blnEditable = (CheckBabyEdit = 0)
            End If

            If .TextMatrix(lngRow, COL_类别) = "K" And gbln血库系统 Then
                '血库环节
                If Not (Val(.TextMatrix(lngRow, COL_检查方法)) = 1 And Val(.TextMatrix(lngRow, COL_审核状态)) = 2) Then
                    '旧程 5－血库配血中
                    If Val(.TextMatrix(lngRow, COL_审核状态)) = 5 Or Val(.TextMatrix(lngRow, COL_审核状态)) = 2 Then blnEditable = False
                End If
            Else
                '审核通过的不允许修改
                If Val(.TextMatrix(lngRow, COL_审核状态)) = 2 Then blnEditable = False
            End If
            
            '是输血医嘱时，新开后直接进入4这个状态，这时候是允许编辑的，否则禁止
            If Val(.TextMatrix(lngRow, COL_审核状态)) = 4 And .TextMatrix(lngRow, COL_类别) = "K" Then
                If CanEditBloodAdvice(Val(.RowData(lngRow)), Val(.TextMatrix(lngRow, COL_审核状态)), Val(.TextMatrix(lngRow, COL_标志)) = 1, Val(.TextMatrix(lngRow, COL_检查方法)) = 1, False) = False Then blnEditable = False
            End If
            
            If mintPState = ps最近转出 Then
                If Val(.TextMatrix(lngRow, COL_开嘱科室ID)) <> mlng病人科室id Then blnEditable = False
            End If
            
            '修改资格判断
            If blnEditable Then
                If mint场合 <> 1 Then
                    '无资格的医生不能修改有资格的医生下达或审核了的医嘱
                    If Not mblnHaveAuditPriv Then
                        If HaveAuditPriv(GetAuditName(.TextMatrix(lngRow, COL_开嘱医生))) Then
                            blnEditable = False
                        End If
                    End If
                Else
                    '护士不能修改医生经过审核的医嘱
                    If .TextMatrix(lngRow, COL_开嘱医生) Like "*/*" Then blnEditable = False
                End If
            End If
            
            Call SetCardEditable(blnEditable)
            
            '已有诊疗项目，不可变为自由录入
            tbrFree.Buttons(1).value = 0
            tbrFree.Buttons(1).Enabled = False
            tbrFree.Buttons(1).Image = 2
            
            '获取诊疗项目基本信息
            '---------------------
            If InStr(",4,5,6,7,", Val(.TextMatrix(lngRow, COL_类别))) > 0 Then
                lng药品ID = Val(.TextMatrix(lngRow, COL_收费细目ID))
            End If
            
            If RowIn配方行(lngRow) Then
                txt总量.MaxLength = 3
                '获取中药配方第一味中药行
                lngBaseRow = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
                lng药品ID = Val(.TextMatrix(lngBaseRow, COL_收费细目ID))
            ElseIf RowIn检验行(lngRow) Then
                '获取一并采样的第一个项目行
                lngBaseRow = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
                txt总量.MaxLength = txt单量.MaxLength
            Else
                lngBaseRow = lngRow
                txt总量.MaxLength = txt单量.MaxLength
            End If
            Set rsItem = Get诊疗项目记录(Val(.TextMatrix(lngBaseRow, COL_诊疗项目ID)))
            
            '扩展按钮可用状态(检查组合,检验组合,手术,中药配方)
            cmdExt.Enabled = InStr(",7,C,F,D,", rsItem!类别) > 0
            If rsItem!类别 = "E" Or rsItem!类别 = "K" Then
                If rsItem!类别 = "K" And Val(.TextMatrix(lngRow, COL_申请序号) & "") <> 0 Then
                    cmdExt.Enabled = True
                Else
                    cmdExt.Enabled = CheckApplication(Val(.TextMatrix(lngBaseRow, COL_诊疗项目ID)), 2)
                End If
            ElseIf rsItem!类别 = "Z" And rsItem!操作类型 & "" = "7" And Val(.TextMatrix(lngRow, COL_申请序号) & "") <> 0 Then
                cmdExt.Enabled = True
            End If
            
            '临床路径禁止修改的内容
            If mbytUseType = 0 And Val(.TextMatrix(lngRow, COL_路径执行ID)) <> 0 Then
                '已保存的项目，不允许再改扩展项
                If cmdExt.Enabled Then cmdExt.Enabled = False
                                    
                '临床路径的项目，禁止改变医嘱内容
                If blnEditable Then
                    cbo期效.Enabled = False
                    txt医嘱内容.Enabled = False
                    cmdSel.Enabled = False
                End If
            End If
            
            
            '显示当前医嘱卡片内容
            '--------------------------------------------------------------------------------------------
            Call Cbo.SetIndex(cbo期效.hwnd, IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1))
            
            '开始时间：没校对的医嘱都可以修改开始时间
            msk开始时间.Text = .Cell(flexcpData, lngRow, COL_开始时间)
            Call SetStartTime(Val(.TextMatrix(lngRow, COL_状态)) < 3)
            
            '医嘱内容
            txt医嘱内容.Text = .TextMatrix(lngRow, col_医嘱内容)
            '超量说明
            txt超量说明.Text = .TextMatrix(lngRow, COL_超量说明)
            '首次用量
            txt首次用量.Text = .TextMatrix(lngRow, COL_首次用量)
            SetItemEditable , , , , , , , , , , , , , , , IIF(.TextMatrix(lngRow, COL_是否超量) = "1", 1, -1)
            If txt超量说明.Text <> "" Then
                cmdExcReason.Enabled = blnEditable
                cmdComExcReason.Enabled = blnEditable
            End If
            
            '分零方式:长期，动态分零的非中药医嘱，有规格的
            If cbo期效.ListIndex = 0 And Val(.TextMatrix(lngRow, COL_动态分零)) = 1 _
                And InStr(",5,6,", Val(.TextMatrix(lngRow, COL_类别))) > 0 And Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
                i = Cbo.FindIndex(cbo分零, Val(.TextMatrix(lngRow, COL_可否分零)))
                Cbo.SetIndex cbo分零.hwnd, i
                SetItemEditable , , , , , , , , , 1
            Else
                SetItemEditable , , , , , , , , , -1
            End If
            
            '单量
            '----------------------
            If rsItem!类别 = "7" Then '中药配方(中草药)虽然有单量,但不在这里填写
                SetItemEditable -1
            ElseIf cbo期效.ListIndex = 0 Then
                '长嘱：成药或计时,计量项目可以录入
                If InStr(",1,2,", NVL(rsItem!计算方式, 0)) > 0 Or InStr(",5,6,", rsItem!类别) > 0 Then
                    SetItemEditable 1
                    bln显示单量 = True
                    txt单量.Text = .TextMatrix(lngRow, COL_单量)
                    lbl单量单位(0).Caption = .TextMatrix(lngRow, COL_单量单位)
                    lbl单量单位(1).Caption = .TextMatrix(lngRow, COL_单量单位)
                Else
                    SetItemEditable -1
                End If
            ElseIf cbo期效.ListIndex = 1 Then
                '临嘱:成药或可选择频率的计时,计量项目可以录入(注意这是原始频率,当前可能已是一次性)
                If (NVL(rsItem!执行频率, 0) = 0 And InStr(",1,2,", NVL(rsItem!计算方式, 0)) > 0) _
                    Or InStr(",5,6,", rsItem!类别) > 0 Then
                    SetItemEditable 1
                    bln显示单量 = True
                    txt单量.Text = .TextMatrix(lngRow, COL_单量)
                    lbl单量单位(0).Caption = .TextMatrix(lngRow, COL_单量单位)
                    lbl单量单位(1).Caption = .TextMatrix(lngRow, COL_单量单位)
                Else
                    SetItemEditable -1
                End If
            End If
            
            '天数：西药，中成药临嘱才使用，用于计算总量
            '一般：临嘱的药品(非中药)或可选择频率的计时,计量项目可以使用天数来自动计算总量
            blnEditableTmp = False
            If cbo期效.ListIndex = 1 And InStr(",5,6,", rsItem!类别) > 0 Then
                If mbln天数 And Val(.TextMatrix(lngRow, COL_频率性质)) <> 1 Then blnEditableTmp = True
            End If
            If blnEditableTmp Then
                SetDayState 1, 1
            Else
                SetDayState -1, -1
            End If
            txt天数.Text = Val(.TextMatrix(lngRow, COL_天数))
            If Val(txt天数.Text) = 0 Then txt天数.Text = ""
            
            '总量
            '--------------------
            If rsItem!类别 = "7" Then
                '中药配方(中草药)填写为付数
                If cbo期效.ListIndex = 1 Then
                    SetItemEditable , 1
                    bln显示单量 = True
                Else
                    SetItemEditable , -1 '配方长嘱不能输入总量，但兼容已输入的数据(新的为总量作总单量，固定为1付不用输入)
                End If
                lbl总量单位.Caption = "付"
                txt总量.Text = .TextMatrix(lngRow, COL_总量) '付数
                
            ElseIf cbo期效.ListIndex = 1 Then
                '临嘱都需要填写总量:临嘱发送以总量为准
                If rsItem!类别 = "Z" And NVL(rsItem!操作类型) <> "0" Then
                    SetItemEditable , -1 '特殊医嘱不允许修改总量(固定为1次)
                ElseIf InStr(",5,6,", rsItem!类别) = 0 And NVL(rsItem!计算方式, 0) = 3 _
                    And (NVL(rsItem!执行频率, 0) = 1 Or Val(.TextMatrix(lngRow, COL_频率性质)) = 1) Then
                    SetItemEditable , -1 '非药品一次性计次项目不输入总量(原始频率为一次性或当前设置为一次性)
                Else
                    SetItemEditable , 1
                    bln显示单量 = True
                End If
                lbl总量单位.Caption = .TextMatrix(lngRow, COL_总量单位)
                txt总量.Text = .TextMatrix(lngRow, COL_总量)
            Else
                '其它长嘱不允许填写总量
                SetItemEditable , -1
            End If
            
            '给药途径和中药用法
            '--------------
            If InStr(",5,6,", rsItem!类别) > 0 Then
                SetItemEditable , , 1
                lbl用法.Caption = "给药途径"
                '查找给药途径对应的行:查找的Rowdata(Variant)数据要转为Long型,才能精确匹配
                lng用法ID = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                lng用法ID = Val(.TextMatrix(lng用法ID, COL_诊疗项目ID))
                cmd用法.Tag = lng用法ID
                Set rsTmp = Get诊疗项目记录(lng用法ID)
                If rsTmp.RecordCount > 0 Then
                    txt用法.Text = rsTmp!名称 & ""
                    bln静脉营养 = Val(rsTmp!执行标记 & "") = 2
                End If
            ElseIf rsItem!类别 = "K" Then
                '输血医嘱：要兼容以前没有输血途径的情况
                lng用法ID = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_相关ID)
                If lng用法ID <> -1 Then
                    SetItemEditable , , 1
                    If Val(.TextMatrix(lngRow, COL_检查方法)) = 0 And gbln血库系统 = True Then
                        lbl用法.Caption = "采集方法"
                    Else
                        lbl用法.Caption = "输血途径"
                    End If
                    lng用法ID = Val(.TextMatrix(lng用法ID, COL_诊疗项目ID))
                    cmd用法.Tag = lng用法ID
                    txt用法.Text = Sys.RowValue("诊疗项目目录", lng用法ID, "名称")
                Else
                    SetItemEditable , , -1
                End If
            ElseIf rsItem!类别 = "7" Then
                SetItemEditable , , 1
                lbl用法.Caption = "中药用法"
                
                '中药配方显示行就是中药用法行
                lng用法ID = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
                cmd用法.Tag = lng用法ID
                txt用法.Text = Sys.RowValue("诊疗项目目录", lng用法ID, "名称")
                
            ElseIf RowIn检验行(lngRow) Then '不用类别判断,兼容以前的检验
                '检验组合
                SetItemEditable , , 1
                lbl用法.Caption = "采集方法"
                
                '检验组合显示行就是采集方法行
                lng用法ID = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
                cmd用法.Tag = lng用法ID
                txt用法.Text = Sys.RowValue("诊疗项目目录", lng用法ID, "名称")
                
            Else
                SetItemEditable , , -1
            End If
            
            '手术时间/输血时间：只有手术/输血可用(隐藏在用法位置)
            If rsItem!类别 = "F" Or rsItem!类别 = "K" Then
                SetItemEditable , , , , , , , , , , 1
                If IsDate(.TextMatrix(lngRow, COL_标本部位)) Or IsDate(.TextMatrix(lngRow, COL_手术时间)) And rsItem!类别 = "K" Then
                    txt安排时间.Text = .TextMatrix(lngRow, COL_手术时间)
                Else
                    txt安排时间.Text = .Cell(flexcpData, lngRow, COL_开始时间)
                End If
                Call Set安排时间(rsItem!类别)
                If rsItem!类别 = "F" Then
                    '手术显示手术情况
                    SetItemEditable , , , , , , , , , , , , , , , , 1
                    cbo手术情况.ListIndex = Cbo.FindIndex(cbo手术情况, Val(.TextMatrix(lngRow, COL_手术情况)))
                    If cbo手术情况.ListIndex = -1 Then cbo手术情况.ListIndex = 0
                Else
                    SetItemEditable , , , , , , , , , , , , , , , , -1
                End If
            Else
                SetItemEditable , , , , , , , , , , -1, , , , , , -1
            End If
            
           '频率(临嘱输入用于指导使用)，护理等级不允许改频率但护理常规允许
            If InStr("F,G,I", rsItem!类别) > 0 Or rsItem!类别 = "H" And rsItem!操作类型 = "1" Or rsItem!类别 = "Z" And InStr(",1,2,3,4,5,6,7,8,9,10,11,12,14,", "," & rsItem!操作类型 & ",") > 0 Then
                SetItemEditable , , , -1
            Else
                SetItemEditable , , , 1
            End If
            cmd频率.Tag = .TextMatrix(lngRow, COL_频率)
            txt频率.Text = .TextMatrix(lngRow, COL_频率)
               
            '执行时间："可选频率"或药品(当前未被设置为一次性)。非"分钟"间隔执行的
            If NVL(rsItem!执行频率, 0) = 0 And Val(.TextMatrix(lngBaseRow, COL_频率性质)) <> 1 And .TextMatrix(lngRow, COL_间隔单位) <> "分钟" And .TextMatrix(lngRow, COL_频率) <> "必要时" And .TextMatrix(lngRow, COL_频率) <> "需要时" Then
                SetItemEditable , , , , 1
                Call Get时间方案(cbo执行时间, Get频率范围(lngRow), .TextMatrix(lngRow, COL_频率), lng用法ID)
                
                If InStr(.TextMatrix(lngRow, COL_执行时间), ",") > 0 Then
                    cbo执行时间.Text = Split(.TextMatrix(lngRow, COL_执行时间), ",")(1)
                Else
                    cbo执行时间.Text = .TextMatrix(lngRow, COL_执行时间)
                End If
                
                '首日时间：按天、周频率的长期医嘱
                If cbo期效.ListIndex = 0 And Val(.TextMatrix(lngRow, COL_频率间隔)) = 1 _
                    And (.TextMatrix(lngRow, COL_间隔单位) = "周" Or .TextMatrix(lngRow, COL_间隔单位) = "天") Then
                    blnTemp = True
                    
                    '已固定的医嘱，有首日执行时间也显示
                    If Not blnTemp And InStr(",-1,1,2,", "," & Val(.TextMatrix(lngRow, COL_状态)) & ",") = 0 Then
                        If InStr(.TextMatrix(lngRow, COL_执行时间), ",") > 0 Then blnTemp = True
                    End If
                    
                    If blnTemp Then
                        SetItemEditable , , , , , , , , , , , , 1
                        If InStr(.TextMatrix(lngRow, COL_执行时间), ",") > 0 Then
                            txt首日时间.Text = Split(.TextMatrix(lngRow, COL_执行时间), ",")(0)
                        Else
                            txt首日时间.Text = ""
                        End If
                        lbl首日时间.Caption = Decode(.TextMatrix(lngRow, COL_间隔单位), "周", "↓首周", "↓首日")
                    Else
                        SetItemEditable , , , , , , , , , , , , -1
                    End If
                Else
                    SetItemEditable , , , , , , , , , , , , -1
                End If
            Else
                SetItemEditable , , , , -1
            End If
            '滴速：输液类给药途径的药品可以输入
            lbl滴速.Caption = "↓滴速"
            lbl滴速.Left = cmd开始时间.Left + cmd开始时间.Width + IIF(mbytSize = 0, 5, 10) * 180 '先设置滴速的初始位置
            bln用血 = .TextMatrix(lngRow, COL_类别) = "K" And Val(.TextMatrix(lngRow, COL_检查方法)) = 1 And gbln血库系统 = True
            If InStr(",5,6,", rsItem!类别) > 0 Or bln用血 Then
                If bln用血 = True Then
                    i = .FindRow(CLng(.RowData(lngRow)), , COL_相关ID)
                Else
                    i = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                End If
                If Val(.TextMatrix(i, COL_执行分类)) = 1 Then
                    SetItemEditable , , , , , , , , , , , 1
                    If bln用血 = False Then
                        If InStr(.TextMatrix(i, COL_医生嘱托), "滴/分钟") > 0 Then
                            lbl滴速单位.Caption = "滴/分钟"
                        ElseIf InStr(.TextMatrix(i, COL_医生嘱托), "毫升/小时") > 0 Then
                            lbl滴速单位.Caption = "毫升/小时"
                        End If
                    Else
                        If InStr(.TextMatrix(i, COL_医生嘱托), "滴/分") > 0 Or IsNumeric(.TextMatrix(i, COL_医生嘱托)) Or .TextMatrix(i, COL_医生嘱托) = "" Then
                            lbl滴速单位.Caption = "滴/分钟"
                        Else
                            lbl滴速单位.Caption = ""
                        End If
                    End If
                    Call Load输液滴速(cbo滴速, lbl滴速单位, False, bln用血)
                    cbo滴速.Text = Replace(.TextMatrix(i, COL_医生嘱托), lbl滴速单位.Caption, "")
                    
                Else
                    SetItemEditable , , , , , , , , , , , -1
                End If
                '设置位置
                If bln用血 = True Then
                    lbl滴速.Caption = "滴速"
                    lbl滴速.Left = txt安排时间.Left + txt安排时间.Width + 180
                End If
            Else
                SetItemEditable , , , , , , , , , , , -1
            End If
            If bln用血 = True And lbl滴速.Caption = "滴速" Then
                Call zlControl.SetPubCtrlPos(False, 0, lbl滴速, 30, cbo滴速, 30, lbl滴速单位, IIF(lbl滴速单位.Caption <> "", 0, Me.TextWidth("滴/分钟")) + 180, chk紧急)
            Else
                Call zlControl.SetPubCtrlPos(False, 0, lbl滴速, 30, cbo滴速, 30, lbl滴速单位, 180, chkStop, 180, chk紧急)
            End If
            '用药目的和用药理由
            If Val(.TextMatrix(lngRow, COL_抗菌等级)) = 0 Then
                SetItemEditable , , , , , , , , , , , , , -1, -1
            Else
                SetItemEditable , , , , , , , , , , , , , 1, 1
                bln显示抗菌药物 = True
                If .TextMatrix(lngRow, COL_用药目的) = "1" Then
                    Call Cbo.SetIndex(cboDruPur.hwnd, 1)
                ElseIf .TextMatrix(lngRow, COL_用药目的) = "2" Then
                    Call Cbo.SetIndex(cboDruPur.hwnd, 2)
                End If
                
                txt用药理由.Text = .TextMatrix(lngRow, COL_用药理由)
            End If
            cboDruPur.Enabled = blnEditable
            cmdReason.Enabled = blnEditable
            cmd收藏用药理由.Enabled = blnEditable
            
            '输血医嘱显示用药目的，将用药目的显示为输血原因
            If .TextMatrix(lngRow, COL_类别) = "K" Then
                bln显示抗菌药物 = True
                SetItemEditable , , , , , , , , , , , , , , , , , 1
                txt用药理由.Width = cbo医生嘱托.Left + cbo医生嘱托.Width - txt用药理由.Left
                SetItemEditable , , , , , , , , , , , , , , 1
                txt用药理由.Text = .TextMatrix(lngRow, COL_用药理由)
            Else
                SetItemEditable , , , , , , , , , , , , , , , , , -1
                txt用药理由.Width = cbo医生嘱托.Left + cbo医生嘱托.Width - txt用药理由.Left
            End If
            
              
            '医生嘱托
            cbo医生嘱托.Text = .TextMatrix(lngRow, COL_医生嘱托)
                    
            '终止时间：长嘱可以修改
            If cbo期效.ListIndex = 0 Then
                If rsItem!类别 = "H" And NVL(rsItem!操作类型, 0) = 1 Then
                    SetItemEditable , , , , , , -1 '护理等级为自动停止,不可指定
                Else
                    SetItemEditable , , , , , , 1
                End If
            Else
                SetItemEditable , , , , , , -1
            End If
            txt终止时间.Text = IIF(.TextMatrix(lngRow, COL_采集时间) = "", .Cell(flexcpData, lngRow, COL_终止时间), .TextMatrix(lngRow, COL_采集时间))
                    
            '执行性质:长嘱目前可以使用"自备药"
            If InStr(",5,6,7,", rsItem!类别) > 0 Then
                '如果是自管药则固定选择自备药
                If Val(.TextMatrix(lngRow, COL_临床自管药)) = 1 And InStr(",5,6,", rsItem!类别) > 0 Then
                    strTmp = "自备药"
                Else
                    If rsItem!类别 = "7" Then
                        '对于中药配方,根据诊疗项目管理中限制及本程序处理,不可能用法和煎法一个为院外执行,一个不为
                        If Val(.TextMatrix(lngBaseRow, COL_执行性质)) = 5 And Val(.TextMatrix(lngRow, COL_执行性质)) <> 5 Then
                            If Val(.TextMatrix(lngBaseRow, COL_执行标记)) = 2 Then
                                strTmp = "不取药"
                            Else
                                strTmp = "自备药"
                            End If
                        ElseIf Val(.TextMatrix(lngBaseRow, COL_执行性质)) <> 5 And Val(.TextMatrix(lngRow, COL_执行性质)) = 5 Then
                            strTmp = "离院带药"
                        Else
                            strTmp = IIF(Val(.TextMatrix(lngBaseRow, COL_执行标记)) = 0, "正常", "自取药")
                        End If
                    Else
                        i = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                        If Val(.TextMatrix(lngRow, COL_执行性质)) = 5 And Val(.TextMatrix(i, COL_执行性质)) <> 5 Then
                            If Val(.TextMatrix(lngRow, COL_执行标记)) = 2 Then
                                strTmp = "不取药"
                            Else
                                strTmp = "自备药"
                            End If
                        ElseIf Val(.TextMatrix(lngRow, COL_执行性质)) <> 5 And Val(.TextMatrix(i, COL_执行性质)) = 5 Then
                            strTmp = "离院带药"
                        Else
                            strTmp = IIF(Val(.TextMatrix(lngRow, COL_执行标记)) = 0, "正常", "自取药")
                        End If
                    End If
                End If
                Call SetCbo执行性质(cbo期效.ListIndex = 1, gbln抗菌药物使用自备药 Or Not gblnKSSStrict Or Val(.TextMatrix(lngRow, COL_抗菌等级)) = 0, Val(.TextMatrix(lngRow, COL_临床自管药)) = 1 And rsItem!类别 & "" <> "7")
                SetItemEditable , , , , , , , 1
                '如果是自管药则更新数据
                Call Cbo.SetIndex(cbo执行性质.hwnd, Cbo.FindIndex(cbo执行性质, strTmp, True))
            Else
                SetItemEditable , , , , , , , -1
            End If
                        
            lbl执行科室.Caption = "执行科室"
            '执行科室
            If rsItem!类别 = "Z" And NVL(rsItem!操作类型, 0) = 3 Then
                '转科医嘱用临床科室
                SetItemEditable , , , , , 1
                lbl执行科室.Caption = "转入科室"
                Call Get临床科室(2, mlng病人科室id, Val(.TextMatrix(lngRow, COL_执行科室ID)), cbo执行科室, True, False)
                If Val(.TextMatrix(lngRow, COL_执行科室ID)) <> 0 And cbo执行科室.ListIndex = -1 Then
                    .TextMatrix(lngRow, COL_执行科室ID) = 0
                    .TextMatrix(lngRow, COL_执行科室) = ""
                End If
                
                '门诊留观病人下入院医嘱
            ElseIf rsItem!类别 = "Z" And NVL(rsItem!操作类型, 0) = 2 And mlng病人性质 = 1 Then
                SetItemEditable , , , , , 1
                lbl执行科室.Caption = "入住科室"
                Call Get临床科室(2, mlng病人科室id, Val(.TextMatrix(lngRow, COL_执行科室ID)), cbo执行科室, True, False, True)
                If Val(.TextMatrix(lngRow, COL_执行科室ID)) <> 0 And cbo执行科室.ListIndex = -1 Then
                    .TextMatrix(lngRow, COL_执行科室ID) = 0
                    .TextMatrix(lngRow, COL_执行科室) = ""
                End If
            ElseIf rsItem!类别 = "Z" And NVL(rsItem!操作类型, 0) = 7 Then
                '会诊医嘱用临床科室
                SetItemEditable , , , , , 1
                lbl执行科室.Caption = "会诊科室"
                Y = mlng病人科室id
                If Val(.TextMatrix(lngRow, COL_申请序号)) > 0 Then
                    If .TextMatrix(lngRow, COL_附项) = "" Then
                        strTmp = Get病人医嘱附件(Val(.RowData(lngRow)))
                        .TextMatrix(lngRow, COL_附项) = strTmp
                    Else
                        strTmp = .TextMatrix(lngRow, COL_附项)
                    End If
                    If InStr(strTmp, "<Split2>院外") > 0 Then
                        Y = 0
                    End If
                End If
                Call Get临床科室(2, Y, Val(.TextMatrix(lngRow, COL_执行科室ID)), cbo执行科室, , False)
                If Val(.TextMatrix(lngRow, COL_执行科室ID)) <> 0 And cbo执行科室.ListIndex = -1 Then
                    .TextMatrix(lngRow, COL_执行科室ID) = 0
                    .TextMatrix(lngRow, COL_执行科室) = ""
                End If
            Else
                '是药品则以药品行为准显示,检验组合以检验项目为准显示
                i = lngRow
                If rsItem!类别 = "7" Then
                    i = lngBaseRow
                ElseIf RowIn检验行(lngRow) Then '不用类别判断,兼容以前的检验
                    i = lngBaseRow
                End If
                
                If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                    '非叮嘱和院外执行时才显示和可以选择(包括药品)
                    SetItemEditable , , , , , 1
                    If cbo滴速.Visible And gstr输液配置中心 <> "" And blnEditable Then
                        Call GetRowScope(lngRow, lngBegin, lngEnd)
                        For Y = lngBegin To lngEnd
                            If InStr(",5,6,", "," & .TextMatrix(Y, COL_类别) & ",") > 0 Then
                                If lngRow <> Y Then  '排除当前行
                                    If InStr("," & gstr输液配置中心 & ",", "," & Val(.TextMatrix(Y, COL_执行科室ID)) & ",") = 0 Then
                                        If mbln接收自备药 = False And Val(.TextMatrix(Y, COL_执行科室ID)) = 0 Then
                                            bln屏蔽输液中心 = True
                                        ElseIf Val(.TextMatrix(Y, COL_执行科室ID)) <> 0 Then
                                            bln屏蔽输液中心 = True
                                        End If
                                    End If
                                    If Val(.TextMatrix(Y, COL_执行性质)) <> 5 And Val(.TextMatrix(lngEnd, COL_执行性质)) = 5 And mbln接收自备药 = False Then
                                        bln屏蔽输液中心 = True
                                    End If
                                End If
                            End If
                        Next
                    End If
                    Call Get诊疗执行科室(mlng病人ID, mlng主页ID, cbo执行科室, rsItem!类别, rsItem!ID, lng药品ID, NVL(rsItem!执行科室, 0), _
                        mlng病人科室id, Val(.TextMatrix(i, COL_开嘱科室ID)), Val(.TextMatrix(i, COL_执行科室ID)), cbo期效.ListIndex, _
                        IIF(mlng病人性质 = 1, 1, 2), cbo滴速.Visible, blnEditable, bln屏蔽输液中心, lng用法ID, bln静脉营养, mlng病人病区ID, , mlng病人性质)
                    

                    '非散装形态，只允许在配方界面选药房
                    If rsItem!类别 = "7" Then
                        If Val(.TextMatrix(lngRow, COL_中药形态)) <> 0 Then
                            cbo执行科室.Enabled = False
                            cbo执行科室.BackColor = Me.BackColor
                        End If
                    End If
                ElseIf InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) > 0 Then
                    SetItemEditable , , , , , -1
                    If Val(.TextMatrix(i, COL_执行性质)) = 0 Then
                        cbo执行科室.AddItem "<无执行叮嘱>"
                    Else
                        cbo执行科室.AddItem "-"
                    End If
                    Call Cbo.SetIndex(cbo执行科室.hwnd, 0)
                End If
                If Val(.TextMatrix(i, COL_执行科室ID)) <> 0 And cbo执行科室.ListIndex = -1 Then
                    .TextMatrix(i, COL_执行科室ID) = 0
                    .TextMatrix(i, COL_执行科室) = ""
                End If
                If InStr("5,6,7", rsItem!类别) > 0 Then lbl执行科室.Caption = "发药药房"
            End If
            
            If cbo执行科室.ListIndex = -1 And cbo执行科室.ListCount = 1 Then
                If Val(.TextMatrix(i, COL_状态)) < 3 Then
                    cbo执行科室.ListIndex = 0
                Else
                    Call zlControl.CboSetIndex(cbo执行科室.hwnd, 0)
                End If
            End If
            
            If cbo执行科室.ListCount = 1 Then
                If cbo执行科室.List(cbo执行科室.ListIndex) <> "[其它...]" Then
                    cbo执行科室.Enabled = False
                Else
                    cbo执行科室.Enabled = True
                End If
            Else
                cbo执行科室.Enabled = True
            End If
            
            '附加执行:指给药途径,中药用法,手术麻醉,采集方式的执行科室
            lbl终止时间.Caption = "终止时间"
            If Should附加执行(lngRow, i, strTmp) Then
                If .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5" Then
                    '对于原液皮试加载药房
                    lng药品ID = Get原液皮试药品(Val(.TextMatrix(i, COL_诊疗项目ID)))
                    If lng药品ID <> 0 Then
                        SetItemEditable , , , , , , , , 1
                        Call Get诊疗执行科室(mlng病人ID, 0, cbo附加执行, "5", 0, lng药品ID, 0, mlng病人科室id, 0, Val(.TextMatrix(i, COL_用药理由)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , blnEditable, , , , , , mlng病人性质)
                        '如果没有选药房则不加载任何默认值
                        If Val(.TextMatrix(i, COL_用药理由)) = 0 Then cbo附加执行.ListIndex = -1
                    Else
                        cbo附加执行.Clear
                        SetItemEditable , , , , , , , , -1
                    End If
                Else
                    SetItemEditable , , , , , , , , 1
                    '采集执行允许录入采集时间
                    If strTmp = "采集执行" Then
                        SetItemEditable , , , , , , 1
                        lbl终止时间.Caption = "采集时间"
                    End If
                    Call Get诊疗执行科室(mlng病人ID, mlng主页ID, cbo附加执行, .TextMatrix(i, COL_类别), Val(.TextMatrix(i, COL_诊疗项目ID)), lng药品ID, _
                        Val(.TextMatrix(i, COL_执行性质)), mlng病人科室id, Val(.TextMatrix(i, COL_开嘱科室ID)), Val(.TextMatrix(i, COL_执行科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , blnEditable, , , , , , mlng病人性质)
                        
                    If Val(.TextMatrix(i, COL_执行科室ID)) <> 0 And cbo附加执行.ListIndex = -1 Then
                        .TextMatrix(i, COL_执行科室ID) = 0
                        .TextMatrix(i, COL_执行科室) = ""
                    End If
                    If cbo附加执行.ListIndex = -1 And cbo附加执行.ListCount = 1 Then cbo附加执行.ListIndex = 0
                End If
            Else
                SetItemEditable , , , , , , , , -1
                If i <> -1 Then
                    If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) > 0 Then
                        If Val(.TextMatrix(i, COL_执行性质)) = 0 Then
                            cbo附加执行.AddItem "<无执行叮嘱>"
                        ElseIf Val(.TextMatrix(i, COL_执行性质)) = 5 Then
                            cbo附加执行.AddItem "-"
                        End If
                        Call Cbo.SetIndex(cbo附加执行.hwnd, 0)
                    End If
                End If
            End If
            lbl附加执行.Caption = strTmp
            
            '紧急标志
            If Val(.TextMatrix(lngRow, COL_标志)) <> 2 Then
                chk紧急.Visible = True
                mblnDoCheck = False
                chk紧急.value = Val(.TextMatrix(lngRow, COL_标志))
                mblnDoCheck = True
            Else
                chk紧急.Visible = False
            End If
            
            '手术或术前医嘱
            mblnDoCheck = False
            If (.TextMatrix(lngRow, COL_类别) = "Z" And .TextMatrix(lngRow, COL_操作类型) = "14" Or .TextMatrix(lngRow, COL_类别) = "F") And Val("" & .TextMatrix(lngRow, COL_执行标记)) <> -1 Then
                chkStop.Visible = True
                chkStop.value = Val("" & .TextMatrix(lngRow, COL_执行标记))
            Else
                chkStop.Visible = False
                chkStop.value = 0
            End If
            mblnDoCheck = True
            
            '开嘱医生
            If .TextMatrix(lngRow, COL_开嘱医生) Like "*/*" Then
                cbo医生.Clear: cbo医生.Locked = True
                cbo医生.AddItem .TextMatrix(lngRow, COL_开嘱医生)
                Call Cbo.SetIndex(cbo医生.hwnd, cbo医生.NewIndex)
            Else
                cbo医生.Locked = mint场合 <> 1
                If mint场合 = 1 Then
                    '加入当前医生:不清除历史选择
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, .TextMatrix(lngRow, COL_开嘱医生), 0, cbo医生, IIF(mlng病人性质 = 1, 1, 2), True)
                Else
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, .TextMatrix(lngRow, COL_开嘱医生), 0, cbo医生)
                End If
            End If
            '医生下达医嘱时不允许选择开嘱医生
            If cbo医生.ListCount = 1 Or mint场合 <> 1 Then
                cbo医生.Enabled = False
            Else
                cbo医生.Enabled = True
            End If
            
            '开嘱时间
            txt开嘱时间.Text = .Cell(flexcpData, lngRow, COL_开嘱时间)
                    
            '显示药品库存：以住院单位，中药配方不显示
            '----------------------------------------
            If Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 _
                And (InStr(",5,6,", rsItem!类别) > 0 Or rsItem!类别 = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 1) Then
                If .TextMatrix(lngRow, COL_库存) = "" And Val(.TextMatrix(lngRow, COL_执行科室ID)) <> 0 Then Call GetDrugStock(lngRow)
                If .TextMatrix(lngRow, COL_库存) <> "" And Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then .TextMatrix(lngRow, COL_库存) = ""
                If .TextMatrix(lngRow, COL_库存) <> "" Then
                    If InStr(GetInsidePrivs(p住院医嘱下达), "显示药品库存") = 0 Then
                        stbThis.Panels(3).Text = IIF(Val(.TextMatrix(lngRow, COL_库存)) > 0, "有库存", "无库存")
                    Else
                        stbThis.Panels(3).Text = "库存:" & FormatEx(Val(.TextMatrix(lngRow, COL_库存)), 5) & .TextMatrix(lngRow, COL_住院单位)
                    End If
                Else
                    stbThis.Panels(3).Text = ""
                End If
            Else
                If rsItem!类别 = "7" And InStr(",1,2,-1,", .TextMatrix(lngRow, COL_状态)) > 0 Then
                    Call GetDrugStock(lngRow)
                End If
                stbThis.Panels(3).Text = ""
            End If
            
            '显示医嘱单价
            If .TextMatrix(lngRow, COL_单价) = "" Then '用""不是零
                .TextMatrix(lngRow, COL_单价) = GetItemPrice(lngRow)
            End If
            dblPrice = Val(.TextMatrix(lngRow, COL_单价))
            If dblPrice <> 0 Then
                If InStr(",4,5,6,", rsItem!类别) > 0 Then
                    stbThis.Panels(4).Text = "每" & .TextMatrix(lngRow, COL_住院单位) & ":" & FormatEx(dblPrice, 5) & "元"
                ElseIf rsItem!类别 = "7" Then
                    stbThis.Panels(4).Text = "每付:" & FormatEx(dblPrice, 5) & "元"
                Else
                    stbThis.Panels(4).Text = IIF(IsNull(rsItem!计算单位), "价格:", "每" & NVL(rsItem!计算单位) & ":") & FormatEx(dblPrice, 5) & "元"
                End If
            Else
                stbThis.Panels(4).Text = ""
            End If
            
            '显示费用类型
            strTmp = Get费用类型(lngRow)
            If strTmp <> "" Then
                stbThis.Panels(4).Text = stbThis.Panels(4).Text & IIF(stbThis.Panels(4).Text <> "", ",", "") & strTmp
            End If
    
            '路径生成时，如果是按品种定义的医嘱，自动弹出规格选择器
            If mbytUseType = 1 And mlng路径状态 = 1 Then
                If cmdSel.Visible And cmdSel.Enabled Then
                    If Val(.TextMatrix(lngRow, COL_收费细目ID)) = 0 And Val("" & .Cell(flexcpChecked, lngRow, COL_选择)) = 1 Then
                        Call cmdSel_Click
                    End If
                End If
                If .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "4" Then
                    lbl超量说明.Caption = "变异原因"
                    txt超量说明.BackColor = &H80000018
                    txt超量说明.Enabled = True
                    txt超量说明.Locked = True
                    txt超量说明.TabStop = False
                    cmdZYRemark.Visible = True
                    cmdExcReason.Visible = False
                    cmdComExcReason.Visible = False
                    If .Cell(flexcpData, lngRow, COL_超量说明) <> "" Then
                        cmdZYRemark.Enabled = True
                    Else
                        cmdZYRemark.Enabled = False
                    End If
                    txt超量说明.Width = cmdZYRemark.Width + cmdZYRemark.Left - txt超量说明.Left
                Else
                    lbl超量说明.Caption = "超量说明"
                    txt超量说明.TabStop = True
                    cmdZYRemark.Visible = False
                    cmdExcReason.Visible = True
                    cmdComExcReason.Visible = True
                    cmdExcReason.Enabled = txt超量说明.Enabled
                    cmdComExcReason.Enabled = txt超量说明.Enabled
                    txt超量说明.Width = cbo医生嘱托.Width + cbo医生嘱托.Left - txt超量说明.Left
                End If
            End If
            
            '待审核的用血医嘱，则不允许:输血成分、执行科室、预定输血量
            If .TextMatrix(lngRow, COL_类别) = "K" And Val(.TextMatrix(lngRow, COL_检查方法)) = 1 And gbln血库系统 = True And blnEditable Then
                If InitObjBlood = True Then
                    If gobjPublicBlood.GetPrepareBloodRs(Val(.RowData(lngRow)), rsTmp) = True Then
                        If Val(rsTmp!记录性质 & "") = 2 And Val(rsTmp!记录状态 & "") = 1 Then
                            cmdSel.Enabled = False
                            txt医嘱内容.Enabled = False
                            txt总量.Enabled = False
                            cbo执行科室.Enabled = False
                        End If
                    End If
                End If
            End If
        End If
    End With
    
    '清除编辑标志
    Call ClearItemTag
    
    '显示计价窗体
    Call ShowPrice(lngRow)
    
    If mbytUseType = 3 Then '调整时，不允许修改医嘱的任何项目
        SetCardEditable (False)
    End If
    
    '调用外挂接口
    Call CreatePlugInOK(p住院医嘱下达, mint场合)
    If Not gobjPlugIn Is Nothing Then
        If OldRow <> NewRow Then
            Call zlPluginAdviceRowChange(NewRow)
            With vsAdvice
                If OldRow <> -1 Then
                    If Val(.RowData(OldRow)) <> 0 Then
                        If Val(.TextMatrix(OldRow, COL_EDIT)) = 1 Or Val(.TextMatrix(OldRow, COL_EDIT)) = 2 Then
                            If mbytUseType = 0 Or mbytUseType = 2 Then Call zlPluginAdviceRowChange(OldRow, 1)
                        End If
                    End If
                End If
            End With
        End If
    End If
    
    '显示或隐藏药品相关的两行项目
    Call SetMediInfoItem(bln显示单量, bln显示抗菌药物)
    cbsMain.RecalcLayout '即时刷新,有Lock可不要
    zlControl.FormLock 0
    Exit Sub
errH:
    zlControl.FormLock 0
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub ShowPrice(ByVal lngRow As Long)
'根据当前行的情况显示计价窗体
    If mblnModal Then Exit Sub
    
    If vsAdvice.RowData(lngRow) = 0 Or Val(vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID)) = 0 Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf InStr(",1,2,-1,", Val(vsAdvice.TextMatrix(lngRow, COL_状态))) = 0 Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf InStr(",4,5,6,", vsAdvice.TextMatrix(lngRow, COL_类别)) > 0 Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf RowIn配方行(lngRow) Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf stbThis.Panels("Price").Bevel = sbrNoBevel Then
        stbThis.Panels("Price").Visible = True
        If Val(stbThis.Panels("Price").Tag) <> 0 Then
            stbThis.Panels("Price").Bevel = sbrInset
        Else
            stbThis.Panels("Price").Bevel = sbrRaised
        End If
    End If
    
    If stbThis.Panels("Price").Bevel <> sbrInset Then
        '关闭计价窗体
        mfrmPrice.HideMe
    Else
        Call mfrmPrice.ShowMe(Me, vsAdvice, mlng病人ID, mlng主页ID, mlng病人科室id, mlng病人性质, mint险类, _
            COL_序号 & "," & COL_相关ID & "," & COL_状态 & "," & COL_类别 & "," & COL_诊疗项目ID & "," & _
            COL_收费细目ID & "," & COL_标本部位 & "," & COL_检查方法 & "," & COL_执行标记 & "," & COL_计价性质 & "," & COL_执行性质 & "," & COL_执行科室ID)
    End If
End Sub

Private Function Get费用类型(ByVal lngRow As Long) As String
'功能：获取指定行的费用类型
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, str类型 As String, str大类 As String, lng收费细目ID As Long
        
    lng收费细目ID = Val(vsAdvice.TextMatrix(lngRow, COL_收费细目ID))
    If lng收费细目ID <> 0 Then
        '取医保的费用类型
        If mint险类 <> 0 Then
            str类型 = gclsInsure.GetItemInsure(mlng病人ID, lng收费细目ID, 0, False, mint险类)
            If str类型 <> "" Then
                If UBound(Split(str类型, ";")) >= 5 Then
                    str类型 = Split(str类型, ";")(5)
                Else
                    str类型 = ""
                End If
            End If
        End If
        '没有则取HIS的费用类型
        strSQL = "Select A.费用类型,N.名称 as 医保大类 From 收费项目目录 A,保险支付项目 M,保险支付大类 N" & _
            " Where A.ID=[1] And A.ID=M.收费细目ID(+) And M.大类ID=N.ID(+) And M.险类(+)=[2]"
        On Error GoTo errH
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng收费细目ID, mint险类)
        If Not rsTmp.EOF Then
            If str类型 = "" Then str类型 = NVL(rsTmp!费用类型)
            str大类 = NVL(rsTmp!医保大类)
        End If
    End If
  
    Get费用类型 = Mid(IIF(str类型 <> "", ",类型:" & str类型, "") & IIF(str大类 <> "", ",大类:" & str大类, ""), 2)
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function Should附加执行(ByVal lngRow As Long, lngRow2 As Long, str执行科室 As String) As Boolean
'功能：判断指定的医嘱行(可见行)是否可以设置附加的执行科室
'参数：lngRow2=返回附加行的医嘱行号
'      str执行科室=附加执行科室类型
    Dim i As Long
    
    lngRow2 = -1
    str执行科室 = "附加执行"
    With vsAdvice
        If lngRow = 0 Or .RowData(lngRow) = 0 Then Exit Function

        If RowIn配方行(lngRow) Then
            '中药用法
            lngRow2 = lngRow
            str执行科室 = "用法执行"
            Should附加执行 = True
        ElseIf InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            '给药途径
            lngRow2 = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
            str执行科室 = "给药执行"
            Should附加执行 = True
        ElseIf .TextMatrix(lngRow, COL_类别) = "F" Then
            '手术麻醉
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "G" Then
                        lngRow2 = i: Exit For
                    End If
                Else
                    Exit For
                End If
            Next
            str执行科室 = "麻醉执行"
            If lngRow2 <> -1 Then Should附加执行 = True
        ElseIf .TextMatrix(lngRow, COL_类别) = "K" Then
            '输血途径
            If Val(.TextMatrix(lngRow, COL_检查方法)) = 0 And gbln血库系统 = True Then
                str执行科室 = "采集执行"
            Else
                str执行科室 = "输血执行"
            End If
            lngRow2 = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_相关ID)
            If lngRow2 <> -1 Then Should附加执行 = True
        ElseIf .TextMatrix(lngRow, COL_类别) = "E" _
            And .TextMatrix(lngRow - 1, COL_类别) = "C" _
            And Val(.TextMatrix(lngRow - 1, COL_相关ID)) = .RowData(lngRow) Then
            '采集方式
            lngRow2 = lngRow
            str执行科室 = "采集执行"
            Should附加执行 = True
        ElseIf .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5" Then
            '原液皮试药房
            lngRow2 = lngRow
            str执行科室 = "原液药房"
            Should附加执行 = True
        End If
        
        '叮嘱或院外执行
        If Should附加执行 Then
            If InStr(",0,5,", Val(.TextMatrix(lngRow2, COL_执行性质))) > 0 Then
                Should附加执行 = False
            End If
        End If
    End With
End Function

Private Function GetItemPrice(ByVal lngRow As Long) As Double
'功能：获取当前医嘱行的价格(药品为一个药房包装的单价,其它根据收费对照)
'说明：药品不包含给药途径及中药用法煎法
    Dim rsTmp As New ADODB.Recordset
    Dim str医嘱IDs As String, str单量s As String
    Dim str项目IDs As String, str医嘱 As String, str诊疗收费 As String, str项目科室 As String, strTmp As String
    Dim strAdviceIDs As String, lng执行科室ID As Long
    Dim dblPrice As Double, dbl数量 As Double
    Dim bln药品 As Boolean, strSQL As String
    Dim str管码项目 As String, i As Long
    
    With vsAdvice
        bln药品 = True
        If InStr(",4,5,6,", .TextMatrix(lngRow, COL_类别)) > 0 And Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
            '西药及中成药按规格下才能计算价格
            If Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
                str项目IDs = str项目IDs & "," & Val(.TextMatrix(lngRow, COL_收费细目ID))
            End If
            lng执行科室ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
        ElseIf RowIn配方行(lngRow) Then
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "7" And Val(.TextMatrix(i, COL_收费细目ID)) <> 0 Then
                        If lng执行科室ID = 0 Then
                            lng执行科室ID = Val(.TextMatrix(i, COL_执行科室ID))
                        End If
                        str项目IDs = str项目IDs & "," & Val(.TextMatrix(i, COL_收费细目ID))
                        str单量s = str单量s & ";" & Val(.TextMatrix(i, COL_单量))
                    End If
                Else
                    Exit For
                End If
            Next
        Else
            bln药品 = False
            '其它医嘱,未校对(计价)的按收费对照计算,否则直接取医嘱计价
            '不包含不计价和手工计价的项目,不包含叮嘱和院外执行的项目
            If Val(.TextMatrix(lngRow, COL_计价性质)) = 0 And InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                If InStr(",1,2,-1,", .TextMatrix(lngRow, COL_状态)) > 0 Then
                    str管码项目 = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
                    If RowIn检验行(lngRow) Then
                        i = .FindRow(CStr(.RowData(lngRow)), .FixedRows, COL_相关ID)
                        If i <> -1 Then
                            str管码项目 = Val(.TextMatrix(i, COL_诊疗项目ID))
                        End If
                    End If
                    
                    str项目科室 = str项目科室 & "," & Val(.TextMatrix(lngRow, COL_诊疗项目ID)) & ":" & Val(.TextMatrix(lngRow, COL_执行科室ID))
                    
                    str医嘱 = str医嘱 & " Union ALL Select " & _
                        IIF(Val(.TextMatrix(lngRow, COL_相关ID)) = 0, "-NULL", Val(.TextMatrix(lngRow, COL_相关ID))) & " as 相关ID," & _
                        Val(.TextMatrix(lngRow, COL_诊疗项目ID)) & " as 诊疗项目ID," & Val(.TextMatrix(lngRow, COL_执行标记)) & " as 执行标记," & _
                        IIF(.TextMatrix(lngRow, COL_标本部位) = "", "NULL", "'" & .TextMatrix(lngRow, COL_标本部位) & "'") & " as 标本部位," & _
                        IIF(.TextMatrix(lngRow, COL_检查方法) = "", "NULL", "'" & .TextMatrix(lngRow, COL_检查方法) & "'") & " as 检查方法," & _
                        str管码项目 & " as 管码项目ID From Dual"
                Else
                    str医嘱IDs = str医嘱IDs & "," & .RowData(lngRow)
                End If
            End If
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If Val(.TextMatrix(i, COL_计价性质)) = 0 And InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                        If InStr(",1,2,-1,", .TextMatrix(i, COL_状态)) > 0 Then
                            strTmp = Val(.TextMatrix(i, COL_诊疗项目ID)) & ":" & Val(.TextMatrix(i, COL_执行科室ID))
                            If InStr("," & str项目科室 & ",", "," & strTmp & ",") = 0 Then str项目科室 = str项目科室 & "," & strTmp
                            
                            str医嘱 = str医嘱 & " Union ALL Select " & _
                                IIF(Val(.TextMatrix(i, COL_相关ID)) = 0, "-NULL", Val(.TextMatrix(i, COL_相关ID))) & " as 相关ID," & _
                                Val(.TextMatrix(i, COL_诊疗项目ID)) & " as 诊疗项目ID," & Val(.TextMatrix(i, COL_执行标记)) & " as 执行标记," & _
                                IIF(.TextMatrix(i, COL_标本部位) = "", "NULL", "'" & .TextMatrix(i, COL_标本部位) & "'") & " as 标本部位," & _
                                IIF(.TextMatrix(i, COL_检查方法) = "", "NULL", "'" & .TextMatrix(i, COL_检查方法) & "'") & " as 检查方法," & _
                                Val(.TextMatrix(i, COL_诊疗项目ID)) & " as 管码项目ID From Dual"
                        Else
                            str医嘱IDs = str医嘱IDs & "," & .RowData(i)
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
            For i = lngRow - 1 To .FixedRows Step -1 '检验组合
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If Val(.TextMatrix(i, COL_计价性质)) = 0 And InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                        If InStr(",1,2,-1,", .TextMatrix(i, COL_状态)) > 0 Then
                            strTmp = Val(.TextMatrix(i, COL_诊疗项目ID)) & ":" & Val(.TextMatrix(i, COL_执行科室ID))
                            If InStr("," & str项目科室 & ",", "," & strTmp & ",") = 0 Then str项目科室 = str项目科室 & "," & strTmp
                            
                            str医嘱 = str医嘱 & " Union ALL Select " & _
                                IIF(Val(.TextMatrix(i, COL_相关ID)) = 0, "-NULL", Val(.TextMatrix(i, COL_相关ID))) & " as 相关ID," & _
                                Val(.TextMatrix(i, COL_诊疗项目ID)) & " as 诊疗项目ID," & Val(.TextMatrix(i, COL_执行标记)) & " as 执行标记," & _
                                IIF(.TextMatrix(i, COL_标本部位) = "", "NULL", "'" & .TextMatrix(i, COL_标本部位) & "'") & " as 标本部位," & _
                                IIF(.TextMatrix(i, COL_检查方法) = "", "NULL", "'" & .TextMatrix(i, COL_检查方法) & "'") & " as 检查方法," & _
                                Val(.TextMatrix(i, COL_诊疗项目ID)) & " as 管码项目ID From Dual"
                        Else
                            str医嘱IDs = str医嘱IDs & "," & .RowData(i)
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
        End If
    End With
    str医嘱IDs = Mid(str医嘱IDs, 2)
    str单量s = Mid(str单量s, 2)
    str项目IDs = Mid(str项目IDs, 2)
    str项目科室 = Mid(str项目科室, 2)
    str医嘱 = Mid(str医嘱, 12)
    
    On Error GoTo errH
    
    If bln药品 Then
        If str项目IDs = "" Then Exit Function
    
        strSQL = "Select Rownum As 序号,Column_Value As ID From Table(f_Num2list([1]))"
        strSQL = "Select /*+ RULE */ A.ID,A.类别,A.是否变价,D.跟踪在用,Nvl(B.住院包装,1) as 住院包装,Nvl(B.剂量系数,1) as 剂量系数,B.住院可否分零 As 可否分零" & _
            " From 收费项目目录 A,药品规格 B,材料特性 D,(" & strSQL & ") C" & _
            " Where A.ID=B.药品ID(+) And A.ID=D.材料ID(+) And A.ID=C.ID Order By C.序号"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str项目IDs)
        For i = 1 To rsTmp.RecordCount
            '售价数量
            If str单量s <> "" Then '中药配方才管每味剂量
                dbl数量 = Val(Split(str单量s, ";")(i - 1))
                
                '售价数量：中药药房单位按不可分零处理:每付
                If NVL(rsTmp!可否分零, 0) = 0 Then
                    dbl数量 = Format(dbl数量 / NVL(rsTmp!剂量系数, 1), "0.00000")
                Else
                    dbl数量 = Format(IntEx(dbl数量 / NVL(rsTmp!剂量系数, 1) / NVL(rsTmp!住院包装, 1)) * NVL(rsTmp!住院包装, 1), "0.00000")
                End If
            Else
                dbl数量 = NVL(rsTmp!住院包装, 1) '1个药房单位的售价数量
            End If
            If NVL(rsTmp!是否变价, 0) = 1 And (rsTmp!类别 = "4" And NVL(rsTmp!跟踪在用, 0) = 1 Or InStr(",5,6,7,", rsTmp!类别) > 0) Then
                dblPrice = dblPrice + Format(Format(CalcDrugPrice(rsTmp!ID, lng执行科室ID, dbl数量, , , , mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级), "0.00000") * dbl数量, "0.00000")
            Else
                dblPrice = dblPrice + Format(Format(CalcPrice(rsTmp!ID, , , , , , mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级), "0.00000") * dbl数量, "0.00000")
            End If
            
            rsTmp.MoveNext
        Next
    Else
        If str医嘱 = "" And str医嘱IDs = "" Then Exit Function
    
        If str医嘱IDs <> "" Then
            strSQL = _
                " Select /*+ RULE */ B.数量,Decode(C.是否变价,1,B.单价,Sum(D.现价)) as 单价" & _
                " From 病人医嘱计价 B,收费项目目录 C,收费价目 D" & _
                " Where B.收费细目ID=C.ID And B.收费细目ID=D.收费细目ID" & _
                GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "4", "5", "6") & _
                " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))" & _
                " And B.医嘱ID IN(Select Column_Value From Table(f_Num2list([1])))" & _
                " Group by B.数量,C.是否变价,B.单价"
        End If
        If str医嘱 <> "" Then
            '由于没有加部位等条件，所以要用Distinct
            str诊疗收费 = "Select * From (" & _
                "Select Distinct C.诊疗项目ID,C.收费项目ID,C.检查部位,C.检查方法,C.费用性质,C.收费数量,C.固有对照,C.从属项目,C.收费方式,C.适用科室id" & _
                " ,Max(Nvl(c.适用科室id, 0)) Over(Partition By c.诊疗项目id, c.检查部位, c.检查方法, c.费用性质) As Top" & _
                " From 诊疗收费关系 C,Table(f_Num2list2([2])) D Where C.诊疗项目ID=D.c1" & _
                "      And (C.适用科室ID is Null or C.适用科室ID = Nvl(D.c2,[3]) And C.病人来源 = " & IIF(mlng病人性质 = 1, 1, 2) & ")" & _
                " ) Where Nvl(适用科室id, 0) = Top"
        
            strSQL = IIF(strSQL = "", "", strSQL & " Union ALL") & _
                " Select " & IIF(strSQL = "", "/*+ RULE */", "") & "B.收费数量 as 数量,Decode(C.是否变价,1,Sum(D.缺省价格),Sum(D.现价)) as 单价" & _
                " From (" & str医嘱 & ") A,(" & str诊疗收费 & ") B,收费项目目录 C,收费价目 D,诊疗项目目录 E,采血管类型 F" & _
                " Where A.诊疗项目ID=B.诊疗项目ID And B.收费项目ID=C.ID And B.收费项目ID=D.收费细目ID" & _
                " And (C.站点='" & gstrNodeNo & "' Or C.站点 is Null) And A.管码项目ID=E.ID And E.试管编码=F.编码(+)" & _
                " And (Nvl(B.收费方式,0)=1 And C.类别='4' And B.收费项目ID=F.材料ID Or Not(Nvl(B.收费方式,0)=1 And C.类别='4' And F.材料ID Is Not NULL))" & _
                " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))" & _
                GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "4", "5", "6") & _
                " And (A.相关ID is Null And A.执行标记 IN(1,2) And B.费用性质=1" & _
                "       Or A.标本部位=B.检查部位 And A.检查方法=B.检查方法 And Nvl(B.费用性质,0)=0" & _
                "       Or (A.检查方法 is Null Or e.类别 = 'E' And e.操作类型='4') And Nvl(B.费用性质,0)=0 And B.检查部位 is Null And B.检查方法 is Null)" & _
                " Group by B.收费数量,C.是否变价"
        End If
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Name, str医嘱IDs, str项目科室, mlng病人病区ID, mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级)
        For i = 1 To rsTmp.RecordCount
            dblPrice = dblPrice + Format(NVL(rsTmp!数量, 0) * NVL(rsTmp!单价, 0), "0.00000")
            rsTmp.MoveNext
        Next
    End If
    
    GetItemPrice = Format(dblPrice, gstrDecPrice)
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function MakePriceRecord(ByVal lngRow As Long) As Boolean
'功能：根据当前新开医嘱行内容，生成对应的用于医保的费用明细记录集
'参数：lngRow=当前医嘱行
'返回：有计价数据记录集内容才返回True
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, strAdvice As String, str项目科室 As String, str诊疗收费 As String
    Dim lngBegin As Long, lngEnd As Long
    Dim lng执行科室ID As Long, blnLoad As Boolean
    Dim dbl单价 As Double, dbl金额 As Double, dbl实收 As Double
    Dim str管码项目 As String, i As Long
    Dim str项目 As String, blnDo As Boolean
    
    On Error GoTo errH
        
    With vsAdvice
        If .RowData(lngRow) = 0 Or Val(.TextMatrix(lngRow, COL_诊疗项目ID)) = 0 Then Exit Function
        
        If RowIn检验行(lngRow) Then
            i = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
            If i <> -1 Then str管码项目 = Val(.TextMatrix(i, COL_诊疗项目ID))
        End If
        
        '生成病人医嘱记录临时表
        Call GetRowScope(lngRow, lngBegin, lngEnd)
        For i = lngBegin To lngEnd
            If Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                str项目科室 = str项目科室 & "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & ":" & Val(.TextMatrix(i, COL_执行科室ID))
                
                strAdvice = strAdvice & " Union ALL " & _
                    "Select " & .RowData(i) & " as ID," & Val(.TextMatrix(i, COL_序号)) & " as 序号," & _
                    ZVal(.TextMatrix(i, COL_相关ID), True) & " as 相关ID,'" & .TextMatrix(i, COL_类别) & "' as 诊疗类别," & _
                    IIF(str管码项目 = "", Val(.TextMatrix(i, COL_诊疗项目ID)), str管码项目) & " as 管码项目ID," & _
                    Val(.TextMatrix(i, COL_诊疗项目ID)) & " as 诊疗项目ID," & ZVal(.TextMatrix(i, COL_收费细目ID), True) & " as 收费细目ID," & _
                    Val(.TextMatrix(i, COL_总量)) & " as 总量," & Val(.TextMatrix(i, COL_单量)) & " as 单量," & _
                    "'" & .TextMatrix(i, COL_标本部位) & "' as 标本部位,'" & .TextMatrix(i, COL_检查方法) & "' as 检查方法," & _
                    Val(.TextMatrix(i, COL_执行标记)) & " as 执行标记," & Val(.TextMatrix(i, COL_计价性质)) & " as 计价特性," & _
                    IIF(.TextMatrix(i, COL_类别) = "F" And Val(.TextMatrix(i, COL_相关ID)) <> 0, 1, 0) & " as 附加手术," & _
                    Val(.TextMatrix(i, COL_执行性质)) & " as 执行性质," & ZVal(.TextMatrix(i, COL_执行科室ID), True) & " as 执行科室ID From Dual"
            End If
        Next
        strAdvice = Mid(strAdvice, 12)
        str项目科室 = Mid(str项目科室, 2)
    End With
    
    blnLoad = True
    
    '药品、卫材的计价：按售价数量、单价计算
    If vsAdvice.TextMatrix(lngRow, COL_类别) = "4" Then
        '卫材：固定按规格下达
        strSQL = "Select A.序号,A.诊疗类别,C.类别 as 收费类别,A.收费细目ID,D.收入项目ID," & _
            " Decode(A.总量,0,1,A.总量) as 数量,Decode(Nvl(C.是否变价,0),1,D.缺省价格,D.现价) as 单价," & _
            " C.是否变价,C.屏蔽费别,B.跟踪在用,A.执行科室ID,A.附加手术,D.附术收费率" & _
            " From (" & strAdvice & ") A,材料特性 B,收费项目目录 C,收费价目 D" & _
            " Where A.ID=[1] And Nvl(A.执行性质,0)<>5 And A.收费细目ID=B.材料ID" & _
            " And A.收费细目ID=C.ID And C.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3) And D.收费细目ID=C.ID" & _
            GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "5", "6", "7") & _
            " And (C.撤档时间 is NULL Or C.撤档时间=To_Date('3000-01-01','YYYY-MM-DD'))" & _
            " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))"
        blnLoad = False
    ElseIf InStr(",5,6,", vsAdvice.TextMatrix(lngRow, COL_类别)) > 0 Then
        '中,西成药:可能按规格下医嘱,计算1个药房包装的单价
        strSQL = "Select A.序号,A.诊疗类别,C.类别 as 收费类别,C.ID as 收费细目ID,D.收入项目ID," & _
            " Decode(A.总量,0,1,A.总量)/Decode(2,1,B.门诊包装,B.住院包装) as 数量," & _
            " Decode(Nvl(C.是否变价,0),1,-NULL,D.现价) as 单价,C.是否变价,C.屏蔽费别," & _
            " 0 as 跟踪在用,A.执行科室ID,A.附加手术,D.附术收费率" & _
            " From (" & strAdvice & ") A,药品规格 B,收费项目目录 C,收费价目 D" & _
            " Where A.ID=[1] And Nvl(A.执行性质,0)<>5 And A.收费细目ID=B.药品ID" & _
            " And B.药品ID=C.ID And C.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3) And D.收费细目ID=C.ID" & _
            GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "5", "6", "7") & _
            " And (C.撤档时间 is NULL Or C.撤档时间=To_Date('3000-01-01','YYYY-MM-DD'))" & _
            " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))"
            
        '仅一并给药(如果是)的第一成药行才显示给药途径的计价
        blnLoad = Val(vsAdvice.TextMatrix(lngRow - 1, COL_相关ID)) <> Val(vsAdvice.TextMatrix(lngRow, COL_相关ID))
    ElseIf RowIn配方行(lngRow) Then
        '中草药:一定对应有规格记录且填写了收费细目ID
        strSQL = "Select A.序号,A.诊疗类别,C.类别 as 收费类别,C.ID as 收费细目ID,D.收入项目ID," & _
            " Decode(A.总量,0,1,A.总量)*A.单量/Nvl(B.剂量系数,1) as 数量," & _
            " Decode(Nvl(C.是否变价,0),1,-NULL,D.现价) as 单价,C.是否变价,C.屏蔽费别," & _
            " 0 as 跟踪在用,A.执行科室ID,A.附加手术,D.附术收费率" & _
            " From (" & strAdvice & ") A,药品规格 B,收费项目目录 C,收费价目 D" & _
            " Where A.诊疗类别='7' And A.相关ID=[1] And A.收费细目ID=B.药品ID And A.收费细目ID=C.ID" & _
            GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "5", "6", "7") & _
            " And C.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3) And D.收费细目ID=C.ID And Nvl(A.执行性质,0)<>5" & _
            " And (C.撤档时间 is NULL Or C.撤档时间=To_Date('3000-01-01','YYYY-MM-DD'))" & _
            " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))"
    End If
    
    '读取计价关系：除药品、卫材医嘱外的计价,包含相关医嘱计价；不计价,手工计价的医嘱不读取
    If blnLoad Then
        '由于没有加部位等条件，所以要用Distinct
        str诊疗收费 = "Select * From (" & _
                "Select Distinct C.诊疗项目ID,C.收费项目ID,C.检查部位,C.检查方法,C.费用性质,C.收费数量,C.固有对照,C.从属项目,C.收费方式,C.适用科室id" & _
                " ,Max(Nvl(c.适用科室id, 0)) Over(Partition By c.诊疗项目id, c.检查部位, c.检查方法, c.费用性质) As Top" & _
                " From 诊疗收费关系 C,Table(f_Num2list2([3])) D Where C.诊疗项目ID=D.c1" & _
                "      And (C.适用科室ID is Null or C.适用科室ID = Nvl(D.c2,[4]) And C.病人来源 = " & IIF(mlng病人性质 = 1, "1,2", 2) & ")" & _
                " ) Where Nvl(适用科室id, 0) = Top"
    
        strSQL = strSQL & IIF(strSQL = "", "", " Union ALL") & _
            " Select A.序号,A.诊疗类别,C.类别 as 收费类别,B.收费项目ID as 收费细目ID,D.收入项目ID," & _
            " Decode(A.总量,0,1,A.总量)*B.收费数量 as 数量,Decode(C.是否变价,1,D.缺省价格,D.现价) as 单价," & _
            " C.是否变价,C.屏蔽费别,0 as 跟踪在用,A.执行科室ID,A.附加手术,D.附术收费率" & _
            " From (" & strAdvice & ") A,(" & str诊疗收费 & ") B,收费项目目录 C,收费价目 D,诊疗项目目录 E,采血管类型 F" & _
            " Where A.诊疗类别 Not IN('4','5','6','7') And A.诊疗项目ID=B.诊疗项目ID" & _
            GetPriceGradeSQL(mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级, "C", "D", "5", "6", "7") & _
            " And (A.相关ID is Null And A.执行标记 IN(1,2) And B.费用性质=1" & _
            "       Or A.标本部位=B.检查部位 And A.检查方法=B.检查方法 And Nvl(B.费用性质,0)=0" & _
            "       Or (A.检查方法 is Null Or e.类别 = 'E' And e.操作类型='4') And Nvl(B.费用性质,0)=0 And B.检查部位 is Null And B.检查方法 is Null)" & _
            " And A.管码项目ID=E.ID And E.试管编码=F.编码(+)" & _
            "   And (Nvl(B.收费方式,0)=1 And C.类别='4' And B.收费项目ID=F.材料ID" & _
            "       Or Not(Nvl(B.收费方式,0)=1 And C.类别='4' And F.材料ID Is Not NULL))" & _
            " And Nvl(A.计价特性,0)=0 And Nvl(A.执行性质,0) Not IN(0,5) And B.收费项目ID=C.ID And B.收费项目ID=D.收费细目ID" & _
            " And ((Sysdate Between D.执行日期 and D.终止日期) or (Sysdate>=D.执行日期 And D.终止日期 is NULL))" & _
            " And (C.撤档时间 is NULL Or C.撤档时间=To_Date('3000-01-01','YYYY-MM-DD')) And C.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3)" & _
            " And (C.站点='" & gstrNodeNo & "' Or C.站点 is Null) And (A.ID=[1] Or A.ID=[2] Or A.相关ID=[1])"
    End If
    
    strSQL = "Select /*+ RULE */ A.* From (" & strSQL & ") A Order by 序号,收入项目ID"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Name, Val(vsAdvice.RowData(lngRow)), Val(vsAdvice.TextMatrix(lngRow, COL_相关ID)), str项目科室, mlng病人病区ID, mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级)
    If Not rsTmp.EOF Then
        '初始化记录集
        Set mrsPrice = New ADODB.Recordset
        mrsPrice.Fields.Append "病人ID", adBigInt
        mrsPrice.Fields.Append "主页ID", adBigInt, , adFldIsNullable
        mrsPrice.Fields.Append "收费类别", adVarChar, 1
        mrsPrice.Fields.Append "收费细目ID", adBigInt
        mrsPrice.Fields.Append "数量", adDouble
        mrsPrice.Fields.Append "单价", adDouble
        mrsPrice.Fields.Append "实收金额", adDouble
        mrsPrice.Fields.Append "开单人", adVarChar, 100, adFldIsNullable
        mrsPrice.Fields.Append "开单科室", adVarChar, 100, adFldIsNullable
        mrsPrice.CursorLocation = adUseClient
        mrsPrice.LockType = adLockOptimistic
        mrsPrice.CursorType = adOpenStatic
        mrsPrice.Open
        
        '加入费用明细
        dbl实收 = 0: blnDo = True
        Do While Not rsTmp.EOF
            '执行科室
            If blnDo Then
                lng执行科室ID = NVL(rsTmp!执行科室ID, 0)
                If rsTmp!收费类别 = "4" And NVL(rsTmp!跟踪在用, 0) = 1 Or InStr(",5,6,7,", rsTmp!收费类别) > 0 And InStr(",5,6,7,", rsTmp!诊疗类别) = 0 Then
                    lng执行科室ID = Get收费执行科室ID(mlng病人ID, mlng主页ID, rsTmp!收费类别, rsTmp!收费细目ID, 4, mlng病人科室id, 0, IIF(mlng病人性质 = 1, "1,2", 2), lng执行科室ID, , , 2)
                End If
            End If
            
            '单价
            If InStr(",5,6,7,", rsTmp!收费类别) > 0 And NVL(rsTmp!是否变价, 0) = 1 Then
                '药品时价
                dbl单价 = Format(CalcDrugPrice(rsTmp!收费细目ID, lng执行科室ID, NVL(rsTmp!数量, 0), , , , mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级), gstrDecPrice)
            ElseIf rsTmp!收费类别 = "4" And NVL(rsTmp!跟踪在用, 0) = 1 And NVL(rsTmp!是否变价, 0) = 1 Then
                '跟踪在用卫材时价
                dbl单价 = Format(CalcDrugPrice(rsTmp!收费细目ID, lng执行科室ID, NVL(rsTmp!数量, 0), , , , mstr药品价格等级, mstr卫材价格等级, mstr普通项目价格等级), gstrDecPrice)
            Else
                dbl单价 = Format(NVL(rsTmp!单价, 0), gstrDecPrice) '其他变价取的缺省价格
            End If
            
            '金额
            dbl金额 = CCur(NVL(rsTmp!数量, 0) * dbl单价)
            If NVL(rsTmp!附加手术, 0) = 1 Then
                dbl金额 = dbl金额 * NVL(rsTmp!附术收费率, 100) / 100
            End If
            dbl金额 = Format(dbl金额, gstrDec)
            
            If NVL(rsTmp!屏蔽费别, 0) = 0 And lvwPati.SelectedItem.SubItems(Item_费别) <> "" Then
                dbl金额 = ActualMoney(lvwPati.SelectedItem.SubItems(Item_费别), rsTmp!收入项目ID, dbl金额, rsTmp!收费细目ID, lng执行科室ID, NVL(rsTmp!数量, 0))
            End If
            
            dbl实收 = dbl实收 + dbl金额
            
            '项目变化时加入
            str项目 = rsTmp!序号 & "," & rsTmp!收费细目ID
            blnDo = False: rsTmp.MoveNext
            If Not rsTmp.EOF Then
                If rsTmp!序号 & "," & rsTmp!收费细目ID <> str项目 Then blnDo = True
            Else
                blnDo = True
            End If
            rsTmp.MovePrevious
            
            If blnDo Then
                With vsAdvice
                    mrsPrice.AddNew
                    mrsPrice!病人ID = mlng病人ID
                    mrsPrice!主页ID = mlng主页ID
                    mrsPrice!收费类别 = rsTmp!收费类别
                    mrsPrice!收费细目ID = rsTmp!收费细目ID
                    mrsPrice!数量 = NVL(rsTmp!数量, 0)
                    mrsPrice!单价 = dbl单价
                    mrsPrice!实收金额 = dbl金额
                    If .TextMatrix(lngRow, COL_开嘱医生) <> "" Then
                        mrsPrice!开单人 = .TextMatrix(lngRow, COL_开嘱医生)
                    End If
                    If Val(.TextMatrix(lngRow, COL_开嘱科室ID)) <> 0 Then
                        mrsPrice!开单科室 = CStr(Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_开嘱科室ID)), "名称"))
                    End If
                    mrsPrice.Update
                End With
                dbl实收 = 0
            End If
            
            rsTmp.MoveNext
        Loop
        
        mrsPrice.MoveFirst
        MakePriceRecord = True
    End If
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub GetDrugStock(ByVal lngRow As Long)
'功能：重新获取指定药品行的药品库存
'参数：lngRow=卫材、成药行或中药用法行
'说明：如果是中药配方行,一次性获取整个配方中的所有中药的库存
    Dim i As Long
    
    With vsAdvice
        If InStr(",4,5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            If Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Or Val(.TextMatrix(lngRow, COL_收费细目ID)) = 0 _
                Or .TextMatrix(lngRow, COL_类别) = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 0 Then
                .TextMatrix(lngRow, COL_库存) = ""
            Else
                .TextMatrix(lngRow, COL_库存) = GetStock(Val(.TextMatrix(lngRow, COL_收费细目ID)), Val(.TextMatrix(lngRow, COL_执行科室ID)))
            End If
        ElseIf RowIn配方行(lngRow) Then
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "7" Then
                        If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Or Val(.TextMatrix(i, COL_收费细目ID)) = 0 Then
                            .TextMatrix(i, COL_库存) = ""
                        Else
                            .TextMatrix(i, COL_库存) = GetStock(Val(.TextMatrix(i, COL_收费细目ID)), Val(.TextMatrix(i, COL_执行科室ID)))
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
        End If
    End With
End Sub

Private Function Get住院医师() As String
'功能：获取当前病人的住院医师
    Get住院医师 = lvwPati.ListItems("_" & mlng病人ID & "_" & mlng主页ID).SubItems(Item_住院医师)
End Function

Private Sub vsAdvice_AfterUserResize(ByVal Row As Long, ByVal Col As Long)
    Dim lngW As Long
    
    If Row = -1 Then
        lngW = Me.TextWidth(vsAdvice.TextMatrix(0, Col) & "A")
        If vsAdvice.ColWidth(Col) < lngW Then
            vsAdvice.ColWidth(Col) = lngW
        ElseIf vsAdvice.ColWidth(Col) > vsAdvice.Width * 0.5 Then
            vsAdvice.ColWidth(Col) = vsAdvice.Width * 0.5
        End If
        
        If Col = col_医嘱内容 Then Call vsAdvice.AutoSize(col_医嘱内容)
    End If
End Sub

Private Sub vsAdvice_BeforeScroll(ByVal OldTopRow As Long, ByVal OldLeftCol As Long, ByVal NewTopRow As Long, ByVal NewLeftCol As Long, Cancel As Boolean)
    If dtpDate.Visible Or lvwPati.Visible Then
        Call Form_KeyDown(vbKeyEscape, 0)
        Cancel = True
    End If
    If fraAdvice.Tag <> "" Then
        Cancel = True
    End If
End Sub

Private Sub vsAdvice_BeforeUserResize(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    If Row = -1 Then
        If Col <= vsAdvice.FixedCols - 1 Then
            Cancel = True
        ElseIf Col = COL_警示 Then 'Pass
            Cancel = True
        End If
    End If
End Sub

Private Sub vsAdvice_CellChanged(ByVal Row As Long, ByVal Col As Long)
    With vsAdvice
        If Col = COL_状态 Then
            If Val(.TextMatrix(Row, Col)) = -1 Then
                .Cell(flexcpFontItalic, Row, COL_期效) = True
                .Cell(flexcpFontBold, Row, COL_期效) = True
            ElseIf .Cell(flexcpFontItalic, Row, COL_期效) Then
                .Cell(flexcpFontItalic, Row, COL_期效) = False
                .Cell(flexcpFontBold, Row, COL_期效) = False
            End If
        End If
    End With
End Sub

Private Sub vsAdvice_Click()
    'PASS
    If mblnPass And Me.Visible Then
        Call gobjPass.zlPassAdviceMainPoint(mobjPassMap, 1)
    End If
End Sub

Private Sub vsAdvice_DblClick()
    Dim strMsg As String, lngRow As Long
    Dim lngBabyEdit As Long
    Dim strDepartments As String

    With vsAdvice
        If .MouseRow >= .FixedRows And .MouseRow <= .Rows - 1 Then
            lngRow = .MouseRow
            If .MouseCol >= .FixedCols And .MouseCol <= .Cols - 1 Then
                If .MouseCol = col_医嘱内容 And (mbytUseType = 0 Or mbytUseType = 2) Then
                    '复制医嘱
                    If vsAdvice.RowData(vsAdvice.Row) <> 0 Then
                        If CheckedPathSended = False Then Exit Sub
                        lngBabyEdit = CheckBabyEdit
                        If lngBabyEdit = 1 Then
                            MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
                            Exit Sub
                        ElseIf lngBabyEdit = 2 Then
                            MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
                            Exit Sub
                        End If
                        
                        If Not mbln医技后续 And mlng前提ID <> 0 And .TextMatrix(.Row, COL_期效) = "长嘱" Then
                            MsgBox "系统不允许对医技医嘱进行后续处理，不允许复制长嘱！", vbInformation, gstrSysName
                            Exit Sub
                        End If
                        
                        If gblnStock Then
                            '判断非院外执行药品是否有库存
                            strDepartments = ""
                            If mlng病人科室id <> 0 And Val(.TextMatrix(.Row, COL_执行性质)) <> 5 And InStr(",5,6,7,", .TextMatrix(.Row, COL_类别)) > 0 And Val(.TextMatrix(.Row, COL_收费细目ID)) <> 0 Then
                                strDepartments = Get可用药房IDs(.TextMatrix(.Row, COL_类别), NVL(.TextMatrix(.Row, COL_诊疗项目ID)), Val(.TextMatrix(.Row, COL_收费细目ID)), mlng病人科室id, 2)
                                '判断库存是否大于总量
                                If strDepartments <> "" Then
                                    If GetStock(Val(.TextMatrix(.Row, COL_收费细目ID)), , 2, strDepartments, CDbl(Val(.TextMatrix(.Row, COL_总量)))) = 0 Then
                                        MsgBox "该药品库存不足,系统限制了不允许下达库存不足的药品，不能被复制！", vbInformation, gstrSysName
                                        Exit Sub
                                    End If
                                End If
                            End If
                        End If
                
                        Call AdviceCopyCurr(vsAdvice.Row)

                        '医保管控实时监测
                        If mint险类 <> 0 And Not RowIn一并给药(vsAdvice.Row) Then
                            '总量不可输入：缺省并固定总量的医嘱，以及长嘱
                            '复制一并给药的多条药品时不在这里检查
                            If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) And Not txt总量.Enabled Then
                                If MakePriceRecord(vsAdvice.Row) Then
                                    If Not gclsInsure.CheckItem(mint险类, 1, 0, mrsPrice) Then
                                        Call AdviceCurRowClear: Exit Sub
                                    End If
                                End If
                                '标记为已经作了检查
                                vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_状态) = 1
                            End If
                        End If

                        If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
                    End If

                Else
                    Call vsAdvice_KeyPress(13)    '定位到对应的编辑控件
                    If mblnPass Then
                        Call gobjPass.zlPassAdviceMainPoint(mobjPassMap)
                    End If
                End If
            ElseIf .MouseCol = 0 Then
                '填写申请
                '##
            End If
        End If
    End With
End Sub

Private Function RowIsLastVisible(ByVal lngRow As Long) As Boolean
'功能：判断指定行是否最后一可见行
    Dim i As Long
    
    With vsAdvice
        For i = .Rows - 1 To .FixedRows Step -1
            If Not .RowHidden(i) Then Exit For
        Next
        If i >= .FixedRows Then
            RowIsLastVisible = lngRow = i
        End If
    End With
End Function



Private Sub vsAdvice_DrawCell(ByVal hDC As Long, ByVal Row As Long, ByVal Col As Long, ByVal Left As Long, ByVal Top As Long, ByVal Right As Long, ByVal Bottom As Long, Done As Boolean)
'说明：1.OwnerDraw要设置为Over(画出单元所有内容)
'      2.Cell的GridLine从上下左右向内都是从第1根线开始
'      3.Cell的Border从左上是从第2根线开始,右下是从第1根线开始
    Dim lngLeft As Long, lngRight As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim vRect As RECT
    
    With vsAdvice
        If Col <= .FixedCols - 1 Then
            '擦除固定列中的表格线
            SetBkColor hDC, OS.SysColor2RGB(.BackColorFixed)

            '仅左边表格线
            vRect.Left = Left
            vRect.Top = Top
            vRect.Right = Left + 1
            vRect.Bottom = Bottom
            If Row = .Rows - 1 Then vRect.Bottom = vRect.Bottom - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0

            '仅上边表格线
            vRect.Left = Left
            vRect.Top = Top
            vRect.Right = Right
            vRect.Bottom = Top + 1
            If Col = .FixedCols - 1 Then vRect.Right = vRect.Right - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0

            '仅下边表格线
            vRect.Left = Left
            vRect.Top = Bottom - 1
            vRect.Right = Right
            vRect.Bottom = Bottom
            If RowIsLastVisible(Row) Then vRect.Bottom = vRect.Bottom - 1
            If Col = .FixedCols - 1 Then vRect.Right = vRect.Right - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0

            '仅右边表格线
            vRect.Left = Right - 1
            vRect.Top = Top
            vRect.Right = Right
            vRect.Bottom = Bottom
            If Row = .Rows - 1 Then vRect.Bottom = vRect.Bottom - 1
            If Col = .FixedCols - 1 Then vRect.Right = vRect.Right - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0
        Else
            lngLeft = COL_期效: lngRight = COL_开始时间
            If Not Between(Col, lngLeft, lngRight) Then
                lngLeft = COL_天数: lngRight = COL_用法
                If Not Between(Col, lngLeft, lngRight) Then Exit Sub
            End If
            
            If Not RowIn一并给药(Row) Then Exit Sub
            If .RowData(Row) = 0 Then
                Call Get一并给药范围(Val(.TextMatrix(Row - 1, COL_相关ID)), lngBegin, lngEnd)
            Else
                Call Get一并给药范围(Val(.TextMatrix(Row, COL_相关ID)), lngBegin, lngEnd)
            End If
            
            vRect.Left = Left '擦除左边表格线
            vRect.Right = Right - 1 '保留右边表格线
            If Row = lngBegin Then
                vRect.Top = Bottom - 1 '首行保留文字内容
                vRect.Bottom = Bottom
            Else
                If Row = lngEnd Then
                    vRect.Top = Top
                    vRect.Bottom = Bottom - 1 '底行保留下边线
                Else
                    vRect.Top = Top
                    vRect.Bottom = Bottom
                End If
            End If
            
            If Between(Row, .Row, .RowSel) Then
                SetBkColor hDC, OS.SysColor2RGB(.BackColorSel)
            Else
                If (mbytUseType = 0 Or mbytUseType = 3) And mlng路径状态 = 1 Then
                    If Val(.TextMatrix(Row, COL_路径项目ID)) = 0 And Val(.TextMatrix(Row, COL_婴儿)) = 0 Then
                        SetBkColor hDC, OS.SysColor2RGB(BackColorNew) '路径外项目，浅黄色
                    Else
                        SetBkColor hDC, OS.SysColor2RGB(.BackColor)
                    End If
                Else
                    SetBkColor hDC, OS.SysColor2RGB(.BackColor)
                End If
            End If
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0
        End If
        Done = True
    End With
End Sub

Private Sub vsAdvice_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyDelete And (mbytUseType = 0 Or mbytUseType = 2) Then
        '执行Execute时,如果按钮"当前"不可用则不实际执行；不管是否可见
        cbsMain.FindControl(, conMenu_Delete, True, True).Execute
    End If
End Sub

Private Sub vsAdvice_KeyPress(KeyAscii As Integer)
    Dim objEdit As Object
    
    If KeyAscii = 13 Then
        '定位到对应的编辑控件
        KeyAscii = 0
        Select Case vsAdvice.Col
            Case COL_期效
                Set objEdit = cbo期效
            Case COL_开始时间
                Set objEdit = msk开始时间
            Case col_医嘱内容
                Set objEdit = txt医嘱内容
            Case COL_标本部位
                Set objEdit = txt安排时间
            Case COL_单量
                Set objEdit = txt单量
            Case COL_天数
                Set objEdit = txt天数
            Case COL_总量
                Set objEdit = txt总量
            Case COL_用法
                Set objEdit = txt用法
            Case COL_频率
                Set objEdit = txt频率
            Case COL_执行时间
                Set objEdit = cbo执行时间
            Case COL_执行科室ID
                Set objEdit = cbo执行科室
            Case COL_终止时间
                Set objEdit = txt终止时间
            Case COL_开嘱医生
                Set objEdit = cbo医生
            Case COL_开嘱时间
                Set objEdit = txt开嘱时间
            Case COL_医生嘱托
                Set objEdit = cbo医生嘱托
            Case COL_标志
                Set objEdit = chk紧急
            Case COL_超量说明
                Set objEdit = txt超量说明
            Case COL_用药目的
                Set objEdit = cboDruPur
            Case COL_用药理由
                Set objEdit = txt用药理由
        End Select
        If Not objEdit Is Nothing Then
            If objEdit.Enabled And objEdit.Visible Then objEdit.SetFocus
        End If
    End If
End Sub

Private Sub ClearItemTag()
'功能：清除控件编辑标志
    msk开始时间.Tag = ""
    txt安排时间.Tag = ""
    cbo分零.Tag = ""
    txt单量.Tag = ""
    txt天数.Tag = ""
    txt总量.Tag = ""
    txt用法.Tag = ""
    txt频率.Tag = ""
    cbo执行时间.Tag = ""
    txt首日时间.Tag = ""
    cbo医生嘱托.Tag = ""
    cbo执行科室.Tag = ""
    cbo执行性质.Tag = ""
    cbo附加执行.Tag = ""
    txt终止时间.Tag = ""
    txt开嘱时间.Tag = ""
    cbo医生.Tag = ""
    chk紧急.Tag = ""
    chkStop.Tag = ""
    cbo滴速.Tag = ""
    lbl用药目的.Tag = ""
    txt用药理由.Tag = ""
    cbo手术情况.Tag = ""
    txt超量说明.Tag = ""
    txt首次用量.Tag = ""
End Sub

Private Sub SetStartTime(ByVal Editable As Boolean)
'功能：设置开始时间是否允许编辑
    msk开始时间.TabStop = Editable
    msk开始时间.Enabled = Editable
    cmd开始时间.Enabled = Editable
    If Editable Then
        msk开始时间.BackColor = lvwPati.BackColor
    Else
        msk开始时间.BackColor = &HE0E0E0
    End If
End Sub

Private Sub SetWriteTime(ByVal Editable As Boolean)
'功能：设置开嘱时间是否允许编辑
    txt开嘱时间.TabStop = Editable
    txt开嘱时间.Locked = Not Editable
    cmd开嘱时间.Enabled = Editable
    If Editable Then
        txt开嘱时间.BackColor = lvwPati.BackColor
    Else
        txt开嘱时间.BackColor = &HE0E0E0
    End If
    '隐藏开嘱时间
    cmd开嘱时间.Visible = Editable
    txt开嘱时间.Visible = Editable
    lbl开嘱时间.Visible = Editable
End Sub

Private Sub SetDosagePos()
'功能：根据参数设置，设置单量/总量的先后位置；当不输入天数时使用，输入天数时另有函数SetDayState。
'说明：因为长嘱不录入总量，为避免总量与单量位置不断变换给用户造成不便，根据参数长/临嘱的总量与单量位置都固定。
    If mbln先输单量 Then
        lbl单量.Left = lbl用法.Left + lbl用法.Width - lbl单量.Width
        txt单量.Left = txt用法.Left
        txt单量.Width = txt用法.Width - cmd用法.Width - 15
        lbl单量单位(0).Left = txt单量.Left + txt单量.Width + 30
        
        lbl总量.Left = lbl频率.Left + lbl频率.Width - lbl总量.Width
        txt总量.Left = txt频率.Left
        txt总量.Width = txt频率.Width - cmd频率.Width - 15
        lbl总量单位.Left = txt总量.Left + txt总量.Width + 30
        
        txt单量.TabIndex = cmd频率.TabIndex + 1
        txt总量.TabIndex = txt单量.TabIndex + 1
    Else
        lbl总量.Left = lbl用法.Left + lbl用法.Width - lbl总量.Width
        txt总量.Left = txt用法.Left
        txt总量.Width = txt用法.Width - cmd用法.Width - 15
        lbl总量单位.Left = txt总量.Left + txt总量.Width + 30
        
        lbl单量.Left = lbl频率.Left + lbl频率.Width - lbl单量.Width
        txt单量.Left = txt频率.Left
        txt单量.Width = txt频率.Width - cmd频率.Width - 15
        lbl单量单位(0).Left = txt单量.Left + txt单量.Width + 30
        
        txt总量.TabIndex = cmd频率.TabIndex + 1
        txt单量.TabIndex = txt总量.TabIndex + 1
    End If
End Sub

Private Sub SetDayState(Optional ByVal intVisible As Integer, Optional ByVal intEnabled As Integer)
'功能：设置执行天数可用和或见状态
'参数：0-保持不变,-1-禁止,1-允许
    If intEnabled = -1 Then
        txt天数.Enabled = False
        txt天数.BackColor = Me.BackColor
        txt天数.Text = ""
    ElseIf intEnabled = 1 Then
        txt天数.TabStop = True
        txt天数.Enabled = True
        txt天数.BackColor = lvwPati.BackColor
    End If
    
    If intVisible = -1 Then
        lbl天数.Visible = False
        txt天数.Visible = False
        txt天数.Text = ""
        
        '当不输入天数时，设置缺省的总量/单量位置
        Call SetDosagePos
    ElseIf intVisible = 1 Then
        lbl天数.Visible = True
        txt天数.Visible = True
        
        lbl单量.Left = lbl用法.Left + lbl用法.Width - lbl单量.Width
        txt单量.Left = txt用法.Left
        txt单量.Width = txt用法.Width - txt天数.Width - Me.TextWidth("三个字!") - 15
        lbl单量单位(0).Left = txt单量.Left + txt单量.Width + 30
        
        lbl总量.Left = lbl频率.Left + lbl频率.Width - lbl总量.Width
        txt总量.Left = txt频率.Left
        txt总量.Width = txt频率.Width - cmd频率.Width - 15
        lbl总量单位.Left = txt总量.Left + txt总量.Width + 30
        
        txt单量.TabIndex = cmd频率.TabIndex + 1
        txt天数.TabIndex = txt单量.TabIndex + 1
        txt总量.TabIndex = txt天数.TabIndex + 1
    End If
End Sub

Private Sub SetItemEditable(Optional int单量 As Integer, Optional int总量 As Integer, _
    Optional int用法 As Integer, Optional int频率 As Integer, _
    Optional int执行时间 As Integer, Optional int执行科室 As Integer, _
    Optional int终止时间 As Integer, Optional int执行性质 As Integer, _
    Optional int附加执行 As Integer, Optional int分零方式 As Integer, _
    Optional int安排时间 As Integer, Optional int滴速 As Integer, _
    Optional int首日时间 As Integer, Optional int用药目的 As Integer, _
    Optional int用药理由 As Integer, Optional int超量说明 As Integer, _
    Optional int手术情况 As Integer, Optional int输血原因 As Integer)
'功能：设置指定编辑项的可用状态
'参数：0-保持不变,-1-禁止,1-允许,2-锁定
'说明：禁止时,同时清除该项目数据(不是全部)

    '依次设置为禁止时,会引发焦点改变,从而可能引发Validate事件,所以先禁止焦点顺序
    If int单量 = -1 Then txt单量.TabStop = False
    If int总量 = -1 Then txt总量.TabStop = False
    If int用法 = -1 Then txt用法.TabStop = False
    If int频率 = -1 Then txt频率.TabStop = False
    If int执行时间 = -1 Then cbo执行时间.TabStop = False
    If int执行科室 = -1 Then cbo执行科室.TabStop = False
    If int终止时间 = -1 Then txt终止时间.TabStop = False
    If int执行性质 = -1 Then cbo执行性质.TabStop = False
    If int附加执行 = -1 Then cbo附加执行.TabStop = False
        
    If int用药目的 = -1 Then cboDruPur.TabStop = False
    If int用药理由 = -1 Then txt用药理由.TabStop = False
    
    If int单量 = -1 Then
        txt单量.Enabled = False
        txt单量.BackColor = Me.BackColor
        txt单量.Text = ""
        txt首次用量.Enabled = False
        txt首次用量.BackColor = Me.BackColor
        txt首次用量.Text = ""
        lbl单量单位(0).Caption = "" '"单位"
        lbl单量单位(1).Caption = "" '"单位"
    ElseIf int单量 = 1 Then
        txt单量.TabStop = True
        txt单量.Enabled = True
        txt单量.BackColor = lvwPati.BackColor
        If cbo期效.ListIndex = 0 And Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_单量)) > 0 And InStr(",5,6,", "," & vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) & ",") > 0 Then
            txt首次用量.TabStop = True
            txt首次用量.Enabled = True
            txt首次用量.BackColor = lvwPati.BackColor
        Else
            txt首次用量.Enabled = False
            txt首次用量.BackColor = Me.BackColor
        End If
    End If

    If int总量 = -1 Then
        txt总量.Enabled = False
        txt总量.BackColor = Me.BackColor
        txt总量.Text = ""
        lbl总量单位.Caption = "" '"单位"
    ElseIf int总量 = 1 Then
        txt总量.TabStop = True
        txt总量.Enabled = True
        txt总量.BackColor = lvwPati.BackColor
    End If
    
    If int用法 = -1 Then
        txt用法.Enabled = False
        txt用法.BackColor = Me.BackColor
        txt用法.Text = ""
        cmd用法.Enabled = False
        lbl用法.Caption = "用法"
    ElseIf int用法 = 1 Then
        txt用法.TabStop = True
        txt用法.Enabled = True
        cmd用法.Enabled = True
        txt用法.BackColor = lvwPati.BackColor
    End If

    If int频率 = -1 Then
        txt频率.Enabled = False
        cmd频率.Enabled = False
        txt频率.BackColor = Me.BackColor
        txt频率.Text = ""
    ElseIf int频率 = 1 Then
        txt频率.TabStop = True
        txt频率.Enabled = True
        cmd频率.Enabled = True
        txt频率.BackColor = lvwPati.BackColor
    End If

    If int执行时间 = -1 Then
        cbo执行时间.Text = ""
        cbo执行时间.Enabled = False
        cbo执行时间.BackColor = Me.BackColor
        cbo执行时间.Clear
    ElseIf int执行时间 = 1 Then
        cbo执行时间.TabStop = True
        cbo执行时间.Enabled = True
        cbo执行时间.BackColor = lvwPati.BackColor
    End If
    
    If int执行时间 = -1 Then int首日时间 = -1
    If int首日时间 = -1 Then
        lbl首日时间.Visible = False
        txt首日时间.Visible = False
        txt首日时间.Text = ""
        cbo执行时间.Width = txt首日时间.Left + txt首日时间.Width - cbo执行时间.Left
    ElseIf int首日时间 = 1 Then
        lbl首日时间.Visible = True
        txt首日时间.Visible = True
        cbo执行时间.Width = lbl首日时间.Left - cbo执行时间.Left - Screen.TwipsPerPixelX * 3
    End If

    If int执行科室 = -1 Then
        lbl执行科室.Caption = "执行科室"
        cbo执行科室.Enabled = False
        cbo执行科室.BackColor = Me.BackColor
        cbo执行科室.Clear
    ElseIf int执行科室 = 1 Then
        lbl执行科室.Caption = "执行科室"
        cbo执行科室.TabStop = True
        cbo执行科室.Enabled = True
        cbo执行科室.BackColor = lvwPati.BackColor
    End If

    If int执行性质 = -1 Then
        cbo执行性质.Enabled = False
        cbo执行性质.BackColor = Me.BackColor
        Call Cbo.SetIndex(cbo执行性质.hwnd, -1) '不清除
    ElseIf int执行性质 = 1 Then
        cbo执行性质.TabStop = True
        cbo执行性质.Enabled = True
        cbo执行性质.BackColor = lvwPati.BackColor
    End If
    
    If int附加执行 = -1 Then
        lbl附加执行.Caption = "附加执行"
        cbo附加执行.Enabled = False
        cbo附加执行.BackColor = Me.BackColor
        cbo附加执行.Clear
    ElseIf int附加执行 = 1 Then
        lbl附加执行.Caption = "附加执行"
        cbo附加执行.TabStop = True
        cbo附加执行.Enabled = True
        cbo附加执行.BackColor = lvwPati.BackColor
    End If
    
    If int终止时间 = -1 Then
        cmd终止时间.Enabled = False
        txt终止时间.Enabled = False
        txt终止时间.Locked = False
        txt终止时间.BackColor = Me.BackColor
        txt终止时间.Text = ""
    ElseIf int终止时间 = 1 Then
        txt终止时间.TabStop = True
        cmd终止时间.Enabled = True
        txt终止时间.Enabled = True
        txt终止时间.Locked = False
        txt终止时间.BackColor = lvwPati.BackColor
    ElseIf int终止时间 = 2 Then '锁定(不可编辑,不清除内容)
        txt终止时间.TabStop = False
        cmd终止时间.Enabled = False
        txt终止时间.Enabled = True
        txt终止时间.Locked = True
        txt终止时间.BackColor = &HE0E0E0
    End If
    
    If int分零方式 = -1 Then
        lbl分零.Visible = False
        cbo分零.Visible = False
        Call Cbo.SetIndex(cbo分零.hwnd, -1)
        txt医嘱内容.Height = cbo分零.Top + cbo分零.Height - txt医嘱内容.Top
    ElseIf int分零方式 = 1 Then
        lbl分零.Visible = True
        cbo分零.Visible = True
        txt医嘱内容.Height = cbo执行时间.Top + cbo执行时间.Height - txt医嘱内容.Top
    End If
    
    If int安排时间 = -1 Then
        txt安排时间.Text = ""
        lbl安排时间.Visible = False
        txt安排时间.Visible = False
        cmd安排时间.Visible = False
        lbl用法.Visible = True
        txt用法.Visible = True
        cmd用法.Visible = True
    ElseIf int安排时间 = 1 Then
        lbl安排时间.Visible = True
        txt安排时间.Visible = True
        cmd安排时间.Visible = True
        lbl用法.Visible = False
        txt用法.Visible = False
        cmd用法.Visible = False
    End If
    
    If int滴速 = -1 Then
        cbo滴速.Text = ""
        lbl滴速.Visible = False
        cbo滴速.Visible = False
        lbl滴速单位.Visible = False
    ElseIf int滴速 = 1 Then
        lbl滴速.Visible = True
        cbo滴速.Visible = True
        lbl滴速单位.Visible = True
    End If
    
    '缺省不选中
    If int用药目的 = -1 Then
        Call Cbo.SetIndex(cboDruPur.hwnd, 0)
        cboDruPur.Enabled = False
    ElseIf int用药目的 = 1 Then
        Call Cbo.SetIndex(cboDruPur.hwnd, 0)
        cboDruPur.Enabled = True
        cboDruPur.TabStop = True
    End If
        
    If int用药理由 = -1 Then
        txt用药理由.Text = ""
        txt用药理由.Enabled = False
        cmdReason.Enabled = False
        cmd收藏用药理由.Enabled = False
        txt用药理由.BackColor = Me.BackColor
        cmd输血原因.Enabled = False
    ElseIf int用药理由 = 1 Then
        txt用药理由.Enabled = True
        cmdReason.Enabled = True
        cmd收藏用药理由.Enabled = True
        txt用药理由.TabStop = True
        txt用药理由.BackColor = lvwPati.BackColor
        cmd输血原因.Enabled = True
    End If
    
    If int超量说明 = -1 Then
        txt超量说明.Enabled = False
        txt超量说明.BackColor = Me.BackColor
        cmdExcReason.Enabled = False
        cmdComExcReason.Enabled = False
    ElseIf int超量说明 = 1 Then
        txt超量说明.Enabled = True
        txt超量说明.TabStop = True
        txt超量说明.BackColor = vsAdvice.BackColor
        cmdExcReason.Enabled = True
        cmdComExcReason.Enabled = True
    End If
    
    If int手术情况 = -1 Then
        lbl手术情况.Visible = False
        cbo手术情况.Visible = False
        lbl频率.Visible = True
        txt频率.Visible = True
        cmd频率.Visible = True
    ElseIf int手术情况 = 1 Then
        lbl手术情况.Visible = True
        cbo手术情况.Visible = True
        lbl频率.Visible = False
        txt频率.Visible = False
        cmd频率.Visible = False
    End If
    
    '=1输血医嘱，显示输血原因
    If int输血原因 = -1 Then
        lbl用药目的.Visible = True
        cboDruPur.Visible = True
        cmdReason.Visible = True
        cmd收藏用药理由.Visible = True
        lbl用药理由.Caption = "用药理由"
        cmd输血原因.Visible = False
    ElseIf int输血原因 = 1 Then
        lbl用药目的.Visible = False
        cboDruPur.Visible = False
        cmdReason.Visible = False
        cmd收藏用药理由.Visible = False
        lbl用药理由.Caption = "输血原因"
        cmd输血原因.Visible = True
    End If
End Sub


Private Function Get身份证号() As Boolean
    '功能：读取病人身份证号
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    strSQL = "select 姓名,身份证号 from 病人信息 where 病人ID=[1] and 主页ID=[2]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
    If Not rsTmp.EOF Then
        mstr姓名 = rsTmp!姓名 & ""
        mstr身份证号 = rsTmp!身份证号 & ""
    End If
End Function

Private Function LoadPatients(ByVal intType As Integer) As Boolean
'功能：读取与调用界面相同范围的病人列表
'参数：intType=0 只读取当前病人,intType=1 读取所有病人
    Dim rsPati As New ADODB.Recordset
    Dim objItem As ListItem, strSQL As String, strTmp As String
    Dim strPriv As String, strMsg As String
    Dim i As Integer, j As Integer
    Dim str部门IDs As String, lng部门ID As Long
    Dim intBedLen As Integer, blnDo As Boolean
    Dim blnOutDept As Boolean, bln待入住 As Boolean
    
    On Error GoTo errH
    
    strSQL = _
        "Select A.病人ID,B.主页ID,A.门诊号,B.住院号,Nvl(B.姓名,A.姓名) 姓名,Nvl(B.性别,A.性别) 性别 ,Nvl(B.年龄,A.年龄) 年龄 ,B.病人类型," & _
        " D.名称 as 科室,B.入院日期,B.出院日期,B.住院医师,B.出院病床 as 床号,B.费别," & _
        " B.险类,B.出院科室ID as 科室ID,B.当前病区ID as 病区ID,C.名称 as 护理等级," & _
        " B.状态,B.数据转出,Nvl(B.医疗付款方式,A.医疗付款方式) as 医疗付款方式,A.出生日期,B.病人性质,b.路径状态,b.体重,b.留观号,b.婴儿科室ID,b.婴儿病区ID" & _
        " From 病人信息 A,病案主页 B,收费项目目录 C,部门表 D" & _
        " Where A.病人ID=B.病人ID And B.护理等级ID=C.ID(+)" & _
        " And B.出院科室ID=D.ID And A.病人ID=[1] And B.主页ID=[2]"
    Set rsPati = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
    lng部门ID = IIF(mint场合 = 1, IIF(mlng婴儿科室ID <> 0, NVL(rsPati!婴儿病区ID, 0), NVL(rsPati!病区ID, 0)), IIF(mlng婴儿科室ID <> 0, NVL(rsPati!婴儿科室ID, 0), NVL(rsPati!科室ID, 0)))
    
    If mlng病人性质 = 1 Then    '门诊留观病人
        blnOutDept = True
    Else
        Call Sys.DeptHaveProperty(lng部门ID, IIF(mint场合 = 1, "护理", "临床"), blnOutDept)
    End If
    If blnOutDept Then
        lblCaption(1).Caption = "门诊号:"
        lvwPati.ColumnHeaders("_住院号").Text = "门诊号" '注意listview按key访问，RestoreListViewState中固定修改了key值为“_文本值”
    Else
        lblCaption(1).Caption = "住院号:"
        lvwPati.ColumnHeaders("_住院号").Text = "住院号"
    End If
    
    
    '临床路径生成，会诊调用，医技调用，或非在院病人：不能选择
    blnDo = False
    If mlng前提ID = 0 And mlng会诊科室ID = 0 And mbytUseType = 0 Then
        If IsNull(rsPati!出院日期) And NVL(rsPati!状态, 0) <> 3 Then
            blnDo = True
        End If
    End If
    If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
        blnDo = False
        cbo期效.Enabled = False
    End If
    
    If blnDo Then
        If GetSinglePati() Then blnDo = False
    End If
    
    bln待入住 = Val(zlDatabase.GetPara("允许给待入住病人下达医嘱", glngSys, p住院医嘱下达, 1)) = 1
    
    If blnDo Then
        '提供当前科室/病区的在院病人清单供选择
        '不显示临床路径中的病人
        '如果是第一次进入时，则不读取
        If intType = 1 Then
            intBedLen = GetMaxBedLen(lng部门ID, mint场合 <> 1)
            strSQL = _
                "Select Decode(B.状态,1,0,3,3,Decode(B.住院医师,[4],1,2)) as 排序,A.病人ID,B.主页ID,A.门诊号,B.住院号,Nvl(B.姓名,A.姓名) 姓名,Nvl(B.性别,A.性别) 性别 ,Nvl(B.年龄,A.年龄) 年龄,D.名称 as 科室,B.入院日期,B.出院日期," & _
                " B.住院医师,LPAD(B.出院病床," & intBedLen & ",' ') as 床号,B.费别,B.险类," & _
                " B.责任护士,B.当前病区ID as 病区ID,B.出院科室ID as 科室ID,C.名称 as 护理等级," & _
                " B.状态,B.数据转出,Nvl(B.医疗付款方式,A.医疗付款方式) as 医疗付款方式,B.病人类型,A.出生日期,B.病人性质,b.路径状态,b.体重,b.留观号,b.婴儿科室ID,b.婴儿病区ID" & _
                " From 病人信息 A,病案主页 B,收费项目目录 C,部门表 D" & _
                " Where A.病人ID=B.病人ID And B.护理等级ID=C.ID(+)" & _
                " And B.出院科室ID=D.ID And A.病人ID=[1] And B.主页ID=[2]" & _
                IIF(gbyt病人审核方式 = 1, " And Nvl(b.审核标志,0)<1", "")
            strSQL = strSQL & " Union " & _
                "Select Decode(B.状态,1,0,3,3,Decode(B.住院医师,[4],1,2)) as 排序,A.病人ID,B.主页ID,A.门诊号,B.住院号,Nvl(B.姓名,A.姓名) 姓名,Nvl(B.性别,A.性别) 性别 ,Nvl(B.年龄,A.年龄) 年龄,D.名称 as 科室,B.入院日期,B.出院日期," & _
                " B.住院医师,LPAD(B.出院病床," & intBedLen & ",' ') as 床号,B.费别,B.险类," & _
                " B.责任护士,B.当前病区ID as 病区ID,B.出院科室ID as 科室ID,C.名称 as 护理等级," & _
                " B.状态,B.数据转出,Nvl(B.医疗付款方式,A.医疗付款方式) as 医疗付款方式,B.病人类型,A.出生日期,B.病人性质,b.路径状态,b.体重,b.留观号,b.婴儿科室ID,b.婴儿病区ID" & _
                " From 病人信息 A,病案主页 B,收费项目目录 C,部门表 D,在院病人 R" & _
                " Where A.病人ID=B.病人ID And A.主页ID=B.主页ID And B.出院科室ID=D.ID " & _
                IIF(bln待入住, "", " And B.状态<>1 ") & "And a.病人ID=R.病人ID " & _
                IIF(mint场合 = 1, " And A.当前病区ID=R.病区ID", " And A.当前科室ID=R.科室ID") & " And B.护理等级ID=C.ID(+)" & _
                IIF(mint场合 = 1, " And (R.病区ID=[3] Or b.婴儿病区ID=[3])", " And (R.科室ID=[3] Or b.婴儿科室ID=[3])") & _
                IIF(mint场合 <> 1 And InStr(mMainPrivs, "本科病人") = 0, " And B.住院医师=[4]", "") & _
                IIF(gbyt病人审核方式 = 1, " And Nvl(b.审核标志,0)<1", "") & _
                " And Nvl(B.病案状态,0)<>5 And B.封存时间 is NULL" & _
                " Order by 排序,床号"
            Set rsPati = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, lng部门ID, UserInfo.姓名)
            mblnRefresh = True
        End If
    Else
        cmdPati.Visible = False
        txtPati.Locked = True
        txtPati.BackColor = Me.BackColor
    End If
    
    '下面判断权限备用
    strPriv = GetInsidePrivs(p住院医嘱下达)
    If Not (mlng前提ID <> 0 Or mlng会诊科室ID <> 0) Then
        If mint场合 <> 1 Then
            str部门IDs = GetUser科室IDs(True)
        Else
            str部门IDs = GetUser病区IDs
        End If
    End If
        
    lvwPati.ListItems.Clear
    If Not rsPati.EOF Then
        For i = 1 To rsPati.RecordCount
            If mlng前提ID <> 0 Or mlng会诊科室ID <> 0 Then
                blnDo = True
            ElseIf rsPati!病人ID = mlng病人ID And rsPati!主页ID = mlng主页ID Then
                blnDo = True
            Else
                blnDo = False
                If mint场合 <> 1 Then
                    If NVL(rsPati!住院医师) = UserInfo.姓名 Then
                        blnDo = True '当前医生经治病人
                    ElseIf InStr(strPriv, ";全院医嘱下达;") > 0 Then
                        blnDo = True '有全院病人医嘱下达权限
                    ElseIf InStr(strPriv, ";本科医嘱下达;") > 0 _
                        And InStr("," & str部门IDs & ",", "," & NVL(rsPati!科室ID, 0) & ",") > 0 Then
                        blnDo = True '有本科病人医嘱下达权限
                    End If
                Else
                    If NVL(rsPati!责任护士) = UserInfo.姓名 Then
                        blnDo = True '当前护士责任护理
                    ElseIf InStr(strPriv, ";全院医嘱下达;") > 0 Then
                        blnDo = True '有全院病人医嘱下达权限
                    ElseIf InStr(strPriv, ";本科医嘱下达;") > 0 _
                        And InStr("," & str部门IDs & ",", "," & NVL(rsPati!病区ID, 0) & ",") > 0 Then
                        blnDo = True '有本科病人医嘱下达权限
                    End If
                End If
            End If
            If blnDo Then
                Set objItem = lvwPati.ListItems.Add(, "_" & rsPati!病人ID & "_" & rsPati!主页ID, rsPati!姓名, , "Pati")
                If Val("" & rsPati!病人性质) = 1 Then
                    objItem.SubItems(Item_标识号) = NVL(rsPati!门诊号)
                Else
                    objItem.SubItems(Item_标识号) = NVL(rsPati!住院号)
                End If
                objItem.SubItems(Item_床号) = NVL(rsPati!床号)
                objItem.SubItems(Item_住院医师) = NVL(rsPati!住院医师)
                objItem.SubItems(Item_性别) = NVL(rsPati!性别)
                objItem.SubItems(Item_年龄) = NVL(rsPati!年龄)
                objItem.SubItems(Item_费别) = NVL(rsPati!费别)
                objItem.SubItems(Item_护理等级) = NVL(rsPati!护理等级)
                objItem.SubItems(Item_入院日期) = Format(rsPati!入院日期, "yyyy-MM-dd HH:mm")
                objItem.SubItems(Item_出院日期) = Format(NVL(rsPati!出院日期), "yyyy-MM-dd HH:mm")
                objItem.SubItems(Item_医疗付款方式) = NVL(rsPati!医疗付款方式)
                objItem.SubItems(Item_病人类型) = NVL(rsPati!病人类型)
                objItem.SubItems(Item_病人性质) = IIF(Val("" & rsPati!病人性质) = 0, "住院病人", IIF(Val("" & rsPati!病人性质) = 1, "门诊留观", "住院留观"))
                objItem.SubItems(Item_体重) = IIF(IsNull(rsPati!体重), "", rsPati!体重 & "kg")
                objItem.SubItems(Item_留观号) = NVL(rsPati!留观号)
                objItem.SubItems(Item_婴儿科室ID) = NVL(rsPati!婴儿科室ID, 0)
                objItem.SubItems(Item_婴儿病区ID) = NVL(rsPati!婴儿病区ID, 0)
                If intType = 0 Then
                    mlng婴儿科室ID = Val(objItem.SubItems(Item_婴儿科室ID))
                    mlng婴儿病区ID = Val(objItem.SubItems(Item_婴儿病区ID))
                End If
                        
                objItem.ListSubItems(Itag_路径状态).Tag = Val("" & rsPati!路径状态)
                objItem.ListSubItems(Itag_科室ID).Tag = rsPati!科室ID
                objItem.ListSubItems(Itag_险类).Tag = NVL(rsPati!险类, 0)
                objItem.ListSubItems(Itag_入院日期).Tag = Format(rsPati!入院日期, "yyyy-MM-dd HH:mm:ss")
                objItem.ListSubItems(Itag_出院日期).Tag = Format(NVL(rsPati!出院日期), "yyyy-MM-dd HH:mm:ss")
                objItem.ListSubItems(Itag_状态).Tag = NVL(rsPati!状态, 0)
                objItem.ListSubItems(Itag_科室).Tag = NVL(rsPati!科室)
                objItem.ListSubItems(Itag_病区ID).Tag = NVL(rsPati!病区ID, 0)
                
                '用于历史数据查询
                objItem.ListSubItems(Itag_数据转出).Tag = NVL(rsPati!数据转出, 0)
                objItem.ListSubItems(Itag_病人性质).Tag = Val("" & rsPati!病人性质)
                
                If IsNull(rsPati!出生日期) Then
                    objItem.ListSubItems(Itag_出生日期).Tag = Format(DateAdd("yyyy", -Val(NVL(rsPati!年龄)), mdatCurr), "yyyy-MM-dd HH:mm:ss")
                Else
                    objItem.ListSubItems(Itag_出生日期).Tag = Format(NVL(rsPati!出生日期), "yyyy-MM-dd HH:mm:ss")
                End If
                
                '病人颜色 住院号和病人类型
                objItem.ForeColor = zlDatabase.GetPatiColor(NVL(rsPati!病人类型))
                For j = 1 To objItem.ListSubItems.Count
                    objItem.ListSubItems(j).ForeColor = objItem.ForeColor
                Next
                
                '显示初始病人的信息
                If rsPati!病人ID = mlng病人ID And rsPati!主页ID = mlng主页ID Then
                    With objItem
                        Call GetPatiLastChange(mlng病人ID, mlng主页ID, 0, 0, mint场合, strTmp)
                        .ListSubItems(Itag_转科时间).Tag = strTmp
                                                
                        txtPati.ForeColor = .ForeColor
                        txtPati.Text = .Text
                        mstr性别 = .SubItems(Item_性别)
                        mstr病人性别 = mstr性别
                        mint险类 = Val(.ListSubItems(Itag_险类).Tag)
                        mint病人状态 = Val(.ListSubItems(Itag_状态).Tag)
                        mstr付款码 = Get医疗付款码(.SubItems(Item_医疗付款方式))
                        mlng病人性质 = objItem.ListSubItems(Itag_病人性质).Tag
                        mlng路径状态 = objItem.ListSubItems(Itag_路径状态).Tag
                        If mblnOutPathTable Then mlng路径状态 = 0
                        
                        If mlng路径状态 = 1 Then
                            mbln未评估 = CheckPathNotEvaluete(mlng病人ID, mlng主页ID)
                            If mbytUseType = 0 Then Set mrsPPati = GetPatiPathInfo(mlng病人ID, mlng主页ID)
                        Else
                            mbln未评估 = False
                        End If
                        
                        If mintPState <> ps最近转出 Then
                            mlng病人科室id = Val(.ListSubItems(Itag_科室ID).Tag)
                            mlng病人病区ID = Val(.ListSubItems(Itag_病区ID).Tag)
                        End If
                                                
                        Call ShowPatiInfo(objItem)
                        
                        .Selected = True '一定要选中当前病人
                        mbln提醒对码 = True
                    End With
                    mint年龄 = GetPatiYear(mlng病人ID)
                    Call Show费用信息
                    
                    '产科才有婴儿医嘱
                    Call SetBabyVisible(mlng病人ID, mlng主页ID)
                    
                    '特殊医嘱提醒
                    strMsg = ExistsSpecAdvice(mlng病人ID, mlng主页ID)
                    If strMsg <> "" Then MsgBox strMsg, vbInformation, gstrSysName
                End If
            End If
            rsPati.MoveNext
        Next
    End If
    
    If mblnPass Then
        Call zlPASSPati
    End If
    
    LoadPatients = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub ShowPatiInfo(objItem As ListItem)
    Dim lngLeft As Long, i As Integer
    
    With objItem
        lblText(0).Caption = Trim(.SubItems(Item_床号))
        
        If .SubItems(Item_留观号) <> "" And Val(.ListSubItems(Itag_病人性质).Tag) = 2 Then
            lblCaption(1).Caption = "留观号:"
            lblText(1).Caption = .SubItems(Item_留观号)
        Else
            If Val(.ListSubItems(Itag_病人性质).Tag) = 1 Then
                lblCaption(1).Caption = "门诊号:"
            Else
                lblCaption(1).Caption = "住院号:"
            End If
            lblText(1).Caption = .SubItems(Item_标识号)
        End If
        
        lblText(2).Caption = .ListSubItems(Itag_科室).Tag
        lblText(3).Caption = .SubItems(Item_性别)
        lblText(4).Caption = .SubItems(Item_年龄)
        lblText(5).Caption = .SubItems(Item_费别)
        lblText(6).Caption = .SubItems(Item_病人类型)
        lblText(7).Caption = .SubItems(Item_医疗付款方式)
        lblText(8).Caption = .SubItems(Item_体重)
    End With
    
    lngLeft = 30
    For i = 0 To lblText.UBound
        lblCaption(i).Left = lngLeft
        lblText(i).Left = lblCaption(i).Left + lblCaption(i).Width
        lngLeft = lblText(i).Left + lblText(i).Width + 150
    Next
End Sub

Private Sub SetBabyVisible(ByVal lng病人ID As Long, ByVal lng主页ID As Long)
'功能：根据科室性质设置婴儿医嘱是否可以选择
'说明：产科才有婴儿医嘱
    Dim arrBaby As Variant, strBaby As String
    Dim intIdx As Integer, i As Long
    
    '删除其他婴儿医嘱项(至少都保留病人医嘱项)
    intIdx = cbo婴儿.ListIndex
    Call Cbo.SetIndex(cbo婴儿.hwnd, 0): cbo婴儿.Tag = 0
    For i = cbo婴儿.ListCount - 1 To 1 Step -1
        cbo婴儿.RemoveItem i
    Next
    
    '重新设置婴儿
    strBaby = GetBabyRegList(lng病人ID, lng主页ID, mrsBaby)
    If strBaby <> "" Then
        arrBaby = Split(strBaby, "<Split>")
        For i = 0 To UBound(arrBaby)
            cbo婴儿.AddItem "婴儿 " & i + 1 & IIF(arrBaby(i) <> "", "：" & arrBaby(i), "")
            If cbo婴儿.NewIndex = intIdx Then
                Call Cbo.SetIndex(cbo婴儿.hwnd, intIdx): cbo婴儿.Tag = intIdx
                mint婴儿 = intIdx
                mstr性别 = GetBabySex(mint婴儿)
            End If
        Next
        lbl婴儿.Visible = True
        cbo婴儿.Visible = True
    Else
        lbl婴儿.Visible = False
        cbo婴儿.Visible = False
        Set mrsBaby = Nothing
    End If
End Sub

Private Function Show费用信息() As Boolean
'功能：获取当前病人的费用信息
'参数：bytType:0-费用余额,1-预交余额
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String
    
    strSQL = _
        " Select 费用余额,预交余额,0 as 预结费用, 0 As 担保额 From 病人余额 Where 性质=1 And 病人ID=[1] And 类型 = " & IIF(mlng病人性质 = 1, 1, 2) & _
        " Union All" & _
        " Select 0, 0, 0, Sum(担保额) As 担保额" & _
        " From 病人担保记录 Where 病人id = [1] And 主页id = [2] And 删除标志 = 1 And (Sysdate <= 到期时间 Or 到期时间 Is Null)" & _
        " Union ALL" & _
        " Select 0,0,Sum(金额),0 From 保险模拟结算 A,病案主页 B" & _
        " Where A.病人ID=B.病人ID And A.主页ID=B.主页ID And B.险类 Is Not Null And A.病人ID=[1] And A.主页ID=[2]"
    strSQL = "Select Sum(费用余额) as 费用余额,Sum(预交余额) as 预交余额,Sum(预结费用) as 预结费用, Sum(担保额) As 担保额 From (" & strSQL & ")"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
    If Not rsTmp.EOF Then
        stbThis.Panels(2).Text = _
            "预交余额:" & FormatEx(NVL(rsTmp!预交余额, 0), 2) & ",未结费用:" & FormatEx(NVL(rsTmp!费用余额, 0), 2) & _
            IIF(NVL(rsTmp!预结费用, 0) <> 0, ",预结费用:" & FormatEx(NVL(rsTmp!预结费用, 0), 2), "") & _
            ",剩余款:" & FormatEx(NVL(rsTmp!预交余额, 0) - NVL(rsTmp!费用余额, 0) + NVL(rsTmp!预结费用, 0), 2) & ",担保额:" & NVL(rsTmp!担保额, 0)
    Else
        stbThis.Panels(2).Text = ""
    End If
    Show费用信息 = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function GetPreRow(ByVal lngRow As Long) As Long
'功能：取上一最近有效可见行
'返回：无有效行时,返回-1
    Dim lngTmp As Long, i As Long
    
    lngTmp = -1
    For i = lngRow - 1 To vsAdvice.FixedRows Step -1
        If vsAdvice.RowData(i) <> 0 And Not vsAdvice.RowHidden(i) Then
            lngTmp = i: Exit For
        End If
    Next
    GetPreRow = lngTmp
End Function

Private Function GetNextRow(ByVal lngRow As Long) As Long
'功能：取下一最近有效可见行
'返回：无有效行时,返回-1
    Dim lngTmp As Long, i As Long
    
    lngTmp = -1
    For i = lngRow + 1 To vsAdvice.Rows - 1
        If vsAdvice.RowData(i) <> 0 And Not vsAdvice.RowHidden(i) Then
            lngTmp = i: Exit For
        End If
    Next
    GetNextRow = lngTmp
End Function

Private Sub GetRowScope(ByVal lngRow As Long, lngBegin As Long, lngEnd As Long)
'功能：获取组ID相同的一组医嘱行号范围(注意考虑一并给药中的空行)
    Dim lngS组ID As Long, lngO组ID As Long, i As Long
    With vsAdvice
        lngBegin = lngRow: lngEnd = lngRow
        lngS组ID = IIF(Val(.TextMatrix(lngRow, COL_相关ID)) = 0, .RowData(lngRow), Val(.TextMatrix(lngRow, COL_相关ID)))
        For i = lngRow - 1 To .FixedRows Step -1
            lngO组ID = IIF(Val(.TextMatrix(i, COL_相关ID)) = 0, .RowData(i), Val(.TextMatrix(i, COL_相关ID)))
            If Not (.RowData(i) = 0 And i >= .FixedRows) Then '跳过空行
                If lngO组ID = lngS组ID Then
                    lngBegin = i
                Else
                    Exit For
                End If
            End If
        Next
        For i = lngRow + 1 To .Rows - 1
            lngO组ID = IIF(Val(.TextMatrix(i, COL_相关ID)) = 0, .RowData(i), Val(.TextMatrix(i, COL_相关ID)))
            If Not (.RowData(i) = 0 And i >= .FixedRows) Then '跳过空行
                If lngO组ID = lngS组ID Then
                    lngEnd = i
                Else
                    Exit For
                End If
            End If
        Next
    End With
End Sub

Private Function TimeIs长嘱次日(ByVal lngRow As Long) As Boolean
'功能：判断指定医嘱行的开始执行时间是否按次日生效设置的
    With vsAdvice
        TimeIs长嘱次日 = gbln长期医嘱次日生效 And .TextMatrix(lngRow, COL_期效) = "长嘱" _
            And Format(.Cell(flexcpData, lngRow, COL_开始时间), "HH:mm") = "00:00"
    End With
End Function

Private Function GetDefaultTime(ByVal lngRow As Long, Optional ByVal blnNew As Boolean) As String
'功能：获取新开医嘱的缺省开始时间
'参数：blnNew=是否不取以前医嘱的时间，取新时间
    Dim curDate As Date, strDate As String
    Dim int期效 As Integer, i As Long
    Dim lngBegin As Long, lngEnd As Long
    
    If mbytUseType = 1 Then
        curDate = mdat开始时间
    Else
        If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
            curDate = DateAdd("n", -1, mdatTurn)    '变动前一分钟
        Else
            curDate = zlDatabase.Currentdate
        End If
    End If
    
    With vsAdvice
        '当前行的期效:可能才输入,也可能已输入
        If .RowData(lngRow) <> 0 Then
            int期效 = IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1)
        Else
            int期效 = cbo期效.ListIndex
        End If
        
        If int期效 = 0 And gbln长期医嘱次日生效 Then
            If Val(.TextMatrix(lngRow, COL_标志)) = 0 Then
                strDate = Format(curDate + 1, "yyyy-MM-dd 00:00")
            Else
                strDate = Format(curDate, "yyyy-MM-dd 00:00")
            End If
        ElseIf Not blnNew Then
            If mstrLastTime <> "" Then
                strDate = mstrLastTime
                mstrLastTime = ""
            Else
                '以本次编辑才录入的新医嘱时间为准:跳过缺省为次日生效的时间
                '本次编辑新录入的医嘱操作时间目前没有填写
                Call GetRowScope(lngRow, lngBegin, lngEnd)

                For i = lngBegin - 1 To .FixedRows Step -1
                    If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_开始时间)) Then
                        If Not TimeIs长嘱次日(i) And .TextMatrix(i, COL_操作时间) = "" Then
                            strDate = Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd HH:mm")
                            Exit For
                        End If
                    End If
                Next
                If strDate = "" Then
                    For i = .Rows - 1 To lngEnd + 1 Step -1
                        If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_开始时间)) Then
                            If Not TimeIs长嘱次日(i) And .TextMatrix(i, COL_操作时间) = "" Then
                                strDate = Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd HH:mm")
                                Exit For
                            End If
                        End If
                    Next
                End If
            End If
        End If
    End With
    If strDate = "" Then strDate = Format(curDate, "yyyy-MM-dd HH:mm")
    GetDefaultTime = strDate
End Function

Private Function GetCurRow序号(lngRow As Long, Optional ByVal lngNo As Long) As Long
'功能：获取指定行可用的的序号
'参数：lngRow=要取序号的行
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, lng序号 As Long, i As Long
    Dim lng序号1 As Long, lng序号2 As Long
            
    '取之后最近一个有效序号,直接使用
    For i = lngRow + 1 To vsAdvice.Rows - 1
        If vsAdvice.RowData(i) <> 0 Then
            If Val(vsAdvice.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex _
                And IsNumeric(vsAdvice.TextMatrix(i, COL_序号)) Then
                lng序号 = Val(vsAdvice.TextMatrix(i, COL_序号))
                Exit For
            End If
        End If
    Next
    If lng序号 = 0 Then
        '后面没有,则取数据库之中的最大序号与之前的最大序号比较
        On Error GoTo errH
        strSQL = "Select Max(序号) as 序号 From 病人医嘱记录 Where 病人ID=[1] And 主页ID=[2] And Nvl(婴儿,0)=[3]"
        
        If lngNo <> 0 Then strSQL = strSQL & " and nvl(申请序号,0)<>[4]"
        
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, cbo婴儿.ListIndex, lngNo)
        If Not rsTmp.EOF Then lng序号1 = NVL(rsTmp!序号, 0)
        On Error GoTo 0
        
        For i = lngRow To vsAdvice.FixedRows Step -1
            If vsAdvice.RowData(i) <> 0 Then
                If (Val(vsAdvice.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Or mbytUseType = 1) _
                    And IsNumeric(vsAdvice.TextMatrix(i, COL_序号)) Then
                    lng序号2 = Val(vsAdvice.TextMatrix(i, COL_序号))
                    Exit For
                End If
            End If
        Next
        
        If lng序号1 > lng序号2 Then
            lng序号 = lng序号1
        Else
            lng序号 = lng序号2
        End If

        If lng序号 <> 0 Then lng序号 = lng序号 + 1 '最大序号+1
    End If
    If lng序号 = 0 Then lng序号 = 1
    GetCurRow序号 = lng序号
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub AdviceSet医嘱序号(lngRow As Long, intStep As Integer)
'功能：将当前病人医嘱记录中序号前移或后移
'参数：lngRow=起始调整行,intStep=调整步长,如1或-1
    Dim i As Long
    
    For i = lngRow To vsAdvice.Rows - 1
        If vsAdvice.RowData(i) <> 0 Then
            If Val(vsAdvice.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex _
                And IsNumeric(vsAdvice.TextMatrix(i, COL_序号)) Then
                vsAdvice.TextMatrix(i, COL_序号) = Val(vsAdvice.TextMatrix(i, COL_序号)) + intStep
                If Val(vsAdvice.TextMatrix(i, COL_EDIT)) = 0 Then
                    vsAdvice.TextMatrix(i, COL_EDIT) = 3 '标志修改了序号
                End If
            End If
        End If
    Next
End Sub

Private Sub AdviceDelete(ByVal lngRow As Long)
'功能：指定的医嘱删除处理
    Dim lngBegin As Long, lngEnd As Long
    Dim lng相关ID As Long, blnGroup As Boolean
    Dim lng医嘱ID As Long, i As Integer, lng审核状态 As Long
    
    mblnRowChange = False
    vsAdvice.Redraw = flexRDNone
    
    If vsAdvice.RowData(lngRow) <> 0 Then
        '调用删除前外挂接口
        If Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            Call CreatePlugInOK(p住院医嘱下达, mint场合)
            On Error Resume Next
            If Not gobjPlugIn Is Nothing Then
                If gobjPlugIn.AdviceDeletBefor(glngSys, p住院医嘱下达, mlng病人ID, mlng主页ID, Val(vsAdvice.RowData(lngRow)), mint场合) = False Then
                    If err.Number = 0 Then Exit Sub
                End If
                Call zlPlugInErrH(err, "AdviceDeletBefor")
            End If
            If err.Number <> 0 Then err.Clear
            On Error GoTo 0
        End If
        
        If InStr(",5,6,", vsAdvice.TextMatrix(lngRow, COL_类别)) > 0 Then
            lng医嘱ID = vsAdvice.RowData(lngRow)
            lng相关ID = Val(vsAdvice.TextMatrix(lngRow, COL_相关ID))
            blnGroup = RowIn一并给药(lngRow)
            If blnGroup Then
                '先删除一并给药中的空行(一定要删)
                Call Get一并给药范围(lng相关ID, lngBegin, lngEnd)
                For i = lngEnd To lngBegin Step -1 '必须反向
                    If vsAdvice.RowData(i) = 0 Then Call DeleteRow(i)
                Next
                
                '删除之后当前行号可能变了
                lngRow = vsAdvice.FindRow(lng医嘱ID, lngBegin)
                lng审核状态 = Val(vsAdvice.TextMatrix(lngRow, COL_审核状态))
                '一并给药只删除当前行
                Call DeleteRow(lngRow)
                
                If lng审核状态 <> 0 Then
                    lngRow = vsAdvice.FindRow(lng相关ID, lngBegin)
                    Call ReSet审核状态图标(lngRow)
                End If
            Else
                '单独的成药：删除给药途径行及当前行
                i = vsAdvice.FindRow(CLng(vsAdvice.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                Call DeleteRow(i)
                Call DeleteRow(lngRow)
            End If
        ElseIf InStr(",D,F,K,", vsAdvice.TextMatrix(lngRow, COL_类别)) > 0 Then
            Call Delete检查手术输血(lngRow)
            Call DeleteRow(lngRow)
        ElseIf RowIn配方行(lngRow) Then
            '删除组成味药及煎法行:删除之后重新定位的当前行
            lngRow = Delete中药配方(lngRow)
            '删除当前行(中药用法行)
            Call DeleteRow(lngRow)
        ElseIf RowIn检验行(lngRow) Then
            lngRow = Delete检验组合(lngRow)
            Call DeleteRow(lngRow)
        Else
            Call DeleteRow(lngRow)
        End If
        
        mblnNoSave = True '标记为未保存
    Else
        '空行直接删除
        Call DeleteRow(lngRow)
    End If
    
    '重新定位行
    If vsAdvice.RowHidden(vsAdvice.Row) Then
        i = GetPreRow(vsAdvice.Row)
        If i = -1 Then i = GetNextRow(vsAdvice.Row)
        If i <> -1 Then vsAdvice.Row = i
    End If
    If blnGroup Then Call SetTag一并给药(vsAdvice.Row)
    Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
    
    mblnRowChange = True
    vsAdvice.Redraw = flexRDDirect
    Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
End Sub

Private Sub DeleteRow(ByVal lngRow As Long, Optional ByVal blnClear As Boolean, Optional blnDelID As Boolean = True)
'功能：删除表格中的一行,但不改变当前行
'参数：blnClear=是否仅清除该行内容,不删除
'      blnDelID=是否记录要删除的医嘱ID,原始中药配方
    Dim lngCol As Long, blnDraw As Boolean, blnChange As Boolean
    Dim lngBegin As Long, lngEnd As Long, k As Long
    Dim strExtData As String
    
    With vsAdvice
        lngCol = .Col
        blnDraw = .Redraw
        blnChange = mblnRowChange
        
        mblnRowChange = False
        .Redraw = flexRDNone
        
        '如果是删除临床路径一并给药中最后一行路径外项目，则需要处理给药途径行，改为路径内项目（以前的被删掉了）
        If mlng路径状态 <> 0 Then
            If Val(.TextMatrix(lngRow, COL_路径项目ID)) = 0 And InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                Call GetRowScope(lngRow, lngBegin, lngEnd)
                If lngBegin < lngRow And Val(.TextMatrix(lngBegin, COL_路径项目ID)) <> 0 Then   '路径外项目只能添加到一并给药的后面
                    For k = lngBegin To lngEnd - 1
                        If Val(.TextMatrix(k, COL_路径项目ID)) = 0 And k <> lngRow Then Exit For
                    Next
                    If k = lngEnd Then  '重设给药途径的路径相关信息
                        .TextMatrix(lngEnd, COL_路径项目ID) = .TextMatrix(lngBegin, COL_路径项目ID)
                        .TextMatrix(lngEnd, COL_路径执行ID) = .TextMatrix(lngBegin, COL_路径执行ID)
                        .TextMatrix(lngEnd, COL_路径执行方式) = .TextMatrix(lngBegin, COL_路径执行方式)
                        .TextMatrix(lngEnd, COL_路径项目分类) = .TextMatrix(lngBegin, COL_路径项目分类)
                    End If
                End If
            End If
        End If
        
        If .RowData(lngRow) <> 0 Then
            '调整序号
            Call AdviceSet医嘱序号(lngRow + 1, -1)
            
            '记录要删除的ID(除了才新增的)
            If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 And blnDelID Then
                mstrDelIDs = mstrDelIDs & "," & .RowData(lngRow)
                If Val(.TextMatrix(lngRow, COL_状态)) = -1 Then
                    mstrDelTempIDs = mstrDelTempIDs & .RowData(lngRow)
                End If
                If .TextMatrix(lngRow, COL_类别) = "K" And gbln血库系统 Then
                    mstrDel输血 = mstrDel输血 & "," & .RowData(lngRow)
                End If
            End If
        End If
            
        '如果为行1且仅剩行1或仅清除,则保留
        If Not (lngRow = .FixedRows And .Rows = .FixedRows + 1) And Not blnClear Then
            .RemoveItem lngRow
        Else
            If blnDelID = False Then strExtData = .TextMatrix(lngRow, COL_原始中药配方)
            '清除该行数据
            .RowData(lngRow) = Empty
            .Cell(flexcpText, lngRow, 0, lngRow, .Cols - 1) = "" '文字
            .Cell(flexcpData, lngRow, 0, lngRow, .Cols - 1) = Empty '数据
            .Cell(flexcpFontBold, lngRow, .FixedCols, lngRow, .Cols - 1) = False '粗体
            .Cell(flexcpForeColor, lngRow, .FixedCols, lngRow, .Cols - 1) = .ForeColor '文字色
            .Cell(flexcpForeColor, lngRow, 0, lngRow, .FixedCols - 1) = .ForeColorFixed '固定列文字色
            .Cell(flexcpBackColor, lngRow, 0, lngRow, .FixedCols - 1) = .BackColorFixed '固定列背景色
            Set .Cell(flexcpPicture, lngRow, 0, lngRow, .Cols - 1) = Nothing '单元图片
            Set .Cell(flexcpPicture, lngRow, COL_警示) = Nothing 'Pass警示灯
            
            If blnDelID = False Then .TextMatrix(lngRow, COL_原始中药配方) = strExtData
            
            '单元格边框
            .Select lngRow, .FixedCols, lngRow, COL_标志
            .CellBorder vbRed, 0, 0, 0, 0, 0, 0
        End If
        
        .Col = lngCol '因为有删除行,所以调用程序肯定有行定位,所以不必恢复行
        .Redraw = blnDraw
        mblnRowChange = blnChange
    End With
End Sub

Private Sub Delete检查手术输血(ByVal lngRow As Long, Optional ByVal bln申请序号 As Boolean, Optional ByRef lngTmpRow As Long)
'功能：1.删除检查组合项目的部位行
'      2.删除手术项目的附加手术行及麻醉项目行
'      3.删除输血项目的输血途径行
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim lngNo As Long
    Dim strRows As String
    Dim varArr As Variant
    Dim lngTmp As Long
    On Error GoTo errH
    With vsAdvice
        If bln申请序号 Then
            lngNo = Val(.TextMatrix(lngRow, COL_申请序号))
        End If
        If lngNo = 0 Then
            i = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), lngRow + 1, COL_相关ID) '不一定有,所以用查找
            If i <> -1 Then
                lngBegin = i
                For i = lngBegin To vsAdvice.Rows - 1
                    If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = vsAdvice.RowData(lngRow) Then
                        lngEnd = i
                    Else
                        Exit For
                    End If
                Next
                For i = lngEnd To lngBegin Step -1
                    Call DeleteRow(i)
                Next
            End If
        Else
            lngTmp = -1
            For i = .FixedRows To .Rows - 1
                If Val(.TextMatrix(i, COL_状态)) < 2 Then
                    If lngNo = Val(.TextMatrix(i, COL_申请序号)) Then
                        strRows = i & IIF(strRows = "", "", "," & strRows)
                    End If
                End If
                If i > lngRow Then
                    If lngNo <> Val(.TextMatrix(i, COL_申请序号)) Then
                        If lngTmp = -1 Then
                            lngTmp = vsAdvice.RowData(i)
                        End If
                    End If
                End If
            Next
            varArr = Split(strRows, ",")
            For i = 0 To UBound(varArr)
                Call DeleteRow(Val(varArr(i)))
            Next
            
            If lngTmp = -1 Then
                '先删除中间间隔的空行
                mblnRowChange = False
                For i = .Rows - 1 To .FixedRows Step -1
                    If .RowData(i) = 0 Then .RemoveItem i
                Next
                mblnRowChange = True
                .AddItem "", .Rows
                .Row = .Rows - 1
                .Col = .FixedCols
                lngTmpRow = .Row
            Else
                For i = .FixedRows To .Rows - 1
                    If lngTmp = Val(vsAdvice.RowData(i)) Then
                        lngTmp = i
                        Exit For
                    End If
                Next
                i = lngTmp
                If i <> -1 Then
                    .AddItem "", i
                    .Row = i
                    lngTmpRow = i
                Else
                    '先删除中间间隔的空行
                    mblnRowChange = False
                    For i = .Rows - 1 To .FixedRows Step -1
                        If .RowData(i) = 0 Then .RemoveItem i
                    Next
                    mblnRowChange = True
                    .AddItem "", .Rows
                    .Row = .Rows - 1
                    .Col = .FixedCols
                    lngTmpRow = .Row
                End If
            End If
        End If
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function Delete中药配方(ByVal lngRow As Long) As Long
'功能：删除中药配方的组成味药及煎法行
'参数：lngRow=中药配方用法行(可见)
'返回：删除之后重新定位的当前行(中药用法行)
    Dim lngBegin As Long, lngEnd As Long
    Dim lng医嘱ID As Long, i As Long
    
    lng医嘱ID = vsAdvice.RowData(lngRow)
    
    lngEnd = lngRow - 1
    For i = lngEnd To vsAdvice.FixedRows Step -1
        If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = lng医嘱ID Then
            lngBegin = i
        Else
            Exit For
        End If
    Next
    
    mblnRowChange = False
    For i = lngEnd To lngBegin Step -1
        Call DeleteRow(i)
    Next
    
    '因为是在前面删除,需要重新定位到中药用法行
    i = vsAdvice.FindRow(lng医嘱ID)
    vsAdvice.Row = i '不可能找不到

    mblnRowChange = True
    
    Delete中药配方 = vsAdvice.Row
End Function

Private Function Delete检验组合(ByVal lngRow As Long) As Long
'功能：删除一并采集的多个检验项目行
'参数：lngRow=采集方法行(可见)
'返回：删除之后重新定位的当前行(采集方法行)
    Dim lngBegin As Long, lngEnd As Long
    Dim lng医嘱ID As Long, i As Long
    
    lng医嘱ID = vsAdvice.RowData(lngRow)
    
    lngEnd = lngRow - 1
    For i = lngEnd To vsAdvice.FixedRows Step -1
        If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = lng医嘱ID Then
            lngBegin = i
        Else
            Exit For
        End If
    Next
    
    mblnRowChange = False
    For i = lngEnd To lngBegin Step -1
        Call DeleteRow(i)
    Next
    
    '因为是在前面删除,需要重新定位到采集方法行
    i = vsAdvice.FindRow(lng医嘱ID)
    vsAdvice.Row = i '不可能找不到
    
    mblnRowChange = True
    
    Delete检验组合 = vsAdvice.Row
End Function

Private Function Get检查部位方法(ByVal lngRow As Long) As String
'功能：获取指定行的检查部位方法串
'参数：lngRow=检查医嘱的可见行
'返回："部位名1;方法名1,方法名2|部位名2;方法名1,方法名2|...<vbTab>0-常规/1-床旁/2-术中"
'      如果是老的检查组合方式，或者是以前的单部位检查，则返回空以便程序识别
    Dim str部位 As String, str部位Last As String
    Dim str方法 As String, i As Long
    
    With vsAdvice
        For i = lngRow + 1 To .Rows - 1
            If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                If Val(.TextMatrix(i, COL_诊疗项目ID)) <> Val(.TextMatrix(lngRow, COL_诊疗项目ID)) Then Exit Function '老的方式
                
                If .TextMatrix(i, COL_标本部位) <> "" Then
                    If .TextMatrix(i, COL_标本部位) <> str部位Last And str部位Last <> "" Then
                        str部位 = str部位 & "|" & str部位Last & IIF(str方法 <> "", ";" & Mid(str方法, 2), "")
                        str方法 = ""
                    End If
                    If .TextMatrix(i, COL_检查方法) <> "" Then
                        str方法 = str方法 & "," & .TextMatrix(i, COL_检查方法)
                    End If
                    
                    str部位Last = .TextMatrix(i, COL_标本部位)
                End If
            Else
                Exit For
            End If
        Next
        If str部位Last <> "" Then
            str部位 = str部位 & "|" & str部位Last & IIF(str方法 <> "", ";" & Mid(str方法, 2), "")
        End If
        Get检查部位方法 = Mid(str部位, 2) & vbTab & Val(.TextMatrix(lngRow, COL_执行标记))
    End With
End Function

Private Function Get手术附加IDs(ByVal lngRow As Long) As String
'功能：获取指定手术行的附加手术及麻醉项目ID串
'返回："手术ID1,手术ID2,...;麻醉ID",其中可能没有附加手术和麻醉
    Dim strTmp As String, lng麻醉ID As Long, i As Long
    
    i = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), lngRow + 1, COL_相关ID)
    If i <> -1 Then
        For i = i To vsAdvice.Rows - 1
            If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = vsAdvice.RowData(lngRow) Then
                If vsAdvice.TextMatrix(i, COL_类别) = "G" Then
                    lng麻醉ID = Val(vsAdvice.TextMatrix(i, COL_诊疗项目ID))
                Else
                    strTmp = strTmp & "," & Val(vsAdvice.TextMatrix(i, COL_诊疗项目ID))
                End If
            Else
                Exit For
            End If
        Next
    End If
    Get手术附加IDs = Mid(strTmp, 2) & ";" & IIF(lng麻醉ID = 0, "", lng麻醉ID)
End Function


Private Function Get手术附加必要时(ByVal lngRow As Long) As String
'功能：获取指定手术行的附加手术和是否必要时
'返回：手术ID1:必要时,手术ID2:必要时,...
    Dim strTmp As String, i As Long
    
    i = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), lngRow + 1, COL_相关ID)
    If i <> -1 Then
        For i = i To vsAdvice.Rows - 1
            If Val(vsAdvice.TextMatrix(i, COL_相关ID)) = vsAdvice.RowData(lngRow) Then
                If vsAdvice.TextMatrix(i, COL_类别) <> "G" Then
                    strTmp = strTmp & "," & Val(vsAdvice.TextMatrix(i, COL_诊疗项目ID)) & ":" & Val(vsAdvice.TextMatrix(i, COL_执行标记))
                End If
            Else
                Exit For
            End If
        Next
    End If
    Get手术附加必要时 = Mid(strTmp, 2)
End Function


Private Function Get中药配方IDs(ByVal lngRow As Long) As String
'功能：获取中药配方的组成味药及煎法ID串
'返回："中药规格ID1,单量1,脚注1;中药规格ID2,单量2,脚注2;...|煎法ID|中药形态|付数|药房ID"
    Dim lng煎法ID As Long, str中药IDs As String, i As Long, lng形态 As Long
    Dim lng付数 As Long, lng药房ID As Long
    Dim strTmp As String
    
    With vsAdvice
        lng形态 = Val(.TextMatrix(lngRow, COL_中药形态))    '用法行
        For i = lngRow - 1 To .FixedRows Step -1
            If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                If .TextMatrix(i, COL_类别) = "E" Then
                    lng煎法ID = Val(.TextMatrix(i, COL_诊疗项目ID))
                    strTmp = .TextMatrix(i, COL_标本部位) '代表中药的 煎量
                ElseIf .TextMatrix(i, COL_类别) = "7" Then
                    str中药IDs = Val(.TextMatrix(i, COL_收费细目ID)) & "," & _
                        .TextMatrix(i, COL_单量) & "," & .TextMatrix(i, COL_医生嘱托) & _
                        ";" & str中药IDs
                    If lng药房ID = 0 Then
                        lng药房ID = Val(.TextMatrix(i, COL_执行科室ID))
                        lng付数 = Val(.TextMatrix(i, COL_总量))
                    End If
                End If
            Else
                Exit For
            End If
        Next
        Get中药配方IDs = Mid(str中药IDs, 1, Len(str中药IDs) - 1) & "|" & lng煎法ID & "|" & lng形态 & "|" & lng付数 & "|" & lng药房ID & "|" & strTmp
    End With
End Function

Private Function Get检验组合IDs(ByVal lngRow As Long) As String
'功能：获取一并采集的检验组合项目ID及标本
'返回：'      检验组合="项目ID1,项目ID2,...;检验标本" 如果是新版LIS的模式则是："项目ID1|指标1|指标2...,项目ID2|指标1|指标2...,...;检验标本"
    Dim str项目IDs As String, str标本 As String, i As Long
    Dim j As Long
    
    With vsAdvice
        For i = lngRow - 1 To .FixedRows Step -1
            If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                If Val(.TextMatrix(i, COL_组合项目ID)) = 0 And mblnNewLIS Then
                    For j = lngRow - 1 To .FixedRows Step -1
                        If Val(.TextMatrix(j, COL_相关ID)) = .RowData(lngRow) Then
                            If Val(.TextMatrix(j, COL_组合项目ID)) = Val(.TextMatrix(i, COL_诊疗项目ID)) And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                                str项目IDs = "|" & Val(.TextMatrix(j, COL_诊疗项目ID)) & str项目IDs
                            End If
                        Else
                            Exit For
                        End If
                    Next
                    str项目IDs = "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & str项目IDs
                Else
                    If Not mblnNewLIS Then
                        str项目IDs = "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & str项目IDs
                    End If
                End If
                str标本 = .TextMatrix(i, COL_标本部位)
            Else
                Exit For
            End If
        Next
    End With
    Get检验组合IDs = Right(str项目IDs, Len(str项目IDs) - 1) & ";" & str标本
End Function

Private Function RowIn检验行(ByVal lngRow As Long) As Boolean
'功能：判断指定行是否属于检验组合中的一行
'说明：不管行当前是否隐藏
    If lngRow = -1 Then Exit Function
    If vsAdvice.RowData(lngRow) = 0 Then Exit Function
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_类别) = "E" And Val(.TextMatrix(lngRow, COL_相关ID)) = 0 Then
            '采集方法行
            If .TextMatrix(lngRow - 1, COL_类别) = "C" _
                And Val(.TextMatrix(lngRow - 1, COL_相关ID)) = .RowData(lngRow) Then
                RowIn检验行 = True: Exit Function
            End If
        ElseIf .TextMatrix(lngRow, COL_类别) = "C" And Val(.TextMatrix(lngRow, COL_相关ID)) <> 0 Then
            '检验项目行
            RowIn检验行 = True: Exit Function
        End If
    End With
End Function

Private Function RowIn配方行(ByVal lngRow As Long) As Boolean
'功能：判断指定行是否属于中药配方中的一行
'说明：不管行当前是否隐藏
    If lngRow = -1 Then Exit Function
    If vsAdvice.RowData(lngRow) = 0 Then Exit Function
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_类别) = "E" Then
            If Val(.TextMatrix(lngRow, COL_相关ID)) = 0 Then
                '用法行
                If Val(.TextMatrix(lngRow - 1, COL_相关ID)) = .RowData(lngRow) _
                    And .TextMatrix(lngRow - 1, COL_类别) = "E" Then
                    RowIn配方行 = True: Exit Function
                End If
            Else
                '煎法行
                If .TextMatrix(lngRow - 1, COL_类别) = "7" _
                    And Val(.TextMatrix(lngRow - 1, COL_相关ID)) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                    RowIn配方行 = True: Exit Function
                End If
            End If
        ElseIf .TextMatrix(lngRow, COL_类别) = "7" And Val(.TextMatrix(lngRow, COL_相关ID)) <> 0 Then
            '中药行
            RowIn配方行 = True: Exit Function
        End If
    End With
End Function

Private Function RowIn一并给药(ByVal lngRow As Long) As Boolean
'功能：判断指定行是否在一并给药的范围中
'参数：lngRow=可见的行,可能是空行
'说明：一并给药的范围中可能存在空行
    Dim lngPreRow As Long, lngNextRow As Long
    Dim lng相关ID As Long, blnGroup As Boolean, i As Long
    
    lngPreRow = GetPreRow(lngRow)
    lngNextRow = GetNextRow(lngRow)

    With vsAdvice
        If .RowData(lngRow) = 0 Then
            If lngPreRow <> -1 And lngNextRow <> -1 Then
                If Val(.TextMatrix(lngPreRow, COL_相关ID)) = Val(.TextMatrix(lngNextRow, COL_相关ID)) _
                    And Val(.TextMatrix(lngPreRow, COL_相关ID)) <> 0 _
                    And InStr(",5,6,", .TextMatrix(lngPreRow, COL_类别)) > 0 _
                    And InStr(",5,6,", .TextMatrix(lngNextRow, COL_类别)) > 0 Then
                    blnGroup = True
                End If
            End If
        ElseIf InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 _
            And Val(.TextMatrix(lngRow, COL_相关ID)) <> 0 Then
            
            lng相关ID = Val(.TextMatrix(lngRow, COL_相关ID))
            If lngPreRow <> -1 Then
                If InStr(",5,6,", .TextMatrix(lngPreRow, COL_类别)) > 0 _
                    And Val(.TextMatrix(lngPreRow, COL_相关ID)) = lng相关ID Then blnGroup = True
            End If
            If Not blnGroup And lngNextRow <> -1 Then
                If InStr(",5,6,", .TextMatrix(lngNextRow, COL_类别)) > 0 _
                    And Val(.TextMatrix(lngNextRow, COL_相关ID)) = lng相关ID Then blnGroup = True
            End If
        End If
    End With
    RowIn一并给药 = blnGroup
End Function

Private Function CheckAdviceOperation(Optional ByVal lng婴儿 As Long = -1) As Boolean
'功能：下达术后医嘱时，检查病人最后的手术医嘱是否已执行
'返回：具体的提示信息，为空表示允许继续
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim strMsg As String
    Dim lngBaby As Long
    
    CheckAdviceOperation = True
    
    If Val(zlDatabase.GetPara("手术完成后下达术后医嘱", glngSys, p住院医嘱下达)) = 0 Then Exit Function
        
    On Error GoTo errH
    
    If lng婴儿 = -1 Then
        lngBaby = cbo婴儿.ListIndex
    Else
        lngBaby = lng婴儿
    End If
    
    strSQL = "Select Max(序号) as 序号 From 病人医嘱记录" & _
        " Where 诊疗类别='F' And 相关ID is NULL And 前提ID is NULL" & _
        " And 开始执行时间 is Not NULL And Nvl(医嘱状态,0) Not IN(0,1,2,4)" & _
        " And 病人ID=[1] And 主页ID=[2] And Nvl(婴儿,0)=[3]"
    strSQL = "Select A.姓名,A.婴儿,A.医嘱内容,B.执行状态" & _
        " From 病人医嘱记录 A,病人医嘱发送 B" & _
        " Where A.ID=B.医嘱ID(+) And A.序号=(" & strSQL & ")" & _
        " And A.病人ID=[1] And A.主页ID=[2] And Nvl(A.婴儿,0)=[3]" & _
        " Order by B.发送号 Desc"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, lngBaby)
    If Not rsTmp.EOF Then
        If NVL(rsTmp!执行状态, 0) <> 1 Then
            MsgBox rsTmp!姓名 & IIF(NVL(rsTmp!婴儿, 0) > 0, "之子" & rsTmp!婴儿, "") & "的""" & rsTmp!医嘱内容 & """尚未执行完成，不能下达术后医嘱。", vbInformation, gstrSysName
            CheckAdviceOperation = False: Exit Function
        End If
    End If
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function AdviceSet过敏试验(ByVal lngRow As Long, ByVal lng皮试ID As Long) As Boolean
'功能：自动增加皮试行
'参数：lngRow=当前输入行,已经输入西药或中成药
'      lng皮试ID=要增加的皮试项目ID
'说明：自动增加之后,当前行及光标仍定位在已刚输入的药品行位置
    Dim rsInput As New ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim intIndex As Integer
    
    On Error GoTo errH
        
    '类别ID,名称,诊疗项目ID,收费细目ID,规格,产地
    strSQL = "Select 类别 as 类别ID,名称,ID as 诊疗项目ID,NULL as 收费细目ID,NULL as 规格,NULL as 产地,NULL as 项目特性 From 诊疗项目目录 Where ID=[1]"
    Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng皮试ID)
        
    '寻找实际要加入皮试的行:一并给药的情况
    With vsAdvice
        For i = lngRow - 1 To .FixedRows - 1 Step -1 '可能是增加在最前面
            If Val(.TextMatrix(i, COL_相关ID)) <> Val(.TextMatrix(lngRow, COL_相关ID)) Then
                lngRow = i + 1: Exit For '新增行的行号
            End If
        Next
    End With
    
    '加入空行
    vsAdvice.AddItem "", lngRow
   
    intIndex = cbo期效.ListIndex

    Call zlControl.CboSetIndex(cbo期效.hwnd, 1)
    '增加皮试
    Call AdviceInput(rsInput, lngRow, True)
    Call zlControl.CboSetIndex(cbo期效.hwnd, intIndex)
    
    '重新定位到输入的药品行
    mblnRowChange = False
    vsAdvice.Row = vsAdvice.Row + 1
    mblnRowChange = True
    
    AdviceSet过敏试验 = True
    Exit Function
errH:
    If ErrCenter = 1 Then Resume
    Call SaveErrLog
End Function

Private Function AdviceInput(rsInput As ADODB.Recordset, ByVal lngRow As Long, Optional ByVal blnBy皮试 As Boolean) As Boolean
'功能：根据新输的诊疗项目(新增或更换)设置缺省的医嘱数据
'参数：rsInput=输入或选择返回的记录集,lngRow=当前输入行
'返回：本次录入是否有效
    Dim intType As Integer
    Dim str过敏 As String, blnGroup, bln皮试行 As Boolean
    Dim lng用法ID As Long, lngGroupRow, lng皮试ID As Long
    Dim lngPreRow As Long, lngNextRow As Long, lngRowID As Long
    Dim strExtData As String, strAppend As String
    Dim strMsg As String, vMsg As VbMsgBoxResult
    Dim str摘要 As String, i As Long, lng审核状态 As Long, str摘要Out As String
    Dim objControl As CommandBarControl
    Dim lngPreRow中药房  As Long, lng药品ID As Long
    Dim t_Pati As TYPE_PatiInfoEx
    Dim blnOK As Boolean, bln连续用药 As Boolean
    Dim str手术部位 As String
    Dim lngBabyEdit As Long
    Dim strIDs1 As String, strIDs2 As String, str医嘱内容 As String
    Dim lngBegin As Long, lngEnd As Long, sng天数 As Single
    Dim lngAppType As Long '申请单应用
    Dim objAppPages()  As clsApplicationData
    Dim rsCard As ADODB.Recordset
    Dim lngTmpRow As Long
    Dim bln备血 As Boolean '是否为备血医嘱 备血=0，用血=1,存于K类别医嘱行的 检查方法  字段;备血-采集方式 / 用血-输血途径
    Dim lngApplyID As Long
    Dim strWhere As String
    
    On Error GoTo errH
        
    lngPreRow = GetPreRow(lngRow) '取上一有效行,某些内容缺省与上一行相同
    lngNextRow = GetNextRow(lngRow) '取下一有效行
    
    '项目附加数据输入及输入合法性检查
    '---------------------------------------------------------------------------------------------------------------
    txt医嘱内容.Text = rsInput!名称 '暂时显示
    
    '药品处方职务检查(护士站在保存时检查,路径生成时不检查)
    If mint场合 <> 1 Then
        If InStr(",5,6,7,", rsInput!类别ID) > 0 Then
            If mbytUseType <> 1 Then
                strMsg = CheckOneDuty(rsInput!名称, NVL(rsInput!处方职务ID), UserInfo.姓名, InStr(",1,2,", mstr付款码) > 0 And mstr付款码 <> "")
                If strMsg <> "" Then
                    vsAdvice.Refresh
                    MsgBox strMsg, vbInformation, gstrSysName
                    vsAdvice.Refresh: Exit Function
                End If
            End If
            If mblnPass Then
                Call gobjPass.zlPassAdviceInput(mobjPassMap, rsInput!诊疗项目ID, NVL(rsInput!收费细目ID, 0)) '要点提示 品种下达时，收费细目ID为NULL
            End If
        End If
    End If
    
    If CheckedPathSended = False Then Exit Function
    lngBabyEdit = CheckBabyEdit
    If lngBabyEdit = 1 Then
        MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
        Exit Function
    ElseIf lngBabyEdit = 2 Then
        MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
        Exit Function
    End If
    
    '医保病人输入内容时的提示：非医保病人也要调(Or And mint险类 <> 0)
    If InStr(",7,8,9,", rsInput!类别ID) = 0 Then '成套，配方，单味中药不在这里提示
        cbo期效.Locked = True
        str摘要 = gclsInsure.GetItemInfo(mint险类, mlng病人ID, NVL(rsInput!收费细目ID, 0), "", 0, "", rsInput!诊疗项目ID & "||2")
        cbo期效.Locked = False
    End If
    
    With vsAdvice
        '术后医嘱下达检查
        If rsInput!类别ID = "Z" And rsInput!项目特性 = "术后" Then
            If Not CheckAdviceOperation Then .Refresh: Exit Function
        End If
        If rsInput!类别ID = "Z" And rsInput!项目特性 = "会诊" Then
            If CanUseApply("Z", "会诊") Then
                Call Apply会诊(lngRow, 0, 0, Val(rsInput!诊疗项目ID & ""))
                Exit Function
            End If
        End If
        '检验项目：采集方法判断
        If rsInput!类别ID = "C" Then
            '所有数据中取一个缺省的采集方法,同时判断是否有采集方法数据
            lng用法ID = Get缺省用法ID(6, 2, , mlng病人性质)
            If lng用法ID = 0 Then
                .Refresh
                MsgBox "没有可用的标本采集方法,请先到诊疗项目管理中设置！", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            '缺省与上一行相同
            If lngPreRow <> -1 Then
                If RowIn检验行(lngPreRow) Then
                    If Val(.TextMatrix(lngPreRow, COL_是否停用)) = 0 Then lng用法ID = Val(.TextMatrix(lngPreRow, COL_诊疗项目ID))
                End If
            End If
        End If
        
        '中药配方：给成与中药用法判断
        If InStr(",7,8,", rsInput!类别ID) > 0 Then
            If rsInput!类别ID = "8" Then
                If GetGroupCount(rsInput!诊疗项目ID, IIF(mlng病人性质 = 1, 1, 2), False, mlng病人性质) = 0 Then
                    .Refresh
                    MsgBox """" & rsInput!名称 & """是一个中药配方，但没有设置有效的组成中药。" & vbCrLf & "请先到诊疗项目管理中设置。", vbInformation, gstrSysName
                    .Refresh: Exit Function
                End If
                
                '部份药无效的提示
                strMsg = GetGroupNone(rsInput!诊疗项目ID, IIF(mlng病人性质 = 1, 1, 2))
                If strMsg <> "" Then
                    .Refresh
                    MsgBox "配方""" & rsInput!名称 & """中以下药品已撤档或服务对象不匹配：" & _
                        vbCrLf & vbCrLf & vbTab & strMsg & vbCrLf & vbCrLf & "这些药品将不会出现在配方中。", vbInformation, gstrSysName
                    .Refresh
                End If
            End If
        
            '所有数据中取一个缺省的中药用法,同时判断是否有中药用法数据
            lng用法ID = Get缺省用法ID(4, 2, , mlng病人性质)
            If lng用法ID = 0 Then
                .Refresh
                MsgBox "没有可用的中药用(服)法,请先到诊疗项目管理中设置！", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            '中药用法缺省与上一行相同
            If RowIn配方行(lngPreRow) Then
                If Val(.TextMatrix(lngPreRow, COL_是否停用)) = 0 Then lng用法ID = Val(.TextMatrix(lngPreRow, COL_诊疗项目ID))
            End If
        End If
        
        '输血医嘱：输血途径判断
        If rsInput!类别ID = "K" Then
            If gbln血库系统 Then
                vMsg = frmMsgBox.ShowMsgBox("请选择输血医嘱类型。", Me, , 2)
                If vMsg = vbNo Then
                    bln备血 = True
                ElseIf vMsg = vbCancel Then
                    Exit Function
                End If
            Else
                bln备血 = True
            End If
            '所有数据中取一个缺省的输血途径
            strWhere = ""
            If bln备血 = False And gbln血库系统 = True Then
                strWhere = " And NVL(执行分类,0)=1 "
            End If
            lng用法ID = Get缺省用法ID(IIF(bln备血 And gbln血库系统, 9, 8), 2, strWhere, mlng病人性质)
            If lng用法ID = 0 Then
                .Refresh
                MsgBox "没有可用的输血" & IIF(bln备血 And gbln血库系统, "采集方法", "途径") & ",请先到诊疗项目管理中设置！", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            '缺省与上一行相同
            If lngPreRow <> -1 Then
                If .TextMatrix(lngPreRow, COL_类别) = "K" And Val(.TextMatrix(lngPreRow, COL_检查方法)) = IIF(bln备血, "0", "1") Then
                    i = .FindRow(CStr(.RowData(lngPreRow)), lngPreRow + 1, COL_相关ID)
                    If i <> -1 Then
                        If Val(.TextMatrix(i, COL_是否停用)) = 0 Then lng用法ID = Val(.TextMatrix(i, COL_诊疗项目ID))
                    End If
                End If
            End If
        End If
        
        '中西成药：给药途径判断
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            '给药途径缺省与上一个行相同剂型的相同
            If lngPreRow <> -1 And Not IsNull(rsInput!药品剂型) Then
                If InStr(",5,6,", .TextMatrix(lngPreRow, COL_类别)) > 0 And .TextMatrix(lngPreRow, COL_药品剂型) = NVL(rsInput!药品剂型) Then
                    i = .FindRow(CLng(.TextMatrix(lngPreRow, COL_相关ID)), lngPreRow + 1)
                    If i <> -1 Then
                        If Val(.TextMatrix(i, COL_是否停用)) = 0 Then lng用法ID = Val(.TextMatrix(i, COL_诊疗项目ID))
                    End If
                End If
            End If
        End If
        
        '中西成药：过敏试验检查
        If InStr(",5,6,", rsInput!类别ID) > 0 And gint过敏登记有效天数 <> 0 Then
            str过敏 = Check过敏试验(Me, txt医嘱内容, mlng病人ID, rsInput!诊疗项目ID, rsInput!名称, mbln自动皮试, lng皮试ID, mlng主页ID, Val("" & rsInput!收费细目ID), bln连续用药, msk开始时间.Text, blnOK)
            If Not bln连续用药 Then
                If str过敏 <> "" Then
                    .Refresh
                    If blnOK Then
                        MsgBox str过敏, vbInformation, gstrSysName
                        .Refresh: Exit Function
                    Else
                        If MsgBox(str过敏, vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                            .Refresh: Exit Function
                        End If
                    End If
                End If
                
                '自动添加皮试
                If lng皮试ID <> 0 Then
                    '先检查是否已有该皮试(在有效时间内手工或自动添加的,包括免试皮试)
                    i = .FixedRows - 1
                    Do
                        i = .FindRow(CStr(lng皮试ID), i + 1, COL_诊疗项目ID)
                        If i <> -1 Then
                            If Not .RowHidden(i) Then
                                If Int(CDate(.Cell(flexcpData, i, COL_开始时间))) >= Int(zlDatabase.Currentdate - gint过敏登记有效天数) Then
                                    bln皮试行 = True: Exit Do '记录以作标志,当前行输入完成后再增加
                                End If
                            End If
                        End If
                    Loop Until i = -1
                End If
            End If
        End If
        
        '中西成药：一并给药的判断,新行缺省是按下一并的（如果上一行是一并）
        blnGroup = RowIn一并给药(lngRow) And Not blnBy皮试
        If blnGroup Then
            If rsInput!类别ID = "9" Then
                .Refresh
                MsgBox "不能在一并给药的药品中直接输入成套方案。", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            
            If .RowData(lngRow) = 0 Then
                '一并给药中的待输入空行：只有插入在一并给药的中间,才能自动成为一并给药
                lngGroupRow = lngPreRow
            Else
                If lngPreRow = -1 Then  '取当前行的下一行，避免在操作已有医嘱时重选诊疗项目操作时，当前行的内容被删除，后续过程无法取到其中的值
                    lngGroupRow = vsAdvice.FindRow(.TextMatrix(lngRow, COL_相关ID), lngRow + 1, COL_相关ID)
                Else
                    '一并给药中的药品行：可能是第一行或最后一行
                    If InStr(",5,6,", .TextMatrix(lngPreRow, COL_类别)) > 0 _
                        And Val(.TextMatrix(lngPreRow, COL_相关ID)) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                        lngGroupRow = lngPreRow
                    Else
                        lngGroupRow = lngNextRow
                    End If
                End If
            End If
            
            '一并给药的,类别，期效必须相同
            If Decode(rsInput!类别ID, "5", "Y", "6", "Y", "N") <> Decode(.TextMatrix(lngGroupRow, COL_类别), "5", "Y", "6", "Y", "N") Then
                .Refresh
                MsgBox "该组一并给药的药品必须都为西成药或中成药。", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            If zlCommFun.GetNeedName(cbo期效.Text) <> .TextMatrix(lngGroupRow, COL_期效) Then
                .Refresh
                MsgBox "该组一并给药的药品必须都为""" & .TextMatrix(lngGroupRow, COL_期效) & """。", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            
            i = .FindRow(CLng(.TextMatrix(lngGroupRow, COL_相关ID)), lngGroupRow + 1)
            lng用法ID = Val(.TextMatrix(i, COL_诊疗项目ID)) '一并给药的给药途径相同
            
            '检查一并给药的的给药途径是否适合于当前输入药品(非一并给药的缺省用法在输入函数中作了判断处理)
            If Not Check适用用法(lng用法ID, rsInput!诊疗项目ID, 2, rsInput!收费细目ID, mlng病人性质) Then
                .Refresh
                MsgBox "一并的给药途径为""" & .TextMatrix(i, col_医嘱内容) & """，不适用于当前输入药品。", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
        End If
    
        '成套项目
        If rsInput!类别ID = "9" Then
            If GetGroupCount(rsInput!诊疗项目ID, IIF(mlng病人性质 = 1, 1, 2), , mlng病人性质) = 0 Then
                .Refresh
                MsgBox """" & rsInput!名称 & """是一个成套方案，但没有设置有效的组成项目。" & vbCrLf & "请先到诊疗项目管理中设置。", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            strExtData = frmSchemeSelect.ShowMe(Me, rsInput!诊疗项目ID, IIF(mlng病人性质 = 1, 1, 2), mlng病人科室id, mstr性别)
            If strExtData = "" Then .Refresh: Exit Function
        End If
    
        '需要输入更多数据的一些项目
        '---------------------------------------------------------------------------------------------------------------
        intType = -1
        lngAppType = -1
        If rsInput!类别ID <> "9" Then strExtData = ""
        If rsInput!类别ID = "D" Then
            '检查项目：都要扩展编辑了，不象以前还有单部位项目
            If gblnIn必用 And CanUseApply("D", , Val(rsInput!诊疗项目ID & "")) Then
                lngAppType = 0
            Else
                intType = 0
            End If
        ElseIf rsInput!类别ID = "F" Then
            If gblnIn必用 And CanUseApply("F") Then
                lngAppType = 2
            Else
                '手术：需要输入麻醉项目，及可选择附加手术
                intType = 1
            End If
            '如果参数启用了，检查手术的开单权
            If gbln手术授权管理 Then
                If CheckUserEmpower(rsInput!诊疗项目ID) = False Then
                    MsgBox "当前操作员不具备手术""" & rsInput!名称 & """的开单权，不允许下达。", vbInformation, Me.Caption
                    Exit Function
                End If
            End If
        ElseIf InStr(",7,8,", rsInput!类别ID) > 0 Then
            '中药配方(单味草药当配方处理)
            intType = 2
        ElseIf rsInput!类别ID = "C" Then
            If gblnIn必用 And CanUseApply("C", , Val(rsInput!诊疗项目ID & ""), rsInput!编码 & "") Then
                lngAppType = 3
            Else
                '输入一并采集的多个检验项目及检验标本
                intType = 4
                strExtData = rsInput!诊疗项目ID & ";" & NVL(rsInput!规格) '项目;标本
            End If
        ElseIf rsInput!类别ID = "K" Or rsInput!类别ID = "E" Or rsInput!类别ID = "Z" Then
            If gblnIn必用 And CanUseApply(rsInput!类别ID) Then
                lngAppType = 1
            ElseIf CheckApplication(Val(rsInput!诊疗项目ID & ""), 2) Then
                '治疗和输血类的如果有申请附项则填写
                intType = 5
            End If
        End If
        '判断当前项目是否绑定有自定义申请单，如果有则弹出
        lngApplyID = GetApplyCustom(Val(rsInput!诊疗项目ID & ""))
        If intType <> -1 And lngApplyID = 0 Then
            With t_Pati
                .bln医保 = InStr(",1,2,", mstr付款码) > 0 And mstr付款码 <> ""
                .int险类 = mint险类
                .int婴儿 = mint婴儿
                .lng病人ID = mlng病人ID
                .lng主页ID = mlng主页ID
                .lng病人科室ID = mlng病人科室id
                .str性别 = mstr性别
            End With
            
            If intType = 2 Then
                lngPreRow中药房 = GetPreRow中药房(lngRow)
                lng药品ID = Val("" & rsInput!收费细目ID)   '一组配方时为空
            End If
            On Error Resume Next
            '改造接口：添加了mbytUseType的传入
            If intType = 2 Then
                blnOK = frmAdviceFormula.ShowMe(Me, gclsInsure, txt医嘱内容.hwnd, t_Pati, mint场合, mbytUseType, cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), _
                            2, rsInput!诊疗项目ID, strExtData, str摘要Out, lng药品ID, lngPreRow中药房, mstr药品价格等级)
            ElseIf intType <> -1 Then
                blnOK = frmAdviceEditEx.ShowMe(Me, txt医嘱内容.hwnd, t_Pati, mint场合, intType, mbytUseType, cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), _
                            2, mblnNewLIS, True, rsInput!诊疗项目ID, strExtData, strAppend, GetAdviceAppendItem, , str手术部位)
            End If
            
            On Error GoTo 0
            If Not blnOK Then Exit Function
            If intType = 2 Then str摘要 = str摘要Out
        End If
        
        If lngAppType <> -1 Or lngApplyID <> 0 Then
            On Error Resume Next
            If lngApplyID <> 0 Then
                FuncApplyCustom 0, lngApplyID, , Val(rsInput!诊疗项目ID & "")
            ElseIf lngAppType = 0 Then
                blnOK = ApplyNew检查申请(0, rsInput!诊疗项目ID & "", objAppPages())
            ElseIf lngAppType = 1 Then
                blnOK = ApplyNew输血申请(0, rsInput!诊疗项目ID & "", rsCard, bln备血)
            ElseIf lngAppType = 2 Then
                blnOK = ApplyNew手术申请(0, rsInput!诊疗项目ID & "", rsCard)
            ElseIf lngAppType = 3 Then
                blnOK = ApplyNew检验申请(0, rsInput!编码 & "", rsCard)
            End If
            On Error GoTo errH
            If Not blnOK Then Exit Function
        End If
        
        '修改已有项目时,先删除当前医嘱的内容
        '---------------------------------------------------------------------------------------------------------------
        If .RowData(lngRow) <> 0 Then
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '西成药、中成药
                If Not blnGroup Then
                    '单个成药删除给药途径行,并清除当前行
                    i = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    Call DeleteRow(i)
                    Call DeleteRow(lngRow, True)
                Else
                    '一组成药时,只清除当前行
                    lng审核状态 = Val(vsAdvice.TextMatrix(lngRow, COL_审核状态))
                    Call DeleteRow(lngRow, True)
                    If lng审核状态 <> 0 Then Call ReSet审核状态图标(lngGroupRow)
                End If
            ElseIf InStr(",D,F,K,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '这个分支只处理检查申请单，因为检查申请单帮可能产生多组医嘱，检查申请单产生的医嘱加到表格最后
                If .TextMatrix(lngRow, COL_类别) = "D" And 0 <> Val(.TextMatrix(lngRow, COL_申请序号)) Then
                    Call Delete检查手术输血(lngRow, True, lngTmpRow)
                    lngRow = lngTmpRow
                Else
                    '检查组合项目，手术项目，输血医嘱
                    '删除部位行，或手术附加行(附加手术,麻醉项目)，或输血途径
                    Call Delete检查手术输血(lngRow)
                    '清除当前行
                    Call DeleteRow(lngRow, True)
                End If
            ElseIf RowIn配方行(lngRow) Then
                '中药配方：顺序(序号)要求必须严格控制
                '删除组成味药及煎法行:删除之后重新定位的当前行
                lngRow = Delete中药配方(lngRow)
                '清除当前行(中药用法行)
                Call DeleteRow(lngRow, True)
            ElseIf RowIn检验行(lngRow) Then
                If lngAppType = 3 Then
                    Call Delete检验申请单(lngRow, True, lngTmpRow)
                    lngRow = lngTmpRow
                Else
                    '删除检验项目行:删除之后重新定位的当前行
                    lngRow = Delete检验组合(lngRow)
                    '清除当前行(采集方法行)
                    Call DeleteRow(lngRow, True)
                End If
            Else
                '其它项目直接清除当前行内容
                Call DeleteRow(lngRow, True)
            End If
        End If
        
        '当前行新增医嘱(lngRow可能会改变)
        '---------------------------------------------------------------------------------------------------------------
        If InStr(",7,8,", rsInput!类别ID) > 0 Then
            '中药配方(单味草药当配方处理):处理之后重新定位的当前行
            lngRow = AdviceSet中药配方(rsInput!诊疗项目ID, lngRow, lng用法ID, strExtData, , str摘要)
            
            If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
        ElseIf rsInput!类别ID = "9" Then
            '成套医嘱需要分解为多个项目加入(成套项目由于有多个医嘱，SetPathRows已在AdviceSet成套项目中处理)
            Call AdviceSet成套项目(1, rsInput!诊疗项目ID, lngRow, strExtData)
        ElseIf rsInput!类别ID = "C" Then
            If lngAppType = 3 Then
                Call AdviceSet检验申请(lngRow, rsCard)
            Else
                '检验组合
                lngRow = AdviceSet检验组合(lngRow, lng用法ID, strExtData, , str摘要)
                If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
            End If
        ElseIf lngAppType = 0 Then
            '加入检查申请单
            lngRow = AdviceSet检查申请(lngRow, objAppPages())
        ElseIf lngAppType = 1 Then
            lngRow = AdviceSet输血申请(lngRow, rsCard)
        ElseIf lngAppType = 2 Then
            lngRow = AdviceSet手术申请(lngRow, rsCard)
        Else
            '输血医嘱检查，必须中级及以上专业技术职务的医师才允许下达
            If rsInput!类别ID & "" = "K" And gbln输血申请中级以上 Then
                If UserInfo.专业技术职务 <> "主治医师" And UserInfo.专业技术职务 <> "主任医师" And UserInfo.专业技术职务 <> "副主任医师" Then
                    MsgBox "启用了输血分级管理后，输血医嘱只有中级及以上专业技术职务医师才能下达。", vbInformation, Me.Caption
                    Exit Function
                End If
            End If
            '中、西成药，卫材，检查(组合)，手术(组合)，输血，及其它诊疗项目
            Call AdviceSet诊疗项目(rsInput, lngRow, lng用法ID, lngGroupRow, strExtData, str摘要, str手术部位, bln连续用药, strAppend, bln备血)
            
            '在设置为一并之前处理
            If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
            
            '自动设置一并给药
            If InStr(",5,6,", rsInput!类别ID) > 0 Then
                i = CheckAutoMerge(lngRow)
                If i = 1 Then
                    mblnRowMerge = True
                ElseIf i = 2 Then
                    mblnRowMerge = False
                    Set objControl = cbsMain.FindControl(, conMenu_Merge, , True)
                    objControl.Checked = False
                End If
                If Not RowIn一并给药(lngRow) Then
                    If mblnRowMerge Then
                        '手工使一并给药
                        lngRowID = .RowData(lngRow)
                        Call MergeRow(lngPreRow, lngRow) '本来就是显示当前行的内容,不用再强行RowChange
                        lngRow = .FindRow(lngRowID, lngPreRow + 1)
                        '抗菌药物新增一行时一并给药的，应该缺省与上一行的“用药目的”和“用药理由”相同。
                        If Val(.TextMatrix(lngRow, COL_抗菌等级)) <> 0 Then
                            If lngRow > 1 Then
                                txt用药理由.Text = .TextMatrix(lngRow - 1, COL_用药理由)
                                If Val(.TextMatrix(lngRow - 1, COL_用药目的)) <> 0 Then
                                    cboDruPur.ListIndex = Val(.TextMatrix(lngRow - 1, COL_用药目的))
                                End If
                            End If
                        End If
                        '新录入的药品一并给药时，如果没有启用天数录入参数，但用法用量指定了单量则自动反算总量，根据第一条医嘱的天数来反算
                        If Val(.TextMatrix(lngRow, COL_单量)) > 0 And .TextMatrix(lngRow, COL_期效) = "临嘱" And mbln天数 = False Then
                            Call GetRowScope(lngRow, lngBegin, lngEnd)
                            If Val(.TextMatrix(lngBegin, COL_总量)) > 0 And Val(.TextMatrix(lngBegin, COL_单量)) > 0 And .TextMatrix(lngBegin, COL_频率) <> "" _
                                And Val(.TextMatrix(lngBegin, COL_频率次数)) <> 0 And Val(.TextMatrix(lngBegin, COL_频率间隔)) <> 0 _
                                And Val(.TextMatrix(lngBegin, COL_剂量系数)) <> 0 And Val(.TextMatrix(lngBegin, COL_住院包装)) <> 0 Then
                                sng天数 = Calc缺省药品天数(Val(.TextMatrix(lngBegin, COL_总量)), Val(.TextMatrix(lngBegin, COL_单量)), _
                                                Val(.TextMatrix(lngBegin, COL_频率次数)), Val(.TextMatrix(lngBegin, COL_频率间隔)), .TextMatrix(lngBegin, COL_间隔单位), _
                                                Val(.TextMatrix(lngBegin, COL_剂量系数)), Val(.TextMatrix(lngBegin, COL_住院包装)), _
                                                Val(.TextMatrix(lngBegin, COL_可否分零)))
                                .TextMatrix(lngRow, COL_总量) = ReSetTotalamount(False, vsAdvice.TextMatrix(lngRow, COL_总量), sng天数, lngRow)
                            End If
                        End If
                    ElseIf lngPreRow <> -1 Then
                        '自动使一并给药
                        Set objControl = cbsMain.FindControl(, conMenu_Merge, , True)
                        If objControl.Checked = True Then
                            If .TextMatrix(lngPreRow, COL_类别) = rsInput!类别ID Then
                                If RowIn一并给药(lngPreRow) And RowCanMerge(lngPreRow, lngRow) And GetNextRow(lngRow) = -1 Then
                                    mblnRowMerge = True: cbsMain.RecalcLayout '*即时刷新
                                    lngRowID = .RowData(lngRow)
                                    Call MergeRow(lngPreRow, lngRow, False)
                                    lngRow = .FindRow(lngRowID, lngPreRow + 1)
                                End If
                            End If
                        End If
                    End If
                Else
                    Call SetTag一并给药(lngRow)
                End If
            End If
        End If
        
        
        '更新附件内容:以当前可见行为准
        If strAppend <> "" Then
            .TextMatrix(.Row, COL_附项) = strAppend
            .Cell(flexcpData, .Row, COL_附项) = 1 '表明需要重新写入(新增或修改)
            Call ReplaceAdviceAppend(.Row) '缺省替换其他医嘱的申请附项
        End If
        
        '输入西药可成药时自动增加皮试行:增加之后仍定位在当前药品
        If lng皮试ID <> 0 And Not bln皮试行 Then
            Call AdviceSet过敏试验(.Row, lng皮试ID) '注意用当前行,因为一并之后定位改变
        End If
        
        '重新自动调整行高
        Call .AutoSize(col_医嘱内容)
    End With
    
    mblnNoSave = True '标记为未保存
    
    '对保险对码进行检查
    Call GetInsureStr(strIDs1, strIDs2, str医嘱内容, vsAdvice.Row)
    strMsg = CheckAdviceInsure(mint险类, mbln提醒对码, mlng病人ID, mlng病人性质, strIDs1, strIDs2, str医嘱内容, mlng病人病区ID)
    If strMsg <> "" Then
        If gint医保对码 = 2 Then strMsg = strMsg & vbCrLf & vbCrLf & "请先和相关人员联系处理，否则医嘱将不允许保存。"
        vMsg = frmMsgBox.ShowMsgBox(strMsg, Me, True)
        If vMsg = vbIgnore Then mbln提醒对码 = False
    End If
    
    '调用外挂接口
    If CreatePlugInOK(p住院医嘱下达, mint场合) Then
        If zlPluginAdviceEnter(vsAdvice.Row) = False Then
            vsAdvice.Refresh: Exit Function
        End If
    End If
    
    AdviceInput = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function CheckAutoMerge(ByVal lngRow As Long) As Integer
'功能：自动判断溶媒进行自动一并给药和取消一并
        '判断溶媒，自动一并/取消一并
        '如果上一行医嘱是输液药品，当前输入的也是输液药品时：
        '1、如果当前录入的是药品，如果前面一组液体中，溶媒是第一个，那么自动为“一并”状态。
        '2、如果当前录入的是药品，如果前面一组液体中，溶媒是最后一个（上一条医嘱），那么自动取消“一并”状态（后输入溶媒的情况）。
        '3、如果当前行录入的溶媒（药品特性.溶媒），则判断如果一组液体中已经存在一个溶媒时，则自动取消“一并”状态（先输入溶媒的情况）。
'参数：lngRow=当前行
'返回：0-不做处理，1-一并给药，2-取消一并给药
    Dim i As Long, j As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim lngPreRow As Long
    
    With vsAdvice
        lngPreRow = GetPreRow(lngRow) '取上一有效行,某些内容缺省与上一行相同
        If lngPreRow <> -1 Then
            If InStr(",5,6,", .TextMatrix(lngPreRow, COL_类别)) > 0 Then
                i = .FindRow(CLng(.TextMatrix(lngPreRow, COL_相关ID)), lngPreRow + 1)
                If .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "2" And .TextMatrix(i, COL_执行分类) = "1" Then
                    j = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    If .TextMatrix(j, COL_类别) = "E" And .TextMatrix(j, COL_操作类型) = "2" And .TextMatrix(j, COL_执行分类) = "1" Then
                        If RowCanMerge(lngPreRow, lngRow) Then
                            '获取上一条医嘱的开始行号
                            Call GetRowScope(i, lngBegin, lngEnd)
                            If mblnRowMerge = False Then
                                '第一行是溶媒(1)
                                If Val(.TextMatrix(lngBegin, COL_是否溶媒)) = 1 And Val(.TextMatrix(lngRow, COL_是否溶媒)) <> 1 Then
                                    CheckAutoMerge = 1
                                End If
                            Else
                                '当前行是溶媒，前面已经存在溶媒了(3)
                                If Val(.TextMatrix(lngRow, COL_是否溶媒)) = 1 Then
                                    For i = lngBegin To lngEnd
                                        If Val(.TextMatrix(i, COL_是否溶媒)) = 1 Then
                                            CheckAutoMerge = 2
                                            Exit For
                                        End If
                                    Next
                                Else
                                    '当前是药品，上一行是溶媒，但又不是第一行时(2)
                                    If Val(.TextMatrix(lngPreRow, COL_是否溶媒)) = 1 And lngPreRow <> lngBegin Then
                                        CheckAutoMerge = 2
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
    End With
End Function

Private Sub MergeRow(ByVal lngRow1 As Long, ByVal lngRow2 As Long, Optional ByVal blnCheck As Boolean = True)
'功能：将两行设置为一并给药
'参数：lngRow1=前面行,可能本来已经属于一并给药
'      lngRow2=当前行
'说明：设置完成后,表格仍定位在原lngRow2的当前行
    Dim lngBegin As Long, lngEnd As Long
    Dim blnDo As Boolean, lngTmp As Long
    
    With vsAdvice
        If blnCheck Then
            blnDo = RowCanMerge(lngRow1, lngRow2)
        Else
            blnDo = True
        End If
        If blnDo Then
            mblnRowChange = False: .Redraw = flexRDNone
            lngTmp = .RowData(lngRow2) '记录以再定位到当前行
            '先取消之前的一并给药
            If RowIn一并给药(lngRow1) Then
                Call Get一并给药范围(Val(.TextMatrix(lngRow1, COL_相关ID)), lngBegin, lngEnd)
                Call AdviceSet单独给药(lngBegin, lngEnd)
                lngRow1 = lngBegin
                lngRow2 = .FindRow(lngTmp, lngBegin + 1)
            End If
            Call AdviceSet一并给药(lngRow1, lngRow2)
            lngRow2 = .FindRow(lngTmp, lngBegin + 1)
            .Row = lngRow2
            mblnRowChange = True: .Redraw = flexRDDirect
        End If
    End With
End Sub

Private Sub SplitRow(ByVal lngRow As Long)
'功能：将指定行从一并给药中独立出来(该组一并给药必须至少包含三行)
'参数：lngRow=当前行,且为一并给药中的最后一药品行
'说明：设置完成后,表格仍定位在原lngRow的当前行
    Dim lngBegin As Long, lngEnd As Long, lngTmp As Long, k As Long
    
    With vsAdvice
        mblnRowChange = False: .Redraw = flexRDNone
        lngTmp = .RowData(lngRow) '记录用于恢复定位当前行
        Call Get一并给药范围(Val(.TextMatrix(lngRow, COL_相关ID)), lngBegin, lngEnd)
        
        '先取消整个的一并给药
        Call AdviceSet单独给药(lngBegin, lngEnd)
        
        '再设置除最后行外的行为一并给药
        lngRow = .FindRow(lngTmp, lngBegin + 1)
        lngEnd = GetPreRow(lngRow)
        Call AdviceSet一并给药(lngBegin, lngEnd)
                
        '恢复当前行
        lngRow = .FindRow(lngTmp, lngBegin + 1)
        .Row = lngRow
        
        If mlng路径状态 <> 0 Then
            If Val(.TextMatrix(lngRow, COL_路径项目ID)) = 0 And InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                Call GetRowScope(lngBegin, lngBegin, lngEnd)
                If lngBegin < lngRow And Val(.TextMatrix(lngBegin, COL_路径项目ID)) <> 0 Then   '路径外项目只能添加到一并给药的后面
                    For k = lngBegin To lngEnd - 1
                        If Val(.TextMatrix(k, COL_路径项目ID)) = 0 Then Exit For
                    Next
                    If k = lngEnd Then  '重设给药途径的路径相关信息
                        .TextMatrix(lngEnd, COL_路径项目ID) = .TextMatrix(lngBegin, COL_路径项目ID)
                        .TextMatrix(lngEnd, COL_路径执行ID) = .TextMatrix(lngBegin, COL_路径执行ID)
                        .TextMatrix(lngEnd, COL_路径执行方式) = .TextMatrix(lngBegin, COL_路径执行方式)
                        .TextMatrix(lngEnd, COL_路径项目分类) = .TextMatrix(lngBegin, COL_路径项目分类)
                    End If
                End If
            End If
        End If
        
        mblnRowChange = True: .Redraw = flexRDDirect
    End With
End Sub

Private Sub AdviceSet成套项目(ByVal intType As Integer, ByVal lng成套ID As Long, ByVal lngRow As Long, Optional ByVal str序号 As String, Optional strAltAdivce As String)
'功能：输入成套项目(包括一并给药,检查组合,手术附加,中药配方)
'      mbytUseType = 1时是提取路径项目对应的医嘱
'参数：lngRow=空的输入行(可能是插入的新行,但不位于一并给药中间)
'      intType=调用类型，1-成套调用，2-路径生成，3-备选医嘱动态加载
'     strAltAdivce   intType=3时动态加载备选医嘱，intType=2时，所有路径项目对应的医嘱，医嘱内容ID:婴儿序号:路径项目ID,...，例：227:0:38,335:1:69
    Dim rsItems As New ADODB.Recordset
    Dim rs规格 As New ADODB.Recordset
    Dim rs材料 As New ADODB.Recordset
    Dim rs疗程 As New ADODB.Recordset
    Dim strSQL As String, i As Long, j As Long
    Dim strTab As String, strList As String, strTabTwo As String
    Dim bln允许选择 As Boolean    '临床路径生成时是否存在允许选择生成的项目
    Dim lngCurRow As Long, intCount As Integer, lng序号 As Long
    Dim lngPreRow As Long, vCurDate As Date, lngTmp As Long
    Dim int频率次数 As Integer, int频率间隔 As Integer, str间隔单位 As String
    Dim bln给药途径 As Boolean, bln采集方法 As Boolean, bln输血途径 As Boolean
    Dim bln中药用法 As Boolean, bln中药煎法 As Boolean, bln配方 As Boolean
    Dim lng西药房ID As Long, lng成药房ID As Long, lng中药房ID As Long, lng发料部门ID As Long
    Dim dbl相关ID As Double, str适用范围 As String, str频率 As String
    Dim str医生 As String, lng医生ID As Long
    Dim lng倍数 As Long, vBookMark As Variant, str药房IDs As String
    Dim sng天数 As Single, strSQL序号 As String, str附项 As String
    Dim int频率性质 As Integer, str开始时间 As String
    Dim lngPre路径项目id As Long, lngPre选择生成 As Long
    Dim lngPre As Long, strValues(0 To 10) As String
    Dim strAdivceOfPath As String, strTmp As String, lngPar As Long, lngPos As Long
    Dim str高危药品 As String
    Dim str证候IDs As String
    Dim lngRecord As Long
    Dim rsTmp As ADODB.Recordset
    
    On Error GoTo errH
    Screen.MousePointer = 11
    Me.Refresh

    '路径项目对应医嘱
    If mbytUseType = 1 Then
        strAdivceOfPath = strAltAdivce
        lngPar = 0
        strList = ""
        str证候IDs = Get证候IDs(mlng病人ID, mlng主页ID)
        Do While strAdivceOfPath <> ""
            If Len(strAdivceOfPath) > 4000 And lngPar < 10 Then
                strTmp = Mid(strAdivceOfPath, 1, 4000)
                lngPos = InStrRev(strTmp, ",")
                If lngPos > 0 Then
                    strTmp = Mid(strTmp, 1, lngPos - 1)
                Else
                    lngPos = Len(strTmp)
                End If
            Else
                strTmp = strAdivceOfPath
                lngPos = Len(strTmp)
            End If

            strValues(lngPar) = strTmp
            strAdivceOfPath = Mid(strAdivceOfPath, lngPos + 1)
            lngPar = lngPar + 1    '参数是从1开始

            If strList <> "" Then strList = strList & " Union All "
            strList = strList & "Select To_Number(Substr(Column_Value, 1, Instr(Column_Value, ':') - 1)) As 医嘱内容id," & vbNewLine & _
                      "       To_Number(Substr(Column_Value, Instr(Column_Value, ':') + 1," & vbNewLine & _
                      "                         Instr(Column_Value, ':', -1) - (Instr(Column_Value, ':') + 1))) As 婴儿," & vbNewLine & _
                      "       To_Number(Substr(Column_Value, Instr(Column_Value, ':', -1) + 1)) As 路径项目id" & vbNewLine & _
                      "From Table(f_Str2list([" & lngPar & "]))"
        Loop

        strTab = "(Select distinct a.路径项目id,c.婴儿,e.序号 as 分类序号,d.项目序号, b.序号 as 医嘱序号," & vbNewLine & _
                 " b.Id 序号, b.相关id 相关序号, b.期效, b.诊疗项目id, b.收费细目id, b.医嘱内容, b.单次用量, b.总给予量, b.标本部位, b.检查方法, b.医生嘱托, b.执行频次," & vbNewLine & _
                 " b.频率次数, b.频率间隔, b.间隔单位, b.执行性质, b.执行标记,b.执行科室id, b.时间方案,d.内容要求,d.执行方式,b.是否缺省,b.是否备选,d.路径id,B.配方ID, b.组合项目id" & vbNewLine & _
                 "From 临床路径医嘱 A, 路径医嘱内容 B,临床路径项目 D,临床路径分类 E, (" & strList & ") C" & vbNewLine & _
                 "Where a.医嘱内容id = b.Id And a.路径项目ID = c.路径项目ID And a.医嘱内容ID = c.医嘱内容ID And a.路径项目ID = d.ID  And NVL(e.分支id,0)=NVL(d.分支id,0) " & vbNewLine & _
                 " And d.分类 = e.名称 And d.路径id = e.路径id And d.版本号 = e.版本号 " & IIF(intType = 2, " And NVL(b.是否备选,0)=0", "") & ")"
        
        strTabTwo = Replace(strTab, ",c.婴儿,", ",") '避免勾选多个婴儿情况下,规格返回多条相同数据
        
        '药品规格信息:虽然存了收费细目ID,但长嘱可能没存,以前的数据也没存
        strSQL = "Select /*+ rule*/A.序号,B.药名ID,B.药品ID,B.剂量系数,B.住院包装,B.住院单位,b.基本药物," & _
                 " B.住院可否分零 As 可否分零,B.动态分零,C.编码,Nvl(D.名称,C.名称) as 名称,C.规格,C.产地,A.是否备选,b.高危药品,B.是否易至跌倒" & _
                 " From " & strTabTwo & " A,药品规格 B,收费项目目录 C,收费项目别名 D" & _
                 " Where A.诊疗项目ID=B.药名ID And B.药品ID=C.ID" & _
                 " And C.ID=D.收费细目ID(+) And D.码类(+)=1 And D.性质(+)=" & IIF(gbyt药品名称显示 = 0, 1, 3) & _
                 " Order by a.路径项目id,a.医嘱序号"
        Set rs规格 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strValues(0), strValues(1), strValues(2), strValues(3), strValues(4), strValues(5), strValues(6), strValues(7), strValues(8), strValues(9), strValues(10))

        '卫材信息
        strSQL = "Select /*+ rule*/A.序号,B.材料ID,B.跟踪在用,C.名称,C.计算单位,a.是否备选,B.是否分零" & _
                 " From " & strTabTwo & " A,材料特性 B,收费项目目录 C" & _
                 " Where A.收费细目ID=B.材料ID And B.材料ID=C.ID" & _
                 " Order by a.路径项目id,a.医嘱序号"
        Set rs材料 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strValues(0), strValues(1), strValues(2), strValues(3), strValues(4), strValues(5), strValues(6), strValues(7), strValues(8), strValues(9), strValues(10))

        '成药疗程信息(因成套中无直接对应配方,中药取不到疗程)
        strSQL = "Select /*+ rule*/Distinct A.诊疗项目ID,C.疗程,A.是否备选" & _
                 " From " & strTabTwo & " A,诊疗项目目录 B,诊疗用法用量 C" & _
                 " Where A.诊疗项目ID=B.ID And B.类别 IN('5','6')" & _
                 " And A.诊疗项目ID=C.项目ID"
        Set rs疗程 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strValues(0), strValues(1), strValues(2), strValues(3), strValues(4), strValues(5), strValues(6), strValues(7), strValues(8), strValues(9), strValues(10))


        '与成套相比，没有"天数"字段,可能有自由录入的叮嘱项目（无诊疗项目ID）
        '没有定义顺序的，空值排在后面,由于新增合并路径，所以必须先根据路径ID排序，把一个路径的同组医嘱放在一起。
        strSQL = "Select /*+ rule*/A.路径项目id,a.婴儿,A.期效,a.序号+0.01 As 序号,Decode(a.相关序号,Null,Null,a.相关序号+0.01) As 相关序号,A.诊疗项目ID,A.收费细目ID,A.医嘱内容,Null 天数,A.总给予量,A.单次用量," & _
                 " A.医生嘱托,A.执行频次,A.频率次数,A.频率间隔,A.间隔单位,A.执行科室ID,Nvl(B.类别,'*') 类别,B.名称," & _
                 " B.计算单位,Decode(B.类别,'D',A.标本部位,Nvl(A.标本部位,B.标本部位)) as 标本部位,A.检查方法," & _
                 " A.时间方案,Nvl(A.执行性质,B.执行科室) as 执行性质,A.执行标记,B.计价性质,B.操作类型,B.执行分类,B.计算方式," & _
                 " B.执行频率,B.录入限量,C.处方限量,C.处方职务,C.毒理分类,C.抗生素,C.药品剂型,C.品种医嘱,A.内容要求,A.分类序号,A.项目序号,A.医嘱序号,A.执行方式,A.是否缺省,A.是否备选,A.路径id,A.配方ID,C.临床自管药,A.组合项目ID,b.单独应用,C.溶媒" & _
                 " From " & strTab & " A,诊疗项目目录 B,药品特性 C,收费项目目录 D" & _
                 " Where A.诊疗项目ID=B.ID(+) And B.ID=C.药名ID(+) And d.id(+)=a.收费细目ID And (NVL(d.撤档时间,b.撤档时间) = To_Date('3000/1/1', 'yyyy/mm/dd') or NVL(d.撤档时间,b.撤档时间) is null) And (Nvl(d.服务对象, b.服务对象) In (" & IIF(mlng病人性质 = 1, "1,2", 2) & ", 3) or Nvl(d.服务对象, b.服务对象) is null) " & _
                 IIF(str证候IDs <> "", " And (instr(',' || [12] || ',',',' || a.组合项目ID || ',')>0 or a.组合项目ID is null or Not (b.类别 = '7' or (b.类别 = 'E' and b.操作类型='4') or (b.类别 = 'E' and b.操作类型='3')))", "") & _
                 " Order by 婴儿,分类序号,项目序号,路径id,医嘱序号"
        Set rsItems = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strValues(0), strValues(1), strValues(2), strValues(3), strValues(4), strValues(5), strValues(6), strValues(7), strValues(8), strValues(9), strValues(10), str证候IDs)
        mblnNoSave = rsItems.RecordCount > 0
        If rsItems.RecordCount > 0 Then
            '清除主记录已经停用或是服务对象修改了的
            Set rsItems = zlDatabase.CopyNewRec(rsItems)
            If rsItems.RecordCount > 0 Then rsItems.MoveFirst
            Do While Not rsItems.EOF
                If rsItems!相关序号 & "" <> "" Then
                    lngRecord = rsItems.AbsolutePosition
                    rsItems.Filter = "序号=" & rsItems!相关序号
                    If rsItems.RecordCount = 0 Then
                        rsItems.Filter = 0
                        rsItems.AbsolutePosition = lngRecord
                        rsItems.Delete
                    Else
                        rsItems.Filter = 0
                        rsItems.AbsolutePosition = lngRecord
                    End If
                Else
                    '如果主记录只有一条记录，只检查项目是否允许单独应用
                    If Val(rsItems!诊疗项目ID & "") <> 0 Then
                        lngRecord = rsItems.AbsolutePosition
                        rsItems.Filter = "相关序号=" & rsItems!序号
                        If rsItems.RecordCount = 0 Then
                            rsItems.Filter = 0
                            rsItems.AbsolutePosition = lngRecord
                            If Val(rsItems!单独应用 & "") = 0 Then rsItems.Delete
                        Else
                            rsItems.Filter = 0
                            rsItems.AbsolutePosition = lngRecord
                        End If
                    End If
                End If
                rsItems.MoveNext
            Loop
            If rsItems.RecordCount > 0 Then rsItems.MoveFirst
        End If
    Else
        '产生序号过滤串
        If str序号 <> "" Then
            If Left(str序号, 1) = "+" Then
                strSQL序号 = " And Instr([2],','||A.序号||',')>0"
            ElseIf Left(str序号, 1) = "-" Then
                strSQL序号 = " And Instr([2],','||A.序号||',')=0"
            End If
        End If

        '药品规格信息:虽然存了收费细目ID,但长嘱可能没存,以前的数据也没存
        strSQL = "Select A.序号,B.药名ID,B.药品ID,B.剂量系数,B.住院包装,B.住院单位,b.基本药物," & _
                 " B.住院可否分零 As 可否分零,B.动态分零,C.编码,Nvl(D.名称,C.名称) as 名称,C.规格,C.产地,A.配方ID,b.高危药品,b.是否易至跌倒" & _
                 " From 诊疗项目组合 A,药品规格 B,收费项目目录 C,收费项目别名 D" & _
                 " Where A.诊疗项目ID=B.药名ID And B.药品ID=C.ID" & _
                 " And C.ID=D.收费细目ID(+) And D.码类(+)=1 And D.性质(+)=[3]" & _
                 " And A.诊疗组合ID=[1]" & strSQL序号 & _
                 " Order by A.序号,C.编码"
        Set rs规格 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng成套ID, "," & Mid(str序号, 2) & ",", IIF(gbyt药品名称显示 = 0, 1, 3))

        '卫材信息
        strSQL = "Select A.序号,B.材料ID,B.跟踪在用,C.名称,C.计算单位,B.是否分零" & _
                 " From 诊疗项目组合 A,材料特性 B,收费项目目录 C" & _
                 " Where A.收费细目ID=B.材料ID And B.材料ID=C.ID" & _
                 " And A.诊疗组合ID=[1]" & strSQL序号 & _
                 " Order by A.序号,C.编码"
        Set rs材料 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng成套ID, "," & Mid(str序号, 2) & ",")

        '成药疗程信息(因成套中无直接对应配方,中药取不到疗程)
        strSQL = "Select Distinct A.诊疗项目ID,C.疗程" & _
                 " From 诊疗项目组合 A,诊疗项目目录 B,诊疗用法用量 C" & _
                 " Where A.诊疗项目ID=B.ID And B.类别 IN('5','6')" & _
                 " And A.诊疗项目ID=C.项目ID And A.诊疗组合ID=[1]" & strSQL序号
        Set rs疗程 = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng成套ID, "," & Mid(str序号, 2) & ",")

        '按序号排列后应该与医嘱编辑时的次序一致
        strSQL = "Select A.期效,a.序号+0.1 As 序号,Decode(a.相关序号,Null,Null,a.相关序号+0.1) As 相关序号,A.诊疗项目ID,A.收费细目ID,A.医嘱内容,A.天数,A.总给予量,A.单次用量," & _
                 " A.医生嘱托,A.执行频次,A.频率次数,A.频率间隔,A.间隔单位,A.执行科室ID,Nvl(B.类别,'*') 类别,B.名称," & _
                 " B.计算单位,Decode(B.类别,'D',A.标本部位,Nvl(A.标本部位,B.标本部位)) as 标本部位,A.检查方法," & _
                 " A.时间方案,Nvl(A.执行性质,B.执行科室) as 执行性质,A.执行标记,B.计价性质,B.操作类型,B.单独应用,B.执行分类,B.计算方式," & _
                 " B.执行频率,B.录入限量,C.处方限量,C.处方职务,C.毒理分类,C.抗生素,C.药品剂型,C.品种医嘱,A.配方ID,c.临床自管药,a.组合项目ID,C.溶媒" & _
                 " From 诊疗项目组合 A,诊疗项目目录 B,药品特性 C,收费项目目录 D" & _
                 " Where A.诊疗项目ID=B.ID(+) And A.诊疗项目ID=C.药名ID(+) And d.id(+)=a.收费细目ID " & _
                 " And A.诊疗组合ID=[1]" & strSQL序号 & _
                 " And (NVL(d.撤档时间,b.撤档时间) is null or NVL(d.撤档时间,b.撤档时间) = To_Date('3000/1/1', 'yyyy/mm/dd') Or Not (b.类别 = '7' Or b.类别 = 'E' And b.执行分类 = 0 And b.操作类型 = '3') Or a.诊疗项目ID is null)" & _
                 " Order by A.序号"
        Set rsItems = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng成套ID, "," & Mid(str序号, 2) & ",")
    End If

    With vsAdvice
        vCurDate = zlDatabase.Currentdate

        '缺省开始时间
        If IsDate(msk开始时间.Text) Then
            If Not (gbln长期医嘱次日生效 And Format(msk开始时间.Text, "HH:mm") = "00:00") Then
                '补录以补录为准，否则正常生成
                If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                    str开始时间 = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                ElseIf DateDiff("n", CDate(msk开始时间.Text), vCurDate) > gint补录间隔 Then
                    str开始时间 = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                End If
                '当前控件中输入的日期合法，则作为缺省值
                If Check开始时间(msk开始时间.Text, txt终止时间.Text, False) Then
                    str开始时间 = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                End If
            End If
        End If

        mblnRowChange = False
        .Redraw = flexRDNone

        lngPreRow = GetPreRow(lngRow)    '前一参照行
        intCount = 0    '已经设置的行数
        lng序号 = GetCurRow序号(lngRow)    '起始序号
        '如果是动态加载备选医嘱，则默认新增一行
        If intType = 3 Then intCount = 1
        For i = 1 To rsItems.RecordCount
            lngCurRow = lngRow + intCount
            If lngCurRow > lngRow Then .AddItem "", lngCurRow
            '记录相对ID
            .RowData(lngCurRow) = -1 * rsItems!序号
            If Not IsNull(rsItems!相关序号) Then
                .TextMatrix(lngCurRow, COL_相关ID) = -1 * rsItems!相关序号
            End If

            .TextMatrix(lngCurRow, COL_EDIT) = 1    '新增的
            .Cell(flexcpData, lngCurRow, COL_EDIT) = lng成套ID    '记录相关的成套项目

            .TextMatrix(lngCurRow, COL_婴儿) = cbo婴儿.ListIndex
            .TextMatrix(lngCurRow, COL_序号) = lng序号 + intCount - IIF(intType = 3, 1, 0)
            .TextMatrix(lngCurRow, COL_状态) = IIF(mbln暂存, -1, 1)    '新开

            If mintPState = ps最近转出 And gbln只允许补录临嘱 = True Or mintPState = ps预出 Or mintPState = ps出院 Then
                .TextMatrix(lngCurRow, COL_期效) = "临嘱"
            Else
                .TextMatrix(lngCurRow, COL_期效) = IIF(NVL(rsItems!期效, 0) = 0, "长嘱", "临嘱")
            End If

            .TextMatrix(lngCurRow, COL_类别) = rsItems!类别
            .TextMatrix(lngCurRow, COL_诊疗项目ID) = NVL(rsItems!诊疗项目ID, 0)
            .TextMatrix(lngCurRow, COL_配方ID) = NVL(rsItems!配方ID)
            .TextMatrix(lngCurRow, COL_组合项目ID) = rsItems!组合项目ID & ""
            .TextMatrix(lngCurRow, COL_执行标记) = NVL(rsItems!执行标记, 0)
            '临床路径项目
            If mbytUseType = 1 Then
                .RowData(lngCurRow) = -1 * (rsItems!序号 * 10 + rsItems!婴儿)   '避免多个婴儿医嘱ID相同
                If Not IsNull(rsItems!相关序号) Then
                    .TextMatrix(lngCurRow, COL_相关ID) = -1 * (rsItems!相关序号 * 10 + rsItems!婴儿)
                End If
                .TextMatrix(lngCurRow, COL_婴儿) = Val(rsItems!婴儿)

                .TextMatrix(lngCurRow, COL_路径项目ID) = Val(rsItems!路径项目ID)
                .TextMatrix(lngCurRow, COL_路径执行方式) = Val("" & rsItems!执行方式)    '0-无须执行，1-每天执行，2-至少执行一次，3-必要时执行

                If Val("" & rsItems!内容要求) = 1 Then  '允许选择生成
                    .Cell(flexcpChecked, lngCurRow, COL_选择) = IIF(rsItems!是否缺省 = 1, 1, 2)    '1表示选择
                    .Cell(flexcpPictureAlignment, lngCurRow, COL_选择) = flexPicAlignCenterCenter
                    If bln允许选择 = False Then bln允许选择 = True
                Else
                    .TextMatrix(lngCurRow, COL_选择) = "√"    '未设置.Cell(flexcpChecked, lngCurRow, COL_选择)时值为0
                    .Cell(flexcpBackColor, lngCurRow, COL_选择) = &H8000000F
                End If

                '不同组的路径项目，以粗线分隔
                If lngPre路径项目id <> Val(rsItems!路径项目ID) And lngCurRow <> .FixedRows Then
                    If lngPre选择生成 = 1 Or Val("" & rsItems!内容要求) = 1 Then
                        If .RowHidden(lngCurRow - 1) Then   '找到前一非隐藏行
                            For lngPre = lngCurRow - 2 To .FixedRows Step -1
                                If .RowHidden(lngPre) = False Then
                                    .CellBorderRange lngPre, .FixedCols, lngPre, .Cols - 1, &H808080, 0, 0, 0, 2, 0, 0
                                    Exit For
                                End If
                            Next
                        Else
                            .CellBorderRange lngCurRow - 1, .FixedCols, lngCurRow - 1, .Cols - 1, &H808080, 0, 0, 0, 2, 0, 0
                        End If
                    End If
                End If
                lngPre路径项目id = Val(rsItems!路径项目ID)
                lngPre选择生成 = Val("" & rsItems!内容要求)
            End If

            .TextMatrix(lngCurRow, COL_名称) = NVL(rsItems!名称)
            .TextMatrix(lngCurRow, COL_标本部位) = NVL(rsItems!标本部位)
            .TextMatrix(lngCurRow, COL_检查方法) = NVL(rsItems!检查方法)

            '开始时间
            .TextMatrix(lngCurRow, COL_开始时间) = str开始时间
            If .TextMatrix(lngCurRow, COL_开始时间) = "" Then
                .TextMatrix(lngCurRow, COL_开始时间) = GetDefaultTime(lngCurRow)
            End If
            .Cell(flexcpData, lngCurRow, COL_开始时间) = .TextMatrix(lngCurRow, COL_开始时间)
            
            If rsItems!类别 = "E" And rsItems!操作类型 & "" = "6" Then
                .TextMatrix(lngCurRow, COL_采集时间) = .TextMatrix(lngCurRow, COL_开始时间)
            End If
            '手术/输血时间：复制时缺省与开始时间相同,在标本部位处理后
            If rsItems!类别 = "K" Or rsItems!类别 = "F" Or rsItems!类别 = "G" _
               And Val(.TextMatrix(lngCurRow, COL_相关ID)) = Val(.TextMatrix(lngCurRow - 1, COL_相关ID)) Then
                .TextMatrix(lngCurRow, COL_手术时间) = .TextMatrix(lngCurRow, COL_开始时间)
            End If

            '其它
            .TextMatrix(lngCurRow, COL_计价性质) = NVL(rsItems!计价性质, 0)
            .TextMatrix(lngCurRow, COL_计算方式) = NVL(rsItems!计算方式, 0)
            .TextMatrix(lngCurRow, COL_操作类型) = NVL(rsItems!操作类型)
            .TextMatrix(lngCurRow, COL_单独应用) = NVL(rsItems!单独应用)
            .TextMatrix(lngCurRow, COL_执行分类) = NVL(rsItems!执行分类, 0)
            .TextMatrix(lngCurRow, COL_毒理分类) = NVL(rsItems!毒理分类)
            .TextMatrix(lngCurRow, COL_抗菌等级) = Val("" & rsItems!抗生素)

            .TextMatrix(lngCurRow, COL_药品剂型) = NVL(rsItems!药品剂型)
            If InStr(",5,6,7,", rsItems!类别) > 0 Then
                .TextMatrix(lngCurRow, COL_处方限量) = NVL(rsItems!处方限量)
            Else
                .TextMatrix(lngCurRow, COL_处方限量) = NVL(rsItems!录入限量)
            End If
            .TextMatrix(lngCurRow, COL_处方职务) = NVL(rsItems!处方职务)
            .TextMatrix(lngCurRow, COL_品种医嘱) = Val("" & rsItems!品种医嘱)

            .TextMatrix(lngCurRow, COL_临床自管药) = rsItems!临床自管药 & ""
            .TextMatrix(lngCurRow, COL_是否溶媒) = Val(rsItems!溶媒 & "")
            

            '药品规格信息:中草药肯定有,成药按单量与剂量单位自动匹配
            lng倍数 = 0: vBookMark = 0
            '不管成套本身是否记录规格，根据当前设置来
            If rsItems!类别 = "7" Or (InStr(",5,6,", rsItems!类别) > 0 _
                And (NVL(rsItems!期效, 0) = 1 Or gbln药品按规格下医嘱 And NVL(rsItems!品种医嘱, 0) = 0)) Then
                '                '成药长嘱：记录了规格的保持原样；没记录规格的，如果固定按品种下达则不管
                '                If Not (InStr(",5,6,", rsItems!类别) > 0 And Nvl(rsItems!期效, 0) = 0 _
                                 '                    And IsNull(rsItems!收费细目ID) And Nvl(rsItems!品种医嘱, 0) = 1) Then
                '临床路径定义和成套定义，允许不指定规格，包括临嘱和长嘱
                If Not IsNull(rsItems!收费细目ID) Then
                    rs规格.Filter = "药品ID=" & rsItems!收费细目ID
                Else
                    rs规格.Filter = "药名ID=0"
                End If
                If Not rs规格.EOF Then
                    If IsNull(rsItems!收费细目ID) Then
                        '取剂量系数为单量的最小整倍数的那一个规格
                        If CInt(NVL(rsItems!单次用量, 0)) <> 0 Then
                            Do While Not rs规格.EOF
                                If rs规格!剂量系数 / rsItems!单次用量 = Int(rs规格!剂量系数 / rsItems!单次用量) Then
                                    If rs规格!剂量系数 / rsItems!单次用量 < lng倍数 Or lng倍数 = 0 Then
                                        vBookMark = rs规格.Bookmark
                                        lng倍数 = rs规格!剂量系数 / rsItems!单次用量
                                    End If
                                End If
                                rs规格.MoveNext
                            Loop
                            If vBookMark <> 0 Then rs规格.Bookmark = vBookMark
                        End If
                        If rs规格.EOF Then rs规格.MoveFirst
                    End If
                    .TextMatrix(lngCurRow, COL_名称) = NVL(rs规格!名称)
                    .TextMatrix(lngCurRow, COL_收费细目ID) = rs规格!药品ID
                    .Cell(flexcpData, lngCurRow, COL_收费细目ID) = Val("" & rs规格!药品ID)
                    .TextMatrix(lngCurRow, COL_剂量系数) = NVL(rs规格!剂量系数)
                    .TextMatrix(lngCurRow, COL_住院包装) = NVL(rs规格!住院包装)
                    .TextMatrix(lngCurRow, COL_住院单位) = NVL(rs规格!住院单位)
                    .TextMatrix(lngCurRow, COL_可否分零) = NVL(rs规格!可否分零, 0)
                    .TextMatrix(lngCurRow, COL_动态分零) = NVL(rs规格!动态分零, 0)
                    .TextMatrix(lngCurRow, COL_高危药品) = NVL(rs规格!高危药品, 0)
                    .TextMatrix(lngCurRow, COL_易跌倒) = NVL(rs规格!是否易至跌倒, 0)
                    If Val(.TextMatrix(lngCurRow, COL_高危药品)) <> 0 Then
                        str高危药品 = str高危药品 & vbCrLf & rsItems!名称 & ":" & Decode(Val(.TextMatrix(lngCurRow, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级；"
                    End If
                    .TextMatrix(lngCurRow, COL_基本药物) = NVL(rs规格!基本药物)
                End If
            ElseIf rsItems!类别 = "4" Then
                rs材料.Filter = "材料ID=" & NVL(rsItems!收费细目ID, 0)
                If Not rs材料.EOF Then
                    .TextMatrix(lngCurRow, COL_名称) = NVL(rs材料!名称)
                    .TextMatrix(lngCurRow, COL_住院单位) = NVL(rs材料!计算单位)    '散装单位
                    .TextMatrix(lngCurRow, COL_跟踪在用) = NVL(rs材料!跟踪在用, 0)
                End If
                .TextMatrix(lngCurRow, COL_剂量系数) = 1
                .TextMatrix(lngCurRow, COL_住院包装) = 1
                .TextMatrix(lngCurRow, COL_收费细目ID) = NVL(rsItems!收费细目ID, 0)
                .Cell(flexcpData, lngCurRow, COL_收费细目ID) = Val("" & rsItems!收费细目ID)
                .Cell(flexcpData, lngCurRow, COL_可否分零) = NVL(rs材料!是否分零, 0)
            End If

            '判断是否特定行
            bln给药途径 = False: bln采集方法 = False: bln输血途径 = False
            bln中药用法 = False: bln中药煎法 = False: bln配方 = False
            If rsItems!类别 = "E" Then
                If IsNull(rsItems!相关序号) Then
                    If Val(.TextMatrix(lngCurRow - 1, COL_相关ID)) = .RowData(lngCurRow) Then
                        If InStr(",5,6,", .TextMatrix(lngCurRow - 1, COL_类别)) > 0 Then
                            bln给药途径 = True
                        ElseIf .TextMatrix(lngCurRow - 1, COL_类别) = "C" Then
                            bln采集方法 = True
                        Else
                            bln中药用法 = True
                        End If
                    End If
                ElseIf .TextMatrix(lngCurRow - 1, COL_类别) = "K" And .RowData(lngCurRow - 1) = Val(.TextMatrix(lngCurRow, COL_相关ID)) Then
                    bln输血途径 = True
                Else
                    bln中药煎法 = True
                End If
            End If
            If rsItems!类别 = "7" Or bln中药煎法 Or bln中药用法 Then bln配方 = True

            '获取当前项目的适用范围
            If bln采集方法 Then
                '采集方法以检验项目的为准
                lngTmp = .FindRow(CStr(.RowData(lngCurRow)), , COL_相关ID)
                int频率性质 = .TextMatrix(lngTmp, COL_频率性质)
            Else
                int频率性质 = NVL(rsItems!执行频率, 0)
            End If
            If bln配方 Then
                str适用范围 = 2    '中药配方(包括煎法,用法)用中医
                '            ElseIf bln采集方法 Then
                '                str适用范围 = -1 '设置与检验项目相同:一次性
            ElseIf int频率性质 = 1 Then
                str适用范围 = -1    '一次性
            ElseIf int频率性质 = 2 Then
                str适用范围 = -2    '持续性
            ElseIf int频率性质 = 0 Then    '可选频率
                If NVL(rsItems!期效, 0) = 1 Then
                    str适用范围 = "1,-1"    '临嘱可能为一次性(光名称不能唯一区分)
                Else
                    str适用范围 = 1
                End If
            End If
            If rsItems!执行频次 & "" = "必要时" Then
                str适用范围 = -3
            ElseIf rsItems!执行频次 & "" = "需要时" Then
                str适用范围 = -5
            End If

            '频率,频率次数,频率间隔,间隔单位
            .TextMatrix(lngCurRow, COL_频率性质) = int频率性质
            If Not IsNull(rsItems!执行频次) Then
                If Check频率可用(NVL(rsItems!诊疗项目ID, 0), Val(str适用范围), NVL(rsItems!执行频次)) Then    'Val(str适用范围)
                    If Get频率信息_名称(rsItems!执行频次, int频率次数, int频率间隔, str间隔单位, str适用范围) Then
                        .TextMatrix(lngCurRow, COL_频率) = rsItems!执行频次
                        .TextMatrix(lngCurRow, COL_频率次数) = int频率次数
                        .TextMatrix(lngCurRow, COL_频率间隔) = int频率间隔
                        .TextMatrix(lngCurRow, COL_间隔单位) = str间隔单位

                        '临嘱可选频率可能设置为了一次性
                        If NVL(rsItems!期效, 0) = 1 And int频率性质 = 0 And NVL(rsItems!频率次数, 0) = 0 And NVL(rsItems!频率间隔, 0) = 0 Then
                            .TextMatrix(lngCurRow, COL_频率性质) = 1
                        End If
                    End If
                End If
            End If
            If .TextMatrix(lngCurRow, COL_频率) = "" And Not IsNull(rsItems!诊疗项目ID) Then    '取缺省的
                If NVL(rsItems!期效, 0) = 1 And int频率性质 = 0 Then
                    If mbln一次性 Then    '临嘱缺省为一次性
                        str适用范围 = -1
                        .TextMatrix(lngCurRow, COL_频率性质) = 1
                    Else
                        str适用范围 = 1
                    End If
                End If
                Call Get缺省频率(NVL(rsItems!诊疗项目ID, 0), str适用范围, str频率, int频率次数, int频率间隔, str间隔单位)
                .TextMatrix(lngCurRow, COL_频率) = str频率
                .TextMatrix(lngCurRow, COL_频率次数) = int频率次数
                .TextMatrix(lngCurRow, COL_频率间隔) = int频率间隔
                .TextMatrix(lngCurRow, COL_间隔单位) = str间隔单位
            End If

            '单量
            .TextMatrix(lngCurRow, COL_单量) = FormatEx(NVL(rsItems!单次用量), 5)
            If rsItems!类别 = "4" Then
                .TextMatrix(lngCurRow, COL_单量单位) = .TextMatrix(lngCurRow, COL_住院单位)    '散装单位
            ElseIf bln中药用法 Then
                .TextMatrix(lngCurRow, COL_单量单位) = ""
            ElseIf NVL(rsItems!期效, 0) = 0 Then
                If InStr(",5,6,7,", rsItems!类别) > 0 Or InStr(",1,2,", NVL(rsItems!计算方式, 0)) > 0 Then
                    .TextMatrix(lngCurRow, COL_单量单位) = NVL(rsItems!计算单位)
                End If
            Else
                If InStr(",5,6,7,", rsItems!类别) > 0 Or (int频率性质 = 0 And InStr(",1,2,", NVL(rsItems!计算方式, 0)) > 0) Then
                    .TextMatrix(lngCurRow, COL_单量单位) = NVL(rsItems!计算单位)
                End If
            End If

            '总量
            If NVL(rsItems!期效, 0) = 1 And (InStr(",5,6,", rsItems!类别) > 0 Or rsItems!类别 = "7") Then
                '成药临嘱(有对应规格)或中药配方
                If InStr(",5,6,", rsItems!类别) > 0 Then
                    .TextMatrix(lngCurRow, COL_总量单位) = .TextMatrix(lngCurRow, COL_住院单位)

                    sng天数 = NVL(rsItems!天数, msng天数)
                    If mbln天数 Then
                        If .TextMatrix(lngCurRow, COL_间隔单位) = "周" Then
                            If 7 > sng天数 Then sng天数 = 7
                        ElseIf .TextMatrix(lngCurRow, COL_间隔单位) = "天" Then
                            If Val(.TextMatrix(lngCurRow, COL_频率间隔)) > sng天数 Then
                                sng天数 = Val(.TextMatrix(lngCurRow, COL_频率间隔))
                            End If
                        ElseIf .TextMatrix(lngCurRow, COL_间隔单位) = "小时" Then
                            If Val(.TextMatrix(lngCurRow, COL_频率间隔)) \ 24 > sng天数 Then
                                sng天数 = Val(.TextMatrix(lngCurRow, COL_频率间隔)) \ 24
                            End If
                        ElseIf .TextMatrix(lngCurRow, COL_间隔单位) = "分钟" Then
                            If sng天数 = 0 Then sng天数 = 1
                        End If
                        If sng天数 = 0 Then sng天数 = 1
                    End If
                Else
                    .TextMatrix(lngCurRow, COL_总量单位) = "付"
                    sng天数 = 1
                End If

                If Not IsNull(rsItems!总给予量) Then
                    If InStr(",5,6,", rsItems!类别) > 0 Then
                        '转换为住院单位
                        .TextMatrix(lngCurRow, COL_总量) = FormatEx(rsItems!总给予量 / Val(.TextMatrix(lngCurRow, COL_住院包装)), 5)
                    Else
                        .TextMatrix(lngCurRow, COL_总量) = rsItems!总给予量
                    End If
                Else
                    '计算缺省总量
                    If .TextMatrix(lngCurRow, COL_频率) <> "" Then
                        If InStr(",5,6,", rsItems!类别) > 0 Then
                            rs疗程.Filter = "诊疗项目ID=" & rsItems!诊疗项目ID
                            If Not rs疗程.EOF Then
                                If NVL(rs疗程!疗程, 1) > sng天数 Then
                                    sng天数 = NVL(rs疗程!疗程, 1)
                                End If
                            End If
                        End If

                        If InStr(",5,6,", rsItems!类别) > 0 Then
                            If (Val(.TextMatrix(lngCurRow, COL_单量)) <> 0 _
                                And Val(.TextMatrix(lngCurRow, COL_住院包装)) <> 0 _
                                And Val(.TextMatrix(lngCurRow, COL_剂量系数)) <> 0) Then
                                If Val(.TextMatrix(lngCurRow, COL_频率性质)) = 1 Then
                                    .TextMatrix(lngCurRow, COL_总量) = FormatEx(Calc缺省药品总量( _
                                                                              Val(.TextMatrix(lngCurRow, COL_单量)), 1, 1, 1, "天", "", _
                                                                              Val(.TextMatrix(lngCurRow, COL_剂量系数)), _
                                                                              Val(.TextMatrix(lngCurRow, COL_住院包装)), _
                                                                              Val(.TextMatrix(lngCurRow, COL_可否分零)), _
                                                                              Val(.TextMatrix(lngCurRow, COL_首次用量))), 5)
                                Else
                                    .TextMatrix(lngCurRow, COL_总量) = FormatEx(Calc缺省药品总量( _
                                                                              Val(.TextMatrix(lngCurRow, COL_单量)), sng天数, _
                                                                              Val(.TextMatrix(lngCurRow, COL_频率次数)), _
                                                                              Val(.TextMatrix(lngCurRow, COL_频率间隔)), _
                                                                              .TextMatrix(lngCurRow, COL_间隔单位), _
                                                                              .TextMatrix(lngCurRow, COL_执行时间), _
                                                                              Val(.TextMatrix(lngCurRow, COL_剂量系数)), _
                                                                              Val(.TextMatrix(lngCurRow, COL_住院包装)), _
                                                                              Val(.TextMatrix(lngCurRow, COL_可否分零)), _
                                                                              Val(.TextMatrix(lngCurRow, COL_首次用量))), 5)
                                End If
                                If Val(.TextMatrix(lngCurRow, COL_可否分零)) <> 0 Then
                                    .TextMatrix(lngCurRow, COL_总量) = IntEx(Val(.TextMatrix(lngCurRow, COL_总量)))
                                End If
                            End If
                        Else
                            .TextMatrix(lngCurRow, COL_总量) = Calc缺省药品总量(1, sng天数, _
                                                                        Val(.TextMatrix(lngCurRow, COL_频率次数)), Val(.TextMatrix(lngCurRow, COL_频率间隔)), .TextMatrix(lngCurRow, COL_间隔单位), , , , , _
                                                                        Val(.TextMatrix(lngCurRow, COL_首次用量)))
                        End If
                    End If
                End If
                
                If InStr(",5,6,", rsItems!类别) > 0 And InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") = 0 Then
                    .TextMatrix(lngCurRow, COL_总量) = IntEx(Val(.TextMatrix(lngCurRow, COL_总量)))
                End If
                '处方限量
                If Val(rsItems!处方限量 & "") <> 0 And Not rs规格.EOF Then   '路径生成时 临嘱且按品种下达时，执行语句：Val(rs规格!剂量系数 & "")报错
                    If Val(.TextMatrix(lngCurRow, COL_总量)) > FormatEx(rsItems!处方限量 / Val(rs规格!剂量系数 & "") / Val(rs规格!住院包装 & ""), 5) Then
                        .TextMatrix(lngCurRow, COL_是否超量) = "1"
                    End If
                End If
                If mbln天数 And InStr(",5,6,", rsItems!类别) > 0 And Val(.TextMatrix(lngCurRow, COL_频率性质)) <> 1 Then
                    .TextMatrix(lngCurRow, COL_天数) = IIF(sng天数 = 0, "", sng天数)
                End If
            ElseIf bln配方 Then
                '中药煎法,用法的总量与组成药相同(为了显示)
                .TextMatrix(lngCurRow, COL_总量) = .TextMatrix(lngCurRow - 1, COL_总量)
                .TextMatrix(lngCurRow, COL_总量单位) = .TextMatrix(lngCurRow - 1, COL_总量单位)
            ElseIf NVL(rsItems!期效, 0) = 1 Then
                '其它临嘱都需要总量
                '如果为一次性或计次临嘱缺省总量为1
                If Not IsNull(rsItems!总给予量) Then
                    vsAdvice.TextMatrix(lngCurRow, COL_总量) = rsItems!总给予量
                ElseIf int频率性质 = 1 Or NVL(rsItems!计算方式, 0) = 3 Then
                    vsAdvice.TextMatrix(lngCurRow, COL_总量) = 1
                End If
                If rsItems!类别 = "4" Then
                    .TextMatrix(lngCurRow, COL_总量单位) = .TextMatrix(lngCurRow, COL_住院单位)    '散装单位
                Else
                    .TextMatrix(lngCurRow, COL_总量单位) = NVL(rsItems!计算单位)
                End If
            End If

            '抗菌药物缺省用药目的
            If Val(.TextMatrix(lngCurRow, COL_抗菌等级)) > 0 Then .TextMatrix(lngCurRow, COL_用药目的) = mstrPurMed
            
            '连续用药
            If InStr(",5,6,", rsItems!类别) > 0 Then
                If Set药品连续用药(mlng病人ID, mlng主页ID, Val(.TextMatrix(lngCurRow, COL_诊疗项目ID)), Val(.TextMatrix(lngCurRow, COL_收费细目ID))) Then
                    .TextMatrix(lngCurRow, COL_皮试结果) = "连续用药"
                    .Cell(flexcpData, lngCurRow, COL_皮试结果) = "连续用药"
                End If
            End If
            
            '执行时间,终止时间(总量,频率,执行时间之后)
            If .TextMatrix(lngCurRow, COL_频率) <> "" Then
                If Val(.TextMatrix(lngCurRow, COL_频率性质)) <> 1 Then
                    '可能求出缺省执行时间方案
                    If bln给药途径 Or bln中药用法 Then
                        If Not IsNull(rsItems!时间方案) Then
                            If ExeTimeValid(rsItems!时间方案, Val(.TextMatrix(lngCurRow, COL_频率次数)), _
                                            Val(.TextMatrix(lngCurRow, COL_频率间隔)), .TextMatrix(lngCurRow, COL_间隔单位)) Then
                                .TextMatrix(lngCurRow, COL_执行时间) = rsItems!时间方案
                            End If
                        End If
                        If .TextMatrix(lngCurRow, COL_执行时间) = "" Then
                            .TextMatrix(lngCurRow, COL_执行时间) = Get缺省时间(Val(str适用范围), .TextMatrix(lngCurRow, COL_频率), rsItems!诊疗项目ID)
                        End If
                    ElseIf int频率性质 = 0 Then
                        If Not IsNull(rsItems!时间方案) Then
                            If ExeTimeValid(rsItems!时间方案, Val(.TextMatrix(lngCurRow, COL_频率次数)), _
                                            Val(.TextMatrix(lngCurRow, COL_频率间隔)), .TextMatrix(lngCurRow, COL_间隔单位)) Then
                                .TextMatrix(lngCurRow, COL_执行时间) = rsItems!时间方案
                            End If
                        End If
                        If .TextMatrix(lngCurRow, COL_执行时间) = "" Then
                            .TextMatrix(lngCurRow, COL_执行时间) = Get缺省时间(Val(str适用范围), .TextMatrix(lngCurRow, COL_频率))
                        End If
                    End If
                End If

                If bln采集方法 Then
                    .TextMatrix(lngCurRow, COL_用法) = rsItems!名称
                ElseIf bln给药途径 Or bln中药用法 Then
                    '成药和中药配方的用法,执行时间,配方终止时间
                    If bln中药用法 Then
                        .TextMatrix(lngCurRow, COL_用法) = rsItems!名称
                    End If
                    For j = lngCurRow - 1 To lngRow Step -1
                        If Val(.TextMatrix(j, COL_相关ID)) = .RowData(lngCurRow) Then
                            If bln给药途径 Then
                                .TextMatrix(j, COL_用法) = rsItems!名称 & rsItems!医生嘱托
                            End If
                            .TextMatrix(j, COL_执行时间) = .TextMatrix(lngCurRow, COL_执行时间)
                        Else
                            Exit For
                        End If
                    Next
                ElseIf bln输血途径 Then
                    .TextMatrix(lngCurRow - 1, COL_用法) = rsItems!名称
                    If gbln血库系统 Then
                        If Val(rsItems!操作类型 & "") = 8 And Val(rsItems!执行分类 & "") = 1 Then
                             If .TextMatrix(lngCurRow - 1, COL_检查方法) <> "1" Then
                                 .TextMatrix(lngCurRow - 1, COL_检查方法) = "1"
                             End If
                        End If
                    End If
                End If
            End If

            '开嘱医生和开嘱科室
            If mint场合 = 1 Then
                '与上一行相同
                If lngPreRow <> -1 Then
                    .TextMatrix(lngCurRow, COL_开嘱医生) = .TextMatrix(lngPreRow, COL_开嘱医生)
                    If .TextMatrix(lngCurRow, COL_开嘱医生) Like "*/*" Then
                        .TextMatrix(lngCurRow, COL_开嘱医生) = Mid(.TextMatrix(lngCurRow, COL_开嘱医生), InStr(.TextMatrix(lngCurRow, COL_开嘱医生), "/") + 1)
                    End If
                End If
                '缺省为病人的住院医师或病人科室的第一个医生
                If .TextMatrix(lngCurRow, COL_开嘱医生) = "" Then
                    str医生 = Get住院医师
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, str医生, lng医生ID)
                    .TextMatrix(lngCurRow, COL_开嘱医生) = str医生
                Else
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, .TextMatrix(lngCurRow, COL_开嘱医生), lng医生ID, , , True)
                End If
                .TextMatrix(lngCurRow, COL_开嘱科室ID) = Get开嘱科室ID(lng医生ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            Else
                .TextMatrix(lngCurRow, COL_开嘱医生) = UserInfo.姓名
                .TextMatrix(lngCurRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            End If

            '执行性质
            If InStr(",5,6,7,", rsItems!类别) > 0 Then
                If NVL(rsItems!执行性质, 0) = 5 Then
                    .TextMatrix(lngCurRow, COL_执行性质) = 5
                Else
                    .TextMatrix(lngCurRow, COL_执行性质) = 4
                End If
            ElseIf rsItems!类别 = "4" Then
                .TextMatrix(lngCurRow, COL_执行性质) = 4
            ElseIf bln给药途径 Or bln中药煎法 Or bln中药用法 Or bln采集方法 Then
                .TextMatrix(lngCurRow, COL_执行性质) = NVL(rsItems!执行性质, 0)
            Else
                .TextMatrix(lngCurRow, COL_执行性质) = NVL(rsItems!执行性质, 0)
            End If

            '执行科室ID:为0-叮嘱,5-院外执行时取出为0
            '入院医嘱，取缺省转入临床科室(不管执行性质)
            If rsItems!类别 = "Z" And NVL(rsItems!操作类型, 0) = 2 And mlng病人性质 = 1 Then
                If NVL(rsItems!执行科室ID, 0) <> 0 Then
                    .TextMatrix(lngCurRow, COL_执行科室ID) = NVL(rsItems!执行科室ID, 0)
                Else
                    lngTmp = 0
                    Call Get临床科室(2, mlng病人科室id, lngTmp, , True, False, True)
                    .TextMatrix(lngCurRow, COL_执行科室ID) = lngTmp
                End If
            ElseIf rsItems!类别 = "Z" And (NVL(rsItems!操作类型, 0) = 3 Or NVL(rsItems!操作类型, 0) = 7) Then
                If NVL(rsItems!执行科室ID, 0) <> 0 Then
                    .TextMatrix(lngCurRow, COL_执行科室ID) = NVL(rsItems!执行科室ID, 0)
                Else
                    '转科、会诊医嘱不缺省
                    .TextMatrix(lngCurRow, COL_执行科室ID) = 0
                End If
            ElseIf Val(rsItems!诊疗项目ID & "") = 0 Then
                '自由录入医嘱执行科室和录入自由录入医嘱时的默认科室保持一直
                .TextMatrix(lngCurRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, "*", 0, 0, 4, mlng病人科室id, 0, NVL(rsItems!期效, 0), IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
            ElseIf InStr(",0,5,", Val(.TextMatrix(lngCurRow, COL_执行性质))) = 0 Then
                If NVL(rsItems!执行科室ID, 0) <> 0 Then
                    If InStr(",5,6,7,", rsItems!类别) > 0 Then
                        str药房IDs = Get可用药房IDs(rsItems!类别, rsItems!诊疗项目ID, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), mlng病人科室id, 2)
                        If InStr("," & str药房IDs & ",", "," & rsItems!执行科室ID & ",") > 0 Then
                            .TextMatrix(lngCurRow, COL_执行科室ID) = NVL(rsItems!执行科室ID, 0)
                        End If
                    ElseIf rsItems!类别 = "4" Then
                        str药房IDs = Get可用发料部门IDs(Val(.TextMatrix(lngCurRow, COL_收费细目ID)), mlng病人科室id, 2, Val(.TextMatrix(lngCurRow, COL_诊疗项目ID)))
                        If InStr("," & str药房IDs & ",", "," & rsItems!执行科室ID & ",") > 0 Then
                            .TextMatrix(lngCurRow, COL_执行科室ID) = NVL(rsItems!执行科室ID, 0)
                        End If
                    ElseIf rsItems!类别 = "*" Or Val(.TextMatrix(lngCurRow, COL_执行性质)) = 4 Then
                        '自由医嘱或者"4-指定科室"时才取,其它的固定生成
                        .TextMatrix(lngCurRow, COL_执行科室ID) = NVL(rsItems!执行科室ID, 0)

                        '检查执行科室的有效性
                        If Val(.TextMatrix(lngCurRow, COL_执行科室ID)) <> 0 Then
                            If CheckExecDeptValidate(Val(.TextMatrix(lngCurRow, COL_执行科室ID)), mlng病人科室id, IIF(mlng病人性质 = 1, 1, 2), Val("" & rsItems!诊疗项目ID)) = False Then
                                .TextMatrix(lngCurRow, COL_执行科室ID) = 0
                            End If
                        End If
                    End If
                End If
                If Val(.TextMatrix(lngCurRow, COL_执行科室ID)) = 0 Then
                    '药品类的整个成套相同
                    If rsItems!类别 = "5" Then
                        If lng西药房ID = 0 Then
                            lng西药房ID = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsItems!类别, rsItems!诊疗项目ID, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), 4, mlng病人科室id, 0, NVL(rsItems!期效, 0), IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                        End If
                        .TextMatrix(lngCurRow, COL_执行科室ID) = lng西药房ID
                    ElseIf rsItems!类别 = "6" Then
                        If lng成药房ID = 0 Then
                            lng成药房ID = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsItems!类别, rsItems!诊疗项目ID, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), 4, mlng病人科室id, 0, NVL(rsItems!期效, 0), IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                        End If
                        .TextMatrix(lngCurRow, COL_执行科室ID) = lng成药房ID
                    ElseIf rsItems!类别 = "7" Then
                        If lng中药房ID = 0 Then
                            lng中药房ID = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsItems!类别, rsItems!诊疗项目ID, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), 4, mlng病人科室id, 0, NVL(rsItems!期效, 0), IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                        End If
                        .TextMatrix(lngCurRow, COL_执行科室ID) = lng中药房ID
                    ElseIf rsItems!类别 = "4" Then
                        If lng发料部门ID = 0 Then
                            lng发料部门ID = Get收费执行科室ID(mlng病人ID, mlng主页ID, rsItems!类别, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), 4, mlng病人科室id, 0, IIF(mlng病人性质 = 1, 1, 2), , 1, 0, 2)
                        End If
                        .TextMatrix(lngCurRow, COL_执行科室ID) = lng发料部门ID
                    ElseIf rsItems!类别 <> "*" Then
                        '之前先求出开嘱科室
                        .TextMatrix(lngCurRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsItems!类别, _
                            NVL(rsItems!诊疗项目ID, 0), 0, Val(.TextMatrix(lngCurRow, COL_执行性质)), mlng病人科室id, _
                            Val(.TextMatrix(lngCurRow, COL_开嘱科室ID)), NVL(rsItems!期效, 0), IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                    End If
                End If
            End If
            
            '执行科室名称
            If bln采集方法 Then
                .TextMatrix(lngCurRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngCurRow - 1, COL_执行科室ID)), "名称")
            ElseIf bln中药用法 Then
                .TextMatrix(lngCurRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngCurRow - 2, COL_执行科室ID)), "名称")
            Else
                .TextMatrix(lngCurRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngCurRow, COL_执行科室ID)), "名称")
            End If
            
            If bln给药途径 Then
                For j = lngCurRow - 1 To .FixedRows Step -1
                    If Val(.TextMatrix(j, COL_相关ID)) = 0 Then Exit For
                    If Val(.TextMatrix(j, COL_执行性质)) = 5 And Val(.TextMatrix(lngCurRow, COL_执行性质)) <> 5 Then
                        If Val(.TextMatrix(j, COL_执行标记)) = 2 Then
                            .TextMatrix(j, COL_医嘱执行性质) = "不取药"
                        Else
                            .TextMatrix(j, COL_医嘱执行性质) = "自备药"
                        End If
                    ElseIf Val(.TextMatrix(j, COL_执行性质)) <> 5 And Val(.TextMatrix(lngCurRow, COL_执行性质)) = 5 Then
                        .TextMatrix(j, COL_医嘱执行性质) = "离院带药"
                    Else
                        .TextMatrix(j, COL_医嘱执行性质) = IIF(Val(.TextMatrix(j, COL_执行标记)) = 1, "自取药", "")
                    End If
                Next
            ElseIf bln中药用法 Then
                If Val(.TextMatrix(lngCurRow - 2, COL_执行性质)) = 5 And Val(.TextMatrix(lngCurRow, COL_执行性质)) <> 5 Then
                    If Val(.TextMatrix(lngCurRow - 2, COL_执行标记)) = 2 Then
                        .TextMatrix(lngCurRow, COL_医嘱执行性质) = "不取药"
                    Else
                        .TextMatrix(lngCurRow, COL_医嘱执行性质) = "自备药"
                    End If
                ElseIf Val(.TextMatrix(lngCurRow - 2, COL_执行性质)) <> 5 And Val(.TextMatrix(lngCurRow, COL_执行性质)) = 5 Then
                    .TextMatrix(lngCurRow, COL_医嘱执行性质) = "离院带药"
                Else
                    .TextMatrix(lngCurRow, COL_医嘱执行性质) = IIF(Val(.TextMatrix(lngCurRow - 2, COL_执行标记)) = 1, "自取药", "")
                End If
                .TextMatrix(lngCurRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngCurRow - 2, COL_执行科室ID)), "名称")
            End If
            
            '医生嘱托
            .TextMatrix(lngCurRow, COL_医生嘱托) = NVL(rsItems!医生嘱托)
            .Cell(flexcpData, lngCurRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, Val(.TextMatrix(lngCurRow, COL_收费细目ID)), "", 0, "", .TextMatrix(lngCurRow, COL_诊疗项目ID) & "|1|1")

            '紧急标志:可以在界面先统一设置
            If IsDate(.Cell(flexcpData, lngCurRow, COL_开始时间)) Then
                If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                    .TextMatrix(lngCurRow, COL_标志) = 2
                ElseIf DateDiff("n", CDate(.Cell(flexcpData, lngCurRow, COL_开始时间)), vCurDate) > gint补录间隔 Then
                    .TextMatrix(lngCurRow, COL_标志) = 2
                Else
                    .TextMatrix(lngCurRow, COL_标志) = chk紧急.value
                End If
            End If

            '开嘱时间
            If Val(.TextMatrix(lngCurRow, COL_标志)) = 2 And IsDate(.Cell(flexcpData, lngCurRow, COL_开始时间)) Then
                .TextMatrix(lngCurRow, COL_开嘱时间) = .TextMatrix(lngCurRow, COL_开始时间)
                .Cell(flexcpData, lngCurRow, COL_开嘱时间) = .Cell(flexcpData, lngCurRow, COL_开始时间)
            Else
                .TextMatrix(lngCurRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngCurRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
            End If

            If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(lngCurRow, COL_抗菌等级)) And (.TextMatrix(lngCurRow, COL_标志) <> "1" Or .TextMatrix(lngCurRow, COL_期效) = "长嘱") _
               Or gbln手术分级管理 And (.TextMatrix(lngCurRow, COL_类别) = "F" Or .TextMatrix(lngCurRow, COL_类别) = "G") Then

                .TextMatrix(lngCurRow, COL_审核状态) = 1
         
            End If
            If .TextMatrix(lngCurRow, COL_类别) = "E" And .TextMatrix(lngCurRow, COL_操作类型) = "8" And Val(.TextMatrix(lngCurRow, COL_相关ID)) <> 0 Then
                strSQL = ""
                strSQL = GetBloodState(IIF(.TextMatrix(lngCurRow, COL_标志) = "1", 1, 0), Val(.TextMatrix(lngCurRow, COL_执行分类)))
                .TextMatrix(lngCurRow - 1, COL_审核状态) = strSQL
                .TextMatrix(lngCurRow, COL_审核状态) = strSQL
            End If
            Call SetRow标志图标(lngCurRow, 1)

            '读取药品库存
            If InStr(",5,6,7,", .TextMatrix(lngCurRow, COL_类别)) > 0 Or .TextMatrix(lngCurRow, COL_类别) = "4" And Val(.TextMatrix(lngCurRow, COL_跟踪在用)) = 1 Then
                If Val(.TextMatrix(lngCurRow, COL_收费细目ID)) <> 0 And Val(.TextMatrix(lngCurRow, COL_执行科室ID)) <> 0 Then
                    .TextMatrix(lngCurRow, COL_库存) = GetStock(Val(.TextMatrix(lngCurRow, COL_收费细目ID)), Val(.TextMatrix(lngCurRow, COL_执行科室ID)))
                End If
            End If

            '----------------------
            '毒麻精药品标识:中药配方及组成味中药不处理
            If InStr(",5,6,", .TextMatrix(lngCurRow, COL_类别)) > 0 And .TextMatrix(lngCurRow, COL_毒理分类) <> "" Then
                If InStr(",麻醉药,毒性药,精神药,精神I类,精神II类,", .TextMatrix(lngCurRow, COL_毒理分类)) > 0 Then
                    .Cell(flexcpFontBold, lngCurRow, col_医嘱内容) = True
                End If
            End If

            '隐蔽一些附加行
            If (InStr(",F,G,D,7,E,C,", rsItems!类别) > 0 And Not IsNull(rsItems!相关序号)) Or bln给药途径 Then
                .RowHidden(lngCurRow) = True
            End If

            '如果是备选医嘱
            If mbytUseType = 1 Then
                .TextMatrix(lngCurRow, COL_是否备选) = Val("" & rsItems!是否备选)
            End If

            '医嘱内容
            If Not .RowHidden(lngCurRow) Then
                If IsNull(rsItems!诊疗项目ID) Then
                    .TextMatrix(lngCurRow, col_医嘱内容) = rsItems!医嘱内容    '自由录入医嘱
                ElseIf InStr(",F,D,", rsItems!类别) > 0 And IsNull(rsItems!相关序号) Then
                    .TextMatrix(lngCurRow, col_医嘱内容) = rsItems!名称    '临时
                Else
                    .TextMatrix(lngCurRow, col_医嘱内容) = AdviceTextMake(lngCurRow)
                End If
            Else
                .TextMatrix(lngCurRow, col_医嘱内容) = rsItems!名称
            End If

            '产生新嘱时，在可见行读取诊疗项目附项串，用于检查，不用于保存
            If Not .RowHidden(lngCurRow) Then
                If Not bln中药用法 Then
                    If bln采集方法 Then
                        j = .FindRow(CStr(.RowData(lngCurRow)), , COL_相关ID)
                        If j <> -1 Then
                            .TextMatrix(lngCurRow, COL_附项) = Get医嘱项目附件(Val(.TextMatrix(j, COL_诊疗项目ID)))
                        End If
                    Else
                        .TextMatrix(lngCurRow, COL_附项) = Get医嘱项目附件(Val(.TextMatrix(lngCurRow, COL_诊疗项目ID)))
                    End If
                    If .TextMatrix(lngCurRow, COL_附项) <> "" Then
                        str附项 = str附项 & vbCrLf & "●" & .TextMatrix(lngCurRow, col_医嘱内容)
                    End If
                End If
            End If

            If lngPreRow = -1 And Not .RowHidden(lngCurRow) Then lngPreRow = lngCurRow

            '----------------------
            intCount = intCount + 1
            rsItems.MoveNext
        Next
        '路径病人生成备选医嘱的时候没有增加空行所以要修正下当前行
        lngRow = lngRow + IIF(intType = 3, 1, 0)
        '--------------------------------------------------
        '再取检查和手术的医嘱内容
        For i = lngRow To lngCurRow
            If InStr(",F,D,", .TextMatrix(i, COL_类别)) > 0 And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                .TextMatrix(i, col_医嘱内容) = AdviceTextMake(i)
            End If

            '计算诊疗单价
            If Not .RowHidden(i) And .TextMatrix(i, COL_单价) = "" Then
                .TextMatrix(i, COL_单价) = GetItemPrice(i)
            End If
        Next

        '调整受影响行的序号
        Call AdviceSet医嘱序号(lngCurRow + 1, intCount - IIF(intType = 3, 1, 0))
        '产生假医嘱ID
        For i = lngRow To lngCurRow
            dbl相关ID = .RowData(i)
                        If mbytUseType = 1 Then .TextMatrix(i, COL_医嘱内容ID) = CLng(dbl相关ID)
            .RowData(i) = GetNext医嘱ID
            For j = i - 1 To lngRow Step -1
                If Val(.TextMatrix(j, COL_相关ID)) = dbl相关ID Then
                    .TextMatrix(j, COL_相关ID) = .RowData(i)
                Else
                    Exit For
                End If
            Next
            For j = i + 1 To lngCurRow
                If Val(.TextMatrix(j, COL_相关ID)) = dbl相关ID Then
                    .TextMatrix(j, COL_相关ID) = .RowData(i)
                Else
                    Exit For
                End If
            Next
            '如果是备选医嘱新增，则默认勾选
            If intType = 3 Then
                .Cell(flexcpChecked, i, COL_选择) = 1
            End If
        Next
        '--产生申请序号
        If gblnIn必用 Then Call MakeAppNo(2, lngRow, lngCurRow)
        
        '一并给药的符号标志
        For i = lngRow To lngCurRow
            If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                If Val(.TextMatrix(i - 1, COL_相关ID)) = .RowData(i) And InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                    Call SetTag一并给药(i - 1)
                End If
            End If
        Next
        
        Call Set医嘱超量(lngRow, lngCurRow)
        '路径病人添加医嘱时检查是否是路径内项目
        If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngCurRow)

        '全部都不允许选择时，隐藏选择列
        If mbytUseType = 1 Then
            .ColHidden(COL_选择) = bln允许选择 = False
            If bln允许选择 Then
                .Editable = flexEDKbdMouse
            End If
            Call .AutoSize(col_医嘱内容)
        End If

        '--------------------------------------------------
        If .RowHidden(lngRow) Then    '寻找可见行(如配方和检验之后)
            For i = lngRow + 1 To .Rows - 1
                If Not .RowHidden(i) And .RowData(i) <> 0 Then
                    lngRow = i: Exit For
                End If
            Next
        End If

        .Row = lngRow: .Col = col_医嘱内容
        Call .ShowCell(.Row, .Col)
        .Redraw = flexRDDirect
        mblnRowChange = True
    End With

    '按预定规则重新排序（生成时）
    If mbytUseType = 1 And intType = 2 Then Call AdviceSort

    Screen.MousePointer = 0

    If str附项 <> "" Then
        MsgBox "以下医嘱需要填写申请附项，请注意填写：" & vbCrLf & str附项, vbInformation, gstrSysName
    End If
    If str高危药品 <> "" Then
        MsgBox "以下医嘱是高危药品：" & str高危药品, vbInformation, gstrSysName
    End If
    Exit Sub
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function GetPreRow中药房(lngRow As Long) As Long
'功能：获取上一或下一中药行的执行科室
    Dim lngDrugRow As Long, lngCopyRow As Long
    
    lngDrugRow = -1
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
    If lngCopyRow <> -1 Then
        If RowIn配方行(lngCopyRow) Then
            '如果上一有效行是中药配方的,则取它的第一中药行
            lngDrugRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngCopyRow)), , COL_相关ID)
        End If
    End If
    
    If lngDrugRow <> -1 Then '缺省与上一配方行相同
        GetPreRow中药房 = Val("" & vsAdvice.TextMatrix(lngDrugRow, COL_执行科室ID))
    End If
End Function

Private Function AdviceSet中药配方(lng诊疗项目ID As Long, ByVal lngRow As Long, ByVal lng用法ID As Long, _
    ByVal strExtData As String, Optional rsCurr As ADODB.Recordset, Optional ByVal str摘要 As String, Optional ByVal lng配方ID As Long) As Long
'功能：(重新)处理中药配方的缺省医嘱数据
'参数：lng诊疗项目ID=输入的中药配方ID或单味中药ID
'      lngRow=当前输入行
'      lng用法ID=缺省中药用法ID
'      strExtData=包含配方组成味药及煎法数据:规格ID1,数量,脚注;规格ID2,数量,脚注...|中药煎法|中药形态|付数|药房ID|煎量"
'      rsCurr=如果是修改了配方内容后调用,则包含要保持的一些当前值
'      str摘要=医保摘要
'返回：处理后的中药配方的当前显示行号
    Dim rsItems As New ADODB.Recordset '中药详细信息
    Dim rsUse As New ADODB.Recordset '中药用法信息
    Dim rs煎法 As New ADODB.Recordset '中药煎法项目信息
    Dim rs用法 As New ADODB.Recordset '中药用法项目信息
    Dim rsTmp As ADODB.Recordset
    Dim arr中药s As Variant, str中药IDs As String, lng相关ID As Long
    Dim lngCopyRow As Long '缺省参照行
    Dim lngDrugRow As Long '如果缺省参照行是中药配方,则为该配方的第一个中药行
    Dim lngFirstRow As Long '当前配方的第一个中药行
    Dim vCurDate As Date
    Dim strSQL As String, i As Long
    Dim blnOutOfRange As Boolean
    
    Dim str频率 As String, int频率次数 As Integer, int频率间隔 As Integer, str间隔单位 As String
    Dim lng煎法ID As Long, int疗程 As Integer
    Dim str医生 As String, lng医生ID As Long
    Dim lng形态 As Long
    Dim str高危药品 As String, str煎量 As String
    Dim str配方名称 As String
    Dim str医嘱内容 As String
        
    On Error GoTo errH
    
    '取上一或下一有效行,某些内容缺省与该行相同
    lngDrugRow = -1
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
    If lngCopyRow <> -1 Then
        If RowIn配方行(lngCopyRow) Then
            '如果上一有效行是中药配方的,则取它的第一中药行
            lngDrugRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngCopyRow)), , COL_相关ID)
        End If
    End If
    
    '获取相关数据库信息
    '------------------
    arr中药s = Split(Split(strExtData, "|")(0), ";")
    For i = 0 To UBound(arr中药s)
        str中药IDs = str中药IDs & "," & CStr(Split(arr中药s(i), ",")(0))
    Next
    str中药IDs = Mid(str中药IDs, 2)
    lng煎法ID = Val(Split(strExtData, "|")(1))
    lng形态 = Val(Split(strExtData, "|")(2))
    str煎量 = Split(strExtData, "|")(5)
    
    '配方用法信息:直接输入配方时才有可能有,输入单味中药无
    strSQL = "Select A.用法ID,A.频次,A.疗程,A.医生嘱托" & _
        " From 诊疗用法用量 A,诊疗项目目录 B" & _
        " Where A.用法ID=B.ID And B.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3)" & _
        " And Nvl(A.性质,0)=0 And A.项目ID=[1] And (B.站点='" & gstrNodeNo & "' Or B.站点 is Null)" & _
        " And (b.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or b.撤档时间 is NULL)"
    Set rsUse = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng诊疗项目ID)
    If Not rsUse.EOF Then lng用法ID = rsUse!用法ID '缺省设置的中药配方用法优先
    
    '配方组成味中药信息:中药无规格概念,对应的的规格记录一定有且只有一条
    strSQL = "Select /*+ rule*/A.计算规则,A.站点,A.类别,A.分类ID,A.ID,A.编码,A.名称,A.标本部位,A.计算单位,A.计算方式,A.执行频率,A.适用性别," & _
        "A.单独应用,A.组合项目,A.操作类型,A.执行安排,A.执行科室,A.服务对象,A.计价性质,A.参考目录ID,A.人员ID,A.建档时间,A.撤档时间," & _
        "A.录入限量,A.试管编码,A.执行分类,A.执行标记,B.药品ID,B.剂量系数,B.住院包装,B.住院单位,B.住院可否分零 As 可否分零,C.处方限量,C.处方职务,c.临床自管药,b.高危药品,b.是否易至跌倒" & _
        " From 诊疗项目目录 A,药品规格 B,药品特性 C" & _
        " Where A.ID=B.药名ID And A.ID=C.药名ID And B.药品ID IN(Select Column_Value From Table(f_Num2list([1])))"
    Set rsItems = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str中药IDs)
    
    '配方煎法项目信息
    Set rs煎法 = Get诊疗项目记录(lng煎法ID)
    
    '配方用法项目信息
    Set rs用法 = Get诊疗项目记录(lng用法ID)
    
    '加入配方组成味中药行:按照用户输入顺序
    '--------------------------------------------------------------------------------------
    '--------------------------------------------------------------------------------------
    mblnRowChange = False
    vCurDate = zlDatabase.Currentdate
    
    '中药用法的医嘱ID,ID顺序与序号不一定一致
    If Not rsCurr Is Nothing Then
        '修改了配方中的内容,用法行标记为修改,医嘱ID不变
        lng相关ID = rsCurr!医嘱ID
    Else
        '新输入的中药配方
        lng相关ID = GetNext医嘱ID
    End If
    
    For i = 0 To UBound(arr中药s)
        rsItems.Filter = "药品ID=" & CStr(Split(arr中药s(i), ",")(0)) '规格ID
        
        vsAdvice.AddItem "", lngRow
        
        vsAdvice.RowHidden(lngRow) = True
        vsAdvice.RowData(lngRow) = GetNext医嘱ID
        vsAdvice.TextMatrix(lngRow, COL_相关ID) = lng相关ID '对应到后面的中药用法行
        vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1 '新增
        vsAdvice.TextMatrix(lngRow, COL_期效) = zlCommFun.GetNeedName(cbo期效.Text)
        vsAdvice.TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
        vsAdvice.TextMatrix(lngRow, COL_状态) = IIF(mbln暂存, -1, 1) '新开
        vsAdvice.TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
        Call AdviceSet医嘱序号(lngRow + 1, 1) '调整序号
        
        vsAdvice.TextMatrix(lngRow, COL_类别) = rsItems!类别
        vsAdvice.TextMatrix(lngRow, col_医嘱内容) = rsItems!名称
        vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) = rsItems!ID
        vsAdvice.TextMatrix(lngRow, COL_计算方式) = NVL(rsItems!计算方式, 0)
        vsAdvice.TextMatrix(lngRow, COL_频率性质) = NVL(rsItems!执行频率, 0)
        vsAdvice.TextMatrix(lngRow, COL_操作类型) = NVL(rsItems!操作类型)
        vsAdvice.TextMatrix(lngRow, COL_单独应用) = NVL(rsItems!单独应用)
        vsAdvice.TextMatrix(lngRow, COL_执行分类) = NVL(rsItems!执行分类, 0)
        
        vsAdvice.TextMatrix(lngRow, COL_单量) = FormatEx(Val(Split(arr中药s(i), ",")(1)), 5) '单味药的单次用量
        vsAdvice.TextMatrix(lngRow, COL_单量单位) = NVL(rsItems!计算单位)
        vsAdvice.TextMatrix(lngRow, COL_医生嘱托) = CStr(Split(arr中药s(i), ",")(2)) '单味药的脚注
        vsAdvice.Cell(flexcpData, lngRow, COL_医生嘱托) = str摘要
        
        '规格信息
        vsAdvice.TextMatrix(lngRow, COL_收费细目ID) = rsItems!药品ID
        vsAdvice.TextMatrix(lngRow, COL_剂量系数) = rsItems!剂量系数
        vsAdvice.TextMatrix(lngRow, COL_住院单位) = rsItems!住院单位
        vsAdvice.TextMatrix(lngRow, COL_住院包装) = rsItems!住院包装
        vsAdvice.TextMatrix(lngRow, COL_可否分零) = NVL(rsItems!可否分零, 0)
        vsAdvice.TextMatrix(lngRow, COL_处方限量) = NVL(rsItems!处方限量)
        vsAdvice.TextMatrix(lngRow, COL_处方职务) = NVL(rsItems!处方职务)
        vsAdvice.TextMatrix(lngRow, COL_临床自管药) = rsItems!临床自管药 & ""
        vsAdvice.TextMatrix(lngRow, COL_高危药品) = Val(rsItems!高危药品 & "")
        vsAdvice.TextMatrix(lngRow, COL_易跌倒) = Val(rsItems!是否易至跌倒 & "")
        If Val(vsAdvice.TextMatrix(lngRow, COL_高危药品)) <> 0 Then
            str高危药品 = str高危药品 & vbCrLf & vsAdvice.TextMatrix(lngRow, col_医嘱内容) & ":" & Decode(Val(vsAdvice.TextMatrix(lngRow, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级；"
        End If
        vsAdvice.Cell(flexcpData, lngRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, Val(vsAdvice.TextMatrix(lngRow, COL_收费细目ID)), "", 0, "", vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) & "||2")
        '计价性质:各自独立
        vsAdvice.TextMatrix(lngRow, COL_计价性质) = NVL(rsItems!计价性质, 0)
        
        If lngFirstRow <> 0 Then
            '与上一行已设置的组成中药相同
            vsAdvice.TextMatrix(lngRow, COL_执行性质) = vsAdvice.TextMatrix(lngFirstRow, COL_执行性质)
            vsAdvice.TextMatrix(lngRow, COL_执行科室ID) = vsAdvice.TextMatrix(lngFirstRow, COL_执行科室ID)
            vsAdvice.TextMatrix(lngRow, COL_频率) = vsAdvice.TextMatrix(lngFirstRow, COL_频率)
            vsAdvice.TextMatrix(lngRow, COL_频率次数) = vsAdvice.TextMatrix(lngFirstRow, COL_频率次数)
            vsAdvice.TextMatrix(lngRow, COL_频率间隔) = vsAdvice.TextMatrix(lngFirstRow, COL_频率间隔)
            vsAdvice.TextMatrix(lngRow, COL_间隔单位) = vsAdvice.TextMatrix(lngFirstRow, COL_间隔单位)
            vsAdvice.TextMatrix(lngRow, COL_总量) = vsAdvice.TextMatrix(lngFirstRow, COL_总量)
            vsAdvice.TextMatrix(lngRow, COL_执行时间) = vsAdvice.TextMatrix(lngFirstRow, COL_执行时间)
            
            vsAdvice.TextMatrix(lngRow, COL_开始时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开始时间)
            vsAdvice.Cell(flexcpData, lngRow, COL_开始时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开始时间)
            
            vsAdvice.TextMatrix(lngRow, COL_终止时间) = vsAdvice.TextMatrix(lngFirstRow, COL_终止时间)
            vsAdvice.Cell(flexcpData, lngRow, COL_终止时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_终止时间)
            
            vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱医生)
            vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID)
            
            vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱时间)
            vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开嘱时间)
            
            vsAdvice.TextMatrix(lngRow, COL_标志) = vsAdvice.TextMatrix(lngFirstRow, COL_标志)
        ElseIf Not rsCurr Is Nothing Then
            '修改了配方内容后重新设置,保持与当前的值
            
            '执行性质:修改时根据当前界面设置决定
            vsAdvice.TextMatrix(lngRow, COL_执行性质) = Decode(NVL(rsCurr!执行性质), "自备药", 5, 4)
            '执行科室
            vsAdvice.TextMatrix(lngRow, COL_执行科室ID) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_执行性质)) = 5, 0, Val("" & rsCurr!执行科室ID))
            
            vsAdvice.TextMatrix(lngRow, COL_频率) = NVL(rsCurr!频率)
            vsAdvice.TextMatrix(lngRow, COL_频率次数) = NVL(rsCurr!频率次数)
            vsAdvice.TextMatrix(lngRow, COL_频率间隔) = NVL(rsCurr!频率间隔)
            vsAdvice.TextMatrix(lngRow, COL_间隔单位) = NVL(rsCurr!间隔单位)
            vsAdvice.TextMatrix(lngRow, COL_总量) = NVL(rsCurr!总量)
            vsAdvice.TextMatrix(lngRow, COL_执行时间) = NVL(rsCurr!执行时间)
            
            vsAdvice.TextMatrix(lngRow, COL_开始时间) = Format(NVL(rsCurr!开始时间), "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_开始时间) = CStr(NVL(rsCurr!开始时间))
            
            vsAdvice.TextMatrix(lngRow, COL_终止时间) = Format(NVL(rsCurr!终止时间), "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_终止时间) = CStr(NVL(rsCurr!终止时间))
            
            vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = NVL(rsCurr!开嘱医生)
            vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = NVL(rsCurr!开嘱科室id)
            
            vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = Format(NVL(rsCurr!开嘱时间), "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = CStr(NVL(rsCurr!开嘱时间))
            
            vsAdvice.TextMatrix(lngRow, COL_标志) = NVL(rsCurr!标志)
        Else
             '执行性质:中药配方组成中药相同,缺省=4-指定科室,5-自备药
            vsAdvice.TextMatrix(lngRow, COL_执行性质) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_临床自管药)) = 1, 5, 4)
        
            '执行科室(先在配方界面选择)
            vsAdvice.TextMatrix(lngRow, COL_执行科室ID) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_执行性质)) = 5, 0, Val(Split(strExtData, "|")(4)))
            
            
            '执行频率
            '根据用法里面设置的优先
            If Not rsUse.EOF Then
                If Not IsNull(rsUse!频次) Then
                    Call Get频率信息_编码(rsUse!频次, str频率, int频率次数, int频率间隔, str间隔单位)
                    vsAdvice.TextMatrix(lngRow, COL_频率) = str频率
                    vsAdvice.TextMatrix(lngRow, COL_频率次数) = int频率次数
                    vsAdvice.TextMatrix(lngRow, COL_频率间隔) = int频率间隔
                    vsAdvice.TextMatrix(lngRow, COL_间隔单位) = str间隔单位
                End If
            End If
            '或缺省与上一行相同
            If vsAdvice.TextMatrix(lngRow, COL_频率) = "" And lngDrugRow <> -1 Then
                If Val(vsAdvice.TextMatrix(lngDrugRow, COL_EDIT)) = 1 And vsAdvice.TextMatrix(lngDrugRow, COL_频率) <> "" Then
                    vsAdvice.TextMatrix(lngRow, COL_频率) = vsAdvice.TextMatrix(lngDrugRow, COL_频率)
                    vsAdvice.TextMatrix(lngRow, COL_频率次数) = vsAdvice.TextMatrix(lngDrugRow, COL_频率次数)
                    vsAdvice.TextMatrix(lngRow, COL_频率间隔) = vsAdvice.TextMatrix(lngDrugRow, COL_频率间隔)
                    vsAdvice.TextMatrix(lngRow, COL_间隔单位) = vsAdvice.TextMatrix(lngDrugRow, COL_间隔单位)
                End If
            End If
            '或取缺省值
            If vsAdvice.TextMatrix(lngRow, COL_频率) = "" Then
                Call Get缺省频率(NVL(rsItems!ID, 0), IIF(mlng病人性质 = 1, 1, 2), str频率, int频率次数, int频率间隔, str间隔单位)
                vsAdvice.TextMatrix(lngRow, COL_频率) = str频率
                vsAdvice.TextMatrix(lngRow, COL_频率次数) = int频率次数
                vsAdvice.TextMatrix(lngRow, COL_频率间隔) = int频率间隔
                vsAdvice.TextMatrix(lngRow, COL_间隔单位) = str间隔单位
            End If
            
            '总量(付数):临嘱才需要,非散装形态已确定付数
            If Val(Split(strExtData, "|")(3)) > 1 Or lng形态 <> 0 Then
                vsAdvice.TextMatrix(lngRow, COL_总量) = Val(Split(strExtData, "|")(3))
            Else
                If vsAdvice.TextMatrix(lngRow, COL_期效) = "临嘱" And vsAdvice.TextMatrix(lngRow, COL_频率) <> "" Then
                    int疗程 = 1
                    If Not rsUse.EOF Then int疗程 = NVL(rsUse!疗程, 1)
                    '配方付数
                    vsAdvice.TextMatrix(lngRow, COL_总量) = Calc缺省药品总量(1, int疗程, _
                            Val(vsAdvice.TextMatrix(lngRow, COL_频率次数)), _
                            Val(vsAdvice.TextMatrix(lngRow, COL_频率间隔)), _
                            vsAdvice.TextMatrix(lngRow, COL_间隔单位), , , , , _
                            Val(vsAdvice.TextMatrix(lngRow, COL_首次用量)))
                End If
            End If
            
            '执行时间
            If lngDrugRow <> -1 Then '缺省与上一行相同
                If vsAdvice.TextMatrix(lngRow, COL_频率) = vsAdvice.TextMatrix(lngDrugRow, COL_频率) Then
                    vsAdvice.TextMatrix(lngRow, COL_执行时间) = vsAdvice.TextMatrix(lngDrugRow, COL_执行时间)
                End If
            End If
            If vsAdvice.TextMatrix(lngRow, COL_执行时间) = "" Then '缺省时间方案
                vsAdvice.TextMatrix(lngRow, COL_执行时间) = Get缺省时间(2, vsAdvice.TextMatrix(lngRow, COL_频率), lng用法ID)
            End If
            
            '开始时间
            If IsDate(msk开始时间.Text) Then
                vsAdvice.TextMatrix(lngRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                vsAdvice.Cell(flexcpData, lngRow, COL_开始时间) = msk开始时间.Text
            End If
            
            '开嘱医生和开嘱科室
            If mint场合 = 1 Then '护士使用时
                '与上一行相同
                If lngCopyRow <> -1 Then
                    vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = vsAdvice.TextMatrix(lngCopyRow, COL_开嘱医生)
                    If vsAdvice.TextMatrix(lngRow, COL_开嘱医生) Like "*/*" Then
                        vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = Mid(vsAdvice.TextMatrix(lngRow, COL_开嘱医生), InStr(vsAdvice.TextMatrix(lngRow, COL_开嘱医生), "/") + 1)
                    End If
                End If
                '缺省为病人的住院医师或病人科室的第一个医生
                If vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = "" Then
                    str医生 = Get住院医师
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, str医生, lng医生ID)
                    vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = str医生
                Else
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, vsAdvice.TextMatrix(lngRow, COL_开嘱医生), lng医生ID, , , True)
                End If
                vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(lng医生ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            Else
                vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
                vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            End If
            
            '紧急标志
            If IsDate(vsAdvice.Cell(flexcpData, lngRow, COL_开始时间)) Then
                If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                    vsAdvice.TextMatrix(lngRow, COL_标志) = 2
                ElseIf DateDiff("n", CDate(vsAdvice.Cell(flexcpData, lngRow, COL_开始时间)), vCurDate) > gint补录间隔 Then
                    vsAdvice.TextMatrix(lngRow, COL_标志) = 2
                Else
                    vsAdvice.TextMatrix(lngRow, COL_标志) = chk紧急.value
                End If
            End If
            
            vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
        End If
        
        '---------------------------------------
        If lngFirstRow = 0 Then lngFirstRow = lngRow '该中药配方的第一个组成中药行
        lngRow = lngRow + 1 '保持当前输入行位置
    Next
    
    '加入中药配方煎法行
    '--------------------------------------------------------------------------------------
    '--------------------------------------------------------------------------------------
    vsAdvice.AddItem "", lngRow
    vsAdvice.RowHidden(lngRow) = True
    vsAdvice.RowData(lngRow) = GetNext医嘱ID
    vsAdvice.TextMatrix(lngRow, COL_相关ID) = lng相关ID
    vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1 '新增
    vsAdvice.TextMatrix(lngRow, COL_期效) = vsAdvice.TextMatrix(lngFirstRow, COL_期效)
    vsAdvice.TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
    vsAdvice.TextMatrix(lngRow, COL_状态) = IIF(mbln暂存, -1, 1) '新开
    vsAdvice.TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
    Call AdviceSet医嘱序号(lngRow + 1, 1) '调整序号
    vsAdvice.TextMatrix(lngRow, COL_类别) = rs煎法!类别
    vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) = lng煎法ID
    vsAdvice.TextMatrix(lngRow, COL_标本部位) = str煎量
    vsAdvice.Cell(flexcpData, lngRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) & "||2")
    
    vsAdvice.TextMatrix(lngRow, COL_计算方式) = NVL(rs煎法!计算方式, 0)
    vsAdvice.TextMatrix(lngRow, COL_操作类型) = NVL(rs煎法!操作类型)
    vsAdvice.TextMatrix(lngRow, COL_单独应用) = NVL(rs煎法!单独应用)
    vsAdvice.TextMatrix(lngRow, COL_执行分类) = NVL(rs煎法!执行分类, 0)
        
    '!中药煎法中也存放中药的付数
    vsAdvice.TextMatrix(lngRow, COL_总量) = vsAdvice.TextMatrix(lngFirstRow, COL_总量)
    
    vsAdvice.TextMatrix(lngRow, col_医嘱内容) = rs煎法!名称
    
    vsAdvice.TextMatrix(lngRow, COL_开始时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开始时间)
    vsAdvice.Cell(flexcpData, lngRow, COL_开始时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开始时间)
    
    vsAdvice.TextMatrix(lngRow, COL_频率性质) = vsAdvice.TextMatrix(lngFirstRow, COL_频率性质) '以药品的为准
    vsAdvice.TextMatrix(lngRow, COL_频率) = vsAdvice.TextMatrix(lngFirstRow, COL_频率)
    vsAdvice.TextMatrix(lngRow, COL_频率次数) = vsAdvice.TextMatrix(lngFirstRow, COL_频率次数)
    vsAdvice.TextMatrix(lngRow, COL_频率间隔) = vsAdvice.TextMatrix(lngFirstRow, COL_频率间隔)
    vsAdvice.TextMatrix(lngRow, COL_间隔单位) = vsAdvice.TextMatrix(lngFirstRow, COL_间隔单位)
    vsAdvice.TextMatrix(lngRow, COL_执行时间) = vsAdvice.TextMatrix(lngFirstRow, COL_执行时间)
    
    vsAdvice.TextMatrix(lngRow, COL_终止时间) = vsAdvice.TextMatrix(lngFirstRow, COL_终止时间)
    vsAdvice.Cell(flexcpData, lngRow, COL_终止时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_终止时间)
    
    '执行性质:缺省根据项目设置(不可能为院外执行),修改时根据当前界面设置
    If rsCurr Is Nothing Then
        vsAdvice.TextMatrix(lngRow, COL_执行性质) = NVL(rs煎法!执行科室, 0)
    Else
        vsAdvice.TextMatrix(lngRow, COL_执行性质) = Decode(NVL(rsCurr!执行性质), "离院带药", 5, NVL(rs煎法!执行科室, 0))
    End If
    
    If InStr(",0,5,", Val(vsAdvice.TextMatrix(lngRow, COL_执行性质))) = 0 Then
        vsAdvice.TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rs煎法!类别, lng煎法ID, 0, _
            NVL(rs煎法!执行科室, 0), mlng病人科室id, Val(vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
    End If
    
    vsAdvice.TextMatrix(lngRow, COL_计价性质) = NVL(rs煎法!计价性质, 0)
    vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID)
    vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱医生)
    
    vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱时间)
    vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开嘱时间)
    
    vsAdvice.TextMatrix(lngRow, COL_标志) = vsAdvice.TextMatrix(lngFirstRow, COL_标志)
    
    
    '保持当前输入行位置
    lngRow = lngRow + 1
    
    '设置中药配方用法行:中药配方的显示行
    '--------------------------------------------------------------------------------------
    '--------------------------------------------------------------------------------------
    vsAdvice.RowData(lngRow) = lng相关ID
    
    Set rsTmp = Get诊疗项目记录(lng诊疗项目ID)
    If rsTmp!类别 & "" = "8" Then
        vsAdvice.TextMatrix(lngRow, COL_配方ID) = lng诊疗项目ID
        str配方名称 = rsTmp!名称 & ":"
    End If
    If lng配方ID <> 0 Then
        vsAdvice.TextMatrix(lngRow, COL_配方ID) = lng配方ID
    End If
    
    If Not rsCurr Is Nothing Then
        '修改了配方内容,标记为修改
        If InStr(",0,3,", rsCurr!Edit) > 0 Then
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = 2 '标记为被修改
        Else
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = rsCurr!Edit '本来就是新增或修改
        End If
    Else
        '新输入的中药配方,为新增
        vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1
    End If
    
    If Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) = 1 Then
        vsAdvice.TextMatrix(lngRow, COL_状态) = IIF(mbln暂存, -1, 1)
    Else
        vsAdvice.TextMatrix(lngRow, COL_状态) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_状态)) = -1, -1, 1)
    End If
    
    vsAdvice.TextMatrix(lngRow, COL_期效) = vsAdvice.TextMatrix(lngFirstRow, COL_期效)
    vsAdvice.TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
    vsAdvice.TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
    Call AdviceSet医嘱序号(lngRow + 1, 1) '调整序号
    vsAdvice.TextMatrix(lngRow, COL_类别) = rs用法!类别
    vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) = lng用法ID
    vsAdvice.Cell(flexcpData, lngRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", vsAdvice.TextMatrix(lngRow, COL_诊疗项目ID) & "||2")
    
    vsAdvice.TextMatrix(lngRow, COL_计算方式) = NVL(rs用法!计算方式, 0)
    vsAdvice.TextMatrix(lngRow, COL_操作类型) = NVL(rs用法!操作类型)
    vsAdvice.TextMatrix(lngRow, COL_单独应用) = NVL(rs用法!单独应用)
    vsAdvice.TextMatrix(lngRow, COL_执行分类) = NVL(rs用法!执行分类, 0)
    
    '!中药用法中也存放中药的付数
    vsAdvice.TextMatrix(lngRow, COL_总量) = vsAdvice.TextMatrix(lngFirstRow, COL_总量)
    vsAdvice.TextMatrix(lngRow, COL_总量单位) = "付"
    
    vsAdvice.TextMatrix(lngRow, COL_开始时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开始时间)
    vsAdvice.Cell(flexcpData, lngRow, COL_开始时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开始时间)
    
    vsAdvice.TextMatrix(lngRow, COL_名称) = rs用法!名称
    vsAdvice.TextMatrix(lngRow, COL_用法) = rs用法!名称
    vsAdvice.TextMatrix(lngRow, COL_频率性质) = vsAdvice.TextMatrix(lngFirstRow, COL_频率性质)
    vsAdvice.TextMatrix(lngRow, COL_频率) = vsAdvice.TextMatrix(lngFirstRow, COL_频率)
    vsAdvice.TextMatrix(lngRow, COL_频率次数) = vsAdvice.TextMatrix(lngFirstRow, COL_频率次数)
    vsAdvice.TextMatrix(lngRow, COL_频率间隔) = vsAdvice.TextMatrix(lngFirstRow, COL_频率间隔)
    vsAdvice.TextMatrix(lngRow, COL_间隔单位) = vsAdvice.TextMatrix(lngFirstRow, COL_间隔单位)
    vsAdvice.TextMatrix(lngRow, COL_执行时间) = vsAdvice.TextMatrix(lngFirstRow, COL_执行时间)
    
    vsAdvice.TextMatrix(lngRow, COL_终止时间) = vsAdvice.TextMatrix(lngFirstRow, COL_终止时间)
    vsAdvice.Cell(flexcpData, lngRow, COL_终止时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_终止时间)
    
    '执行性质:缺省根据项目设置(不可能为院外执行),修改时根据当前界面设置
    If rsCurr Is Nothing Then
        vsAdvice.TextMatrix(lngRow, COL_执行性质) = NVL(rs用法!执行科室, 0)
    Else
        vsAdvice.TextMatrix(lngRow, COL_执行性质) = Decode(NVL(rsCurr!执行性质), "离院带药", 5, NVL(rs用法!执行科室, 0))
    End If
    
    '中药用法如果未设置执行科室,则缺省为病人所在病区(门诊要改为病人所在科室!!)
    If InStr(",0,5,", Val(vsAdvice.TextMatrix(lngRow, COL_执行性质))) = 0 Then
        vsAdvice.TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rs用法!类别, lng用法ID, 0, _
            NVL(rs用法!执行科室, 0), mlng病人科室id, Val(vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
    End If
    
    vsAdvice.TextMatrix(lngRow, COL_计价性质) = NVL(rs用法!计价性质, 0)
    vsAdvice.TextMatrix(lngRow, COL_开嘱科室ID) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱科室ID)
    vsAdvice.TextMatrix(lngRow, COL_开嘱医生) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱医生)
    
    vsAdvice.TextMatrix(lngRow, COL_开嘱时间) = vsAdvice.TextMatrix(lngFirstRow, COL_开嘱时间)
    vsAdvice.Cell(flexcpData, lngRow, COL_开嘱时间) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_开嘱时间)
    
    
    vsAdvice.TextMatrix(lngRow, COL_标志) = vsAdvice.TextMatrix(lngFirstRow, COL_标志)
    Call SetRow标志图标(lngRow)
        
    If Not rsCurr Is Nothing Then
        vsAdvice.TextMatrix(lngRow, COL_医生嘱托) = NVL(rsCurr!医生嘱托)
    ElseIf Not rsUse.EOF Then
        vsAdvice.TextMatrix(lngRow, COL_医生嘱托) = NVL(rsUse!医生嘱托)
    End If
    
    '中药形态(用于AdviceTextMake中)
    vsAdvice.TextMatrix(lngRow, COL_中药形态) = lng形态
    str医嘱内容 = AdviceTextMake(lngRow)
    
    If Val(Split(strExtData, "|")(6)) = 0 Then
        str医嘱内容 = "中药配方:" & str医嘱内容
    Else
        str医嘱内容 = str配方名称 & str医嘱内容
    End If
    '中药配方医嘱内容
    vsAdvice.TextMatrix(lngRow, col_医嘱内容) = str医嘱内容
    vsAdvice.TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(vsAdvice.TextMatrix(lngRow - 2, COL_执行科室ID)), "名称")
    
    '处方限量检查，草药只计算临嘱
    If vsAdvice.TextMatrix(lngRow, COL_期效) = "临嘱" Then
        Call CheckCHLimited(lngRow, vsAdvice.TextMatrix(lngRow, COL_总量), blnOutOfRange, vsAdvice, COL_相关ID, COL_诊疗项目ID, COL_类别, COL_单量)
        If blnOutOfRange Then vsAdvice.TextMatrix(lngRow, COL_是否超量) = "1"
    End If
    '中药配方的中药库存
    Call GetDrugStock(lngRow)
    
    If str高危药品 <> "" Then
        MsgBox "以下医嘱是高危药品：" & str高危药品, vbInformation, gstrSysName
    End If
    
    '-------------------
    vsAdvice.Row = lngRow
    mblnRowChange = True
        
    AdviceSet中药配方 = lngRow
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet检验组合(ByVal lngRow As Long, ByVal lng采集方法ID As Long, ByVal strExtData As String, Optional rsCurr As ADODB.Recordset, Optional ByVal str摘要 As String, Optional ByVal bln申请单 As Boolean) As Long
'功能：处理新增的检验(组合)
'参数：rsItems=输入或选择返回的记录集
'      lngRow=当前输入行
'      lng采集方法ID=缺省的采集方法
'      strExtData=检查:"项目ID1,项目ID2,...;检验标本"如果是新版LIS的模式则是："项目ID1|指标1|指标2...,项目ID2|指标1|指标2...,...;检验标本"
'      rsCurr=修改检验项目时用
'      str摘要=医保摘要
'      bln申请单 申请单保存后调用
'返回：处理之后的当前显示行号
    Dim rsMore As New ADODB.Recordset '采集方法信息
    Dim rsItems As New ADODB.Recordset '检验项目信息
    Dim arrItems As Variant, strItems As String
    Dim strSQL As String, curDate As Date
    Dim str医生 As String, lng医生ID As Long
    Dim str频率 As String, int频率次数 As Integer
    Dim int频率间隔 As Integer, str间隔单位 As String
    Dim lng相关ID As Long, str医嘱内容 As String
    Dim lngCopyRow As Long, lngFirstRow As Long
    Dim vCurDate As Date, i As Long
    Dim rsLIS As New ADODB.Recordset
    Dim strTmp As String
    Dim Y As Long
    Dim blnLis As Boolean
    
    On Error GoTo errH
    
    '取上一或下一有效行,某些内容缺省与该行相同
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
    '当前时间
    curDate = zlDatabase.Currentdate
    
    '检验项目信息
    '----------------------------------------------------------------------------
    '各个检验项目信息:按输入顺序
    arrItems = Split(Split(strExtData, ";")(0), ",")
    For i = UBound(arrItems) To 0 Step -1
        If mblnNewLIS Then
            strTmp = arrItems(i)
            If InStr(strTmp, "|") > 0 Then
                For Y = 0 To UBound(Split(strTmp, "|"))
                    strItems = strItems & "," & Val(Split(strTmp, "|")(Y))
                    If Y > 0 Then
                        strSQL = strSQL & " Union All " & " Select '" & Val(Split(strTmp, "|")(Y)) & "' as 子项,'" & Val(Split(strTmp, "|")(0)) & "' as 父项 From Dual "
                    End If
                Next
            Else
                strItems = strItems & "," & Val(strTmp)
            End If
        Else
            strItems = strItems & "," & Val(arrItems(i))
        End If
    Next
    If strSQL <> "" Then
        Set rsLIS = zlDatabase.OpenSQLRecord(Mid(strSQL, 11), Me.Caption)
        blnLis = True
    End If
    Set rsItems = Get诊疗项目记录(0, Mid(strItems, 2))
    
    If Not bln申请单 Then
        '取某个检验项目的采集方法
        strSQL = "Select /*+ RULE */ A.项目ID,Nvl(A.性质,0) as 序号,A.用法ID" & _
            " From 诊疗用法用量 A,诊疗项目目录 B" & _
            " Where A.用法ID=B.ID And B.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3)" & _
            " And A.项目ID IN(Select Column_Value From Table(f_Num2list([1])))" & _
            " And (B.站点='" & gstrNodeNo & "' Or B.站点 is Null)" & _
            " And (b.撤档时间=To_Date('3000-01-01','YYYY-MM-DD') Or b.撤档时间 is NULL)" & _
            " Order by A.项目ID,Nvl(A.性质,0)"
        Set rsMore = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Mid(strItems, 2))
        If Not rsMore.EOF Then
            If rsCurr Is Nothing Or lng采集方法ID = 0 Then
                lng采集方法ID = rsMore!用法ID '修改时不变
            End If
        End If
    End If
    
    Set rsMore = Get诊疗项目记录(lng采集方法ID)
    
    mblnRowChange = False
    vCurDate = zlDatabase.Currentdate
    
    '设置各行检验项目
    '----------------------------------------------------------------------------
    '采集方法医嘱ID,ID顺序与序号不一定一致
    If Not rsCurr Is Nothing Then
        '修改了检验组合中的内容,采集方法行标记为修改,医嘱ID不变
        lng相关ID = rsCurr!医嘱ID
    Else
        '新输入的
        lng相关ID = GetNext医嘱ID
    End If
    
    With vsAdvice
        For i = 1 To rsItems.RecordCount
            .AddItem "", lngRow
            
            .RowHidden(lngRow) = True
            .RowData(lngRow) = GetNext医嘱ID
            .TextMatrix(lngRow, COL_相关ID) = lng相关ID '对应到采集方法行
            .TextMatrix(lngRow, COL_EDIT) = 1 '新增
            .TextMatrix(lngRow, COL_期效) = zlCommFun.GetNeedName(cbo期效.Text)
            .TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
            .TextMatrix(lngRow, COL_状态) = IIF(mbln暂存, -1, 1) '新开
            
            .TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
            Call AdviceSet医嘱序号(lngRow + 1, 1) '调整序号
            
            .TextMatrix(lngRow, COL_类别) = rsItems!类别
            .TextMatrix(lngRow, col_医嘱内容) = rsItems!名称
            .TextMatrix(lngRow, COL_诊疗项目ID) = rsItems!ID
            .TextMatrix(lngRow, COL_计算方式) = NVL(rsItems!计算方式, 0)
            If .TextMatrix(lngRow, COL_期效) = "临嘱" And NVL(rsItems!执行频率, 0) = 0 And mbln一次性 Then
                .TextMatrix(lngRow, COL_频率性质) = 1 '住院可选择频率的临嘱缺省为一次性
            Else
                .TextMatrix(lngRow, COL_频率性质) = NVL(rsItems!执行频率, 0)
            End If
            .TextMatrix(lngRow, COL_操作类型) = NVL(rsItems!操作类型)
            .TextMatrix(lngRow, COL_单独应用) = NVL(rsItems!单独应用)
            .TextMatrix(lngRow, COL_执行分类) = NVL(rsItems!执行分类, 0)
            .TextMatrix(lngRow, COL_处方限量) = NVL(rsItems!录入限量)
            .TextMatrix(lngRow, COL_计价性质) = NVL(rsItems!计价性质, 0)
            .TextMatrix(lngRow, COL_执行性质) = NVL(rsItems!执行科室, 0)
            '检验标本
            .TextMatrix(lngRow, COL_标本部位) = Split(strExtData, ";")(1)
            
            If mblnNewLIS And rsItems!ID & "" <> "" And blnLis Then
                rsLIS.Filter = "子项=" & rsItems!ID
                If rsLIS.EOF = False Then
                    .TextMatrix(lngRow, COL_组合项目ID) = rsLIS!父项 & ""
                End If
            End If
            
            .Cell(flexcpData, lngRow, COL_医生嘱托) = str摘要
            
            '部份内容一并采集的检验项目相同
            If lngFirstRow <> 0 Then
                .TextMatrix(lngRow, COL_总量) = .TextMatrix(lngFirstRow, COL_总量)
                
                '一并采集的检验项目应该相同
                If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                    .TextMatrix(lngRow, COL_执行科室ID) = .TextMatrix(lngFirstRow, COL_执行科室ID)
                End If
                .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngFirstRow, COL_频率)
                .TextMatrix(lngRow, COL_频率次数) = .TextMatrix(lngFirstRow, COL_频率次数)
                .TextMatrix(lngRow, COL_频率间隔) = .TextMatrix(lngFirstRow, COL_频率间隔)
                .TextMatrix(lngRow, COL_间隔单位) = .TextMatrix(lngFirstRow, COL_间隔单位)
                .TextMatrix(lngRow, COL_执行时间) = .TextMatrix(lngFirstRow, COL_执行时间)
            
                .TextMatrix(lngRow, COL_开始时间) = .TextMatrix(lngFirstRow, COL_开始时间)
                .Cell(flexcpData, lngRow, COL_开始时间) = .Cell(flexcpData, lngFirstRow, COL_开始时间)
                
                .TextMatrix(lngRow, COL_开嘱医生) = .TextMatrix(lngFirstRow, COL_开嘱医生)
                .TextMatrix(lngRow, COL_开嘱科室ID) = .TextMatrix(lngFirstRow, COL_开嘱科室ID)
                
                .TextMatrix(lngRow, COL_开嘱时间) = .TextMatrix(lngFirstRow, COL_开嘱时间)
                .Cell(flexcpData, lngRow, COL_开嘱时间) = .Cell(flexcpData, lngFirstRow, COL_开嘱时间)
                
                .TextMatrix(lngRow, COL_标志) = .TextMatrix(lngFirstRow, COL_标志)
            ElseIf Not rsCurr Is Nothing Then
                If cbo期效.ListIndex = 1 Then
                    .TextMatrix(lngRow, COL_总量) = NVL(rsCurr!总量, 1)
                End If
                
                '执行科室:执行性质为(0-叮嘱,5-院外执行)无执行科室
                If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                    If NVL(rsCurr!执行科室ID, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_执行科室ID) = rsCurr!执行科室ID
                    Else
                        .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsItems!类别, rsItems!ID, 0, _
                            NVL(rsItems!执行科室, 0), mlng病人科室id, NVL(rsCurr!开嘱科室id, 0), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                    End If
                End If
                
                '执行频率
                .TextMatrix(lngRow, COL_频率) = NVL(rsCurr!频率)
                .TextMatrix(lngRow, COL_频率次数) = NVL(rsCurr!频率次数)
                .TextMatrix(lngRow, COL_频率间隔) = NVL(rsCurr!频率间隔)
                .TextMatrix(lngRow, COL_间隔单位) = NVL(rsCurr!间隔单位)
                .TextMatrix(lngRow, COL_执行时间) = NVL(rsCurr!执行时间)
                
                '时间/科室/医生
                .TextMatrix(lngRow, COL_开始时间) = Format(NVL(rsCurr!开始时间), "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开始时间) = CStr(NVL(rsCurr!开始时间))
                
                .TextMatrix(lngRow, COL_开嘱时间) = Format(NVL(rsCurr!开嘱时间), "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开嘱时间) = CStr(NVL(rsCurr!开嘱时间))
                
                .TextMatrix(lngRow, COL_开嘱医生) = NVL(rsCurr!开嘱医生)
                .TextMatrix(lngRow, COL_开嘱科室ID) = NVL(rsCurr!开嘱科室id)
                
                .TextMatrix(lngRow, COL_标志) = NVL(rsCurr!标志)
            Else
                If cbo期效.ListIndex = 1 Then
                    .TextMatrix(lngRow, COL_总量) = 1
                End If
                
                '开嘱医生和科室
                If mint场合 = 1 Then '护士使用时
                    If lngCopyRow <> -1 Then '与上一行相同
                        .TextMatrix(lngRow, COL_开嘱医生) = .TextMatrix(lngCopyRow, COL_开嘱医生)
                        If .TextMatrix(lngRow, COL_开嘱医生) Like "*/*" Then
                            .TextMatrix(lngRow, COL_开嘱医生) = Mid(.TextMatrix(lngRow, COL_开嘱医生), InStr(.TextMatrix(lngRow, COL_开嘱医生), "/") + 1)
                        End If
                    End If
                    '缺省为病人的住院医师或病人科室的第一个医生
                    If .TextMatrix(lngRow, COL_开嘱医生) = "" Then
                        str医生 = Get住院医师
                        Call Get开嘱医生(mlng病人科室id, mint场合 = 1, str医生, lng医生ID)
                        .TextMatrix(lngRow, COL_开嘱医生) = str医生
                    Else
                        Call Get开嘱医生(mlng病人科室id, mint场合 = 1, .TextMatrix(lngRow, COL_开嘱医生), lng医生ID, , , True)
                    End If
                    .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(lng医生ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
                Else
                    .TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
                    .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
                End If
                
                '执行科室:执行性质为(0-叮嘱,5-院外执行)无执行科室
                If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                    '之前要求出开嘱科室ID
                    .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsItems!类别, rsItems!ID, 0, _
                        NVL(rsItems!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                End If
                
                '执行频率
                Call Get缺省频率(NVL(rsItems!ID, 0), Get频率范围(lngRow), str频率, int频率次数, int频率间隔, str间隔单位)
                .TextMatrix(lngRow, COL_频率) = str频率
                .TextMatrix(lngRow, COL_频率次数) = int频率次数
                .TextMatrix(lngRow, COL_频率间隔) = int频率间隔
                .TextMatrix(lngRow, COL_间隔单位) = str间隔单位
            
                '执行时间:"可选频率"(药品是可选频率,但可能设置为一次性)
                If Val(.TextMatrix(lngRow, COL_频率性质)) = 0 Then
                    If lngCopyRow <> -1 Then '与上一行相同
                        If .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngCopyRow, COL_频率) Then
                            .TextMatrix(lngRow, COL_执行时间) = .TextMatrix(lngCopyRow, COL_执行时间)
                        End If
                    End If
                    If .TextMatrix(lngRow, COL_执行时间) = "" Then  '缺省时间方案
                        .TextMatrix(lngRow, COL_执行时间) = Get缺省时间(1, .TextMatrix(lngRow, COL_频率))
                    End If
                End If
            
                '开始时间
                If IsDate(msk开始时间.Text) Then
                    .TextMatrix(lngRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, lngRow, COL_开始时间) = msk开始时间.Text
                End If
                
                '紧急标志
                If IsDate(.Cell(flexcpData, lngRow, COL_开始时间)) Then
                    If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                        .TextMatrix(lngRow, COL_标志) = 2
                    ElseIf DateDiff("n", CDate(.Cell(flexcpData, lngRow, COL_开始时间)), vCurDate) > gint补录间隔 Then
                        .TextMatrix(lngRow, COL_标志) = 2
                    Else
                        .TextMatrix(lngRow, COL_标志) = chk紧急.value
                    End If
                End If
                
                '开嘱时间
                .TextMatrix(lngRow, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
            End If
            
            str医嘱内容 = str医嘱内容 & "," & rsItems!名称 '医嘱内容
            If lngFirstRow = 0 Then lngFirstRow = lngRow '第一项目行
            lngRow = lngRow + 1 '保持当前输入行位置
            
            rsItems.MoveNext
        Next
        
        '设置标本的采集方法
        '----------------------------------------------------------------------------
        rsItems.MoveFirst
        .RowData(lngRow) = lng相关ID
        
        If Not rsCurr Is Nothing Then
            '修改了检验组合内容,标记为修改
            If InStr(",0,3,", rsCurr!Edit) > 0 Then
                vsAdvice.TextMatrix(lngRow, COL_EDIT) = 2 '标记为被修改
            Else
                vsAdvice.TextMatrix(lngRow, COL_EDIT) = rsCurr!Edit '本来就是新增或修改
            End If
        Else
            '新输入的检验组合,为新增
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1
        End If
        
        If Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) = 1 Then
            .TextMatrix(lngRow, COL_状态) = IIF(mbln暂存, -1, 1) '新开
        Else
            .TextMatrix(lngRow, COL_状态) = IIF(Val(.TextMatrix(lngRow, COL_状态)) = -1, -1, 1) '新开
        End If
        
        .TextMatrix(lngRow, COL_期效) = zlCommFun.GetNeedName(cbo期效.Text)
        .TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
        
        .TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
        Call AdviceSet医嘱序号(lngRow + 1, 1) '调整序号
        
        .TextMatrix(lngRow, COL_类别) = rsMore!类别
        .TextMatrix(lngRow, COL_名称) = rsMore!名称
        .TextMatrix(lngRow, COL_用法) = rsMore!名称
        .TextMatrix(lngRow, COL_诊疗项目ID) = rsMore!ID
        .TextMatrix(lngRow, COL_计算方式) = NVL(rsMore!计算方式, 0)
        .TextMatrix(lngRow, COL_操作类型) = NVL(rsMore!操作类型)
        .TextMatrix(lngRow, COL_单独应用) = NVL(rsMore!单独应用)
        .TextMatrix(lngRow, COL_执行分类) = NVL(rsMore!执行分类, 0)
        .TextMatrix(lngRow, COL_计价性质) = NVL(rsMore!计价性质, 0)
        .TextMatrix(lngRow, COL_标本部位) = .TextMatrix(lngFirstRow, COL_标本部位)
        
        '总量为检验项目的,与检验项目相同
        .TextMatrix(lngRow, COL_总量) = .TextMatrix(lngFirstRow, COL_总量)
        If cbo期效.ListIndex = 1 Then
            .TextMatrix(lngRow, COL_总量单位) = NVL(rsMore!计算单位)
        End If
        
        '执行频率
        .TextMatrix(lngRow, COL_频率性质) = .TextMatrix(lngFirstRow, COL_频率性质) '以检验的为准
        .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngFirstRow, COL_频率)
        .TextMatrix(lngRow, COL_频率次数) = .TextMatrix(lngFirstRow, COL_频率次数)
        .TextMatrix(lngRow, COL_频率间隔) = .TextMatrix(lngFirstRow, COL_频率间隔)
        .TextMatrix(lngRow, COL_间隔单位) = .TextMatrix(lngFirstRow, COL_间隔单位)
        .TextMatrix(lngRow, COL_执行时间) = .TextMatrix(lngFirstRow, COL_执行时间)
        .TextMatrix(lngRow, COL_执行性质) = NVL(rsMore!执行科室, 0)
        
        '执行科室:执行性质为(0-叮嘱,5-院外执行)无执行科室
        If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
            .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsMore!类别, rsMore!ID, 0, _
                NVL(rsMore!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngFirstRow, COL_开嘱科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
        End If
        
        '时间/科室/医生
        .TextMatrix(lngRow, COL_开始时间) = .TextMatrix(lngFirstRow, COL_开始时间)
        .Cell(flexcpData, lngRow, COL_开始时间) = .Cell(flexcpData, lngFirstRow, COL_开始时间)
        .TextMatrix(lngRow, COL_采集时间) = .TextMatrix(lngRow, COL_开始时间)
        .TextMatrix(lngRow, COL_开嘱时间) = .TextMatrix(lngFirstRow, COL_开嘱时间)
        .Cell(flexcpData, lngRow, COL_开嘱时间) = .Cell(flexcpData, lngFirstRow, COL_开嘱时间)
        .TextMatrix(lngRow, COL_开嘱科室ID) = .TextMatrix(lngFirstRow, COL_开嘱科室ID)
        .TextMatrix(lngRow, COL_开嘱医生) = .TextMatrix(lngFirstRow, COL_开嘱医生)
        
        '显示紧急标志
        .TextMatrix(lngRow, COL_标志) = .TextMatrix(lngFirstRow, COL_标志)
        Call SetRow标志图标(lngRow)
                        
        If Not rsCurr Is Nothing Then
            .TextMatrix(lngRow, COL_医生嘱托) = NVL(rsCurr!医生嘱托)
        End If
        .Cell(flexcpData, lngRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", .TextMatrix(lngRow, COL_诊疗项目ID) & "||2")
        
        '医嘱内容:检验1,检验2(标本 采集方法)
        .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
        .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow - 1, COL_执行科室ID)), "名称")
        .Row = lngRow
    End With
    mblnRowChange = True
    AdviceSet检验组合 = lngRow
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub AdviceSet诊疗项目(rsInput As ADODB.Recordset, ByVal lngRow As Long, ByVal lng给药途径ID As Long, ByVal lngGroupRow As Long, _
        ByVal strExtData As String, ByVal str摘要 As String, Optional ByVal str手术部位 As String, Optional ByVal bln连续用药 As Boolean, _
        Optional ByVal strAppend As String, Optional ByVal bln备血 As Boolean = True)
'功能：处理新增(插入)的中、西成药，检查(组合)，手术(组合)，输血，卫材，及其它诊疗项目的缺省医嘱数据
'参数：rsInput=输入或选择返回的记录集
'      lngRow=当前输入行
'      lng给药途径ID=缺省给药途径ID,或一并给药时的给药途径ID
'      lngGroupRow=在一并给药的一组成药中插入新的成药行时,对应一并给药的一行行号
'      strExtData=检查:包含检查部位方法等信息,手术:包含附加手术及麻醉的信息,可能无附加手术
'      str摘要=医保摘要
'      str手术部位=申请附项中的手术部位
'      bln连续用药 是否是连续用药
'      bln备血 当前的输血医嘱为备血医嘱，仅对类别为K的诊疗项目
    Dim rsTmp As New ADODB.Recordset
    Dim rsMore As New ADODB.Recordset '诊疗项目详细信息
    Dim strSQL As String, lngCopyRow As Long
    Dim lngTmp As Long, i As Long
    Dim str医生 As String, lng医生ID As Long
    Dim str药房IDs As String, sng天数 As Single
    Dim str频率 As String, int频率次数 As Integer
    Dim int频率间隔 As Integer, str间隔单位 As String
    Dim lng收费项目ID As Long, bln品种 As Boolean
    Dim lng执行科室ID As Long, vCurDate As Date
    Dim varTmp1 As Variant, varTmp2 As Variant
        
    On Error GoTo errH
    
    '取上一或下一有效行,某些内容缺省与该行相同
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
                
    With vsAdvice
        '开始设置医嘱缺省内容
        .RowData(lngRow) = GetNext医嘱ID
        .TextMatrix(lngRow, COL_EDIT) = 1 '新增
        .TextMatrix(lngRow, COL_期效) = zlCommFun.GetNeedName(cbo期效.Text)
        .TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
        .TextMatrix(lngRow, COL_状态) = IIF(mbln暂存, -1, 1) '新开
        
        '序号:保持连续,当前行占用新序号后,后面的序号向后移
        .TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
        Call AdviceSet医嘱序号(lngRow + 1, 1)
        
        .TextMatrix(lngRow, COL_类别) = rsInput!类别ID
        .TextMatrix(lngRow, COL_名称) = rsInput!名称 '该名称可能是别名
        .TextMatrix(lngRow, COL_诊疗项目ID) = rsInput!诊疗项目ID
        .Cell(flexcpData, lngRow, COL_医生嘱托) = str摘要
        .TextMatrix(lngRow, COL_皮试结果) = IIF(bln连续用药, "连续用药", "")
        .Cell(flexcpData, lngRow, COL_皮试结果) = .TextMatrix(lngRow, COL_皮试结果)
        
        
        '药品特性
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            strSQL = "Select 毒理分类,抗生素,药品剂型,处方限量,处方职务,品种医嘱,临床自管药,溶媒 From 药品特性 Where 药名ID=[1]"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!诊疗项目ID))
            If Not rsTmp.EOF Then
                .TextMatrix(lngRow, COL_毒理分类) = NVL(rsTmp!毒理分类)
                .TextMatrix(lngRow, COL_抗菌等级) = Val("" & rsTmp!抗生素)
                .TextMatrix(lngRow, COL_药品剂型) = NVL(rsTmp!药品剂型)
                .TextMatrix(lngRow, COL_处方限量) = NVL(rsTmp!处方限量)
                .TextMatrix(lngRow, COL_处方职务) = NVL(rsTmp!处方职务)
                .TextMatrix(lngRow, COL_品种医嘱) = Val("" & rsTmp!品种医嘱)
                .TextMatrix(lngRow, COL_临床自管药) = rsTmp!临床自管药 & ""
                .TextMatrix(lngRow, COL_是否溶媒) = Val(rsTmp!溶媒 & "")
                '是否长嘱药品固定按品种下达
                bln品种 = NVL(rsTmp!品种医嘱, 0) <> 0 And cbo期效.ListIndex = 0
                
                If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(lngRow, COL_抗菌等级)) Then
                    .TextMatrix(lngRow, COL_审核状态) = 1
                End If
            End If
        End If
        
        '手术分级管理
        If gbln手术分级管理 Then
            If rsInput!类别ID & "" = "F" Then
                .TextMatrix(lngRow, COL_审核状态) = 1
            End If
        End If
        
        If InStr(",F,G,K,", "," & rsInput!类别ID & ",") = 0 Then
            If chk紧急.value = 1 Then
                If Val(.TextMatrix(lngRow, COL_审核状态)) = 1 Then .TextMatrix(lngRow, COL_审核状态) = ""
            Else
                If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(lngRow, COL_抗菌等级)) Then .TextMatrix(lngRow, COL_审核状态) = 1
            End If
        End If
        
        '长嘱抗菌药紧急要审核(都要审核)
        If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(lngRow, COL_抗菌等级)) And .TextMatrix(lngRow, COL_期效) = "长嘱" Then
             .TextMatrix(lngRow, COL_审核状态) = 1
        End If
        
        If rsInput!类别ID & "" = "F" And Val(.TextMatrix(lngRow, COL_审核状态)) = 1 Then
            If gbln手术等级管理 Then
                If gbln手术授权管理 Then
                    If CheckDocEmpowerEx(Val(rsInput!诊疗项目ID), strAppend) Then
                        .TextMatrix(lngRow, COL_审核状态) = ""
                    End If
                Else
                    If CheckDoc手术等级(Val(rsInput!诊疗项目ID), strAppend) Then
                        .TextMatrix(lngRow, COL_审核状态) = ""
                    End If
                End If
            End If
        End If
        
        '是否长嘱药品固定按品种下达
        lng收费项目ID = NVL(rsInput!收费细目ID, 0)
        If bln品种 Then lng收费项目ID = 0
        
        '药品、卫材的规格信息
        .TextMatrix(lngRow, COL_收费细目ID) = lng收费项目ID '药品、卫材有
        If lng收费项目ID <> 0 Then
            If InStr(",5,6,", rsInput!类别ID) > 0 Then
                strSQL = "Select Nvl(C.名称,A.名称) as 名称,b.基本药物," & _
                    " B.剂量系数,B.住院单位,B.住院包装,B.住院可否分零 As 可否分零,B.动态分零,b.高危药品,b.是否易至跌倒" & _
                    " From 收费项目目录 A,药品规格 B,收费项目别名 C" & _
                    " Where A.ID=B.药品ID And A.ID=[1]" & _
                    " And A.ID=C.收费细目ID(+) And C.码类(+)=1 And C.性质(+)=[2]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng收费项目ID, IIF(gbyt药品名称显示 = 0, 1, 3))
                .TextMatrix(lngRow, COL_名称) = rsTmp!名称 '将别名换成正式规格名称
                .TextMatrix(lngRow, COL_剂量系数) = rsTmp!剂量系数
                .TextMatrix(lngRow, COL_住院单位) = rsTmp!住院单位
                .TextMatrix(lngRow, COL_住院包装) = rsTmp!住院包装
                .TextMatrix(lngRow, COL_可否分零) = NVL(rsTmp!可否分零, 0)
                .TextMatrix(lngRow, COL_动态分零) = NVL(rsTmp!动态分零, 0)
                .TextMatrix(lngRow, COL_高危药品) = NVL(rsTmp!高危药品, 0)
                .TextMatrix(lngRow, COL_易跌倒) = NVL(rsTmp!是否易至跌倒, 0)
                .TextMatrix(lngRow, COL_基本药物) = rsTmp!基本药物 & ""
                If Val(.TextMatrix(lngRow, COL_高危药品)) <> 0 Then
                    varTmp1 = mblnRowChange: varTmp2 = .Redraw
                    mblnRowChange = False: .Redraw = flexRDNone
                    MsgBox "当前新开的是" & Decode(Val(.TextMatrix(lngRow, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级高危药品，请谨慎使用。", vbInformation, Me.Caption
                    mblnRowChange = varTmp1: .Redraw = varTmp2
                End If
            ElseIf rsInput!类别ID = "4" Then
                strSQL = "Select A.跟踪在用,B.名称,B.计算单位,A.是否分零 From 材料特性 A,收费项目目录 B Where A.材料ID=B.ID And A.材料ID=[1]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng收费项目ID)
                .TextMatrix(lngRow, COL_名称) = rsTmp!名称 '将别名换成正式规格名称
                .TextMatrix(lngRow, COL_剂量系数) = 1
                .TextMatrix(lngRow, COL_住院包装) = 1
                .TextMatrix(lngRow, COL_住院单位) = NVL(rsTmp!计算单位) '散装单位
                .TextMatrix(lngRow, COL_跟踪在用) = NVL(rsTmp!跟踪在用, 0)
                .TextMatrix(lngRow, COL_检查方法) = rsInput!批次 & ""
                .Cell(flexcpData, lngRow, COL_可否分零) = NVL(rsTmp!是否分零, 0)
            End If
        End If
        
        '获取更多诊疗项目信息
        '----------------------------------------------------------------------------
        If InStr(",5,6,", rsInput!类别ID) > 0 And lng收费项目ID <> 0 Then
            strSQL = "Select a.用法id,a.频次,a.成人剂量,a.小儿剂量,a.医生嘱托,a.疗程,c.药名id as 项目ID " & _
                " From 药品用法用量 A,诊疗项目目录 B,药品规格 C " & _
                " Where A.用法ID=B.ID and a.药品ID=c.药品id And B.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3)" & _
                " And A.药品ID=[2] And A.性质=1"
            strSQL = "Select A.*,1 as 性质,B.用法ID," & _
                " B.频次,B.成人剂量,B.小儿剂量,B.医生嘱托,B.疗程" & _
                " From 诊疗项目目录 A,(" & strSQL & ") B" & _
                " Where A.ID=b.项目id(+) And A.ID=[1]"
        Else
            strSQL = "Select A.*" & _
                " From 诊疗用法用量 A,诊疗项目目录 B" & _
                " Where A.用法ID=B.ID And (Nvl(A.性质,0)=0 Or B.服务对象 IN(" & IIF(mlng病人性质 = 1, "1,2", 2) & ",3))" & _
                " And (B.站点='" & gstrNodeNo & "' Or B.站点 is Null)" & _
                " And A.项目ID=[1]"
            strSQL = "Select A.*,Nvl(B.性质,0) as 性质,B.用法ID," & _
                " B.频次,B.成人剂量,B.小儿剂量,B.医生嘱托,B.疗程" & _
                " From 诊疗项目目录 A,(" & strSQL & ") B" & _
                " Where A.ID=B.项目ID(+) And A.ID=[1]" & _
                " Order by 性质"
        End If
        Set rsMore = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!诊疗项目ID), lng收费项目ID)
        
        If lng收费项目ID = 0 Then '将别名换成正式诊疗名称
            .TextMatrix(lngRow, COL_名称) = rsMore!名称
        End If
        
        '单量单位
        If rsInput!类别ID = "4" Then
            .TextMatrix(lngRow, COL_单量单位) = .TextMatrix(lngRow, COL_住院单位) '散装单位
        Else
            If cbo期效.ListIndex = 0 Then
                If InStr(",5,6,", rsInput!类别ID) > 0 Or InStr(",1,2,", NVL(rsMore!计算方式, 0)) > 0 Then
                    .TextMatrix(lngRow, COL_单量单位) = NVL(rsMore!计算单位) '药品为剂量单位
                End If
            Else
                If InStr(",5,6,", rsInput!类别ID) > 0 Or (NVL(rsMore!执行频率, 0) = 0 And InStr(",1,2,", NVL(rsMore!计算方式, 0)) > 0) Then
                    .TextMatrix(lngRow, COL_单量单位) = NVL(rsMore!计算单位) '药品为剂量单位
                End If
            End If
        End If
        
        '总量单位
        If cbo期效.ListIndex = 1 Then
            If InStr(",5,6,", rsInput!类别ID) > 0 Then
                '中、西成药临嘱的总量单位就是住院单位
                .TextMatrix(lngRow, COL_总量单位) = .TextMatrix(lngRow, COL_住院单位)
            ElseIf rsInput!类别ID = "4" Then
                .TextMatrix(lngRow, COL_总量单位) = .TextMatrix(lngRow, COL_住院单位) '散装单位
            Else
                '其它临嘱要输入总量
                '如果为一次性或计次临嘱缺省总量为1
                If NVL(rsMore!执行频率, 0) = 1 Or NVL(rsMore!计算方式, 0) = 3 Then
                    .TextMatrix(lngRow, COL_总量) = 1
                End If
                .TextMatrix(lngRow, COL_总量单位) = NVL(rsMore!计算单位)
            End If
        End If
        
        '抗菌药物缺省用药目的
        If Val(.TextMatrix(lngRow, COL_抗菌等级)) > 0 Then .TextMatrix(lngRow, COL_用药目的) = mstrPurMed
        
        .TextMatrix(lngRow, COL_计算方式) = NVL(rsMore!计算方式, 0)
        If .TextMatrix(lngRow, COL_期效) = "临嘱" And NVL(rsMore!执行频率, 0) = 0 And mbln一次性 Then
            .TextMatrix(lngRow, COL_频率性质) = 1 '住院可选择频率的临嘱缺省为一次性
        Else
            .TextMatrix(lngRow, COL_频率性质) = NVL(rsMore!执行频率, 0)
        End If
        .TextMatrix(lngRow, COL_操作类型) = NVL(rsMore!操作类型)
        .TextMatrix(lngRow, COL_单独应用) = NVL(rsMore!单独应用)
        .TextMatrix(lngRow, COL_执行分类) = NVL(rsMore!执行分类, 0)
        If InStr(",5,6,7,", rsInput!类别ID) = 0 Then
            .TextMatrix(lngRow, COL_处方限量) = NVL(rsMore!录入限量)
        End If
        
        '标本部位
        If InStr(",4,5,6,", rsInput!类别ID) > 0 Then
            .TextMatrix(lngRow, COL_标本部位) = rsInput!名称 '记录药品、卫材输入时选择名称
        ElseIf rsInput!类别ID = "F" Or rsInput!类别ID = "K" Then
            .TextMatrix(lngRow, COL_手术时间) = "" '记录手术/输血时间
        ElseIf rsInput!类别ID <> "D" Then
            .TextMatrix(lngRow, COL_标本部位) = NVL(rsMore!标本部位)
        End If
        
        '计价性质
        .TextMatrix(lngRow, COL_计价性质) = NVL(rsMore!计价性质, 0)
    
        '执行性质:新增项目时根据项目设置,药品、卫材=4-指定科室,一并给药的相同
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            If lngGroupRow <> 0 Then
                .TextMatrix(lngRow, COL_执行性质) = .TextMatrix(lngGroupRow, COL_执行性质)
            Else
                .TextMatrix(lngRow, COL_执行性质) = IIF(Val(.TextMatrix(lngRow, COL_临床自管药)) = 1, 5, 4) '自备药设为院外执行
            End If
        ElseIf rsInput!类别ID = "4" Then
            .TextMatrix(lngRow, COL_执行性质) = 4
        Else
            .TextMatrix(lngRow, COL_执行性质) = NVL(rsMore!执行科室, 0)
        End If
        
        '开嘱医生和科室
        If lngGroupRow = 0 Then
            If mint场合 = 1 Then '护士使用时
                '与上一行相同
                If lngCopyRow <> -1 Then
                    .TextMatrix(lngRow, COL_开嘱医生) = .TextMatrix(lngCopyRow, COL_开嘱医生)
                    If .TextMatrix(lngRow, COL_开嘱医生) Like "*/*" Then
                        .TextMatrix(lngRow, COL_开嘱医生) = Mid(.TextMatrix(lngRow, COL_开嘱医生), InStr(.TextMatrix(lngRow, COL_开嘱医生), "/") + 1)
                    End If
                End If
                '缺省为病人的住院医师或病人科室的第一个医生
                If .TextMatrix(lngRow, COL_开嘱医生) = "" Then
                    str医生 = Get住院医师
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, str医生, lng医生ID)
                    .TextMatrix(lngRow, COL_开嘱医生) = str医生
                Else
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, .TextMatrix(lngRow, COL_开嘱医生), lng医生ID, , , True)
                End If
                .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(lng医生ID, mlng医技科室ID, mlng病人科室id, IIF(mlng病人性质 = 1, 1, 2), 0, mlng会诊科室ID)
            Else
                .TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
                .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, IIF(mlng病人性质 = 1, 1, 2), 0, mlng会诊科室ID)
            End If
        Else
            .TextMatrix(lngRow, COL_开嘱医生) = .TextMatrix(lngGroupRow, COL_开嘱医生)
            .TextMatrix(lngRow, COL_开嘱科室ID) = .TextMatrix(lngGroupRow, COL_开嘱科室ID)
        End If
        
        '执行科室:药品缺省与上一行相同,一并给药的缺省相同
        lng执行科室ID = 0
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            If Val(.TextMatrix(lngRow, COL_执行性质)) = 5 Then
                .TextMatrix(lngRow, COL_执行科室ID) = 0
            Else
                If lngGroupRow <> 0 Then
                    str药房IDs = Get可用药房IDs(rsInput!类别ID, rsInput!诊疗项目ID, lng收费项目ID, mlng病人科室id, 2)
                    If InStr("," & str药房IDs & ",", "," & .TextMatrix(lngGroupRow, COL_执行科室ID) & ",") > 0 Then
                        .TextMatrix(lngRow, COL_执行科室ID) = .TextMatrix(lngGroupRow, COL_执行科室ID)
                    End If
                ElseIf lngCopyRow <> -1 Then
                    If rsInput!类别ID = .TextMatrix(lngCopyRow, COL_类别) Then
                        lng执行科室ID = Val(.TextMatrix(lngCopyRow, COL_执行科室ID))
                        If InStr("," & gstr输液配置中心 & ",", "," & lng执行科室ID & ",") > 0 Then
                            '如果上一个是输液配置中心，则不默认跟上一个保持一致
                            lng执行科室ID = 0
                        End If
                    End If
                End If
            End If
        End If
        If Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then
            If rsInput!类别ID = "Z" And (NVL(rsMore!操作类型, 0) = 3 Or NVL(rsMore!操作类型, 0) = 7) Then
                '转科,会诊医嘱的执行科室不缺省
                .TextMatrix(lngRow, COL_执行科室ID) = 0
            
                '门诊留观病人下入院医嘱
            ElseIf rsInput!类别ID = "Z" And NVL(rsMore!操作类型, 0) = 2 And mlng病人性质 = 1 Then
                '入院不设置缺省执行科室
                .TextMatrix(lngRow, COL_执行科室ID) = 0
                
            ElseIf InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                '执行性质为(0-叮嘱,5-院外执行)无执行科室
                '先要求出开嘱科室ID
                If rsInput!类别ID = "4" Then
                    .TextMatrix(lngRow, COL_执行科室ID) = Get收费执行科室ID(mlng病人ID, mlng主页ID, _
                        rsInput!类别ID, lng收费项目ID, 4, mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), IIF(mlng病人性质 = 1, 1, 2), , 1, , 2)
                Else
                    .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsInput!类别ID, rsInput!诊疗项目ID, _
                        lng收费项目ID, NVL(rsMore!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), InStr(",5,6,", rsInput!类别ID) > 0, lng执行科室ID, 2)
                End If
            End If
        End If
        
        '药品库存
        If (InStr(",5,6,", rsInput!类别ID) > 0 Or rsInput!类别ID = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 1) And lng收费项目ID <> 0 Then
            Call GetDrugStock(lngRow)
        End If
        
        '执行频率:可选频率,一次性或持续性
        '缺省与上一新增行相同
        If lngCopyRow <> -1 Then
            If .TextMatrix(lngRow, COL_期效) = .TextMatrix(lngCopyRow, COL_期效) And Get频率范围(lngRow) = Get频率范围(lngCopyRow) Then
                If Val(.TextMatrix(lngCopyRow, COL_EDIT)) = 1 And .TextMatrix(lngCopyRow, COL_频率) <> "" _
                    And Not (.TextMatrix(lngRow, COL_类别) = "7" And Not RowIn配方行(lngCopyRow)) _
                    And Not (.TextMatrix(lngRow, COL_类别) <> "7" And RowIn配方行(lngCopyRow)) _
                    And Check频率可用(NVL(rsInput!诊疗项目ID, 0), Get频率范围(lngRow), .TextMatrix(lngCopyRow, COL_频率)) Then
                    
                    '特殊类不与上一行相同，因为特殊类频率固定不能修改
                    If InStr("F,G,I", rsInput!类别ID) > 0 Or rsInput!类别ID = "H" And .TextMatrix(lngRow, COL_操作类型) = "1" Or rsInput!类别ID = "Z" And InStr(",1,2,3,4,5,6,7,8,9,10,11,12,14,", "," & .TextMatrix(lngRow, COL_操作类型) & ",") > 0 Then
                        .TextMatrix(lngRow, COL_频率) = ""
                    Else
                        .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngCopyRow, COL_频率)
                        .TextMatrix(lngRow, COL_频率次数) = .TextMatrix(lngCopyRow, COL_频率次数)
                        .TextMatrix(lngRow, COL_频率间隔) = .TextMatrix(lngCopyRow, COL_频率间隔)
                        .TextMatrix(lngRow, COL_间隔单位) = .TextMatrix(lngCopyRow, COL_间隔单位)
                    End If
                    
                End If
            End If
        End If
        '或取缺省频率
        If .TextMatrix(lngRow, COL_频率) = "" Then
            Call Get缺省频率(NVL(rsInput!诊疗项目ID, 0), Get频率范围(lngRow), str频率, int频率次数, int频率间隔, str间隔单位)
            .TextMatrix(lngRow, COL_频率) = str频率
            .TextMatrix(lngRow, COL_频率次数) = int频率次数
            .TextMatrix(lngRow, COL_频率间隔) = int频率间隔
            .TextMatrix(lngRow, COL_间隔单位) = str间隔单位
        End If
       
        
        '中，西成药的一些缺省信息
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            
            '如果启用了用法严格控制,则清除与上一行相同
            If CheckDrugUseM(NVL(rsInput!收费细目ID, 0), rsInput!诊疗项目ID) And lngGroupRow = 0 Then lng给药途径ID = 0

            '执行频率
            If lngGroupRow <> 0 Then
                '一并给药的相同
                .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngGroupRow, COL_频率)
                .TextMatrix(lngRow, COL_频率次数) = .TextMatrix(lngGroupRow, COL_频率次数)
                .TextMatrix(lngRow, COL_频率间隔) = .TextMatrix(lngGroupRow, COL_频率间隔)
                .TextMatrix(lngRow, COL_间隔单位) = .TextMatrix(lngGroupRow, COL_间隔单位)
                .TextMatrix(lngRow, COL_执行时间) = .TextMatrix(lngGroupRow, COL_执行时间)
                '频率性质也要相同,如已强制设置为一次性
                .TextMatrix(lngRow, COL_频率性质) = .TextMatrix(lngGroupRow, COL_频率性质)
                
                If Val(.TextMatrix(lngRow, COL_抗菌等级)) > 0 Then
                    .TextMatrix(lngRow, COL_用药目的) = .TextMatrix(lngGroupRow, COL_用药目的)
                    .TextMatrix(lngRow, COL_用药理由) = .TextMatrix(lngGroupRow, COL_用药理由)
                End If
            End If
            
            '确定临嘱用药天数：
            '1.最少为一个频率周期天数
            '2-有疗程则为疗程天数(应大于一个频率周期天数)
            If cbo期效.ListIndex = 1 Then
                sng天数 = msng天数
                If mbln天数 Then
                    If .TextMatrix(lngRow, COL_间隔单位) = "周" Then
                        If 7 > sng天数 Then sng天数 = 7
                    ElseIf .TextMatrix(lngRow, COL_间隔单位) = "天" Then
                        If Val(.TextMatrix(lngRow, COL_频率间隔)) > sng天数 Then
                            sng天数 = Val(.TextMatrix(lngRow, COL_频率间隔))
                        End If
                    ElseIf .TextMatrix(lngRow, COL_间隔单位) = "小时" Then
                        If Val(.TextMatrix(lngRow, COL_频率间隔)) \ 24 > sng天数 Then
                            sng天数 = Val(.TextMatrix(lngRow, COL_频率间隔)) \ 24
                        End If
                    ElseIf .TextMatrix(lngRow, COL_间隔单位) = "分钟" Then
                        If sng天数 = 0 Then sng天数 = 1
                    End If
                    If sng天数 = 0 Then sng天数 = 1
                End If
            End If
            
            rsMore.Filter = "性质>0" '取第一种给药途径用为缺省设置
            If Not rsMore.EOF Then
                '不是一并给药时,设置的缺省用法频率优先
                If lngGroupRow = 0 Then
                    If Not IsNull(rsMore!用法ID) Then lng给药途径ID = rsMore!用法ID
                    If Not IsNull(rsMore!频次) And Val(.TextMatrix(lngRow, COL_频率性质)) <> 1 Then '缺省为一次性优先
                        Call Get频率信息_编码(rsMore!频次, str频率, int频率次数, int频率间隔, str间隔单位)
                        .TextMatrix(lngRow, COL_频率) = str频率
                        .TextMatrix(lngRow, COL_频率次数) = int频率次数
                        .TextMatrix(lngRow, COL_频率间隔) = int频率间隔
                        .TextMatrix(lngRow, COL_间隔单位) = str间隔单位
                        If str频率 = "一次性" Then .TextMatrix(lngRow, COL_频率性质) = 1
                    End If
                End If
                
                '医生嘱托
                .TextMatrix(lngRow, COL_医生嘱托) = NVL(rsMore!医生嘱托) '一般为给药途径的说明
                
                '药品单量
                If mint年龄 > 12 Then
                    If NVL(rsMore!成人剂量, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_单量) = FormatEx(rsMore!成人剂量, 5)
                    End If
                Else
                    If NVL(rsMore!小儿剂量, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_单量) = FormatEx(rsMore!小儿剂量, 5)
                    ElseIf NVL(rsMore!成人剂量, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_单量) = FormatEx(rsMore!成人剂量 * (mint年龄 + 2) * 5 / 100, 5)
                    End If
                End If
                If Val(.TextMatrix(lngRow, COL_单量)) = 0 Then .TextMatrix(lngRow, COL_单量) = ""
                
                '药品临嘱总量:住院包装
                If cbo期效.ListIndex = 1 Then
                    If NVL(rsMore!疗程, 1) > sng天数 Then sng天数 = NVL(rsMore!疗程, 1)
                    If .TextMatrix(lngRow, COL_频率) <> "" And Val(.TextMatrix(lngRow, COL_单量)) <> 0 _
                        And Val(.TextMatrix(lngRow, COL_剂量系数)) <> 0 And Val(.TextMatrix(lngRow, COL_住院包装)) <> 0 Then
                        If Val(.TextMatrix(lngRow, COL_频率性质)) = 1 Then '临嘱药品可能缺省为一次性
                            '仅按疗程算改为按最少用药天数算
                            .TextMatrix(lngRow, COL_总量) = FormatEx(Calc缺省药品总量( _
                                    Val(.TextMatrix(lngRow, COL_单量)), 1, 1, 1, "天", "", _
                                    Val(.TextMatrix(lngRow, COL_剂量系数)), _
                                    Val(.TextMatrix(lngRow, COL_住院包装)), _
                                    Val(.TextMatrix(lngRow, COL_可否分零))), 5)
                        Else
                            '仅按疗程算改为按最少用药天数算
                            .TextMatrix(lngRow, COL_总量) = FormatEx(Calc缺省药品总量( _
                                    Val(.TextMatrix(lngRow, COL_单量)), sng天数, _
                                    Val(.TextMatrix(lngRow, COL_频率次数)), _
                                    Val(.TextMatrix(lngRow, COL_频率间隔)), _
                                    .TextMatrix(lngRow, COL_间隔单位), _
                                    .TextMatrix(lngRow, COL_执行时间), _
                                    Val(.TextMatrix(lngRow, COL_剂量系数)), _
                                    Val(.TextMatrix(lngRow, COL_住院包装)), _
                                    Val(.TextMatrix(lngRow, COL_可否分零))), 5)
                        End If
                        If InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") = 0 Then
                            .TextMatrix(lngRow, COL_总量) = IntEx(Val(.TextMatrix(lngRow, COL_总量)))
                        ElseIf Val(.TextMatrix(lngRow, COL_可否分零)) <> 0 Then
                            .TextMatrix(lngRow, COL_总量) = IntEx(Val(.TextMatrix(lngRow, COL_总量)))
                        End If
                    End If
                End If
            End If
            
            '记录缺省天数
            If mbln天数 And cbo期效.ListIndex = 1 And Val(.TextMatrix(lngRow, COL_频率性质)) <> 1 Then
                .TextMatrix(lngRow, COL_天数) = IIF(sng天数 = 0, "", sng天数)
            End If
            
            '程序自动（不是手动录入）设值，如设置了用法用量，则不会执行超量检查的代码（控件Validate事件）
            If Val(.TextMatrix(lngRow, COL_处方限量)) <> 0 Then
                If cbo期效.ListIndex = 1 And Val(.TextMatrix(lngRow, COL_总量)) <> 0 Then   '临嘱检查总量
                    If Val(.TextMatrix(lngRow, COL_总量)) * Val(.TextMatrix(lngRow, COL_住院包装)) * Val(.TextMatrix(lngRow, COL_剂量系数)) > Val(.TextMatrix(lngRow, COL_处方限量)) Then
                        .TextMatrix(lngRow, COL_是否超量) = "1"
                    End If
                ElseIf cbo期效.ListIndex = 0 And Val(.TextMatrix(lngRow, COL_单量)) <> 0 Then '长嘱检查单量
                    If Val(.TextMatrix(lngRow, COL_单量)) > Val(.TextMatrix(lngRow, COL_处方限量)) Then
                        .TextMatrix(lngRow, COL_是否超量) = "1"
                    End If
                End If
            End If
            
        End If
        
        If rsMore.Filter <> 0 Then rsMore.Filter = 0
        
        '执行时间:"可选频率"(药品是可选频率,但可能设置为一次性)
        If Val(.TextMatrix(lngRow, COL_频率性质)) = 0 Then
            If .TextMatrix(lngRow, COL_执行时间) = "" Then
                If lngCopyRow <> -1 Then '与上一行相同
                    If .TextMatrix(lngRow, COL_频率) = .TextMatrix(lngCopyRow, COL_频率) Then
                        .TextMatrix(lngRow, COL_执行时间) = .TextMatrix(lngCopyRow, COL_执行时间)
                    End If
                End If
                If .TextMatrix(lngRow, COL_执行时间) = "" Then  '缺省时间方案
                    .TextMatrix(lngRow, COL_执行时间) = Get缺省时间(1, .TextMatrix(lngRow, COL_频率), lng给药途径ID)
                End If
            End If
        End If
        
        '其它(与项目无关)
        '---------------------------------------------------------------------
        If lngGroupRow = 0 Then
            vCurDate = zlDatabase.Currentdate
            If IsDate(msk开始时间.Text) Then
                .TextMatrix(lngRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开始时间) = msk开始时间.Text
                
                If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                    .TextMatrix(lngRow, COL_标志) = 2
                ElseIf DateDiff("n", CDate(msk开始时间.Text), vCurDate) > gint补录间隔 Then
                    .TextMatrix(lngRow, COL_标志) = 2
                Else
                    .TextMatrix(lngRow, COL_标志) = chk紧急.value
                End If
                
                '手术/输血时间缺省为开始时间
                If rsInput!类别ID = "F" Or rsInput!类别ID = "K" Then
                    .TextMatrix(lngRow, COL_手术时间) = msk开始时间.Text
                End If
            End If
                        
            .TextMatrix(lngRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
            .Cell(flexcpData, lngRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
        Else
            .TextMatrix(lngRow, COL_开始时间) = .TextMatrix(lngGroupRow, COL_开始时间)
            .Cell(flexcpData, lngRow, COL_开始时间) = .Cell(flexcpData, lngGroupRow, COL_开始时间)
            
            .TextMatrix(lngRow, COL_标志) = .TextMatrix(lngGroupRow, COL_标志)
            
            .TextMatrix(lngRow, COL_开嘱时间) = .TextMatrix(lngGroupRow, COL_开嘱时间)
            .Cell(flexcpData, lngRow, COL_开嘱时间) = .Cell(flexcpData, lngGroupRow, COL_开嘱时间)
        End If
                
        
        '在主行处理完成之后处理附加行,并组合医嘱内容
        '-------------------------------------------------------------------------
        If InStr(",5,6,", rsInput!类别ID) > 0 Then
            '新增一个给药途径项目,并设置相关
            If lng给药途径ID <> 0 Then
                .TextMatrix(lngRow, COL_用法) = Sys.RowValue("诊疗项目目录", lng给药途径ID, "名称")
            End If
            If lngGroupRow <> 0 Then
                '一并给药的关联相同的给药途径行
                lngTmp = .FindRow(CLng(.TextMatrix(lngGroupRow, COL_相关ID)), lngGroupRow + 1)
                If lngTmp > lngRow Then
                    .TextMatrix(lngRow, COL_相关ID) = .TextMatrix(lngGroupRow, COL_相关ID)
                Else
                    '这种情况是仅为了使用一并给药的相同设置
                    .TextMatrix(lngRow, COL_相关ID) = AdviceSet给药途径(lngRow, lng给药途径ID)
                End If
            Else '独立新增的成药关联独立的给药途径行
                .TextMatrix(lngRow, COL_相关ID) = AdviceSet给药途径(lngRow, lng给药途径ID)
            End If
            
            '毒麻精的颜色标识
            If InStr(",麻醉药,毒性药,精神药,精神I类,精神II类,", .TextMatrix(lngRow, COL_毒理分类)) > 0 _
                And .TextMatrix(lngRow, COL_毒理分类) <> "" Then
                .Cell(flexcpFontBold, lngRow, col_医嘱内容) = True
            End If
        ElseIf rsInput!类别ID = "D" And strExtData <> "" Then
            '检查的组合部位行
            Call AdviceSet检查组合(lngRow, strExtData)
        ElseIf rsInput!类别ID = "F" And strExtData <> "" Then
            '手术的附加手术及麻醉项目行
            Call AdviceSet手术组合(lngRow, strExtData)
            vsAdvice.Cell(flexcpData, lngRow, COL_标本部位) = str手术部位
        ElseIf rsInput!类别ID = "K" Then
            If bln备血 Then
                .TextMatrix(lngRow, COL_检查方法) = ""
            Else
                .TextMatrix(lngRow, COL_检查方法) = 1
            End If
            '输血的途径行
            If lng给药途径ID <> 0 Then
                If gbln血库系统 = True Then
                    strSQL = "Select a.名称,a.操作类型,a.执行分类 From 诊疗项目目录 A where a.id=[1]"
                    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng给药途径ID)
                    .TextMatrix(lngRow, COL_用法) = rsTmp!名称 & ""
                
                    If Val(rsTmp!操作类型 & "") = 8 And Val(rsTmp!执行分类 & "") = 1 Then '如果是编辑界面用申请单时需要重设一次
                        .TextMatrix(lngRow, COL_检查方法) = 1
                    Else
                        .TextMatrix(lngRow, COL_检查方法) = ""
                    End If
                Else
                    .TextMatrix(lngRow, COL_用法) = Sys.RowValue("诊疗项目目录", lng给药途径ID, "名称")
                End If
                Call AdviceSet输血途径(lngRow, lng给药途径ID)
            End If
        End If
        If Val(.TextMatrix(lngRow, COL_执行科室ID)) <> 0 Then
            .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称")
        Else
            .TextMatrix(lngRow, COL_执行科室) = ""
        End If
        If lngGroupRow <> 0 And .TextMatrix(lngRow, COL_审核状态) <> "" Then
            Call SetRow标志图标(lngRow, 0)
        Else
            Call SetRow标志图标(lngRow, 1)
        End If
        
        '医嘱内容
        .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub AdviceInputFree(ByVal lngRow As Long)
'功能：处理新增自由输入医嘱
    Dim str医生 As String, lng医生ID As Long
    Dim lngCopyRow As Long, vCurDate As Date
    Dim lngBabyEdit As Long
    
    If CheckedPathSended = False Then Exit Sub
    lngBabyEdit = CheckBabyEdit
    If lngBabyEdit = 1 Then
        MsgBox "当前病人不在本科室，不允许编辑病人医嘱。", vbInformation, Me.Caption
        Exit Sub
    ElseIf lngBabyEdit = 2 Then
        MsgBox "当前病人的婴儿不在本科室，不允许编辑婴儿医嘱。", vbInformation, Me.Caption
        Exit Sub
    End If
    
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
    
    vCurDate = zlDatabase.Currentdate
    
    With vsAdvice
        If .RowData(lngRow) <> 0 Then
            If txt医嘱内容.Text <> .TextMatrix(lngRow, col_医嘱内容) Then
                .TextMatrix(lngRow, col_医嘱内容) = txt医嘱内容.Text
                
                '医生站时严格检查开嘱医生
                If mint场合 <> 1 And GetAuditName(.TextMatrix(lngRow, COL_开嘱医生)) <> UserInfo.姓名 Then
                    .TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
                    Call Cbo.SeekIndex(cbo医生, UserInfo.姓名) '界面更新
                    .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
                End If
                
                If InStr(",0,3,", .TextMatrix(lngRow, COL_EDIT)) > 0 Then
                    .TextMatrix(lngRow, COL_EDIT) = 2
                    .TextMatrix(lngRow, COL_状态) = IIF(Val(.TextMatrix(lngRow, COL_状态)) = -1, -1, 1)
                    Call ReSetColor(lngRow)
                End If
                mblnNoSave = True '标记为未保存
            End If
        Else
            .RowData(lngRow) = GetNext医嘱ID
            .TextMatrix(lngRow, COL_EDIT) = 1 '新增
            .TextMatrix(lngRow, COL_期效) = zlCommFun.GetNeedName(cbo期效.Text)
            .TextMatrix(lngRow, COL_婴儿) = cbo婴儿.ListIndex
            .TextMatrix(lngRow, COL_状态) = IIF(mbln暂存, -1, 1) '新开
            
            '序号:保持连续,当前行占用新序号后,后面的序号向后移
            .TextMatrix(lngRow, COL_序号) = GetCurRow序号(lngRow)
            Call AdviceSet医嘱序号(lngRow + 1, 1)
                            
            .TextMatrix(lngRow, col_医嘱内容) = txt医嘱内容.Text
            .TextMatrix(lngRow, COL_类别) = "*" '特殊标记,为程序处理需要
            .TextMatrix(lngRow, COL_诊疗项目ID) = 0
            
            .TextMatrix(lngRow, COL_执行性质) = 4 '按可选执行科室处理，缺省为无
            .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, "*", 0, 0, 4, mlng病人科室id, 0, cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
            .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称")
            If IsDate(msk开始时间.Text) Then
                .TextMatrix(lngRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开始时间) = msk开始时间.Text
            End If
                
            '开嘱医生
            If mint场合 = 1 Then '护士使用时
                '与上一行相同
                If lngCopyRow <> -1 Then
                    .TextMatrix(lngRow, COL_开嘱医生) = .TextMatrix(lngCopyRow, COL_开嘱医生)
                    If .TextMatrix(lngRow, COL_开嘱医生) Like "*/*" Then
                        .TextMatrix(lngRow, COL_开嘱医生) = Mid(.TextMatrix(lngRow, COL_开嘱医生), InStr(.TextMatrix(lngRow, COL_开嘱医生), "/") + 1)
                    End If
                End If
                '缺省为病人的住院医师或病人科室的第一个医生
                If .TextMatrix(lngRow, COL_开嘱医生) = "" Then
                    str医生 = Get住院医师
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, str医生, lng医生ID)
                    .TextMatrix(lngRow, COL_开嘱医生) = str医生
                Else
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, .TextMatrix(lngRow, COL_开嘱医生), lng医生ID, , , True)
                End If
                .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(lng医生ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            Else
                .TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
                .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            End If
                                
            '紧急标志
            If IsDate(.Cell(flexcpData, lngRow, COL_开始时间)) Then
                If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                    .TextMatrix(lngRow, COL_标志) = 2
                ElseIf DateDiff("n", CDate(.Cell(flexcpData, lngRow, COL_开始时间)), vCurDate) > gint补录间隔 Then
                    .TextMatrix(lngRow, COL_标志) = 2
                Else
                    .TextMatrix(lngRow, COL_标志) = chk紧急.value
                End If
            End If
                                
            '开嘱时间
            .TextMatrix(lngRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
            .Cell(flexcpData, lngRow, COL_开嘱时间) = Format(vCurDate, "yyyy-MM-dd HH:mm")
            
            Call SetRow标志图标(lngRow)
            
            
            '路径病人添加医嘱时检查是否是路径内项目(自由录入的都当成路径外项目)
            If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
            
            mblnNoSave = True '标记为未保存
            
            Call vsAdvice_AfterRowColChange(-1, -1, lngRow, .Col)
        End If
        
    End With
End Sub

Private Sub AdviceSet检查组合(ByVal lngRow As Long, ByVal strExData As String)
'功能：重新设置指定检查组合项目的部位方法行,用于新输入检查组合项目或修改部位方法
'参数：lngRow=当前输入行
'      strExData=包含检查部位方法等信息,格式为:"部位名1;方法名1,方法名2|部位名2;方法名1,方法名2|...<vbTab>0-常规/1-床旁/2-术中"
    Dim arrItems As Variant, arrMethod As Variant
    Dim int执行标记 As Integer, str检查部位 As String
    Dim i As Integer, j As Integer, k As Integer
    
    '删除现有的检查部位方法行
    Call Delete检查手术输血(lngRow)
    
    '重新加入部位方法行
    If strExData <> "" Then
        '执行标记
        If UBound(Split(strExData, vbTab)) >= 1 Then
            int执行标记 = Val(Split(strExData, vbTab)(1))
        End If
        vsAdvice.TextMatrix(lngRow, COL_执行标记) = int执行标记 '在这里统一更新主行的执行标记
        
        arrItems = Split(Split(strExData, vbTab)(0), "|")
        For i = 0 To UBound(arrItems)
            str检查部位 = Split(arrItems(i), ";")(0)
            arrMethod = Split(Split(arrItems(i), ";")(1), ",")
            For j = 0 To UBound(arrMethod)
                k = k + 1
                With vsAdvice
                    .AddItem "", lngRow + k
                    .RowHidden(lngRow + k) = True
                    
                    .RowData(lngRow + k) = GetNext医嘱ID
                    .TextMatrix(lngRow + k, COL_相关ID) = .RowData(lngRow)
                    
                    .TextMatrix(lngRow + k, COL_EDIT) = 1 '新增
                    
                    .TextMatrix(lngRow + k, COL_婴儿) = cbo婴儿.ListIndex
                    .TextMatrix(lngRow + k, COL_序号) = Val(.TextMatrix(lngRow, COL_序号)) + k
                    .TextMatrix(lngRow + k, COL_状态) = IIF(mbln暂存, -1, 1) '新开
                    .TextMatrix(lngRow + k, COL_期效) = .TextMatrix(lngRow, COL_期效)
                    
                    .TextMatrix(lngRow + k, COL_类别) = .TextMatrix(lngRow, COL_类别)
                    .TextMatrix(lngRow + k, COL_诊疗项目ID) = .TextMatrix(lngRow, COL_诊疗项目ID) '为同一个检查项目
                    
                    .TextMatrix(lngRow + k, COL_计算方式) = .TextMatrix(lngRow, COL_计算方式)
                    .TextMatrix(lngRow + k, COL_频率性质) = .TextMatrix(lngRow, COL_频率性质)
                    .TextMatrix(lngRow + k, COL_操作类型) = .TextMatrix(lngRow, COL_操作类型)
                    .TextMatrix(lngRow + k, COL_单独应用) = .TextMatrix(lngRow, COL_单独应用)
                    .TextMatrix(lngRow + k, COL_执行分类) = .TextMatrix(lngRow, COL_执行分类)
                    .TextMatrix(lngRow + k, COL_处方限量) = .TextMatrix(lngRow, COL_处方限量)
                    
                    .TextMatrix(lngRow + k, col_医嘱内容) = .TextMatrix(lngRow, COL_名称) '记录为检查项目名称
                    .TextMatrix(lngRow + k, COL_标本部位) = str检查部位
                    .TextMatrix(lngRow + k, COL_检查方法) = arrMethod(j)
                    .TextMatrix(lngRow + k, COL_执行标记) = int执行标记
                    
                    .TextMatrix(lngRow + k, COL_计价性质) = .TextMatrix(lngRow, COL_计价性质)
                    
                    .TextMatrix(lngRow + k, COL_单量) = .TextMatrix(lngRow, COL_单量)
                    .TextMatrix(lngRow + k, COL_总量) = .TextMatrix(lngRow, COL_总量)
                    
                    .TextMatrix(lngRow + k, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
                    .TextMatrix(lngRow + k, COL_频率) = .TextMatrix(lngRow, COL_频率)
                    .TextMatrix(lngRow + k, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
                    .TextMatrix(lngRow + k, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
                    .TextMatrix(lngRow + k, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
                    
                    .TextMatrix(lngRow + k, COL_终止时间) = .TextMatrix(lngRow, COL_终止时间)
                    .Cell(flexcpData, lngRow + k, COL_终止时间) = .Cell(flexcpData, lngRow, COL_终止时间)
                    
                    .TextMatrix(lngRow + k, COL_执行性质) = .TextMatrix(lngRow, COL_执行性质)
                    .TextMatrix(lngRow + k, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                    
                    .TextMatrix(lngRow + k, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                    .Cell(flexcpData, lngRow + k, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
                    
                    .TextMatrix(lngRow + k, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                    .TextMatrix(lngRow + k, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                    
                    .TextMatrix(lngRow + k, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                    .Cell(flexcpData, lngRow + k, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                    
                    .TextMatrix(lngRow + k, COL_标志) = .TextMatrix(lngRow, COL_标志)
                End With
            Next
        Next
                
        '调整后面医嘱的序号
        Call AdviceSet医嘱序号(lngRow + k + 1, k)
    End If
End Sub

Private Sub AdviceSet手术组合(ByVal lngRow As Long, ByVal strDataIDs As String)
'功能：重新设置指定手术项目的附加手术及麻醉项目行,用于新输入手术项目或手术项目的附加手术及麻醉项目
'参数：lngRow=当前输入行
'      strDataIDs=包含附加手术及麻醉项目信息,其中可能没有附加手术和麻醉
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim arrIDs As Variant
    
    On Error GoTo errH
            
    '删除现有的附加手术及麻醉项目行
    Call Delete检查手术输血(lngRow)
    
    '重新加入附加手术行及麻醉项目行
    strDataIDs = Trim(Replace(strDataIDs, ";", ","))
    If Left(strDataIDs, 1) = "," Then strDataIDs = Mid(strDataIDs, 2)
    If Right(strDataIDs, 1) = "," Then strDataIDs = Mid(strDataIDs, 1, Len(strDataIDs) - 1)
    
    If strDataIDs <> "" Then
        Set rsTmp = Get诊疗项目记录(0, strDataIDs)
        If Not rsTmp.EOF Then
            arrIDs = Split(strDataIDs, ",")
            For i = 0 To UBound(arrIDs) '按用户输入项目顺序
                rsTmp.Filter = "ID=" & CStr(arrIDs(i)) '不可能EOF
                
                With vsAdvice
                    .AddItem "", lngRow + i + 1
                    .RowHidden(lngRow + i + 1) = True
                    
                    .RowData(lngRow + i + 1) = GetNext医嘱ID
                    .TextMatrix(lngRow + i + 1, COL_相关ID) = .RowData(lngRow)
                    
                    .TextMatrix(lngRow + i + 1, COL_EDIT) = 1 '新增
                    
                    .TextMatrix(lngRow + i + 1, COL_婴儿) = cbo婴儿.ListIndex
                    .TextMatrix(lngRow + i + 1, COL_序号) = Val(.TextMatrix(lngRow, COL_序号)) + i + 1
                    .TextMatrix(lngRow + i + 1, COL_状态) = IIF(mbln暂存, -1, 1) '新开
                    .TextMatrix(lngRow + i + 1, COL_期效) = .TextMatrix(lngRow, COL_期效)
                    
                    .TextMatrix(lngRow + i + 1, COL_类别) = rsTmp!类别
                    .TextMatrix(lngRow + i + 1, COL_诊疗项目ID) = rsTmp!ID
                    .Cell(flexcpData, lngRow + i + 1, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", .TextMatrix(lngRow + i + 1, COL_诊疗项目ID) & "||2")
                    
                    .TextMatrix(lngRow + i + 1, COL_计算方式) = NVL(rsTmp!计算方式, 0)
                    .TextMatrix(lngRow + i + 1, COL_频率性质) = NVL(rsTmp!执行频率, 0)
                    .TextMatrix(lngRow + i + 1, COL_操作类型) = NVL(rsTmp!操作类型)
                    .TextMatrix(lngRow + i + 1, COL_单独应用) = NVL(rsTmp!单独应用)
                    .TextMatrix(lngRow + i + 1, COL_执行分类) = NVL(rsTmp!执行分类, 0)
                    .TextMatrix(lngRow + i + 1, COL_处方限量) = NVL(rsTmp!录入限量)
                    
                    .TextMatrix(lngRow + i + 1, COL_手术时间) = .TextMatrix(lngRow, COL_手术时间) '手术/输血时间
                    .TextMatrix(lngRow + i + 1, col_医嘱内容) = rsTmp!名称
                    
                    .TextMatrix(lngRow + i + 1, COL_计价性质) = NVL(rsTmp!计价性质, 0)
                    
                    .TextMatrix(lngRow + i + 1, COL_单量) = .TextMatrix(lngRow, COL_单量)
                    .TextMatrix(lngRow + i + 1, COL_总量) = .TextMatrix(lngRow, COL_总量)
                    
                    .TextMatrix(lngRow + i + 1, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
                    .TextMatrix(lngRow + i + 1, COL_频率) = .TextMatrix(lngRow, COL_频率)
                    .TextMatrix(lngRow + i + 1, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
                    .TextMatrix(lngRow + i + 1, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
                    .TextMatrix(lngRow + i + 1, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
                    .TextMatrix(lngRow + i + 1, COL_终止时间) = .TextMatrix(lngRow, COL_终止时间)
                    .Cell(flexcpData, lngRow + i + 1, COL_终止时间) = .Cell(flexcpData, lngRow, COL_终止时间)
                    
                    '执行性质:根据项目自身设置
                    .TextMatrix(lngRow + i + 1, COL_执行性质) = NVL(rsTmp!执行科室, 0)
                    
                    '叮嘱和院外执行无执行科室,手术麻醉单独执行科室
                    '否则不管其执行科室设置,一个手术组合应该相同
                    If InStr(",0,5,", NVL(rsTmp!执行科室, 0)) > 0 Then
                        .TextMatrix(lngRow + i + 1, COL_执行科室ID) = 0
                    Else
                        If rsTmp!类别 = "G" Then
                            .TextMatrix(lngRow + i + 1, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsTmp!类别, rsTmp!ID, 0, _
                                NVL(rsTmp!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                        Else
                            .TextMatrix(lngRow + i + 1, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                        End If
                    End If
                    
                    .TextMatrix(lngRow + i + 1, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                    .Cell(flexcpData, lngRow + i + 1, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
                    
                    .TextMatrix(lngRow + i + 1, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                    .TextMatrix(lngRow + i + 1, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                    
                    .TextMatrix(lngRow + i + 1, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                    .Cell(flexcpData, lngRow + i + 1, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                    
                    .TextMatrix(lngRow + i + 1, COL_标志) = .TextMatrix(lngRow, COL_标志)
                    
                    .TextMatrix(lngRow + i + 1, COL_审核状态) = .TextMatrix(lngRow, COL_审核状态)
                End With
            Next
                
            '调整序号
            Call AdviceSet医嘱序号(lngRow + UBound(arrIDs) + 2, UBound(arrIDs) + 1)
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function AdviceSet给药途径(ByVal lngRow As Long, ByVal lng给药途径ID As Long, _
    Optional ByVal str执行性质 As String, Optional ByVal lng给药执行ID As Long, Optional ByVal str滴速 As String) As Long
'功能：为录入的中，西成药设置对应的给药途径行(新增或修改)
'参数：lngRow=要处理给药途径的药品行
'      lng给药途径ID=给药途径ID
'      str执行性质=修改给药途径时,当前界面设置的执行性质
'      lng给药执行ID=修改给药途径时,当前界面设置的执行科室
'      str滴速=修改给药途径时,当前界面设置的滴速
'返回：被设置的给药途径行的医嘱ID
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, lngNewRow As Long
    Dim blnNew As Boolean
    
    On Error GoTo errH
    Set rsTmp = Get诊疗项目记录(lng给药途径ID)
    If rsTmp.EOF Then lng给药途径ID = 0 '没有数据，先设置以保持关系
    
    With vsAdvice
        If Val(.TextMatrix(lngRow, COL_相关ID)) = 0 Then '未设置"相关ID"时
            blnNew = True
            lngNewRow = lngRow + 1
            .AddItem "", lngNewRow
            .RowHidden(lngNewRow) = True
        Else
            '修改医嘱的内容时重新设置给药途径内容(不是更换诊疗项目)
            blnNew = False
            lngNewRow = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
        End If
        
        '无效内容：名称,收费细目ID,剂量系数,住院单位,住院包装,标本部位,医生嘱托,单量,总量,用法
        If blnNew Then
            .RowData(lngNewRow) = GetNext医嘱ID
            .TextMatrix(lngNewRow, COL_EDIT) = 1 '新增
            .TextMatrix(lngNewRow, COL_序号) = Val(.TextMatrix(lngRow, COL_序号)) + 1
            
            '设置临床路径相关数据
            If mlng路径状态 <> 0 Then
                .TextMatrix(lngNewRow, COL_路径项目ID) = .TextMatrix(lngRow, COL_路径项目ID)
                .TextMatrix(lngNewRow, COL_路径执行方式) = .TextMatrix(lngRow, COL_路径执行方式)
                
                If mbytUseType = 1 Then '生成路径时
                    .Cell(flexcpChecked, lngNewRow, COL_选择) = .Cell(flexcpChecked, lngRow, COL_选择)
                    .TextMatrix(lngNewRow, COL_选择) = .TextMatrix(lngRow, COL_选择)
                Else
                    .TextMatrix(lngNewRow, COL_路径执行ID) = .TextMatrix(lngRow, COL_路径执行ID)
                    .TextMatrix(lngNewRow, COL_路径项目分类) = .TextMatrix(lngRow, COL_路径项目分类)
                End If
            End If
        Else
            '医嘱ID(RowData),序号:保持不变
            If InStr(",0,3,", .TextMatrix(lngNewRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngNewRow, COL_EDIT) = 2 '标志为内容修改
                .TextMatrix(lngNewRow, COL_状态) = IIF(Val(.TextMatrix(lngNewRow, COL_状态)) = -1, -1, 1) '修改后变为新开
            End If
        End If
        If Val(.TextMatrix(lngNewRow, COL_EDIT)) = 1 Then
            .TextMatrix(lngNewRow, COL_状态) = IIF(mbln暂存, -1, 1) '新开
        Else
            .TextMatrix(lngNewRow, COL_状态) = IIF(Val(.TextMatrix(lngNewRow, COL_状态)) = -1, -1, 1) '新开
        End If
        
        If mbytUseType = 1 Then '82440
            .TextMatrix(lngNewRow, COL_婴儿) = .TextMatrix(lngRow, COL_婴儿)
        Else
            .TextMatrix(lngNewRow, COL_婴儿) = cbo婴儿.ListIndex
        End If
        
        .TextMatrix(lngNewRow, COL_期效) = .TextMatrix(lngRow, COL_期效)
        
        .TextMatrix(lngNewRow, COL_类别) = "E" '给药途径属于治疗
        .TextMatrix(lngNewRow, COL_诊疗项目ID) = lng给药途径ID
        
        '如果没有确定给药途径，暂时不设置的内容
        If Not rsTmp.EOF Then
            .TextMatrix(lngNewRow, COL_计算方式) = NVL(rsTmp!计算方式, 0)
            .TextMatrix(lngNewRow, COL_操作类型) = NVL(rsTmp!操作类型)
            .TextMatrix(lngNewRow, COL_单独应用) = NVL(rsTmp!单独应用)
            .TextMatrix(lngNewRow, COL_执行分类) = NVL(rsTmp!执行分类, 0)
            .TextMatrix(lngNewRow, col_医嘱内容) = rsTmp!名称
            
            .TextMatrix(lngNewRow, COL_计价性质) = NVL(rsTmp!计价性质, 0)
            
            '滴速
            If str滴速 <> "" Then
                .TextMatrix(lngNewRow, COL_医生嘱托) = str滴速
            End If
            .Cell(flexcpData, lngNewRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", .TextMatrix(lngNewRow, COL_诊疗项目ID) & "||2")
            
            '执行性质:缺省根据项目设置,修改时根据当前界面设置
            If str执行性质 = "" Then
                .TextMatrix(lngNewRow, COL_执行性质) = NVL(rsTmp!执行科室, 0)
            Else
                .TextMatrix(lngNewRow, COL_执行性质) = Decode(str执行性质, "离院带药", 5, NVL(rsTmp!执行科室, 0))
            End If
            
            If InStr(",0,5,", Val(.TextMatrix(lngNewRow, COL_执行性质))) = 0 Then
                If lng给药执行ID <> 0 Then
                    .TextMatrix(lngNewRow, COL_执行科室ID) = lng给药执行ID
                Else
                    .TextMatrix(lngNewRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, "E", lng给药途径ID, 0, _
                        NVL(rsTmp!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                End If
            Else
                .TextMatrix(lngNewRow, COL_执行科室ID) = 0
            End If
        End If
        
        '给药途径天数与药品相同
        .TextMatrix(lngNewRow, COL_天数) = .TextMatrix(lngRow, COL_天数)
        
        .TextMatrix(lngNewRow, COL_频率性质) = .TextMatrix(lngRow, COL_频率性质) '以药品的为准
        .TextMatrix(lngNewRow, COL_频率) = .TextMatrix(lngRow, COL_频率)
        .TextMatrix(lngNewRow, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
        .TextMatrix(lngNewRow, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
        .TextMatrix(lngNewRow, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
        .TextMatrix(lngNewRow, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
        
        .TextMatrix(lngNewRow, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
        .Cell(flexcpData, lngNewRow, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
        
        .TextMatrix(lngNewRow, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
        .TextMatrix(lngNewRow, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
        
        .TextMatrix(lngNewRow, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
        .Cell(flexcpData, lngNewRow, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
        
        .TextMatrix(lngNewRow, COL_终止时间) = .TextMatrix(lngRow, COL_终止时间)
        .Cell(flexcpData, lngNewRow, COL_终止时间) = .Cell(flexcpData, lngRow, COL_终止时间)
        
        .TextMatrix(lngNewRow, COL_标志) = .TextMatrix(lngRow, COL_标志)
        .TextMatrix(lngNewRow, COL_审核状态) = .TextMatrix(lngRow, COL_审核状态)
            
        '往后调整序号
        If blnNew Then Call AdviceSet医嘱序号(lngNewRow + 1, 1)
        
        AdviceSet给药途径 = .RowData(lngNewRow)
    End With
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet输血途径(ByVal lngRow As Long, ByVal lng输血途径ID As Long, Optional ByVal lng输血执行ID As Long) As Long
'功能：为录入的中，西成药设置对应的给药途径行(新增或修改)
'参数：lngRow=要处理输血途径的输血医嘱行
'      lng输血途径ID=输血途径ID
'      lng输血执行ID=修改输血途径时,当前界面设置的执行科室
'返回：被设置的输血途径行的医嘱ID
    Dim rsTmp As New ADODB.Recordset
    Dim lngNewRow As Long
    Dim blnNew As Boolean
    Dim strTmp As String
    
    On Error GoTo errH
    Set rsTmp = Get诊疗项目记录(lng输血途径ID)
    
    With vsAdvice
        lngNewRow = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_相关ID)
        If lngNewRow = -1 Then '尚未设置输血途径时
            blnNew = True
            lngNewRow = lngRow + 1
            .AddItem "", lngNewRow
            .RowHidden(lngNewRow) = True
        End If
        
        '无效内容：名称,收费细目ID,剂量系数,住院单位,住院包装,标本部位,医生嘱托,单量,总量,用法
        If blnNew Then
            .RowData(lngNewRow) = GetNext医嘱ID
            .TextMatrix(lngNewRow, COL_相关ID) = .RowData(lngRow)
            .TextMatrix(lngNewRow, COL_EDIT) = 1 '新增
            .TextMatrix(lngNewRow, COL_序号) = Val(.TextMatrix(lngRow, COL_序号)) + 1
        Else
            '医嘱ID(RowData),序号:保持不变
            If InStr(",0,3,", .TextMatrix(lngNewRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngNewRow, COL_EDIT) = 2 '标志为内容修改
                .TextMatrix(lngNewRow, COL_状态) = IIF(Val(.TextMatrix(lngNewRow, COL_状态)) = -1, -1, 1) '修改后变为新开
            End If
        End If
        If Val(.TextMatrix(lngNewRow, COL_EDIT)) = 1 Then
            .TextMatrix(lngNewRow, COL_状态) = IIF(mbln暂存, -1, 1) '新开
        Else
            .TextMatrix(lngNewRow, COL_状态) = IIF(Val(.TextMatrix(lngNewRow, COL_状态)) = -1, -1, 1) '新开
        End If
        
        If mbytUseType = 1 Then '82440
            .TextMatrix(lngNewRow, COL_婴儿) = .TextMatrix(lngRow, COL_婴儿)
        Else
            .TextMatrix(lngNewRow, COL_婴儿) = cbo婴儿.ListIndex
        End If
        
        .TextMatrix(lngNewRow, COL_期效) = .TextMatrix(lngRow, COL_期效)
        
        .TextMatrix(lngNewRow, COL_类别) = "E" '输血途径属于治疗
        .TextMatrix(lngNewRow, COL_诊疗项目ID) = lng输血途径ID
        .Cell(flexcpData, lngNewRow, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, 0, "", 0, "", .TextMatrix(lngNewRow, COL_诊疗项目ID) & "||2")
        
        .TextMatrix(lngNewRow, COL_计算方式) = NVL(rsTmp!计算方式, 0)
        .TextMatrix(lngNewRow, COL_操作类型) = NVL(rsTmp!操作类型)
        .TextMatrix(lngNewRow, COL_单独应用) = NVL(rsTmp!单独应用)
        .TextMatrix(lngNewRow, COL_执行分类) = NVL(rsTmp!执行分类, 0)
        .TextMatrix(lngNewRow, col_医嘱内容) = rsTmp!名称
        
        .TextMatrix(lngNewRow, COL_计价性质) = NVL(rsTmp!计价性质, 0)
        .TextMatrix(lngNewRow, COL_执行性质) = NVL(rsTmp!执行科室, 0)
        
        If InStr(",0,5,", Val(.TextMatrix(lngNewRow, COL_执行性质))) = 0 Then
            If lng输血执行ID <> 0 Then
                .TextMatrix(lngNewRow, COL_执行科室ID) = lng输血执行ID
            Else
                .TextMatrix(lngNewRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, "E", lng输血途径ID, 0, _
                    NVL(rsTmp!执行科室, 0), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
            End If
        Else
            .TextMatrix(lngNewRow, COL_执行科室ID) = 0
        End If
        
        .TextMatrix(lngNewRow, COL_频率性质) = .TextMatrix(lngRow, COL_频率性质) '以药品的为准
        .TextMatrix(lngNewRow, COL_频率) = .TextMatrix(lngRow, COL_频率)
        .TextMatrix(lngNewRow, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
        .TextMatrix(lngNewRow, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
        .TextMatrix(lngNewRow, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
        .TextMatrix(lngNewRow, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
        .TextMatrix(lngNewRow, COL_审核状态) = .TextMatrix(lngRow, COL_审核状态)
        
        .TextMatrix(lngNewRow, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
        .Cell(flexcpData, lngNewRow, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
        
        .TextMatrix(lngNewRow, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
        .TextMatrix(lngNewRow, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
        
        .TextMatrix(lngNewRow, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
        .Cell(flexcpData, lngNewRow, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
        
        .TextMatrix(lngNewRow, COL_终止时间) = .TextMatrix(lngRow, COL_终止时间)
        .Cell(flexcpData, lngNewRow, COL_终止时间) = .Cell(flexcpData, lngRow, COL_终止时间)
        
        .TextMatrix(lngNewRow, COL_标志) = .TextMatrix(lngRow, COL_标志)
            
        '往后调整序号
        If blnNew Then Call AdviceSet医嘱序号(lngNewRow + 1, 1)
        
        AdviceSet输血途径 = .RowData(lngNewRow)
        '跟据输血途径来重设输血医嘱的审核状态
        strTmp = GetBloodState(IIF(Val(.TextMatrix(lngNewRow, COL_标志)) = 1, 1, 0), Val(.TextMatrix(lngNewRow, COL_执行分类)))
        .TextMatrix(lngNewRow, COL_审核状态) = strTmp
        .TextMatrix(lngRow, COL_审核状态) = strTmp
        Call SetRow标志图标(lngRow, 2)
    End With
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub ShowHideFirstDate(ByVal lngRow As Long)
'功能：根据当前输入医嘱行的状态，显示或隐藏首日执行时间
    Dim blnTemp As Boolean
    
    With vsAdvice
        blnTemp = False
        
        '首日时间：按天、周频率的长期医嘱
        If cbo期效.ListIndex = 0 And cbo执行时间.Enabled And Val(.TextMatrix(lngRow, COL_频率间隔)) = 1 _
            And (.TextMatrix(lngRow, COL_间隔单位) = "周" Or .TextMatrix(lngRow, COL_间隔单位) = "天") Then
            blnTemp = True
        End If
    
        If blnTemp And Not txt首日时间.Visible Then
            SetItemEditable , , , , , , , , , , , , 1
            lbl首日时间.Caption = Decode(.TextMatrix(lngRow, COL_间隔单位), "周", "↓首周", "↓首日")
        ElseIf Not blnTemp And txt首日时间.Visible Then
            SetItemEditable , , , , , , , , , , , , -1
            txt首日时间.Tag = "1" '内容被清除
        End If
    End With
End Sub

Private Sub AdviceChange()
'功能：根据当前医嘱卡片中的内容，更新当前医嘱内容
'说明：对于ListIndex=-1而对应医嘱项又有内容的，保持原内容不更新
    Dim lngRow As Long, lngBeginRow As Long, lngEndRow As Long
    Dim int频率次数 As Integer, int频率间隔 As Integer, str间隔单位 As String
    Dim blnCurDo As Boolean, blnOtherDo As Boolean, blnTmp As Boolean
    Dim lngTmp As Long, strTmp As String
    Dim strCurDate As String, lng开嘱科室ID As Long
    Dim blnReInRow As Boolean, i As Long, j As Long
    Dim lng执行科室ID As Long, vCurDate As Date
    Dim blnSetColor As Boolean
    Dim dbl总量 As Double
    Dim bln超量说明 As Boolean
    Dim blnExecUpdate As Boolean
    
    With vsAdvice
        lngRow = .Row
        
        If .RowData(lngRow) = 0 Then Call ClearItemTag: Exit Sub '清除编辑标志
        
        vCurDate = zlDatabase.Currentdate
        
        If RowIn配方行(lngRow) Then
            '中药配方
            strCurDate = Format(vCurDate, "yyyy-MM-dd HH:mm")
            lngBeginRow = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
            For i = lngBeginRow To lngRow
                '修改处理配方的所有行内容(包括煎法和用法)
                blnSetColor = False
                If IsDate(msk开始时间.Text) And msk开始时间.Tag <> "" Then
                    .TextMatrix(i, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, i, COL_开始时间) = msk开始时间.Text
                    
                    '更新检查补录标志
                    If DateDiff("n", CDate(msk开始时间.Text), CDate(strCurDate)) > gint补录间隔 _
                        Or mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                        .TextMatrix(i, COL_标志) = 2
                        '用法行界面更新
                        If i = lngRow Then
                            mblnDoCheck = False: chk紧急.Visible = False: chk紧急.value = 0: mblnDoCheck = True
                        End If
                    ElseIf Val(.TextMatrix(i, COL_标志)) = 2 Then
                        .TextMatrix(i, COL_标志) = 0
                        
                        '用法行界面更新
                        If i = lngRow Then
                            mblnDoCheck = False: chk紧急.Visible = True: chk紧急.value = 0: mblnDoCheck = True
                        End If
                    End If
                    
                    If i = lngRow Then '用法行显示紧急标志
                        blnSetColor = True
                    End If
                    
                    '处理是否显示首日时间
                    If i = lngBeginRow Then Call ShowHideFirstDate(i)
                    
                    blnCurDo = True
                End If
                If chk紧急.Visible And chk紧急.Tag <> "" Then
                    .TextMatrix(i, COL_标志) = chk紧急.value
                    '待审核的改为无需审核
                    If chk紧急.value = 1 Then
                        If Val(.TextMatrix(i, COL_审核状态)) = 1 Then .TextMatrix(i, COL_审核状态) = ""
                    Else
                        If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) Then .TextMatrix(i, COL_审核状态) = 1
                    End If
                    
                    If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And .TextMatrix(i, COL_期效) = "长嘱" Then
                        .TextMatrix(i, COL_审核状态) = 1
                    End If
                    
                    If i = lngRow Then '用法行显示紧急标志
                        blnSetColor = True
                    End If
                    blnCurDo = True
                End If
                If txt总量.Enabled And txt总量.Tag <> "" Then
                    .TextMatrix(i, COL_总量) = FormatEx(IIF(Val(txt总量.Text) = 0, "", Val(txt总量.Text)), 5)
                    bln超量说明 = True
                    blnCurDo = True
                End If
                
                If txt频率.Enabled And cmd频率.Tag <> "" And txt频率.Tag <> "" Then
                    .TextMatrix(i, COL_频率) = txt频率.Text
                    Call Get频率信息_名称(txt频率.Text, int频率次数, int频率间隔, str间隔单位, 2) '中医范围
                    .TextMatrix(i, COL_频率次数) = int频率次数
                    .TextMatrix(i, COL_频率间隔) = int频率间隔
                    .TextMatrix(i, COL_间隔单位) = str间隔单位
                    If i = lngRow Then '用法行显示紧急标志
                        blnSetColor = True
                    End If
                    blnCurDo = True
                End If
                If blnSetColor Then
                    Call SetRow标志图标(i, 0)
                End If
                If cbo执行时间.Tag <> "" Or txt首日时间.Tag <> "" Then
                    .TextMatrix(i, COL_执行时间) = IIF(txt首日时间.Text <> "", txt首日时间.Text & ",", "") & cbo执行时间.Text
                    blnCurDo = True
                End If
                
                If .TextMatrix(i, COL_类别) = "7" Then
                    '更改的是组成中药的执行科室(用法煎法的改不到)
                    If cbo执行科室.ListIndex <> -1 And cbo执行科室.Tag <> "" Then
                        .TextMatrix(i, COL_执行科室ID) = cbo执行科室.ItemData(cbo执行科室.ListIndex)
                        blnCurDo = True
                    End If
                    
                    '执行性质:配方中所有组成的中药相同
                    If cbo执行性质.Tag <> "" Then
                        .TextMatrix(i, COL_执行性质) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "自备药", 5, "不取药", 5, 4)
                        .TextMatrix(i, COL_执行标记) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "自取药", 1, "不取药", 2, 0)
                         
                        If Val(.TextMatrix(i, COL_执行性质)) = 5 Then
                            .TextMatrix(i, COL_执行科室ID) = 0
                        ElseIf Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                            '恢复缺省执行科室,缺省与前面相同
                            If i = lngBeginRow Then
                                For j = i - 1 To .FixedRows Step -1
                                    If .TextMatrix(j, COL_类别) = "7" And Val(.TextMatrix(j, COL_执行科室ID)) <> 0 Then
                                        .TextMatrix(i, COL_执行科室ID) = .TextMatrix(j, COL_执行科室ID)
                                        Exit For
                                    End If
                                Next
                                If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                                    .TextMatrix(i, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, .TextMatrix(i, COL_类别), _
                                        Val(.TextMatrix(i, COL_诊疗项目ID)), Val(.TextMatrix(i, COL_收费细目ID)), 4, mlng病人科室id, 0, cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                                End If
                            Else
                                .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngBeginRow, COL_执行科室ID)
                            End If
                        End If
                        blnReInRow = True '界面执行科室编辑性变化
                        blnCurDo = True
                    End If
                End If
                
                '终止时间：中药配方长嘱才有
                If cbo期效.ListIndex = 0 Then
                    If (IsDate(txt终止时间.Text) Or txt终止时间.Text = "") And txt终止时间.Tag <> "" Then
                        .TextMatrix(i, COL_终止时间) = Format(txt终止时间.Text, "yyyy-MM-dd HH:mm")
                        .Cell(flexcpData, i, COL_终止时间) = txt终止时间.Text
                        blnCurDo = True
                    End If
                    
                End If
                
                If cbo医生.ListIndex <> -1 And cbo医生.Tag <> "" Then
                    .TextMatrix(i, COL_开嘱医生) = zlCommFun.GetNeedName(cbo医生.Text)
                    .TextMatrix(i, COL_开嘱科室ID) = Get开嘱科室ID(cbo医生.ItemData(cbo医生.ListIndex), mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
                    blnCurDo = True
                End If
                
                If txt开嘱时间.Tag <> "" And IsDate(txt开嘱时间.Text) Then
                    .TextMatrix(i, COL_开嘱时间) = Format(txt开嘱时间.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, i, COL_开嘱时间) = Format(txt开嘱时间.Text, "yyyy-MM-dd HH:mm")
                    blnCurDo = True
                End If
                                                    
                '修改时自动更新部份内容
                blnTmp = False
                If cbo医生嘱托.Tag <> "" Or cbo执行性质.Tag <> "" _
                    Or (Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "") Then
                    blnTmp = True
                End If
                If blnCurDo Or blnTmp Then
                    '非补录医嘱托修改了内容则更新开嘱时间
                    If Val(.TextMatrix(i, COL_标志)) <> 2 Then
                        .TextMatrix(i, COL_开嘱时间) = Format(strCurDate, "yyyy-MM-dd HH:mm")
                        .Cell(flexcpData, i, COL_开嘱时间) = strCurDate
                        txt开嘱时间.Text = strCurDate
                    End If
                    
                    '医生站时严格检查开嘱医生:如果是已审核的，修改医嘱时以审核医生为准。
                    If mint场合 <> 1 And GetAuditName(.TextMatrix(i, COL_开嘱医生)) <> UserInfo.姓名 Then
                        .TextMatrix(i, COL_开嘱医生) = UserInfo.姓名
                        Call Cbo.SeekIndex(cbo医生, UserInfo.姓名) '界面更新
                        If lng开嘱科室ID = 0 Then
                            lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
                        End If
                        .TextMatrix(i, COL_开嘱科室ID) = lng开嘱科室ID
                    End If
                End If
                                                                    
                If .TextMatrix(i, COL_类别) = "E" And i <> lngRow Then lngTmp = i '煎法行号
                                                    
                '---------------
                If blnCurDo Then '标记为修改:0-原始的,1-新增的,2-修改了内容,3-修改了序号
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2
                        .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1) '修改后变为新开
                        If Not .RowHidden(i) Then Call ReSetColor(i) '用法行才设置
                    End If
                    mblnNoSave = True '标记为未保存
                End If
            Next
            If cbo执行科室.ListIndex <> -1 And cbo执行科室.Tag <> "" Then
                .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow - 2, COL_执行科室ID)), "名称")
                blnCurDo = True
            End If
            '涉及中药用法行的内容:直接更改当前行的内容(煎法行在配方编辑中才能改)
            '-----------------------------------------------------------
            blnCurDo = False
                    
            '医生嘱托:是放在中药用法行(显示行)中的
            If cbo医生嘱托.Tag <> "" Then
                .TextMatrix(lngRow, COL_医生嘱托) = cbo医生嘱托.Text
                blnCurDo = True
            End If
        
            '中药用法
            If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then
                .TextMatrix(lngRow, COL_诊疗项目ID) = Val(cmd用法.Tag)
                .TextMatrix(lngRow, COL_用法) = txt用法.Text
                
                '同时更改计价性质和执行性质
                .TextMatrix(lngRow, COL_计价性质) = NVL(Sys.RowValue("诊疗项目目录", Val(cmd用法.Tag), "计价性质"), 0)
                i = NVL(Sys.RowValue("诊疗项目目录", Val(cmd用法.Tag), "执行科室"), 0)
                .TextMatrix(lngRow, COL_执行性质) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "离院带药", 5, i)
                If Val(.TextMatrix(lngRow, COL_执行性质)) = 5 Then
                    .TextMatrix(lngRow, COL_执行科室ID) = 0
                Else
                    .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, "E", Val(cmd用法.Tag), 0, _
                        Val(.TextMatrix(lngRow, COL_执行性质)), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                End If
                
                blnReInRow = True '需要刷新中药用法执行科室
                blnCurDo = True
            End If
            
            '用法和煎法的执行性质
            If cbo执行性质.Tag <> "" Then
                '用法
                i = NVL(Sys.RowValue("诊疗项目目录", Val(.TextMatrix(lngRow, COL_诊疗项目ID)), "执行科室"), 0)
                .TextMatrix(lngRow, COL_执行性质) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "离院带药", 5, i)
                If Val(.TextMatrix(lngRow, COL_执行性质)) = 5 Then
                    .TextMatrix(lngRow, COL_执行科室ID) = 0
                Else
                    .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, .TextMatrix(lngRow, COL_类别), _
                        Val(.TextMatrix(lngRow, COL_诊疗项目ID)), 0, Val(.TextMatrix(lngRow, COL_执行性质)), _
                        mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                End If
                
                '煎法
                i = NVL(Sys.RowValue("诊疗项目目录", Val(.TextMatrix(lngTmp, COL_诊疗项目ID)), "执行科室"), 0)
                .TextMatrix(lngTmp, COL_执行性质) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "离院带药", 5, i)
                If Val(.TextMatrix(lngTmp, COL_执行性质)) = 5 Then
                    .TextMatrix(lngTmp, COL_执行科室ID) = 0
                Else
                    .TextMatrix(lngTmp, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, .TextMatrix(lngTmp, COL_类别), _
                        Val(.TextMatrix(lngTmp, COL_诊疗项目ID)), 0, Val(.TextMatrix(lngTmp, COL_执行性质)), _
                        mlng病人科室id, Val(.TextMatrix(lngTmp, COL_开嘱科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                End If
                
                If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                    .TextMatrix(lngTmp, COL_EDIT) = 2
                    .TextMatrix(lngTmp, COL_状态) = IIF(Val(.TextMatrix(lngTmp, COL_状态)) = -1, -1, 1) '修改后变为新开
                End If
                
                .TextMatrix(lngRow, COL_医嘱执行性质) = IIF("正常" = zlCommFun.GetNeedName(cbo执行性质.Text), "", zlCommFun.GetNeedName(cbo执行性质.Text))
                .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow - 2, COL_执行科室ID)), "名称")
                If .TextMatrix(lngRow, COL_执行科室) = "" Then .TextMatrix(lngRow, COL_执行科室) = "-"
                mblnNoSave = True '标记为未保存
                
                blnCurDo = True
            End If
            
            '中药用法执行科室:即配方当前显示行的执行科室
            If cbo附加执行.ListIndex <> -1 And cbo附加执行.Tag <> "" Then
                .TextMatrix(lngRow, COL_执行科室ID) = cbo附加执行.ItemData(cbo附加执行.ListIndex)
                blnCurDo = True
            End If
        Else '其它诊疗项目
            If IsDate(msk开始时间.Text) And msk开始时间.Tag <> "" Then
                If .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "6" And .TextMatrix(lngRow, COL_采集时间) = .Cell(flexcpData, lngRow, COL_开始时间) Then
                    .TextMatrix(lngRow, COL_采集时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    txt终止时间.Text = .TextMatrix(lngRow, COL_采集时间)
                End If
                .TextMatrix(lngRow, COL_开始时间) = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开始时间) = msk开始时间.Text
                
                '更新检查补录标志
                If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Or _
                    DateDiff("n", CDate(msk开始时间.Text), vCurDate) > gint补录间隔 Then
                    .TextMatrix(lngRow, COL_标志) = 2
                    mblnDoCheck = False: chk紧急.Visible = False: chk紧急.value = 0: mblnDoCheck = True '界面更新
                    
                ElseIf Val(.TextMatrix(lngRow, COL_标志)) = 2 Then
                    .TextMatrix(lngRow, COL_标志) = 0
                    mblnDoCheck = False: chk紧急.Visible = True: chk紧急.value = 0: mblnDoCheck = True '界面更新
                End If
                                                
                '处理是否显示首日时间
                Call ShowHideFirstDate(lngRow)

                blnCurDo = True
            End If
            If IsDate(txt安排时间.Text) And txt安排时间.Tag <> "" Then
                .TextMatrix(lngRow, COL_手术时间) = txt安排时间.Text
                blnCurDo = True
            End If
            
            If chk紧急.Visible And chk紧急.Tag <> "" Then
                .TextMatrix(lngRow, COL_标志) = chk紧急.value
                '后面处理一并给药中的其他行，待审核的改为无需审核
                If Not (.TextMatrix(lngRow, COL_类别) = "F" Or .TextMatrix(lngRow, COL_类别) = "G" Or .TextMatrix(lngRow, COL_类别) = "K") Then
                    If chk紧急.value = 1 Then
                        If Val(.TextMatrix(lngRow, COL_审核状态)) = 1 Then .TextMatrix(lngRow, COL_审核状态) = ""
                    Else
                        If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(lngRow, COL_抗菌等级)) Then .TextMatrix(lngRow, COL_审核状态) = 1
                    End If
                End If
                
                '长嘱抗菌药紧急要审核(都要审核)
                 If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(lngRow, COL_抗菌等级)) And .TextMatrix(lngRow, COL_期效) = "长嘱" Then
                     .TextMatrix(lngRow, COL_审核状态) = 1
                 End If
                    
                If (gbln输血分级管理 Or gbln血库系统) And .TextMatrix(lngRow, COL_类别) = "K" Then  '输血医嘱处理流程变动 70823
                     
                    blnReInRow = True
                End If
                blnCurDo = True
            End If
            
            If chkStop.Visible And chkStop.Tag <> "" Then
                .TextMatrix(lngRow, COL_执行标记) = chkStop.value    '手术或术前医嘱，是否停止所有长嘱
                blnCurDo = True
            End If
            If cbo分零.Tag <> "" And cbo分零.ListIndex <> -1 Then
                .TextMatrix(lngRow, COL_可否分零) = cbo分零.ItemData(cbo分零.ListIndex)
                .Cell(flexcpData, lngRow, COL_可否分零) = 1 '表示有分零方式变动，需要保存
                blnCurDo = True
                
                If Val(.TextMatrix(lngRow, COL_可否分零)) <> 0 Then
                    .TextMatrix(lngRow, COL_总量) = IntEx(Val(.TextMatrix(lngRow, COL_总量)))
                End If
            End If
            If cbo手术情况.Tag <> "" And cbo手术情况.ListIndex <> -1 Then
                .TextMatrix(lngRow, COL_手术情况) = cbo手术情况.ItemData(cbo手术情况.ListIndex)
                blnCurDo = True
                If gbln手术分级管理 Then
                    If cbo手术情况.Text = "急诊" Then
                         .TextMatrix(lngRow, COL_审核状态) = ""
                    Else
                        If Val(.TextMatrix(lngRow, COL_审核状态)) = 0 Then .TextMatrix(lngRow, COL_审核状态) = 1
                    End If
                    If gbln手术等级管理 And Val(.TextMatrix(lngRow, COL_审核状态)) = 1 Then
                        If gbln手术授权管理 Then
                            If CheckDocEmpowerEx(Val(.TextMatrix(lngRow, COL_诊疗项目ID)), .TextMatrix(lngRow, COL_附项)) Then
                                .TextMatrix(lngRow, COL_审核状态) = ""
                            End If
                        Else
                            If CheckDoc手术等级(Val(.TextMatrix(lngRow, COL_诊疗项目ID)), .TextMatrix(lngRow, COL_附项)) Then
                                .TextMatrix(lngRow, COL_审核状态) = ""
                            End If
                        End If
                    End If
                    Call SetRow标志图标(lngRow, 2)
                End If
            End If
            
            If txt单量.Enabled And (IsNumeric(txt单量.Text) Or txt单量.Text = "") And txt单量.Tag <> "" Then
                .TextMatrix(lngRow, COL_单量) = FormatEx(txt单量.Text, 5)
                bln超量说明 = True
                blnCurDo = True
            End If
            
            If txt首次用量.Tag <> "" Then
                .TextMatrix(lngRow, COL_首次用量) = txt首次用量.Text
                bln超量说明 = True
                blnCurDo = True
            End If
            
            If txt天数.Tag <> "" Then
                .TextMatrix(lngRow, COL_天数) = txt天数.Text
                blnCurDo = True
            End If
            
            If txt总量.Enabled And (IsNumeric(txt总量.Text) Or txt总量.Text = "") And txt总量.Tag <> "" Then
                .TextMatrix(lngRow, COL_总量) = FormatEx(txt总量.Text, 5)
                bln超量说明 = True
                blnCurDo = True
            End If
            
            If txt频率.Enabled And cmd频率.Tag <> "" And txt频率.Tag <> "" Then
                '频率性质已经在设置时确定(临嘱可能在一次性之间切换)
                .TextMatrix(lngRow, COL_频率) = txt频率.Text
                Call Get频率信息_名称(txt频率.Text, int频率次数, int频率间隔, str间隔单位, Get频率范围(lngRow))
                .TextMatrix(lngRow, COL_频率次数) = int频率次数
                .TextMatrix(lngRow, COL_频率间隔) = int频率间隔
                .TextMatrix(lngRow, COL_间隔单位) = str间隔单位
                blnCurDo = True
            End If
            
            If IsDate(msk开始时间.Text) And msk开始时间.Tag <> "" Or chk紧急.Visible And chk紧急.Tag <> "" Or txt频率.Enabled And cmd频率.Tag <> "" And txt频率.Tag <> "" Then
                '显示紧急标志,一并给药显示在第一行
                Call SetRow标志图标(lngRow, 0)
            End If
            
            If cbo执行时间.Tag <> "" Or txt首日时间.Tag <> "" Then
                .TextMatrix(lngRow, COL_执行时间) = IIF(txt首日时间.Text <> "", txt首日时间.Text & ",", "") & cbo执行时间.Text
                blnCurDo = True
            End If
            
            If cbo医生嘱托.Tag <> "" Then
                .TextMatrix(lngRow, COL_医生嘱托) = cbo医生嘱托.Text
                blnCurDo = True
            End If
            
            If cbo执行科室.ListIndex <> -1 And cbo执行科室.Tag <> "" Then
                If Not RowIn检验行(lngRow) Then '采集方法的执行科室不同
                    .TextMatrix(lngRow, COL_执行科室ID) = cbo执行科室.ItemData(cbo执行科室.ListIndex)
                End If
                blnCurDo = True
                
                '会诊开嘱科室可能缺省为会诊科室
                If .TextMatrix(lngRow, COL_类别) = "Z" And Val(.TextMatrix(lngRow, COL_操作类型)) = 7 Then
                    If cbo医生.ListIndex <> -1 Then
                        lng执行科室ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
                        .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(cbo医生.ItemData(cbo医生.ListIndex), mlng医技科室ID, mlng病人科室id, IIF(mlng病人性质 = 1, 1, 2), lng执行科室ID, mlng会诊科室ID)
                    End If
                End If
            End If
            
            '用药目的和理由
            If lbl用药目的.Tag <> "" Then
                .TextMatrix(lngRow, COL_用药目的) = cboDruPur.ListIndex
                blnCurDo = True
            End If
            If txt用药理由.Tag <> "" Then
                .TextMatrix(lngRow, COL_用药理由) = Trim(txt用药理由.Text)
                blnCurDo = True
            End If
            
            '滴速：输液药品
            If cbo滴速.Tag <> "" Then
                If .TextMatrix(lngRow, COL_类别) = "K" Then
                    lngTmp = .FindRow(CLng(.RowData(lngRow)), , COL_相关ID)
                Else
                    lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                End If
                If lngTmp <> -1 Then
                    If cbo滴速.Text <> "" Then
                        .TextMatrix(lngTmp, COL_医生嘱托) = cbo滴速.Text & lbl滴速单位.Caption
                    Else
                        .TextMatrix(lngTmp, COL_医生嘱托) = ""
                    End If
                    If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                        .TextMatrix(lngTmp, COL_EDIT) = 2
                        .TextMatrix(lngTmp, COL_状态) = IIF(Val(.TextMatrix(lngTmp, COL_状态)) = -1, -1, 1) '修改后变为新开
                    End If
                    'mblnNoSave = True '标记为未保存
                    blnCurDo = True
                End If
                If cbo滴速.Text <> "" Then
                    .TextMatrix(lngRow, COL_用法) = txt用法.Text & cbo滴速.Text & lbl滴速单位.Caption
                Else
                    .TextMatrix(lngRow, COL_用法) = txt用法.Text
                End If
            End If
            
            '附加执行科室：给药途径,手术麻醉,采集方法,原液皮试项目
            If cbo附加执行.ListIndex <> -1 And cbo附加执行.Tag <> "" Then
                lngTmp = -1
                If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                    lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                ElseIf .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5" Then
                    lngTmp = lngRow
                ElseIf .TextMatrix(lngRow, COL_类别) = "F" Then
                    For i = lngRow + 1 To .Rows - 1
                        If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                            If .TextMatrix(i, COL_类别) = "G" Then
                                lngTmp = i: Exit For
                            End If
                        Else
                            Exit For
                        End If
                    Next
                ElseIf .TextMatrix(lngRow, COL_类别) = "E" _
                    And .TextMatrix(lngRow - 1, COL_类别) = "C" _
                    And Val(.TextMatrix(lngRow - 1, COL_相关ID)) = .RowData(lngRow) Then
                    lngTmp = lngRow
                                ElseIf .TextMatrix(lngRow, COL_类别) = "K" _
                    And .TextMatrix(lngRow + 1, COL_类别) = "E" _
                    And Val(.TextMatrix(lngRow + 1, COL_相关ID)) = .RowData(lngRow) Then
                    lngTmp = lngRow + 1
                End If
                
                '只更新对应行,不影响其它行
                If lngTmp <> -1 Then
                    If Not (.TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5") Then
                        .TextMatrix(lngTmp, COL_执行科室ID) = cbo附加执行.ItemData(cbo附加执行.ListIndex)
                    End If
                    If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                        .TextMatrix(lngTmp, COL_EDIT) = 2
                        .TextMatrix(lngTmp, COL_状态) = IIF(Val(.TextMatrix(lngTmp, COL_状态)) = -1, -1, 1) '修改后变为新开
                    End If
                    'mblnNoSave = True '标记为未保存
                    blnCurDo = True
                End If
            End If
            
            '原液皮试项目可以不指定附加的药房科室
            If cbo附加执行.Tag <> "" Then
                If .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5" Then
                    lngTmp = lngRow
                    If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                        .TextMatrix(lngTmp, COL_EDIT) = 2
                        .TextMatrix(lngTmp, COL_状态) = 1 '修改后变为新开
                    End If
                    'mblnNoSave = True '标记为未保存
                    blnCurDo = True
                End If
            End If
            
            If (IsDate(txt终止时间.Text) Or txt终止时间.Text = "") And txt终止时间.Tag <> "" Then
                If lbl终止时间.Caption = "采集时间" Then
                    .TextMatrix(lngRow, COL_采集时间) = txt终止时间.Text
                Else
                    .TextMatrix(lngRow, COL_终止时间) = Format(txt终止时间.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, lngRow, COL_终止时间) = txt终止时间.Text
                End If
                blnCurDo = True
            End If
            
            If cbo医生.ListIndex <> -1 And cbo医生.Tag <> "" Then
                lng执行科室ID = 0 '10809,会诊开嘱科室可能缺省为会诊科室
                If .TextMatrix(lngRow, COL_类别) = "Z" And Val(.TextMatrix(lngRow, COL_操作类型)) = 7 Then
                    lng执行科室ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
                End If
                .TextMatrix(lngRow, COL_开嘱医生) = zlCommFun.GetNeedName(cbo医生.Text)
                .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(cbo医生.ItemData(cbo医生.ListIndex), mlng医技科室ID, mlng病人科室id, IIF(mlng病人性质 = 1, 1, 2), lng执行科室ID, mlng会诊科室ID)
                blnCurDo = True
            End If
            
            If txt开嘱时间.Tag <> "" And IsDate(txt开嘱时间.Text) Then
                .TextMatrix(lngRow, COL_开嘱时间) = Format(txt开嘱时间.Text, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开嘱时间) = Format(txt开嘱时间.Text, "yyyy-MM-dd HH:mm")
                blnCurDo = True
            End If
                                    
            '执行性质,给药途径:为更新开嘱时间(包括给药途径的同步更改),先判断是否改变
            If InStr(",5,6,K,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                If cbo执行性质.Tag <> "" Then blnCurDo = True
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then blnCurDo = True
            End If
                                    
            '修改时自动更新部份内容
            blnTmp = False
            If cbo执行性质.Tag <> "" Or (Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "") Then
                blnReInRow = True '需要刷新给药途径,采集方式的执行科室
                blnTmp = True
                If .TextMatrix(lngRow, COL_相关ID) <> "" Then
                    lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    If .TextMatrix(lngTmp, COL_类别) = "E" And .TextMatrix(lngTmp, COL_操作类型) = "2" And .TextMatrix(lngTmp, COL_执行分类) = "1" Then
                        blnExecUpdate = True
                    End If
                End If
            End If
            If blnCurDo Or blnTmp Then
                '非补录医嘱托修改了内容则更新开嘱时间
                If Val(.TextMatrix(lngRow, COL_标志)) <> 2 Then
                    strCurDate = Format(vCurDate, "yyyy-MM-dd HH:mm")
                    .TextMatrix(lngRow, COL_开嘱时间) = Format(strCurDate, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, lngRow, COL_开嘱时间) = strCurDate
                    txt开嘱时间.Text = strCurDate
                End If
                
                '医生站时严格检查开嘱医生:如果是已审核的，修改医嘱时以审核医生为准。
                If mint场合 <> 1 And GetAuditName(.TextMatrix(lngRow, COL_开嘱医生)) <> UserInfo.姓名 Then
                    .TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
                    Call Cbo.SeekIndex(cbo医生, UserInfo.姓名) '界面更新

                    lng执行科室ID = 0 '会诊开嘱科室可能缺省为会诊科室
                    If .TextMatrix(lngRow, COL_类别) = "Z" And Val(.TextMatrix(lngRow, COL_操作类型)) = 7 Then
                        lng执行科室ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
                    End If
                    
                    If lng开嘱科室ID = 0 Then
                        lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, IIF(mlng病人性质 = 1, 1, 2), lng执行科室ID, mlng会诊科室ID)
                    End If
                    .TextMatrix(lngRow, COL_开嘱科室ID) = lng开嘱科室ID
                End If
            End If
                                    
            If cbo执行科室.ListIndex <> -1 And cbo执行科室.Tag <> "" Then
                .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称")
            End If
                                    
            '其它需要同步处理的关联行
            '----------------------------------------------------------------
            If RowIn检验行(lngRow) Then
                '采集方法
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then
                    .TextMatrix(lngRow, COL_诊疗项目ID) = Val(cmd用法.Tag)
                    .TextMatrix(lngRow, COL_用法) = txt用法.Text
                    .TextMatrix(lngRow, COL_名称) = txt用法.Text
                    
                    '同时更改计价性质和执行性质
                    .TextMatrix(lngRow, COL_计价性质) = NVL(Sys.RowValue("诊疗项目目录", Val(cmd用法.Tag), "计价性质"), 0)
                    .TextMatrix(lngRow, COL_执行性质) = NVL(Sys.RowValue("诊疗项目目录", Val(cmd用法.Tag), "执行科室"), 0)
                    If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                        .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, "E", Val(cmd用法.Tag), 0, _
                            Val(.TextMatrix(lngRow, COL_执行性质)), mlng病人科室id, Val(.TextMatrix(lngRow, COL_开嘱科室ID)), cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                    Else
                        .TextMatrix(lngRow, COL_执行科室ID) = 0
                    End If
                    
                    blnCurDo = True
                End If
                
                '设置一并采集的各个检验项目
                If blnCurDo Then
                    For i = lngRow - 1 To .FixedRows Step -1
                        If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                            If txt总量.Tag <> "" Then
                                .TextMatrix(i, COL_总量) = .TextMatrix(lngRow, COL_总量)
                                blnOtherDo = True
                            End If
                            If txt频率.Tag <> "" Then
                                .TextMatrix(i, COL_频率性质) = .TextMatrix(lngRow, COL_频率性质)
                                .TextMatrix(i, COL_频率) = .TextMatrix(lngRow, COL_频率)
                                .TextMatrix(i, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
                                .TextMatrix(i, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
                                .TextMatrix(i, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
                                blnOtherDo = True
                            End If
                            If cbo执行科室.Tag <> "" And cbo执行科室.ListIndex <> -1 Then
                                If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) > 0 Then
                                    .TextMatrix(i, COL_执行科室ID) = 0
                                Else
                                    .TextMatrix(i, COL_执行科室ID) = cbo执行科室.ItemData(cbo执行科室.ListIndex)
                                End If
                                blnOtherDo = True
                            End If
                            If msk开始时间.Tag <> "" Then
                                .TextMatrix(i, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                                .Cell(flexcpData, i, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
                                
                                .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                
                                .TextMatrix(i, COL_标志) = .TextMatrix(lngRow, COL_标志)
                                
                                blnOtherDo = True
                            End If
                            If cbo执行时间.Tag <> "" Or txt首日时间.Tag <> "" Then
                                .TextMatrix(i, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
                                blnOtherDo = True
                            End If
                            If txt终止时间.Tag <> "" And lbl终止时间.Caption <> "采集时间" Then
                                .TextMatrix(i, COL_终止时间) = .TextMatrix(lngRow, COL_终止时间)
                                .Cell(flexcpData, i, COL_终止时间) = .Cell(flexcpData, lngRow, COL_终止时间)
                                blnOtherDo = True
                            End If
                            If cbo医生.Tag <> "" Then
                                .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                                .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                                blnOtherDo = True
                            End If
                            If txt开嘱时间.Tag <> "" Then
                                .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                blnOtherDo = True
                            End If
                            If chk紧急.Tag <> "" Then
                                .TextMatrix(i, COL_标志) = .TextMatrix(lngRow, COL_标志)
                                blnOtherDo = True
                            End If
                            
                            '开嘱时间
                            If .TextMatrix(i, COL_开嘱时间) <> .TextMatrix(lngRow, COL_开嘱时间) Then
                                .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                blnOtherDo = True
                            End If
                            
                            '开嘱医生
                            If .TextMatrix(i, COL_开嘱医生) <> .TextMatrix(lngRow, COL_开嘱医生) Then
                                .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                                blnOtherDo = True
                            End If
                            
                            '开嘱科室ID
                            If .TextMatrix(i, COL_开嘱科室ID) <> .TextMatrix(lngRow, COL_开嘱科室ID) Then
                                .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                                blnOtherDo = True
                            End If
                            
                            '标记为修改
                            If blnOtherDo And InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                .TextMatrix(i, COL_EDIT) = 2
                                .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1) '修改后变为新开
                            End If
                        Else
                            Exit For
                        End If
                    Next
                End If
                If cbo执行科室.ListIndex <> -1 And cbo执行科室.Tag <> "" Then
                    .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow - 1, COL_执行科室ID)), "名称")
                End If
            ElseIf InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '中、西成药处理给药途径及一并给药的情况
                
                '执行性质
                If cbo执行性质.Tag <> "" Then
                    .TextMatrix(lngRow, COL_执行性质) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "自备药", 5, "不取药", 5, 4)
                    .TextMatrix(lngRow, COL_执行标记) = Decode(zlCommFun.GetNeedName(cbo执行性质.Text), "自取药", 1, "不取药", 2, 0)
                    If Val(.TextMatrix(lngRow, COL_执行性质)) = 5 Then
                        .TextMatrix(lngRow, COL_执行科室ID) = 0
                    ElseIf Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then
                        '恢复缺省药房,缺省与前面的成药相同
                        strTmp = Get可用药房IDs(.TextMatrix(lngRow, COL_类别), Val(.TextMatrix(lngRow, COL_诊疗项目ID)), Val(.TextMatrix(lngRow, COL_收费细目ID)), mlng病人科室id, 2)
                        For i = lngRow - 1 To .FixedRows Step -1
                            '西成药和中成药的药房可能不同,所以类别要相同
                            If .TextMatrix(i, COL_类别) = .TextMatrix(lngRow, COL_类别) And Val(.TextMatrix(i, COL_执行科室ID)) <> 0 Then
                                If InStr("," & strTmp & ",", "," & Val(.TextMatrix(i, COL_执行科室ID)) & ",") > 0 Then
                                    .TextMatrix(lngRow, COL_执行科室ID) = Val(.TextMatrix(i, COL_执行科室ID))
                                    Exit For
                                End If
                            End If
                        Next
                        If Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then
                            .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, .TextMatrix(lngRow, COL_类别), _
                                Val(.TextMatrix(lngRow, COL_诊疗项目ID)), Val(.TextMatrix(lngRow, COL_收费细目ID)), 4, mlng病人科室id, 0, cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                        End If
                    End If
                    .TextMatrix(lngRow, COL_医嘱执行性质) = IIF("正常" = zlCommFun.GetNeedName(cbo执行性质.Text), "", zlCommFun.GetNeedName(cbo执行性质.Text))
                    .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称")
                    If .TextMatrix(lngRow, COL_执行科室) = "" Then .TextMatrix(lngRow, COL_执行科室) = "-"
                    cbo执行科室.Tag = "1" '标明执行科室一并给药的要同步变
                    blnReInRow = True '界面执行科室编辑性变化
                End If
                
                '给药途径本身及其它相关数据同步更改
                lng执行科室ID = 0
                If cbo附加执行.ListIndex <> -1 Then
                    lng执行科室ID = cbo附加执行.ItemData(cbo附加执行.ListIndex)
                End If
                strTmp = ""
                If Trim(cbo滴速.Text) <> "" Then
                    strTmp = cbo滴速.Text & lbl滴速单位.Caption
                End If
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then
                    .TextMatrix(lngRow, COL_用法) = txt用法.Text & strTmp
                                        
                    If CheckExecDeptValidate(lng执行科室ID, mlng病人科室id, IIF(mlng病人性质 = 1, 1, 2), Val(cmd用法.Tag)) = False Then
                        lng执行科室ID = 0
                    End If
                    
                    Call AdviceSet给药途径(lngRow, Val(cmd用法.Tag), zlCommFun.GetNeedName(cbo执行性质.Text), lng执行科室ID, strTmp)
                ElseIf blnCurDo Then 'cbo执行性质.Tag <> "" Then
                    '如果执行性质更改了,需要强行修改对应的给药途径的执行性质和执行科室
                    lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    Call AdviceSet给药途径(lngRow, Val(.TextMatrix(lngTmp, COL_诊疗项目ID)), zlCommFun.GetNeedName(cbo执行性质.Text), lng执行科室ID, strTmp)
                End If
                If cbo执行科室.ListIndex <> -1 And cbo执行科室.Tag <> "" Then
                    .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称")
                    If .TextMatrix(lngRow, COL_执行科室) = "" Then .TextMatrix(lngRow, COL_执行科室) = "-"
                End If
                '一并给药:不处理给药途径,前面已单独设置
                If blnCurDo Then
                    lngBeginRow = .FindRow(.TextMatrix(lngRow, COL_相关ID), , COL_相关ID)
                    If cbo执行科室.Tag <> "" Then
                        For i = lngBeginRow To .Rows - 1
                            If .TextMatrix(i, COL_相关ID) = "" Then
                                lngTmp = i: Exit For
                            End If
                        Next
                    End If
                    For i = lngBeginRow To .Rows - 1
                        If i <> lngRow And .RowData(i) <> 0 _
                            And Val(.TextMatrix(i, COL_婴儿)) = Val(.TextMatrix(lngRow, COL_婴儿)) Then '可能现在中间有空行
                            If Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                                If msk开始时间.Tag <> "" Then
                                    .TextMatrix(i, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                                    .Cell(flexcpData, i, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
                                    
                                    .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                    .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                    
                                    .TextMatrix(i, COL_标志) = .TextMatrix(lngRow, COL_标志)
                                    
                                    blnOtherDo = True
                                End If
                                If cbo医生.Tag <> "" Then
                                    .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                                    .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                                    blnOtherDo = True
                                End If
                                If txt开嘱时间.Tag <> "" Then
                                    .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                    .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                    blnOtherDo = True
                                End If
                                If txt用法.Tag <> "" Then
                                    .TextMatrix(i, COL_用法) = .TextMatrix(lngRow, COL_用法)
                                    blnOtherDo = True
                                End If
                                If txt频率.Tag <> "" Then
                                    .TextMatrix(i, COL_频率性质) = .TextMatrix(lngRow, COL_频率性质) '需要同步设置,因为临嘱可能在一次性之间切换
                                    .TextMatrix(i, COL_频率) = .TextMatrix(lngRow, COL_频率)
                                    .TextMatrix(i, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
                                    .TextMatrix(i, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
                                    .TextMatrix(i, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
                                    blnOtherDo = True
                                End If
                                    
                                '将滴速补填到一并给药的其他行中
                                If cbo滴速.Tag <> "" Then
                                    .TextMatrix(i, COL_用法) = txt用法.Text & strTmp
                                    blnOtherDo = True
                                End If
                                
                                '一并给药的,天数相同变化,总量重新计算
                                If txt天数.Tag <> "" And cbo期效.ListIndex = 1 Then
                                    .TextMatrix(i, COL_天数) = .TextMatrix(lngRow, COL_天数)
                                    If .TextMatrix(i, COL_频率) <> "" And Val(.TextMatrix(i, COL_频率性质)) <> 1 _
                                        And Val(.TextMatrix(i, COL_单量)) <> 0 _
                                        And Val(.TextMatrix(i, COL_剂量系数)) <> 0 _
                                        And Val(.TextMatrix(i, COL_住院包装)) <> 0 Then
                                        
                                        .TextMatrix(i, COL_总量) = FormatEx(Calc缺省药品总量( _
                                            Val(.TextMatrix(i, COL_单量)), Val(.TextMatrix(i, COL_天数)), _
                                            Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), _
                                            .TextMatrix(i, COL_间隔单位), .TextMatrix(i, COL_执行时间), _
                                            Val(.TextMatrix(i, COL_剂量系数)), Val(.TextMatrix(i, COL_住院包装)), _
                                            Val(.TextMatrix(i, COL_可否分零)), _
                                            Val(.TextMatrix(i, COL_首次用量))), 5)
                                        If InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") = 0 Then
                                            .TextMatrix(i, COL_总量) = IntEx(Val(.TextMatrix(i, COL_总量)))
                                        ElseIf Val(.TextMatrix(i, COL_可否分零)) <> 0 Then
                                            .TextMatrix(i, COL_总量) = IntEx(Val(.TextMatrix(i, COL_总量)))
                                        End If
                                    End If
                                    
                                    '重新检查处方限量，长嘱不需要数天，此处当照临嘱方式处理
                                    .TextMatrix(i, COL_是否超量) = ""
                                    If Val(.TextMatrix(i, COL_处方限量)) <> 0 Then
                                        dbl总量 = Val(.TextMatrix(i, COL_总量)) * Val(.TextMatrix(i, COL_住院包装)) * Val(.TextMatrix(i, COL_剂量系数))
                                        If dbl总量 > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
                                    End If
                                    If .TextMatrix(i, COL_是否超量) = "" Then .TextMatrix(i, COL_超量说明) = ""
                                    
                                    blnOtherDo = True
                                End If
                                      
                                If cbo执行时间.Tag <> "" Or txt首日时间.Tag <> "" Then
                                    .TextMatrix(i, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
                                    blnOtherDo = True
                                End If
                
                                If txt终止时间.Tag <> "" Then
                                    .TextMatrix(i, COL_终止时间) = .TextMatrix(lngRow, COL_终止时间)
                                    .Cell(flexcpData, i, COL_终止时间) = .Cell(flexcpData, lngRow, COL_终止时间)
                                    blnOtherDo = True
                                End If
                                
                                '执行性质、执行标记：离院带药、自取药在一并给药中需一致，其它可单独设置
                                If cbo执行性质.Tag <> "" And (zlCommFun.GetNeedName(cbo执行性质.Text) = "离院带药" Or zlCommFun.GetNeedName(cbo执行性质.Text) = "自取药") Then
                                    .TextMatrix(i, COL_执行性质) = .TextMatrix(lngRow, COL_执行性质)
                                    .TextMatrix(i, COL_执行标记) = .TextMatrix(lngRow, COL_执行标记)
                                    '由自备药转过来时需要重新设置执行科室
                                    If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                                        .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                                        .TextMatrix(i, COL_执行科室) = .TextMatrix(lngRow, COL_执行科室)
                                    End If
                                    .TextMatrix(i, COL_医嘱执行性质) = .TextMatrix(lngRow, COL_医嘱执行性质)
                                    blnOtherDo = True
                                End If
                                
                                '执行科室:执行科室(药房)可以不同,除非是配制中心
                                If cbo执行科室.Tag <> "" Then
                                    '输入行改为自备药，或某行为自备药的情况不管它
                                    If Not (Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 And Val(.TextMatrix(lngRow, COL_执行性质)) = 5) _
                                        And Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                                        If .TextMatrix(lngTmp, COL_类别) = "E" And .TextMatrix(lngTmp, COL_操作类型) = "2" And .TextMatrix(lngTmp, COL_执行分类) = "1" Then
                                            If Sys.DeptHaveProperty(Val(.TextMatrix(lngRow, COL_执行科室ID)), "配制中心") Then
                                                '输入行药品由普通药房或其他配制中心改为新的配制中心,则该组药都改为该配制中心
                                                .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                                                .TextMatrix(i, COL_执行科室) = .TextMatrix(lngRow, COL_执行科室)
                                                blnOtherDo = True
                                            ElseIf Sys.DeptHaveProperty(Val(.TextMatrix(i, COL_执行科室ID)), "配制中心") Then
                                                '输入行药品由配制中心改成普通药房,则该组药都改为该普通药房
                                                .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                                                .TextMatrix(i, COL_执行科室) = .TextMatrix(lngRow, COL_执行科室)
                                                blnOtherDo = True
                                            End If
                                        End If
                                    End If
                                End If
                                
                                '补录时不允许在一并给药之中插入药品
                                If chk紧急.Tag <> "" Then
                                    .TextMatrix(i, COL_标志) = .TextMatrix(lngRow, COL_标志)
                                    .TextMatrix(i, COL_审核状态) = .TextMatrix(lngRow, COL_审核状态)
                                    blnOtherDo = True
                                End If
                                
                                '开嘱时间
                                If .TextMatrix(i, COL_开嘱时间) <> .TextMatrix(lngRow, COL_开嘱时间) Then
                                    .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                    .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                    blnOtherDo = True
                                End If
                                
                                '开嘱医生
                                If .TextMatrix(i, COL_开嘱医生) <> .TextMatrix(lngRow, COL_开嘱医生) Then
                                    .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                                    blnOtherDo = True
                                End If
                                
                                '开嘱科室ID
                                If .TextMatrix(i, COL_开嘱科室ID) <> .TextMatrix(lngRow, COL_开嘱科室ID) Then
                                    .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                                    blnOtherDo = True
                                End If
                                
                                '标记为修改
                                If blnOtherDo And InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                    .TextMatrix(i, COL_EDIT) = 2
                                    .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1) '修改后变为新开
                                End If
                            Else
                                Exit For
                            End If
                        End If
                    Next
                End If
            ElseIf .TextMatrix(lngRow, COL_类别) = "K" Then
                '输血医嘱的处理(前面已处理输血时间(安排时间)的修改)
                lng执行科室ID = 0
                If cbo附加执行.ListIndex <> -1 Then
                    lng执行科室ID = cbo附加执行.ItemData(cbo附加执行.ListIndex)
                End If
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then
                    .TextMatrix(lngRow, COL_用法) = txt用法.Text
                    Call AdviceSet输血途径(lngRow, Val(cmd用法.Tag), lng执行科室ID)
                ElseIf blnCurDo Then
                    lngTmp = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_相关ID)
                    If lngTmp <> -1 Then
                        Call AdviceSet输血途径(lngRow, Val(.TextMatrix(lngTmp, COL_诊疗项目ID)), lng执行科室ID)
                    End If
                End If
                If cbo执行科室.ListIndex <> -1 And cbo执行科室.Tag <> "" Then
                    .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称")
                End If
            ElseIf InStr(",D,F,", .TextMatrix(lngRow, COL_类别)) > 0 And blnCurDo Then
                '检查组合项目行或手术附加行
                lngBeginRow = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_相关ID)
                If lngBeginRow <> -1 Then
                    For i = lngBeginRow To .Rows - 1
                        If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                            If txt单量.Tag <> "" Then
                                .TextMatrix(i, COL_单量) = .TextMatrix(lngRow, COL_单量)
                                blnOtherDo = True
                            End If
                            If txt总量.Tag <> "" Then
                                .TextMatrix(i, COL_总量) = .TextMatrix(lngRow, COL_总量)
                                blnOtherDo = True
                            End If
                            
                            If cbo执行时间.Tag <> "" Or txt首日时间.Tag <> "" Then
                                .TextMatrix(i, COL_执行时间) = .TextMatrix(lngRow, COL_执行时间)
                                blnOtherDo = True
                            End If
                            If txt频率.Tag <> "" Then
                                .TextMatrix(i, COL_频率性质) = .TextMatrix(lngRow, COL_频率性质)
                                .TextMatrix(i, COL_频率) = .TextMatrix(lngRow, COL_频率)
                                .TextMatrix(i, COL_频率次数) = .TextMatrix(lngRow, COL_频率次数)
                                .TextMatrix(i, COL_频率间隔) = .TextMatrix(lngRow, COL_频率间隔)
                                .TextMatrix(i, COL_间隔单位) = .TextMatrix(lngRow, COL_间隔单位)
                                blnOtherDo = True
                            End If
                            If cbo执行科室.Tag <> "" Then
                                If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) > 0 Then
                                    .TextMatrix(i, COL_执行科室ID) = 0
                                ElseIf .TextMatrix(i, COL_类别) <> "G" Then '手术麻醉的执行科室为单独
                                    .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow, COL_执行科室ID)
                                End If
                                blnOtherDo = True
                            End If
                            If msk开始时间.Tag <> "" Then
                                .TextMatrix(i, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                                .Cell(flexcpData, i, COL_开始时间) = .Cell(flexcpData, lngRow, COL_开始时间)
                                
                                .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                
                                .TextMatrix(i, COL_标志) = .TextMatrix(lngRow, COL_标志)
                                
                                blnOtherDo = True
                            End If
                            If txt安排时间.Tag <> "" Then
                                .TextMatrix(i, COL_手术时间) = .TextMatrix(lngRow, COL_手术时间)
                                blnOtherDo = True
                            End If
                            If txt终止时间.Tag <> "" Then
                                .TextMatrix(i, COL_终止时间) = .TextMatrix(lngRow, COL_终止时间)
                                .Cell(flexcpData, i, COL_终止时间) = .Cell(flexcpData, lngRow, COL_终止时间)
                                blnOtherDo = True
                            End If
                            If cbo医生.Tag <> "" Then
                                .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                                .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                                blnOtherDo = True
                            End If
                            If txt开嘱时间.Tag <> "" Then
                                .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                blnOtherDo = True
                            End If
                            If chk紧急.Tag <> "" Then
                                .TextMatrix(i, COL_标志) = .TextMatrix(lngRow, COL_标志)
                                blnOtherDo = True
                            End If
                            
                            '开嘱时间
                            If .TextMatrix(i, COL_开嘱时间) <> .TextMatrix(lngRow, COL_开嘱时间) Then
                                .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                                .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                                blnOtherDo = True
                            End If
                            
                            '开嘱医生
                            If .TextMatrix(i, COL_开嘱医生) <> .TextMatrix(lngRow, COL_开嘱医生) Then
                                .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                                blnOtherDo = True
                            End If
                            
                            '开嘱科室ID
                            If .TextMatrix(i, COL_开嘱科室ID) <> .TextMatrix(lngRow, COL_开嘱科室ID) Then
                                .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                                blnOtherDo = True
                            End If
                            
                            '手术情况
                            If .TextMatrix(i, COL_手术情况) <> .TextMatrix(lngRow, COL_手术情况) Then
                                .TextMatrix(i, COL_手术情况) = .TextMatrix(lngRow, COL_手术情况)
                                blnOtherDo = True
                            End If
                            
                            '审核状态
                            If .TextMatrix(i, COL_审核状态) <> .TextMatrix(lngRow, COL_审核状态) Then
                                .TextMatrix(i, COL_审核状态) = .TextMatrix(lngRow, COL_审核状态)
                                blnOtherDo = True
                            End If
                            
                            '标记为修改
                            If blnOtherDo And InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                .TextMatrix(i, COL_EDIT) = 2
                                .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1) '修改后变为新开
                            End If
                        Else
                            Exit For
                        End If
                    Next
                End If
                If cbo执行科室.ListIndex <> -1 And cbo执行科室.Tag <> "" Then
                    .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称")
                End If
            ElseIf .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "1" And .TextMatrix(lngRow, COL_执行分类) = "5" Then
                If cbo附加执行.Tag <> "" Then
                    lng执行科室ID = 0
                    If cbo附加执行.ListIndex <> -1 Then
                        lng执行科室ID = cbo附加执行.ItemData(cbo附加执行.ListIndex)
                    End If
                    .TextMatrix(lngRow, COL_用药理由) = lng执行科室ID
                End If
            End If
        End If
        
        '配方和其他诊疗项目都可能存在超期
        If txt超量说明.Enabled And txt超量说明.Tag <> "" Then
            .TextMatrix(lngRow, COL_超量说明) = txt超量说明.Text
            blnCurDo = True
        End If
        
        '---------------
        If blnCurDo Then '标记为修改:0-原始的,1-新增的,2-修改了内容,3-修改了序号
            If InStr(",0,2,3,", .TextMatrix(lngRow, COL_EDIT)) > 0 Then
                '审核未通过的是一组药品,则需要改变组内其他行的审核状态为未审核或无需审核
                '启用药品分级管理之后修改他人的医嘱，重新设置审核状态，输血医嘱审核状态已经在前面设置了。
                If Val(.TextMatrix(lngRow, COL_审核状态)) <> 2 And .TextMatrix(lngRow, COL_类别) <> "K" Then
                    Call GetRowScope(lngRow, lngBeginRow, lngEndRow)
                    For i = lngBeginRow To lngEndRow
                        '如果是紧急医嘱，则无须审核
                        If (gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And (.TextMatrix(i, COL_标志) <> 1 Or .TextMatrix(i, COL_期效) = "长嘱")) Or (gbln手术分级管理 And Val(.TextMatrix(lngRow, COL_审核状态)) = 3) Then
                            .TextMatrix(i, COL_审核状态) = 1
                        Else
                            .TextMatrix(i, COL_审核状态) = ""
                        End If
                        
                        Call SetRow标志图标(i, 2)
                    Next
                End If
                .TextMatrix(lngRow, COL_EDIT) = 2
                .TextMatrix(lngRow, COL_状态) = IIF(Val(.TextMatrix(lngRow, COL_状态)) = -1, -1, 1) '修改后变为新开
                Call ReSetColor(lngRow)
            End If
            mblnNoSave = True '标记为未保存
        End If
                
        '更新医嘱内容
        If AdviceTextChange(lngRow) Then
            .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
            txt医嘱内容.Text = .TextMatrix(lngRow, col_医嘱内容)
        End If
    End With
        
    '清除编辑标志
    Call ClearItemTag
    
    '某些情况下需要重新设置卡片的项目编辑性(如修改了执行性质时)
    If blnReInRow Then
        If blnExecUpdate Then
            zlControl.FormLock Me.hwnd
            Call GetRowScope(lngRow, lngBeginRow, lngEndRow)
            For i = lngBeginRow To lngEndRow
                '如果改变了执行性质或者执行科室，同步一并给药的其他的执行科室（输液药品）
                If InStr(",5,6,", vsAdvice.TextMatrix(i, COL_类别)) > 0 And vsAdvice.Row <> i Then
                    vsAdvice.Row = i '调用 vsAdvice_AfterRowColChange 事件(自动触发)
                End If
            Next
            If vsAdvice.Row <> lngRow Then vsAdvice.Row = lngRow
            zlControl.FormLock 0
        End If
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
        If vsAdvice.TextMatrix(lngRow, COL_是否超量) = "" Then vsAdvice.TextMatrix(lngRow, COL_超量说明) = ""
    ElseIf bln超量说明 Then
        '其中 txt总量 txt单量 txt首次用量 的值生变化都会影响超量说明的填写
        SetItemEditable , , , , , , , , , , , , , , , IIF(vsAdvice.TextMatrix(lngRow, COL_是否超量) = "1", 1, -1)
        If vsAdvice.TextMatrix(lngRow, COL_是否超量) = "" Then vsAdvice.TextMatrix(lngRow, COL_超量说明) = ""
    End If
End Sub

Private Sub ReSetColor(ByVal lngRow As Long)
'功能：重新设置指定行的颜色
'说明：因为疑问的医嘱编辑后变成新开
    Dim lngBegin As Long, lngEnd As Long, i As Long
    
    With vsAdvice
        '一并给药范围
        lngBegin = lngRow: lngEnd = lngRow
        If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            If RowIn一并给药(lngRow) Then
                Call Get一并给药范围(Val(.TextMatrix(lngRow, COL_相关ID)), lngBegin, lngEnd)
            End If
        End If
        '恢复成正常色
        For i = lngBegin To lngEnd
            .Cell(flexcpForeColor, i, .FixedCols, i, COL_校对护士) = .ForeColor
            '毒麻精的颜色标识
            If InStr(",麻醉药,毒性药,精神药,精神I类,精神II类,", .TextMatrix(i, COL_毒理分类)) > 0 _
                And .TextMatrix(i, COL_毒理分类) <> "" Then
                .Cell(flexcpFontBold, i, col_医嘱内容) = True
            End If
        Next
        .ForeColorSel = .Cell(flexcpForeColor, lngRow, COL_开始时间)
    End With
    
    Call ShowOrHideQuestion
    Call Form_Resize
End Sub

Private Sub AdviceSet一并给药(ByVal lngBegin As Long, ByVal lngEnd As Long)
'功能：将选择范围内的药品设置为一并给药
'参数：起止行号,中间不包含空行,不包含最后一行药品的给药途径行
'说明：以第一行药品的给药途径为准,但位置放在最后一行药品之后
    Dim varTmp1 As Variant, varTmp2 As Variant
    Dim lngRow1 As Long, lngRow2 As Long
    Dim lng相关ID As Long, i As Long
    Dim strStart As String, curDate As Date
    Dim lng配制中心 As Long
    Dim str配制中心 As String
    Dim bln算总量 As Boolean
    Dim str药房IDs As String
    
    With vsAdvice
        lngRow1 = .FindRow(CLng(.TextMatrix(lngBegin, COL_相关ID)), lngBegin + 1) '第一给药途径行
        lngRow2 = .FindRow(CLng(.TextMatrix(lngEnd, COL_相关ID)), lngEnd + 1) '最后给药途径行
        
        '启用了天数控制才反算（71152）
        If .TextMatrix(lngRow1, COL_期效) = "临嘱" And mbln天数 Then
                bln算总量 = True
        End If
        
        '删除给药途径行之前记录执行性质,以便后面作判断
        For i = lngRow2 To lngRow1 Step -1
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex And .RowHidden(i) Then
                .Cell(flexcpData, i - 1, COL_执行性质) = Val(.TextMatrix(i, COL_执行性质))
            End If
        Next
        
        '复制第一行的给药途径到最后一行的给药途径
        For i = .FixedCols To .Cols - 1
            Select Case i
            Case COL_EDIT, COL_相关ID, COL_序号, COL_状态, COL_路径项目ID, COL_路径执行方式, COL_路径执行ID, COL_路径项目分类
            
            Case Else
                .TextMatrix(lngRow2, i) = .TextMatrix(lngRow1, i)
            End Select
        Next
        .Cell(flexcpData, lngRow2, COL_开始时间) = .TextMatrix(lngRow2, COL_开始时间)

        '编辑标志：0-原始的,1-新增的,2-修改了内容,3-修改了序号
        If InStr(",0,3,", .TextMatrix(lngRow2, COL_EDIT)) > 0 Then
            .TextMatrix(lngRow2, COL_EDIT) = 2 '标记为已修改
            .TextMatrix(lngRow2, COL_状态) = IIF(Val(.TextMatrix(lngRow2, COL_状态)) = -1, -1, 1) '修改后变为新开
        End If
        lng相关ID = .RowData(lngRow2)
        
        varTmp1 = mblnRowChange: varTmp2 = .Redraw
        mblnRowChange = False: .Redraw = flexRDNone
        
        '删除除最后一行给药途径外的其它给药途径
        For i = lngEnd To lngBegin Step -1
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                If .RowHidden(i) Then
                    Call DeleteRow(i)
                Else
                    .TextMatrix(i, COL_相关ID) = lng相关ID
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2 '标记为已修改
                        .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1) '修改后变为新开
                    End If
                End If
            End If
        Next
        
        '行号已变更
        lngRow1 = lngBegin '开始一并给药行
        curDate = zlDatabase.Currentdate
        
        '检查医生是否变更
        If mint场合 <> 1 And GetAuditName(.TextMatrix(lngRow1, COL_开嘱医生)) <> UserInfo.姓名 Then
            '更新相关信息:前面已标记为修改,且手工操作完成时已有进入界面刷新
            .TextMatrix(lngRow1, COL_开嘱医生) = UserInfo.姓名
            .TextMatrix(lngRow1, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            If Val(.TextMatrix(lngRow1, COL_标志)) <> 2 Then '不是补录医嘱时
                .TextMatrix(lngRow1, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow1, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
            End If
        End If
        
        '处理一并给药其他行的相同信息
        For i = lngRow1 + 1 To .Rows - 1
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                If Val(.TextMatrix(i, COL_相关ID)) = lng相关ID Then
                    lngRow2 = i '记录新的结束行号
                    
                    '临床路径相关的信息
                     If .ColHidden(COL_选择) = False Then
                        .TextMatrix(i, COL_选择) = .TextMatrix(lngRow1, COL_选择)
                        .Cell(flexcpChecked, i, COL_选择) = .Cell(flexcpChecked, lngRow1, COL_选择)
                        .Cell(flexcpPictureAlignment, i, COL_选择) = .Cell(flexcpPictureAlignment, lngRow1, COL_选择)
                        .Cell(flexcpBackColor, i, COL_选择) = .Cell(flexcpBackColor, lngRow1, COL_选择)
                    End If
                    
                    
                    '一并给药的部分信息相同
                    .TextMatrix(i, COL_开始时间) = .TextMatrix(lngRow1, COL_开始时间)
                    .Cell(flexcpData, i, COL_开始时间) = .Cell(flexcpData, lngRow1, COL_开始时间)
                    
                    .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow1, COL_开嘱医生)
                    .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow1, COL_开嘱科室ID)
                    
                    .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow1, COL_开嘱时间) '一并给药的开嘱时间相同
                    .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow1, COL_开嘱时间)
                    
                    .TextMatrix(i, COL_天数) = .TextMatrix(lngRow1, COL_天数)
                    .TextMatrix(i, COL_用法) = .TextMatrix(lngRow1, COL_用法)
                    
                    .TextMatrix(i, COL_频率性质) = .TextMatrix(lngRow1, COL_频率性质)
                    .TextMatrix(i, COL_频率) = .TextMatrix(lngRow1, COL_频率)
                    .TextMatrix(i, COL_频率次数) = .TextMatrix(lngRow1, COL_频率次数)
                    .TextMatrix(i, COL_频率间隔) = .TextMatrix(lngRow1, COL_频率间隔)
                    .TextMatrix(i, COL_间隔单位) = .TextMatrix(lngRow1, COL_间隔单位)
                    .TextMatrix(i, COL_执行时间) = .TextMatrix(lngRow1, COL_执行时间)
                    
                    .TextMatrix(i, COL_终止时间) = .TextMatrix(lngRow1, COL_终止时间)
                    .Cell(flexcpData, i, COL_终止时间) = .Cell(flexcpData, lngRow1, COL_终止时间)
                    
                    '重新计算总量，只有临嘱才计算总量
                    If bln算总量 Then
                        vsAdvice.TextMatrix(i, COL_总量) = ReSetTotalamount(False, vsAdvice.TextMatrix(i, COL_总量), vsAdvice.TextMatrix(i, COL_天数), i)
                    End If
                    .TextMatrix(i, COL_标志) = .TextMatrix(lngRow1, COL_标志)
                    Set .Cell(flexcpPicture, i, COL_F标志) = Nothing '在开始行显示
                    
                    '离院带药、自取药一组相同
                    If Val(.TextMatrix(lngRow1, COL_执行性质)) <> 5 And Val(.Cell(flexcpData, lngRow1, COL_执行性质)) = 5 Then
                        '第一行是离院带药,全部设置为离院带药
                        .TextMatrix(i, COL_执行标记) = .TextMatrix(lngRow1, COL_执行标记)
                        .TextMatrix(i, COL_执行性质) = .TextMatrix(lngRow1, COL_执行性质)
                        If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then '执行科室可以不同,没有时才缺省相同
                            .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow1, COL_执行科室ID)
                        End If
                    ElseIf Val(.TextMatrix(i, COL_执行性质)) <> 5 And Val(.Cell(flexcpData, i, COL_执行性质)) = 5 Then
                        '当前行是离院带药,则设置为与第一行相同
                        .TextMatrix(i, COL_执行标记) = .TextMatrix(lngRow1, COL_执行标记)
                        .TextMatrix(i, COL_执行性质) = .TextMatrix(lngRow1, COL_执行性质)
                        If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                            .TextMatrix(i, COL_执行科室ID) = .TextMatrix(lngRow1, COL_执行科室ID)
                        End If
                    Else
                        '否则保持不变
                    End If
                    
                    '标记为修改:0-原始的,1-新增的,2-修改了内容,3-修改了序号
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2
                        .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1) '修改后变为新开
                    End If
                Else
                    Exit For
                End If
            End If
        Next
        
        '检查这些药品中是否存在配制中心拿药的，以第一个为准
        For i = lngRow1 To .Rows - 1
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                If Val(.TextMatrix(i, COL_相关ID)) = lng相关ID Then
                    '自备药的情况不管它
                    If Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                        If Sys.DeptHaveProperty(Val(.TextMatrix(i, COL_执行科室ID)), "配制中心") Then
                            lng配制中心 = Val(.TextMatrix(i, COL_执行科室ID)): Exit For
                        End If
                    End If
                Else
                    Exit For
                End If
            End If
        Next
        '配制中心一组相同
        If lng配制中心 <> 0 Then
            str配制中心 = Sys.RowValue("部门表", lng配制中心, "名称")
            For i = lngRow1 To .Rows - 1
                If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                    If Val(.TextMatrix(i, COL_相关ID)) = lng相关ID Then
                        '自备药的情况不管它
                        If Not (Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) = 5) Then
                            str药房IDs = Get可用药房IDs(.TextMatrix(i, COL_类别), Val(.TextMatrix(i, COL_诊疗项目ID)), Val(.TextMatrix(i, COL_收费细目ID)), mlng病人科室id, 2)
                            If InStr("," & str药房IDs & ",", "," & lng配制中心 & ",") = 0 Then
                                MsgBox "一并给药的药品中，""" & .TextMatrix(i, col_医嘱内容) & """在""" & CStr(Sys.RowValue("部门表", lng配制中心, "名称")) & """中没有存储。", vbInformation, gstrSysName
                                .TextMatrix(i, COL_执行科室ID) = 0
                                .TextMatrix(i, COL_执行科室) = ""
                            Else
                                .TextMatrix(i, COL_执行科室ID) = lng配制中心
                                .TextMatrix(i, COL_执行科室) = str配制中心
                            End If
                            
                            '标记为修改:0-原始的,1-新增的,2-修改了内容,3-修改了序号
                            If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                .TextMatrix(i, COL_EDIT) = 2
                                .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1) '修改后变为新开
                            End If
                        End If
                    Else
                        Exit For
                    End If
                End If
            Next
        End If
        
        '开始执行时间处理(非补录新开的不能太早)
        If Val(.TextMatrix(lngRow1, COL_标志)) <> 2 Then
            strStart = ""
            For i = lngRow1 To lngRow2
                If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                    If Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                        If DateDiff("n", CDate(.Cell(flexcpData, i, COL_开始时间)), curDate) > gint补录间隔 _
                            Or mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                            strStart = GetDefaultTime(i, True): Exit For
                        End If
                    End If
                End If
            Next
            If strStart <> "" Then
                For i = lngRow1 To lngRow2 + 1
                    If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                        .Cell(flexcpData, i, COL_开始时间) = strStart
                        .TextMatrix(i, COL_开始时间) = Format(strStart, "yyyy-MM-dd HH:mm")
                    End If
                Next
            End If
        End If
        Call ReSet审核状态图标(lngBegin)
        Call SetTag一并给药(lngBegin)
        Call SetRow标志图标(lngBegin)
        mblnRowChange = varTmp1: .Redraw = varTmp2
    End With
    mblnNoSave = True '标记为未保存
End Sub

Private Sub AdviceSet单独给药(ByVal lngBegin As Long, ByVal lngEnd As Long)
'功能：取消一组药品的一并给药
'参数：起止行号,中间不包含空行,不包含最后一行药品的给药途径行
    Dim varTmp1 As Variant, varTmp2 As Variant
    Dim lng给药途径ID As Long, lng给药执行ID As Long, i As Long
    Dim int执行性质 As Integer, str执行性质 As String, str滴速 As String
    Dim lngRow As Long, curDate As Date, blnUpdate As Boolean
    Dim intIdx As Integer
    
    With vsAdvice
        varTmp1 = mblnRowChange: varTmp2 = .Redraw
        mblnRowChange = False: .Redraw = flexRDNone
        
        '一并给药途径
        lngRow = .FindRow(CLng(.TextMatrix(lngEnd, COL_相关ID)), lngEnd + 1)
        lng给药途径ID = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
        lng给药执行ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
        int执行性质 = Val(.TextMatrix(lngRow, COL_执行性质))
        str滴速 = .TextMatrix(lngRow, COL_医生嘱托)
                        
        '检查医生变更:以给药途径行为准变化
        If mint场合 <> 1 And GetAuditName(.TextMatrix(lngRow, COL_开嘱医生)) <> UserInfo.姓名 Then
            '更新相关信息:手工操作完成时有进入界面刷新
            .TextMatrix(lngRow, COL_开嘱医生) = UserInfo.姓名
            .TextMatrix(lngRow, COL_开嘱科室ID) = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            If Val(.TextMatrix(lngRow, COL_标志)) <> 2 Then '不是补录医嘱时
                curDate = zlDatabase.Currentdate
                .TextMatrix(lngRow, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
            End If
            
            If InStr(",0,3,", .TextMatrix(lngRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngRow, COL_EDIT) = 2 '标记为已修改
                .TextMatrix(lngRow, COL_状态) = IIF(Val(.TextMatrix(lngRow, COL_状态)) = -1, -1, 1) '修改后变为新开
            End If
            blnUpdate = True
        End If

        '显示紧急标志:每一行
        For i = lngBegin To lngEnd
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                '药品行相应变化
                If blnUpdate Then
                    .TextMatrix(i, COL_开嘱医生) = .TextMatrix(lngRow, COL_开嘱医生)
                    .TextMatrix(i, COL_开嘱科室ID) = .TextMatrix(lngRow, COL_开嘱科室ID)
                    If Val(.TextMatrix(i, COL_标志)) <> 2 Then '不是补录医嘱时
                        .TextMatrix(i, COL_开嘱时间) = .TextMatrix(lngRow, COL_开嘱时间)
                        .Cell(flexcpData, i, COL_开嘱时间) = .Cell(flexcpData, lngRow, COL_开嘱时间)
                    End If
                    
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2 '标记为已修改
                        .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1) '修改后变为新开
                    End If
                End If
                                
                If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And (.TextMatrix(i, COL_标志) <> "1" Or .TextMatrix(i, COL_期效) = "长嘱") Then
                    .TextMatrix(i, COL_审核状态) = 1
                Else
                    .TextMatrix(i, COL_审核状态) = ""
                End If
                Call SetRow标志图标(i, 2)
            End If
        Next
        
        For i = lngEnd - 1 To lngBegin Step -1 '必须反向
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                '设置给药途径行
                If Val(.TextMatrix(i, COL_执行性质)) = 5 And int执行性质 <> 5 Then
                    str执行性质 = "自备药"
                ElseIf Val(.TextMatrix(i, COL_执行性质)) <> 5 And int执行性质 = 5 Then
                    str执行性质 = "离院带药"
                Else
                    str执行性质 = ""
                End If
                .TextMatrix(i, COL_相关ID) = "" '必须清除作为标志
                .TextMatrix(i, COL_相关ID) = AdviceSet给药途径(i, lng给药途径ID, str执行性质, lng给药执行ID, str滴速)
                
                If Val(.TextMatrix(i, COL_执行科室ID)) = 0 And Val(.TextMatrix(i, COL_执行性质)) <> 5 Then
                    '如果执行科室为0，则恢复默认的科室
                    .TextMatrix(i, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, .TextMatrix(i, COL_类别), Val(.TextMatrix(i, COL_诊疗项目ID)), Val(.TextMatrix(i, COL_收费细目ID)), 4, mlng病人科室id, 0, IIF(.TextMatrix(i, COL_期效) = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                End If
                
                If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                    .TextMatrix(i, COL_EDIT) = 2 '标记为已修改
                    .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1) '修改后变为新开
                End If
            End If
        Next
        lngRow = lngEnd + (lngEnd - lngBegin)
        For i = lngBegin To lngRow Step 2
            .TextMatrix(i, COL_并) = ""
        Next
        mblnRowChange = varTmp1: .Redraw = varTmp2
        mblnNoSave = True '标记为未保存
    End With
End Sub

Private Sub ShowAdvice()
'功能：显示当前界面条件下的医嘱记录
'说明：1.根据程序编辑方式,相关的数据行是按序号严格排列在一在的。
'      2.这里不处理一并给药的边框及配方行高，状态颜色等格式内容,它们已在读取或编辑时设置
    Dim lngRow As Long, blnHide As Boolean, i As Long
    
    Screen.MousePointer = 11
    mblnRowChange = False
    vsAdvice.Redraw = flexRDNone
        
    '先删除无效行
    For i = vsAdvice.Rows - 1 To vsAdvice.FixedRows Step -1
        If vsAdvice.RowData(i) = 0 Then vsAdvice.RemoveItem i
    Next
    
    '根据当前期效,婴儿显示
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If Val(.TextMatrix(i, COL_婴儿)) = cbo婴儿.ListIndex Then
                blnHide = False
                '隐藏以下数据行：
                '1.成药的给药途径行
                '2.手术的附加手术及麻醉项目行
                '3.检查组合的部位行
                '4.中药配方的组成味中药及中药煎法行
                '5.(一并采集的)检验项目
                '6.输血项目的输血途径
                If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                    If Val(.TextMatrix(i - 1, COL_相关ID)) = .RowData(i) _
                        And InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                        blnHide = True
                    End If
                End If
                If InStr(",F,G,D,7,E,C,", .TextMatrix(i, COL_类别)) > 0 _
                    And Val(.TextMatrix(i, COL_相关ID)) <> 0 Then
                    blnHide = True
                End If
                                
                .RowHidden(i) = blnHide
                If Not blnHide And lngRow = 0 Then lngRow = i
                
                '计算诊疗单价:这里为加快速度,只读取新开的,其它的进入再读
                If Not .RowHidden(i) _
                    And InStr(",1,2,-1,", Val(.TextMatrix(i, COL_状态))) > 0 And .TextMatrix(i, COL_单价) = "" Then
                    .TextMatrix(i, COL_单价) = GetItemPrice(i)
                End If
            Else
                .RowHidden(i) = True
            End If
        Next
    End With
    
    '没有数据行,添加一行空
    If lngRow = 0 Then
        vsAdvice.AddItem ""
        lngRow = vsAdvice.Rows - 1
    End If
    
    vsAdvice.Row = lngRow
    If vsAdvice.RowData(lngRow) = 0 Then
        vsAdvice.Col = vsAdvice.FixedCols
    Else
        vsAdvice.Col = col_医嘱内容
    End If
    vsAdvice.Redraw = flexRDDirect
    mblnRowChange = True
    
    '显示当前行:进入时在FormLoad中处理,以加快速度
    If Me.Visible Then Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    
    Screen.MousePointer = 0
End Sub

Private Function MakePathAdivceRS() As ADODB.Recordset
    Set MakePathAdivceRS = New ADODB.Recordset
    
    MakePathAdivceRS.Fields.Append "行号", adBigInt
    MakePathAdivceRS.Fields.Append "路径项目ID", adBigInt
    MakePathAdivceRS.Fields.Append "原医嘱ID", adBigInt
    
    MakePathAdivceRS.Fields.Append "路径项目分类", adVarChar, 50, adFldIsNullable
    MakePathAdivceRS.Fields.Append "医嘱IDS", adLongVarWChar, 4000, adFldIsNullable
    MakePathAdivceRS.Fields.Append "开始时间", adVarChar, 20, adFldIsNullable
    MakePathAdivceRS.CursorLocation = adUseClient
    MakePathAdivceRS.LockType = adLockOptimistic
    MakePathAdivceRS.CursorType = adOpenStatic
    MakePathAdivceRS.Open
End Function

Private Sub GetPathAdvice(ByRef rsPathAdvice As ADODB.Recordset)
'功能：获取路径项目已生成的长嘱对应记录集
'      路径生成时，重新选择的长嘱，如果最近一次生成了医嘱的，本次不再生成，但要返回"路径项目ID与医嘱ID的对应"，以便生成“病人路径医嘱”
'      重新生成时,已经校对且未作废的医嘱,本次不再重复产生医嘱记录,但要返回"路径项目ID与医嘱ID的对应"，以便生成“病人路径医嘱”,
'        如果路径项目是可选择使用,且已经校对但未作废的医嘱在医嘱下达界面没有被勾选，那么"路径项目ID与医嘱ID的对应"再生成界面追加。
    Dim str诊疗项目IDs As String, strOld诊疗项目IDs As String, lng组ID As Long, lngBegin As Long, lngEnd As Long
    Dim lng路径项目ID As Long
    Dim rsTmp As ADODB.Recordset
    Dim i As Long, j As Long, k As Long
    Dim bytMode As Byte

    With vsAdvice
        lngEnd = 0: bytMode = Val(.Cell(flexcpChecked, i, COL_选择)) '2=未选择,1=选择,0=单元格不是flexcpChecked型 91635
        For i = .FixedRows To .Rows - 1
            If (bytMode = 1 Or bytMode = 0) And i > lngEnd And Not mrsLastAdvice Is Nothing Then
                lng路径项目ID = .TextMatrix(i, COL_路径项目ID)

                str诊疗项目IDs = ""
                Call GetRowScope(i, lngBegin, lngEnd)
                For j = lngBegin To lngEnd
                    str诊疗项目IDs = str诊疗项目IDs & "," & .TextMatrix(j, COL_诊疗项目ID)
                Next
                str诊疗项目IDs = Mid(str诊疗项目IDs, 2)

                mrsLastAdvice.Filter = "项目ID=" & lng路径项目ID    '其中可能有多组医嘱
                Set rsTmp = zlDatabase.CopyNewRec(mrsLastAdvice)
                lng组ID = 0
                For j = 1 To mrsLastAdvice.RecordCount
                    If lng组ID <> mrsLastAdvice!组ID Then
                        lng组ID = mrsLastAdvice!组ID
                        rsTmp.Filter = "项目ID=" & lng路径项目ID & " And 组ID=" & lng组ID

                        strOld诊疗项目IDs = ""
                        For k = 1 To rsTmp.RecordCount
                            strOld诊疗项目IDs = strOld诊疗项目IDs & "," & rsTmp!诊疗项目ID
                            rsTmp.MoveNext
                        Next
                        strOld诊疗项目IDs = Mid(strOld诊疗项目IDs, 2)

                        If str诊疗项目IDs = strOld诊疗项目IDs Then  '该组医嘱上一次生成过
                            rsPathAdvice.Filter = "路径项目ID=" & mrsLastAdvice!项目ID & " and 原医嘱ID=" & mrsLastAdvice!病人医嘱ID
                            '临床路径项目医嘱在创建时，没有做同一路径项目中，不能出现相同医嘱的限制处理。
                            '因而rsTmp记录集中可能存在两组诊疗项目IDs串一样的记录时且编辑界面选中了这两组时，会重复添加第一组项目ID和病人医嘱ID
                            If rsPathAdvice.RecordCount = 0 Then
                                rsTmp.Filter = "项目ID=" & lng路径项目ID & " And 组ID=" & lng组ID
                                For k = lngBegin To lngEnd
                                    rsPathAdvice.AddNew
                                    rsPathAdvice!行号 = k
                                    rsPathAdvice!路径项目ID = rsTmp!项目ID
                                    rsPathAdvice!原医嘱ID = rsTmp!病人医嘱ID
                                    rsPathAdvice.Update
                                    rsTmp.MoveNext    'rsTmp.RecordCount必定与lngEnd-lngBegin相等
                                Next
                                Exit For
                            End If
                        End If
                    End If
                    mrsLastAdvice.MoveNext
                Next
            End If
        Next
    End With
End Sub

Private Function SaveAdvice(ByVal blnTemp As Boolean) As Boolean
'功能：保存当前病人的医嘱记录
'参数：blnTemp=是否进行暂存
    Dim arrSQL As Variant, dbl总量 As Double
    Dim arrDelID() As String
    Dim arrAppend As Variant, i As Long, j As Long
    Dim blnDo As Boolean, blnRefreshed As Boolean
    Dim rsPathAdvice As ADODB.Recordset, rsTmp As ADODB.Recordset
    Dim rsPath As ADODB.Recordset
    Dim strAdivcePathOut As String, lng执行ID As Long, strAddDate As String, str路径项目分类 As String
    Dim DatAddDate As Date, dat日期 As Date
    Dim blnIsHaveOut As Boolean    '判断是否存在院外执行的药品
    Dim blnTrans As Boolean
    Dim str路径项目IDs As String    '中医修改了的配方的，且超出了允许修改配方的比例的项目，对应的变异原因：项目ID1|变异编码1,项目2|变异编码2・・・・
    Dim lng阶段Id As Long, lng天数 As Long
    Dim byt生成时间性质 As Byte, bytPass警示 As Byte
    Dim str类别 As String
    Dim blnChecked As Boolean
    
    Dim str医嘱IDs As String
    Dim strMsg As String
    Dim strPrintDel As String
    Dim arrPrintDel As Variant
    Dim str给药IDs As String
    Dim rsPass As ADODB.Recordset
    Dim rsCard As ADODB.Recordset
    Dim rsBlood As ADODB.Recordset, intBloodState As Integer
    Dim strTmp As String
    Dim varTmp As Variant
    Dim blnNoSave As Boolean
    
    Dim blnRis As Boolean 'RIS接口是否使用预约
    Dim strNewAdvice As String '新增和修改后的医嘱,格式 医嘱ID:诊疗项目ID,....
    Dim str本次变动 As String '本次删除和修改的医嘱，用于判断RIS预约的医嘱是否已经被预约，已经被预约的医嘱不能删
    Dim rs输血 As ADODB.Recordset '输血医嘱血库接口调用时的参数信息
    Dim bln血库 As Boolean '是否需要进行血库接口调用
    Dim strAdvices输血 As String
    Dim strErr As String
    Dim bln用血审核 As Boolean
    Dim blnNewDrug As Boolean   'T-存在新增或修改的药品医嘱
    
    On Error GoTo errH
    If HaveRIS And gbln启用影像信息系统预约 Then
        blnRis = mbytUseType = 0 And mint场合 <> 1
    ElseIf gbln启用影像信息系统接口 = True And gbln启用影像信息系统预约 = True Then
        MsgBox "RIS接口创建失败，不能继续当前操作。可能是接口文件安装或注册不正常，请与系统管理员联系。", vbInformation, gstrSysName
        Exit Function
    End If
    
    Call MakeRealID
    
    'Pass自动用药审查
    If mblnPass And blnTemp = False And mbytUseType <> 3 Then
        blnNewDrug = IsNewDrug()
        If blnNewDrug Then
            'And mint场合 <> 1 Then
            If Not gobjPass.zlPassAdviceSave(mobjPassMap, mblnNoSave, rsPass) Then Exit Function
            '填写禁忌药品说明
            With vsAdvice
                If Not rsPass Is Nothing Then
                    For i = .FixedRows To .Rows - 1
                        If .RowData(i) <> 0 Then
                            rsPass.Filter = "医嘱ID=" & CLng(.RowData(i) & "") & " And 是否禁忌=1"
                            If rsPass.RecordCount = 1 Then
                                .TextMatrix(i, COL_禁忌药品说明) = rsPass!禁忌药品说明
                                .Cell(flexcpData, i, COL_序号) = 1
                            End If
                        End If
                    Next
                End If
            End With
        End If
    End If
    
    '调用外挂接口
    If CreatePlugInOK(p住院医嘱下达, mint场合) Then
        If zlPluginAdviceSave = False Then Exit Function
    End If

    Screen.MousePointer = 11
    If gbln血库系统 Then bln血库 = InitObjBlood()
    Set rs输血 = New ADODB.Recordset
    With rs输血
        .Fields.Append "医嘱ID", adBigInt
        .Fields.Append "类型", adInteger '0－新开，1－修改，2－删除
        .Fields.Append "状态", adInteger '0-调用血库接口,1-不掉用血库接口(用血医嘱审核)
        .CursorLocation = adUseClient
        .LockType = adLockOptimistic
        .CursorType = adOpenStatic
        .Open
    End With
    If mstrDel输血 <> "" Then
        arrDelID = Split(mstrDel输血, ",")
        For i = 0 To UBound(arrDelID)
            If Val(arrDelID(i)) <> 0 Then
                Call rs输血.AddNew(Array("医嘱ID", "类型"), Array(Val(arrDelID(i)), 2))
            End If
        Next
    End If
    '路径医嘱：路径项目执行方式为必须生成的，需要添加变异原因才容许删除
    If mstrDelIDs <> "" Then
        mstrDelIDs = Mid(mstrDelIDs, 2)
        Call CheckDelAdivceOfPathItem(mstrDelIDs)
    End If
    
    If mbytUseType = 3 Then
        '如果是医嘱调序医嘱打印单独判断
        strPrintDel = CheckPrintAfter调序(strMsg)
        If strMsg <> "" Then
            If MsgBox("您调整的医嘱或之后的医嘱已经打印，需清除重打。" & vbCrLf & strMsg & vbCrLf & "是否继续？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                Screen.MousePointer = 0
                Exit Function
            End If
        End If
    Else
        '医嘱打印的判断
        strPrintDel = CheckAdvicePrint(mstrDelIDs, strMsg)
        If strMsg <> "" Then
            If MsgBox("您调整的医嘱或之后的医嘱已经打印，需清除重打。" & vbCrLf & strMsg & vbCrLf & "是否继续？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                Screen.MousePointer = 0
                Exit Function
            End If
        End If
    End If
    
    '生成SQL
    arrSQL = Array()
    '删除了的记录
    If mbytUseType = 2 And mstrAdivceOfPath <> "" Then
        mstrAdivceOfPath = ""
        gcnOracle.RollbackTrans    '之前插入后没有提交
    Else
        arrDelID = Split(mstrDelIDs, ",")
        For i = 0 To UBound(arrDelID)
            If Val(arrDelID(i)) <> 0 Then
                ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_Delete(" & Val(arrDelID(i)) & ")"
                If blnRis Then str本次变动 = str本次变动 & "," & Val(arrDelID(i))
            End If
        Next
    End If
    DatAddDate = zlDatabase.Currentdate

    '获取路径项目已生成的长嘱对应记录集
    If mbytUseType = 1 Then
        Set rsPathAdvice = MakePathAdivceRS
        Call GetPathAdvice(rsPathAdvice)
    End If

    '路径中的病人，新开或修改医嘱
    If mbytUseType = 0 And mlng路径状态 = 1 And Not blnTemp Then
        Set rsPath = GetPatiPathInfo(mlng病人ID, mlng主页ID, str路径项目分类)
        Set rsPathAdvice = MakePathAdivceRS
        strAddDate = "To_Date('" & Format(DatAddDate, "yyyy-MM-dd HH:mm:ss") & "','YYYY-MM-DD HH24:MI:SS')"
    End If


    '编辑标志：0-原始的,1-新增的,2-修改了内容,3-修改了序号
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If .RowData(i) <> 0 And (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2)) Then    '所有医嘱记录
                '检验采集医嘱标本部位的处理
                If .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_标本部位) = "" Then
                    If RowIn检验行(i) Then .TextMatrix(i, COL_标本部位) = .TextMatrix(i - 1, COL_标本部位)
                End If
                
                '总量转换
                dbl总量 = 0
                If InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                    If Val(.TextMatrix(i, COL_总量)) <> 0 Then
                        If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                            '成药转换成零售单位
                            dbl总量 = Format(Val(.TextMatrix(i, COL_总量)) * Val(.TextMatrix(i, COL_住院包装)), "0.00000")
                        Else
                            '中药配方付数或非药临嘱总量,不转换
                            dbl总量 = Val(.TextMatrix(i, COL_总量))
                        End If
                    End If
                End If
                
                If .TextMatrix(i, COL_类别) = "K" And bln血库 Then
                    If Val(.TextMatrix(i, COL_EDIT)) = 2 Then
                        intBloodState = 0
                        '用血医嘱已经发血，则修改医嘱审核状态为2
                        If Val(.TextMatrix(i, COL_检查方法)) = 1 Then
                            If gobjPublicBlood.GetPrepareBloodRs(Val(.RowData(i)), rsBlood) = True Then
                                If Val(rsBlood!记录性质 & "") = 2 And Val(rsBlood!记录状态 & "") = 1 Then
                                    .TextMatrix(i, COL_审核状态) = 2
                                    intBloodState = 1
                                    bln用血审核 = True
                                End If
                            End If
                        End If
                        Call rs输血.AddNew(Array("医嘱ID", "类型", "状态"), Array(Val(.RowData(i)), 1, intBloodState))
                    ElseIf Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                        Call rs输血.AddNew(Array("医嘱ID", "类型"), Array(Val(.RowData(i)), 0))
                    End If
                End If
                
                If blnChecked = False And mblnAddAgent And mbytUseType <> 3 Then
                    If .RowHidden(i) = False And AgentInfo.本次就诊已录入 = False Then
                        If (Val(vsAdvice.TextMatrix(i, COL_状态)) = 1 Or Val(vsAdvice.TextMatrix(i, COL_状态)) = -1) And InStr(",麻醉药,毒性药,精神I类,", "," & Trim(.TextMatrix(i, COL_毒理分类)) & ",") > 0 Then
                            blnChecked = frmAgentInfo.ShowMe(Me, mlng病人ID, mlng主页ID, mstr姓名, mstr身份证号, AgentInfo.代办人姓名, AgentInfo.代办人身份证号, AgentInfo.代办人性别, AgentInfo.代办人年龄, AgentInfo.代办人电话, AgentInfo.用药理由)
                            If blnChecked Then
                                Call GetAgentInfo
                            Else
                                Screen.MousePointer = 0
                                Exit Function
                            End If
                        End If
                    End If
                End If

                If Val(.TextMatrix(i, COL_EDIT)) = 3 Then    '修改了序号的记录
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_更新序号(" & .RowData(i) & "," & Val(.TextMatrix(i, COL_序号)) & ")"
                ElseIf Val(.TextMatrix(i, COL_EDIT)) = 2 Then    '修改了内容的记录
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_Update(" & _
                                             .RowData(i) & "," & ZVal(.TextMatrix(i, COL_相关ID)) & "," & _
                                             Val(.TextMatrix(i, COL_序号)) & "," & Val(.TextMatrix(i, COL_状态)) & "," & _
                                             IIF(.TextMatrix(i, COL_期效) = "长嘱", 0, 1) & "," & _
                                             ZVal(.TextMatrix(i, COL_诊疗项目ID)) & "," & ZVal(.TextMatrix(i, COL_收费细目ID)) & "," & _
                                             ZVal(.TextMatrix(i, COL_天数)) & "," & ZVal(.TextMatrix(i, COL_单量)) & "," & ZVal(dbl总量) & "," & _
                                             "'" & Replace(.TextMatrix(i, col_医嘱内容), "'", "''") & "','" & Replace(.TextMatrix(i, COL_医生嘱托), "'", "''") & "'," & _
                                             "'" & .TextMatrix(i, COL_标本部位) & "','" & .TextMatrix(i, COL_频率) & "'," & _
                                             ZVal(.TextMatrix(i, COL_频率次数)) & "," & ZVal(.TextMatrix(i, COL_频率间隔)) & "," & _
                                             "'" & .TextMatrix(i, COL_间隔单位) & "','" & .TextMatrix(i, COL_执行时间) & "'," & _
                                             Val(.TextMatrix(i, COL_计价性质)) & "," & ZVal(.TextMatrix(i, COL_执行科室ID)) & "," & _
                                             Val(.TextMatrix(i, COL_执行性质)) & "," & Val(.TextMatrix(i, COL_标志)) & "," & _
                                             "To_Date('" & Format(IIF(.TextMatrix(i, COL_采集时间) = "", .Cell(flexcpData, i, COL_开始时间), .TextMatrix(i, COL_采集时间)), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI')," & _
                                             "To_Date('" & Format(.Cell(flexcpData, i, COL_终止时间), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI')," & _
                                             mlng病人科室id & "," & Val(.TextMatrix(i, COL_开嘱科室ID)) & ",'" & .TextMatrix(i, COL_开嘱医生) & "'," & _
                                             "To_Date('" & Format(.Cell(flexcpData, i, COL_开嘱时间), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI')," & _
                                             "'" & .TextMatrix(i, COL_检查方法) & "'," & Val(.TextMatrix(i, COL_执行标记)) & "," & _
                                             IIF(.Cell(flexcpData, i, COL_可否分零) = 1, Val(.TextMatrix(i, COL_可否分零)), "Null") & "," & _
                                             "'" & .Cell(flexcpData, i, COL_医生嘱托) & "','" & UserInfo.姓名 & "',Null," & _
                                             ZVal(Val(.TextMatrix(i, COL_用药目的))) & ",'" & .TextMatrix(i, COL_用药理由) & "'," & ZVal(Val(.TextMatrix(i, COL_审核状态))) & _
                                             ",'" & IIF(txt超量说明.Enabled, .TextMatrix(i, COL_超量说明), "") & "','" & IIF(txt首次用量.Enabled, .TextMatrix(i, COL_首次用量), "") & _
                                             "'," & ZVal(Val(.TextMatrix(i, COL_手术情况))) & "," & ZVal(Val(.TextMatrix(i, COL_组合项目ID))) & _
                                              ",'" & .Cell(flexcpData, i, COL_皮试结果) & "',null," & ZVal(mlng会诊医嘱ID) & ")"
                ElseIf Val(.TextMatrix(i, COL_EDIT)) = 1 Then    '新增的记录
                    blnDo = True
                    If mbytUseType = 1 Then
                        rsPathAdvice.Filter = "行号=" & i
                        If rsPathAdvice.RecordCount > 0 Then
                            mstrAdviceOfItem = mstrAdviceOfItem & "," & rsPathAdvice!路径项目ID & ":" & rsPathAdvice!原医嘱ID
                            blnDo = False
                        End If
                    End If

                    If blnDo Then
                        If .TextMatrix(i, COL_类别) = "K" Then
                            '输血类医嘱从新获取医嘱审核状态
                            If TypeName(.Cell(flexcpData, i, COL_申请序号)) = "Recordset" Then
                                Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, i, COL_申请序号))
                                If Not rsCard.EOF Then
                                    rsCard.MoveFirst
                                    strTmp = NVL(rsCard!申请项目 & "", .TextMatrix(i, COL_诊疗项目ID) & "," & dbl总量)
                                    .TextMatrix(i, COL_审核状态) = GetBloodVerifyState(2, mlng病人ID, mlng主页ID, .TextMatrix(i, COL_标本部位), GetBloodTotalByML(strTmp), Val(.TextMatrix(i, COL_标志)), Val(.TextMatrix(i, COL_检查方法)), Val(.TextMatrix(i, COL_婴儿)), .RowData(i))
                                    If i < .Rows - 1 Then
                                        If Val(.TextMatrix(i + 1, COL_相关ID)) = .RowData(i) Then
                                            .TextMatrix(i + 1, COL_审核状态) = .TextMatrix(i, COL_审核状态)
                                        End If
                                    End If
                                    Call SetRow标志图标(i, 2)
                                End If
                            Else
                                '非申请单下达的医嘱
                                If bln血库 Then
                                    strTmp = .TextMatrix(i, COL_诊疗项目ID) & "," & dbl总量
                                    .TextMatrix(i, COL_审核状态) = GetBloodVerifyState(2, mlng病人ID, mlng主页ID, .TextMatrix(i, COL_标本部位), GetBloodTotalByML(strTmp), Val(.TextMatrix(i, COL_标志)), Val(.TextMatrix(i, COL_检查方法)), Val(.TextMatrix(i, COL_婴儿)), .RowData(i))
                                    If i < .Rows - 1 Then
                                        If Val(.TextMatrix(i + 1, COL_相关ID)) = .RowData(i) Then
                                            .TextMatrix(i + 1, COL_审核状态) = .TextMatrix(i, COL_审核状态)
                                        End If
                                    End If
                                    Call SetRow标志图标(i, 2)
                                End If
                            End If
                        End If
                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                        arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_Insert(" & _
                                                 .RowData(i) & "," & ZVal(.TextMatrix(i, COL_相关ID)) & "," & _
                                                 Val(.TextMatrix(i, COL_序号)) & ",2," & mlng病人ID & "," & mlng主页ID & "," & _
                                                 Val(.TextMatrix(i, COL_婴儿)) & "," & Val(.TextMatrix(i, COL_状态)) & "," & _
                                                 IIF(.TextMatrix(i, COL_期效) = "长嘱", 0, 1) & "," & _
                                                 "'" & IIF(.TextMatrix(i, COL_类别) = "*", "", .TextMatrix(i, COL_类别)) & "'," & _
                                                 ZVal(.TextMatrix(i, COL_诊疗项目ID)) & "," & ZVal(.TextMatrix(i, COL_收费细目ID)) & "," & _
                                                 ZVal(.TextMatrix(i, COL_天数)) & "," & ZVal(.TextMatrix(i, COL_单量)) & "," & ZVal(dbl总量) & "," & _
                                                 "'" & Replace(.TextMatrix(i, col_医嘱内容), "'", "''") & "','" & Replace(.TextMatrix(i, COL_医生嘱托), "'", "''") & "'," & _
                                                 "'" & .TextMatrix(i, COL_标本部位) & "','" & .TextMatrix(i, COL_频率) & "'," & _
                                                 ZVal(.TextMatrix(i, COL_频率次数)) & "," & ZVal(.TextMatrix(i, COL_频率间隔)) & "," & _
                                                 "'" & .TextMatrix(i, COL_间隔单位) & "','" & .TextMatrix(i, COL_执行时间) & "'," & _
                                                 Val(.TextMatrix(i, COL_计价性质)) & "," & ZVal(.TextMatrix(i, COL_执行科室ID)) & "," & _
                                                 Val(.TextMatrix(i, COL_执行性质)) & "," & Val(.TextMatrix(i, COL_标志)) & "," & _
                                                 "To_Date('" & Format(IIF(.TextMatrix(i, COL_采集时间) = "", .Cell(flexcpData, i, COL_开始时间), .TextMatrix(i, COL_采集时间)), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI')," & _
                                                 "To_Date('" & Format(.Cell(flexcpData, i, COL_终止时间), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI')," & _
                                                 mlng病人科室id & "," & Val(.TextMatrix(i, COL_开嘱科室ID)) & ",'" & .TextMatrix(i, COL_开嘱医生) & "'," & _
                                                 "To_Date('" & Format(.Cell(flexcpData, i, COL_开嘱时间), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI')," & _
                                                 "NULL," & ZVal(mlng前提ID) & ",'" & .TextMatrix(i, COL_检查方法) & "'," & Val(.TextMatrix(i, COL_执行标记)) & "," & _
                                                 IIF(.Cell(flexcpData, i, COL_可否分零) = 1, Val(.TextMatrix(i, COL_可否分零)), "Null") & "," & _
                                                 "'" & .Cell(flexcpData, i, COL_医生嘱托) & "','" & UserInfo.姓名 & "',Null," & _
                                                 ZVal(Val(.TextMatrix(i, COL_用药目的))) & ",'" & .TextMatrix(i, COL_用药理由) & "'," & ZVal(Val(.TextMatrix(i, COL_审核状态))) & _
                                                 "," & ZVal(Val(.TextMatrix(i, COL_申请序号))) & ",'" & IIF(txt超量说明.Enabled, .TextMatrix(i, COL_超量说明), "") & "','" & IIF(txt首次用量.Enabled, .TextMatrix(i, COL_首次用量), "") & _
                                                 "'," & ZVal(Val(.TextMatrix(i, COL_配方ID))) & "," & ZVal(Val(.TextMatrix(i, COL_手术情况))) & "," & ZVal(Val(.TextMatrix(i, COL_组合项目ID))) & _
                                                 ",'" & .Cell(flexcpData, i, COL_皮试结果) & "',null," & ZVal(mlng会诊医嘱ID) & ")"

                        If mbytUseType = 1 Then    '路径项目ID与医嘱ID的对应
                            mstrAdviceOfItem = mstrAdviceOfItem & "," & .TextMatrix(i, COL_路径项目ID) & ":" & .RowData(i)
                            If .Cell(flexcpData, i, COL_超量说明) <> "" And .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "4" Then
                                str路径项目IDs = str路径项目IDs & "," & .TextMatrix(i, COL_路径项目ID) & "|" & .Cell(flexcpData, i, COL_超量说明)
                            End If
                        ElseIf mbytUseType = 2 Then
                            mstrAdviceOfItem = mstrAdviceOfItem & "," & .RowData(i)
                            mdatPathOut = Format(.TextMatrix(i, COL_开始时间), "YYYY-MM-DD")
                        End If
                        
                        '收集本次新增的医嘱用于关联病人危急值记录
                        If mlng危急值ID <> 0 Then
                            If Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                                ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                arrSQL(UBound(arrSQL)) = "Zl_病人危急值医嘱_Update(1," & mlng危急值ID & "," & .RowData(i) & ")"
                            End If
                        End If
                        
                        '输血申请单的额外数据保存
                        If .TextMatrix(i, COL_类别) = "K" Then
                            If TypeName(.Cell(flexcpData, i, COL_申请序号)) = "Recordset" Then
                                Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, i, COL_申请序号))
                                If Not rsCard.EOF Then
                                    rsCard.MoveFirst
                                    strTmp = rsCard!申请其他项目SQL & ""
                                    If strTmp <> "" Then
                                        strTmp = Replace(strTmp, "[相关ID]", .RowData(i))
                                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                        arrSQL(UBound(arrSQL)) = strTmp
                                    End If
                                    strTmp = rsCard!检验项目SQL & ""
                                    If strTmp <> "" Then
                                        strTmp = Replace(strTmp, "[相关ID]", .RowData(i))
                                        varTmp = Split(strTmp, "<splitSQL>")
                                        For j = 0 To UBound(varTmp)
                                            If varTmp(j) <> "" Then
                                                ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                                arrSQL(UBound(arrSQL)) = varTmp(j)
                                            End If
                                        Next
                                    End If
                                    strTmp = rsCard!诊断关联信息SQL & ""
                                    If strTmp <> "" Then
                                        strTmp = Replace(strTmp, "[相关ID]", .RowData(i))
                                        varTmp = Split(strTmp, "<splitSQL>")
                                        For j = 0 To UBound(varTmp)
                                            If varTmp(j) <> "" Then
                                                ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                                arrSQL(UBound(arrSQL)) = varTmp(j)
                                            End If
                                        Next
                                    End If
                                    strTmp = rsCard!申请项目SQL & ""
                                    If strTmp <> "" Then
                                        strTmp = Replace(strTmp, "[相关ID]", .RowData(i))
                                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                        arrSQL(UBound(arrSQL)) = strTmp
                                    End If
                                End If
                            End If
                        End If
                        If .TextMatrix(i, COL_类别) = "F" Then
                            If TypeName(.Cell(flexcpData, i, COL_申请序号)) = "Recordset" Then
                                Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, i, COL_申请序号))
                                If Not rsCard.EOF Then
                                    rsCard.MoveFirst
                                    strTmp = rsCard!临床诊断IDs & ""
                                    '诊断关联信息
                                    If strTmp <> "" Then
                                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                        arrSQL(UBound(arrSQL)) = "Zl_病人诊断医嘱_Insert(" & .RowData(i) & ",'" & strTmp & "')"
                                    End If
                                End If
                            End If
                        End If
                        '检验申请
                        If .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "6" Then
                            If TypeName(.Cell(flexcpData, i, COL_申请序号)) = "Recordset" Then
                                Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, i, COL_申请序号))
                                If Not rsCard.EOF Then
                                    rsCard.MoveFirst
                                    strTmp = rsCard!临床诊断IDs & ""
                                    '诊断关联信息
                                    If strTmp <> "" Then
                                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                        arrSQL(UBound(arrSQL)) = "Zl_病人诊断医嘱_Insert(" & .RowData(i) & ",'" & strTmp & "')"
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
                
                If blnRis Then
                    If InStr(",F,D,", .TextMatrix(i, COL_类别)) > 0 Or InStr(",0,5,", Val(.TextMatrix(i, COL_操作类型))) > 0 And .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_期效) = "临嘱" Then
                        If Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                            If Val(.TextMatrix(i, COL_EDIT)) = 2 Then
                                str本次变动 = str本次变动 & "," & .RowData(i)
                            End If
                            If InStr(",1,2,", Val(.TextMatrix(i, COL_EDIT))) > 0 And Val(.TextMatrix(i, COL_标志)) <> 1 Then
                                strNewAdvice = strNewAdvice & "," & .RowData(i) & ":" & Val(.TextMatrix(i, COL_诊疗项目ID))
                            End If
                        End If
                    End If
                End If

                '临床路径数据处理
                If mbytUseType = 0 And mlng路径状态 = 1 And Not blnTemp Then
                    If Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_状态)) = -1 Then
                        '路径外项目(婴儿医嘱、自由录入医嘱不当成路径外项目,补录医嘱的生效日期小于首次生成日期,也不作为路径表上项目)
                        If Val(.TextMatrix(i, COL_路径项目ID)) = 0 Then
                            If Val(.TextMatrix(i, COL_婴儿)) = 0 And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                                strAdivcePathOut = strAdivcePathOut & "," & .RowData(i)
                            End If
                        ElseIf Val(.TextMatrix(i, COL_路径项目ID)) > 0 Then
                            rsPathAdvice.Filter = "路径项目ID = " & .TextMatrix(i, COL_路径项目ID)
                            If rsPathAdvice.RecordCount = 0 Then
                                rsPathAdvice.AddNew
                                rsPathAdvice!路径项目ID = .TextMatrix(i, COL_路径项目ID)
                                rsPathAdvice!路径项目分类 = .TextMatrix(i, COL_路径项目分类)
                                rsPathAdvice!医嘱ids = .RowData(i)
                                rsPathAdvice!开始时间 = .TextMatrix(i, COL_开始时间)
                            Else
                                rsPathAdvice!医嘱ids = rsPathAdvice!医嘱ids & "," & .RowData(i)
                            End If
                            rsPathAdvice.Update
                        End If
                    End If
                End If

                '单据申请附项
                If .TextMatrix(i, COL_附项) <> "" And .Cell(flexcpData, i, COL_附项) = 1 Then
                    arrAppend = Split(.TextMatrix(i, COL_附项), "<Split1>")
                    For j = 0 To UBound(arrAppend)
                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                        arrSQL(UBound(arrSQL)) = "Zl_病人医嘱附件_Insert(" & .RowData(i) & "," & _
                                                 "'" & Split(arrAppend(j), "<Split2>")(0) & "'," & Val(Split(arrAppend(j), "<Split2>")(1)) & "," & _
                                                 j + 1 & "," & ZVal(Split(arrAppend(j), "<Split2>")(2)) & ",'" & Replace(Split(arrAppend(j), "<Split2>")(3), "'", "''") & "'" & _
                                                 IIF(j = 0, ",1", "") & ")"
                    Next
                End If

                'Pass:更新审查结果
                If Val(.Cell(flexcpData, i, COL_序号)) = 1 Then
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_病人医嘱记录_更新审查(" & .RowData(i) & "," & _
                                             IIF(CStr(.Cell(flexcpData, i, COL_警示)) = "", "NULL", Val(.Cell(flexcpData, i, COL_警示))) & IIF(.TextMatrix(i, COL_禁忌药品说明) <> "", ",'" & .TextMatrix(i, COL_禁忌药品说明) & "'", ",NULL") & ")"
                End If
            End If
        Next

        '保存时，提交暂存记录
        If Not blnTemp Then
            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
            arrSQL(UBound(arrSQL)) = "Zl_病人医嘱记录_提交(" & mlng病人ID & "," & mlng主页ID & "," & mlng前提ID & ",'" & UserInfo.姓名 & "')"
            If blnRis Then
                strTmp = Get暂存医嘱IDsToRis(mlng病人ID, mlng主页ID, mlng前提ID)
                If strTmp <> "" Then
                    strNewAdvice = strNewAdvice & "," & strTmp
                End If
            End If
            If bln血库 Then strAdvices输血 = Get暂存医嘱IDs(mlng病人ID, mlng主页ID, mlng前提ID, "K")
            If strAdvices输血 <> "" Then
                arrDelID = Split(strAdvices输血, ",")
                For i = 0 To UBound(arrDelID)
                    If Val(arrDelID(i)) <> 0 Then
                        Call rs输血.AddNew(Array("医嘱ID", "类型"), Array(Val(arrDelID(i)), 0))
                    End If
                Next
            End If
        End If

        '临床路径数据(要放在临时表提交之后，因为有外键约束)
        If mbytUseType = 0 And mlng路径状态 = 1 And Not blnTemp Then
            If rsPath.RecordCount > 0 Then
                rsPathAdvice.Filter = ""
                For i = 1 To rsPathAdvice.RecordCount
                    mdatPathOut = CDate(Format(rsPathAdvice!开始时间 & "", "YYYY-MM-dd"))
                    If rsPath!日期 > mdatPathOut And mdatPathOut <> CDate(0) Then
                        Set rsTmp = GetPatiPathAppend(rsPath!路径记录id, mdatPathOut)
                        If rsTmp.RecordCount > 0 Then
                            lng阶段Id = rsTmp!阶段id
                            lng天数 = rsTmp!天数
                            dat日期 = mdatPathOut
                        End If
                        byt生成时间性质 = 1 '补录
                    Else
                        lng阶段Id = rsPath!当前阶段ID
                        lng天数 = rsPath!当前天数
                        dat日期 = rsPath!日期
                        If rsPath!日期 = mdatPathOut Then
                            byt生成时间性质 = 0
                        Else
                            byt生成时间性质 = 2 '暂存
                        End If
                    End If
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "Zl_病人路径生成_Insert(0," & mlng病人ID & "," & mlng主页ID & ",Null,0," & _
                                             rsPath!路径记录id & "," & lng阶段Id & _
                                             ",To_Date('" & Format(dat日期, "yyyy-MM-dd") & "','YYYY-MM-DD')," & lng天数 & _
                                             ",'" & rsPathAdvice!路径项目分类 & "'," & rsPathAdvice!路径项目ID & ",'" & rsPathAdvice!医嘱ids & "',Null,Null" & _
                                             ",'" & UserInfo.姓名 & "'," & strAddDate & ",NULL,1,Null,Null,Null,NUlL," & IIF(byt生成时间性质 = 1, 1, 0) & ",Null,Null,NUlL,Null,Null,Null,NUlL," & IIF(byt生成时间性质 = 0, "NULL", byt生成时间性质) & ")"
                    rsPathAdvice.MoveNext
                Next
            End If
            '路径外项目
            If strAdivcePathOut <> "" And rsPath.RecordCount > 0 Then
                If rsPath!日期 > mdatPathOut And mdatPathOut <> CDate(0) Then
                    Set rsTmp = GetPatiPathAppend(rsPath!路径记录id, mdatPathOut)
                    If rsTmp.RecordCount > 0 Then
                        lng阶段Id = rsTmp!阶段id
                        lng天数 = rsTmp!天数
                        dat日期 = mdatPathOut
                    End If
                    byt生成时间性质 = 1 '补录
                Else
                    lng阶段Id = rsPath!当前阶段ID
                    lng天数 = rsPath!当前天数
                    dat日期 = rsPath!日期
                    If rsPath!日期 = mdatPathOut Then
                        byt生成时间性质 = 0
                    Else
                        byt生成时间性质 = 2 '暂存
                    End If
                End If
                strAdivcePathOut = Mid(strAdivcePathOut, 2)
                ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                arrSQL(UBound(arrSQL)) = "Zl_病人路径生成_Insert(0," & mlng病人ID & "," & mlng主页ID & ",Null,0," & _
                                          rsPath!路径记录id & "," & lng阶段Id & _
                                          ",To_Date('" & Format(dat日期, "yyyy-MM-dd") & "','YYYY-MM-DD')," & lng天数 & _
                                          ",'" & str路径项目分类 & "',Null" & ",'" & strAdivcePathOut & "',Null,Null" & _
                                          ",'" & UserInfo.姓名 & "'," & strAddDate & ",'路径外项目'" & _
                                          ",1,Null,Null,Null,NUlL," & IIF(byt生成时间性质 = 1, 1, 0) & ",Null,Null,NUlL,Null,Null,Null,NUlL," & IIF(byt生成时间性质 = 0, "NULL", byt生成时间性质) & ")"
              
            End If
        End If
    End With
    
    If strPrintDel <> "" Then
        arrPrintDel = Split(strPrintDel, "|")
        For i = 0 To UBound(arrPrintDel)
            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
            arrSQL(UBound(arrSQL)) = arrPrintDel(i)
        Next
    End If
    
    blnNoSave = mblnNoSave
    
    '提交数据
    If mbytUseType = 1 Or mbytUseType = 2 Then
        '临床路径的医嘱生成后的消息发送在Path部件中
        If mbytUseType = 1 Then
            marrSQL = arrSQL
            mstrAdviceOfItem = Mid(mstrAdviceOfItem, 2)
            mstr路径项目IDs = Mid(str路径项目IDs, 2)
        Else
            marrSQL = Array()
            mstrAdviceOfItem = Mid(mstrAdviceOfItem, 2)
            gcnOracle.BeginTrans    '不提交事务，以便返回时重新读取
            For i = 0 To UBound(arrSQL)
                zlDatabase.ExecuteProcedure CStr(arrSQL(i)), Me.Caption
            Next
        End If
        
        mblnNoSave = False
        Screen.MousePointer = 0
        SaveAdvice = True
        mblnOK = True
    Else
        If bln血库 Then
            bln血库 = rs输血.RecordCount > 0
            If bln血库 Then rs输血.MoveFirst
        End If
        If blnRis Then
            If str本次变动 <> "" Then
                str本次变动 = Mid(str本次变动, 2)
                Set rsTmp = GetDataRIS预约(str本次变动)
                If rsTmp.RecordCount > 0 Then
                    str本次变动 = "有数据"
                Else
                    str本次变动 = ""
                End If
            End If
        Else
            str本次变动 = ""
        End If
        
        '处理RIS的取消预约
        If str本次变动 <> "" Then
            On Error Resume Next
            For i = 1 To rsTmp.RecordCount
                If 0 <> gobjRis.HISSchedulingEx(Val(rsTmp!ID & ""), Val(rsTmp!预约id & "")) Then
                    MsgBox "当前启用了影像信息系统接口，本次操作删除或修改了已经预约医嘱，但由于影像信息系统接口(HISSchedulingEx)取消息预约未调用成功，请与系统管理员联系。", vbInformation, gstrSysName
                End If
                rsTmp.MoveNext
            Next
            On Error GoTo errH
        End If
         
        gcnOracle.BeginTrans: blnTrans = True
        For i = 0 To UBound(arrSQL)
            zlDatabase.ExecuteProcedure CStr(arrSQL(i)), Me.Caption
        Next
        '处理血库的接口
        If bln血库 Then
            For i = 1 To rs输血.RecordCount
                If Val("" & rs输血!状态) <> 1 Then
                    If gobjPublicBlood.AdviceOperation(p住院医嘱下达, Val(rs输血!医嘱ID & ""), Val(rs输血!类型 & ""), False, strErr) = False Then
                        gcnOracle.RollbackTrans: blnTrans = False
                        Screen.MousePointer = 0
                        MsgBox "血库系统接口调用失败：" & strErr, vbInformation, gstrSysName
                        Exit Function
                    End If
                End If
                rs输血.MoveNext
            Next
        End If
        gcnOracle.CommitTrans: blnTrans = False
     
        Screen.MousePointer = 0
        mblnNoSave = False
        SaveAdvice = True
        mblnOK = True
        mlng危急值ID = 0
        '发送消息
        If Not blnTemp Then
            blnDo = True
            If mint场合 = 2 Then
                If Val(zlDatabase.GetPara("医技医嘱后续处理", glngSys, p住院医嘱发送)) = 0 Then
                    blnDo = False
                End If
            End If
            If blnDo Then Call SendMsg
        End If

        '消息相关,校对疑问，用血审核
        Call ReadMsg("ZLHIS_CIS_035")
        If bln用血审核 Then Call ReadMsg("ZLHIS_BLOOD_004")
        
        mstrDelIDs = "": mstrDelTempIDs = "": mstrDel输血 = ""
        mstr备血医嘱时间 = ""
        
        '路径外项目的处理(刷新在后面处理)
        '医技站补的医嘱暂时不进行路径外项目的登记处理（变异原因登记）
        If mbytUseType = 0 And mlng路径状态 = 1 And Not blnTemp And (mint场合 = 0 Or mint场合 = 1) Then
            If strAdivcePathOut <> "" And rsPath.RecordCount > 0 Then
                lng执行ID = GetPathOutItemID(Val(rsPath!路径记录id), DatAddDate)
                '强制刷新读取路径病人信息，因为界面可能切换病人
                Call gobjPath.zlRefresh(mlng病人ID, mlng主页ID, mlng病人病区ID, mlng病人科室id, mintPState, False, True)
                Call gobjPath.zlExePathAppendItem(str路径项目分类, strAdivcePathOut, lng执行ID, mdatPathOut)
            End If
        End If
        Call CreatePlugInOK(p住院医嘱下达, mint场合)
        '调用删除后外挂接口
        If Not gobjPlugIn Is Nothing Then
            On Error Resume Next
            For i = 0 To UBound(arrDelID)
                If Val(arrDelID(i)) <> 0 Then
                    If Not gobjPlugIn Is Nothing Then
                        Call gobjPlugIn.AdviceDeleted(glngSys, p住院医嘱下达, mlng病人ID, mlng主页ID, Val(arrDelID(i)), mint场合)
                        Call zlPlugInErrH(err, "AdviceDeleted")
                    End If
                End If
            Next
            On Error GoTo errH
        End If

        '保存成功后,所有记录变成原始记录
        With vsAdvice
            For i = vsAdvice.FixedRows To vsAdvice.Rows - 1
                If .RowData(i) <> 0 Then
                    .TextMatrix(i, COL_EDIT) = 0
                    .Cell(flexcpData, i, COL_序号) = Empty    'Pass:保存后清除标志
                    .Cell(flexcpData, i, COL_附项) = 0    '附项:保存后清除标志

                    '不读数据库刷新：暂存的记录保存提交后，变为正式记录
                    If Not blnTemp And Val(.TextMatrix(i, COL_状态)) = -1 Then
                        .TextMatrix(i, COL_状态) = 1
                    End If
                End If
            Next
        End With
        
        '调用处方审查系统检查
        If InitObjRecipeAudit(p住院医嘱下达) And blnNoSave Then
            For i = vsAdvice.FixedRows To vsAdvice.Rows - 1
                If vsAdvice.TextMatrix(i, COL_类别) = "E" And vsAdvice.TextMatrix(i, COL_操作类型) = "2" Then
                    '当前新开状态的医嘱带需要传入
                    If Val(vsAdvice.TextMatrix(i, COL_状态)) = 1 Then
                        str给药IDs = str给药IDs & "," & vsAdvice.RowData(i)
                    End If
                End If
            Next
            If Mid(str给药IDs, 2) <> "" Then
                Call gobjRecipeAudit.AutoAudit(Me, 1, Mid(str给药IDs, 2), mlng病人科室id, 1, mlng病人ID, mlng主页ID)
            End If
        End If

        '调整医嘱序号并刷新
        Call AdviceClearUp(True, blnRefreshed)
        If mbytUseType = 0 And mlng路径状态 = 1 And Not blnTemp And Not blnRefreshed Then Call ReLoadAdvice(vsAdvice.RowData(vsAdvice.Row))
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
        
        '医嘱数据保存提交后，再RIS预约
        If blnRis Then
            If strNewAdvice <> "" Then
                strTmp = Mid(strNewAdvice, 2)
                varTmp = Split(strTmp, ",")
                On Error Resume Next
                For i = 0 To UBound(varTmp)
                    strTmp = varTmp(i)
                    Call gobjRis.HISScheduling(2, Val(Split(strTmp, ":")(0)), Val(Split(strTmp, ":")(1)))
                Next
                On Error GoTo errH
            End If
        End If
    End If
    'Pass自动用药审查上传处方
    If mblnPass And blnTemp = False And mbytUseType <> 3 Then
        If blnNewDrug Then Call gobjPass.zlPassUpLoad(mobjPassMap)
    End If
    Exit Function
errH:
    Screen.MousePointer = 0
    If blnTrans Then gcnOracle.RollbackTrans
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub AdviceClearUp(ByVal blnRefresh As Boolean, ByRef blnRefreshed As Boolean)
'功能：重新整理医嘱序号
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String
    
    On Error GoTo errH
    blnRefreshed = False
    
    Screen.MousePointer = 11
    strSQL = "Select Count(*) as Num From (Select 序号,Count(ID) From 病人医嘱记录 Where 病人ID=[1] And 主页ID=[2] Having Count(ID)>1 Group by 序号)"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
    If rsTmp.EOF Then Screen.MousePointer = 0: Exit Sub
    If NVL(rsTmp!Num, 0) = 0 Then Screen.MousePointer = 0: Exit Sub
    
    strSQL = "ZL_病人医嘱记录_更新序号(NULL,NULL," & mlng病人ID & "," & mlng主页ID & ")"
    Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
    
    '刷新数据
    If blnRefresh Then
        '重新读取显示医嘱
        Call ReLoadAdvice(vsAdvice.RowData(vsAdvice.Row))
        blnRefreshed = True
        If txt医嘱内容.Enabled Then
            txt医嘱内容.SetFocus
        Else
            vsAdvice.SetFocus
        End If
    End If
    Screen.MousePointer = 0
    Exit Sub
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function LoadAdvice() As Boolean
'功能：读取当前病人的医嘱记录
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, bln配方 As Boolean
    Dim i As Long, j As Long
    Dim strCurr As String, strTime As String, strTable As String
    Dim blnDo As Boolean, strPassWhere As String    'Pass
    Dim blnHaveData As Boolean
    Dim lng相关ID As Long

    Screen.MousePointer = 11

    On Error GoTo errH

    '下医嘱缺省的天数
    If msng天数 = 0 Then msng天数 = 1

    If mbytUseType = 2 Then
        strTable = "(Select * From 病人医嘱记录" & _
                   " Where ID IN(Select Column_Value From Table(f_Num2list([1]))))"
    Else
        strTable = "病人医嘱记录"

        If mbytUseType <> 3 Then    '顺序调整时显示所有医嘱，包括已作废的(为了改其序号)
            '临床和医技不互相编辑
            strSQL = " And Nvl(A.前提ID,0) in (Select /*+cardinality(x,10)*/ x.Column_Value From Table(Cast(f_Num2list([3]) As zlTools.t_Numlist)) X)"
            
            '护士不能看到医生的临时医嘱
            If mint场合 = 1 Then
                strSQL = strSQL & " And Nvl(A.医嘱状态,0)<>-1"
            End If

            '医嘱审核的条件设置
            If mbln审核 Then
                '医生审核时:只包含未审核医嘱
                strSQL = strSQL & " And A.医嘱状态=1 And Instr(A.开嘱医生,'/')=0" & _
                         " And Not Exists(Select M.姓名 From 人员表 M,执业类别 N" & _
                         "   Where M.姓名=A.开嘱医生 And M.执业类别=N.编码 And N.分类 IN('执业医师','执业助理医师')" & _
                         ")"
            ElseIf mint场合 <> 1 And mblnHaveAuditPriv Then
                '有资格医生下达时:不包含未审核医嘱(在审核功能中包含,以示区分)
                strSQL = strSQL & " And Not (A.医嘱状态=1 And Instr(A.开嘱医生,'/')=0" & _
                         " And Not Exists(Select M.姓名 From 人员表 M,执业类别 N" & _
                         "   Where M.姓名=A.开嘱医生 And M.执业类别=N.编码 And N.分类 IN('执业医师','执业助理医师')" & _
                         " ))"
            End If

            '其他条件
            If mblnShowStop Then
                '强行显示停止医嘱
                strPassWhere = " And A.医嘱状态<>4"
            Else
                'PASS启用时的条件
                '不读取：4-已作废，8-已停止，9-已确认停止，未用医嘱；包含当天的术前术后、转科医嘱
                If mblnPass Then
                    'And mint场合 <> 1 Then
                    '包含当天的临嘱(包括已执行),和未停止的长嘱
                    strPassWhere = " And A.医嘱状态<>4 And Nvl(A.执行标记,0)<>-1 And (A.医嘱状态 Not IN(8,9)" & _
                                   " Or A.诊疗类别='Z' And B.操作类型 In('3','4','14') And Trunc(A.开嘱时间)=Trunc(Sysdate)" & _
                                   " Or A.医嘱期效=1 And Trunc(A.开嘱时间)=Trunc(Sysdate))"
                End If
                
                If strPassWhere = "" Then
                    strPassWhere = " And A.医嘱状态<>4 And Nvl(A.执行标记,0)<>-1 And (A.医嘱状态 Not IN(8,9)" & _
                                   " Or A.诊疗类别='Z' And B.操作类型 In('3','4','14') And Trunc(A.开嘱时间)=Trunc(Sysdate))"
                End If
            End If
        End If
        strSQL = strSQL & " And A.病人ID=[1] And A.主页ID=[2] And A.病人来源<>3 And A.开始执行时间 is Not NULL"
    End If

    If (mbytUseType = 0 Or mbytUseType = 3) And mlng路径状态 <> 0 Then
        strSQL = _
        "Select a.*, g.项目id As 路径项目id, k.执行方式 As 路径执行方式" & vbNewLine & _
                 "From (Select a.Id, a.相关id, Nvl(a.婴儿, 0) As 婴儿, a.序号, a.医嘱期效, a.医嘱状态, Nvl(A.诊疗类别,'*') 诊疗类别, a.诊疗项目id, b.名称, a.标本部位, a.检查方法, a.执行标记," & vbNewLine & _
                 "              a.收费细目id, a.开始执行时间, a.医嘱内容, a.医生嘱托, a.单次用量, a.天数, a.总给予量, b.计算单位, a.执行频次, a.频率次数, a.频率间隔, a.间隔单位, b.计算方式," & vbNewLine & _
                 "              b.执行频率, b.操作类型, b.单独应用,b.执行分类, a.计价特性, a.执行时间方案, To_Char(a.上次执行时间, 'YYYY-MM-DD HH24:MI') As 上次执行, a.执行性质, a.执行科室id," & vbNewLine & _
                 "              a.执行终止时间, a.开嘱科室id, a.开嘱医生, a.开嘱时间, a.校对护士, a.紧急标志, c.处方限量, c.处方职务, c.毒理分类, c.抗生素, c.药品剂型, d.剂量系数, d.住院包装, d.住院单位," & vbNewLine & _
                 "              f.计算单位 As 散装单位, e.跟踪在用,e.是否分零 as 卫材分零, Nvl(a.可否分零, d.住院可否分零) As 可否分零, d.动态分零, a.审查结果, Decode(A.新开签名id, Null, 0, 1) As 签名否,Nvl(l.名称,Decode(Nvl(A.执行性质,0),0,'<叮嘱>',5,'-')) as 执行科室," & vbNewLine & _
                 "              Decode(a.医嘱状态,-1,Null,a.开嘱时间) as 操作时间, a.摘要, c.品种医嘱, h.路径执行id, Row_Number() Over(Partition By a.Id Order By h.路径执行id) As Top," & vbNewLine & _
                 "              A.用药目的,A.用药理由,A.审核状态,A.超量说明,a.首次用量,a.配方ID,a.手术情况,c.临床自管药,a.组合项目ID,d.高危药品,A.申请序号,b.撤档时间,C.溶媒,a.皮试结果,'' AS 处方审查状态,'' as 处方审查结果,a.禁忌药品说明,d.基本药物,-null As 危急值id,d.是否易至跌倒" & vbNewLine & _
                 "       From " & strTable & " A, 诊疗项目目录 B, 药品特性 C, 药品规格 D, 材料特性 E, 收费项目目录 F, 病人路径医嘱 H,部门表 L" & vbNewLine & _
                 "       Where a.诊疗项目id = b.Id(+) And a.诊疗项目id = c.药名id(+) And a.收费细目id = d.药品id(+) And a.Id = h.病人医嘱id(+) And A.执行科室ID=L.ID(+) And" & vbNewLine & _
                 "             a.收费细目id = e.材料id(+) And e.材料id = f.Id(+)" & strPassWhere & strSQL & ") A, 病人路径执行 G, 临床路径项目 K" & vbNewLine & _
                 "Where a.Top = 1 And a.路径执行id = g.Id(+) And g.项目id = k.Id(+)" & vbNewLine & _
                 "Order By 婴儿, 序号"

    Else
        strSQL = _
        " Select " & IIF(mbytUseType = 2, "/*+ Rule*/", "") & "A.ID,A.相关ID,Nvl(A.婴儿,0) as 婴儿,A.序号,A.医嘱期效,A.医嘱状态,Nvl(A.诊疗类别,'*') 诊疗类别," & _
                 " A.诊疗项目ID,B.名称,A.标本部位,A.检查方法,A.执行标记,A.收费细目ID,A.开始执行时间,A.医嘱内容,A.医生嘱托,A.单次用量,A.天数,A.总给予量,B.计算单位," & _
                 " A.执行频次,A.频率次数,A.频率间隔,A.间隔单位,B.计算方式,B.执行频率,B.操作类型,B.单独应用,B.执行分类,A.计价特性,A.执行时间方案," & _
                 " To_Char(A.上次执行时间,'YYYY-MM-DD HH24:MI') as 上次执行,A.执行性质,A.执行科室ID,A.执行终止时间,A.开嘱科室ID,A.开嘱医生,A.开嘱时间,A.校对护士," & _
                 " A.紧急标志,C.处方限量,C.处方职务,C.毒理分类,C.抗生素, C.药品剂型,D.剂量系数,D.住院包装,D.住院单位,F.计算单位 as 散装单位,E.跟踪在用,E.是否分零 as 卫材分零," & _
                 " Nvl(A.可否分零,D.住院可否分零) as 可否分零,D.动态分零,A.审查结果,Decode(a.新开签名ID,NULL,0,1) as 签名否,Nvl(l.名称,Decode(Nvl(A.执行性质,0),0,'<叮嘱>',5,'-')) as 执行科室," & _
                 " Decode(a.医嘱状态,-1,Null,a.开嘱时间) as 操作时间,A.摘要,C.品种医嘱,0 as 路径项目ID,0 as 路径执行方式,0 as 路径执行ID," & vbNewLine & _
                 " A.用药目的,A.用药理由,A.审核状态,A.超量说明,a.首次用量,a.配方ID,a.手术情况,c.临床自管药,a.组合项目ID,d.高危药品,A.申请序号,b.撤档时间,C.溶媒,a.皮试结果,J.状态 as 处方审查状态,J.审查结果 as 处方审查结果,a.禁忌药品说明,d.基本药物, Nvl(Max(g.危急值id), Max(h.危急值id)) As 危急值id,d.是否易至跌倒" & _
                 " From " & strTable & " A,诊疗项目目录 B,药品特性 C,药品规格 D,材料特性 E,收费项目目录 F,处方审查明细 I,处方审查记录 J,部门表 L, 病人危急值医嘱 G, 病人危急值医嘱 H" & _
                 " Where A.诊疗项目ID=B.ID(+) And A.诊疗项目ID=C.药名ID(+) And A.收费细目ID=D.药品ID(+) And A.执行科室ID=L.ID(+) And a.ID = i.医嘱ID(+) And a.Id = h.医嘱id(+) And a.相关id = g.医嘱id(+) And I.审方ID = J.ID(+) and (I.最后提交 =1 Or I.审方ID is NULL) " & _
                 " And A.收费细目ID=E.材料ID(+) And E.材料ID=F.ID(+) " & strPassWhere & strSQL
        strSQL = strSQL & "  " & _
                "Group By a.Id, a.相关id, a.婴儿, a.序号, a.医嘱期效, a.医嘱状态, a.诊疗类别, a.诊疗项目id, b.名称, a.标本部位, a.检查方法, a.执行标记, a.收费细目id, a.开始执行时间," & vbNewLine & _
                "         a.医嘱内容, a.医生嘱托, a.单次用量, a.天数, a.总给予量, b.计算单位, a.执行频次, a.频率次数, a.频率间隔, a.间隔单位, b.计算方式, b.执行频率, b.操作类型, b.单独应用," & vbNewLine & _
                "         b.执行分类, a.计价特性, a.执行时间方案, a.上次执行时间, a.执行性质, a.执行科室id, a.执行终止时间, a.开嘱科室id, a.开嘱医生, a.开嘱时间, a.校对护士, a.紧急标志," & vbNewLine & _
                "         c.处方限量, c.处方职务, c.毒理分类, c.抗生素, c.药品剂型, d.剂量系数, d.住院包装, d.住院单位, f.计算单位, e.跟踪在用, a.可否分零, d.住院可否分零, d.动态分零, a.审查结果," & vbNewLine & _
                "         a.新开签名id, l.名称, a.摘要, c.品种医嘱, a.用药目的, a.用药理由, a.审核状态, a.超量说明, a.首次用量, a.配方id, a.手术情况," & vbNewLine & _
                "         c.临床自管药, a.组合项目id, d.高危药品, a.申请序号, b.撤档时间, c.溶媒, a.皮试结果, j.状态, j.审查结果, a.禁忌药品说明, d.基本药物,E.是否分零,d.是否易至跌倒" & vbNewLine & _
                "Order By 婴儿, 序号"

    End If

    If mbytUseType = 2 Then
        If mstrAdivceOfPath <> "" Then
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mstrAdivceOfPath)
            blnHaveData = Not rsTmp.EOF
        Else
            blnHaveData = False
        End If
    Else
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, IIF(mstr前提IDs = "", "0", mstr前提IDs))
        blnHaveData = Not rsTmp.EOF
    End If
    On Error GoTo 0
    
    If blnHaveData Then
        mblnRowChange = False
        mblnHave疑问医嘱 = False
        If mbytUseType = 3 Then
            Set mrsAdvice调序 = zlDatabase.CopyNewRec(rsTmp, , "ID,相关ID,婴儿,序号,医嘱期效")
        End If
        strCurr = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
        With vsAdvice
            .Redraw = flexRDNone
            .Rows = .FixedRows
            .Rows = .FixedRows + rsTmp.RecordCount
            For i = 1 To rsTmp.RecordCount
                bln配方 = False
                .RowData(i) = CLng(rsTmp!ID)
                .TextMatrix(i, COL_EDIT) = IIF(mbytUseType = 2, 1, IIF(mbln审核, 2, 0))    '本为原始记录,审核时表示更改了。添加路径外项目，再次进入时，因为保存之前会回退事务，所以当成新的来产生。
                .TextMatrix(i, COL_相关ID) = NVL(rsTmp!相关ID)
                .TextMatrix(i, COL_婴儿) = Val("" & rsTmp!婴儿)
                .TextMatrix(i, COL_序号) = rsTmp!序号
                .TextMatrix(i, COL_期效) = IIF(NVL(rsTmp!医嘱期效, 0) = 0, "长嘱", "临嘱")
                .TextMatrix(i, COL_状态) = NVL(rsTmp!医嘱状态, 0)
                
                If Val(.TextMatrix(i, COL_状态)) = 2 Then
                    mblnHave疑问医嘱 = True
                End If
                
                .TextMatrix(i, COL_类别) = rsTmp!诊疗类别
                .TextMatrix(i, COL_诊疗项目ID) = Val("" & rsTmp!诊疗项目ID)
                .TextMatrix(i, COL_路径项目ID) = Val("" & rsTmp!路径项目ID)
                .TextMatrix(i, COL_路径执行方式) = Val("" & rsTmp!路径执行方式)
                .TextMatrix(i, COL_路径执行ID) = Val("" & rsTmp!路径执行id)
                If (mbytUseType = 0 Or mbytUseType = 3) And mlng路径状态 <> 0 Then
                    If Val("" & rsTmp!路径执行id) <> 0 And Val("" & rsTmp!路径项目ID) = 0 And Val("" & rsTmp!婴儿) = 0 Then
                        .Cell(flexcpBackColor, i, 0, i, .Cols - 1) = BackColorNew         '路径外项目，浅黄色
                    End If
                End If

                .TextMatrix(i, COL_名称) = NVL(rsTmp!名称)
                .TextMatrix(i, COL_标本部位) = NVL(rsTmp!标本部位)
                .TextMatrix(i, COL_检查方法) = NVL(rsTmp!检查方法)
                .TextMatrix(i, COL_执行标记) = NVL(rsTmp!执行标记, 0)
                .TextMatrix(i, COL_收费细目ID) = Val("" & rsTmp!收费细目ID)
                .Cell(flexcpData, i, COL_收费细目ID) = Val("" & rsTmp!收费细目ID)   '用于临床路径医嘱重选规格
                .TextMatrix(i, COL_品种医嘱) = Val("" & rsTmp!品种医嘱)

                .TextMatrix(i, col_医嘱内容) = NVL(rsTmp!医嘱内容)
                .TextMatrix(i, COL_医生嘱托) = NVL(rsTmp!医生嘱托)
                .Cell(flexcpData, i, COL_医生嘱托) = CStr(NVL(rsTmp!摘要))

                .TextMatrix(i, COL_计价性质) = NVL(rsTmp!计价特性, 0)
                .TextMatrix(i, COL_计算方式) = NVL(rsTmp!计算方式, 0)
                .TextMatrix(i, COL_执行科室) = "" & rsTmp!执行科室
                '临嘱可选频率的可能被设置为了一次性
                If NVL(rsTmp!执行频率, 0) = 0 _
                   And NVL(rsTmp!频率次数, 0) = 0 And NVL(rsTmp!频率间隔, 0) = 0 Then
                    .TextMatrix(i, COL_频率性质) = 1
                Else
                    .TextMatrix(i, COL_频率性质) = NVL(rsTmp!执行频率, 0)
                End If

                .TextMatrix(i, COL_操作类型) = NVL(rsTmp!操作类型)
                .TextMatrix(i, COL_执行分类) = NVL(rsTmp!执行分类, 0)
                .TextMatrix(i, COL_毒理分类) = NVL(rsTmp!毒理分类)
                .TextMatrix(i, COL_抗菌等级) = Val("" & rsTmp!抗生素)
                .TextMatrix(i, COL_药品剂型) = NVL(rsTmp!药品剂型)
                .TextMatrix(i, COL_处方限量) = NVL(rsTmp!处方限量)
                .TextMatrix(i, COL_处方职务) = NVL(rsTmp!处方职务)
                If gblnKSSStrict Or gbln手术分级管理 Or gbln输血分级管理 Or gbln血库系统 Then
                    .TextMatrix(i, COL_审核状态) = Val("" & rsTmp!审核状态)
                End If
                .TextMatrix(i, COL_用药目的) = "" & rsTmp!用药目的
                .TextMatrix(i, COL_用药理由) = "" & rsTmp!用药理由
                .TextMatrix(i, COL_组合项目ID) = "" & rsTmp!组合项目ID
                .TextMatrix(i, COL_高危药品) = NVL(rsTmp!高危药品, 0)
                .TextMatrix(i, COL_易跌倒) = NVL(rsTmp!是否易至跌倒, 0)
                If Format(NVL(rsTmp!撤档时间, "3000/1/1"), "yyyy-MM-dd") <> "3000-01-01" Then
                    .TextMatrix(i, COL_是否停用) = 1
                End If
                If InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 Then
                    .TextMatrix(i, COL_剂量系数) = NVL(rsTmp!剂量系数)
                    .TextMatrix(i, COL_住院包装) = NVL(rsTmp!住院包装)
                    .TextMatrix(i, COL_住院单位) = NVL(rsTmp!住院单位)
                    If Not IsNull(rsTmp!剂量系数) Then
                        .TextMatrix(i, COL_可否分零) = NVL(rsTmp!可否分零, 0)
                        .TextMatrix(i, COL_动态分零) = NVL(rsTmp!动态分零, 0)
                    End If
                ElseIf .TextMatrix(i, COL_类别) = "4" Then
                    .TextMatrix(i, COL_剂量系数) = 1
                    .TextMatrix(i, COL_住院包装) = 1
                    .TextMatrix(i, COL_住院单位) = NVL(rsTmp!散装单位)
                    .TextMatrix(i, COL_跟踪在用) = NVL(rsTmp!跟踪在用, 0)
                    .Cell(flexcpData, i, COL_可否分零) = NVL(rsTmp!卫材分零, 0)
                End If

                .TextMatrix(i, COL_开始时间) = Format(rsTmp!开始执行时间, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, i, COL_开始时间) = Format(rsTmp!开始执行时间, "yyyy-MM-dd HH:mm")
                If rsTmp!诊疗类别 & "" = "E" And rsTmp!操作类型 & "" = "6" Then
                    .TextMatrix(i, COL_采集时间) = Format(rsTmp!开始执行时间, "yyyy-MM-dd HH:mm")
                End If

                .TextMatrix(i, COL_频率) = NVL(rsTmp!执行频次)
                .TextMatrix(i, COL_频率次数) = NVL(rsTmp!频率次数)
                .TextMatrix(i, COL_频率间隔) = NVL(rsTmp!频率间隔)
                .TextMatrix(i, COL_间隔单位) = NVL(rsTmp!间隔单位)
                .TextMatrix(i, COL_执行时间) = NVL(rsTmp!执行时间方案)
                .TextMatrix(i, COL_上次执行) = NVL(rsTmp!上次执行)

                .TextMatrix(i, COL_终止时间) = Format(NVL(rsTmp!执行终止时间), "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, i, COL_终止时间) = Format(NVL(rsTmp!执行终止时间), "yyyy-MM-dd HH:mm")

                .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID)
                .TextMatrix(i, COL_执行性质) = NVL(rsTmp!执行性质, 0)
                .TextMatrix(i, COL_配方ID) = NVL(rsTmp!配方ID)
                .TextMatrix(i, COL_手术情况) = Val(rsTmp!手术情况 & "")
                .TextMatrix(i, COL_临床自管药) = rsTmp!临床自管药 & ""
                .TextMatrix(i, COL_申请序号) = rsTmp!申请序号 & ""
                .TextMatrix(i, COL_是否溶媒) = Val(rsTmp!溶媒 & "")
                
                .TextMatrix(i, COL_皮试结果) = rsTmp!皮试结果 & ""
                .Cell(flexcpData, i, COL_皮试结果) = .TextMatrix(i, COL_皮试结果)
                If Not (.TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "1") Then
                    .TextMatrix(i, COL_皮试结果) = "" '对于非皮试医嘱不显示皮试结果到界上
                End If
                
                .TextMatrix(i, COL_处方审查状态) = rsTmp!处方审查状态 & ""
                .TextMatrix(i, COL_处方审查结果) = rsTmp!处方审查结果 & ""
                .TextMatrix(i, COL_禁忌药品说明) = rsTmp!禁忌药品说明 & ""
                .TextMatrix(i, COL_单独应用) = rsTmp!单独应用 & ""
                .TextMatrix(i, COL_基本药物) = rsTmp!基本药物 & ""
                .TextMatrix(i, COL_危急值ID) = Val(rsTmp!危急值ID & "")
               
                If rsTmp!诊疗类别 = "E" Then
                    If NVL(rsTmp!相关ID, 0) = 0 And Val(.TextMatrix(i - 1, COL_相关ID)) = rsTmp!ID Then
                        If InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                            '当前记录是成药的给药途径,可能是一并给药的
                            For j = i - 1 To .FixedRows Step -1
                                If Val(.TextMatrix(j, COL_相关ID)) = rsTmp!ID Then
                                    '显示给药途径
                                    .TextMatrix(j, COL_用法) = rsTmp!名称 & rsTmp!医生嘱托
                                    '显示成药的执行性质
                                    If Val(.TextMatrix(j, COL_执行性质)) = 5 And Val(.TextMatrix(i, COL_执行性质)) <> 5 Then
                                        If Val(.TextMatrix(j, COL_执行标记)) = 2 Then
                                            .TextMatrix(j, COL_医嘱执行性质) = "不取药"
                                        Else
                                            .TextMatrix(j, COL_医嘱执行性质) = "自备药"
                                        End If
                                    ElseIf Val(.TextMatrix(j, COL_执行性质)) <> 5 And Val(.TextMatrix(i, COL_执行性质)) = 5 Then
                                        .TextMatrix(j, COL_医嘱执行性质) = "离院带药"
                                    Else
                                        .TextMatrix(j, COL_医嘱执行性质) = IIF(Val(.TextMatrix(j, COL_执行标记)) = 1, "自取药", "")
                                    End If
                                Else
                                    Exit For
                                End If
                            Next
                            Call SetTag一并给药(i - 1)
                        ElseIf InStr(",E,7,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                            '当前记录是中药配方的用法,即配方显示行
                            .TextMatrix(i, COL_用法) = rsTmp!名称
                            .TextMatrix(i, COL_中药形态) = Val("" & rsTmp!检查方法)    '中药用法行的检查方法字段存储了中药形态
                            bln配方 = True
                            .TextMatrix(i, COL_执行科室) = .TextMatrix(i - 2, COL_执行科室)
                            
                            If Val(.TextMatrix(i - 2, COL_执行性质)) = 5 And Val(.TextMatrix(i, COL_执行性质)) <> 5 Then
                                If Val(.TextMatrix(i - 2, COL_执行标记)) = 2 Then
                                    .TextMatrix(i, COL_医嘱执行性质) = "不取药"
                                Else
                                    .TextMatrix(i, COL_医嘱执行性质) = "自备药"
                                End If
                            ElseIf Val(.TextMatrix(i - 2, COL_执行性质)) <> 5 And Val(.TextMatrix(i, COL_执行性质)) = 5 Then
                                .TextMatrix(i, COL_医嘱执行性质) = "离院带药"
                            Else
                                .TextMatrix(i, COL_医嘱执行性质) = IIF(Val(.TextMatrix(i - 2, COL_执行标记)) = 1, "自取药", "")
                            End If
                        ElseIf .TextMatrix(i - 1, COL_类别) = "C" Then
                            .TextMatrix(i, COL_用法) = rsTmp!名称
                            .TextMatrix(i, COL_开始时间) = .TextMatrix(i - 1, COL_开始时间)
                            .Cell(flexcpData, i, COL_开始时间) = .TextMatrix(i, COL_开始时间)
                            .TextMatrix(i, COL_执行科室) = .TextMatrix(i - 1, COL_执行科室)
                        End If
                    ElseIf Not IsNull(rsTmp!相关ID) And .TextMatrix(i - 1, COL_类别) = "K" And NVL(rsTmp!相关ID, 0) = .RowData(i - 1) Then
                        '当前记录是输血途径行
                        .TextMatrix(i - 1, COL_用法) = rsTmp!名称 & rsTmp!医生嘱托
                    ElseIf Not IsNull(rsTmp!相关ID) Then
                        '当前记录是中药配方煎法行
                        bln配方 = True
                    End If
                ElseIf rsTmp!诊疗类别 = "7" Then
                    bln配方 = True
                End If

                '单量
                .TextMatrix(i, COL_单量) = FormatEx(NVL(rsTmp!单次用量), 5)
                If rsTmp!诊疗类别 = "4" Then
                    .TextMatrix(i, COL_单量单位) = NVL(rsTmp!散装单位)
                ElseIf bln配方 And rsTmp!诊疗类别 <> 7 Then
                    .TextMatrix(i, COL_单量单位) = ""
                Else
                    If NVL(rsTmp!医嘱期效, 0) = 0 Then
                        If InStr(",5,6,7,", rsTmp!诊疗类别) > 0 Or InStr(",1,2,", NVL(rsTmp!计算方式, 0)) > 0 Then
                            .TextMatrix(i, COL_单量单位) = NVL(rsTmp!计算单位)
                        End If
                    Else
                        If InStr(",5,6,7,", rsTmp!诊疗类别) > 0 _
                           Or (Val(.TextMatrix(i, COL_频率性质)) = 0 And InStr(",1,2,", NVL(rsTmp!计算方式, 0)) > 0) Then
                            .TextMatrix(i, COL_单量单位) = NVL(rsTmp!计算单位)
                        End If
                    End If
                End If

                '天数
                .TextMatrix(i, COL_天数) = NVL(rsTmp!天数)
                '取最近新开医嘱的开数作为缺省天数
                If InStr(",1,2,-1,", NVL(rsTmp!医嘱状态, 0)) > 0 _
                   And InStr(",5,6,", rsTmp!诊疗类别) > 0 _
                   And NVL(rsTmp!医嘱期效, 0) = 1 And NVL(rsTmp!天数, 0) <> 0 Then
                    msng天数 = NVL(rsTmp!天数, 1)
                End If

                '总量
                If InStr(",5,6,", rsTmp!诊疗类别) > 0 Then
                    '成药临嘱有总量,以零售单位存放,住院单位显示
                    If Not IsNull(rsTmp!总给予量) And Not IsNull(rsTmp!住院包装) Then
                        .TextMatrix(i, COL_总量) = FormatEx(rsTmp!总给予量 / rsTmp!住院包装, 5)
                    End If
                    If NVL(rsTmp!医嘱期效, 0) = 1 Then
                        .TextMatrix(i, COL_总量单位) = NVL(rsTmp!住院单位)
                    End If
                Else
                    '其它情况有中药和其它临嘱
                    If Not IsNull(rsTmp!总给予量) Then
                        .TextMatrix(i, COL_总量) = FormatEx(rsTmp!总给予量, 5)
                    End If
                    If bln配方 Then
                        .TextMatrix(i, COL_总量单位) = "付"    '中药配方总量单位为"付"
                    ElseIf NVL(rsTmp!医嘱期效, 0) = 1 Then
                        If .TextMatrix(i, COL_类别) = "4" Then
                            .TextMatrix(i, COL_总量单位) = NVL(rsTmp!散装单位)
                        Else
                            .TextMatrix(i, COL_总量单位) = NVL(rsTmp!计算单位)
                        End If
                    End If
                End If
                .TextMatrix(i, COL_超量说明) = rsTmp!超量说明 & ""
                .TextMatrix(i, COL_首次用量) = FormatEx(NVL(rsTmp!首次用量), 5)
                .TextMatrix(i, COL_开嘱科室ID) = rsTmp!开嘱科室id
                If mbln审核 Then
                    .TextMatrix(i, COL_开嘱医生) = UserInfo.姓名 & "/" & rsTmp!开嘱医生
                Else
                    .TextMatrix(i, COL_开嘱医生) = rsTmp!开嘱医生 & ""
                End If

                .TextMatrix(i, COL_开嘱时间) = Format(rsTmp!开嘱时间, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, i, COL_开嘱时间) = Format(rsTmp!开嘱时间, "yyyy-MM-dd HH:mm")

                .TextMatrix(i, COL_校对护士) = NVL(rsTmp!校对护士)

                '显示紧急标志:一并给药只显示在第一行
                .TextMatrix(i, COL_标志) = NVL(rsTmp!紧急标志, 0)
                .TextMatrix(i, COL_签名否) = NVL(rsTmp!签名否)

                Call SetRow标志图标(i, 1)

                '根据医嘱状态,欺效和药品毒理设置颜色
                '-------------------------------------------------------------------
                '医嘱颜色
                blnDo = False
                .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = .ForeColor
                If rsTmp!医嘱状态 = 2 Then
                    '校对疑问
                    .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &H80&    '深红
                    blnDo = True
                ElseIf rsTmp!医嘱状态 = 4 Then
                    '已作废(调整顺序时会显示已作废的，为了修改其序号)
                    .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &H808080    '灰色
                    .Cell(flexcpFontStrikethru, i, .FixedCols, i, .Cols - 1) = True
                    blnDo = True

                ElseIf InStr(",8,9,", rsTmp!医嘱状态) > 0 Then
                    '已停止,已确认停止:长嘱都以终止时间进行判断
                    If strCurr >= .TextMatrix(i, COL_终止时间) Or NVL(rsTmp!医嘱期效, 0) = 1 Then
                        .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &H808080    '灰色
                        blnDo = True
                    ElseIf rsTmp!医嘱状态 = 8 And strCurr < .TextMatrix(i, COL_终止时间) Then
                        '长嘱,停止后,停止时间未到这一种情况
                        .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &HFF8080    '浅蓝
                        blnDo = True
                    End If
                ElseIf rsTmp!医嘱状态 = 6 Then
                    '已暂停
                    strTime = Format(GetAdviceTime(rsTmp!ID, 6), "yyyy-MM-dd HH:mm")
                    If strCurr >= strTime Then
                        .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &H8000&    '深绿
                        blnDo = True
                    Else
                        '长嘱,暂停后,暂停时间未到这一种情况
                        .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &HFF8080    '浅蓝
                        blnDo = True
                    End If
                ElseIf rsTmp!医嘱状态 = 7 Then
                    '已启用
                    strTime = Format(GetAdviceTime(rsTmp!ID, 7), "yyyy-MM-dd HH:mm")
                    If strCurr < strTime Then
                        '长嘱,启用后,启用时间未到这一种情况
                        .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &H4AAD00  '浅绿
                        blnDo = True
                    End If
                End If
                If Not blnDo And rsTmp!医嘱状态 <> 1 And rsTmp!医嘱状态 <> -1 Then
                    '已通过校对(也包含后续的多个状态)
                    If Format(.TextMatrix(i, COL_上次执行), "YYYY-MM-DD") >= Format(strCurr, "YYYY-MM-DD") Then  '当天已发送的(长嘱可能发送到将来)
                        .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &HA08000               '海蓝
                    Else
                        .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &HC00000    '深蓝
                    End If
                End If

                '校对后术后医嘱红色显示
                If .TextMatrix(i, COL_类别) = "Z" And (Val(.TextMatrix(i, COL_操作类型)) = 4 Or Val(.TextMatrix(i, COL_操作类型)) = 14) _
                   And InStr(",-1,1,2,4,", rsTmp!医嘱状态) = 0 Then
                    .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = vbRed    '红色
                End If

                '发送后转科医嘱红色显示
                If .TextMatrix(i, COL_类别) = "Z" And Val(.TextMatrix(i, COL_操作类型)) = 3 And rsTmp!医嘱状态 = 8 Then
                    .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = vbRed    '红色
                End If

                '毒麻精药品标识:中药配方及组成味中药不处理
                If InStr(",5,6,", rsTmp!诊疗类别) > 0 And Not IsNull(rsTmp!毒理分类) Then
                    If InStr(",麻醉药,毒性药,精神药,精神I类,精神II类,", rsTmp!毒理分类) > 0 Then
                        .Cell(flexcpFontBold, i, col_医嘱内容) = True
                    End If
                End If

                '未用医嘱标识
                If Val(.TextMatrix(i, COL_执行标记)) = -1 Then
                    Set .Cell(flexcpPicture, i, COL_F标志) = frmIcons.imgFlag.ListImages("未用").Picture
                    .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &H808080    '灰色
                End If

                'Pass根据审查结果显示警示灯
                If mblnPass Then
                    If Not IsNull(rsTmp!审查结果) Then
                        Call gobjPass.zlPassSetWarnLight(mobjPassMap, i, rsTmp!审查结果)
                    End If
                End If
                
                '新开操作时间
                .TextMatrix(i, COL_操作时间) = Format(rsTmp!操作时间, "yyyy-MM-dd HH:mm:ss")

                Call Set医嘱超量(i, i)
                rsTmp.MoveNext
            Next

            '固定列图标对齐:设置为中对齐,不然擦边框时可能有问题
            .Cell(flexcpPictureAlignment, .FixedRows, 0, .Rows - 1, .FixedCols - 1) = 4
            '电子签名图标对齐
            .Cell(flexcpPictureAlignment, .FixedRows, col_医嘱内容, .Rows - 1, col_医嘱内容) = 0

            Call .AutoSize(col_医嘱内容)
            
            If mbytUseType = 0 And mlng路径状态 = 1 Then '非路径病人无需进入
                For i = 1 To .Rows - 1
                    '如果是暂存的医嘱，退出窗体后再进入或切换病人后，需要再次匹配
                    If Val(.TextMatrix(i, COL_状态)) = -1 And Val(.TextMatrix(i, COL_路径项目ID)) = 0 Then
                        Call SetPathRows(i, i)
                    End If
                Next
            End If
            .Redraw = flexRDDirect
        End With
        mblnRowChange = True

        If mbln审核 Then mblnNoSave = True
    Else
        mblnRowChange = False
        vsAdvice.Rows = vsAdvice.FixedRows
        vsAdvice.Rows = vsAdvice.FixedRows + 1
        mblnRowChange = True
    End If
    
    Screen.MousePointer = 0
    LoadAdvice = True
    Exit Function
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub AdviceSet复制医嘱(ByVal lng病人ID As Long, ByVal lng主页ID As Long, ByVal strIDs As String, _
    Optional ByVal blnHistory As Boolean, Optional ByVal strAlter As String)
'功能：复制指定病人的指定医嘱产生成为新医嘱
'参数：strIDs,strAlter=选择及要切换期效的医嘱ID(组ID)
'      blnHistory=复制包括历史医嘱
'说明：可供外部调用,调用之前处于新增医嘱行
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, bln配方 As Boolean
    Dim lngBegin As Long, lngEnd As Long
    Dim curDate As Date, blnDoIt As Boolean
    Dim lng开嘱科室ID As Long, str开嘱医生 As String
    Dim dbl相关ID As Double, lngCopyRow As Long
    Dim lng序号 As Long, intCount As Integer
    Dim lng医生ID As Long
    Dim lngRow As Long, i As Long, j As Long
    
    Dim lng西药房ID As Long, lng成药房ID As Long, lng中药房ID As Long, lng发料部门ID As Long
    Dim str药房IDs As String, str附项 As String, str开始时间 As String
    Dim bln药品小数输入 As Boolean
    Dim str高危药品 As String
    
    Screen.MousePointer = 11
    
    On Error GoTo errH
    
    strSQL = _
        " Select a.ID+0.1 As ID,Decode(a.相关id,Null,Null,a.相关id+0.1) As 相关id,Nvl(A.婴儿,0) as 婴儿,A.序号,A.医嘱期效," & _
        " A.医嘱状态,Nvl(A.诊疗类别,'*') as 诊疗类别,A.诊疗项目ID,B.名称,A.标本部位,A.检查方法,Decode(A.执行标记,-1,0,A.执行标记) as 执行标记," & _
        " A.收费细目ID,A.开始执行时间,Nvl(B.名称,A.医嘱内容) 医嘱内容,A.医生嘱托,A.单次用量,A.首次用量,A.天数,A.总给予量,B.计算单位," & _
        " A.执行频次,A.频率次数,A.频率间隔,A.间隔单位,B.计算方式,B.执行频率,B.操作类型,B.单独应用,B.执行分类," & _
        " B.计价性质,A.执行时间方案,Decode(nvl(Instr(',5,6,7,',a.诊疗类别),0),0,b.执行科室,a.执行性质) as 执行性质,A.执行科室ID,B.录入限量,C.处方限量,C.处方职务," & _
        " C.毒理分类,C.抗生素,C.药品剂型,D.剂量系数,D.住院包装,D.住院单位,F.计算单位 as 散装单位,E.跟踪在用,E.是否分零 as 卫材分零," & _
        " A.可否分零,D.住院可否分零 as 原始分零,D.动态分零,C.品种医嘱,a.配方ID,a.手术情况,c.临床自管药,d.高危药品,d.是否易至跌倒,a.组合项目ID,c.溶媒,d.基本药物" & _
        " From 病人医嘱记录 A,诊疗项目目录 B,药品特性 C,药品规格 D,材料特性 E,收费项目目录 F" & _
        " Where A.诊疗项目ID=B.ID(+) And A.诊疗项目ID=C.药名ID(+)" & _
        " And A.收费细目ID=D.药品ID(+) And A.病人ID=[1] And A.主页ID=[2]" & _
        " And A.收费细目ID=E.材料ID(+) And E.材料ID=F.ID(+)" & _
        " And Instr([3],','||A.ID||',')>0" & _
        " Order by 婴儿,序号"
    If blnHistory Then
        strSQL = Replace(strSQL, "病人医嘱记录", "H病人医嘱记录")
    End If
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng病人ID, lng主页ID, "," & strIDs & ",")
    On Error GoTo 0
    
    If Not rsTmp.EOF Then
        intCount = 0 '已经设置的行数
        mblnRowChange = False
        lngBegin = vsAdvice.Row '开始新增行
        lng序号 = GetCurRow序号(lngBegin) '起始序号
        curDate = zlDatabase.Currentdate
        
        With vsAdvice
            '取开嘱医生和科室
            If mint场合 = 1 Then
                lngCopyRow = GetPreRow(lngBegin)
                If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngBegin)
                If lngCopyRow <> -1 Then
                    If Val(.TextMatrix(lngCopyRow, COL_状态)) <> 1 Then lngCopyRow = -1
                End If
                If lngCopyRow <> -1 Then
                    str开嘱医生 = .TextMatrix(lngCopyRow, COL_开嘱医生)
                     If str开嘱医生 Like "*/*" Then
                        str开嘱医生 = Mid(str开嘱医生, InStr(str开嘱医生, "/") + 1)
                    End If
                End If
                '缺省为病人的住院医师或病人科室的第一个医生
                If str开嘱医生 = "" Then
                    str开嘱医生 = Get住院医师
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, str开嘱医生, lng医生ID)
                Else
                    Call Get开嘱医生(mlng病人科室id, mint场合 = 1, str开嘱医生, lng医生ID, , , True)
                End If
                lng开嘱科室ID = Get开嘱科室ID(lng医生ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            Else
                str开嘱医生 = UserInfo.姓名
                lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            End If
            
            '缺省开始时间
            If IsDate(msk开始时间.Text) Then
                If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                    str开始时间 = Format(DateAdd("s", -1, mdatTurn), "yyyy-MM-dd HH:mm")
                    
                ElseIf Not (gbln长期医嘱次日生效 And Format(msk开始时间.Text, "HH:mm") = "00:00") Then
                    '补录以补录为准，否则正常生成
                    If DateDiff("n", CDate(msk开始时间.Text), curDate) > gint补录间隔 Then
                        str开始时间 = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    End If
                    '当前控件中输入的日期合法，则作为缺省值
                    If Check开始时间(msk开始时间.Text, txt终止时间.Text, False) Then
                        str开始时间 = Format(msk开始时间.Text, "yyyy-MM-dd HH:mm")
                    End If
                End If
            End If
            '药品总量是否可以输入小数，中药不可以输入小数，因此只检查西药与中成药
            bln药品小数输入 = InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") > 0
            
            '复制数据
            .Redraw = flexRDNone
            For i = lngBegin To rsTmp.RecordCount + lngBegin - 1
                If i > lngBegin Then .AddItem "", i

                bln配方 = False
                
                .RowData(i) = -1 * rsTmp!ID
                If Not IsNull(rsTmp!相关ID) Then
                    .TextMatrix(i, COL_相关ID) = -1 * rsTmp!相关ID
                End If
                .TextMatrix(i, COL_序号) = lng序号 + intCount
                
                .TextMatrix(i, COL_EDIT) = 1 '新增
                .Cell(flexcpData, i, COL_EDIT) = CStr(lng病人ID & "," & lng主页ID) '记录相关的复制项目
                
                If mintPState = ps最近转出 And gbln只允许补录临嘱 = True Or mintPState = ps预出 Or mintPState = ps出院 Then
                    .TextMatrix(i, COL_期效) = "临嘱"
                Else
                    .TextMatrix(i, COL_期效) = IIF(NVL(rsTmp!医嘱期效, 0) = 0, "长嘱", "临嘱")
                End If

                .TextMatrix(i, COL_状态) = IIF(mbln暂存, -1, 1) '新开
                .TextMatrix(i, COL_婴儿) = cbo婴儿.ListIndex
                .TextMatrix(i, COL_类别) = rsTmp!诊疗类别
                .TextMatrix(i, COL_诊疗项目ID) = NVL(rsTmp!诊疗项目ID)
                .TextMatrix(i, COL_名称) = NVL(rsTmp!名称)
                .TextMatrix(i, COL_标本部位) = NVL(rsTmp!标本部位)
                .TextMatrix(i, COL_检查方法) = NVL(rsTmp!检查方法)
                .TextMatrix(i, COL_执行标记) = NVL(rsTmp!执行标记, 0)
                .TextMatrix(i, COL_收费细目ID) = NVL(rsTmp!收费细目ID)
                .TextMatrix(i, col_医嘱内容) = NVL(rsTmp!医嘱内容)
                .TextMatrix(i, COL_医生嘱托) = NVL(rsTmp!医生嘱托)
                .Cell(flexcpData, i, COL_医生嘱托) = gclsInsure.GetItemInfo(mint险类, mlng病人ID, Val(.TextMatrix(i, COL_收费细目ID)), "", 0, "", .TextMatrix(i, COL_诊疗项目ID) & "||2")
                
                .TextMatrix(i, COL_计价性质) = NVL(rsTmp!计价性质, 0)
                .TextMatrix(i, COL_计算方式) = NVL(rsTmp!计算方式, 0)
                .TextMatrix(i, COL_操作类型) = NVL(rsTmp!操作类型)
                .TextMatrix(i, COL_单独应用) = NVL(rsTmp!单独应用)
                .TextMatrix(i, COL_执行分类) = NVL(rsTmp!执行分类, 0)
                .TextMatrix(i, COL_毒理分类) = NVL(rsTmp!毒理分类)
                .TextMatrix(i, COL_抗菌等级) = Val("" & rsTmp!抗生素)
                .TextMatrix(i, COL_配方ID) = NVL(rsTmp!配方ID)
                .TextMatrix(i, COL_手术情况) = Val(rsTmp!手术情况 & "")
                .TextMatrix(i, COL_临床自管药) = rsTmp!临床自管药 & ""
                .TextMatrix(i, COL_组合项目ID) = rsTmp!组合项目ID & ""
                .TextMatrix(i, COL_高危药品) = Val(rsTmp!高危药品 & "")
                .TextMatrix(i, COL_易跌倒) = Val(rsTmp!是否易至跌倒 & "")
                .TextMatrix(i, COL_是否溶媒) = Val(rsTmp!溶媒 & "")
                .TextMatrix(i, COL_基本药物) = rsTmp!基本药物 & ""

                If Val(.TextMatrix(i, COL_高危药品)) <> 0 Then
                    str高危药品 = str高危药品 & vbCrLf & .TextMatrix(i, col_医嘱内容) & ":" & Decode(Val(.TextMatrix(i, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级；"
                End If
                
                .TextMatrix(i, COL_药品剂型) = NVL(rsTmp!药品剂型)
                If InStr(",5,6,7,", rsTmp!诊疗类别) > 0 Then
                    .TextMatrix(i, COL_处方限量) = NVL(rsTmp!处方限量)
                Else
                    .TextMatrix(i, COL_处方限量) = NVL(rsTmp!录入限量)
                End If
                .TextMatrix(i, COL_处方职务) = NVL(rsTmp!处方职务)
                .TextMatrix(i, COL_品种医嘱) = Val("" & rsTmp!品种医嘱)
                
                If InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 Then
                    .TextMatrix(i, COL_剂量系数) = NVL(rsTmp!剂量系数)
                    .TextMatrix(i, COL_住院包装) = NVL(rsTmp!住院包装)
                    .TextMatrix(i, COL_住院单位) = NVL(rsTmp!住院单位)
                    If Not IsNull(rsTmp!剂量系数) Then
                        If Not IsNull(rsTmp!可否分零) Then
                            .TextMatrix(i, COL_可否分零) = NVL(rsTmp!可否分零, 0)
                            .Cell(flexcpData, i, COL_可否分零) = 1
                        Else
                            .TextMatrix(i, COL_可否分零) = NVL(rsTmp!原始分零, 0)
                        End If
                        .TextMatrix(i, COL_动态分零) = NVL(rsTmp!动态分零, 0)
                    End If
                ElseIf .TextMatrix(i, COL_类别) = "4" Then
                    .TextMatrix(i, COL_剂量系数) = 1
                    .TextMatrix(i, COL_住院包装) = 1
                    .TextMatrix(i, COL_住院单位) = NVL(rsTmp!散装单位)
                    .TextMatrix(i, COL_跟踪在用) = NVL(rsTmp!跟踪在用)
                    .Cell(flexcpData, i, COL_可否分零) = NVL(rsTmp!卫材分零, 0)
                End If
                
                '开始时间
                .TextMatrix(i, COL_开始时间) = str开始时间
                If .TextMatrix(i, COL_开始时间) = "" Then
                    .TextMatrix(i, COL_开始时间) = GetDefaultTime(i)
                End If
                .Cell(flexcpData, i, COL_开始时间) = .TextMatrix(i, COL_开始时间)
                If rsTmp!诊疗类别 = "E" And rsTmp!操作类型 & "" = "6" Then
                    .TextMatrix(i, COL_采集时间) = .TextMatrix(i, COL_开始时间)
                End If
                
                '手术/输血时间：复制时缺省与开始时间相同,在标本部位处理后
                If rsTmp!诊疗类别 = "K" Or rsTmp!诊疗类别 = "F" Or rsTmp!诊疗类别 = "G" _
                    And Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(i - 1, COL_相关ID)) Then
                    .TextMatrix(i, COL_手术时间) = .TextMatrix(i, COL_开始时间)
                End If
                
                '临嘱可选频率的可能被设置为了一次性
                If NVL(rsTmp!医嘱期效, 0) = 1 And NVL(rsTmp!执行频率, 0) = 0 _
                    And NVL(rsTmp!频率次数, 0) = 0 And NVL(rsTmp!频率间隔, 0) = 0 Then
                    .TextMatrix(i, COL_频率性质) = 1
                Else
                    .TextMatrix(i, COL_频率性质) = NVL(rsTmp!执行频率, 0)
                End If
                .TextMatrix(i, COL_频率) = NVL(rsTmp!执行频次)
                .TextMatrix(i, COL_频率次数) = NVL(rsTmp!频率次数)
                .TextMatrix(i, COL_频率间隔) = NVL(rsTmp!频率间隔)
                .TextMatrix(i, COL_间隔单位) = NVL(rsTmp!间隔单位)
                .TextMatrix(i, COL_执行时间) = NVL(rsTmp!执行时间方案)
                .TextMatrix(i, COL_执行性质) = NVL(rsTmp!执行性质, 0)
                
                '处理执行科室
                If rsTmp!诊疗类别 = "Z" Then
                    .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID)
                ElseIf Val(NVL(rsTmp!诊疗项目ID)) = 0 Then
                    '自由录入医嘱执行科室和录入自由录入医嘱时的默认科室保持一直
                    .TextMatrix(i, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, "*", 0, 0, 4, mlng病人科室id, 0, cbo期效.ListIndex, IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                ElseIf InStr(",0,5,", NVL(rsTmp!执行性质, 0)) = 0 Then
                    If NVL(rsTmp!执行科室ID, 0) <> 0 Then
                        If InStr(",5,6,7,", rsTmp!诊疗类别) > 0 Then
                            str药房IDs = Get可用药房IDs(rsTmp!诊疗类别, rsTmp!诊疗项目ID, NVL(rsTmp!收费细目ID, 0), mlng病人科室id, 2)
                            If InStr("," & str药房IDs & ",", "," & rsTmp!执行科室ID & ",") > 0 Then
                                .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID, 0)
                            End If
                        ElseIf rsTmp!诊疗类别 = "4" Then
                            str药房IDs = Get可用发料部门IDs(NVL(rsTmp!收费细目ID, 0), mlng病人科室id, 2)
                            If InStr("," & str药房IDs & ",", "," & rsTmp!执行科室ID & ",") > 0 Then
                                .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID, 0)
                            End If
                        ElseIf rsTmp!诊疗类别 = "*" Or Val(.TextMatrix(i, COL_执行性质)) = 4 Then
                            '自由医嘱或者"4-指定科室"时才取,其它的固定生成
                            .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID, 0)
                            
                            '检查执行科室的有效性
                            If Val(.TextMatrix(i, COL_执行科室ID)) <> 0 Then
                                If CheckExecDeptValidate(Val(.TextMatrix(i, COL_执行科室ID)), mlng病人科室id, IIF(mlng病人性质 = 1, 1, 2), Val("" & rsTmp!诊疗项目ID)) = False Then
                                    .TextMatrix(i, COL_执行科室ID) = 0
                                End If
                            End If
                        End If
                    End If
                    If Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                        '药品、卫材类的整个成套相同
                        If rsTmp!诊疗类别 = "5" Then
                            If lng西药房ID = 0 Then
                                lng西药房ID = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsTmp!诊疗类别, rsTmp!诊疗项目ID, NVL(rsTmp!收费细目ID, 0), 4, mlng病人科室id, 0, NVL(rsTmp!医嘱期效, 0), IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                            End If
                            .TextMatrix(i, COL_执行科室ID) = lng西药房ID
                        ElseIf rsTmp!诊疗类别 = "6" Then
                            If lng成药房ID = 0 Then
                                lng成药房ID = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsTmp!诊疗类别, rsTmp!诊疗项目ID, NVL(rsTmp!收费细目ID, 0), 4, mlng病人科室id, 0, NVL(rsTmp!医嘱期效, 0), IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                            End If
                            .TextMatrix(i, COL_执行科室ID) = lng成药房ID
                        ElseIf rsTmp!诊疗类别 = "7" Then
                            If lng中药房ID = 0 Then
                                lng中药房ID = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsTmp!诊疗类别, rsTmp!诊疗项目ID, NVL(rsTmp!收费细目ID, 0), 4, mlng病人科室id, 0, NVL(rsTmp!医嘱期效, 0), IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                            End If
                            .TextMatrix(i, COL_执行科室ID) = lng中药房ID
                        ElseIf rsTmp!诊疗类别 = "4" Then
                            If lng发料部门ID = 0 Then
                                lng发料部门ID = Get收费执行科室ID(mlng病人ID, mlng主页ID, rsTmp!诊疗类别, NVL(rsTmp!收费细目ID, 0), 4, mlng病人科室id, lng开嘱科室ID, IIF(mlng病人性质 = 1, 1, 2), , 1, , 2)
                            End If
                            .TextMatrix(i, COL_执行科室ID) = lng发料部门ID
                        ElseIf rsTmp!诊疗类别 <> "*" Then
                            .TextMatrix(i, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, rsTmp!诊疗类别, _
                                NVL(rsTmp!诊疗项目ID, 0), 0, NVL(rsTmp!执行性质, 0), mlng病人科室id, lng开嘱科室ID, NVL(rsTmp!医嘱期效, 0), IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                        End If
                    End If
                End If
                .TextMatrix(i, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(i, COL_执行科室ID)), "名称")
                If rsTmp!诊疗类别 = "E" Then
                    If NVL(rsTmp!相关ID, 0) = 0 And Val(.TextMatrix(i - 1, COL_相关ID)) = -1 * rsTmp!ID Then
                        If InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                            '当前记录是成药的给药途径,可能是一并给药的
                            For j = i - 1 To .FixedRows Step -1
                                If Val(.TextMatrix(j, COL_相关ID)) = -1 * rsTmp!ID Then
                                    '显示给药途径
                                    .TextMatrix(j, COL_用法) = rsTmp!名称 & rsTmp!医生嘱托
                                    '显示成药的执行性质
                                    If Val(.TextMatrix(j, COL_执行性质)) = 5 And Val(.TextMatrix(i, COL_执行性质)) <> 5 Then
                                        If Val(.TextMatrix(j, COL_执行标记)) = 2 Then
                                            .TextMatrix(j, COL_医嘱执行性质) = "不取药"
                                        Else
                                            .TextMatrix(j, COL_医嘱执行性质) = "自备药"
                                        End If
                                    ElseIf Val(.TextMatrix(j, COL_执行性质)) <> 5 And Val(.TextMatrix(i, COL_执行性质)) = 5 Then
                                        .TextMatrix(j, COL_医嘱执行性质) = "离院带药"
                                    Else
                                        .TextMatrix(j, COL_医嘱执行性质) = IIF(Val(.TextMatrix(j, COL_执行标记)) = 1, "自取药", "")
                                    End If
                                Else
                                    Exit For
                                End If
                            Next
                        ElseIf InStr(",E,7,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                            '当前记录是中药配方的用法,即配方显示行
                            .TextMatrix(i, COL_用法) = rsTmp!名称
                            .TextMatrix(i, COL_执行科室) = .TextMatrix(i - 2, COL_执行科室)
                            If Val(.TextMatrix(i - 2, COL_执行性质)) = 5 And Val(.TextMatrix(i, COL_执行性质)) <> 5 Then
                                If Val(.TextMatrix(i - 2, COL_执行标记)) = 2 Then
                                    .TextMatrix(i, COL_医嘱执行性质) = "不取药"
                                Else
                                    .TextMatrix(i, COL_医嘱执行性质) = "自备药"
                                End If
                            ElseIf Val(.TextMatrix(i - 2, COL_执行性质)) <> 5 And Val(.TextMatrix(i, COL_执行性质)) = 5 Then
                                .TextMatrix(i, COL_医嘱执行性质) = "离院带药"
                            Else
                                .TextMatrix(i, COL_医嘱执行性质) = IIF(Val(.TextMatrix(i - 2, COL_执行标记)) = 1, "自取药", "")
                            End If
                            bln配方 = True
                        ElseIf .TextMatrix(i - 1, COL_类别) = "C" Then
                            .TextMatrix(i, COL_用法) = rsTmp!名称
                            .TextMatrix(i, COL_执行科室) = .TextMatrix(i - 1, COL_执行科室)
                        End If
                    ElseIf Not IsNull(rsTmp!相关ID) And .TextMatrix(i - 1, COL_类别) = "K" And -1 * NVL(rsTmp!相关ID, 0) = .RowData(i - 1) Then
                        '当前记录是输血途径行
                        .TextMatrix(i - 1, COL_用法) = rsTmp!名称
                        If gbln血库系统 Then
                            If Val(rsTmp!操作类型 & "") = 8 And Val(rsTmp!执行分类 & "") = 1 Then
                                 If .TextMatrix(i - 1, COL_检查方法) <> "1" Then
                                     .TextMatrix(i - 1, COL_检查方法) = "1"
                                 End If
                            End If
                        End If
                    ElseIf Not IsNull(rsTmp!相关ID) Then
                        '当前记录是中药配方煎法行
                        bln配方 = True
                    End If
                ElseIf rsTmp!诊疗类别 = "7" Then
                    bln配方 = True
                End If
                
                '单量
                .TextMatrix(i, COL_单量) = FormatEx(NVL(rsTmp!单次用量), 5)
                '首次用量
                .TextMatrix(i, COL_首次用量) = FormatEx(NVL(rsTmp!首次用量), 5)
                
                If rsTmp!诊疗类别 = "4" Then
                    .TextMatrix(i, COL_单量单位) = NVL(rsTmp!散装单位)
                ElseIf bln配方 And rsTmp!诊疗类别 <> 7 Then
                    .TextMatrix(i, COL_单量单位) = ""
                Else
                    If NVL(rsTmp!医嘱期效, 0) = 0 Then
                        If InStr(",5,6,7,", rsTmp!诊疗类别) > 0 Or InStr(",1,2,", NVL(rsTmp!计算方式, 0)) > 0 Then
                            .TextMatrix(i, COL_单量单位) = NVL(rsTmp!计算单位)
                        End If
                    Else
                        If InStr(",5,6,7,", rsTmp!诊疗类别) > 0 Or (.TextMatrix(i, COL_频率性质) = 0 And InStr(",1,2,", NVL(rsTmp!计算方式, 0)) > 0) Then
                            .TextMatrix(i, COL_单量单位) = NVL(rsTmp!计算单位)
                        End If
                    End If
                End If
                
                '天数
                If mbln天数 Then
                    .TextMatrix(i, COL_天数) = NVL(rsTmp!天数)
                End If

                '总量
                If InStr(",5,6,", rsTmp!诊疗类别) > 0 Then
                    '成药临嘱有总量,以零售单位存放,住院单位显示
                    If Not IsNull(rsTmp!总给予量) And Not IsNull(rsTmp!住院包装) Then
                        .TextMatrix(i, COL_总量) = FormatEx(rsTmp!总给予量 / rsTmp!住院包装, 5)
                    End If
                    If NVL(rsTmp!医嘱期效, 0) = 1 Then .TextMatrix(i, COL_总量单位) = NVL(rsTmp!住院单位)
                    If Val(.TextMatrix(i, COL_可否分零)) = 0 And Not bln药品小数输入 And InStr(.TextMatrix(i, COL_总量), ".") > 0 Then
                        .TextMatrix(i, COL_总量) = IntEx(Val(.TextMatrix(i, COL_总量)))
                    End If
                Else
                    '其它情况有中药和其它临嘱
                    If Not IsNull(rsTmp!总给予量) Then
                        .TextMatrix(i, COL_总量) = FormatEx(rsTmp!总给予量, 5)
                    End If
                    If bln配方 Then
                        .TextMatrix(i, COL_总量单位) = "付" '中药配方总量单位为"付"
                    ElseIf NVL(rsTmp!医嘱期效, 0) = 1 Then
                        If rsTmp!诊疗类别 = "4" Then
                            .TextMatrix(i, COL_总量单位) = NVL(rsTmp!散装单位)
                        Else
                            .TextMatrix(i, COL_总量单位) = NVL(rsTmp!计算单位)
                        End If
                    End If
                End If
                
                '抗菌药物缺省用药目的
                If Val(.TextMatrix(i, COL_抗菌等级)) > 0 Then .TextMatrix(i, COL_用药目的) = mstrPurMed
                
                '连续用药
                If InStr(",5,6,", rsTmp!诊疗类别) > 0 Then
                    If Set药品连续用药(mlng病人ID, mlng主页ID, Val(.TextMatrix(i, COL_诊疗项目ID)), Val(.TextMatrix(i, COL_收费细目ID))) Then
                        .TextMatrix(i, COL_皮试结果) = "连续用药"
                        .Cell(flexcpData, i, COL_皮试结果) = "连续用药"
                    End If
                End If
                
                .TextMatrix(i, COL_开嘱医生) = str开嘱医生
                .TextMatrix(i, COL_开嘱科室ID) = lng开嘱科室ID
                                
                '紧急标志
                If IsDate(.Cell(flexcpData, i, COL_开始时间)) Then
                    If DateDiff("n", CDate(.Cell(flexcpData, i, COL_开始时间)), curDate) > gint补录间隔 _
                        Or mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                        .TextMatrix(i, COL_标志) = 2
                    Else
                        .TextMatrix(i, COL_标志) = chk紧急.value
                    End If
                End If
                                
                .TextMatrix(i, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, i, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                .TextMatrix(i, COL_校对护士) = ""
                
                If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And (.TextMatrix(i, COL_标志) <> "1" Or .TextMatrix(i, COL_期效) = "长嘱") _
                    Or gbln手术分级管理 And (.TextMatrix(i, COL_类别) = "F" Or .TextMatrix(i, COL_类别) = "G") Then

                    .TextMatrix(i, COL_审核状态) = 1
               
                End If
                
           
                
                '处理输血医嘱审核状态
                If .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "8" And Val(.TextMatrix(i, COL_相关ID)) <> 0 Then
                    strSQL = ""
                    strSQL = GetBloodState(IIF(.TextMatrix(i, COL_标志) = "1", 1, 0), Val(.TextMatrix(i, COL_执行分类)))
                    .TextMatrix(i - 1, COL_审核状态) = strSQL
                    .TextMatrix(i, COL_审核状态) = strSQL
                End If
                
                Call SetRow标志图标(i, 1)
                
                '毒麻精药品标识:中药配方及组成味中药不处理
                If InStr(",5,6,", rsTmp!诊疗类别) > 0 And Not IsNull(rsTmp!毒理分类) Then
                    If InStr(",麻醉药,毒性药,精神药,精神I类,精神II类,", rsTmp!毒理分类) > 0 Then
                        .Cell(flexcpFontBold, i, col_医嘱内容) = True
                    End If
                End If
                
                lngEnd = i
                intCount = intCount + 1
                
                rsTmp.MoveNext
            Next
            
            '显示/隐藏行
            lngRow = 0
            For i = lngBegin To lngEnd
                blnDoIt = False
                If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                    If Val(.TextMatrix(i - 1, COL_相关ID)) = .RowData(i) _
                        And InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                        blnDoIt = True
                    End If
                End If
                If InStr(",F,G,D,7,E,C,", .TextMatrix(i, COL_类别)) > 0 _
                    And Val(.TextMatrix(i, COL_相关ID)) <> 0 Then
                    blnDoIt = True
                End If
                                
                .RowHidden(i) = blnDoIt
                If Not blnDoIt And lngRow = 0 Then lngRow = i
                
                '处理医嘱内容的变化
                If Not .RowHidden(i) Then
                    If Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                        .TextMatrix(i, col_医嘱内容) = AdviceTextMake(i)
                    End If
                End If
                
                '预先计算诊疗单价
                If Not .RowHidden(i) And .TextMatrix(i, COL_单价) = "" Then
                    .TextMatrix(i, COL_单价) = GetItemPrice(i)
                End If
                
                '产生新嘱时，在可见行读取诊疗项目附项串，用于检查，不用于保存
                If Not .RowHidden(i) Then
                    If Not RowIn配方行(i) Then
                        If RowIn检验行(i) Then
                            j = .FindRow(CStr(.RowData(i)), , COL_相关ID)
                            If j <> -1 Then
                                .TextMatrix(i, COL_附项) = Get医嘱项目附件(Val(.TextMatrix(j, COL_诊疗项目ID)))
                            End If
                        Else
                            .TextMatrix(i, COL_附项) = Get医嘱项目附件(Val(.TextMatrix(i, COL_诊疗项目ID)))
                        End If
                        If .TextMatrix(i, COL_附项) <> "" Then
                            str附项 = str附项 & vbCrLf & "●" & .TextMatrix(i, col_医嘱内容)
                        End If
                    End If
                End If
            Next
            
            '调整医嘱的期效同时处理超量问题 AdviceAlterType中已处理超量
            If strAlter <> "" Then
                For i = lngBegin To lngEnd
                    dbl相关ID = -1 * Val(.TextMatrix(i, COL_相关ID))
                    If dbl相关ID = 0 Then dbl相关ID = -1 * .RowData(i)
                    If InStr("," & strAlter & ",", "," & CLng(dbl相关ID) & ",") > 0 Then
                        blnDoIt = True
                        If .RowHidden(i) Then blnDoIt = False
                        If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                            If Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(i - 1, COL_相关ID)) Then
                                blnDoIt = False
                            End If
                        End If
                        If blnDoIt Then Call AdviceAlterType(i)
                    End If
                Next
            End If

            '产生假医嘱ID
            For i = lngBegin To lngEnd
                dbl相关ID = .RowData(i)
                .RowData(i) = GetNext医嘱ID
                For j = i - 1 To lngBegin Step -1
                    If Val(.TextMatrix(j, COL_相关ID)) = dbl相关ID Then
                        .TextMatrix(j, COL_相关ID) = .RowData(i)
                    Else
                        Exit For
                    End If
                Next
                For j = i + 1 To lngEnd
                    If Val(.TextMatrix(j, COL_相关ID)) = dbl相关ID Then
                        .TextMatrix(j, COL_相关ID) = .RowData(i)
                    Else
                        Exit For
                    End If
                Next
            Next
            '---产生申请序号
            If gblnIn必用 Then Call MakeAppNo(2, lngBegin, lngEnd)
            
            '一并给药的符号标志
            For i = lngBegin To lngEnd
                If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                    If Val(.TextMatrix(i - 1, COL_相关ID)) = .RowData(i) And InStr(",5,6,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                        Call SetTag一并给药(i - 1)
                    End If
                End If
            Next
            
            Call Set医嘱超量(lngBegin, lngEnd)
            '调整受影响行的序号
            Call AdviceSet医嘱序号(lngEnd + 1, intCount)
                        
             '路径病人添加医嘱时检查是否是路径内项目
            If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngBegin, lngEnd)
            
            '图标对齐:设置为中对齐,不然擦边框时可能有问题
            .Cell(flexcpPictureAlignment, .FixedRows, 0, .Rows - 1, .FixedCols - 1) = 4
            
            .Row = lngRow: .Col = col_医嘱内容
            
            Call .AutoSize(col_医嘱内容)
            .Redraw = flexRDDirect
        End With
        mblnRowChange = True
        mblnNoSave = True '标记为未保存
    End If
     
    Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)

    Screen.MousePointer = 0
    
    If str附项 <> "" Then
        MsgBox "以下医嘱需要填写申请附项，请注意填写：" & vbCrLf & str附项, vbInformation, gstrSysName
    End If
    
    If str高危药品 <> "" Then
        MsgBox "以下医嘱是高危药品：" & str高危药品, vbInformation, gstrSysName
    End If
    Exit Sub
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function Check单独应用(ByVal lngRow As Long, ByRef strMsg As String) As Boolean
    '检查是否有医嘱的诊疗项目未勾选“可以单独应用”，未勾选的不允许复制。
    With vsAdvice
        If Not (InStr(",4,5,6,7,G,", .TextMatrix(lngRow, COL_类别)) > 0) Then
            If Not (.TextMatrix(lngRow, COL_类别) = "E" And InStr(",2,3,4,6,7,8,9,", .TextMatrix(lngRow, COL_操作类型)) > 0) Then
                If Val(.TextMatrix(lngRow, COL_单独应用)) = 0 And Val(.TextMatrix(lngRow, COL_诊疗项目ID)) <> 0 Then
                    If Val(.TextMatrix(lngRow, COL_申请序号)) = 0 Then
                        strMsg = "”对应的诊疗项目不能单独应用！"
                        Check单独应用 = False
                        Exit Function
                    End If
                End If
            End If
        End If
    End With
    Check单独应用 = True
End Function

Private Function Check开始时间(ByVal strStart As String, ByVal strEnd As String, _
    Optional ByVal blnMsg As Boolean = True, Optional strMsg As String, Optional lngRow As Long, Optional ByVal byt类别 As Byte) As Boolean
'功能：检查输入的开始时间是否合法
'说明：
'1.开始时间不能小于病人的入院时间
'2.开始时间不能小于病人的转科时间
'3.开始时间必须小于终止时间
'4.正常录入时,开始时间不能小于当前时间之前30分钟(从而可能造成开嘱时间大于开始时间30分钟)
'5.补录的医嘱开始时间不能大于当前时间，转科补录不能大于转科开始时间
'参数：lngRow=当前医嘱行号
'      byt类别 医嘱类别，1=护理等级医嘱,2=采集医嘱
    Dim strInDate As String, blnOut As Boolean
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim strTmp As String
        
    If byt类别 = 2 Then
        strTmp = "采集时间"
    Else
        strTmp = "生效时间"
    End If
    If Not IsDate(strStart) Then
        MsgBox "输入的医嘱" & strTmp & "无效。", vbInformation, gstrSysName
        Exit Function
    End If
    If lbl终止时间.Caption <> "终止时间" Then strEnd = ""
        
    strInDate = Format(lvwPati.SelectedItem.ListSubItems(Itag_入院日期).Tag, "yyyy-MM-dd HH:mm")
    If Format(strStart, "yyyy-MM-dd HH:mm") < Format(lvwPati.SelectedItem.ListSubItems(Itag_入院日期).Tag, "yyyy-MM-dd HH:mm") Then
        strMsg = "医嘱的" & strTmp & "不能小于病人的入院时间 " & Format(lvwPati.SelectedItem.ListSubItems(Itag_入院日期).Tag, "yyyy-MM-dd HH:mm") & " 。"
        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
        Exit Function
    End If
    
    strInDate = ""
    If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
        strInDate = Format(mdatTurn, "yyyy-MM-dd HH:mm")
    ElseIf IsDate(lvwPati.SelectedItem.ListSubItems(Itag_转科时间).Tag) Then
        strInDate = Format(lvwPati.SelectedItem.ListSubItems(Itag_转科时间).Tag, "yyyy-MM-dd HH:mm")
    End If
    If strInDate <> "" Then
        If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
            If Format(strStart, "yyyy-MM-dd HH:mm") >= strInDate Then
                strMsg = "医嘱的" & strTmp & "应小于病人" & IIF(mintPState = ps最近转出, "转出", IIF(mintPState = ps预出, "预出院", "出院")) & "的时间 " & strInDate & " 。"
                If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
                Exit Function
            End If
        Else
            If Format(strStart, "yyyy-MM-dd HH:mm") < strInDate Then
                strMsg = "医嘱的" & strTmp & "不能小于病人最近的转科时间 " & strInDate & " 。"
                If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
                Exit Function
            End If
        End If
    End If
    
    If IsDate(strEnd) Then
        If Format(strStart, "yyyy-MM-dd HH:mm") >= Format(strEnd, "yyyy-MM-dd HH:mm") Then
            strMsg = "医嘱的" & strTmp & "必须小于执行终止时间。"
            If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    '生成路径时检查开始时间
    If mbytUseType = 1 And lngRow <> 0 Then
        '出院医嘱允许修改为大于当前时间(但不能超过本阶段的最大时间，此点暂不限制）
        If vsAdvice.TextMatrix(lngRow, COL_类别) = "Z" And Val(vsAdvice.TextMatrix(lngRow, COL_操作类型)) = 5 Then
            blnOut = True
        End If
        
        If blnOut Then
            If CDate(strStart) < Format(mdatSendTime, "YYYY-MM-DD HH:mm") Then
                strMsg = "出院医嘱的" & strTmp & "不能小于路径生成时间。"
                If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
                Exit Function
            End If
        ElseIf Format(mdatSendTime, "YYYY-MM-DD") > Format(strStart, "YYYY-MM-DD") Or Format(strStart, "YYYY-MM-DD") > Format(mdatSendTime + mlng路径医嘱天数, "YYYY-MM-DD") Then
            strMsg = "临床路径的医嘱必须在当前日期和提前的天数之间，当前允许提前" & mlng路径医嘱天数 & "天。"
            If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
                Exit Function
        End If
    End If
    
    '添加路径外项目
    If mbytUseType = 2 Then
        '添加路径外项目时，如果当天还没有生成路径，医嘱的开始时间不能大于最后一次生成路径的时间
        If mdat开始时间 < CDate(Format(mdatCurr, "YYYY-MM-DD")) And mdat开始时间 <> CDate(0) Then
            If CDate(Format(strStart, "YYYY-MM-DD")) > mdat开始时间 Then
                strMsg = "医嘱的开始日期不能大于最近一次路径生成日期(" & Format(mdat开始时间, "YYYY-MM-DD") & ")。"
                If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
                Exit Function
            End If
        ElseIf Format(strStart, "YYYY-MM-DD") < Format(mrsPPati!开始日期 & "", "YYYY-MM-DD") Then
            strMsg = "医嘱的生效日期不能小于路径首次生成日期(" & Format(mrsPPati!开始日期 & "", "YYYY-MM-DD") & ")。" & _
                vbCrLf & "如果想补录首次生成日期之前的医嘱,请按新开医嘱方式补录。"
            If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    If mbytUseType = 0 And mlng路径状态 = 1 Then
        If Val(vsAdvice.TextMatrix(lngRow, COL_路径执行ID)) <> 0 Then
            If Format(strStart, "YYYY-MM-DD") <> Format(vsAdvice.Cell(flexcpData, lngRow, COL_开始时间), "YYYY-MM-DD") Then
                strMsg = "医嘱生效时间的日期值不能修改，因为医嘱对应路径阶段的日期与医嘱生效时间的日期是相同的。"
                If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
                Exit Function
            End If
        End If
    End If
    '如果是护理等级医嘱则开始时间不能小于入科时间，未入科不能下达。
    If byt类别 = 1 Then
        If mint病人状态 = 1 Then
            strMsg = "病人未入科不能下达护理等级医嘱。"
        Else
            On Error GoTo errH
            strSQL = "Select Max(开始时间) as 入科时间 From 病人变动记录 Where 病人id = [1] And 主页id = [2] And 开始原因 In (1, 2)"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
            If rsTmp.RecordCount = 1 Then
                If Format(rsTmp!入科时间, "yyyy-MM-dd HH:mm") > Format(strStart, "yyyy-MM-dd HH:mm") Then
                    strMsg = "护理等级医嘱的" & strTmp & "不能小于病人入科时间 " & rsTmp!入科时间 & " 。"
                End If
            End If
        End If
        If strMsg <> "" Then
            If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If

    '用血医嘱的生效时间检查
    If gbln血库系统 Then
        If vsAdvice.TextMatrix(lngRow, COL_类别) = "K" And Val(vsAdvice.TextMatrix(lngRow, COL_检查方法)) = 1 Then
            If mstr备血医嘱时间 = "" Then
                strSQL = "select to_char(a.开始执行时间, 'yyyy-MM-dd HH24:MI:SS') as 开始执行时间 from 病人医嘱记录 a,诊疗项目目录 b" & vbNewLine & _
                    "where a.病人id=[1] and a.主页id=[2] and nvl(a.婴儿,0)=[3] and nvl(a.医嘱状态,0)<>4 and a.诊疗类别='E' and a.相关id is not null and (b.操作类型='8' and nvl(b.执行分类,0)=0 or b.操作类型='9')" & vbNewLine & _
                    "order by a.开始执行时间"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, Val(vsAdvice.TextMatrix(lngRow, COL_婴儿)))
                If Not rsTmp.BOF Then
                    mstr备血医嘱时间 = rsTmp!开始执行时间 & ""
                Else
                    mstr备血医嘱时间 = "1111-11-11 00:00:00"
                End If
            End If
            If mstr备血医嘱时间 > Format(strStart, "yyyy-MM-dd HH:mm:ss") Then
                strMsg = "用血医嘱的" & strTmp & "不能小于备血医嘱的生效时间。"
            End If
            If strMsg <> "" Then
                If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
                Exit Function
            End If
        End If
    End If
    
    Check开始时间 = True
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function Check安排时间(ByVal strDate As String, ByVal strStart As String, ByVal strType As String, Optional ByVal blnMsg As Boolean = True, Optional strMsg As String) As Boolean
'功能：检查输入的手术/输血时间是否合法
'说明：
'1.手术/输血时间不能小于医嘱的开始时间
    Dim strInDate As String, strDateType As String
    
    If strType = "F" Then
        strDateType = "手术"
    ElseIf strType = "K" Then
        strDateType = "输血"
    End If
    
    If Not IsDate(strDate) Then
        strMsg = "输入的" & strDateType & "时间无效。"
        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
        Exit Function
    ElseIf IsDate(strStart) Then
        If Format(strDate, "yyyy-MM-dd HH:mm") < Format(strStart, "yyyy-MM-dd HH:mm") Then
            strMsg = strDateType & "时间不能小于医嘱开始时间。"
            If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    Check安排时间 = True
End Function

Private Function Check终止时间(ByVal strWrite As String, ByVal strStart As String, ByVal strEnd As String, _
    Optional ByVal blnMsg As Boolean = True, Optional strMsg As String) As Boolean
'功能：检查输入的终止时间是否合法
'说明：
'1.终止时间必须大于开始时间,开嘱时间
'2.##如果有频率,长嘱终止时间至少应该在一个频率周期之后
    If Not IsDate(strEnd) Then
        strMsg = "输入的医嘱执行终止时间无效。"
        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
        Exit Function
    End If

    If IsDate(strStart) Then
        If Format(strEnd, "yyyy-MM-dd HH:mm") <= Format(strStart, "yyyy-MM-dd HH:mm") Then
            strMsg = "医嘱的执行终止时间必须大于开始执行时间。"
            If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If

    Check终止时间 = True
End Function

Private Function Check配伍禁忌(ByVal str药品IDs As String) As Boolean
'功能：检查西成药,中成药的配伍禁忌;中药配方不在这里检查
'参数：str药品IDs="1,2,3,..."
    Dim rsTmp As New ADODB.Recordset
    Dim rsMain As New ADODB.Recordset
    Dim strSQL As String, i As Long, j As Long, k As Long
    Dim arr慎用 As Variant, arr禁用 As Variant
    Dim arrItems As Variant, strMsg As String, strTmp As String
    Dim lng项目id As Long, str名称 As String, bln未编辑 As Boolean
    Dim lng组编号 As Long, lngRow As Long, lngSeekRow As Long
    Dim n As Long, p As Long
    Dim varPar(0 To 10) As String
    Dim strThis As String, strSQL药品 As String
    
    On Error GoTo errH
    
    arr慎用 = Array(): arr禁用 = Array()
    
    strTmp = "Select Column_Value As 药品ID From Table(f_Num2list([2]))"
    n = 0
    Do While True
        If Len(str药品IDs) < 4000 Then
            p = Len(str药品IDs) + 1
        Else
            p = InStrRev(Mid(str药品IDs, 1, 4000), ",")
        End If
        strThis = Mid(str药品IDs, 1, p - 1)
        
        If n > 10 Then
            strSQL药品 = strSQL药品 & vbNewLine & " Union All " & Replace(strTmp, "[2]", "'" & strThis & "'")
        Else
            varPar(n) = strThis
            strSQL药品 = IIF(strSQL药品 = "", "", strSQL药品 & vbNewLine & " Union All ") & Replace(strTmp, "[2]", "[" & (n + 2) & "]")
        End If
        
        n = n + 1
        str药品IDs = Mid(str药品IDs, p + 1)
        If str药品IDs = "" Then Exit Do
    Loop
    
    strSQL = "Select /*+ rule*/ 组编号 From 诊疗互斥项目" & _
        " Where 项目ID IN(" & strSQL药品 & ") Group by 组编号 Having Count(*)>1"
    Set rsMain = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, "", varPar(0), varPar(1), varPar(2), varPar(3), varPar(4), varPar(5), varPar(6), varPar(7), varPar(8), varPar(9), varPar(10))
    For k = 1 To rsMain.RecordCount
        strSQL = "Select /*+ RULE */ A.组编号,A.类型,A.项目ID,B.名称" & _
            " From 诊疗互斥项目 A,诊疗项目目录 B" & _
            " Where A.项目ID=B.ID And A.组编号=[1]" & _
            " And A.项目ID IN(" & strSQL药品 & ")" & _
            " Order by A.组编号,B.编码"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsMain!组编号), varPar(0), varPar(1), varPar(2), varPar(3), varPar(4), varPar(5), varPar(6), varPar(7), varPar(8), varPar(9), varPar(10))
        For i = 1 To rsTmp.RecordCount
            If rsTmp!组编号 <> lng组编号 Then
                If rsTmp!类型 = 1 Then
                    ReDim Preserve arr慎用(UBound(arr慎用) + 1)
                Else
                    ReDim Preserve arr禁用(UBound(arr禁用) + 1)
                End If
                lng组编号 = rsTmp!组编号
            End If
            If rsTmp!类型 = 1 Then
                arr慎用(UBound(arr慎用)) = arr慎用(UBound(arr慎用)) & Chr(234) & rsTmp!项目ID & Chr(8) & rsTmp!名称
            Else
                arr禁用(UBound(arr禁用)) = arr禁用(UBound(arr禁用)) & Chr(234) & rsTmp!项目ID & Chr(8) & rsTmp!名称
            End If
            rsTmp.MoveNext
        Next
        rsMain.MoveNext
    Next
    
    '先检查禁用部份(禁止继续)
    If UBound(arr禁用) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr禁用) '每组
            strTmp = "": bln未编辑 = True
            arrItems = Split(Mid(arr禁用(i), 2), Chr(234))
            For j = 0 To UBound(arrItems) '每项目
                lng项目id = Split(arrItems(j), Chr(8))(0)
                str名称 = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & "，" & str名称
                
                '为了定位,在医嘱中查找本次新增或修改的该项目(可能有多个)所在行
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lng项目id), lngRow + 1, COL_诊疗项目ID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '编辑过的最小行优先定位
                        bln未编辑 = False: Exit Do
                    End If
                Loop
            Next
            If Not bln未编辑 Then '如果一组中的项目在本次都未编辑过,则不管
                strMsg = strMsg & vbCrLf & "● " & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            MsgBox "在病人医嘱中发现以下药品互相禁用：" & strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    '再检查慎用部份(提醒是否继续)
    If UBound(arr慎用) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr慎用) '每组
            strTmp = "": bln未编辑 = True
            arrItems = Split(Mid(arr慎用(i), 2), Chr(234))
            For j = 0 To UBound(arrItems) '每项目
                lng项目id = Split(arrItems(j), Chr(8))(0)
                str名称 = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & "，" & str名称
                
                '为了定位,在医嘱中查找本次新增或修改的该项目(可能有多个)所在行
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lng项目id), lngRow + 1, COL_诊疗项目ID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '编辑过的最小行优先定位
                        bln未编辑 = False: Exit Do
                    End If
                Loop
            Next
            If Not bln未编辑 Then '如果一组中的项目在本次都未编辑过,则不管
                strMsg = strMsg & vbCrLf & "● " & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            If MsgBox("在病人医嘱中发现以下药品互相慎用：" & strMsg & vbCrLf & vbCrLf & "要继续吗？", _
                vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                Exit Function
            End If
        End If
    End If
    
    Check配伍禁忌 = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function Check诊疗互斥(ByVal str诊疗IDs As String) As Boolean
'功能：检查非药品(成药,中药)的互斥
'参数：str诊疗IDs="1,2,3,..."
    Dim rsTmp As New ADODB.Recordset
    Dim rsMain As New ADODB.Recordset
    Dim strSQL As String, i As Long, j As Long, k As Long
    Dim arr提醒 As Variant, arr禁止 As Variant, arr停止 As Variant
    Dim arrItems As Variant, strMsg As String, strTmp As String
    Dim lng项目id As Long, str名称 As String, bln未编辑 As Boolean
    Dim lng组编号 As Long, lngRow As Long, lngSeekRow As Long
    Dim bln临嘱 As Boolean
    Dim n As Long, p As Long
    Dim varPar(0 To 10) As String
    Dim strThis As String, strSQL诊疗 As String
    
    On Error GoTo errH
        
    arr提醒 = Array(): arr禁止 = Array(): arr停止 = Array()
    
    strTmp = "Select Column_Value As 诊疗ID From Table(f_Num2list([2]))"
    n = 0
    Do While True
        If Len(str诊疗IDs) < 4000 Then
            p = Len(str诊疗IDs) + 1
        Else
            p = InStrRev(Mid(str诊疗IDs, 1, 4000), ",")
        End If
        strThis = Mid(str诊疗IDs, 1, p - 1)
        
        If n > 10 Then
            strSQL诊疗 = strSQL诊疗 & vbNewLine & " Union All " & Replace(strTmp, "[2]", "'" & strThis & "'")
        Else
            varPar(n) = strThis
            strSQL诊疗 = IIF(strSQL诊疗 = "", "", strSQL诊疗 & vbNewLine & " Union All ") & Replace(strTmp, "[2]", "[" & (n + 2) & "]")
        End If
        
        n = n + 1
        str诊疗IDs = Mid(str诊疗IDs, p + 1)
        If str诊疗IDs = "" Then Exit Do
    Loop
    
    strSQL = "Select /*+ rule*/ 组编号 From 诊疗互斥项目" & _
        " Where 项目ID IN(" & strSQL诊疗 & ") Group by 组编号 Having Count(*)>1"
    Set rsMain = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, "", varPar(0), varPar(1), varPar(2), varPar(3), varPar(4), varPar(5), varPar(6), varPar(7), varPar(8), varPar(9), varPar(10))
    For k = 1 To rsMain.RecordCount
        strSQL = "Select /*+ RULE */ A.组编号,A.组名称,A.类型,A.项目ID,B.名称" & _
            " From 诊疗互斥项目 A,诊疗项目目录 B" & _
            " Where A.项目ID=B.ID And A.组编号=[1]" & _
            " And A.项目ID IN(" & strSQL诊疗 & ")" & _
            " Order by A.组编号,B.编码"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsMain!组编号), varPar(0), varPar(1), varPar(2), varPar(3), varPar(4), varPar(5), varPar(6), varPar(7), varPar(8), varPar(9), varPar(10))
        For i = 1 To rsTmp.RecordCount
            If rsTmp!组编号 <> lng组编号 Then
                If rsTmp!类型 = 1 Then
                    ReDim Preserve arr提醒(UBound(arr提醒) + 1)
                    arr提醒(UBound(arr提醒)) = rsTmp!组名称
                ElseIf rsTmp!类型 = 2 Then
                    ReDim Preserve arr禁止(UBound(arr禁止) + 1)
                    arr禁止(UBound(arr禁止)) = rsTmp!组名称
                Else
                    ReDim Preserve arr停止(UBound(arr停止) + 1)
                    arr停止(UBound(arr停止)) = rsTmp!组名称
                End If
                lng组编号 = rsTmp!组编号
            End If
            If rsTmp!类型 = 1 Then
                arr提醒(UBound(arr提醒)) = arr提醒(UBound(arr提醒)) & Chr(234) & rsTmp!项目ID & Chr(8) & rsTmp!名称
            ElseIf rsTmp!类型 = 2 Then
                arr禁止(UBound(arr禁止)) = arr禁止(UBound(arr禁止)) & Chr(234) & rsTmp!项目ID & Chr(8) & rsTmp!名称
            Else
                arr停止(UBound(arr停止)) = arr停止(UBound(arr停止)) & Chr(234) & rsTmp!项目ID & Chr(8) & rsTmp!名称
            End If
            rsTmp.MoveNext
        Next
        rsMain.MoveNext
    Next
    
    '先检查禁止继续部份
    If UBound(arr禁止) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr禁止) '每组
            strTmp = "": bln未编辑 = True
            arrItems = Split(arr禁止(i), Chr(234))
            For j = 1 To UBound(arrItems) '每项目
                lng项目id = Split(arrItems(j), Chr(8))(0)
                str名称 = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & vbCrLf & vbTab & str名称
                
                '为了定位,在医嘱中查找本次新增或修改的该项目(可能有多个)所在行
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lng项目id), lngRow + 1, COL_诊疗项目ID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then 'bln已校对,COL_状态
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '编辑过的最小行优先定位
                        bln未编辑 = False: Exit Do
                    End If
                Loop
            Next
            If Not bln未编辑 Then '如果一组中的项目在本次都未编辑过,则不管
                strMsg = strMsg & vbCrLf & vbCrLf & arrItems(0) & "：" & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            MsgBox "在病人医嘱中发现以下内容互相排斥：" & strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    '再检查自动停止部份,如果在一组中包含临嘱则禁止,否则在校对时自动停止
    If UBound(arr停止) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr停止) '每组
            strTmp = "": bln未编辑 = True: bln临嘱 = False
            arrItems = Split(arr停止(i), Chr(234))
            For j = 1 To UBound(arrItems) '每项目
                lng项目id = Split(arrItems(j), Chr(8))(0)
                str名称 = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & vbCrLf & vbTab & str名称
                
                '为了定位,在医嘱中查找本次新增或修改的该项目(可能有多个)所在行
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lng项目id), lngRow + 1, COL_诊疗项目ID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '编辑过的最小行优先定位
                        bln未编辑 = False ': Exit Do
                    End If
                    If vsAdvice.TextMatrix(lngRow, COL_期效) = "临嘱" Then bln临嘱 = True
                Loop
            Next
            If Not bln未编辑 Then '如果一组中的项目在本次都未编辑过,则不管
                If bln临嘱 Then '包含临嘱项时,在程序中就禁止了。
                    strMsg = strMsg & vbCrLf & vbCrLf & arrItems(0) & "：" & Mid(strTmp, 2)
                End If
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            MsgBox "在病人医嘱中发现以下内容互相排斥：" & strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    '再检查提醒是否继续部份
    If UBound(arr提醒) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr提醒) '每组
            strTmp = "": bln未编辑 = True
            arrItems = Split(arr提醒(i), Chr(234))
            For j = 1 To UBound(arrItems) '每项目
                lng项目id = Split(arrItems(j), Chr(8))(0)
                str名称 = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & vbCrLf & vbTab & str名称
                
                '为了定位,在医嘱中查找本次新增或修改的该项目(可能有多个)所在行
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lng项目id), lngRow + 1, COL_诊疗项目ID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '编辑过的最小行优先定位
                        bln未编辑 = False: Exit Do
                    End If
                Loop
            Next
            If Not bln未编辑 Then '如果一组中的项目在本次都未编辑过,则不管
                strMsg = strMsg & vbCrLf & vbCrLf & arrItems(0) & "：" & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_医嘱内容: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            If MsgBox("在病人医嘱中发现以下内容互相排斥：" & strMsg & vbCrLf & vbCrLf & "要继续吗？", _
                vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                Exit Function
            End If
        End If
    End If
    
    Check诊疗互斥 = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function CheckStock(ByVal lngRow As Long) As String
'功能：检查指定药品行的库存情况
'返回：空=表示通过
    Dim dbl总量 As Double, strMsg As String
    Dim lng执行科室ID As Long, i As Integer
    
    With vsAdvice
        If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Or .TextMatrix(lngRow, COL_类别) = "4" And Val(.TextMatrix(lngRow, COL_跟踪在用)) = 1 Then
            If TheStockCheck(Val(.TextMatrix(lngRow, COL_执行科室ID)), .TextMatrix(lngRow, COL_类别)) <> 0 Then
                If .TextMatrix(lngRow, COL_期效) = "临嘱" And .TextMatrix(lngRow, COL_库存) <> "" Then
                    '成药临嘱直接检查总量
                    dbl总量 = Val(.TextMatrix(lngRow, COL_总量))
                    If dbl总量 > 0 Then
                        If dbl总量 > Val(.TextMatrix(lngRow, COL_库存)) Then
                            strMsg = """" & .TextMatrix(lngRow, col_医嘱内容) & """库存提醒：" & _
                                vbCrLf & vbCrLf & Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称") & _
                                IIF(InStr(GetInsidePrivs(p住院医嘱下达), "显示药品库存") = 0, _
                                    "当前可用库存不足 " & FormatEx(dbl总量, 5) & .TextMatrix(lngRow, COL_住院单位) & "。", _
                                    "当前可用库存为 " & FormatEx(Val(.TextMatrix(lngRow, COL_库存)), 5) & _
                                    .TextMatrix(lngRow, COL_住院单位) & "，不足 " & FormatEx(dbl总量, 5) & .TextMatrix(lngRow, COL_住院单位) & "。")
                        End If
                    End If
                ElseIf Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 And .TextMatrix(lngRow, COL_库存) <> "" Then
                    '成药长嘱(按规格下时)检查一个频率周期的总量
                    If Val(.TextMatrix(lngRow, COL_单量)) <> 0 And .TextMatrix(lngRow, COL_频率) <> "" Then
                        dbl总量 = Calc缺省药品总量(Val(.TextMatrix(lngRow, COL_单量)), 1, _
                            Val(.TextMatrix(lngRow, COL_频率次数)), _
                            Val(.TextMatrix(lngRow, COL_频率间隔)), _
                            .TextMatrix(lngRow, COL_间隔单位), _
                            .TextMatrix(lngRow, COL_执行时间), _
                            Val(.TextMatrix(lngRow, COL_剂量系数)), _
                            Val(.TextMatrix(lngRow, COL_住院包装)), _
                            Val(.TextMatrix(lngRow, COL_可否分零)), _
                            Val(.TextMatrix(lngRow, COL_首次用量)))
                        If dbl总量 > 0 Then
                            If dbl总量 > Val(.TextMatrix(lngRow, COL_库存)) Then
                                strMsg = """" & .TextMatrix(lngRow, col_医嘱内容) & """库存提醒：" & _
                                    vbCrLf & vbCrLf & Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称") & _
                                    IIF(InStr(GetInsidePrivs(p住院医嘱下达), "显示药品库存") = 0, _
                                    "当前可用库存不足一个频率周期所需用量 " & FormatEx(dbl总量, 5) & .TextMatrix(lngRow, COL_住院单位) & "。", _
                                    "当前可用库存为 " & FormatEx(Val(.TextMatrix(lngRow, COL_库存)), 5) & .TextMatrix(lngRow, COL_住院单位) & "，不足一个频率周期所需用量 " & FormatEx(dbl总量, 5) & .TextMatrix(lngRow, COL_住院单位) & "。")
                            End If
                        End If
                    End If
                End If
            End If
        ElseIf RowIn配方行(lngRow) And .TextMatrix(lngRow, COL_期效) = "临嘱" And Val(.TextMatrix(lngRow, COL_总量)) <> 0 Then
            '根据付数计算总量,临嘱要输入付数
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "7" And .TextMatrix(i, COL_库存) <> "" Then
                        '总量=住院包装(单味剂量*付数)
                        '中药药房单位按不可分零处理:每付
                        If Val(.TextMatrix(i, COL_可否分零)) = 0 Then
                            dbl总量 = Val(.TextMatrix(i, COL_总量)) * Val(.TextMatrix(i, COL_单量)) / Val(.TextMatrix(i, COL_剂量系数)) / Val(.TextMatrix(i, COL_住院包装))
                        Else
                            dbl总量 = Val(.TextMatrix(i, COL_总量)) * IntEx(Val(.TextMatrix(i, COL_单量)) / Val(.TextMatrix(i, COL_剂量系数)) / Val(.TextMatrix(i, COL_住院包装)))
                        End If
                        If dbl总量 > Val(.TextMatrix(i, COL_库存)) Then
                            lng执行科室ID = Val(.TextMatrix(i, COL_执行科室ID))
                            If TheStockCheck(lng执行科室ID, .TextMatrix(i, COL_类别)) = 0 Then Exit For
                            
                            strMsg = strMsg & vbCrLf & .TextMatrix(i, col_医嘱内容) & _
                                "：所需总量 " & FormatEx(dbl总量, 5) & .TextMatrix(i, COL_住院单位) & _
                                "，可用库存" & IIF(InStr(GetInsidePrivs(p住院医嘱下达), "显示药品库存") = 0, _
                                    "不足", " " & FormatEx(Val(.TextMatrix(i, COL_库存)), 5) & .TextMatrix(i, COL_住院单位))
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
            If strMsg <> "" Then
                strMsg = "中药配方库存提醒，" & Sys.RowValue("部门表", lng执行科室ID, "名称") & "中以下味药库存不足：" & vbCrLf & strMsg
            End If
        End If
    End With
    CheckStock = strMsg
End Function

Private Function CheckMoney() As Boolean
'功能：费用报警检查
'说明：病区有累计费用报警方式时,只提醒。
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, lng病区ID As Long
    Dim str适用病人 As String, cur余额 As Currency
    Dim cur担保额 As Currency
    
    '费用余额,及适用报警方案
    strSQL = _
        " Select Nvl(预交余额,0)-Nvl(费用余额,0) as 余额 From 病人余额 Where 性质=1 And 病人ID=[1] And 类型 = " & IIF(mlng病人性质 = 1, 1, 2) & _
        " Union ALL " & _
        " Select Sum(金额) as 余额 From 保险模拟结算 A,病案主页 B" & _
        " Where A.病人ID=B.病人ID And A.主页ID=B.主页ID And B.险类 is Not Null And A.病人ID=[1] And A.主页ID=[2]"
    strSQL = "Select Sum(余额) as 余额 From (" & strSQL & ")"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
    If Not rsTmp.EOF Then cur余额 = NVL(rsTmp!余额, 0)
    
    '担保额
    strSQL = "Select Decode(担保额,Null,Null,zl_PatientSurety([1],[2])) as 担保额 From 病人信息 Where 病人ID=[1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
    If Not rsTmp.EOF Then cur担保额 = NVL(rsTmp!担保额, 0)
    
    '适用报警方案
    strSQL = "Select zl_PatiWarnScheme([1],[2]) as 适用病人 From Dual"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
    If Not rsTmp.EOF Then str适用病人 = NVL(rsTmp!适用病人)
        
    '报警值:NULL与0当作不同意义处理
    lng病区ID = GetPatiUnitID(mlng病人ID, mlng主页ID)
    strSQL = "Select 报警值 From 记帐报警线 Where 报警方法=1 And 病区ID=[1] And 报警值 is Not NULL And 适用病人=[2]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng病区ID, str适用病人)
    If Not rsTmp.EOF Then
        If cur余额 + cur担保额 < NVL(rsTmp!报警值, 0) Then
            If MsgBox("病人当前可用剩余款 " & FormatEx(cur余额 + cur担保额, 2) & IIF(cur担保额 <> 0, "(含担保额:" & FormatEx(cur担保额, 2) & ")", "") & " 低于报警值 " & FormatEx(NVL(rsTmp!报警值, 0), 2) & "，要继续吗？", _
                vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                Exit Function
            End If
        End If
    End If
    CheckMoney = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function CheckAdvice(Optional ByVal blnTemp As Boolean) As Boolean
'功能：检查当前病人(婴儿)的医嘱输入是否合法
'说明：如果有不合法的地方，在本函数中提示及定位
    Dim rsTmp As ADODB.Recordset, strSQL As String
    Dim blnValid As Boolean, dMax As Date
    Dim bln配方行 As Boolean, bln检验行 As Boolean, blnCheck开嘱时间 As Boolean
    Dim dbl总量 As Double, strMsg As String, lngRxCount As Long
    Dim str药品IDs As String, str诊疗IDs As String
    Dim lngCount As Long, lngRow As Long, i As Long, j As Long, k As Long, lng路径项目ID As Long
    Dim blnSkipStock As Boolean, blnSkipTotal As Boolean
    Dim vMsg As VbMsgBoxResult, sng天数 As Single
    Dim bln中医 As Boolean, str类型 As String, blnSucceed As Boolean
    Dim bln检查入院诊断 As Boolean, bln检查出院诊断 As Boolean
    Dim blnAppend As Boolean, blnPathAppend As Boolean
    Dim lng主ID  As Long, lngThis主ID As Long
    Dim bln选择 As Boolean  '临床路径是否选择了生成项目
    Dim str中药名 As String, strExtra As String
    Dim lng麻醉诊疗ID As Long, lng给药执行性质 As Long, str部位方法 As String
    Dim lngBegin As Long, lngEnd As Long
    Dim blnExists As Boolean
    Dim dblOneDay As Double
    Dim intEnable As Integer
    Dim strIDs1 As String, strIDs2 As String, str医嘱内容 As String
    Dim bln护理等级医嘱 As Boolean
    Dim blnCheck超量 As Boolean, blnOut As Boolean
    Dim strPathExeDate As String
    Dim dat出院时间 As Date
    Dim str终止原因 As String
    Dim blnTmp As Boolean
    Dim str性别 As String
    Dim str项目IDs As String
    
    If vsAdvice.Enabled = True Then
        If Me.ActiveControl.Name = "txt总量" Then
            Call txt总量_Validate(False)
        ElseIf Me.ActiveControl.Name = "txt单量" Then
            Call txt单量_Validate(False)
        ElseIf Me.ActiveControl.Name = "txt天数" Then
            Call txt天数_Validate(False)
        End If
        vsAdvice.SetFocus  '处理光标定位，如果光标还没离开输入框，则还未更新数据。
    End If

    If mbytUseType = 3 Then
        CheckAdvice = True
        Exit Function    '调整顺序时不检查
    End If
    On Error GoTo errH
    
    '临床路径项目暂不考虑申请方式下达检验检查
    If Not (mbytUseType = 1 Or mbytUseType = 2) Then
        If Not CheckApply Then Exit Function
    End If
    
    If mbytUseType = 0 And mlng路径状态 = 1 Then
        If blnTemp = False Then
            If CheckPathEvalute Then
                MsgBox "该病人当天已进行了评估，不能再添加医嘱。" & vbCrLf & "你可以暂存医嘱，取消评估后再保存。", vbInformation, gstrSysName
                Exit Function
            End If
        End If
        
        If InStr(GetInsidePrivs(p临床路径应用), ";路径外项目;") > 0 Then
            blnPathAppend = True
        Else
            blnPathAppend = False
        End If
    End If
    
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If mbytUseType = 1 And bln选择 = False Then
                If .RowData(i) <> 0 Then
                    If .Cell(flexcpChecked, i, COL_选择) <> 2 Then
                        bln选择 = True
                    End If
                End If
            End If
            '临床路径生成时，检查每天执行的项目是否至少选择了一行医嘱
            If mbytUseType = 1 Then
                If lng路径项目ID <> Val(.TextMatrix(i, COL_路径项目ID)) Then
                    lng路径项目ID = .TextMatrix(i, COL_路径项目ID)
                    If .Cell(flexcpChecked, i, COL_选择) = 2 Then   '相同路径项目的，可能因为自定义的排序导致不是挨着的
                        lng主ID = Val(.TextMatrix(i, COL_相关ID))
                        If lng主ID = 0 Then lng主ID = .RowData(i)
                        For k = .FixedRows To .Rows - 1
                            If lng路径项目ID = .TextMatrix(k, COL_路径项目ID) Then
                                lngThis主ID = Val(.TextMatrix(k, COL_相关ID))
                                If lngThis主ID = 0 Then lngThis主ID = .RowData(k)
                                If lng主ID <> lngThis主ID Then
                                    If .Cell(flexcpChecked, k, COL_选择) = 1 Then k = 0: Exit For
                                End If
                            End If
                        Next
                        If k = .Rows Then
                            strMsg = "是路径项目的一组可选医嘱之一，至少应选择一行。"
                            .Col = COL_选择: Exit For
                        End If
                    End If
                End If
            End If
            
            If mbytUseType = 0 And mlng路径状态 = 1 And blnPathAppend = False Then
                If Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                    If Val(.TextMatrix(i, COL_路径项目ID)) = 0 And Val(.TextMatrix(i, COL_婴儿)) = 0 And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                        strMsg = ",你没有添加路径外项目的权限，请删除黄色背景的医嘱，否则不能执行保存操作。"
                        .Col = col_医嘱内容: Exit For
                    End If
                End If
            End If
            '路径外项目同一批次开始时间必须在同一天才能保存
            If (mbytUseType = 2 Or mbytUseType = 0) And mlng路径状态 = 1 Then
                If Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                    If Val(.TextMatrix(i, COL_路径项目ID)) = 0 And Val(.TextMatrix(i, COL_婴儿)) = 0 And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                        If strPathExeDate = "" Then
                            strPathExeDate = .TextMatrix(i, COL_开始时间)
                        Else
                            If Format(.TextMatrix(i, COL_开始时间), "YYYY-MM-DD") <> Format(strPathExeDate, "YYYY-MM-DD") Then
                                MsgBox "当前新增路径外项目的开始时间不在同一天,不允许保存。", vbInformation + vbOKOnly, gstrSysName
                                Exit Function
                            End If
                        End If
                    End If
                End If
            End If
            
            '本次新增或修改药品行的处方职务检查(路径生成时不检查)
            If .RowData(i) <> 0 And (mbytUseType = 0 Or mbytUseType = 2) _
                And InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                strMsg = CheckOneDuty(.TextMatrix(i, col_医嘱内容), .TextMatrix(i, COL_处方职务), .TextMatrix(i, COL_开嘱医生), InStr(",1,2,", mstr付款码) > 0 And mstr付款码 <> "")
                If strMsg <> "" Then
                    .Col = col_医嘱内容
                    If .TextMatrix(i, COL_类别) = "7" Then
                        lngRow = .FindRow(CLng(.TextMatrix(i, COL_相关ID)), i + 1)
                        If lngRow <> -1 Then .Row = lngRow
                    Else
                        .Row = i
                    End If
                    Call .ShowCell(.Row, .Col)
                    MsgBox strMsg, vbInformation, gstrSysName
                    .Refresh
                    If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
                    Exit Function
                End If
                '药品公共方法调用
                If Val(.TextMatrix(i, COL_收费细目ID)) <> 0 And Val(.TextMatrix(i, COL_执行科室ID)) <> 0 Then
                    If InitObjPublicDrug Then
                        blnTmp = gobjPublicDrug.zlCheckPriceAdjustBySell(Val(.TextMatrix(i, COL_收费细目ID)), Val(.TextMatrix(i, COL_执行科室ID)), False)
                        If Not blnTmp Then
                            strMsg = "在(" & Sys.RowValue("部门表", Val(.TextMatrix(i, COL_执行科室ID)), "名称") & ")中药品""" & .TextMatrix(i, col_医嘱内容) & """" & vbCrLf & vbCrLf & _
                                    "不满足零差价管理的要求：成本价和售价不一致，不能销售出库。" & vbCrLf & vbCrLf & _
                                    "请联系药房或药剂科进行调价处理。"
                            .Col = col_医嘱内容
                            If .TextMatrix(i, COL_类别) = "7" Then
                                lngRow = .FindRow(CLng(.TextMatrix(i, COL_相关ID)), i + 1)
                                If lngRow <> -1 Then .Row = lngRow
                            Else
                                .Row = i
                            End If
                            Call .ShowCell(.Row, .Col)
                            MsgBox strMsg, vbInformation, gstrSysName
                            .Refresh
                            If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
                            Exit Function
                        End If
                    End If
                End If
            End If
            
            '本次新增或修改的行(包括隐藏行，不含自由录入行)，调用自定义的医嘱检查函数
            If .RowData(i) <> 0 And (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2)) _
                And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                '临时医嘱不应该包含首日要去掉
                If .TextMatrix(i, COL_期效) = "临嘱" Then
                    strSQL = .TextMatrix(i, COL_执行时间)
                    If InStr(strSQL, ",") > 0 Then .TextMatrix(i, COL_执行时间) = Split(strSQL, ",")(1)
                End If
                '抗菌用药检查
                If gblnKSSStrict And Val(.TextMatrix(i, COL_抗菌等级)) > 0 Then
                    If Val(.TextMatrix(i, COL_用药目的)) = 0 Then
                        strMsg = ",抗菌用药要求登记用药目的。"
                        .Col = COL_用药目的: Exit For
                    End If
                    
                    '如果操作员没有抗菌用药处方权，则禁止保存
                    If UserInfo.用药级别 = 0 Then
                        strMsg = ",您没有抗菌用药权限，请联系管理员。"
                        .Col = col_医嘱内容: Exit For
                    End If
                    
                    If Val(.TextMatrix(i, COL_EDIT)) = 2 Then
                        If UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And (Val(.TextMatrix(i, COL_标志)) <> 1 Or .TextMatrix(i, COL_期效) = "长嘱") Then
                            .TextMatrix(i, COL_审核状态) = 1
                        End If
                    End If
                                        
                    '一组药品中，只要有一个为待审核或未审核通过，则整组更改(没在输入时处理，是因为可能给药途径是后续才加上的，处理的点较多)
                    If Val(.TextMatrix(i, COL_审核状态)) > 0 Then
                        Call GetRowScope(i, lngBegin, lngEnd)
                        For j = lngBegin To lngEnd
                            If j <> i Then
                                .TextMatrix(j, COL_审核状态) = .TextMatrix(i, COL_审核状态)
                            End If
                        Next
                    End If
                    
                    '紧急医嘱检查
                    If Val(.TextMatrix(i, COL_标志)) = 1 Then
                        If .TextMatrix(i, COL_用药理由) = "" Then
                            strMsg = ",紧急使用的抗菌用药要求输入用药理由。"
                            .Col = COL_用药理由: Exit For
                        End If
 
                        If Val(.TextMatrix(i, COL_天数)) > 1 Then
                            strMsg = ",紧急使用的抗菌用药要求仅限一天。"
                            .Col = COL_天数: Exit For
                        ElseIf Val(.TextMatrix(i, COL_天数)) = 0 Then
                            '未输入天数时进行反算天数：总量/单量/频率
                            If .TextMatrix(i, COL_剂量系数) <> "" And .TextMatrix(i, COL_住院包装) <> "" Then
                                '计算出一天的总量
                                If Val(.TextMatrix(i, COL_频率性质)) = 1 Then '临嘱药品可能缺省为一次性
                                    dblOneDay = FormatEx(Calc缺省药品总量( _
                                            Val(.TextMatrix(i, COL_单量)), 1, 1, 1, "天", "", Val(.TextMatrix(i, COL_剂量系数)), _
                                            Val(.TextMatrix(i, COL_住院包装)), Val(.TextMatrix(i, COL_可否分零))), 5)
                                Else
                                    dblOneDay = FormatEx(Calc缺省药品总量( _
                                            Val(.TextMatrix(i, COL_单量)), 1, Val(.TextMatrix(i, COL_频率次数)), _
                                            Val(.TextMatrix(i, COL_频率间隔)), .TextMatrix(i, COL_间隔单位), _
                                            .TextMatrix(i, COL_执行时间), Val(.TextMatrix(i, COL_剂量系数)), _
                                            Val(.TextMatrix(i, COL_住院包装)), Val(.TextMatrix(i, COL_可否分零))), 5)
                                End If
                                If Val(.TextMatrix(i, COL_总量)) > dblOneDay Then
                                    strMsg = ",紧急使用的抗菌用药总量超出了一天的使用量：" & dblOneDay & "。"
                                    .Col = COL_天数: Exit For
                                End If
                            End If
                        End If
                    End If
                End If
                
                strExtra = CStr(.Cell(flexcpData, i, COL_医生嘱托))
                lng麻醉诊疗ID = 0
                lng给药执行性质 = 0
                str部位方法 = ""
                If .TextMatrix(i, COL_类别) = "F" Then
                    lng主ID = Val(.TextMatrix(i, COL_相关ID))
                    If lng主ID = 0 Then lng主ID = .RowData(i)
                    '如果参数启用了，检查手术的开单权和执行权
                    If gbln手术授权管理 Then
                        If CheckUserEmpower(.TextMatrix(i, COL_诊疗项目ID)) = False Then
                            strMsg = "当前操作员不具备此手术的开单权，不允许下达。"
                            .Col = col_医嘱内容: Exit For
                        End If
                        If CheckDocEmpower(.TextMatrix(i, COL_诊疗项目ID), .TextMatrix(i, COL_附项)) = False Then
                            If Not gbln手术等级管理 Then
                                strMsg = "主刀医生不具备此手术的执行权，不允许下达。"
                                .Col = col_医嘱内容: Exit For
                            End If
                        End If
                    ElseIf gbln手术等级管理 Then
                        .TextMatrix(i, COL_审核状态) = IIF(gbln手术分级管理 And Val(.TextMatrix(i, COL_标志)) <> 1, "1", "")
                        If Val(.TextMatrix(i, COL_审核状态)) = 1 Then
                            If gbln手术授权管理 Then
                                If gbln手术等级管理 Then
                                    If CheckDocEmpower(.TextMatrix(i, COL_诊疗项目ID), .TextMatrix(i, COL_附项)) Then
                                        .TextMatrix(i, COL_审核状态) = ""
                                    End If
                                End If
                            Else
                                If gbln手术等级管理 Then
                                    If CheckDoc手术等级(Val(.TextMatrix(i, COL_诊疗项目ID)), .TextMatrix(i, COL_附项)) Then
                                        .TextMatrix(i, COL_审核状态) = ""
                                    End If
                                End If
                            End If
                        End If
                        
                        Call GetRowScope(i, lngBegin, lngEnd)
                        For j = lngBegin To lngEnd
                            If j <> i Then
                                .TextMatrix(j, COL_审核状态) = .TextMatrix(i, COL_审核状态)
                            End If
                        Next
                    End If
                    
                    For k = i + 1 To .Rows - 1
                        If Val(.TextMatrix(k, COL_相关ID)) <> lng主ID Then Exit For
                        If .TextMatrix(k, COL_类别) = "G" Then
                            lng麻醉诊疗ID = .TextMatrix(k, COL_诊疗项目ID)
                        End If
                    Next
                ElseIf InStr("4,5,6,7", .TextMatrix(i, COL_类别)) > 0 Then
                    k = .FindRow(CLng(Val(.TextMatrix(i, COL_相关ID))), i + 1)
                    If k > 0 Then lng给药执行性质 = Val(.TextMatrix(k, COL_执行性质))
                
                ElseIf .TextMatrix(i, COL_类别) = "D" And Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                    lng主ID = .RowData(i)
                    For k = i + 1 To .Rows - 1
                        If Val(.TextMatrix(k, COL_相关ID)) <> lng主ID Then Exit For
                        str部位方法 = str部位方法 & "," & .TextMatrix(k, COL_标本部位) & ":" & .TextMatrix(k, COL_检查方法)
                    Next
                    str部位方法 = Mid(str部位方法, 2)
                End If
                
                strExtra = strExtra & "||" & lng给药执行性质 & "||" & lng麻醉诊疗ID & "||" & IIF(str部位方法 = "", " ", str部位方法) & "||" & Val(.TextMatrix(i, COL_收费细目ID))
                
                strSQL = "Select zl_AdviceCheck([1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11],[12],[13],[14],[15]) as 结果 From Dual"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "zl_AdviceCheck", 2, mlng病人ID, mlng主页ID, mint险类, IIF(.TextMatrix(i, COL_期效) = "长嘱", 0, 1), _
                    .TextMatrix(i, COL_类别), Val(.TextMatrix(i, COL_诊疗项目ID)), _
                   Val(.TextMatrix(i, COL_开嘱科室ID)), .TextMatrix(i, COL_开嘱医生), _
                   Val(.TextMatrix(i, COL_执行科室ID)), Val(.TextMatrix(i, COL_执行性质)), Val(.TextMatrix(i, COL_执行标记)), _
                   Val(.TextMatrix(i, COL_单量)), strExtra, Val(.TextMatrix(i, COL_收费细目ID)))
                
                If Not rsTmp.EOF Then
                    strMsg = NVL(rsTmp!结果)
                    If strMsg <> "" Then
                        Select Case Val(Split(strMsg, "|")(0))
                        Case 1 '提示
                            If MsgBox(Split(strMsg, "|")(1), vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                                strMsg = "": Exit For
                            End If
                        Case 2 '禁止
                            MsgBox Split(strMsg, "|")(1), vbInformation, gstrSysName
                            strMsg = "": Exit For
                        End Select
                        strMsg = ""
                    End If
                End If
            End If
            
            '检查药品是否超量和超期，遍历时应从第一条没有填写超量说明的行开始
            If (gbyt超量原因 = 1 And InStr(gstr不录超量科室, "," & mlng病人科室id & ",") = 0) And Not blnCheck超量 _
                And .TextMatrix(i, COL_是否超量) = "1" And .TextMatrix(i, COL_超量说明) = "" Then
                blnCheck超量 = SetAll超量说明(i, blnOut) '超量的检查只要这个方法执行了一次就算是所有都已经检查了不用再遍历了
                If blnOut Then
                    strMsg = "Not Null" '这里应该赋值确保 strMsg 不为空即可
                    .Col = COL_超量说明: Exit For
                End If
            End If
            
            '医嘱诊断检查：只针对本次新开的医嘱检查
            If .RowData(i) <> 0 And (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2)) And Not .RowHidden(i) _
                And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                strMsg = ""
                If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_操作类型)) = 6 Then
                    str类型 = "C"
                ElseIf .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_操作类型)) = 4 Or Val(.TextMatrix(i, COL_类别)) = 6 Then
                    str类型 = "5"
                Else
                    str类型 = .TextMatrix(i, COL_类别)
                End If
                '入院诊断
                If Not bln检查入院诊断 And mstr检查入院诊断 <> "" And InStr(mstr检查入院诊断, str类型) > 0 Then
                    bln中医 = Sys.DeptHaveProperty(mlng病人科室id, "中医科")
                    str类型 = IIF(bln中医, "2,12", "2")
                    If Not ExistsDiagNoses(mlng病人ID, mlng主页ID, str类型) Then
                        strMsg = "病人的入院诊断还没有输入，请先输入病人的入院诊断再下达相关医嘱。"
                    End If
                    bln检查入院诊断 = True
                End If
                
                If strMsg = "" Then
                    '出院诊断
                    If Not bln检查出院诊断 And mbln检查出院诊断 And .TextMatrix(i, COL_类别) = "Z" And InStr(",5,6,11,", Val(.TextMatrix(i, COL_操作类型))) > 0 Then
                        bln中医 = Sys.DeptHaveProperty(mlng病人科室id, "中医科")
                        str类型 = IIF(bln中医, "3,13", "3")
                        If Not ExistsDiagNoses(mlng病人ID, mlng主页ID, str类型) Then
                            strMsg = "病人的出院诊断还没有输入，请先输入病人的出院诊断再下达出院或转院、死亡医嘱。"
                        End If
                        bln检查出院诊断 = True
                    End If
                End If

                If strMsg <> "" Then
                    If InStr(";" & mMainPrivs & ";", ";首页整理;") > 0 Then
                        vsAdvice.Refresh
                        MsgBox strMsg & vbCrLf & vbCrLf & "请按 [确定] 进入诊断输入界面。", vbInformation, gstrSysName
                        blnSucceed = True
                        RaiseEvent EditDiagnose(Me, mlng病人ID, mlng主页ID, mlng病人科室id, str类型, blnSucceed)
                        vsAdvice.Refresh
                        If Not blnSucceed Then Exit Function
                    Else
                        vsAdvice.Refresh
                        MsgBox strMsg, vbInformation, gstrSysName
                        vsAdvice.Refresh: Exit Function
                    End If
                End If
            End If
            
            '其它输入合法性检查
            If .RowData(i) <> 0 And (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2)) Then
                bln配方行 = RowIn配方行(i)
                bln检验行 = RowIn检验行(i)
                
                '有性别限制项目的检查（只针对：检验、检查、手术）
                If InStr(",C,D,F,5,6,7,", .TextMatrix(i, COL_类别)) > 0 And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                    If .TextMatrix(i, COL_类别) = "F" Or .TextMatrix(i, COL_类别) = "D" And Not .RowHidden(i) Or .TextMatrix(i, COL_类别) = "C" And .RowHidden(i) Or InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 Then
                        str性别 = GetBabySex(Val(.TextMatrix(i, COL_婴儿)))
                        If str性别 = "男" Or str性别 = "女" Then
                            strSQL = "Select Decode(a.适用性别, 1, '男', 2, '女', '未知') As 性别 From 诊疗项目目录 A Where a.Id = [1]"
                            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(i, COL_诊疗项目ID)))
                            
                            If rsTmp!性别 <> str性别 And rsTmp!性别 <> "未知" Then
                                If .TextMatrix(i, COL_类别) = "D" Then
                                    strMsg = "手术，对性别""" & str性别 & """不适用。"
                                Else
                                    strMsg = Decode(.TextMatrix(i, COL_类别), "C", "检验项目", "F", "附加手术", "D", "检查项目", "药品") & "，对性别""" & str性别 & """不适用。"
                                End If
                                .Col = col_医嘱内容: Exit For
                            End If
                        End If
                    End If
                End If
                
                If .RowHidden(i) Then
                    '本次新增或修改的行
                    '---------------------------------------------------
                    If InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        If Not Check单独应用(i, strMsg) Then Exit For
                        '检查执行科室
                        If Val(.TextMatrix(i, COL_执行科室ID)) = 0 And InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 And Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                            strMsg = "没有确定执行科室。"
                            .Col = COL_执行科室ID: Exit For
                        End If
                    
                        If .TextMatrix(i, COL_类别) = "D" And .TextMatrix(i, COL_标本部位) <> "" Then
                            str性别 = GetBabySex(Val(.TextMatrix(i, COL_婴儿)))
                            If Check检查部位Enable(.TextMatrix(i, COL_诊疗项目ID), .TextMatrix(i, COL_标本部位), str性别, .TextMatrix(i, COL_检查方法), blnExists) = False Then
                                If blnExists = True Then
                                    strMsg = "中的部位：" & .TextMatrix(i, COL_标本部位) & "，对性别""" & str性别 & """不适用。"
                                Else
                                    Call cmdExt_Click
                                End If
                                .Col = col_医嘱内容: Exit For
                            End If
                        End If
                    End If
                Else
                    If mintPState = ps最近转出 And gbln只允许补录临嘱 = True Or mintPState = ps预出 Or mintPState = ps出院 Then
                        If InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                            If Not Check单独应用(i, strMsg) Then Exit For
                            If .TextMatrix(i, COL_期效) <> "临嘱" Then
                                strMsg = "补录的医嘱只能是临嘱。"
                                .Col = COL_期效: Exit For
                            End If
                        End If
                    End If
                    lngRow = i
                    If bln配方行 Then '得到配方的第一药品行
                        lngRow = .FindRow(CStr(.RowData(i)), , COL_相关ID)
                        '自备药不检查药房
                        If Not (Val(.TextMatrix(lngRow, COL_执行性质)) = 5 And Val(.TextMatrix(i, COL_执行性质)) <> 5) And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                            str中药名 = ""
                            If Check中药存储库房(lngRow, i, str中药名, vsAdvice, 2, mlng病人科室id, COL_类别, col_医嘱内容, COL_收费细目ID, COL_执行科室ID) = False Then
                                strMsg = "中的[" & str中药名 & "]没有存储在当前选择的药房，或该药房不是服务于当前病人科室的，不能使用该药品。"
                                Exit For
                            End If
                        End If
                    ElseIf bln检验行 Then '得到检验医嘱行
                        lngRow = .FindRow(CStr(.RowData(i)), , COL_相关ID)
                    End If
                    
                    '未校对的医嘱行
                    '------------------------------------
                    If InStr(",1,2,-1,", .TextMatrix(i, COL_状态)) > 0 Then
                        If Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                            lngCount = lngCount + 1
                        
                            '长嘱、临嘱规格判断,由于临床路径定义和成套方案时，药品卫材可以只定义品种，生成时再选择，所以这里要检查
                            If InStr(",4,5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                                If Val(.TextMatrix(i, COL_收费细目ID)) = 0 Then
                                    If .TextMatrix(i, COL_期效) = "临嘱" Or .TextMatrix(i, COL_期效) = "长嘱" And gbln药品按规格下医嘱 And Val(.TextMatrix(i, COL_品种医嘱)) = 0 Then
                                        strMsg = "没有确定" & IIF(.TextMatrix(i, COL_类别) = "4", "卫材", "药品") & "的规格信息。"
                                        .Col = col_医嘱内容: Exit For
                                    End If
                                End If
                            End If
                            
                            '必须录入单量
                            If .TextMatrix(i, COL_期效) = "长嘱" Then
                                '长嘱：成药或计时,计量项目需要录入
                                If InStr(",1,2,", Val(.TextMatrix(lngRow, COL_计算方式))) > 0 Or InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                                    If Not IsNumeric(.TextMatrix(lngRow, COL_单量)) Or Val(.TextMatrix(lngRow, COL_单量)) <= 0 Then
                                        If Not (.TextMatrix(lngRow, COL_单量) = "" And .TextMatrix(lngRow, COL_频率) Like "*持续*" _
                                            And InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) = 0) Then
                                            strMsg = "没有录入正确的单次用量。"
                                            .Col = COL_单量: Exit For
                                        End If
                                    End If
                                End If
                            Else
                                '临嘱:成药或可选择频率的计时,计量项目可以录入(也可不录)
                                If (Val(.TextMatrix(lngRow, COL_频率性质)) = 0 And InStr(",1,2,", Val(.TextMatrix(lngRow, COL_计算方式))) > 0) _
                                    Or InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                                    If .TextMatrix(lngRow, COL_单量) <> "" Then
                                        If Not IsNumeric(.TextMatrix(lngRow, COL_单量)) Or Val(.TextMatrix(lngRow, COL_单量)) <= 0 Then
                                            strMsg = "没有录入正确的单次用量。"
                                            .Col = COL_单量: Exit For
                                        End If
                                    End If
                                    '发送到输液配置中心的药品必须确定单量（临嘱可选不发送到输液配置中心）
                                    If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 And gstr输液配置中心 <> "" Then
                                         If InStr("," & gstr输液配置中心 & ",", "," & Val(.TextMatrix(lngRow, COL_执行科室ID)) & ",") > 0 Then
                                            If Val(.TextMatrix(lngRow, COL_单量)) <= 0 Then
                                                strMsg = "发送到配置中心的输液类药品必须输入单量。"
                                                .Col = COL_单量: Exit For
                                            End If
                                         End If
                                    End If
                                End If
                            End If
                            
                            '必须录入天数：对临嘱药品，如果指定了要录入
                            If mbln天数 And .TextMatrix(i, COL_期效) = "临嘱" _
                                And InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 And Val(.TextMatrix(i, COL_频率性质)) <> 1 Then
                                If Val(.TextMatrix(i, COL_天数)) <= 0 Then
                                    strMsg = "请录入正确的用药天数。"
                                    .Col = COL_天数: Exit For
                                End If
                            End If
                            
                            '必须录入总量:配方,临嘱(药品或其它)
                            If .TextMatrix(i, COL_期效) = "临嘱" Then 'Or bln配方行 Then
                                If Not IsNumeric(.TextMatrix(i, COL_总量)) Or Val(.TextMatrix(i, COL_总量)) <= 0 Then
                                    '输血医嘱允许不输入总量
                                    If Not (.TextMatrix(i, COL_类别) = "K" And .TextMatrix(i, COL_总量) = "") Then
                                        If bln配方行 Then
                                            strMsg = "没有录入正确的中药配方付数。"
                                        ElseIf InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                                            strMsg = "没有录入正确的药品总给予量。"
                                        Else
                                            strMsg = "没有录入正确的总量。"
                                        End If
                                        .Col = COL_总量: Exit For
                                    End If
                                End If
                            End If
                                                
                            '必须录入频率:临嘱也要检查,用于指导使用
                            If Val(.TextMatrix(lngRow, COL_频率性质)) = 0 Or bln配方行 Then
                                If .TextMatrix(lngRow, COL_频率) = "" Then
                                    strMsg = "没有确定执行频率。"
                                    .Col = COL_频率: Exit For
                                End If
                                
                                '执行时间判断:可选频率的必须输入(对临嘱将来可能允许不录入,要注意发送等地方的处理)
                                If .TextMatrix(lngRow, COL_执行时间) = "" And .TextMatrix(lngRow, COL_间隔单位) <> "分钟" And .TextMatrix(lngRow, COL_频率) <> "必要时" And .TextMatrix(lngRow, COL_频率) <> "需要时" Then
                                    If Not bln检验行 Then '检验组合显示行的采集方法为可选频率,但检验项目为一次性
                                        If Val(.TextMatrix(lngRow, COL_频率性质)) <> 1 Then
                                            strMsg = "没有录入执行时间方案。"
                                            .Col = COL_执行时间: Exit For
                                        End If
                                    End If
                                End If
                                '只录入了首日时间的情况
                                If InStr(.TextMatrix(lngRow, COL_执行时间), ",") > 0 Then
                                    If Split(.TextMatrix(lngRow, COL_执行时间), ",")(1) = "" Then
                                        strMsg = "没有录入执行时间方案。"
                                        .Col = COL_执行时间: Exit For
                                    End If
                                End If
                            End If
                            
                            '必须录入执行科室:非叮嘱和院外执行时(配方以药品行，检验以检验行进行判断)
                            If Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then
                                If .TextMatrix(lngRow, COL_类别) = "Z" And Val(.TextMatrix(lngRow, COL_操作类型)) = 3 Then
                                    strMsg = "没有确定转科医嘱的转入科室。"
                                    .Col = COL_执行科室ID: Exit For
                                ElseIf .TextMatrix(lngRow, COL_类别) = "Z" And Val(.TextMatrix(lngRow, COL_操作类型)) = 7 Then
                                    strMsg = "没有确定会诊医嘱的会诊科室。"
                                    .Col = COL_执行科室ID: Exit For
                                ElseIf InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                                    strMsg = "没有确定执行科室。"
                                    .Col = COL_执行科室ID: Exit For
                                End If
                            End If
                            If lngRow <> i And Val(.TextMatrix(i, COL_执行科室ID)) = 0 Then
                                If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                                    strMsg = "没有确定执行科室。"
                                    .Col = COL_执行科室ID: Exit For
                                End If
                            End If
                            
                            '终止时间判断
                            If .TextMatrix(i, COL_期效) = "长嘱" And Val(.TextMatrix(i, COL_抗菌等级)) = 3 And .Cell(flexcpData, i, COL_终止时间) = "" And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And gblnKSSStrict Then
                                strMsg = "长嘱下达特殊使用抗菌药物时必须录入执行终止时间。"
                                .Col = COL_终止时间: Exit For
                            End If
                            

                            If .TextMatrix(i, COL_期效) = "长嘱" And Not bln配方行 And .Cell(flexcpData, i, COL_终止时间) <> "" Then
                                If Not Check终止时间(.Cell(flexcpData, i, COL_开嘱时间), .Cell(flexcpData, i, COL_开始时间), .Cell(flexcpData, i, COL_终止时间), False, strMsg) Then
                                    .Col = COL_终止时间: Exit For
                                End If
                            End If
                        End If
                        
                        '必须录入开嘱医生:护士使用时
                        If mint场合 = 1 And .TextMatrix(i, COL_开嘱医生) = "" Then
                            strMsg = "没有确定开嘱医生。"
                            .Col = COL_开嘱医生: Exit For
                        End If
                        
                        '开嘱时间判断(补录时只检查新增或修改的行)
                        blnCheck开嘱时间 = True
                        If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                            blnCheck开嘱时间 = InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0
                        End If
                        
                        '留观病人发送到门诊：处方条数限制检查
                        If gintRXCount > 0 And mlng病人性质 = 1 Then
                            If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 And Val(.TextMatrix(i, COL_相关ID)) <> Val(.TextMatrix(i - 1, COL_相关ID)) Then
                                lngRxCount = GetMergeCount(vsAdvice, i, COL_相关ID, COL_收费细目ID)
                                If lngRxCount > gintRXCount Then
                                    strMsg = "一并给药的药品种数 " & lngRxCount & " 种已达到或超过药品处方最多允许的种数 " & gintRXCount & " 种。"
                                    .Col = col_医嘱内容: Exit For
                                End If
                            End If
                        End If
                        
                    End If
                    
                    '本次新增或修改的行
                    '---------------------------------------------------
                    If InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        If Not Check单独应用(i, strMsg) Then Exit For
                        '开始时间判断:只对新增的医嘱或补录的医嘱进行判断,因为否则是不准修改开始时间的(不好判断被修改的非补录医嘱开始时间的相对有效性)
                        If Val(.TextMatrix(i, COL_标志)) = 2 Or .TextMatrix(i, COL_EDIT) = "1" Then
                            bln护理等级医嘱 = .TextMatrix(i, COL_类别) = "H" And Val(.TextMatrix(i, COL_操作类型)) = 1
                            If Not Check开始时间(.Cell(flexcpData, i, COL_开始时间), .Cell(flexcpData, i, COL_终止时间), False, strMsg, i, IIF(bln护理等级医嘱, 1, 0)) Then
                                .Col = COL_开始时间: Exit For
                            End If
                        End If
                        '手术/输血医嘱的手术/输血时间判断
                        If .TextMatrix(i, COL_类别) = "F" Or .TextMatrix(i, COL_类别) = "K" Then
                            If Not Check安排时间(.TextMatrix(i, COL_手术时间), .Cell(flexcpData, i, COL_开始时间), .TextMatrix(i, COL_类别), False, strMsg) Then
                                .Col = COL_手术时间: Exit For
                            End If
                            If .TextMatrix(i, COL_类别) = "K" Then
                                '只有紧急医嘱保存输血原因
                                If .TextMatrix(i, COL_用药理由) = "" And .TextMatrix(i, COL_标志) = "1" Then
                                    If gbln输血分级管理 Then
                                        strMsg = "启用了输血分级管理后，紧急输血医嘱必须填写输血原因。"
                                        .Col = COL_用药理由: Exit For
                                    End If
                                End If
                            End If
                        End If
                        
                        '手术和术前医嘱，自动停止长嘱
                        If .TextMatrix(i, COL_类别) = "Z" And .TextMatrix(i, COL_操作类型) = "14" And chkStop.value = 0 Then
                            If MsgBox("需要在术前医嘱校对后停止该病人的所有长嘱吗？", vbQuestion + vbYesNo + vbDefaultButton2) = vbYes Then
                                .TextMatrix(i, COL_执行标记) = 1
                                mblnDoCheck = False
                                chkStop.value = Val(.TextMatrix(i, COL_执行标记))
                                mblnDoCheck = True
                            Else
                                .TextMatrix(i, COL_执行标记) = 0
                            End If
                        ElseIf .TextMatrix(i, COL_类别) = "F" Then  '即使有附加手术，可见行只有一行
                            If Val(.TextMatrix(i, COL_执行标记)) = 1 Then
                                If MsgBox("需要在手术日:" & Format(.TextMatrix(i, COL_手术时间), "YYYY-MM-DD") & "停止该病人的所有长嘱吗？", vbQuestion + vbYesNo + vbDefaultButton1) = vbNo Then
                                    .TextMatrix(i, COL_执行标记) = 0
                                    mblnDoCheck = False
                                    chkStop.value = Val(.TextMatrix(i, COL_执行标记))
                                    mblnDoCheck = True
                                End If
                            End If
                        End If
                                                
                                
                        '检查并提示下达转科、出院、转院、死亡、术后等特殊医嘱时将会自动停止的长嘱
                        '只检查新开的，临床路径生成的不检查
                        '3-转科;4-术后;5-出院;6-转院,11-死亡
                        If mbytUseType = 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                            If .TextMatrix(i, COL_类别) = "Z" And InStr(",3,4,5,6,11,", "," & .TextMatrix(i, COL_操作类型) & ",") > 0 Then
                                blnValid = CheckUnStopedAdvice(CDate(.TextMatrix(i, COL_开始时间)), IIF(.TextMatrix(i, COL_操作类型) = "4", True, False))
                                If blnValid Then
                                    If InStr(GetInsidePrivs(p住院医嘱下达), ";医嘱停止;") > 0 Then
                                        If Val(.TextMatrix(i, COL_操作类型)) = 5 Then
                                            dat出院时间 = CDate(.TextMatrix(i, COL_开始时间)) - (1 / 24 / 60)
                                        Else
                                            dat出院时间 = CDate(.TextMatrix(i, COL_开始时间))
                                        End If
                                        
                                        str终止原因 = Decode(Val(.TextMatrix(i, COL_操作类型)), 3, "转科", 4, "术后", 5, "出院", 6, "转院", 11, "死亡", "")
                                        
                                        If Not frmAdviceOperate.ShowMe(mfrmParent, mMainPrivs, 1, mlng病人ID, mlng主页ID, mlng病人病区ID, 0, mint场合 = 1, , , , dat出院时间, , , , mint婴儿, _
                                            IIF(.TextMatrix(i, COL_操作类型) = "4", True, False), mlng医护科室ID, , mclsMipModule, , , str终止原因) Then
                                            Exit For
                                        End If
                                    End If
                                End If
                                If "4" = .TextMatrix(i, COL_操作类型) Then
                                    blnValid = CheckAdviceOperation(Val(.TextMatrix(i, COL_婴儿)))
                                    If Not blnValid Then
                                        .Col = col_医嘱内容: Exit For
                                    End If
                                End If
                            End If
                        End If
                
                        
                        '护理等级医嘱的判断
                        If .TextMatrix(i, COL_类别) = "H" And .TextMatrix(i, COL_操作类型) = "1" Then
                            If Check护理等级变动交叉(mlng病人ID, mlng主页ID, .Cell(flexcpData, i, COL_开始时间)) Then
                                .Col = COL_开始时间: Exit For
                            End If
                        End If
                        
                        If Val(.TextMatrix(i, COL_诊疗项目ID)) = 0 Then
                            If .TextMatrix(i, col_医嘱内容) = "" Then
                                strMsg = "没有录入医嘱内容。"
                                .Col = COL_用法: Exit For
                            End If
                        Else
                            '引起病人变动的医嘱开始时间检查
                            If .TextMatrix(i, COL_类别) = "Z" And InStr(",3,5,6,11,", Val(.TextMatrix(i, COL_操作类型))) > 0 And Val(.TextMatrix(i, COL_婴儿)) = 0 Then
                                dMax = GetMaxDate(mlng病人ID, mlng主页ID)
                                If Format(.Cell(flexcpData, i, COL_开始时间), "yyyy-MM-dd HH:mm") <= Format(dMax, "yyyy-MM-dd HH:mm") Then
                                    MsgBox "医嘱""" & .TextMatrix(i, col_医嘱内容) & """的开始时间应大于该病人上次变动时间 " & Format(dMax, "yyyy-MM-dd HH:mm") & " 。", vbInformation, gstrSysName
                                    .Col = COL_开始时间: Exit For
                                End If
                            End If
                        
                            '给药途径，中药用法，采集方法设置检查
                            If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(i + 1) And Val(.TextMatrix(i + 1, COL_诊疗项目ID)) = 0 Then
                                    strMsg = "没有设置对应的给药途径。"
                                    .Col = COL_用法: Exit For
                                End If
                            End If
                            If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_诊疗项目ID)) = 0 Then
                                If .RowData(i) = Val(.TextMatrix(i - 1, COL_相关ID)) Then
                                    If InStr(",7,E,", .TextMatrix(i - 1, COL_类别)) > 0 Then
                                        strMsg = "中药配方没有设置对应的用法。"
                                    ElseIf .TextMatrix(i - 1, COL_类别) = "C" Then
                                        strMsg = "没有设置对应的标本采集方法。"
                                    End If
                                    .Col = COL_用法: Exit For
                                End If
                            End If
                            
                            '检验医嘱一并采集检查
                            str项目IDs = ""
                            If .TextMatrix(i, COL_类别) = "E" And Val(.TextMatrix(i, COL_操作类型)) = 6 Then
                                If .RowData(i) = Val(.TextMatrix(i - 1, COL_相关ID)) And .TextMatrix(i - 1, COL_类别) = "C" And i - 2 >= .FixedRows Then
                                    If .RowData(i) = Val(.TextMatrix(i - 2, COL_相关ID)) And .TextMatrix(i - 2, COL_类别) = "C" Then
                                        Call GetRowScope(i, lngBegin, lngEnd)
                                        For j = lngBegin To lngEnd
                                            If j <> i And .TextMatrix(j, COL_类别) = "C" Then
                                                str项目IDs = str项目IDs & "," & .TextMatrix(j, COL_诊疗项目ID)
                                                If Val(.Cell(flexcpData, j, COL_皮试结果)) = 0 Or Val(.TextMatrix(j, COL_申请序号)) = 0 Then
                                                  
                                                        blnTmp = IsLis耐受项目(p住院医嘱下达, Val(.TextMatrix(j, COL_诊疗项目ID)), str中药名)
                                                        If Not blnTmp Then
                                                            If str中药名 <> "" Then
                                                                strMsg = "耐受试验判断出错:" & str中药名: .Col = col_医嘱内容: Exit For
                                                            End If
                                                        Else
                                                            strMsg = "当前为耐受试验必须用申请单方式下达。": .Col = col_医嘱内容: Exit For
                                                        End If
                                                End If
                                            End If
                                        Next
                                        str项目IDs = Mid(str项目IDs, 2)
                                        If str项目IDs <> "" Then
                                            strSQL = "Select distinct 试管编码 ,操作类型 From 诊疗项目目录 Where ID IN (Select /*+cardinality(x,10)*/ x.Column_Value From Table(f_Num2list([1])) X) And 试管编码 is Not Null"
                                            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str项目IDs)
                                            If rsTmp.RecordCount > 1 Then strMsg = "当前一并采集检验医嘱的试管编码或检验类型不相同。": .Col = col_医嘱内容: Exit For
                                        End If
                                    End If
                                End If
                            
                                '耐受试验判断
                                If Val(.RowData(i)) = Val(.TextMatrix(i - 1, COL_相关ID)) And .TextMatrix(i - 1, COL_类别) = "C" And (Val(.Cell(flexcpData, i - 1, COL_皮试结果)) = 0 Or Val(.TextMatrix(i - 1, COL_申请序号)) = 0) Then
                                 
                                        blnTmp = IsLis耐受项目(p住院医嘱下达, Val(.TextMatrix(i - 1, COL_诊疗项目ID)), str中药名)
                                        If Not blnTmp Then
                                            If str中药名 <> "" Then
                                                strMsg = "耐受试验判断出错:" & str中药名: .Col = col_医嘱内容: Exit For
                                            End If
                                        Else
                                            strMsg = "当前为耐受试验必须用申请单方式下达。": .Col = col_医嘱内容: Exit For
                                        End If
                                End If
                            End If

                            '最少总量检查:至少要满足一个频次周期的用量
                            If .TextMatrix(i, COL_期效) = "临嘱" And (InStr(",4,5,6,", .TextMatrix(i, COL_类别)) > 0 Or bln配方行) Then
                                If Not blnSkipTotal And .TextMatrix(i, COL_频率) <> "" Then
                                    strMsg = ""
                                    If bln配方行 Then '判断
                                        dbl总量 = Calc缺省药品总量(1, 1, Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), .TextMatrix(i, COL_间隔单位))
                                        If Val(.TextMatrix(i, COL_总量)) < dbl总量 Then
                                            strMsg = .TextMatrix(i, col_医嘱内容) & vbCrLf & vbCrLf & _
                                                "在按""" & .TextMatrix(i, COL_频率) & """执行时,至少需要 " & dbl总量 & "付。"
                                        End If
                                    ElseIf Val(.TextMatrix(i, COL_剂量系数)) <> 0 And Val(.TextMatrix(i, COL_单量)) <> 0 Then
                                        If Val(.TextMatrix(i, COL_频率性质)) = 1 Then '临嘱成药可能为一次性
                                            dbl总量 = Calc缺省药品总量(Val(.TextMatrix(i, COL_单量)), 1, 1, 1, "天", "", Val(.TextMatrix(i, COL_剂量系数)), Val(.TextMatrix(i, COL_住院包装)), Val(.TextMatrix(i, COL_可否分零)))
                                        Else
                                            sng天数 = Val(.TextMatrix(i, COL_天数))
                                            If sng天数 = 0 Then sng天数 = 1
                                            dbl总量 = Calc缺省药品总量(Val(.TextMatrix(i, COL_单量)), sng天数, Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), .TextMatrix(i, COL_间隔单位), .TextMatrix(i, COL_执行时间), Val(.TextMatrix(i, COL_剂量系数)), Val(.TextMatrix(i, COL_住院包装)), Val(.TextMatrix(i, COL_可否分零)))
                                        End If
                                        If Val(.TextMatrix(i, COL_总量)) < dbl总量 Then
                                            strMsg = .TextMatrix(i, col_医嘱内容) & vbCrLf & vbCrLf & _
                                                "在按每次 " & .TextMatrix(i, COL_单量) & .TextMatrix(i, COL_单量单位) & "," & _
                                                .TextMatrix(i, COL_频率) & IIF(mbln天数 And .TextMatrix(i, COL_类别) <> "4", ",用药 " & sng天数 & " 天", "") & _
                                                "执行时,至少需要 " & dbl总量 & .TextMatrix(i, COL_总量单位) & "。"
                                        End If
                                    End If
                                    If strMsg <> "" Then '提示
                                        .Row = i: .Col = COL_总量: Call .ShowCell(.Row, .Col)
                                        vMsg = frmMsgBox.ShowMsgBox(strMsg & "^^要继续吗？", Me)
                                        If vMsg = vbNo Or vMsg = vbCancel Then
                                            If txt总量.Enabled And txt总量.Visible Then txt总量.SetFocus
                                            Exit Function
                                        ElseIf vMsg = vbIgnore Then
                                            blnSkipTotal = True
                                        End If
                                    End If
                                End If
                            End If
                            
                            '药品库存检查:只提醒,所以也只对本次编辑的才判断
                            If (InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Or bln配方行 _
                                Or .TextMatrix(i, COL_类别) = "4" And Val(.TextMatrix(i, COL_跟踪在用)) = 1) And Not blnSkipStock Then
                                strMsg = CheckStock(i)
                                If strMsg <> "" Then
                                    .Row = i: .Col = col_医嘱内容: Call .ShowCell(.Row, .Col)
                                    vMsg = frmMsgBox.ShowMsgBox(strMsg & "^^要继续吗？", Me)
                                    If vMsg = vbNo Or vMsg = vbCancel Then
                                        Exit Function
                                    ElseIf vMsg = vbIgnore Then
                                        blnSkipStock = True
                                    End If
                                End If
                            End If
                            
                            '执行时间合法性检查
                            If .TextMatrix(i, COL_执行时间) <> "" And .TextMatrix(i, COL_频率) <> "" Then
                                If InStr(.TextMatrix(i, COL_执行时间), ",") > 0 Then
                                    blnValid = ExeTimeValid(Split(.TextMatrix(i, COL_执行时间), ",")(1), Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), .TextMatrix(i, COL_间隔单位))
                                Else
                                    blnValid = ExeTimeValid(.TextMatrix(i, COL_执行时间), Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), .TextMatrix(i, COL_间隔单位))
                                End If
                                If Not blnValid Then
                                    If .TextMatrix(i, COL_间隔单位) = "周" Then
                                        strMsg = COL_按周执行
                                    ElseIf .TextMatrix(i, COL_间隔单位) = "天" Then
                                        strMsg = COL_按天执行
                                    ElseIf .TextMatrix(i, COL_间隔单位) = "小时" Then
                                        strMsg = COL_按时执行
                                    End If
                                    strMsg = "录入的执行时间方案格式不正确，请检查。" & vbCrLf & vbCrLf & "例：" & vbCrLf & strMsg
                                    .Col = COL_执行时间: Exit For
                                End If
                                If InStr(.TextMatrix(i, COL_执行时间), ",") > 0 Then '首日时间
                                    blnValid = ExeTimeValid(Split(.TextMatrix(i, COL_执行时间), ",")(0), Val(.TextMatrix(i, COL_频率次数)), Val(.TextMatrix(i, COL_频率间隔)), .TextMatrix(i, COL_间隔单位), True)
                                    If Not blnValid Then
                                        If .TextMatrix(i, COL_间隔单位) = "周" Then
                                            strMsg = COL_按周执行首周
                                        ElseIf .TextMatrix(i, COL_间隔单位) = "天" Then
                                            strMsg = COL_按天执行首日
                                        End If
                                        strMsg = "录入的" & Mid(lbl首日时间.Caption, 2) & "执行时间方案格式不正确，请检查。" & vbCrLf & vbCrLf & "例：" & vbCrLf & strMsg
                                        .Col = COL_执行时间: Exit For
                                    End If
                                End If
                            End If
                            
                            '医保对码检查:以一组医保第一可见行为准
                            If InStr(",5,6,", .TextMatrix(i, COL_类别)) = 0 _
                                Or Val(.TextMatrix(i - 1, COL_相关ID)) <> Val(.TextMatrix(i, COL_相关ID)) Then
                                If gint医保对码 = 2 Then mbln提醒对码 = True
                                Call GetInsureStr(strIDs1, strIDs2, str医嘱内容, i)
                                strMsg = CheckAdviceInsure(mint险类, mbln提醒对码, mlng病人ID, mlng病人性质, strIDs1, strIDs2, str医嘱内容, mlng病人病区ID)
                                If strMsg <> "" Then
                                    .Row = i: .Col = col_医嘱内容: Call .ShowCell(.Row, .Col)
                                    If gint医保对码 = 1 Then
                                        vMsg = frmMsgBox.ShowMsgBox(strMsg & vbCrLf & vbCrLf & "要继续保存医嘱吗？", Me)
                                        If vMsg = vbNo Or vMsg = vbCancel Then Exit Function
                                        If vMsg = vbIgnore Then mbln提醒对码 = False
                                    ElseIf gint医保对码 = 2 Then
                                        MsgBox strMsg & vbCrLf & vbCrLf & "请先和相关人员联系处理，否则医嘱将不允许保存。", vbInformation, gstrSysName
                                        Exit Function
                                    End If
                                    strMsg = "" '防止后面再作处理
                                End If
                            End If
                            
                            '医保管控实时监测：首次输入(经过)或者更改时检查
                            If mint险类 <> 0 And .Cell(flexcpData, i, COL_状态) = 0 Then
                                If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) Then
                                    If MakePriceRecord(i) Then
                                        If Not gclsInsure.CheckItem(mint险类, 1, 0, mrsPrice) Then
                                            .Row = i: .Col = col_医嘱内容
                                            Call .ShowCell(.Row, .Col)
                                            If txt总量.Enabled Then
                                                txt总量.SetFocus
                                            ElseIf txt医嘱内容.Enabled Then
                                                txt医嘱内容.SetFocus
                                            End If
                                            Exit Function
                                        End If
                                    End If
                                    '标记为已经作了检查
                                    .Cell(flexcpData, .Row, COL_状态) = 1
                                End If
                            End If
                        End If
                    End If
                                    
                    '医嘱申请附项填写检查：
                    '只针对新录入的医嘱，修改的医嘱修改时已检查
                    '".Cell(flexcpData, i, COL_附项) = 1"的可能还没有在输入过程中检查，只是自动替换了
                    If Val(.TextMatrix(i, COL_EDIT)) = 1 And .TextMatrix(i, COL_附项) <> "" Then
                        strMsg = CheckAdviceAppend(.TextMatrix(i, COL_附项))
                        If strMsg <> "" Then
                            strMsg = "申请附项""" & strMsg & """没有录入，请确认系统默认填写的信息是否正确。"
                            .Col = col_医嘱内容: blnAppend = True: Exit For
                        End If
                    End If
                                    
                    '互斥数据收集:在所有有效医嘱中,因为可能已校对的与未校对的互斥
                    If Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                        If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                            '用于药品配伍禁忌检查:不分期效
                            str药品IDs = str药品IDs & "," & Val(.TextMatrix(i, COL_诊疗项目ID))
                        ElseIf Not bln配方行 Then
                            '不管检查组合与手术附加内部之间及内部与其它项目之间
                            str诊疗IDs = str诊疗IDs & "," & Val(.TextMatrix(i, COL_诊疗项目ID))
                        End If
                    End If
                End If
            End If
            '申请单的添加，相当于是点击附项的按钮
            If .RowData(i) <> 0 Then
                If Val(.TextMatrix(i, COL_申请序号)) = -1 Then
                    If CanUseApply(.TextMatrix(i, COL_类别)) Then
                        .Col = col_医嘱内容: blnAppend = True: Exit For
                    End If
                End If
            End If
        Next
        '记录下路径外医嘱开始执行时间
        mdatPathOut = Format(IIF(strPathExeDate = "", CDate(0) & "", strPathExeDate), "YYYY-MM-DD")
        '--------------------------------------------------------------------------
        '中间退出的错误提示
        If i <= .Rows - 1 Then
            .Row = i: Call .ShowCell(.Row, .Col)
            If strMsg <> "" Then
                If bln配方行 Then
                    strMsg = "该中药配方" & strMsg
                Else
                    strMsg = """" & .TextMatrix(i, col_医嘱内容) & """" & strMsg
                End If
                If Not blnOut Then '超量说明提示特殊处理
                    MsgBox strMsg, vbInformation, gstrSysName
                End If
                blnOut = False
                .Refresh
            End If
            If .Col = col_医嘱内容 Then
                If txt医嘱内容.Enabled Then txt医嘱内容.SetFocus
            Else
                Call vsAdvice_KeyPress(13)
            End If
            If blnAppend Then '是否弹出申请附项编辑
                If cmdExt.Enabled And cmdExt.Visible Then Call cmdExt_Click
            End If
            Exit Function
        End If
        
        '检查药品配伍禁忌
        If str药品IDs <> "" Then
            If Not Check配伍禁忌(Mid(str药品IDs, 2)) Then Exit Function
        End If
        '检查诊疗项目互斥
        If str诊疗IDs <> "" Then
            If Not Check诊疗互斥(Mid(str诊疗IDs, 2)) Then Exit Function
        End If
    End With
    
    '费用报警:有未校对医嘱时
    If lngCount > 0 Then
        If Not CheckMoney Then Exit Function
    End If
        
    
    '医嘱下达保存之前自动调整顺序
    If mbytUseType = 0 And mblnAdviceSort Then
        If AdviceSort Then
            If MsgBox("本次新开的医嘱已按系统预定顺序重新排列，你要继续保存医嘱吗？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                Exit Function
            End If
        End If
    End If
    
    '生成路径时检查
    If mbytUseType = 1 Then
        '允许一个都不选择，但给予提示
        If bln选择 = False Then
            If MsgBox("你没有选择生成任何医嘱，确定要继续吗？", vbQuestion + vbYesNo + vbDefaultButton1) = vbNo Then
                Exit Function
            End If
        End If
    End If
    
    CheckAdvice = True
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function SeekNextControl() As Boolean
'功能：定位到下一个焦点的控件上,并根据情况决定是否自动新增一行医嘱
'返回：如果通过SetFocus强制定位的,则返回True
    Dim objActive As Object, objNext As Object
    Dim blnDo As Boolean, i As Long
    Dim strSkip As String
    
    Set objActive = Me.ActiveControl
    
    If Not objActive Is Nothing Then
        If TypeName(objActive) = "TextBox" Or TypeName(objActive) = "ComboBox" Then
            If objActive.Container Is fraAdvice Then
                strSkip = GetInputSkip(vsAdvice.Row)
                Set objNext = zlControl.GetNextControl(objActive.TabIndex, Me, strSkip)
                
                '如果是备用医嘱，则先录入医生嘱托
                If objNext.TabIndex = cbo执行科室.TabIndex Then
                    If txt频率.Text = "需要时" Or txt频率.Text = "必要时" Then
                        Set objNext = cbo医生嘱托
                        '用于后面直接得到焦点，而不是调用vbkeytab
                        strSkip = "Test"
                    End If
                ElseIf objActive.TabIndex = cbo医生嘱托.TabIndex Then
                    If txt频率.Text = "需要时" Or txt频率.Text = "必要时" Then
                        Set objNext = cbo执行科室
                        strSkip = "Test"
                    End If
                ElseIf objNext.TabIndex = cbo医生嘱托.TabIndex Then
                    If txt频率.Text = "需要时" Or txt频率.Text = "必要时" Then
                        Set objNext = vsAdvice
                    End If
                End If
                If Not objNext Is Nothing Then
                    If objNext Is vsAdvice Then
                        For i = vsAdvice.Row + 1 To vsAdvice.Rows - 1
                            If Not vsAdvice.RowHidden(i) Then
                                Call AdviceChange '强制更新医嘱内容
                                vsAdvice.Row = i
                                
                                '可能已在其他事件中被定位了，不用重复移动定位表格
                                If Not Me.ActiveControl Is Nothing Then
                                    If Not Me.ActiveControl Is vsAdvice Then
                                        Call zlCommFun.PressKey(vbKeyTab)
                                End If
                                End If
                                '表格行无内容则再移动定位到医嘱输入框
                                blnDo = vsAdvice.RowData(i) <> 0
                                
                                Exit For
                            End If
                        Next
                        If i > vsAdvice.Rows - 1 And (mbytUseType = 0 Or mbytUseType = 2) Then
                            blnDo = True
                            cbsMain.FindControl(, conMenu_New, True, True).Execute
                        End If
                    ElseIf strSkip <> "" And InStr(";" & strSkip & ";", objNext.Name) = 0 Then
                        If objNext.Enabled And objNext.Visible Then
                            blnDo = True
                            objNext.SetFocus
                        End If
                    End If
                End If
            End If
        End If
    End If
    If Not blnDo Then
        Call zlCommFun.PressKey(vbKeyTab)
    Else
        SeekNextControl = True
    End If
End Function

Private Function GetInputSkip(ByVal lngRow As Long) As String
'功能：获取输入医嘱过程中，回车光标应跳过的控件
    Dim strSkip As String, lngFind As Long
    
    With vsAdvice
        '一并给药中的药品输入时应跳过的内容
        If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 And .RowData(lngRow) <> 0 Then
            If Val(.TextMatrix(lngRow, COL_相关ID)) = Val(.TextMatrix(lngRow - 1, COL_相关ID)) Then
                '给药途径,附加执行
                If Val(.TextMatrix(lngRow, COL_相关ID)) <> 0 Then
                    lngFind = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    If lngFind <> -1 Then
                        If Val(.TextMatrix(lngFind, COL_诊疗项目ID)) <> 0 Then
                            strSkip = strSkip & ";" & Me.txt用法.Name
                        End If
                        If Val(.TextMatrix(lngFind, COL_执行科室ID)) <> 0 Then
                            strSkip = strSkip & ";" & Me.cbo附加执行.Name
                        End If
                    End If
                End If
                '频率
                If .TextMatrix(lngRow, COL_频率) <> "" Then strSkip = strSkip & ";" & Me.txt频率.Name
                '执行时间
                If .TextMatrix(lngRow, COL_执行时间) <> "" Then strSkip = strSkip & ";" & Me.cbo执行时间.Name
                '终止时间:因为一般为空，所以后面输入时固定跳过
                strSkip = strSkip & ";" & Me.txt终止时间.Name
                '开嘱医生
                If .TextMatrix(lngRow, COL_开嘱医生) <> "" Then strSkip = strSkip & ";" & Me.cbo医生.Name
                '开嘱时间
                If .TextMatrix(lngRow, COL_开嘱时间) <> "" Then strSkip = strSkip & ";" & Me.txt开嘱时间.Name
            End If
        ElseIf InStr(",C,D,F,G,Z", .TextMatrix(lngRow, COL_类别)) > 0 And .RowData(lngRow) <> 0 And .TextMatrix(lngRow, COL_频率) = "一次性" Then
            strSkip = strSkip & ";" & Me.txt频率.Name
        End If
        If txt首次用量.Enabled Then strSkip = strSkip & ";" & Me.txt首次用量.Name
    End With
    GetInputSkip = Mid(strSkip, 2)
End Function

Private Function AdviceTextChange(ByVal lngRow As Long) As Boolean
'功能：当医嘱卡片输入内容变化时，判断医嘱内容文本是否应该重新组织
    Dim str类别 As String, strText As String, blnDefine As Boolean
    
    With vsAdvice
        '确定医嘱类别
        str类别 = .TextMatrix(lngRow, COL_类别)
        If str类别 = "E" And Val(.TextMatrix(lngRow, COL_相关ID)) = 0 Then '中药配方或一组检验
            lngRow = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
            If lngRow <> -1 Then str类别 = .TextMatrix(lngRow, COL_类别)
        End If
        If str类别 = "7" Then str类别 = "8"
                
        '确定是否定义
        blnDefine = Not mrsDefine Is Nothing And Not mobjVBA Is Nothing
        If blnDefine Then
            mrsDefine.Filter = "诊疗类别='" & str类别 & "'"
            If mrsDefine.EOF Then
                blnDefine = False
            ElseIf Trim(NVL(mrsDefine!医嘱内容)) = "" Then
                blnDefine = False
            End If
        End If
        If blnDefine Then strText = mrsDefine!医嘱内容
        
        '检查内容变动
        If blnDefine Then '公共字段部份或可以公共处理的部份
            If IsDate(msk开始时间.Text) And msk开始时间.Tag <> "" And InStr(strText, "[开始时间]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If IsDate(txt安排时间.Text) And txt安排时间.Tag <> "" Then
                If InStr(strText, "[手术时间]") > 0 Or InStr(strText, "[输血时间]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
            If cbo医生嘱托.Tag <> "" And InStr(strText, "[医生嘱托]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If cmd频率.Tag <> "" And txt频率.Tag <> "" Then
                If InStr(strText, "[中文频率]") > 0 Or InStr(strText, "[英文频率]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
            If cbo执行时间.Tag <> "" And InStr(strText, "[执行时间]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If (IsNumeric(txt单量.Text) Or txt单量.Text = "") And txt单量.Tag <> "" And InStr(strText, "[单量]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If IsNumeric(txt总量.Text) And txt总量.Tag <> "" And InStr(strText, "[总量]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
        End If
        
        Select Case str类别 '不同的类别检查
        Case "5", "6" '中西成药
            If Not blnDefine Then
                
            Else
                '[输入名][通用名][商品名][英文名][规格][产地]是输入或修改整个药品时变化
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" And InStr(strText, "[给药途径]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case "8" '中药配方
            If Not blnDefine Then
                If IsNumeric(txt总量.Text) And txt总量.Tag <> "" Then AdviceTextChange = True: Exit Function
                If cmd频率.Tag <> "" And txt频率.Tag <> "" Then AdviceTextChange = True: Exit Function
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[配方组成][煎法]是输入或修改整个配方时变化
                If IsNumeric(txt总量.Text) And txt总量.Tag <> "" And InStr(strText, "[付数]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" And InStr(strText, "[用法]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case "C" '检验
            If Not blnDefine Then
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[检验项目][检验标本]是输入或修改整个项目时变化
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" And InStr(strText, "[采集方法]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case "D" '检查
            If Not blnDefine Then
                
            Else
                '[检查项目][检查部位]是输入或修改整个项目时变化
            End If
        Case "F" '手术
            If Not blnDefine Then
                If IsDate(txt安排时间.Text) And txt安排时间.Tag <> "" Then AdviceTextChange = True: Exit Function
                If IsDate(msk开始时间.Text) And msk开始时间.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[主要手术][附加手术][麻醉方法]是输入或修改整个项目时变化
            End If
        Case "K" '输血
            If Not blnDefine Then
                If IsDate(txt安排时间.Text) And txt安排时间.Tag <> "" Then AdviceTextChange = True: Exit Function
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[输血途径]
                If Val(cmd用法.Tag) <> 0 And txt用法.Tag <> "" And InStr(strText, "[输血途径]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case Else '其他
            If Not blnDefine Then
                
            Else
                '[诊疗项目]是输入或修改整个项目时变化
            End If
        End Select
    End With
End Function

Private Function AdviceTextMake(ByVal lngRow As Long) As String
'功能：获取医嘱内容文本
'参数：lngRow=已有医嘱数据的可见行
    Dim rsTmp As New ADODB.Recordset
    Dim blnDefine As Boolean, str类别 As String
    Dim strText As String, strSQL As String
    Dim strField As String, int频率范围 As Integer
    Dim i As Long, k As Long
    Dim blnDo As Boolean
    Dim str中药 As String, str煎法 As String, str形态 As String
    Dim str麻醉 As String, str附术 As String
    Dim str检验 As String, str标本 As String
    Dim str部位 As String, str部位Last As String, str方法 As String
    Dim dbl数量 As Double, str中药名称 As String
    Dim str中药诊疗项目IDS As String, strSame As String
    Dim rsCard As New ADODB.Recordset
    
    On Error GoTo errH
    
    With vsAdvice
        '确定医嘱类别
        str类别 = .TextMatrix(lngRow, COL_类别)
        If str类别 = "E" Then '中药配方或一组检验
            k = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
            If k <> -1 Then str类别 = .TextMatrix(k, COL_类别)
        End If
        If str类别 = "7" Then str类别 = "8"
                
        '确定是否定义
        blnDefine = Not mrsDefine Is Nothing And Not mobjVBA Is Nothing
        If blnDefine Then
            mrsDefine.Filter = "诊疗类别='" & str类别 & "'"
            If mrsDefine.EOF Then
                blnDefine = False
            ElseIf Trim(NVL(mrsDefine!医嘱内容)) = "" Then
                blnDefine = False
            End If
        End If
        
ReDoDefault: '用于按定义公式计算失败，重新按缺省规则进行组织
        strText = ""
        If blnDefine Then strText = mrsDefine!医嘱内容
        
        '产生医嘱内容
        Select Case str类别
        Case "C" '检验-------------------------------------------------------------
            str检验 = "": str标本 = ""
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If Val(.TextMatrix(i, COL_组合项目ID)) = 0 And mblnNewLIS Or Not mblnNewLIS Then
                        str检验 = .TextMatrix(i, col_医嘱内容) & "," & str检验
                    End If
                    str标本 = .TextMatrix(i, COL_标本部位)
                Else
                    Exit For
                End If
            Next
            If str检验 = "" Then '老的方式
                str检验 = .TextMatrix(lngRow, COL_名称)
            Else
                str检验 = Left(str检验, Len(str检验) - 1)
            End If
            
            If Not blnDefine Then
                strText = str检验 & IIF(str标本 <> "", "(" & str标本 & ")", "")
            Else
                If InStr(strText, "[检验项目]") > 0 Then
                    strField = str检验
                    strText = Replace(strText, "[检验项目]", """" & strField & """")
                End If
                If InStr(strText, "[检验标本]") > 0 Then
                    strField = str标本
                    strText = Replace(strText, "[检验标本]", """" & strField & """")
                End If
                If InStr(strText, "[采集方法]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_用法)
                    strText = Replace(strText, "[采集方法]", """" & strField & """")
                End If
            End If
        Case "D" '检查-------------------------------------------------------------
            str部位 = "": str方法 = ""
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_标本部位) <> "" Then
                        If .TextMatrix(i, COL_标本部位) <> str部位Last And str部位Last <> "" Then
                            str部位 = str部位 & "," & str部位Last & IIF(str方法 <> "", "(" & Mid(str方法, 2) & ")", "")
                            str方法 = ""
                        End If
                        If .TextMatrix(i, COL_检查方法) <> "" Then
                            str方法 = str方法 & "," & .TextMatrix(i, COL_检查方法)
                        End If
                        
                        str部位Last = .TextMatrix(i, COL_标本部位)
                    End If
                Else
                    Exit For
                End If
            Next
            If str部位Last <> "" Then
                str部位 = str部位 & "," & str部位Last & IIF(str方法 <> "", "(" & Mid(str方法, 2) & ")", "")
            End If
            str部位 = Mid(str部位, 2) '检查组合项目的部位
            
            If Not blnDefine Then
                strText = .TextMatrix(lngRow, COL_名称) & _
                    Decode(Val(.TextMatrix(lngRow, COL_执行标记)), 1, ",床旁执行", 2, ",术中执行", "") & IIF(str部位 <> "", ":" & str部位, "")
            Else
                If InStr(strText, "[检查项目]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_名称) & _
                        Decode(Val(.TextMatrix(lngRow, COL_执行标记)), 1, ",床旁执行", 2, ",术中执行", "")
                    strText = Replace(strText, "[检查项目]", """" & strField & """")
                End If
                If InStr(strText, "[检查部位]") > 0 Then
                    strField = str部位
                    strText = Replace(strText, "[检查部位]", """" & strField & """")
                End If
            End If
        Case "F" '手术-------------------------------------------------------------
            str麻醉 = "": str附术 = ""
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "G" Then
                        str麻醉 = .TextMatrix(i, col_医嘱内容)
                    Else
                        str附术 = str附术 & "," & .TextMatrix(i, col_医嘱内容) & IIF(.TextMatrix(i, COL_执行标记) = "1", "(必要时)", "")
                    End If
                Else
                    Exit For
                End If
            Next
            str附术 = Mid(str附术, 2)
            
            If Not blnDefine Then
                If IsDate(.TextMatrix(lngRow, COL_标本部位)) Then
                    strText = Format(.TextMatrix(lngRow, COL_标本部位), "MM月dd日HH:mm")
                Else
                    strText = Format(.Cell(flexcpData, lngRow, COL_开始时间), "MM月dd日HH:mm")
                End If
                If str麻醉 <> "" Then
                    strText = strText & IIF(str麻醉 <> "", " 在 " & str麻醉 & " 下行 ", " 行 ")
                End If
                strText = strText & .TextMatrix(lngRow, COL_名称) & IIF(.Cell(flexcpData, lngRow, COL_标本部位) = "", "", "(部位:" & .Cell(flexcpData, lngRow, COL_标本部位) & ")")
                If str附术 <> "" Then
                    strText = strText & " 及 " & str附术
                End If
            Else
                If InStr(strText, "[手术时间]") > 0 Then
                    If IsDate(.TextMatrix(lngRow, COL_手术时间)) Then
                        strField = .TextMatrix(lngRow, COL_手术时间)
                    Else
                        strField = .Cell(flexcpData, lngRow, COL_开始时间)
                    End If
                    strText = Replace(strText, "[手术时间]", """" & strField & """")
                End If
                If InStr(strText, "[主要手术]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_名称) & IIF(.Cell(flexcpData, lngRow, COL_标本部位) = "", "", "(部位:" & .Cell(flexcpData, lngRow, COL_标本部位) & ")")
                    strText = Replace(strText, "[主要手术]", """" & strField & """")
                End If
                If InStr(strText, "[附加手术]") > 0 Then
                    strField = str附术
                    strText = Replace(strText, "[附加手术]", """" & strField & """")
                End If
                If InStr(strText, "[麻醉方法]") > 0 Then
                    strField = str麻醉
                    strText = Replace(strText, "[麻醉方法]", """" & strField & """")
                End If
            End If
        Case "8" '中药配方---------------------------------------------------------
            str中药 = "": str煎法 = "": str中药诊疗项目IDS = "": strSame = ""
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "7" Then
                        If InStr("," & str中药诊疗项目IDS & ",", "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & ",") > 0 Then
                            strSame = strSame & "," & Val(.TextMatrix(i, COL_诊疗项目ID))
                        End If
                        str中药诊疗项目IDS = str中药诊疗项目IDS & "," & Val(.TextMatrix(i, COL_诊疗项目ID))
                    End If
                Else
                    Exit For
                End If
            Next
            strSame = Mid(strSame, 2)
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_相关ID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_类别) = "7" Then
                        dbl数量 = dbl数量 + Val(.TextMatrix(i, COL_单量))
                        
                        If Val(.TextMatrix(lngRow, COL_中药形态)) = 0 Then
                            blnDo = .TextMatrix(i, COL_收费细目ID) <> .TextMatrix(i - 1, COL_收费细目ID)
                        Else
                            blnDo = .TextMatrix(i, COL_诊疗项目ID) <> .TextMatrix(i - 1, COL_诊疗项目ID)
                        End If
                        
                        If blnDo Then
                            str中药名称 = .TextMatrix(i, col_医嘱内容)
                            
                            If Val(.TextMatrix(lngRow, COL_中药形态)) = 0 And InStr("," & strSame & ",", "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & ",") > 0 Then
                                strSQL = "Select 规格 as 名称 From 收费项目目录 Where ID=[1] And Exists(Select 1 From 药品规格 Where 药品ID<>[1] And 药名ID=[2])"
                                Set rsTmp = New ADODB.Recordset '清除Filter
                                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(i, COL_收费细目ID)), Val(.TextMatrix(i, COL_诊疗项目ID)))
                                If rsTmp.RecordCount > 0 Then
                                    If Not IsNull(rsTmp!名称) Then str中药名称 = str中药名称 & "(" & rsTmp!名称 & ")"
                                End If
                            End If
                        
                            str中药 = RTrim(str中药名称 & _
                                " " & FormatEx(dbl数量, 5) & .TextMatrix(i, COL_单量单位) & _
                                " " & .TextMatrix(i, COL_医生嘱托)) & "," & str中药
                            dbl数量 = 0
                        End If
                    ElseIf .TextMatrix(i, COL_类别) = "E" Then
                        str煎法 = .TextMatrix(i, col_医嘱内容) & .TextMatrix(i, COL_标本部位)
                    End If
                Else
                    Exit For
                End If
            Next
            If str中药 <> "" Then
                str中药 = Mid(str中药, 1, Len(str中药) - 1)
            End If
            If Not blnDefine Or .TextMatrix(lngRow, COL_期效) = "长嘱" Then
                If .TextMatrix(lngRow, COL_中药形态) = "1" Then
                    str形态 = "[饮片]"
                ElseIf .TextMatrix(lngRow, COL_中药形态) = "2" Then
                    str形态 = "[免煎剂]"
                End If
                
                '数字后加了空格在文本框中会自动换行
                If .TextMatrix(lngRow, COL_期效) = "长嘱" Then
                    '长嘱配方内容付数不好处理，暂用固定规则
                    strText = "中药配方" & str形态 & "," & _
                        .TextMatrix(lngRow, COL_频率) & "," & str煎法 & "," & _
                        .TextMatrix(lngRow, COL_用法) & ":" & str中药
                Else
                    strText = "中药" & str形态 & .TextMatrix(lngRow, COL_总量) & "付," & _
                        .TextMatrix(lngRow, COL_频率) & "," & str煎法 & "," & _
                        .TextMatrix(lngRow, COL_用法) & ":" & str中药
                End If
            Else
                If InStr(strText, "[付数]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_总量)
                    strText = Replace(strText, "[付数]", """" & strField & """")
                End If
                If InStr(strText, "[配方组成]") > 0 Then
                    strField = str中药
                    strText = Replace(strText, "[配方组成]", """" & strField & """")
                End If
                If InStr(strText, "[用法]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_用法)
                    strText = Replace(strText, "[用法]", """" & strField & """")
                End If
                If InStr(strText, "[煎法]") > 0 Then
                    strField = str煎法
                    strText = Replace(strText, "[煎法]", """" & strField & """")
                End If
            End If
        Case "4" '卫材------------------------------------------------------------
            If Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
                strSQL = "Select 名称,规格,产地 From 收费项目目录 Where ID=[1]"
                Set rsTmp = New ADODB.Recordset '清除Filter
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_收费细目ID)))
            ElseIf blnDefine Then
                strSQL = "Select 名称,NULL as 规格,NULL as 产地 From 诊疗项目目录 Where ID=[1]"
                Set rsTmp = New ADODB.Recordset '清除Filter
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_诊疗项目ID)))
            End If
            If Not blnDefine Then
                strText = .TextMatrix(lngRow, COL_名称)
                If Not IsNull(rsTmp!规格) Then
                    strText = strText & " " & rsTmp!规格
                End If
            Else
                If InStr(strText, "[卫生材料]") > 0 Then
                    strField = rsTmp!名称
                    strText = Replace(strText, "[卫生材料]", """" & strField & """")
                End If
                If InStr(strText, "[规格]") > 0 Then
                    strField = NVL(rsTmp!规格)
                    strText = Replace(strText, "[规格]", """" & strField & """")
                End If
                If InStr(strText, "[产地]") > 0 Then
                    strField = NVL(rsTmp!产地)
                    strText = Replace(strText, "[产地]", """" & strField & """")
                End If
            End If
        Case "5", "6" '西成药，中成药---------------------------------------------
            If Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
                '性质:0-正名,1-英文名,3-商品名
                strSQL = "Select Nvl(B.名称,A.名称) as 名称,A.规格,A.产地,B.性质" & _
                    " From 收费项目目录 A,收费项目别名 B Where A.ID=B.收费细目ID(+) And A.ID=[1] Order by B.性质,B.码类"
                Set rsTmp = New ADODB.Recordset '清除Filter
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_收费细目ID)))
            ElseIf blnDefine Then
                '性质:0-正名,1-英文名
                strSQL = "Select Nvl(B.名称,A.名称) as 名称,Null as 规格,Null as 产地,B.性质" & _
                    " From 诊疗项目目录 A,诊疗项目别名 B Where A.ID=B.诊疗项目ID(+) And A.ID=[1] Order by B.性质,B.码类"
                Set rsTmp = New ADODB.Recordset '清除Filter
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_诊疗项目ID)))
            End If
            If Not blnDefine Then
                strText = .TextMatrix(lngRow, COL_标本部位)
                If Val(.TextMatrix(lngRow, COL_收费细目ID)) <> 0 Then
                    If strText = "" Then
                        If gbyt药品名称显示 <> 0 Then rsTmp.Filter = "性质=3"
                        If rsTmp.EOF Then rsTmp.Filter = 0
                        strText = rsTmp!名称
                    End If
                    If Not IsNull(rsTmp!产地) Then
                        strText = strText & "(" & rsTmp!产地 & ")"
                    End If
                    If Not IsNull(rsTmp!规格) Then
                        strText = strText & " " & rsTmp!规格
                    End If
                Else
                    If strText = "" Then
                        strText = .TextMatrix(lngRow, COL_名称)
                    End If
                End If
            Else
                If InStr(strText, "[输入名]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_标本部位)
                    If strField = "" Then
                        If gbyt药品名称显示 <> 0 Then rsTmp.Filter = "性质=3"
                        If rsTmp.EOF Then rsTmp.Filter = 0
                        strField = rsTmp!名称
                    End If
                    strText = Replace(strText, "[输入名]", """" & strField & """")
                End If
                If InStr(strText, "[通用名]") > 0 Then
                    rsTmp.Filter = 0
                    strField = rsTmp!名称
                    strText = Replace(strText, "[通用名]", """" & strField & """")
                End If
                If InStr(strText, "[商品名]") > 0 Then
                    rsTmp.Filter = "性质=3"
                    If rsTmp.EOF Then
                        strField = ""
                    Else
                        strField = rsTmp!名称
                    End If
                    strText = Replace(strText, "[商品名]", """" & strField & """")
                End If
                If InStr(strText, "[英文名]") > 0 Then
                    rsTmp.Filter = "性质=2"
                    If rsTmp.EOF Then
                        strField = ""
                    Else
                        strField = rsTmp!名称
                    End If
                    strText = Replace(strText, "[英文名]", """" & strField & """")
                End If
                If InStr(strText, "[规格]") > 0 Then
                    If rsTmp.EOF Then rsTmp.Filter = 0
                    strField = NVL(rsTmp!规格)
                    strText = Replace(strText, "[规格]", """" & strField & """")
                End If
                If InStr(strText, "[产地]") > 0 Then
                    If rsTmp.EOF Then rsTmp.Filter = 0
                    strField = NVL(rsTmp!产地)
                    strText = Replace(strText, "[产地]", """" & strField & """")
                End If
                If InStr(strText, "[给药途径]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_用法)
                    strText = Replace(strText, "[给药途径]", """" & strField & """")
                End If
            End If
        Case "K" '输血医嘱
            If Not blnDefine Then
                If IsDate(.TextMatrix(lngRow, COL_输血时间)) Then
                    strText = Format(.TextMatrix(lngRow, COL_输血时间), "MM月dd日HH:mm")
                Else
                    strText = Format(.Cell(flexcpData, lngRow, COL_开始时间), "MM月dd日HH:mm")
                End If
            
                strText = "于" & strText & "输" & .TextMatrix(lngRow, COL_名称)
                If .TextMatrix(lngRow, COL_用法) <> "" Then
                    strText = strText & "(" & .TextMatrix(lngRow, COL_用法) & ")"
                End If
            Else
                If InStr(strText, "[输血时间]") > 0 Then
                    If IsDate(.TextMatrix(lngRow, COL_输血时间)) Then
                        strField = .TextMatrix(lngRow, COL_输血时间)
                    Else
                        strField = .Cell(flexcpData, lngRow, COL_开始时间)
                    End If
                    strText = Replace(strText, "[输血时间]", """" & strField & """")
                End If
                If InStr(strText, "[诊疗项目]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_名称)
                    strText = Replace(strText, "[诊疗项目]", """" & strField & """")
                End If
                If InStr(strText, "[输血项目]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_名称)
                    strText = Replace(strText, "[输血项目]", """" & strField & """")
                End If
                If InStr(strText, "[输血途径]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_用法)
                    strText = Replace(strText, "[输血途径]", """" & strField & """")
                End If
                If TypeName(.Cell(flexcpData, lngRow, COL_申请序号)) = "Recordset" Then
                    Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_申请序号))
                    If InStr(strText, "[血型]") > 0 Then
                        If rsCard.EOF Then
                            strField = ""
                        Else
                            strField = Decode(Val("" & rsCard!血型), 1, "A", 2, "B", 3, "O", 4, "AB", "")
                        End If
                        strText = Replace(strText, "[血型]", """" & strField & """")
                    End If
                    If InStr(strText, "[RH]") > 0 Then
                        If rsCard.EOF Then
                            strField = ""
                        Else
                            strField = Decode(Val("" & rsCard!RHD), 1, "-", 2, "+", "")
                        End If
                        strText = Replace(strText, "[RH]", """" & strField & """")
                    End If
                End If
                
                If InStr(strText, "[执行分类]") > 0 Then
                    strField = Val(.TextMatrix(lngRow + 1, COL_执行分类))
                    strText = Replace(strText, "[执行分类]", """" & strField & """")
                End If
            End If
        Case Else '其它所有类别-----------------------------------------------------
            If Not blnDefine Then
                strText = .TextMatrix(lngRow, COL_名称)
            Else
                If InStr(strText, "[诊疗项目]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_名称)
                    strText = Replace(strText, "[诊疗项目]", """" & strField & """")
                End If
            End If
            '术后医嘱特殊显示
            If .TextMatrix(lngRow, COL_类别) = "Z" And (Val(.TextMatrix(lngRow, COL_操作类型)) = 4 Or Val(.TextMatrix(lngRow, COL_操作类型)) = 14) Then
                strText = "━━━" & strText & "━━━"
            End If
            '转科医嘱特殊显示
            If .TextMatrix(lngRow, COL_类别) = "Z" And Val(.TextMatrix(lngRow, COL_操作类型)) = 3 Then
                strText = "━━━" & strText & "━━━"
            End If
        End Select
        
        '公共字段或可以公共处理的字段-------------------------------------------
        If blnDefine Then
            If InStr(strText, "[开始时间]") > 0 Then
                strField = .Cell(flexcpData, lngRow, COL_开始时间)
                strText = Replace(strText, "[开始时间]", """" & strField & """")
            End If
            If InStr(strText, "[医生嘱托]") > 0 Then
                strField = .Cell(flexcpData, lngRow, COL_医生嘱托)
                If .TextMatrix(lngRow, COL_医生嘱托) <> "" Then
                    If strField <> "" Then
                        strField = strField & "," & .TextMatrix(lngRow, COL_医生嘱托)
                    Else
                        strField = .TextMatrix(lngRow, COL_医生嘱托)
                    End If
                End If
                strText = Replace(strText, "[医生嘱托]", """" & strField & """")
            End If
            If InStr(strText, "[中文频率]") > 0 Then
                strField = .TextMatrix(lngRow, COL_频率)
                strText = Replace(strText, "[中文频率]", """" & strField & """")
            End If
            If InStr(strText, "[英文频率]") > 0 Then
                strField = ""
                If .TextMatrix(lngRow, COL_频率) <> "" Then
                    int频率范围 = Get频率范围(lngRow)
                    strSQL = "Select 英文名称 From 诊疗频率项目 Where 名称=[1] And 适用范围=[2]"
                    Set rsTmp = New ADODB.Recordset '清除Filter
                    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, .TextMatrix(lngRow, COL_频率), int频率范围)
                    If Not rsTmp.EOF Then strField = NVL(rsTmp!英文名称)
                End If
                strText = Replace(strText, "[英文频率]", """" & strField & """")
            End If
            If InStr(strText, "[单量]") > 0 Then
                strField = ""
                If .TextMatrix(lngRow, COL_单量) <> "" Then
                    strField = .TextMatrix(lngRow, COL_单量) & .TextMatrix(lngRow, COL_单量单位)
                End If
                strText = Replace(strText, "[单量]", """" & strField & """")
            End If
            If InStr(strText, "[总量]") > 0 Then
                strField = ""
                If .TextMatrix(lngRow, COL_总量) <> "" Then
                    strField = .TextMatrix(lngRow, COL_总量) & .TextMatrix(lngRow, COL_总量单位)
                End If
                strText = Replace(strText, "[总量]", """" & strField & """")
            End If
            If InStr(strText, "[执行时间]") > 0 Then
                strField = .TextMatrix(lngRow, COL_执行时间)
                strText = Replace(strText, "[执行时间]", """" & strField & """")
            End If
        End If
                
        '计算医嘱内容
        If blnDefine Then
            On Error Resume Next
            strText = mobjVBA.Eval(strText)
            If mobjVBA.Error.Number <> 0 Then
                err.Clear: On Error GoTo errH
                blnDefine = False: GoTo ReDoDefault
            End If
        End If
    End With
    AdviceTextMake = strText
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub AdviceCopyCurr(ByVal lngRow As Long)
'功能：根据指定行的医嘱复制产生新的医嘱
    Dim lngBegin As Long, lngEnd As Long
    Dim lngStart As Long, lngOver As Long
    Dim lng序号 As Long, dbl相关ID As Double
    Dim lngShow As Long, curDate As Date
    Dim i As Long, j As Long
    Dim bln附项 As Boolean, lng执行科室ID As Long
    
    Dim lng开嘱科室ID As Long, str开嘱医生 As String
    Dim bln药品小数输入 As Boolean
    Dim str高危药品 As String
    
    Dim strSor As String '药品类别
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim lng西药房ID As Long, lng成药房ID As Long, lng中药房ID As Long, lng发料部门ID As Long
    Dim str药房IDs As String
    
    curDate = zlDatabase.Currentdate
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    
    With vsAdvice
        '复制前先检查权限
        strSor = ""
        For i = lngBegin To lngEnd
            If InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 Then
                If .TextMatrix(i, COL_毒理分类) = "麻醉药" And Not mblnPrivsNar Then
                    strSor = "麻醉"
                ElseIf .TextMatrix(i, COL_毒理分类) = "毒性药" And Not mblnPrivsPoi Then
                    strSor = "毒性"
                ElseIf .TextMatrix(i, COL_毒理分类) = "精神I类" And Not mblnPrivsMin Then
                    strSor = "精神I"
                ElseIf .TextMatrix(i, COL_诊疗项目ID) <> "" And Not mblnPrivsPre Then
                    '获取药品的价值分类
                    strSQL = "Select 价值分类 From 药品特性 Where 药名id = [1]"
                    On Error GoTo errH
                    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(i, COL_诊疗项目ID)))
                    If rsTmp.RecordCount > 0 Then
                        If rsTmp!价值分类 = "昂贵" Then
                            strSor = "昂贵"
                        ElseIf rsTmp!价值分类 = "贵重" Then
                            strSor = "贵重"
                        End If
                    End If
                End If
                If strSor <> "" Then
                    MsgBox "因为医嘱""" & .TextMatrix(i, col_医嘱内容) & """是" & strSor & "类药品，而你没有下达" & strSor & "类药品的权限，该医嘱不能被复制。", vbInformation, gstrSysName
                    Exit Sub
                End If
            End If
            If Not Check项目Enalble(Val(.TextMatrix(i, COL_诊疗项目ID)), Val(.TextMatrix(i, COL_收费细目ID)), 2, .TextMatrix(i, COL_类别)) Then
                MsgBox "因为医嘱""" & .TextMatrix(i, col_医嘱内容) & """已经撤档或不服务于住院或类别改变，该医嘱不能被复制。", vbInformation, gstrSysName
                Exit Sub
            End If
            '输血医嘱检查，必须中级及以上专业技术职务的医师才允许下达
            If .TextMatrix(i, COL_类别) = "K" And gbln输血申请中级以上 Then
                If UserInfo.专业技术职务 <> "主治医师" And UserInfo.专业技术职务 <> "主任医师" And UserInfo.专业技术职务 <> "副主任医师" Then
                    MsgBox "启用了输血分级管理后，输血医嘱只有中级及以上专业技术职务医师才能下达。", vbInformation, Me.Caption
                    Exit Sub
                End If
            End If
        Next i
        
        '取开嘱医生和科室
        If mint场合 = 1 Then
            str开嘱医生 = .TextMatrix(lngRow, COL_开嘱医生)
            If str开嘱医生 Like "*/*" Then
                str开嘱医生 = Mid(str开嘱医生, InStr(str开嘱医生, "/") + 1)
            End If
            If mintPState = ps最近转出 Then
                lng开嘱科室ID = mlng病人科室id
            Else
                lng开嘱科室ID = .TextMatrix(lngRow, COL_开嘱科室ID)
            End If
        Else
            str开嘱医生 = UserInfo.姓名
            If mintPState = ps最近转出 Then
                lng开嘱科室ID = mlng病人科室id
            Else
                lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
            End If
        End If
        '药品总量是否可以输入小数，中药不可以输入小数，因此只检查西药与中成药
        bln药品小数输入 = InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") > 0
        .Redraw = flexRDNone
        For i = lngBegin To lngEnd
            If .RowData(i) <> 0 Then
                '添加新行
                If .RowData(.Rows - 1) <> 0 Then .AddItem "", .Rows
                lngRow = .Rows - 1
                If lngStart = 0 Then lngStart = lngRow
                lngOver = lngRow
                
                '医嘱起始序号
                If lng序号 = 0 Then
                    lng序号 = GetCurRow序号(lngRow)
                End If
                
                '复制内容'临床路径项目属性不复制，超量说明不复制
                '--------------------------------------------------------------------------------
                For j = 0 To .Cols - 1
                    If InStr("," & COL_路径项目ID & "," & COL_路径执行方式 & "," & COL_路径执行ID & "," & COL_操作时间 & "," & COL_超量说明 & "," & COL_用药目的 & "," & COL_申请序号 & "," & COL_皮试结果 & "," & COL_处方审查状态 & "," & COL_处方审查结果 & ",", "," & j & ",") = 0 _
                                           And (j <> COL_标本部位 Or InStr(",F,K,", "," & .TextMatrix(i, COL_类别) & ",") = 0) Then
                        .TextMatrix(lngRow, j) = .TextMatrix(i, j)
                        .Cell(flexcpData, lngRow, j) = .Cell(flexcpData, i, j)
                        .Cell(flexcpFontBold, lngRow, j) = .Cell(flexcpFontBold, i, j) '毒麻药品标识
                    End If
                Next
                
                If Not mbln天数 Then
                    .TextMatrix(lngRow, COL_天数) = ""
                    .Cell(flexcpData, lngRow, COL_天数) = ""
                End If
                
                .Cell(flexcpData, lngRow, COL_频率) = "1"
                
                '抗菌药物缺省用药目的
                If Val(.TextMatrix(lngRow, COL_抗菌等级)) > 0 Then .TextMatrix(lngRow, COL_用药目的) = mstrPurMed
                .RowData(lngRow) = .RowData(i)
                .RowHidden(lngRow) = .RowHidden(i)
                .RowHeight(lngRow) = .RowHeight(i)
                If Val(.TextMatrix(lngRow, COL_诊疗项目ID)) <> 0 Then
                    Set rsTmp = Get诊疗项目记录(Val(.TextMatrix(lngRow, COL_诊疗项目ID)))
                    strSor = rsTmp!名称 & ""
                    If strSor <> "" Then
                        .TextMatrix(lngRow, col_医嘱内容) = Sys.RowValue("诊疗项目目录", Val(.TextMatrix(lngRow, COL_诊疗项目ID)), "名称")
                    End If
                    '重新获取诊疗项目计价性质
                    .TextMatrix(lngRow, COL_计价性质) = rsTmp!计价性质 & ""
                End If
                '调整内容
                '--------------------------------------------------------------------------------
                .RowData(lngRow) = -1 * (Val(.RowData(lngRow)) + 0.1)
                If Val(.TextMatrix(lngRow, COL_相关ID)) <> 0 Then
                    .TextMatrix(lngRow, COL_相关ID) = -1 * (Val(.TextMatrix(lngRow, COL_相关ID)) + 0.1)
                End If
                
                .TextMatrix(lngRow, COL_EDIT) = 1 '新增
                .TextMatrix(lngRow, COL_状态) = IIF(mbln暂存, -1, 1) '新开
                .TextMatrix(lngRow, COL_序号) = lng序号
                lng序号 = lng序号 + 1
                
                If mintPState = ps最近转出 And gbln只允许补录临嘱 = True Or mintPState = ps预出 Or mintPState = ps出院 Then
                    .TextMatrix(lngRow, COL_期效) = "临嘱"
                    
                    If mintPState = ps最近转出 Then
                        .TextMatrix(lngRow, COL_执行科室ID) = mlng病人科室id
                    End If
                End If
                
                '检查执行科室的有效性
                lng执行科室ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
                .TextMatrix(lngRow, COL_执行科室ID) = ""
                If .TextMatrix(lngRow, COL_类别) = "Z" Then
                    .TextMatrix(lngRow, COL_执行科室ID) = lng执行科室ID
                ElseIf Val(.TextMatrix(lngRow, COL_诊疗项目ID)) = 0 Then
                    '自由录入医嘱执行科室和录入自由录入医嘱时的默认科室保持一直
                    .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, "*", 0, 0, 4, mlng病人科室id, 0, IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                ElseIf InStr(",0,5,", Val(.TextMatrix(lngRow, COL_执行性质))) = 0 Then
                    If lng执行科室ID <> 0 Then
                        If InStr(",5,6,7,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                            str药房IDs = Get可用药房IDs(.TextMatrix(lngRow, COL_类别), Val(.TextMatrix(lngRow, COL_诊疗项目ID)), Val(.TextMatrix(lngRow, COL_收费细目ID)), mlng病人科室id, 2)
                            If InStr("," & str药房IDs & ",", "," & lng执行科室ID & ",") > 0 Then
                                .TextMatrix(lngRow, COL_执行科室ID) = lng执行科室ID
                            End If
                        ElseIf .TextMatrix(lngRow, COL_类别) = "4" Then
                            str药房IDs = Get可用发料部门IDs(Val(.TextMatrix(lngRow, COL_收费细目ID)), mlng病人科室id, 2)
                            If InStr("," & str药房IDs & ",", "," & lng执行科室ID & ",") > 0 Then
                                .TextMatrix(lngRow, COL_执行科室ID) = lng执行科室ID
                            End If
                        ElseIf Val(.TextMatrix(lngRow, COL_执行性质)) = 4 Then
                            '"4-指定科室"时才取,其它的固定生成
                            .TextMatrix(lngRow, COL_执行科室ID) = lng执行科室ID
                            '检查执行科室的有效性
                            If lng执行科室ID <> 0 Then
                                If CheckExecDeptValidate(lng执行科室ID, mlng病人科室id, IIF(mlng病人性质 = 1, 1, 2), Val(.TextMatrix(lngRow, COL_诊疗项目ID))) = False Then
                                    .TextMatrix(lngRow, COL_执行科室ID) = ""
                                End If
                            End If
                        End If
                    End If
                    If Val(.TextMatrix(lngRow, COL_执行科室ID)) = 0 Then
                        '药品、卫材类
                        If .TextMatrix(lngRow, COL_类别) = "5" Then
                            If lng西药房ID = 0 Then
                                lng西药房ID = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, .TextMatrix(lngRow, COL_类别), Val(.TextMatrix(lngRow, COL_诊疗项目ID)), Val(.TextMatrix(lngRow, COL_收费细目ID)), 4, mlng病人科室id, 0, IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                            End If
                            .TextMatrix(lngRow, COL_执行科室ID) = lng西药房ID
                        ElseIf .TextMatrix(lngRow, COL_类别) = "6" Then
                            If lng成药房ID = 0 Then
                                lng成药房ID = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, .TextMatrix(lngRow, COL_类别), Val(.TextMatrix(lngRow, COL_诊疗项目ID)), Val(.TextMatrix(lngRow, COL_收费细目ID)), 4, mlng病人科室id, 0, IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                            End If
                            .TextMatrix(lngRow, COL_执行科室ID) = lng成药房ID
                        ElseIf .TextMatrix(lngRow, COL_类别) = "7" Then
                            If lng中药房ID = 0 Then
                                lng中药房ID = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, .TextMatrix(lngRow, COL_类别), Val(.TextMatrix(lngRow, COL_诊疗项目ID)), Val(.TextMatrix(lngRow, COL_收费细目ID)), 4, mlng病人科室id, 0, IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), True, 0, 2)
                            End If
                            .TextMatrix(lngRow, COL_执行科室ID) = lng中药房ID
                        ElseIf .TextMatrix(lngRow, COL_类别) = "4" Then
                            If lng发料部门ID = 0 Then
                                lng发料部门ID = Get收费执行科室ID(mlng病人ID, mlng主页ID, .TextMatrix(lngRow, COL_类别), Val(.TextMatrix(lngRow, COL_收费细目ID)), 4, mlng病人科室id, lng开嘱科室ID, IIF(mlng病人性质 = 1, 1, 2), , 1, , 2)
                            End If
                            .TextMatrix(lngRow, COL_执行科室ID) = lng发料部门ID
                        ElseIf Val(.TextMatrix(lngRow, COL_诊疗项目ID)) <> 0 Then
                            .TextMatrix(lngRow, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, .TextMatrix(lngRow, COL_类别), _
                                Val(.TextMatrix(lngRow, COL_诊疗项目ID)), 0, Val(.TextMatrix(lngRow, COL_执行性质)), mlng病人科室id, lng开嘱科室ID, IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                        End If
                    End If
                End If
                
                '开始时间
                .TextMatrix(lngRow, COL_开始时间) = GetDefaultTime(lngRow)
                .Cell(flexcpData, lngRow, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
                
                If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                    If Not bln药品小数输入 And InStr(.TextMatrix(lngRow, COL_总量), ".") > 0 And Val(.TextMatrix(lngRow, COL_可否分零)) = 0 Then .TextMatrix(lngRow, COL_总量) = IntEx(Val(.TextMatrix(lngRow, COL_总量)))
                    '连续用药
                    If Set药品连续用药(mlng病人ID, mlng主页ID, Val(.TextMatrix(lngRow, COL_诊疗项目ID)), Val(.TextMatrix(lngRow, COL_收费细目ID))) Then
                        .TextMatrix(lngRow, COL_皮试结果) = "连续用药"
                        .Cell(flexcpData, lngRow, COL_皮试结果) = "连续用药"
                    End If
                End If
                '手术/输血时间：复制时缺省与开始时间相同
                If .TextMatrix(lngRow, COL_类别) = "K" Or .TextMatrix(lngRow, COL_类别) = "F" Or .TextMatrix(lngRow, COL_类别) = "G" _
                    And Val(.TextMatrix(lngRow, COL_相关ID)) = Val(.TextMatrix(lngRow - 1, COL_相关ID)) Then
                    .TextMatrix(lngRow, COL_手术时间) = .TextMatrix(lngRow, COL_开始时间)
                End If

                If gbln血库系统 Then
                     If .TextMatrix(lngRow - 1, COL_类别) = "K" And .RowData(lngRow - 1) = Val(.TextMatrix(lngRow, COL_相关ID)) And .TextMatrix(lngRow, COL_类别) = "E" Then
                        If Val(.TextMatrix(lngRow, COL_操作类型)) = 8 And Val(.TextMatrix(lngRow, COL_执行分类)) = 1 Then
                            If .TextMatrix(lngRow - 1, COL_检查方法) <> "1" Then
                               .TextMatrix(lngRow - 1, COL_检查方法) = "1"
                            End If
                        End If
                    End If
                End If
                
                '检验医嘱采集时间
                If .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "6" Then
                    .TextMatrix(lngRow, COL_采集时间) = .TextMatrix(lngRow, COL_开始时间)
                End If
                
                '配方长嘱终止时间:根据开始时间、付数、频次,执行时间自动确定
                .TextMatrix(lngRow, COL_终止时间) = "": .Cell(flexcpData, lngRow, COL_终止时间) = Empty
                
                '紧急标志
                .TextMatrix(lngRow, COL_标志) = 0
                If IsDate(.Cell(flexcpData, lngRow, COL_开始时间)) Then
                    If DateDiff("n", CDate(.Cell(flexcpData, lngRow, COL_开始时间)), curDate) > gint补录间隔 _
                        Or mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                        .TextMatrix(lngRow, COL_标志) = 2
                    End If
                End If
                
                '重设审核状态
                If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(lngRow, COL_抗菌等级)) And (.TextMatrix(lngRow, COL_标志) <> "1" Or .TextMatrix(lngRow, COL_期效) = "长嘱") _
                    Or gbln手术分级管理 And (.TextMatrix(lngRow, COL_类别) = "F" Or .TextMatrix(lngRow, COL_类别) = "G") Then
                    .TextMatrix(lngRow, COL_审核状态) = 1
                Else
                    .TextMatrix(lngRow, COL_审核状态) = ""
                End If
                
                If .TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "8" And Val(.TextMatrix(lngRow, COL_相关ID)) <> 0 Then
                    strSQL = ""
                    strSQL = GetBloodState(IIF(.TextMatrix(lngRow, COL_标志) = "1", 1, 0), Val(.TextMatrix(lngRow, COL_执行分类)))
                    .TextMatrix(lngRow - 1, COL_审核状态) = strSQL
                    .TextMatrix(lngRow, COL_审核状态) = strSQL
                End If
                
                If Val(.TextMatrix(lngRow, COL_抗菌等级)) > 0 Then .TextMatrix(lngRow, COL_用药目的) = mstrPurMed
                
                .TextMatrix(lngRow, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_开嘱时间) = Format(curDate, "yyyy-MM-dd HH:mm")
                
                If Val(.TextMatrix(lngRow, COL_高危药品)) <> 0 Then
                    str高危药品 = str高危药品 & vbCrLf & .TextMatrix(lngRow, col_医嘱内容) & ":" & Decode(Val(.TextMatrix(lngRow, COL_高危药品)), 1, "A", 2, "B", 3, "C", "") & "级；"
                End If
                
                .TextMatrix(lngRow, COL_开嘱医生) = str开嘱医生
                .TextMatrix(lngRow, COL_开嘱科室ID) = lng开嘱科室ID
                .TextMatrix(lngRow, COL_校对护士) = ""
                .TextMatrix(lngRow, COL_签名否) = ""
                
                If Val(.TextMatrix(lngRow, COL_执行标记)) = -1 Then .TextMatrix(lngRow, COL_执行标记) = 0
                
                Call SetRow标志图标(lngRow, 1)
                
                '产生新嘱时，在可见行读取诊疗项目附项串，用于检查，不用于保存
                If Not .RowHidden(lngRow) Then
                    If Not RowIn配方行(lngRow) Then
                        If RowIn检验行(lngRow) Then
                            j = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
                            If j <> -1 Then
                                .TextMatrix(lngRow, COL_附项) = Get医嘱项目附件(Val(.TextMatrix(j, COL_诊疗项目ID)))
                            End If
                        Else
                            .TextMatrix(lngRow, COL_附项) = Get医嘱项目附件(Val(.TextMatrix(lngRow, COL_诊疗项目ID)))
                        End If
                        If .TextMatrix(lngRow, COL_附项) <> "" Then bln附项 = True
                    End If
                End If
            End If
        Next
        
        '产生假医嘱ID
        '--------------------------------------------------------------------------------
        For i = lngStart To lngOver
            dbl相关ID = .RowData(i)
            .RowData(i) = GetNext医嘱ID
            For j = i - 1 To lngStart Step -1
                If Val(.TextMatrix(j, COL_相关ID)) = dbl相关ID Then
                    .TextMatrix(j, COL_相关ID) = .RowData(i)
                Else
                    Exit For
                End If
            Next
            For j = i + 1 To lngOver
                If Val(.TextMatrix(j, COL_相关ID)) = dbl相关ID Then
                    .TextMatrix(j, COL_相关ID) = .RowData(i)
                Else
                    Exit For
                End If
            Next
            
            '定位到第一个可见行
            If Not .RowHidden(i) And lngShow = 0 Then lngShow = i
            
            '处理医嘱内容的变化
            If Not .RowHidden(i) Then
                If Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                    .TextMatrix(i, col_医嘱内容) = AdviceTextMake(i)
                End If
            End If
        Next
        '----产生申请序号
        If gblnIn必用 Then Call MakeAppNo(1, lngStart, lngOver)
        
         '路径病人添加医嘱时检查是否是路径内项目
        If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngStart, lngOver)
        
        '图标对齐:设置为中对齐,不然擦边框时可能有问题
        .Cell(flexcpPictureAlignment, .FixedRows, 0, .Rows - 1, .FixedCols - 1) = 4
        
        '复制后刷新
        '--------------------------------------------------------------------------------
        mblnRowChange = False
        .Row = lngShow
        mblnRowChange = True
        Call .ShowCell(.Row, .Col): .TopRow = .Row
        Call vsAdvice_AfterRowColChange(-1, -1, .Row, .Col)
        .Redraw = flexRDDirect
        
        mblnNoSave = True '标记为未保存
    End With
    
    If str高危药品 <> "" Then
        MsgBox "以下医嘱是高危药品：" & str高危药品, vbInformation, gstrSysName
    End If
    
    If bln附项 And cmdExt.Enabled And cmdExt.Visible Then Call cmdExt_Click
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function CanAlterType(ByVal lngRow As Long, blnNeedSpec As Boolean) As Boolean
'功能：判断指定的医嘱是否可以切换期效
'参数：lngRow=可见的医嘱行
'返回：blnNeedSpec=表示允许切换，但需要指定药品规格
'说明：允许切换期效的条件：
'   1.成长嘱：执行频率=0(可选频率),2(持续性)
'   2.成临嘱：执行频率=0(可选频率),1(一次性);药品必须指定了规格
    Dim rsMore As New ADODB.Recordset
    Dim strSQL As String, strType As String, i As Long
    Dim lngBegin As Long, lngEnd As Long
    
    blnNeedSpec = False
    
    With vsAdvice
        If .RowData(lngRow) = 0 Then
            CanAlterType = True: Exit Function
        ElseIf Val(.TextMatrix(lngRow, COL_诊疗项目ID)) = 0 Then
            '自由输入的可以切换
            CanAlterType = True: Exit Function
        ElseIf RowIn配方行(lngRow) Then
            '中药配方固定可以切换
            CanAlterType = True: Exit Function
        ElseIf RowIn检验行(lngRow) Then
            '检验以检验行为准判断
            lngRow = .FindRow(CStr(.RowData(lngRow)), , COL_相关ID)
            If lngRow = -1 Then Exit Function
        End If
    
        strType = IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", "临嘱", "长嘱")
        
        '以原始频率为准判断:因为可选择频率的可能已缺成一次性
        strSQL = "Select 执行频率 From 诊疗项目目录 Where ID=[1]"
        On Error GoTo errH
        Set rsMore = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_诊疗项目ID)))
        
        If strType = "长嘱" Then
            If InStr(",0,2,", NVL(rsMore!执行频率, 0)) = 0 Then Exit Function
        Else
            If InStr(",0,1,", NVL(rsMore!执行频率, 0)) = 0 Then Exit Function
            
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                Call GetRowScope(lngRow, lngBegin, lngEnd)
                For i = lngBegin To lngEnd
                    If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                        'If Val(.TextMatrix(i, COL_收费细目ID)) = 0 Then Exit Function
                        If Val(.TextMatrix(i, COL_收费细目ID)) = 0 Then
                            blnNeedSpec = True: Exit For
                        End If
                    End If
                Next
            End If
        End If
    End With
    CanAlterType = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub AdviceAlterType(ByVal lngRow As Long, Optional ByVal strSpec As String)
'功能：在尽量保持数据的情况下，切换指定行医嘱的期效(长期<->临时)
'参数：lngRow=可见的医嘱行
'      strSpec=药品医嘱的药品规格ID，格式如"医嘱ID,药品ID;..."
'说明：执行该函数时应保证已用CanAlterType函数进行了判断
    Dim rsMore As New ADODB.Recordset
    Dim rsDrug As ADODB.Recordset
    Dim strType As String, strSQL As String
    Dim int频率性质 As Integer, sng天数 As Single
    Dim str频率 As String, int频率次数 As Integer
    Dim int频率间隔 As Integer, str间隔单位 As String
    Dim lng用法ID As Long, blnToNormal As Boolean
    Dim lngBegin As Long, lngEnd As Long
    Dim lngCopyRow As Long, i As Long, j As Long
    Dim str药品IDs As String
    
    On Error GoTo errH
    
    With vsAdvice
        '最终要转换为的期效
        strType = IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", "临嘱", "长嘱")
        
        If Val(.TextMatrix(lngRow, COL_诊疗项目ID)) <> 0 Then
            '取上一或下一有效行,某些内容缺省与该行相同
            lngCopyRow = GetPreRow(lngRow)
            If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
            
            '获取一组医嘱的操作行范围
            Call GetRowScope(lngRow, lngBegin, lngEnd)
        End If
        
        '针对不同类别的医嘱进行转换-----------------------------------------
        If Val(.TextMatrix(lngRow, COL_诊疗项目ID)) = 0 Then
            '自由录入的医嘱直接处理
            .TextMatrix(lngRow, COL_期效) = strType
            
            .TextMatrix(lngRow, COL_开始时间) = GetDefaultTime(lngRow)
            .Cell(flexcpData, lngRow, COL_开始时间) = .TextMatrix(lngRow, COL_开始时间)
            
            If InStr(",0,3,", .TextMatrix(lngRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngRow, COL_EDIT) = 2
                .TextMatrix(lngRow, COL_状态) = IIF(Val(.TextMatrix(lngRow, COL_状态)) = -1, -1, 1)
            End If
        ElseIf RowIn配方行(lngRow) Then '中药配方
            '药品长嘱不能为离院带药
            If strType = "长嘱" And .TextMatrix(lngEnd, COL_类别) = "E" _
                And .RowData(lngEnd) = Val(.TextMatrix(lngBegin, COL_相关ID)) Then
                If Val(.TextMatrix(lngBegin, COL_执行性质)) <> 5 And Val(.TextMatrix(lngEnd, COL_执行性质)) = 5 Then
                    lng用法ID = Val(.TextMatrix(lngEnd, COL_诊疗项目ID))
                    blnToNormal = True '表示给药执行应恢复成正常值
                End If
            End If
            
            For i = lngBegin To lngEnd
                '期效值
                .TextMatrix(i, COL_期效) = strType
                
                '开始时间
                If i = lngBegin Then
                    .TextMatrix(i, COL_开始时间) = GetDefaultTime(i)
                    .Cell(flexcpData, i, COL_开始时间) = .TextMatrix(i, COL_开始时间)
                Else
                    .TextMatrix(i, COL_开始时间) = .TextMatrix(lngBegin, COL_开始时间)
                    .Cell(flexcpData, i, COL_开始时间) = .Cell(flexcpData, lngBegin, COL_开始时间)
                End If
                
                '总量
                If strType = "长嘱" Then
                    .TextMatrix(i, COL_总量) = ""
                End If
                
                '终止时间
                If strType = "临嘱" Then
                    .TextMatrix(i, COL_终止时间) = ""
                    .Cell(flexcpData, i, COL_终止时间) = Empty
                End If
                
                '执行标记:药品长嘱不能为"自取药"
                If strType = "长嘱" And .TextMatrix(i, COL_类别) = "7" And Val(.TextMatrix(i, COL_执行标记)) = 1 Then
                    .TextMatrix(i, COL_执行标记) = 0
                End If
                
                '备用医嘱频率
                If .TextMatrix(i, COL_频率) = "必要时" Then
                    .TextMatrix(i, COL_频率) = "需要时"
                    txt频率.Text = "需要时"
                    cmd频率.Tag = "需要时"
                ElseIf .TextMatrix(i, COL_频率) = "需要时" Then
                    .TextMatrix(i, COL_频率) = "必要时"
                    txt频率.Text = "必要时"
                    cmd频率.Tag = "必要时"
                End If
                '执行性质:药品长嘱不能为"离院带药"
                If i = lngEnd And blnToNormal Then
                    strSQL = "Select 执行科室 From 诊疗项目目录 Where ID=[1]"
                    Set rsMore = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng用法ID)
                    
                    .TextMatrix(i, COL_执行性质) = NVL(rsMore!执行科室, 0)
                    If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                        .TextMatrix(i, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, "E", lng用法ID, 0, _
                            NVL(rsMore!执行科室, 0), mlng病人科室id, Val(.TextMatrix(i, COL_开嘱科室ID)), IIF(strType = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                    Else
                        .TextMatrix(i, COL_执行科室ID) = 0
                    End If
                End If
                
                If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                    .TextMatrix(i, COL_EDIT) = 2
                    .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1)
                End If
            Next
        Else '其它诊疗项目,包括药品,卫材,检查(组合),手术(组合)；检验组合因代码处理部份相同,因此一起处理
            '获取给药途径ID
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 _
                And .TextMatrix(lngEnd, COL_类别) = "E" And .RowData(lngEnd) = Val(.TextMatrix(lngRow, COL_相关ID)) Then
                lng用法ID = Val(.TextMatrix(lngEnd, COL_诊疗项目ID))
                
                '药品长嘱不能为离院带药
                If strType = "长嘱" Then
                    If Val(.TextMatrix(lngRow, COL_执行性质)) <> 5 And Val(.TextMatrix(lngEnd, COL_执行性质)) = 5 Then
                        blnToNormal = True '表示给药执行应恢复成正常值
                    End If
                End If
            End If
            
            '切换为临嘱时，获取药品规格信息
            If strSpec <> "" Then
                str药品IDs = ""
                For i = 0 To UBound(Split(strSpec, ";"))
                    str药品IDs = str药品IDs & "," & Split(Split(strSpec, ";")(i), ",")(1)
                Next
                str药品IDs = Mid(str药品IDs, 2)
                
                strSQL = "Select /*+ Rule*/ B.药品ID,Nvl(C.名称,A.名称) as 名称,b.基本药物," & _
                    " B.剂量系数,B.住院单位,B.住院包装,B.住院可否分零 As 可否分零,B.动态分零,b.高危药品,b.是否易至跌倒" & _
                    " From 收费项目目录 A,药品规格 B,收费项目别名 C" & _
                    " Where A.ID=B.药品ID And A.ID IN(Select Column_Value From Table(f_Num2list([1])))" & _
                    " And A.ID=C.收费细目ID(+) And C.码类(+)=1 And C.性质(+)=[2]"
                Set rsDrug = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str药品IDs, IIF(gbyt药品名称显示 = 0, 1, 3))
            End If
            
            '------------------------------------------------------------------------------------------------------
            '同时处理一组医嘱的相关行
            For i = lngBegin To lngEnd
                '期效值
                .TextMatrix(i, COL_期效) = strType
                
                '开始时间
                If i = lngBegin Then
                    .TextMatrix(i, COL_开始时间) = GetDefaultTime(i)
                    .Cell(flexcpData, i, COL_开始时间) = .TextMatrix(i, COL_开始时间)
                Else
                    .TextMatrix(i, COL_开始时间) = .TextMatrix(lngBegin, COL_开始时间)
                    .Cell(flexcpData, i, COL_开始时间) = .Cell(flexcpData, lngBegin, COL_开始时间)
                End If
                
                
                '切换药品期效时，医嘱相关内容变化
                If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                    If strType = "长嘱" And Not gbln药品按规格下医嘱 Then
                        .TextMatrix(i, COL_收费细目ID) = 0
                        .TextMatrix(i, COL_基本药物) = ""
                    ElseIf strType = "临嘱" And Val(.TextMatrix(i, COL_收费细目ID)) = 0 Then
                        For j = 0 To UBound(Split(strSpec, ";"))
                            If Val(Split(Split(strSpec, ";")(j), ",")(0)) = .RowData(i) Then
                                rsDrug.Filter = "药品ID=" & Split(Split(strSpec, ";")(j), ",")(1)
                                If Not rsDrug.EOF Then
                                    .TextMatrix(i, COL_收费细目ID) = rsDrug!药品ID
                                    .TextMatrix(i, COL_名称) = rsDrug!名称
                                    .TextMatrix(i, COL_剂量系数) = rsDrug!剂量系数
                                    .TextMatrix(i, COL_住院单位) = rsDrug!住院单位
                                    .TextMatrix(i, COL_住院包装) = rsDrug!住院包装
                                    .TextMatrix(i, COL_动态分零) = NVL(rsDrug!动态分零, 0)
                                    .TextMatrix(i, COL_可否分零) = NVL(rsDrug!可否分零, 0)
                                    .TextMatrix(i, COL_高危药品) = NVL(rsDrug!高危药品, 0)
                                    .TextMatrix(i, COL_基本药物) = NVL(rsDrug!基本药物)
                                    .TextMatrix(i, COL_易跌倒) = NVL(rsDrug!是否易至跌倒, 0)
                                End If
                                Exit For
                            End If
                        Next
                    End If
                    .TextMatrix(i, col_医嘱内容) = AdviceTextMake(i)
                End If
                
                '由长期药嘱切换为临时药嘱
                If .Cell(flexcpData, i, COL_可否分零) = 1 Then
                    .Cell(flexcpData, i, COL_可否分零) = Empty '按理还应还原本身的分零方式
                End If
                
                '获取当前项目的附加信息
                If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 And i = lngBegin Then
                    '第一药品行才取这些信息
                    strSQL = "Select 项目ID,频次,疗程 From 诊疗用法用量 Where Nvl(性质,0)>0 And 项目ID=[1] And 用法ID=[2]"
                    strSQL = "Select A.执行科室,A.执行频率,A.计算方式,A.计算单位,B.频次,B.疗程" & _
                        " From 诊疗项目目录 A,(" & strSQL & ") B Where A.ID=B.项目ID(+) And A.ID=[1]"
                Else
                    strSQL = "Select 执行科室,执行频率,计算方式,计算单位,Null as 频次,Null as 疗程 From 诊疗项目目录 Where ID=[1]"
                End If
                Set rsMore = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(i, COL_诊疗项目ID)), lng用法ID)
                If Not rsMore.EOF Then '给药途径没有指定的情况
                    '总量(单位)
                    If strType = "临嘱" Then
                        If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                            '中、西成药临嘱的总量单位就是住院单位
                            .TextMatrix(i, COL_总量单位) = .TextMatrix(i, COL_住院单位)
                        ElseIf .TextMatrix(i, COL_类别) = "4" Then
                            .TextMatrix(i, COL_总量单位) = .TextMatrix(i, COL_住院单位) '散装单位
                        Else
                            '其它临嘱要输入总量
                            .TextMatrix(i, COL_总量单位) = NVL(rsMore!计算单位)
                            
                            '如果为一次性或计次临嘱缺省总量为1
                            If i = lngBegin Then
                                If NVL(rsMore!执行频率, 0) = 1 Or NVL(rsMore!计算方式, 0) = 3 Then
                                    .TextMatrix(i, COL_总量) = 1
                                End If
                            ElseIf Not (lng用法ID = Val(.TextMatrix(i, COL_诊疗项目ID))) Then
                                .TextMatrix(i, COL_总量) = .TextMatrix(lngBegin, COL_总量)
                            End If
                        End If
                    Else
                        .TextMatrix(i, COL_总量) = ""
                        .TextMatrix(i, COL_总量单位) = ""
                        .TextMatrix(i, COL_天数) = ""
                    End If
                    '备用医嘱频率
                    If .TextMatrix(i, COL_频率) = "必要时" Then
                        .TextMatrix(i, COL_频率) = "需要时"
                        txt频率.Text = "需要时"
                        cmd频率.Tag = "需要时"
                    ElseIf .TextMatrix(i, COL_频率) = "需要时" Then
                        .TextMatrix(i, COL_频率) = "必要时"
                        txt频率.Text = "必要时"
                        cmd频率.Tag = "必要时"
                    Else
                        '频率性质,执行频率,执行时间
                        If i = lngBegin Then '以第一行为准
                            int频率性质 = Val(.TextMatrix(i, COL_频率性质))
                            If strType = "临嘱" And NVL(rsMore!执行频率, 0) = 0 And mbln一次性 Then
                                .TextMatrix(i, COL_频率性质) = 1 '住院可选择频率的临嘱缺省为一次性
                            Else
                                .TextMatrix(i, COL_频率性质) = NVL(rsMore!执行频率, 0)
                            End If
            
                            '执行频率:当适用范围有所变化时
                            If Val(.TextMatrix(i, COL_频率性质)) <> int频率性质 Then
                                '标记为重新取
                                .TextMatrix(i, COL_频率) = ""
                                .TextMatrix(i, COL_执行时间) = ""
                                
                                '药品设置的缺省频率优先
                                If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 _
                                    And Not IsNull(rsMore!频次) And Val(.TextMatrix(i, COL_频率性质)) <> 1 Then
                                    Call Get频率信息_编码(rsMore!频次, str频率, int频率次数, int频率间隔, str间隔单位)
                                    .TextMatrix(i, COL_频率) = str频率
                                    .TextMatrix(i, COL_频率次数) = int频率次数
                                    .TextMatrix(i, COL_频率间隔) = int频率间隔
                                    .TextMatrix(i, COL_间隔单位) = str间隔单位
                                End If
                                '缺省与上一新增行相同
                                If .TextMatrix(i, COL_频率) = "" And lngCopyRow <> -1 Then
                                    If .TextMatrix(i, COL_期效) = .TextMatrix(lngCopyRow, COL_期效) _
                                        And Val(.TextMatrix(i, COL_频率性质)) = Val(.TextMatrix(lngCopyRow, COL_频率性质)) Then
                                        If Val(.TextMatrix(lngCopyRow, COL_EDIT)) = 1 And .TextMatrix(lngCopyRow, COL_频率) <> "" _
                                            And Not (.TextMatrix(i, COL_类别) = "7" And Not RowIn配方行(lngCopyRow)) _
                                            And Not (.TextMatrix(i, COL_类别) <> "7" And RowIn配方行(lngCopyRow)) _
                                            And Check频率可用(Val(.TextMatrix(i, COL_诊疗项目ID)), Get频率范围(i), .TextMatrix(lngCopyRow, COL_频率)) Then
                                            .TextMatrix(i, COL_频率) = .TextMatrix(lngCopyRow, COL_频率)
                                            .TextMatrix(i, COL_频率次数) = .TextMatrix(lngCopyRow, COL_频率次数)
                                            .TextMatrix(i, COL_频率间隔) = .TextMatrix(lngCopyRow, COL_频率间隔)
                                            .TextMatrix(i, COL_间隔单位) = .TextMatrix(lngCopyRow, COL_间隔单位)
                                        End If
                                    End If
                                End If
                                '或取缺省频率
                                If .TextMatrix(i, COL_频率) = "" Then
                                    Call Get缺省频率(Val(.TextMatrix(i, COL_诊疗项目ID)), Get频率范围(i), str频率, int频率次数, int频率间隔, str间隔单位)
                                    .TextMatrix(i, COL_频率) = str频率
                                    .TextMatrix(i, COL_频率次数) = int频率次数
                                    .TextMatrix(i, COL_频率间隔) = int频率间隔
                                    .TextMatrix(i, COL_间隔单位) = str间隔单位
                                End If
                                
                                '执行时间:可选频率的项目
                                If Val(.TextMatrix(i, COL_频率性质)) = 0 Then
                                    If lngCopyRow <> -1 Then '与上一行相同
                                        If .TextMatrix(i, COL_频率) = .TextMatrix(lngCopyRow, COL_频率) Then
                                            .TextMatrix(i, COL_执行时间) = .TextMatrix(lngCopyRow, COL_执行时间)
                                        End If
                                    End If
                                    If .TextMatrix(i, COL_执行时间) = "" Then  '缺省时间方案
                                        .TextMatrix(i, COL_执行时间) = Get缺省时间(1, .TextMatrix(i, COL_频率), lng用法ID)
                                    End If
                                End If
                            End If
                        Else
                            .TextMatrix(i, COL_频率) = .TextMatrix(lngBegin, COL_频率)
                            .TextMatrix(i, COL_频率次数) = .TextMatrix(lngBegin, COL_频率次数)
                            .TextMatrix(i, COL_频率间隔) = .TextMatrix(lngBegin, COL_频率间隔)
                            .TextMatrix(i, COL_间隔单位) = .TextMatrix(lngBegin, COL_间隔单位)
                            .TextMatrix(i, COL_频率性质) = .TextMatrix(lngBegin, COL_频率性质)
                            .TextMatrix(i, COL_执行时间) = .TextMatrix(lngBegin, COL_执行时间)
                        End If
                    End If
                    
                    
                    '终止时间:长嘱才有
                    If strType = "临嘱" Then
                        .TextMatrix(i, COL_终止时间) = ""
                        .Cell(flexcpData, i, COL_终止时间) = Empty
                    End If
                    
                    '药品临嘱天数和总量
                    If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 And strType = "临嘱" Then
                        '确定临嘱用药天数：
                        '1.最少为一个频率周期天数
                        '2-有疗程则为疗程天数(应大于一个频率周期天数)
                        If i = lngBegin Then '以第一行为准
                            sng天数 = Val(.TextMatrix(i, COL_天数)) '如果以前有则保持
                            If sng天数 = 0 Then sng天数 = msng天数
                            If mbln天数 Then
                                If .TextMatrix(i, COL_间隔单位) = "周" Then
                                    If 7 > sng天数 Then sng天数 = 7
                                ElseIf .TextMatrix(i, COL_间隔单位) = "天" Then
                                    If Val(.TextMatrix(i, COL_频率间隔)) > sng天数 Then
                                        sng天数 = Val(.TextMatrix(i, COL_频率间隔))
                                    End If
                                ElseIf .TextMatrix(i, COL_间隔单位) = "小时" Then
                                    If Val(.TextMatrix(i, COL_频率间隔)) \ 24 > sng天数 Then
                                        sng天数 = Val(.TextMatrix(i, COL_频率间隔)) \ 24
                                    End If
                                ElseIf .TextMatrix(i, COL_间隔单位) = "分钟" Then
                                    If sng天数 = 0 Then sng天数 = 1
                                End If
                            End If
                            If NVL(rsMore!疗程, 1) > sng天数 Then sng天数 = NVL(rsMore!疗程, 1)
                            If sng天数 = 0 Then sng天数 = 1
                        End If
                        
                        '天数
                        If mbln天数 And Val(.TextMatrix(i, COL_频率性质)) <> 1 Then
                            .TextMatrix(i, COL_天数) = IIF(sng天数 = 0, "", sng天数)
                        End If
                        
                        '总量
                        If .TextMatrix(i, COL_频率) <> "" And Val(.TextMatrix(i, COL_单量)) <> 0 _
                            And Val(.TextMatrix(i, COL_剂量系数)) <> 0 And Val(.TextMatrix(i, COL_住院包装)) <> 0 Then
                            If Val(.TextMatrix(i, COL_频率性质)) = 1 Then '临嘱药品可能缺省为一次性
                                '仅按疗程算改为按最少用药天数算
                                .TextMatrix(i, COL_总量) = FormatEx(Calc缺省药品总量( _
                                        Val(.TextMatrix(i, COL_单量)), 1, 1, 1, "天", "", Val(.TextMatrix(i, COL_剂量系数)), _
                                        Val(.TextMatrix(i, COL_住院包装)), Val(.TextMatrix(i, COL_可否分零))), 5)
                            Else
                                '仅按疗程算改为按最少用药天数算
                                .TextMatrix(i, COL_总量) = FormatEx(Calc缺省药品总量( _
                                        Val(.TextMatrix(i, COL_单量)), sng天数, Val(.TextMatrix(i, COL_频率次数)), _
                                        Val(.TextMatrix(i, COL_频率间隔)), .TextMatrix(i, COL_间隔单位), _
                                        .TextMatrix(i, COL_执行时间), Val(.TextMatrix(i, COL_剂量系数)), _
                                        Val(.TextMatrix(i, COL_住院包装)), Val(.TextMatrix(i, COL_可否分零))), 5)
                            End If
                            If InStr(GetInsidePrivs(p住院医嘱下达), "药品小数输入") = 0 Then
                                .TextMatrix(i, COL_总量) = IntEx(Val(.TextMatrix(i, COL_总量)))
                            ElseIf Val(.TextMatrix(i, COL_可否分零)) <> 0 Then
                                .TextMatrix(i, COL_总量) = IntEx(Val(.TextMatrix(i, COL_总量)))
                            End If
                        End If
                    End If
                    
                    '执行标记:药品长嘱不能为"自取药"
                    If strType = "长嘱" And InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 And Val(.TextMatrix(i, COL_执行标记)) = 1 Then
                        .TextMatrix(i, COL_执行标记) = 0
                    End If
                    
                    '执行性质:药品长嘱不能为"离院带药"
                    If i = lngEnd And blnToNormal Then
                        .TextMatrix(i, COL_执行性质) = NVL(rsMore!执行科室, 0)
                        If InStr(",0,5,", Val(.TextMatrix(i, COL_执行性质))) = 0 Then
                            .TextMatrix(i, COL_执行科室ID) = Get诊疗执行科室ID(mlng病人ID, mlng主页ID, "E", lng用法ID, 0, _
                                NVL(rsMore!执行科室, 0), mlng病人科室id, Val(.TextMatrix(i, COL_开嘱科室ID)), IIF(strType = "长嘱", 0, 1), IIF(mlng病人性质 = 1, 1, 2), , 0, 2)
                        Else
                            .TextMatrix(i, COL_执行科室ID) = 0
                        End If
                    End If
                    
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2
                        .TextMatrix(i, COL_状态) = IIF(Val(.TextMatrix(i, COL_状态)) = -1, -1, 1)
                    End If
                End If
            Next
        End If
        
        .AutoSize col_医嘱内容
    End With
    
    Call Set医嘱超量(lngRow, lngRow)
    
    Call ReSetColor(lngRow)
    mblnNoSave = True '标记为未保存
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function GetAdviceAppendItem() As String
'功能：获取未保存医嘱(新开或修改的)的最新单据附项
'返回：项目名1<Split2>内容1<Split1>项目名2<Split2>内容2<Split1>...
    Dim arrAppend As Variant, i As Long, j As Long
    Dim strName As String, strText As String
    Dim strResult As String
    
    With vsAdvice
        For i = .Rows - 1 To .FixedRows Step -1
            If .RowData(i) <> 0 And .TextMatrix(i, COL_附项) <> "" And .Cell(flexcpData, i, COL_附项) = 1 Then
                arrAppend = Split(.TextMatrix(i, COL_附项), "<Split1>")
                For j = 0 To UBound(arrAppend)
                    strName = Split(arrAppend(j), "<Split2>")(0)
                    strText = Split(arrAppend(j), "<Split2>")(3)
                    
                    If InStr(strResult, "<Split1>" & strName & "<Split2>") = 0 Then
                        strResult = strResult & "<Split1>" & strName & "<Split2>" & strText
                    End If
                Next
            End If
        Next
    End With
    
    GetAdviceAppendItem = Mid(strResult, Len("<Split1>") + 1)
End Function

Private Sub vsAdvice_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim lngRow As Long
    
    With vsAdvice
        'Pass
        If Button = 2 Then

            lngRow = .MouseRow
            If lngRow >= .FixedRows And lngRow <= .Rows - 1 Then
                If Not .RowHidden(lngRow) Then .Row = lngRow
            End If
        End If
        
        If Button = 1 Then
            If .Col = COL_并 And .MouseRow > .FixedRows - 1 Then
                mlng拖动行 = .MouseRow
            Else
                mlng拖动行 = 0
                .Cell(flexcpBackColor, .FixedRows, COL_并, .Rows - 1, COL_并) = .BackColor
            End If
        End If
    
    End With
End Sub

Private Sub vsAdvice_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim lngPreRow As Long
    
    With vsAdvice
        If Button = 1 Then
            If .Col = COL_并 And .MouseRow > .FixedRows - 1 Then
                lngPreRow = Val(.Tag)
                If mlng拖动行 > 0 Then
                    If lngPreRow <> .MouseRow Then
                        .Cell(flexcpBackColor, .FixedRows, COL_并, .Rows - 1, COL_并) = .BackColor
                        .Cell(flexcpBackColor, .MouseRow, COL_并, mlng拖动行, COL_并) = .BackColorSel
                    End If
                End If
            Else
                .Cell(flexcpBackColor, .FixedRows, COL_并, .Rows - 1, COL_并) = .BackColor
                mlng拖动行 = 0
                .Tag = ""
            End If
            .Tag = .MouseRow
        End If
    End With
End Sub

Private Sub vsAdvice_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim objPopup As CommandBarPopup
    Dim blnDo As Boolean

    If Button = 2 Then
        If cbsMain Is Nothing Then Exit Sub
        Set objPopup = cbsMain.ActiveMenuBar.FindControl(, conMenu_EditPopup)
        If mblnPass = False Then
            blnDo = True
        Else
            '住院编辑界面菜单级数比医生站少一级
            Call gobjPass.zlPASSPopupCommandBars(mobjPassMap, objPopup.CommandBar, conMenu_Edit_MediAudit, blnDo)
        End If
        If gobjPlugIn Is Nothing And blnDo And gobjDrugExplain Is Nothing Then Exit Sub '当弹出没有菜单项目时会显示一个空白小方块
        If Not objPopup Is Nothing Then
            objPopup.CommandBar.ShowPopup
        End If
    End If
    
    If Button = 1 Then
        If vsAdvice.Col = COL_并 And mlng拖动行 <> 0 Then
            Call SetAll一并给药(mlng拖动行, vsAdvice.MouseRow)
        Else
            mlng拖动行 = 0
        End If
        vsAdvice.Cell(flexcpBackColor, vsAdvice.FixedRows, COL_并, vsAdvice.Rows - 1, COL_并) = vsAdvice.BackColor
    End If
End Sub

Private Sub ExePlugIn(ByVal strName As String)
'功能：执行外挂功能
    Dim lngID As String
    
    If CreatePlugInOK(p住院医嘱下达, mint场合) Then
        With vsAdvice
            lngID = .RowData(.Row)
            If InStr(",1,2,", Val(.TextMatrix(.Row, COL_EDIT))) > 0 Then
                If MsgBox("当前选中的医嘱未保存，是否先保存？", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                    Exit Sub
                End If
                cbsMain.FindControl(, conMenu_Save, True, True).Execute: Exit Sub
            End If
        End With
        On Error Resume Next
        If PlugExeNew(strName) = False Then
            Call gobjPlugIn.ExecuteFunc(glngSys, Decode(mint场合, 0, p住院医嘱下达, 1, p住院医嘱发送, 2, p住院医嘱下达), _
                strName, mlng病人ID, mlng主页ID, lngID, mlng前提ID, mint场合)
            Call zlPlugInErrH(err, "ExecuteFunc")
            err.Clear: On Error GoTo 0
        End If
    End If
End Sub

Private Function PlugExeNew(ByVal strName As String) As Boolean
'功能：向下兼容外挂部件的ExecuteFunc过程
    Dim lngID As Long
    Dim strXML As String
On Error GoTo errH
    If CreatePlugInOK(p住院医嘱下达, mint场合) Then
        With vsAdvice
            lngID = .RowData(.Row)
            strXML = "<ROOT><诊疗项目名称>" & .TextMatrix(.Row, COL_名称) & "</诊疗项目名称></ROOT>"
            Call gobjPlugIn.ExecuteFunc(glngSys, Decode(mint场合, 0, p住院医嘱下达, 1, p住院医嘱发送, 2, p住院医嘱下达), strName, mlng病人ID, mlng主页ID, lngID, mlng前提ID, mint场合, strXML)
        End With
    End If
   PlugExeNew = True
   Exit Function
errH:
    If err.Number = 450 Then
        PlugExeNew = False
        err.Clear
    Else
        PlugExeNew = True
        Call zlPlugInErrH(err, "ExecuteFunc")
        err.Clear: On Error GoTo 0
    End If
End Function


Private Sub vsAdvice_StartEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    If mbytUseType = 1 Then
        If Col = COL_选择 Then
            If vsAdvice.TextMatrix(Row, Col) = "√" Then Cancel = True
        Else
            Cancel = True
        End If
    End If
End Sub

Private Function AdviceSort() As Boolean
'功能：对医嘱进行排序处理
'参数：如果排过序，则返回True
    Dim rsTmp As ADODB.Recordset
    Dim i As Long, k As Long, lngCurRow As Long, lngNextRow As Long
    Dim lngTop As Long, lngBottom As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim lngThisValue As Long, lngNextValue As Long
    Dim lngGID As Long, lngCurGID As Long, lngGNum As Long
    Dim blnSorted As Boolean
    
    lngTop = GetNewRowTop
    If lngTop = -1 Then Exit Function
    Call GetRowScope(lngTop, lngBegin, lngEnd)
    If lngEnd = vsAdvice.Rows - 1 Then Exit Function '只有一行(一并给药当成一行)时不用排序
    lngTop = lngBegin
          
    Set rsTmp = GetAdviceSortRs
    If rsTmp.RecordCount = 0 Then Exit Function
    
    With vsAdvice
        .Redraw = flexRDNone
        For i = lngEnd To .Rows - 1
            lngCurGID = Val(.TextMatrix(i, COL_相关ID))
            If lngCurGID = 0 Then lngCurGID = Val(.RowData(i))
            
            If lngCurGID <> lngGID Then
                lngGNum = lngGNum + 1
                lngGID = lngCurGID
            End If
        Next
        lngBottom = .Rows - 1
        
        '冒泡排序法,外层每循环一次，将有一个最大的移到最下面
        For k = 2 To lngGNum
            Call GetRowScope(lngTop, lngBegin, lngEnd) '顶行一组医嘱可能因移动而变化，所以要每次取
            
            lngNextRow = GetNextRow(lngEnd)
            If lngNextRow = -1 Then Exit For
            Call GetRowScope(lngNextRow, lngBegin, lngEnd)
            lngNextRow = lngBegin
            
            lngCurRow = lngTop
            lngThisValue = GetAdviceSort(rsTmp, lngCurRow)
                        
            Do While lngNextRow <= lngBottom
                If Val(.RowData(lngNextRow)) <> 0 Then
                    lngNextValue = GetAdviceSort(rsTmp, lngNextRow)
                    If lngThisValue > lngNextValue Then     '交换相邻相行,大的向下移
                        Call MoveCurrRow(lngCurRow, -1)
                        lngCurRow = .Row
                        If blnSorted = False Then blnSorted = True
                    Else
                        lngThisValue = lngNextValue '指针移到相邻下一行
                        lngCurRow = lngNextRow
                    End If
                    Call GetRowScope(lngCurRow, lngBegin, lngEnd)
                    lngNextRow = lngEnd + 1
                Else
                    lngNextRow = lngNextRow + 1
                End If
            Loop
            lngBottom = lngBegin - 1 '最后一组医嘱的前一行，每循环一次，后退一个组的距离
        Next
    
        .Redraw = flexRDDirect
        .Refresh '否则一并给药的表格擦除线会显示
    End With
    AdviceSort = blnSorted
End Function

Private Function GetAdviceSort(ByRef rsSort As ADODB.Recordset, lngRow As Long) As Long
    With vsAdvice
        Dim lng期效 As Long, lngGroup As Long
        
        GetAdviceSort = 9999
        lng期效 = IIF(.TextMatrix(lngRow, COL_期效) = "长嘱", 0, 1)
        If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            lngGroup = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
            If lngGroup <> 0 Then
                rsSort.Filter = "医嘱期效=" & lng期效 & " And 诊疗类别='E' And 操作类型='2' And 执行分类=" & Val(.TextMatrix(lngGroup, COL_执行分类))
            Else
                Exit Function
            End If
        ElseIf InStr(",7,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            rsSort.Filter = "医嘱期效=" & lng期效 & " And 诊疗类别='E' And 操作类型='4'"
            
        ElseIf InStr(",H,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            rsSort.Filter = "医嘱期效=" & lng期效 & " And 诊疗类别='H' And 操作类型='" & Val(.TextMatrix(lngRow, COL_操作类型)) & "'"
        
        '一并采集
        ElseIf InStr(",E,", .TextMatrix(lngRow, COL_类别)) > 0 And Val(.TextMatrix(lngRow, COL_操作类型)) = 6 Then
            rsSort.Filter = "医嘱期效=" & lng期效 & " And 诊疗类别='C'"
            
        ElseIf InStr(",E,", .TextMatrix(lngRow, COL_类别)) > 0 Then
            rsSort.Filter = "医嘱期效=" & lng期效 & " And 诊疗类别='E' And 操作类型='" & Val(.TextMatrix(lngRow, COL_操作类型)) & "'"
            
        ElseIf InStr(",Z,", .TextMatrix(lngRow, COL_类别)) > 0 And Val(.TextMatrix(lngRow, COL_操作类型)) = 4 Then
            rsSort.Filter = "医嘱期效=" & lng期效 & " And 诊疗类别='Z' And 操作类型='4'"
            
        ElseIf InStr(",Z,", .TextMatrix(lngRow, COL_类别)) > 0 And Val(.TextMatrix(lngRow, COL_操作类型)) <> 4 Then
            rsSort.Filter = "医嘱期效=" & lng期效 & " And 诊疗类别='Z' And 操作类型='4'"
            If rsSort.RecordCount > 0 Then
                rsSort.Filter = "医嘱期效=" & lng期效 & " And 诊疗类别='Z' And 操作类型<>'4'"
            Else
                rsSort.Filter = "医嘱期效=" & lng期效 & " And 诊疗类别='" & .TextMatrix(lngRow, COL_类别) & "'"
            End If
        Else
            rsSort.Filter = "医嘱期效=" & lng期效 & " And 诊疗类别='" & .TextMatrix(lngRow, COL_类别) & "'"
        End If
        
        If rsSort.RecordCount > 0 Then
            GetAdviceSort = Val("" & rsSort!顺序)
        End If
    End With
End Function

Private Function GetAdviceSortRs() As ADODB.Recordset
'功能：读取医嘱排序设置记录集
    Dim strSQL As String
 
    strSQL = "Select 顺序, 医嘱期效, 诊疗类别, 操作类型, 执行分类 From 路径项目顺序"
    On Error GoTo errH
    Set GetAdviceSortRs = zlDatabase.OpenSQLRecord(strSQL, Me.Caption)

    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function GetNewRowTop() As Long
'功能：获取本次新增医嘱的开始可见行号,中间插入的新行不管
'返回：本次新增医嘱的开始可见行号，如果没有，则返回-1
    Dim lngTmp As Long, i As Long
    
    With vsAdvice
        For i = .Rows - 1 To .FixedRows Step -1
            If .RowData(i) <> 0 And Not .RowHidden(i) Then
                If .TextMatrix(i, COL_EDIT) <> 1 Then Exit For
            End If
        Next
    End With
    i = GetNextRow(i)
    GetNewRowTop = i
End Function

Private Function CheckedPathSended() As Boolean
'功能：检查并提示路径病人是否可以新增医嘱
    Dim lng理论天数 As Long, rsTmp As Recordset
    Dim blnPathSended As Boolean, blnYes As Boolean
    
    blnPathSended = True
    If mbytUseType = 0 And cbo婴儿.ListIndex <= 0 Then
        If mlng路径状态 = 1 And mbln未评估 = False Then
            Set rsTmp = GetPatiPathInfo(mlng病人ID, mlng主页ID)
            If rsTmp.RecordCount > 0 Then
                lng理论天数 = GetMustDay(Val(rsTmp!路径记录id & ""), Val(rsTmp!当前天数 & ""))
                If Not CheckSameDayOfPhase(Val(rsTmp!当前阶段ID & ""), lng理论天数) And Format(rsTmp!日期 & "", "yyyy-MM-dd") = Format(mdatCurr, "yyyy-MM-dd") Then
                    If MsgBox("该病人在今天已进行了评估，要补充医嘱需先取消评估，你现在要取消评估吗？", vbYesNo + vbDefaultButton1 + vbQuestion, "是否取消评估？") = vbYes Then
                         '之前可能没有进过路径页面，需要先通过刷新接口读取初始数据
                        Call gobjPath.zlRefresh(mlng病人ID, mlng主页ID, mlng病人病区ID, mlng病人科室id, mintPState, False, True)
                        Call gobjPath.zlExecEvaluateCancel(False, False)
                        blnPathSended = True
                    Else
                        blnPathSended = False
                    End If
                Else
                    MsgBox "病人在今天的路径还没有生成，请先生成路径后再下达新的医嘱。", vbInformation, gstrSysName
                    blnPathSended = False
                End If
            Else
                 MsgBox "必须先生成第一天的内容后再修改和调整医嘱。", vbInformation, gstrSysName
                 blnPathSended = False
            End If
        ElseIf mlng路径状态 = 2 Then
            '检查病人是否下达了出院医嘱
            If CheckOutAdvice(mlng病人ID, mlng主页ID) Then
                MsgBox "该病人已经正常结束了路径并下达了出院医嘱，不能再新开医嘱。", vbInformation, gstrSysName
                blnPathSended = False
            End If
        End If
        CheckedPathSended = blnPathSended
        '如果已经不允许开医嘱(已经评估了还未生成，或是已经下达了出院医嘱），则直接退出
        If blnPathSended = False Then Exit Function
        
        If mlng路径状态 = 1 And mblnPathSend = False Then
            '如果启用了参数：未评估时允许添加医嘱到昨天，则提示，否则直接进行评估生成操作
            If Val(zlDatabase.GetPara("未评估时允许添加医嘱到昨天", glngSys, p临床路径应用, 1)) = 1 Then
                blnYes = MsgBox("你要添加路径外项目到''" & mstr当前日期 & "'?", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbYes
            End If
            '如果选择否，则进行评估生成操作，选择是则允许新开路径外项目到 当前日期
            If blnYes = False Then
                '之前可能没有进过路径页面，需要先通过刷新接口读取初始数据
                Call gobjPath.zlRefresh(mlng病人ID, mlng主页ID, mlng病人病区ID, mlng病人科室id, mintPState, False, True)
                Call gobjPath.zlExecPathSend(, 1)
                '医嘱编辑界面不能直接调用医嘱生成。
                CheckedPathSended = False
                '重新获取是否评估的状态
                mbln未评估 = CheckPathNotEvaluete(mlng病人ID, mlng主页ID, mblnPathSend, mstr当前日期)
            End If
        End If
    Else
        CheckedPathSended = blnPathSended
    End If
End Function

Public Function GetMustDay(ByVal lng病人路径ID As Long, ByVal lng当前天数 As Long) As Long
'功能：获取病人路径执行理论上的当前天数(=当前实际天数-曾经延迟的天数+提前天数)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    
    On Error GoTo errH
    strSQL = "Select sum(Decode(时间进度,-1,1,0)) as 延迟天数,sum(Decode(时间进度,1,1,0)) as 提前天数" & _
            " From 病人路径评估 Where 路径记录id = [1] And (时间进度=-1 or 时间进度=1)"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "GetMustDay", lng病人路径ID)
    GetMustDay = lng当前天数 - Val("" & rsTmp!延迟天数) + Val("" & rsTmp!提前天数)
        
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function


Private Function CheckSameDayOfPhase(ByVal lngPhase As Long, ByVal lngDay As Long) As Boolean
'功能：检查当天是否还有适用的其他后续阶段(当前阶段及分支除外)
    Dim rsTmp As ADODB.Recordset, strSQL As String
    
    '如果当前是分支阶段，则取其父ID
    strSQL = "Select 父ID From 临床路径阶段 Where ID = [1] And 父ID is Not Null"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "读取阶段", lngPhase)
    If rsTmp.RecordCount > 0 Then lngPhase = rsTmp!父ID
    
    strSQL = "Select 1" & vbNewLine & _
            "From 临床路径阶段 A, 临床路径阶段 B" & vbNewLine & _
            "Where a.Id = [1] And a.路径id = b.路径id And a.版本号 = b.版本号 And b.序号 > a.序号" & vbNewLine & _
            "      And [2] Between b.开始天数 And Nvl(b.结束天数, b.开始天数) And b.父ID is Null And Rownum < 2"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "读取阶段", lngPhase, lngDay)
    If rsTmp.RecordCount > 0 Then CheckSameDayOfPhase = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub SetPathRows(ByVal lngTop As Long, ByVal lngBottom As Long, Optional ByRef lng项目id As Long, Optional ByRef str路径项目分类 As String)
'功能：设置临床路径行及相关行的信息和显示
'     lng项目ID,str路径项目分类中药配方再次编辑时保存对应的项目ID和分类
    Dim k As Long, lngBegin As Long, lngEnd As Long, lngRow As Long
    Dim str诊疗项目IDs As String, lng路径项目ID As Long, str分类 As String
    Dim blnOut As Boolean
    Dim strSQL As String
    Dim str开始日期 As String
    Dim rsTmp As Recordset
    Dim bln西药 As Boolean
    Dim rsAdvice As ADODB.Recordset
    
    With vsAdvice
        lngRow = lngTop
        While lngRow <= lngBottom
            '一并给药时，只检查和设置当前行，因为路径外项目可能和路径内项目一并给药
            If RowIn一并给药(lngRow) Then
               lngBegin = lngRow
               lngEnd = lngRow
            Else
                Call GetRowScope(lngRow, lngBegin, lngEnd)
            End If
            '自由录入的医嘱，不在路径表上体现,给药途径排除，因为药品单独一条一条判断
            If Val(.TextMatrix(lngRow, COL_婴儿)) = 0 And Val(.TextMatrix(lngRow, COL_诊疗项目ID)) <> 0 And Not (.TextMatrix(lngRow, COL_类别) = "E" And .TextMatrix(lngRow, COL_操作类型) = "2") _
                 And Format(.TextMatrix(lngRow, COL_开始时间), "YYYY-MM-DD") >= Format(mrsPPati!开始日期 & "", "YYYY-MM-DD") Then
                str诊疗项目IDs = ""
                For k = lngBegin To lngEnd
                    '药品不含给药途径、用法、煎法，输血不含途径,检验不含采集方式，手术不含附加手术、麻醉，检查不含部位方法
                    '含单独应用的输血途径
                    If (Not (.TextMatrix(k, COL_类别) = "E" And InStr(",2,3,4,6,8,", "," & .TextMatrix(k, COL_操作类型) & ",") > 0) _
                        Or (.TextMatrix(k, COL_类别) = "E" And .TextMatrix(k, COL_操作类型) & "" = "8" And Val(.TextMatrix(k, COL_单独应用)) = 1)) _
                        And Not (InStr(",G,F,D,", "," & .TextMatrix(k, COL_类别) & ",") > 0 And Val(.TextMatrix(k, COL_相关ID)) <> 0) _
                        And Val(.TextMatrix(k, COL_诊疗项目ID)) <> 0 Then
                        
                        str诊疗项目IDs = str诊疗项目IDs & "," & .TextMatrix(k, COL_诊疗项目ID)
                        If str开始日期 = "" Then str开始日期 = Format(.TextMatrix(k, COL_开始时间), "YYYY-MM-DD")
                        If InStr("5,6", .TextMatrix(k, COL_类别)) > 0 Then bln西药 = True
                        
                    End If
                Next
                str诊疗项目IDs = Mid(str诊疗项目IDs, 2)
                On Error GoTo errH
                '根据医嘱的开始日期获取对应的路径阶段
                If mrsPPati!日期 = CDate(str开始日期) Then
                    '86696同一天有多个阶段时取当前阶段匹配
                     strSQL = "Select 当前阶段id From 病人临床路径 Where 病人ID = [1] And 主页ID=[2]" & vbNewLine & _
                        "Union All" & vbNewLine & _
                        "Select 当前阶段id From 病人合并路径 Where 病人ID = [1] And 主页ID=[2]"
                Else
                    strSQL = "Select a.阶段id as 当前阶段ID " & vbNewLine & _
                            "From 病人路径执行 A, 病人临床路径 B" & vbNewLine & _
                            "Where b.Id = a.路径记录id And b.病人id = [1] And b.主页id = [2] And a.日期 = [3]" & vbNewLine & _
                            "Union" & vbNewLine & _
                            "Select a.阶段id as 当前阶段ID  " & vbNewLine & _
                            "From 病人路径执行 A, 病人合并路径 B" & vbNewLine & _
                            "Where b.Id = a.合并路径记录id And b.病人id = [1] And b.主页id = [2] And a.日期 = [3]"
                End If
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, CDate(str开始日期))
                             
                Do While Not rsTmp.EOF
                    If rsTmp!当前阶段ID & "" <> "" Then
                        lng路径项目ID = CheckPathInItem(mlng病人ID, mlng主页ID, str诊疗项目IDs, str分类, Val(rsTmp!当前阶段ID & ""), RowIn配方行(.Row), IIF(.TextMatrix(.Row, COL_期效) = "长嘱", 0, 1), bln西药)
                    End If
                    If lng路径项目ID <> 0 Then Exit Do
                    rsTmp.MoveNext
                Loop
            
                '调用外挂接口进行判断，对于已匹配的外挂可以设置为不匹配
                If CreatePlugInOK(p住院医嘱下达, mint场合) Then
                    Set rsAdvice = GetAdviceRs
                    For k = lngBegin To lngEnd
                        If Val(vsAdvice.RowData(k)) <> 0 Then
                            Call AdviceRSAddRow(rsAdvice, k)
                        End If
                    Next
                    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
                    On Error Resume Next
                    Call gobjPlugIn.CheckPathInItem(glngSys, p住院医嘱下达, mlng病人ID, mlng主页ID, rsAdvice, lng路径项目ID, str分类, mint场合)
                    Call zlPlugInErrH(err, "CheckPathInItem")
                    err.Clear: On Error GoTo 0
                    On Error GoTo errH
                End If
            
                
                For k = lngBegin To lngEnd
                    If lng路径项目ID = 0 Then
                        blnOut = True
                        If .RowHidden(k) = False Then
                            .Cell(flexcpBackColor, k, 0, k, .Cols - 1) = BackColorNew         '路径外项目，浅黄色
                        End If
                        .TextMatrix(k, COL_路径项目ID) = 0
                        .TextMatrix(k, COL_路径项目分类) = ""
                        If lng项目id <> 0 Then lng项目id = 0
                        If str路径项目分类 <> "" Then str路径项目分类 = ""
                    Else
                        .TextMatrix(k, COL_路径项目ID) = lng路径项目ID
                        .TextMatrix(k, COL_路径项目分类) = str分类
                        If lng项目id = 0 Then lng项目id = lng路径项目ID
                        If str路径项目分类 = "" Then str路径项目分类 = str分类
                        .Cell(flexcpBackColor, k, 0, k, .Cols - 1) = .BackColor
                    End If
                Next
                '如果是一并给药的，则同步更新给药途径
                If RowIn一并给药(lngRow) Then
                    k = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                    If k <> -1 Then
                        .TextMatrix(k, COL_路径项目ID) = .TextMatrix(lngRow, COL_路径项目ID)
                        .TextMatrix(k, COL_路径项目分类) = .TextMatrix(lngRow, COL_路径项目分类)
                    End If
                End If
            Else
                For k = lngBegin To lngEnd
                   .TextMatrix(k, COL_路径项目ID) = -1   '不在路径表单中体现
                   .TextMatrix(k, COL_路径项目分类) = ""
                   .Cell(flexcpBackColor, k, 0, k, .Cols - 1) = .BackColor
                Next
            End If
            lngRow = lngEnd + 1
        Wend
        
        If blnOut Then
            If InStr(GetInsidePrivs(p临床路径应用), ";路径外项目;") = 0 Then
                MsgBox "你没有添加路径外项目的权限，请删除黄色背景的医嘱，否则不能保存医嘱。", vbExclamation, gstrSysName
            End If
        End If
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function CheckUnStopedAdvice(ByVal dat开始时间 As Date, Optional ByVal bln术后 As Boolean) As Boolean
'功能：检查指定停止时间前是否存在未停止的长嘱
'返回：true=存在
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    
    strSQL = "Select 1" & vbNewLine & _
            "From 病人医嘱记录 A" & vbNewLine & _
            "Where a.病人id = [1] And a.主页id = [2] " & IIF(mint婴儿 = 0, IIF(bln术后, "  And Nvl(a.婴儿, 0) = 0 ", ""), " And Nvl(a.婴儿, 0) = [3]") & _
            " And a.医嘱期效 = 0 And a.执行标记 <> -1 And a.医嘱状态 Not In (-1, 1, 2, 4, 8, 9)" & vbNewLine & _
            " And a.开始执行时间 <= [4] And Rownum < 2" & " And Not Exists(Select 1 From 诊疗项目目录 B Where a.诊疗项目ID = b.ID And a.诊疗类别='H' And b.操作类型='1' And b.执行频率=2)"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, mint婴儿, dat开始时间)
    CheckUnStopedAdvice = rsTmp.RecordCount > 0
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function


Private Sub AdviceRSAddRow(ByRef rsAdvice As ADODB.Recordset, ByVal i As Long)
'功能：根据指定行的信息复制产生医嘱记录集的一行数据
 
    With vsAdvice
        rsAdvice.AddNew
        rsAdvice!ID = .RowData(i)
        rsAdvice!相关ID = Val("" & .TextMatrix(i, COL_相关ID))
        rsAdvice!前提ID = mlng前提ID
        rsAdvice!病人来源 = 2
        rsAdvice!病人ID = mlng病人ID
        rsAdvice!主页ID = mlng主页ID
        
        rsAdvice!婴儿 = Val("" & .TextMatrix(i, COL_婴儿))
        rsAdvice!姓名 = txtPati.Text
        rsAdvice!性别 = mstr性别
        rsAdvice!年龄 = mint年龄
        rsAdvice!病人科室id = mlng病人科室id
        
        rsAdvice!序号 = .TextMatrix(i, COL_序号)
        rsAdvice!医嘱状态 = .TextMatrix(i, COL_状态)
        rsAdvice!医嘱期效 = IIF(.TextMatrix(i, COL_期效) = "临嘱", 1, 0)
        rsAdvice!诊疗类别 = .TextMatrix(i, COL_类别)
        rsAdvice!诊疗项目ID = Val("" & .TextMatrix(i, COL_诊疗项目ID))
        rsAdvice!标本部位 = .TextMatrix(i, COL_标本部位)
        rsAdvice!检查方法 = .TextMatrix(i, COL_检查方法)
        
        rsAdvice!收费细目ID = Val("" & .TextMatrix(i, COL_收费细目ID))
        rsAdvice!天数 = Val("" & .TextMatrix(i, COL_天数))
        rsAdvice!单次用量 = Val("" & .TextMatrix(i, COL_单量))
        rsAdvice!总给予量 = Val("" & .TextMatrix(i, COL_总量))
        
        rsAdvice!医嘱内容 = .TextMatrix(i, col_医嘱内容)
        rsAdvice!医生嘱托 = .TextMatrix(i, COL_医生嘱托)
        rsAdvice!执行科室ID = Val("" & .TextMatrix(i, COL_执行科室ID))
        rsAdvice!执行频次 = .TextMatrix(i, COL_频率)
        rsAdvice!频率次数 = Val("" & .TextMatrix(i, COL_频率次数))
        rsAdvice!频率间隔 = Val("" & .TextMatrix(i, COL_频率间隔))
        rsAdvice!间隔单位 = .TextMatrix(i, COL_间隔单位)
        rsAdvice!执行时间方案 = .TextMatrix(i, COL_执行时间)
        rsAdvice!计价特性 = Val("" & .TextMatrix(i, COL_计价性质))
        rsAdvice!执行性质 = Val("" & .TextMatrix(i, COL_执行性质))
        rsAdvice!执行标记 = Val("" & .TextMatrix(i, COL_执行标记))
                    
        rsAdvice!可否分零 = Val("" & .TextMatrix(i, COL_可否分零))
        rsAdvice!紧急标志 = Val("" & .TextMatrix(i, COL_标志))
        rsAdvice!开始执行时间 = .TextMatrix(i, COL_开始时间)
        rsAdvice!执行终止时间 = IIF(.TextMatrix(i, COL_终止时间) = "", CDate(0), .TextMatrix(i, COL_终止时间))
        
        rsAdvice!开嘱科室id = Val("" & .TextMatrix(i, COL_开嘱科室ID))
        rsAdvice!开嘱医生 = .TextMatrix(i, COL_开嘱医生)
        rsAdvice!开嘱时间 = CDate(.TextMatrix(i, COL_开嘱时间))
        rsAdvice!摘要 = .Cell(flexcpData, i, COL_医生嘱托)
        
        rsAdvice!EditState = Val(.TextMatrix(i, COL_EDIT)) '1-新增，2－修改
        rsAdvice!用药目的 = Val("" & .TextMatrix(i, COL_用药目的))     '1-预防,2-治疗
        rsAdvice!用药理由 = .TextMatrix(i, COL_用药理由)
        
        rsAdvice.Update
    End With
End Sub

Private Function zlPluginAdviceEnter(ByVal lngRow As Long) As Boolean
'功能：输入医嘱完成后调用外挂接口
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim rsAdvice As ADODB.Recordset
    
    Set rsAdvice = GetAdviceRs
    
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    For i = lngBegin To lngEnd
        If Val(vsAdvice.RowData(i)) <> 0 Then
            Call AdviceRSAddRow(rsAdvice, i)
        End If
    Next
    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
    Call CreatePlugInOK(p住院医嘱下达, mint场合)
    On Error Resume Next
    zlPluginAdviceEnter = gobjPlugIn.AdviceEnter(glngSys, p住院医嘱下达, mlng病人ID, mlng主页ID, rsAdvice, mint场合)
    If err.Number <> 0 And zlPluginAdviceEnter = False Then zlPluginAdviceEnter = True
    Call zlPlugInErrH(err, "AdviceEnter")
    err.Clear: On Error GoTo 0
End Function

Private Function zlPluginAdviceSave() As Boolean
'功能：医嘱保存前调用外挂接口
    Dim i As Long
    Dim rsAdvice As ADODB.Recordset
    
    Dim lngBegin As Long, lngEnd As Long
    Dim rsTmp As ADODB.Recordset
    
    Set rsAdvice = GetAdviceRs
    
    With vsAdvice
        '医嘱录入完成之后直接保存可能导到当前这行医嘱没有调用到外挂 AdviceEditAfter此处再调用一次。
        If mbytUseType = 0 Or mbytUseType = 2 Then
            i = .Row
            If .RowData(i) <> 0 And (Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_EDIT)) = 2) Then
                Set rsTmp = zlDatabase.zlCopyDataStructure(rsAdvice)
                Call GetRowScope(i, lngBegin, lngEnd)
                For i = lngBegin To lngEnd
                    If Val(vsAdvice.RowData(i)) <> 0 Then
                        Call AdviceRSAddRow(rsTmp, i)
                    End If
                Next
                If rsTmp.RecordCount > 0 Then rsTmp.MoveFirst
            End If
        End If
    
        For i = .FixedRows To .Rows - 1
            '新增或修改的有效行(非空行)
            If .RowData(i) <> 0 And InStr(",1,2,", Val(.TextMatrix(i, COL_EDIT))) > 0 _
                And (mbytUseType <> 1 Or mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2) Then
                Call AdviceRSAddRow(rsAdvice, i)
            End If
        Next
    End With
    
    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
    Call CreatePlugInOK(p住院医嘱下达, mint场合)
    On Error Resume Next
    
    If Not (rsTmp Is Nothing) Then
        If rsTmp.RecordCount > 0 Then
            Call gobjPlugIn.AdviceEditAfter(glngSys, p住院医嘱下达, mlng病人ID, mlng主页ID, rsTmp, mint场合)
            Call zlPlugInErrH(err, "AdviceEditAfter")
        End If
    End If
    zlPluginAdviceSave = gobjPlugIn.AdviceSave(glngSys, p住院医嘱下达, mlng病人ID, mlng主页ID, rsAdvice, mint场合)
    If err.Number <> 0 And zlPluginAdviceSave = False Then zlPluginAdviceSave = True
    Call zlPlugInErrH(err, "AdviceSave")
    err.Clear: On Error GoTo 0
End Function

Private Sub zlPluginAdviceRowChange(ByVal lngRow As Long, Optional ByVal intType As Integer)
'功能：医嘱切换行后调用外挂接口
'参数：intType 0－调用外挂接口 AdviceRowChange；1－调用接口 AdviceEditAfter
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim rsAdvice As ADODB.Recordset
    
    If Val(vsAdvice.RowData(lngRow)) = 0 Then Exit Sub
    Set rsAdvice = GetAdviceRs
    
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    For i = lngBegin To lngEnd
        If Val(vsAdvice.RowData(i)) <> 0 Then
            Call AdviceRSAddRow(rsAdvice, i)
        End If
    Next
    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
    Call CreatePlugInOK(p住院医嘱下达, mint场合)
    On Error Resume Next
    If intType = 0 Then
        Call gobjPlugIn.AdviceRowChange(glngSys, p住院医嘱下达, mlng病人ID, mlng主页ID, rsAdvice, mint场合)
        Call zlPlugInErrH(err, "AdviceRowChange")
    Else
        Call gobjPlugIn.AdviceEditAfter(glngSys, p住院医嘱下达, mlng病人ID, mlng主页ID, rsAdvice, mint场合)
        Call zlPlugInErrH(err, "AdviceEditAfter")
    End If
    err.Clear: On Error GoTo 0
End Sub

Private Function CheckAdviceOfPathItem(ByVal lng路径执行ID As Long, ByVal lng医嘱ID As Long) As Boolean
'功能：检查指定的医嘱是否是"选择生成"的医嘱之一(存在其他医嘱)，不含本次界面上已删除的医嘱(mstrDelTempIDs)
'返回：true=该医嘱的路径项目不是选择生成，或者不存在其他医嘱
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    
    strSQL = "Select 1" & vbNewLine & _
            "From 病人路径医嘱 A" & vbNewLine & _
            "Where a.路径执行id = [1] And instr([3],','|| a.病人医嘱id||',') = 0 And Not Exists" & vbNewLine & _
            " (Select 1 From 病人医嘱记录 B Where a.病人医嘱id = b.Id And (b.Id = [2] Or b.相关id = [2])) And Exists" & vbNewLine & _
            " (Select 1 From 病人路径执行 C, 临床路径项目 D Where c.Id = a.路径执行id And c.项目id = d.Id And d.内容要求 = 1) And Rownum < 2"

    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng路径执行ID, lng医嘱ID, "," & mstrDelIDs & ",")
    CheckAdviceOfPathItem = rsTmp.RecordCount = 0
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function CheckPathEvalute() As Boolean
'功能：检查病人当天是否已进行了评估
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    
    strSQL = "Select 1" & vbNewLine & _
            "From 病人临床路径 A, 病人路径评估 B" & vbNewLine & _
            "Where a.病人id = [1] And a.主页id = [2] And a.Id = b.路径记录id And a.当前天数 = b.天数 And a.当前阶段id = b.阶段id"

    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
    CheckPathEvalute = rsTmp.RecordCount > 0
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub Set安排时间(ByVal strType As String)
'功能：设置手术或输血医嘱的安排时间位置
'参数：strType=F-手术,K-输血

    If strType = "F" Then
        lbl安排时间.Caption = "手术时间"
        lbl安排时间.Top = lbl用法.Top
        txt安排时间.Top = txt用法.Top
    
        lbl安排时间.Left = lbl医嘱内容.Left
        txt安排时间.Left = txt用法.Left
    Else
        lbl安排时间.Caption = "输血时间"
        lbl安排时间.Top = lbl开始时间.Top
        txt安排时间.Top = msk开始时间.Top
    
        lbl安排时间.Left = lbl医生嘱托.Left
        txt安排时间.Left = cbo医生嘱托.Left
        
        'SetItemEditable中设置了显示“安排时间”就不显示“用法”
        lbl用法.Visible = True
        txt用法.Visible = True
        cmd用法.Visible = True
    End If
    
    cmd安排时间.Top = txt安排时间.Top + 30
    cmd安排时间.Left = txt安排时间.Left + txt安排时间.Width - cmd安排时间.Width - 30
End Sub


Private Sub txt用药理由_GotFocus()
    zlControl.TxtSelAll txt用药理由
    Call zlCommFun.OpenIme(True)
End Sub

Private Sub txt用药理由_LostFocus()
    Call zlCommFun.OpenIme(False)
End Sub

Private Sub txt用药理由_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt用药理由.Text <> "" And vsAdvice.TextMatrix(vsAdvice.Row, COL_类别) <> "K" Then
            If ReasonSelect(txt用药理由.Text, 1) Then Exit Sub
        End If
        If SeekNextControl Then Call txt用药理由_Validate(False)
    End If
End Sub

Private Sub txt用药理由_Change()
    txt用药理由.Tag = "1"
End Sub

Private Sub txt用药理由_Validate(Cancel As Boolean)
    If zlCommFun.ActualLen(txt用药理由.Text) > 1000 Then
        MsgBox "输入内容不过超过 500 个汉字或 1000 个字符。", vbInformation, gstrSysName
        txt用药理由_GotFocus
        Cancel = True: Exit Sub
    End If
    
    '更新数据
    Call AdviceChange
End Sub

Private Sub cboDruPur_Click()
    lbl用药目的.Tag = "1"
    Call AdviceChange
End Sub

Private Sub cboDruPur_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        SeekNextControl
    End If
End Sub

Private Sub SetRow标志图标(ByVal i As Long, Optional ByVal bytMode As Byte)
'功能：根据当前行的状态，设置标志列的图标显示
'参数：i=当前行
'      bytMode=一并给药时传入，0-根据传入行的状态处理组内首行，1-传入行是组内首行时才处理,2-只处理传入行
'      危急值图标，已保存数据的图标显示和本次新增医嘱的图标显示
    Dim blnFirst As Boolean, lngRow As Long
    Dim int图标数 As Integer '医嘱内容上面的图标个数
    
    With vsAdvice
        '自由录入
        If Val(.TextMatrix(i, COL_诊疗项目ID)) = 0 Then
             Set .Cell(flexcpPicture, i, COL_F标志) = frmIcons.imgFlag.ListImages("自由").Picture
             .Cell(flexcpPictureAlignment, i, COL_F标志) = 4
             
             '危急值图标
            If mlng危急值ID > 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_危急值ID)) > 0 Then
                If int图标数 = 0 Then
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = frmIcons.imgQuestion.ListImages("危急值").Picture
                ElseIf int图标数 = 1 Then
                    pictmp.Cls
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, pictmp.Width / 2, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("危急值").Picture, pictmp.Width / 2, 0, pictmp.Width / 2, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    int图标数 = 2
                ElseIf int图标数 = 2 Then
                    pictmp.Cls
                    pictmp.Width = 720
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, 480, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("危急值").Picture, 480, 0, 240, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    pictmp.Width = 480
                    int图标数 = 3
                End If
            End If
        Else
            blnFirst = True
            lngRow = i
            '一并给药的图标只显示在第一行(审核状态除外)
            If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 Then
                If bytMode > 0 Then
                    If bytMode = 1 Then
                        '判断传入行是组内首行时才处理(可能还没有设置给药途径)
                        If Val(.TextMatrix(i, COL_相关ID)) = Val(.TextMatrix(i - 1, COL_相关ID)) And Val(.TextMatrix(i, COL_相关ID)) <> 0 Then blnFirst = False
                    Else
                        '只处理传入的行(取消一并时)
                    End If
                Else
                    '根据传入行的状态处理组内首行
                    lngRow = .FindRow(.TextMatrix(i, COL_相关ID), , COL_相关ID)
                End If
            End If
        
            If blnFirst Then
                '备用医嘱
                If .TextMatrix(lngRow, COL_频率) = "必要时" Or .TextMatrix(lngRow, COL_频率) = "需要时" Then
                    Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("备用").Picture
                ElseIf .TextMatrix(i, COL_标志) = "2" Then
                    Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("补录").Picture
                ElseIf .TextMatrix(i, COL_标志) = "1" Then
                    Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("紧急").Picture
                Else
                    Set .Cell(flexcpPicture, lngRow, COL_F标志) = Nothing
                End If
            
                '一并给药显示在第一行
                If Val(.TextMatrix(i, COL_状态)) < 2 Then   '新开或暂存的医嘱
                    Select Case Val(.TextMatrix(i, COL_审核状态))
                    '0-无需审核，1-待审核，2-审核通过，3-审核未通过
                        Case 1
                            If .TextMatrix(i, COL_类别) = "K" And Val(.TextMatrix(i, COL_检查方法)) = 1 Then
                                '用血医嘱审核图标单独显示(表明是有医生核对)
                                Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("核对").Picture
                            Else
                                Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("待审核").Picture
                            End If
                        Case 2
                            If Not (.TextMatrix(i, COL_类别) = "K" And Val(.TextMatrix(i, COL_检查方法)) = 1) Then
                                Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("审核通过").Picture
                            End If
                        Case 3
                            Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("审核未通过").Picture
                        Case 4, 5
                            If gbln血库系统 = False Then Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("待审核").Picture
                        Case 7
                            Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("待签发").Picture
                    End Select
                    '处方审查系统
                    If .TextMatrix(i, COL_处方审查状态) = "0" Then
                        Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("待审核").Picture
                    ElseIf .TextMatrix(i, COL_处方审查状态) = "2" Or .TextMatrix(i, COL_处方审查结果) = "1" Then
                        '超时免审当作合格处理
                        Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("审核通过").Picture
                    ElseIf .TextMatrix(i, COL_处方审查结果) = "2" Then
                        ' 不合格
                        Set .Cell(flexcpPicture, lngRow, COL_F标志) = frmIcons.imgFlag.ListImages("审核未通过").Picture
                    End If
                End If
                .Cell(flexcpPictureAlignment, lngRow, COL_F标志) = 4
                
            End If
            
            If Val(.TextMatrix(i, COL_签名否)) = 1 Then
                Set .Cell(flexcpPicture, i, col_医嘱内容) = frmIcons.imgSign.ListImages("签名").Picture
                int图标数 = 1
            End If
            
            If Val(.TextMatrix(i, COL_高危药品)) > 0 Then
                If .Cell(flexcpPicture, i, col_医嘱内容) Is Nothing Then
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = frmIcons.imgQuestion.ListImages("高危药品").Picture
                    int图标数 = 1
                Else
                    If .Cell(flexcpPicture, i, col_医嘱内容) <> frmIcons.imgQuestion.ListImages("高危药品").Picture Then
                        pictmp.Cls
                        pictmp.PaintPicture vsAdvice.Cell(flexcpPicture, i, col_医嘱内容), 0, 0, pictmp.Width / 2, pictmp.Height
                        pictmp.PaintPicture frmIcons.imgQuestion.ListImages("高危药品").Picture, pictmp.Width / 2, 0, pictmp.Width / 2, pictmp.Height
                        Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                        int图标数 = 2
                    End If
                End If
            End If
            
            '危急值图标
            If mlng危急值ID > 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_危急值ID)) > 0 Then
                If int图标数 = 0 Then
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = frmIcons.imgQuestion.ListImages("危急值").Picture
                ElseIf int图标数 = 1 Then
                    pictmp.Cls
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, pictmp.Width / 2, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("危急值").Picture, pictmp.Width / 2, 0, pictmp.Width / 2, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    int图标数 = 2
                ElseIf int图标数 = 2 Then
                    pictmp.Cls
                    pictmp.Width = 720
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, 480, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("危急值").Picture, 480, 0, 240, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    pictmp.Width = 480
                    int图标数 = 3
                End If
            End If
            
            '易跌倒图标
            If Val(.TextMatrix(i, COL_易跌倒)) > 0 Then
                If int图标数 = 0 Then
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = frmIcons.imgQuestion.ListImages("易跌倒").Picture
                ElseIf int图标数 = 1 Then
                    pictmp.Cls
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, pictmp.Width / 2, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("易跌倒").Picture, pictmp.Width / 2, 0, pictmp.Width / 2, pictmp.Height
                    Set vsAdvice.Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    int图标数 = 2
                ElseIf int图标数 = 2 Then
                    pictmp.Cls
                    pictmp.Width = 720
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, 480, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("易跌倒").Picture, 480, 0, 240, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    pictmp.Width = 480
                    int图标数 = 3
                ElseIf int图标数 = 3 Then
                    pictmp.Cls
                    pictmp.Width = 960
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_医嘱内容), 0, 0, 720, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("易跌倒").Picture, 720, 0, 240, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_医嘱内容) = pictmp.Image
                    pictmp.Width = 480
                    int图标数 = 4
                End If
            End If
        End If
    End With
End Sub


Private Sub ReSet审核状态图标(ByVal lngRow As Long)
'功能：删除或修改一并给药中的一行医嘱后，重设组中首行的图标
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim blnDo As Boolean
    
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    
    '如果有审核未通过的，删除后变为待审核
    With vsAdvice
        For i = lngBegin To lngEnd
            If gblnKSSStrict And UserInfo.用药级别 < Val(.TextMatrix(i, COL_抗菌等级)) And (.TextMatrix(i, COL_标志) <> "1" Or .TextMatrix(i, COL_期效) = "长嘱") _
                Or gbln手术分级管理 And (.TextMatrix(i, COL_类别) = "F" Or .TextMatrix(i, COL_类别) = "G") Then
                .TextMatrix(i, COL_审核状态) = 1
            Else
                .TextMatrix(i, COL_审核状态) = ""
            End If
            
            If .TextMatrix(i, COL_审核状态) <> "" Then
                Set .Cell(flexcpPicture, lngBegin, COL_F标志) = frmIcons.imgFlag.ListImages("待审核").Picture
                .Cell(flexcpPictureAlignment, lngBegin, COL_F标志) = 4
                blnDo = True
            End If
            
            '备用医嘱
            If .TextMatrix(i, COL_频率) = "必要时" Or .TextMatrix(i, COL_频率) = "需要时" Then
                blnDo = True
            End If
        Next
        If blnDo = False Then Set .Cell(flexcpPicture, lngBegin, COL_F标志) = Nothing
    End With
End Sub

Private Sub SetMediInfoItem(ByVal bln显示单量 As Boolean, ByVal bln显示抗菌药物 As Boolean)
'功能：隐藏或显示药品相关的信息项目：首次用量，超量说明，用药目的，用药理由
    Dim lngHeight As Long, lngHeightOld As Long
    Dim bytHideType As Byte
        
    lngHeightOld = fraAdvice.Height
    lngHeight = txt开嘱时间.Top + txt开嘱时间.Height + IIF(mbytSize = 0, 60, 90)
    
    If bln显示单量 Or bln显示抗菌药物 Then
        If bln显示抗菌药物 = False Then
            lngHeight = lngHeight + txt超量说明.Height + IIF(mbytSize = 0, 60, 90)
        Else
            lngHeight = lngHeight + txt超量说明.Height + IIF(mbytSize = 0, 60, 90) + txt用药理由.Height + 90
        End If
    End If
    
    If lngHeightOld <> lngHeight Then
        fraAdvice.Height = lngHeight
        '处理滚动条bug
        fraAdvice.Tag = "不滚动"
        Call cbsMain_Resize
        fraAdvice.Tag = ""
        '需要调用两次才能生效
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
    End If
End Sub


Private Function CheckBabyEdit() As Integer
'功能：检查母婴分离是否允许编辑
'返回：0，允许编辑，1=婴儿科室不允许编辑病人医嘱，2=病人科室不允许编辑婴儿医嘱
    CheckBabyEdit = 0
    If mlng婴儿科室ID <> 0 And cbo婴儿.Visible Then
        If (mlng婴儿科室ID = mlng医护科室ID Or mlng婴儿病区ID = mlng医护科室ID) And cbo婴儿.ListIndex = 0 Then
            CheckBabyEdit = 1
        ElseIf (mlng病人科室id = mlng医护科室ID Or mlng病人病区ID = mlng医护科室ID) And cbo婴儿.ListIndex > 0 Then
            CheckBabyEdit = 2
        End If
    End If
End Function

Private Function CheckDelAdivceOfPathItem(ByRef str医嘱IDs As String) As String
'功能：检查删除医嘱对应的路径项目是否允许删除，如果是必须执行的项目所对应的医嘱，则需要弹出原因选择并更新变异原因，
'       添加过变异原因的不再添加
'返回：原因字符串或者为空串
'参数:str医嘱IDs:ID,ID,ID,ID...
    Dim blnCancel As Boolean
    Dim i, j As Long
    Dim strSQL As String
    Dim rsTmp, rsAdvice As ADODB.Recordset
    Dim rsReason As ADODB.Recordset
    Dim strReason As String
    Dim vPoint As PointAPI
    Dim blnUndo, blnHave As Boolean
    Dim strTemp As String
    Dim arrTmp As Variant
    Dim arrSQL As Variant
    Dim strMustSendIDs As String   '必须生成的医嘱
    
    str医嘱IDs = "," & str医嘱IDs & ","

    '1.检查路径项目
    strSQL = "Select /*+ rule*/ Distinct c.Id As 执行id, c.分类, c.变异原因, d.执行方式, c.天数, c.阶段id, c.路径记录id, c.项目id" & vbNewLine & _
            "From 病人路径医嘱 B, 病人路径执行 C, 临床路径项目 D" & vbNewLine & _
            "Where b.病人医嘱id IN(Select Column_Value From Table(Cast(f_Num2list([1]) As zlTools.t_Numlist))) And b.路径执行id = c.Id And d.Id = c.项目id And d.执行方式 In (1, 2, 4)"
            

    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "检查路径医嘱", str医嘱IDs)

    If rsTmp.RecordCount < 1 Then
        str医嘱IDs = Mid(str医嘱IDs, 2, Len(str医嘱IDs) - 2)
        Exit Function    '非 必须生成的路径医嘱
    End If

    
    For i = 1 To rsTmp.RecordCount
        '2.检查医嘱能否删除
        If InStr(strTemp, "," & rsTmp!执行Id & ":") = 0 Then
            '根据执行方式 决定是否有必要添加变异原因
            If CheckPathItemIsMust(Val(rsTmp!执行方式 & ""), Val("" & rsTmp!天数), Val("" & rsTmp!路径记录id), Val("" & rsTmp!阶段id), Val("" & rsTmp!项目ID)) Then
                strTemp = strTemp & "," & rsTmp!执行Id & ":" & rsTmp!分类    '执行ID:项目分类
            End If
        End If
        '该路径项目存在已校对但未作废的其他医嘱，提示并禁止删除    医嘱状态 ：3-已校对
        strSQL = "Select a.病人医嘱ID,b.医嘱状态 " & vbNewLine & _
                 "From 病人路径医嘱 A, 病人医嘱记录 B" & vbNewLine & _
                 "Where a.路径执行id = [1] And a.病人医嘱id = b.Id "

        Set rsAdvice = zlDatabase.OpenSQLRecord(strSQL, "检查路径医嘱", rsTmp!执行Id)
        For j = 1 To rsAdvice.RecordCount
            strMustSendIDs = strMustSendIDs & "," & rsAdvice!病人医嘱ID
            rsAdvice.MoveNext
        Next
        rsAdvice.Filter = " 医嘱状态>1 and 医嘱状态<>4"
        If rsAdvice.RecordCount > 0 Then
            strTemp = Replace(strTemp, "," & rsTmp!执行Id & ":" & rsTmp!分类, "")
            blnUndo = True
            rsAdvice.Filter = "医嘱状态<=1 OR 医嘱状态=4"
            For j = 1 To rsAdvice.RecordCount
                str医嘱IDs = Replace(str医嘱IDs, "," & rsAdvice!病人医嘱ID & ",", ",")
                rsAdvice.MoveNext
            Next
        End If
        If blnUndo Then
            MsgBox "删除医嘱所在的路径项目中存在已校对但未作废的医嘱，请先作废该医嘱后再执行此操作。", vbInformation, gstrSysName
            Exit Function
        End If

        If mint场合 = 1 Then
            '对于已经过审核的医嘱，不允许修改删除。
            strSQL = "Select b.病人医嘱ID From 病人路径医嘱 B, 病人医嘱记录 C Where b.路径执行id = [1] And b.病人医嘱id = c.Id And c.开嘱医生 Like '%/%'"
            Set rsAdvice = zlDatabase.OpenSQLRecord(strSQL, "检查路径医嘱", rsTmp!执行Id)
            If rsAdvice.RecordCount > 0 Then
                strTemp = Replace(strTemp, "," & rsTmp!执行Id & ":" & rsTmp!分类, "")     '执行ID:项目分类
                blnHave = True
                For j = 1 To rsAdvice.RecordCount
                    str医嘱IDs = Replace(str医嘱IDs, "," & rsAdvice!病人医嘱ID & ",", ",")
                    rsAdvice.MoveNext
                Next
            End If
            If blnHave Then
                MsgBox "删除的医嘱中存在医生审查的医嘱，请取消审查后再执行此操作。", vbInformation, gstrSysName
                Exit Function
            End If
        End If
        rsTmp.MoveNext
    Next

    str医嘱IDs = Mid(str医嘱IDs, 2, IIF(str医嘱IDs = ",", 0, Len(str医嘱IDs) - 2))

    '3.必须生成的项目填写变异原因
    If strTemp <> "" Then
        '取消必须生成的项目时,选择变异原因
        strSQL = "Select b.名称 as 分类,a.编码 as ID,a.编码,a.名称,a.简码 From 变异常见原因 a,变异常见原因 b" & _
                 " Where a.性质=1 And a.末级=1 And a.上级=b.编码 And b.末级=0 " & _
                 " Order by 分类,a.编码"
        vPoint = zlControl.GetCoordPos(vsAdvice.hwnd, vsAdvice.CellLeft, vsAdvice.CellTop)

        Set rsReason = zlDatabase.ShowSelect(Me, strSQL, 0, "变异常见原因", True, , , True, True, True, _
                                             vPoint.X, vPoint.Y, vsAdvice.RowHeight(vsAdvice.Row), blnCancel, False, True)
        If rsReason Is Nothing Then
            If Not blnCancel Then
                MsgBox "系统没有初始变异常见原因，请与系统管理员联系。", vbInformation, gstrSysName
            End If
            '未添加变异原因的时候，所有必须生成的医嘱ID不返回
            str医嘱IDs = "," & str医嘱IDs & ","
            arrTmp = Split(Mid(strMustSendIDs, 2), ",")
            For i = 0 To UBound(arrTmp)
                str医嘱IDs = Replace(str医嘱IDs, "," & arrTmp(i) & ",", ",")
            Next
            str医嘱IDs = Mid(str医嘱IDs, 2, IIF(str医嘱IDs = ",", 0, Len(str医嘱IDs) - 2))  '未添加变异原因，不允许删除
            Exit Function
        Else
            strReason = rsReason!ID
        End If

        If strReason <> "" Then
            arrTmp = Split(Mid(strTemp, 2), ",")
            arrSQL = Array()
            For j = 0 To UBound(arrTmp)
                ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                arrSQL(j) = "Zl_病人路径生成_Update(" & Split(arrTmp(j), ":")(0) & ",'" & Split(arrTmp(j), ":")(1) & "',Null ,Null,Null,Null,Null,'" & strReason & "')"
            Next
            For j = 0 To UBound(arrTmp)
                Call zlDatabase.ExecuteProcedure(CStr(arrSQL(j)), Me.Caption)
            Next
        End If
    End If

    CheckDelAdivceOfPathItem = strReason
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub Set医嘱超量(ByVal lngBegin As Long, ByVal lngEnd As Long)
'功能：为指定范围内的医嘱设置超标记 .TextMatrix(i, COL_是否超量) .TextMatrix(i, COL_超量说明)
    Dim dbl总量 As Double
    Dim lng相关ID As Long
    Dim i As Long
    Dim j As Long
    
    With vsAdvice
        For i = lngBegin To lngEnd
            If .RowData(i) = 0 Then Exit Sub
            If .TextMatrix(i, COL_期效) = "临嘱" Then
                .TextMatrix(i, COL_首次用量) = ""
                If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 And Val(.TextMatrix(i, COL_处方限量)) > 0 Then
                    dbl总量 = Val(.TextMatrix(i, COL_总量)) * Val(.TextMatrix(i, COL_住院包装)) * Val(.TextMatrix(i, COL_剂量系数))
                    If dbl总量 > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
                ElseIf Val(.TextMatrix(i, COL_类别)) = 7 And Val(.TextMatrix(i, COL_处方限量)) > 0 Then   '中药
                    dbl总量 = Val(.TextMatrix(i, COL_单量)) * Val(.TextMatrix(i, COL_总量))
                    If dbl总量 > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
                ElseIf .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "4" Then
                    lng相关ID = .RowData(i)
                    For j = i - 1 To .FixedRows Step -1
                        If Val(.TextMatrix(j, COL_相关ID)) = lng相关ID Then
                            If .TextMatrix(j, COL_是否超量) = "1" Then
                                .TextMatrix(i, COL_是否超量) = "1"
                                .TextMatrix(j, COL_是否超量) = ""
                            End If
                        Else
                            Exit For
                        End If
                    Next
                ElseIf Val(.TextMatrix(i, COL_处方限量)) > 0 Then    '其他诊疗项目
                    If Val(.TextMatrix(i, COL_总量)) > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
                End If
            Else
                If InStr(",5,6,", .TextMatrix(i, COL_类别)) > 0 And Val(.TextMatrix(i, COL_处方限量)) > 0 Then
                    If Val(.TextMatrix(i, COL_收费细目ID)) = 0 Then
                        If Val(.TextMatrix(i, COL_单量)) > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
                    ElseIf Val(.TextMatrix(i, COL_频率间隔)) <> 0 Then
                        dbl总量 = Calc缺省药品总量(Val(.TextMatrix(i, COL_单量)), 1, _
                        Val(.TextMatrix(i, COL_频率次数)), _
                        Val(.TextMatrix(i, COL_频率间隔)), _
                        .TextMatrix(i, COL_间隔单位), _
                        .TextMatrix(i, COL_执行时间), _
                        Val(.TextMatrix(i, COL_剂量系数)), _
                        Val(.TextMatrix(i, COL_住院包装)), _
                        Val(.TextMatrix(i, COL_可否分零)), _
                        Val(.TextMatrix(i, COL_首次用量)))
                        dbl总量 = dbl总量 * Val(.TextMatrix(i, COL_住院包装)) * Val(.TextMatrix(i, COL_剂量系数))
                        If Val(.TextMatrix(i, COL_总量)) > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
                    End If
                ElseIf Val(.TextMatrix(i, COL_处方限量)) > 0 Then '其他诊疗项目
                    If Val(.TextMatrix(i, COL_单量)) > Val(.TextMatrix(i, COL_处方限量)) Then .TextMatrix(i, COL_是否超量) = "1"
                End If
            End If
            If .TextMatrix(i, COL_是否超量) = "" Then .TextMatrix(i, COL_超量说明) = ""
        Next
    End With
End Sub

Private Function GetInsureStr(ByRef strIDs1 As String, ByRef strIDs2 As String, ByRef str医嘱内容 As String, ByVal lngRow As Long) As Boolean
'功能：获取医保对码的字符串
'   strIDs1:药品卫材的收费细目ID字符串，strIDs2 ：其他诊疗项目的诊疗项目ID:执行科室字符串
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    With vsAdvice
        '为利用索引,用Union方式
        For i = lngBegin To lngEnd
            If Val(.TextMatrix(i, COL_诊疗项目ID)) <> 0 Then
                If InStr(",4,5,6,7,", .TextMatrix(i, COL_类别)) > 0 Then
                    '药品、卫材无对应关系,药品只处理按规格下达时
                    If Val(.TextMatrix(i, COL_收费细目ID)) <> 0 And InStr("," & strIDs1 & ",", "," & Val(.TextMatrix(i, COL_收费细目ID)) & ",") = 0 Then
                        strIDs1 = strIDs1 & "," & .TextMatrix(i, COL_收费细目ID)
                    End If
                ElseIf InStr("," & strIDs2 & ",", "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & ",") = 0 Then
                    '包含了收费数量为0的
                    strIDs2 = strIDs2 & "," & Val(.TextMatrix(i, COL_诊疗项目ID)) & ":" & Val(.TextMatrix(i, COL_执行科室ID))
                End If
            End If
        Next
        str医嘱内容 = Left(vsAdvice.TextMatrix(lngRow, col_医嘱内容), 50)
    End With
End Function

Private Sub zlPASSMap()
'功能:设置Pass VsAdvie及列映射
'说明:删除或修改下面列中数据时，请检查合理用药部件中的关联处理。
'     对应列包含所有合理用药检测接口需要用到的列
    
    If mobjPassMap Is Nothing Then
        Set mobjPassMap = DynamicCreate("zlPassInterface.clsPassMap", "合理用药监测", True)
        mblnPass = Not gobjPass Is Nothing And Not mobjPassMap Is Nothing
    End If
    If mblnPass Then
        With mobjPassMap
            .lngModel = PM_住院编辑
            .int场合 = mint场合
            Set .frmMain = Me
            .bytUseType = mbytUseType
            Set .vsAdvice = vsAdvice
            Set .VSCOL = .GetVSCOL(-1, COL_相关ID, COL_类别, COL_诊疗项目ID, COL_收费细目ID, col_医嘱内容, COL_期效, COL_单量, COL_单量单位, COL_用法, _
                            COL_天数, COL_婴儿, COL_开嘱时间, COL_开嘱医生, COL_开始时间, COL_开嘱科室ID, COL_终止时间, COL_频率, COL_频率次数, COL_频率间隔, COL_间隔单位, _
                            COL_警示, COL_序号, COL_状态, COL_EDIT, , , COL_选择, COL_执行性质, COL_标本部位, , , , , , COL_总量, COL_住院单位, COL_医生嘱托, COL_用药目的, _
                            COL_操作类型, COL_禁忌药品说明, COL_用药理由, COL_标志, , COL_执行分类, COL_执行科室ID)
            Set .objCmdBar = cmdAlley
            Set .PassPati = .GetPatient()
            mblnPass = gobjPass.zlPassCheck(mobjPassMap)
        End With
    End If
End Sub

Private Sub zlPASSPati()
'功能:设置病人信息
    
    If Not mobjPassMap Is Nothing Then
        With mobjPassMap.PassPati
            .int婴儿 = IIF(cbo婴儿.ListIndex = -1, 0, cbo婴儿.ListIndex)  '缺省新增病人为0
            .dbl标识号 = Val(lvwPati.SelectedItem.SubItems(Item_标识号) & "") '住院号
            .Dat出生日期 = CDate(lvwPati.SelectedItem.ListSubItems(Itag_出生日期).Tag)
            .lng病人ID = mlng病人ID
            .lng挂号ID = 0
            .lng主页ID = mlng主页ID
            .str挂号单 = ""
            .str床号 = lvwPati.SelectedItem.SubItems(Item_床号)
            .str性别 = mstr性别
            .str姓名 = txtPati.Text
        End With
    End If
End Sub

Private Function SetAll超量说明(ByVal lngRow As Long, ByRef blnOut As Boolean) As Boolean
'功能：检查没有写超量说明的医嘱然后为其添加超量说明
'参数：lngRow开始行号
'      blnOut 表示弹出了输入界面但没填写任何内容
    Dim i As Long
    Dim str配方 As String
    Dim str行IDs As String '需要填写超量说明的医嘱行号
    Dim str超量说明 As String
    Dim strMsg As String
    Dim varArr As Variant
    
    blnOut = False
    With vsAdvice
        For i = lngRow To .Rows - 1
            If .TextMatrix(i, COL_是否超量) = "1" And .TextMatrix(i, COL_超量说明) = "" And (Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_EDIT)) = 2) Then
                If .TextMatrix(i, COL_类别) = "E" And .TextMatrix(i, COL_操作类型) = "4" Then '中草药的超量标志放到了显示行，只能大概提示
                    str配方 = .TextMatrix(i, col_医嘱内容)
                    str配方 = "中草药配方：" & Mid(str配方, InStr(str配方, ":") + 1)
                    strMsg = strMsg & "，" & """" & str配方 & """"
                Else
                    strMsg = strMsg & "，" & """" & .TextMatrix(i, col_医嘱内容) & """"
                End If
                str行IDs = str行IDs & "," & i
            End If
        Next
    End With
    strMsg = Mid(strMsg, 2) & "，超出了处方限量，请填写超量说明。"
    str行IDs = Mid(str行IDs, 2)
    
    If strMsg <> "" And str行IDs <> "" Then
        Call frmMsgDruExcess.ShowMe(Me, 0, strMsg, str超量说明)
    Else
        SetAll超量说明 = True
        Exit Function
    End If
    
    If str超量说明 = "*NULL*" Then 'str超量说明 = "*NULL*" 表示没有填写任何东西
        blnOut = True
    ElseIf str超量说明 <> "" Then
        varArr = Split(str行IDs, ",")
        For i = 0 To UBound(varArr)
            vsAdvice.TextMatrix(Val(varArr(i)), COL_超量说明) = str超量说明
        Next
    End If
    SetAll超量说明 = True
End Function

Private Function Set药品连续用药(ByVal lng病人ID As Long, lng主页ID As Long, ByVal lng药名ID As Long, ByVal lng药品ID As Long) As Boolean
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    
    On Error GoTo errH
    
    '取有效时间内的最后一次过敏结果登记
    strSQL = "Select 药物名,结果,Nvl(过敏时间,记录时间) as 过敏时间 From 病人过敏记录" & _
        " Where 病人ID=[1] And 药物ID=[2] And Trunc(Nvl(过敏时间,记录时间))>=Trunc(Sysdate-[3])" & _
        " Order by Nvl(过敏时间,记录时间) Desc"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng病人ID, lng药名ID, gint过敏登记有效天数)
    
    If rsTmp.EOF Then
        '无过敏结果登记记录,则先看该药品是否需要皮试
        strSQL = "Select A.用法ID,B.名称" & _
            " From 诊疗用法用量 A,诊疗项目目录 B" & _
            " Where A.用法ID=B.ID And A.性质=0 And A.项目ID=[1]" & _
            " And (B.站点='" & gstrNodeNo & "' Or B.站点 is Null)"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng药名ID)
        
        If Not rsTmp.EOF Then
            '如果按规格下达则判断 药品id,否则按品种判断 75874
            strSQL = "select 1 from 病人医嘱记录 a where a.病人id=[1] and a.主页id=[2]" & _
                IIF(lng药品ID <> 0, " and a.收费细目id=[3]", " and a.诊疗项目id=[3]") & _
                " And Trunc(a.上次执行时间)>=Trunc(Sysdate-[4]) And Rownum<2"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng病人ID, lng主页ID, IIF(0 <> lng药品ID, lng药品ID, lng药名ID), gint过敏登记有效天数)
            Set药品连续用药 = Not rsTmp.EOF
        End If
    End If
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function ApplySelect() As Integer
'功能：弹出申请单选择器
    Dim strSQL As String, rsTmp As ADODB.Recordset
    Dim intTmp As Integer, blnCancel As Boolean
    Dim vRect As RECT
    
    If mint场合 <> 0 Then Exit Function
   
    intTmp = Val(Mid(gstrInUseApp, 1, 1))
    If intTmp = 1 Then strSQL = "select 1 as id,'检查申请单' as 申请单 from dual"
    intTmp = Val(Mid(gstrInUseApp, 2, 1))
    If intTmp = 1 And Not gobjLIS Is Nothing Then strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 2 as id,'检验申请单' as 申请单 from dual"
    intTmp = Val(Mid(gstrInUseApp, 3, 1))
    If intTmp = 1 Then strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 3 as id,'输血申请单' as 申请单 from dual"
    intTmp = Val(Mid(gstrInUseApp, 4, 1))
    If intTmp = 1 Then strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 4 as id,'手术申请单' as 申请单 from dual"
    intTmp = Val(Mid(gstrInUseApp, 5, 1))
    If intTmp = 1 Then strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 5 as id,'会诊申请单' as 申请单 from dual"
    
    strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 6 as id,'转科申请单' as 申请单 from dual" & _
            " union all select 7 as id,'出院申请单' as 申请单 from dual"
            
    strSQL = strSQL & " order by id"

    On Error GoTo errH
    vRect = zlControl.GetControlRect(txt医嘱内容.hwnd)
    Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, Me.Caption, , , , , , True, vRect.Left, vRect.Top, txt医嘱内容.Height, blnCancel, , True)
    If Not rsTmp Is Nothing Then ApplySelect = Val(rsTmp!ID & "")
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function CanUseApply(ByVal str类别 As String, Optional ByVal str操作类型 As String, Optional ByVal lng项目id As Long, Optional ByVal str项目编码 As String) As Boolean
'功能：是否可以使用相应的申请单
'参数：str操作类型－会诊，转科，出院
'只用在医生工作站
    Dim strType As String
    Dim blnTmp As Boolean
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim str编码 As String
    Dim strEx As String

    If mint场合 <> 0 Or mbytUseType <> 0 Then
        Exit Function
    End If
    
    strType = str类别
    
    If str操作类型 <> "" And str类别 = "Z" Then
        strType = "会诊"
    End If
    
    If strType = "D" And Val(Mid(gstrInUseApp, 1, 1)) = 1 Or strType = "C" And Val(Mid(gstrInUseApp, 2, 1)) = 1 Or _
        strType = "K" And Val(Mid(gstrInUseApp, 3, 1)) = 1 Or (strType = "F" Or strType = "G") And Val(Mid(gstrInUseApp, 4, 1)) = 1 Or _
        strType = "会诊" And Val(Mid(gstrInUseApp, 5, 1)) = 1 Then
        
        blnTmp = True
        
    End If
    
    If lng项目id <> 0 And blnTmp Then
        If strType = "D" Then
            strSQL = "select 1 from 病历单据应用 where 诊疗项目ID=[1] and 应用场合 = [2]"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng项目id, 2)
            If rsTmp.EOF Then blnTmp = False
        ElseIf strType = "C" Then
            blnTmp = False
            If Not gobjLIS Is Nothing Then
                If str项目编码 <> "" Then
                    str编码 = str项目编码
                Else
                    str编码 = Sys.RowValue("诊疗项目目录", lng项目id, "编码")
                End If
                On Error Resume Next
                blnTmp = gobjLIS.CanUseLISApp(str编码, strEx)
                err.Clear: On Error GoTo 0
            End If
        End If
    End If
    CanUseApply = blnTmp
End Function

Private Function AdviceInput申请单(Optional ByVal intType As Integer) As Boolean
'功能：输入诊疗项目后弹出申请单
    Dim str类别 As String, str操作类型 As String
    Dim blnOK As Boolean
    Dim objAppPages() As clsApplicationData
    Dim rsCard As ADODB.Recordset
    Dim lngRow As Long

    On Error Resume Next
    '新增
    cbsMain.FindControl(, conMenu_New, True, True).Execute
    lngRow = vsAdvice.Row
    cbo期效.ListIndex = 1
    Select Case intType
    Case 1 '检查申请
        blnOK = ApplyNew检查申请(0, "", objAppPages())
    Case 2 '检验申请
        blnOK = ApplyNew检验申请(0, "", rsCard)
    Case 3 '输血申请
        blnOK = ApplyNew输血申请(0, "", rsCard)
    Case 4 '手术申请
        blnOK = ApplyNew手术申请(0, "", rsCard)
    Case 5 '会诊申请
        Call Apply会诊(vsAdvice.Row, 0)
        Exit Function
    Case 6 '转科3
        Call Apply特殊(vsAdvice.Row, 3)
        Exit Function
    Case 7 '通知出院5
        Call Apply特殊(vsAdvice.Row, 5)
        Exit Function
    End Select
    err.Clear
    
    On Error GoTo errH
    '根据选择项目设置缺省医嘱信息
    If blnOK Then
        Select Case intType
        Case 1 '检查申请
            Call AdviceSet检查申请(lngRow, objAppPages())
        Case 2 '检验申请
            Call AdviceSet检验申请(lngRow, rsCard)
        Case 3 '输血申请
            Call AdviceSet输血申请(lngRow, rsCard)
        Case 4 '手术申请
            Call AdviceSet手术申请(lngRow, rsCard)
        End Select
        
        '显示已缺省设置的值
        Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
        '医保管控实时监测
        If mint险类 <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
            '总量不可输入：缺省并固定总量的医嘱，以及长嘱
            '成套医嘱不在这里检查
            If gclsInsure.GetCapability(support实时监控, mlng病人ID, mint险类) And Not txt总量.Enabled Then
                If MakePriceRecord(vsAdvice.Row) Then
                    If Not gclsInsure.CheckItem(mint险类, 0, 0, mrsPrice) Then
                        Call AdviceCurRowClear: Exit Function
                    End If
                End If
                '标记为已经作了检查
                vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_状态) = 1
            End If
        End If
        txt医嘱内容.SetFocus: Call SeekNextControl '必须先定位
        mblnNoSave = True
    Else
        '恢复原值(AdviceInput函数中可能处理了一下)
        txt医嘱内容.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_医嘱内容)
        txt医嘱内容.SetFocus
    End If
    
    
    AdviceInput申请单 = True
    Exit Function
errH:
    If ErrCenter = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function Apply会诊(ByVal lngRow As Long, ByVal intType As Integer, Optional ByVal lng医嘱ID As Long, Optional ByVal lng项目id As Long, Optional ByVal lngNo As Long) As Long
'功能：处理会诊医嘱
'参数：lngRow－界面上输入的医嘱行号，
'      intType-调用方式，0－新增，1－确了诊疗项目后新增，2－医嘱卡片上点下拉按钮修改
'      lng医嘱ID－组医嘱ID，lng项目ID－诊疗项目id
'说明：1、弹出申请单界面保存医嘱；2、处理界面医嘱表格；3、设置医嘱序号；4、定位表格选择行。
    Dim blnOK As Boolean '医嘱是否已经保存
    Dim lngAdviceID As Long, lng开嘱科室ID As Long
    Dim intTmp As Integer, strTmp As String, strDelIDs As String
    Dim colSQL As Collection
    Dim strSQL As String, rsTmp As ADODB.Recordset
    Dim lng医嘱序号 As Long, i As Long, j As Long
    Dim lngCurRow As Long, bln手术序号 As Boolean
    Dim rsCard As ADODB.Recordset
    Dim lngTmp As Long
    Dim blnPreChange As Boolean
    Dim varArr As Variant
    Dim lngB As Long, lngE As Long
    Dim lngNoTmp As Long
    Dim lngPos As Long
    Dim blnNoChange As Boolean
    Dim datTurn  As Date
    Dim lngApplyNo As Long '会诊医嘱保存后的生成的申请序号
    Dim strRowNums As String '一组会诊医嘱的所有行号
    Dim strDelIDsTmp As String
    Dim arrSQL As Variant
    Dim blnTrans As Boolean
    Dim lngTmpRow As Long
    
    On Error GoTo errH
    
    If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
        If CheckPatiTurnLimit(mlng病人ID, mlng主页ID, mlng病人病区ID, mlng病人科室id, datTurn, mintPState) = False Then Exit Function
    End If
    
    If intType = 2 Then
        intTmp = 1
        lngAdviceID = lng医嘱ID
        If lngNo = -1 Then lngAdviceID = 0
    Else
        intTmp = 0
        lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 2)
    End If
    
    If lngNo <> 0 Then
        Call InitCardRs(rsCard)
        strTmp = "" '收集所有执行科室ID
        With vsAdvice
            lngTmp = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
            If lngNo = -1 Then
                For i = .FixedRows To .Rows - 1
                    If Val(.TextMatrix(i, COL_申请序号)) = -1 And .TextMatrix(i, COL_类别) = "Z" And .TextMatrix(i, COL_操作类型) = "7" And Val(.TextMatrix(i, COL_诊疗项目ID)) = lngTmp Then
                        
                        If InStr("," & strTmp & ",", "," & Val(.TextMatrix(i, COL_执行科室ID)) & ",") = 0 Then
                            strTmp = strTmp & "," & Val(.TextMatrix(i, COL_执行科室ID))
                        End If
                        strRowNums = strRowNums & "," & i
                    End If
                Next
            Else
                For i = .FixedRows To .Rows - 1
                    If Val(.TextMatrix(i, COL_申请序号)) = lngNo Then
                        strTmp = strTmp & "," & Val(.TextMatrix(i, COL_执行科室ID))
                        strRowNums = strRowNums & "," & i
                    End If
                Next
            End If
            strRowNums = Mid(strRowNums, 2)
        End With
        
        With rsCard
            .AddNew
            !是否新增 = IIF(lngNo = -1, 0, 1)
            !是否保存 = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) = 0, 0, 1)
            !紧急医嘱 = IIF(chk紧急.value = 1 And chk紧急.Visible, 1, 0)
            !发送为不收费记帐单 = 0 '门诊才有
            !停止所有长嘱 = IIF(chkStop.value = 1 And chkStop.Visible, 1, 0)
            !生效时间 = msk开始时间.Text
            !医生嘱托 = cbo医生嘱托.Text
            !执行科室ID = Val(vsAdvice.TextMatrix(lngRow, COL_执行科室ID)) '
            !会诊科室IDs = Mid(strTmp, 2)
            .Update
            .MoveFirst
        End With
    End If
    
    lng医嘱序号 = GetCurRow序号(lngRow) - 1
    
    blnOK = frmApplyConsultation.ShowMe(Me, lngAdviceID, lngApplyNo, intTmp, 1, mlng病人ID, mlng主页ID, mlng病人科室id, lng开嘱科室ID, _
            mlng病人病区ID, mintPState, datTurn, mclsMipModule, lng项目id, rsCard, mlng前提ID, CByte(mint婴儿))
 
    If Not blnOK Then
        Exit Function
    End If
    mblnOK = True
    Apply会诊 = blnOK
    strDelIDsTmp = mstrDelIDs
    If lngNo <> 0 Then
        Call Delete检查手术输血(lngRow, True, lngTmpRow)
        lngRow = lngTmpRow
    End If
    mstrDelIDs = strDelIDsTmp
    
    strSQL = "Select a.Id,a.相关id,Nvl(a.婴儿,0) As 婴儿,a.序号,a.医嘱期效,a.医嘱状态,a.诊疗类别,a.诊疗项目id,b.名称,a.标本部位,a.检查方法,a.执行标记,a.收费细目id," & vbNewLine & _
        "a.开始执行时间,a.医嘱内容, a.医生嘱托,a.超量说明,a.总给予量,b.计算单位,a.执行频次,a.频率次数,a.频率间隔,a.间隔单位,b.计算方式,b.执行频率,b.操作类型,b.单独应用, " & vbNewLine & _
        "b.执行分类,a.计价特性,a.执行时间方案,a.执行性质,a.执行科室id,a.开嘱科室id,a.开嘱医生,a.开嘱时间,a.紧急标志,a.审查结果," & vbNewLine & _
        "a.摘要,a.零费记帐,a.用药目的,a.用药理由, a.审核状态,a.组合项目id,b.撤档时间,a.申请序号" & vbNewLine & _
        "From 病人医嘱记录 A, 诊疗项目目录 B" & vbNewLine & _
        "where a.诊疗项目id = b.Id and a.申请序号=[1] Order By 婴儿,序号"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lngApplyNo)
    
    lngNoTmp = lngApplyNo
    
    vsAdvice.Redraw = flexRDNone
    mblnRowChange = False
    
    With vsAdvice
        For j = 1 To rsTmp.RecordCount
            If j <> rsTmp.RecordCount Then
                .AddItem "", lngRow
                i = lngRow
                lngRow = lngRow + 1
            Else
                i = lngRow
            End If
            
            If Val(rsTmp!相关ID & "") = 0 Then
                .RowHidden(i) = False
                lngPos = i
            Else
                .RowHidden(i) = True
            End If
            
            If j = 1 Then
                .TextMatrix(i, COL_序号) = GetCurRow序号(lngRow, lngNoTmp)
            Else
                .TextMatrix(i, COL_序号) = Val(.TextMatrix(i - 1, COL_序号)) + 1
            End If
            .TextMatrix(i, COL_EDIT) = 3
            
            .RowData(i) = CLng(rsTmp!ID)
            .TextMatrix(i, COL_相关ID) = NVL(rsTmp!相关ID)
            .TextMatrix(i, COL_婴儿) = NVL(rsTmp!婴儿, 0)
            .TextMatrix(i, COL_期效) = "临嘱"
            .TextMatrix(i, COL_状态) = NVL(rsTmp!医嘱状态, 0)
            .TextMatrix(i, COL_类别) = rsTmp!诊疗类别
            .TextMatrix(i, COL_诊疗项目ID) = rsTmp!诊疗项目ID
            .TextMatrix(i, COL_名称) = rsTmp!名称
            .TextMatrix(i, COL_标本部位) = NVL(rsTmp!标本部位)
            .TextMatrix(i, COL_检查方法) = NVL(rsTmp!检查方法)
            .TextMatrix(i, COL_执行标记) = NVL(rsTmp!执行标记, 0)
            .TextMatrix(i, COL_收费细目ID) = NVL(rsTmp!收费细目ID)
            .TextMatrix(i, col_医嘱内容) = NVL(rsTmp!医嘱内容)
            .TextMatrix(i, COL_医生嘱托) = NVL(rsTmp!医生嘱托)
            .Cell(flexcpData, i, COL_医生嘱托) = CStr(NVL(rsTmp!摘要))
            .TextMatrix(i, COL_计价性质) = NVL(rsTmp!计价特性, 0)
            .TextMatrix(i, COL_计算方式) = NVL(rsTmp!计算方式, 0)
            .TextMatrix(i, COL_频率性质) = NVL(rsTmp!执行频率, 0)
            .TextMatrix(i, COL_操作类型) = NVL(rsTmp!操作类型)
            .TextMatrix(i, COL_单独应用) = NVL(rsTmp!单独应用)
            .TextMatrix(i, COL_执行分类) = NVL(rsTmp!执行分类, 0)
            .TextMatrix(i, COL_审核状态) = Val("" & rsTmp!审核状态)
            .TextMatrix(i, COL_用药目的) = "" & rsTmp!用药目的
            .TextMatrix(i, COL_用药理由) = "" & rsTmp!用药理由
            .TextMatrix(i, COL_组合项目ID) = "" & rsTmp!组合项目ID
            If Format(NVL(rsTmp!撤档时间, "3000/1/1"), "yyyy-MM-dd") <> "3000-01-01" Then
                .TextMatrix(i, COL_是否停用) = 1
            End If
            .TextMatrix(i, COL_开始时间) = Format(rsTmp!开始执行时间, "yyyy-MM-dd HH:mm")
            .Cell(flexcpData, i, COL_开始时间) = Format(rsTmp!开始执行时间, "yyyy-MM-dd HH:mm")

            .TextMatrix(i, COL_频率) = NVL(rsTmp!执行频次)
            .TextMatrix(i, COL_频率次数) = NVL(rsTmp!频率次数)
            .TextMatrix(i, COL_频率间隔) = NVL(rsTmp!频率间隔)
            .TextMatrix(i, COL_间隔单位) = NVL(rsTmp!间隔单位)
            .TextMatrix(i, COL_执行时间) = NVL(rsTmp!执行时间方案)
            .TextMatrix(i, COL_执行科室ID) = NVL(rsTmp!执行科室ID)
            .TextMatrix(i, COL_执行性质) = NVL(rsTmp!执行性质, 0)
            .TextMatrix(i, COL_申请序号) = rsTmp!申请序号 & ""
            If Not IsNull(rsTmp!总给予量) Then .TextMatrix(i, COL_总量) = rsTmp!总给予量
            .TextMatrix(i, COL_总量单位) = NVL(rsTmp!计算单位)
            .TextMatrix(i, COL_超量说明) = rsTmp!超量说明 & ""
            .TextMatrix(i, COL_开嘱科室ID) = rsTmp!开嘱科室id
            .TextMatrix(i, COL_开嘱医生) = rsTmp!开嘱医生
            .TextMatrix(i, COL_开嘱时间) = Format(rsTmp!开嘱时间, "yyyy-MM-dd HH:mm")
            .Cell(flexcpData, i, COL_开嘱时间) = Format(rsTmp!开嘱时间, "yyyy-MM-dd HH:mm")
            .TextMatrix(i, COL_标志) = NVL(rsTmp!紧急标志, 0)
            Call SetRow标志图标(i, 1)
            rsTmp.MoveNext
        Next
        .Row = lngPos
        
        Call AdviceSet医嘱序号(lngRow + 1, rsTmp.RecordCount)
         
    End With
    mblnRowChange = True
    vsAdvice.Redraw = flexRDDirect
  
    mblnNoSave = True
    Call vsAdvice_AfterRowColChange(0, 0, vsAdvice.Row, col_医嘱内容)
    Exit Function
errH:
    If blnTrans Then gcnOracle.RollbackTrans
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function GetInputRow(ByVal lngRow As Long) As Long
'功能：医嘱输入时的当前行
    Dim i As Long
    
    With vsAdvice
        '修改已有项目时,先删除当前医嘱的内容
        '---------------------------------------------------------------------------------------------------------------
        If .RowData(lngRow) <> 0 Then
            If InStr(",5,6,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '一并给药的情况已经在前面判断。
                '单个成药删除给药途径行,并清除当前行
                i = .FindRow(CLng(.TextMatrix(lngRow, COL_相关ID)), lngRow + 1)
                Call DeleteRow(i)
                Call DeleteRow(lngRow, True)
            ElseIf InStr(",D,F,K,", .TextMatrix(lngRow, COL_类别)) > 0 Then
                '检查组合项目，手术项目，输血医嘱
                '删除部位行，或手术附加行(附加手术,麻醉项目)，或输血途径
                Call Delete检查手术输血(lngRow)
                '清除当前行
                Call DeleteRow(lngRow, True)
            ElseIf RowIn配方行(lngRow) Then
                '中药配方：顺序(序号)要求必须严格控制
                '删除组成味药及煎法行:删除之后重新定位的当前行
                lngRow = Delete中药配方(lngRow)
                '清除当前行(中药用法行)
                Call DeleteRow(lngRow, True)
            ElseIf RowIn检验行(lngRow) Then
                '删除检验项目行:删除之后重新定位的当前行
                lngRow = Delete检验组合(lngRow)
                '清除当前行(采集方法行)
                Call DeleteRow(lngRow, True)
            Else
                '其它项目直接清除当前行内容
                Call DeleteRow(lngRow, True)
            End If
        End If
    End With
    GetInputRow = lngRow
End Function

Private Function CheckApply() As Boolean
'功能：判断申请单的填写情况
    Dim i As Long
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If Not .RowHidden(i) Then
                If Val(.TextMatrix(i, COL_申请序号)) < 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                    .Row = i
                    Call cmdExt_Click
                End If
            End If
        Next
        For i = .FixedRows To .Rows - 1
            If Not .RowHidden(i) Then
                If Val(.TextMatrix(i, COL_申请序号)) < 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                    Exit Function
                End If
            End If
        Next
    End With
    CheckApply = True
End Function

Private Sub SendMsg()
'功能：发送消息
    Dim i As Long
    
    Dim lngRow新开 As Long
    Dim lngRow审核 As Long
    Dim lngRow手术 As Long
    Dim lngRow抗药 As Long
    Dim lngRow输血 As Long
    Dim lngMsgRow As Long
    Dim lngTmp As Long
    
    Dim int新开急 As Integer
    Dim int审核急 As Integer
    Dim int紧急 As Integer
     
    Dim blnDo As Boolean
    
    Dim str类别 As String
    Dim strSQL As String
    Dim strWhere As String
    Dim rsTmp As ADODB.Recordset
    Dim rsAdviceTmp As ADODB.Recordset
    Dim str审核状态 As String
    
    On Error GoTo errH
    
    Set rsAdviceTmp = New ADODB.Recordset
    
    rsAdviceTmp.Fields.Append "行号", adBigInt
    rsAdviceTmp.Fields.Append "紧急", adBigInt
    rsAdviceTmp.Fields.Append "状态", adBigInt '1－新增，2－修改
    rsAdviceTmp.Fields.Append "开嘱医生", adVarChar, 500
    rsAdviceTmp.Fields.Append "类别", adVarChar, 10
    rsAdviceTmp.Fields.Append "操作类型", adBigInt
    rsAdviceTmp.Fields.Append "审核状态", adBigInt
    rsAdviceTmp.Fields.Append "执业医师", adBigInt
    rsAdviceTmp.Fields.Append "期效", adVarChar, 20
    
    rsAdviceTmp.CursorLocation = adUseClient
    rsAdviceTmp.LockType = adLockOptimistic
    rsAdviceTmp.CursorType = adOpenStatic
    rsAdviceTmp.Open

    '医嘱审核状态，参照医嘱校对
    If gblnKSSStrict Or gbln手术分级管理 Or gbln输血分级管理 Or gbln血库系统 Then
        str审核状态 = "1,3,7" & IIF(gbln血库系统 = True, "", ",4,5")
    End If
    
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            '需要的字段，行号、紧急、开嘱医生、类别、操作类型、审核状态、执业医师
            '所有医嘱记录，状态为修改了内容和新增的
            '默认实习生不能开 手术、输血、抗菌药医嘱
            '消息发送时要考虑暂存医嘱提交的情况既 Val(.TextMatrix(i, COL_状态)) = -1
            If Val(.TextMatrix(i, COL_状态)) = -1 Or (InStr(",1,2,", Val(.TextMatrix(i, COL_EDIT))) > 0 And _
                Val(.TextMatrix(i, COL_相关ID)) = 0 And .RowData(i) <> 0 And _
                (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2))) Then
                
                If InStr(.TextMatrix(i, COL_开嘱医生), "/") > 0 Then
                     lngTmp = 1
                Else
                    '是否具有"执业医师"的资格
                    If HaveAuditPriv(.TextMatrix(i, COL_开嘱医生)) Then
                        lngTmp = 1
                    Else
                        lngTmp = 0
                    End If
                End If
                
                rsAdviceTmp.AddNew
                rsAdviceTmp!行号 = i
                rsAdviceTmp!紧急 = IIF(1 = Val(.TextMatrix(i, COL_标志)), 1, 0)
                rsAdviceTmp!状态 = Val(.TextMatrix(i, COL_EDIT))
                rsAdviceTmp!开嘱医生 = .TextMatrix(i, COL_开嘱医生)
                rsAdviceTmp!类别 = .TextMatrix(i, COL_类别)
                rsAdviceTmp!操作类型 = Val(.TextMatrix(i, COL_操作类型))
                rsAdviceTmp!审核状态 = Val(.TextMatrix(i, COL_审核状态))
                rsAdviceTmp!期效 = .TextMatrix(i, COL_期效)
                rsAdviceTmp!执业医师 = lngTmp
                rsAdviceTmp.Update
            End If
        Next
    End With
    
    '审核实习生医嘱
    rsAdviceTmp.Filter = "执业医师=0"
    If Not rsAdviceTmp.EOF Then
        lngRow审核 = rsAdviceTmp!行号
    End If
    
    rsAdviceTmp.Filter = "执业医师=0 and 紧急=1"
    If Not rsAdviceTmp.EOF Then
        lngRow审核 = rsAdviceTmp!行号
        int审核急 = 1
    End If
     
    rsAdviceTmp.Filter = "执业医师=1 and 审核状态=0"
    If Not rsAdviceTmp.EOF Then
        lngRow新开 = rsAdviceTmp!行号
        For i = 1 To rsAdviceTmp.RecordCount
            If rsAdviceTmp!紧急 = 1 Then
                lngRow新开 = rsAdviceTmp!行号
                int新开急 = 1
                Exit For
            End If
            rsAdviceTmp.MoveNext
        Next
    End If
    
    rsAdviceTmp.Filter = "执业医师=1 and 审核状态=1 and 期效='长嘱' and 紧急=1"
    If Not rsAdviceTmp.EOF Then
        lngRow新开 = rsAdviceTmp!行号
        int新开急 = 1
    End If
    
    '审核手术医嘱
    rsAdviceTmp.Filter = "审核状态=1 and 类别='F'"
    If Not rsAdviceTmp.EOF Then lngRow手术 = rsAdviceTmp!行号
    
    '审核输血医嘱
    rsAdviceTmp.Filter = "审核状态=1 and 类别='K'"
    If Not rsAdviceTmp.EOF Then lngRow输血 = rsAdviceTmp!行号

    '输血医嘱特殊判断血库流特殊化,产生医嘱新开提醒
    If str审核状态 <> "" Then
        rsAdviceTmp.Filter = "类别='K'"
        If Not rsAdviceTmp.EOF Then
            For i = 1 To rsAdviceTmp.RecordCount
                If 0 = InStr("," & str审核状态 & ",", "," & rsAdviceTmp!审核状态 & ",") Or 0 = Val(rsAdviceTmp!审核状态 & "") Then
                    lngRow新开 = rsAdviceTmp!行号
                    If Val(rsAdviceTmp!紧急 & "") = 1 Then
                        int新开急 = 1
                    End If
                End If
                rsAdviceTmp.MoveNext
            Next
        End If
    End If
    
    '审核抗药医嘱
    rsAdviceTmp.Filter = "审核状态=1 and 类别='E' and 操作类型=2"
    If Not rsAdviceTmp.EOF Then lngRow抗药 = rsAdviceTmp!行号
    
    '消息发送
    With vsAdvice
        'ZLHIS_CIS_001－新开患者医嘱
        If lngRow新开 <> 0 Then
            lngMsgRow = lngRow新开
            int紧急 = int新开急
            
            str类别 = IIF(.TextMatrix(lngMsgRow, COL_类别) = "*", "", .TextMatrix(lngMsgRow, COL_类别))
            If .TextMatrix(lngMsgRow, COL_类别) = "E" Then
                If .TextMatrix(lngMsgRow, COL_操作类型) = "2" Then
                    str类别 = "5"
                ElseIf .TextMatrix(lngMsgRow, COL_操作类型) = "4" Then
                    str类别 = "7"
                ElseIf .TextMatrix(lngMsgRow, COL_操作类型) = "6" Then
                    str类别 = "C"
                End If
            End If
            
            Call ZLHIS_CIS_001(mclsMipModule, mlng病人ID, Trim(txtPati.Text), Trim(lblText(1).Caption), , IIF(mlng病人性质 = 1, 1, 2), mlng主页ID, mlng病人病区ID, , mlng病人科室id, "", , Trim(lblText(0).Caption), _
                .RowData(lngMsgRow), int紧急, IIF(.TextMatrix(lngMsgRow, COL_期效) = "长嘱", 0, 1), str类别, _
                .TextMatrix(lngMsgRow, COL_操作类型), .TextMatrix(lngMsgRow, COL_开嘱医生), .Cell(flexcpData, lngMsgRow, COL_开嘱时间), .TextMatrix(lngMsgRow, COL_开嘱科室ID), "", , "")
            
        End If
        
        'ZLHIS_CIS_026－新嘱审核提醒
        If lngRow审核 <> 0 Then
            lngMsgRow = lngRow审核
            int紧急 = int审核急
            
            str类别 = IIF(.TextMatrix(lngMsgRow, COL_类别) = "*", "", .TextMatrix(lngMsgRow, COL_类别))
            If .TextMatrix(lngMsgRow, COL_类别) = "E" Then
                If .TextMatrix(lngMsgRow, COL_操作类型) = "2" Then
                    str类别 = "5"
                ElseIf .TextMatrix(lngMsgRow, COL_操作类型) = "4" Then
                    str类别 = "7"
                ElseIf .TextMatrix(lngMsgRow, COL_操作类型) = "6" Then
                    str类别 = "C"
                End If
            End If
            
            Call ZLHIS_CIS_026(mclsMipModule, mlng病人ID, Trim(txtPati.Text), Trim(lblText(1).Caption), , IIF(mlng病人性质 = 1, 1, 2), mlng主页ID, mlng病人病区ID, , mlng病人科室id, "", , Trim(lblText(0).Caption), _
                .RowData(lngMsgRow), int紧急, IIF(.TextMatrix(lngMsgRow, COL_期效) = "长嘱", 0, 1), str类别, _
                .TextMatrix(lngMsgRow, COL_操作类型), .TextMatrix(lngMsgRow, COL_开嘱医生), .Cell(flexcpData, lngMsgRow, COL_开嘱时间), .TextMatrix(lngMsgRow, COL_开嘱科室ID), "", , "")
        End If
        
        'ZLHIS_CIS_028－手术审核提醒
        If lngRow手术 <> 0 Then
            lngMsgRow = lngRow手术
            Call ZLHIS_CIS_Audit("ZLHIS_CIS_028", mclsMipModule, mlng病人ID, Trim(txtPati.Text), Trim(lblText(1).Caption), , IIF(mlng病人性质 = 1, 1, 2), mlng主页ID, mlng病人病区ID, , mlng病人科室id, "", , Trim(lblText(0).Caption), _
                .RowData(lngMsgRow), .TextMatrix(lngMsgRow, COL_开嘱医生), .Cell(flexcpData, lngMsgRow, COL_开嘱时间), .TextMatrix(lngMsgRow, COL_开嘱科室ID), "", , "")
        End If
        
        'ZLHIS_CIS_029-抗菌药物审核提醒
        If lngRow抗药 <> 0 Then
            lngMsgRow = lngRow抗药
            Call ZLHIS_CIS_Audit("ZLHIS_CIS_029", mclsMipModule, mlng病人ID, Trim(txtPati.Text), Trim(lblText(1).Caption), , IIF(mlng病人性质 = 1, 1, 2), mlng主页ID, mlng病人病区ID, , mlng病人科室id, "", , Trim(lblText(0).Caption), _
                .RowData(lngMsgRow), .TextMatrix(lngMsgRow, COL_开嘱医生), .Cell(flexcpData, lngMsgRow, COL_开嘱时间), .TextMatrix(lngMsgRow, COL_开嘱科室ID), "", , "")
        End If
        
        'ZLHIS_CIS_030-输血审核提醒
        If lngRow输血 <> 0 Then
            lngMsgRow = lngRow输血
            Call ZLHIS_CIS_Audit("ZLHIS_CIS_030", mclsMipModule, mlng病人ID, Trim(txtPati.Text), Trim(lblText(1).Caption), , IIF(mlng病人性质 = 1, 1, 2), mlng主页ID, mlng病人病区ID, , mlng病人科室id, "", , Trim(lblText(0).Caption), _
                .RowData(lngMsgRow), .TextMatrix(lngMsgRow, COL_开嘱医生), .Cell(flexcpData, lngMsgRow, COL_开嘱时间), .TextMatrix(lngMsgRow, COL_开嘱科室ID), "", , "")
        End If
        
        '紧急输血医嘱
        lngRow输血 = 0
        rsAdviceTmp.Filter = "审核状态=4 and 类别='K'"
        If Not rsAdviceTmp.EOF Then lngRow输血 = rsAdviceTmp!行号
        If lngRow输血 <> 0 Then
            lngMsgRow = lngRow输血
            If Not (mclsMipModule Is Nothing) Then
                If mclsMipModule.IsConnect Then
                    Call ZLHIS_CIS_031(mclsMipModule, mlng病人ID, Trim(txtPati.Text), Trim(lblText(1).Caption), , IIF(mlng病人性质 = 1, 1, 2), mlng主页ID, mlng病人病区ID, , mlng病人科室id, "", , Trim(lblText(0).Caption), _
                        .RowData(lngMsgRow), .TextMatrix(lngMsgRow, COL_开嘱医生), .Cell(flexcpData, lngMsgRow, COL_开嘱时间), .TextMatrix(lngMsgRow, COL_开嘱科室ID), "", , "")
                End If
            End If
        End If
    End With
    If mstrDelIDs <> "" And lngRow新开 = 0 Then
        '如果有删除的医嘱要同步一下新开消息
        If gblnKSSStrict Or gbln手术分级管理 Or gbln输血分级管理 Or gbln血库系统 Then
            strWhere = strWhere & " And (Nvl(A.审核状态,0) Not in(1,3,7" & IIF(gbln血库系统 = True, "", ",4,5") & ") or a.医嘱期效=0 and a.审核状态=1 and a.紧急标志=1 and (instr(',5,6,',A.诊疗类别)>0 or A.诊疗类别='E' and B.操作类型='2'))"
        End If
        strSQL = "select 1 from 病人医嘱记录 a,诊疗项目目录 b where a.诊疗项目id=b.id(+) and A.医嘱状态=1 and a.病人id=[1] and a.主页id=[2]" & strWhere & _
                " And Exists ( Select M.姓名 From 人员表 M,执业类别 N" & _
                " Where M.姓名=Decode(A.审核标记,1,Substr(A.开嘱医生,1,Instr(A.开嘱医生,'/')-1),Substr(A.开嘱医生,Instr(A.开嘱医生,'/')+1))" & _
                " And M.执业类别=N.编码 And N.分类 IN('执业医师','执业助理医师')) And Nvl(A.执行标记,0)<>-1 And A.病人来源<>3 and Rownum<2"
    
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
        If rsTmp.EOF Then '无数据则将消息设置为已阅
             strSQL = "Zl_业务消息清单_Read(" & mlng病人ID & "," & mlng主页ID & ",'ZLHIS_CIS_001',3,'" & UserInfo.姓名 & "'," & mlng病人科室id & ")"
             Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
        End If
    End If
    Exit Sub
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub tbcSub_SelectedChanged(ByVal Item As XtremeSuiteControls.ITabControlItem)
    If mblnNoRefresh Then Exit Sub
    If mblnNoSave Then
        mblnNoRefresh = True
        tbcSub.Item(0).Selected = True
        MsgBox "当前医嘱内容编辑后尚未保存，请先保存或暂存。", vbInformation, gstrSysName
        mblnNoRefresh = False
        Exit Sub
    End If
    Call SubWinRefreshData(Item)
End Sub

Private Sub SubWinRefreshData(ByVal objItem As TabControlItem)
'功能：刷新数据
    If objItem.Tag = "医嘱编辑" Then
        Call ReLoadAdvice(vsAdvice.RowData(vsAdvice.Row))
    Else
        If objItem.Tag <> "" Then
            If Not gobjPlugIn Is Nothing Then
                On Error Resume Next
                Call gobjPlugIn.RefreshForm(glngSys, p住院医嘱下达, mcolSubForm("_" & objItem.Tag), objItem.Tag, mlng病人ID, "", mlng主页ID, False, _
                    0, 0, mlng病人病区ID, mlng病人科室id, , mintPState, , mlng路径状态)
                Call zlPlugInErrH(err, "RefreshForm")
                err.Clear: On Error GoTo 0
            End If
        End If
    End If
    Call SetFontSize(mbytSize)
End Sub

Private Sub SetTag一并给药(ByVal lngRow As Long)
'功能：对于药品医嘱添加标志
'参数：lngRow  一组药医嘱中的任意一行药品行行号
    Dim lngBg As Long, lngEd As Long
    Dim i As Long
     
    Call GetRowScope(lngRow, lngBg, lngEd)
    lngEd = lngEd - 1
    With vsAdvice
        If lngBg = lngEd Then
            .TextMatrix(lngBg, COL_并) = ""
        Else
            For i = lngBg To lngEd
                If i = lngBg Then
                    .TextMatrix(i, COL_并) = "┏"
                ElseIf i = lngEd Then
                    .TextMatrix(i, COL_并) = "┗"
                Else
                    .TextMatrix(i, COL_并) = "┃"
                End If
            Next
        End If
    End With
End Sub

Private Sub Delete检验申请单(ByVal lngRow As Long, Optional ByVal bln申请序号 As Boolean, Optional ByRef lngTmpRow As Long)
'功能：1.删除检查组合项目的部位行
'      2.删除手术项目的附加手术行及麻醉项目行
'      3.删除输血项目的输血途径行
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim lngNo As Long
    Dim strRows As String
    Dim varArr As Variant
    Dim lngTmp As Long
    On Error GoTo errH
    With vsAdvice
        If bln申请序号 Then
            lngNo = Val(.TextMatrix(lngRow, COL_申请序号))
        End If
        If lngNo = 0 Then
            lngTmpRow = Delete检验组合(lngRow)
        Else
            lngTmp = -1
            For i = .FixedRows To .Rows - 1
                If Val(.TextMatrix(i, COL_状态)) < 2 Then
                    If lngNo = Val(.TextMatrix(i, COL_申请序号)) Then
                        strRows = i & IIF(strRows = "", "", "," & strRows)
                    End If
                End If
                If i > lngRow Then
                    If lngNo <> Val(.TextMatrix(i, COL_申请序号)) Then
                        If lngTmp = -1 Then
                            lngTmp = vsAdvice.RowData(i)
                        End If
                    End If
                End If
            Next
            varArr = Split(strRows, ",")
            For i = 0 To UBound(varArr)
                Call DeleteRow(Val(varArr(i)))
            Next
            
            If lngTmp = -1 Then
                '先删除中间间隔的空行
                mblnRowChange = False
                For i = .Rows - 1 To .FixedRows Step -1
                    If .RowData(i) = 0 Then .RemoveItem i
                Next
                mblnRowChange = True
                .AddItem "", .Rows
                .Row = .Rows - 1
                .Col = .FixedCols
                lngTmpRow = .Row
            Else
                For i = .FixedRows To .Rows - 1
                    If lngTmp = Val(vsAdvice.RowData(i)) Then
                        lngTmp = i
                        Exit For
                    End If
                Next
                i = lngTmp
                If i <> -1 Then
                    .AddItem "", i
                    .Row = i
                    lngTmpRow = i
                Else
                    '先删除中间间隔的空行
                    mblnRowChange = False
                    For i = .Rows - 1 To .FixedRows Step -1
                        If .RowData(i) = 0 Then .RemoveItem i
                    Next
                    mblnRowChange = True
                    .AddItem "", .Rows
                    .Row = .Rows - 1
                    .Col = .FixedCols
                    lngTmpRow = .Row
                End If
            End If
        End If
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNew检验申请(ByVal intType As Integer, ByVal str项目编码 As String, ByRef rsCard As ADODB.Recordset) As Boolean
'功能：调用申请单
'参数：intType 0-新增,1-修改
    Dim lng开单科室ID As Long
    Dim strSQL As String
    Dim rsPati As ADODB.Recordset
    Dim strResult As String
    Dim strDept As String
    Dim lng申请序号 As String
    Dim strDiag As String
    Dim blnCancel As Boolean
    Dim strErr As String
    Dim strLIS As String

    On Error GoTo errH
    
    '执行部门(号别科室)即病人科室
    strSQL = "Select A.住院号, A.当前床号, A.出生日期, Nvl(B.姓名, A.姓名) 姓名, Nvl(B.性别, A.性别) 性别, Nvl(B.年龄, A.年龄) 年龄, A.门诊号, A.健康号" & vbNewLine & _
            "From 病人信息 A, 病案主页 B" & vbNewLine & _
            "Where A.病人id = B.病人id And A.病人id = [1] And B.主页id = [2]"
     
    Set rsPati = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
    
    If rsPati.RecordCount = 0 Then
        MsgBox "未能正确读取病人信息！", vbInformation, gstrSysName
        Exit Function
    End If
    
    lng开单科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id)
    
    strDept = Sys.RowValue("部门表", lng开单科室ID, "名称")
    
    strDept = Sys.RowValue("部门表", lng开单科室ID, "名称")
    Call InitObjLis(p住院医嘱下达)
    If gobjLIS Is Nothing Then Exit Function
    On Error GoTo errH
    If Not rsCard Is Nothing Then
        If Not rsCard.EOF Then
            strLIS = rsCard!申请信息 & ""
            strDiag = rsCard!临床诊断IDs & ""
        End If
    End If
    
    strResult = gobjLIS.ShowLisApplicationForm(Me, 0, mlng病人ID, CByte(mint婴儿), mlng主页ID, rsPati!姓名, "" & rsPati!性别, "" & rsPati!年龄, IIF(mlng病人性质 = 1, 1, 2), _
        Val("" & rsPati!门诊号), Val("" & rsPati!住院号), Val("" & rsPati!健康号), strDiag, UserInfo.姓名, UserInfo.部门ID, UserInfo.部门名, lng开单科室ID, strDept, blnCancel, strErr, strLIS, str项目编码)
    
    If strErr <> "" Then
        MsgBox "检验接口内部错误：" & strErr, vbInformation, gstrSysName
        Exit Function
    ElseIf blnCancel Then
        Exit Function
    ElseIf strResult = "" Then
        Exit Function
    End If
    
    Call InitCardRsLIS(rsCard)
    rsCard.AddNew Array("临床诊断IDs", "申请信息"), Array(strDiag, strResult)
    ApplyNew检验申请 = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet检验申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset) As Long
'功能：把检查申请单数据加载到表格中
    Dim i As Long, j As Long
    Dim varTmp As Variant
    Dim lng申请序号 As Long
    Dim strLIS As String
    Dim str诊断 As String
    Dim str附项 As String
    Dim vCurDate As Date
    Dim rsLISInfo As ADODB.Recordset
    Dim rsTmp As ADODB.Recordset
    Dim lng检验项目ID As Long
    Dim lng申请组号 As Long '一组一个申请序号,可以一次申请多个申请,如果是耐受试验,一个项目就是一个申请序号
    Dim lng数量 As Long
      
    On Error GoTo errH
    
    mblnRowChange = False
    cbo期效.ListIndex = 1
    lng申请组号 = -1
    strLIS = rsCard!申请信息 & ""
    str诊断 = rsCard!临床诊断IDs & ""
    If str诊断 <> "" Then
        str诊断 = GetDiag诊断描述(str诊断)
        If str诊断 <> "" Then
            str诊断 = "申请单诊断<Split2>0<Split2><Split2>" & str诊断
        End If
    End If
    
    vCurDate = zlDatabase.Currentdate()
    '在该方法中对rsLISInfo, rsTmp赋值
    Call LisInfoTrans(strLIS, rsLISInfo, rsTmp)
    For i = 1 To rsLISInfo.RecordCount
        If i <> 1 Then
            vsAdvice.AddItem "", lngRow + 1
            lngRow = lngRow + 1
        End If
        If lng申请组号 <> Val(rsLISInfo!组号 & "") Then
            lng申请组号 = Val(rsLISInfo!组号 & "")
            lng申请序号 = Get申请序号
        End If
    
        Call AdviceSet检验组合(lngRow, Val(rsLISInfo!采集项目ID & ""), rsLISInfo!检验项目ID & ";" & rsLISInfo!标本, , , True)
        lng检验项目ID = Val(rsLISInfo!检验项目ID & "")
        lng数量 = 1
        lngRow = lngRow + lng数量
        With vsAdvice
            For j = lngRow - lng数量 To lngRow
                .TextMatrix(j, COL_标志) = Val(rsLISInfo!紧急 & "")
                .TextMatrix(j, COL_开始时间) = Format(CDate(rsLISInfo!开始执行时间 & ""), "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, j, COL_开始时间) = .TextMatrix(j, COL_开始时间)
                    
                .TextMatrix(lngRow, COL_执行科室ID) = Val(rsLISInfo!执行科室ID & "")   '检验执行科室ID,采集执行科室ID后续会重新赋值
                .TextMatrix(j, COL_申请序号) = lng申请序号
                .TextMatrix(j, COL_皮试结果) = ""
                    .Cell(flexcpData, j, COL_皮试结果) = rsLISInfo!时间ID & "" '耐受试验时间ID
                '补录标识
                If IsDate(.Cell(flexcpData, j, COL_开始时间)) Then
                    If mintPState = ps最近转出 Or mintPState = ps预出 Or mintPState = ps出院 Then
                        .TextMatrix(j, COL_标志) = 2
                    ElseIf DateDiff("n", CDate(.Cell(flexcpData, j, COL_开始时间)), vCurDate) > gint补录间隔 Then
                        .TextMatrix(j, COL_标志) = 2
                    Else
                        .TextMatrix(j, COL_标志) = chk紧急.value
                    End If
                End If
                
            Next
            .TextMatrix(lngRow, COL_执行科室ID) = Val(rsLISInfo!采集科室ID & "") '更新采集执行科室ID
            .TextMatrix(lngRow, COL_医生嘱托) = rsLISInfo!嘱托 & ""
            .TextMatrix(lngRow, COL_诊疗项目ID) = Val(rsLISInfo!采集项目ID & "")
            str附项 = rsLISInfo!附项 & ""
            If str附项 <> "" And str诊断 <> "" Then
                str附项 = str诊断 & "<Split1>" & str附项
            ElseIf str附项 = "" And str诊断 <> "" Then
                str附项 = str诊断
            End If
            If str附项 <> "" Then
                .TextMatrix(lngRow, COL_附项) = str附项
                .Cell(flexcpData, lngRow, COL_附项) = 1
            End If
            Set .Cell(flexcpData, lngRow, COL_申请序号) = zlDatabase.CopyNewRec(rsCard)
            .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow) & rsLISInfo!时间内容 & ""
            
            rsTmp.Filter = "ID=" & lng检验项目ID
            .TextMatrix(lngRow, COL_执行科室) = rsTmp!名称 & ""
            Call .AutoSize(col_医嘱内容)
        End With
        Call SetRow标志图标(lngRow, 0)
        If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
        
        rsLISInfo.MoveNext
    Next
    vsAdvice.Row = lngRow
    AdviceSet检验申请 = lngRow
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub GetData检验申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset)
'功能：从医嘱表格中获取数据生成对象只传新开状态的医嘱和未保存的医嘱数据
    Dim rsCardBak As ADODB.Recordset
    Dim rsTmp As ADODB.Recordset
    Dim blnTmp As Boolean
    Dim strSQL As String
    Dim str诊断 As String
    Dim str诊断IDs As String
    Dim strTmp As String
    Dim var1 As Variant
    Dim var2 As Variant
    Dim i As Long, j As Long
    Dim strLIS As String
    Dim strResult As String
    Dim lng申请序号 As Long
    Dim strAppend As String
    
    On Error GoTo errH
    With vsAdvice
    
        If TypeName(.Cell(flexcpData, lngRow, COL_申请序号)) = "Recordset" Then
            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_申请序号))
        Else
            Call InitCardRsLIS(rsCard)
            rsCard.AddNew
        End If
        If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            str诊断IDs = GetAdviceDiag(Val(.RowData(lngRow)), str诊断)
            rsCard!临床诊断IDs = str诊断IDs
        End If
     
        lng申请序号 = Val(.TextMatrix(lngRow, COL_申请序号))
        For i = .FixedRows To .Rows - 1
            '检验医嘱显示行是采集方式
            If Val(.TextMatrix(i, COL_申请序号)) = lng申请序号 And Not .RowHidden(i) Then
         
                lngRow = i
                '采诊科室id , 执行科室id, 申请时间1, 标本1, 附项, 嘱托, 是否急症, 采集id, 诊疗项目id1
                strLIS = .TextMatrix(lngRow, COL_执行科室ID) & "<Split A>" & .TextMatrix(lngRow - 1, COL_执行科室ID) & "<Split A>" & .TextMatrix(lngRow, COL_开始时间) & _
                      "<Split A>" & .TextMatrix(lngRow, COL_标本部位)
                strAppend = .TextMatrix(lngRow, COL_附项)
                If strAppend = "" And Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
                     strAppend = Get病人医嘱附件(.RowData(lngRow))
                End If
                strLIS = strLIS & "<Split A>" & strAppend & "<Split A>" & .TextMatrix(lngRow, COL_医生嘱托) & "<Split A>" & Val(.TextMatrix(lngRow, COL_标志)) & "<Split A>" & .TextMatrix(lngRow, COL_诊疗项目ID) & "<Split A>" & .TextMatrix(lngRow - 1, COL_诊疗项目ID)
                If strLIS <> "" Then
                    strResult = strLIS & IIF(strResult = "", "", "<Split B>" & strResult)
                End If
            End If
        Next
        rsCard!申请信息 = strResult
        rsCard.Update
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub GetData检查申请(ByVal lngRow As Long, ByRef objAppPages() As clsApplicationData)
'功能：从医嘱表格中获取数据生成对象只传新开状态的医嘱和未保存的医嘱数据
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim strAppend As String, strExtData As String
    Dim lng申请序号 As Long
    Dim lng相关ID As Long
    Dim i As Long, j As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim objTmp As clsApplicationData
    Dim varArr As Variant
    Dim strTmp As String
    Dim lngObjIndex As Long
 
    On Error GoTo errH
    With vsAdvice
        lngEnd = -1
        lngObjIndex = -1
        lng申请序号 = Val(.TextMatrix(lngRow, COL_申请序号))
        For i = .FixedRows To .Rows - 1
            If Val(.TextMatrix(i, COL_申请序号)) = lng申请序号 And i > lngEnd Then
                lng相关ID = Val(.RowData(i))
                lngBegin = i
                lngRow = i
                Set objTmp = New clsApplicationData
                objTmp.blnIsModify = True
                objTmp.blnAllowUpdate = True
                objTmp.blnIsAdditionalRec = False
                objTmp.lngProjectId = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
                objTmp.blnIsPriority = Val(.TextMatrix(lngRow, COL_标志)) = 1
                objTmp.strStartExeTime = .TextMatrix(lngRow, COL_开始时间)
                objTmp.lngExeRoomId = Val(.TextMatrix(lngRow, COL_执行科室ID))
                objTmp.strExeRoomName = Sys.RowValue("部门表", objTmp.lngExeRoomId, "名称")
                objTmp.lngExeRoomType = Val(.TextMatrix(lngRow, COL_执行性质))
                objTmp.strRequestTime = .TextMatrix(lngRow, COL_开嘱时间)
                objTmp.lngRequestRoomId = Val(.TextMatrix(lngRow, COL_开嘱科室ID))
                objTmp.strDiagnoseId = ""
                
                strTmp = objTmp.Get申请单信息(objTmp.lngProjectId, 2)
                If strTmp <> "" Then
                    objTmp.lngApplicationPageId = Val(Split(strTmp, "<Split>")(0))
                    objTmp.strApplicationPageName = Split(strTmp, "<Split>")(1)
                    objTmp.strRequestAffixCfg = objTmp.Get申请附项目配置(objTmp.lngApplicationPageId)
                End If
                
                strExtData = Get检查部位方法(lngRow)
                If InStr(strExtData, vbTab) > 0 Then
                    objTmp.strPartMethod = Split(strExtData, vbTab)(0)
                    objTmp.lngExeType = Val(Split(strExtData, vbTab)(1))
                End If
                
                strAppend = .TextMatrix(lngRow, COL_附项)
                If strAppend <> "" Then
                    varArr = Split(strAppend, "<Split1>")
                    strAppend = ""
                    For j = 0 To UBound(varArr)
                        strTmp = varArr(j)
                        If strTmp <> "" Then
                            strAppend = strAppend & "|" & Split(strTmp, "<Split2>")(0) & ":" & Split(strTmp, "<Split2>")(3)
                        End If
                    Next
                    objTmp.strRequestAffix = Mid(strAppend, 2)
                End If
                
                For j = i + 1 To .Rows - 1
                    If Val(.TextMatrix(j, COL_相关ID)) = lng相关ID Then
                        lngEnd = j
                    Else
                        Exit For
                    End If
                Next
                lngObjIndex = lngObjIndex + 1
                ReDim Preserve objAppPages(lngObjIndex)
                Set objAppPages(lngObjIndex) = objTmp
            End If
        Next
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNew检查申请(ByVal intType As Integer, ByVal str项目IDs As String, ByRef objAppPages() As clsApplicationData) As Boolean
'功能：调用申请单
'参数：intType 0-新增,1-修改
    Dim objPacspplication As New clsPacsApplication
    Dim lng项目id As Long
    Dim strSQL As String
    Dim lng开单科室ID As Long
    On Error GoTo errH
    lng项目id = Val(str项目IDs)
    '初始化检查申请单对象
    lng开单科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id)
    Call objPacspplication.InitComponents(lng开单科室ID, Me)
    ApplyNew检查申请 = objPacspplication.ShowApplicationForm(mlng病人ID, 2, 0, mlng主页ID, intType, objAppPages(), mint婴儿, , lng项目id)
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet检查申请(ByVal lngRow As Long, ByRef objAppPages() As clsApplicationData) As Long
'功能：把检查申请单数据加载到表格中
    Dim objTmp As clsApplicationData
    Dim i As Long, j As Long, k As Long
    Dim lngCnt As Long, lng申请序号 As Long, lngCurRow As Long
    Dim strSQL As String, strAppend As String
    Dim varTmp As Variant, strTmp As String
    Dim rsInput As ADODB.Recordset
    Dim rsAppend As ADODB.Recordset
    Dim lngBegin As Long, lngEnd As Long
        Dim str附项内容 As String
    
    On Error GoTo errH
    lng申请序号 = Get申请序号
    mblnRowChange = False
    cbo期效.ListIndex = 1
    For i = 0 To UBound(objAppPages)
        Set objTmp = objAppPages(i)
        strSQL = "Select a.名称,a.Id As 诊疗项目id, Null As 收费细目id,a.类别 As 类别ID From 诊疗项目目录 A where a.id=[1]"
        Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, objTmp.lngProjectId)
        strAppend = ""
        If objTmp.strRequestAffix <> "" Then
            strSQL = "Select C.项目,C.内容,C.要素ID,C.必填,d.中文名,decode(D.表示法,4,D.数值域,NULL) as 数值域" & _
                " From 病历单据应用 A,病历文件列表 B,病历单据附项 C,诊治所见项目 D" & _
                " Where A.诊疗项目ID=[1] And A.应用场合=[2]" & _
                " And A.病历文件ID=B.ID And B.种类=7 And B.ID=C.文件ID And c.要素id=d.id(+)" & _
                " Order by C.排列"
            Set rsAppend = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, objTmp.lngProjectId, 2)
            varTmp = Split(objTmp.strRequestAffix, "|")
            For j = 0 To UBound(varTmp)
                If InStr(varTmp(j), ":") > 0 Then
                    rsAppend.Filter = "项目='" & Split(varTmp(j), ":")(0) & "'"
                    If Not rsAppend.EOF Then
                        strSQL = varTmp(j)
                        str附项内容 = Replace(strSQL, Mid(strSQL, 1, InStr(strSQL, ":")), "")
                        strAppend = IIF(strAppend = "", "", strAppend & "<Split1>") & rsAppend!项目 & "<Split2>" & Val(rsAppend!必填 & "") & _
                            "<Split2>" & rsAppend!要素ID & "<Split2>" & str附项内容
                    End If
                End If
            Next
        End If
        If i <> 0 Then
            vsAdvice.AddItem "", lngEnd + 1
            lngRow = lngEnd + 1
        End If
        strTmp = objTmp.strPartMethod & vbTab & objTmp.lngExeType
        Call AdviceSet诊疗项目(rsInput, lngRow, 0, 0, strTmp, "")
        lngBegin = lngRow
        With vsAdvice
            For j = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(j, COL_相关ID)) = Val(.RowData(lngRow)) Then
                    lngEnd = j
                Else
                    Exit For
                End If
            Next
            If lngEnd < lngBegin Then lngEnd = lngBegin
            For j = lngBegin To lngEnd
                '更新一些项目
                .TextMatrix(j, COL_标志) = IIF(objTmp.blnIsPriority, 1, 0) '门诊无补录
                .TextMatrix(j, COL_开始时间) = Format(objTmp.strStartExeTime, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, j, COL_开始时间) = .TextMatrix(j, COL_开始时间)
                .TextMatrix(j, COL_执行科室ID) = IIF(objTmp.lngExeRoomId <= 0, 0, objTmp.lngExeRoomId)
                .TextMatrix(j, COL_执行性质) = objTmp.lngExeRoomType
                .TextMatrix(j, COL_开嘱时间) = Format(objTmp.strRequestTime, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, j, COL_开嘱时间) = .TextMatrix(j, COL_开嘱时间)
                .TextMatrix(j, COL_开嘱科室ID) = objTmp.lngRequestRoomId
                .TextMatrix(j, COL_申请序号) = lng申请序号
            Next
            '新增后关联诊断的标记处理
            '更新附件内容:以当前可见行为准
            If strAppend <> "" Then
                .TextMatrix(lngRow, COL_附项) = strAppend
                .Cell(flexcpData, lngRow, COL_附项) = 1 '表明需要重新写入(新增或修改)
                Call ReplaceAdviceAppend(lngRow) '缺省替换其他医嘱的申请附项
            End If
            .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
            .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称")
            '重新自动调整行高
            Call .AutoSize(col_医嘱内容)
            Call SetRow标志图标(lngRow, 0)
        End With
        If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
    Next
    vsAdvice.Row = lngRow
    AdviceSet检查申请 = lngRow
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub GetData输血申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset)
'功能：从医嘱表格中获取数据生成对象只传新开状态的医嘱和未保存的医嘱数据
    Dim rsCardBak As ADODB.Recordset
    Dim rsTmp As ADODB.Recordset
    Dim rsTmpOther As ADODB.Recordset
    Dim blnTmp As Boolean
    Dim lng医嘱ID As Long
    Dim strSQL As String
    Dim str诊断 As String
    Dim str诊断IDs As String
    Dim strTmp As String
    Dim var1 As Variant
    Dim var2 As Variant
    Dim i As Long, j As Long
    Dim str申请项目 As String, str输血目的 As String
    
    On Error GoTo errH
    With vsAdvice
        If TypeName(.Cell(flexcpData, lngRow, COL_申请序号)) = "Recordset" Then
            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_申请序号))
        Else
            Call InitCardRsBlood(rsCard)
            rsCard.AddNew
        End If
        If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            lng医嘱ID = Val(.RowData(lngRow))
            If gbln血库系统 Then
                strSQL = "Select 诊疗项目id, 申请量, 申请血型, 申请rh, 血液信息 From 输血申请项目 Where 医嘱id = [1]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "输血申请项目", lng医嘱ID)
                Do While Not rsTmp.EOF
                    str申请项目 = str申请项目 & ";" & rsTmp!诊疗项目ID & "," & rsTmp!申请量 & "," & rsTmp!申请血型 & "," & rsTmp!申请rh & IIF(rsTmp!血液信息 & "" <> "", "," & rsTmp!血液信息, "")
                rsTmp.MoveNext
                Loop
                If Left(str申请项目, 1) = ";" Then str申请项目 = Mid(str申请项目, 2)
                
                strSQL = "Select 是否待诊 as 待诊,输血类型,输血目的, 输血性质, 即往输血史, 既往输血反应史, 输血禁忌及过敏史, 孕产情况, 受血者属地, 是否签订同意书, 是否已评估, 输血血型 as 血型, RHD" & vbNewLine & _
                    " From 输血申请记录" & vbNewLine & _
                    " Where 医嘱id = [1]"
            Else
                strSQL = "Select 是否待诊 as 待诊, 输血性质, 即往输血史, 孕产情况, 受血者属地, 输血血型 as 血型, RHD" & vbNewLine & _
                    " From 输血申请记录" & vbNewLine & _
                    " Where 医嘱id = [1]"
            End If
            
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng医嘱ID)
            If Not rsTmp.EOF Then
                If Val(rsTmp!待诊 & "") = 0 Then
                   str诊断IDs = GetAdviceDiag(lng医嘱ID, str诊断)
                   '从附项中获取诊断如果附项中有以附项为准
                    strSQL = "select 内容 from 病人医嘱附件 where 医嘱ID=[1] and 项目='申请单诊断'"
                    Set rsTmpOther = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng医嘱ID)
                    If Not rsTmpOther.EOF Then str诊断 = rsTmpOther!内容 & ""
                End If
                rsCard!临床诊断IDs = str诊断IDs
                rsCard!临床诊断描述 = str诊断
                rsCard!血型 = Val(rsTmp!血型 & "")
                rsCard!RHD = Val(rsTmp!RHD & "")
                rsCard!待诊 = Val(rsTmp!待诊 & "")
                rsCard!输血性质 = Val(rsTmp!输血性质 & "")
                rsCard!即往输血史 = Val(rsTmp!即往输血史 & "")
                If gbln血库系统 = True Then
                    rsCard!既往输血反应史 = Val(rsTmp!既往输血反应史 & "")
                    rsCard!输血禁忌及过敏史 = Val(rsTmp!输血禁忌及过敏史 & "")
                    rsCard!输血类型 = rsTmp!输血类型 & ""
                    rsCard!输血目的 = rsTmp!输血目的 & ""
                    str输血目的 = rsTmp!输血目的 & ""
                    rsCard!是否签订同意书 = rsTmp!是否签订同意书
                    rsCard!是否已评估 = rsTmp!是否已评估
                End If
                rsCard!孕产情况 = Val(rsTmp!孕产情况 & "")
                rsCard!受血者属地 = Val(rsTmp!受血者属地 & "")
            End If
            var2 = Array()
            strSQL = "select 序号,检验项目ID,指标代码,指标中文名,指标英文名,指标结果,结果单位,结果标志,结果参考,取值序列,是否人工填写 from 输血检验结果 Where 医嘱ID=[1] order by 序号"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng医嘱ID)
            For i = 1 To rsTmp.RecordCount
                var1 = Array()
                For j = 0 To rsTmp.Fields.Count - 1
                    ReDim Preserve var1(j)
                    var1(j) = rsTmp.Fields(j).value & ""
                Next
                strTmp = Join(var1, "<SplitCol>")
                ReDim Preserve var2(UBound(var2) + 1)
                var2(UBound(var2)) = strTmp
                rsTmp.MoveNext
            Next
            rsCard!检查结果 = Join(var2, "<SplitRow>")
        End If
        
        rsCard!申请项目 = str申请项目
        If str输血目的 = "" Then rsCard!输血目的 = .TextMatrix(lngRow, COL_用药理由) '老的的输血目的存储在医嘱的用药理由里面
        rsCard!用血安排 = Val(.TextMatrix(lngRow, COL_标志))
        rsCard!预定输血日期 = .TextMatrix(lngRow, COL_输血时间)
        rsCard!输血项目ID = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
        rsCard!输血执行科室ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
        rsCard!预定输血量 = Val(.TextMatrix(lngRow, COL_总量))
        rsCard!输血途径项目ID = Val(.TextMatrix(lngRow + 1, COL_诊疗项目ID))
        rsCard!输血途径执行科室ID = Val(.TextMatrix(lngRow + 1, COL_执行科室ID))
        rsCard!备注 = .TextMatrix(lngRow, COL_医生嘱托)
        rsCard!输血申请日期 = .TextMatrix(lngRow, COL_开始时间)
        rsCard!申请科室id = .TextMatrix(lngRow, COL_开嘱科室ID)
        rsCard!滴速 = .TextMatrix(lngRow + 1, COL_医生嘱托)
        rsCard.Update
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNew输血申请(ByVal intType As Integer, ByVal str项目IDs As String, ByRef rsCard As ADODB.Recordset, Optional ByVal bln备血 As Boolean = True) As Boolean
'功能：调用申请单
'参数：intType 0-新增,1-修改
    Dim lng项目id As Long
    Dim lng开嘱科室ID As Long
    
    On Error GoTo errH
    lng项目id = Val(str项目IDs)
 
    '输血医嘱检查，必须中级及以上专业技术职务的医师才允许下达
    If gbln输血申请中级以上 Then
        If UserInfo.专业技术职务 <> "主治医师" And UserInfo.专业技术职务 <> "主任医师" And UserInfo.专业技术职务 <> "副主任医师" Then
            MsgBox "启用了输血分级管理后，输血医嘱只有中级及以上专业技术职务医师才能下达。", vbInformation, Me.Caption
            Exit Function
        End If
    End If
    
    lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 2)
    
    If Not rsCard Is Nothing Then
        If Not rsCard.EOF Then
            If Val(rsCard!申请科室id & "") <> 0 Then
                lng开嘱科室ID = Val(rsCard!申请科室id & "")
            End If
        End If
    End If
    
    If gbln血库系统 = True Then
        ApplyNew输血申请 = frmApplyBloodNew.ShowMe(Me, mlng病人ID, mlng主页ID, IIF(mlng病人性质 = 1, 1, 2), intType, 0, mlng病人科室id, _
             , lng开嘱科室ID, , , mrsDefine, , 0, "", lng项目id, rsCard, mint婴儿, 1, mlng前提ID, IIF(bln备血 = True, 0, 1))
    Else
        ApplyNew输血申请 = frmApplyBlood.ShowMe(Me, mlng病人ID, mlng主页ID, IIF(mlng病人性质 = 1, 1, 2), intType, 0, mlng病人科室id, _
             , lng开嘱科室ID, , , mrsDefine, , 0, "", lng项目id, rsCard, mint婴儿, 1, mlng前提ID)
    End If
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet输血申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset) As Long
'功能：把检查申请单数据加载到表格中
    Dim objTmp As clsApplicationData
    Dim i As Long, j As Long, k As Long
    Dim lngCnt As Long, lng申请序号 As Long, lngCurRow As Long
    Dim strSQL As String, strAppend As String
    Dim varTmp As Variant, strTmp As String
    Dim rsInput As ADODB.Recordset
    Dim rsAppend As ADODB.Recordset
    Dim lngBegin As Long, lngEnd As Long
    Dim arrItem, strIDs As String
    
    On Error GoTo errH
    lng申请序号 = Get申请序号
    mblnRowChange = False
    cbo期效.ListIndex = 1
    strSQL = "Select a.名称,a.Id As 诊疗项目id, Null As 收费细目id,a.类别 As 类别ID From 诊疗项目目录 A where a.id=[1]"
    Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsCard!输血项目ID & ""))
    Call AdviceSet诊疗项目(rsInput, lngRow, Val(rsCard!输血途径项目ID & ""), 0, "", "")
    
    '备血申请可能申请多个品种，此处重新设置名称列
    If gbln血库系统 = True Then
        arrItem = Split(rsCard!申请项目 & "", ";")
        strIDs = ""
        If UBound(arrItem) > 0 Then
            For i = 0 To UBound(arrItem)
                strIDs = strIDs & "," & Val(arrItem(i))
            Next
            strIDs = Mid(strIDs, 2)
            strSQL = "Select /*+ CARDINALITY(C 10) */" & vbNewLine & _
                "  f_List2str(Cast(Collect(a.名称) As t_Strlist)) 名称" & vbNewLine & _
                " From 诊疗项目目录 a, Table(f_Num2list([1])) b" & vbNewLine & _
                " Where a.Id = b.Column_Value"
            Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strIDs)
            If rsInput.EOF = False Then
                vsAdvice.TextMatrix(lngRow, COL_名称) = rsInput!名称
            End If
        End If
    End If
    
    With vsAdvice
        For j = lngRow To lngRow + 1
            '更新一些项目
            .TextMatrix(j, COL_标志) = rsCard!用血安排
            .TextMatrix(j, COL_开嘱时间) = rsCard!输血申请日期
            .TextMatrix(j, COL_开始时间) = rsCard!输血申请日期
            .Cell(flexcpData, j, COL_开始时间) = .TextMatrix(j, COL_开始时间)
            .Cell(flexcpData, j, COL_开嘱时间) = .TextMatrix(j, COL_开嘱时间)
            .TextMatrix(j, COL_开嘱科室ID) = Val(rsCard!申请科室id & "")
            .TextMatrix(j, COL_申请序号) = lng申请序号
        Next
        .TextMatrix(lngRow, COL_输血时间) = rsCard!预定输血日期
        .TextMatrix(lngRow, COL_总量) = rsCard!预定输血量
        .TextMatrix(lngRow, COL_医生嘱托) = rsCard!备注
        .TextMatrix(lngRow, COL_用药理由) = rsCard!输血目的
        .TextMatrix(lngRow, COL_执行科室ID) = Val(rsCard!输血执行科室ID & "")
        .TextMatrix(lngRow + 1, COL_执行科室ID) = Val(rsCard!输血途径执行科室ID & "")
        .TextMatrix(lngRow + 1, COL_医生嘱托) = rsCard!滴速 & ""
        '新增后关联诊断的标记处理
        Set .Cell(flexcpData, lngRow, COL_申请序号) = zlDatabase.CopyNewRec(rsCard)
        .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
        .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称")
        .TextMatrix(lngRow, COL_用法) = .TextMatrix(lngRow, COL_用法) & rsCard!滴速
        '重新自动调整行高
        Call .AutoSize(col_医嘱内容)
    End With
    If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
    vsAdvice.Row = lngRow
    AdviceSet输血申请 = lngRow
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub GetData手术申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset)
'功能：从医嘱表格中获取数据生成对象只传新开状态的医嘱和未保存的医嘱数据
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    Dim str诊断 As String
    Dim str诊断IDs As String
    Dim strTmp As String
    Dim i As Long, j As Long
    Dim strExtData As String
    Dim strAppend As String
    
    On Error GoTo errH
    With vsAdvice
        If TypeName(.Cell(flexcpData, lngRow, COL_申请序号)) = "Recordset" Then
            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_申请序号))
        Else
            Call InitCardRsOperate(rsCard)
            rsCard.AddNew
        End If
        
        If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            str诊断IDs = GetAdviceDiag(.RowData(lngRow), str诊断)
            rsCard!临床诊断IDs = str诊断IDs
            rsCard!临床诊断描述 = str诊断
                
            .TextMatrix(lngRow, COL_附项) = Get病人医嘱附件(.RowData(lngRow))
            strAppend = .TextMatrix(lngRow, COL_附项)
            rsCard!申请附项 = strAppend
        End If
        
        rsCard!主手术项目ID = Val(.TextMatrix(lngRow, COL_诊疗项目ID))
        
        strExtData = Get手术附加IDs(lngRow)
        
        rsCard!附手术必要时 = Get手术附加必要时(lngRow)
        
        If strExtData <> "" Then
            If InStr(strExtData, ";") > 0 Then
                rsCard!附手术项目IDs = Split(strExtData, ";")(0)
                rsCard!麻醉项目ID = Val(Split(strExtData, ";")(1))
                
                For j = lngRow + 1 To .Rows - 1
                    If Val(.TextMatrix(j, COL_相关ID)) = Val(.RowData(lngRow)) Then
                        If .TextMatrix(j, COL_类别) = "G" Then
                            rsCard!麻醉执行科室ID = Val(.TextMatrix(j, COL_执行科室ID))
                        End If
                    Else
                        Exit For
                    End If
                Next
            Else
                rsCard!附手术项目IDs = strExtData
            End If
        End If
        '手术情况 '门诊没有用到这个东西
        '申请附项
        '生效时间
        '手术时间
        rsCard!手术执行科室ID = Val(.TextMatrix(lngRow, COL_执行科室ID))
        rsCard!手术时间 = .TextMatrix(lngRow, COL_手术时间)
        rsCard!生效时间 = .TextMatrix(lngRow, COL_开始时间)
        rsCard!申请科室id = Val(.TextMatrix(lngRow, COL_开嘱科室ID))
        rsCard.Update
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNew手术申请(ByVal intType As Integer, ByVal str项目IDs As String, ByRef rsCard As ADODB.Recordset) As Boolean
'功能：调用申请单
'参数：intType 0-新增,1-修改
    Dim lng项目id As Long
    Dim lng开嘱科室ID As Long
    
    On Error GoTo errH
    lng项目id = Val(str项目IDs)
    
    lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, 2)
    
    If Not rsCard Is Nothing Then
        If Not rsCard.EOF Then
            If Val(rsCard!申请科室id & "") <> 0 Then
                lng开嘱科室ID = Val(rsCard!申请科室id & "")
            End If
        End If
    End If
    
    ApplyNew手术申请 = frmApplyOperation.ShowMe(Me, 0, intType, mlng病人ID, mlng主页ID, 0, 0, mlng病人科室id, lng开嘱科室ID, "", , , , 1, , lng项目id, rsCard, mlng前提ID, CByte(mint婴儿))
      
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet手术申请(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset) As Long
'功能：把检查申请单数据加载到表格中
    Dim objTmp As clsApplicationData
    Dim i As Long, j As Long, k As Long
    Dim lngCnt As Long, lng申请序号 As Long, lngCurRow As Long
    Dim strSQL As String, strAppend As String
    Dim varTmp As Variant, strTmp As String
    Dim rsInput As ADODB.Recordset
    Dim rsAppend As ADODB.Recordset
    Dim lngBegin As Long, lngEnd As Long
    Dim strExtData As String
    Dim bln麻醉 As Boolean
    Dim str附加必要时 As String
    
    On Error GoTo errH
    lng申请序号 = Get申请序号
    mblnRowChange = False
    cbo期效.ListIndex = 1
    lngBegin = lngRow
    
    strSQL = "Select a.名称,a.Id As 诊疗项目id, Null As 收费细目id,a.类别 As 类别ID From 诊疗项目目录 A where a.id=[1]"
    Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsCard!主手术项目ID & ""))
    
    If rsCard!附手术项目IDs & "" <> "" Then
        strExtData = rsCard!附手术项目IDs
        lngEnd = UBound(Split(strExtData, ",")) + 1
    End If
    
    str附加必要时 = rsCard!附手术必要时 & ""
    
    If Val(rsCard!麻醉项目ID & "") <> 0 Then
        If strExtData <> "" Then
            strExtData = strExtData & ";" & rsCard!麻醉项目ID
        Else
            strExtData = rsCard!麻醉项目ID
        End If
        lngEnd = lngEnd + 1
        bln麻醉 = True
    End If
    If rsCard!申请附项 & "" <> "" Then
        strAppend = rsCard!申请附项 & ""
    End If
    
    lngEnd = lngBegin + lngEnd
    
    Call AdviceSet诊疗项目(rsInput, lngRow, 0, 0, strExtData, "", , , strAppend)
    
    With vsAdvice
        For j = lngBegin To lngEnd
            .TextMatrix(j, COL_手术时间) = rsCard!手术时间
            .TextMatrix(j, COL_开始时间) = rsCard!生效时间
            .Cell(flexcpData, j, COL_开始时间) = .TextMatrix(j, COL_开始时间)
            .TextMatrix(j, COL_开嘱时间) = rsCard!生效时间
            .Cell(flexcpData, j, COL_开嘱时间) = .TextMatrix(j, COL_开嘱时间)
            .TextMatrix(j, COL_开嘱科室ID) = Val(rsCard!申请科室id & "")
            .TextMatrix(j, COL_执行科室ID) = Val(rsCard!手术执行科室ID & "")
            .TextMatrix(j, COL_手术情况) = Val(rsCard!手术情况 & "")
            .TextMatrix(j, COL_申请序号) = lng申请序号
            If str附加必要时 <> "" Then
                .TextMatrix(j, COL_执行标记) = IIF(InStr(str附加必要时, .TextMatrix(j, COL_诊疗项目ID) & ":1") > 0, "1", "0")
            End If
            .TextMatrix(j, COL_标志) = IIF(Val(rsCard!手术情况 & "") = 1, 1, chk紧急.value)
            .TextMatrix(j, COL_审核状态) = IIF(Val(rsCard!手术情况 & "") = 1, "", .TextMatrix(j, COL_审核状态))
        Next
        
        If bln麻醉 Then
            .TextMatrix(lngEnd, COL_执行科室ID) = Val(rsCard!麻醉执行科室ID & "")
        End If
        
        '更新附件内容:以当前可见行为准
        If strAppend <> "" Then
            .TextMatrix(lngRow, COL_附项) = strAppend
            .Cell(flexcpData, lngRow, COL_附项) = 1 '表明需要重新写入(新增或修改)
            Call ReplaceAdviceAppend(lngRow) '缺省替换其他医嘱的申请附项
        End If
        
        '新增后关联诊断的标记处理
        Set .Cell(flexcpData, lngRow, COL_申请序号) = zlDatabase.CopyNewRec(rsCard)
        .TextMatrix(lngRow, col_医嘱内容) = AdviceTextMake(lngRow)
        .TextMatrix(lngRow, COL_执行科室) = Sys.RowValue("部门表", Val(.TextMatrix(lngRow, COL_执行科室ID)), "名称")
        '重新自动调整行高
        Call .AutoSize(col_医嘱内容)
        Call SetRow标志图标(lngRow, 0)
    End With
    If mbytUseType = 0 And mlng路径状态 = 1 Then Call SetPathRows(lngRow, lngRow)
    vsAdvice.Row = lngRow
    AdviceSet手术申请 = lngRow
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function


Private Function CheckDoc手术等级(ByVal lng诊疗项目ID As Long, ByVal strAppend As String) As Boolean
'功能：检查操作员或主刀医生是否达到手术项目的等级
'参数：strAppend=当前申请附项的填写情况串,格式为"项目名1<Split2>0/1(必填否)<Split2>要素ID<Split2>内容<Split1>..."
    Dim strSQL As String, rsTmp As Recordset
    Dim arrItem As Variant, arrSub As Variant
    Dim strItem As String, i As Integer
    Dim lngID As Long
    Dim strDoc As String
    Dim str手术等级 As String
    Dim str人员等级 As String
    Dim blnTmp As Boolean
    
    On Error GoTo errH
    If strAppend <> "" Then
        strSQL = "select A.ID from 诊治所见项目 A,诊治所见分类 B where a.分类id=b.id and b.编码='06' and A.中文名='主刀医生'"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "CheckDoc手术等级")
        If rsTmp.RecordCount > 0 Then
            lngID = rsTmp!ID
            arrItem = Split(strAppend, "<Split1>")
            For i = 0 To UBound(arrItem)
                arrSub = Split(arrItem(i), "<Split2>")
                If Val(arrSub(2)) = lngID Then
                    If Trim(arrSub(3)) <> "" Then
                        strDoc = Trim(arrSub(3))
                    End If
                    Exit For
                End If
            Next
        End If
    End If
    
    '人员等级和手术等级 同时有时值才进行判断，否则都需要审核
    If strDoc = "" Then
        str人员等级 = UserInfo.手术等级
    Else
        strSQL = "Select b.手术等级 From 人员表 B Where B.姓名=[1] and b.手术等级 is not null"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "CheckDoc手术等级", strDoc)
        If Not rsTmp.EOF Then str人员等级 = rsTmp!手术等级 & ""
    End If
    
    If str人员等级 <> "" Then
        strSQL = "select i.手术类型 as 手术等级 from 疾病编码目录 I, 疾病诊断对照 R where r.手术id=[1] and i.id=r.疾病id and i.手术类型 is not null"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "CheckDoc手术等级", lng诊疗项目ID)
        If Not rsTmp.EOF Then str手术等级 = rsTmp!手术等级 & ""
        
        If str人员等级 <> "" And str手术等级 <> "" Then
            If Decode(str人员等级, "丁", 1, "丙", 2, "乙", 3, "甲", 4, "一级", 1, "二级", 2, "三级", 3, "四级", 4, 0) >= _
                Decode(str手术等级, "丁", 1, "丙", 2, "乙", 3, "甲", 4, "一级", 1, "二级", 2, "三级", 3, "四级", 4, 0) Then
                blnTmp = True
            End If
        End If
    End If
    
    CheckDoc手术等级 = blnTmp
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function Get暂存医嘱IDs(ByVal lng病人ID As Long, ByVal lng主页ID As Long, ByVal lng前提ID As Long, ByVal str类别 As String) As String
'功能：获取本次医嘱保存时将要提交的暂存医嘱ID
    Dim i As Long
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    On Error GoTo errH
    strSQL = "select ID from 病人医嘱记录 Where 病人ID =[1] And 主页ID =[2] And Nvl(前提id,0)=[3] And 医嘱状态 =-1 and 诊疗类别=[4] and 相关id is null"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng病人ID, lng主页ID, lng前提ID, str类别)
    If Not rsTmp.EOF Then
        strSQL = ""
        For i = 0 To rsTmp.RecordCount
            strSQL = strSQL & "," & rsTmp!ID
            rsTmp.MoveNext
        Next
        Get暂存医嘱IDs = Mid(strSQL, 2)
    End If
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function Get暂存医嘱IDsToRis(ByVal lng病人ID As Long, ByVal lng主页ID As Long, ByVal lng前提ID As Long) As String
'功能：获取本次医嘱保存时将要提交的暂存医嘱ID
    Dim i As Long
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    
    On Error GoTo errH
    
    strSQL = "select a.ID,a.诊疗项目ID from 病人医嘱记录 a,诊疗项目目录 b " & _
        "   where a.诊疗项目id=b.id and (a.诊疗类别 in ('F','D') or a.诊疗类别='E' and nvl(b.操作类型,'0') in ('0','5')) and a.相关id is null" & _
        " and a.病人ID =[1] And a.主页ID =[2] And Nvl(a.前提id,0)=[3] And a.医嘱状态 =-1 and a.医嘱期效=1 and nvl(a.紧急标志,0)<>1"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng病人ID, lng主页ID, lng前提ID)
    
    If Not rsTmp.EOF Then
        strSQL = ""
        For i = 0 To rsTmp.RecordCount
            strSQL = strSQL & "," & rsTmp!ID & ":" & rsTmp!诊疗项目ID
            rsTmp.MoveNext
        Next
        Get暂存医嘱IDsToRis = Mid(strSQL, 2)
    End If
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub MakeAppNo(ByVal intType As Integer, ByVal lngBegin As Long, ByVal lngEnd As Long)
'功能：给表格上的医嘱数据产生申请序号
'参数：lngBegin - lngEnd 表格行的范围，intType －1 单组医嘱，2－多组医嘱
    Dim str类别 As String
    Dim lngNo As Long
    Dim lng项目id As Long
    Dim i As Long, j As Long
    Dim lng组ID As Long
    Dim lngPre组ID As Long
    Dim lngStart As Long
    Dim lngStop As Long
    
    On Error GoTo errH
    With vsAdvice
        If intType = 1 Then
            str类别 = .TextMatrix(lngBegin, COL_类别)
            lng项目id = Val(.TextMatrix(lngBegin, COL_诊疗项目ID))
            Select Case str类别
            Case "D", "F", "C"
                If CanUseApply(str类别, , lng项目id) Then
                    lngNo = -1 * Get申请序号
                End If
            Case "K"
                If CanUseApply("K", , lng项目id) Then
                    lngNo = -1 * Get申请序号
                End If
            Case "Z"
                If .TextMatrix(lngBegin, COL_操作类型) = "7" Then
                    If CanUseApply("Z", "会诊") Then
                        lngNo = -1 * Get申请序号
                    End If
                End If
            End Select
            If lngNo <> 0 Then
                For i = lngBegin To lngEnd
                    .TextMatrix(i, COL_申请序号) = lngNo
                Next
            End If
        Else
            For i = lngBegin To lngEnd
                If Val(.TextMatrix(i, COL_相关ID)) = 0 Then
                    lng组ID = .RowData(i)
                Else
                    lng组ID = Val(.TextMatrix(i, COL_相关ID))
                End If
                lngStop = -1
                lngStart = i
                For j = i + 1 To lngEnd
                    If lng组ID = IIF(Val(.TextMatrix(j, COL_相关ID)) = 0, Val(.RowData(j)), Val(.TextMatrix(j, COL_相关ID))) Then
                        lngStop = j
                    Else
                        Exit For
                    End If
                Next
                If lngStop = -1 Then lngStop = lngStart
                
                Call MakeAppNo(1, lngStart, lngStop)
                
                If lngStop = lngEnd Then
                    Exit Sub
                Else
                    i = lngStop
                End If
            Next
        End If
    End With
    Exit Sub
errH:
    If ErrCenter = 1 Then
        Resume
    End If
End Sub

Private Function CheckAdvicePrint(ByVal strDels As String, ByRef strMsg As String) As String
'功能：医嘱打印的判断
'参数：strDels 本次删除的医嘱
    Dim strSQL As String, i As Long, j As Long
    Dim rsTmp As ADODB.Recordset
    Dim rsDel As ADODB.Recordset
    Dim strTmp As String, varTmp As Variant
    Dim lng页号 As Long, strMsgTmp As String
    Dim strSQLDel As String
    Dim str修改 As String
    Dim rs修改 As ADODB.Recordset
    Dim strFilters As String
    Dim rsBaby As ADODB.Recordset
    Dim lngPrintType As Long
    
    On Error GoTo errH
    
    If strDels <> "" Then
        strSQL = "Select a.婴儿,a.期效, Min(LPad(页号,4,'0')||LPad(行号,3,'0')) As 位置,Min(a.页号) As 页号,min(a.打印时间) as 打印时间" & _
                " From 病人医嘱打印 A, 病人医嘱记录 B" & vbNewLine & _
                " Where a.病人id = b.病人id and b.id=a.医嘱id And a.主页id = b.主页id and a.病人id=[1] and a.主页id=[2]" & _
                " And b.id In (Select Column_Value From Table(Cast(f_Num2list([3]) As zlTools.t_Numlist)))" & _
                " Group By a.婴儿,a.期效 having Min(a.页号)>0"
        Set rsDel = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, strDels)
    End If
    
    lngPrintType = Val(zlDatabase.GetPara("医嘱单打印模式", glngSys, p住院医嘱下达))
    
    If lngPrintType = 1 Then
        '期效修改变化判断，只有在新开后打印的模式才会出现
        Set rs修改 = New ADODB.Recordset
        rs修改.Fields.Append "医嘱ID", adBigInt
        rs修改.Fields.Append "期效", adBigInt
        rs修改.Fields.Append "婴儿", adBigInt
        rs修改.Fields.Append "页号", adBigInt
        rs修改.Fields.Append "提示", adBigInt
        rs修改.CursorLocation = adUseClient
        rs修改.LockType = adLockOptimistic
        rs修改.CursorType = adOpenStatic
        rs修改.Open
        
        With vsAdvice
            For i = .FixedRows To .Rows - 1
                If .RowData(i) <> 0 And (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2)) Then
                    If 2 = Val(.TextMatrix(i, COL_EDIT)) Then
                        str修改 = str修改 & "," & .RowData(i)
                        rs修改.AddNew
                        rs修改!医嘱ID = Val(.RowData(i))
                        rs修改!婴儿 = Val(.TextMatrix(i, COL_婴儿))
                        rs修改!期效 = IIF(.TextMatrix(i, COL_期效) = "长嘱", 0, 1)
                        rs修改.Update
                    End If
                End If
            Next
        End With
        
        If str修改 <> "" Then
            str修改 = Mid(str修改, 2)
            strSQL = "Select a.医嘱ID,a.婴儿,a.期效,a.页号,a.行号,a.打印时间, To_Number(LPad(a.页号, 4, '0') || LPad(a.行号, 3, '0')) As 位置,-1 as 标记" & _
                    " From 病人医嘱打印 A Where a.病人id=[1] and a.主页id=[2]" & _
                    " And a.医嘱ID In (Select Column_Value From Table(Cast(f_Num2list([3]) As zlTools.t_Numlist)))"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, str修改)
            If Not rsTmp.EOF Then
                str修改 = ""
                Set rsTmp = zlDatabase.CopyNewRec(rsTmp)
                For i = 1 To rsTmp.RecordCount
                    rs修改.Filter = "医嘱ID=" & Val(rsTmp!医嘱ID & "")
                    If Val(rs修改!期效 & "") <> Val(rsTmp!期效 & "") Then
                        str修改 = str修改 & "," & Val(rsTmp!医嘱ID & "")
                        If InStr("," & strFilters & ",", "," & "期效=" & Val(rsTmp!期效 & "") & " and 婴儿=" & Val(rsTmp!婴儿 & "") & ",") = 0 Then
                            strFilters = strFilters & "," & "期效=" & Val(rsTmp!期效 & "") & " and 婴儿=" & Val(rsTmp!婴儿 & "")
                        End If
                    End If
                    rsTmp.MoveNext
                Next
            End If
        End If
    End If
    
    Set rs修改 = New ADODB.Recordset
    rs修改.Fields.Append "医嘱ID", adBigInt
    rs修改.Fields.Append "期效", adBigInt
    rs修改.Fields.Append "婴儿", adBigInt
    rs修改.Fields.Append "页号", adBigInt
    rs修改.Fields.Append "提示", adBigInt
    rs修改.CursorLocation = adUseClient
    rs修改.LockType = adLockOptimistic
    rs修改.CursorType = adOpenStatic
    rs修改.Open
    
    If strFilters <> "" Then
        strFilters = Mid(strFilters, 2)
        varTmp = Split(strFilters, ",")
        For j = 0 To UBound(varTmp)
            rsTmp.Filter = varTmp(j)
            rsTmp.Sort = "位置"
            If Not rsTmp.EOF Then
                rs修改.AddNew
                rs修改!期效 = rsTmp!期效
                rs修改!婴儿 = rsTmp!婴儿
                rs修改!页号 = rsTmp!页号
                rs修改!提示 = IIF(IsNull(rsTmp!打印时间), 0, 1)
                rs修改.Update
            End If
        Next
    End If
    
    For i = 0 To 1
        strTmp = Get医嘱下达打印判断(rsDel, 0, i)
        If strTmp <> "" Then
            varTmp = Split(strTmp, "|")
            lng页号 = Val(varTmp(0))
            '先判断是否存在了
            rs修改.Filter = "婴儿=0 and 期效=" & i
            If rs修改.EOF Then
                rs修改.AddNew
                rs修改!期效 = i
                rs修改!婴儿 = 0
                rs修改!页号 = lng页号
                rs修改!提示 = IIF(CStr(varTmp(1)) = "", 0, 1)
                rs修改.Update
            Else
                '比较页号大小取较小页号更新
                If lng页号 < Val(rs修改!页号 & "") Then
                    rs修改!页号 = lng页号
                    rs修改.Update
                End If
            End If
        End If
    Next
    
    If cbo婴儿.Visible Then
        strSQL = "Select 序号,婴儿姓名 From 病人新生儿记录 Where 病人ID=[1] And 主页ID=[2] Order by 序号"
        Set rsBaby = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
        For j = 1 To rsBaby.RecordCount
            For i = 0 To 1
                strTmp = Get医嘱下达打印判断(rsDel, Val(rsBaby!序号 & ""), i)
                If strTmp <> "" Then
                    varTmp = Split(strTmp, "|")
                    lng页号 = Val(varTmp(0))
                    '先判断是否存在了
                    rs修改.Filter = "婴儿=" & Val(rsBaby!序号 & "") & "  and 期效=" & i
                    If rs修改.EOF Then
                        rs修改.AddNew
                        rs修改!期效 = i
                        rs修改!婴儿 = Val(rsBaby!序号 & "")
                        rs修改!页号 = lng页号
                        rs修改!提示 = IIF(CStr(varTmp(1)) = "", 0, 1)
                        rs修改.Update
                    Else
                        '比较页号大小取较小页号更新
                        If lng页号 < Val(rs修改!页号 & "") Then
                            rs修改!页号 = lng页号
                            rs修改.Update
                        End If
                    End If
                End If
            Next
            rsBaby.MoveNext
        Next
    End If
    
    rs修改.Filter = 0
    For i = 1 To rs修改.RecordCount
        If Val(rs修改!提示 & "") = 1 Then
            If 0 = Val(rs修改!婴儿 & "") Then
                strMsgTmp = IIF(strMsgTmp = "", "", strMsgTmp & vbCrLf) & "该病人的" & IIF(Val(rs修改!期效 & "") = 0, "长期", "临时") & "医嘱单的打印记录将从第" & rs修改!页号 & "页开始被清除。"
            Else
                rsBaby.Filter = "序号=" & Val(rs修改!婴儿 & "")
                strMsgTmp = IIF(strMsgTmp = "", "", strMsgTmp & vbCrLf) & _
                "该病人" & IIF(rsBaby!婴儿姓名 & "" = "", "", "婴儿-" & rsBaby!婴儿姓名) & "的" & IIF(Val(rs修改!期效 & "") = 0, "长期", "临时") & "医嘱单的打印记录将从第" & rs修改!页号 & "页开始被清除。"
            End If
            strSQLDel = strSQLDel & "|" & "Zl_病人医嘱打印_Delete(" & mlng病人ID & "," & mlng主页ID & "," & rs修改!婴儿 & "," & rs修改!期效 & "," & rs修改!页号 & ")"
        Else
            strSQLDel = strSQLDel & "|" & "Zl_病人医嘱打印_Delete(" & mlng病人ID & "," & mlng主页ID & "," & rs修改!婴儿 & "," & rs修改!期效 & "," & rs修改!页号 & ",null,3)"
        End If
        rs修改.MoveNext
    Next
    strMsg = strMsgTmp
    CheckAdvicePrint = Mid(strSQLDel, 2)
    Exit Function
errH:
    If ErrCenter = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function CheckPrintAfter调序(ByRef strMsg As String) As String
'功能：医嘱调整序后保存医嘱时候的检查
'返回：可能执行的SQL
    Dim i As Long, j As Long
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim strMsgTmp As String
    Dim strSQLDel As String
    Dim varTmp As Variant
    Dim strTmp As String
    Dim lng页号 As Long
    
    On Error GoTo errH
    
    For i = 0 To 1
        strTmp = Get医嘱调序打印判断(0, i)
        If strTmp <> "" Then
            varTmp = Split(strTmp, "|")
            lng页号 = Val(varTmp(0))
            If CStr(varTmp(1)) <> "" Then
                strMsgTmp = IIF(strMsgTmp = "", "", strMsgTmp & vbCrLf) & _
                    "该病人的" & IIF(i = 0, "长期", "临时") & "医嘱单的打印记录将从第" & lng页号 & "页开始被清除。"
                strSQLDel = strSQLDel & "|" & "Zl_病人医嘱打印_Delete(" & mlng病人ID & "," & mlng主页ID & ",0," & i & "," & lng页号 & ")"
            Else
                strSQLDel = strSQLDel & "|" & "Zl_病人医嘱打印_Delete(" & mlng病人ID & "," & mlng主页ID & ",0," & i & ",null,null,3)"
            End If
        End If
    Next
    
    If cbo婴儿.Visible Then
        strSQL = "Select 序号,婴儿姓名 From 病人新生儿记录 Where 病人ID=[1] And 主页ID=[2] Order by 序号"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
        For j = 1 To rsTmp.RecordCount
            For i = 0 To 1
                strTmp = Get医嘱调序打印判断(Val(rsTmp!序号 & ""), i)
                If strTmp <> "" Then
                    varTmp = Split(strTmp, "|")
                    lng页号 = Val(varTmp(0))
                    If CStr(varTmp(1)) <> "" Then
                        strMsgTmp = IIF(strMsgTmp = "", "", strMsgTmp & vbCrLf) & _
                            "该病人" & IIF(rsTmp!婴儿姓名 & "" = "", "", "婴儿-" & rsTmp!婴儿姓名) & "的" & IIF(i = 0, "长期", "临时") & "医嘱单的打印记录将从第" & lng页号 & "页开始被清除。"
                        strSQLDel = strSQLDel & "|" & "Zl_病人医嘱打印_Delete(" & mlng病人ID & "," & mlng主页ID & "," & rsTmp!序号 & "," & i & "," & lng页号 & ")"
                    Else
                        strSQLDel = strSQLDel & "|" & "Zl_病人医嘱打印_Delete(" & mlng病人ID & "," & mlng主页ID & "," & rsTmp!序号 & "," & i & ",null,null,3)"
                    End If
                End If
            Next
            rsTmp.MoveNext
        Next
    End If
    strMsg = strMsgTmp
    CheckPrintAfter调序 = Mid(strSQLDel, 2)
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function Get医嘱调序打印判断(ByVal lng婴儿序号 As Long, ByVal lng期效 As Long) As String
'功能：调序后打印情况判断
'参数：lng婴儿序号  婴儿序号，lng期效 0－长嘱，1－临嘱
    Dim strSQL As String
    Dim lng医嘱ID As Long
    Dim i As Long
    Dim str现IDs As String, str原IDs As String
    Dim var现 As Variant, var原 As Variant
    Dim rsTmp As ADODB.Recordset
    
    On Error GoTo errH
    
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If Val(.TextMatrix(i, COL_婴儿)) = lng婴儿序号 And .TextMatrix(i, COL_期效) = IIF(0 = lng期效, "长嘱", "临嘱") Then
                str现IDs = str现IDs & "," & Val(.RowData(i))
            End If
        Next
    End With
    
    mrsAdvice调序.Filter = "医嘱期效=" & lng期效 & " and 婴儿=" & lng婴儿序号
    mrsAdvice调序.Sort = "序号"
    If Not mrsAdvice调序.EOF Then
        For i = 1 To mrsAdvice调序.RecordCount
            str原IDs = str原IDs & "," & mrsAdvice调序!ID
            mrsAdvice调序.MoveNext
        Next
    End If
    
    If str原IDs <> str现IDs Then
        var现 = Split(str现IDs, ",")
        var原 = Split(str原IDs, ",")
        For i = 0 To UBound(var原)
            If Val(var现(i)) <> Val(var原(i)) Then
                lng医嘱ID = Val(var原(i))
                Exit For
            End If
        Next
    End If
    
    If lng医嘱ID <> 0 Then
        strSQL = "Select min(b.页号) As 页号, min(b.打印时间) As 打印时间" & vbNewLine & _
            "From 病人医嘱记录 A, 病人医嘱打印 B" & vbNewLine & _
            "Where a.Id = b.医嘱id And b.病人id = [1] And b.主页id = [2] And b.婴儿 = [3] And b.期效=[4] And" & vbNewLine & _
            "      a.序号 >= (Select Nvl(Max(x.序号), 0) From 病人医嘱记录 X Where x.Id = [5])"
        
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, lng婴儿序号, lng期效, lng医嘱ID)
        If Val(rsTmp!页号 & "") > 0 Then
            Get医嘱调序打印判断 = rsTmp!页号 & "|" & rsTmp!打印时间
        End If
    End If
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function Get医嘱下达打印判断(ByVal rsDel As ADODB.Recordset, ByVal lng婴儿序号 As Long, ByVal lng期效 As Long) As String
'功能：调序后打印情况判断
'参数：lng婴儿序号  婴儿序号，lng期效 0－长嘱，1－临嘱
    Dim strSQL As String
    Dim i As Long, lng页号 As Long
    Dim rsTmp As ADODB.Recordset
    Dim lng序号 As Long
    Dim strResult As String
    
    On Error GoTo errH
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If .RowData(i) <> 0 And (mbytUseType <> 1 Or (mbytUseType = 1 And .Cell(flexcpChecked, i, COL_选择) <> 2)) Then
                If InStr(",1,2,", Val(.TextMatrix(i, COL_EDIT))) > 0 Then
                    If Val(.TextMatrix(i, COL_婴儿)) = lng婴儿序号 And .TextMatrix(i, COL_期效) = IIF(0 = lng期效, "长嘱", "临嘱") Then
                        lng序号 = Val(.TextMatrix(i, COL_序号))
                        Exit For
                    End If
                End If
            End If
        Next
    End With
    
    If lng序号 <> 0 Then
        strSQL = "Select min(b.页号) As 页号, min(b.打印时间) As 打印时间" & vbNewLine & _
            "From 病人医嘱记录 A, 病人医嘱打印 B" & vbNewLine & _
            "Where a.Id = b.医嘱id And b.病人id = [1] And b.主页id = [2] And b.婴儿 = [3] And b.期效=[4] And" & vbNewLine & _
            "      a.序号 >=[5]"
        
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID, lng婴儿序号, lng期效, lng序号)
        If Val(rsTmp!页号 & "") > 0 Then
            lng页号 = Val(rsTmp!页号 & "")
            strResult = rsTmp!页号 & "|" & rsTmp!打印时间
        End If
    End If
        
    If Not rsDel Is Nothing Then
        rsDel.Filter = "期效=" & lng期效 & " and 婴儿=" & lng婴儿序号
        If Not rsDel.EOF Then
            If Val(rsDel!页号 & "") <> 0 Then
                If lng页号 <> 0 Then
                    If Val(rsDel!页号 & "") < lng页号 Then
                        strResult = rsDel!页号 & "|" & rsDel!打印时间
                    End If
                Else
                    strResult = rsDel!页号 & "|" & rsDel!打印时间
                End If
            End If
        End If
    End If
    
    Get医嘱下达打印判断 = strResult
    
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub imgColSel_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim i As Long
    
    If Button = 1 Then '列选择器
        '根据当前状态直接确定勾选状态
        With vsColumn
            If .Visible Then
                .Visible = False
                If vsAdvice.Enabled Then vsAdvice.SetFocus
            Else
                For i = .FixedRows To .Rows - 1
                    If vsAdvice.ColHidden(.RowData(i)) Or vsAdvice.ColWidth(.RowData(i)) = 0 Then
                        .TextMatrix(i, 0) = 0
                    Else
                        .TextMatrix(i, 0) = 1
                    End If
                Next
                
                vsColumn.Height = vsColumn.RowHeightMin * vsColumn.Rows + 150
                If vsColumn.Top + vsColumn.Height > Me.ScaleHeight Then
                    vsColumn.Height = Me.ScaleHeight - vsColumn.Top
                    vsColumn.Width = 1750
                Else
                    vsColumn.Width = 1470
                End If
                
                .Left = fraColSel.Left
                .Top = fraColSel.Top + fraColSel.Height
                .ZOrder
                .Visible = True
                .SetFocus
            End If
        End With
    End If
End Sub

Private Sub InitColumnSelect()
'功能：根据医嘱清单原始列显示状态初始化列选择器
    Dim lngRow As Long, i As Long
    
    vsColumn.Rows = vsColumn.FixedRows
    With vsAdvice
        For i = .FixedCols To .Cols - 1
            If Not (.ColHidden(i) Or .ColWidth(i) = 0) Then
                If .TextMatrix(0, i) <> "" Then '审查结果,皮试
                    vsColumn.Rows = vsColumn.Rows + 1
                    lngRow = vsColumn.Rows - 1
                    vsColumn.TextMatrix(lngRow, 1) = .TextMatrix(0, i)
                    vsColumn.RowData(lngRow) = i
                    
                    '固定显示列
                    If InStr(",开始时间,医嘱内容,开嘱医生,", "," & .TextMatrix(0, i) & ",") > 0 Then
                        vsColumn.TextMatrix(lngRow, 0) = 1
                        vsColumn.Cell(flexcpForeColor, lngRow, 0, lngRow, 1) = vsColumn.BackColorFixed
                    End If
                    
                    '默认隐藏开嘱时间
                     If InStr(",开嘱时间,", "," & .TextMatrix(0, i) & ",") > 0 Then
                        vsAdvice.ColWidth(i) = 0
                        vsAdvice.ColHidden(i) = True
                        vsColumn.TextMatrix(lngRow, 0) = 0
                    End If
                End If
            End If
        Next
    End With
    If vsColumn.Rows > 1 Then vsColumn.Row = 1
End Sub

Private Sub vsColumn_AfterEdit(ByVal Row As Long, ByVal Col As Long)
    Dim lngCol As Long
    
    If Col = 0 Then
        lngCol = vsColumn.RowData(Row)
        If Val(vsColumn.TextMatrix(Row, 0)) <> 0 Then
            vsAdvice.ColWidth(lngCol) = vsAdvice.ColData(lngCol)
            vsAdvice.ColHidden(lngCol) = False
        Else
            vsAdvice.ColWidth(lngCol) = 0
            vsAdvice.ColHidden(lngCol) = True
        End If
    End If
End Sub

Private Sub vsColumn_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
    With vsColumn
        If NewRow >= .FixedRows - 1 And NewCol >= .FixedCols - 1 Then
            .ForeColorSel = .Cell(flexcpForeColor, NewRow, 1)
            .Col = 0
        End If
    End With
End Sub

Private Sub vsColumn_LostFocus()
    vsColumn.Visible = False
End Sub

Private Sub vsColumn_StartEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    If Col <> 0 Or vsColumn.Cell(flexcpForeColor, Row, 1) = vsColumn.BackColorFixed Then Cancel = True
End Sub

Private Function Check项目Enalble(ByVal lng诊疗项目ID As Long, ByVal lng收费细目ID As Long, ByVal int服务对象 As Integer, ByVal str类别 As String) As Boolean
'功能：检查一条医嘱对应项目是否已经撤档或不服务或项目类别变化
'参数：lng诊疗项目ID：医嘱对应的诊疗项目
'      收费细目ID：医嘱对应的收费细目
'      int服务对象：所要检查的服务对象 1-门诊，2-住院
'返回：
'       true,该医嘱对应项目已经撤档或不服务当前范围,false,该医嘱对应项目有效

    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    Dim str服务对象 As String
    
    On Error GoTo errH
    
    If mlng病人性质 = 1 Then
        str服务对象 = ",1,2,3,"
    Else
        str服务对象 = ",2,3,"
    End If
    
    '诊疗项目检查
    If lng诊疗项目ID <> 0 Then
        strSQL = "Select a.服务对象,a.撤档时间,a.类别 From 诊疗项目目录 A where a.id=[1]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng诊疗项目ID)
        If Not (IsNull(rsTmp!撤档时间) Or Format(NVL(rsTmp!撤档时间), "yyyy-MM-dd") = "3000-01-01") Then
            Exit Function
        ElseIf Not (NVL(rsTmp!服务对象, 0) = 3 Or InStr(str服务对象, "," & NVL(rsTmp!服务对象, 0) & ",") > 0) Then
            Exit Function
        ElseIf NVL(rsTmp!类别, "") <> str类别 Then
            Exit Function
        End If
    End If
    '收费细目检查
    If lng收费细目ID <> 0 Then
        strSQL = "Select 1" & vbNewLine & _
                "From 收费项目目录 A" & vbNewLine & _
                "Where ID = [1] And (a.撤档时间 Is Not Null And To_Char(a.撤档时间, 'yyyy-MM-dd') <> '3000-01-01' Or" & vbNewLine & _
                " Instr([2],','||a.服务对象||',')=0  )"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng收费细目ID, str服务对象)
        If rsTmp.RecordCount > 0 Then Exit Function
    End If
    Check项目Enalble = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function GetNext医嘱ID() As Long
'功能：生成临时的医嘱ID
    mlngID序列 = mlngID序列 - 1
    GetNext医嘱ID = mlngID序列
End Function

Private Function GetID指定值(ByRef colIn As Collection, ByVal strKey As String) As Long
'功能：获取指定的真实医嘱ID，用集合方式生成键值对
    Dim strID As String
    
    On Error Resume Next
    
    strID = colIn(strKey)
    If err.Number <> 0 Then
        strID = zlDatabase.GetNextID("病人医嘱记录")
        colIn.Add strID, strKey
    End If
    err.Clear
    
    GetID指定值 = Val(strID)
End Function

Private Sub MakeRealID()
'功能：将医嘱表格中的医嘱ID生成为真实的医嘱ID
'说明：提交数据时可能失败，可能会被重复执行，可以用当前值是否大于0进行判断，只有本次新的医嘱才需要重新产生
    Dim i As Long
    Dim colID As New Collection
    Screen.MousePointer = 11
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If InStr("1,2", Val(.TextMatrix(i, COL_EDIT))) > 0 Then   '所有医嘱记录
                If Val(.RowData(i)) < 0 Then
                    .RowData(i) = GetID指定值(colID, CStr(.RowData(i)))
                End If
                If Val(.TextMatrix(i, COL_相关ID)) < 0 Then
                    .TextMatrix(i, COL_相关ID) = GetID指定值(colID, CStr(Val(.TextMatrix(i, COL_相关ID))))
                End If
            End If
        Next
    End With
    Screen.MousePointer = 0
End Sub

Private Sub FuncApplyCustom(ByVal intType As Integer, ByVal lng文件ID As Long, Optional ByVal lng申请序号 As Long, Optional ByVal lng项目id As Long)
'功能：自定义申请单
    Dim objApplyCustom As New frmApplyCustom
    Dim lng开嘱科室ID As Long
    Dim objControl As CommandBarControl
    Dim lngOut医嘱ID As Long
    
    '自动保存
    Set objControl = cbsMain.FindControl(, conMenu_Save)
    If Not objControl Is Nothing Then
        If objControl.Enabled Then
            mblnChecking = True
            If Not CheckAdvice Then mblnChecking = False: Exit Sub    '检查中处理了光标定位
            mblnChecking = False
            If Not SaveAdvice(False) Then vsAdvice.SetFocus: Exit Sub
        End If
    End If
    
    lng开嘱科室ID = Get开嘱科室ID(UserInfo.ID, mlng医技科室ID, mlng病人科室id, , , mlng会诊科室ID)
    If objApplyCustom.ShowMe(mfrmParent, 0, intType, mlng病人ID, mlng主页ID, IIF(mlng病人性质 = 1, 1, 0), lng文件ID, lng申请序号, mlng病人科室id, lng开嘱科室ID, mlng病人病区ID, mrsDefine, mintPState, mdatTurn, 1, mclsMipModule, mlng前提ID, mint婴儿, mint险类, lngOut医嘱ID, lng项目id) Then
        '重新读取显示医嘱
        Call ReLoadAdvice(lngOut医嘱ID)
        mblnOK = True '强行
        If txt医嘱内容.Enabled Then
            txt医嘱内容.SetFocus
        Else
            vsAdvice.SetFocus
        End If
    End If
End Sub


Private Sub SetAll一并给药(ByVal OldRow As Long, ByVal NewRow As Long)
'功能：将一定范围的医嘱行合并为一并给药
    Dim i As Long
    Dim strIDs As String
    Dim lngS As Long, lngE As Long
    Dim strMsg As String
    Dim lngTmp As Long, lngTmp1 As Long, lngTmp2 As Long
    Dim lngIDS As Long, lngIDE As Long
    Dim lng组ID As Long
    
    lngS = OldRow
    lngE = NewRow
    
    If lngS = lngE Then Exit Sub
    
    If lngS > lngE Then
        lngS = lngS + lngE
        lngE = lngS - lngE
        lngS = lngS - lngE
    End If
    
    With vsAdvice
        If lngS < .FixedRows Then Exit Sub
        
        If RowIn一并给药(lngS) Then
            lng组ID = Val(.TextMatrix(lngS, COL_相关ID))
        End If
        
        If RowIn一并给药(lngE) Then
            If lng组ID = Val(.TextMatrix(lngE, COL_相关ID)) Then
                .Row = lngE
                cbsMain.FindControl(, conMenu_Merge, True, True).Execute
                Exit Sub
            End If
        End If
        
        For i = lngS To lngE
            If Not .RowHidden(i) Then
                If Val(.RowData(i)) = 0 Then
                    .Redraw = flexRDNone
                    MsgBox "您本次的鼠标拖选行中有空白行，不设置能一并给药", vbInformation, gstrSysName
                    .Redraw = flexRDDirect
                    Exit Sub
                End If
                '两行不符合条件
                strMsg = ""
                If i > lngS And Not .RowHidden(i) Then
                    If Not RowCanMerge(lngS, i, strMsg) Then
                        .Redraw = flexRDNone
                        MsgBox strMsg, vbInformation, gstrSysName
                        .Redraw = flexRDDirect
                        Exit Sub
                    End If
                End If
            End If
        Next
        
        '一并给药的取消一并约药
        lngIDS = Val(.RowData(lngS))
        lngIDE = Val(.RowData(lngE))
        mblnRowChange = False: .Redraw = flexRDNone
        For i = lngE To lngS Step -1
            If Not .RowHidden(i) Then
                If RowIn一并给药(i) Then
                    Call Get一并给药范围(Val(.TextMatrix(i, COL_相关ID)), lngTmp1, lngTmp2)
                    If i = lngE Then
                        lngIDE = Val(.RowData(lngTmp2))
                    ElseIf i = lngS Then
                        lngIDS = Val(.RowData(lngTmp1))
                    End If
                    i = lngTmp1
                    Call AdviceSet单独给药(lngTmp1, lngTmp2)
                End If
            End If
        Next
        
        '合并找到起始行和结束
        lngS = .FindRow(lngIDS)
        lngE = .FindRow(lngIDE)
        Call AdviceSet一并给药(lngS, lngE)
        .Row = lngS: .Col = col_医嘱内容
        mblnRowChange = True: .Redraw = flexRDDirect
        Call vsAdvice_AfterRowColChange(-1, .Col, .Row, .Col)
    End With
End Sub

Private Function Get缺省首日(ByVal lngRow As Long, ByVal lngPar As Long) As String
'功能:获取一个首日缺省执行时间方案
    Dim strTmp As String
    Dim str生效时间 As String
    Dim datCurTime As Date
    Dim datEnd As Date
    Dim varTmp As Variant
    Dim str原方案 As String
    Dim i As Long
    Dim dbl小时数 As Double
    Dim intDx As Integer
    Dim str新方案 As String
    Dim int原首日次数 As Integer
    Dim str单位  As String
    Dim strFirt As String
    Dim strLast As String
    Dim datEndTmp As Date
    
    If lngPar = 0 Then Exit Function
    
    With vsAdvice
        str生效时间 = .TextMatrix(lngRow, COL_开始时间)
        str原方案 = .TextMatrix(lngRow, COL_执行时间)
        str单位 = .TextMatrix(lngRow, COL_间隔单位)
        
        If InStr(str原方案, ",") > 0 Then
            str原方案 = Split(str原方案, ",")(1)
        End If
        
        datCurTime = CDate(str生效时间)
        
        If str单位 = "周" Then
            datEnd = zlCommFun.GetWeekBase(datCurTime)
            datEnd = Format(datEnd + 6, "YYYY-MM-DD 23:59:59")
        ElseIf str单位 = "天" Then
            datEnd = Format(datCurTime, "YYYY-MM-DD 23:59:59")
        End If
        datEndTmp = datEnd
        
        '计算第一个周期内可以执行多少次
        strTmp = Calc次数分解时间(Val(.TextMatrix(lngRow, COL_频率次数)), datCurTime, datEnd, "", str原方案, Val(.TextMatrix(lngRow, COL_频率次数)), 1, str单位)
        If strTmp <> "" Then
            varTmp = Split(strTmp, ",")
            int原首日次数 = UBound(varTmp) + 1
            strFirt = varTmp(0)
            strLast = varTmp(int原首日次数 - 1)
        End If
        
        If lngPar <= int原首日次数 Then
            '首日的次数大于指定次数，直接从原方案中截取
            varTmp = Split(str原方案, "-")
            '从后往前
            strTmp = ""
            For i = UBound(varTmp) To 0 Step -1
                strTmp = varTmp(i) & IIF(strTmp = "", "", "-" & strTmp)
                intDx = intDx + 1
                If intDx = lngPar Then Exit For
            Next
            str新方案 = strTmp
        ElseIf int原首日次数 = 0 Then
            '首日一次时间点也没有，重新计算，平均值
            dbl小时数 = (datEnd - datCurTime) * 24 / lngPar
            If dbl小时数 > 1 Then
                strTmp = dbl小时数
                intDx = Split(strTmp, ".")(0)
                str新方案 = Format(datCurTime, "HH:MM")
                If str单位 = "周" Then
                    str新方案 = Weekday(datCurTime, vbMonday) & "/" & str新方案
                End If
                For i = 1 To lngPar - 1
                    datCurTime = DateAdd("h", intDx, datCurTime)
                    strTmp = Format(datCurTime, "HH:MM")
                    If str单位 = "周" Then
                        strTmp = Weekday(datCurTime, vbMonday) & "/" & strTmp
                    End If
                    
                    str新方案 = str新方案 & "-" & strTmp
                Next
            Else
                dbl小时数 = dbl小时数 * 60
                strTmp = dbl小时数
                intDx = Split(strTmp, ".")(0)
                str新方案 = Format(datCurTime, "HH:MM")
                
                If str单位 = "周" Then
                    str新方案 = Weekday(datCurTime, vbMonday) & "/" & str新方案
                End If
                 
                For i = 1 To lngPar - 1
                    datCurTime = DateAdd("n", intDx, datCurTime)
                    strTmp = Format(datCurTime, "HH:MM")
                    If str单位 = "周" Then
                        strTmp = Weekday(datCurTime, vbMonday) & "/" & strTmp
                    End If
                    str新方案 = str新方案 & "-" & strTmp
                Next
            End If
        Else
            '在第一个时间点向前加
            datEnd = CDate(strFirt)
            dbl小时数 = (datEnd - datCurTime) * 24 * 60 / (lngPar - int原首日次数)
            If dbl小时数 > 1 Then
                strTmp = dbl小时数
                intDx = Split(strTmp, ".")(0)
                str新方案 = Format(datCurTime, "HH:MM")
                
                If str单位 = "周" Then
                    str新方案 = Weekday(datCurTime, vbMonday) & "/" & str新方案
                End If
                 
                For i = 1 To lngPar - 1 - int原首日次数
                    datCurTime = DateAdd("n", intDx, datCurTime)
                    strTmp = Format(datCurTime, "HH:MM")
                    If str单位 = "周" Then
                        strTmp = Weekday(datCurTime, vbMonday) & "/" & strTmp
                    End If
                    str新方案 = str新方案 & "-" & strTmp
                Next
                
                varTmp = Split(str原方案, "-")
                intDx = 0
                strTmp = ""
                For i = UBound(varTmp) To 0 Step -1
                    strTmp = varTmp(i) & IIF(strTmp = "", "", "-" & strTmp)
                    intDx = intDx + 1
                    If intDx = int原首日次数 Then Exit For
                Next
                str新方案 = str新方案 & "-" & strTmp
            Else
                '否则从最后一个时间点往后加，默认以1分钟为一个单位
                datCurTime = CDate(strLast)
                datEnd = datEndTmp
                dbl小时数 = (datEnd - datCurTime) * 24 * 60 / (lngPar - int原首日次数)
                If dbl小时数 > 1 Then
                    strTmp = dbl小时数
                    intDx = Split(strTmp, ".")(0)
                    datCurTime = DateAdd("n", intDx, datCurTime)
                    str新方案 = Format(datCurTime, "HH:MM")
                    
                    If str单位 = "周" Then
                        str新方案 = Weekday(datCurTime, vbMonday) & "/" & str新方案
                    End If
                     
                    For i = 1 To lngPar - 1 - int原首日次数
                        datCurTime = DateAdd("n", intDx, datCurTime)
                        strTmp = Format(datCurTime, "HH:MM")
                        If str单位 = "周" Then
                            strTmp = Weekday(datCurTime, vbMonday) & "/" & strTmp
                        End If
                        str新方案 = str新方案 & "-" & strTmp
                    Next
                    varTmp = Split(str原方案, "-")
                    intDx = 0
                    strTmp = ""
                    For i = UBound(varTmp) To 0 Step -1
                        strTmp = varTmp(i) & IIF(strTmp = "", "", "-" & strTmp)
                        intDx = intDx + 1
                        If intDx = int原首日次数 Then Exit For
                    Next
                    str新方案 = strTmp & "-" & str新方案
                End If
            End If
        End If
        Get缺省首日 = str新方案
    End With
End Function


Private Sub GetAgentInfo()
'功能：读取代办人信息
    Dim rsTmp As ADODB.Recordset
    
    gstrSQL = "Select c.信息名, c.信息值" & vbNewLine & _
        "  From 病人信息从表 C" & vbNewLine & _
        "  Where c.就诊id = [2] And c.病人id = [1] And Instr(',代办人姓名,代办人身份证号,代办人性别,代办人年龄,代办人电话,病人身份证号,用药理由,',','||c.信息名||',')>0"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(gstrSQL, Me.Caption, mlng病人ID, mlng主页ID)
    
    AgentInfo.本次就诊已录入 = False
    AgentInfo.代办人姓名 = ""
    AgentInfo.代办人身份证号 = ""
    AgentInfo.代办人性别 = ""
    AgentInfo.代办人年龄 = ""
    AgentInfo.代办人电话 = ""
    AgentInfo.用药理由 = ""
    
    If rsTmp.EOF Then Exit Sub
    
    AgentInfo.本次就诊已录入 = True
    While Not rsTmp.EOF
        Select Case NVL(rsTmp!信息名)
            Case "代办人姓名"
                AgentInfo.代办人姓名 = NVL(rsTmp!信息值)
            Case "代办人身份证号"
                AgentInfo.代办人身份证号 = NVL(rsTmp!信息值)
            Case "代办人性别"
                AgentInfo.代办人性别 = NVL(rsTmp!信息值)
            Case "代办人年龄"
                AgentInfo.代办人年龄 = NVL(rsTmp!信息值)
            Case "代办人电话"
                AgentInfo.代办人电话 = NVL(rsTmp!信息值)
            Case "用药理由"
                AgentInfo.用药理由 = NVL(rsTmp!信息值)
        End Select
        rsTmp.MoveNext
    Wend
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub ReadMsg(ByVal strNO As String)
'功能：消息处理，校对疑问消息ZLHIS_CIS_035/ZLHIS_BLOOD_004
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim i As Long
    Dim blnHave As Boolean
    
    On Error GoTo errH
    
    If strNO = "ZLHIS_CIS_035" Then
    
        If mbytUseType <> 0 Then Exit Sub
        
        '如果没有疑问医嘱则不用处理
        If Not mblnHave疑问医嘱 Then Exit Sub
        
        With vsAdvice
            For i = .FixedRows To .Rows - 1
                If Val(.TextMatrix(i, COL_状态)) = 2 Then
                    blnHave = True
                    Exit Sub
                End If
            Next
        End With
    ElseIf strNO = "ZLHIS_BLOOD_004" Then
        strSQL = "select 1 from 病人医嘱记录 a where a.病人id=[1] and a.主页id=[2] and a.医嘱状态=1 and a.诊疗类别='K' and a.检查方法='1' and a.审核状态=1 and rownum<2"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
        
        If rsTmp.EOF Then '没有这类数据了，将消息设为已阅
            strSQL = "select 1 from 业务消息清单 a where a.病人id=[1] and a.就诊id=[2] and a.类型编码='ZLHIS_BLOOD_004' and nvl(a.是否已阅,0)=0"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng病人ID, mlng主页ID)
            If rsTmp.EOF Then Exit Sub
        End If
    End If
    
    '否则将消息设为已读
    strSQL = "Zl_业务消息清单_Read(" & mlng病人ID & "," & mlng主页ID & ",'" & strNO & "',2,'" & UserInfo.姓名 & "'," & mlng病人科室id & ")"
    Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function GetBabySex(ByVal intBaby As Integer) As String
'功能：根据婴儿序号获取婴儿的性别
    Dim strSex As String
    
    If intBaby = 0 Then
        strSex = mstr病人性别
    Else
        If Not mrsBaby Is Nothing Then
            mrsBaby.Filter = "序号=" & intBaby
            If Not mrsBaby.EOF Then
                strSex = mrsBaby!性别 & ""
            End If
        End If
    End If
    
    If strSex = "" Then
        '未赋值时则以病人性别
        strSex = mstr病人性别
    End If
    
    GetBabySex = strSex
End Function

Private Function GetSinglePati() As Boolean
'功能:判断导航台传入的命令行是不是单病人处理模式 SINGLEPATI=1 识另
'说明:需要容错处理,gfrmMain 对象有可能不是导航台窗体
    Dim strTmp As String
    On Error Resume Next
    strTmp = gfrmMain.GetCommand
    If strTmp <> "" Then
        GetSinglePati = InStr(strTmp, "SINGLEPATI=1") > 0
    End If
End Function

Private Function IsNewDrug() As Boolean
'功能:是否存在新增或修改的药品医嘱
    Dim i As Long
    Dim blnHvae As Boolean
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If .RowData(i) <> 0 Then
                If InStr(",5,6,7,", .TextMatrix(i, COL_类别)) > 0 And InStr(",1,2,", "," & .TextMatrix(i, COL_EDIT) & ",") > 0 Then
                    blnHvae = True
                    Exit For
                End If
            End If
        Next
    End With
    IsNewDrug = blnHvae
End Function
